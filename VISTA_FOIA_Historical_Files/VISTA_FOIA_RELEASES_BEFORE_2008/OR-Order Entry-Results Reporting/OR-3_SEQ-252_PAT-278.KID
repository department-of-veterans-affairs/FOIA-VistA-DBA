Released OR*3*278 SEQ #252
Extracted from mail message
**KIDS**:OR*3.0*278^

**INSTALL NAME**
OR*3.0*278
"BLD",7474,0)
OR*3.0*278^ORDER ENTRY/RESULTS REPORTING^0^3070906^y
"BLD",7474,1,0)
^^3^3^3070905^
"BLD",7474,1,1,0)
Corrects the issue with Tasks accumulating while  waiting  for a 
"BLD",7474,1,2,0)
partition. Caused by ORMEVNT exiting without unlocking a global that it 
"BLD",7474,1,3,0)
locked. 
"BLD",7474,4,0)
^9.64PA^^
"BLD",7474,6.3)
5
"BLD",7474,"KRN",0)
^9.67PA^8989.52^19
"BLD",7474,"KRN",.4,0)
.4
"BLD",7474,"KRN",.401,0)
.401
"BLD",7474,"KRN",.402,0)
.402
"BLD",7474,"KRN",.403,0)
.403
"BLD",7474,"KRN",.5,0)
.5
"BLD",7474,"KRN",.84,0)
.84
"BLD",7474,"KRN",3.6,0)
3.6
"BLD",7474,"KRN",3.8,0)
3.8
"BLD",7474,"KRN",9.2,0)
9.2
"BLD",7474,"KRN",9.8,0)
9.8
"BLD",7474,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",7474,"KRN",9.8,"NM",1,0)
ORMEVNT^^0^B75252404
"BLD",7474,"KRN",9.8,"NM","B","ORMEVNT",1)

"BLD",7474,"KRN",19,0)
19
"BLD",7474,"KRN",19.1,0)
19.1
"BLD",7474,"KRN",101,0)
101
"BLD",7474,"KRN",409.61,0)
409.61
"BLD",7474,"KRN",771,0)
771
"BLD",7474,"KRN",870,0)
870
"BLD",7474,"KRN",8989.51,0)
8989.51
"BLD",7474,"KRN",8989.52,0)
8989.52
"BLD",7474,"KRN",8994,0)
8994
"BLD",7474,"KRN","B",.4,.4)

"BLD",7474,"KRN","B",.401,.401)

"BLD",7474,"KRN","B",.402,.402)

"BLD",7474,"KRN","B",.403,.403)

"BLD",7474,"KRN","B",.5,.5)

"BLD",7474,"KRN","B",.84,.84)

"BLD",7474,"KRN","B",3.6,3.6)

"BLD",7474,"KRN","B",3.8,3.8)

"BLD",7474,"KRN","B",9.2,9.2)

"BLD",7474,"KRN","B",9.8,9.8)

"BLD",7474,"KRN","B",19,19)

"BLD",7474,"KRN","B",19.1,19.1)

"BLD",7474,"KRN","B",101,101)

"BLD",7474,"KRN","B",409.61,409.61)

"BLD",7474,"KRN","B",771,771)

"BLD",7474,"KRN","B",870,870)

"BLD",7474,"KRN","B",8989.51,8989.51)

"BLD",7474,"KRN","B",8989.52,8989.52)

"BLD",7474,"KRN","B",8994,8994)

"BLD",7474,"QUES",0)
^9.62^^
"BLD",7474,"REQB",0)
^9.611^1^1
"BLD",7474,"REQB",1,0)
OR*3.0*195^2
"BLD",7474,"REQB","B","OR*3.0*195",1)

"MBREQ")
0
"PKG",167,-1)
1^1
"PKG",167,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",167,20,0)
^9.402P^^
"PKG",167,22,0)
^9.49I^1^1
"PKG",167,22,1,0)
3.0^2971217^2980417^1271
"PKG",167,22,1,"PAH",1,0)
278^3070906
"PKG",167,22,1,"PAH",1,1,0)
^^3^3^3070906
"PKG",167,22,1,"PAH",1,1,1,0)
Corrects the issue with Tasks accumulating while  waiting  for a 
"PKG",167,22,1,"PAH",1,1,2,0)
partition. Caused by ORMEVNT exiting without unlocking a global that it 
"PKG",167,22,1,"PAH",1,1,3,0)
locked. 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","ORMEVNT")
0^1^B75252404^B71407003
"RTN","ORMEVNT",1,0)
ORMEVNT ;SLC/MKB-Trigger HL7 msg off MAS events ;3/31/04  09:21
"RTN","ORMEVNT",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**24,45,70,79,141,165,177,186,195,278**;Dec 17, 1997;Build 5
"RTN","ORMEVNT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORMEVNT",4,0)
 ;
"RTN","ORMEVNT",5,0)
EN1 ; -- tasked entry point
"RTN","ORMEVNT",6,0)
 Q:'$G(DFN)  Q:$D(DGPMPC)  Q:DGPMT=4!(DGPMT=5)  ;skip lodger mvts
"RTN","ORMEVNT",7,0)
 N ZTDESC,ZTIO,ZTRTN,ZTDTH,ZTSAVE,ZTSK,I
"RTN","ORMEVNT",8,0)
 S ZTDESC="Auto-DC and/or Release orders on MAS movement",ZTIO=""
"RTN","ORMEVNT",9,0)
 S ZTRTN="EN^ORMEVNT",ZTDTH=$H,ZTSAVE("^UTILITY(""DGPM"",$J,")=""
"RTN","ORMEVNT",10,0)
 F I="DFN","DGPMDA","DGPMA","DGPMP","DGPMT" S ZTSAVE(I)=""
"RTN","ORMEVNT",11,0)
 D ^%ZTLOAD ;D EN^ORYDGPM
"RTN","ORMEVNT",12,0)
 Q
"RTN","ORMEVNT",13,0)
 ;
"RTN","ORMEVNT",14,0)
EN ; -- main entry point
"RTN","ORMEVNT",15,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ORMEVNT",16,0)
 Q:'$G(DFN)  Q:$D(DGPMPC)  Q:DGPMT=4!(DGPMT=5)
"RTN","ORMEVNT",17,0)
 I '$G(DGPMP) S ^XTMP("OREVENT",DFN,DGPMDA,0)=DT_U_$$FMADD^XLFDT(DT,2)_U_"Event process flag" ;195
"RTN","ORMEVNT",18,0)
 I $G(DGPMP),$D(^XTMP("OREVENT",DFN,DGPMDA)) D EN1 Q  ;195 edits processed after new JEH
"RTN","ORMEVNT",19,0)
 N XQORQUIT,XQORPOP,DTOUT,DUOUT,DIRUT,DIROUT ;protect protocol context
"RTN","ORMEVNT",20,0)
 N VAIP,DONE,ORVP,ORWARD,ORTS,ORL,ORDIV,ORLAST,X,Y,I,ORCURRNT,OREVENT,ORDCRULE,ORACT,ORPRINT
"RTN","ORMEVNT",21,0)
 S VAIP("E")=DGPMDA D IN5^VADPT M ORVP=VAIP I '$G(DGPMA) D  Q  ;deleted
"RTN","ORMEVNT",22,0)
 . N LAST,OREVT S LAST=+$O(^ORE(100.2,"ADT",DGPMDA,""),-1) Q:LAST<1
"RTN","ORMEVNT",23,0)
 . S OREVT=+$O(^ORE(100.2,"ADT",DGPMDA,LAST,0))
"RTN","ORMEVNT",24,0)
 . D ACTLOG^OREVNTX(OREVT,"DL")
"RTN","ORMEVNT",25,0)
A ;
"RTN","ORMEVNT",26,0)
 S ORVP=+DFN_";DPT(",ORTS=+$G(^DPT(DFN,.103)),ORWARD=$G(^(.1))
"RTN","ORMEVNT",27,0)
 S ORWARD=$S($L(ORWARD):+$O(^DIC(42,"B",ORWARD,0)),1:0)
"RTN","ORMEVNT",28,0)
 S ORL=$S(ORWARD:+$G(^DIC(42,ORWARD,44))_";SC(",1:""),ORDIV=$$DIV(+ORL)
"RTN","ORMEVNT",29,0)
 S ORLAST("TS")=$$PREVTS,X=+VAIP(15,4) F I="WD","LOC","DIV" S ORLAST(I)=""
"RTN","ORMEVNT",30,0)
 S:X ORLAST("WD")=X,Y=+$G(^DIC(42,X,44)),ORLAST("LOC")=Y_";SC(",ORLAST("DIV")=$$DIV(Y)
"RTN","ORMEVNT",31,0)
 N OREVNTLK S OREVNTLK=""  ;JEH
"RTN","ORMEVNT",32,0)
 S ORCURRNT=$$CURRENT,OREVENT=$$PATEVT,ORACT=$S($G(DGPMP):"ED",1:"NW") ; Lock
"RTN","ORMEVNT",33,0)
 I OREVENT=-1 D EN1 Q  ;195 Can't lock, retry
"RTN","ORMEVNT",34,0)
 S OREVNTLK=OREVENT  ; save routine copy of ifn JEH
"RTN","ORMEVNT",35,0)
 I $G(DGPMP),$D(^ORE(100.2,"ADT",DGPMDA)) D   ;edited 
"RTN","ORMEVNT",36,0)
 . N LAST,OREVT,DA,X,I S LAST=+$O(^ORE(100.2,"ADT",DGPMDA,""),-1) Q:LAST<1
"RTN","ORMEVNT",37,0)
 . S OREVT=+$O(^ORE(100.2,"ADT",DGPMDA,LAST,0)),DA=+$O(^(OREVT,0))
"RTN","ORMEVNT",38,0)
 . S X=$G(^ORE(100.2,OREVT,10,DA,0)) ;last activity on movement
"RTN","ORMEVNT",39,0)
 . I $P(X,U,5)=+$G(VAIP(4)),$P(X,U,6)=+$G(VAIP(8)),$P(X,U,7)=+$G(VAIP(5)) S DONE=1 Q  ;no change
"RTN","ORMEVNT",40,0)
 . I 'OREVENT D ACTLOG^OREVNTX(OREVT,"ED",$$TYPE(DGPMT),1) S DONE=1
"RTN","ORMEVNT",41,0)
 I $G(DONE) D FINISHED Q  ; unlock and clean up before quit IFNjeh 
"RTN","ORMEVNT",42,0)
B ;
"RTN","ORMEVNT",43,0)
 I '$G(DGPMP),ORCURRNT D  ;new mvt - autoDC
"RTN","ORMEVNT",44,0)
 . I $D(^ORE(100.2,"ADT",DGPMDA)) D  Q:$G(DONE)  ;ReEntered
"RTN","ORMEVNT",45,0)
 .. N LAST,OREVT S DONE=0
"RTN","ORMEVNT",46,0)
 .. S LAST=+$O(^ORE(100.2,"ADT",DGPMDA,""),-1),OREVT=+$O(^(LAST,0))
"RTN","ORMEVNT",47,0)
 .. Q:+ORVP'=+$G(^ORE(100.2,OREVT,0))  ;diff pat -> diff mvt
"RTN","ORMEVNT",48,0)
 .. S ORACT="RE",DONE=1 Q:OREVENT  ;log on new event instead
"RTN","ORMEVNT",49,0)
 .. D ACTLOG^OREVNTX(OREVT,ORACT,$$TYPE(DGPMT),1)
"RTN","ORMEVNT",50,0)
 . I DGPMT=3 D COMP("ALG") ;keep until GMRA*4*15 gets out
"RTN","ORMEVNT",51,0)
 . S ORDCRULE=$$DCEVT D:ORDCRULE AUTODC^ORMEVNT1(ORDCRULE,$P(DGPMA,U))
"RTN","ORMEVNT",52,0)
 . I DGPMT=1!(DGPMT=2&("^13^40^"[("^"_$P(DGPMA,U,18)_"^"))) I $G(^XTMP("ORDCOBS-"_+ORVP,0)) D REINST ;186 TO ASIH tran mvmt
"RTN","ORMEVNT",53,0)
C ;
"RTN","ORMEVNT",54,0)
 I OREVENT D  ;release delayed orders, complete event
"RTN","ORMEVNT",55,0)
 . D RELEASE^ORMEVNT1(OREVENT),DONE^OREVNTX(OREVENT,$P(DGPMA,U),DGPMDA)
"RTN","ORMEVNT",56,0)
 . I '$G(VAIP(1)) M VAIP=ORVP ;reset for ACTLOG use
"RTN","ORMEVNT",57,0)
 . D ACTLOG^OREVNTX(OREVENT,ORACT,$$TYPE(DGPMT),1)
"RTN","ORMEVNT",58,0)
 . I DGPMT=1,'$P($G(^ORE(100.2,+OREVENT,0)),U,3) S $P(^(0),U,3)=DGPMDA
"RTN","ORMEVNT",59,0)
 . ;D UNLEVT^ORX2(OREVENT)
"RTN","ORMEVNT",60,0)
 I $O(ORPRINT(0)),$G(ORL) D PRINTS^ORWD1(.ORPRINT,+ORL)
"RTN","ORMEVNT",61,0)
 I DGPMT=3,ORCURRNT,'$G(DGPMP) D DISCH ;lapse remaining events
"RTN","ORMEVNT",62,0)
 I '$G(DFN),$G(ORVP) S DFN=+ORVP ;just in case
"RTN","ORMEVNT",63,0)
FINISHED  ; unlock and clean up JEH
"RTN","ORMEVNT",64,0)
 D:$G(OREVNTLK) UNLEVT^ORX2(OREVNTLK) K ^XTMP("OREVENT",DFN,DGPMDA) ;195
"RTN","ORMEVNT",65,0)
 Q
"RTN","ORMEVNT",66,0)
 ;
"RTN","ORMEVNT",67,0)
CURRENT() ; -- Returns 1 or 0, if DGPMDA is the latest movement
"RTN","ORMEVNT",68,0)
 N Y,LAST,LASTYPE,LASTDT S Y=0
"RTN","ORMEVNT",69,0)
 S LAST=+VAIP(14),LASTDT=+VAIP(14,1),LASTYPE=+VAIP(14,2)
"RTN","ORMEVNT",70,0)
 ; VAIP(14) = last physical movement for the admission
"RTN","ORMEVNT",71,0)
 I DGPMT=6 D  G CQ
"RTN","ORMEVNT",72,0)
 . N CA,IDT I LAST,LASTDT>+VAIP(3) Q  ;last physical mvt
"RTN","ORMEVNT",73,0)
 . S CA=+VAIP(13),IDT=9999999.9999999-VAIP(3)
"RTN","ORMEVNT",74,0)
 . I '$O(^DGPM("ATS",DFN,CA,IDT),-1) S Y=1 Q  ;last TS mvt
"RTN","ORMEVNT",75,0)
 I DGPMT=3 D  ;get last mvt overall
"RTN","ORMEVNT",76,0)
 . N VAIP,Y S VAIP("D")="LAST" D IN5^VADPT
"RTN","ORMEVNT",77,0)
 . S LAST=+VAIP(14),LASTYPE=+VAIP(14,2) ;reset
"RTN","ORMEVNT",78,0)
 I LAST=DGPMDA S Y=1 G CQ ;primary mvt
"RTN","ORMEVNT",79,0)
 I $D(^UTILITY("DGPM",$J,LASTYPE,LAST)) S Y=1 ;secondary mvt
"RTN","ORMEVNT",80,0)
CQ Q Y
"RTN","ORMEVNT",81,0)
 ;
"RTN","ORMEVNT",82,0)
PREVTS() ; -- Returns previous treating specialty
"RTN","ORMEVNT",83,0)
 N TS,TSP,CA,ID,LAST,Y
"RTN","ORMEVNT",84,0)
 S TS=+$O(^UTILITY("DGPM",$J,6,0)),TSP=$G(^(TS,"P"))
"RTN","ORMEVNT",85,0)
 I $G(TSP) S Y=+$P(TSP,U,9) G PRVQ ;edited TS mvt
"RTN","ORMEVNT",86,0)
 ; look for TS mvt since last phys mvt
"RTN","ORMEVNT",87,0)
 S CA=$P(DGPMA,U,14),ID=9999999.9999999-DGPMA
"RTN","ORMEVNT",88,0)
 S LAST=+$O(^DGPM("ATS",DFN,CA,ID)),Y=$S(LAST:+$O(^(LAST,0)),1:+VAIP(15,6))
"RTN","ORMEVNT",89,0)
PRVQ Q Y
"RTN","ORMEVNT",90,0)
 ;
"RTN","ORMEVNT",91,0)
TYPE(X) ; -- Return type of event from MAS code
"RTN","ORMEVNT",92,0)
 N Y S Y=$S(X=1:"A",X=2:"T",X=3:"D",X=6:"S",1:"")
"RTN","ORMEVNT",93,0)
 Q Y
"RTN","ORMEVNT",94,0)
 ;
"RTN","ORMEVNT",95,0)
DIV(LOC) ; -- Return Institution file #4 ptr for LOC
"RTN","ORMEVNT",96,0)
 N X0,Y S X0=$G(^SC(+LOC,0))
"RTN","ORMEVNT",97,0)
 S Y=$S($P(X0,U,4):$P(X0,U,4),$P(X0,U,15):$$SITE^VASITE(DT,$P(X0,U,15)),1:+$G(DUZ(2)))
"RTN","ORMEVNT",98,0)
 Q Y
"RTN","ORMEVNT",99,0)
 ;
"RTN","ORMEVNT",100,0)
PATEVT() ; -- Find match to new data in Patient Event file
"RTN","ORMEVNT",101,0)
 N TYPE,MVTYPE,EVT,IFN,X0,Y S Y="" G:'$G(ORCURRNT) PTQ
"RTN","ORMEVNT",102,0)
 S TYPE=$S(DGPMT=1:"A",DGPMT=3:"D",DGPMT=2!(DGPMT=6):"T",1:""),EVT=0
"RTN","ORMEVNT",103,0)
 S MVTYPE=$P(DGPMA,U,18),TYPE(1)="",MVTYPE(1)=""
"RTN","ORMEVNT",104,0)
 I DGPMT=2,MVTYPE=13 S TYPE(1)="A",MVTYPE(1)=40 ;To ASIH
"RTN","ORMEVNT",105,0)
 I DGPMT=3,MVTYPE=41 S TYPE(1)="T",MVTYPE(1)=14 ;From ASIH
"RTN","ORMEVNT",106,0)
 I DGPMT'=3,$$GET1^DIQ(45.7,+$G(ORTS)_",","SPECIALTY:SERVICE")="NHCU" S TYPE(1)=$S(TYPE="A":"T",1:"A") ;DBIA #1154
"RTN","ORMEVNT",107,0)
 F  S EVT=+$O(^ORE(100.2,"AE",DFN,EVT)) Q:EVT<1  S IFN=+$O(^(EVT,0)) D  Q:Y
"RTN","ORMEVNT",108,0)
 . Q:$$LAPSED^OREVNTX(+IFN)  Q:$P($G(^ORE(100.2,IFN,1)),U,5)
"RTN","ORMEVNT",109,0)
 . S X0=$G(^ORD(100.5,EVT,0)) Q:$P(X0,U,3)'=ORDIV
"RTN","ORMEVNT",110,0)
 . I $P(X0,U,2)'=TYPE,$P(X0,U,2)'=TYPE(1) Q  ;Xaction type
"RTN","ORMEVNT",111,0)
 . I $P(X0,U,7),$P(X0,U,7)'=MVTYPE,$P(X0,U,7)'=MVTYPE(1) Q  ;Mvt type
"RTN","ORMEVNT",112,0)
 . I $O(^ORD(100.5,EVT,"TS",0)) Q:'$D(^("B",ORTS))  Q:ORTS=ORLAST("TS")&(ORDIV=ORLAST("DIV"))
"RTN","ORMEVNT",113,0)
 . I $O(^ORD(100.5,EVT,"LOC",0)) Q:'$D(^("B",ORWARD))  Q:ORWARD=ORLAST("WD")
"RTN","ORMEVNT",114,0)
 . S Y=+IFN ;ok
"RTN","ORMEVNT",115,0)
 I Y S:'$$LCKEVT^ORX2(Y) Y=-1 ;195 Lock event if possible
"RTN","ORMEVNT",116,0)
PTQ Q Y
"RTN","ORMEVNT",117,0)
 ;
"RTN","ORMEVNT",118,0)
DCEVT() ; -- Find match to event in AutoDC Rules file for [new] ORDIV,ORTS,ORL
"RTN","ORMEVNT",119,0)
 N MVTYPE,DIV,XFER,ORY,EXC,OBS
"RTN","ORMEVNT",120,0)
 S OBS=$S(DGPMT=3:$$MVT^DGPMOBS(DGPMDA),1:0) ;observation mvt
"RTN","ORMEVNT",121,0)
 S MVTYPE=+$P(DGPMA,U,18) S:MVTYPE=41 MVTYPE=14 S:MVTYPE=40 MVTYPE=13 ;ASIH- 186
"RTN","ORMEVNT",122,0)
 S XFER=$S(DGPMT=2:1,DGPMT=6:1,MVTYPE'=14:0,OBS:0,1:1)
"RTN","ORMEVNT",123,0)
 I DGPMT=2,MVTYPE=13,$G(^XTMP("ORDCOBS-"_+ORVP,"READMIT")) S ORY=0 K ^XTMP("ORDCOBS-"_+ORVP,"READMIT") G DCQ ;186 Obs readmit from ASIH don't auto-dc
"RTN","ORMEVNT",124,0)
 I XFER,ORLAST("TS")'=ORTS,$D(^ORD(100.6,"AC",ORDIV,20)) S MVTYPE=20 ;TS
"RTN","ORMEVNT",125,0)
 S DIV=ORDIV I DGPMT=3,MVTYPE'=14 S DIV=ORLAST("DIV") ;discharge
"RTN","ORMEVNT",126,0)
 S ORY=+$O(^ORD(100.6,"AC",ORDIV,MVTYPE,0)) K:ORY<1&(DGPMT=3)&(OBS) ^XTMP("ORDCOBS-"_+ORVP) G:ORY<1 DCQ ;186, If obs, no active rule, no reinstate
"RTN","ORMEVNT",127,0)
 I MVTYPE=20,$D(^ORD(100.6,ORY,4,ORLAST("TS"),1,ORTS))!(ORTS=ORLAST("TS")) S ORY=0 G DCQ
"RTN","ORMEVNT",128,0)
 I MVTYPE=4 D  G DCQ ;ck Div and Loc multiples
"RTN","ORMEVNT",129,0)
 . I ORLAST("DIV")'=ORDIV S:'$D(^ORD(100.6,ORY,6,ORLAST("DIV"))) ORY=0 Q
"RTN","ORMEVNT",130,0)
 . N OLD,INCL S INCL=0 ;ck incl loc's
"RTN","ORMEVNT",131,0)
 . F OLD=+ORLAST("LOC"),"ALL" I $D(^ORD(100.6,ORY,5,"ADC",OLD,+ORL))!$D(^("ALL")) S INCL=1 Q
"RTN","ORMEVNT",132,0)
 . S:'INCL ORY=0
"RTN","ORMEVNT",133,0)
 I DGPMT=3,OBS D  ;readmitting from observation?
"RTN","ORMEVNT",134,0)
 . N TORY
"RTN","ORMEVNT",135,0)
 . S TORY=ORY
"RTN","ORMEVNT",136,0)
 . S EXC=+$P($G(^ORD(100.6,ORY,0)),U,6) S:EXC=2 ORY=0 ;ignore rule
"RTN","ORMEVNT",137,0)
 . I EXC=1,'$D(ZTQUEUED),$$READMIT S ORY=0
"RTN","ORMEVNT",138,0)
 . I ORY=0 D DCGEN^ORMEVNT2,TIMER^ORMEVNT2 S:"^14^41^"[("^"_$P(DGPMA,U,18)_"^") ^XTMP("ORDCOBS-"_+ORVP,"READMIT")=1 ;177,186 
"RTN","ORMEVNT",139,0)
 . K:ORY ^XTMP("ORDCOBS-"_+ORVP) ;have rule -> dc, don't reinstate meds
"RTN","ORMEVNT",140,0)
DCQ Q ORY
"RTN","ORMEVNT",141,0)
 ;
"RTN","ORMEVNT",142,0)
READMIT() ; -- Return 1 or 0, if patient is being readmitted
"RTN","ORMEVNT",143,0)
 N X,Y,DIR
"RTN","ORMEVNT",144,0)
 S DIR(0)="YA",DIR("A")="Will the patient be re-admitted immediately? "
"RTN","ORMEVNT",145,0)
 S DIR("?")="Enter YES if the patient is to be admitted to the hospital immediately following this discharge from observation."
"RTN","ORMEVNT",146,0)
 D ^DIR S:$D(DTOUT)!$D(DUOUT) Y="^"
"RTN","ORMEVNT",147,0)
 Q Y
"RTN","ORMEVNT",148,0)
 ;
"RTN","ORMEVNT",149,0)
COMP(ORDG) ; -- Complete orders on event [Keep until GMRA*4*15]
"RTN","ORMEVNT",150,0)
 N ORI,ORLIST,ORIFN,OREDT
"RTN","ORMEVNT",151,0)
 I 'ORDG S:ORDG?1.U ORDG=+$O(^ORD(100.98,"B",ORDG,0)) Q:ORDG'>0
"RTN","ORMEVNT",152,0)
 D EN^ORQ1(ORVP,ORDG,2) S ORI=0,OREDT=$P(DGPMA,U)
"RTN","ORMEVNT",153,0)
 F  S ORI=$O(^TMP("ORR",$J,ORLIST,ORI)) Q:ORI'>0  S ORIFN=^(ORI) D STATUS^ORCSAVE2(+ORIFN,2) S:$G(OREDT) $P(^OR(100,+ORIFN,3),U)=OREDT,$P(^(6),U,6)=OREDT
"RTN","ORMEVNT",154,0)
 Q
"RTN","ORMEVNT",155,0)
 ;
"RTN","ORMEVNT",156,0)
LOC(NODE) ; -- Returns [new] patient location from NODE
"RTN","ORMEVNT",157,0)
 N X,Y S X=$P($G(NODE),U,6)
"RTN","ORMEVNT",158,0)
 I X'>0 S X=$P($G(^DPT(+ORVP,.1)),U) S:$L(X) X=$O(^DIC(42,"B",X,0))
"RTN","ORMEVNT",159,0)
 S Y=+$G(^DIC(42,+X,44))_";SC("
"RTN","ORMEVNT",160,0)
 Q Y
"RTN","ORMEVNT",161,0)
 ;
"RTN","ORMEVNT",162,0)
DISCH ; -- Lapse/cancel outstanding events on discharge
"RTN","ORMEVNT",163,0)
 D DISCH^ORMEVNT2 ;195 Code moved to ORMEVNT2 for space considerations
"RTN","ORMEVNT",164,0)
 Q
"RTN","ORMEVNT",165,0)
 ;
"RTN","ORMEVNT",166,0)
XTMP ; -- Save ORIFN to possibly reinstate on admission
"RTN","ORMEVNT",167,0)
 ;    Also uses ORVP, DGPMDA
"RTN","ORMEVNT",168,0)
 Q:'$G(DGPMDA)  Q:'$G(ORIFN)  Q:'$G(ORVP)
"RTN","ORMEVNT",169,0)
 N ORNOW S ORNOW=+$$NOW^XLFDT
"RTN","ORMEVNT",170,0)
 I $G(^XTMP("ORDCOBS-"_+ORVP,0)),+^(0)<ORNOW K ^XTMP("ORDCOBS-"_+ORVP)
"RTN","ORMEVNT",171,0)
 I '$G(^XTMP("ORDCOBS-"_+ORVP,0)) D
"RTN","ORMEVNT",172,0)
 . N ORNOW1H S ORNOW1H=$$FMADD^XLFDT(ORNOW,,1)
"RTN","ORMEVNT",173,0)
 . S ^XTMP("ORDCOBS-"_+ORVP,0)=ORNOW1H_U_ORNOW_"^InptMeds AutoDC'd on Discharge from Observation"
"RTN","ORMEVNT",174,0)
 S ^XTMP("ORDCOBS-"_+ORVP,+ORIFN)=$G(^OR(100,+ORIFN,4))
"RTN","ORMEVNT",175,0)
 S ^XTMP("ORDCOBS-"_+ORVP,"DISCHARGE")=DGPMDA
"RTN","ORMEVNT",176,0)
 Q
"RTN","ORMEVNT",177,0)
 ;
"RTN","ORMEVNT",178,0)
REINST ; -- Reinstate meds from observation
"RTN","ORMEVNT",179,0)
 I '$L($T(ENR^PSJOERI)) K ^XTMP("ORDCOBS-"_+ORVP) Q   ;DBIA 3598
"RTN","ORMEVNT",180,0)
 N ORIDT,ORLASTDC,X0,ORIFN,PSIFN
"RTN","ORMEVNT",181,0)
 S ORIDT=+$O(^DGPM("ATID3",+ORVP,0)) S:DGPMT=2 ORIDT=$O(^DGPM("ATID3",+ORVP,ORIDT)) Q:ORIDT<1  S ORLASTDC=+$O(^(ORIDT,0)) ;186 If reinstating for transfer TO ASIH then skip pseudo discharge for WHILE ASIH
"RTN","ORMEVNT",182,0)
 Q:$G(^XTMP("ORDCOBS-"_+ORVP,"DISCHARGE"))'=ORLASTDC  S X0=$G(^(0))
"RTN","ORMEVNT",183,0)
 I $P(X0,U)<$$NOW^XLFDT K ^XTMP("ORDCOBS-"_+ORVP) Q  ;readmit after one hour 177
"RTN","ORMEVNT",184,0)
 S ORIFN=0 F  S ORIFN=+$O(^XTMP("ORDCOBS-"_+ORVP,ORIFN))  Q:ORIFN<1  S PSIFN=$G(^(ORIFN)) D:PSIFN ENR^PSJOERI(+ORVP,PSIFN,+ORWARD)  ;DBIA 3598
"RTN","ORMEVNT",185,0)
 K ^XTMP("ORDCOBS-"_+ORVP)
"RTN","ORMEVNT",186,0)
 Q
"RTN","ORMEVNT",187,0)
 ;
"RTN","ORMEVNT",188,0)
 ; -- Moved code:
"RTN","ORMEVNT",189,0)
EXP(ORDER,ORSTOP) G EXP^ORMEVNT1
"RTN","ORMEVNT",190,0)
ACTIVE(ORDER,ORSTRT) G ACT^ORMEVNT1
"RTN","ORMEVNT",191,0)
PURGE(ORDER) G PUR^ORMEVNT1
"VER")
8.0^22.0
"BLD",7474,6)
^252
**END**
**END**
