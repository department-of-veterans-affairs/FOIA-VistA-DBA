EMERGENCY Released PSO*7*215 SEQ #187
Extracted from mail message
**KIDS**:PSO*7.0*215^

**INSTALL NAME**
PSO*7.0*215
"BLD",6357,0)
PSO*7.0*215^OUTPATIENT PHARMACY^0^3050810^y
"BLD",6357,1,0)
^^3^3^3050802^
"BLD",6357,1,1,0)
Produce a Tally message & report of all Outpatient Pharmacy refills that 
"BLD",6357,1,2,0)
were released via the OPAI 2.4 automated interface since the install of 
"BLD",6357,1,3,0)
patch PSO*7*156.
"BLD",6357,4,0)
^9.64PA^^
"BLD",6357,"INID")
^n
"BLD",6357,"INIT")
PSOCPBK1
"BLD",6357,"KRN",0)
^9.67PA^8989.52^19
"BLD",6357,"KRN",.4,0)
.4
"BLD",6357,"KRN",.401,0)
.401
"BLD",6357,"KRN",.402,0)
.402
"BLD",6357,"KRN",.403,0)
.403
"BLD",6357,"KRN",.5,0)
.5
"BLD",6357,"KRN",.84,0)
.84
"BLD",6357,"KRN",3.6,0)
3.6
"BLD",6357,"KRN",3.8,0)
3.8
"BLD",6357,"KRN",9.2,0)
9.2
"BLD",6357,"KRN",9.8,0)
9.8
"BLD",6357,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",6357,"KRN",9.8,"NM",1,0)
PSOCPBK1^^0^89371510
"BLD",6357,"KRN",9.8,"NM",2,0)
PSOCPBK2^^0^54982346
"BLD",6357,"KRN",9.8,"NM","B","PSOCPBK1",1)

"BLD",6357,"KRN",9.8,"NM","B","PSOCPBK2",2)

"BLD",6357,"KRN",19,0)
19
"BLD",6357,"KRN",19.1,0)
19.1
"BLD",6357,"KRN",101,0)
101
"BLD",6357,"KRN",409.61,0)
409.61
"BLD",6357,"KRN",771,0)
771
"BLD",6357,"KRN",870,0)
870
"BLD",6357,"KRN",8989.51,0)
8989.51
"BLD",6357,"KRN",8989.52,0)
8989.52
"BLD",6357,"KRN",8994,0)
8994
"BLD",6357,"KRN","B",.4,.4)

"BLD",6357,"KRN","B",.401,.401)

"BLD",6357,"KRN","B",.402,.402)

"BLD",6357,"KRN","B",.403,.403)

"BLD",6357,"KRN","B",.5,.5)

"BLD",6357,"KRN","B",.84,.84)

"BLD",6357,"KRN","B",3.6,3.6)

"BLD",6357,"KRN","B",3.8,3.8)

"BLD",6357,"KRN","B",9.2,9.2)

"BLD",6357,"KRN","B",9.8,9.8)

"BLD",6357,"KRN","B",19,19)

"BLD",6357,"KRN","B",19.1,19.1)

"BLD",6357,"KRN","B",101,101)

"BLD",6357,"KRN","B",409.61,409.61)

"BLD",6357,"KRN","B",771,771)

"BLD",6357,"KRN","B",870,870)

"BLD",6357,"KRN","B",8989.51,8989.51)

"BLD",6357,"KRN","B",8989.52,8989.52)

"BLD",6357,"KRN","B",8994,8994)

"BLD",6357,"QUES",0)
^9.62^1^1
"BLD",6357,"QUES",1,0)
POS1
"BLD",6357,"QUES",1,1)
D^::%DT
"BLD",6357,"QUES",1,"A")
Enter when to Queue the Tally job to run in date@time format 
"BLD",6357,"QUES",1,"B")
NOW
"BLD",6357,"QUES",1,"Q")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p.
"BLD",6357,"QUES","B","POS1",1)

"BLD",6357,"REQB",0)
^9.611^^
"INIT")
PSOCPBK1
"MBREQ")
0
"PKG",134,-1)
1^1
"PKG",134,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",134,20,0)
^9.402P^^
"PKG",134,22,0)
^9.49I^1^1
"PKG",134,22,1,0)
7.0^2971216^2980417^1271
"PKG",134,22,1,"PAH",1,0)
215^3050810^33255
"PKG",134,22,1,"PAH",1,1,0)
^^3^3^3050810
"PKG",134,22,1,"PAH",1,1,1,0)
Produce a Tally message & report of all Outpatient Pharmacy refills that 
"PKG",134,22,1,"PAH",1,1,2,0)
were released via the OPAI 2.4 automated interface since the install of 
"PKG",134,22,1,"PAH",1,1,3,0)
patch PSO*7*156.
"QUES","POS1",0)
D^::%DT
"QUES","POS1","?")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p.
"QUES","POS1","A")
Enter when to Queue the Tally job to run in date@time format 
"QUES","POS1","B")
NOW
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOCPBK1")
0^1^B89371510
"RTN","PSOCPBK1",1,0)
PSOCPBK1 ;BIR/EJW,GN-Tally unbilled Automated-release refill copays ;8/10/05 12:50pm
"RTN","PSOCPBK1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**215**;DEC 1997
"RTN","PSOCPBK1",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCPBK1",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCPBK1",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCPBK1",6,0)
 ;
"RTN","PSOCPBK1",7,0)
 N DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC
"RTN","PSOCPBK1",8,0)
 I '$D(XPDQUES("POS1")) D  Q:'ZTDTH
"RTN","PSOCPBK1",9,0)
 .K DIR
"RTN","PSOCPBK1",10,0)
 .S DIR("A")="Enter when to Queue the Tally job to run in date@time format "
"RTN","PSOCPBK1",11,0)
 .S DIR("B")="NOW"
"RTN","PSOCPBK1",12,0)
 .S DIR(0)="D^::%DT"
"RTN","PSOCPBK1",13,0)
 .S DIR("?")="Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p"
"RTN","PSOCPBK1",14,0)
 .D ^DIR I $D(DTOUT)!($D(DUOUT)) W !,"Halting..." S ZTDTH="" Q
"RTN","PSOCPBK1",15,0)
 .S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSOCPBK1",16,0)
 ;
"RTN","PSOCPBK1",17,0)
 I $D(XPDQUES("POS1")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS1"))
"RTN","PSOCPBK1",18,0)
 ;
"RTN","PSOCPBK1",19,0)
 D BMES^XPDUTL("===================================================")
"RTN","PSOCPBK1",20,0)
 D MES^XPDUTL("Queuing background job to tally unbilled refills...")
"RTN","PSOCPBK1",21,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSOCPBK1",22,0)
 D MES^XPDUTL("===================================================")
"RTN","PSOCPBK1",23,0)
 L +^XTMP($$NAMSP):0 I '$T D  Q
"RTN","PSOCPBK1",24,0)
 . I ZTDTH="" D BMES^XPDUTL("Tally job is already running.  Halting...")
"RTN","PSOCPBK1",25,0)
 L -^XTMP($$NAMSP)
"RTN","PSOCPBK1",26,0)
 S ZTRTN="EN^PSOCPBK1",ZTIO=""
"RTN","PSOCPBK1",27,0)
 S ZTDESC="Background job to tally unbilled copays for refills via OPAI"
"RTN","PSOCPBK1",28,0)
 D ^%ZTLOAD
"RTN","PSOCPBK1",29,0)
 D:$D(ZTSK)
"RTN","PSOCPBK1",30,0)
 .D BMES^XPDUTL("=========================")
"RTN","PSOCPBK1",31,0)
 .D MES^XPDUTL("Task #"_ZTSK_" Queued!")
"RTN","PSOCPBK1",32,0)
 .D MES^XPDUTL("=========================")
"RTN","PSOCPBK1",33,0)
 .D BMES^XPDUTL("")
"RTN","PSOCPBK1",34,0)
 D BMES^XPDUTL("")
"RTN","PSOCPBK1",35,0)
 K XPDQUES
"RTN","PSOCPBK1",36,0)
 Q
"RTN","PSOCPBK1",37,0)
EN ;
"RTN","PSOCPBK1",38,0)
 N NAMSP S NAMSP=$$NAMSP
"RTN","PSOCPBK1",39,0)
 ;if can't get Lock, then already running.
"RTN","PSOCPBK1",40,0)
 L +^XTMP(NAMSP):3 I '$T S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOCPBK1",41,0)
 ;if got a lock then must be fresh start, kill possible old Xtmp
"RTN","PSOCPBK1",42,0)
 K ^XTMP(NAMSP)
"RTN","PSOCPBK1",43,0)
 N PSODT,RXP,PSOTEXT,XX,YY,PSOCNT,PSOSTART,PSOEND,PSOVETS,PSOTRX,XIEN
"RTN","PSOCPBK1",44,0)
 N PSOSCMX,PSODFN,PSOREL,PSOAMT,FOUND,V24,PSOTRF,PSOEND2,PSOSTRT2,QQ
"RTN","PSOCPBK1",45,0)
 N PSOTIME,PSOSTNM,PSOS1,PSOINST,I,PSOTC,PSOCNTS,LIN,%,X1,XMY,STOP
"RTN","PSOCPBK1",46,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCPBK1",47,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBK1",48,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCPBK1",49,0)
 I '$D(^XTMP(NAMSP)) S X1=DT D C^%DTC S ^XTMP(NAMSP,0)=$G(X)_"^"_DT_"^Tally of unbilled copays for refills via OPAI, PSO*7*215"
"RTN","PSOCPBK1",50,0)
 ;
"RTN","PSOCPBK1",51,0)
 ;get 1st occurence of install date of patch PSO*7*156 (OPAI)
"RTN","PSOCPBK1",52,0)
 S XIEN=+$O(^XPD(9.7,"B","PSO*7.0*156",0))
"RTN","PSOCPBK1",53,0)
 S PSODT=+$P($G(^XPD(9.7,XIEN,1)),"^",3)
"RTN","PSOCPBK1",54,0)
 I 'PSODT S ^XTMP(NAMSP,0,.1)="OPAI PATCH PSO*7*156 IS NOT INSTALLED" D MAIL3^PSOCPBK2(^XTMP(NAMSP,0,.1)) Q
"RTN","PSOCPBK1",55,0)
 ;
"RTN","PSOCPBK1",56,0)
 ;check if any division is on v2.4 (OPAI interface)
"RTN","PSOCPBK1",57,0)
 S V24=0
"RTN","PSOCPBK1",58,0)
 F XX=0:0 S XX=$O(^PS(59,XX)) Q:'XX  D  Q:V24
"RTN","PSOCPBK1",59,0)
 . S:+$G(^PS(59,XX,"DISP"))=2.4 V24=1
"RTN","PSOCPBK1",60,0)
 I 'V24 D  Q
"RTN","PSOCPBK1",61,0)
 . S ^XTMP(NAMSP,0,.2)="OPAI IS INSTALLED BUT IS NOT TURNED ON"
"RTN","PSOCPBK1",62,0)
 . D MAIL3^PSOCPBK2(^XTMP(NAMSP,0,.2))
"RTN","PSOCPBK1",63,0)
 ;
"RTN","PSOCPBK1",64,0)
 S (PSOTRX,PSOTRF)=1
"RTN","PSOCPBK1",65,0)
 K ^XTMP(NAMSP,0,"STOP") S STOP=0                 ;init stop flag to 0
"RTN","PSOCPBK1",66,0)
 F QQ=1:1 S PSODT=$O(^PSRX("AL",PSODT)) Q:'PSODT  D  Q:STOP
"RTN","PSOCPBK1",67,0)
 .I QQ#100=0,$D(^XTMP(NAMSP,0,"STOP")) K ^XTMP(NAMSP) S STOP=1 Q
"RTN","PSOCPBK1",68,0)
 .S RXP=""
"RTN","PSOCPBK1",69,0)
 .F PSOTRX=PSOTRX+1:1 S RXP=$O(^PSRX("AL",PSODT,RXP)) Q:'RXP  D
"RTN","PSOCPBK1",70,0)
 ..;save last date & fill info
"RTN","PSOCPBK1",71,0)
 ..S ^XTMP(NAMSP,0,"LAST")=PSODT_"^"_RXP_"^"_PSOTRX
"RTN","PSOCPBK1",72,0)
 ..S PSODFN=$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSOCPBK1",73,0)
 ..Q:('PSODFN)!('$D(^DPT(PSODFN,0)))         ;quit, no valid DFN info
"RTN","PSOCPBK1",74,0)
 ..D XTYPE
"RTN","PSOCPBK1",75,0)
 ..Q:+PSOSCMX=0                              ;quit, Exempt or deceased
"RTN","PSOCPBK1",76,0)
 ..;search refills only, ignore 0=orig fill
"RTN","PSOCPBK1",77,0)
 ..F YY=0:0 S YY=$O(^PSRX("AL",PSODT,RXP,YY)) Q:'YY  D ADDBILL
"RTN","PSOCPBK1",78,0)
 Q:STOP
"RTN","PSOCPBK1",79,0)
 ;
"RTN","PSOCPBK1",80,0)
 S PSOCNT=0
"RTN","PSOCPBK1",81,0)
 D TALLY^PSOCPBK2 Q:STOP
"RTN","PSOCPBK1",82,0)
 D TOTAL
"RTN","PSOCPBK1",83,0)
 D MAIL
"RTN","PSOCPBK1",84,0)
 D MAIL2
"RTN","PSOCPBK1",85,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK1",86,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK1",87,0)
 Q
"RTN","PSOCPBK1",88,0)
 ;
"RTN","PSOCPBK1",89,0)
ADDBILL ;add to billable ^XTMP if ok, quit if not
"RTN","PSOCPBK1",90,0)
 S PSOTRF=PSOTRF+1
"RTN","PSOCPBK1",91,0)
 S PSOREL=$P($G(^PSRX(RXP,1,YY,0)),"^",18)
"RTN","PSOCPBK1",92,0)
 Q:'PSOREL                                   ;not released
"RTN","PSOCPBK1",93,0)
 Q:'YY                                       ;orig fill
"RTN","PSOCPBK1",94,0)
 Q:+$$RXST^IBARXEU(PSODFN,$P(PSOREL,"."))    ;Exempt on Rel dte
"RTN","PSOCPBK1",95,0)
 ;check refill
"RTN","PSOCPBK1",96,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",1)'=""    ;already billed
"RTN","PSOCPBK1",97,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",2)'=""    ;exceeded ann. cap
"RTN","PSOCPBK1",98,0)
 ;
"RTN","PSOCPBK1",99,0)
 ;look for Activity log entry per refill # with the below text
"RTN","PSOCPBK1",100,0)
 S FOUND=0
"RTN","PSOCPBK1",101,0)
 F XX=999:0 S XX=$O(^PSRX(RXP,"A",XX),-1) Q:'XX  D  Q:FOUND
"RTN","PSOCPBK1",102,0)
 .Q:$P(^PSRX(RXP,"A",XX,0),"^",4)'=YY
"RTN","PSOCPBK1",103,0)
 .Q:^PSRX(RXP,"A",XX,0)'["External Interface Dispensing is Complete"
"RTN","PSOCPBK1",104,0)
 .S FOUND=1
"RTN","PSOCPBK1",105,0)
 Q:'FOUND
"RTN","PSOCPBK1",106,0)
 ;
"RTN","PSOCPBK1",107,0)
 S ^XTMP(NAMSP,PSODFN,RXP,YY)=$P(PSOREL,".")  ;add to XTMP to be bill
"RTN","PSOCPBK1",108,0)
 Q
"RTN","PSOCPBK1",109,0)
 ;
"RTN","PSOCPBK1",110,0)
MAIL ;
"RTN","PSOCPBK1",111,0)
 N TOTAMT,PSOCXPDA
"RTN","PSOCPBK1",112,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBK1",113,0)
 S PSOEND2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBK1",114,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCPBK1",115,0)
 S XMDUZ="Outpatient Pharmacy",XMSUB="Outpatient Pharmacy Copay Tally"
"RTN","PSOCPBK1",116,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPBK1",117,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCPBK1",118,0)
 S PSOTEXT(1)="The Rx copay tally job for the Outpatient Pharmacy patch (PSO*7*215)"
"RTN","PSOCPBK1",119,0)
 S PSOTEXT(2)="started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSOCPBK1",120,0)
 I PSOCNT=0 S PSOTEXT(3)="No released unbilled copay fills were found."
"RTN","PSOCPBK1",121,0)
 I PSOCNT>0 D
"RTN","PSOCPBK1",122,0)
 .S TOTAMT=0
"RTN","PSOCPBK1",123,0)
 .F XX="YR2004","YR2005" D
"RTN","PSOCPBK1",124,0)
 ..F YY=1:1:3 S PSOAMT(XX,YY)=PSOCNT(XX,YY)*YY*7,TOTAMT=TOTAMT+PSOAMT(XX,YY)
"RTN","PSOCPBK1",125,0)
 .S PSOTEXT(3)="Auto-Released refills have now been marked as potentials for back billing."
"RTN","PSOCPBK1",126,0)
 .S PSOTEXT(4)="There were "_$FN(PSOCNT,",")_" fills successfully tallied for "_$FN(PSOVETS,",")_" veterans."
"RTN","PSOCPBK1",127,0)
 .S PSOTEXT(5)=" "
"RTN","PSOCPBK1",128,0)
 .S PSOTEXT(6)="Fills eligible for back-billing by year:"
"RTN","PSOCPBK1",129,0)
 .S PSOTEXT(7)="2004  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",1),6)
"RTN","PSOCPBK1",130,0)
 .S PSOTEXT(7)=PSOTEXT(7)_"     $"_$J($FN(PSOAMT("YR2004",1),","),9)
"RTN","PSOCPBK1",131,0)
 .S PSOTEXT(8)="2004  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",2),6)
"RTN","PSOCPBK1",132,0)
 .S PSOTEXT(8)=PSOTEXT(8)_"     $"_$J($FN(PSOAMT("YR2004",2),","),9)
"RTN","PSOCPBK1",133,0)
 .S PSOTEXT(9)="2004  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",3),6)
"RTN","PSOCPBK1",134,0)
 .S PSOTEXT(9)=PSOTEXT(9)_"     $"_$J($FN(PSOAMT("YR2004",3),","),9)
"RTN","PSOCPBK1",135,0)
 .S PSOTEXT(10)=""
"RTN","PSOCPBK1",136,0)
 .S PSOTEXT(11)="2005  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",1),6)
"RTN","PSOCPBK1",137,0)
 .S PSOTEXT(11)=PSOTEXT(11)_"     $"_$J($FN(PSOAMT("YR2005",1),","),9)
"RTN","PSOCPBK1",138,0)
 .S PSOTEXT(12)="2005  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",2),6)
"RTN","PSOCPBK1",139,0)
 .S PSOTEXT(12)=PSOTEXT(12)_"     $"_$J($FN(PSOAMT("YR2005",2),","),9)
"RTN","PSOCPBK1",140,0)
 .S PSOTEXT(13)="2005  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",3),6)
"RTN","PSOCPBK1",141,0)
 .S PSOTEXT(13)=PSOTEXT(13)_"     $"_$J($FN(PSOAMT("YR2005",3),","),9)
"RTN","PSOCPBK1",142,0)
 .S PSOTEXT(14)="                                          =========="
"RTN","PSOCPBK1",143,0)
 .S PSOTEXT(15)="                                    TOTAL $"_$J($FN(TOTAMT,","),9)
"RTN","PSOCPBK1",144,0)
 .S PSOTEXT(16)=" "
"RTN","PSOCPBK1",145,0)
 .S PSOTEXT(17)="To get a report of patients/prescriptions that were identified as potentially"
"RTN","PSOCPBK1",146,0)
 .S PSOTEXT(18)="billable as part of this Tally, enter D RPT^PSOCPBK2 at the programmer's prompt"
"RTN","PSOCPBK1",147,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK1",148,0)
 Q
"RTN","PSOCPBK1",149,0)
 ;
"RTN","PSOCPBK1",150,0)
MAIL2 ;
"RTN","PSOCPBK1",151,0)
 S LIN="",$P(LIN," ",80)=""
"RTN","PSOCPBK1",152,0)
 D NOW^%DTC S PSOTIME=$$FMDIFF^XLFDT(%,$G(PSOS1),2)
"RTN","PSOCPBK1",153,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBK1",154,0)
 S PSOSTNM=$P($G(^DIC(4,PSOINST,0)),"^")
"RTN","PSOCPBK1",155,0)
 K PSOTEXT
"RTN","PSOCPBK1",156,0)
 S XMY(DUZ)="",PSOTC=0,PSOCNTS=""
"RTN","PSOCPBK1",157,0)
 F J="YR2004","YR2005" F I=1:1:3 D
"RTN","PSOCPBK1",158,0)
 .S PSOTC=PSOTC+PSOCNT(J,I)
"RTN","PSOCPBK1",159,0)
 .S PSOCNTS=PSOCNTS_","_PSOCNT(J,I)
"RTN","PSOCPBK1",160,0)
 S XMY("NAPOLIELLO.GREG@FORUM.VA.GOV")=""
"RTN","PSOCPBK1",161,0)
 S XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOCPBK1",162,0)
 S:$$PROD^XUPROD(1) XMY("WILLIAMSON.ERIC@FORUM.VA.GOV")=""
"RTN","PSOCPBK1",163,0)
 S XMDUZ="PSO*7*215 TALLY"
"RTN","PSOCPBK1",164,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCPBK1",165,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):"(Prod)",1:"(Test)")
"RTN","PSOCPBK1",166,0)
 S XMSUB=XMSUB_" UNBILLED COPAYS FOR PRESCRIPTION REFILLS"
"RTN","PSOCPBK1",167,0)
 S PSOTEXT(1)="               Start time: "_PSOSTRT2
"RTN","PSOCPBK1",168,0)
 S PSOTEXT(2)="           Completed time: "_PSOEND2
"RTN","PSOCPBK1",169,0)
 S PSOTEXT(3)="             Elapsed Time: "_$$ETIME^PSOCPBK2(PSOTIME)
"RTN","PSOCPBK1",170,0)
 S PSOTEXT(4)=""
"RTN","PSOCPBK1",171,0)
 S PSOTEXT(5)="     Total RX's processed: "_$J($FN(PSOTRX,","),8)
"RTN","PSOCPBK1",172,0)
 S PSOTEXT(6)="  Total Refills processed: "_$J($FN(PSOTRF,","),8)
"RTN","PSOCPBK1",173,0)
 S PSOTEXT(7)="   Total billable refills: "_$J($FN(PSOTC,","),8)
"RTN","PSOCPBK1",174,0)
 S PSOTEXT(8)="      Total billable vets: "_$J($FN(PSOVETS,","),8)
"RTN","PSOCPBK1",175,0)
 S PSOTEXT(9)=""
"RTN","PSOCPBK1",176,0)
 S PSOTEXT(10)="Excel comma delimited data below, Two heading, one data line"
"RTN","PSOCPBK1",177,0)
 S PSOTEXT(11)=""
"RTN","PSOCPBK1",178,0)
 S PSOTEXT(12)="Copy and paste any of the 2 heading & 1 data rows into Excel.  Then click "
"RTN","PSOCPBK1",179,0)
 S PSOTEXT(13)="'Data', 'Text to Columns..', check 'Delimited', click Next, check 'Comma',"
"RTN","PSOCPBK1",180,0)
 S PSOTEXT(14)="and click Finish"
"RTN","PSOCPBK1",181,0)
 S PSOTEXT(15)=""
"RTN","PSOCPBK1",182,0)
 S PSOTEXT(16)=$E(("Station,Station,,2004,,,2005"_LIN),1,79)
"RTN","PSOCPBK1",183,0)
 S PSOTEXT(17)=$E(("Name,#,30 days,60 days,90 days,30 days,60 days,90 days"_LIN),1,79)
"RTN","PSOCPBK1",184,0)
 S PSOTEXT(18)=$E((PSOSTNM_","_PSOINST_PSOCNTS_LIN),1,79)
"RTN","PSOCPBK1",185,0)
 S PSOTEXT(19)=""
"RTN","PSOCPBK1",186,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK1",187,0)
 Q
"RTN","PSOCPBK1",188,0)
 ;
"RTN","PSOCPBK1",189,0)
XTYPE ;
"RTN","PSOCPBK1",190,0)
 N Y,VADM,I,J,X,SAVY,DFN
"RTN","PSOCPBK1",191,0)
 S DFN=PSODFN D DEM^VADPT I +$G(VADM(6)) S PSOSCMX="" Q  ; DECEASED
"RTN","PSOCPBK1",192,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPBK1",193,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPBK1",194,0)
 I 'X Q
"RTN","PSOCPBK1",195,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCPBK1",196,0)
 I $G(Y)'=1 Q
"RTN","PSOCPBK1",197,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPBK1",198,0)
 I PSOSCMX="",SAVY=0 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPBK1",199,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCPBK1",200,0)
 Q
"RTN","PSOCPBK1",201,0)
 ;
"RTN","PSOCPBK1",202,0)
TOTAL ;
"RTN","PSOCPBK1",203,0)
 N COUNT,COUNTED
"RTN","PSOCPBK1",204,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCPBK1",205,0)
 N I,J
"RTN","PSOCPBK1",206,0)
 F I=1:1:3 S (PSOCNT("YR2004",I),PSOCNT("YR2005",I))=0
"RTN","PSOCPBK1",207,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D
"RTN","PSOCPBK1",208,0)
 .S COUNTED=0
"RTN","PSOCPBK1",209,0)
 .F J="YR2004","YR2005" F I=1:1:3 S COUNT=$G(^XTMP(NAMSP,PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCPBK1",210,0)
 F I=1:1:3 S PSOCNT=PSOCNT+PSOCNT("YR2004",I)+PSOCNT("YR2005",I)
"RTN","PSOCPBK1",211,0)
 Q
"RTN","PSOCPBK1",212,0)
 ;
"RTN","PSOCPBK1",213,0)
STATUS ;show status of job running
"RTN","PSOCPBK1",214,0)
 I $$ST D
"RTN","PSOCPBK1",215,0)
 .W !,"Currently processing:"
"RTN","PSOCPBK1",216,0)
 .W !?5,"Released Date > ",+^XTMP($$NAMSP,0,"LAST")
"RTN","PSOCPBK1",217,0)
 .W !?5,"         RX # > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",2)
"RTN","PSOCPBK1",218,0)
 .W !?5,"   TOTAL RX's > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",3),!
"RTN","PSOCPBK1",219,0)
 Q
"RTN","PSOCPBK1",220,0)
 ;
"RTN","PSOCPBK1",221,0)
STOP ;stop job command
"RTN","PSOCPBK1",222,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSOCPBK1",223,0)
 .W !,"Outpatient RX Copay Tally Job - set to STOP Soon"
"RTN","PSOCPBK1",224,0)
 .W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSOCPBK1",225,0)
 .W !,"     (D STATUS^PSOCPBK1)"
"RTN","PSOCPBK1",226,0)
 Q
"RTN","PSOCPBK1",227,0)
ST() ;status
"RTN","PSOCPBK1",228,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSOCPBK1",229,0)
 .L -^XTMP($$NAMSP)
"RTN","PSOCPBK1",230,0)
 .W !,"*** TALLY NOT CURRENTLY RUNNING! ***",!
"RTN","PSOCPBK1",231,0)
 Q 1
"RTN","PSOCPBK1",232,0)
NAMSP() ;
"RTN","PSOCPBK1",233,0)
 Q $T(+0)
"RTN","PSOCPBK2")
0^2^B54982346
"RTN","PSOCPBK2",1,0)
PSOCPBK2 ;BIR/EJW,GN-Tally Automated-release refill copay cont. ;8/10/05 12:03pm
"RTN","PSOCPBK2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**215**;DEC 1997
"RTN","PSOCPBK2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCPBK2",4,0)
 ;External reference to ^IBAM(354.7 supported by DBIA 3877
"RTN","PSOCPBK2",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCPBK2",6,0)
 ;
"RTN","PSOCPBK2",7,0)
TALLY ;
"RTN","PSOCPBK2",8,0)
 ; IF NO IB NUMBER FOR THIS FILL, SET UP VARIABLES AND TALLY
"RTN","PSOCPBK2",9,0)
 N PSOCAP,PSODIV,PSODV,PSOFILL,PSOLOG,PSOOUT,PSOPAR,PSOPATID,PSOSITE
"RTN","PSOCPBK2",10,0)
 N PSOSITE7,PSOSQ,PSOTOT,PSOYEAR,PSOYR,SSN
"RTN","PSOCPBK2",11,0)
 S PSODFN=0
"RTN","PSOCPBK2",12,0)
 F QQ=1:1 S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D  Q:STOP
"RTN","PSOCPBK2",13,0)
 .I QQ#100=0,$D(^XTMP(NAMSP,0,"STOP")) K ^XTMP(NAMSP) S STOP=1
"RTN","PSOCPBK2",14,0)
 .S (PSOCAP(304),PSOCAP(305))=0 ; INITIAL ANNUAL CAP FOR 2004 & 2005
"RTN","PSOCPBK2",15,0)
 .F RXP=0:0 S RXP=$O(^XTMP(NAMSP,PSODFN,RXP)) Q:'RXP  D
"RTN","PSOCPBK2",16,0)
 ..F YY=0:0 S YY=$O(^XTMP(NAMSP,PSODFN,RXP,YY)) Q:YY=""  D
"RTN","PSOCPBK2",17,0)
 ...S PSOREL=$G(^XTMP(NAMSP,PSODFN,RXP,YY))
"RTN","PSOCPBK2",18,0)
 ...I PSOCAP($E(PSOREL,1,3)) Q  ; MET ANNUAL CAP FOR 2004 OR 2005
"RTN","PSOCPBK2",19,0)
 ...I $P($G(^PSRX(RXP,1,YY,"IB")),"^",1)="" D  ; REFILL LEVEL
"RTN","PSOCPBK2",20,0)
 ....D SITE
"RTN","PSOCPBK2",21,0)
 ....D CP
"RTN","PSOCPBK2",22,0)
 Q
"RTN","PSOCPBK2",23,0)
 ;
"RTN","PSOCPBK2",24,0)
CP ; Entry point to Check if COPAY  -   Requires RXP,PSOSITE7
"RTN","PSOCPBK2",25,0)
 I '$D(PSOPAR) D ^PSOLSET G CP
"RTN","PSOCPBK2",26,0)
 K PSOCP
"RTN","PSOCPBK2",27,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2) ; Set COPAY dfn PTR TO PATIENT
"RTN","PSOCPBK2",28,0)
 S PSOCP=$P($G(^PSRX(RXP,"IB")),"^") ; IB action type
"RTN","PSOCPBK2",29,0)
 S PSOSAVE=$S(PSOCP:1,1:"") ; save current copay status
"RTN","PSOCPBK2",30,0)
 ;         Set x=service^dfn^actiontype^user duz
"RTN","PSOCPBK2",31,0)
 I +$G(PSOSITE7)'>0 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCPBK2",32,0)
 S X=PSOSITE7_"^"_PSOCPN_"^"_PSOCP_"^"_$P(^PSRX(RXP,0),"^",16)
"RTN","PSOCPBK2",33,0)
 ;
"RTN","PSOCPBK2",34,0)
RX ;         Determine Original or Refill for RX
"RTN","PSOCPBK2",35,0)
 N PSOIB
"RTN","PSOCPBK2",36,0)
 S PSOIB=0
"RTN","PSOCPBK2",37,0)
 S PSOREF=0
"RTN","PSOCPBK2",38,0)
 ;set refill number if this is a refill
"RTN","PSOCPBK2",39,0)
 I $G(^PSRX(RXP,1,+$G(YY),0))]"" S PSOREF=YY
"RTN","PSOCPBK2",40,0)
 ;
"RTN","PSOCPBK2",41,0)
 ;Orig fill -check if bill # already exists
"RTN","PSOCPBK2",42,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1
"RTN","PSOCPBK2",43,0)
 I PSOIB G QUIT
"RTN","PSOCPBK2",44,0)
 ;already attempted to bill, but exceeded Anuual Cap
"RTN","PSOCPBK2",45,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",4)>0 G QUIT
"RTN","PSOCPBK2",46,0)
 ;
"RTN","PSOCPBK2",47,0)
 ;Refill -check if bill # already exists
"RTN","PSOCPBK2",48,0)
 I PSOREF,+$G(^PSRX(RXP,1,PSOREF,"IB")) D CHKIB^PSOCP1
"RTN","PSOCPBK2",49,0)
 I PSOIB G QUIT
"RTN","PSOCPBK2",50,0)
 ;already attempted to bill, but exceeded Anuual Cap
"RTN","PSOCPBK2",51,0)
 I PSOREF,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^",2) G QUIT
"RTN","PSOCPBK2",52,0)
 ;
"RTN","PSOCPBK2",53,0)
 ;set temporary variable to copay and then look for exceptions
"RTN","PSOCPBK2",54,0)
 S PSOCHG=1
"RTN","PSOCPBK2",55,0)
 D COPAYREL
"RTN","PSOCPBK2",56,0)
 I 'PSOCHG G QUIT            ;not billable
"RTN","PSOCPBK2",57,0)
 I PSOCHG=2 I 'PSOCP G QUIT
"RTN","PSOCPBK2",58,0)
 ;  Units for COPAY
"RTN","PSOCPBK2",59,0)
 ;calc number of 30-day units eligible to bill
"RTN","PSOCPBK2",60,0)
 S PSOCPUN=($P(^PSRX(RXP,0),"^",8)+29)\30
"RTN","PSOCPBK2",61,0)
 D ACCUM
"RTN","PSOCPBK2",62,0)
QUIT ;
"RTN","PSOCPBK2",63,0)
 K Y,PSOCP1,PSOCP2,PSOCPN,X,PSOCPUN,PSOREF,PSOCHG,PSOSAVE,PREA,PSORSN
"RTN","PSOCPBK2",64,0)
 Q
"RTN","PSOCPBK2",65,0)
 ;
"RTN","PSOCPBK2",66,0)
COPAYREL ; Recheck copay status at release
"RTN","PSOCPBK2",67,0)
 ;
"RTN","PSOCPBK2",68,0)
 ; check Rx patient status
"RTN","PSOCPBK2",69,0)
 I $P(^PSRX(RXP,0),"^",3)'="",$P($G(^PS(53,$P(^PSRX(RXP,0),"^",3),0)),"^",7)=1 S PSOCHG=0 Q
"RTN","PSOCPBK2",70,0)
 ; see if drug is investigational or supply
"RTN","PSOCPBK2",71,0)
 N DRG,DRGTYP
"RTN","PSOCPBK2",72,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6),DRGTYP=$P($G(^PSDRUG(DRG,0)),"^",3)
"RTN","PSOCPBK2",73,0)
 I DRGTYP["I" S PSOCHG=0 Q
"RTN","PSOCPBK2",74,0)
 I DRGTYP["S" S PSOCHG=0 Q
"RTN","PSOCPBK2",75,0)
 K PSOTG,CHKXTYPE
"RTN","PSOCPBK2",76,0)
 I +$G(^PSRX(RXP,"IBQ")) D XTYPE1^PSOCP1
"RTN","PSOCPBK2",77,0)
 I $G(^PSRX(RXP,"IBQ"))["1" S PSOCHG=0 Q
"RTN","PSOCPBK2",78,0)
 Q
"RTN","PSOCPBK2",79,0)
 ;
"RTN","PSOCPBK2",80,0)
ACCUM ; ACCUMULATE TOTALS AND SEE IF PATIENT MET ANNUAL CAP
"RTN","PSOCPBK2",81,0)
 S PSOYR=$E(PSOREL,1,3) I PSOYR="" Q
"RTN","PSOCPBK2",82,0)
 S PSOYEAR=$S(PSOYR="304":"YR2004",PSOYR="305":"YR2005",1:"")
"RTN","PSOCPBK2",83,0)
 Q:PSOYEAR=""
"RTN","PSOCPBK2",84,0)
 ;
"RTN","PSOCPBK2",85,0)
 ;get Xtmp billing amt which would be IBAM tot + any previous refills
"RTN","PSOCPBK2",86,0)
 S PSOTOT=$G(^XTMP(NAMSP,PSODFN,PSOYEAR))
"RTN","PSOCPBK2",87,0)
 ;
"RTN","PSOCPBK2",88,0)
 ;if none yegt then init to the IBAM total for the year
"RTN","PSOCPBK2",89,0)
 I 'PSOTOT D
"RTN","PSOCPBK2",90,0)
 .F PSOSQ=0:0 S PSOSQ=$O(^IBAM(354.7,PSODFN,1,PSOSQ)) Q:'PSOSQ  D
"RTN","PSOCPBK2",91,0)
 ..S PSOLOG=$G(^IBAM(354.7,PSODFN,1,PSOSQ,0))
"RTN","PSOCPBK2",92,0)
 ..I $E(PSOLOG,1,3)=PSOYR S PSOTOT=PSOTOT+$P(PSOLOG,"^",2)
"RTN","PSOCPBK2",93,0)
 ;
"RTN","PSOCPBK2",94,0)
 ;see if current refill added to tot exceeds annual cap and quit
"RTN","PSOCPBK2",95,0)
 I PSOTOT+(7*PSOCPUN)>840 S PSOCAP(PSOYR)=1 Q
"RTN","PSOCPBK2",96,0)
 ;
"RTN","PSOCPBK2",97,0)
 ;update Xtmp tot nodes with current refill amounts
"RTN","PSOCPBK2",98,0)
 S ^XTMP(NAMSP,PSODFN,PSOYEAR)=PSOTOT+(PSOCPUN*7)
"RTN","PSOCPBK2",99,0)
 S ^XTMP(NAMSP,PSODFN,PSOYEAR,PSOCPUN)=$G(^XTMP(NAMSP,PSODFN,PSOYEAR,PSOCPUN))+1
"RTN","PSOCPBK2",100,0)
 ;
"RTN","PSOCPBK2",101,0)
 ;indicate this refill would be billable by adding to Xtmp "BILLED"
"RTN","PSOCPBK2",102,0)
 N PSONAM
"RTN","PSOCPBK2",103,0)
 S PSONAM=$P($G(^DPT(PSODFN,0)),"^"),PSONAM=$P(PSONAM,",")
"RTN","PSOCPBK2",104,0)
 S PSONAM=$E(PSONAM,1,6)
"RTN","PSOCPBK2",105,0)
 S ^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOREF)=PSOREL
"RTN","PSOCPBK2",106,0)
 Q
"RTN","PSOCPBK2",107,0)
 ;
"RTN","PSOCPBK2",108,0)
SITE ; SET UP VARIABLES NEEDED BY BILLING
"RTN","PSOCPBK2",109,0)
 S PSOSITE=$S(YY=0:$P(^PSRX(RXP,2),"^",9),1:$P($G(^PSRX(RXP,1,YY,0)),"^",9))
"RTN","PSOCPBK2",110,0)
 Q:PSOSITE=""
"RTN","PSOCPBK2",111,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSOCPBK2",112,0)
 S PSOSITE7=$P($G(^PS(59,PSOSITE,"IB")),"^")
"RTN","PSOCPBK2",113,0)
 Q
"RTN","PSOCPBK2",114,0)
 ;
"RTN","PSOCPBK2",115,0)
RPT ;
"RTN","PSOCPBK2",116,0)
 N NAMSP S NAMSP=$$NAMSP^PSOCPBK1
"RTN","PSOCPBK2",117,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCPBK2",118,0)
 . W !,"Copay Tally job for PSO*7*215 is still running.  Halting..."
"RTN","PSOCPBK2",119,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK2",120,0)
 W !!,"This report shows the patient name and prescription information for refills"
"RTN","PSOCPBK2",121,0)
 W !,"that were indentified as billable by the tally patch PSO*7*215"
"RTN","PSOCPBK2",122,0)
 W !!,"You may queue the report to print, if you wish.",!
"RTN","PSOCPBK2",123,0)
 ;
"RTN","PSOCPBK2",124,0)
DVC K %ZIS,POP,IOP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! G DONE
"RTN","PSOCPBK2",125,0)
QUEUE I $D(IO("Q")) S ZTRTN="START^PSOCPBK2",ZTDESC="Potential Billable copay report" D ^%ZTLOAD K %ZSI W !,"Report queued to print.",! G DONE
"RTN","PSOCPBK2",126,0)
START ;
"RTN","PSOCPBK2",127,0)
 U IO
"RTN","PSOCPBK2",128,0)
 N NAMSP S NAMSP=$$NAMSP^PSOCPBK1
"RTN","PSOCPBK2",129,0)
 S PSOOUT=0,PSODV=$S($E(IOST)="C":"C",1:"P")
"RTN","PSOCPBK2",130,0)
 S PSOPGCT=0,PSOPGLN=IOSL-7,PSOPGCT=1
"RTN","PSOCPBK2",131,0)
 D TITLE
"RTN","PSOCPBK2",132,0)
 S PSONAM=""
"RTN","PSOCPBK2",133,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"BILLED",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCPBK2",134,0)
 .S PSODFN=""
"RTN","PSOCPBK2",135,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCPBK2",136,0)
 ..S RXP=""
"RTN","PSOCPBK2",137,0)
 ..F  S RXP=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP)) Q:RXP=""  D
"RTN","PSOCPBK2",138,0)
 ...S PSOFILL=""
"RTN","PSOCPBK2",139,0)
 ...F  S PSOFILL=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSOCPBK2",140,0)
 ....N XX,PSONAME
"RTN","PSOCPBK2",141,0)
 ....S XX=$G(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOFILL)) D
"RTN","PSOCPBK2",142,0)
 .....D FULL Q:$G(PSOOUT)  S PSONAME=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCPBK2",143,0)
 .....W !,$E(PSONAME,1,14) D PRTSSN
"RTN","PSOCPBK2",144,0)
 .....W ?46," ",RXP," (",PSOFILL,")" D
"RTN","PSOCPBK2",145,0)
 ......S Y=XX I Y>0 X ^DD("DD")
"RTN","PSOCPBK2",146,0)
 ......W ?65," ",Y
"RTN","PSOCPBK2",147,0)
 G END
"RTN","PSOCPBK2",148,0)
 ;
"RTN","PSOCPBK2",149,0)
FULL ;
"RTN","PSOCPBK2",150,0)
 I ($Y+7)>IOSL&('$G(PSOOUT)) D TITLE
"RTN","PSOCPBK2",151,0)
 Q
"RTN","PSOCPBK2",152,0)
 ;
"RTN","PSOCPBK2",153,0)
TITLE ;
"RTN","PSOCPBK2",154,0)
 I $G(PSODV)="C",$G(PSOPGCT)'=1 W ! K DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSOOUT=1 Q
"RTN","PSOCPBK2",155,0)
 ;
"RTN","PSOCPBK2",156,0)
 W @IOF D
"RTN","PSOCPBK2",157,0)
 . W !,"Patch PSO*7*215 -COPAY PRESCRIPTION REFILLS BILLABLE"
"RTN","PSOCPBK2",158,0)
 S Y=DT X ^DD("DD") W !,"Date printed: ",Y,?70,"Page: ",PSOPGCT,!
"RTN","PSOCPBK2",159,0)
 F MJT=1:1:79 W "="
"RTN","PSOCPBK2",160,0)
 W !,"PATIENT NAME     (SSN)       DIV",?48,"RX# (FILL)",?66,"RELEASE DATE"
"RTN","PSOCPBK2",161,0)
 W !,"--------------  -------  ----------------",?47,"------------"
"RTN","PSOCPBK2",162,0)
 W ?66,"------------"
"RTN","PSOCPBK2",163,0)
 S PSOPGCT=PSOPGCT+1
"RTN","PSOCPBK2",164,0)
 Q
"RTN","PSOCPBK2",165,0)
END ;
"RTN","PSOCPBK2",166,0)
 I '$G(PSOOUT),$G(PSODV)="C" W !!,"** End of Report **" K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOCPBK2",167,0)
 I $G(PSODV)="C" W !
"RTN","PSOCPBK2",168,0)
 E  W @IOF
"RTN","PSOCPBK2",169,0)
DONE ;
"RTN","PSOCPBK2",170,0)
 K MJT,PSOPGCT,PSOPGLN,Y,DIR,X,IOP,POP,IO("Q"),DIRUT,DUOUT,DTOUT
"RTN","PSOCPBK2",171,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK2",172,0)
 Q
"RTN","PSOCPBK2",173,0)
 ;
"RTN","PSOCPBK2",174,0)
PRTSSN ;
"RTN","PSOCPBK2",175,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9),SSN=$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","PSOCPBK2",176,0)
 S PSOPATID=$E(PSONAM,1)_SSN
"RTN","PSOCPBK2",177,0)
 S PSODIV=$P($G(^PSRX(RXP,2)),"^",9)
"RTN","PSOCPBK2",178,0)
 S:PSODIV'="" PSODIV=$P($G(^PS(59,PSODIV,0)),"^",1)
"RTN","PSOCPBK2",179,0)
 W "  ("_PSOPATID_")"_"  "_PSODIV
"RTN","PSOCPBK2",180,0)
 Q
"RTN","PSOCPBK2",181,0)
 ;
"RTN","PSOCPBK2",182,0)
ETIME(SECTIME) ;convert seconds to day:hr:min:sec
"RTN","PSOCPBK2",183,0)
 N DAY,HR,MIN,SEC,ETIM
"RTN","PSOCPBK2",184,0)
 S (DAY,HR,MIN,SEC)=""
"RTN","PSOCPBK2",185,0)
 I SECTIME>86400 S DAY=SECTIME\86400,SECTIME=SECTIME#86400
"RTN","PSOCPBK2",186,0)
 I SECTIME>3600 S HR=SECTIME\3600,SECTIME=SECTIME#3600
"RTN","PSOCPBK2",187,0)
 I SECTIME>60 S MIN=SECTIME\60,SECTIME=SECTIME#60
"RTN","PSOCPBK2",188,0)
 S SEC=SECTIME
"RTN","PSOCPBK2",189,0)
 S ETIM=""
"RTN","PSOCPBK2",190,0)
 S:$L(HR)=1 HR=0_HR S:$L(MIN)=1 MIN=0_MIN S:$L(SEC)=1 SEC=0_SEC
"RTN","PSOCPBK2",191,0)
 S:DAY ETIM=DAY_" Day " S:HR ETIM=ETIM_HR_":" S:MIN ETIM=ETIM_MIN
"RTN","PSOCPBK2",192,0)
 S ETIM=ETIM_":"_SEC
"RTN","PSOCPBK2",193,0)
 Q ETIM
"RTN","PSOCPBK2",194,0)
 ;
"RTN","PSOCPBK2",195,0)
MAIL3(MSG) ;
"RTN","PSOCPBK2",196,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBK2",197,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBK2",198,0)
 K PSOTEXT
"RTN","PSOCPBK2",199,0)
 S XMY(DUZ)=""
"RTN","PSOCPBK2",200,0)
 S XMY("NAPOLIELLO.GREG@FORUM.VA.GOV")=""
"RTN","PSOCPBK2",201,0)
 S XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOCPBK2",202,0)
 S:$$PROD^XUPROD(1) XMY("WILLIAMSON.ERIC@FORUM.VA.GOV")=""
"RTN","PSOCPBK2",203,0)
 S XMDUZ="PSO*7*215 TALLY"
"RTN","PSOCPBK2",204,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCPBK2",205,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):"(Prod)",1:"(Test)")
"RTN","PSOCPBK2",206,0)
 S XMSUB=XMSUB_" UNBILLED COPAYS FOR PRESCRIPTION REFILLS"
"RTN","PSOCPBK2",207,0)
 S PSOTEXT(1)=""
"RTN","PSOCPBK2",208,0)
 S PSOTEXT(2)="Started "_PSOSTART
"RTN","PSOCPBK2",209,0)
 S PSOTEXT(3)=""
"RTN","PSOCPBK2",210,0)
 S PSOTEXT(4)="   "_MSG
"RTN","PSOCPBK2",211,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK2",212,0)
 Q
"VER")
8.0^22.0
"BLD",6357,6)
^SEQ #187
**END**
**END**
