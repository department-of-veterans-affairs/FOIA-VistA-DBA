Released SR*3*148 SEQ #142
Extracted from mail message
**KIDS**:SR*3.0*148^

**INSTALL NAME**
SR*3.0*148
"BLD",5447,0)
SR*3.0*148^SURGERY^0^3050901^y
"BLD",5447,1,0)
^^4^4^3050823^
"BLD",5447,1,1,0)
This patch modifies the Blood Product Verification [SR BLOOD PRODUCT 
"BLD",5447,1,2,0)
VERIFICATION] option to reference the VistA Blood Establishment Computer 
"BLD",5447,1,3,0)
Software (VBECS) if installed. This change allows the option to maintain 
"BLD",5447,1,4,0)
its current functionality before and after VBECS is installed.
"BLD",5447,4,0)
^9.64PA^^
"BLD",5447,6)
1^
"BLD",5447,"KRN",0)
^9.67PA^8989.52^19
"BLD",5447,"KRN",.4,0)
.4
"BLD",5447,"KRN",.401,0)
.401
"BLD",5447,"KRN",.402,0)
.402
"BLD",5447,"KRN",.403,0)
.403
"BLD",5447,"KRN",.5,0)
.5
"BLD",5447,"KRN",.84,0)
.84
"BLD",5447,"KRN",3.6,0)
3.6
"BLD",5447,"KRN",3.8,0)
3.8
"BLD",5447,"KRN",9.2,0)
9.2
"BLD",5447,"KRN",9.8,0)
9.8
"BLD",5447,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5447,"KRN",9.8,"NM",1,0)
SRBL^^0^B18632447
"BLD",5447,"KRN",9.8,"NM",2,0)
SRBLOOD^^0^B20308980
"BLD",5447,"KRN",9.8,"NM","B","SRBL",1)

"BLD",5447,"KRN",9.8,"NM","B","SRBLOOD",2)

"BLD",5447,"KRN",19,0)
19
"BLD",5447,"KRN",19.1,0)
19.1
"BLD",5447,"KRN",101,0)
101
"BLD",5447,"KRN",409.61,0)
409.61
"BLD",5447,"KRN",771,0)
771
"BLD",5447,"KRN",870,0)
870
"BLD",5447,"KRN",8989.51,0)
8989.51
"BLD",5447,"KRN",8989.52,0)
8989.52
"BLD",5447,"KRN",8994,0)
8994
"BLD",5447,"KRN","B",.4,.4)

"BLD",5447,"KRN","B",.401,.401)

"BLD",5447,"KRN","B",.402,.402)

"BLD",5447,"KRN","B",.403,.403)

"BLD",5447,"KRN","B",.5,.5)

"BLD",5447,"KRN","B",.84,.84)

"BLD",5447,"KRN","B",3.6,3.6)

"BLD",5447,"KRN","B",3.8,3.8)

"BLD",5447,"KRN","B",9.2,9.2)

"BLD",5447,"KRN","B",9.8,9.8)

"BLD",5447,"KRN","B",19,19)

"BLD",5447,"KRN","B",19.1,19.1)

"BLD",5447,"KRN","B",101,101)

"BLD",5447,"KRN","B",409.61,409.61)

"BLD",5447,"KRN","B",771,771)

"BLD",5447,"KRN","B",870,870)

"BLD",5447,"KRN","B",8989.51,8989.51)

"BLD",5447,"KRN","B",8989.52,8989.52)

"BLD",5447,"KRN","B",8994,8994)

"BLD",5447,"QUES",0)
^9.62^^
"BLD",5447,"REQB",0)
^9.611^1^1
"BLD",5447,"REQB",1,0)
SR*3.0*101^2
"BLD",5447,"REQB","B","SR*3.0*101",1)

"MBREQ")
0
"PKG",167,-1)
1^1
"PKG",167,0)
SURGERY^SR^SURGICAL DATA COLLECTION AND OPERATIONS SCHEDULING
"PKG",167,20,0)
^9.402P^^
"PKG",167,22,0)
^9.49I^1^1
"PKG",167,22,1,0)
3.0^3040426^2930811
"PKG",167,22,1,"PAH",1,0)
148^3050901^517
"PKG",167,22,1,"PAH",1,1,0)
^^4^4^3050901
"PKG",167,22,1,"PAH",1,1,1,0)
This patch modifies the Blood Product Verification [SR BLOOD PRODUCT 
"PKG",167,22,1,"PAH",1,1,2,0)
VERIFICATION] option to reference the VistA Blood Establishment Computer 
"PKG",167,22,1,"PAH",1,1,3,0)
Software (VBECS) if installed. This change allows the option to maintain 
"PKG",167,22,1,"PAH",1,1,4,0)
its current functionality before and after VBECS is installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","SRBL")
0^1^B18632447
"RTN","SRBL",1,0)
SRBL ;BIR/ADM - BLOOD PRODUCT VERIFICATION FOR VBECS ;09/01/05
"RTN","SRBL",2,0)
 ;;3.0; Surgery ;**148**;24 Jun 93
"RTN","SRBL",3,0)
 ; 
"RTN","SRBL",4,0)
 ; Reference to AVUNIT^VBECA1B supported by DBIA #4629
"RTN","SRBL",5,0)
 ;
"RTN","SRBL",6,0)
SCAN D BAR ; test bar code reader
"RTN","SRBL",7,0)
 S SRQ=0,DFN=$P(^SRF(SRTN,0),"^") K ^TMP("SRBL",$J)
"RTN","SRBL",8,0)
 D AVUNIT^VBECA1B("SRBL",DFN) ; get list of units available for the patient
"RTN","SRBL",9,0)
TST K DIR S DIR(0)="FA^1:50",(SRPROMPT,DIR("A"))="Enter Blood Product Identifier: "
"RTN","SRBL",10,0)
 S DIR("?")="Enter or scan the Blood Product Unit Id" D ^DIR K DIR G END:$D(DTOUT)!$D(DUOUT)
"RTN","SRBL",11,0)
 D CODA,MATCH I 'SRMATCH G SRNO
"RTN","SRBL",12,0)
 I SRMATCH=1 S SRY=SRMATCH D SRYES Q
"RTN","SRBL",13,0)
 D LIST I SRQ G END
"RTN","SRBL",14,0)
 S SRY=Y D SRYES
"RTN","SRBL",15,0)
 Q
"RTN","SRBL",16,0)
LIST W ! S Y=^TMP("SRBL",$J,0),Z=$P(Y,"^",7),SRSSN=$E(Z,1,3)_"-"_$E(Z,4,5)_"-"_$E(Z,6,12)
"RTN","SRBL",17,0)
 S SRNAME=$P(Y,"^",5)_","_$P(Y,"^",4)_" "_SRSSN
"RTN","SRBL",18,0)
 S (SRI,SRZ)=0 F  S SRZ=$O(SRBL(SRZ)) Q:'SRZ  D
"RTN","SRBL",19,0)
 .S Z=SRBL(SRZ),SRPROD=$P(Z,"^",4),X=$P(Z,"^",2) D ^%DT S SREXP=Y
"RTN","SRBL",20,0)
 .W !!," ",SRZ_") Unit ID: ",SRUID,?45,SRPROD
"RTN","SRBL",21,0)
 .W !,?4,"Patient: ",SRNAME,?45,"Expiration Date: " S Y=SREXP D DD^%DT W Y
"RTN","SRBL",22,0)
 .S SRI=SRI+1
"RTN","SRBL",23,0)
 W ! K DIR S DIR(0)="NO^1:"_SRI,DIR("A")="Select the blood product matching the unit label"
"RTN","SRBL",24,0)
 D ^DIR K DIR I $D(DTOUT)!$D(DUOUT)!'Y S SRQ=1 Q
"RTN","SRBL",25,0)
 S SRY=Y
"RTN","SRBL",26,0)
 Q
"RTN","SRBL",27,0)
MATCH ; retrieve matching units from list of available units
"RTN","SRBL",28,0)
 S (SRIDT,SRMATCH)=0 F  S SRIDT=$O(^TMP("SRBL",$J,SRIDT)) Q:'SRIDT  D
"RTN","SRBL",29,0)
 .S X=^TMP("SRBL",$J,SRIDT)
"RTN","SRBL",30,0)
 .I $P(X,"^",3)=SRUID S SRMATCH=SRMATCH+1,SRBL(SRMATCH)=X
"RTN","SRBL",31,0)
 Q
"RTN","SRBL",32,0)
CODA ; interpret Codabar barcodes used to label the Unit ID of blood component
"RTN","SRBL",33,0)
 I $$ISBTUID(.X) S SRUID=X Q
"RTN","SRBL",34,0)
 S SRUID=$$STRIP(X)
"RTN","SRBL",35,0)
 W ?45,"UNIT ID: ",SRUID
"RTN","SRBL",36,0)
 Q
"RTN","SRBL",37,0)
SRYES S X=$P(SRBL(SRY),"^",2) D ^%DT I Y<DT D  D ASK Q
"RTN","SRBL",38,0)
 .I SRMATCH=1 D LIST
"RTN","SRBL",39,0)
 .W !!,?30,"**WARNING**",!!,"Today's date exceeds the blood product expiration date.",!
"RTN","SRBL",40,0)
 W !!!,?25,"No Discrepancies Found",!!! K DIR S DIR(0)="FOA",DIR("A")="Press RETURN to continue" D ^DIR G END
"RTN","SRBL",41,0)
SRNO W !!,?30,"**WARNING**",!!
"RTN","SRBL",42,0)
 W ?5,"There is no record that this unit has been assigned to this patient."
"RTN","SRBL",43,0)
 W !!,?8,"      Please recheck the patient and blood product IDs.",!!
"RTN","SRBL",44,0)
ASK K DIR S DIR(0)="Y",DIR("A")="Do you want to scan another product (Y/N)",DIR("B")="YES" D ^DIR I Y D END G SCAN
"RTN","SRBL",45,0)
END K ^TMP("SRBL",$J),DIR,SR,SRBL,SREXP,SRI,SRIDT,SRMATCH,SRNAME,SRPROD,SRPROMPT,SRQ,SRSSN,SRUID,SRY,SRZ,X,Y,Z
"RTN","SRBL",46,0)
 Q
"RTN","SRBL",47,0)
STRIP(X) ; strip off any ISBT-128 barcode identifier characters
"RTN","SRBL",48,0)
 S X=$TR(X,"=<>&%(","")
"RTN","SRBL",49,0)
 Q X
"RTN","SRBL",50,0)
BAR ; test bar code reader
"RTN","SRBL",51,0)
 N A,SR,SRABO,SRRH,SRPROMPT,X,Y S SR=""
"RTN","SRBL",52,0)
 K DIR S DIR(0)="FAO^1:20" S DIR("A",1)="",(SRPROMPT,DIR("A"))="                         => "
"RTN","SRBL",53,0)
 S DIR("A",2)="                            To use BAR CODE READER"
"RTN","SRBL",54,0)
 S DIR("A",3)="               Pass reader wand over a GROUP-TYPE (ABO/Rh) label"
"RTN","SRBL",55,0)
 S DIR("?",2)="     To test scanner, scan a GROUP-TYPE (ABO/Rh) label. Otherwise, press"
"RTN","SRBL",56,0)
 S DIR("?",1)="",DIR("?")="     the Enter key." D ^DIR K DIR Q:$D(DTOUT)!$D(DUOUT)!(X="")
"RTN","SRBL",57,0)
 W $C(13),$J("",79),$C(13),SRPROMPT,"(Bar code)"
"RTN","SRBL",58,0)
 D ISBTBG(X,.SRABO,.SRRH) I SRABO]"" D  Q
"RTN","SRBL",59,0)
 .S SR=1,SR(2)=""
"RTN","SRBL",60,0)
 .W " ",SRABO," ",SRRH
"RTN","SRBL",61,0)
 S X=$$STRIP(X)
"RTN","SRBL",62,0)
 F A=1:1 S Y=$P($T(G+A),";",4) Q:Y=""  S X(1)=$F(X,Y) I X(1),$L(X)<X(1) S SR=$L(X)-3,SR(2)=$E(X,1,SR),SR=SR+1 Q
"RTN","SRBL",63,0)
 I SR="" W $C(7),!!?28,"Not a GROUP-TYPE label",!?15,"Press <ENTER> key if BAR CODE READER is not used",! G BAR
"RTN","SRBL",64,0)
 W " ",$P($T(G+A),";",3)
"RTN","SRBL",65,0)
 Q
"RTN","SRBL",66,0)
ISBTBG(SRIN,SRBLABO,SRBLRH) ; check for ISBT-128 valid blood group and return ABO & Rh values
"RTN","SRBL",67,0)
 ; Valid codes are prefixed by "=%".
"RTN","SRBL",68,0)
 ;
"RTN","SRBL",69,0)
 ; INPUT  : SRIN = input from Blood Group barcode label.
"RTN","SRBL",70,0)
 ; OUTPUT : SRBLABO (passed by reference) = ABO value
"RTN","SRBL",71,0)
 ;          SRBLRH  (passed by reference) = Rh value
"RTN","SRBL",72,0)
 ;
"RTN","SRBL",73,0)
 N Z S (SRBLABO,SRBLRH)=""
"RTN","SRBL",74,0)
 Q:$L(SRIN)'>3
"RTN","SRBL",75,0)
 Q:$E(SRIN,1,2)'="=%"
"RTN","SRBL",76,0)
 S Z=$E(SRIN,3,4)
"RTN","SRBL",77,0)
 S SRBLABO=$S(57<Z&(Z<66):"A POS",46<Z&(Z<55):"O POS",90<Z&(Z<99):"O NEG",1<Z&(Z<10):"A NEG",12<Z&(Z<21):"B NEG",68<Z&(Z<77):"B POS",23<Z&(Z<32):"AB NEG",79<Z&(Z<88):"AB POS",1:"")
"RTN","SRBL",78,0)
 Q:SRBLABO=""
"RTN","SRBL",79,0)
 S SRBLRH=$P(SRBLABO," ",2)
"RTN","SRBL",80,0)
 S SRBLABO=$P(SRBLABO," ")
"RTN","SRBL",81,0)
 Q
"RTN","SRBL",82,0)
ISBTUID(SRBLIN) ; Check for and display valid ISBT-128 Unit Id
"RTN","SRBL",83,0)
 ; Valid codes are prefixed by "="
"RTN","SRBL",84,0)
 ;
"RTN","SRBL",85,0)
 ; INPUT  : SRBLIN = input from Unit Id barcode label.
"RTN","SRBL",86,0)
 ; OUTPUT : Boolean
"RTN","SRBL",87,0)
 ;
"RTN","SRBL",88,0)
 Q:$E(SRBLIN,1,2)'?1"="1(1A,1N) 0
"RTN","SRBL",89,0)
 S SRBLIN=$E(SRBLIN,2,14)
"RTN","SRBL",90,0)
 S SRBLIN=$$UP^XLFSTR(SRBLIN) ; make uppercase
"RTN","SRBL",91,0)
 W $C(13),$J("",79),$C(13),SRPROMPT,?32,"(Bar code)"
"RTN","SRBL",92,0)
 D EN^DDIOL("UNIT ID: "_SRBLIN,"","?46")
"RTN","SRBL",93,0)
 Q 1
"RTN","SRBL",94,0)
G ;;
"RTN","SRBL",95,0)
51 ;;O POS;510
"RTN","SRBL",96,0)
62 ;;A POS;620
"RTN","SRBL",97,0)
73 ;;B POS;730
"RTN","SRBL",98,0)
84 ;;AB POS;840
"RTN","SRBL",99,0)
95 ;;O NEG;950
"RTN","SRBL",100,0)
6 ;;A NEG;060
"RTN","SRBL",101,0)
17 ;;B NEG;170
"RTN","SRBL",102,0)
28 ;;AB NEG;280
"RTN","SRBL",103,0)
55 ;;O;550
"RTN","SRBL",104,0)
66 ;;A;660
"RTN","SRBL",105,0)
77 ;;B;770
"RTN","SRBL",106,0)
88 ;;AB;880
"RTN","SRBL",107,0)
 ;;NA NA;
"RTN","SRBLOOD")
0^2^B20308980
"RTN","SRBLOOD",1,0)
SRBLOOD ;B'HAM  ISC/MM,SM - BLOOD PRODUCT VERIFICATION ;08/11/05
"RTN","SRBLOOD",2,0)
 ;;3.0; Surgery ;**74,85,101,148**;24 Jun 93
"RTN","SRBLOOD",3,0)
 ; 
"RTN","SRBLOOD",4,0)
 ; References to ^LRD(65 supported by DBIA #2331-A
"RTN","SRBLOOD",5,0)
 ; References to ^LR( supported by DBIA #894 and 252-B
"RTN","SRBLOOD",6,0)
 ; References to ^LAB(66 supported by DBIA #210
"RTN","SRBLOOD",7,0)
 ; Reference to BAR^LRBLB supported by DBIA #2331-B
"RTN","SRBLOOD",8,0)
 ; Reference to ^LRBLBU supported by DBIA #2333
"RTN","SRBLOOD",9,0)
 ; Reference to VBECA1B supported by DBIA #4629
"RTN","SRBLOOD",10,0)
 ;
"RTN","SRBLOOD",11,0)
 S X="VBECA1B" X ^%ZOSF("TEST") I $T D ^SRBL Q  ; check if VBECS installed
"RTN","SRBLOOD",12,0)
SCAN D BAR^LRBLB ; scan UNIT ID before VBECS
"RTN","SRBLOOD",13,0)
 ;obtain the LRDFN from the patient's DFN
"RTN","SRBLOOD",14,0)
 S SRDFN=$P($G(^DPT($P(^SRF(SRTN,0),"^"),"LR")),"^")
"RTN","SRBLOOD",15,0)
 I SRDFN="" G SRNO
"RTN","SRBLOOD",16,0)
 K DIR S DIR(0)="F^1:50",DIR("A")="Enter Blood Product Identifier",DIR("?")="Enter or scan the Blood Product Unit Id" D ^DIR G END:$D(DIRUT)
"RTN","SRBLOOD",17,0)
 W ! D ^LRBLBU S SRUNIT=$G(X) I SRUNIT="" G SRNO
"RTN","SRBLOOD",18,0)
 ;if patient is not on the "AP" 'DO NOT Give' (no display)
"RTN","SRBLOOD",19,0)
 I '$O(^LRD(65,"AP",SRDFN,0)) G SRNO
"RTN","SRBLOOD",20,0)
 I '$O(^LRD(65,"B",SRUNIT,0)),('$O(^LRD(65,"C",SRUNIT,0))) G SRNO
"RTN","SRBLOOD",21,0)
 S (SRIEN,SRICNT,SROCNT,SROK)=0 F  S SRIEN=$O(^LRD(65,"B",SRUNIT,SRIEN)) Q:'SRIEN  S SROCNT=SROCNT+1,SRO(SROCNT)=SRIEN
"RTN","SRBLOOD",22,0)
 S (SRIEN)=0 F  S SRIEN=$O(^LRD(65,"C",SRUNIT,SRIEN)) Q:'SRIEN  S SROCNT=SROCNT+1,SRO(SROCNT)=SRIEN
"RTN","SRBLOOD",23,0)
 S (SRLRD,SRICNT)=0 F SRZ=1:1:SROCNT D 
"RTN","SRBLOOD",24,0)
 .;S SRIEN=SRO(SRZ) I '$O(^LRD(65,SRIEN,2,0)) S SRICNT=SRICNT+1,SRB(SRICNT)=SRIEN_"^"_0 Q ;checks for "No date/time unit assigned"
"RTN","SRBLOOD",25,0)
 .S SRIEN=SRO(SRZ) I '$O(^LRD(65,SRIEN,2,0)) Q
"RTN","SRBLOOD",26,0)
 .S SRLRD=0 F  S SRLRD=$O(^LRD(65,SRIEN,2,SRLRD)) Q:'SRLRD  D
"RTN","SRBLOOD",27,0)
 ..Q:'$D(^LRD(65,"AP",SRLRD,SRIEN))
"RTN","SRBLOOD",28,0)
 ..S SRICNT=SRICNT+1,SRB(SRICNT)=SRIEN_"^"_SRLRD
"RTN","SRBLOOD",29,0)
 ..I SRLRD=SRDFN S SROK=1
"RTN","SRBLOOD",30,0)
 I '$D(SROK) G SRNO
"RTN","SRBLOOD",31,0)
 ;look through the list of patients assigned to the unit id for selected patient
"RTN","SRBLOOD",32,0)
 S (SRC2,SRFLAG)=0 F SRZ=1:1:SRICNT D
"RTN","SRBLOOD",33,0)
 .I SRC2=SROCNT Q
"RTN","SRBLOOD",34,0)
 .I SRZ=SRICNT,(SRFLAG=0) S SRD(SRC2+1)=SRB(SRZ) Q
"RTN","SRBLOOD",35,0)
 .I SRZ=SRICNT,(SRFLAG=1) Q
"RTN","SRBLOOD",36,0)
 .I $P(SRB(SRZ),"^",2)=SRDFN S SRFLAG=1,SRC2=SRC2+1,SRD(SRC2)=SRB(SRZ)
"RTN","SRBLOOD",37,0)
 .I $P(SRB(SRZ),"^")=$P(SRB(SRZ+1),"^") Q
"RTN","SRBLOOD",38,0)
 .I SRFLAG=1 S SRFLAG=0 Q
"RTN","SRBLOOD",39,0)
 .I SRFLAG=0 S SRC2=SRC2+1,SRD(SRC2)=SRB(SRZ)
"RTN","SRBLOOD",40,0)
 ;
"RTN","SRBLOOD",41,0)
 ;create the display
"RTN","SRBLOOD",42,0)
 I '$D(SRD) G SRNO
"RTN","SRBLOOD",43,0)
 ;if selected patient is assigned to each unit id, no display necessary 
"RTN","SRBLOOD",44,0)
 S SRI="",(SRDS,SRDSP,SRFLAG,SRNODT,SREXP)=0 F  S SRI=$O(SRD(SRI)) Q:SRI=""  D
"RTN","SRBLOOD",45,0)
 .I $P(SRD(SRI),"^",2)'=SRDFN S SRDSP=1
"RTN","SRBLOOD",46,0)
 .;I $D(^LRD(65,"AP",$P(SRD(SRI),"^",2),$P(SRD(SRI),"^")))
"RTN","SRBLOOD",47,0)
 .;E  S SRDS=1,SRD(SRI)=SRD(SRI)_"^"_"       **NO DATE/TIME UNIT ASSIGNED **",SRNODT=1
"RTN","SRBLOOD",48,0)
 .S DFN=$P(SRD(SRI),"^",2)
"RTN","SRBLOOD",49,0)
 .I DFN'=0 S DFN=$P(^LR(DFN,0),"^",3) D DEM^VADPT S $P(SRD(SRI),"^",6)=VADM(1)_" "_VA("PID")
"RTN","SRBLOOD",50,0)
 .I DFN=0 S $P(SRD(SRI),"^",6)="Not Assigned"
"RTN","SRBLOOD",51,0)
 .S SRIEN=$P(SRD(SRI),"^"),SRUNIT=$P(SRD(SRI),"^"),(Y,Z)=$P($G(^LRD(65,SRIEN,0)),"^",6) I Y'="" X ^DD("DD") S $P(SRD(SRI),"^",5)=Y I Z<DT S $P(SRD(SRI),"^",4)="Today's date exceeds the blood product expiration date.",SREXP=1
"RTN","SRBLOOD",52,0)
 I SRDSP=0,(SRDS=0) I SRNODT=0,(SREXP=0) G SRYES
"RTN","SRBLOOD",53,0)
 I SROCNT=1,$D(SROK) S Y=1 G CHECKS
"RTN","SRBLOOD",54,0)
 S SRI="",SRZ=0 F  S SRI=$O(SRD(SRI)) Q:SRI=""  D
"RTN","SRBLOOD",55,0)
 .S SRZ=SRZ+1,SRIEN=$P(SRD(SRI),"^"),SRUNIT=$P(^LRD(65,SRIEN,0),"^")
"RTN","SRBLOOD",56,0)
 .W !!," ",SRI_")"," Unit ID: ",SRUNIT,?45,$P(^LAB(66,$P(^LRD(65,SRIEN,0),"^",4),0),"^")
"RTN","SRBLOOD",57,0)
 .W !,?4,"Patient: ",$P(SRD(SRI),"^",6),?45,"Expiration Date: ",?40,$P(SRD(SRI),"^",5)
"RTN","SRBLOOD",58,0)
 .I $P(SRD(SRI),"^",3)'="" W !,$P(SRD(SRI),"^",3)
"RTN","SRBLOOD",59,0)
 W ! K DIR S DIR(0)="NO^1:"_SRZ,DIR("A")="Select the blood product matching the unit label" D ^DIR K DIR I $D(DTOUT)!$D(DUOUT)!'Y G END
"RTN","SRBLOOD",60,0)
CHECKS I $P(SRD(Y),"^",2)'=SRDFN G SRNO
"RTN","SRBLOOD",61,0)
 I $P(SRD(Y),"^",4)'="" S SRFLAG=1 W !!,"                       **WARNING**",!!,$P(SRD(Y),"^",4),!
"RTN","SRBLOOD",62,0)
 ;I $P(SRD(Y),"^",3)["**NO DATE" S SRFLAG=1 W !!," There is no 'DATE/TIME Unit Assigned' for this entry."
"RTN","SRBLOOD",63,0)
 I SRFLAG=1 G ASK
"RTN","SRBLOOD",64,0)
SRYES W !!!,?25,"No Discrepancies Found",!!! K DIR S DIR(0)="FOA",DIR("A")="Press RETURN to continue" D ^DIR G END
"RTN","SRBLOOD",65,0)
SRNO W !!,?30,"**WARNING**",!!
"RTN","SRBLOOD",66,0)
 W ?5,"There is no record that this unit has been assigned to this patient."
"RTN","SRBLOOD",67,0)
 W !!,?8,"      Please recheck the patient and blood product IDs.",!!
"RTN","SRBLOOD",68,0)
ASK K DIR S DIR(0)="Y",DIR("A")="Do you want to scan another product (Y/N)",DIR("B")="YES" D ^DIR
"RTN","SRBLOOD",69,0)
END K SRC2,SRDFN,SRFLAG,SRICNT,SROCNT,SRZ,SRDSP,SRBLOOD,SRB,SRO,SRD,SRDS,SROK,SRIEN,SRLRD,SRUNIT,SRNODT,SREXP,SRI
"RTN","SRBLOOD",70,0)
 I Y=1 G SCAN
"RTN","SRBLOOD",71,0)
 Q
"RTN","SRBLOOD",72,0)
AUDIT S L=0,DIC=19.081,FLDS="[XUOPTLOGP]",BY="[SR BLOOD PRODUCT VERIFICATION]" D EN1^DIP
"RTN","SRBLOOD",73,0)
 Q
"RTN","SRBLOOD",74,0)
PAGE I $E(IOST,1,2)="C-" S DIR(0)="E" D ^DIR
"RTN","SRBLOOD",75,0)
 W @IOF
"RTN","SRBLOOD",76,0)
 Q
"VER")
8.0^22.0
"BLD",5447,6)
^142
**END**
**END**
