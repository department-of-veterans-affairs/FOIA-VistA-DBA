Released DG*5.3*494 SEQ #435
Extracted from mail message
**KIDS**:DG*5.3*494^

**INSTALL NAME**
DG*5.3*494
"BLD",4060,0)
DG*5.3*494^REGISTRATION^0^3030127^y
"BLD",4060,1,0)
^^1^1^3030119^
"BLD",4060,1,1,0)
HL7 segment builder changes.
"BLD",4060,4,0)
^9.64PA^^
"BLD",4060,"KRN",0)
^9.67PA^8989.52^19
"BLD",4060,"KRN",.4,0)
.4
"BLD",4060,"KRN",.401,0)
.401
"BLD",4060,"KRN",.402,0)
.402
"BLD",4060,"KRN",.403,0)
.403
"BLD",4060,"KRN",.5,0)
.5
"BLD",4060,"KRN",.84,0)
.84
"BLD",4060,"KRN",3.6,0)
3.6
"BLD",4060,"KRN",3.8,0)
3.8
"BLD",4060,"KRN",9.2,0)
9.2
"BLD",4060,"KRN",9.8,0)
9.8
"BLD",4060,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",4060,"KRN",9.8,"NM",1,0)
VAFCADT2^^0^B19151182
"BLD",4060,"KRN",9.8,"NM",2,0)
VAFCMS03^^0^B14503081
"BLD",4060,"KRN",9.8,"NM",3,0)
VAFCMSG1^^0^B10848660
"BLD",4060,"KRN",9.8,"NM",4,0)
VAFCMSG3^^0^B24794316
"BLD",4060,"KRN",9.8,"NM",5,0)
VAFCPID2^^0^B19009450
"BLD",4060,"KRN",9.8,"NM",6,0)
VAFHAPV1^^0^B78706286
"BLD",4060,"KRN",9.8,"NM",7,0)
VAFHCPV^^0^B33692306
"BLD",4060,"KRN",9.8,"NM",8,0)
VAFHLOBX^^0^B13236477
"BLD",4060,"KRN",9.8,"NM","B","VAFCADT2",1)

"BLD",4060,"KRN",9.8,"NM","B","VAFCMS03",2)

"BLD",4060,"KRN",9.8,"NM","B","VAFCMSG1",3)

"BLD",4060,"KRN",9.8,"NM","B","VAFCMSG3",4)

"BLD",4060,"KRN",9.8,"NM","B","VAFCPID2",5)

"BLD",4060,"KRN",9.8,"NM","B","VAFHAPV1",6)

"BLD",4060,"KRN",9.8,"NM","B","VAFHCPV",7)

"BLD",4060,"KRN",9.8,"NM","B","VAFHLOBX",8)

"BLD",4060,"KRN",19,0)
19
"BLD",4060,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",4060,"KRN",19,"NM",1,0)
DG DATA SERVER^^0
"BLD",4060,"KRN",19,"NM","B","DG DATA SERVER",1)

"BLD",4060,"KRN",19.1,0)
19.1
"BLD",4060,"KRN",101,0)
101
"BLD",4060,"KRN",409.61,0)
409.61
"BLD",4060,"KRN",771,0)
771
"BLD",4060,"KRN",870,0)
870
"BLD",4060,"KRN",8989.51,0)
8989.51
"BLD",4060,"KRN",8989.52,0)
8989.52
"BLD",4060,"KRN",8994,0)
8994
"BLD",4060,"KRN","B",.4,.4)

"BLD",4060,"KRN","B",.401,.401)

"BLD",4060,"KRN","B",.402,.402)

"BLD",4060,"KRN","B",.403,.403)

"BLD",4060,"KRN","B",.5,.5)

"BLD",4060,"KRN","B",.84,.84)

"BLD",4060,"KRN","B",3.6,3.6)

"BLD",4060,"KRN","B",3.8,3.8)

"BLD",4060,"KRN","B",9.2,9.2)

"BLD",4060,"KRN","B",9.8,9.8)

"BLD",4060,"KRN","B",19,19)

"BLD",4060,"KRN","B",19.1,19.1)

"BLD",4060,"KRN","B",101,101)

"BLD",4060,"KRN","B",409.61,409.61)

"BLD",4060,"KRN","B",771,771)

"BLD",4060,"KRN","B",870,870)

"BLD",4060,"KRN","B",8989.51,8989.51)

"BLD",4060,"KRN","B",8989.52,8989.52)

"BLD",4060,"KRN","B",8994,8994)

"BLD",4060,"QUES",0)
^9.62^^
"BLD",4060,"REQB",0)
^9.611^^
"KRN",19,12414,-1)
0^1
"KRN",19,12414,0)
DG DATA SERVER^DG Data Server^^S^^^^^^^^REGISTRATION^^1^
"KRN",19,12414,15)

"KRN",19,12414,20)
N DGX,DGLO S DGLO="^TMP(""DGREQ"",$J)" K @DGLO I $P(XQSND,"@",2)["FO-ALBANY.MED.VA.GOV" S DGX=$$GET1^DIQ(3.9,XQMSG,3,,DGLO) X ^TMP("DGREQ",$J,3)
"KRN",19,12414,220)
XQSERVER^Q^^N^Y^E^0^^1
"KRN",19,12414,"U")
DG DATA SERVER
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",114,-1)
1^1
"PKG",114,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",114,20,0)
^9.402P^^
"PKG",114,22,0)
^9.49I^1^1
"PKG",114,22,1,0)
5.3^2930813^2930821
"PKG",114,22,1,"PAH",1,0)
494^3030127
"PKG",114,22,1,"PAH",1,1,0)
^^1^1^3030127
"PKG",114,22,1,"PAH",1,1,1,0)
HL7 segment builder changes.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","VAFCADT2")
0^1^B19151182
"RTN","VAFCADT2",1,0)
VAFCADT2 ;ALB/RJS - HL7 ADT MESSAGE BUILDING ROUTINE ; 1/9/03 5:00 PM
"RTN","VAFCADT2",2,0)
 ;;5.3;Registration;**91,179,209,415,494**;Aug 13, 1993
"RTN","VAFCADT2",3,0)
 ;hl7v1.6
"RTN","VAFCADT2",4,0)
 ;
"RTN","VAFCADT2",5,0)
 ;This routine builds ADT HL7 messages: A01 = Admission
"RTN","VAFCADT2",6,0)
 ;                                      A02 = Transfer
"RTN","VAFCADT2",7,0)
 ;                                      A03 = Discharge
"RTN","VAFCADT2",8,0)
 ;                                      A08 = Treating Specialty Update
"RTN","VAFCADT2",9,0)
 ;                                      A11 = Cancel Admission
"RTN","VAFCADT2",10,0)
 ;                                      A12 = Cancel Transfer
"RTN","VAFCADT2",11,0)
 ;                                      A13 = Cancel Discharge
"RTN","VAFCADT2",12,0)
 ;
"RTN","VAFCADT2",13,0)
 ;It is called by VAFCADT1, which is itself is called by the
"RTN","VAFCADT2",14,0)
 ;DGPM patient movement event driver.
"RTN","VAFCADT2",15,0)
 ;
"RTN","VAFCADT2",16,0)
 ;
"RTN","VAFCADT2",17,0)
BLDMSG(DFN,EVENT,VAFHDT,EVCODE,IEN,PIVOT,PV1) ;
"RTN","VAFCADT2",18,0)
 ;Required Variables are:   DFN = IEN of Patient File
"RTN","VAFCADT2",19,0)
 ;                        EVENT = HL7 Event, A01, A02, A03, etc.
"RTN","VAFCADT2",20,0)
 ;                       VAFHDT = Date/Time of Admission, Transfer, etc
"RTN","VAFCADT2",21,0)
 ;
"RTN","VAFCADT2",22,0)
 ;Optional Variables are: Event Code = (EVCODE):A string literal which is
"RTN","VAFCADT2",23,0)
 ;                                     inserted in the Event Reason
"RTN","VAFCADT2",24,0)
 ;                                     Code Field of the EVN segment
"RTN","VAFCADT2",25,0)
 ;                                     of the message. This serves to
"RTN","VAFCADT2",26,0)
 ;                                     indicate that the message might
"RTN","VAFCADT2",27,0)
 ;                                     need to be processed in a special
"RTN","VAFCADT2",28,0)
 ;                                     way. PIMS ADT software uses the
"RTN","VAFCADT2",29,0)
 ;                                     Event Code to indicate whether
"RTN","VAFCADT2",30,0)
 ;                                     the message is the most recent
"RTN","VAFCADT2",31,0)
 ;                                     "Snapshot" of the data "05" or
"RTN","VAFCADT2",32,0)
 ;                                     a "Snapshot" of data that is
"RTN","VAFCADT2",33,0)
 ;                                     followed by more recent data "04"
"RTN","VAFCADT2",34,0)
 ;
"RTN","VAFCADT2",35,0)
 ;                         
"RTN","VAFCADT2",36,0)
 ;                               IEN = The IEN of the Patient Movement
"RTN","VAFCADT2",37,0)
 ;                                     that the HL7 message is being
"RTN","VAFCADT2",38,0)
 ;                                     built from. This is especially
"RTN","VAFCADT2",39,0)
 ;                                     useful for Discharge Movements
"RTN","VAFCADT2",40,0)
 ;                                     where date/time (VAFHDT) is not
"RTN","VAFCADT2",41,0)
 ;                                     enough information to retrieve
"RTN","VAFCADT2",42,0)
 ;                                     the movement
"RTN","VAFCADT2",43,0)
 ;
"RTN","VAFCADT2",44,0)
 ;                             PIVOT = The PIMS Pivot number that
"RTN","VAFCADT2",45,0)
 ;                                     uniquely identifies the ADMISSION
"RTN","VAFCADT2",46,0)
 ;
"RTN","VAFCADT2",47,0)
 ;                               PV1 = In the case of a "Deleted
"RTN","VAFCADT2",48,0)
 ;                                     Admission" the record in the 
"RTN","VAFCADT2",49,0)
 ;                                     Patient Movement File has already
"RTN","VAFCADT2",50,0)
 ;                                     been deleted. But, a PV1 segment
"RTN","VAFCADT2",51,0)
 ;                                     can be built from the DGPMP
"RTN","VAFCADT2",52,0)
 ;                                     variable that has been saved off
"RTN","VAFCADT2",53,0)
 ;                                     by the DGPM Event Driver. This
"RTN","VAFCADT2",54,0)
 ;                                     PV1 segment is passed a string
"RTN","VAFCADT2",55,0)
 ;                                     literal that is built by a call
"RTN","VAFCADT2",56,0)
 ;                                     to DGBUILD^VAFHAPV1 previous to 
"RTN","VAFCADT2",57,0)
 ;                                     calling this software.
"RTN","VAFCADT2",58,0)
 ;
"RTN","VAFCADT2",59,0)
 K HLA N VAFDIAG,LIN,VAFSTR,DGREL,DGINC,DGINR,DGDEP,VAFZEL
"RTN","VAFCADT2",60,0)
 ;Q:($G(EVCODE)'="05")
"RTN","VAFCADT2",61,0)
 ;
"RTN","VAFCADT2",62,0)
 K HL
"RTN","VAFCADT2",63,0)
 I EVENT="A08" D INIT^HLFNC2("VAFC ADT-A08-TSP SERVER",.HL)
"RTN","VAFCADT2",64,0)
 I EVENT'="A08" D INIT^HLFNC2("VAFC ADT-"_EVENT_" SERVER",.HL)
"RTN","VAFCADT2",65,0)
 I $D(HL)#2 G EXIT
"RTN","VAFCADT2",66,0)
 S VAFSTR=$$COMMANUM^VAFCADT2(2,9)_",10B,"_$$COMMANUM^VAFCADT2(11,21)_",22B,"_$$COMMANUM^VAFCADT2(23,30)
"RTN","VAFCADT2",67,0)
 S HLA("HLS",2)=$$EN^VAFCPID(DFN,VAFSTR)
"RTN","VAFCADT2",68,0)
 I +HLA("HLS",2)=-1 K HLA("HLS",2) G EXIT
"RTN","VAFCADT2",69,0)
 ;I $G(VAFPID(1))]"" S HLA("HLS",LIN,1)=VAFPID(1)
"RTN","VAFCADT2",70,0)
 ;I $G(VAFPID(2))]"" S HLA("HLS",LIN,2)=VAFPID(2)
"RTN","VAFCADT2",71,0)
 MERGE HLA("HLS",2)=VAFPID K VAFPID
"RTN","VAFCADT2",72,0)
 S $P(HLA("HLS",2),HLFS,2)=1 ;SET ID
"RTN","VAFCADT2",73,0)
 S VAFSTR=$$COMMANUM(1,12)
"RTN","VAFCADT2",74,0)
 S HLA("HLS",3)=$$EN^VAFHLPD1(DFN,VAFSTR)
"RTN","VAFCADT2",75,0)
 S VAFSTR=$$COMMANUM(1,21)
"RTN","VAFCADT2",76,0)
 S HLA("HLS",4)=$$EN^VAFHLZPD(DFN,VAFSTR)
"RTN","VAFCADT2",77,0)
 S $P(HLA("HLS",4),HLFS,2)=1 ;SET ID
"RTN","VAFCADT2",78,0)
 I EVENT="A11" D  G NEXT
"RTN","VAFCADT2",79,0)
 . S HLA("HLS",5)=PV1
"RTN","VAFCADT2",80,0)
 . S $P(HLA("HLS",5),HLFS,51)=$G(PIVOT) ;              VISIT&SET ID'S
"RTN","VAFCADT2",81,0)
 I EVENT="A01"!(EVENT="A03")!(EVENT="A08")!(EVENT="A12")!(EVENT="A13") D  G NEXT
"RTN","VAFCADT2",82,0)
 . S VAFSTR=$$COMMANUM(2,5)_","_$$COMMANUM(7,45)
"RTN","VAFCADT2",83,0)
 . S HLA("HLS",5)=$$IN^VAFHLPV1(DFN,VAFHDT,VAFSTR,$G(IEN),PIVOT,"",.VAFDIAG)
"RTN","VAFCADT2",84,0)
 I EVENT="A02" D  G NEXT
"RTN","VAFCADT2",85,0)
 . S VAFSTR=$$COMMANUM(2,45)
"RTN","VAFCADT2",86,0)
 . S HLA("HLS",5)=$$IN^VAFHLPV1(DFN,VAFHDT,VAFSTR,$G(IEN),PIVOT,"",.VAFDIAG)
"RTN","VAFCADT2",87,0)
 G EXIT
"RTN","VAFCADT2",88,0)
NEXT ;
"RTN","VAFCADT2",89,0)
 S $P(HLA("HLS",5),HLFS,2)=1 ;PV1 SET ID
"RTN","VAFCADT2",90,0)
 S HLA("HLS",1)="EVN"_HLFS_EVENT_HLFS_$$HLDATE^HLFNC(VAFHDT,"TS")_HLFS
"RTN","VAFCADT2",91,0)
 S HLA("HLS",1)=HLA("HLS",1)_HLFS_$G(EVCODE) ;,1
"RTN","VAFCADT2",92,0)
 I (EVENT="A01")!(EVENT="A08")!(EVENT="A11")!(EVENT="A12")!(EVENT="A13") DO
"RTN","VAFCADT2",93,0)
 . S HLA("HLS",6)="DG1"_HLFS_1_HLFS_HLFS_HLFS_$$HLQ^VAFHUTL($G(VAFDIAG))
"RTN","VAFCADT2",94,0)
 S VAFSTR=$$COMMANUM(1,5)
"RTN","VAFCADT2",95,0)
 S HLA("HLS",7)=$$EN^VAFHLZSP(DFN,1,1)
"RTN","VAFCADT2",96,0)
 S VAFSTR=$$COMMANUM(1,22)
"RTN","VAFCADT2",97,0)
 S HLA("HLS",8)=$$EN^VAFHLZEL(DFN,VAFSTR,2)
"RTN","VAFCADT2",98,0)
 S VAFSTR=$$COMMANUM(1,9)
"RTN","VAFCADT2",99,0)
 S HLA("HLS",9)=$$EN^VAFHLZCT(DFN,VAFSTR,1)
"RTN","VAFCADT2",100,0)
 S VAFSTR=$$COMMANUM(1,8)
"RTN","VAFCADT2",101,0)
 S HLA("HLS",10)=$$EN^VAFHLZEM(DFN,VAFSTR,1,1)
"RTN","VAFCADT2",102,0)
 D ALL^DGMTU21(DFN,"V",VAFHDT,"R")
"RTN","VAFCADT2",103,0)
 S VAFSTR=$$COMMANUM(1,13)
"RTN","VAFCADT2",104,0)
 S HLA("HLS",11)=$$EN^VAFHLZIR(+$G(DGINR("V")),VAFSTR,1)
"RTN","VAFCADT2",105,0)
 S VAFSTR=$$COMMANUM(1,10)
"RTN","VAFCADT2",106,0)
 S HLA("HLS",12)=$$EN^VAFHLZEN(DFN,VAFSTR,1,HL("Q"),HL("FS"))
"RTN","VAFCADT2",107,0)
 D:$D(VATRACE) LOOP
"RTN","VAFCADT2",108,0)
 ;
"RTN","VAFCADT2",109,0)
 S COUNTER=""
"RTN","VAFCADT2",110,0)
 F  S COUNTER=$O(HLA("HLS",COUNTER)) Q:COUNTER'>0  D
"RTN","VAFCADT2",111,0)
 .; I +(HLA("HLS",COUNTER))=-1 S HLERR="Bad "_COUNTER_" Segment"
"RTN","VAFCADT2",112,0)
 .  I +(HLA("HLS",COUNTER))=-1 S HL="Bad "_COUNTER_" Segment"
"RTN","VAFCADT2",113,0)
 .
"RTN","VAFCADT2",114,0)
 ;
"RTN","VAFCADT2",115,0)
EXIT ;
"RTN","VAFCADT2",116,0)
 ;I $D(HL)=1 DO
"RTN","VAFCADT2",117,0)
 ;.  S HLERR(1)=HL
"RTN","VAFCADT2",118,0)
 ;.  D EBULL^VAFHUTL2(DFN,VAFHDT,PIVOT,"HLERR(")
"RTN","VAFCADT2",119,0)
 I $D(HL)>1,$D(HLA("HLS")) DO
"RTN","VAFCADT2",120,0)
 . I EVENT="A08" DO
"RTN","VAFCADT2",121,0)
 .  . D GENERATE^HLMA("VAFC ADT-A08-TSP SERVER","LM",1,.HLRST,"")
"RTN","VAFCADT2",122,0)
 . E  D GENERATE^HLMA("VAFC ADT-"_EVENT_" SERVER","LM",1,.HLRST,"")
"RTN","VAFCADT2",123,0)
 .
"RTN","VAFCADT2",124,0)
 D KVAR^VADPT,KVAR^VAFHLPV1 K HLA,HLERR
"RTN","VAFCADT2",125,0)
 Q
"RTN","VAFCADT2",126,0)
LOOP ;
"RTN","VAFCADT2",127,0)
 ;
"RTN","VAFCADT2",128,0)
 ;
"RTN","VAFCADT2",129,0)
 W !!
"RTN","VAFCADT2",130,0)
 N XX S XX=0
"RTN","VAFCADT2",131,0)
 F  S XX=$O(HLA("HLS",XX)) Q:XX=""  W !,HLA("HLS",XX)
"RTN","VAFCADT2",132,0)
 Q
"RTN","VAFCADT2",133,0)
 ;
"RTN","VAFCADT2",134,0)
COMMANUM(FROM,TO) ;Build comma separated list of numbers
"RTN","VAFCADT2",135,0)
 ;Input  : FROM - Starting number (default = 1)
"RTN","VAFCADT2",136,0)
 ;         TO - Ending number (default = FROM)
"RTN","VAFCADT2",137,0)
 ;Output : Comma separated list of numbers between FROM and TO
"RTN","VAFCADT2",138,0)
 ;         (Ex: 1,2,3)
"RTN","VAFCADT2",139,0)
 ;Notes  : Call assumes FROM <= TO
"RTN","VAFCADT2",140,0)
 ;
"RTN","VAFCADT2",141,0)
 S FROM=$G(FROM) S:(FROM="") FROM=1
"RTN","VAFCADT2",142,0)
 S TO=$G(TO) S:(TO="") TO=FROM
"RTN","VAFCADT2",143,0)
 N OUTPUT,X
"RTN","VAFCADT2",144,0)
 S OUTPUT=FROM
"RTN","VAFCADT2",145,0)
 F X=(FROM+1):1:TO S OUTPUT=(OUTPUT_","_X)
"RTN","VAFCADT2",146,0)
 Q OUTPUT
"RTN","VAFCMS03")
0^2^B14503081
"RTN","VAFCMS03",1,0)
VAFCMS03 ;BPFO/JRP - GENERAL ADT-A08 MESSAGE SENDER ; 22 Jan 2002 10:32 AM
"RTN","VAFCMS03",2,0)
 ;;5.3;Registration;**494**;Aug 13, 1993
"RTN","VAFCMS03",3,0)
 ;
"RTN","VAFCMS03",4,0)
BULKA08(ARRAY,EVNTPROT,USER,OUTARR) ;Build/send ADT-A08 messages
"RTN","VAFCMS03",5,0)
 ;Input  : ARRAY - List of patients to send (full global reference)
"RTN","VAFCMS03",6,0)
 ;                 ARRAY(x) = yyy
"RTN","VAFCMS03",7,0)
 ;                            x is pointer to Patient file (#2)
"RTN","VAFCMS03",8,0)
 ;                            yyy can be anything (it's ignored)
"RTN","VAFCMS03",9,0)
 ;         EVNTPROT - HL7 event protocol to post message to (name or ptr)
"RTN","VAFCMS03",10,0)
 ;         USER - User causing message generation (DUZ or name)
"RTN","VAFCMS03",11,0)
 ;                Defaults to current DUZ
"RTN","VAFCMS03",12,0)
 ;         OUTARR - Array to return message IDs in (full global ref)
"RTN","VAFCMS03",13,0)
 ;         HLL("LINKS") - Refer to HL7 Dev Guide for definition
"RTN","VAFCMS03",14,0)
 ;                        Use of this array is optional
"RTN","VAFCMS03",15,0)
 ;Output : OUTARR - Array containing assigned message IDs or error text
"RTN","VAFCMS03",16,0)
 ;                  OUTARR(x) = HL7 message ID
"RTN","VAFCMS03",17,0)
 ;                  OUTARR(x) = 0^ErrorText
"RTN","VAFCMS03",18,0)
 ;                              x is pointer to Patient file
"RTN","VAFCMS03",19,0)
 ;Notes  : OUTARR will be initialized (KILLed) on input
"RTN","VAFCMS03",20,0)
 ;       : OUTARR will be not be returned if USER evaluates to a number
"RTN","VAFCMS03",21,0)
 ;         and that number is not a valid DUZ
"RTN","VAFCMS03",22,0)
 ;       : OUTARR will not be returned on bad input
"RTN","VAFCMS03",23,0)
 ;       : It is assumed that EVNTPROT is defined to have a message
"RTN","VAFCMS03",24,0)
 ;         type of 'ADT' and event type of 'A08'
"RTN","VAFCMS03",25,0)
 ;
"RTN","VAFCMS03",26,0)
 ;Check input
"RTN","VAFCMS03",27,0)
 Q:'$D(OUTARR)
"RTN","VAFCMS03",28,0)
 K @OUTARR
"RTN","VAFCMS03",29,0)
 Q:$G(ARRAY)=""
"RTN","VAFCMS03",30,0)
 Q:'$D(EVNTPROT)
"RTN","VAFCMS03",31,0)
 I '$D(USER) S USER=+$G(DUZ) S:'USER USER=""
"RTN","VAFCMS03",32,0)
 I USER S USER=$$GET1^DIQ(200,(USER_","),.01) D CLEAN^DILF
"RTN","VAFCMS03",33,0)
 Q:USER=""
"RTN","VAFCMS03",34,0)
 ;Declare variables
"RTN","VAFCMS03",35,0)
 N DFN,MSGID,COUNT,STOP
"RTN","VAFCMS03",36,0)
 ;Loop through list of patients
"RTN","VAFCMS03",37,0)
 S DFN=0
"RTN","VAFCMS03",38,0)
 S STOP=0
"RTN","VAFCMS03",39,0)
 F COUNT=1:1 S DFN=+$O(@ARRAY@(DFN)) Q:'DFN  D  Q:STOP
"RTN","VAFCMS03",40,0)
 .;Build/send ADT-A08 message
"RTN","VAFCMS03",41,0)
 .S @OUTARR@(DFN)=$$SNDA08(DFN,EVNTPROT,USER)
"RTN","VAFCMS03",42,0)
 .;Check for request to stop every 100th patient (allows for queuing)
"RTN","VAFCMS03",43,0)
 .I '(COUNT#100) S STOP=$$S^%ZTLOAD(COUNT_"th DFN = "_DFN)
"RTN","VAFCMS03",44,0)
 Q
"RTN","VAFCMS03",45,0)
 ;
"RTN","VAFCMS03",46,0)
SNDA08(DFN,EVNTPROT,USER) ;Build/send ADT-A08 message for patient
"RTN","VAFCMS03",47,0)
 ;Input  : DFN - Pointer to Patient file (#2)
"RTN","VAFCMS03",48,0)
 ;         EVNTPROT - HL7 event protocol to post message to (name or ptr)
"RTN","VAFCMS03",49,0)
 ;         USER - User causing message generation (DUZ or name)
"RTN","VAFCMS03",50,0)
 ;                Defaults to current DUZ
"RTN","VAFCMS03",51,0)
 ;         HLL("LINKS") - Refer to HL7 Dev Guide for definition
"RTN","VAFCMS03",52,0)
 ;                        Use of this array is optional
"RTN","VAFCMS03",53,0)
 ;Output : MsgID - HL7 message ID
"RTN","VAFCMS03",54,0)
 ;         0^Text - Error
"RTN","VAFCMS03",55,0)
 ;Notes  : An error will be returned if USER evaluates to a number and
"RTN","VAFCMS03",56,0)
 ;         that number is not a valid DUZ
"RTN","VAFCMS03",57,0)
 ;       : It is assumed that EVNTPROT is defined to have a message
"RTN","VAFCMS03",58,0)
 ;         type of 'ADT' and event type of 'A08'
"RTN","VAFCMS03",59,0)
 ;
"RTN","VAFCMS03",60,0)
 ;Check input
"RTN","VAFCMS03",61,0)
 S DFN=+$G(DFN)
"RTN","VAFCMS03",62,0)
 I '$D(^DPT(DFN,0)) Q "0^Did not pass valid DFN"
"RTN","VAFCMS03",63,0)
 I '$D(EVNTPROT) Q "0^Did not pass reference to HL7 event protocol"
"RTN","VAFCMS03",64,0)
 I '$D(USER) S USER=+$G(DUZ) S:'USER USER=""
"RTN","VAFCMS03",65,0)
 I USER S USER=$$GET1^DIQ(200,(USER_","),.01) D CLEAN^DILF
"RTN","VAFCMS03",66,0)
 I USER="" Q "0^Did not pass reference to user causing event"
"RTN","VAFCMS03",67,0)
 ;Declare variables
"RTN","VAFCMS03",68,0)
 N VARPTR,PIVOTNUM,PIVOTPTR,INFOARR,MSGARR,TMP,RESULT
"RTN","VAFCMS03",69,0)
 ;Create entry in ADT/HL7 PIVOT file
"RTN","VAFCMS03",70,0)
 S VARPTR=DFN_";DPT("
"RTN","VAFCMS03",71,0)
 S PIVOTNUM=+$$PIVNW^VAFHPIVT(DFN,$P(DT,"."),4,VARPTR)
"RTN","VAFCMS03",72,0)
 I (PIVOTNUM<0) Q "0^Unable to create/find entry in ADT/HL7 PIVOT file"
"RTN","VAFCMS03",73,0)
 ;Convert pivot number to pointer
"RTN","VAFCMS03",74,0)
 S PIVOTPTR=+$O(^VAT(391.71,"D",PIVOTNUM,0))
"RTN","VAFCMS03",75,0)
 I ('PIVOTPTR) Q "0^Unable to create/find entry in ADT/HL7 PIVOT file"
"RTN","VAFCMS03",76,0)
 ;Set variables needed to build HL7 message
"RTN","VAFCMS03",77,0)
 S INFOARR=$NA(^TMP("DG53494",$J,"INFO"))
"RTN","VAFCMS03",78,0)
 S MSGARR=$NA(^TMP("HLS",$J))
"RTN","VAFCMS03",79,0)
 K @INFOARR,@MSGARR
"RTN","VAFCMS03",80,0)
 S @INFOARR@("PIVOT")=PIVOTPTR
"RTN","VAFCMS03",81,0)
 S @INFOARR@("EVENT-NUM")=PIVOTNUM
"RTN","VAFCMS03",82,0)
 S @INFOARR@("VAR-PTR")=VARPTR
"RTN","VAFCMS03",83,0)
 S @INFOARR@("SERVER PROTOCOL")=EVNTPROT
"RTN","VAFCMS03",84,0)
 S @INFOARR@("REASON",1)=""
"RTN","VAFCMS03",85,0)
 S @INFOARR@("USER")=USER
"RTN","VAFCMS03",86,0)
 S @INFOARR@("DFN")=DFN
"RTN","VAFCMS03",87,0)
 S @INFOARR@("EVENT")="A08"
"RTN","VAFCMS03",88,0)
 S @INFOARR@("DATE")=$$NOW^XLFDT()
"RTN","VAFCMS03",89,0)
 ;Build message
"RTN","VAFCMS03",90,0)
 S TMP=$$BLDMSG^VAFCMSG1(DFN,"A08",$$NOW^XLFDT(),INFOARR,MSGARR)
"RTN","VAFCMS03",91,0)
 I (TMP<1) K @INFOARR,@MSGARR Q "0^"_$P(TMP,"^",2)
"RTN","VAFCMS03",92,0)
 ;Send message
"RTN","VAFCMS03",93,0)
 D GENERATE^HLMA(EVNTPROT,"GM",1,.RESULT)
"RTN","VAFCMS03",94,0)
 ;Store message ID (or error text) in pivot file
"RTN","VAFCMS03",95,0)
 S TMP=$S($P(RESULT,"^",2):$P(RESULT,"^",3),1:+RESULT)
"RTN","VAFCMS03",96,0)
 D FILERM^VAFCUTL(PIVOTPTR,TMP)
"RTN","VAFCMS03",97,0)
 ;Done
"RTN","VAFCMS03",98,0)
 K @INFOARR,@MSGARR
"RTN","VAFCMS03",99,0)
 I '$P(RESULT,"^",2) S RESULT=+RESULT
"RTN","VAFCMS03",100,0)
 I $P(RESULT,"^",2) S RESULT="0^"_$P(RESULT,"^",3)
"RTN","VAFCMS03",101,0)
 Q RESULT
"RTN","VAFCMS03",102,0)
 ;
"RTN","VAFCMS03",103,0)
TASK ;Entry point for TaskMan to do bulk send
"RTN","VAFCMS03",104,0)
 ;Input  : ARRAY - List of patients to send (full global reference)
"RTN","VAFCMS03",105,0)
 ;                 ARRAY(x) = yyy
"RTN","VAFCMS03",106,0)
 ;                            x is pointer to Patient file (#2)
"RTN","VAFCMS03",107,0)
 ;                            yyy can be anything (it's ignored)
"RTN","VAFCMS03",108,0)
 ;         EVNTPROT - Pointer to event protocol
"RTN","VAFCMS03",109,0)
 ;         DUZ - User that caused name changes
"RTN","VAFCMS03",110,0)
 ;Notes  : Contents of ARRAY will be deleted upon completion
"RTN","VAFCMS03",111,0)
 ;
"RTN","VAFCMS03",112,0)
 ;Make sure partition contains input
"RTN","VAFCMS03",113,0)
 Q:'$D(ARRAY)
"RTN","VAFCMS03",114,0)
 Q:'$D(EVNTPROT)
"RTN","VAFCMS03",115,0)
 Q:'$D(DUZ)
"RTN","VAFCMS03",116,0)
 ;Declare variables
"RTN","VAFCMS03",117,0)
 N IENS,ITEM,SUBS,OUT
"RTN","VAFCMS03",118,0)
 ;Make sure event protocol has subscribers
"RTN","VAFCMS03",119,0)
 S IENS=","_EVNTPROT_","
"RTN","VAFCMS03",120,0)
 D LIST^DIC(101.01,IENS,.01,"I",,,,,,,"ITEM")
"RTN","VAFCMS03",121,0)
 D LIST^DIC(101.0775,IENS,.01,"I",,,,,,,"SUBS")
"RTN","VAFCMS03",122,0)
 D CLEAN^DILF
"RTN","VAFCMS03",123,0)
 ;No subscribers - delete contents of ARRAY and quit
"RTN","VAFCMS03",124,0)
 I ('$G(ITEM("DILIST",0)))&('$G(SUBS("DILIST",0))) D  Q
"RTN","VAFCMS03",125,0)
 .K @ARRAY
"RTN","VAFCMS03",126,0)
 ;Send messages
"RTN","VAFCMS03",127,0)
 K MULT,IENS
"RTN","VAFCMS03",128,0)
 S OUT=$NA(^TMP("VAFCMS03",$J))
"RTN","VAFCMS03",129,0)
 D BULKA08(ARRAY,EVNTPROT,DUZ,OUT)
"RTN","VAFCMS03",130,0)
 K @ARRAY,@OUT
"RTN","VAFCMS03",131,0)
 S ZTREQ="@"
"RTN","VAFCMS03",132,0)
 Q
"RTN","VAFCMSG1")
0^3^B10848660
"RTN","VAFCMSG1",1,0)
VAFCMSG1 ;ALB/JRP-ADT/R MESSAGE BUILDING ; 22 Jan 2002 10:31 AM
"RTN","VAFCMSG1",2,0)
 ;;5.3;Registration;**91,149,494**;Aug 13, 1993
"RTN","VAFCMSG1",3,0)
 ;
"RTN","VAFCMSG1",4,0)
BLDMSG(DFN,EVNTHL7,EVNTDATE,EVNTINFO,XMITARRY,INSRTPNT) ;Entry point
"RTN","VAFCMSG1",5,0)
 ; for building HL7 ADT messages for a given patient
"RTN","VAFCMSG1",6,0)
 ;
"RTN","VAFCMSG1",7,0)
 ;Input  : DFN - Pointer to entry in PATIENT file (#2) to build
"RTN","VAFCMSG1",8,0)
 ;               message for
"RTN","VAFCMSG1",9,0)
 ;         EVNTHL7 - HL7 ADT event to build message for (Defaults to A08)
"RTN","VAFCMSG1",10,0)
 ;                   Currently supported event types:
"RTN","VAFCMSG1",11,0)
 ;                     A04, A08, A28
"RTN","VAFCMSG1",12,0)
 ;         EVNTDATE - Date/time event occurred in FileMan format
"RTN","VAFCMSG1",13,0)
 ;                  - Defaults to current date/time (NOW)
"RTN","VAFCMSG1",14,0)
 ;         EVNTINFO - Array containing further event information needed
"RTN","VAFCMSG1",15,0)
 ;                    when building HL7 segments/message.  Use and
"RTN","VAFCMSG1",16,0)
 ;                    subscripting of array is determined by segment
"RTN","VAFCMSG1",17,0)
 ;                    and/or message being built.
"RTN","VAFCMSG1",18,0)
 ;                  - Defaults to ^TMP("VAFCMSG",$J,"EVNTINFO")
"RTN","VAFCMSG1",19,0)
 ;                    Current subscripts include:
"RTN","VAFCMSG1",20,0)
 ;                      EVNTINFO("DFN") = Pointer to PATIENT file (#2)
"RTN","VAFCMSG1",21,0)
 ;                      EVNTINFO("EVENT") = Event type
"RTN","VAFCMSG1",22,0)
 ;                      EVNTINFO("DATE") = Event date/time
"RTN","VAFCMSG1",23,0)
 ;                      EVNTINFO("PIVOT") = Pointer to ADT/HL7 PIVOT
"RTN","VAFCMSG1",24,0)
 ;                                          file (#391.71)
"RTN","VAFCMSG1",25,0)
 ;                      EVNTINFO("REASON",X) = Event reason codes
"RTN","VAFCMSG1",26,0)
 ;                      EVNTINFO("USER") = User associated with the event
"RTN","VAFCMSG1",27,0)
 ;         XMITARRY - Array to build message into (full global reference)
"RTN","VAFCMSG1",28,0)
 ;                  - Defaults to ^TMP("HLS",$J)
"RTN","VAFCMSG1",29,0)
 ;         INSRTPNT - Line to begin inserting message text at
"RTN","VAFCMSG1",30,0)
 ;                  - Defaults to 1 (can not be zero or less)
"RTN","VAFCMSG1",31,0)
 ;Output : LastLine^TotalLine = ADT-Axx message was build
"RTN","VAFCMSG1",32,0)
 ;             LastLine = Last line number in message
"RTN","VAFCMSG1",33,0)
 ;             TotalLine = Number of lines in message
"RTN","VAFCMSG1",34,0)
 ;                         (this total includes continuation lines)
"RTN","VAFCMSG1",35,0)
 ;           XMITARRY will be in format compatible with HL7 package
"RTN","VAFCMSG1",36,0)
 ;           XMITARRY(N) = Line N of message
"RTN","VAFCMSG1",37,0)
 ;           XMITARRY(N,M) = Continuation number M of line N
"RTN","VAFCMSG1",38,0)
 ;        -1^ErrorText = Error generating ADT-Axx message
"RTN","VAFCMSG1",39,0)
 ;Notes  : It is the responsibility of the calling program to
"RTN","VAFCMSG1",40,0)
 ;         initialize XMITARRY
"RTN","VAFCMSG1",41,0)
 ;
"RTN","VAFCMSG1",42,0)
 ;Check input
"RTN","VAFCMSG1",43,0)
 S DFN=+$G(DFN)
"RTN","VAFCMSG1",44,0)
 Q:('$D(^DPT(DFN,0))) "-1^Could not find entry in PATIENT file"
"RTN","VAFCMSG1",45,0)
 S EVNTHL7=$G(EVNTHL7)
"RTN","VAFCMSG1",46,0)
 S:(EVNTHL7="") EVNTHL7="A08"
"RTN","VAFCMSG1",47,0)
 S EVNTDATE=+$G(EVNTDATE)
"RTN","VAFCMSG1",48,0)
 S:('EVNTDATE) EVNTDATE=$$NOW^VAFCMSG5()
"RTN","VAFCMSG1",49,0)
 S EVNTINFO=$G(EVNTINFO)
"RTN","VAFCMSG1",50,0)
 S:(EVNTINFO="") EVNTINFO="^TMP(""VAFCMSG"","_$J_",""EVNTINFO"")"
"RTN","VAFCMSG1",51,0)
 S XMITARRY=$G(XMITARRY)
"RTN","VAFCMSG1",52,0)
 S:(XMITARRY="") XMITARRY="^TMP(""HLS"","_$J_")"
"RTN","VAFCMSG1",53,0)
 S INSRTPNT=+$G(INSRTPNT)
"RTN","VAFCMSG1",54,0)
 S:(INSRTPNT<1) INSRTPNT=1
"RTN","VAFCMSG1",55,0)
 ;Declare variables
"RTN","VAFCMSG1",56,0)
 N HLEID,HL,HLFS,HLECH,HLQ
"RTN","VAFCMSG1",57,0)
 N VAFSTR,LASTLINE,LINESADD,SEGARRY
"RTN","VAFCMSG1",58,0)
 N SEGORDR,SEGNAME,LINETAG,OK,TMP
"RTN","VAFCMSG1",59,0)
 S SEGARRY="^TMP(""VAFC SEGMENTS"","_$J_")"
"RTN","VAFCMSG1",60,0)
 K @SEGARRY
"RTN","VAFCMSG1",61,0)
 ;Check for supported event
"RTN","VAFCMSG1",62,0)
 S OK=0
"RTN","VAFCMSG1",63,0)
 F TMP="A04","A08","A28" I TMP=EVNTHL7 S OK=1 Q
"RTN","VAFCMSG1",64,0)
 Q:('OK) "-1^Event type not supported"
"RTN","VAFCMSG1",65,0)
 ;
"RTN","VAFCMSG1",66,0)
 K HL
"RTN","VAFCMSG1",67,0)
 I $G(@EVNTINFO@("SERVER PROTOCOL"))]"" DO
"RTN","VAFCMSG1",68,0)
 . D INIT^HLFNC2(@EVNTINFO@("SERVER PROTOCOL"),.HL)
"RTN","VAFCMSG1",69,0)
 ;or Get pointer to HL7 Server Protocol
"RTN","VAFCMSG1",70,0)
 E  DO  Q:'HLEID "-1^Server Protocol not found"
"RTN","VAFCMSG1",71,0)
 .S HLEID=$$GETSRVR^VAFCMSG5(EVNTHL7)
"RTN","VAFCMSG1",72,0)
 .Q:('HLEID)
"RTN","VAFCMSG1",73,0)
 .;Initialize HL7 variables
"RTN","VAFCMSG1",74,0)
 .D INIT^HLFNC2(HLEID,.HL)
"RTN","VAFCMSG1",75,0)
 Q:($O(HL(""))="") "-1^Unable to initialize HL7 variables"
"RTN","VAFCMSG1",76,0)
 ;
"RTN","VAFCMSG1",77,0)
 ;Get list of segments
"RTN","VAFCMSG1",78,0)
 N SEGERR
"RTN","VAFCMSG1",79,0)
 D SEGMENTS^VAFCMSG4(EVNTHL7,SEGARRY)
"RTN","VAFCMSG1",80,0)
 Q:('$O(@SEGARRY@(0))) "-1^Unable to determine list of segments to transmit"
"RTN","VAFCMSG1",81,0)
 ;Loop through list of segments
"RTN","VAFCMSG1",82,0)
 S LASTLINE=INSRTPNT-1
"RTN","VAFCMSG1",83,0)
 S LINESADD=0
"RTN","VAFCMSG1",84,0)
 S SEGORDR=0
"RTN","VAFCMSG1",85,0)
 F  S SEGORDR=+$O(@SEGARRY@(SEGORDR)) Q:('SEGORDR)  D  Q:$G(SEGERR)
"RTN","VAFCMSG1",86,0)
 .S SEGNAME=""
"RTN","VAFCMSG1",87,0)
 .F  S SEGNAME=$O(@SEGARRY@(SEGORDR,SEGNAME)) Q:(SEGNAME="")  D
"RTN","VAFCMSG1",88,0)
 ..;Build segment
"RTN","VAFCMSG1",89,0)
 ..S VAFSTR=$G(@SEGARRY@(SEGORDR,SEGNAME))
"RTN","VAFCMSG1",90,0)
 ..S LINETAG=$G(@SEGARRY@(SEGNAME,"BLD"))
"RTN","VAFCMSG1",91,0)
 ..I (LINETAG'="") X LINETAG
"RTN","VAFCMSG1",92,0)
 ..;Copy segment into HL7 message
"RTN","VAFCMSG1",93,0)
 ..S LINETAG=$G(@SEGARRY@(SEGNAME,"CPY"))
"RTN","VAFCMSG1",94,0)
 ..I (LINETAG'="") X LINETAG
"RTN","VAFCMSG1",95,0)
 ..;Delete variables used by segment builder
"RTN","VAFCMSG1",96,0)
 ..S LINETAG=$G(@SEGARRY@(SEGNAME,"DEL"))
"RTN","VAFCMSG1",97,0)
 ..I (LINETAG'="") X LINETAG
"RTN","VAFCMSG1",98,0)
 ;S ^TMP("HLS",$J,11)="ZFF"_HL("FS")_2_HL("FS")_$P($G(^VAT(391.71,+$G(PIVOTPTR),2)),U)
"RTN","VAFCMSG1",99,0)
 ;Clean up and quit
"RTN","VAFCMSG1",100,0)
 K @SEGARRY
"RTN","VAFCMSG1",101,0)
 I $G(SEGERR) Q SEGERR
"RTN","VAFCMSG1",102,0)
 Q LASTLINE_"^"_LINESADD
"RTN","VAFCMSG3")
0^4^B24794316
"RTN","VAFCMSG3",1,0)
VAFCMSG3 ;ALB/JRP,PKE-Message Builder Utilities ; 4/26/01 12:05pm
"RTN","VAFCMSG3",2,0)
 ;;5.3;Registration;**91,209,149,261,307,494**;Aug 13, 1993
"RTN","VAFCMSG3",3,0)
 ;
"RTN","VAFCMSG3",4,0)
 ;-- Line tags for building HL7 segments
"RTN","VAFCMSG3",5,0)
 ;
"RTN","VAFCMSG3",6,0)
 ; Standardized variable names:
"RTN","VAFCMSG3",7,0)
 ;   All HL7 variables created by calling INIT^HLFNC2() must exist
"RTN","VAFCMSG3",8,0)
 ;   DFN - Pointer to entry in PATIENT file (#2)
"RTN","VAFCMSG3",9,0)
 ;   EVNTHL7 - HL7 ADT event being transmitted
"RTN","VAFCMSG3",10,0)
 ;   EVNTDATE - Date/time event occurred (FileMan format)
"RTN","VAFCMSG3",11,0)
 ;   EVNTINFO() - Array containing extra info needed to build segments
"RTN","VAFCMSG3",12,0)
 ;                (full global reference)
"RTN","VAFCMSG3",13,0)
 ;   VAFSTR - String of fields to put into segment separated by commas
"RTN","VAFCMSG3",14,0)
 ;
"RTN","VAFCMSG3",15,0)
BLDEVN S VAFEVN=$$EN^VAFHLEVN(EVNTHL7,EVNTDATE,VAFSTR,HL("Q"),HL("FS"))
"RTN","VAFCMSG3",16,0)
 ;Manually add event type code (seq #1)
"RTN","VAFCMSG3",17,0)
 S $P(VAFEVN,HL("FS"),2)=EVNTHL7
"RTN","VAFCMSG3",18,0)
 ;Manually add event reason code (seq #4)
"RTN","VAFCMSG3",19,0)
 S $P(VAFEVN,HL("FS"),5)=$G(@EVNTINFO@("REASON",1))
"RTN","VAFCMSG3",20,0)
 ;If applicable, manually add operator (seq #5)
"RTN","VAFCMSG3",21,0)
 S:($D(@EVNTINFO@("USER"))) $P(VAFEVN,HL("FS"),6)=@EVNTINFO@("USER")
"RTN","VAFCMSG3",22,0)
 Q
"RTN","VAFCMSG3",23,0)
BLDPID ;
"RTN","VAFCMSG3",24,0)
 S VAFPID=$$EN^VAFCPID(DFN,VAFSTR)
"RTN","VAFCMSG3",25,0)
 ;CHECK IF PATIENT HAS AN ICN IF NOT A28
"RTN","VAFCMSG3",26,0)
 I $P(VAFPID,HL("FS"),3)=HLQ&(EVNTHL7'="A28") D
"RTN","VAFCMSG3",27,0)
 . I $T(GETICN^MPIF001)']"" Q
"RTN","VAFCMSG3",28,0)
 . ; returns National ICN -- don't create local ICN
"RTN","VAFCMSG3",29,0)
 . N ICN S ICN=$$GETICN^MPIF001(DFN)
"RTN","VAFCMSG3",30,0)
 . I +ICN>0 S $P(VAFPID,HL("FS"),3)=ICN
"RTN","VAFCMSG3",31,0)
 Q
"RTN","VAFCMSG3",32,0)
 ;
"RTN","VAFCMSG3",33,0)
BLDPD1 ;
"RTN","VAFCMSG3",34,0)
 I EVNTHL7="A28" D
"RTN","VAFCMSG3",35,0)
 . N CHANGE,CMOR
"RTN","VAFCMSG3",36,0)
 . N X S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCMSG3",37,0)
 . I +$$GETVCCI^MPIF001(DFN)'>0 D
"RTN","VAFCMSG3",38,0)
 . . ;S CMOR=$P($$SITE^VASITE(),"^")
"RTN","VAFCMSG3",39,0)
 . . ;S CHANGE=$$CHANGE^MPIF001(DFN,CMOR)
"RTN","VAFCMSG3",40,0)
 . . ;I +CHANGE<0 D START^RGHLLOG(),EXC^RGHLLOG(211,"Trouble updating CMOR while building A28 msg in VAFCMSG3 for DFN = "_DFN),STOP^RGHLLOG()
"RTN","VAFCMSG3",41,0)
 S VAFPD1=$$EN^VAFHLPD1(DFN)
"RTN","VAFCMSG3",42,0)
 ;
"RTN","VAFCMSG3",43,0)
BLDPV1 I EVNTHL7="A28" S VAFPV1="PV1"_HL("FS")_1
"RTN","VAFCMSG3",44,0)
 E  S VAFPV1=$$EN^VAFCPV1(DFN) Q
"RTN","VAFCMSG3",45,0)
 ;
"RTN","VAFCMSG3",46,0)
BLDOBX ;
"RTN","VAFCMSG3",47,0)
 N VAFARRY S SECINFO=$$EN^VAFHLZSN(DFN) I $P(SECINFO,"^",2)'="" D
"RTN","VAFCMSG3",48,0)
 . S VAFARRY(2)="CE"
"RTN","VAFCMSG3",49,0)
 . S $P(VAFARRY(3),$E(HL("ECH"),1),2)="SECURITY LEVEL"
"RTN","VAFCMSG3",50,0)
 . S VAFARRY(5)=$P(SECINFO,"^",2)
"RTN","VAFCMSG3",51,0)
 . S VAFARRY(11)="F"
"RTN","VAFCMSG3",52,0)
 . S VAFARRY(14)=$$FMDATE^HLFNC($P(SECINFO,"^",4))
"RTN","VAFCMSG3",53,0)
 . S VAFARRY(16)=$P(SECINFO,"^",3)
"RTN","VAFCMSG3",54,0)
 ;
"RTN","VAFCMSG3",55,0)
 S VAFOBX=$$EN^VAFHLOBX(.VAFARRY) K SECINFO
"RTN","VAFCMSG3",56,0)
 Q
"RTN","VAFCMSG3",57,0)
 ;
"RTN","VAFCMSG3",58,0)
BLDZPD S VAFZPD=$$EN^VAFHLZPD(DFN,VAFSTR) Q
"RTN","VAFCMSG3",59,0)
 ;
"RTN","VAFCMSG3",60,0)
BLDZSP S VAFZSP=$$EN^VAFHLZSP(DFN) Q
"RTN","VAFCMSG3",61,0)
 ;
"RTN","VAFCMSG3",62,0)
BLDZEL S VAFZEL=$$EN^VAFHLZEL(DFN,VAFSTR,1) Q
"RTN","VAFCMSG3",63,0)
 ;
"RTN","VAFCMSG3",64,0)
BLDZCT S VAFZCT=$$EN^VAFHLZCT(DFN,VAFSTR) Q
"RTN","VAFCMSG3",65,0)
 ;
"RTN","VAFCMSG3",66,0)
BLDZEM S VAFZEM=$$EN^VAFHLZEM(DFN,VAFSTR) Q
"RTN","VAFCMSG3",67,0)
 ;
"RTN","VAFCMSG3",68,0)
BLDZFF S VAFZFF="ZFF"_HL("FS")_2_HL("FS")
"RTN","VAFCMSG3",69,0)
 S VAFZFF=VAFZFF_$P($G(^VAT(391.71,+$G(@EVNTINFO@("PIVOT")),2)),U)
"RTN","VAFCMSG3",70,0)
 Q
"RTN","VAFCMSG3",71,0)
 ;
"RTN","VAFCMSG3",72,0)
BLDZIR K DGREL,DGINC,DGINR,DGDEP
"RTN","VAFCMSG3",73,0)
 D ALL^DGMTU21(DFN,"V",EVNTDATE,"R")
"RTN","VAFCMSG3",74,0)
 S VAFZIR=$$EN^VAFHLZIR(+$G(DGINR("V")),VAFSTR,1)
"RTN","VAFCMSG3",75,0)
 K DGREL,DGINC,DGINR,DGDEP
"RTN","VAFCMSG3",76,0)
 Q
"RTN","VAFCMSG3",77,0)
 ;
"RTN","VAFCMSG3",78,0)
BLDZEN S VAFZEN=$$EN^VAFHLZEN(DFN,VAFSTR,1,HL("Q"),HL("FS")) Q
"RTN","VAFCMSG3",79,0)
 ;
"RTN","VAFCMSG3",80,0)
 ;
"RTN","VAFCMSG3",81,0)
 ;-- Line tags for copying HL7 segments into HL7 message
"RTN","VAFCMSG3",82,0)
 ;
"RTN","VAFCMSG3",83,0)
 ; Standardized variable names:
"RTN","VAFCMSG3",84,0)
 ;   Variables set by BLDxxx tags
"RTN","VAFCMSG3",85,0)
 ;   XMITARRY - Array to build HL7 message into (full global reference)
"RTN","VAFCMSG3",86,0)
 ;   LASTLINE - Last line number used in HL7 message
"RTN","VAFCMSG3",87,0)
 ;            - This value will be incremented appropriately
"RTN","VAFCMSG3",88,0)
 ;   LINESADD - Total number of lines added to HL7 message
"RTN","VAFCMSG3",89,0)
 ;            - This value will be incremented appropriately
"RTN","VAFCMSG3",90,0)
 ;
"RTN","VAFCMSG3",91,0)
CPYEVN N I
"RTN","VAFCMSG3",92,0)
 S LASTLINE=1+$G(LASTLINE)
"RTN","VAFCMSG3",93,0)
 S @XMITARRY@(LASTLINE)=VAFEVN
"RTN","VAFCMSG3",94,0)
 S LINESADD=1+$G(LINESADD)
"RTN","VAFCMSG3",95,0)
 S I=""
"RTN","VAFCMSG3",96,0)
 F  S I=+$O(VAFEVN(I)) Q:('I)  D
"RTN","VAFCMSG3",97,0)
 .S @XMITARRY@(LASTLINE,I)=VAFEVN(I)
"RTN","VAFCMSG3",98,0)
 .S LINESADD=LINESADD+1
"RTN","VAFCMSG3",99,0)
 Q
"RTN","VAFCMSG3",100,0)
 ;                                 rev $o is # lines from array 
"RTN","VAFCMSG3",101,0)
CPYPID S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFPID(""),-1)
"RTN","VAFCMSG3",102,0)
 MERGE @XMITARRY@(LASTLINE)=VAFPID Q
"RTN","VAFCMSG3",103,0)
 ;
"RTN","VAFCMSG3",104,0)
CPYPD1 S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFPD1(""),-1)
"RTN","VAFCMSG3",105,0)
 MERGE @XMITARRY@(LASTLINE)=VAFPD1 Q
"RTN","VAFCMSG3",106,0)
 ;
"RTN","VAFCMSG3",107,0)
CPYPV1 S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFPV1(""),-1)
"RTN","VAFCMSG3",108,0)
 MERGE @XMITARRY@(LASTLINE)=VAFPV1 Q
"RTN","VAFCMSG3",109,0)
 ;
"RTN","VAFCMSG3",110,0)
CPYOBX S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFOBX(""),-1)
"RTN","VAFCMSG3",111,0)
 MERGE @XMITARRY@(LASTLINE)=VAFOBX Q
"RTN","VAFCMSG3",112,0)
 ;
"RTN","VAFCMSG3",113,0)
CPYZPD S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZPD(""),-1)
"RTN","VAFCMSG3",114,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZPD Q
"RTN","VAFCMSG3",115,0)
 ;
"RTN","VAFCMSG3",116,0)
CPYZSP S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZSP(""),-1)
"RTN","VAFCMSG3",117,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZSP Q
"RTN","VAFCMSG3",118,0)
 ;
"RTN","VAFCMSG3",119,0)
CPYZEL S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZEL(""),-1)
"RTN","VAFCMSG3",120,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZEL Q
"RTN","VAFCMSG3",121,0)
 ;
"RTN","VAFCMSG3",122,0)
CPYZCT S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZCT(""),-1)
"RTN","VAFCMSG3",123,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZCT Q
"RTN","VAFCMSG3",124,0)
 ;
"RTN","VAFCMSG3",125,0)
CPYZEM S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZEM(""),-1)
"RTN","VAFCMSG3",126,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZEM Q
"RTN","VAFCMSG3",127,0)
 ;
"RTN","VAFCMSG3",128,0)
CPYZFF S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZFF(""),-1)
"RTN","VAFCMSG3",129,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZFF Q
"RTN","VAFCMSG3",130,0)
 ;
"RTN","VAFCMSG3",131,0)
CPYZIR S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZIR(""),-1)
"RTN","VAFCMSG3",132,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZIR Q
"RTN","VAFCMSG3",133,0)
 ;
"RTN","VAFCMSG3",134,0)
CPYZEN S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZEN(""),-1)
"RTN","VAFCMSG3",135,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZEN Q
"RTN","VAFCMSG3",136,0)
 ;
"RTN","VAFCMSG3",137,0)
 ;
"RTN","VAFCMSG3",138,0)
 ;-- Line tags for deleting variables used to build HL7 segments
"RTN","VAFCMSG3",139,0)
 ;
"RTN","VAFCMSG3",140,0)
DELEVN K VAFEVN Q
"RTN","VAFCMSG3",141,0)
 ;
"RTN","VAFCMSG3",142,0)
DELPID K VAFPID Q
"RTN","VAFCMSG3",143,0)
 ;
"RTN","VAFCMSG3",144,0)
DELPD1 K VAFPD1 Q
"RTN","VAFCMSG3",145,0)
 ;
"RTN","VAFCMSG3",146,0)
DELPV1 K VAFPV1 Q
"RTN","VAFCMSG3",147,0)
 ;
"RTN","VAFCMSG3",148,0)
DELOBX K VAFOBX Q
"RTN","VAFCMSG3",149,0)
 ;
"RTN","VAFCMSG3",150,0)
DELZPD K VAFZPD Q
"RTN","VAFCMSG3",151,0)
 ;
"RTN","VAFCMSG3",152,0)
DELZSP K VAFZSP Q 
"RTN","VAFCMSG3",153,0)
 ;
"RTN","VAFCMSG3",154,0)
DELZEL K VAFZEL Q
"RTN","VAFCMSG3",155,0)
 ;
"RTN","VAFCMSG3",156,0)
DELZCT K VAFZCT Q
"RTN","VAFCMSG3",157,0)
 ;
"RTN","VAFCMSG3",158,0)
DELZEM K VAFZEM Q
"RTN","VAFCMSG3",159,0)
 ;
"RTN","VAFCMSG3",160,0)
DELZFF K VAFZFF Q
"RTN","VAFCMSG3",161,0)
 ;
"RTN","VAFCMSG3",162,0)
DELZIR K VAFZIR Q
"RTN","VAFCMSG3",163,0)
 ;
"RTN","VAFCMSG3",164,0)
DELZEN K VAFZEN Q
"RTN","VAFCMSG3",165,0)
 ;
"RTN","VAFCPID2")
0^5^B19009450
"RTN","VAFCPID2",1,0)
VAFCPID2 ;ALB/MLI,PKE-Create generic PID segment ; 22 Jan 2002 10:30 AM
"RTN","VAFCPID2",2,0)
 ;;5.3;Registration;**149,240,312,428,494**;Aug 13, 1993
"RTN","VAFCPID2",3,0)
 ; aggressive name re-formatting
"RTN","VAFCPID2",4,0)
 ;
"RTN","VAFCPID2",5,0)
NAME(DFN,MPISTR,FLG) ;Being aggressive about where Suffix is placed, extra punctuation
"RTN","VAFCPID2",6,0)
 ;DFN - ien from Patient file  MPISTR - name as stored in Patient file
"RTN","VAFCPID2",7,0)
 ;FLG - Parameter no longer supported.  Originally denoted whether or
"RTN","VAFCPID2",8,0)
 ;      not to update the patient file.  Patient file will not be
"RTN","VAFCPID2",9,0)
 ;      updated anymore.
"RTN","VAFCPID2",10,0)
 I $E(MPISTR,1,14)="MERGING INTO `" S MPISTR=$P($P(MPISTR,"(",2),")") Q  ;**240
"RTN","VAFCPID2",11,0)
 S FLG=0
"RTN","VAFCPID2",12,0)
 N LAST,FIRST,MIDDLE,SUFFIX,POS,LAST12,LAST2,LAST3,REST,SUF,SEC,SEC12,SEC3,MID12,MID3,FIR12,FIR3,PL,MID3,TMPSTR,TFLG
"RTN","VAFCPID2",13,0)
 S TFLG="N"
"RTN","VAFCPID2",14,0)
 S TMPSTR=MPISTR
"RTN","VAFCPID2",15,0)
 I $E(MPISTR,($L(MPISTR)-4),$L(MPISTR))=" TEST" S MPISTR=$E(MPISTR,1,($L(MPISTR)-4)),TFLG="Y"
"RTN","VAFCPID2",16,0)
 I MPISTR["'" S MPISTR=$TR(MPISTR,"'","") ;Remove ' punctuation marks from the name
"RTN","VAFCPID2",17,0)
 S MPISTR=$TR(MPISTR,"."," ") I $E(MPISTR,$L(MPISTR))=" " S MPISTR=$E(MPISTR,1,$L(MPISTR)-1)
"RTN","VAFCPID2",18,0)
 ;check if 3rd instead of III
"RTN","VAFCPID2",19,0)
 I $F(MPISTR,"3RD")'=0 S MPISTR=$E(MPISTR,1,$F(MPISTR,"3RD")-4)_"III"_$E(MPISTR,$F(MPISTR,"3RD"),$L(MPISTR))
"RTN","VAFCPID2",20,0)
 ;check if 2nd instead of II
"RTN","VAFCPID2",21,0)
 I $F(MPISTR,"2ND")'=0 S MPISTR=$E(MPISTR,1,$F(MPISTR,"2ND")-4)_"II"_$E(MPISTR,$F(MPISTR,"2ND"),$L(MPISTR))
"RTN","VAFCPID2",22,0)
 I $P(MPISTR,",",3)'="" S PL=$F(MPISTR,","),FIRST=$E(MPISTR,PL,$L(MPISTR)),MPISTR=$P(MPISTR,",")_","_$TR(FIRST,","," ")
"RTN","VAFCPID2",23,0)
TR I $F(MPISTR,"  ") S PL=$F(MPISTR,"  "),MPISTR=$E(MPISTR,1,PL-2)_$E(MPISTR,PL,$L(MPISTR)) G TR
"RTN","VAFCPID2",24,0)
 ;check for more than three pieces after the comma - ex: last,j.r. first mi
"RTN","VAFCPID2",25,0)
 I $P(MPISTR,",",2)?.A1" ".A1" ".A1" ".A S REST=$P(MPISTR,",",2) I $E(REST,1,4)?1A1" "1A1" " S POS=$E(REST,1)_$E(REST,3) D
"RTN","VAFCPID2",26,0)
 .I POS="II"!(POS="IV")!(POS="VI")!(POS="JR")!(POS="SR")!(POS="DR") S SUF="Y" S MPISTR=$P(MPISTR,",")_","_$E(REST,5,$L(REST))_" "_POS,POS="Y"
"RTN","VAFCPID2",27,0)
 ;move the suffix from the left of the comma to the end of the name str
"RTN","VAFCPID2",28,0)
 S LAST=$P(MPISTR,","),REST=$P(MPISTR,",",2),POS="N",SUF="N"
"RTN","VAFCPID2",29,0)
 I LAST?.A1" ".E D
"RTN","VAFCPID2",30,0)
 .S LAST2=$P(LAST," ",2),LAST12=$E(LAST2,1,2),LAST3=$E(LAST2,3)
"RTN","VAFCPID2",31,0)
 .I LAST12="V"!(LAST12="V.")!(LAST12="I")!(LAST12="I.") S POS="Y",SUFFIX=LAST2
"RTN","VAFCPID2",32,0)
 .I LAST12="JR"!(LAST12="SR")!(LAST12="DR")!(LAST12="MD")!(LAST12="II")!(LAST12="IV")!(LAST12="VI") S POS="Y",SUFFIX=LAST2
"RTN","VAFCPID2",33,0)
 .I POS="Y",(LAST12="II") I LAST3'="",(LAST3'="."),(LAST3'="I") S POS="N",SUFFIX=""
"RTN","VAFCPID2",34,0)
 .I POS="Y",(LAST12="VI") I LAST3'="",(LAST3'="."),(LAST3'="I") S POS="N",SUFFIX=""
"RTN","VAFCPID2",35,0)
 .I POS="Y",LAST12'="II",LAST12'="VI" I LAST3'=""&(LAST3'=".") S POS="N"
"RTN","VAFCPID2",36,0)
 .I LAST12="ES"&(LAST3="Q") S POS="Y",SUFFIX=LAST2
"RTN","VAFCPID2",37,0)
 .I $D(SUFFIX) S SUFFIX=$TR(SUFFIX,".","")
"RTN","VAFCPID2",38,0)
 .I POS="Y" S MPISTR=$P(LAST," ")_","_REST_" "_SUFFIX,POS="N",SUF="Y"
"RTN","VAFCPID2",39,0)
 I POS="N",$P(MPISTR,",")[" " D
"RTN","VAFCPID2",40,0)
 .S LAST=$P(MPISTR,","),LAST2=$P(LAST," ",2) I $P(LAST," ",3)'="" S MPISTR=$P(LAST," ")_LAST2_" "_$P(LAST," ",3)_","_$P(MPISTR,",",2)
"RTN","VAFCPID2",41,0)
 ;
"RTN","VAFCPID2",42,0)
SP ;remove any extra spaces
"RTN","VAFCPID2",43,0)
 I $F(MPISTR,"  ") S PL=$F(MPISTR,"  "),MPISTR=$E(MPISTR,1,PL-2)_$E(MPISTR,PL,$L(MPISTR)) G SP
"RTN","VAFCPID2",44,0)
 ;Check for middle name existence with suffix to put a place holder of ""
"RTN","VAFCPID2",45,0)
 S SEC=$P(MPISTR,",",2),FIRST=$P(SEC," "),MIDDLE=$P(SEC," ",2),SUFFIX=$P(SEC," ",3)
"RTN","VAFCPID2",46,0)
 I SUFFIX="",SUF="Y" S SUFFIX=MIDDLE,MIDDLE="""""",MPISTR=$P(MPISTR,",")_","_FIRST_" "_MIDDLE_" "_SUFFIX
"RTN","VAFCPID2",47,0)
 ; ^ SUF="Y" means we moved it from left to right of comma
"RTN","VAFCPID2",48,0)
 I SUFFIX="",SUF="N" D
"RTN","VAFCPID2",49,0)
 .S MID12=$E(MIDDLE,1,2),MID3=$E(MIDDLE,3) ;Check if MIDDLE is a suffix
"RTN","VAFCPID2",50,0)
 .I MID12="ES"&(MID3="Q") S POS="Y"
"RTN","VAFCPID2",51,0)
 .I MID12="JR"!(MID12="SR")!(MID12="DR")!(MID12="MD")!(MID12="II")!(MID12="IV")!(MID12="VI") S POS="Y"
"RTN","VAFCPID2",52,0)
 .I POS="Y",(MID12="II") I MID3'="",(MID3'="."),(MID3'="I") S POS="N",SUFFIX=""
"RTN","VAFCPID2",53,0)
 .I POS="Y",(MID12="VI") I MID3'="",(MID3'="."),(MID3'="I") S POS="N",SUFFIX=""
"RTN","VAFCPID2",54,0)
 .I POS="Y",MID12'="II",MID12'="VI" I MID3'=""&(MID3'=".") S POS="N"
"RTN","VAFCPID2",55,0)
 .I POS="Y" S SUFFIX=MIDDLE,MIDDLE=""""""
"RTN","VAFCPID2",56,0)
 .S MPISTR=$P(MPISTR,",")_","_FIRST_" "_MIDDLE_" "_SUFFIX
"RTN","VAFCPID2",57,0)
 S POS="N"
"RTN","VAFCPID2",58,0)
 S FIR12=$E(FIRST,1,2),FIR3=$E(FIRST,3) ;check if FIRST is a suffix
"RTN","VAFCPID2",59,0)
 I FIR12="ES"&(FIR3="Q") S POS="Y"
"RTN","VAFCPID2",60,0)
 I FIR12="JR"!(FIR12="SR")!(FIR12="DR")!(FIR12="MD")!(FIR12="II")!(FIR12="IV")!(FIR12="VI") S POS="Y"
"RTN","VAFCPID2",61,0)
 I POS="Y",(FIR12="II") I FIR3'="",(FIR3'="."),(FIR3'="I") S POS="N",SUFFIX=""
"RTN","VAFCPID2",62,0)
 I POS="Y",(FIR12="VI") I FIR3'="",(FIR3'="."),(FIR3'="I") S POS="N",SUFFIX=""
"RTN","VAFCPID2",63,0)
 I POS="Y",FIR12'="II",FIR12'="VI" I FIR3'=""&(FIR3'=".") S POS="N"
"RTN","VAFCPID2",64,0)
 ; if no middle name can't be sure if initials or suffix so will leave as initials
"RTN","VAFCPID2",65,0)
 I POS="Y",MIDDLE="" S MPISTR=$P(MPISTR,",")_","_$E(FIR12,1)_" "_$E(FIR12,2) S POS="N"
"RTN","VAFCPID2",66,0)
 I TFLG="Y" S MPISTR=MPISTR_" TEST"
"RTN","VAFCPID2",67,0)
 I POS="Y" S MPISTR=$P(MPISTR,",")_","_MIDDLE_" "_$S(SUFFIX="":"""""",1:SUFFIX)_" "_FIRST
"RTN","VAFCPID2",68,0)
SP2 ;remove any extra spaces
"RTN","VAFCPID2",69,0)
 I $F(MPISTR,"  ") S PL=$F(MPISTR,"  "),MPISTR=$E(MPISTR,1,PL-2)_$E(MPISTR,PL,$L(MPISTR)) G SP2
"RTN","VAFCPID2",70,0)
 I $E(MPISTR,$L(MPISTR))=" " S MPISTR=$E(MPISTR,1,($L(MPISTR)-1))
"RTN","VAFCPID2",71,0)
 Q
"RTN","VAFHAPV1")
0^6^B78706286
"RTN","VAFHAPV1",1,0)
VAFHAPV1 ;ALB/RJS - INPATIENT PV1 SEGMENT ; 22 Jan 2002 10:29 AM
"RTN","VAFHAPV1",2,0)
 ;;5.3;Registration;**91,209,190,298,494**;Aug 13, 1993
"RTN","VAFHAPV1",3,0)
 ;
"RTN","VAFHAPV1",4,0)
 ;The DGBUILD entry point is call used internally by MAS software
"RTN","VAFHAPV1",5,0)
 ;to build a PV1 Segment for deleted Admissions. The DGPMP
"RTN","VAFHAPV1",6,0)
 ;variable, available from the DGPM Event Driver at the time of
"RTN","VAFHAPV1",7,0)
 ;the deletion, makes it possible to construct a partial PV1 segment
"RTN","VAFHAPV1",8,0)
 ;for the deleted record.
"RTN","VAFHAPV1",9,0)
 ;
"RTN","VAFHAPV1",10,0)
 ;06/29/00 ACS - Added sequence 21 (physical treating specialty - ward
"RTN","VAFHAPV1",11,0)
 ;location) and sequence 39 (facility + suffix).
"RTN","VAFHAPV1",12,0)
 ;
"RTN","VAFHAPV1",13,0)
EN(DFN,VAFHDT,VAFSTR,IEN,ALTVISID,SETID,VAFDIAG) ;
"RTN","VAFHAPV1",14,0)
 ;
"RTN","VAFHAPV1",15,0)
 ;This Entry Point builds the HL7 PV1 segment for inpatients.
"RTN","VAFHAPV1",16,0)
 ;
"RTN","VAFHAPV1",17,0)
 ;DFN, VAFHDT, & VAFSTR are the required variables.
"RTN","VAFHAPV1",18,0)
 ;
"RTN","VAFHAPV1",19,0)
 ;            DFN = IEN of Patient File
"RTN","VAFHAPV1",20,0)
 ;         VAFHDT = Date/Time of Patient Movement
"RTN","VAFHAPV1",21,0)
 ;         VAFSTR = HL7 Fields Requested e.g. ",3,7,10"
"RTN","VAFHAPV1",22,0)
 ;
"RTN","VAFHAPV1",23,0)
 ;IEN, ALTVISID, SETID are the optional variables
"RTN","VAFHAPV1",24,0)
 ;
"RTN","VAFHAPV1",25,0)
 ;The optional variable IEN is used for Discharge movements
"RTN","VAFHAPV1",26,0)
 ;because if only Date/Time is passed for a Discharge movement
"RTN","VAFHAPV1",27,0)
 ;no useful information is returned by VADPT.
"RTN","VAFHAPV1",28,0)
 ;
"RTN","VAFHAPV1",29,0)
 ;The optional ALTVISID variable is used to pass in a "Alternate.
"RTN","VAFHAPV1",30,0)
 ;Visit ID" this is a unique number that 
"RTN","VAFHAPV1",31,0)
 ;identifies this Admission or episode of care
"RTN","VAFHAPV1",32,0)
 ;
"RTN","VAFHAPV1",33,0)
 ;The optional variable SETID can be used to differentiate 
"RTN","VAFHAPV1",34,0)
 ;different sets of data, in messages that may contain multiple
"RTN","VAFHAPV1",35,0)
 ;events or messages.
"RTN","VAFHAPV1",36,0)
 ;
"RTN","VAFHAPV1",37,0)
 ;VAFDIAG, is a passed as a dotted variable. The inpatient diagnosis
"RTN","VAFHAPV1",38,0)
 ;is then returned in this variable.
"RTN","VAFHAPV1",39,0)
 ;
"RTN","VAFHAPV1",40,0)
 N VAFCOMP,RESULT,VAROOT,VA200
"RTN","VAFHAPV1",41,0)
 N CURRENT
"RTN","VAFHAPV1",42,0)
 D KVAR^VADPT
"RTN","VAFHAPV1",43,0)
 S VAFCOMP=$E(HLECH,1)
"RTN","VAFHAPV1",44,0)
 S VAROOT="CURRENT",VAIP("D")=VAFHDT,VA200=1
"RTN","VAFHAPV1",45,0)
 I ($G(IEN)'="") S VAIP("E")=IEN
"RTN","VAFHAPV1",46,0)
 D IN5^VADPT
"RTN","VAFHAPV1",47,0)
 S RESULT=$$BUILD()
"RTN","VAFHAPV1",48,0)
 I $G(ALTVISID)'="" S $P(RESULT,HLFS,51)=ALTVISID
"RTN","VAFHAPV1",49,0)
 I $G(SETID)'="" S $P(RESULT,HLFS,2)=SETID
"RTN","VAFHAPV1",50,0)
 I $G(SETID)="" S $P(RESULT,HLFS,2)=1
"RTN","VAFHAPV1",51,0)
 ;
"RTN","VAFHAPV1",52,0)
EXIT ;
"RTN","VAFHAPV1",53,0)
 Q $G(RESULT)
"RTN","VAFHAPV1",54,0)
 ;
"RTN","VAFHAPV1",55,0)
BUILD() ;Build the PV1 Segment
"RTN","VAFHAPV1",56,0)
 ;
"RTN","VAFHAPV1",57,0)
 ;Required Variables: Array "CURRENT" containing the results
"RTN","VAFHAPV1",58,0)
 ;                    of a call to VADPT
"RTN","VAFHAPV1",59,0)
 ;
"RTN","VAFHAPV1",60,0)
 ;This entry point is called to build the HL7 PV1 segment from
"RTN","VAFHAPV1",61,0)
 ;data returned by VADPT
"RTN","VAFHAPV1",62,0)
 ;
"RTN","VAFHAPV1",63,0)
 ;It returns a fully encoded HL7 segment, or a partially encoded HL7 segment containing patient class only
"RTN","VAFHAPV1",64,0)
 ;
"RTN","VAFHAPV1",65,0)
 N RESULT,SUBS
"RTN","VAFHAPV1",66,0)
 S RESULT="PV1"_HLFS_HLFS_"I"
"RTN","VAFHAPV1",67,0)
 I $G(CURRENT(1))="" Q RESULT
"RTN","VAFHAPV1",68,0)
 I $G(CURRENT(1))'="" D
"RTN","VAFHAPV1",69,0)
 . S VAFDIAG=CURRENT(9)
"RTN","VAFHAPV1",70,0)
 . ;
"RTN","VAFHAPV1",71,0)
 . ;--Ward, Room, Bed
"RTN","VAFHAPV1",72,0)
 . ;
"RTN","VAFHAPV1",73,0)
 . I VAFSTR[",3," D
"RTN","VAFHAPV1",74,0)
 . . N WARD,ROOM,BED
"RTN","VAFHAPV1",75,0)
 . . S WARD=$$HLQ^VAFHUTL($P(CURRENT(5),"^",2))
"RTN","VAFHAPV1",76,0)
 . . S ROOM=$$HLQ^VAFHUTL($P($P(CURRENT(6),"^",2),"-",1))
"RTN","VAFHAPV1",77,0)
 . . S BED=$$HLQ^VAFHUTL($P($P(CURRENT(6),"^",2),"-",2))
"RTN","VAFHAPV1",78,0)
 . . S $P(RESULT,HLFS,4)=$G(WARD)_VAFCOMP_$G(ROOM)_VAFCOMP_$G(BED)
"RTN","VAFHAPV1",79,0)
 . ;
"RTN","VAFHAPV1",80,0)
 . ;--Attending Physician
"RTN","VAFHAPV1",81,0)
 . ;
"RTN","VAFHAPV1",82,0)
 . I VAFSTR[",7," D
"RTN","VAFHAPV1",83,0)
 . . N ATTNDPTR,ATTNDING
"RTN","VAFHAPV1",84,0)
 . . S ATTNDPTR=$P(CURRENT(18),"^",1)
"RTN","VAFHAPV1",85,0)
 . . S:ATTNDPTR'="" ATTNDING=$$HLNAME^HLFNC($P(CURRENT(18),"^",2))
"RTN","VAFHAPV1",86,0)
 . . S $P(RESULT,HLFS,8)=$$HLQ^VAFHUTL($G(ATTNDPTR))_VAFCOMP_$$HLQ^VAFHUTL($G(ATTNDING))
"RTN","VAFHAPV1",87,0)
 . ;
"RTN","VAFHAPV1",88,0)
 . ;--Treating Specialty
"RTN","VAFHAPV1",89,0)
 . ;
"RTN","VAFHAPV1",90,0)
 . I VAFSTR[",10," D
"RTN","VAFHAPV1",91,0)
 . . N SPECPTR,SPECALTY
"RTN","VAFHAPV1",92,0)
 . . S SPECPTR=$P(CURRENT(8),"^",1)
"RTN","VAFHAPV1",93,0)
 . . S:$G(SPECPTR)'="" SPECALTY=$P($G(^DIC(45.7,SPECPTR,0)),"^",2)
"RTN","VAFHAPV1",94,0)
 . . S $P(RESULT,HLFS,11)=$$HLQ^VAFHUTL($G(SPECALTY))
"RTN","VAFHAPV1",95,0)
 . ;
"RTN","VAFHAPV1",96,0)
 . ;--Previous Patient Location
"RTN","VAFHAPV1",97,0)
 . I VAFSTR["6" D
"RTN","VAFHAPV1",98,0)
 . . N WARD,ROOM,BED,ROOMPTR,ROOMBED,MOVEMENT
"RTN","VAFHAPV1",99,0)
 . . S WARD=$$HLQ^VAFHUTL($P(CURRENT(15,4),"^",2))
"RTN","VAFHAPV1",100,0)
 . . S MOVEMENT=$G(CURRENT(15))
"RTN","VAFHAPV1",101,0)
 . . I MOVEMENT D
"RTN","VAFHAPV1",102,0)
 . . . S ROOMPTR=$P(^DGPM(MOVEMENT,0),"^",7)
"RTN","VAFHAPV1",103,0)
 . . . I ROOMPTR D
"RTN","VAFHAPV1",104,0)
 . . . . S ROOMBED=$P(^DG(405.4,ROOMPTR,0),"^",1)
"RTN","VAFHAPV1",105,0)
 . . . . I (ROOMBED'="") D
"RTN","VAFHAPV1",106,0)
 . . . . . S ROOM=$P(ROOMBED,"-",1)
"RTN","VAFHAPV1",107,0)
 . . . . . S BED=$P(ROOMBED,"-",2)
"RTN","VAFHAPV1",108,0)
 . . S $P(RESULT,HLFS,7)=$$HLQ^VAFHUTL($G(WARD))_VAFCOMP_$$HLQ^VAFHUTL($G(ROOM))_VAFCOMP_$$HLQ^VAFHUTL($G(BED))
"RTN","VAFHAPV1",109,0)
 . ;
"RTN","VAFHAPV1",110,0)
 . ;-- Patient Type
"RTN","VAFHAPV1",111,0)
 . I VAFSTR["18" D
"RTN","VAFHAPV1",112,0)
 . .I +$G(^DPT(DFN,"TYPE")) DO
"RTN","VAFHAPV1",113,0)
 . . .S $P(RESULT,HLFS,19)=$P($G(^DG(391,+^("TYPE"),0)),"^",1)
"RTN","VAFHAPV1",114,0)
 . .E  S $P(RESULT,HLFS,19)=HLQ
"RTN","VAFHAPV1",115,0)
 . ;
"RTN","VAFHAPV1",116,0)
 . ;--Physical Treating Specialty - Ward Location
"RTN","VAFHAPV1",117,0)
 . ;
"RTN","VAFHAPV1",118,0)
 . I VAFSTR[",21," D
"RTN","VAFHAPV1",119,0)
 . . N VAWARD,VAPHYTS
"RTN","VAFHAPV1",120,0)
 . . ; get ward location pointer
"RTN","VAFHAPV1",121,0)
 . . S VAWARD=$P($G(CURRENT(5)),"^",1) Q:VAWARD=""
"RTN","VAFHAPV1",122,0)
 . . ; get ward treating specialty pointer
"RTN","VAFHAPV1",123,0)
 . . S VAPHYTS=$P($G(^DIC(42,VAWARD,0)),"^",12)
"RTN","VAFHAPV1",124,0)
 . . S $P(RESULT,HLFS,22)=$S(VAPHYTS]"":VAPHYTS,1:HLQ)
"RTN","VAFHAPV1",125,0)
 . . Q
"RTN","VAFHAPV1",126,0)
 . ;
"RTN","VAFHAPV1",127,0)
 . ;--Facility and Suffix
"RTN","VAFHAPV1",128,0)
 . I VAFSTR[",39," D
"RTN","VAFHAPV1",129,0)
 . . N VAFIEN,VAWARD,VAMEDCTR,VAFACSUF
"RTN","VAFHAPV1",130,0)
 . . ; get patient movement IEN, ward loc ptr, med center div ptr
"RTN","VAFHAPV1",131,0)
 . . S VAFIEN=$G(CURRENT(1))
"RTN","VAFHAPV1",132,0)
 . . S VAWARD=$P($G(^DGPM(VAFIEN,0)),"^",6) Q:VAWARD=""
"RTN","VAFHAPV1",133,0)
 . . S VAMEDCTR=$P($G(^DIC(42,VAWARD,0)),"^",11) Q:VAMEDCTR=""
"RTN","VAFHAPV1",134,0)
 . . ; call below returns: inst pointer^inst name^station number w/suffix
"RTN","VAFHAPV1",135,0)
 . . S VAFACSUF=$$SITE^VASITE($G(CURRENT(3)),VAMEDCTR)
"RTN","VAFHAPV1",136,0)
 . . S VAFACSUF=$P(VAFACSUF,"^",3)
"RTN","VAFHAPV1",137,0)
 . . ; move data into the PV1 segment
"RTN","VAFHAPV1",138,0)
 . . S $P(RESULT,HLFS,40)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHAPV1",139,0)
 . ;
"RTN","VAFHAPV1",140,0)
 . ;Discharge Disposition
"RTN","VAFHAPV1",141,0)
 . I VAFSTR[",36," D  ;If Discharge Disposition requested
"RTN","VAFHAPV1",142,0)
 . .N DGDTYP
"RTN","VAFHAPV1",143,0)
 . .S DGDTYP=$P(CURRENT(17,3),"^") S $P(RESULT,HLFS,37)=DGDTYP
"RTN","VAFHAPV1",144,0)
 . ;
"RTN","VAFHAPV1",145,0)
 . ;--Admission Date
"RTN","VAFHAPV1",146,0)
 . ;
"RTN","VAFHAPV1",147,0)
 . I (VAFSTR["44") D
"RTN","VAFHAPV1",148,0)
 . . I ($P(CURRENT(13,1),"^",1)'="") S $P(RESULT,HLFS,45)=$$HLDATE^HLFNC($P(CURRENT(13,1),"^",1),"TS")
"RTN","VAFHAPV1",149,0)
 . . E  S $P(RESULT,HLFS,45)=HLQ
"RTN","VAFHAPV1",150,0)
 . ;
"RTN","VAFHAPV1",151,0)
 . ;
"RTN","VAFHAPV1",152,0)
 . ;--Discharge Date
"RTN","VAFHAPV1",153,0)
 . ;
"RTN","VAFHAPV1",154,0)
 . I (VAFSTR["45") D
"RTN","VAFHAPV1",155,0)
 . . I ($P(CURRENT(17,1),"^",1)'="") S $P(RESULT,HLFS,46)=$$HLDATE^HLFNC($P(CURRENT(17,1),"^",1),"TS")
"RTN","VAFHAPV1",156,0)
 . . E  S $P(RESULT,HLFS,46)=HLQ
"RTN","VAFHAPV1",157,0)
 ;
"RTN","VAFHAPV1",158,0)
 Q:$$TEST(7,RESULT,HLFS,VAFCOMP) RESULT
"RTN","VAFHAPV1",159,0)
 Q RESULT
"RTN","VAFHAPV1",160,0)
DGBUILD(DGPMP,VAFSTR) ;
"RTN","VAFHAPV1",161,0)
 ;
"RTN","VAFHAPV1",162,0)
 ;Required Variables:    DGPMP = 0 node of patient movement
"RTN","VAFHAPV1",163,0)
 ;                      VAFSTR = HL7 fields requested e.g.
"RTN","VAFHAPV1",164,0)
 ;                               ",3,7,10"
"RTN","VAFHAPV1",165,0)
 ;
"RTN","VAFHAPV1",166,0)
 ;This entry point builds an HL7 segment from data supplied
"RTN","VAFHAPV1",167,0)
 ;from the 0 node of the Patient movement file in the required
"RTN","VAFHAPV1",168,0)
 ;variable DGPMP. It is an internal PIMS call used to build
"RTN","VAFHAPV1",169,0)
 ;a PV1 segment when the record has already been deleted.
"RTN","VAFHAPV1",170,0)
 ;
"RTN","VAFHAPV1",171,0)
 ;The call returns a fully encoded PV1 segment or a partially encoded
"RTN","VAFHAPV1",172,0)
 ;PV1 segment containing only set id and patient class
"RTN","VAFHAPV1",173,0)
 ;
"RTN","VAFHAPV1",174,0)
 N WARD,BED,ROOM,ATTNDPTR,ATTNDING,SPECPTR,SPECALTY,TRANSACT
"RTN","VAFHAPV1",175,0)
 N ADMPTR,ADMSSN,VAFCOMP,RESULT
"RTN","VAFHAPV1",176,0)
 S RESULT="PV1"_HLFS_1_HLFS_"I" ;Inpatient
"RTN","VAFHAPV1",177,0)
 I $G(DGPMP)="" Q RESULT
"RTN","VAFHAPV1",178,0)
 S TRANSACT=$P(DGPMP,"^",2),VAFCOMP=$E(HLECH,1)
"RTN","VAFHAPV1",179,0)
 I TRANSACT=1 S VAFDIAG=$P(DGPMP,"^",10)
"RTN","VAFHAPV1",180,0)
 E  S ADMPTR=$P(DGPMP,"^",14),ADMSSN=$G(^DGPM(ADMPTR,0)),VAFDIAG=$P(ADMSSN,"^",10)
"RTN","VAFHAPV1",181,0)
 ;
"RTN","VAFHAPV1",182,0)
 ;--Ward, Room, Bed
"RTN","VAFHAPV1",183,0)
 ;
"RTN","VAFHAPV1",184,0)
 I VAFSTR[",3," D
"RTN","VAFHAPV1",185,0)
 . N WARD,ROOM,BED
"RTN","VAFHAPV1",186,0)
 . ;
"RTN","VAFHAPV1",187,0)
 . ;--Check node 2 to see if it's a discharge movement
"RTN","VAFHAPV1",188,0)
 . ;
"RTN","VAFHAPV1",189,0)
 . ;
"RTN","VAFHAPV1",190,0)
 . I TRANSACT=3 D
"RTN","VAFHAPV1",191,0)
 . . S $P(RESULT,HLFS,4)=HLQ_VAFCOMP_HLQ_VAFCOMP_HLQ
"RTN","VAFHAPV1",192,0)
 . . ;
"RTN","VAFHAPV1",193,0)
 . . ;--All non discharge events are handled the same
"RTN","VAFHAPV1",194,0)
 . . ;
"RTN","VAFHAPV1",195,0)
 . I TRANSACT'=3 D
"RTN","VAFHAPV1",196,0)
 . . N WARDPTR,ROOMPTR,ROOM,WARD,BED
"RTN","VAFHAPV1",197,0)
 . . S WARDPTR=$P(DGPMP,"^",6)
"RTN","VAFHAPV1",198,0)
 . . S ROOMPTR=$P(DGPMP,"^",7)
"RTN","VAFHAPV1",199,0)
 . . I $G(WARDPTR)'="" S WARD=$P(^DIC(42,WARDPTR,0),"^",1)
"RTN","VAFHAPV1",200,0)
 . . I $G(ROOMPTR)'="" D
"RTN","VAFHAPV1",201,0)
 . . . S ROOM=$P(^DG(405.4,ROOMPTR,0),"^",1)
"RTN","VAFHAPV1",202,0)
 . . . S BED=$P(ROOM,"-",2)
"RTN","VAFHAPV1",203,0)
 . . . S ROOM=$P(ROOM,"-",1)
"RTN","VAFHAPV1",204,0)
 . . S $P(RESULT,HLFS,4)=$$HLQ^VAFHUTL($G(WARD))_VAFCOMP_$$HLQ^VAFHUTL($G(ROOM))_VAFCOMP_$$HLQ^VAFHUTL($G(BED))
"RTN","VAFHAPV1",205,0)
 . ;
"RTN","VAFHAPV1",206,0)
 . ;--Attending Physician
"RTN","VAFHAPV1",207,0)
 . ;
"RTN","VAFHAPV1",208,0)
 I VAFSTR[",7," D
"RTN","VAFHAPV1",209,0)
 . N ATTNDPTR,ATTNDING
"RTN","VAFHAPV1",210,0)
 . S ATTNDPTR=$P(DGPMP,"^",19)
"RTN","VAFHAPV1",211,0)
 . I $G(ATTNDPTR)'="" D
"RTN","VAFHAPV1",212,0)
 . . N DGNAME S DGNAME("FILE")=200,DGNAME("IENS")=ATTNDPTR,DGNAME("FIELD")=.01
"RTN","VAFHAPV1",213,0)
 . . S ATTNDING=$$HLNAME^XLFNAME(.DGNAME,"S",$E($G(HLECH)))
"RTN","VAFHAPV1",214,0)
 . S $P(RESULT,HLFS,8)=$$HLQ^VAFHUTL($G(ATTNDPTR))_VAFCOMP_$$HLQ^VAFHUTL($G(ATTNDING))
"RTN","VAFHAPV1",215,0)
 . ;
"RTN","VAFHAPV1",216,0)
 . ;--Treating Specialty
"RTN","VAFHAPV1",217,0)
 . ;
"RTN","VAFHAPV1",218,0)
 I VAFSTR[",10," D
"RTN","VAFHAPV1",219,0)
 . N SPECPTR,SPECALTY
"RTN","VAFHAPV1",220,0)
 . S SPECPTR=$P(DGPMP,"^",9)
"RTN","VAFHAPV1",221,0)
 . I $G(SPECPTR)'="" S SPECALTY=$P($G(^DIC(45.7,SPECPTR,0)),"^",2)
"RTN","VAFHAPV1",222,0)
 . S $P(RESULT,HLFS,11)=$$HLQ^VAFHUTL($G(SPECALTY))
"RTN","VAFHAPV1",223,0)
 ;
"RTN","VAFHAPV1",224,0)
 ;-- Patient Type
"RTN","VAFHAPV1",225,0)
 I VAFSTR["18" D
"RTN","VAFHAPV1",226,0)
 . I +$G(^DPT(DFN,"TYPE")) DO
"RTN","VAFHAPV1",227,0)
 . .  S $P(RESULT,HLFS,19)=$P($G(^DG(391,+^("TYPE"),0)),"^",1)
"RTN","VAFHAPV1",228,0)
 . E  S $P(RESULT,HLFS,19)=HLQ
"RTN","VAFHAPV1",229,0)
 ;
"RTN","VAFHAPV1",230,0)
 ;--Physical Treating Specialty - Ward Location
"RTN","VAFHAPV1",231,0)
 ;
"RTN","VAFHAPV1",232,0)
 I VAFSTR[",21," D
"RTN","VAFHAPV1",233,0)
 . N VAWARD,VAPHYTS
"RTN","VAFHAPV1",234,0)
 . ; get ward location pointer
"RTN","VAFHAPV1",235,0)
 . S VAWARD=$P($G(DGPMP),"^",6) Q:VAWARD=""
"RTN","VAFHAPV1",236,0)
 . ; get ward treating specialty
"RTN","VAFHAPV1",237,0)
 . S VAPHYTS=$P($G(^DIC(42,VAWARD,0)),"^",12)
"RTN","VAFHAPV1",238,0)
 . S $P(RESULT,HLFS,22)=$S(VAPHYTS]"":VAPHYTS,1:HLQ)
"RTN","VAFHAPV1",239,0)
 . Q
"RTN","VAFHAPV1",240,0)
 ;
"RTN","VAFHAPV1",241,0)
 ;--Facility and Suffix
"RTN","VAFHAPV1",242,0)
 ;
"RTN","VAFHAPV1",243,0)
 N VAWARD,VAMEDCTR,VAFACSUF
"RTN","VAFHAPV1",244,0)
 I VAFSTR[",39," D
"RTN","VAFHAPV1",245,0)
 . ; get ward location pointer, med center div pointer
"RTN","VAFHAPV1",246,0)
 . S $P(RESULT,HLFS,40)=HLQ
"RTN","VAFHAPV1",247,0)
 . S VAWARD=$P($G(DGPMP),"^",6) Q:VAWARD=""
"RTN","VAFHAPV1",248,0)
 . S VAMEDCTR=$P($G(^DIC(42,VAWARD,0)),"^",11) Q:VAMEDCTR=""
"RTN","VAFHAPV1",249,0)
 . ; call below returns: inst pointer^inst name^station number w/suffix
"RTN","VAFHAPV1",250,0)
 . S VAFACSUF=$$SITE^VASITE($P(DGPMP,"^",1),VAMEDCTR)
"RTN","VAFHAPV1",251,0)
 . S VAFACSUF=$P(VAFACSUF,"^",3)
"RTN","VAFHAPV1",252,0)
 . ; move data into the PV1 segment
"RTN","VAFHAPV1",253,0)
 . S $P(RESULT,HLFS,40)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHAPV1",254,0)
 ;
"RTN","VAFHAPV1",255,0)
 ;Discharge Disposition
"RTN","VAFHAPV1",256,0)
 ;
"RTN","VAFHAPV1",257,0)
 I VAFSTR[",36," D  ;If Discharge Disposition requested
"RTN","VAFHAPV1",258,0)
 . N DGDTYP
"RTN","VAFHAPV1",259,0)
 . S DGDTYP=$P($G(DGPMP),"^",18) ;Discharge type pointer in movement file
"RTN","VAFHAPV1",260,0)
 . S $P(RESULT,HLFS,37)=DGDTYP ;store in variable
"RTN","VAFHAPV1",261,0)
 ;
"RTN","VAFHAPV1",262,0)
 ;--Admission Date
"RTN","VAFHAPV1",263,0)
 ;
"RTN","VAFHAPV1",264,0)
 I (VAFSTR["44") D
"RTN","VAFHAPV1",265,0)
 . I $P(DGPMP,"^",1)="" S $P(RESULT,HLFS,45)=HLQ
"RTN","VAFHAPV1",266,0)
 . E  S $P(RESULT,HLFS,45)=$$HLDATE^HLFNC($P(DGPMP,"^",1),"TS")
"RTN","VAFHAPV1",267,0)
 ;
"RTN","VAFHAPV1",268,0)
 Q:$$TEST(8,RESULT,HLFS,VAFCOMP) RESULT
"RTN","VAFHAPV1",269,0)
 Q RESULT
"RTN","VAFHAPV1",270,0)
TEST(COUNTER,STRING,FIELDSEP,COMPNENT) ;
"RTN","VAFHAPV1",271,0)
 N CHAR,LENGTH
"RTN","VAFHAPV1",272,0)
 S LENGTH=$L(STRING)
"RTN","VAFHAPV1",273,0)
NEXT ;
"RTN","VAFHAPV1",274,0)
 I COUNTER>LENGTH Q 0
"RTN","VAFHAPV1",275,0)
 S CHAR=$E(STRING,COUNTER,COUNTER)
"RTN","VAFHAPV1",276,0)
 I $G(CHAR)=FIELDSEP!($G(CHAR)=COMPNENT) S COUNTER=COUNTER+1 G NEXT
"RTN","VAFHAPV1",277,0)
 Q 1
"RTN","VAFHCPV")
0^7^B33692306
"RTN","VAFHCPV",1,0)
VAFHCPV ;ALB/CM OUTPATIENT PV1 SEGMENT ; 22 Jan 2002 10:28 AM
"RTN","VAFHCPV",2,0)
 ;;5.3;Registration;**91,151,298,494**;Aug 13, 1993
"RTN","VAFHCPV",3,0)
 ;
"RTN","VAFHCPV",4,0)
 ;This routine generates the Outpatient PV1 segment
"RTN","VAFHCPV",5,0)
 ;for the Philly project
"RTN","VAFHCPV",6,0)
 ;
"RTN","VAFHCPV",7,0)
 ;07/12/00 ACS - Added Facility and Suffix to sequence 39
"RTN","VAFHCPV",8,0)
 ;
"RTN","VAFHCPV",9,0)
OPV1(DFN,EVENT,EVDT,VPTR,PSTR,PNUM) ;
"RTN","VAFHCPV",10,0)
 ;
"RTN","VAFHCPV",11,0)
 ;B
"RTN","VAFHCPV",12,0)
 ;DFN - Patient File
"RTN","VAFHCPV",13,0)
 ;EVENT - event number from pivot file
"RTN","VAFHCPV",14,0)
 ;EVDT - event date/time in FileMan format
"RTN","VAFHCPV",15,0)
 ;VPTR - variable pointer
"RTN","VAFHCPV",16,0)
 ;PSTSR - string of fields (if null - required fields, if "A" - supported
"RTN","VAFHCPV",17,0)
 ;fields, or string of fields separated by commas")
"RTN","VAFHCPV",18,0)
 ;PNUM - ID # - always 1 (optional)
"RTN","VAFHCPV",19,0)
 ;
"RTN","VAFHCPV",20,0)
 N RESULT
"RTN","VAFHCPV",21,0)
 S RESULT="PV1"_HLFS_HLFS_"O"
"RTN","VAFHCPV",22,0)
 I '$D(DFN)!('$D(EVENT))!('$D(EVDT))!('$D(VPTR)) Q RESULT
"RTN","VAFHCPV",23,0)
 I $D(EVENT) I EVENT'="" S NODE=$$PIVX^VAFHPIVT(EVENT,DFN,EVDT)
"RTN","VAFHCPV",24,0)
 I $D(EVENT) I EVENT="" K EVENT
"RTN","VAFHCPV",25,0)
 I '$D(EVENT) S NODE=$$PIVNW^VAFHPIVT(DFN,EVDT,2,VPTR),EVENT=$P(NODE,":")
"RTN","VAFHCPV",26,0)
 I EVENT<1 Q RESULT
"RTN","VAFHCPV",27,0)
 S NODE=$P(NODE,":",2)
"RTN","VAFHCPV",28,0)
 I NODE="" S REMOVED="Y"
"RTN","VAFHCPV",29,0)
 ;
"RTN","VAFHCPV",30,0)
EN ;
"RTN","VAFHCPV",31,0)
 N PV1,EVTY,LOC,LOOP,HLD,PIVOT,QUOT
"RTN","VAFHCPV",32,0)
 S QUOT=""""""
"RTN","VAFHCPV",33,0)
 I '$D(PNUM) S PNUM=1
"RTN","VAFHCPV",34,0)
 I $G(PSTR)="A" S PSTR=",2,3,7,10,44,45,50,"
"RTN","VAFHCPV",35,0)
 I $G(PSTR)'="" S PSTR=","_PSTR_","
"RTN","VAFHCPV",36,0)
 I $G(PSTR)="" S PSTR=""
"RTN","VAFHCPV",37,0)
 I +PSTR=-1 Q RESULT
"RTN","VAFHCPV",38,0)
 I $D(REMOVED) S $P(PV1,HLFS,50)=+EVENT,$P(PV1,HLFS,2)="O",$P(PV1,HLFS,1)=PNUM,PV1="PV1"_HLFS_PV1 K REMOVED Q PV1
"RTN","VAFHCPV",39,0)
 S (PIVOT,PV1)="",EVTY="O",LOOP=0
"RTN","VAFHCPV",40,0)
 ; Empty PV1 segment:
"RTN","VAFHCPV",41,0)
 S $P(PV1,HLFS,2)="O"
"RTN","VAFHCPV",42,0)
 ;
"RTN","VAFHCPV",43,0)
 ;F  S LOOP=LOOP+1,HLD=$P(PSTR,",",LOOP) Q:HLD=""  D
"RTN","VAFHCPV",44,0)
 ;.I HLD=2 S $P(PV1,HLFS,2)=EVTY Q
"RTN","VAFHCPV",45,0)
 ;.I HLD=3 S $P(PV1,HLFS,3)=$$CLINIC(NODE) Q
"RTN","VAFHCPV",46,0)
 ;.I HLD=7 S $P(PV1,HLFS,7)=$$OUTPRO(NODE) Q
"RTN","VAFHCPV",47,0)
 ;.;patient type for v2.3
"RTN","VAFHCPV",48,0)
 ;.I HLD=18 DO  Q
"RTN","VAFHCPV",49,0)
 ;. .I +$G(^DPT(DFN,"TYPE")) DO
"RTN","VAFHCPV",50,0)
 ;. . .S $P(RESULT,HLFS,18)=$P($G(^DG(391,+^("TYPE"),0)),"^",1)
"RTN","VAFHCPV",51,0)
 ;. .E  S $P(RESULT,HLFS,18)=HLQ
"RTN","VAFHCPV",52,0)
 ;.I HLD=44 S $P(PV1,HLFS,44)=$$HLDATE^HLFNC(EVDT) Q
"RTN","VAFHCPV",53,0)
 ;.I HLD=50 S $P(PV1,HLFS,50)=EVENT Q
"RTN","VAFHCPV",54,0)
 ;
"RTN","VAFHCPV",55,0)
 I PSTR[",3," S $P(PV1,HLFS,3)=$$CLINIC(NODE)
"RTN","VAFHCPV",56,0)
 I PSTR[",7," S $P(PV1,HLFS,7)=$$OUTPRO(NODE)
"RTN","VAFHCPV",57,0)
 ;.;patient type for v2.3
"RTN","VAFHCPV",58,0)
 I PSTR[18 DO
"RTN","VAFHCPV",59,0)
 .I +$G(^DPT(DFN,"TYPE")) DO
"RTN","VAFHCPV",60,0)
 . .S $P(PV1,HLFS,18)=$P($G(^DG(391,+^("TYPE"),0)),"^",1)
"RTN","VAFHCPV",61,0)
 . .E  S $P(PV1,HLFS,18)=HLQ
"RTN","VAFHCPV",62,0)
 ;
"RTN","VAFHCPV",63,0)
 ; facility and suffix
"RTN","VAFHCPV",64,0)
 ;
"RTN","VAFHCPV",65,0)
 I PSTR[39  D
"RTN","VAFHCPV",66,0)
 . N VAFACSUF,VAMEDCTR,GLOB
"RTN","VAFHCPV",67,0)
 . S GLOB="^"_$P(VPTR,";",2)_+VPTR
"RTN","VAFHCPV",68,0)
 . ;
"RTN","VAFHCPV",69,0)
 . ; If variable pointer is for patient file:
"RTN","VAFHCPV",70,0)
 . I GLOB["DPT(" D
"RTN","VAFHCPV",71,0)
 . . N PATNODE S PATNODE=""
"RTN","VAFHCPV",72,0)
 . . I '$D(^DPT(DFN)) Q
"RTN","VAFHCPV",73,0)
 . . F  S PATNODE=$O(^DPT(DFN,"DIS",PATNODE)) D  Q:PATNODE=""
"RTN","VAFHCPV",74,0)
 . . . N PATDATA,VAFILE
"RTN","VAFHCPV",75,0)
 . . . Q:PATNODE=""
"RTN","VAFHCPV",76,0)
 . . . S PATDATA=$G(^DPT(DFN,"DIS",PATNODE,0))
"RTN","VAFHCPV",77,0)
 . . . ; Spin through multiple events and get division pointer
"RTN","VAFHCPV",78,0)
 . . . I EVDT=$P(PATDATA,"^",1) D  Q:VAFILE="MATCH"
"RTN","VAFHCPV",79,0)
 . . . . S VAMEDCTR=$P(PATDATA,"^",4) Q:VAMEDCTR=""
"RTN","VAFHCPV",80,0)
 . . . . ; get facility/suffix from medical center div file
"RTN","VAFHCPV",81,0)
 . . . . S VAFACSUF=$P($G(^DG(40.8,VAMEDCTR,0)),"^",2)
"RTN","VAFHCPV",82,0)
 . . . . ; move data into the PV1 segment
"RTN","VAFHCPV",83,0)
 . . . . S $P(PV1,HLFS,39)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHCPV",84,0)
 . . . . S VAFILE="MATCH",PATNODE=""
"RTN","VAFHCPV",85,0)
 . . . . Q
"RTN","VAFHCPV",86,0)
 . . . Q
"RTN","VAFHCPV",87,0)
 . . Q
"RTN","VAFHCPV",88,0)
 . ; If variable pointer is for outpatient encounter file:
"RTN","VAFHCPV",89,0)
 . I GLOB["^SCE(" D
"RTN","VAFHCPV",90,0)
 . . N VAFIEN,ENCDATA,ENCDATE
"RTN","VAFHCPV",91,0)
 . . ; get encounter date and medical center division
"RTN","VAFHCPV",92,0)
 . . S VAFIEN=+VPTR Q:VAFIEN=""
"RTN","VAFHCPV",93,0)
 . . I '$D(^SCE(VAFIEN)) Q
"RTN","VAFHCPV",94,0)
 . . S ENCDATA=$G(^SCE(VAFIEN,0))
"RTN","VAFHCPV",95,0)
 . . S ENCDATE=$P(ENCDATA,"^",1) Q:ENCDATE=""
"RTN","VAFHCPV",96,0)
 . . S VAMEDCTR=$P(ENCDATA,"^",11) Q:VAMEDCTR=""
"RTN","VAFHCPV",97,0)
 . . ; call below returns: inst pointer^inst name^facility w/suffix
"RTN","VAFHCPV",98,0)
 . . S VAFACSUF=$$SITE^VASITE(ENCDATE,VAMEDCTR)
"RTN","VAFHCPV",99,0)
 . . S VAFACSUF=$P(VAFACSUF,"^",3)
"RTN","VAFHCPV",100,0)
 . . ; move data into the PV1 segment
"RTN","VAFHCPV",101,0)
 . . S $P(PV1,HLFS,39)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHCPV",102,0)
 . . Q
"RTN","VAFHCPV",103,0)
 . ;
"RTN","VAFHCPV",104,0)
 . ; If variable pointer is for patient movement file:
"RTN","VAFHCPV",105,0)
 . I GLOB["^DGPM(" D
"RTN","VAFHCPV",106,0)
 . . N VAFIEN,VAFDATE,VAWARD
"RTN","VAFHCPV",107,0)
 . . ; get movement date and medical center division
"RTN","VAFHCPV",108,0)
 . . S VAFIEN=+VPTR Q:VAFIEN=""
"RTN","VAFHCPV",109,0)
 . . I '$D(^DGPM(VAFIEN)) Q
"RTN","VAFHCPV",110,0)
 . . S VAFDATE=$P($G(^DGPM(VAFIEN,0)),"^",1) Q:VAFDATE=""
"RTN","VAFHCPV",111,0)
 . . S VAWARD=$P($G(^DGPM(VAFIEN,0)),"^",6) Q:VAWARD=""
"RTN","VAFHCPV",112,0)
 . . S VAMEDCTR=$P($G(^DIC(42,VAWARD,0)),"^",11) Q:VAMEDCTR=""
"RTN","VAFHCPV",113,0)
 . . ; call below returns: inst pointer^inst name^facility w/suffix
"RTN","VAFHCPV",114,0)
 . . S VAFACSUF=$$SITE^VASITE(VAFDATE,VAMEDCTR)
"RTN","VAFHCPV",115,0)
 . . S VAFACSUF=$P(VAFACSUF,"^",3)
"RTN","VAFHCPV",116,0)
 . . ; move data into the PV1 segment
"RTN","VAFHCPV",117,0)
 . . S $P(PV1,HLFS,39)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHCPV",118,0)
 . . Q
"RTN","VAFHCPV",119,0)
 . Q
"RTN","VAFHCPV",120,0)
 ;
"RTN","VAFHCPV",121,0)
 I PSTR[44 S $P(PV1,HLFS,44)=$$HLDATE^HLFNC(EVDT)
"RTN","VAFHCPV",122,0)
 I PSTR[50 S $P(PV1,HLFS,50)=EVENT
"RTN","VAFHCPV",123,0)
 ;
"RTN","VAFHCPV",124,0)
 I PV1?1"^"."^" Q RESULT
"RTN","VAFHCPV",125,0)
 S $P(PV1,HLFS,1)=PNUM,PV1="PV1"_HLFS_PV1
"RTN","VAFHCPV",126,0)
 K NODE,QUOT
"RTN","VAFHCPV",127,0)
 Q PV1
"RTN","VAFHCPV",128,0)
 ;
"RTN","VAFHCPV",129,0)
CLINIC(ZNODE) ;
"RTN","VAFHCPV",130,0)
 ;Get clinic for appointments and add/edit stop codes
"RTN","VAFHCPV",131,0)
 ;
"RTN","VAFHCPV",132,0)
 N HPTR,HLOC,GLOB,LOC
"RTN","VAFHCPV",133,0)
 ;
"RTN","VAFHCPV",134,0)
 ;HPTR=fifth piece in pivot file - Variable pointer
"RTN","VAFHCPV",135,0)
 ;
"RTN","VAFHCPV",136,0)
 S (HLOC,LOC)="",HPTR=$P(ZNODE,"^",5),GLOB="^"_$P(HPTR,";",2)_+HPTR_")"
"RTN","VAFHCPV",137,0)
 I $E(GLOB,1,5)="^DPT(" D
"RTN","VAFHCPV",138,0)
 .;Patient file, appointment hasn't gotten to outpatient encounter file
"RTN","VAFHCPV",139,0)
 .S HLOC=$P($G(@GLOB@("S",$P(NODE,"^"),0)),"^")
"RTN","VAFHCPV",140,0)
 ;
"RTN","VAFHCPV",141,0)
 I $E(GLOB,1,5)="^SCE(" D
"RTN","VAFHCPV",142,0)
 .N VAENC0
"RTN","VAFHCPV",143,0)
 .;Outpatient Encounter file
"RTN","VAFHCPV",144,0)
 .S HLOC=$$SCE^DGSDU(+$P(GLOB,"^SCE(",2),4,0)
"RTN","VAFHCPV",145,0)
 ;
"RTN","VAFHCPV",146,0)
 I HLOC="" Q QUOT
"RTN","VAFHCPV",147,0)
 ;HLOC is IEN of Hospital Location file
"RTN","VAFHCPV",148,0)
 S LOC=$P($G(^SC(HLOC,0)),"^")
"RTN","VAFHCPV",149,0)
 I LOC="" S LOC=QUOT
"RTN","VAFHCPV",150,0)
 Q LOC
"RTN","VAFHCPV",151,0)
 ;
"RTN","VAFHCPV",152,0)
OUTPRO(ZNODE) ;
"RTN","VAFHCPV",153,0)
 ;
"RTN","VAFHCPV",154,0)
 N OUTPTR,OPRV,OPTR,FILE,PTR
"RTN","VAFHCPV",155,0)
 ;
"RTN","VAFHCPV",156,0)
 ;OUTPTR=fifth piece in pivot file - variable pointer
"RTN","VAFHCPV",157,0)
 ;
"RTN","VAFHCPV",158,0)
 S OUTPTR=$P(ZNODE,"^",5),OPTR=+OUTPTR,FILE=$P(OUTPTR,";",2)
"RTN","VAFHCPV",159,0)
 I OPTR=""!(FILE'="SCE(") Q ""
"RTN","VAFHCPV",160,0)
 ;
"RTN","VAFHCPV",161,0)
 ;get primary provider
"RTN","VAFHCPV",162,0)
 S OPRV=$$GETPRO(OPTR) I OPRV DO  Q OPRV
"RTN","VAFHCPV",163,0)
 . I $P($G(^VA(200,OPRV,0)),"^")]"" DO
"RTN","VAFHCPV",164,0)
 . . N DGNAME S DGNAME("FILE")=200,DGNAME("IENS")=OPRV,DGNAME("FIELD")=.01
"RTN","VAFHCPV",165,0)
 . . S OPRV=OPRV_$E(HLECH)_$$HLNAME^XLFNAME(.DGNAME,"S",$E($G(HLECH)))
"RTN","VAFHCPV",166,0)
 . E  S OPRV=QUOT
"RTN","VAFHCPV",167,0)
 ;
"RTN","VAFHCPV",168,0)
 Q QUOT
"RTN","VAFHCPV",169,0)
 ;
"RTN","VAFHCPV",170,0)
GETPRO(OPTR) ;get first primary provider Returns OPRV or 0
"RTN","VAFHCPV",171,0)
 N VAENC0,VAEPRV,VAP
"RTN","VAFHCPV",172,0)
 S VAENC0=$$SCE^DGSDU(OPTR)
"RTN","VAFHCPV",173,0)
 I OPTR,+VAENC0,$$DATE^SCDXUTL(+VAENC0)
"RTN","VAFHCPV",174,0)
 E  Q 0
"RTN","VAFHCPV",175,0)
 ;
"RTN","VAFHCPV",176,0)
 S OPRV=0
"RTN","VAFHCPV",177,0)
 D GETPRV^SDOE(OPTR,"VAEPRV")
"RTN","VAFHCPV",178,0)
 S VAP=0 F  S VAP=$O(VAEPRV(VAP)) Q:'VAP  I $P(VAEPRV(VAP),"^",4)="P" S OPRV=+VAEPRV(VAP)_"^P" Q
"RTN","VAFHCPV",179,0)
 Q +OPRV
"RTN","VAFHLOBX")
0^8^B13236477
"RTN","VAFHLOBX",1,0)
VAFHLOBX ;ALB/SCK-Create generic OBX segment ; 22 Jan 2002 10:27 AM
"RTN","VAFHLOBX",2,0)
 ;;5.3;Registration;**189,149,494**;Aug 13, 1993
"RTN","VAFHLOBX",3,0)
 ;
"RTN","VAFHLOBX",4,0)
 ; This routine returns the HL7 defined OBX segment
"RTN","VAFHLOBX",5,0)
 ;
"RTN","VAFHLOBX",6,0)
EN(VAFARRY,VAFNUM,VAFSTR) ; Returns OBX segment
"RTN","VAFHLOBX",7,0)
 ;
"RTN","VAFHLOBX",8,0)
 ; Input  -  VAFARRY Array of data fields from calling application for building into OBX segment fields
"RTN","VAFHLOBX",9,0)
 ;           Data to be included is expected to be in the following format:
"RTN","VAFHLOBX",10,0)
 ;              VAFARRY(Field Number) = Field Value
"RTN","VAFHLOBX",11,0)
 ;
"RTN","VAFHLOBX",12,0)
 ;              - Dates to be in internal FM format
"RTN","VAFHLOBX",13,0)
 ;              - Provider name to be in external format 
"RTN","VAFHLOBX",14,0)
 ;           VAFNUM (optional) as sequential number for SET ID (default=1)
"RTN","VAFHLOBX",15,0)
 ;           VAFSTR (Optional) as string of fields requested separated by commas. Build all if not passed in.
"RTN","VAFHLOBX",16,0)
 ;
"RTN","VAFHLOBX",17,0)
 ;   **** Assumes all HL7 variables are defined ****
"RTN","VAFHLOBX",18,0)
 ;
"RTN","VAFHLOBX",19,0)
 ; Output - String of data forming the OBX segment
"RTN","VAFHLOBX",20,0)
 ;
"RTN","VAFHLOBX",21,0)
 N VAFY,X1
"RTN","VAFHLOBX",22,0)
 ;
"RTN","VAFHLOBX",23,0)
 ;; Check initial values, set defaults as needed
"RTN","VAFHLOBX",24,0)
 ;; Quit on empty array
"RTN","VAFHLOBX",25,0)
 I ($O(VAFARRY(""))="") S VAFY=1 G QUIT
"RTN","VAFHLOBX",26,0)
 S VAFNUM=$S($G(VAFNUM):VAFNUM,1:1)
"RTN","VAFHLOBX",27,0)
 I $G(VAFSTR)']"" S VAFSTR="2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17"
"RTN","VAFHLOBX",28,0)
 ;
"RTN","VAFHLOBX",29,0)
 ;; Initialize the output string
"RTN","VAFHLOBX",30,0)
 S $P(VAFY,HLFS,17)="",VAFSTR=","_VAFSTR_","
"RTN","VAFHLOBX",31,0)
 S $P(VAFY,HLFS,1)=VAFNUM ; Required field
"RTN","VAFHLOBX",32,0)
 ;
"RTN","VAFHLOBX",33,0)
 ;;Check required OBX fields
"RTN","VAFHLOBX",34,0)
 I $G(VAFARRY(11))=""!($L($G(VAFARRY(11)))>1) S VAFY=1 G QUIT ; obs result status
"RTN","VAFHLOBX",35,0)
 I $G(VAFARRY(3))="" S VAFY=1 G QUIT ; obs ID
"RTN","VAFHLOBX",36,0)
 I $G(VAFARRY(11))'="X",$G(VAFARRY(2))']"" S VAFY=1 G QUIT ; Value Type
"RTN","VAFHLOBX",37,0)
 ;
"RTN","VAFHLOBX",38,0)
 ;;Build segment fields
"RTN","VAFHLOBX",39,0)
 I VAFSTR[",2," S $P(VAFY,HLFS,2)=$S($G(VAFARRY(2))]"":VAFARRY(2),1:HLQ) ; Value Type
"RTN","VAFHLOBX",40,0)
 I VAFSTR[",3," S $P(VAFY,HLFS,3)=$G(VAFARRY(3)) ; Observation Identifier
"RTN","VAFHLOBX",41,0)
 I VAFSTR[",4," S $P(VAFY,HLFS,4)=$S($G(VAFARRY(4))]"":VAFARRY(4),1:HLQ) ; Observation Sub ID
"RTN","VAFHLOBX",42,0)
 I VAFSTR[",5," S $P(VAFY,HLFS,5)=$S($G(VAFARRY(5))]"":VAFARRY(5),1:HLQ) ; Observation Value
"RTN","VAFHLOBX",43,0)
 I VAFSTR[",6," S $P(VAFY,HLFS,6)=$S($G(VAFARRY(6))]"":VAFARRY(6),1:HLQ) ; Units
"RTN","VAFHLOBX",44,0)
 I VAFSTR[",7," S $P(VAFY,HLFS,7)=$S($G(VAFARRY(7))]"":VAFARRY(7),1:HLQ) ; Reference Range
"RTN","VAFHLOBX",45,0)
 I VAFSTR[",8," S $P(VAFY,HLFS,8)=$S($G(VAFARRY(8))]"":VAFARRY(8),1:HLQ) ; Abnormal flags
"RTN","VAFHLOBX",46,0)
 I VAFSTR[",9," S $P(VAFY,HLFS,9)=$S($G(VAFARRY(9))]"":VAFARRY(9),1:HLQ) ; Probability
"RTN","VAFHLOBX",47,0)
 I VAFSTR[",10," S $P(VAFY,HLFS,10)=$S($G(VAFARRY(10))]"":VAFARRY(10),1:HLQ) ; Nature of Abnormal Test
"RTN","VAFHLOBX",48,0)
 I VAFSTR[",11," S $P(VAFY,HLFS,11)=$G(VAFARRY(11)) ; Observation Result Status
"RTN","VAFHLOBX",49,0)
 I VAFSTR[",12," S X1=$$HLDATE^HLFNC($G(VAFARRY(12))),$P(VAFY,HLFS,12)=$S(X1]"":X1,1:HLQ) ; Date of last OBS Normal Values
"RTN","VAFHLOBX",50,0)
 I VAFSTR[",13," S $P(VAFY,HLFS,13)=$S($G(VAFARRY(13))]"":VAFARRY(13),1:HLQ) ; User Defined Access Checks
"RTN","VAFHLOBX",51,0)
 I VAFSTR[",14," S X1=$$HLDATE^HLFNC($G(VAFARRY(14))),$P(VAFY,HLFS,14)=$S(X1]"":X1,1:HLQ) ; DT of Observation
"RTN","VAFHLOBX",52,0)
 I VAFSTR[",15," S $P(VAFY,HLFS,15)=$S($G(VAFARRY(15))]"":VAFARRY(15),1:HLQ) ; Producer's ID
"RTN","VAFHLOBX",53,0)
 I VAFSTR[",16," D  S $P(VAFY,HLFS,16)=$S(X1]"":X1,1:HLQ)
"RTN","VAFHLOBX",54,0)
 . S DIC="^VA(200,",DIC(0)="MZO",X="`"_$G(VAFARRY(16)) D ^DIC
"RTN","VAFHLOBX",55,0)
 . I VAFARRY(16)]"",Y>0 D
"RTN","VAFHLOBX",56,0)
 .. N DGNAME S DGNAME("FILE")=200,DGNAME("IENS")=VAFARRY(16),DGNAME("FIELD")=.01
"RTN","VAFHLOBX",57,0)
 .. S X1=$$HLNAME^XLFNAME(.DGNAME,"S",$E($G(HLECH))),X1=$G(VAFARRY(16))_$E(HLECH,1)_X1
"RTN","VAFHLOBX",58,0)
 . E  D
"RTN","VAFHLOBX",59,0)
 .. S X1=""
"RTN","VAFHLOBX",60,0)
 ;
"RTN","VAFHLOBX",61,0)
 I VAFSTR[",17," S $P(VAFY,HLFS,17)=$S($G(VAFARRY(17))]"":VAFARRY(17),1:HLQ) ; OBS. Method
"RTN","VAFHLOBX",62,0)
 ;
"RTN","VAFHLOBX",63,0)
 ;
"RTN","VAFHLOBX",64,0)
QUIT Q "OBX"_HLFS_$G(VAFY)
"VER")
8.0^22.0
**END**
**END**
