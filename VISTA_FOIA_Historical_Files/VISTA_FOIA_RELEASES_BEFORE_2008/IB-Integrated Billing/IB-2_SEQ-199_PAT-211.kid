Released IB*2*211 SEQ #199
Extracted from mail message
**KIDS**:IB*2.0*211^

**INSTALL NAME**
IB*2.0*211
"BLD",4661,0)
IB*2.0*211^INTEGRATED BILLING^0^3030606^y
"BLD",4661,1,0)
^^1^1^3030509^
"BLD",4661,1,1,0)
Fixes assorted NOIS calls (10).
"BLD",4661,4,0)
^9.64PA^^
"BLD",4661,"ABPKG")
n
"BLD",4661,"KRN",0)
^9.67PA^8989.52^19
"BLD",4661,"KRN",.4,0)
.4
"BLD",4661,"KRN",.401,0)
.401
"BLD",4661,"KRN",.402,0)
.402
"BLD",4661,"KRN",.403,0)
.403
"BLD",4661,"KRN",.5,0)
.5
"BLD",4661,"KRN",.84,0)
.84
"BLD",4661,"KRN",3.6,0)
3.6
"BLD",4661,"KRN",3.8,0)
3.8
"BLD",4661,"KRN",9.2,0)
9.2
"BLD",4661,"KRN",9.8,0)
9.8
"BLD",4661,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",4661,"KRN",9.8,"NM",1,0)
IBCEXTRP^^0^B21771139
"BLD",4661,"KRN",9.8,"NM",2,0)
IBCERP4^^0^B11778687
"BLD",4661,"KRN",9.8,"NM",3,0)
IBCE837A^^0^B29225601
"BLD",4661,"KRN",9.8,"NM",4,0)
IBCCC2^^0^B52397521
"BLD",4661,"KRN",9.8,"NM",5,0)
IBJTU2^^0^B6821930
"BLD",4661,"KRN",9.8,"NM",6,0)
IBCNSU41^^0^B21366788
"BLD",4661,"KRN",9.8,"NM",7,0)
IBCU3^^0^B23463172
"BLD",4661,"KRN",9.8,"NM",8,0)
IBCNSM3^^0^B13078506
"BLD",4661,"KRN",9.8,"NM",9,0)
IBCNBMN^^0^B7906645
"BLD",4661,"KRN",9.8,"NM",10,0)
IBCERP6^^0^B23760797
"BLD",4661,"KRN",9.8,"NM","B","IBCCC2",4)

"BLD",4661,"KRN",9.8,"NM","B","IBCE837A",3)

"BLD",4661,"KRN",9.8,"NM","B","IBCERP4",2)

"BLD",4661,"KRN",9.8,"NM","B","IBCERP6",10)

"BLD",4661,"KRN",9.8,"NM","B","IBCEXTRP",1)

"BLD",4661,"KRN",9.8,"NM","B","IBCNBMN",9)

"BLD",4661,"KRN",9.8,"NM","B","IBCNSM3",8)

"BLD",4661,"KRN",9.8,"NM","B","IBCNSU41",6)

"BLD",4661,"KRN",9.8,"NM","B","IBCU3",7)

"BLD",4661,"KRN",9.8,"NM","B","IBJTU2",5)

"BLD",4661,"KRN",19,0)
19
"BLD",4661,"KRN",19.1,0)
19.1
"BLD",4661,"KRN",101,0)
101
"BLD",4661,"KRN",409.61,0)
409.61
"BLD",4661,"KRN",771,0)
771
"BLD",4661,"KRN",870,0)
870
"BLD",4661,"KRN",8989.51,0)
8989.51
"BLD",4661,"KRN",8989.52,0)
8989.52
"BLD",4661,"KRN",8994,0)
8994
"BLD",4661,"KRN","B",.4,.4)

"BLD",4661,"KRN","B",.401,.401)

"BLD",4661,"KRN","B",.402,.402)

"BLD",4661,"KRN","B",.403,.403)

"BLD",4661,"KRN","B",.5,.5)

"BLD",4661,"KRN","B",.84,.84)

"BLD",4661,"KRN","B",3.6,3.6)

"BLD",4661,"KRN","B",3.8,3.8)

"BLD",4661,"KRN","B",9.2,9.2)

"BLD",4661,"KRN","B",9.8,9.8)

"BLD",4661,"KRN","B",19,19)

"BLD",4661,"KRN","B",19.1,19.1)

"BLD",4661,"KRN","B",101,101)

"BLD",4661,"KRN","B",409.61,409.61)

"BLD",4661,"KRN","B",771,771)

"BLD",4661,"KRN","B",870,870)

"BLD",4661,"KRN","B",8989.51,8989.51)

"BLD",4661,"KRN","B",8989.52,8989.52)

"BLD",4661,"KRN","B",8994,8994)

"BLD",4661,"QUES",0)
^9.62^^
"BLD",4661,"REQB",0)
^9.611^10^10
"BLD",4661,"REQB",1,0)
IB*2.0*52^1
"BLD",4661,"REQB",2,0)
IB*2.0*85^1
"BLD",4661,"REQB",3,0)
IB*2.0*106^1
"BLD",4661,"REQB",4,0)
IB*2.0*137^1
"BLD",4661,"REQB",5,0)
IB*2.0*161^1
"BLD",4661,"REQB",6,0)
IB*2.0*191^1
"BLD",4661,"REQB",7,0)
IB*2.0*197^1
"BLD",4661,"REQB",8,0)
IB*2.0*82^1
"BLD",4661,"REQB",9,0)
IB*2.0*182^1
"BLD",4661,"REQB",10,0)
IB*2.0*199^1
"BLD",4661,"REQB","B","IB*2.0*106",3)

"BLD",4661,"REQB","B","IB*2.0*137",4)

"BLD",4661,"REQB","B","IB*2.0*161",5)

"BLD",4661,"REQB","B","IB*2.0*182",9)

"BLD",4661,"REQB","B","IB*2.0*191",6)

"BLD",4661,"REQB","B","IB*2.0*197",7)

"BLD",4661,"REQB","B","IB*2.0*199",10)

"BLD",4661,"REQB","B","IB*2.0*52",1)

"BLD",4661,"REQB","B","IB*2.0*82",8)

"BLD",4661,"REQB","B","IB*2.0*85",2)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
211^3030606^100850
"PKG",200,22,1,"PAH",1,1,0)
^^1^1^3030606
"PKG",200,22,1,"PAH",1,1,1,0)
Fixes assorted NOIS calls (10).
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","IBCCC2")
0^4^B52397521
"RTN","IBCCC2",1,0)
IBCCC2 ;ALB/AAS - CANCEL AND CLONE A BILL - CONTINUED ; 6/6/03 9:56am
"RTN","IBCCC2",2,0)
 ;;2.0;INTEGRATED BILLING;**80,106,124,138,51,151,137,161,182,211**;21-MAR-94
"RTN","IBCCC2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCCC2",4,0)
 ;
"RTN","IBCCC2",5,0)
 ;MAP TO DGCRCC2
"RTN","IBCCC2",6,0)
 ;
"RTN","IBCCC2",7,0)
 ;STEP 5 - get remainder of data to move and store in MCCR then x-ref
"RTN","IBCCC2",8,0)
 ;STEP 6 - go to screens, come out to IBB1 or something like that
"RTN","IBCCC2",9,0)
 ;
"RTN","IBCCC2",10,0)
STEP5 S IBIFN1=$P(^DGCR(399,IBIFN,0),"^",15) G END:$S(IBIFN1="":1,'$D(^DGCR(399,IBIFN1,0)):1,1:0)
"RTN","IBCCC2",11,0)
 ;
"RTN","IBCCC2",12,0)
 ;move pure data nodes
"RTN","IBCCC2",13,0)
 F I="I1","I2","I3","M1" I $D(^DGCR(399,IBIFN1,I)) S ^DGCR(399,IBIFN,I)=^DGCR(399,IBIFN1,I)
"RTN","IBCCC2",14,0)
 ;
"RTN","IBCCC2",15,0)
 ;move top level data node. ;Do not move 'TX' node
"RTN","IBCCC2",16,0)
 F I="U","U1","U2","UF2","UF3","UF31","C","M" I $D(^DGCR(399,IBIFN1,I)) S IBND(I)=^(I) D @I
"RTN","IBCCC2",17,0)
 ;
"RTN","IBCCC2",18,0)
 ;move multiple level data
"RTN","IBCCC2",19,0)
 F I="CC","OC","OP","RC","CP","CV","PRV" I $D(^DGCR(399,IBIFN1,I,0)) D @I
"RTN","IBCCC2",20,0)
 ;
"RTN","IBCCC2",21,0)
 D FTPRV^IBCEU5(IBIFN) ; Ask change prov type if form type not the same
"RTN","IBCCC2",22,0)
 D COBCHG(IBIFN,,.IBCOB)
"RTN","IBCCC2",23,0)
 ;
"RTN","IBCCC2",24,0)
 D ^IBCCC3 ; copy table files (362.3)
"RTN","IBCCC2",25,0)
 ;
"RTN","IBCCC2",26,0)
 S I=$G(^DGCR(399,IBIFN1,0)) I $P(I,U,13)=7,$P(I,U,20)=1 D COPYB^IBCDC(IBIFN1,IBIFN) ; update auto bill files
"RTN","IBCCC2",27,0)
 D PRIOR(IBIFN) ; add new bill to previous bills in series, primary/secondary
"RTN","IBCCC2",28,0)
 I +$G(IBCTCOPY) N IBAUTO S IBAUTO=1 D BILL^IBCRBC(IBIFN),CPTMOD26^IBCU73(IBIFN) D RECALL^DILFD(399,IBIFN_",",DUZ) G END
"RTN","IBCCC2",29,0)
 ;
"RTN","IBCCC2",30,0)
STEP6 N IBGOEND
"RTN","IBCCC2",31,0)
 I '$G(IBCE("EDI"))!$G(IBCE("EDI","NEW")),'$G(IBCEAUTO) D IBSCEDT G END:$G(IBGOEND)
"RTN","IBCCC2",32,0)
 ;
"RTN","IBCCC2",33,0)
 ;
"RTN","IBCCC2",34,0)
END K DFN,IB,IBA,IBA2,IBAD,IBADD1,IBBNO,IBCAN,IBCCC,IBDA,IBDPT,IBDR,IBDT,IBI,IBI1,IBIDS,IBIFN,IBIFN1,IBND,IBQUIT,IBU,IBUN,IBARST,IBCOB,IBCNCOPY,IBCBCOPY
"RTN","IBCCC2",35,0)
 K IBV,IBV1,IBW,IBWW,IBYN,IBZZ,PRCASV,PRCAERCD,PRCAERR,PRCASVC,PRCAT,IBBT,IBCH,IBNDS,IBOA,IBREV,IBX,DGXRF1,VAEL,VAERR,IBAC,IBCCC,IBDD1,IBIN,DGREV,DGREV00,DGREVHDR,IBCHK
"RTN","IBCCC2",36,0)
 K IBBS,IBLS,DGPCM,IBIP,IBND0,IBNDU,IBO,IBPTF,IBST,IBUC,IBDD,D,%,%DT,DIC,VA,VADM,X,X1,X2,X3,X4,Y,I,J,K,DGRVRCAL,DDH,DGACTDT,DGAMNT,DGBR,DGBRN,DGBSI,DGBSLOS,IBA1,IBOD,IBINS,IBN,IBPROC,DGFUNC,DGIFN
"RTN","IBCCC2",37,0)
 Q
"RTN","IBCCC2",38,0)
 ;
"RTN","IBCCC2",39,0)
 ;
"RTN","IBCCC2",40,0)
IBSCEDT ; call the IB bill edit screens and validate the data
"RTN","IBCCC2",41,0)
 N IBV,IBPAR,IBAC,IBHV,IBH,IBCIREDT
"RTN","IBCCC2",42,0)
 D RECALL^DILFD(399,IBIFN_",",DUZ)
"RTN","IBCCC2",43,0)
ST1 S IBV=0 D ^IBCSCU,^IBCSC1 I $G(IBPOPOUT) S IBGOEND=1 G IBSCX
"RTN","IBCCC2",44,0)
 S IBAC=1
"RTN","IBCCC2",45,0)
 D ^IBCB1
"RTN","IBCCC2",46,0)
 I $G(IBCIREDT) G ST1
"RTN","IBCCC2",47,0)
IBSCX ;
"RTN","IBCCC2",48,0)
 Q
"RTN","IBCCC2",49,0)
 ;
"RTN","IBCCC2",50,0)
 ;
"RTN","IBCCC2",51,0)
U F J=3,4,6:1:17,20 I $P(IBND("U"),"^",J)]"" S $P(^DGCR(399,IBIFN,"U"),"^",J)=$P(IBND("U"),"^",J)
"RTN","IBCCC2",52,0)
 Q
"RTN","IBCCC2",53,0)
U1 F J=1:1:9,13,14 I $P(IBND("U1"),"^",J)]"" S $P(^DGCR(399,IBIFN,"U1"),"^",J)=$P(IBND("U1"),"^",J)
"RTN","IBCCC2",54,0)
 Q
"RTN","IBCCC2",55,0)
U2 F J=1:1:19 I $P(IBND("U2"),"^",J)]"" S $P(^DGCR(399,IBIFN,"U2"),"^",J)=$P(IBND("U2"),"^",J)
"RTN","IBCCC2",56,0)
 Q
"RTN","IBCCC2",57,0)
UF2 F J=1 I $P(IBND("UF2"),"^",J)]"" S $P(^DGCR(399,IBIFN,"UF2"),"^",J)=$P(IBND("UF2"),"^",J)
"RTN","IBCCC2",58,0)
 Q
"RTN","IBCCC2",59,0)
UF3 F J=1:1:7 I $P(IBND("UF3"),"^",J)]"" S $P(^DGCR(399,IBIFN,"UF3"),"^",J)=$P(IBND("UF3"),"^",J)
"RTN","IBCCC2",60,0)
 Q
"RTN","IBCCC2",61,0)
UF31 F J=1:1:3 I $P(IBND("UF31"),"^",J)]"" S $P(^DGCR(399,IBIFN,"UF31"),"^",J)=$P(IBND("UF31"),"^",J)
"RTN","IBCCC2",62,0)
 Q
"RTN","IBCCC2",63,0)
C F J=10 I $P(IBND("C"),"^",J)]"" S $P(^DGCR(399,IBIFN,"C"),"^",J)=$P(IBND("C"),"^",J)
"RTN","IBCCC2",64,0)
 I '$D(^DGCR(399,IBIFN1,"CP")) D CP1
"RTN","IBCCC2",65,0)
 Q
"RTN","IBCCC2",66,0)
M F J=1:1:14 I $P(IBND("M"),"^",J)]"" S $P(^DGCR(399,IBIFN,"M"),"^",J)=$P(IBND("M"),"^",J)
"RTN","IBCCC2",67,0)
 Q
"RTN","IBCCC2",68,0)
CC S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",69,0)
 S IBDD=399.04 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) S ^DGCR(399,IBIFN,I,J,0)=^DGCR(399,IBIFN1,I,J,0),X=$P(^(0),"^")
"RTN","IBCCC2",70,0)
OP S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",71,0)
 S IBDD=399.043 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) S ^DGCR(399,IBIFN,I,J,0)=^DGCR(399,IBIFN1,I,J,0),X=$P(^(0),"^")
"RTN","IBCCC2",72,0)
 Q
"RTN","IBCCC2",73,0)
OC S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",74,0)
 S IBDD=399.041 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) S ^DGCR(399,IBIFN,I,J,0)=^DGCR(399,IBIFN1,I,J,0),X=$P(^(0),"^")
"RTN","IBCCC2",75,0)
 Q
"RTN","IBCCC2",76,0)
CV ; Don't copy value codes from inpatient inst to inpatient prof bills
"RTN","IBCCC2",77,0)
 I $$FT^IBCEF(IBIFN1)'=2,$$FT^IBCEF(IBIFN)=2 Q
"RTN","IBCCC2",78,0)
 S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",79,0)
 S IBDD=399.047 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) S ^DGCR(399,IBIFN,I,J,0)=^DGCR(399,IBIFN1,I,J,0),X=$P(^(0),"^")
"RTN","IBCCC2",80,0)
 Q
"RTN","IBCCC2",81,0)
RC S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",82,0)
 S IBDD=399.042 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) S IBND("RC")=^(0) F K=1:1:15 S $P(^DGCR(399,IBIFN,I,J,0),"^",K)=$P(IBND("RC"),"^",K),X=$P(IBND("RC"),"^",K)
"RTN","IBCCC2",83,0)
 Q
"RTN","IBCCC2",84,0)
CP S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",85,0)
 I +$G(IBNOCPT) Q
"RTN","IBCCC2",86,0)
 S IBDD=399.0304 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) S IBND("CP")=^(0),IBND("CP-AUX")=$G(^("AUX")) D
"RTN","IBCCC2",87,0)
 . F K=1:1:7,9:1:13,15:1:20 S $P(^DGCR(399,IBIFN,I,J,0),"^",K)=$P(IBND("CP"),"^",K)
"RTN","IBCCC2",88,0)
 . I IBND("CP-AUX")'="" F K=1:1:8 S $P(^DGCR(399,IBIFN,I,J,"AUX"),"^",K)=$P(IBND("CP-AUX"),"^",K)
"RTN","IBCCC2",89,0)
 . I $D(^DGCR(399,IBIFN1,I,J,"MOD",0)) S ^DGCR(399,IBIFN,I,J,"MOD",0)=^DGCR(399,IBIFN1,I,J,"MOD",0) D
"RTN","IBCCC2",90,0)
 .. S K=0 F  S K=$O(^DGCR(399,IBIFN1,I,J,"MOD",K)) Q:'K  D
"RTN","IBCCC2",91,0)
 ... I $G(IBNOTC),$P($$MOD^ICPTMOD(+$P($G(^DGCR(399,IBIFN1,I,J,"MOD",K,0)),U,2),"I"),U,2)="TC" Q  ; Don't copy TC modifier from inst to prof bill
"RTN","IBCCC2",92,0)
 ... S ^DGCR(399,IBIFN,I,J,"MOD",K,0)=^DGCR(399,IBIFN1,I,J,"MOD",K,0)
"RTN","IBCCC2",93,0)
CP1 S IBCOD=$P($G(^DGCR(399,IBIFN,0)),"^",9) Q:IBCOD=""!('$D(^DGCR(399,IBIFN1,"C")))
"RTN","IBCCC2",94,0)
 I IBCOD=9 F DGI=4,5,6 I $P(^DGCR(399,IBIFN1,"C"),"^",DGI) S X=$P(^("C"),"^",DGI)_";ICD0(",DGPROCDT=$P(^("C"),"^",DGI+7) D FILE
"RTN","IBCCC2",95,0)
 I IBCOD=4 F DGI=1,2,3 I $P(^DGCR(399,IBIFN1,"C"),"^",DGI) S X=$P(^("C"),"^",DGI)_";ICPT(",DGPROCDT=$P(^("C"),"^",DGI+10) D FILE
"RTN","IBCCC2",96,0)
 I IBCOD=5 F DGI=7,8,9 I $P(^DGCR(399,IBIFN1,"C"),"^",DGI) S X=$P(^("C"),"^",DGI)_";ICPT(",DGPROCDT=$P(^("C"),"^",DGI+4) D FILE
"RTN","IBCCC2",97,0)
 Q
"RTN","IBCCC2",98,0)
 ;
"RTN","IBCCC2",99,0)
PRV S ^DGCR(399,IBIFN,I,0)=^DGCR(399,IBIFN1,I,0)
"RTN","IBCCC2",100,0)
 N Z,Z0
"RTN","IBCCC2",101,0)
 S Z=$P($G(^DGCR(399,IBIFN,0)),U,19),Z0=$P($G(^DGCR(399,IBIFN1,0)),U,19)
"RTN","IBCCC2",102,0)
 S IBDD=399.0222 F J=0:0 S J=$O(^DGCR(399,IBIFN1,I,J)) Q:'J  I $D(^(J,0)) D
"RTN","IBCCC2",103,0)
 . S ^DGCR(399,IBIFN,I,J,0)=^DGCR(399,IBIFN1,I,J,0),X=$P(^(0),"^")
"RTN","IBCCC2",104,0)
 . I Z'=Z0,$S(X=3:Z0=3,X=4:Z0=2,1:0) S $P(^DGCR(399,IBIFN,I,J,0),U)=(Z0+1)
"RTN","IBCCC2",105,0)
 Q
"RTN","IBCCC2",106,0)
 ;
"RTN","IBCCC2",107,0)
COB S J=0 F  S J=$O(IBCOB(I,J)) Q:'J  S $P(^DGCR(399,IBIFN,I),U,J)=IBCOB(I,J)
"RTN","IBCCC2",108,0)
 Q
"RTN","IBCCC2",109,0)
 ;
"RTN","IBCCC2",110,0)
FILE N DIC,DIE,DR,DA,X,Y,DLAYGO,DD,DO
"RTN","IBCCC2",111,0)
 I '$D(^DGCR(399,IBIFN,"CP",0)) S DIC("P")=$$GETSPEC^IBEFUNC(399,304)
"RTN","IBCCC2",112,0)
 S DIC(0)="L",DLAYGO=399,DA(1)=IBIFN,DIC="^DGCR(399,"_DA(1)_",""CP""," Q:X=""  D FILE^DICN K DO,DD Q:+Y<1  S DA=+Y
"RTN","IBCCC2",113,0)
 S DIE="^DGCR(399,"_DA(1)_",""CP"",",DR="1///"_DGPROCDT D ^DIE
"RTN","IBCCC2",114,0)
 K DGPROCDT
"RTN","IBCCC2",115,0)
 Q
"RTN","IBCCC2",116,0)
 ;
"RTN","IBCCC2",117,0)
INDEX ;index entire file (set logic)
"RTN","IBCCC2",118,0)
 S DIK="^DGCR(399,",DA=IBIFN D IX1^DIK K DA,DIK
"RTN","IBCCC2",119,0)
 Q
"RTN","IBCCC2",120,0)
 ;
"RTN","IBCCC2",121,0)
PRIOR(IBIFN) ; set Secondary/Tertiary Bill #s on prior bills, if the bill is cancelled remove it from prior bills
"RTN","IBCCC2",122,0)
 N IBSEQ,IBSEQN,IBM1,I,IBIFN1
"RTN","IBCCC2",123,0)
 S IBSEQ=$$COB^IBCEF(IBIFN)
"RTN","IBCCC2",124,0)
 S IBSEQN=$S(IBSEQ="S":6,IBSEQ="T":7,1:"") Q:'IBSEQN
"RTN","IBCCC2",125,0)
 ;
"RTN","IBCCC2",126,0)
 S IBM1=$G(^DGCR(399,IBIFN,"M1")) I +$P(^DGCR(399,IBIFN,0),U,13)=7 S IBIFN=""
"RTN","IBCCC2",127,0)
 F I=5,6 I I<IBSEQN  S IBIFN1=+$P(IBM1,U,I) I +IBIFN1,$D(^DGCR(399,+IBIFN1,0)) S $P(^DGCR(399,IBIFN1,"M1"),U,IBSEQN)=IBIFN
"RTN","IBCCC2",128,0)
 Q
"RTN","IBCCC2",129,0)
 ;
"RTN","IBCCC2",130,0)
COBCHG(IBIFN,IBINS,IBCOB) ; Make changes for a new COB payer for bill
"RTN","IBCCC2",131,0)
 ; IBIFN = ien of bill in file 399
"RTN","IBCCC2",132,0)
 ; IBINS = ien of bill's current insurance (optional)
"RTN","IBCCC2",133,0)
 ; IBCOB = array subscripted by node,piece of COB data field change
"RTN","IBCCC2",134,0)
 ;
"RTN","IBCCC2",135,0)
 N I,IBFRMTYP
"RTN","IBCCC2",136,0)
 ; Subtract the Prior Payments from the bill's Offset (these are re-added by triggers)
"RTN","IBCCC2",137,0)
 F I=4,5,6  S $P(^DGCR(399,IBIFN,"U1"),U,2)=$P($G(^DGCR(399,IBIFN,"U1")),U,2)-$P($G(^DGCR(399,IBIFN,"U2")),U,I)
"RTN","IBCCC2",138,0)
 ;
"RTN","IBCCC2",139,0)
 I $G(IBINS),$$MCRWNR^IBEFUNC(IBINS) D
"RTN","IBCCC2",140,0)
 . ;MCRWNR is current insurance ... move payer only
"RTN","IBCCC2",141,0)
 . N IBCOBN,IBX
"RTN","IBCCC2",142,0)
 . S IBCOBN=$$COBN^IBCEF(IBIFN)
"RTN","IBCCC2",143,0)
 . S IBCOB(0,15)=""
"RTN","IBCCC2",144,0)
 . S IBCOB(0,21)=$P("S^T^",U,IBCOBN)
"RTN","IBCCC2",145,0)
 . S IBCOB("M1",IBCOBN+4)=IBIFN
"RTN","IBCCC2",146,0)
 . S IBCOB("TX",1)="",IBCOB("TX",2)="",IBCOB("TX",6)=""
"RTN","IBCCC2",147,0)
 . S IBX=$$REQMRA^IBEFUNC(IBIFN)
"RTN","IBCCC2",148,0)
 . I IBX=0 S IBCOB("TX",5)=0
"RTN","IBCCC2",149,0)
 . I IBX["R" S IBCOB("TX",5)="A"
"RTN","IBCCC2",150,0)
 . I IBX=1 D
"RTN","IBCCC2",151,0)
 .. N Z,Z0,IBOK
"RTN","IBCCC2",152,0)
 .. S (IBOK,Z)=0
"RTN","IBCCC2",153,0)
 .. F  S Z=$O(^IBM(361.1,"ABS",IBIFN,IBCOBN,Z)) Q:'Z  D  Q:IBOK
"RTN","IBCCC2",154,0)
 ... S Z0=$G(^IBM(361.1,Z,0))
"RTN","IBCCC2",155,0)
 ... I "23"[$P(Z0,U,16) S IBOK=1
"RTN","IBCCC2",156,0)
 .. I 'IBOK S IBCOB("TX",5)=$E("AC",IBOK+1)
"RTN","IBCCC2",157,0)
 . D PRIOR(IBIFN)
"RTN","IBCCC2",158,0)
 ;
"RTN","IBCCC2",159,0)
 ;reset fields for next Sequence Payer
"RTN","IBCCC2",160,0)
 F I=0,"M1","U2","TX" I $D(IBCOB(I)) D COB
"RTN","IBCCC2",161,0)
 ;
"RTN","IBCCC2",162,0)
 ; IB*2.0*211
"RTN","IBCCC2",163,0)
 ; save off Form Type
"RTN","IBCCC2",164,0)
 S IBFRMTYP=$P($G(^DGCR(399,IBIFN,0)),U,19)
"RTN","IBCCC2",165,0)
 ; fire xrefs set logic
"RTN","IBCCC2",166,0)
 D INDEX
"RTN","IBCCC2",167,0)
 ; don't restore form type if creating HCFA bill 
"RTN","IBCCC2",168,0)
 ; from CTCOPY1^IBCCCB 
"RTN","IBCCC2",169,0)
 I $G(IBCTCOPY)=1 K IBCOB("TX") Q
"RTN","IBCCC2",170,0)
 ; restore Form Type if changed
"RTN","IBCCC2",171,0)
 I IBFRMTYP'=$P($G(^DGCR(399,IBIFN,0)),U,19) N DA,DIE,DR S DA=IBIFN,DIE="^DGCR(399,",DR=".19////"_IBFRMTYP D ^DIE
"RTN","IBCCC2",172,0)
 ;
"RTN","IBCCC2",173,0)
 K IBCOB("TX")
"RTN","IBCCC2",174,0)
 Q
"RTN","IBCCC2",175,0)
 ;
"RTN","IBCE837A")
0^3^B29225601
"RTN","IBCE837A",1,0)
IBCE837A ;ALB/TMP - OUTPUT FOR 837 TRANSMISSION - CONTINUED ; 3/17/03 1:06pm
"RTN","IBCE837A",2,0)
 ;;2.0;INTEGRATED BILLING;**137,191,211**;21-MAR-94
"RTN","IBCE837A",3,0)
 ;
"RTN","IBCE837A",4,0)
UPD(MSGNUM,BATCH,CNT,BILLS,DESC,IBBTYP,IBINS) ; Upd current batch + bills w/new status
"RTN","IBCE837A",5,0)
 ;MSGNUM = mail msg # for batch
"RTN","IBCE837A",6,0)
 ;BATCH = batch #
"RTN","IBCE837A",7,0)
 ;CNT = # of bills in batch
"RTN","IBCE837A",8,0)
 ;BILLS = array BILLS(bill ien in 364) in batch
"RTN","IBCE837A",9,0)
 ;DESC = 1-80 character description of batch
"RTN","IBCE837A",10,0)
 ;IBBTYP = X-Y where X = P for professional or I for institution
"RTN","IBCE837A",11,0)
 ;                   Y = 1 for test or 0 for live transmission
"RTN","IBCE837A",12,0)
 ;IBINS = ien of single insurance company for the batch (optional)
"RTN","IBCE837A",13,0)
 ;
"RTN","IBCE837A",14,0)
 N DIC,DIE,DR,DA,IBBATCH,IBIFN,IBIEN,IBYY,IBTXTEST
"RTN","IBCE837A",15,0)
 S IBBATCH=$O(^IBA(364.1,"B",+BATCH,"")) Q:'IBBATCH
"RTN","IBCE837A",16,0)
 S IBTXTEST=+$P(IBBTYP,"-",2)
"RTN","IBCE837A",17,0)
 I '$P($G(^IBE(350.9,1,8)),U,7) S IBINS=""
"RTN","IBCE837A",18,0)
 ;
"RTN","IBCE837A",19,0)
 S DIE="^IBA(364.1,",DA=IBBATCH,DR=".02////P;.03///"_CNT_";.04///"_MSGNUM_";.05///0;.07////1;.08///^S X="""_DESC_""""_$S($G(IBINS):";.12////"_IBINS,1:"")
"RTN","IBCE837A",20,0)
 ;
"RTN","IBCE837A",21,0)
 I '$P($G(^TMP("IBRESUBMIT",$J)),U,3) S DR=DR_";1.01///NOW;1.02///.5"
"RTN","IBCE837A",22,0)
 I $P($G(^TMP("IBRESUBMIT",$J)),U,2) S DR=DR_";.15////"_$P(^($J),U,2)
"RTN","IBCE837A",23,0)
 ;
"RTN","IBCE837A",24,0)
 S DR=DR_";.14////"_IBTXTEST_";.06////"_$S($E(IBBTYP)="P":2,1:3) D ^DIE ; Update batch
"RTN","IBCE837A",25,0)
 ;
"RTN","IBCE837A",26,0)
 S IBIEN=0 F  S IBIEN=$O(BILLS(IBIEN)) Q:'IBIEN  D  ;Update each bill
"RTN","IBCE837A",27,0)
 .S DA=IBIEN,DIE="^IBA(364,",DR=".02////"_IBBATCH_";.03///P;.04///NOW" D ^DIE
"RTN","IBCE837A",28,0)
 .S IBIFN=+$G(^IBA(364,IBIEN,0))
"RTN","IBCE837A",29,0)
 .Q:$D(^TMP("IBRESUBMIT",$J))!($P($G(^DGCR(399,IBIFN,0)),U,13)=4)!(+$$TXMT^IBCEF4(IBIEN)=2)
"RTN","IBCE837A",30,0)
 .S:'$D(IBMRA) IBMRA=$$NEEDMRA^IBEFUNC(IBIFN)
"RTN","IBCE837A",31,0)
 .I IBIFN D
"RTN","IBCE837A",32,0)
 ..S (DIC,DIE)="^DGCR(399,",DA=$P($G(^IBA(364,IBIEN,0)),U),DR="[IB STATUS]",IBYY=$S('IBMRA:"@91",1:"@911") D:DA ^DIE
"RTN","IBCE837A",33,0)
 ..D BSTAT^IBCDC(IBIFN) ; remove from AB list
"RTN","IBCE837A",34,0)
 Q
"RTN","IBCE837A",35,0)
 ;
"RTN","IBCE837A",36,0)
PRE ; Run before processing a bill entry
"RTN","IBCE837A",37,0)
 K IBXSAVE,IBXERR,^UTILITY("VAPA",$J),^TMP("IBXSAVE",$J),^TMP($J),^TMP("DIERR",$J)
"RTN","IBCE837A",38,0)
 Q
"RTN","IBCE837A",39,0)
 ;
"RTN","IBCE837A",40,0)
POST ; Run after processing a bill entry for cleanup
"RTN","IBCE837A",41,0)
 N Q
"RTN","IBCE837A",42,0)
 I $G(IBXERR)'="" D
"RTN","IBCE837A",43,0)
 .S ^TMP("IBXERR",$J,IBXIEN)=IBXERR K ^TMP("IBXDATA",$J)
"RTN","IBCE837A",44,0)
 .K ^TMP("IBHDR1",$J)
"RTN","IBCE837A",45,0)
 .I $D(^TMP("IBRESUBMIT",$J)) D  ;Set not resub flag for bill
"RTN","IBCE837A",46,0)
 ..N Z,Z0
"RTN","IBCE837A",47,0)
 ..S Z0=$P($G(^TMP("IBRESUBMIT",$J)),U) Q:Z0=""
"RTN","IBCE837A",48,0)
 ..S Z=$O(^IBA(364,"ABABI",+$O(^IBA(364.1,"B",Z0,"")),IBXIEN,""))
"RTN","IBCE837A",49,0)
 ..I Z S ^TMP("IBNOT",$J,Z)=IBXIEN
"RTN","IBCE837A",50,0)
 K IBXSAVE,IBXNOREQ,^TMP("IBXSAVE",$J),^TMP($J)
"RTN","IBCE837A",51,0)
 S Q="VA" F  S Q=$O(^UTILITY(Q)) Q:$E(Q,1,2)'="VA"  I $D(^(Q,$J)) K ^UTILITY(Q,$J)
"RTN","IBCE837A",52,0)
 D CLEAN^DILF
"RTN","IBCE837A",53,0)
 Q
"RTN","IBCE837A",54,0)
 ;
"RTN","IBCE837A",55,0)
MAILIT(IBQUEUE,IBBILL,IBCTM,IBDUZ,IBDESC,IBBTYP,IBINS) ; Send mail msg, update bills
"RTN","IBCE837A",56,0)
 ;IBQUEUE = mail queue name to send 837 transactions to
"RTN","IBCE837A",57,0)
 ;IBBILL = array of ien's in file 364 of bills in batch - IBBILL(IEN)=""
"RTN","IBCE837A",58,0)
 ;IBCTM = # of bills in batch, returned reset to 0
"RTN","IBCE837A",59,0)
 ;IBDUZ = ien of user 'running' extract (if any)
"RTN","IBCE837A",60,0)
 ;IBDESC = description of batch
"RTN","IBCE837A",61,0)
 ;IBBTYP = X-Y where X = P for professional or I for institution
"RTN","IBCE837A",62,0)
 ;                   Y = 1 for test or 0 for live transmission
"RTN","IBCE837A",63,0)
 ;IBINS = ien of insurance company if only one/batch option (optional)
"RTN","IBCE837A",64,0)
 ;
"RTN","IBCE837A",65,0)
 N DIK,DA,XMTO,XMZ,XMBODY,XMDUZ,IBBDA,IBBNO
"RTN","IBCE837A",66,0)
 ;
"RTN","IBCE837A",67,0)
 S IBBNO=+$P($G(^TMP("IBHDR",$J)),U),IBBDA=$O(^IBA(364.1,"B",IBBNO,""))
"RTN","IBCE837A",68,0)
 I '$P($G(^IBE(350.9,1,8)),U,7) S IBINS=""
"RTN","IBCE837A",69,0)
 ;
"RTN","IBCE837A",70,0)
 I IBCTM D
"RTN","IBCE837A",71,0)
 . I IBQUEUE'="",IBQUEUE'["@" S XMTO("XXX@Q-"_IBQUEUE_".VA.GOV")=""
"RTN","IBCE837A",72,0)
 . S XMDUZ=$G(IBDUZ),XMBODY="^TMP(""IBXMSG"","_$J_")",XMSUBJ=$S($P(IBBTYP,U,2):"** TEST ",1:"")_"CLAIM BATCH: "_$S(IBQUEUE'["@":IBQUEUE,1:$P(IBQUEUE,"@"))_"/"_IBBNO
"RTN","IBCE837A",73,0)
 . K XMZ
"RTN","IBCE837A",74,0)
 . D SENDMSG^XMXAPI(XMDUZ,XMSUBJ,XMBODY,.XMTO,,.XMZ)
"RTN","IBCE837A",75,0)
 . I $G(XMZ) D
"RTN","IBCE837A",76,0)
 .. D UPD(XMZ,$P($G(^TMP("IBHDR",$J)),U),IBCTM,.IBBILL,IBDESC,IBBTYP,IBINS) ;Update batch/bills
"RTN","IBCE837A",77,0)
 .. S ^TMP("IBCE-BATCH",$J,IBBNO)=IBBDA_U_IBCTM
"RTN","IBCE837A",78,0)
MAILQ S IBCTM=0
"RTN","IBCE837A",79,0)
 D CHKBTCH(+$G(^TMP("IBHDR",$J)))
"RTN","IBCE837A",80,0)
 K ^TMP("IBHDR",$J),^TMP("IBHDR1",$J),^TMP("IBXMSG",$J),IBBILL
"RTN","IBCE837A",81,0)
 Q
"RTN","IBCE837A",82,0)
 ;
"RTN","IBCE837A",83,0)
CHKNEW(IBQ,IBBILL,IBCTM,IBDESC,IBBTYP,IBINS,IBSITE,IBSIZE) ;
"RTN","IBCE837A",84,0)
 ;  Determine if ok to send msg
"RTN","IBCE837A",85,0)
 ;  Check for one insurance per batch if IBINS defined
"RTN","IBCE837A",86,0)
 ; Returns IBSIZE, IBCTM, IBBILL (pass by reference)
"RTN","IBCE837A",87,0)
 ;
"RTN","IBCE837A",88,0)
 ; IBQ = data queue name
"RTN","IBCE837A",89,0)
 ; IBBILL = the 'list' of bill #'s in the batch
"RTN","IBCE837A",90,0)
 ; IBCTM = the # of claims output so far to the batch
"RTN","IBCE837A",91,0)
 ; IBDESC = the batch description text
"RTN","IBCE837A",92,0)
 ; IBBTYP = X-Y where X = P for professional or I for institution
"RTN","IBCE837A",93,0)
 ;                   Y = 1 for test or 0 for live transmission
"RTN","IBCE837A",94,0)
 ; IBINS = the ien of the single insurance co. for the batch (optional)
"RTN","IBCE837A",95,0)
 ; IBSITE = the '8' node of file 350.9 (IB PARAMETERS)
"RTN","IBCE837A",96,0)
 ; IBSIZE = the 'running' size of the output message
"RTN","IBCE837A",97,0)
 ;
"RTN","IBCE837A",98,0)
 Q:$S($G(IBINS)="":0,1:'$P(IBSITE,U,7))
"RTN","IBCE837A",99,0)
 ;
"RTN","IBCE837A",100,0)
 ; New batch needed
"RTN","IBCE837A",101,0)
 I IBCTM D MAILIT(IBQ,.IBBILL,.IBCTM,"",IBDESC,IBBTYP,IBINS) S IBSIZE=0
"RTN","IBCE837A",102,0)
 Q
"RTN","IBCE837A",103,0)
 ;
"RTN","IBCE837A",104,0)
ERRMSG(XMBODY) ; Send bulletin for error message
"RTN","IBCE837A",105,0)
 N XMTO,XMSUBJ
"RTN","IBCE837A",106,0)
 S XMTO("I:G.IB EDI")="",XMSUBJ="EDI 837 TRANSMISSION ERRORS"
"RTN","IBCE837A",107,0)
 ;
"RTN","IBCE837A",108,0)
 D SENDMSG^XMXAPI(,XMSUBJ,XMBODY,.XMTO)
"RTN","IBCE837A",109,0)
 D ALERT("One or more EDI bills were not transmitted.  Check your mail for details","G.IB EDI")
"RTN","IBCE837A",110,0)
 Q
"RTN","IBCE837A",111,0)
 ;
"RTN","IBCE837A",112,0)
CLEANUP ; Cleans up bill transmission environment
"RTN","IBCE837A",113,0)
 ;
"RTN","IBCE837A",114,0)
 L -^IBA(364,0)
"RTN","IBCE837A",115,0)
 I $D(^TMP("IBRESUBMIT",$J,"IBXERR"))!$D(^TMP("IBONE",$J,"IBXERR"))!$D(^TMP("IBSELX",$J,"IBXERR")) D  ;Error message to mail group
"RTN","IBCE837A",116,0)
 . N XMTO,XMBODY,XMDUZ,XMSUBJ,IBFUNC
"RTN","IBCE837A",117,0)
 . S IBFUNC=$S($D(^TMP("IBRESUBMIT",$J,"IBXERR")):1,$D(^TMP("IBONE",$J,"IBXERR")):2,1:3)
"RTN","IBCE837A",118,0)
 . Q:'IBFUNC
"RTN","IBCE837A",119,0)
 . S XMTO("I:G.IB EDI")="",XMDUZ="",XMBODY="^TMP("""_$S(IBFUNC=1:"IBRESUBMIT",1:"IBONE")_""","_$J_",""IBXERR"")",XMSUBJ="EDI 837 B"_$P("ATCH^ILL^ILL(s)",U,IBFUNC)_" NOT "_$S($G(^TMP("IBONE",$J)):"RE",1:"")_"SUBMITTED"
"RTN","IBCE837A",120,0)
 . D SENDMSG^XMXAPI(XMDUZ,XMSUBJ,XMBODY,.XMTO,,.XMZ)
"RTN","IBCE837A",121,0)
 . K ^TMP("IBRESUBMIT",$J),^TMP("IBONE",$J)
"RTN","IBCE837A",122,0)
 ;
"RTN","IBCE837A",123,0)
 I $D(^TMP("IBRESUBMIT",$J)) D RESUBUP^IBCEM02 ;Upd resubmtd batch bills
"RTN","IBCE837A",124,0)
 I '$D(^TMP("IBSELX",$J)) K ^TMP("IBCE-BATCH",$J)
"RTN","IBCE837A",125,0)
 K ^TMP("IBXERR",$J),IBXERR
"RTN","IBCE837A",126,0)
 D CHKBTCH(+$G(^TMP("IBHDR",$J)))
"RTN","IBCE837A",127,0)
CLEANP ;  Entrypoint for extract data disply
"RTN","IBCE837A",128,0)
 K ^TMP("IBTXMT",$J),^TMP("IBXINS",$J)
"RTN","IBCE837A",129,0)
 K ^TMP("IBRESUBMIT",$J),^TMP("IBRESUB",$J),^TMP("IBNOT",$J),^TMP("IBONE",$J),^TMP("IBHDR",$J),^TMP("IBTX",$J)
"RTN","IBCE837A",130,0)
 K ^UTILITY("VADM",$J)
"RTN","IBCE837A",131,0)
 D CLEAN^DILF
"RTN","IBCE837A",132,0)
 S ZTREQ="@"
"RTN","IBCE837A",133,0)
 Q
"RTN","IBCE837A",134,0)
 ;
"RTN","IBCE837A",135,0)
ALERT(XQAMSG,IBGRP) ; Send alert message
"RTN","IBCE837A",136,0)
 N XQA
"RTN","IBCE837A",137,0)
 S XQA(IBGRP)=""
"RTN","IBCE837A",138,0)
 D SETUP^XQALERT
"RTN","IBCE837A",139,0)
 Q
"RTN","IBCE837A",140,0)
CHKBTCH(IBBNO) ; Delete batch whose batch # is IBBNO if no entries in file 364
"RTN","IBCE837A",141,0)
 ; and not a resubmitted batch
"RTN","IBCE837A",142,0)
 N IBZ
"RTN","IBCE837A",143,0)
 S IBZ=+$O(^IBA(364.1,"B",+IBBNO,""))
"RTN","IBCE837A",144,0)
 I IBZ,'$O(^IBA(364,"C",IBZ,0)),'$P($G(^IBA(364.1,IBZ,0)),U,13) S DA=IBZ,DIK="^IBA(364.1," D ^DIK
"RTN","IBCE837A",145,0)
 Q
"RTN","IBCE837A",146,0)
 ;
"RTN","IBCERP4")
0^2^B11778687
"RTN","IBCERP4",1,0)
IBCERP4 ;ALB/TMP - EDI RECEIPT/REJECTION MSGS STILL PENDING/UPDATNG ; 4/22/03 8:29am
"RTN","IBCERP4",2,0)
 ;;2.0;INTEGRATED BILLING;**137,211**;21-MAR-94
"RTN","IBCERP4",3,0)
 Q
"RTN","IBCERP4",4,0)
PENDING ; Report of EDI messages still waiting to be filed
"RTN","IBCERP4",5,0)
 ;  after a user-specified # of days.
"RTN","IBCERP4",6,0)
 N DIR,IBDAYS
"RTN","IBCERP4",7,0)
 W !!
"RTN","IBCERP4",8,0)
 S DIR(0)="NA^1:999",DIR("B")=1,DIR("A")="MINIMUM # OF DAYS MSGS WAITING TO BE FILED: ",DIR("?",1)="Enter the minimum number of days a message has been waiting to be filed",DIR("?")="before it appears on this report" D ^DIR K DIR
"RTN","IBCERP4",9,0)
 Q:$D(DTOUT)!$D(DUOUT)
"RTN","IBCERP4",10,0)
 S IBDAYS=+Y
"RTN","IBCERP4",11,0)
 S %ZIS="QM" D ^%ZIS Q:POP
"RTN","IBCERP4",12,0)
 I $D(IO("Q")) K IO("Q") S ZTSAVE("IB*")="",ZTRTN="EN^IBCERP4",ZTDESC="REPORT OF EDI MSGS PENDING TOO LONG TO BE FILED" D ^%ZTLOAD K ZTSK D HOME^%ZIS Q
"RTN","IBCERP4",13,0)
 U IO
"RTN","IBCERP4",14,0)
EN ; Queued job entrypoint
"RTN","IBCERP4",15,0)
 N IBPAGE,IBHDRDT,IBLINE,IBSTOP,IBDA,IBCT,IBM,IBMSG,IB0,IB1,IB,DIR,Y
"RTN","IBCERP4",16,0)
 ;
"RTN","IBCERP4",17,0)
 K ^TMP($J,"IBSORT")
"RTN","IBCERP4",18,0)
 S IBDA=0 F  S IBDA=$O(^IBA(364.2,IBDA)) Q:'IBDA  S IB0=$G(^IBA(364.2,IBDA,0)),IB1=$G(^(1)),IBM=+$P(IB0,U,2) D
"RTN","IBCERP4",19,0)
 .; IB*2.0*211 - kill off records with dangling nodes
"RTN","IBCERP4",20,0)
 . I IB0="",IB1'="" N DA,DIK,Y S DA=IBDA,DIK="^IBA(364.2," D ^DIK Q
"RTN","IBCERP4",21,0)
 . I DT-($P(IB1,U,3)\1)'<IBDAYS,'$P(IB0,U,12) D
"RTN","IBCERP4",22,0)
 .. S ^TMP($J,"IBSORT",$P(IB0,U),IBDA)=$P(IB0,U)_U_$P(IB0,U,6)_U_$P(IB1,U,3)_U_$P(IB0,U,4,5),$P(^(IBDA),U,6)=IBM
"RTN","IBCERP4",23,0)
 ;
"RTN","IBCERP4",24,0)
 W:$E(IOST,1,2)["C-" @IOF ;Only initial form feed for print to screen
"RTN","IBCERP4",25,0)
 ;
"RTN","IBCERP4",26,0)
 S (IBPAGE,IBSTOP,IBCT,IBMSG,IBLINE)=0
"RTN","IBCERP4",27,0)
 D HDR1
"RTN","IBCERP4",28,0)
 I '$D(^TMP($J,"IBSORT")) W !,"No data found for this report",!
"RTN","IBCERP4",29,0)
 F  S IBMSG=$O(^TMP($J,"IBSORT",IBMSG)) Q:'IBMSG!(IBSTOP)  S IBDA=0 F  S IBDA=$O(^TMP($J,"IBSORT",IBMSG,IBDA)) Q:'IBDA  S IBV=$G(^(IBDA)) D  Q:IBSTOP
"RTN","IBCERP4",30,0)
 . D:IBLINE>(IOSL-5) HDR1 Q:IBSTOP
"RTN","IBCERP4",31,0)
 . W !,?2,$P($G(^IBE(364.3,+$P(IBV,U,6),0)),U,5)
"RTN","IBCERP4",32,0)
 . W !,?4,$P(IBV,U),?15,$$EXPAND^IBTRE(364.2,.06,$P(IBV,U,2)),?31,$$FMTE^XLFDT($P(IBV,U,3),1),?54,$$EXPAND^IBTRE(364.2,.04,$P(IBV,U,4))
"RTN","IBCERP4",33,0)
 . S Z=$$BN1^PRCAFN(+$G(^IBA(364,+$P(IBV,U,5),0)))
"RTN","IBCERP4",34,0)
 . I Z'=-1 W ?65,Z
"RTN","IBCERP4",35,0)
 . S IBCT=IBCT+1,IBLINE=IBLINE+1
"RTN","IBCERP4",36,0)
 ;
"RTN","IBCERP4",37,0)
 W !!,"TOTAL # OF MESSAGES WAITING OVER "_IBDAYS_" DAY"_$S(IBDAYS>1:"S",1:"")_" TO BE FILED: ",IBCT
"RTN","IBCERP4",38,0)
 ;
"RTN","IBCERP4",39,0)
 I $E(IOST,1,2)["C-" K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","IBCERP4",40,0)
STOP I '$D(ZTQUEUED) D ^%ZISC
"RTN","IBCERP4",41,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBCERP4",42,0)
 K ^TMP($J,"IBSORT")
"RTN","IBCERP4",43,0)
 Q
"RTN","IBCERP4",44,0)
 ;
"RTN","IBCERP4",45,0)
HDR1 ; Report header
"RTN","IBCERP4",46,0)
 ;IB = the text for the type of batch
"RTN","IBCERP4",47,0)
 N Z,DIR,Y
"RTN","IBCERP4",48,0)
 I 'IBPAGE S IBHDRDT=$$HTE^XLFDT($H,"2")
"RTN","IBCERP4",49,0)
 I IBPAGE D  Q:IBSTOP
"RTN","IBCERP4",50,0)
 . I $E(IOST,1,2)["C-" K DIR S DIR(0)="E" D ^DIR K DIR S IBSTOP=('Y) Q:IBSTOP
"RTN","IBCERP4",51,0)
 . W @IOF
"RTN","IBCERP4",52,0)
 ;
"RTN","IBCERP4",53,0)
 S IBPAGE=IBPAGE+1,Z="EDI MESSAGES WAITING TO BE FILED OVER "_IBDAYS_" DAY"_$S(IBDAYS>1:"S",1:"")
"RTN","IBCERP4",54,0)
 W !,?((80-$L(Z))\2),Z,?70,"PAGE: ",IBPAGE,!
"RTN","IBCERP4",55,0)
 W !,?26,"RUN DATE: ",IBHDRDT,!
"RTN","IBCERP4",56,0)
 W !,?2,"MESSAGE TYPE"
"RTN","IBCERP4",57,0)
 W !,?4,"MAIL",?31,"IN CURRENT",!,?4,"MESSAGE #",?15,"CURRENT STATUS",?31,"STATUS SINCE",?54,"BATCH #",?65,"BILL #",!
"RTN","IBCERP4",58,0)
 S Z="",$P(Z,"-",76)="" W ?2,Z,!
"RTN","IBCERP4",59,0)
 S IBLINE=7
"RTN","IBCERP4",60,0)
 Q
"RTN","IBCERP4",61,0)
 ;
"RTN","IBCERP6")
0^10^B23760797
"RTN","IBCERP6",1,0)
IBCERP6 ;ALB/JEH - EDI CLAIMS READY FOR EXTRACT ; 4/22/03 10:00am
"RTN","IBCERP6",2,0)
 ;;2.0;INTEGRATED BILLING;**137,211**;21-MAR-94
"RTN","IBCERP6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCERP6",4,0)
 ;
"RTN","IBCERP6",5,0)
EN ;Entry point from option
"RTN","IBCERP6",6,0)
 W !!,"This report provides a list of claims held in a"
"RTN","IBCERP6",7,0)
 W !,"Ready for Extract status.  Users can select all bills"
"RTN","IBCERP6",8,0)
 W !,"in a Ready for extract status or only those trapped due to"
"RTN","IBCERP6",9,0)
 W !,"the EDI Parameters being turned off."
"RTN","IBCERP6",10,0)
 ;
"RTN","IBCERP6",11,0)
 S IBQUIT=0 D SELECT I IBQUIT G ENQ1
"RTN","IBCERP6",12,0)
 S IBQUIT=0 D PARAM I IBQUIT G ENQ1
"RTN","IBCERP6",13,0)
 ;
"RTN","IBCERP6",14,0)
 W !!,"This report requires a 132 column printer.",!!
"RTN","IBCERP6",15,0)
 ; - Ask device
"RTN","IBCERP6",16,0)
 N %ZIS,ZTRTN,ZTSAVE,ZTDESC
"RTN","IBCERP6",17,0)
 S %ZIS="QM" D ^%ZIS G:POP ENQ1
"RTN","IBCERP6",18,0)
 I $D(IO("Q")) D  G ENQ1
"RTN","IBCERP6",19,0)
 .S ZTRTN="BLD^IBCERP6",ZTDESC="IB - EDI Claims in Waiting Transmission Status"
"RTN","IBCERP6",20,0)
 .S ZTSAVE("IB*")=""
"RTN","IBCERP6",21,0)
 .D ^%ZTLOAD
"RTN","IBCERP6",22,0)
 .W !!,$S($D(ZTSK):"Your task number"_ZTSK_" has been queued.",1:"Unable to queue this job.")
"RTN","IBCERP6",23,0)
 .K ZTSK,IO("Q") D HOME^%ZIS
"RTN","IBCERP6",24,0)
 U IO
"RTN","IBCERP6",25,0)
 ;
"RTN","IBCERP6",26,0)
BLD ; - Tasked entry point
"RTN","IBCERP6",27,0)
 ;
"RTN","IBCERP6",28,0)
 N IBSTAT,IBILL,IBREC,IBIFN,IBSTAT,IBVSIT,IBCAT,IBI,IBINS,IBPREC,IBEVDT,IBTYP,IBPG,IBCHK
"RTN","IBCERP6",29,0)
 K ^TMP("IBCERP6",$J)
"RTN","IBCERP6",30,0)
 S (IBI,IBIFN)=0 F  S IBI=$O(^IBA(364,"ASTAT","X",IBI)) Q:'IBI  S IBIFN=+$G(^IBA(364,IBI,0)) D
"RTN","IBCERP6",31,0)
 .S IBQUIT=0
"RTN","IBCERP6",32,0)
 .S IBSTAT=$$WNRBILL^IBEFUNC(IBIFN)
"RTN","IBCERP6",33,0)
 .I IBSEL=2 D
"RTN","IBCERP6",34,0)
 ..I IBSTAT S IBQUIT=1 Q
"RTN","IBCERP6",35,0)
 ..I 'IBSTAT,1[IBPARAM S IBQUIT=1 Q
"RTN","IBCERP6",36,0)
 ..;I IBSTAT,23[IBPARAM S IBQUIT=1 Q
"RTN","IBCERP6",37,0)
 .Q:IBSTAT!(IBQUIT)
"RTN","IBCERP6",38,0)
 .S IBSTAT=$S(IBSTAT:"MRA",1:"EDI")
"RTN","IBCERP6",39,0)
 .S IBREC=$G(^DGCR(399,+IBIFN,0))
"RTN","IBCERP6",40,0)
 .S IBVSIT=$S($$INPAT^IBCEF(IBIFN,1)=1:"INP",1:"OPT")
"RTN","IBCERP6",41,0)
 .S IBCAT=$S($$FT^IBCEF(IBIFN)=3:"UB92",1:"HCFA")
"RTN","IBCERP6",42,0)
 .S IBILL=$$BN1^PRCAFN(IBIFN)
"RTN","IBCERP6",43,0)
 .S IBINS=$P($G(^DIC(36,+$$CURR^IBCEF2(IBIFN),0)),U)
"RTN","IBCERP6",44,0)
 .S IBPREC=$$PT^IBEFUNC(+$P(IBREC,U,2))
"RTN","IBCERP6",45,0)
 .S IBEVDT=$P($G(^DGCR(399,IBIFN,"U")),U) ;Statement from date
"RTN","IBCERP6",46,0)
 .;S IBTYP=$P(IBREC,U,24)_U_$P($G(^DGCR(399.1,+$P(IBREC,U,25),0)),U)_U_$P(IBREC,U,26)
"RTN","IBCERP6",47,0)
 .S IBTYP=$$GET1^DIQ(399,IBIFN,.24)_U_$$GET1^DIQ(399,IBIFN,.25)_U_$$GET1^DIQ(399,IBIFN,.26)
"RTN","IBCERP6",48,0)
 .S ^TMP("IBCERP6",$J,IBSTAT,IBILL)=IBILL_U_IBVSIT_U_IBCAT_U_$P(IBPREC,U)_U_$E($P(IBPREC,U,2),8,11)_U_IBEVDT_U_IBTYP_U_IBINS
"RTN","IBCERP6",49,0)
 ;
"RTN","IBCERP6",50,0)
PRINT ;Prints report
"RTN","IBCERP6",51,0)
 S (IBQUIT,IBPG,IBEDI,IBMRA,IBTOT)=0 D HDR
"RTN","IBCERP6",52,0)
 I '$D(^TMP("IBCERP6",$J)) W !!,"There are no EDI records"_$S(IBSEL=2:" trapped",1:"")_" in a ready for extract status" G ENQ1
"RTN","IBCERP6",53,0)
 S IBSTAT="" F  S IBSTAT=$O(^TMP("IBCERP6",$J,IBSTAT)) Q:IBSTAT=""!(IBQUIT=1)  D
"RTN","IBCERP6",54,0)
 .S IBILL="" F  S IBILL=$O(^TMP("IBCERP6",$J,IBSTAT,IBILL)) Q:IBILL=""!(IBQUIT=1)  S IBREC=^(IBILL)  D
"RTN","IBCERP6",55,0)
 ..I ($Y+5)>IOSL D  I IBQUIT Q
"RTN","IBCERP6",56,0)
 ...D ASK I IBQUIT Q
"RTN","IBCERP6",57,0)
 ...D HDR
"RTN","IBCERP6",58,0)
 ..;
"RTN","IBCERP6",59,0)
 ..W !,?2,$P(IBREC,U),?15,$P(IBREC,U,2),?22,$P(IBREC,U,3)
"RTN","IBCERP6",60,0)
 ..W ?28,$E($P(IBREC,U,4),1,20),?50,$P(IBREC,U,5)
"RTN","IBCERP6",61,0)
 ..W ?57,$$FMTE^XLFDT($P(IBREC,U,6)),?73,$E($P(IBREC,U,7),1,8)_", "_$E($P(IBREC,U,8),1,3)_", "_$E($P(IBREC,U,9),1,16),?110,$E($P(IBREC,U,10),1,20)
"RTN","IBCERP6",62,0)
 ..I IBSTAT="EDI" S IBEDI=IBEDI+1
"RTN","IBCERP6",63,0)
 ..E  S IBMRA=IBMRA+1
"RTN","IBCERP6",64,0)
 ..S IBTOT=IBTOT+1
"RTN","IBCERP6",65,0)
 W !!
"RTN","IBCERP6",66,0)
 I IBEDI>0 W !,?3,"Total EDI Bills ",IBEDI
"RTN","IBCERP6",67,0)
 I IBMRA>0 W !,?3,"Total MRA Bills ",IBMRA
"RTN","IBCERP6",68,0)
 W !!,?3,"Total bills ",IBTOT
"RTN","IBCERP6",69,0)
 K ^TMP("IBCERP6",$J)
"RTN","IBCERP6",70,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBCERP6",71,0)
 I '$D(ZTQUEUED) D ^%ZISC
"RTN","IBCERP6",72,0)
ENQ1 K IBPARAM,IBQUIT,IBSEL,Y,IBEDI,IBMRA,IBTOT Q
"RTN","IBCERP6",73,0)
 ;
"RTN","IBCERP6",74,0)
PARAM ;
"RTN","IBCERP6",75,0)
 S IBPARAM=$P($G(^IBE(350.9,1,8)),U,10) ;Get EDI site parameter setting
"RTN","IBCERP6",76,0)
 I IBPARAM="" D
"RTN","IBCERP6",77,0)
 .W !!,"Your EDI site parameter setting is incomplete."
"RTN","IBCERP6",78,0)
 .W !,"Please contact your coordinator.",!
"RTN","IBCERP6",79,0)
 .S IBQUIT=1
"RTN","IBCERP6",80,0)
 ;
"RTN","IBCERP6",81,0)
 I IBSEL=2,IBPARAM=3 D
"RTN","IBCERP6",82,0)
 .W !!,"Your site parameters are set to allow EDI transmissions"
"RTN","IBCERP6",83,0)
 .W !,"There is no need to run this report.",!
"RTN","IBCERP6",84,0)
 .S IBQUIT=1
"RTN","IBCERP6",85,0)
 Q
"RTN","IBCERP6",86,0)
 ;
"RTN","IBCERP6",87,0)
HDR ;Prints report heading
"RTN","IBCERP6",88,0)
 ; IB*2.0*211
"RTN","IBCERP6",89,0)
 ;I $E(IOST,1,2)="C-" W @IOF,*13
"RTN","IBCERP6",90,0)
 I $S(IBPG:1,1:$E(IOST,1,2)="C-") W @IOF,*13
"RTN","IBCERP6",91,0)
 S IBPG=IBPG+1
"RTN","IBCERP6",92,0)
 W !!,?45,$S(IBSEL=2:"Trapped ",1:"")_" Claims Ready for Extract",?90,$$FMTE^XLFDT(DT),?110,"Page: ",IBPG
"RTN","IBCERP6",93,0)
 W !!,?15,"Inpt/",?23,"Inst/",!,?4,"Bill #",?15,"Opt",?23,"Prof",?32,"Name"
"RTN","IBCERP6",94,0)
 W ?51,"SSN",?57,"Statement Date",?89,"Type",?110,"Insurance Co."
"RTN","IBCERP6",95,0)
 W !,$TR($J("",IOM)," ","=")
"RTN","IBCERP6",96,0)
 Q
"RTN","IBCERP6",97,0)
 ;
"RTN","IBCERP6",98,0)
ASK ;
"RTN","IBCERP6",99,0)
 I $E(IOST,1,2)'["C-" Q
"RTN","IBCERP6",100,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","IBCERP6",101,0)
 S DIR(0)="E" D ^DIR
"RTN","IBCERP6",102,0)
 I ($D(DIRUT))!($D(DUOUT)) S IBQUIT=1 Q
"RTN","IBCERP6",103,0)
 Q
"RTN","IBCERP6",104,0)
 ;
"RTN","IBCERP6",105,0)
SELECT ;Report selection
"RTN","IBCERP6",106,0)
 N DIR,DIROUT,DTOUT,DUOUT,DTOUT
"RTN","IBCERP6",107,0)
 S IBSEL=0
"RTN","IBCERP6",108,0)
 W !!  S DIR("A",1)="Do you want to print a list of:"
"RTN","IBCERP6",109,0)
 S DIR("A",2)=""
"RTN","IBCERP6",110,0)
 S DIR("A",3)="     1 - All bills in Ready for Extract status"
"RTN","IBCERP6",111,0)
 S DIR("A",4)="     2 - Bills trapped due to EDI paramater being turned off"
"RTN","IBCERP6",112,0)
 S DIR("A",5)=""
"RTN","IBCERP6",113,0)
 S DIR(0)="SAXB^1:All bills;2:Trapped bills"
"RTN","IBCERP6",114,0)
 W !
"RTN","IBCERP6",115,0)
 S DIR("A")="Select Number: ",DIR("B")=1
"RTN","IBCERP6",116,0)
 D ^DIR
"RTN","IBCERP6",117,0)
 I +Y'>0 S IBQUIT=1 Q
"RTN","IBCERP6",118,0)
 S IBSEL=+Y
"RTN","IBCERP6",119,0)
 Q
"RTN","IBCEXTRP")
0^1^B21771139
"RTN","IBCEXTRP",1,0)
IBCEXTRP ;ALB/JEH - VIEW/PRINT EDI EXTRACT DATA ; 4/22/03 9:59am
"RTN","IBCEXTRP",2,0)
 ;;2.0;INTEGRATED BILLING;**137,197,211**;21-MAR-94
"RTN","IBCEXTRP",3,0)
 ;
"RTN","IBCEXTRP",4,0)
EN ;
"RTN","IBCEXTRP",5,0)
INIT ;
"RTN","IBCEXTRP",6,0)
 W !!,"This option will display the EDI extract data for a bill.",!
"RTN","IBCEXTRP",7,0)
 N IBREC1,IBIEN,IBINC,DIC,X,Y,DIR,IB364IEN,IBVNUM
"RTN","IBCEXTRP",8,0)
 ;
"RTN","IBCEXTRP",9,0)
 N DPTNOFZY S DPTNOFZY=1 ; Suppress PATIENT file fuzzy lookups
"RTN","IBCEXTRP",10,0)
 S DIC="^DGCR(399,",DIC(0)="AEMQ",DIC("S")="I 234[$P(^(0),U,13)" D ^DIC
"RTN","IBCEXTRP",11,0)
 I Y<1 G EXITQ
"RTN","IBCEXTRP",12,0)
 S IBIEN=+Y,IBREC1=$G(^DGCR(399,IBIEN,0))
"RTN","IBCEXTRP",13,0)
 S IB364IEN=$$LAST364^IBCEF4(IBIEN) I +$G(IB364IEN)=0 D  G EXITQ
"RTN","IBCEXTRP",14,0)
 . W !,"There is no entry in the EDI Transmit Bill file for this bill number."
"RTN","IBCEXTRP",15,0)
 S IBVNUM=$P($G(^IBA(364,IB364IEN,0)),U,2) I +$G(IBVNUM)=0 D  G EXITQ
"RTN","IBCEXTRP",16,0)
 . W !!,"There is no batch # for this bill.  It has not been transmitted."
"RTN","IBCEXTRP",17,0)
 S IBVNUM=$P($G(^IBA(364.1,IBVNUM,0)),U)
"RTN","IBCEXTRP",18,0)
 S DIR("A")="INCLUDE FIELDS WITH NO DATA?: ",DIR("B")="NO",DIR(0)="YA" D ^DIR K DIR
"RTN","IBCEXTRP",19,0)
 I $D(DTOUT)!$D(DUOUT) G EXITQ
"RTN","IBCEXTRP",20,0)
 S IBINC=+Y
"RTN","IBCEXTRP",21,0)
DEV ; - Select device
"RTN","IBCEXTRP",22,0)
 N %ZIS,ZTRTN,ZTSAVE,ZTDESC
"RTN","IBCEXTRP",23,0)
 S %ZIS="QM" D ^%ZIS G:POP EXITQ
"RTN","IBCEXTRP",24,0)
 I $D(IO("Q")) D  G EXITQ
"RTN","IBCEXTRP",25,0)
 . S ZTRTN="LIST^IBCEXTRP",ZTDESC="Transmitted Bill Extract Data"
"RTN","IBCEXTRP",26,0)
 . S ZTSAVE("IB*")=""
"RTN","IBCEXTRP",27,0)
 . D ^%ZTLOAD
"RTN","IBCEXTRP",28,0)
 . W !!,$S($D(ZTSK):"Your task number "_ZTSK_" has been queued.",1:"Unable to queue this job.")
"RTN","IBCEXTRP",29,0)
 .K ZTSK,IO("Q") D HOME^%ZIS
"RTN","IBCEXTRP",30,0)
 U IO
"RTN","IBCEXTRP",31,0)
 ;
"RTN","IBCEXTRP",32,0)
LIST ; - set up array and print data
"RTN","IBCEXTRP",33,0)
 N IBPG,IBSEQ,IBPC,IBDA,IBREC,IBQUIT,IBILL,IBLINE,IBXDATA,IBERR,IBXERR,Z,Z0,Z1
"RTN","IBCEXTRP",34,0)
 D EXTRACT(IBIEN,IBVNUM,8,1)
"RTN","IBCEXTRP",35,0)
 S (IBPG,IBQUIT,IBSEQ,IBPC,IBDA,IBLINE)=0
"RTN","IBCEXTRP",36,0)
 K ^TMP($J,"IBLINES")
"RTN","IBCEXTRP",37,0)
 ;IB*2.0*211 - rely on form type instead of bill charge type
"RTN","IBCEXTRP",38,0)
 ;S IBILL=$S($$INPAT^IBCEF(IBIEN,1):"Inpt",1:"Oupt")_"/"_$S($$INSPRF^IBCEF(IBIEN)=1:"UB92",1:"HCFA")
"RTN","IBCEXTRP",39,0)
 N IBFMTYP S IBFMTYP=$$FT^IBCEF(IBIEN)
"RTN","IBCEXTRP",40,0)
 S IBFMTYP=$S(IBFMTYP=2:"HCFA",IBFMTYP=3:"UB-92",1:"OTHER"_"("_IBFMTYP_")")
"RTN","IBCEXTRP",41,0)
 S IBILL=$S($$INPAT^IBCEF(IBIEN,1):"Inpt",1:"Oupt")_"/"_IBFMTYP
"RTN","IBCEXTRP",42,0)
 I $D(^TMP("IBXERR",$J)) D  G EXITQ
"RTN","IBCEXTRP",43,0)
 . S IBERR=0 F  S IBERR=$O(^TMP("IBXERR",$J,IBERR)) Q:'IBERR  W !,$G(^TMP("IBXERR",$J,IBERR))
"RTN","IBCEXTRP",44,0)
 F  S IBSEQ=$O(^IBA(364.6,"ASEQ",8,IBSEQ)) Q:'IBSEQ!(IBQUIT)  F  S IBPC=$O(^IBA(364.6,"ASEQ",8,IBSEQ,1,IBPC)) Q:'IBPC!(IBQUIT)  F  S IBDA=$O(^IBA(364.6,"ASEQ",8,IBSEQ,1,IBPC,IBDA)) Q:'IBDA!(IBQUIT)  S IBREC=$G(^IBA(364.6,IBDA,0)) D  Q:IBQUIT
"RTN","IBCEXTRP",45,0)
 . N IBOK,Z,IBMULT
"RTN","IBCEXTRP",46,0)
 . I $P(IBREC,U,11)=1 Q
"RTN","IBCEXTRP",47,0)
 . I IBPC=1 S IBOK=0 D
"RTN","IBCEXTRP",48,0)
 .. S Z=1 F  S Z=$O(^TMP("IBXDATA",$J,1,IBSEQ,1,Z)) Q:'Z  I $G(^(Z))'="" S IBOK=1 Q
"RTN","IBCEXTRP",49,0)
 .. I 'IBOK S $P(^TMP("IBXDATA",$J,1,IBSEQ,1,1),U)=$P($G(^TMP("IBXDATA",$J,1,IBSEQ,1,1)),U)_"  (NO DATA - RECORD NOT SENT)"
"RTN","IBCEXTRP",50,0)
 . S IBMULT=0 F  S IBMULT=$O(^TMP("IBXDATA",$J,1,IBSEQ,IBMULT)) Q:'IBMULT   D
"RTN","IBCEXTRP",51,0)
 .. I '$G(IBINC),$P($G(^TMP("IBXDATA",$J,1,IBSEQ,IBMULT,IBPC)),U)="" Q
"RTN","IBCEXTRP",52,0)
 .. S ^TMP($J,"IBLINES",IBSEQ,IBMULT,IBPC)=$E($P(IBREC,U,10)_$J("",30),1,30)_": "_$P($G(^TMP("IBXDATA",$J,1,IBSEQ,IBMULT,IBPC)),U)
"RTN","IBCEXTRP",53,0)
 .
"RTN","IBCEXTRP",54,0)
 W:$E(IOST,1,2)["C-" @IOF ; initial form feed for screen print
"RTN","IBCEXTRP",55,0)
 ;S IBILL=$S($$INPAT^IBCEF(IBIEN,1):"Inpt",1:"Oupt")_"/"_$S($$INSPRF^IBCEF(IBIEN)=1:"UB92",1:"HCFA")
"RTN","IBCEXTRP",56,0)
 N IBFMTYP S IBFMTYP=$$FT^IBCEF(IBIEN)
"RTN","IBCEXTRP",57,0)
 S IBFMTYP=$S(IBFMTYP=2:"HCFA",IBFMTYP=3:"UB-92",1:"OTHER"_"("_IBFMTYP_")")
"RTN","IBCEXTRP",58,0)
 S IBILL=$S($$INPAT^IBCEF(IBIEN,1):"Inpt",1:"Oupt")_"/"_IBFMTYP
"RTN","IBCEXTRP",59,0)
 D HDR
"RTN","IBCEXTRP",60,0)
 S Z=0 F  S Z=$O(^TMP($J,"IBLINES",Z)) Q:'Z  S Z0=0 F  S Z0=$O(^TMP($J,"IBLINES",Z,Z0)) Q:'Z0  S Z1=0 F  S Z1=$O(^TMP($J,"IBLINES",Z,Z0,Z1)) Q:'Z1  D  G:IBQUIT Q1
"RTN","IBCEXTRP",61,0)
 . D:IBLINE>(IOSL-5) HDR Q:IBQUIT
"RTN","IBCEXTRP",62,0)
 . W !,^TMP($J,"IBLINES",Z,Z0,Z1)
"RTN","IBCEXTRP",63,0)
 . S IBLINE=IBLINE+1
"RTN","IBCEXTRP",64,0)
Q1 K ^TMP($J,"IBLINES")
"RTN","IBCEXTRP",65,0)
 Q
"RTN","IBCEXTRP",66,0)
 ;
"RTN","IBCEXTRP",67,0)
HDR ; - Report header
"RTN","IBCEXTRP",68,0)
 N DIR,Y
"RTN","IBCEXTRP",69,0)
 I IBPG D  Q:IBQUIT
"RTN","IBCEXTRP",70,0)
 . I $E(IOST,1,2)["C-" K DIR S DIR(0)="E" D ^DIR K DIR S IBQUIT=('Y) Q:IBQUIT
"RTN","IBCEXTRP",71,0)
 . W @IOF
"RTN","IBCEXTRP",72,0)
 ;
"RTN","IBCEXTRP",73,0)
 S IBPG=IBPG+1
"RTN","IBCEXTRP",74,0)
 W !!,?25,"EDI Transmitted Bill Extract Data",!,"Bill #",?11,"Type",?27,"Patient Name",?52,"SSN",?57,$$FMTE^XLFDT(DT),?71,"Page: "_IBPG
"RTN","IBCEXTRP",75,0)
 W !,$TR($J("",IOM)," ","=")
"RTN","IBCEXTRP",76,0)
 W !,$P(IBREC1,U)_" "_"("_IBILL_")",?27,$P($G(^DPT(+$P(IBREC1,U,2),0)),U),?52,$P($G(^DPT($P(IBREC1,U,2),0)),U,9),!
"RTN","IBCEXTRP",77,0)
 S IBLINE=5
"RTN","IBCEXTRP",78,0)
 Q
"RTN","IBCEXTRP",79,0)
 ;
"RTN","IBCEXTRP",80,0)
ASK ;
"RTN","IBCEXTRP",81,0)
 I $E(IOST,1,2)'["C-" Q
"RTN","IBCEXTRP",82,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","IBCEXTRP",83,0)
 S DIR(0)="E" D ^DIR
"RTN","IBCEXTRP",84,0)
 I ($D(DIRUT))!($D(DUOUT)) S IBQUIT=1
"RTN","IBCEXTRP",85,0)
 Q
"RTN","IBCEXTRP",86,0)
 ;
"RTN","IBCEXTRP",87,0)
EXITQ ; - clean up and exit
"RTN","IBCEXTRP",88,0)
 I $E(IOST,1,2)["C-" K DIR S DIR(0)="E" W ! D ^DIR K DIR
"RTN","IBCEXTRP",89,0)
 K ^TMP("IBXERR",$J),^TMP("IBXDATA",$J),IBXERR
"RTN","IBCEXTRP",90,0)
 D CLEAN^DILF
"RTN","IBCEXTRP",91,0)
 Q
"RTN","IBCEXTRP",92,0)
 ;
"RTN","IBCEXTRP",93,0)
EXTRACT(IBIFN,IBBATCH,IBFORM,IBLOCAL) ; Extracts transmitted form data into global
"RTN","IBCEXTRP",94,0)
 ; ^TMP("IBXDATA",$J).  Errors are in ^TMP("IBXERR",$J,err_num)=text.
"RTN","IBCEXTRP",95,0)
 ; IBBATCH = Batch # of bill (if known), otherwise, set to 1.  This
"RTN","IBCEXTRP",96,0)
 ;          variable must be > 0 to prevent a new batch from being added
"RTN","IBCEXTRP",97,0)
 ; IBFORM = the ien of the form in file 353
"RTN","IBCEXTRP",98,0)
 ; IBLOCAL = 1 if OK to use local form, 0 if not
"RTN","IBCEXTRP",99,0)
 N IBVNUM,IBL
"RTN","IBCEXTRP",100,0)
 D FORMPRE^IBCFP1
"RTN","IBCEXTRP",101,0)
 S IBVNUM=$G(IBBATCH)
"RTN","IBCEXTRP",102,0)
 S IBL=$S('$G(IBLOCAL):IBFORM,1:"") ; No local form ... set = main form
"RTN","IBCEXTRP",103,0)
 ; Get local form associated with parent, if any
"RTN","IBCEXTRP",104,0)
 I IBL="" S IBL=$S($P($G(^IBE(353,+IBFORM,2)),U,8):$P(^(2),U,8),1:IBFORM)
"RTN","IBCEXTRP",105,0)
 D SETUP^IBCE837(1)
"RTN","IBCEXTRP",106,0)
 D ROUT^IBCFP1(IBFORM,1,IBIFN,0,IBL)
"RTN","IBCEXTRP",107,0)
 Q
"RTN","IBCEXTRP",108,0)
 ;
"RTN","IBCNBMN")
0^9^B7906645
"RTN","IBCNBMN",1,0)
IBCNBMN ;ALB/ARH-Ins Buffer: add new insurance file entrys ; 4/22/03 10:00am
"RTN","IBCNBMN",2,0)
 ;;2.0;INTEGRATED BILLING;**82,211**;21-MAR-94
"RTN","IBCNBMN",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNBMN",4,0)
 ;
"RTN","IBCNBMN",5,0)
 ;
"RTN","IBCNBMN",6,0)
NEWINS(IBBUFDA) ; add new insurance carrier entry in Insurance Company (#36) file
"RTN","IBCNBMN",7,0)
 ;
"RTN","IBCNBMN",8,0)
 N DIC,DA,DIE,DR,X,Y,DLAYGO,IBINSDA,IB20,IBINSNM,IBREIMB S IBINSDA=0,IB20=$G(^IBA(355.33,+$G(IBBUFDA),20))
"RTN","IBCNBMN",9,0)
 S IBINSNM=$P(IB20,U,1) I IBINSNM="" G NIQ
"RTN","IBCNBMN",10,0)
 ;
"RTN","IBCNBMN",11,0)
 S IBREIMB=$P(IB20,U,5) I IBREIMB'="" S DIC("DR")="1///"_IBREIMB ;                     will reimburse?
"RTN","IBCNBMN",12,0)
 K DD,DO S DIC="^DIC(36,",DIC(0)="L",X=IBINSNM,DLAYGO=36 D FILE^DICN I +Y>0  S IBINSDA=+Y
"RTN","IBCNBMN",13,0)
 ;
"RTN","IBCNBMN",14,0)
NIQ Q IBINSDA
"RTN","IBCNBMN",15,0)
 ;
"RTN","IBCNBMN",16,0)
NEWGRP(IBBUFDA,IBINSDA) ; add a new group/plan to the Group Insurance Plan (#355.3) file, also add standard fields
"RTN","IBCNBMN",17,0)
 ;
"RTN","IBCNBMN",18,0)
 N DIC,DA,DR,DIE,X,Y,DLAYGO,IBGRPDA,IB40,IBFIELDS,IBERR,IBXIFN S IBGRPDA=0,IB40=$G(^IBA(355.33,+$G(IBBUFDA),40))
"RTN","IBCNBMN",19,0)
 I '$D(^DIC(36,+$G(IBINSDA),0)) G NGQ
"RTN","IBCNBMN",20,0)
 I $P(IB40,U,1)=0,'$G(^IBA(355.33,+$G(IBBUFDA),60)) G NGQ
"RTN","IBCNBMN",21,0)
 ;
"RTN","IBCNBMN",22,0)
 K DA,DO S DIC="^IBA(355.3,",DIC(0)="L",X=IBINSDA,DLAYGO=355.3 D FILE^DICN I +Y'>0 G NGQ
"RTN","IBCNBMN",23,0)
 S IBGRPDA=+Y,IBXIFN=IBGRPDA_","
"RTN","IBCNBMN",24,0)
 ;
"RTN","IBCNBMN",25,0)
 S IBFIELDS(355.3,IBXIFN,.02)=$P(IB40,U,1) ;                                           group plan?
"RTN","IBCNBMN",26,0)
 I $P(IB40,U,1)=0 S IBFIELDS(355.3,IBXIFN,.1)=+$G(^IBA(355.33,+$G(IBBUFDA),60)) ;   individual plan patient
"RTN","IBCNBMN",27,0)
 D FILE^DIE("","IBFIELDS","IBERR")
"RTN","IBCNBMN",28,0)
 ;
"RTN","IBCNBMN",29,0)
NGQ Q IBGRPDA
"RTN","IBCNBMN",30,0)
 ;
"RTN","IBCNBMN",31,0)
NEWPOL(IBBUFDA,IBINSDA,IBGRPDA) ; add a new patient policy to the Patient's Insurance Policys (2.312), also add standard fields
"RTN","IBCNBMN",32,0)
 ;
"RTN","IBCNBMN",33,0)
 N DIC,DA,DR,DIE,X,Y,IBPOLDA,IBFIELDS,IBERR,DFN,IBGRP,IBXIFN S IBPOLDA=0
"RTN","IBCNBMN",34,0)
 I '$D(^DIC(36,+$G(IBINSDA),0)) G NPQ
"RTN","IBCNBMN",35,0)
 S IBGRP=$G(^IBA(355.3,+$G(IBGRPDA),0)) I +IBGRP'=IBINSDA G NPQ
"RTN","IBCNBMN",36,0)
 S DFN=+$G(^IBA(355.33,+$G(IBBUFDA),60)) I 'DFN G NPQ
"RTN","IBCNBMN",37,0)
 I $P(IBGRP,U,10)'="",$P(IBGRP,U,10)'=DFN G NPQ
"RTN","IBCNBMN",38,0)
 ;
"RTN","IBCNBMN",39,0)
 ; IB*2*211
"RTN","IBCNBMN",40,0)
 L +^DPT(DFN,.312):5 I '$T D LOCKED^IBTRCD1 G NPQ
"RTN","IBCNBMN",41,0)
 I $G(^DPT(DFN,.312,0))="" S ^DPT(DFN,.312,0)="^2.312PAI^^"
"RTN","IBCNBMN",42,0)
 ;
"RTN","IBCNBMN",43,0)
 K DA,DO S DIC="^DPT("_DFN_",.312,",DIC(0)="L",X=IBINSDA,DA(1)=DFN D FILE^DICN I +Y'>0 G NPQ
"RTN","IBCNBMN",44,0)
 S IBPOLDA=+Y,IBXIFN=IBPOLDA_","_DFN_","
"RTN","IBCNBMN",45,0)
 ;
"RTN","IBCNBMN",46,0)
 S IBFIELDS(2.312,IBXIFN,.18)=IBGRPDA ;                                                 policy's group/plan
"RTN","IBCNBMN",47,0)
 S IBFIELDS(2.312,IBXIFN,1.09)=$P($G(^IBA(355.33,+$G(IBBUFDA),0)),U,3) ;                source
"RTN","IBCNBMN",48,0)
 S IBFIELDS(2.312,IBXIFN,1.1)=+$G(^IBA(355.33,+$G(IBBUFDA),0)) ;                        source date
"RTN","IBCNBMN",49,0)
 D FILE^DIE("","IBFIELDS","IBERR")
"RTN","IBCNBMN",50,0)
 L -^DPT(DFN,.312)
"RTN","IBCNBMN",51,0)
 ;
"RTN","IBCNBMN",52,0)
NPQ Q IBPOLDA
"RTN","IBCNSM3")
0^8^B13078506
"RTN","IBCNSM3",1,0)
IBCNSM3 ;ALB/AAS - INSURANCE MANAGEMENT - OUTPUTS ; 4/7/03 9:56am
"RTN","IBCNSM3",2,0)
 ;;2.0;INTEGRATED BILLING;**6,28,85,211**;21-MAR-94
"RTN","IBCNSM3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNSM3",4,0)
 ;
"RTN","IBCNSM3",5,0)
% G EN^IBCNSM
"RTN","IBCNSM3",6,0)
 ;
"RTN","IBCNSM3",7,0)
AD ; -- Add new insurance policy
"RTN","IBCNSM3",8,0)
 N X,Y,DO,DD,DA,DR,DIC,DIE,DIK,DIR,DIRUT,IBCNSP,IBCPOL,IBQUIT,IBOK,IBCDFN,IBAD,IBGRP,IBADPOL,IBCOVP,ANS,IBGNA,IBGNU
"RTN","IBCNSM3",9,0)
 S IBCNSEH=$P($G(^IBE(350.9,1,4)),"^",1),IBQUIT=0,IBADPOL=1
"RTN","IBCNSM3",10,0)
 D FULL^VALM1
"RTN","IBCNSM3",11,0)
 S IBCOVP=$P($G(^DPT(DFN,.31)),"^",11)
"RTN","IBCNSM3",12,0)
 I '$D(^DPT(DFN,.312,0)) S ^DPT(DFN,.312,0)="^2.312PAI^^"
"RTN","IBCNSM3",13,0)
 ;
"RTN","IBCNSM3",14,0)
 D INS^IBCNSEH
"RTN","IBCNSM3",15,0)
 ; -- Select insurance company
"RTN","IBCNSM3",16,0)
 ;    If one already exists for same co. ask are you sure you are
"RTN","IBCNSM3",17,0)
 ;    adding a new one
"RTN","IBCNSM3",18,0)
 S DIR(0)="350.9,4.06"
"RTN","IBCNSM3",19,0)
 S DIR("A")="Select INSURANCE COMPANY",DIR("??")="^D ADH^IBCNSM3"
"RTN","IBCNSM3",20,0)
 S DIR("?")="Select the Insurance Company for the policy you are entering"
"RTN","IBCNSM3",21,0)
 D ^DIR K DIR S IBCNSP=+Y I Y<1 G ADQ
"RTN","IBCNSM3",22,0)
 I $P($G(^DIC(36,+IBCNSP,0)),"^",2)="N" W !,"This company does not reimburse.  "
"RTN","IBCNSM3",23,0)
 I $P($G(^DIC(36,+IBCNSP,0)),"^",5) W !,*7,"Warning: Inactive Company" H 3 K IBCNSP G ADQ
"RTN","IBCNSM3",24,0)
 I $$DUPCO^IBCNSOK1(DFN,IBCNSP,"",1) H 3
"RTN","IBCNSM3",25,0)
 ;
"RTN","IBCNSM3",26,0)
 ; -- see if can use existing policy
"RTN","IBCNSM3",27,0)
 D SEL^IBCNSEH
"RTN","IBCNSM3",28,0)
 S IBCPOL=$$LK^IBCNSM31(IBCNSP)
"RTN","IBCNSM3",29,0)
 I IBCPOL<1 D NEW^IBCNSJ3(IBCNSP,.IBCPOL)
"RTN","IBCNSM3",30,0)
 I IBCPOL<1 G ADQ
"RTN","IBCNSM3",31,0)
 ;
"RTN","IBCNSM3",32,0)
 ; -- file new patient policy
"RTN","IBCNSM3",33,0)
 S DIC("DR")=".18////"_IBCPOL_";1.09////1;1.05///NOW;1.06////"_DUZ
"RTN","IBCNSM3",34,0)
 K DD,DO S DA(1)=DFN,DIC="^DPT("_DFN_",.312,",DIC(0)="L",X=IBCNSP D FILE^DICN K DIC S IBCDFN=+Y,IBNEW=1 I +Y<1 G ADQ
"RTN","IBCNSM3",35,0)
 D BEFORE^IBCNSEVT
"RTN","IBCNSM3",36,0)
 ;
"RTN","IBCNSM3",37,0)
 ; -- Edit patient policy data
"RTN","IBCNSM3",38,0)
 D PAT^IBCNSEH,PATPOL^IBCNSM32(IBCDFN)
"RTN","IBCNSM3",39,0)
 ;
"RTN","IBCNSM3",40,0)
 ; -- edit PLAN data if hold key
"RTN","IBCNSM3",41,0)
 I '$D(^XUSEC("IB INSURANCE SUPERVISOR",DUZ)) G ADQ
"RTN","IBCNSM3",42,0)
 I '$G(IBQUIT) D POL^IBCNSEH,EDPOL(IBCDFN)
"RTN","IBCNSM3",43,0)
 I '$G(IBNEW) D AI^IBCNSP1
"RTN","IBCNSM3",44,0)
 G ADQ
"RTN","IBCNSM3",45,0)
 ;
"RTN","IBCNSM3",46,0)
ADQ D COVERED^IBCNSM31(DFN,IBCOVP)
"RTN","IBCNSM3",47,0)
 I $G(IBCDFN)>0 D AFTER^IBCNSEVT,^IBCNSEVT
"RTN","IBCNSM3",48,0)
 I $G(IBCPOL)>0 D BLD^IBCNSM
"RTN","IBCNSM3",49,0)
 S VALMBCK="R"
"RTN","IBCNSM3",50,0)
 Q
"RTN","IBCNSM3",51,0)
 ;
"RTN","IBCNSM3",52,0)
EDPOL(IBCDFN) ; -- Edit GROUP PLAN specific info
"RTN","IBCNSM3",53,0)
 I '$G(IBCDFN) G EDPOLQ
"RTN","IBCNSM3",54,0)
 N DA,DR,DIE,DIC,IBAD,IBCPOL,IBDIF
"RTN","IBCNSM3",55,0)
 S IBCPOL=$P($G(^DPT(DFN,.312,IBCDFN,0)),"^",18)
"RTN","IBCNSM3",56,0)
 L +^IBA(355.3,+IBCPOL):5 I '$T D LOCKED^IBTRCD1 G EDPOLQ
"RTN","IBCNSM3",57,0)
 I IBCPOL D
"RTN","IBCNSM3",58,0)
 .D SAVE^IBCNSP3(IBCPOL)
"RTN","IBCNSM3",59,0)
 .S DIE="^IBA(355.3,",DA=IBCPOL
"RTN","IBCNSM3",60,0)
 .S DR="S IBAD=$P($G(^IBA(355.3,DA,0)),U,2),Y=$S(IBAD=0:""@55"",IBAD="""":""@1"",1:""@25"");@1;.02;@25;.03;.04;@55;.09;.15;S Y=$S($$CATOK^IBCEMRA($P(^(0),U,14)):""@60"",1:""@65"");@60;.14;@65;.13;.05;.12;.06;.07;.08//YES;"
"RTN","IBCNSM3",61,0)
 .I $D(IBREG),'$G(IBNEWP) S DR="S IBAD=$P($G(^IBA(355.3,DA,0)),U,2),Y=$S(IBAD=0:""@55"",IBAD="""":""@1"",1:""@25"");@1;.02;@25;D 3^IBCNSM31;D 4^IBCNSM31;@55;.09;"
"RTN","IBCNSM3",62,0)
 .I $D(IBREG),'$G(IBNEWP) S DR=DR_".15;S Y=$S($$CATOK^IBCEMRA($P(^(0),U,14)):""@60"",1:""@65"");@60;.14;@65;.13;.05;.12;.06;.07;.08//YES;"
"RTN","IBCNSM3",63,0)
 .D ^DIE
"RTN","IBCNSM3",64,0)
 .D COMP^IBCNSP3(IBCPOL)
"RTN","IBCNSM3",65,0)
 .I IBDIF D UPDATE^IBCNSP3(IBCPOL),UPDATPT^IBCNSP3(DFN,IBCDFN) I $$DUPPOL^IBCNSOK1(IBCPOL,1)
"RTN","IBCNSM3",66,0)
 L -^IBA(355.3,+IBCPOL)
"RTN","IBCNSM3",67,0)
EDPOLQ Q
"RTN","IBCNSM3",68,0)
 ;
"RTN","IBCNSM3",69,0)
OK ; -- ask okay
"RTN","IBCNSM3",70,0)
 S IBQUIT=0,DIR(0)="Y",DIR("A")="       ...OK",DIR("B")="YES" D ^DIR K DIR
"RTN","IBCNSM3",71,0)
 I $D(DIRUT) S IBQUIT=1
"RTN","IBCNSM3",72,0)
 S IBOK=Y
"RTN","IBCNSM3",73,0)
 Q
"RTN","IBCNSM3",74,0)
 ;
"RTN","IBCNSM3",75,0)
ADH ; -- show existing policies for help
"RTN","IBCNSM3",76,0)
 N DIR,DA,%A
"RTN","IBCNSM3",77,0)
 W !!,"The patient currently has the following Insurance Policies"
"RTN","IBCNSM3",78,0)
 D DISP^IBCNS
"RTN","IBCNSM3",79,0)
 Q
"RTN","IBCNSU41")
0^6^B21366788
"RTN","IBCNSU41",1,0)
IBCNSU41 ;ALB/CPM - SPONSOR UTILITIES (CON'T) ; 5/9/03 1:25pm
"RTN","IBCNSU41",2,0)
 ;;2.0;INTEGRATED BILLING;**52,211**; 21-MAR-94
"RTN","IBCNSU41",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNSU41",4,0)
 ;
"RTN","IBCNSU41",5,0)
SPON(DFN) ; Add/edit sponsor/sponsor relationships for a patient.
"RTN","IBCNSU41",6,0)
 ;  Input:    DFN  --  Pointer to the patient in file #2
"RTN","IBCNSU41",7,0)
 ;
"RTN","IBCNSU41",8,0)
 I '$G(DFN) G SPONQ
"RTN","IBCNSU41",9,0)
 N IBQ S IBQ=0
"RTN","IBCNSU41",10,0)
 F  D LSP Q:IBQ
"RTN","IBCNSU41",11,0)
SPONQ Q
"RTN","IBCNSU41",12,0)
 ;
"RTN","IBCNSU41",13,0)
 ;
"RTN","IBCNSU41",14,0)
 ;
"RTN","IBCNSU41",15,0)
LSP ; Main loop to collect sponsor and relation data.
"RTN","IBCNSU41",16,0)
 S DIR(0)="FAO^3:30",DIR("A")="Select SPONSOR: " D ^DIR K DIR
"RTN","IBCNSU41",17,0)
 I $D(DIRUT)!$D(DIROUT)!$D(DUOUT)!$D(DTOUT) K DIRUT,DIROUT,DTOUT,DUOUT S IBQ=1 G LSPQ
"RTN","IBCNSU41",18,0)
 S IBX=X
"RTN","IBCNSU41",19,0)
 ;
"RTN","IBCNSU41",20,0)
 ; - perform lookup to find sponsor or add a patient sponsor
"RTN","IBCNSU41",21,0)
 S DIC(0)="ELMZ",DIC="^IBA(355.8,",DLAYGO=355.8 D ^DIC K DIC,DLAYGO
"RTN","IBCNSU41",22,0)
 I Y>0 S IBSP=+Y,IBSPD=$G(^IBA(355.8,IBSP,0)),IBNAM=Y(0,0) G LSPC
"RTN","IBCNSU41",23,0)
 I IBX'?1.A1","1.ANP W !,"New sponsors must be in the format LAST,FIRST.",! G LSP
"RTN","IBCNSU41",24,0)
 ;
"RTN","IBCNSU41",25,0)
 ; - is this a new sponsor to be added to the system?
"RTN","IBCNSU41",26,0)
 S DIR(0)="Y",DIR("A")="  Are you adding '"_IBX_"' as a new SPONSOR"
"RTN","IBCNSU41",27,0)
 D ^DIR K DIR
"RTN","IBCNSU41",28,0)
 I 'Y!$D(DIRUT)!$D(DIROUT)!$D(DUOUT)!$D(DTOUT) K DIRUT,DIROUT,DTOUT,DUOUT G LSP
"RTN","IBCNSU41",29,0)
 ;
"RTN","IBCNSU41",30,0)
 ; - add non-patient sponsor to file #355.82 (sponsor person file)
"RTN","IBCNSU41",31,0)
 S (X,IBNAM)=IBX,DIC(0)="L",DIC="^IBA(355.82,",DLAYGO=355.82
"RTN","IBCNSU41",32,0)
 D FILE^DICN S IBSPP=+Y K DLAYGO
"RTN","IBCNSU41",33,0)
 I IBSPP<0 W !,"Unable to add a new sponsor!" G LSPQ
"RTN","IBCNSU41",34,0)
 ;
"RTN","IBCNSU41",35,0)
 ; - now add to file #355.8 (sponsor file)
"RTN","IBCNSU41",36,0)
 S (IBSPD,X)=IBSPP_";IBA(355.82,",DIC(0)="L",DIC="^IBA(355.8,",DLAYGO=355.8
"RTN","IBCNSU41",37,0)
 D FILE^DICN S IBSP=+Y K DLAYGO
"RTN","IBCNSU41",38,0)
 I IBSP<0 W !,"Unable to add a new sponsor!" G LSPQ
"RTN","IBCNSU41",39,0)
 ;
"RTN","IBCNSU41",40,0)
LSPC ; - allow edit of non-patient sponsor name/dob/ssn
"RTN","IBCNSU41",41,0)
 I $P(IBSPD,"^")["IBA" D
"RTN","IBCNSU41",42,0)
 .S DIE="^IBA(355.82,",DA=+IBSPD
"RTN","IBCNSU41",43,0)
 .S DR=".01  NAME;.02  DATE OF BIRTH;.03  SOCIAL SECURITY NUMBER"
"RTN","IBCNSU41",44,0)
 .D ^DIE K DIE,DA,DR
"RTN","IBCNSU41",45,0)
 ;
"RTN","IBCNSU41",46,0)
 ; - edit remaining sponsor attributes
"RTN","IBCNSU41",47,0)
 S DIE="^IBA(355.8,",DA=IBSP
"RTN","IBCNSU41",48,0)
 S DR=".02  MILITARY STATUS;.03  BRANCH;.04  RANK"
"RTN","IBCNSU41",49,0)
 D ^DIE K DA,DR,DIE
"RTN","IBCNSU41",50,0)
 ;
"RTN","IBCNSU41",51,0)
 ; - find patient relation to sponsor, or create one
"RTN","IBCNSU41",52,0)
 S IBSPR=0 F  S IBSPR=$O(^IBA(355.81,"B",DFN,IBSPR)) Q:'IBSPR  I $P($G(^IBA(355.81,IBSPR,0)),"^",2)=IBSP Q
"RTN","IBCNSU41",53,0)
 I 'IBSPR S IBQQ=0 D  G:IBQQ LSPQ
"RTN","IBCNSU41",54,0)
 .W !!,"The person '",IBNAM,"' is not currently the sponsor of this patient."
"RTN","IBCNSU41",55,0)
 .S DIR(0)="Y",DIR("A")="Okay to add this person as the patient's sponsor"
"RTN","IBCNSU41",56,0)
 .S DIR("?")="Please enter 'YES' to add this person as the patient's sponsor, or 'NO' to select a new sponsor."
"RTN","IBCNSU41",57,0)
 .D ^DIR K DIR I 'Y W ! S IBQQ=1 Q
"RTN","IBCNSU41",58,0)
 .;
"RTN","IBCNSU41",59,0)
 .S X=DFN,DIC="^IBA(355.81,",DIC(0)="L",DIC("DR")=".02////"_IBSP,DLAYGO=355.81
"RTN","IBCNSU41",60,0)
 .D FILE^DICN S IBSPR=+Y S:Y<0 IBQQ=1 K DLAYGO
"RTN","IBCNSU41",61,0)
 ;
"RTN","IBCNSU41",62,0)
 ; - edit sponsor relation attributes
"RTN","IBCNSU41",63,0)
 S DIE="^IBA(355.81,",DA=IBSPR,DR=".03:.06" D ^DIE K DA,DIE,DR
"RTN","IBCNSU41",64,0)
 W !
"RTN","IBCNSU41",65,0)
 ;
"RTN","IBCNSU41",66,0)
LSPQ K IBSP,IBSPD,IBSPP,IBSPR,IBQQ,IBNAM,IBX,DIRUT,DIROUT,DTOUT,DUOUT,X,Y
"RTN","IBCNSU41",67,0)
 Q
"RTN","IBCNSU41",68,0)
 ;
"RTN","IBCNSU41",69,0)
 ;
"RTN","IBCNSU41",70,0)
 ;
"RTN","IBCNSU41",71,0)
POL(DFN) ; Update CHAMPUS policies with Sponsor information.
"RTN","IBCNSU41",72,0)
 ;  Input:   DFN  --  Pointer to the patient in file #2
"RTN","IBCNSU41",73,0)
 ;
"RTN","IBCNSU41",74,0)
 I '$G(DFN) G POLQ
"RTN","IBCNSU41",75,0)
 N IBX,IBY,SPON,X,X1,X3,Y,Z
"RTN","IBCNSU41",76,0)
 ;
"RTN","IBCNSU41",77,0)
 S X=0 F  S X=$O(^IBA(355.81,"B",DFN,X)) Q:'X  D  Q:$D(Z)
"RTN","IBCNSU41",78,0)
 .S Y=$G(^IBA(355.81,X,0))
"RTN","IBCNSU41",79,0)
 .;
"RTN","IBCNSU41",80,0)
 .; - relationship must be with a Tricare sponsor
"RTN","IBCNSU41",81,0)
 .Q:$P(Y,"^",4)'="T"
"RTN","IBCNSU41",82,0)
 .;
"RTN","IBCNSU41",83,0)
 .S SPON=$G(^IBA(355.8,+$P(Y,"^",2),0)) Q:SPON=""
"RTN","IBCNSU41",84,0)
 .;
"RTN","IBCNSU41",85,0)
 .; - if sponsor is a patient, get name/dob/SSN from the patient
"RTN","IBCNSU41",86,0)
 .;   file; otherwise, use file #355.82
"RTN","IBCNSU41",87,0)
 .I $P(SPON,"^")["DPT" D
"RTN","IBCNSU41",88,0)
 ..S X1=$G(^DPT(+SPON,0)) Q:X1=""
"RTN","IBCNSU41",89,0)
 ..S Z("NAME")=$P(X1,"^"),Z("DOB")=$P(X1,"^",3),Z("SSN")=$P(X1,"^",9)
"RTN","IBCNSU41",90,0)
 .E  D
"RTN","IBCNSU41",91,0)
 ..S X1=$G(^IBA(355.82,+SPON,0)) Q:X1=""
"RTN","IBCNSU41",92,0)
 ..S Z("NAME")=$P(X1,"^"),Z("DOB")=$P(X1,"^",2),Z("SSN")=$TR($P(X1,"^",3),"-","")
"RTN","IBCNSU41",93,0)
 .;
"RTN","IBCNSU41",94,0)
 .S Z("BRAN")=$P(SPON,"^",3),Z("RANK")=$P(SPON,"^",4)
"RTN","IBCNSU41",95,0)
 ;
"RTN","IBCNSU41",96,0)
 ; - if no Tricare sponsors were found, quit.
"RTN","IBCNSU41",97,0)
 I '$D(Z) G POLQ
"RTN","IBCNSU41",98,0)
 ;
"RTN","IBCNSU41",99,0)
 ; - update any policies with CHAMPUS plans
"RTN","IBCNSU41",100,0)
 S IBX=0 F  S IBX=$O(^DPT(DFN,.312,IBX)) Q:'IBX  S IBY=$G(^(IBX,0)) D
"RTN","IBCNSU41",101,0)
 .;
"RTN","IBCNSU41",102,0)
 .; - only consider CHAMPUS plans
"RTN","IBCNSU41",103,0)
 .Q:$P($G(^IBE(355.1,+$P($G(^IBA(355.3,+$P(IBY,"^",18),0)),"^",9),0)),"^",3)'=7
"RTN","IBCNSU41",104,0)
 .;
"RTN","IBCNSU41",105,0)
 .; - the policyholder should not be the veteran (patient)
"RTN","IBCNSU41",106,0)
 .Q:$P(IBY,"^",6)="v"
"RTN","IBCNSU41",107,0)
 .;
"RTN","IBCNSU41",108,0)
 .; - if a sponsor DOB exists, be sure it's the same as the
"RTN","IBCNSU41",109,0)
 .;   sponsor file DOB
"RTN","IBCNSU41",110,0)
 .S X3=$G(^DPT(DFN,.312,IBX,3))
"RTN","IBCNSU41",111,0)
 .I X3,+X3'=Z("DOB") Q
"RTN","IBCNSU41",112,0)
 .;
"RTN","IBCNSU41",113,0)
 .S DR=""
"RTN","IBCNSU41",114,0)
 .;IB*2*211
"RTN","IBCNSU41",115,0)
 .I $P(IBY,"^",17)="" S DR=DR_"17////"_Z("NAME")_";"
"RTN","IBCNSU41",116,0)
 .I $P(X3,"^")="",Z("DOB") S DR=DR_"3.01////"_Z("DOB")_";"
"RTN","IBCNSU41",117,0)
 .I $P(X3,"^",2)="",Z("BRAN") S DR=DR_"3.02////"_Z("BRAN")_";"
"RTN","IBCNSU41",118,0)
 .I $P(X3,"^",3)="",Z("RANK")]"" S DR=DR_"3.03////"_Z("RANK")_";"
"RTN","IBCNSU41",119,0)
 .I $P(X3,"^",5)="",Z("SSN")]"" S DR=DR_"3.05////"_Z("SSN")_";"
"RTN","IBCNSU41",120,0)
 .;
"RTN","IBCNSU41",121,0)
 .Q:DR=""
"RTN","IBCNSU41",122,0)
 .I $E(DR,$L(DR))=";" S DR=$E(DR,1,$L(DR)-1)
"RTN","IBCNSU41",123,0)
 .;
"RTN","IBCNSU41",124,0)
 .S DIE="^DPT(DFN,.312,",DA(1)=DFN,DA=IBX D ^DIE K DA,DIE,DR
"RTN","IBCNSU41",125,0)
 ;
"RTN","IBCNSU41",126,0)
POLQ Q
"RTN","IBCU3")
0^7^B23463172
"RTN","IBCU3",1,0)
IBCU3 ;ALB/AAS - BILLING UTILITY ROUTINE (CONTINUED) ; 4/4/03 8:49am
"RTN","IBCU3",2,0)
 ;;2.0;INTEGRATED BILLING;**52,80,91,106,51,137,211**;21-MAR-94
"RTN","IBCU3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCU3",4,0)
 ;
"RTN","IBCU3",5,0)
 ;MAP TO DGCRU3
"RTN","IBCU3",6,0)
SC(DFN) ; returns 1 if service connection indicated, 0 otherwise (based on VAEL(3))
"RTN","IBCU3",7,0)
 N X,VAEL,VAERR S X=0
"RTN","IBCU3",8,0)
 I +$G(DFN) D ELIG^VADPT S X=+$G(VAEL(3))
"RTN","IBCU3",9,0)
 Q X
"RTN","IBCU3",10,0)
 ;
"RTN","IBCU3",11,0)
APPT(DATE,DFN,DISP) ;Check date to see if patient has any visit data
"RTN","IBCU3",12,0)
 ;input:   DATE - required, date to check for appointments
"RTN","IBCU3",13,0)
 ;         DFN  - required, patient to check for appointments on date
"RTN","IBCU3",14,0)
 ;         DISP - if true then error message will be printed before exit, if any
"RTN","IBCU3",15,0)
 ;returns: 1 - if appt visit found
"RTN","IBCU3",16,0)
 ;         2 - if unscheduled add/edit clinic stop entry found
"RTN","IBCU3",17,0)
 ;         3 - if only disposition found
"RTN","IBCU3",18,0)
 ;         "0^error message" if no valid visit data/disposition found
"RTN","IBCU3",19,0)
 ;
"RTN","IBCU3",20,0)
 N Y,X,X1,X2 S DATE=$P(DATE,".",1),Y="0^* Patient has no Visits for this date..."
"RTN","IBCU3",21,0)
 I 'DATE!'$D(^DPT(DFN,0)) S Y="0^Unable to check for appointments on this date!" G APPTE
"RTN","IBCU3",22,0)
 N IBVAL,IBCBK,IBVTYP
"RTN","IBCU3",23,0)
 S IBVAL("DFN")=DFN,IBVAL("BDT")=DATE,IBVAL("EDT")=DATE+.9
"RTN","IBCU3",24,0)
 S IBCBK="I '$P(Y0,U,6) S IBVTYP=+$P(Y0,U,8) I $S(IBVTYP=2:1,IBVTYP=1:$$APPTCT^IBEFUNC(Y0),IBVTYP=3:$$DISCT^IBEFUNC(Y,Y0),1:0) S IBVTYP(IBVTYP)="""" S:$D(IBVTYP(1)) SDSTOP=1"
"RTN","IBCU3",25,0)
 D SCAN^IBSDU("PATIENT/DATE",.IBVAL,"",IBCBK,1) K ^TMP("DIERR",$J)
"RTN","IBCU3",26,0)
 S IBVTYP=$O(IBVTYP(0))
"RTN","IBCU3",27,0)
 S:IBVTYP Y=IBVTYP
"RTN","IBCU3",28,0)
 ;
"RTN","IBCU3",29,0)
APPTE I +$G(DISP),'Y W !,?10,*7,$P(Y,U,2)
"RTN","IBCU3",30,0)
 Q Y
"RTN","IBCU3",31,0)
 ;
"RTN","IBCU3",32,0)
BDT(DFN,DATE) ; returns primary bill defined for an event date, "" if none
"RTN","IBCU3",33,0)
 N X,Y S X="" I '$O(^DGCR(399,"C",+$G(DFN),0))!'$G(DATE) G BDTE
"RTN","IBCU3",34,0)
 S Y="",DATE=9999999-DATE F  S Y=$O(^DGCR(399,"APDT",+DFN,Y)) Q:'Y  D
"RTN","IBCU3",35,0)
 . I $O(^DGCR(399,"APDT",+DFN,Y,0))=DATE,'$P($G(^DGCR(399,Y,"S")),U,16) S X=$P($G(^DGCR(399,Y,0)),U,17) Q
"RTN","IBCU3",36,0)
BDTE Q X
"RTN","IBCU3",37,0)
 ;
"RTN","IBCU3",38,0)
BILLED(PTF) ;returns bill "IFN^^rate group" if PTF record is already associated with an uncancelled final bill
"RTN","IBCU3",39,0)
 ;returns "bill IFN ^ bill date (stm to) ^ bill rate group" if inpatients interim with no final bill, 0 otherwise
"RTN","IBCU3",40,0)
 N IFN,Y,X S Y=0 I '$D(^DGCR(399,"APTF",+$G(PTF))) G BILLEDQ
"RTN","IBCU3",41,0)
 S IFN=0 F  S IFN=$O(^DGCR(399,"APTF",PTF,IFN)) Q:'IFN  D  I +Y,'$P(Y,U,2) Q
"RTN","IBCU3",42,0)
 . S X=$G(^DGCR(399,IFN,0)) I $P(X,U,13)=7 Q  ; bill cancelled
"RTN","IBCU3",43,0)
 . S Y=IFN_"^^"_$P(X,U,7) I $P(X,U,6)=2!($P(X,U,6)=3) S Y=IFN_"^"_$P($G(^DGCR(399,IFN,"U")),U,2)_"^"_$P(X,U,7)
"RTN","IBCU3",44,0)
BILLEDQ Q Y
"RTN","IBCU3",45,0)
 ;
"RTN","IBCU3",46,0)
FTN(FT) ;returns name of the form type passed in, "" if not defined
"RTN","IBCU3",47,0)
 N X S X=$P($G(^IBE(353,+$G(FT),0)),U,1)
"RTN","IBCU3",48,0)
 Q X
"RTN","IBCU3",49,0)
 ;
"RTN","IBCU3",50,0)
FT(IFN,IBRESET) ;return the correct form type for a bill (trigger code in 399 to set .19)
"RTN","IBCU3",51,0)
 ; if IBRESET is not a positive value ('IBRESET), returns the bills current form type (if defined)
"RTN","IBCU3",52,0)
 ; if IBRESET is a positive value (+IBRESET), interpret form type according to following rules (for triggers):
"RTN","IBCU3",53,0)
 ;    first use ins co default (36,.14), then bill is inst (UB) or prof (1500) (399,.27),
"RTN","IBCU3",54,0)
 ;    then current (399,.19), then site default (350.9,1.26), then UB-92
"RTN","IBCU3",55,0)
 N X,Y,FTC,FTN,FTD,FTI,FTT,INS S X="",IFN=+$G(IFN),Y=$G(^DGCR(399,IFN,0))
"RTN","IBCU3",56,0)
 S FTC=$P(Y,U,19) I FTC=1 S FTC=3
"RTN","IBCU3",57,0)
 I '$G(IBRESET),+FTC S X=FTC G FTQ
"RTN","IBCU3",58,0)
 S FTT=$S($P(Y,U,27)=1:3,$P(Y,U,27)=2:2,1:"")
"RTN","IBCU3",59,0)
 S INS=+$G(^DGCR(399,IFN,"MP"))
"RTN","IBCU3",60,0)
 I 'INS,$$MCRWNR^IBEFUNC($$CURR^IBCEF2(IFN)) S INS=+$$CURR^IBCEF2(IFN)
"RTN","IBCU3",61,0)
 S FTI=$P($G(^DIC(36,+INS,0)),U,14),FTD=$P($G(^IBE(350.9,1,1)),U,26)
"RTN","IBCU3",62,0)
 S X=$S(+FTI:FTI,+FTT:FTT,+FTC:FTC,+FTD:FTD,1:3)
"RTN","IBCU3",63,0)
FTQ Q X
"RTN","IBCU3",64,0)
 ;
"RTN","IBCU3",65,0)
FNT(FTN) ;returns the ifn of the form type name passed in, must be exact match, 0 if none found
"RTN","IBCU3",66,0)
 N X,Y S X=0 I $G(FTN)'="" S X=$O(^IBE(353,"B",FTN,0))
"RTN","IBCU3",67,0)
 Q X
"RTN","IBCU3",68,0)
 ;
"RTN","IBCU3",69,0)
BILLDEV(IFN,PRT) ;returns the default device for a bill's form type, if PRT is passed as true then returns the AR follow up device, otherwise the billing device
"RTN","IBCU3",70,0)
 N X,Y S X=0 I $D(^DGCR(399,+$G(IFN),0)) S PRT=$S(+$G(PRT):3,1:2),Y=$$FT(IFN),X=$P($G(^IBE(353,+Y,0)),U,PRT)
"RTN","IBCU3",71,0)
 Q X
"RTN","IBCU3",72,0)
 ;
"RTN","IBCU3",73,0)
RXDUP(RX,DATE,IFN,DISP,DFN,RTG) ;returns bill ifn if rx # exists on another bill
"RTN","IBCU3",74,0)
 ;input:  rx # - required, rx # to check for
"RTN","IBCU3",75,0)
 ;        date - required, date of refill
"RTN","IBCU3",76,0)
 ;ifn, dfn, rtg are optional - if not passed then not used to specify rx
"RTN","IBCU3",77,0)
 ;(if ifn not passed then returns true if on any bill same or dfn and rtgetc.)
"RTN","IBCU3",78,0)
 ;if ifn passed the dfn and rtg do not need to be
"RTN","IBCU3",79,0)
 N X,LN,RIFN,BIFN,RLN,BLN S (RIFN,X)=0,DATE=$G(DATE),RX=$G(RX),IFN=$G(IFN) I RX=""!('DATE) G RXDUPE
"RTN","IBCU3",80,0)
 S LN=$G(^DGCR(399,+IFN,0)),DFN=$S(+$G(DFN):DFN,1:+$P(LN,U,2)),RTG=$S(+$G(RTG):RTG,1:+$P(LN,U,7))
"RTN","IBCU3",81,0)
 F  S RIFN=$O(^IBA(362.4,"B",RX,RIFN)) Q:'RIFN  S RLN=$G(^IBA(362.4,+RIFN,0)) I +DATE=+$P(RLN,U,3) D  Q:+X
"RTN","IBCU3",82,0)
 . S BIFN=+$P(RLN,U,2),BLN=$G(^DGCR(399,BIFN,0)) Q:(BLN="")!(BIFN=+$G(IFN))
"RTN","IBCU3",83,0)
 . I $P(BLN,U,13)=7 Q  ; bill cancelled
"RTN","IBCU3",84,0)
 . I +DFN,$P(BLN,U,2)'=DFN Q  ; different patient
"RTN","IBCU3",85,0)
 . I +RTG,+RTG'=$P(BLN,U,7) Q  ; different rate group
"RTN","IBCU3",86,0)
 . S X=BIFN_"^A "_$P($G(^DGCR(399.3,+$P(BLN,U,7),0)),U,1)_" bill ("_$P(BLN,U,1)_") exists for Rx # "_RX_" and refill date "_$$DAT1^IBOUTL(DATE)_"."
"RTN","IBCU3",87,0)
RXDUPE I +$G(DISP),+X W !,?10,$P(X,U,2)
"RTN","IBCU3",88,0)
 Q X
"RTN","IBCU3",89,0)
 ;
"RTN","IBCU3",90,0)
BCOB(IBIFN,IBCOB) ; returns an array of all bills related COB to the bill passed in
"RTN","IBCU3",91,0)
 ; includes prior bills defined on this bill then checks the Primary, Secondary and Tertiary Bills and adds
"RTN","IBCU3",92,0)
 ; all the prior bills defined on them
"RTN","IBCU3",93,0)
 ; ARR(BILL SEQUENCE (1,2,3), INSURANCE CO, BILL #)=""
"RTN","IBCU3",94,0)
 ;
"RTN","IBCU3",95,0)
 N IBM1,IBI,IBIFN1,IBM,IBM11,IBSEQ,IBSEQN,IBJ K IBCOB
"RTN","IBCU3",96,0)
 S IBM1=$G(^DGCR(399,IBIFN,"M1"))
"RTN","IBCU3",97,0)
 F IBI=IBIFN,+$P(IBM1,U,5),+$P(IBM1,U,6),+$P(IBM1,U,7) I +IBI S IBIFN1=+IBI D
"RTN","IBCU3",98,0)
 . ;
"RTN","IBCU3",99,0)
 . S IBM=$G(^DGCR(399,IBIFN1,"M")),IBM11=$G(^DGCR(399,IBIFN1,"M1")) I IBIFN=IBIFN1,'$P(IBM,U,2),'$P(IBM,U,3) Q
"RTN","IBCU3",100,0)
 . S IBSEQ=$P($G(^DGCR(399,IBIFN1,0)),U,21),IBSEQN=$S(IBSEQ="P":1,IBSEQ="S":2,IBSEQ="T":3,1:"") Q:'IBSEQN
"RTN","IBCU3",101,0)
 . ;
"RTN","IBCU3",102,0)
 . F IBJ=1:1:3 I +$P(IBM,U,IBJ) S IBCOB(IBJ,+$P(IBM,U,IBJ),+$P(IBM11,U,(IBJ+4)))=""
"RTN","IBCU3",103,0)
 . I +$P(IBM,U,IBSEQN) S IBCOB(IBSEQN,$P(IBM,U,IBSEQN),+IBIFN1)=""
"RTN","IBCU3",104,0)
 ;
"RTN","IBCU3",105,0)
 S IBI=0 F  S IBI=$O(IBCOB(IBI)) Q:'IBI  S IBJ=0 F  S IBJ=$O(IBCOB(IBI,IBJ)) Q:'IBJ  I +$O(IBCOB(IBI,IBJ,0)) K IBCOB(IBI,IBJ,0)
"RTN","IBCU3",106,0)
 Q
"RTN","IBCU3",107,0)
 ;
"RTN","IBCU3",108,0)
BINS(IBIFN) ; return list of billable insurance carriers on a bill (COB)
"RTN","IBCU3",109,0)
 ; output:  sequence:carrier:policy ^ sequence:carrier:policy ^ sequence:carrier:policy
"RTN","IBCU3",110,0)
 N IBM0,IBI,IBS,IBC,IBP,IBX S IBI=0,IBX="",IBM0=$G(^DGCR(399,+$G(IBIFN),"M"))
"RTN","IBCU3",111,0)
 F IBS="P","S","T" S IBI=IBI+1,IBC=+$P(IBM0,U,IBI) I +IBC D
"RTN","IBCU3",112,0)
 . S IBP=+$P(IBM0,U,(11+IBI)) I $P($G(^DIC(36,+IBC,0)),U,2)'="N" S IBX=IBX_IBS_":"_IBC_":"_IBP_U
"RTN","IBCU3",113,0)
 Q IBX
"RTN","IBCU3",114,0)
 ;
"RTN","IBJTU2")
0^5^B6821930
"RTN","IBJTU2",1,0)
IBJTU2 ;ALB/ARH - TPI UTILITIES ; 6/6/03 1:05pm
"RTN","IBJTU2",2,0)
 ;;2.0;INTEGRATED BILLING;**39,106,199,211**;21-MAR-94
"RTN","IBJTU2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBJTU2",4,0)
 ;
"RTN","IBJTU2",5,0)
PAT() ; select patient, only allows patient's that have bills - returns DFN^NAME if patient selected, 0 otherwise
"RTN","IBJTU2",6,0)
 N X,Y,DFN,DTOUT,DUOUT,DA
"RTN","IBJTU2",7,0)
 N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBJTU2",8,0)
 S DFN=0,DIC(0)="AEQM",DIC="^DPT(",DIC("S")="I $D(^DGCR(399,""C"",Y))" D ^DIC K DIC I Y'<1 S DFN=Y
"RTN","IBJTU2",9,0)
 Q DFN
"RTN","IBJTU2",10,0)
 ;
"RTN","IBJTU2",11,0)
BILL() ; select bill, returns bill IFN^BILL NUMBER or 0 if none selected
"RTN","IBJTU2",12,0)
 N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBJTU2",13,0)
 N X,Y,DTOUT,DUOUT,DA,IBY S IBY=0,DIC="^DGCR(399,",DIC(0)="AEMQ" D ^DIC K DIC I Y'<1 S IBY=Y
"RTN","IBJTU2",14,0)
 Q IBY
"RTN","IBJTU2",15,0)
 ;
"RTN","IBJTU2",16,0)
PB() ; select either a patient name (must have a bill) or bill number
"RTN","IBJTU2",17,0)
 ; if patient chosen: returns "1^"_DFN, if bill chosen: returns "2^"_IBIFN, 0 otherwise
"RTN","IBJTU2",18,0)
 N IBX,IBY,DIC,DTOUT,DUOUT,DA,X,Y S IBY=0
"RTN","IBJTU2",19,0)
 ;
"RTN","IBJTU2",20,0)
PB1 R !!,"Enter BILL NUMBER or PATIENT NAME: ",IBX:DTIME I IBX["^"!(IBX="") G PBQ
"RTN","IBJTU2",21,0)
 ;
"RTN","IBJTU2",22,0)
 ; search for patient name
"RTN","IBJTU2",23,0)
 I IBX?1A4N!(IBX?2A.AP)!(IBX?2.A1",".AP)!(IBX?1A1P.AP) D  I +IBY G PBQ
"RTN","IBJTU2",24,0)
 . N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBJTU2",25,0)
 . S DIC="^DPT(",DIC(0)="EQM",DIC("S")="I $D(^DGCR(399,""C"",Y))",X=IBX D ^DIC K DIC I Y'<1 S IBY="1^"_+Y
"RTN","IBJTU2",26,0)
 ;
"RTN","IBJTU2",27,0)
 ; search for bill number
"RTN","IBJTU2",28,0)
 N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBJTU2",29,0)
 S DIC="^DGCR(399,",DIC(0)="EQ",X=IBX D ^DIC K DIC I Y'<1 S IBY="2^"_+Y G PBQ
"RTN","IBJTU2",30,0)
 ;
"RTN","IBJTU2",31,0)
 G PB1
"RTN","IBJTU2",32,0)
PBQ Q IBY
"RTN","IBJTU2",33,0)
 ;
"RTN","IBJTU2",34,0)
RCANC(IBIFN,ARR,WDTH) ; if bill cancelled returns ARR = IBIFN ^ PTR TO 200 ^ INITIALS OF WHO CANCELLED IN IB
"RTN","IBJTU2",35,0)
 ;                                        ARR(X) = REASON CANCELLED   with line width passed in
"RTN","IBJTU2",36,0)
 N X,DIWL,DIWR,DIWF,IBDS,IBCNT,IBI,IBD K ARR
"RTN","IBJTU2",37,0)
 S ARR=0,IBIFN=+$G(IBIFN),IBDS=$G(^DGCR(399,IBIFN,"S"))
"RTN","IBJTU2",38,0)
 S X=$P(IBDS,U,18) G:'X RCANCQ
"RTN","IBJTU2",39,0)
 S ARR=IBIFN_U_X_U_$P($G(^VA(200,+X,0)),U,2)
"RTN","IBJTU2",40,0)
 S X=$P(IBDS,U,19) G:X="" RCANCQ
"RTN","IBJTU2",41,0)
 S DIWL=1,DIWR=$G(WDTH),DIWF="" D ^DIWP
"RTN","IBJTU2",42,0)
 S (IBCNT,IBI)=0,DIWL=1 F  S IBI=$O(^UTILITY($J,"W",DIWL,IBI)) Q:'IBI  D
"RTN","IBJTU2",43,0)
 . S IBD=$G(^UTILITY($J,"W",DIWL,IBI,0)) I IBD'="" S IBCNT=IBCNT+1,ARR(IBCNT)=IBD
"RTN","IBJTU2",44,0)
 K ^UTILITY($J,"W")
"RTN","IBJTU2",45,0)
RCANCQ Q
"RTN","IBJTU2",46,0)
 ;
"RTN","IBJTU2",47,0)
DR(DB,DE) ; get a date range from the user, DB is default begin date (FM), DE is default end date
"RTN","IBJTU2",48,0)
 ; returns "begin dt ^ end dt" in FM format, or "" if two valid dates are not entered
"RTN","IBJTU2",49,0)
 N IBY,IBX,%DT,X,Y S (IBX,IBY)="" I $G(DB)?7N S %DT("B")=$$FMTE^XLFDT(DB,2)
"RTN","IBJTU2",50,0)
 S %DT="AEX",%DT("A")="Start Date: " D ^%DT K %DT G:Y<0 DRQ S IBX=Y
"RTN","IBJTU2",51,0)
 S %DT(0)=IBX,%DT("B")=$$FMTE^XLFDT($S(IBX>$G(DE):IBX,1:DE),2)
"RTN","IBJTU2",52,0)
 S %DT="AEX",%DT("A")="End Date: " D ^%DT K %DT G:Y<0 DRQ S IBY=IBX_U_Y
"RTN","IBJTU2",53,0)
DRQ Q IBY
"VER")
8.0^22
**END**
**END**
