Released SD*5.3*291 SEQ #262
Extracted from mail message
**KIDS**:SD*5.3*291^

**INSTALL NAME**
SD*5.3*291
"BLD",4753,0)
SD*5.3*291^SCHEDULING^0^3030708^y
"BLD",4753,1,0)
^^7^7^3030708^^^^
"BLD",4753,1,1,0)
1. A new report may be generated for selected patients from a list of 
"BLD",4753,1,2,0)
patients entered by their names or SSN. That option was added to the 
"BLD",4753,1,3,0)
existing process of generating reports.
"BLD",4753,1,4,0)
2. The Summary option was modified to allow the user to specify which Stop 
"BLD",4753,1,5,0)
Code Pair to include. This modification permits print selection to be limited
"BLD",4753,1,6,0)
to the clinic with the selected stop code pair.
"BLD",4753,1,7,0)

"BLD",4753,4,0)
^9.64PA^^
"BLD",4753,"KRN",0)
^9.67PA^8989.52^19
"BLD",4753,"KRN",.4,0)
.4
"BLD",4753,"KRN",.401,0)
.401
"BLD",4753,"KRN",.402,0)
.402
"BLD",4753,"KRN",.403,0)
.403
"BLD",4753,"KRN",.5,0)
.5
"BLD",4753,"KRN",.84,0)
.84
"BLD",4753,"KRN",3.6,0)
3.6
"BLD",4753,"KRN",3.8,0)
3.8
"BLD",4753,"KRN",9.2,0)
9.2
"BLD",4753,"KRN",9.8,0)
9.8
"BLD",4753,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",4753,"KRN",9.8,"NM",1,0)
SCRPW70^^0^B73959817
"BLD",4753,"KRN",9.8,"NM",2,0)
SCRPW72^^0^B70340948
"BLD",4753,"KRN",9.8,"NM",3,0)
SCRPW73^^0^B73698455
"BLD",4753,"KRN",9.8,"NM",4,0)
SCRPW75^^0^B47499168
"BLD",4753,"KRN",9.8,"NM",5,0)
SCRPW76^^0^B75489890
"BLD",4753,"KRN",9.8,"NM",6,0)
SCRPW77^^0^B100471899
"BLD",4753,"KRN",9.8,"NM",7,0)
SCRPW78^^0^B18943883
"BLD",4753,"KRN",9.8,"NM",8,0)
SCRPW74^^0^B43863725
"BLD",4753,"KRN",9.8,"NM","B","SCRPW70",1)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW72",2)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW73",3)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW74",8)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW75",4)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW76",5)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW77",6)

"BLD",4753,"KRN",9.8,"NM","B","SCRPW78",7)

"BLD",4753,"KRN",19,0)
19
"BLD",4753,"KRN",19.1,0)
19.1
"BLD",4753,"KRN",101,0)
101
"BLD",4753,"KRN",409.61,0)
409.61
"BLD",4753,"KRN",771,0)
771
"BLD",4753,"KRN",870,0)
870
"BLD",4753,"KRN",8989.51,0)
8989.51
"BLD",4753,"KRN",8989.52,0)
8989.52
"BLD",4753,"KRN",8994,0)
8994
"BLD",4753,"KRN","B",.4,.4)

"BLD",4753,"KRN","B",.401,.401)

"BLD",4753,"KRN","B",.402,.402)

"BLD",4753,"KRN","B",.403,.403)

"BLD",4753,"KRN","B",.5,.5)

"BLD",4753,"KRN","B",.84,.84)

"BLD",4753,"KRN","B",3.6,3.6)

"BLD",4753,"KRN","B",3.8,3.8)

"BLD",4753,"KRN","B",9.2,9.2)

"BLD",4753,"KRN","B",9.8,9.8)

"BLD",4753,"KRN","B",19,19)

"BLD",4753,"KRN","B",19.1,19.1)

"BLD",4753,"KRN","B",101,101)

"BLD",4753,"KRN","B",409.61,409.61)

"BLD",4753,"KRN","B",771,771)

"BLD",4753,"KRN","B",870,870)

"BLD",4753,"KRN","B",8989.51,8989.51)

"BLD",4753,"KRN","B",8989.52,8989.52)

"BLD",4753,"KRN","B",8994,8994)

"BLD",4753,"QUES",0)
^9.62^^
"BLD",4753,"REQB",0)
^9.611^1^1
"BLD",4753,"REQB",1,0)
SD*5.3*249^2
"BLD",4753,"REQB","B","SD*5.3*249",1)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
291^3030708^100892
"PKG",16,22,1,"PAH",1,1,0)
^^7^7^3030708
"PKG",16,22,1,"PAH",1,1,1,0)
1. A new report may be generated for selected patients from a list of 
"PKG",16,22,1,"PAH",1,1,2,0)
patients entered by their names or SSN. That option was added to the 
"PKG",16,22,1,"PAH",1,1,3,0)
existing process of generating reports.
"PKG",16,22,1,"PAH",1,1,4,0)
2. The Summary option was modified to allow the user to specify which Stop 
"PKG",16,22,1,"PAH",1,1,5,0)
Code Pair to include. This modification permits print selection to be limited
"PKG",16,22,1,"PAH",1,1,6,0)
to the clinic with the selected stop code pair.
"PKG",16,22,1,"PAH",1,1,7,0)

"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","SCRPW70")
0^1^B73959817
"RTN","SCRPW70",1,0)
SCRPW70 ;BP-CIOFO/KEITH,ESW - Clinic appointment availability extract ; 7/8/03 2:23pm
"RTN","SCRPW70",2,0)
 ;;5.3;Scheduling;**192,206,223,241,249,291**;AUG 13, 1993
"RTN","SCRPW70",3,0)
 N SDEX,SDDIV,DIR,SDFMT,SDFMTS,SDMAX,SDSORT,SDOUT,X,Y,DTOUT,DUOUT
"RTN","SCRPW70",4,0)
 N SDREPORT,SDEDT,SDBDT,SDPEDT,SDPBDT,SDPAT,SDPT,SDJN
"RTN","SCRPW70",5,0)
 S SDJN=$J
"RTN","SCRPW70",6,0)
 S (SDEX,SDOUT)=0
"RTN","SCRPW70",7,0)
 D TITL^SCRPW50("Clinic Appointment Availability Report")
"RTN","SCRPW70",8,0)
 I '$$DIVA^SCRPW17(.SDDIV) S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",9,0)
 D SUBT^SCRPW50("**** Date Range Selection ****")
"RTN","SCRPW70",10,0)
 W ! S %DT="AEX",%DT("A")="Beginning date: " D ^%DT I Y<1 S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",11,0)
 S SDBDT=Y X ^DD("DD") S SDPBDT=Y
"RTN","SCRPW70",12,0)
EDT S %DT("A")="   Ending date: " W ! D ^%DT I Y<1 S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",13,0)
 I Y<SDBDT W !!,$C(7),"End date cannot be before begin date!",! G EDT
"RTN","SCRPW70",14,0)
 S SDEDT=Y_.999999 X ^DD("DD") S SDPEDT=Y
"RTN","SCRPW70",15,0)
 S SDMAX=Y D SUBT^SCRPW50("**** Report Format Selection ***")
"RTN","SCRPW70",16,0)
 S DIR(0)="S^S:SUMMARY FOR DATE RANGE;D:DETAIL BY DAY",DIR("A")="Select report format"
"RTN","SCRPW70",17,0)
 W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",18,0)
 S SDFMT=Y G:SDFMT="S" REN
"RTN","SCRPW70",19,0)
 ;clarification that you may skip entry for a patient
"RTN","SCRPW70",20,0)
 W !!?3,"To generate a detailed report by stop code pair or clinic,"
"RTN","SCRPW70",21,0)
 W !?3,"press 'enter' without inputting a patient name.",!
"RTN","SCRPW70",22,0)
 S SDPAT=0
"RTN","SCRPW70",23,0)
 K ^TMP("SDPAT",SDJN)
"RTN","SCRPW70",24,0)
 D SELECT^SCRPW78(SDJN,.SDPAT) ;select patient(s)
"RTN","SCRPW70",25,0)
 S DIR("B")="CLINIC NAME"
"RTN","SCRPW70",26,0)
 S DIR(0)="S^CL:CLINIC NAME;CP:CREDIT PAIR",DIR("A")="Specify limiting category for detail"
"RTN","SCRPW70",27,0)
 I $G(SDPAT) S DIR("B")="CLINIC ALL",DIR(0)="S^CA:CLINIC ALL;CL:CLINIC NAME;CP:CREDIT PAIR"
"RTN","SCRPW70",28,0)
 S DIR("?")="Indicate if availability should be limited by clinic name or DSS credit pair."
"RTN","SCRPW70",29,0)
 W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",30,0)
 S SDSORT=Y I '$$SORT^SCRPW72(.SDSORT) S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",31,0)
 G:SDOUT EXIT^SCRPW74
"RTN","SCRPW70",32,0)
 I SDBDT>DT S SDREPORT(1)=1 G QUE
"RTN","SCRPW70",33,0)
 G RENS
"RTN","SCRPW70",34,0)
REN I SDBDT>DT S SDREPORT(1)=1 G QUE
"RTN","SCRPW70",35,0)
 S DIR(0)="S^CL:ALL CLINICS;CP:CREDIT PAIR SELECTION",DIR("A")="Specify if all clinics or selected clinics by credit pair"
"RTN","SCRPW70",36,0)
 S DIR("?")="Indicate if availability should include All clinics or clinics selected by DSS credit pair only."
"RTN","SCRPW70",37,0)
 W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",38,0)
 S SDFMTS=Y I SDFMTS="CP" D  G:SDOUT EXIT^SCRPW74
"RTN","SCRPW70",39,0)
 .S SDSORT=Y I '$$SORT^SCRPW72(.SDSORT) S SDOUT=1
"RTN","SCRPW70",40,0)
 G:SDOUT EXIT^SCRPW74
"RTN","SCRPW70",41,0)
RENS D SUBT^SCRPW50("**** Report Output Section Selection ****")
"RTN","SCRPW70",42,0)
ROSS S DIR(0)="Y",DIR("B")="YES"
"RTN","SCRPW70",43,0)
 N II F II=1:1:5 S SDREPORT(II)=0
"RTN","SCRPW70",44,0)
 I '$G(SDPAT) D
"RTN","SCRPW70",45,0)
 .S DIR("A")="Include 'next available' appointment statistics"
"RTN","SCRPW70",46,0)
 .W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 D EXIT^SCRPW74 Q
"RTN","SCRPW70",47,0)
 .S SDREPORT(1)=Y
"RTN","SCRPW70",48,0)
 .S DIR("A")="Include 'follow up' appointment statistics"
"RTN","SCRPW70",49,0)
 .W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 D EXIT^SCRPW74 Q
"RTN","SCRPW70",50,0)
 .S SDREPORT(2)=Y
"RTN","SCRPW70",51,0)
 .S DIR("A")="Include 'non-follow up' appointment statistics"
"RTN","SCRPW70",52,0)
 .W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 D EXIT^SCRPW74 Q
"RTN","SCRPW70",53,0)
 .S SDREPORT(3)=Y
"RTN","SCRPW70",54,0)
 .I SDFMT="D" D
"RTN","SCRPW70",55,0)
 ..S DIR("A")="Include list of patient appointments"
"RTN","SCRPW70",56,0)
 ..W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 D EXIT^SCRPW74 Q
"RTN","SCRPW70",57,0)
 ..S SDREPORT(4)=Y
"RTN","SCRPW70",58,0)
 I $G(SDPAT) D
"RTN","SCRPW70",59,0)
 .S DIR("?")="Accept to print report for selected patient(s) or exit"
"RTN","SCRPW70",60,0)
 .S DIR("A")="Print individual patient report" D
"RTN","SCRPW70",61,0)
 .W ! D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 D EXIT^SCRPW74 Q
"RTN","SCRPW70",62,0)
 .S SDREPORT(5)=Y
"RTN","SCRPW70",63,0)
 I '$D(SDREPORT) S SDOUT=1 D EXIT^SCRPW74 Q
"RTN","SCRPW70",64,0)
 I 'SDREPORT(1),'SDREPORT(2),'SDREPORT(3),'SDREPORT(4),'SDREPORT(5) D  G ROSS
"RTN","SCRPW70",65,0)
 .W $C(7),!!,"No output elements selected--at least one must be selected to continue..."
"RTN","SCRPW70",66,0)
QUE I SDBDT'>DT W !!,"This report requires 132 column output!"
"RTN","SCRPW70",67,0)
 N ZTSAVE F X="SDREPORT(","SDEX","SDBDT","SDPBDT","SDEDT","SDPEDT","SDDIV","SDDIV(","SDFMT","SDFMTS","SDSORT","SDSORT(","SDPAT","SDJN","^TMP(""SDPAT""," S ZTSAVE(X)=""
"RTN","SCRPW70",68,0)
 W ! D EN^XUTMDEVQ("START^SCRPW72","Clinic Appointment Availability Report",.ZTSAVE) S SDOUT=1 G EXIT^SCRPW74
"RTN","SCRPW70",69,0)
 ;
"RTN","SCRPW70",70,0)
RESEND ;Entry point for manually initiating extracts for the current month
"RTN","SCRPW70",71,0)
 N DIR,SDXTMP,SDMON,SDI,SDT,DTOUT,DUOUT
"RTN","SCRPW70",72,0)
 W !!,$C(7),"NOTE:  Use of this utility will result in the transmission of extract data to"
"RTN","SCRPW70",73,0)
 W !,"Austin.  It should only be used if automatically queued extracts failed to run."
"RTN","SCRPW70",74,0)
 M SDXTMP=^XTMP("SD53P192") D QDIS^SCRPW74(.SDXTMP)
"RTN","SCRPW70",75,0)
 F SDI=1,2 I $G(SDXTMP("EXTRACT",SDI,"DATE"))<DT D  Q:$D(DTOUT)!$D(DUOUT)
"RTN","SCRPW70",76,0)
 .W !!,"Extract ",SDI," doesn't appear to be tasked to run repetitively in the future."
"RTN","SCRPW70",77,0)
 .S DIR(0)="Y",DIR("A")="Do you wish to schedule it now",DIR("B")="YES"
"RTN","SCRPW70",78,0)
 .W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)  D:Y RQUE(SDI)
"RTN","SCRPW70",79,0)
 Q:$D(DTOUT)!$D(DUOUT)
"RTN","SCRPW70",80,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","SCRPW70",81,0)
 F SDI=1,2 D  Q:$D(DTOUT)!$D(DUOUT)
"RTN","SCRPW70",82,0)
 .S SDT=DT S:SDI=1 SDT=$S($E(SDT,4,5)="01":$E(SDT,1,3)-1_12_$E(SDT,6,7),1:$E(SDT,1,5)-1_$E(SDT,6,7))
"RTN","SCRPW70",83,0)
 .S DIR("A")="Do you want transmit Extract "_SDI_" for "_$P($$MON^SCRPW74(SDI,SDT,.SDMON),U)_" to Austin"
"RTN","SCRPW70",84,0)
 .W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)  D:Y QUEUE(.SDMON)
"RTN","SCRPW70",85,0)
 Q
"RTN","SCRPW70",86,0)
REQUE ;Entry point for initiating repetitive tasking of extracts
"RTN","SCRPW70",87,0)
 N DIR,SDXTMP,DTOUT,DUOUT
"RTN","SCRPW70",88,0)
 M SDXTMP=^XTMP("SD53P192") D QDIS^SCRPW74(.SDXTMP)
"RTN","SCRPW70",89,0)
 I '$D(SDXTMP) D  W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)  I Y D RQUE("B") Q
"RTN","SCRPW70",90,0)
 .S DIR(0)="Y",DIR("A")="Do you want to schedule both extracts now"
"RTN","SCRPW70",91,0)
 .S DIR("B")="YES"
"RTN","SCRPW70",92,0)
 Q:$D(DTOUT)!$D(DUOUT)  K DIR
"RTN","SCRPW70",93,0)
 S DIR(0)="S^1:EXTRACT 1 (PROSPECTIVE);2:EXTRACT 2 (RETROSPECTIVE);B:BOTH EXTRACTS"
"RTN","SCRPW70",94,0)
 S DIR("?",1)="Extract 1 returns future clinic availability, extract 2 returns previous",DIR("?")="clinic availability and utilization."
"RTN","SCRPW70",95,0)
 S DIR("A")="Specify which extract you wish to schedule"
"RTN","SCRPW70",96,0)
 W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)  D RQUE(Y)
"RTN","SCRPW70",97,0)
 Q
"RTN","SCRPW70",98,0)
RQUE(SDEX) ;Schedule extract for repetitive run
"RTN","SCRPW70",99,0)
 ;Input: SDEX=extract type, '1', '2' or 'B' for both
"RTN","SCRPW70",100,0)
 I SDEX="B" D RQUE(1) Q:$D(DTOUT)!$D(DUOUT)  D RQUE(2) Q
"RTN","SCRPW70",101,0)
 N SDMON,SDNOW,SDOUT,DIR,Y,SDT
"RTN","SCRPW70",102,0)
 S SDNOW=$$NOW^XLFDT(),SDOUT=0,Y=$G(SDXTMP("EXTRACT",SDEX,"DATE"))
"RTN","SCRPW70",103,0)
 I Y>SDNOW D  Q:$D(DTOUT)!$D(DUOUT)  Q:SDOUT
"RTN","SCRPW70",104,0)
 .W !!,"Extract ",SDEX," appears to be queued for the future--"
"RTN","SCRPW70",105,0)
 .X ^DD("DD") W !!,"Scheduled for: ",Y,", task number: ",$G(SDXTMP("EXTRACT",SDEX,"TASK"))
"RTN","SCRPW70",106,0)
 .S DIR(0)="Y",DIR("B")="NO"
"RTN","SCRPW70",107,0)
 .S DIR("A")="Do you want to delete this task and re-schedule extract "_SDEX
"RTN","SCRPW70",108,0)
 .W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)  S SDOUT='Y
"RTN","SCRPW70",109,0)
 .Q:'Y  S ZTSK=$G(SDXTMP("EXTRACT",SDEX,"TASK")) D KILL^%ZTLOAD
"RTN","SCRPW70",110,0)
 .K ^XTMP("SD53P192","EXTRACT",SDEX) Q
"RTN","SCRPW70",111,0)
 S SDT=$$WHEN^SCRPW74(SDEX),SDRPT=$$MON^SCRPW74(SDEX,SDT,.SDMON)
"RTN","SCRPW70",112,0)
 D SCHED^SCRPW74(SDEX,SDT,SDRPT,.SDMON) Q
"RTN","SCRPW70",113,0)
QUEUE(SDMON) ;Queue extraction for re-run
"RTN","SCRPW70",114,0)
 ;Input: SDMON=array of input parameters (as described in MON^SCRPW74)
"RTN","SCRPW70",115,0)
 N %DT,SDI,Y,ZTSK,ZTRTN,ZTDESC,ZTDTH,ZTIO,ZTSAVE
"RTN","SCRPW70",116,0)
 S Y=DT_.22 X ^DD("DD") S %DT("B")=Y,%DT("A")="Queue to run: "
"RTN","SCRPW70",117,0)
 S %DT="AEFXR" W ! D ^%DT I Y<1 G QQ
"RTN","SCRPW70",118,0)
 S ZTDTH=Y,ZTSAVE("SDMON(")="",ZTRTN="RUN^SCRPW74(0)",ZTIO=""
"RTN","SCRPW70",119,0)
 S ZTDESC="Clinic Appointment Wait Time Extract ("_SDMON("SDEX")_")"
"RTN","SCRPW70",120,0)
 F SDI=1:1:20 D ^%ZTLOAD Q:$G(ZTSK)
"RTN","SCRPW70",121,0)
QQ I '$G(ZTSK) W !!,"Extract not queued!!!",! Q
"RTN","SCRPW70",122,0)
 W !!,"Task number: ",ZTSK,! Q
"RTN","SCRPW70",123,0)
TXXM ;Transmit extract data
"RTN","SCRPW70",124,0)
 N SDFAC,SDL,SDIV,SDCP,SC,SDI,SDX,SDEX,SDY,SDZ,SDP,SDSIZE,SDMG,SDMGM
"RTN","SCRPW70",125,0)
 S SDFAC=$P($$SITE^VASITE(),U,3),SDXM=1,SDL=0,SDIV="",SDSIZE=0
"RTN","SCRPW70",126,0)
 S SDEX=$S(SDPAST:2,1:1)
"RTN","SCRPW70",127,0)
 S SDMG=$P($G(^SD(404.91,1,"PATCH192")),U,(6+SDEX))
"RTN","SCRPW70",128,0)
 S:SDMG="" SDMG="G.SC CLINIC WAIT TIME"
"RTN","SCRPW70",129,0)
 ;Set up monitoring mail group
"RTN","SCRPW70",130,0)
 S SDMGM="SC CWT EXTRACT MONITOR"
"RTN","SCRPW70",131,0)
 S:'$$GOTLOCAL^XMXAPIG(SDMGM) SDMGM=""
"RTN","SCRPW70",132,0)
 F  S SDIV=$O(^TMP("SD",$J,SDIV)) Q:SDIV=""  S SDCP=0 D
"RTN","SCRPW70",133,0)
 .F  S SDCP=$O(^TMP("SD",$J,SDIV,SDCP)) Q:'SDCP  S SC=0 D
"RTN","SCRPW70",134,0)
 ..F  S SC=$O(^TMP("SD",$J,SDIV,SDCP,SC)) Q:'SC  D
"RTN","SCRPW70",135,0)
 ...I SDSIZE>29000 D EXXM(SDMG,SDMGM)  ;Transmit message if >29K
"RTN","SCRPW70",136,0)
 ...;Build record leader string
"RTN","SCRPW70",137,0)
 ...;Reporting facility, extract date, extract type
"RTN","SCRPW70",138,0)
 ...S SDX="#"_SDFAC_U_SDEXDT_U_SDEX
"RTN","SCRPW70",139,0)
 ...;Format version--NOTE: THIS NUMBER MUST INCREMENTED IF THE EXTRACT
"RTN","SCRPW70",140,0)
 ...;FORMAT IS MODIFIED (e.g. existing number + 1).  Refer to patch
"RTN","SCRPW70",141,0)
 ...;SD*5.3*249 documentation for additional information.
"RTN","SCRPW70",142,0)
 ...S SDX=SDX_"~5"
"RTN","SCRPW70",143,0)
 ...;Report begin date, division, credit pair
"RTN","SCRPW70",144,0)
 ...S SDX=SDX_U_SDBDT_U_$P(SDIV,U,2)_U_SDCP_U
"RTN","SCRPW70",145,0)
 ...;Clinic ifn and name
"RTN","SCRPW70",146,0)
 ...S SDX=SDX_SC_"~"_$$CNAME^SCRPW72(SC)_"~"
"RTN","SCRPW70",147,0)
 ...;Maximum days for future booking
"RTN","SCRPW70",148,0)
 ...S SDX=SDX_+$P($G(^SC(SC,"SDP")),U,2)_U
"RTN","SCRPW70",149,0)
 ...;Build clinic statistics string
"RTN","SCRPW70",150,0)
 ...S SDI="" F  S SDI=$O(^TMP("SD",$J,SDIV,SDCP,SC,SDI)) Q:SDI=""  D
"RTN","SCRPW70",151,0)
 ....S SDY=^TMP("SD",$J,SDIV,SDCP,SC,SDI) Q:'$L(SDY)
"RTN","SCRPW70",152,0)
 ....F SDP=1:1 S SDZ=$P(SDY,U,SDP) Q:SDZ=""  D
"RTN","SCRPW70",153,0)
 .....I $L(SDX)>220 D XMTX(SDX) S SDX=""
"RTN","SCRPW70",154,0)
 .....S SDX=SDX_$S($E(SDX,$L(SDX))=U:"",1:"|")_SDZ
"RTN","SCRPW70",155,0)
 ...I SDEX=1 S SDX=SDX_"$" D XMTX(SDX) Q
"RTN","SCRPW70",156,0)
 ...S SDY=$G(^TMP("SDNAVA",$J,SDIV,SDCP,SC))  ;get next ava. info.
"RTN","SCRPW70",157,0)
 ...S SDZ=$G(^TMP("SDNAVB",$J,SDIV,SDCP,SC))  ;get additional data
"RTN","SCRPW70",158,0)
 ...S SDY=$$NAVA(SDY) D  S SDX=SDX_SDY,SDY=$$ADDL^SCRPW72(SDZ) D
"RTN","SCRPW70",159,0)
 ....I $L(SDX)+$L(SDY)>240 D
"RTN","SCRPW70",160,0)
 .....S SDI=$L(SDX),SDX=SDX_$E(SDY,1,(240-SDI)),SDY=$E(SDY,(241-SDI),999)
"RTN","SCRPW70",161,0)
 .....D XMTX(SDX) S SDX=""
"RTN","SCRPW70",162,0)
 ...S SDX=SDX_SDY_"$" D XMTX(SDX)
"RTN","SCRPW70",163,0)
 D:$D(^TMP("SDXM",$J)) EXXM(SDMG,SDMGM)
"RTN","SCRPW70",164,0)
 Q
"RTN","SCRPW70",165,0)
EXXM(XMG,SDMGM) ;Send extract mail message
"RTN","SCRPW70",166,0)
 ;Input: XMG=mail group to receive message
"RTN","SCRPW70",167,0)
 ;Input: SDMGM=extract monitoring mail group (optional)
"RTN","SCRPW70",168,0)
 N XMSUB,XMDUZ,XMDUN,XMTEXT,XMY,XMZ
"RTN","SCRPW70",169,0)
 S XMSUB="Clinic Appointment Waiting Time Extract ("_SDEX_")"
"RTN","SCRPW70",170,0)
 S (XMDUZ,XMDUN)="Patch SD*5.3*192/Task "_$G(ZTSK)
"RTN","SCRPW70",171,0)
 S XMTEXT="^TMP(""SDXM"",$J,"
"RTN","SCRPW70",172,0)
 S XMY(XMG)="" S:$L($G(SDMGM)) XMY("G."_SDMGM)=""
"RTN","SCRPW70",173,0)
 D ^XMD
"RTN","SCRPW70",174,0)
 K ^TMP("SDXM",$J) S SDXM=1,SDSIZE=0
"RTN","SCRPW70",175,0)
 Q
"RTN","SCRPW70",176,0)
XMTX(SDX) ;Set mail message line
"RTN","SCRPW70",177,0)
 ;Input: SDX=text value
"RTN","SCRPW70",178,0)
 S ^TMP("SDXM",$J,SDXM)=SDX,SDXM=SDXM+1,SDSIZE=SDSIZE+$L(SDX)
"RTN","SCRPW70",179,0)
 Q
"RTN","SCRPW70",180,0)
NAVA(SDY) ;Format next available appointment information
"RTN","SCRPW70",181,0)
 ;Input: SDY=next ava. numbers from ^TMP("SDNAVA",$J,SDCP,SC)
"RTN","SCRPW70",182,0)
 N SDI,SDX
"RTN","SCRPW70",183,0)
 ;Format 'next available' data
"RTN","SCRPW70",184,0)
 S SDX="^" F SDI=0:1:3 D
"RTN","SCRPW70",185,0)
 .S:SDI SDX=SDX_"|"
"RTN","SCRPW70",186,0)
 .S SDX=SDX_SDI_"~"_+$P(SDY,U,(SDI+SDI+1))_"~"_+$P(SDY,U,(SDI+SDI+2))
"RTN","SCRPW70",187,0)
 ;Format 'follow up'/'non-follow up' appointment data
"RTN","SCRPW70",188,0)
 S SDX=SDX_U F SDI=9:2:19 D
"RTN","SCRPW70",189,0)
 .S:SDI>9 SDX=SDX_"|"
"RTN","SCRPW70",190,0)
 .S SDX=SDX_+$P(SDY,U,SDI)_"~"_+$P(SDY,U,(SDI+1))
"RTN","SCRPW70",191,0)
 S SDX=SDX_U_+$P(SDY,U,21)_"~"_+$P(SDY,U,22)
"RTN","SCRPW70",192,0)
 F SDI=23:3:35 D
"RTN","SCRPW70",193,0)
 .S SDX=SDX_"|"_+$P(SDY,U,SDI)_"~"_+$P(SDY,U,(SDI+1))
"RTN","SCRPW70",194,0)
 .S SDX=SDX_"~"_+$P(SDY,U,(SDI+2))
"RTN","SCRPW70",195,0)
 ;Format 'appts. w/in 30 days' data
"RTN","SCRPW70",196,0)
 S SDX=SDX_U_+$P(SDY,U,38)_"~"_+$P(SDY,U,39)
"RTN","SCRPW70",197,0)
 Q SDX
"RTN","SCRPW72")
0^2^B70340948
"RTN","SCRPW72",1,0)
SCRPW72 ;BP-CIOFO/KEITH,ESW - Clinic appointment availability extract (cont.) ; 5/23/03 12:16pm
"RTN","SCRPW72",2,0)
 ;;5.3;Scheduling;**192,206,223,241,249,291**;AUG 13, 1993
"RTN","SCRPW72",3,0)
 ;
"RTN","SCRPW72",4,0)
START ;Gather data for printed report
"RTN","SCRPW72",5,0)
 N SDCP,SC,SCNA,SDI,SDOUT,SDPAST,SDXM,MAX,X1,X2,X,SDIOM,SDFOOT
"RTN","SCRPW72",6,0)
 I $E(IOST)="C" D WAIT^DICD
"RTN","SCRPW72",7,0)
 S (SDOUT,SDI)=0,SDIOM=$G(IOM,80)
"RTN","SCRPW72",8,0)
 S SDPAST=SDBDT'>DT S:SDPAST SDIOM=130
"RTN","SCRPW72",9,0)
 D HINI^SCRPW76,FOOT^SCRPW77(.SDFOOT)
"RTN","SCRPW72",10,0)
 K ^TMP("SD",$J),^TMP("SDS",$J),^TMP("SDTMP",$J),^TMP("SDTOT",$J)
"RTN","SCRPW72",11,0)
 I $G(SDREPORT(4)) K ^TMP("SDPLIST",$J)
"RTN","SCRPW72",12,0)
 I $G(SDREPORT(5)) D
"RTN","SCRPW72",13,0)
 .N CC F CC="SDIPLST","SDIP","SDORD" K ^TMP(CC,$J)
"RTN","SCRPW72",14,0)
 D INIT^SCRPW71 S SDCOL=$S(SDPAST:0,1:(SDIOM-58\2))
"RTN","SCRPW72",15,0)
 S X1=SDEDT,X2=SDBDT D ^%DTC S MAX=X+1
"RTN","SCRPW72",16,0)
 I SDPAST I '$G(SDREPORT(5)) D OE(SDBDT,SDEDT,MAX,0) Q:SDOUT  ;get outpt. enc. workload
"RTN","SCRPW72",17,0)
 G:SDOUT EXIT^SCRPW74
"RTN","SCRPW72",18,0)
 I $G(SDFMT)="D"!($G(SDFMTS)="CP") D
"RTN","SCRPW72",19,0)
 .I $G(SDREPORT(5)) D CA(.SDSORT) Q
"RTN","SCRPW72",20,0)
 .D @SDSORT
"RTN","SCRPW72",21,0)
 I $G(SDFMT)="S"&($G(SDFMTS)'="CP") S SC=0 F  S SC=$O(^SC(SC)) Q:'SC!SDOUT  D
"RTN","SCRPW72",22,0)
 .S SDI=SDI+1 I SDI#25=0 D STOP Q:SDOUT
"RTN","SCRPW72",23,0)
 .S SC0=$G(^SC(SC,0)) Q:'$$DIV(+$P(SC0,U,15))
"RTN","SCRPW72",24,0)
 .S SDX=$$CLINIC^SCRPW71(SC,SDFMT,SDBDT,SDEDT,MAX,SDPAST)
"RTN","SCRPW72",25,0)
 G:SDOUT EXIT^SCRPW74
"RTN","SCRPW72",26,0)
 S SDMD=$O(^TMP("SD",$J,"")),SDMD=$O(^TMP("SD",$J,SDMD)),SDMD=$L(SDMD)
"RTN","SCRPW72",27,0)
 I SDPAST D NAVA^SCRPW75(SDBDT,SDEDT,SDEX)  ;get next available wait times
"RTN","SCRPW72",28,0)
 G:SDOUT EXIT^SCRPW74
"RTN","SCRPW72",29,0)
 D ORD
"RTN","SCRPW72",30,0)
 I $E(IOST)="C" D END^SCRPW50
"RTN","SCRPW72",31,0)
 S SDREPORT=0 F  S SDREPORT=$O(SDREPORT(SDREPORT)) Q:SDOUT!'SDREPORT  D
"RTN","SCRPW72",32,0)
 .I SDREPORT(SDREPORT) S SDPAGE=1 D PRT^SCRPW73(0,SDREPORT)
"RTN","SCRPW72",33,0)
 G EXIT^SCRPW74
"RTN","SCRPW72",34,0)
 ;
"RTN","SCRPW72",35,0)
ORD ;Build list to order clinic output
"RTN","SCRPW72",36,0)
 S SDIV="" F  S SDIV=$O(^TMP("SD",$J,SDIV)) Q:SDIV=""!SDOUT  D
"RTN","SCRPW72",37,0)
 .S SDCP=0 F  S SDCP=$O(^TMP("SD",$J,SDIV,SDCP)) Q:'SDCP!SDOUT  D
"RTN","SCRPW72",38,0)
 ..S SC=0 F  S SC=$O(^TMP("SD",$J,SDIV,SDCP,SC)) Q:'SC!SDOUT  D
"RTN","SCRPW72",39,0)
 ...S SCNA=$P($G(^SC(SC,0)),U) S:'$L(SCNA) SCNA="UNKNOWN"
"RTN","SCRPW72",40,0)
 ...S ^TMP("SDS",$J,SDCP,SCNA,SC)=""
"RTN","SCRPW72",41,0)
 Q
"RTN","SCRPW72",42,0)
 ;
"RTN","SCRPW72",43,0)
OE(SDBDT,SDEDT,MAX,SDEX) ;Count clinic workload
"RTN","SCRPW72",44,0)
 ;Input: SDBDT=begin date
"RTN","SCRPW72",45,0)
 ;Input: SDEDT=end date
"RTN","SCRPW72",46,0)
 ;Input: MAX=number of days in date range
"RTN","SCRPW72",47,0)
 ;Input: SDEX='0' for user report, '1' for Austin extract
"RTN","SCRPW72",48,0)
 N SDT,SDOE,SDOE0,SDCT,SDCP,SDQUIT,SDAY,DFN
"RTN","SCRPW72",49,0)
 S (SDQUIT,SDCT)=0,SDT=SDBDT
"RTN","SCRPW72",50,0)
 F  S SDT=$O(^SCE("B",SDT)) Q:'SDT!(SDT>SDEDT)!SDOUT  D
"RTN","SCRPW72",51,0)
 .S SDOE=0 F  S SDOE=$O(^SCE("B",SDT,SDOE)) Q:'SDOE!SDOUT  D
"RTN","SCRPW72",52,0)
 ..S SDCT=SDCT+1 I SDCT#1000=0 D STOP Q:SDOUT
"RTN","SCRPW72",53,0)
 ..S SDOE0=$$GETOE^SDOE(SDOE) Q:$P(SDOE0,U,6)  Q:$P(SDOE0,U,12)=12
"RTN","SCRPW72",54,0)
 ..S DFN=$P(SDOE0,U,2) Q:'DFN
"RTN","SCRPW72",55,0)
 ..Q:$E($P($G(^DPT(DFN,0)),U,9),1,5)="00000"  ;exclude test patients
"RTN","SCRPW72",56,0)
 ..S SC=$P(SDOE0,U,4) Q:'SC  Q:'$$DIV(+$P(SDOE0,U,11))
"RTN","SCRPW72",57,0)
 ..S SC0=$G(^SC(SC,0)) Q:'$L($P(SC0,U))
"RTN","SCRPW72",58,0)
 ..Q:$P(SC0,U,17)="Y"  Q:'$$CPAIR^SCRPW71(SC0,.SDCP)
"RTN","SCRPW72",59,0)
 ..I 'SDEX,$D(SDSORT) S SDQUIT=0 D  Q:SDQUIT
"RTN","SCRPW72",60,0)
 ...I SDSORT="CL"!(SDSORT="CA"),'$D(SDSORT($P(SC0,U))) S SDQUIT=1 Q
"RTN","SCRPW72",61,0)
 ...I SDSORT="CP",'$D(SDSORT(SDCP)) S SDQUIT=1
"RTN","SCRPW72",62,0)
 ..S SDIV=$$DIV^SCRPW71(SC0) Q:'$L(SDIV)
"RTN","SCRPW72",63,0)
 ..I '$D(^TMP("SD",$J,SDIV,SDCP,SC)) D ARRINI^SCRPW71(SDCP,SC,MAX,SDPAST)
"RTN","SCRPW72",64,0)
 ..S $P(^TMP("SD",$J,SDIV,SDCP),U,3)=$P(^TMP("SD",$J,SDIV,SDCP),U,3)+1
"RTN","SCRPW72",65,0)
 ..S $P(^TMP("SD",$J,SDIV,SDCP,SC),U,3)=$P(^TMP("SD",$J,SDIV,SDCP,SC),U,3)+1
"RTN","SCRPW72",66,0)
 ..Q:SDFMT'="D"  S X1=$P(SDT,"."),X2=SDBDT D ^%DTC S SDAY=X+1
"RTN","SCRPW72",67,0)
 ..D ARRSET(SDCP,SC,SDAY) Q
"RTN","SCRPW72",68,0)
 Q
"RTN","SCRPW72",69,0)
 ;
"RTN","SCRPW72",70,0)
ARRSET(SDCP,SC,SDI) ;Set daily counts into array
"RTN","SCRPW72",71,0)
 ;Input: SDCP=credit pair
"RTN","SCRPW72",72,0)
 ;Input: SC=clinic ifn
"RTN","SCRPW72",73,0)
 ;Input: SDI=number of days from report date
"RTN","SCRPW72",74,0)
 N SDS,SDP,SDX
"RTN","SCRPW72",75,0)
 S SDS=SDI-1\12,SDP=SDI#12 S:SDP=0 SDP=12
"RTN","SCRPW72",76,0)
 S SDX=$P(^TMP("SD",$J,SDIV,SDCP,SC,SDS),U,SDP)
"RTN","SCRPW72",77,0)
 S:'$L(SDX) SDX="0~0~0"
"RTN","SCRPW72",78,0)
 S $P(SDX,"~",3)=$P(SDX,"~",3)+1
"RTN","SCRPW72",79,0)
 S $P(^TMP("SD",$J,SDIV,SDCP,SC,SDS),U,SDP)=SDX
"RTN","SCRPW72",80,0)
 Q
"RTN","SCRPW72",81,0)
 ;
"RTN","SCRPW72",82,0)
DIV(SDIV) ;Evaluate division
"RTN","SCRPW72",83,0)
 Q:'SDDIV 1  Q $D(SDDIV(SDIV))
"RTN","SCRPW72",84,0)
 ;
"RTN","SCRPW72",85,0)
CA(SORT) ;Evaluate list of clinics for selected patient
"RTN","SCRPW72",86,0)
 N SDCNAM,SC0,SDIV,XX,DFN,SDIV,SDCP,SDPNAME S SDI=0
"RTN","SCRPW72",87,0)
 F XX=1:1:$G(SDPAT) S DFN=+^TMP("SDPAT",SDJN,XX),SDPNAME=$P(^(XX),U,2)  D
"RTN","SCRPW72",88,0)
 .N SDDT S SDDT=SDBDT-1+.9999999 ; DATE/TIME APPT SCHEDULED 
"RTN","SCRPW72",89,0)
 .F  S SDDT=$O(^DPT(DFN,"S",SDDT)) Q:'SDDT!(SDDT>SDEDT)  D
"RTN","SCRPW72",90,0)
 ..S SDI=SDI+1 I SDI#10=0 D STOP Q:SDOUT
"RTN","SCRPW72",91,0)
 ..S SC=+^DPT(DFN,"S",SDDT,0),SC0=$G(^SC(SC,0)) I '$$DIV(+$P(SC0,U,15)) Q
"RTN","SCRPW72",92,0)
 ..Q:$P(SC0,U,17)="Y"  ;non-count clinic
"RTN","SCRPW72",93,0)
 ..S SDIV=$$DIV^SCRPW71(SC0)
"RTN","SCRPW72",94,0)
 ..I '$$CPAIR^SCRPW71(SC0,.SDCP) Q
"RTN","SCRPW72",95,0)
 ..I $G(SORT)="CP",'$D(SORT(SDCP)) Q  ;selection by credit pairs
"RTN","SCRPW72",96,0)
 ..I $G(SORT)="CL",'$D(SORT($P(SC0,U))) Q  ; selection by list of clinics
"RTN","SCRPW72",97,0)
 ..I $G(SDREPORT(5)) S ^TMP("SDIPLST",$J,DFN,SC)="",^TMP("SDIP",$J,$P(SDIV,U,2),SC)=SDCP_U_$P(SDIV,U),^TMP("SDORD",$J,SDPNAME,DFN)=""
"RTN","SCRPW72",98,0)
 ..S SDX=$$CLINIC^SCRPW71(SC,SDFMT,SDBDT,SDEDT,MAX,SDPAST)
"RTN","SCRPW72",99,0)
 Q
"RTN","SCRPW72",100,0)
CL ;Evaluate list of clinics
"RTN","SCRPW72",101,0)
 N SDCNAM,SC0,SDIV S SDI=0
"RTN","SCRPW72",102,0)
 S SDCNAM="" F  S SDCNAM=$O(SDSORT(SDCNAM)) Q:SDCNAM=""!SDOUT  D
"RTN","SCRPW72",103,0)
 .S SDI=SDI+1 I SDI#10=0 D STOP Q:SDOUT
"RTN","SCRPW72",104,0)
 .S SC=SDSORT(SDCNAM),SC0=$G(^SC(SC,0)) Q:'$$DIV(+$P(SC0,U,15))
"RTN","SCRPW72",105,0)
 .I $G(SDREPORT(4)) S ^TMP("SDPLIST",$J,SC)=""
"RTN","SCRPW72",106,0)
 .S SDX=$$CLINIC^SCRPW71(SC,SDFMT,SDBDT,SDEDT,MAX,SDPAST)
"RTN","SCRPW72",107,0)
 .I $P(SDX,U,3)=-1 D
"RTN","SCRPW72",108,0)
 ..S SDIV=$$DIV^SCRPW71(SC0)
"RTN","SCRPW72",109,0)
 ..S:$L(SDIV) $P(^TMP("SD",$J,SDIV,SDCNAM),U,3)=$P(SDX,U,3,4) Q
"RTN","SCRPW72",110,0)
 Q
"RTN","SCRPW72",111,0)
 ;
"RTN","SCRPW72",112,0)
CP ;Evaluate list of credit pairs
"RTN","SCRPW72",113,0)
 N SDCCP,SC,SC0 S SC=0
"RTN","SCRPW72",114,0)
 F  S SC=$O(^SC(SC)) Q:'SC!SDOUT  D
"RTN","SCRPW72",115,0)
 .S SC0=$G(^SC(SC,0)) Q:'$$DIV(+$P(SC0,U,15))
"RTN","SCRPW72",116,0)
 .Q:'$$CPAIR^SCRPW71(SC0,.SDCCP)!'$D(SDSORT(SDCCP))
"RTN","SCRPW72",117,0)
 .I $G(SDREPORT(4)) S ^TMP("SDPLIST",$J,SC)=""
"RTN","SCRPW72",118,0)
 .S SDX=$$CLINIC^SCRPW71(SC,SDFMT,SDBDT,SDEDT,MAX,SDPAST)
"RTN","SCRPW72",119,0)
 Q
"RTN","SCRPW72",120,0)
 ;
"RTN","SCRPW72",121,0)
CNAME(SC) ;Massage clinic name
"RTN","SCRPW72",122,0)
 N SDX
"RTN","SCRPW72",123,0)
 ;Default name value
"RTN","SCRPW72",124,0)
 S SDX=$P($G(^SC(SC,0)),U) Q:'$L(SDX) "UNKNOWN"
"RTN","SCRPW72",125,0)
 ;Remove extract formatting characters
"RTN","SCRPW72",126,0)
 S SDX=$TR(SDX,"#$^~|")
"RTN","SCRPW72",127,0)
 ;Uppercase name value
"RTN","SCRPW72",128,0)
 S SDX=$TR(SDX,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SCRPW72",129,0)
 Q SDX
"RTN","SCRPW72",130,0)
 ;
"RTN","SCRPW72",131,0)
SORT(SDSORT) ;Gather sort values for detailed report
"RTN","SCRPW72",132,0)
 ;Input: SDSORT=sort category (pass by reference)
"RTN","SCRPW72",133,0)
 ;Output: '1' if selection(s) made, '0' otherwise
"RTN","SCRPW72",134,0)
 ;        SDSORT(clinic name)=clinic ifn 
"RTN","SCRPW72",135,0)
 ;                    (or)
"RTN","SCRPW72",136,0)
 ;        SDSORT(credit pair)=credit pair
"RTN","SCRPW72",137,0)
 ;
"RTN","SCRPW72",138,0)
 N SDSX S SDSX="S"_SDSORT
"RTN","SCRPW72",139,0)
 I SDSORT="CA" Q 1
"RTN","SCRPW72",140,0)
 D @SDSX Q $D(SDSORT)>1
"RTN","SCRPW72",141,0)
 ;
"RTN","SCRPW72",142,0)
SCL ;Select clinics for detail
"RTN","SCRPW72",143,0)
 N DIC,SDQUIT S (SDQUIT,SDOUT)=0
"RTN","SCRPW72",144,0)
 S DIC="^SC(",DIC(0)="AEMQ",DIC("A")="Select CLINIC: ",DIC("S")="I $P(^(0),U,3)=""C"""
"RTN","SCRPW72",145,0)
 W ! F  Q:SDOUT!SDQUIT  D
"RTN","SCRPW72",146,0)
 .D ^DIC I $D(DTOUT)!$D(DUOUT) S SDOUT=1 Q
"RTN","SCRPW72",147,0)
 .I X="" S SDQUIT=1 Q
"RTN","SCRPW72",148,0)
 .I Y>0,$L($P(Y,U,2)) S SDSORT($P(Y,U,2))=+Y
"RTN","SCRPW72",149,0)
 Q
"RTN","SCRPW72",150,0)
 ;
"RTN","SCRPW72",151,0)
SCP ;Get credit pairs for detail
"RTN","SCRPW72",152,0)
 N DIR,SDQUIT S (SDQUIT,SDOUT)=0
"RTN","SCRPW72",153,0)
 S DIR(0)="NO:101000:999000:0",DIR("A")="Select clinic DSS credit pair"
"RTN","SCRPW72",154,0)
 S DIR("?",1)="Specify a six digit number that represents the primary and secondary stop"
"RTN","SCRPW72",155,0)
 S DIR("?",2)="code of clinics you wish to evaluate.  For clinics that do not have a"
"RTN","SCRPW72",156,0)
 S DIR("?",3)="secondary stop code, enter ""000"" as the second half of the credit pair"
"RTN","SCRPW72",157,0)
 S DIR("?")="(eg. ""323000"")."
"RTN","SCRPW72",158,0)
 W ! F  Q:SDOUT!SDQUIT  D
"RTN","SCRPW72",159,0)
 .D ^DIR I $D(DTOUT)!$D(DUOUT) S SDOUT=1 Q
"RTN","SCRPW72",160,0)
 .I X="" S SDQUIT=1 Q
"RTN","SCRPW72",161,0)
 .I '$$VCP(Y) W "  Invalid credit pair!" Q
"RTN","SCRPW72",162,0)
 .S SDSORT(Y)=Y
"RTN","SCRPW72",163,0)
 Q
"RTN","SCRPW72",164,0)
 ;
"RTN","SCRPW72",165,0)
VCP(Y) ;Validate credit pair
"RTN","SCRPW72",166,0)
 ;Input: Y=credit pair
"RTN","SCRPW72",167,0)
 ;Output: '1' if valid, '0' otherwise
"RTN","SCRPW72",168,0)
 Q:Y'?6N 0
"RTN","SCRPW72",169,0)
 Q:'$D(^DIC(40.7,"C",$E(Y,1,3))) 0
"RTN","SCRPW72",170,0)
 Q:$E(Y,4,6)="000" 1
"RTN","SCRPW72",171,0)
 Q:'$D(^DIC(40.7,"C",$E(Y,4,6))) 0
"RTN","SCRPW72",172,0)
 Q 1
"RTN","SCRPW72",173,0)
 ;
"RTN","SCRPW72",174,0)
STOP ;Check for stop task request
"RTN","SCRPW72",175,0)
 S:$D(ZTQUEUED) (SDOUT,ZTSTOP)=$S($$S^%ZTLOAD:1,1:0) Q
"RTN","SCRPW72",176,0)
 ;
"RTN","SCRPW72",177,0)
ADDL(SDZ) ;Format additional data
"RTN","SCRPW72",178,0)
 ;Input: SDZ=addl. data from ^TMP("SDNAVB",^J,SDCP,SC)
"RTN","SCRPW72",179,0)
 ;
"RTN","SCRPW72",180,0)
 N SDI,SDX S SDX=""
"RTN","SCRPW72",181,0)
 F SDI=1:1:7 S SDX=SDX_$S(SDI=5:"^",1:"~")_+$P(SDZ,U,SDI)
"RTN","SCRPW72",182,0)
 Q SDX
"RTN","SCRPW72",183,0)
 ;
"RTN","SCRPW72",184,0)
EXTRACT ;Gather data for extract
"RTN","SCRPW72",185,0)
 N SDBEG,SDEND,SDTIME,SDCP,SDX,SDY,SC,SCNA,SDI,SDFMT,SDOUT,SDXM,SDIOM,SDFOOT
"RTN","SCRPW72",186,0)
 N SDEXDT,MAX,X1,X2,X S SDIOM=$G(IOM,80)
"RTN","SCRPW72",187,0)
 F SDI=1,2,3 S SDREPORT(SDI)=1
"RTN","SCRPW72",188,0)
 S (SDOUT,SDCOL)=0,SDFMT="D",SDBEG=$H,SDEXDT=DT D INIT^SCRPW71
"RTN","SCRPW72",189,0)
 K ^TMP("SD",$J),^TMP("SDS",$J),^TMP("SDTMP",$J),^TMP("SDXM",$J)
"RTN","SCRPW72",190,0)
 S X1=SDEDT,X2=SDBDT D ^%DTC S MAX=X+1
"RTN","SCRPW72",191,0)
 D HINI^SCRPW76,FOOT^SCRPW77(.SDFOOT)
"RTN","SCRPW72",192,0)
 ;
"RTN","SCRPW72",193,0)
 ;Get encounter workload
"RTN","SCRPW72",194,0)
 I SDPAST D OE(SDBDT,SDEDT_.9999,MAX,1)  ;encounter workload
"RTN","SCRPW72",195,0)
 ;
"RTN","SCRPW72",196,0)
 ;Get clinic availability data
"RTN","SCRPW72",197,0)
 S SC=0 F  S SC=$O(^SC(SC)) Q:'SC  S SC0=$G(^SC(SC,0)) D
"RTN","SCRPW72",198,0)
 .S SDX=$$CLINIC^SCRPW71(SC,SDFMT,SDBDT,SDEDT,MAX,SDPAST)
"RTN","SCRPW72",199,0)
 ;
"RTN","SCRPW72",200,0)
 ;Get next available wait times
"RTN","SCRPW72",201,0)
 S SDMD=$O(^TMP("SD",$J,"")),SDMD=$O(^TMP("SD",$J,SDMD)),SDMD=$L(SDMD)
"RTN","SCRPW72",202,0)
 I SDPAST D NAVA^SCRPW75(SDBDT,SDEDT_.9999,1)  ;next ava. wait times
"RTN","SCRPW72",203,0)
 ;
"RTN","SCRPW72",204,0)
 ;Order by clinic, send extract data to Austin
"RTN","SCRPW72",205,0)
 D ORD,TXXM^SCRPW70 K ^TMP("SDXM",$J)
"RTN","SCRPW72",206,0)
 ;
"RTN","SCRPW72",207,0)
 ;Send summary bulletin to mail group
"RTN","SCRPW72",208,0)
 S SDFMT="S",SDEND=$H,SDTIME=$$TIME(SDBEG,SDEND)
"RTN","SCRPW72",209,0)
 S SDBEG=$$HTE^XLFDT(SDBEG),SDEND=$$HTE^XLFDT(SDEND)
"RTN","SCRPW72",210,0)
 S SDY="*** Clinic Appointment "_$S(SDPAST:"Utilization",1:"Availability")_" Extract ***"
"RTN","SCRPW72",211,0)
 S SDXM=1,SDX="",$E(SDX,(79-$L(SDY)\2))=SDY D XMTX^SCRPW73(SDX)
"RTN","SCRPW72",212,0)
 D XMTX^SCRPW73(" ")
"RTN","SCRPW72",213,0)
 D XMTX^SCRPW73("                   For date range: "_SDPBDT_" to "_SDPEDT)
"RTN","SCRPW72",214,0)
 D XMTX^SCRPW73("               Extract start time: "_SDBEG)
"RTN","SCRPW72",215,0)
 D XMTX^SCRPW73("                 Extract end time: "_SDEND)
"RTN","SCRPW72",216,0)
 D XMTX^SCRPW73("                 Extract run time: "_SDTIME)
"RTN","SCRPW72",217,0)
 D XMTX^SCRPW73("                      Task number: "_$G(ZTSK))
"RTN","SCRPW72",218,0)
 F SDI=1:1:4 D XMTX^SCRPW73("")
"RTN","SCRPW72",219,0)
 D PRT^SCRPW73(SDXM,1),EXXM^SCRPW70("G.SC CLINIC WAIT TIME")
"RTN","SCRPW72",220,0)
 I SDPAST F SDI=2,3 D
"RTN","SCRPW72",221,0)
 .K ^TMP("SDXM",$J) S SDXM=1
"RTN","SCRPW72",222,0)
 .D PRT^SCRPW73(SDXM,SDI),EXXM^SCRPW70("G.SC CLINIC WAIT TIME")
"RTN","SCRPW72",223,0)
 G EXIT^SCRPW74
"RTN","SCRPW72",224,0)
 ;
"RTN","SCRPW72",225,0)
TIME(SDBEG,SDEND) ;Calculate length of run time
"RTN","SCRPW72",226,0)
 ;Input: SDBEG=start time in $H format
"RTN","SCRPW72",227,0)
 ;Input: SDEND=end time in $H format
"RTN","SCRPW72",228,0)
 ;Output: text formatted string with # days, hours, minutes and seconds
"RTN","SCRPW72",229,0)
 N X,Y
"RTN","SCRPW72",230,0)
 S SDEND=$P(SDEND,",")-$P(SDBEG,",")*86400+$P(SDEND,",",2)
"RTN","SCRPW72",231,0)
 S SDBEG=$P(SDBEG,",",2),X=SDEND-SDBEG,Y("D")=X\86400
"RTN","SCRPW72",232,0)
 S X=X#86400,Y("H")=X\3600,X=X#3600,Y("M")=X\60,Y("S")=X#60
"RTN","SCRPW72",233,0)
 S Y("D")=$S('Y("D"):"",1:Y("D")_" day"_$S(Y("D")=1:"",1:"s")_", ")
"RTN","SCRPW72",234,0)
 S Y("H")=Y("H")_" hour"_$S(Y("H")=1:"",1:"s")_", "
"RTN","SCRPW72",235,0)
 S Y("M")=Y("M")_" minute"_$S(Y("M")=1:"",1:"s")_", "
"RTN","SCRPW72",236,0)
 S Y("S")=Y("S")_" second"_$S(Y("S")=1:"",1:"s")
"RTN","SCRPW72",237,0)
 Q Y("D")_Y("H")_Y("M")_Y("S")
"RTN","SCRPW73")
0^3^B73698455
"RTN","SCRPW73",1,0)
SCRPW73 ;BP-CIOFO/KEITH,ESW - Clinic appointment availability extract (cont.) ; 5/28/03 2:27pm
"RTN","SCRPW73",2,0)
 ;;5.3;Scheduling;**192,206,223,249,291**;AUG 13, 1993
"RTN","SCRPW73",3,0)
 ;
"RTN","SCRPW73",4,0)
PRT(SDXM,SDREPORT) ;Print report
"RTN","SCRPW73",5,0)
 ;Input: SDXM='1' for output to mail message text, '0' otherwise
"RTN","SCRPW73",6,0)
 ;Input: SDREPORT=report element to print
"RTN","SCRPW73",7,0)
 ;
"RTN","SCRPW73",8,0)
 N SDX,SDY,SDI,SDP,SDPCT,SDMD,SCNA,SDT,SDFLEN
"RTN","SCRPW73",9,0)
 S SDOUT=0,SDFLEN=$S('SDPAST:5,SDREPORT#1:12,1:11)
"RTN","SCRPW73",10,0)
 S SDMD=$O(^TMP("SD",$J,"")),SDMD=$O(^TMP("SD",$J,SDMD)),SDMD=$L(SDMD)
"RTN","SCRPW73",11,0)
 I '$D(^TMP("SD",$J)),$G(SDREPORT)'=5 D  Q
"RTN","SCRPW73",12,0)
 .D HDR^SCRPW76(0,SDREPORT) S SDX="No data found within the report parameters selected."
"RTN","SCRPW73",13,0)
 .W !!?(SDIOM-$L(SDX)\2),SDX Q
"RTN","SCRPW73",14,0)
 I '$D(^TMP("SDIPLST",$J)),$G(SDREPORT)=5 D  Q
"RTN","SCRPW73",15,0)
 .D HDR^SCRPW76(0,SDREPORT) S SDX="No data found within the report parameters selected."
"RTN","SCRPW73",16,0)
 .W !!?(SDIOM-$L(SDX)\2),SDX Q
"RTN","SCRPW73",17,0)
 I SDREPORT=5 D PRT5^SCRPW78 Q
"RTN","SCRPW73",18,0)
 S SDIV=9999999 F  S SDIV=$O(^TMP("SD",$J,SDIV)) Q:SDIV=""!SDOUT  D
"RTN","SCRPW73",19,0)
 .I SDFMT="D" D
"RTN","SCRPW73",20,0)
 ..S SDCP="" F  S SDCP=$O(^TMP("SD",$J,SDIV,SDCP)) Q:SDCP=""!SDOUT  D
"RTN","SCRPW73",21,0)
 ...S SCNA="" F  S SCNA=$O(^TMP("SDS",$J,SDCP,SCNA)) Q:SCNA=""!SDOUT  D
"RTN","SCRPW73",22,0)
 ....S SC=0 F  S SC=$O(^TMP("SDS",$J,SDCP,SCNA,SC)) Q:'SC!SDOUT  D
"RTN","SCRPW73",23,0)
 .....Q:'$D(^TMP("SD",$J,SDIV,SDCP,SC))
"RTN","SCRPW73",24,0)
 .....D HDR^SCRPW76(1,SDREPORT,SDIV,SDCP,SC) Q:SDOUT
"RTN","SCRPW73",25,0)
 .....I SDREPORT=4 D OUT4^SCRPW77 Q
"RTN","SCRPW73",26,0)
 .....S SDX=^TMP("SD",$J,SDIV,SDCP,SC)
"RTN","SCRPW73",27,0)
 .....I $P(SDX,U)+$P(SDX,U,2)+$P(SDX,U,3)'>0,'$D(^TMP("SDNAVA",$J,SDIV,SDCP,SC)) D  Q
"RTN","SCRPW73",28,0)
 ......S SDY="No availability found"_$S($L($P(SDX,U,4)):": "_$P(SDX,U,4)_".",1:".")
"RTN","SCRPW73",29,0)
 ......W !!?(SDIOM-$L(SDY)\2),SDY Q
"RTN","SCRPW73",30,0)
 .....S SDI="" F  S SDI=$O(^TMP("SD",$J,SDIV,SDCP,SC,SDI)) Q:SDI=""!SDOUT  D
"RTN","SCRPW73",31,0)
 ......S SDX=^TMP("SD",$J,SDIV,SDCP,SC,SDI)
"RTN","SCRPW73",32,0)
 ......F SDP=1:1 S SDY=$P(SDX,U,SDP) Q:'$L(SDY)!SDOUT  D
"RTN","SCRPW73",33,0)
 .......S SDY=$TR(SDY,"~","^"),SDT=$$DAY(SDI,SDP,SDBDT)
"RTN","SCRPW73",34,0)
 .......S SDY=$$TRX(SDREPORT,SDY,SDIV,SDCP,SC,$P(SDT,U,2))
"RTN","SCRPW73",35,0)
 .......I 'SDXM,$Y>(IOSL-SDFLEN) D
"RTN","SCRPW73",36,0)
 ........D:SDPAST FOOTER^SCRPW77(SDREPORT) D HDR^SCRPW76(1,SDREPORT,SDIV,SDCP,SC)
"RTN","SCRPW73",37,0)
 ........Q
"RTN","SCRPW73",38,0)
 .......Q:SDOUT
"RTN","SCRPW73",39,0)
 .......D OUTPUT(SDREPORT,$P(SDT,U),SDY,SDCOL,4,0,SDPAST,.SDXM)
"RTN","SCRPW73",40,0)
 .......Q
"RTN","SCRPW73",41,0)
 ......Q
"RTN","SCRPW73",42,0)
 .....Q:SDOUT
"RTN","SCRPW73",43,0)
 .....S SDX=^TMP("SD",$J,SDIV,SDCP,SC),SDX=$$TRX(SDREPORT,SDX,SDIV,SDCP,SC)
"RTN","SCRPW73",44,0)
 .....D OUTPUT(SDREPORT,"    Clinic Total:",SDX,SDCOL,0,1,SDPAST,.SDXM)
"RTN","SCRPW73",45,0)
 .....D:SDPAST FOOTER^SCRPW77(SDREPORT)
"RTN","SCRPW73",46,0)
 .....Q
"RTN","SCRPW73",47,0)
 ....Q
"RTN","SCRPW73",48,0)
 ...Q
"RTN","SCRPW73",49,0)
 ..Q
"RTN","SCRPW73",50,0)
 .Q:SDOUT  D SUM(SDIV,SDREPORT) Q
"RTN","SCRPW73",51,0)
 Q:SDOUT
"RTN","SCRPW73",52,0)
 ;
"RTN","SCRPW73",53,0)
 I SDMD D SUM(0,SDREPORT)
"RTN","SCRPW73",54,0)
 Q
"RTN","SCRPW73",55,0)
 ;
"RTN","SCRPW73",56,0)
TRX(SDREPORT,SDX,SDIV,SDCP,SC,SDT) ;Transform string for output
"RTN","SCRPW73",57,0)
 ;Input: SDREPORT=report element to print
"RTN","SCRPW73",58,0)
 ;Input: SDX=output numbers to transform
"RTN","SCRPW73",59,0)
 ;Input: SDIV=medical center division
"RTN","SCRPW73",60,0)
 ;Input: SDCP=credit pair (optional)
"RTN","SCRPW73",61,0)
 ;Input: SC=clinic ien (optional)
"RTN","SCRPW73",62,0)
 ;Input: SDT=date for detail by day (optional)
"RTN","SCRPW73",63,0)
 ;Output: string of output values for specified SDREPORT type
"RTN","SCRPW73",64,0)
 ;
"RTN","SCRPW73",65,0)
 N SDY
"RTN","SCRPW73",66,0)
 I SDREPORT=1 S SDY=$$TRX1()
"RTN","SCRPW73",67,0)
 I SDREPORT=2 S SDY=$$TRX2()
"RTN","SCRPW73",68,0)
 I SDREPORT=3 S SDY=$$TRX3()
"RTN","SCRPW73",69,0)
 Q SDY
"RTN","SCRPW73",70,0)
 ;
"RTN","SCRPW73",71,0)
TRX1() N SDZ S SDZ=""
"RTN","SCRPW73",72,0)
 S SDY=$P(SDX,U,2)_U_$P(SDX,U)_U
"RTN","SCRPW73",73,0)
 S SDY=SDY_$S(+$P(SDX,U,2)=0:0,1:$P(SDX,U)*100\$P(SDX,U,2))
"RTN","SCRPW73",74,0)
 S SDY=SDY_U_$P(SDX,U,3) D
"RTN","SCRPW73",75,0)
 .I '$G(SDCP) S SDZ=$G(^TMP("SDNAVA",$J,SDIV)) Q
"RTN","SCRPW73",76,0)
 .I '$G(SC) S SDZ=$G(^TMP("SDNAVA",$J,SDIV,SDCP)) Q
"RTN","SCRPW73",77,0)
 .I '$G(SDT) S SDZ=$G(^TMP("SDNAVA",$J,SDIV,SDCP,SC)) Q
"RTN","SCRPW73",78,0)
 .S SDZ=$G(^TMP("SDNAVA",$J,SDIV,SDCP,SC,SDT)) Q
"RTN","SCRPW73",79,0)
 S SDY=SDY_U_$P(SDZ,U,1,8)_U_$P(SDZ,U,38,39)
"RTN","SCRPW73",80,0)
 Q SDY
"RTN","SCRPW73",81,0)
 ;
"RTN","SCRPW73",82,0)
TRX2() I '$G(SDCP) S SDY=$P($G(^TMP("SDNAVA",$J,SDIV)),U,9,20) Q SDY
"RTN","SCRPW73",83,0)
 I '$G(SC) S SDY=$P($G(^TMP("SDNAVA",$J,SDIV,SDCP)),U,9,20) Q SDY
"RTN","SCRPW73",84,0)
 I '$G(SDT) S SDY=$P($G(^TMP("SDNAVA",$J,SDIV,SDCP,SC)),U,9,20) Q SDY
"RTN","SCRPW73",85,0)
 S SDY=$P($G(^TMP("SDNAVA",$J,SDIV,SDCP,SC,SDT)),U,9,20)
"RTN","SCRPW73",86,0)
 Q SDY
"RTN","SCRPW73",87,0)
 ;
"RTN","SCRPW73",88,0)
TRX3() I '$G(SDCP) S SDY=$P($G(^TMP("SDNAVA",$J,SDIV)),U,21,37) Q SDY
"RTN","SCRPW73",89,0)
 I '$G(SC) S SDY=$P($G(^TMP("SDNAVA",$J,SDIV,SDCP)),U,21,37) Q SDY
"RTN","SCRPW73",90,0)
 I '$G(SDT) S SDY=$P($G(^TMP("SDNAVA",$J,SDIV,SDCP,SC)),U,21,37) Q SDY
"RTN","SCRPW73",91,0)
 S SDY=$P($G(^TMP("SDNAVA",$J,SDIV,SDCP,SC,SDT)),U,21,37)
"RTN","SCRPW73",92,0)
 Q SDY
"RTN","SCRPW73",93,0)
 ;
"RTN","SCRPW73",94,0)
DAY(SDI,SDP,SDBDT) ;Produce date/day value
"RTN","SCRPW73",95,0)
 ;Input: SDI=array subscript incrementor
"RTN","SCRPW73",96,0)
 ;Input: SDP=$PIECE of string containing related date data
"RTN","SCRPW73",97,0)
 ;Input: SDBDT=report start date
"RTN","SCRPW73",98,0)
 N X1,X2,X,%H,Y,SDT,SDAY
"RTN","SCRPW73",99,0)
 S X1=SDBDT,X2=-1 D C^%DTC
"RTN","SCRPW73",100,0)
 S X1=X,X2=SDI*12+SDP D C^%DTC S SDT=X
"RTN","SCRPW73",101,0)
 D DW^%DTC S SDAY=X,Y=SDT X ^DD("DD")
"RTN","SCRPW73",102,0)
 Q Y_" "_$S($E(SDT,6)=0:"-",1:"")_"- "_SDAY_U_SDT
"RTN","SCRPW73",103,0)
 ;
"RTN","SCRPW73",104,0)
SUM(SDIV,SDREPORT) ;Print division/facility summary
"RTN","SCRPW73",105,0)
 ;Input: SDDIV=division name^number (or '0' for facility total)
"RTN","SCRPW73",106,0)
 ;Input: SDREPORT=report element to print
"RTN","SCRPW73",107,0)
 ;
"RTN","SCRPW73",108,0)
 I SDREPORT=4!(SDREPORT=5) Q
"RTN","SCRPW73",109,0)
 N SDY,SCNA,SDI
"RTN","SCRPW73",110,0)
 S SDCP="",SDHD=$S(SDIV=0:3,1:2) D HDR^SCRPW76(SDHD,SDREPORT,SDIV)
"RTN","SCRPW73",111,0)
 F  S SDCP=$O(^TMP("SD",$J,SDIV,SDCP)) Q:SDCP=""!SDOUT  D
"RTN","SCRPW73",112,0)
 .S SDX=^TMP("SD",$J,SDIV,SDCP),SDY=$G(^TMP("SD",$J,SDIV))
"RTN","SCRPW73",113,0)
 .F SDI=1:1:3 S $P(SDY,U,SDI)=$P(SDY,U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW73",114,0)
 .S ^TMP("SD",$J,SDIV)=SDY
"RTN","SCRPW73",115,0)
 .Q:'$$DATA(1)  ;Quit if no data
"RTN","SCRPW73",116,0)
 .I SDMD S SDY=$G(^TMP("SD",$J,0,SDCP)) D 
"RTN","SCRPW73",117,0)
 ..F SDI=1:1:3 S $P(SDY,U,SDI)=$P(SDY,U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW73",118,0)
 ..S ^TMP("SD",$J,0,SDCP)=SDY
"RTN","SCRPW73",119,0)
 .S SDY=$$OTX("CP"),SDX=$$TRX(SDREPORT,SDX,SDIV,SDCP)
"RTN","SCRPW73",120,0)
 .D OUTPUT(SDREPORT,SDY,SDX,SDCOL,0,1,SDPAST,.SDXM)
"RTN","SCRPW73",121,0)
 .S SCNA="" F  S SCNA=$O(^TMP("SDS",$J,SDCP,SCNA)) Q:SCNA=""!SDOUT  D 
"RTN","SCRPW73",122,0)
 ..S SC=0 F  S SC=$O(^TMP("SDS",$J,SDCP,SCNA,SC)) Q:'SC!SDOUT  D 
"RTN","SCRPW73",123,0)
 ...S SDX=$G(^TMP("SD",$J,SDIV,SDCP,SC))
"RTN","SCRPW73",124,0)
 ...Q:'$$DATA(2)  ;Quit if no data
"RTN","SCRPW73",125,0)
 ...I 'SDXM,$Y>(IOSL-SDFLEN) D
"RTN","SCRPW73",126,0)
 ....D:SDPAST FOOTER^SCRPW77(SDREPORT) D HDR^SCRPW76(SDHD,SDREPORT,SDIV)
"RTN","SCRPW73",127,0)
 ....Q
"RTN","SCRPW73",128,0)
 ...Q:SDOUT
"RTN","SCRPW73",129,0)
 ...I SDMD S SDY=$G(^TMP("SD",$J,0,SDCP,SC)) D
"RTN","SCRPW73",130,0)
 ....F SDI=1:1:3 S $P(SDY,U,SDI)=$P(SDY,U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW73",131,0)
 ....S ^TMP("SD",$J,0,SDCP,SC)=SDY
"RTN","SCRPW73",132,0)
 ....Q
"RTN","SCRPW73",133,0)
 ...S SDY=$$OTX("CL"),SDX=$$TRX(SDREPORT,SDX,SDIV,SDCP,SC)
"RTN","SCRPW73",134,0)
 ...D OUTPUT(SDREPORT,SDY,SDX,SDCOL,4,0,SDPAST,.SDXM)
"RTN","SCRPW73",135,0)
 ...Q
"RTN","SCRPW73",136,0)
 ..Q
"RTN","SCRPW73",137,0)
 .Q
"RTN","SCRPW73",138,0)
 Q:SDOUT  S SDX=$G(^TMP("SD",$J,SDIV)),SDX=$$TRX(SDREPORT,SDX,SDIV)
"RTN","SCRPW73",139,0)
 I $G(SDFMT)="S"&($G(SDFMTS)="CP") D:SDPAST FOOTER^SCRPW77(SDREPORT) Q
"RTN","SCRPW73",140,0)
 S SDY=$S(SDIV=0:"Facility",1:"Division")_" total:" D OUTPUT(SDREPORT,SDY,SDX,SDCOL,0,1,SDPAST,.SDXM,1)
"RTN","SCRPW73",141,0)
 D:SDPAST FOOTER^SCRPW77(SDREPORT)
"RTN","SCRPW73",142,0)
 Q
"RTN","SCRPW73",143,0)
 ;
"RTN","SCRPW73",144,0)
DATA(SDS) ;Check for data to print
"RTN","SCRPW73",145,0)
 ;Input: SDS=subscript level
"RTN","SCRPW73",146,0)
 ;Output: '1' if data, '0' otherwise
"RTN","SCRPW73",147,0)
 N SDCK,SDNODE,SDI,SDCT S (SDCT,SDCK)=0
"RTN","SCRPW73",148,0)
 Q:SDFMT'="S" 1
"RTN","SCRPW73",149,0)
 I 'SDPAST S SDCK=($P(SDX,U)+$P(SDX,U,2)+$P(SDX,U,3)>0) Q SDCK
"RTN","SCRPW73",150,0)
 I $P(SDX,U)+$P(SDX,U,2)+$P(SDX,U,3)>0 Q 1
"RTN","SCRPW73",151,0)
 I SDS=1 S SDNODE=$G(^TMP("SDNAVA",$J,SDIV,SDCP))
"RTN","SCRPW73",152,0)
 I SDS=2 S SDNODE=$G(^TMP("SDNAVA",$J,SDIV,SDCP,SC))
"RTN","SCRPW73",153,0)
 F SDI=1:1:39 S SDCT=SDCT+$P(SDNODE,U,SDI)
"RTN","SCRPW73",154,0)
 S SDCK=SDCT>0
"RTN","SCRPW73",155,0)
 Q SDCK
"RTN","SCRPW73",156,0)
 ;
"RTN","SCRPW73",157,0)
OUTPUT(SDREPORT,SDTX,SDX,SDCOL,SDC,SDL,SDPAST,SDXM,SDTL) ;Write output or load summary message
"RTN","SCRPW73",158,0)
 ;Input: SDREPORT=report element to print
"RTN","SCRPW73",159,0)
 ;Input: SDTX=category text value
"RTN","SCRPW73",160,0)
 ;Input: SDX=output count values
"RTN","SCRPW73",161,0)
 ;Input: SDCOL=margin adjusted column control
"RTN","SCRPW73",162,0)
 ;Input: SDC=column to start line
"RTN","SCRPW73",163,0)
 ;Input: SDL=number of additional linefeeds
"RTN","SCRPW73",164,0)
 ;Input: SDPAST='0' if dates > TODAY, '1' otherwise
"RTN","SCRPW73",165,0)
 ;Input: SDXM=mail message line number message text (optional)
"RTN","SCRPW73",166,0)
 ;Input: SDTL='1' if this is a totals line
"RTN","SCRPW73",167,0)
 ;
"RTN","SCRPW73",168,0)
 N SDI,SDPCT
"RTN","SCRPW73",169,0)
 G:$G(SDXM) OUTXM F SDI=1:1:SDL W !
"RTN","SCRPW73",170,0)
 D:SDREPORT=1 OUT1 D:SDREPORT=2 OUT2 D:SDREPORT=3 OUT3
"RTN","SCRPW73",171,0)
 Q
"RTN","SCRPW73",172,0)
 ;
"RTN","SCRPW73",173,0)
OUT1 N SDL1,SDL2,SDL3
"RTN","SCRPW73",174,0)
 W !?(SDCOL+SDC),SDTX
"RTN","SCRPW73",175,0)
 F SDI=1:1:$S(SDPAST:12,1:3) D MANI(SDX,SDI,$G(SDTL)) D
"RTN","SCRPW73",176,0)
 .W ?(SDCOL+34+SDL1+(SDI-1*7)),$J(+$P(SDX,U,SDI),$S(((SDI<3)&(SDL3>7)):SDL3,SDI=3:(6-SDL1),1:7),$$OPD())_$S(SDI=3:"%",1:"")
"RTN","SCRPW73",177,0)
 .Q
"RTN","SCRPW73",178,0)
 I SDPAST F SDI=0,1 D
"RTN","SCRPW73",179,0)
 .W ?(SDCOL+118+(SDI*7)),$J(+$P(SDX,U,13+SDI),6,0)_"%"
"RTN","SCRPW73",180,0)
 .Q
"RTN","SCRPW73",181,0)
 Q
"RTN","SCRPW73",182,0)
 ;
"RTN","SCRPW73",183,0)
MANI(SDX,SDI,SDTL) ;Manipulate column position for large totals
"RTN","SCRPW73",184,0)
 ;
"RTN","SCRPW73",185,0)
 S (SDL1,SDL2)=0,SDL3=$L($P(SDX,U,SDI))
"RTN","SCRPW73",186,0)
 I $G(SDTL) D
"RTN","SCRPW73",187,0)
 .I SDI=1,SDL3>7 S SDL1=(7-SDL3)
"RTN","SCRPW73",188,0)
 .I SDI=2,SDL3>6 S SDL1=1
"RTN","SCRPW73",189,0)
 .I SDI=3 S SDL1=3
"RTN","SCRPW73",190,0)
 .Q
"RTN","SCRPW73",191,0)
 Q
"RTN","SCRPW73",192,0)
 ;
"RTN","SCRPW73",193,0)
OUT2 W !?(SDCOL+SDC),SDTX
"RTN","SCRPW73",194,0)
 F SDI=0:1:5 D
"RTN","SCRPW73",195,0)
 .W ?(36+(SDI*16)),$J(+$P(SDX,U,(1+(SDI*2))),8,0)
"RTN","SCRPW73",196,0)
 .W ?(44+(SDI*16)),$J(+$P(SDX,U,(2+(SDI*2))),8,1)
"RTN","SCRPW73",197,0)
 .Q
"RTN","SCRPW73",198,0)
 Q
"RTN","SCRPW73",199,0)
 ;
"RTN","SCRPW73",200,0)
OUT3 W !?(SDCOL+SDC),SDTX
"RTN","SCRPW73",201,0)
 W ?30,$J(+$P(SDX,U),6,0),?36,$J(+$P(SDX,U,2),6,1)
"RTN","SCRPW73",202,0)
 F SDI=0:1:4 D
"RTN","SCRPW73",203,0)
 .W ?(42+(SDI*18)),$J(+$P(SDX,U,(3+(SDI*3))),6,0)
"RTN","SCRPW73",204,0)
 .W ?(48+(SDI*18)),$J(+$P(SDX,U,(4+(SDI*3))),6,1)
"RTN","SCRPW73",205,0)
 .W ?(54+(SDI*18)),$J(+$P(SDX,U,(5+(SDI*3))),6,1)
"RTN","SCRPW73",206,0)
 .Q
"RTN","SCRPW73",207,0)
 Q
"RTN","SCRPW73",208,0)
 ;
"RTN","SCRPW73",209,0)
OPD() ;Output decimal places
"RTN","SCRPW73",210,0)
 Q $S(SDI<6:0,SDI#2:0,1:1)
"RTN","SCRPW73",211,0)
 ;
"RTN","SCRPW73",212,0)
OUTXM ;Load bulletin message text
"RTN","SCRPW73",213,0)
 ;Output: ^TMP("SDXM",$J,SDXM)=mail message text line
"RTN","SCRPW73",214,0)
 N SDZ S:SDC<1 SDC=1
"RTN","SCRPW73",215,0)
 F SDI=1:1:SDL D XMTX("")
"RTN","SCRPW73",216,0)
 D:SDREPORT=1 OUTXM1 D:SDREPORT=2 OUTXM2 D:SDREPORT=3 OUTXM3
"RTN","SCRPW73",217,0)
 Q
"RTN","SCRPW73",218,0)
 ;
"RTN","SCRPW73",219,0)
OUTXM1 N SDL1,SDL2,SDL3
"RTN","SCRPW73",220,0)
 S SDZ="",$E(SDZ,SDC)=SDTX
"RTN","SCRPW73",221,0)
 F SDI=1:1:$S(SDPAST:12,1:3) D MANI(SDX,SDI,$G(SDTL)) D
"RTN","SCRPW73",222,0)
 .S $E(SDZ,(35+SDL1+(SDI-1*7)))=$J(+$P(SDX,U,SDI),$S(((SDI<3)&(SDL3>7)):SDL3,SDI=3:(6-SDL1),1:7),$$OPD())_$S(SDI=3:"%",1:"")
"RTN","SCRPW73",223,0)
 I SDPAST F SDI=0,1 D
"RTN","SCRPW73",224,0)
 .S $E(SDZ,(119+(SDI*7)))=$J(+$P(SDX,U,13+SDI),6,0)_"%"
"RTN","SCRPW73",225,0)
 D XMTX(SDZ)
"RTN","SCRPW73",226,0)
 Q
"RTN","SCRPW73",227,0)
 ;
"RTN","SCRPW73",228,0)
OUTXM2 S SDZ="",$E(SDZ,SDC)=SDTX
"RTN","SCRPW73",229,0)
 F SDI=0:1:5 D
"RTN","SCRPW73",230,0)
 .S $E(SDZ,(37+(SDI*16)))=$J(+$P(SDX,U,(1+(SDI*2))),8,0)
"RTN","SCRPW73",231,0)
 .S $E(SDZ,(45+(SDI*16)))=$J(+$P(SDX,U,(2+(SDI*2))),8,1)
"RTN","SCRPW73",232,0)
 .Q
"RTN","SCRPW73",233,0)
 D XMTX(SDZ)
"RTN","SCRPW73",234,0)
 Q
"RTN","SCRPW73",235,0)
 ;
"RTN","SCRPW73",236,0)
OUTXM3 S SDZ="",$E(SDZ,SDC)=SDTX
"RTN","SCRPW73",237,0)
 S $E(SDZ,31)=$J(+$P(SDX,U),6,0),$E(SDZ,37)=$J(+$P(SDX,U,2),6,1)
"RTN","SCRPW73",238,0)
 F SDI=0:1:4 D
"RTN","SCRPW73",239,0)
 .S $E(SDZ,(43+(SDI*18)))=$J(+$P(SDX,U,(3+(SDI*3))),6,0)
"RTN","SCRPW73",240,0)
 .S $E(SDZ,(49+(SDI*18)))=$J(+$P(SDX,U,(4+(SDI*3))),6,1)
"RTN","SCRPW73",241,0)
 .S $E(SDZ,(55+(SDI*18)))=$J(+$P(SDX,U,(5+(SDI*3))),6,1)
"RTN","SCRPW73",242,0)
 .Q
"RTN","SCRPW73",243,0)
 D XMTX(SDZ)
"RTN","SCRPW73",244,0)
 Q
"RTN","SCRPW73",245,0)
 ;
"RTN","SCRPW73",246,0)
XMTX(SDX) ;Set mail message text line
"RTN","SCRPW73",247,0)
 ;Input: SDX=text value
"RTN","SCRPW73",248,0)
 S ^TMP("SDXM",$J,SDXM)=SDX,SDXM=SDXM+1 Q
"RTN","SCRPW73",249,0)
 ;
"RTN","SCRPW73",250,0)
OTX(SDSORT)    ;Produce output text for clinic or credit pair
"RTN","SCRPW73",251,0)
 ;Input: SDSORT='CL' for clinic name, 'CP' for credit pair
"RTN","SCRPW73",252,0)
 N SDZ,SDSC1,SDSC2
"RTN","SCRPW73",253,0)
 I SDSORT="CL" D  Q SDZ
"RTN","SCRPW73",254,0)
 .S SDZ=$P($G(^SC(+SC,0)),U) S:'$L(SDZ) SDZ="UNKNOWN"
"RTN","SCRPW73",255,0)
 .I SDREPORT=3 S SDZ=$E(SDZ,1,26)
"RTN","SCRPW73",256,0)
 .Q
"RTN","SCRPW73",257,0)
 S SDSC1=$O(^DIC(40.7,"C",$E(SDCP,1,3),""))
"RTN","SCRPW73",258,0)
 S SDSC1=$P($G(^DIC(40.7,+SDSC1,0)),U),SDSC1=$TR(SDSC1,"/","-")
"RTN","SCRPW73",259,0)
 S:'$L(SDSC1) SDSC1="UNKNOWN"
"RTN","SCRPW73",260,0)
 I $E(SDCP,4,6)="000" S SDSC2="(NONE)" G CPO1
"RTN","SCRPW73",261,0)
 S SDSC2=$O(^DIC(40.7,"C",$E(SDCP,4,6),""))
"RTN","SCRPW73",262,0)
 S SDSC2=$P($G(^DIC(40.7,+SDSC2,0)),U),SDSC2=$TR(SDSC2,"/","-")
"RTN","SCRPW73",263,0)
 S:'$L(SDSC2) SDSC2="UNKNOWN"
"RTN","SCRPW73",264,0)
CPO1 I $L(SDSC1)<13 S SDZ=SDSC1_"/"_$E(SDSC2,1,(13+(13-$L(SDSC1)))) G CPOTQ
"RTN","SCRPW73",265,0)
 I $L(SDSC2)<13 S SDZ=$E(SDSC1,1,(13+(13-$L(SDSC2))))_"/"_SDSC2 G CPOTQ
"RTN","SCRPW73",266,0)
 S SDZ=$E(SDSC1,1,13)_"/"_$E(SDSC2,1,13)
"RTN","SCRPW73",267,0)
CPOTQ S SDZ=SDCP_" "_SDZ I SDREPORT=3 S SDZ=$E(SDZ,1,30)
"RTN","SCRPW73",268,0)
 Q SDZ
"RTN","SCRPW74")
0^8^B43863725
"RTN","SCRPW74",1,0)
SCRPW74 ;BP-CIOFO/KEITH,ESW - Clinic appointment availability extract (cont.) ; 6/10/03 9:13am
"RTN","SCRPW74",2,0)
 ;;5.3;Scheduling;**192,206,223,241,249,291**;AUG 13, 1993
"RTN","SCRPW74",3,0)
 ;
"RTN","SCRPW74",4,0)
MON(SDEX,SDT,SDMON) ;Determine month and date ranges for extracts
"RTN","SCRPW74",5,0)
 ;Input: SDEX=extract type, '1' for prospective, '2' for retrospective
"RTN","SCRPW74",6,0)
 ;Input: SDT=date of extract run
"RTN","SCRPW74",7,0)
 ;Input: SDMON=array to return date information (pass by reference)
"RTN","SCRPW74",8,0)
 ;Output: month/year of extract^begin date of report data
"RTN","SCRPW74",9,0)
 ;Output: SDMON array as follows:
"RTN","SCRPW74",10,0)
 ;        SDMON("SDBDT")=begin date
"RTN","SCRPW74",11,0)
 ;        SDMON("SDDIV")=0
"RTN","SCRPW74",12,0)
 ;        SDMON("SDEDT")=end date
"RTN","SCRPW74",13,0)
 ;        SDMON("SDEX")=extract type ('1' or '2')
"RTN","SCRPW74",14,0)
 ;        SDMON("SDPAST")='1' for extract 2, '0' otherwise
"RTN","SCRPW74",15,0)
 ;        SDMON("SDPBDT")=begin date external value
"RTN","SCRPW74",16,0)
 ;        SDMON("SDPEDT")=end date external value
"RTN","SCRPW74",17,0)
 ;        SDMON("SDRPT")=month/year of extract^begin date of data
"RTN","SCRPW74",18,0)
 ;
"RTN","SCRPW74",19,0)
 N SDPAR,Y,SDX,SDY,X1,X2
"RTN","SCRPW74",20,0)
 S SDMON("SDDIV")=0,SDMON("SDPAST")=$S(SDEX=1:0,1:1)
"RTN","SCRPW74",21,0)
 S SDMON("SDEX")=SDEX,SDPAR=$G(^SD(404.91,1,"PATCH192"))
"RTN","SCRPW74",22,0)
 I SDEX=1 D
"RTN","SCRPW74",23,0)
 .S Y=$S($E(SDT,4,5)=12:$E(SDT,1,3)+1_"0101",1:$E(SDT,1,5)+1_"01")
"RTN","SCRPW74",24,0)
 .S SDMON("SDBDT")=Y X ^DD("DD") S SDMON("SDPBDT")=Y
"RTN","SCRPW74",25,0)
 .S X1=SDMON("SDBDT"),X2=$P(SDPAR,U,2) S:X2<1 X2=180 S X2=X2-1
"RTN","SCRPW74",26,0)
 .D C^%DTC S (SDMON("SDEDT"),Y)=X X ^DD("DD") S SDMON("SDPEDT")=Y
"RTN","SCRPW74",27,0)
 .Q
"RTN","SCRPW74",28,0)
 I SDEX=2 D
"RTN","SCRPW74",29,0)
 .S Y=$S($E(SDT,4,5)="01":$E(SDT,1,3)-1_1201,1:$E(SDT,1,5)-1_"01")
"RTN","SCRPW74",30,0)
 .S SDMON("SDBDT")=Y X ^DD("DD") S SDMON("SDPBDT")=Y
"RTN","SCRPW74",31,0)
 .S X1=SDMON("SDBDT"),X2=$P(SDPAR,U,4) S:X2<1 X2=31 S X2=X2-1
"RTN","SCRPW74",32,0)
 .D C^%DTC I $E(X,1,5)>$E(SDMON("SDBDT"),1,5) D
"RTN","SCRPW74",33,0)
 ..S X1=$E(X,1,5)_"01",X2=-1 D C^%DTC Q
"RTN","SCRPW74",34,0)
 .S (SDMON("SDEDT"),Y)=X X ^DD("DD") S SDMON("SDPEDT")=Y
"RTN","SCRPW74",35,0)
 .Q
"RTN","SCRPW74",36,0)
 S SDY=SDMON("SDBDT")
"RTN","SCRPW74",37,0)
 S:SDEX=2 SDY=$S($E(SDY,4,5)=12:$E(SDY,1,3)+1_"0101",1:$E(SDY,1,5)+1_"01") S SDX=+$E(SDY,4,5)
"RTN","SCRPW74",38,0)
 S SDX=$P("JANUARY^FEBRUARY^MARCH^APRIL^MAY^JUNE^JULY^AUGUST^SEPTEMBER^OCTOBER^NOVEMBER^DECEMBER",U,SDX)
"RTN","SCRPW74",39,0)
 S SDX=SDX_" "_(17+$E(SDY)_$E(SDY,2,3))_U_SDMON("SDBDT")
"RTN","SCRPW74",40,0)
 S SDMON("SDRPT")=SDX
"RTN","SCRPW74",41,0)
 Q SDX
"RTN","SCRPW74",42,0)
 ;
"RTN","SCRPW74",43,0)
QDIS(SDXTMP) ;Display extract queuing information
"RTN","SCRPW74",44,0)
 ;Input: SDXTMP=array of data from ^XTMP("SD53P192")
"RTN","SCRPW74",45,0)
 N SDEX,Y
"RTN","SCRPW74",46,0)
 W !!?18,"*** Extract queuing information on file ***"
"RTN","SCRPW74",47,0)
 I '$D(SDXTMP) W !!,"==> No extract queuing data found" Q
"RTN","SCRPW74",48,0)
 F SDEX=1,2 D
"RTN","SCRPW74",49,0)
 .W !!?22,"Extract ",SDEX," report: ",$P($G(SDXTMP("EXTRACT",SDEX,"REPORT")),U)
"RTN","SCRPW74",50,0)
 .W !?24,"Extract ",SDEX," task: ",$G(SDXTMP("EXTRACT",SDEX,"TASK"))
"RTN","SCRPW74",51,0)
 .S Y=$G(SDXTMP("EXTRACT",SDEX,"DATE")) I Y X ^DD("DD")
"RTN","SCRPW74",52,0)
 .W !?20,"Extract ",SDEX," run date: ",Y
"RTN","SCRPW74",53,0)
 .Q
"RTN","SCRPW74",54,0)
 Q
"RTN","SCRPW74",55,0)
 ;
"RTN","SCRPW74",56,0)
DAYS(SDATE,SDAY) ;Adjust target day if necessary
"RTN","SCRPW74",57,0)
 ;Input: SDATE=date
"RTN","SCRPW74",58,0)
 ;Input: SDAY=target day
"RTN","SCRPW74",59,0)
 ;Output: target SDAY for the month of SDATE, adjusted if necessary
"RTN","SCRPW74",60,0)
 N SDX,X,X1,X2
"RTN","SCRPW74",61,0)
 S X1=$S($E(SDATE,4,5)=12:($E(SDATE,1,3)+1)_"01",1:$E(SDATE,1,5)+1)_"01"
"RTN","SCRPW74",62,0)
 S X2=-1 D C^%DTC S SDX=$E(X,6,7)
"RTN","SCRPW74",63,0)
 Q $S(SDX<SDAY:SDX,1:SDAY)
"RTN","SCRPW74",64,0)
 ;
"RTN","SCRPW74",65,0)
WHEN(SDEX,SDNOW) ;Determine date for next run
"RTN","SCRPW74",66,0)
 ;Input: SDEX=extract type
"RTN","SCRPW74",67,0)
 ;Input: SDDT=date/time to calculate from (optional)
"RTN","SCRPW74",68,0)
 ;Output: if success, date/time for next run
"RTN","SCRPW74",69,0)
 ;        if already scheduled, -1^date_scheduled^task_number
"RTN","SCRPW74",70,0)
 N SDPAR,SDAY,X1,X2,X,SDTIME,SDINT,SDT,SDDT
"RTN","SCRPW74",71,0)
 S SDNOW=$G(SDNOW) I SDNOW<1 S SDNOW=$$NOW^XLFDT()
"RTN","SCRPW74",72,0)
 S SDDT=$P(SDNOW,".")
"RTN","SCRPW74",73,0)
 ;
"RTN","SCRPW74",74,0)
 ;Quit if already scheduled
"RTN","SCRPW74",75,0)
 Q:$G(^XTMP("SD53P192","EXTRACT",SDEX,"DATE"))>SDNOW "-1^"_^XTMP("SD53P192","EXTRACT",SDEX,"DATE")_U_$G(^XTMP("SD53P192","EXTRACT",SDEX,"TASK"))
"RTN","SCRPW74",76,0)
 ;
"RTN","SCRPW74",77,0)
 S SDPAR=$G(^SD(404.91,1,"PATCH192")),SDAY=$P(SDPAR,U) S:'SDAY SDAY=31
"RTN","SCRPW74",78,0)
 S SDINT=$P(SDPAR,U,5) I SDINT=""!("MQSA"'[SDINT) S SDINT="M"
"RTN","SCRPW74",79,0)
 S SDTIME=$P(SDPAR,U,6) I 'SDTIME!(SDTIME>.2359) S SDTIME=.22
"RTN","SCRPW74",80,0)
 S X1=$E(SDDT,1,5)_"01",X2=$$DAYS(SDDT,SDAY)-1 D C^%DTC
"RTN","SCRPW74",81,0)
 I (X+SDTIME)<SDNOW D
"RTN","SCRPW74",82,0)
 .S X1=$S($E(X,4,5)=12:($E(X,1,3)+1)_"01",1:$E(X,1,5)+1)_"01"
"RTN","SCRPW74",83,0)
 .S X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",84,0)
 .Q
"RTN","SCRPW74",85,0)
 ;
"RTN","SCRPW74",86,0)
 ;Values for monthly queuing
"RTN","SCRPW74",87,0)
 I SDINT="M" Q:SDEX=1 X+SDTIME  Q $$WHEN2(X)
"RTN","SCRPW74",88,0)
 ;
"RTN","SCRPW74",89,0)
 ;Values for quarterly queuing
"RTN","SCRPW74",90,0)
 I SDINT="Q" D  Q X
"RTN","SCRPW74",91,0)
 .S X1=+$E(X,4,5),X1=$S(X1<4:"03",X1<7:"06",X1<10:"09",1:12)
"RTN","SCRPW74",92,0)
 .S X1=$E(X,1,3)_X1_"01",X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",93,0)
 .I SDEX=1 S X=X+SDTIME Q
"RTN","SCRPW74",94,0)
 .S X=$$WHEN2(X) Q
"RTN","SCRPW74",95,0)
 ;
"RTN","SCRPW74",96,0)
 ;Values for semi-annual queuing
"RTN","SCRPW74",97,0)
 I SDINT="S" D  Q X
"RTN","SCRPW74",98,0)
 .S X1=+$E(X,4,5) S:X1>9 X=$E(X,1,3)+1_$E(X,4,7)
"RTN","SCRPW74",99,0)
 .S X1=$S(X1<4:"03",X1<10:"09",1:"03")
"RTN","SCRPW74",100,0)
 .S X1=$E(X,1,3)_X1_"01",X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",101,0)
 .I SDEX=1 S X=X+SDTIME Q
"RTN","SCRPW74",102,0)
 .S X=$$WHEN2(X) Q
"RTN","SCRPW74",103,0)
 ;
"RTN","SCRPW74",104,0)
 ;Values for annual queuing
"RTN","SCRPW74",105,0)
 S X1=+$E(X,4,5) S:X1>9 X=$E(X,1,3)+1_$E(X,4,7)
"RTN","SCRPW74",106,0)
 S X=$E(X,1,3)_"0901",X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",107,0)
 Q:SDEX=1 X+SDTIME  Q $$WHEN2(X)
"RTN","SCRPW74",108,0)
 ;
"RTN","SCRPW74",109,0)
WHEN2(X) ;Determine date for extract 2
"RTN","SCRPW74",110,0)
 ;Input: X=date for extract 1
"RTN","SCRPW74",111,0)
 ;Output: date/time for extract 2
"RTN","SCRPW74",112,0)
 S SDT=$S($E(X,4,5)=12:$E(X,1,3)+1_"0101",1:$E(X,1,5)+1_"01")
"RTN","SCRPW74",113,0)
 S SDAY=$P(SDPAR,U,3) S:'SDAY!SDAY>31 SDAY=5
"RTN","SCRPW74",114,0)
 S X1=SDT,X2=$$DAYS(SDT,SDAY)-1 D C^%DTC
"RTN","SCRPW74",115,0)
 S X=X+SDTIME Q X
"RTN","SCRPW74",116,0)
 ;
"RTN","SCRPW74",117,0)
SCHED(SDEX,SDT,SDRPT,SDMON,SDKID) ;Schedule repetitive extract run
"RTN","SCRPW74",118,0)
 ;Input: SDEX=extract type
"RTN","SCRPW74",119,0)
 ;Input: SDT=date/time to queue extract
"RTN","SCRPW74",120,0)
 ;Input: SDRPT=month/year of report^begin date of report data
"RTN","SCRPW74",121,0)
 ;Input: SDMON=report parameters from MON^SCRPW74 (pass by reference)
"RTN","SCRPW74",122,0)
 ;Input: SDKID='1' if from KIDS install (optional)
"RTN","SCRPW74",123,0)
 N SDI,Y,ZTSK,ZTRTN,ZTDESC,ZTDTH,ZTIO,ZTSAVE
"RTN","SCRPW74",124,0)
 S ZTDTH=SDT,ZTSAVE("SDMON(")="",ZTRTN="RUN^SCRPW74(1)",ZTIO=""
"RTN","SCRPW74",125,0)
 S ZTDESC="Clinic Appointment Wait Time Extract ("_SDMON("SDEX")_")"
"RTN","SCRPW74",126,0)
 F SDI=1:1:20 D ^%ZTLOAD Q:$G(ZTSK)
"RTN","SCRPW74",127,0)
 ;
"RTN","SCRPW74",128,0)
QQ I '$G(ZTSK) D  Q
"RTN","SCRPW74",129,0)
 .I $G(SDKID) D BMES^XPDUTL("Extract not queued!!!") Q
"RTN","SCRPW74",130,0)
 .W !!,"Extract not queued!!!",! Q
"RTN","SCRPW74",131,0)
 S Y=SDT X ^DD("DD")
"RTN","SCRPW74",132,0)
 I $G(SDKID) D BMES^XPDUTL("Extract "_SDEX_" queued for "_Y_", task number: "_ZTSK)
"RTN","SCRPW74",133,0)
 I '$G(SDKID) W !!,"Extract "_SDEX_" queued for "_Y_", task number: "_ZTSK,!
"RTN","SCRPW74",134,0)
 ;
"RTN","SCRPW74",135,0)
XTMP ;Service ^XTMP nodes
"RTN","SCRPW74",136,0)
 N X1,X2,X
"RTN","SCRPW74",137,0)
 S X1=$P($P(SDT,U),"."),X2=45 D C^%DTC S SDPGDT=X
"RTN","SCRPW74",138,0)
 I '$D(^XTMP("SD53P192",0)) D
"RTN","SCRPW74",139,0)
 .S ^XTMP("SD53P192",0)=SDPGDT_"^Patch SD*5.3*192 'Clinic Wait Time' extract repetitive queuing information.  Created by user: "_DUZ
"RTN","SCRPW74",140,0)
 .Q
"RTN","SCRPW74",141,0)
 S:$P(^XTMP("SD53P192",0),U)<SDPGDT $P(^XTMP("SD53P192",0),U)=SDPGDT
"RTN","SCRPW74",142,0)
 S ^XTMP("SD53P192","EXTRACT",SDEX,"TASK")=ZTSK
"RTN","SCRPW74",143,0)
 S ^XTMP("SD53P192","EXTRACT",SDEX,"DATE")=SDT
"RTN","SCRPW74",144,0)
 S ^XTMP("SD53P192","EXTRACT",SDEX,"REPORT")=SDRPT
"RTN","SCRPW74",145,0)
 Q
"RTN","SCRPW74",146,0)
 ;
"RTN","SCRPW74",147,0)
RUN(SDR) ;Run extract (reschedule if requested)
"RTN","SCRPW74",148,0)
 ;Input: SDR='1' if rescheduling is requested, '0' otherwise.
"RTN","SCRPW74",149,0)
 N SDV,SDBDT,SDDIV,SDEDT,SDEX,SDPAST,SDPBDT,SDPEDT,SDRPT
"RTN","SCRPW74",150,0)
 S SDV="" F  S SDV=$O(SDMON(SDV)) Q:SDV=""  S @SDV=SDMON(SDV)
"RTN","SCRPW74",151,0)
 I SDR=1 D
"RTN","SCRPW74",152,0)
 .I $G(^XTMP("SD53P192","EXTRACT",SDEX,"TASK"))=ZTSK K ^XTMP("SD53P192","EXTRACT",SDEX)
"RTN","SCRPW74",153,0)
 .N SDT,SDMON
"RTN","SCRPW74",154,0)
 .S SDT=$P(SDRPT,U,2)
"RTN","SCRPW74",155,0)
 .S:SDEX=2 SDT=$S($E(SDT,4,5)=12:$E(SDT,1,3)+1_"0101",1:$E(SDT,1,5)+1_"01")
"RTN","SCRPW74",156,0)
 .S SDT=$$WHEN(SDEX),SDRPT=$$MON(SDEX,SDT,.SDMON)
"RTN","SCRPW74",157,0)
 .D SCHED(SDEX,SDT,SDRPT,.SDMON)
"RTN","SCRPW74",158,0)
 .Q
"RTN","SCRPW74",159,0)
 D EXTRACT^SCRPW72
"RTN","SCRPW74",160,0)
 ;
"RTN","SCRPW74",161,0)
EXIT I $E(IOST)="C",'$G(SDOUT),'$G(SDXM) N DIR S DIR(0)="E" D ^DIR
"RTN","SCRPW74",162,0)
 F SDI="SD","SDS","SDTMP","SDTOT","SDXM","SDNAVA","SDNAVB","SDIP","SDPAT","SDORD","SDIPLST" K ^TMP(SDI,$J)
"RTN","SCRPW74",163,0)
 K ^TMP("SDPAT",+$G(SDJN))
"RTN","SCRPW74",164,0)
 K %,%DT,%H,%I,%T,%Y,CT,D,DA,DAY,DIC,DIE,DIR,DR,DTOUT,DUOUT,ENDATE
"RTN","SCRPW74",165,0)
 K I,J,MAX,MAXDT,SC,SC0,SCNA,SD,SDAY,SDBDT,SDBEG,SDC,SDFLEN,SDREPORT
"RTN","SCRPW74",166,0)
 K SDCAP,SDCCP,SDCNAM,SDCOL,SDCP,SDCT,SDDAY,SDDIV,SDDT,SDDV,SDDW
"RTN","SCRPW74",167,0)
 K SDEDT,SDEND,SDEX,SDEXDT,SDFAC,SDFMT,SDHD,SDI,SDIN,SDINT,SDIV
"RTN","SCRPW74",168,0)
 K SDKID,SDL,SDLINE,SDMAX,SDMD,SDMG,SDMON,SDMPDT,SDNOW,SDOE,SDOE0
"RTN","SCRPW74",169,0)
 K SDOUT,SDP,SDPAGE,SDPAR,SDPAST,SDPATT,SDPBDT,SDPCT,SDPEDT,SDPG
"RTN","SCRPW74",170,0)
 K SDPGDT,SDPNOW,SDQUIT,SDR,SDRE,SDRPT,SDS,SDSC1,SDSC2,SDSIZE,SDSL
"RTN","SCRPW74",171,0)
 K SDSOH,SDSORT,SDSSC,SDSTRTDT,SDT,SDTCAP,SDTIME,SDTIT,SDTITL,SDTOE
"RTN","SCRPW74",172,0)
 K SDTSL,SDTX,SDTY,SDV,SDX,SDXM,SDXTMP,SDY,SDZ,SI,SM,SS,X,X1,X2,Y
"RTN","SCRPW74",173,0)
 K SDJN,SDFMT,SDFMTS
"RTN","SCRPW74",174,0)
 D:$D(IOM) END^SCRPW50 Q
"RTN","SCRPW75")
0^4^B47499168
"RTN","SCRPW75",1,0)
SCRPW75 ;BP-CIOFO/KEITH,ESW - Clinic Appointment Availability Extract (cont.) ; 5/15/03 3:15pm
"RTN","SCRPW75",2,0)
 ;;5.3;Scheduling;**206,223,241,249,291**;AUG 13, 1993
"RTN","SCRPW75",3,0)
 ;
"RTN","SCRPW75",4,0)
NAVA(SDBDT,SDEDT,SDEX) ;Gather next available appointment wait time information
"RTN","SCRPW75",5,0)
 ;Input: SDBDT=beginning date
"RTN","SCRPW75",6,0)
 ;Input: SDEDT=ending date
"RTN","SCRPW75",7,0)
 ;Input: SDEX='0' for user report, '1' for Austin extract
"RTN","SCRPW75",8,0)
 ;Output: ^TMP("SDNAVA",$J) array in the format:
"RTN","SCRPW75",9,0)
 ;        ^TMP("SDNAVA",$J,division)='x'
"RTN","SCRPW75",10,0)
 ;        ^TMP("SDNAVA",$J,division,credit_pair)='x'
"RTN","SCRPW75",11,0)
 ;        ^TMP("SDNAVA",$J,division,credit_pair,clinic_ifn)='x'
"RTN","SCRPW75",12,0)
 ;        ^TMP("SDNAVA",$J,division;credit_pair,clinic_ifn,date_scheduled)='x'
"RTN","SCRPW75",13,0)
 ;        where 'x' consists of:
"RTN","SCRPW75",14,0)
 ;        piece 1 = flag '0' appts.
"RTN","SCRPW75",15,0)
 ;              2 = ave. flag '0' wait time
"RTN","SCRPW75",16,0)
 ;              3 = flag '1' appts.
"RTN","SCRPW75",17,0)
 ;              4 = ave. flag '1' wait time
"RTN","SCRPW75",18,0)
 ;              5 = flag '2' appts.
"RTN","SCRPW75",19,0)
 ;              6 = ave. flag '2' wait time
"RTN","SCRPW75",20,0)
 ;              7 = flag '3' appts.
"RTN","SCRPW75",21,0)
 ;              8 = ave. flag '3' wait time
"RTN","SCRPW75",22,0)
 ;              9 = follow-up next ava. appts.
"RTN","SCRPW75",23,0)
 ;             10 = follow-up next ava. wait time
"RTN","SCRPW75",24,0)
 ;             11 = follow-up non-next ava. appts. <2 days
"RTN","SCRPW75",25,0)
 ;             12 = follow-up non-next ava. appts. <2 days wait time*
"RTN","SCRPW75",26,0)
 ;             13 = follow-up non-next ava. appts. 2-7 days
"RTN","SCRPW75",27,0)
 ;             14 = follow-up non-next ava. appts. 2-7 days wait time*
"RTN","SCRPW75",28,0)
 ;             15 = follow-up non-next ava. appts. 8-30 days
"RTN","SCRPW75",29,0)
 ;             16 = follow-up non-next ava. appts. 8-30 days wait time*
"RTN","SCRPW75",30,0)
 ;             17 = follow-up non-next ava. appts. 31-60 days
"RTN","SCRPW75",31,0)
 ;             18 = follow-up non-next ava. appts. 31-60 days wait time*
"RTN","SCRPW75",32,0)
 ;             19 = follow-up non-next ava. appts. >60 days
"RTN","SCRPW75",33,0)
 ;             20 = follow-up non-next ava. appts. >60 days wait time*
"RTN","SCRPW75",34,0)
 ;             21 = non-follow-up next ava. appts.
"RTN","SCRPW75",35,0)
 ;             22 = non-follow-up next ava. wait time
"RTN","SCRPW75",36,0)
 ;             23 = non-follow-up non-next ava. appts. <2 days
"RTN","SCRPW75",37,0)
 ;             24 = non-follow-up non-next ava. appts. <2 days wait time*
"RTN","SCRPW75",38,0)
 ;             25 = non-follow-up non-next ava. appts. <2 days wait time**
"RTN","SCRPW75",39,0)
 ;             26 = non-follow-up non-next ava. appts. 2-7 days
"RTN","SCRPW75",40,0)
 ;             27 = non-follow-up non-next ava. appts. 2-7 days wait time*
"RTN","SCRPW75",41,0)
 ;             28 = non-follow-up non-next ava. appts. 2-7 days wait time**
"RTN","SCRPW75",42,0)
 ;             29 = non-follow-up non-next ava. appts. 8-30 days
"RTN","SCRPW75",43,0)
 ;             30 = non-follow-up non-next ava. appts. 8-30 days wait time*
"RTN","SCRPW75",44,0)
 ;             31 = non-follow-up non-next ava. appts. 8-30 days wait time**
"RTN","SCRPW75",45,0)
 ;             32 = non-follow-up non-next ava. appts. 31-60 days
"RTN","SCRPW75",46,0)
 ;             33 = non-follow-up non-next ava. appts. 31-60 days wait time*
"RTN","SCRPW75",47,0)
 ;             34 = non-follow-up non-next ava. appts. 31-60 days wait time**
"RTN","SCRPW75",48,0)
 ;             35 = non-follow-up non-next ava. appts. >60 days
"RTN","SCRPW75",49,0)
 ;             36 = non-follow-up non-next ava. appts. >60 days wait time*
"RTN","SCRPW75",50,0)
 ;             37 = non-follow-up non-next ava. appts. >60 days wait time**
"RTN","SCRPW75",51,0)
 ;             38 = percent of non-next ava. appts. within 30 days
"RTN","SCRPW75",52,0)
 ;             39 = percent of next ava. appts. within 30 days
"RTN","SCRPW75",53,0)
 ;
"RTN","SCRPW75",54,0)
 ;      ^TMP("SDNAVB",$J) array in the format:
"RTN","SCRPW75",55,0)
 ;      ^TMP("SDNAVB",$J,division,credit_pair,clinic_ifn)='y'
"RTN","SCRPW75",56,0)
 ;      where 'y' consists of: 
"RTN","SCRPW75",57,0)
 ;      piece 1 = % non-follow-up next ava. appts. within 30 days*
"RTN","SCRPW75",58,0)
 ;            2 = % non-follow-up next ava. appts. within 30 days**
"RTN","SCRPW75",59,0)
 ;            3 = % non-follow-up non-next ava. appts. within 30 days*
"RTN","SCRPW75",60,0)
 ;            4 = % non-follow-up non-next ava. appts. within 30 days**
"RTN","SCRPW75",61,0)
 ;            5 = sum of squared wait time next ava. appts.**
"RTN","SCRPW75",62,0)
 ;            6 = sum of squared wait time non-follow-up appts.*
"RTN","SCRPW75",63,0)
 ;            7 = sum of squared wait time non-follow-up appts.**
"RTN","SCRPW75",64,0)
 ;            8 = total non-follow-up appointments
"RTN","SCRPW75",65,0)
 ;
"RTN","SCRPW75",66,0)
 ;              * desired date to appointment date
"RTN","SCRPW75",67,0)
 ;             ** transaction date to appointment date         
"RTN","SCRPW75",68,0)
 ;
"RTN","SCRPW75",69,0)
 N SDT,SDCT,DFN,SDADT,SDAP,SDAP0,SDWAIT,SDSFU,SDCWT3,SDAVE
"RTN","SCRPW75",70,0)
 N SDCL,SDFLAG,SDX,SDY,SDZ,SDI,SC0,SDCP,SDSDEV,SDSDDT,SDAVE2
"RTN","SCRPW75",71,0)
 S SDT=SDBDT-1,(SDOUT,SDCT)=0
"RTN","SCRPW75",72,0)
 K ^TMP("SDWNAVA",$J),^TMP("SDXNAVA",$J),^TMP("SDYNAVA",$J),^TMP("SDZNAVA",$J),^TMP("SDNAVA",$J),^TMP("SDNAVB",$J)
"RTN","SCRPW75",73,0)
 ;Iterate through 'date scheduled' xref
"RTN","SCRPW75",74,0)
 F  S SDT=$O(^DPT("ASADM",SDT)) Q:SDOUT!'SDT!(SDT>SDEDT)  S DFN=0 D
"RTN","SCRPW75",75,0)
 .F  S DFN=$O(^DPT("ASADM",SDT,DFN)) Q:SDOUT!'DFN  S SDADT=0 D
"RTN","SCRPW75",76,0)
 ..I $G(SDREPORT(5))=1 I '$D(^TMP("SDIPLST",$J,DFN)) Q  ;only selected patient if (5)
"RTN","SCRPW75",77,0)
 ..Q:$E($P($G(^DPT(DFN,0)),U,9),1,5)="00000"  ;exclude test patients
"RTN","SCRPW75",78,0)
 ..F  S SDADT=$O(^DPT("ASADM",SDT,DFN,SDADT)) Q:SDOUT!'SDADT  D
"RTN","SCRPW75",79,0)
 ...;Check for 'stop task' request
"RTN","SCRPW75",80,0)
 ...S SDCT=SDCT+1 I SDCT#1000=0 D STOP Q:SDOUT
"RTN","SCRPW75",81,0)
 ...;Get appointment node
"RTN","SCRPW75",82,0)
 ...S SDAP0=$G(^DPT(DFN,"S",SDADT,0)) Q:$P(SDAP0,U,19)'=SDT
"RTN","SCRPW75",83,0)
 ...I '$G(SDREPORT(5)) Q:$P(SDAP0,U,2)="C"!($P(SDAP0,U,2)="CA")   ;quit if cancelled by clinic
"RTN","SCRPW75",84,0)
 ...S SDCL=+SDAP0 Q:SDCL<1  ;get clinic
"RTN","SCRPW75",85,0)
 ...;'next ava.' appointment indicator
"RTN","SCRPW75",86,0)
 ...S SDFLAG=+$P(SDAP0,U,26)
"RTN","SCRPW75",87,0)
 ...;'date desired' and 'follow up visit' indicator
"RTN","SCRPW75",88,0)
 ...S SDX=$G(^DPT(DFN,"S",SDADT,1))
"RTN","SCRPW75",89,0)
 ...S SDSDDT=+$P(SDX,U),SDSFU=$P(SDX,U,2),SDSDEV=""
"RTN","SCRPW75",90,0)
 ...;Calculate wait time 1 (transaction date to appointment)
"RTN","SCRPW75",91,0)
 ...S SDWAIT=$S(SDADT<SDT:0,1:$$FMDIFF^XLFDT(SDADT,SDT,1))
"RTN","SCRPW75",92,0)
 ...;Calculate wait time 2 (date desired to appointment)
"RTN","SCRPW75",93,0)
 ...S SDCWT3=$$CWT3(SDADT,SDFLAG,SDSDDT,SDSFU,.SDSDEV,.SDX,.SDY,.SDZ)
"RTN","SCRPW75",94,0)
 ...;Gather patient appointment list information
"RTN","SCRPW75",95,0)
 ...I $G(SDREPORT(4)),$D(^TMP("SDPLIST",$J,SDCL)) D
"RTN","SCRPW75",96,0)
 ....N SDPNAME,SDATA,SDSSN
"RTN","SCRPW75",97,0)
 ....S SDATA=$G(^DPT(DFN,0))
"RTN","SCRPW75",98,0)
 ....S SDSSN=$P(SDATA,U,9),SDPNAME=$P(SDATA,U) Q:'$L(SDPNAME)
"RTN","SCRPW75",99,0)
 ....S SDATA=SDSSN_U_$P(SDAP0,U,25)_U_SDFLAG_U_SDSDDT_U_SDSFU_U_SDWAIT_U_SDSDEV
"RTN","SCRPW75",100,0)
 ....S ^TMP("SDPLIST",$J,SDCL,SDT,SDPNAME,DFN,SDADT)=SDATA
"RTN","SCRPW75",101,0)
 ....Q
"RTN","SCRPW75",102,0)
 ...I $G(SDREPORT(5)) I $D(^TMP("SDIPLST",$J,DFN,SDCL)) D GEN5A^SCRPW78(SDAP0,DFN,SDADT,SDCL,SDWAIT,SDT,SDSFU,SDSDEV,SDSDDT,SDFLAG)
"RTN","SCRPW75",103,0)
 ...;Accrue phase II values ('next ava.' appts.)
"RTN","SCRPW75",104,0)
 ...S $P(^TMP("SDXNAVA",$J,SDCL),U,((SDFLAG*2)+1))=$P($G(^TMP("SDXNAVA",$J,SDCL)),U,((SDFLAG*2)+1))+1
"RTN","SCRPW75",105,0)
 ...S $P(^TMP("SDXNAVA",$J,SDCL),U,((SDFLAG*2)+2))=$P(^TMP("SDXNAVA",$J,SDCL),U,((SDFLAG*2)+2))+SDWAIT
"RTN","SCRPW75",106,0)
 ...I SDWAIT<31 S $P(^TMP("SDXNAVA",$J,SDCL),U,9+(SDFLAG#2))=$P(^TMP("SDXNAVA",$J,SDCL),U,9+(SDFLAG#2))+1
"RTN","SCRPW75",107,0)
 ...;Accrue sum of squared wait time for standard deviation
"RTN","SCRPW75",108,0)
 ...I SDFLAG#2 S $P(^TMP("SDWNAVA",$J,SDCL),U,5)=$P($G(^TMP("SDWNAVA",$J,SDCL)),U,5)+(SDWAIT*SDWAIT)
"RTN","SCRPW75",109,0)
 ...;Accrue phase III values ('date desired' deviation)
"RTN","SCRPW75",110,0)
 ...I SDCWT3 D
"RTN","SCRPW75",111,0)
 ....S $P(^TMP("SDYNAVA",$J,SDCL),U,SDX)=$P($G(^TMP("SDYNAVA",$J,SDCL)),U,SDX)+1
"RTN","SCRPW75",112,0)
 ....S $P(^TMP("SDYNAVA",$J,SDCL),U,SDY)=$P(^TMP("SDYNAVA",$J,SDCL),U,SDY)+SDSDEV
"RTN","SCRPW75",113,0)
 ....S:SDZ $P(^TMP("SDYNAVA",$J,SDCL),U,SDZ)=$P(^TMP("SDYNAVA",$J,SDCL),U,SDZ)+SDWAIT
"RTN","SCRPW75",114,0)
 ....;Gather additional information for non-follow-up appointments
"RTN","SCRPW75",115,0)
 ....I 'SDSFU D
"RTN","SCRPW75",116,0)
 .....;Accrue next ava. and non-next ava. appts. less than 31 days
"RTN","SCRPW75",117,0)
 .....N SDP S SDP=$S(SDFLAG#2:1,1:3)
"RTN","SCRPW75",118,0)
 .....I SDSDEV<31 S $P(^TMP("SDWNAVA",$J,SDCL),U,SDP)=$P($G(^TMP("SDWNAVA",$J,SDCL)),U,SDP)+1
"RTN","SCRPW75",119,0)
 .....I SDWAIT<31 S $P(^TMP("SDWNAVA",$J,SDCL),U,SDP+1)=$P($G(^TMP("SDWNAVA",$J,SDCL)),U,SDP+1)+1
"RTN","SCRPW75",120,0)
 .....;Accrue sum of squared wait time for standard deviation
"RTN","SCRPW75",121,0)
 .....S $P(^TMP("SDWNAVA",$J,SDCL),U,6)=$P($G(^TMP("SDWNAVA",$J,SDCL)),U,6)+(SDSDEV*SDSDEV)
"RTN","SCRPW75",122,0)
 .....S $P(^TMP("SDWNAVA",$J,SDCL),U,7)=$P(^TMP("SDWNAVA",$J,SDCL),U,7)+(SDWAIT*SDWAIT)
"RTN","SCRPW75",123,0)
 .....;Total of non-follow-up appointments
"RTN","SCRPW75",124,0)
 .....S $P(^TMP("SDWNAVA",$J,SDCL),U,8)=$P(^TMP("SDWNAVA",$J,SDCL),U,8)+1
"RTN","SCRPW75",125,0)
 .....Q
"RTN","SCRPW75",126,0)
 ....Q
"RTN","SCRPW75",127,0)
 ...;Accrue values for daily detail
"RTN","SCRPW75",128,0)
 ...Q:SDEX=1!(SDFMT'="D")
"RTN","SCRPW75",129,0)
 ...S $P(^TMP("SDXNAVA",$J,SDCL,SDT),U,((SDFLAG*2)+1))=$P($G(^TMP("SDXNAVA",$J,SDCL,SDT)),U,((SDFLAG*2)+1))+1
"RTN","SCRPW75",130,0)
 ...S $P(^TMP("SDXNAVA",$J,SDCL,SDT),U,((SDFLAG*2)+2))=$P(^TMP("SDXNAVA",$J,SDCL,SDT),U,((SDFLAG*2)+2))+SDWAIT
"RTN","SCRPW75",131,0)
 ...I SDWAIT<31 S $P(^TMP("SDXNAVA",$J,SDCL,SDT),U,9+(SDFLAG#2))=$P($G(^TMP("SDXNAVA",$J,SDCL,SDT)),U,9+(SDFLAG#2))+1
"RTN","SCRPW75",132,0)
 ...I SDCWT3 D
"RTN","SCRPW75",133,0)
 ....S $P(^TMP("SDYNAVA",$J,SDCL,SDT),U,SDX)=$P($G(^TMP("SDYNAVA",$J,SDCL,SDT)),U,SDX)+1
"RTN","SCRPW75",134,0)
 ....S $P(^TMP("SDYNAVA",$J,SDCL,SDT),U,SDY)=$P(^TMP("SDYNAVA",$J,SDCL,SDT),U,SDY)+SDSDEV
"RTN","SCRPW75",135,0)
 ....S:SDZ $P(^TMP("SDYNAVA",$J,SDCL,SDT),U,SDZ)=$P(^TMP("SDYNAVA",$J,SDCL,SDT),U,SDZ)+SDWAIT
"RTN","SCRPW75",136,0)
 ...Q
"RTN","SCRPW75",137,0)
 ..Q
"RTN","SCRPW75",138,0)
 .Q
"RTN","SCRPW75",139,0)
 Q:SDOUT  S SDCL=0
"RTN","SCRPW75",140,0)
 D ACCRUE^SCRPW77
"RTN","SCRPW75",141,0)
 Q
"RTN","SCRPW75",142,0)
 ;
"RTN","SCRPW75",143,0)
STOP ;Check for stop task request
"RTN","SCRPW75",144,0)
 S:$D(ZTQUEUED) (SDOUT,ZTSTOP)=$S($$S^%ZTLOAD:1,1:0) Q
"RTN","SCRPW75",145,0)
 ;
"RTN","SCRPW75",146,0)
CWT3(SDADT,SDFLAG,SDSDDT,SDSFU,SDSDEV,SDX,SDY,SDZ)      ;Get phase III data
"RTN","SCRPW75",147,0)
 ;Input: SDADT=appointment date
"RTN","SCRPW75",148,0)
 ;Input: SDFLAG='next ava.' appointment indicator
"RTN","SCRPW75",149,0)
 ;Input: SDSDDT=desired date
"RTN","SCRPW75",150,0)
 ;Input: SDSFU=follow up indicator
"RTN","SCRPW75",151,0)
 ;Input: SDSDEV=deviation from desired date (pass by reference)
"RTN","SCRPW75",152,0)
 ;Input: SDX, SDY, SDZ=string locations to update (pass by reference)
"RTN","SCRPW75",153,0)
 ;Output: '1' if phase III data exists, '0' otherwise
"RTN","SCRPW75",154,0)
 ;
"RTN","SCRPW75",155,0)
 N SDDCAT
"RTN","SCRPW75",156,0)
 I '$L(SDSDDT)!'$L(SDSFU) Q 0  ;no phase III data
"RTN","SCRPW75",157,0)
 S SDSDEV=$S(SDADT<SDSDDT:0,1:$$FMDIFF^XLFDT(SDADT,SDSDDT,1))  ;wait time
"RTN","SCRPW75",158,0)
 S SDDCAT=$$DCAT(SDSDEV)  ;date range category
"RTN","SCRPW75",159,0)
 ;follow-up next ava. appts.
"RTN","SCRPW75",160,0)
 I SDSFU,SDFLAG#2 S SDX=1,SDY=2,SDZ=0 Q 1
"RTN","SCRPW75",161,0)
 ;follow-up non-next ava. appts.
"RTN","SCRPW75",162,0)
 I SDSFU,'(SDFLAG#2) S SDX=SDDCAT*2+1,SDY=SDX+1,SDZ=0 Q 1
"RTN","SCRPW75",163,0)
 ;non-follow-up next ava. appts.
"RTN","SCRPW75",164,0)
 I 'SDSFU,SDFLAG#2 S SDX=13,SDY=14,SDZ=0 Q 1
"RTN","SCRPW75",165,0)
 ;non-follow-up non-next ava. appts.
"RTN","SCRPW75",166,0)
 I 'SDSFU,'(SDFLAG#2) S SDX=SDDCAT+4*3,SDY=SDX+1,SDZ=SDX+2
"RTN","SCRPW75",167,0)
 Q 1
"RTN","SCRPW75",168,0)
 ;
"RTN","SCRPW75",169,0)
DCAT(SDSDEV)    ;Determine date range category
"RTN","SCRPW75",170,0)
 ;Input: SDSDEV=wait time
"RTN","SCRPW75",171,0)
 ;Output: category where '1' = <2 days
"RTN","SCRPW75",172,0)
 ;                       '2' = 2-7 days
"RTN","SCRPW75",173,0)
 ;                       '3' = 8-30 days
"RTN","SCRPW75",174,0)
 ;                       '4' = 31-60 days
"RTN","SCRPW75",175,0)
 ;                       '5' = >60 days
"RTN","SCRPW75",176,0)
 ;
"RTN","SCRPW75",177,0)
 Q:SDSDEV<2 1
"RTN","SCRPW75",178,0)
 Q:SDSDEV<8 2
"RTN","SCRPW75",179,0)
 Q:SDSDEV<31 3
"RTN","SCRPW75",180,0)
 Q:SDSDEV<61 4
"RTN","SCRPW75",181,0)
 Q 5
"RTN","SCRPW76")
0^5^B75489890
"RTN","SCRPW76",1,0)
SCRPW76 ;BP-OIFO/KEITH,ESW - Clinic appointment availability extract (cont.) ; 5/28/03 4:02pm
"RTN","SCRPW76",2,0)
 ;;5.3;Scheduling;**223,291**;AUG 13, 1993
"RTN","SCRPW76",3,0)
 ;
"RTN","SCRPW76",4,0)
HINI ;Initialize header variables
"RTN","SCRPW76",5,0)
 N %,%H,%I,X,X1,X2
"RTN","SCRPW76",6,0)
 S SDLINE="",$P(SDLINE,"-",$S(SDPAST:133,1:(SDIOM+1)))="",SDPAGE=1,SDPG=0
"RTN","SCRPW76",7,0)
 D NOW^%DTC S Y=% X ^DD("DD") S SDPNOW=$P(Y,":",1,2)
"RTN","SCRPW76",8,0)
 S SDTITL="<*>  Clinic Appointment Availability Report  <*>"
"RTN","SCRPW76",9,0)
 Q
"RTN","SCRPW76",10,0)
 ;
"RTN","SCRPW76",11,0)
HDR(SDTY,SDREPORT,SDIV,SDCP,SC) ;Print header
"RTN","SCRPW76",12,0)
 ;Input: SDTY=type of header where:
"RTN","SCRPW76",13,0)
 ;            '0'=negative report
"RTN","SCRPW76",14,0)
 ;            '1'=detailed report
"RTN","SCRPW76",15,0)
 ;            '2'=division summary
"RTN","SCRPW76",16,0)
 ;            '3'=facility summary
"RTN","SCRPW76",17,0)
 ;Input: SDREPORT=report output element where:
"RTN","SCRPW76",18,0)
 ;            '1'='next ava.' appt. information
"RTN","SCRPW76",19,0)
 ;            '2'='follow up' appt. information
"RTN","SCRPW76",20,0)
 ;            '3'='non-follow up' appt. information
"RTN","SCRPW76",21,0)
 ;Input: SDIV=division name^division number
"RTN","SCRPW76",22,0)
 ;Input: SDCP=credit pair
"RTN","SCRPW76",23,0)
 ;Input: SC=clinic ifn
"RTN","SCRPW76",24,0)
 ;
"RTN","SCRPW76",25,0)
 Q:SDOUT
"RTN","SCRPW76",26,0)
 I $G(SDXM) D HDRXM(SDREPORT) Q
"RTN","SCRPW76",27,0)
 I $E(IOST)="C",SDPG N DIR S DIR(0)="E" W ! D ^DIR S SDOUT=Y'=1 Q:SDOUT
"RTN","SCRPW76",28,0)
 N SDX,SDI D STOP Q:SDOUT
"RTN","SCRPW76",29,0)
 W:SDPG!($E(IOST)="C") $$XY^SCRPW50(IOF,1,0) W:$X $$XY^SCRPW50("",0,0)
"RTN","SCRPW76",30,0)
 W SDLINE,!?(SDIOM-$L(SDTITL)\2),SDTITL
"RTN","SCRPW76",31,0)
 I SDREPORT=1,'SDPAST S SDX="Clinic availability data"
"RTN","SCRPW76",32,0)
 I SDREPORT=1,SDPAST S SDX="Clinic availability and 'next available' appointment data"
"RTN","SCRPW76",33,0)
 I SDREPORT=2 S SDX="'Follow up' appointment data"
"RTN","SCRPW76",34,0)
 I SDREPORT=3 S SDX="'Non-follow up' appointment data"
"RTN","SCRPW76",35,0)
 I SDREPORT=4 S SDX="Listing of patient appointments"
"RTN","SCRPW76",36,0)
 I SDREPORT=5 S SDX="Listing of appointments for selected patient"
"RTN","SCRPW76",37,0)
 W !?(SDIOM-$L(SDX)\2),SDX
"RTN","SCRPW76",38,0)
 D HDRX(SDTY) Q:SDOUT  S SDI=0
"RTN","SCRPW76",39,0)
 I $G(SDREPORT)'=5 F  S SDI=$O(SDTIT(SDI)) Q:'SDI  W !?(SDIOM-$L(SDTIT(SDI))\2),SDTIT(SDI)
"RTN","SCRPW76",40,0)
 I $G(SDREPORT)=5 Q:'$O(SDTIT(""))  D
"RTN","SCRPW76",41,0)
 .N SD F SD=1,2 W !?(SDIOM-$L(SDTIT(SD))\2),SDTIT(SD)
"RTN","SCRPW76",42,0)
 .W !,SDTIT(3),?100,SDTIT(4),!,SDTIT(5),?100,SDTIT(6)
"RTN","SCRPW76",43,0)
 W !,SDLINE
"RTN","SCRPW76",44,0)
 W !,"For clinic availability dates ",SDPBDT," through ",SDPEDT
"RTN","SCRPW76",45,0)
 W !,"Date printed: ",SDPNOW,?(IOM-6-$L(SDPAGE)),"Page: ",SDPAGE
"RTN","SCRPW76",46,0)
 W !,SDLINE
"RTN","SCRPW76",47,0)
 S SDPAGE=SDPAGE+1,SDPG=1 D:SDTY SUBT(SDTY,SDREPORT) Q
"RTN","SCRPW76",48,0)
 ;
"RTN","SCRPW76",49,0)
HDRX(SDTY) ;Extra header lines
"RTN","SCRPW76",50,0)
 K SDTIT
"RTN","SCRPW76",51,0)
 Q:SDTY=0  S SDIV=$G(SDIV)
"RTN","SCRPW76",52,0)
 I SDTY=3 S SDTIT(1)="Facility Summary" Q
"RTN","SCRPW76",53,0)
 N SDDV S SDDV=$P(SDIV,U)_" ("_$P(SDIV,U,2)_")"
"RTN","SCRPW76",54,0)
 I SDTY=2 S SDTIT(1)="Summary for division: "_SDDV Q
"RTN","SCRPW76",55,0)
 S SDTIT(1)="Division: "_SDDV
"RTN","SCRPW76",56,0)
 S:SDSORT="CP" SDTIT(2)="For clinics with credit pair: "_$$OTX^SCRPW73("CP")
"RTN","SCRPW76",57,0)
 I $G(SDREPORT)=5 D
"RTN","SCRPW76",58,0)
 .S:SDSORT="CP" SDTIT(2)="For clinics with selected credit pair"
"RTN","SCRPW76",59,0)
 .S:SDSORT="CA" SDTIT(2)="For all clinics"
"RTN","SCRPW76",60,0)
 .S:SDSORT="CL" SDTIT(2)="For clinics selected by name"
"RTN","SCRPW76",61,0)
 .N DA,DIC,DIQ,DR
"RTN","SCRPW76",62,0)
 .S DIC=2,SDPT=DIC,DA=$G(DFN) F DR=.01,.09 N SDPT,SDARR S DIQ="SDARR(",DIQ(0)="I" D EN^DIQ1 D
"RTN","SCRPW76",63,0)
 ..I DR=.01 S SDTIT(3)="Patient: "_SDARR(2,DA,.01,"I")
"RTN","SCRPW76",64,0)
 ..I DR=.09 S SDTIT(4)="SSN: "_SDARR(2,DA,.09,"I")
"RTN","SCRPW76",65,0)
 .S SDTIT(5)="Clinic: "_$P(^SC(SC,0),U)
"RTN","SCRPW76",66,0)
 .S SDTIT(6)="Clinic Stop Code Pair: "_SDCP
"RTN","SCRPW76",67,0)
 E  S SDTIT(3)="Detail for clinic: "_$$OTX^SCRPW73("CL")
"RTN","SCRPW76",68,0)
 Q
"RTN","SCRPW76",69,0)
 ;
"RTN","SCRPW76",70,0)
SUBT(SDTY,SDREPORT) ;Print subtitles
"RTN","SCRPW76",71,0)
 D:SDREPORT=1 SUBT1 D:SDREPORT=2 SUBT2
"RTN","SCRPW76",72,0)
 D:SDREPORT=3 SUBT3 D:SDREPORT=4 SUBT4
"RTN","SCRPW76",73,0)
 D:SDREPORT=5 SUBT5
"RTN","SCRPW76",74,0)
 Q
"RTN","SCRPW76",75,0)
 ;
"RTN","SCRPW76",76,0)
SUBT1 N SDI
"RTN","SCRPW76",77,0)
 W !?(SDCOL+44),"Ava.",?(SDCOL+51),"Pct."
"RTN","SCRPW76",78,0)
 I SDPAST D
"RTN","SCRPW76",79,0)
 .F SDI=0:1:3 W ?(SDCOL+63+(14*SDI)),"--Type '",SDI,"'---"
"RTN","SCRPW76",80,0)
 .W ?120,"% NNA   % NA" Q
"RTN","SCRPW76",81,0)
 W ! W:SDTY>1 ?(SDCOL),"Credit Pair"
"RTN","SCRPW76",82,0)
 W ?(SDCOL+35),"Clinic",?(SDCOL+43),"Appt.",?(SDCOL+50),"Slots"
"RTN","SCRPW76",83,0)
 I SDPAST D
"RTN","SCRPW76",84,0)
 .W ?(SDCOL+56),"Clinic"
"RTN","SCRPW76",85,0)
 .F SDI=0:1:3 W ?(SDCOL+65+(14*SDI)),"Sch.   Wait"
"RTN","SCRPW76",86,0)
 .W ?122,"<31    <31" Q
"RTN","SCRPW76",87,0)
 W !?(SDCOL+4),$S(SDTY=1:"Availability Date",1:"Clinic Name")
"RTN","SCRPW76",88,0)
 W ?(SDCOL+33),"Capacity",?(SDCOL+43),"Slots",?(SDCOL+51),"Ava."
"RTN","SCRPW76",89,0)
 I SDPAST D
"RTN","SCRPW76",90,0)
 .W ?(SDCOL+58),"Enc."
"RTN","SCRPW76",91,0)
 .F SDI=0:1:3 W ?(SDCOL+64+(14*SDI)),"Appts   Time"
"RTN","SCRPW76",92,0)
 .W ?121,"Days   Days"
"RTN","SCRPW76",93,0)
 W !?(SDCOL),$E(SDLINE,1,($S(SDPAST:132,1:58)))
"RTN","SCRPW76",94,0)
 Q
"RTN","SCRPW76",95,0)
 ;
"RTN","SCRPW76",96,0)
SUBT2 N SDI
"RTN","SCRPW76",97,0)
 W !?48,"Next",?54,$E(SDLINE,1,24),"Non-next Available Appointments",$E(SDLINE,1,23)
"RTN","SCRPW76",98,0)
 W !?40,"Next    Ava.     0-1     0-1     2-7     2-7    8-30    8-30   31-60   31-60     >60     >60"
"RTN","SCRPW76",99,0)
 W ! W:SDTY>1 "Credit Pair" W ?40,"Ava.    Wait"
"RTN","SCRPW76",100,0)
 F SDI=56:16:121 W ?(SDI),"Days    Wait"
"RTN","SCRPW76",101,0)
 W !?4,$S(SDTY=1:"Availability Date",1:"Clinic Name")
"RTN","SCRPW76",102,0)
 F SDI=39:16:120 W ?(SDI),"Appts    Time"
"RTN","SCRPW76",103,0)
 W !,SDLINE
"RTN","SCRPW76",104,0)
 Q
"RTN","SCRPW76",105,0)
 ;
"RTN","SCRPW76",106,0)
SUBT3 N SDI
"RTN","SCRPW76",107,0)
 W !?38,"Next",?43,$E(SDLINE,1,29),"Non-next Available Appointments",$E(SDLINE,1,29)
"RTN","SCRPW76",108,0)
 W !?32,"Next  Ava.   0-1   0-1   0-1   2-7   2-7   2-7  8-30  8-30  8-30 31-60 31-60 31-60   >60   >60   >60"
"RTN","SCRPW76",109,0)
 W ! W:SDTY>1 "Credit Pair" W ?32,"Ava.  Wait"
"RTN","SCRPW76",110,0)
 F SDI=44:18:117 W ?(SDI),"Days  Wait  Wait"
"RTN","SCRPW76",111,0)
 W !?4,$S(SDTY=1:"Availability Date",1:"Clinic Name"),?31,"Appts Time1"
"RTN","SCRPW76",112,0)
 F SDI=43:18:116 W ?(SDI),"Appts Time1 Time2"
"RTN","SCRPW76",113,0)
 W !,SDLINE
"RTN","SCRPW76",114,0)
 Q
"RTN","SCRPW76",115,0)
 ;
"RTN","SCRPW76",116,0)
SUBT4 W !?96,"Next",!,"Date",?96,"Ava.  Date               Wait   Wait"
"RTN","SCRPW76",117,0)
 W !,"Scheduled    Patient Name             SSN         Appointment Date   Scheduling Request Type    Ind.  Desired      F/U  Time1  Time2"
"RTN","SCRPW76",118,0)
 W !,SDLINE
"RTN","SCRPW76",119,0)
 Q
"RTN","SCRPW76",120,0)
 ;
"RTN","SCRPW76",121,0)
SUBT5 W !?11,"SCHEDULING",?63,"TIME",!,"DATE",?11,"REQUEST",?31,"DATE",?58,"WAIT",?63,"TO",?68,"APPT",?96,"APPT",?102,"COMPLETION"
"RTN","SCRPW76",122,0)
 W !,"SCHEDULED",?11,"TYPE",?31,"DESIRED",?42,"APPT DATE/TIME",?58,"TIME",?63,"APPT",?68,"TYPE",?73,"F/U",?79,"REBOOK DATE",?96,"STAT",?102,"DATE",?113,"SCHEDULER"
"RTN","SCRPW76",123,0)
 W !,SDLINE
"RTN","SCRPW76",124,0)
 Q
"RTN","SCRPW76",125,0)
HDRXM(SDREPORT)   ;Create header in mail message
"RTN","SCRPW76",126,0)
 ;Input: SDREPORT=report element to print
"RTN","SCRPW76",127,0)
 ;
"RTN","SCRPW76",128,0)
 N SDX,SDI,SDZ
"RTN","SCRPW76",129,0)
 I SDPAGE>1 F SDI=1:1:5 D XMTX("")
"RTN","SCRPW76",130,0)
 D XMTX($E(SDLINE,1,$S('SDPAST:79,1:132)))
"RTN","SCRPW76",131,0)
 S SDZ="",$E(SDZ,($S(SDPAST:132,1:79)-$L(SDTITL)\2))=SDTITL D XMTX(SDZ)
"RTN","SCRPW76",132,0)
 I SDREPORT=1,'SDPAST S SDX="Clinic availability data"
"RTN","SCRPW76",133,0)
 I SDREPORT=1,SDPAST S SDX="Clinic availability and 'next available' appointment data"
"RTN","SCRPW76",134,0)
 I SDREPORT=2 S SDX="'Follow up' appointment data"
"RTN","SCRPW76",135,0)
 I SDREPORT=3 S SDX="'Non-follow up' appointment data"
"RTN","SCRPW76",136,0)
 I SDREPORT=4 S SDX="Listing of patient appointments"
"RTN","SCRPW76",137,0)
 I SDREPORT=5 S SDX="Listing of appointments for selected patient"
"RTN","SCRPW76",138,0)
 S SDZ="",$E(SDZ,($S(SDPAST:132,1:79)-$L(SDX)\2))=SDX D XMTX(SDZ)
"RTN","SCRPW76",139,0)
 D HDRX(SDTY) S SDI=0
"RTN","SCRPW76",140,0)
 F  S SDI=$O(SDTIT(SDI)) Q:'SDI  S SDZ="" D
"RTN","SCRPW76",141,0)
 .S $E(SDZ,($S(SDPAST:130,1:79)-$L(SDTIT(SDI))\2))=SDTIT(SDI) D XMTX(SDZ)
"RTN","SCRPW76",142,0)
 .Q
"RTN","SCRPW76",143,0)
 D XMTX($E(SDLINE,1,$S('SDPAST:79,1:132)))
"RTN","SCRPW76",144,0)
 D XMTX("For clinic availability dates "_SDPBDT_" through "_SDPEDT)
"RTN","SCRPW76",145,0)
 S SDZ="Date extracted: "_SDPNOW
"RTN","SCRPW76",146,0)
 D XMTX(SDZ),XMTX($E(SDLINE,1,$S('SDPAST:79,1:132)))
"RTN","SCRPW76",147,0)
 S SDPAGE=SDPAGE+1 D:SDTY SUBTXM(SDTY,SDREPORT) Q
"RTN","SCRPW76",148,0)
 ;
"RTN","SCRPW76",149,0)
SUBTXM(SDTY,SDREPORT) ;Create message header subtitles
"RTN","SCRPW76",150,0)
 N SDZ
"RTN","SCRPW76",151,0)
 D:SDREPORT=1 STXM1 D:SDREPORT=2 STXM2
"RTN","SCRPW76",152,0)
 D:SDREPORT=3 STXM3 D:SDREPORT=4 STXM4
"RTN","SCRPW76",153,0)
 Q
"RTN","SCRPW76",154,0)
 ;
"RTN","SCRPW76",155,0)
STXM1 N SDI
"RTN","SCRPW76",156,0)
 S SDZ="",$E(SDZ,45)="Ava.",$E(SDZ,52)="Pct."
"RTN","SCRPW76",157,0)
 I SDPAST D
"RTN","SCRPW76",158,0)
 .F SDI=0:1:3 D
"RTN","SCRPW76",159,0)
 ..S $E(SDZ,(SDCOL+64+(14*SDI)))="--Type '"_SDI_"'---"
"RTN","SCRPW76",160,0)
 ..Q
"RTN","SCRPW76",161,0)
 .S $E(SDZ,121)="% NNA   % NA"
"RTN","SCRPW76",162,0)
 .Q
"RTN","SCRPW76",163,0)
 D XMTX(SDZ)
"RTN","SCRPW76",164,0)
 S SDZ="" I SDTY>1 S SDZ="Credit Pair"
"RTN","SCRPW76",165,0)
 S $E(SDZ,36)="Clinic",$E(SDZ,44)="Appt.",$E(SDZ,51)="Slots"
"RTN","SCRPW76",166,0)
 I SDPAST D
"RTN","SCRPW76",167,0)
 .S $E(SDZ,57)="Clinic"
"RTN","SCRPW76",168,0)
 .F SDI=0:1:3 S $E(SDZ,(SDCOL+66+(14*SDI)))="Sch.   Wait"
"RTN","SCRPW76",169,0)
 .S $E(SDZ,123)="<31    <31"
"RTN","SCRPW76",170,0)
 .Q
"RTN","SCRPW76",171,0)
 D XMTX(SDZ)
"RTN","SCRPW76",172,0)
 S SDZ="",$E(SDZ,4)=$S(SDTY=1:"Availability Date",1:"Clinic Name")
"RTN","SCRPW76",173,0)
 S $E(SDZ,34)="Capacity",$E(SDZ,44)="Slots",$E(SDZ,52)="Ava."
"RTN","SCRPW76",174,0)
 I SDPAST D
"RTN","SCRPW76",175,0)
 .S $E(SDZ,59)="Enc."
"RTN","SCRPW76",176,0)
 .F SDI=0:1:3 S $E(SDZ,(SDCOL+65+(14*SDI)))="Appts   Time"
"RTN","SCRPW76",177,0)
 .S $E(SDZ,122)="Days   Days"
"RTN","SCRPW76",178,0)
 .Q
"RTN","SCRPW76",179,0)
 D XMTX(SDZ)
"RTN","SCRPW76",180,0)
 S SDZ="",$E(SDZ,$S(SDTY>1:1,1:4))=$E(SDLINE,1,$S(SDPAST:132,1:58))
"RTN","SCRPW76",181,0)
 D XMTX(SDZ)
"RTN","SCRPW76",182,0)
 Q
"RTN","SCRPW76",183,0)
 ;
"RTN","SCRPW76",184,0)
STXM2 N SDI S SDZ=""
"RTN","SCRPW76",185,0)
 S $E(SDZ,49)="Next"
"RTN","SCRPW76",186,0)
 S $E(SDZ,55)=$E(SDLINE,1,24)_"Non-next Available Appointments"_$E(SDLINE,1,23)
"RTN","SCRPW76",187,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",188,0)
 S $E(SDZ,41)="Next    Ava.     0-1     0-1     2-7     2-7    8-30    8-30   31-60   31-60     >60     >60"
"RTN","SCRPW76",189,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",190,0)
 S:SDTY>1 SDZ="Credit Pair" S $E(SDZ,41)="Ava.    Wait"
"RTN","SCRPW76",191,0)
 F SDI=57:16:121 S $E(SDZ,SDI)="Days    Wait"
"RTN","SCRPW76",192,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",193,0)
 S $E(SDZ,4)=$S(SDTY=1:"Availability Date",1:"Clinic Name")
"RTN","SCRPW76",194,0)
 F SDI=40:16:120 S $E(SDZ,SDI)="Appts    Time"
"RTN","SCRPW76",195,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",196,0)
 S SDZ=SDLINE D XMTX(SDZ)
"RTN","SCRPW76",197,0)
 Q
"RTN","SCRPW76",198,0)
 ;
"RTN","SCRPW76",199,0)
STXM3 N SDI S SDZ=""
"RTN","SCRPW76",200,0)
 S $E(SDZ,39)="Next"
"RTN","SCRPW76",201,0)
 S $E(SDZ,44)=$E(SDLINE,1,29)_"Non-next Available Appointments"_$E(SDLINE,1,29)
"RTN","SCRPW76",202,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",203,0)
 S $E(SDZ,33)="Next  Ava.   0-1   0-1   0-1   2-7   2-7   2-7  8-30  8-30  8-30 31-60 31-60 31-60   >60   >60   >60"
"RTN","SCRPW76",204,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",205,0)
 S:SDTY>1 SDZ="Credit Pair" S $E(SDZ,33)="Ava.  Wait"
"RTN","SCRPW76",206,0)
 F SDI=45:18:117 S $E(SDZ,SDI)="Days  Wait  Wait"
"RTN","SCRPW76",207,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",208,0)
 S $E(SDZ,4)=$S(SDTY=1:"Availability Date",1:"Clinic Name") S $E(SDZ,32)="Appts Time1"
"RTN","SCRPW76",209,0)
 F SDI=44:18:116 S $E(SDZ,SDI)="Appts Time1 Time2"
"RTN","SCRPW76",210,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",211,0)
 S SDZ=SDLINE D XMTX(SDZ)
"RTN","SCRPW76",212,0)
 Q
"RTN","SCRPW76",213,0)
 ;
"RTN","SCRPW76",214,0)
STXM4 S SDZ=""
"RTN","SCRPW76",215,0)
 S $E(SDZ,96)="Next"
"RTN","SCRPW76",216,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",217,0)
 S SDZ="Date",$E(SDZ,96)="Ava.  Date               Wait   Wait"
"RTN","SCRPW76",218,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",219,0)
 S SDZ="Scheduled    Patient Name             SSN         Appointment Date   Scheduling Request Type    Ind.  Desired      F/U  Time1  Time2"
"RTN","SCRPW76",220,0)
 D XMTX(SDZ) S SDZ=""
"RTN","SCRPW76",221,0)
 S SDZ=SDLINE D XMTX(SDZ)
"RTN","SCRPW76",222,0)
 Q
"RTN","SCRPW76",223,0)
 ;
"RTN","SCRPW76",224,0)
STOP ;Check for stop task request
"RTN","SCRPW76",225,0)
 S:$D(ZTQUEUED) (SDOUT,ZTSTOP)=$S($$S^%ZTLOAD:1,1:0) Q
"RTN","SCRPW76",226,0)
 ;
"RTN","SCRPW76",227,0)
XMTX(SDX) ;Set mail message text line
"RTN","SCRPW76",228,0)
 ;Input: SDX=text value
"RTN","SCRPW76",229,0)
 S ^TMP("SDXM",$J,SDXM)=SDX,SDXM=SDXM+1 Q
"RTN","SCRPW77")
0^6^B100471899
"RTN","SCRPW77",1,0)
SCRPW77 ;BP-CIOFO/KEITH,ESW - Clinic Appointment Availability Extract (cont.) ; 5/28/03 4:49pm
"RTN","SCRPW77",2,0)
 ;;5.3;Scheduling;**223,241,291**;AUG 13, 1993
"RTN","SCRPW77",3,0)
 ;
"RTN","SCRPW77",4,0)
ACCRUE ;Accrue counts and averages to division and division/credit pair totals
"RTN","SCRPW77",5,0)
 F  S SDCL=$O(^TMP("SDXNAVA",$J,SDCL)) Q:'SDCL  D
"RTN","SCRPW77",6,0)
 .S SC0=$G(^SC(SDCL,0)) Q:'$L(SC0)  Q:'$$CPAIR^SCRPW71(SC0,.SDCP)
"RTN","SCRPW77",7,0)
 .S SDIV=$$DIV^SCRPW71(SC0) Q:'$L(SDIV)
"RTN","SCRPW77",8,0)
 .Q:'$D(^TMP("SD",$J,SDIV,SDCP,SDCL))
"RTN","SCRPW77",9,0)
 .S:'$D(^TMP("SDNAVA",$J,SDIV,SDCP)) ^TMP("SDNAVA",$J,SDIV,SDCP)=""
"RTN","SCRPW77",10,0)
 .I SDMD S:'$D(^TMP("SDNAVA",$J,0,SDCP)) ^TMP("SDNAVA",$J,0,SDCP)=""
"RTN","SCRPW77",11,0)
 .S SDX=$P(^TMP("SDXNAVA",$J,SDCL),U,1,8)
"RTN","SCRPW77",12,0)
 .S $P(SDX,U,9)=$G(^TMP("SDYNAVA",$J,SDCL))
"RTN","SCRPW77",13,0)
 .S $P(SDX,U,38)=$P(^TMP("SDXNAVA",$J,SDCL),U,9,10)
"RTN","SCRPW77",14,0)
 .S SDAVE=$$AVE(SDX),^TMP("SDNAVA",$J,SDIV,SDCP,SDCL)=SDAVE
"RTN","SCRPW77",15,0)
 .S:$$AVE2(SDCL,.SDAVE2) ^TMP("SDNAVB",$J,SDIV,SDCP,SDCL)=SDAVE2
"RTN","SCRPW77",16,0)
 .I SDMD S ^TMP("SDNAVA",$J,0,SDCP,SDCL)=SDAVE
"RTN","SCRPW77",17,0)
 .F SDI=1:1:18 S $P(^TMP("SDNAVA",$J,SDIV),U,SDI)=$P($G(^TMP("SDNAVA",$J,SDIV)),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",18,0)
 .F SDI=19:1:39 S $P(^TMP("SDZNAVA",$J,SDIV),U,SDI)=$P($G(^TMP("SDZNAVA",$J,SDIV)),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",19,0)
 .I SDMD D
"RTN","SCRPW77",20,0)
 ..F SDI=1:1:18 S $P(^TMP("SDNAVA",$J,0),U,SDI)=$P($G(^TMP("SDNAVA",$J,0)),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",21,0)
 ..F SDI=19:1:39 S $P(^TMP("SDZNAVA",$J,0),U,SDI)=$P($G(^TMP("SDNZAVA",$J,0)),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",22,0)
 ..Q
"RTN","SCRPW77",23,0)
 .F SDI=1:1:18 S $P(^TMP("SDNAVA",$J,SDIV,SDCP),U,SDI)=$P(^TMP("SDNAVA",$J,SDIV,SDCP),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",24,0)
 .F SDI=19:1:39 S $P(^TMP("SDZNAVA",$J,SDIV,SDCP),U,SDI)=$P($G(^TMP("SDZNAVA",$J,SDIV,SDCP)),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",25,0)
 .I SDMD D
"RTN","SCRPW77",26,0)
 ..F SDI=1:1:18 S $P(^TMP("SDNAVA",$J,0,SDCP),U,SDI)=$P(^TMP("SDNAVA",$J,0,SDCP),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",27,0)
 ..F SDI=19:1:39 S $P(^TMP("SDZNAVA",$J,0,SDCP),U,SDI)=$P($G(^TMP("SDZNAVA",$J,0,SDCP)),U,SDI)+$P(SDX,U,SDI)
"RTN","SCRPW77",28,0)
 ..Q
"RTN","SCRPW77",29,0)
 .S SDT=0 F  S SDT=$O(^TMP("SDXNAVA",$J,SDCL,SDT)) Q:SDOUT!'SDT  D
"RTN","SCRPW77",30,0)
 ..S SDX=$P(^TMP("SDXNAVA",$J,SDCL,SDT),U,1,8)
"RTN","SCRPW77",31,0)
 ..S $P(SDX,U,9)=$G(^TMP("SDYNAVA",$J,SDCL,SDT))
"RTN","SCRPW77",32,0)
 ..S $P(SDX,U,38)=$P(^TMP("SDXNAVA",$J,SDCL,SDT),U,9,10)
"RTN","SCRPW77",33,0)
 ..S ^TMP("SDNAVA",$J,SDIV,SDCP,SDCL,SDT)=$$AVE(SDX)
"RTN","SCRPW77",34,0)
 ..Q
"RTN","SCRPW77",35,0)
 .Q
"RTN","SCRPW77",36,0)
 S SDIV="" F  S SDIV=$O(^TMP("SDNAVA",$J,SDIV)) Q:'$L(SDIV)  D
"RTN","SCRPW77",37,0)
 .S SDX=^TMP("SDNAVA",$J,SDIV)_U_$P($G(^TMP("SDZNAVA",$J,SDIV)),U,19,39)
"RTN","SCRPW77",38,0)
 .S ^TMP("SDNAVA",$J,SDIV)=$$AVE(SDX)
"RTN","SCRPW77",39,0)
 .S SDCP=0 F  S SDCP=$O(^TMP("SDNAVA",$J,SDIV,SDCP)) Q:'SDCP  D
"RTN","SCRPW77",40,0)
 ..S SDX=^TMP("SDNAVA",$J,SDIV,SDCP)_U_$P($G(^TMP("SDZNAVA",$J,SDIV,SDCP)),U,19,39)
"RTN","SCRPW77",41,0)
 ..S ^TMP("SDNAVA",$J,SDIV,SDCP)=$$AVE(SDX)
"RTN","SCRPW77",42,0)
 ..Q
"RTN","SCRPW77",43,0)
 .Q
"RTN","SCRPW77",44,0)
 K ^TMP("SDWNAVA",$J),^TMP("SDXNAVA",$J),^TMP("SDYNAVA",$J),^TMP("SDZNAVA",$J)
"RTN","SCRPW77",45,0)
 Q
"RTN","SCRPW77",46,0)
 ;
"RTN","SCRPW77",47,0)
AVE(SDX) ;Calculate averages
"RTN","SCRPW77",48,0)
 ;Input: SDX=string of appointment totals and total waiting time
"RTN","SCRPW77",49,0)
 ;Output: string of appointment totals and average waiting time
"RTN","SCRPW77",50,0)
 N SDI,SDY,SDZ
"RTN","SCRPW77",51,0)
 F SDI=2:2:22,24:3:36 D
"RTN","SCRPW77",52,0)
 .S SDY=+$P(SDX,U,(SDI-1)),$P(SDX,U,(SDI-1))=SDY
"RTN","SCRPW77",53,0)
 .S $P(SDX,U,SDI)=$FN($S(SDY=0:0,1:$P(SDX,U,SDI)/SDY),"",1)
"RTN","SCRPW77",54,0)
 .Q:SDI<24
"RTN","SCRPW77",55,0)
 .S $P(SDX,U,SDI+1)=$FN($S(SDY=0:0,1:$P(SDX,U,SDI+1)/SDY),"",1)
"RTN","SCRPW77",56,0)
 .Q
"RTN","SCRPW77",57,0)
 S SDY=$P(SDX,U)+$P(SDX,U,5),SDZ=+$P(SDX,U,38)*100
"RTN","SCRPW77",58,0)
 S $P(SDX,U,38)=$FN($S(SDY=0:0,1:(SDZ/SDY)),"",1)
"RTN","SCRPW77",59,0)
 S SDY=$P(SDX,U,3)+$P(SDX,U,7),SDZ=+$P(SDX,U,39)*100
"RTN","SCRPW77",60,0)
 S $P(SDX,U,39)=$FN($S(SDY=0:0,1:(SDZ/SDY)),"",1)
"RTN","SCRPW77",61,0)
 Q SDX
"RTN","SCRPW77",62,0)
 ;
"RTN","SCRPW77",63,0)
AVE2(SDCL,SDAVE2) ;Format additional fields
"RTN","SCRPW77",64,0)
 ;Input: SDCL=clinic ifn
"RTN","SCRPW77",65,0)
 ;Input: SDAVE2=variable to return values (pass by reference)
"RTN","SCRPW77",66,0)
 N SDX,SDY,SDI
"RTN","SCRPW77",67,0)
 S SDAVE2=$G(^TMP("SDWNAVA",$J,SDCL))
"RTN","SCRPW77",68,0)
 Q:'$L(SDAVE2) 0
"RTN","SCRPW77",69,0)
 S SDY=+$P(SDAVE2,U,8)
"RTN","SCRPW77",70,0)
 F SDI=1:1:4 D
"RTN","SCRPW77",71,0)
 .S SDX=$P(SDAVE2,U,SDI)*100
"RTN","SCRPW77",72,0)
 .S $P(SDAVE2,U,SDI)=$FN($S(SDY=0:0,1:(SDX/SDY)),"",1)
"RTN","SCRPW77",73,0)
 .Q
"RTN","SCRPW77",74,0)
 Q 1
"RTN","SCRPW77",75,0)
 ;
"RTN","SCRPW77",76,0)
STOP ;Check for stop task request
"RTN","SCRPW77",77,0)
 S:$D(ZTQUEUED) (SDOUT,ZTSTOP)=$S($$S^%ZTLOAD:1,1:0) Q
"RTN","SCRPW77",78,0)
 ;
"RTN","SCRPW77",79,0)
OUT4 ;Output patient list
"RTN","SCRPW77",80,0)
 N SDY,SDI,SDPNAME,DFN,SDADT
"RTN","SCRPW77",81,0)
 I '$O(^TMP("SDPLIST",$J,SC,0)) D  Q
"RTN","SCRPW77",82,0)
 .S SDY="No appointments scheduled during this date range were found."
"RTN","SCRPW77",83,0)
 .W !!?(IOM-$L(SDY)\2),SDY Q
"RTN","SCRPW77",84,0)
 S SDI=0 F  S SDI=$O(^TMP("SDPLIST",$J,SC,SDI)) Q:SDOUT!'SDI  D
"RTN","SCRPW77",85,0)
 .S SDPNAME=""
"RTN","SCRPW77",86,0)
 .F  S SDPNAME=$O(^TMP("SDPLIST",$J,SC,SDI,SDPNAME)) Q:SDOUT!(SDPNAME="")  D
"RTN","SCRPW77",87,0)
 ..S DFN=0
"RTN","SCRPW77",88,0)
 ..F  S DFN=$O(^TMP("SDPLIST",$J,SC,SDI,SDPNAME,DFN)) Q:SDOUT!(DFN="")  D
"RTN","SCRPW77",89,0)
 ...S SDADT=0
"RTN","SCRPW77",90,0)
 ...F  S SDADT=$O(^TMP("SDPLIST",$J,SC,SDI,SDPNAME,DFN,SDADT)) Q:SDOUT!'SDADT  D
"RTN","SCRPW77",91,0)
 ....S SDATA=^TMP("SDPLIST",$J,SC,SDI,SDPNAME,DFN,SDADT)
"RTN","SCRPW77",92,0)
 ....I 'SDXM,$Y>(IOSL-SDFLEN) D FOOTER(SDREPORT),HDR^SCRPW76(1,SDREPORT,SDIV,SDCP,SC)
"RTN","SCRPW77",93,0)
 ....Q:SDOUT
"RTN","SCRPW77",94,0)
 ....W !,$$DTX(SDI),?13,$E(SDPNAME,1,23),?38,$P(SDATA,U)
"RTN","SCRPW77",95,0)
 ....W ?50,$$DTX(SDADT),?69,$$SRTY($P(SDATA,U,2))
"RTN","SCRPW77",96,0)
 ....W ?98,$P(SDATA,U,3),?102,$$DTX($P(SDATA,U,4))
"RTN","SCRPW77",97,0)
 ....W ?115,$S($P(SDATA,U,5)=0:"NO",$P(SDATA,U,5)=1:"YES",1:"")
"RTN","SCRPW77",98,0)
 ....W ?120,$J($P(SDATA,U,7),5,0),?127,$J($P(SDATA,U,6),5,0)
"RTN","SCRPW77",99,0)
 ....Q
"RTN","SCRPW77",100,0)
 ...Q
"RTN","SCRPW77",101,0)
 ..Q
"RTN","SCRPW77",102,0)
 .Q
"RTN","SCRPW77",103,0)
 Q:SDOUT  D FOOTER(SDREPORT)
"RTN","SCRPW77",104,0)
 Q
"RTN","SCRPW77",105,0)
OUT5(DFN,SC) ;Output patient list
"RTN","SCRPW77",106,0)
 N SDY,SDI,SDPNAME,SDADT
"RTN","SCRPW77",107,0)
 I '$O(^TMP("SDIPLST",$J,DFN,SC,0)) D  Q
"RTN","SCRPW77",108,0)
 .S SDY="No appointments scheduled during this date range were found."
"RTN","SCRPW77",109,0)
 .W !!?(IOM-$L(SDY)\2),SDY Q
"RTN","SCRPW77",110,0)
 S SDI=0 F  S SDI=$O(^TMP("SDIPLST",$J,DFN,SC,SDI)) Q:SDOUT!'SDI  D
"RTN","SCRPW77",111,0)
 .S SDPNAME=""
"RTN","SCRPW77",112,0)
 .F  S SDPNAME=$O(^TMP("SDIPLST",$J,DFN,SC,SDI,SDPNAME)) Q:SDOUT!(SDPNAME="")  D
"RTN","SCRPW77",113,0)
 ..S SDADT=0
"RTN","SCRPW77",114,0)
 ..F  S SDADT=$O(^TMP("SDIPLST",$J,DFN,SC,SDI,SDPNAME,SDADT)) Q:SDOUT!'SDADT  D
"RTN","SCRPW77",115,0)
 ...S SDATA=^TMP("SDIPLST",$J,DFN,SC,SDI,SDPNAME,SDADT)
"RTN","SCRPW77",116,0)
 ...I 'SDXM,$Y>(IOSL-SDFLEN) D FOOTER(SDREPORT),HDR^SCRPW76(1,SDREPORT,SDIV,SDCP,SC)
"RTN","SCRPW77",117,0)
 ...Q:SDOUT
"RTN","SCRPW77",118,0)
 ...W !,$$DTXN(SDI),?11,$$SRTY($P(SDATA,U,2)),?31,$$DTXN($P(SDATA,U,4))
"RTN","SCRPW77",119,0)
 ...W ?42,$$DTXN(SDADT),?52,$J($P(SDATA,U,7),5,0)
"RTN","SCRPW77",120,0)
 ...W ?59,$J($P(SDATA,U,6),5,0),?69,$P(SDATA,U,3)
"RTN","SCRPW77",121,0)
 ...W ?73,$S($P(SDATA,U,5)=0:"NO",$P(SDATA,U,5)=1:"YES",1:"")
"RTN","SCRPW77",122,0)
 ...W ?79,$$DTXN($P(SDATA,U,8)),?96,$P(SDATA,U,9),?102,$P($$DTXN($P(SDATA,U,10)),"@")
"RTN","SCRPW77",123,0)
 ...I +$P(SDATA,U,11)>0 N SDFN,SDARR,DR,DIQ,DIC,DA D  W ?113,$G(SDARR(SDFN,DA,DR,"I"))
"RTN","SCRPW77",124,0)
 ....S DR=".01",DIQ="SDARR(",DIQ(0)="I",DIC=200,SDFN=200,DA=$P(SDATA,U,11) D EN^DIQ1
"RTN","SCRPW77",125,0)
 ...Q
"RTN","SCRPW77",126,0)
 ..Q
"RTN","SCRPW77",127,0)
 .Q
"RTN","SCRPW77",128,0)
 Q:SDOUT  D FOOTER(SDREPORT)
"RTN","SCRPW77",129,0)
 Q
"RTN","SCRPW77",130,0)
 ;
"RTN","SCRPW77",131,0)
SRTY(SDSRTY) ;Externalize scheduling request type
"RTN","SCRPW77",132,0)
 ;Input: SDSRTY=internal value for request type
"RTN","SCRPW77",133,0)
 Q:'$L(SDSRTY) ""
"RTN","SCRPW77",134,0)
 Q:SDSRTY="N" "Next available"
"RTN","SCRPW77",135,0)
 Q:SDSRTY="C" "Not-next ava-C/R" ;Clinician Request
"RTN","SCRPW77",136,0)
 Q:SDSRTY="P" "Not-next ava-P/R" ;Patient Request
"RTN","SCRPW77",137,0)
 Q:SDSRTY="W" "Walk in appoint"
"RTN","SCRPW77",138,0)
 Q:SDSRTY="M" "Multi booking"
"RTN","SCRPW77",139,0)
 Q:SDSRTY="A" "Auto rebook"
"RTN","SCRPW77",140,0)
 Q "Not-next available"
"RTN","SCRPW77",141,0)
 ;
"RTN","SCRPW77",142,0)
DTX(Y) ;Externalize date
"RTN","SCRPW77",143,0)
 X ^DD("DD")
"RTN","SCRPW77",144,0)
 Q Y
"RTN","SCRPW77",145,0)
 ;
"RTN","SCRPW77",146,0)
DTXN(Y) ;External date formated to abbreviate
"RTN","SCRPW77",147,0)
 I +Y=0 S Y="" Q Y
"RTN","SCRPW77",148,0)
 X ^DD("DD")
"RTN","SCRPW77",149,0)
 N SDSTR S Y=$P(Y,",")_","_$E($P(Y,",",2),3,10)
"RTN","SCRPW77",150,0)
 I $L(Y)#2=0 S Y=$E(Y,1,3)_"  "_$P(Y," ",2)
"RTN","SCRPW77",151,0)
 Q Y
"RTN","SCRPW77",152,0)
 ;
"RTN","SCRPW77",153,0)
FOOTER(SDREPORT)  ;Print footer
"RTN","SCRPW77",154,0)
 ;Input: SDREPORT=report element to print
"RTN","SCRPW77",155,0)
 N SDI,SDFL S SDFL=$S(SDREPORT=1:10,SDREPORT=2:8,SDREPORT=5:13,1:9)
"RTN","SCRPW77",156,0)
 I SDXM D  Q
"RTN","SCRPW77",157,0)
 .D XMTX^SCRPW73(" ") S SDI=0
"RTN","SCRPW77",158,0)
 .F  S SDI=$O(SDFOOT(SDREPORT,SDI)) Q:'SDI  D XMTX^SCRPW73(SDFOOT(SDREPORT,SDI))
"RTN","SCRPW77",159,0)
 .Q
"RTN","SCRPW77",160,0)
 F SDI=1:1:80 Q:$Y>(IOSL-SDFL)  W !
"RTN","SCRPW77",161,0)
 S SDI=0
"RTN","SCRPW77",162,0)
 F  S SDI=$O(SDFOOT(SDREPORT,SDI)) Q:'SDI  W !,SDFOOT(SDREPORT,SDI)
"RTN","SCRPW77",163,0)
 Q
"RTN","SCRPW77",164,0)
 ;
"RTN","SCRPW77",165,0)
FOOT(SDTX) ;Report footer for retrospective report
"RTN","SCRPW77",166,0)
 ;Input: SDTX=array to return text
"RTN","SCRPW77",167,0)
 I $G(SDREPORT(1)) D
"RTN","SCRPW77",168,0)
 .S SDTX(1,1)=SDLINE
"RTN","SCRPW77",169,0)
 .S SDTX(1,2)="NOTE:  TYPE '0' represents appointments scheduled during the report time frame not indicated by the user or by calculation to be"
"RTN","SCRPW77",170,0)
 .S SDTX(1,3)="'next available' appointments.  TYPE '1' represents appointments defined by the user as being 'next available' appointments.  TYPE"
"RTN","SCRPW77",171,0)
 .S SDTX(1,4)="'2' represents appointments calculated to be 'next available' appointments.  TYPE '3' represents appointments indicated both by the"
"RTN","SCRPW77",172,0)
 .S SDTX(1,5)="user and by calculation to be 'next available' appointments.  WAIT TIME is the average number of days from the date an appointment"
"RTN","SCRPW77",173,0)
 .S SDTX(1,6)="was scheduled to the date it is to be performed.  The '% NNA' and '% NA' columns reflect percentage of appointments scheduled within"
"RTN","SCRPW77",174,0)
 .S SDTX(1,7)="30 days for 'non-next available' appointments (types 0 & 2) and 'next available' appointments (types 1 & 3), respectively."
"RTN","SCRPW77",175,0)
 .S SDTX(1,8)=SDLINE Q
"RTN","SCRPW77",176,0)
 I $G(SDREPORT(2)) D
"RTN","SCRPW77",177,0)
 .S SDTX(2,1)=SDLINE
"RTN","SCRPW77",178,0)
 .S SDTX(2,2)="NOTE:  The date range categories ('0-1', '2-7', '8-30', etc.) are based on the difference between the 'desired date' defined for the"
"RTN","SCRPW77",179,0)
 .S SDTX(2,3)="appointment and the date the appointment was performed.  'Wait Time' reflects the average of this difference for all appointments in"
"RTN","SCRPW77",180,0)
 .S SDTX(2,4)="each category.  'Follow up' status is determined by encounter activity to the same DSS ID credit pair as the appointment clinic"
"RTN","SCRPW77",181,0)
 .S SDTX(2,5)="within the previous 24 months."
"RTN","SCRPW77",182,0)
 .S SDTX(2,6)=SDLINE Q
"RTN","SCRPW77",183,0)
 I $G(SDREPORT(3)) D
"RTN","SCRPW77",184,0)
 .S SDTX(3,1)=SDLINE
"RTN","SCRPW77",185,0)
 .S SDTX(3,2)="NOTE:  The date range categories ('0-1', '2-7', '8-30', etc.) are based on the difference between the 'desired date' defined for the"
"RTN","SCRPW77",186,0)
 .S SDTX(3,3)="appointment and the date the appointment was performed.  'Wait Time1' reflects the average difference between the 'desired date' and"
"RTN","SCRPW77",187,0)
 .S SDTX(3,4)="the date the appointment was performed.  'Wait Time2' reflects the average difference between the transaction date (the date the"
"RTN","SCRPW77",188,0)
 .S SDTX(3,5)="appointment was entered by the Scheduling package user) and the date the appointment was performed.  'Non-follow up' status is"
"RTN","SCRPW77",189,0)
 .S SDTX(3,6)="determined by the absence of encounter activity to the same DSS ID credit pair as the appointment clinic in the previous 24 months."
"RTN","SCRPW77",190,0)
 .S SDTX(3,7)=SDLINE Q
"RTN","SCRPW77",191,0)
 I $G(SDREPORT(4)) D
"RTN","SCRPW77",192,0)
 .S SDTX(4,1)=SDLINE
"RTN","SCRPW77",193,0)
 .S SDTX(4,2)="NOTE:  'Next Ava. Ind.' Values--'0' = not indicated by the user or calculation to be a 'next available' appointment, '1' = defined"
"RTN","SCRPW77",194,0)
 .S SDTX(4,3)="by the user as a 'next available' appointment, '2' = indicated by calculation to be a 'next available' appointment, '3' = indicated"
"RTN","SCRPW77",195,0)
 .S SDTX(4,4)="by the user and by calculation to be a 'next available' appointment.  'Wait Time1' = the difference between the 'date desired' and"
"RTN","SCRPW77",196,0)
 .S SDTX(4,5)="the date of the appointment.  'Wait Time2' = the difference between the 'date scheduled' and the date of the appointment."
"RTN","SCRPW77",197,0)
 .S SDTX(4,6)=SDLINE Q
"RTN","SCRPW77",198,0)
 I $G(SDREPORT(5)) D FOOT^SCRPW78(.SDTX,SDLINE) Q
"RTN","SCRPW77",199,0)
 Q
"RTN","SCRPW78")
0^7^B18943883
"RTN","SCRPW78",1,0)
SCRPW78 ;BP-CIOFO/ESW - Clinic appointment availability extract ; 5/29/03 11:40am
"RTN","SCRPW78",2,0)
 ;;5.3;Scheduling;**291**;AUG 13, 1993
"RTN","SCRPW78",3,0)
 ;
"RTN","SCRPW78",4,0)
 Q  ; Must not call this routine directly
"RTN","SCRPW78",5,0)
 ;
"RTN","SCRPW78",6,0)
SELECT(SDJN,SDPAT) N SDPT,DIC,Y S SDPT=0 N % S %=0 F  Q:(%=1&'SDPT)  S DIC=2,DIC(0)="QEAMIZ",DIC("A")="Select PATIENT NAME:" D ^DIC D
"RTN","SCRPW78",7,0)
 .S SDPT=+Y
"RTN","SCRPW78",8,0)
 .I SDPT>0 W !,"Correct Patient? " S %=1 D YN^DICN D:(%=1)  Q
"RTN","SCRPW78",9,0)
 ..N SS S SS=$O(^TMP("SDPAT",SDJN,""),-1)
"RTN","SCRPW78",10,0)
 ..S ^TMP("SDPAT",SDJN,SS+1)=SDPT_U_$P(^DPT(SDPT,0),U),SDPAT=SDPAT+1
"RTN","SCRPW78",11,0)
 .I SDPT<0,SDPAT S %=1,SDPT=0 W !,SDPAT_" patient(s) selected",! Q
"RTN","SCRPW78",12,0)
 .I SDPT<0 W !,"No Patient Selected, OK to proceed? " S %=1 D YN^DICN S SDPT=0
"RTN","SCRPW78",13,0)
 Q
"RTN","SCRPW78",14,0)
PRT5 ;print SDREPORT=5
"RTN","SCRPW78",15,0)
 I $G(SDREPORT)'=5 Q
"RTN","SCRPW78",16,0)
 N SC,DFN,SDIV,SDCP,SDDV,SDIVC,SDPNAME S DFN=""
"RTN","SCRPW78",17,0)
 S SDPNAME="" F  S SDPNAME=$O(^TMP("SDORD",$J,SDPNAME)) Q:SDPNAME=""!SDOUT  D
"RTN","SCRPW78",18,0)
 .S DFN="" F  S DFN=$O(^TMP("SDORD",$J,SDPNAME,DFN)) Q:DFN=""  D
"RTN","SCRPW78",19,0)
 ..S SDIV="" F  S SDIV=$O(^TMP("SDIP",$J,SDIV)) Q:SDIV=""!SDOUT  D
"RTN","SCRPW78",20,0)
 ...S SC=""
"RTN","SCRPW78",21,0)
 ...F  S SC=$O(^TMP("SDIP",$J,SDIV,SC)) Q:SC=""  I $D(^TMP("SDIPLST",$J,DFN,SC)) D
"RTN","SCRPW78",22,0)
 ....S SDCP=$P(^TMP("SDIP",$J,SDIV,SC),U),SDDV=$P(^(SC),U,2)
"RTN","SCRPW78",23,0)
 ....S SDIVC=SDDV_U_SDIV
"RTN","SCRPW78",24,0)
 ....D HDR^SCRPW76(1,SDREPORT,SDIVC,SDCP,SC) Q:SDOUT
"RTN","SCRPW78",25,0)
 ....D OUT5^SCRPW77(DFN,SC) Q
"RTN","SCRPW78",26,0)
 Q
"RTN","SCRPW78",27,0)
GEN5A(SDAP0,DFN,SDADT,SDCL,SDWAIT,SDT,SDSFU,SDSDEV,SDSDDT,SDFLAG) ;generate ^TMP("SDIPLST" for a selected patient
"RTN","SCRPW78",28,0)
 ;SDAP0 - zero node of appointment multiple
"RTN","SCRPW78",29,0)
 ;        ^DPT(DFN,"S",SDADT,0)
"RTN","SCRPW78",30,0)
 ;
"RTN","SCRPW78",31,0)
 N SDPNAME,SDATA,SDSSN,SDREB,SDCMPL,SDSCHED,SDAST,SDASTO
"RTN","SCRPW78",32,0)
 ;Get appointment status, rebook date, completion date and scheduler
"RTN","SCRPW78",33,0)
 S SDAST=$P(SDAP0,U,2) S SDASTO=$S(SDAST="C":"CC",SDAST="CA":"CCA",SDAST="PC":"CP",SDAST="PCA":"CPA",1:SDAST)
"RTN","SCRPW78",34,0)
 I SDASTO="" D
"RTN","SCRPW78",35,0)
 .N SDATC S SDATC=$$STATUS^SDAM1(DFN,SDADT,SDCL,SDAP0)
"RTN","SCRPW78",36,0)
 .I +SDATC=2 D  Q
"RTN","SCRPW78",37,0)
 ..S SDASTO="CO"
"RTN","SCRPW78",38,0)
 ..I $P(SDATC,";",3)["ACT REQ" S SDASTO="COA"
"RTN","SCRPW78",39,0)
 .I +SDATC=11 S SDASTO="F" Q
"RTN","SCRPW78",40,0)
 .I +SDATC=3 S SDASTO="NT" Q
"RTN","SCRPW78",41,0)
 .I +SDATC=1 S SDASTO="CI"
"RTN","SCRPW78",42,0)
 S SDREB=$P(SDAP0,U,10),SDCMPL=$P(SDAP0,U,14) S SDSCHED=$P($G(^SC(SDCL,"S",SDADT,1,1,0)),U,6) I SDSCHED="" S SDSCHED=$P(SDAP0,U,18)
"RTN","SCRPW78",43,0)
 I SDASTO="CO" D
"RTN","SCRPW78",44,0)
 .N SDE S SDE=$P(SDAP0,U,20),SDCMPL=$P(^SCE(SDE,0),U,7)
"RTN","SCRPW78",45,0)
 S SDATA=$G(^DPT(DFN,0))
"RTN","SCRPW78",46,0)
 S SDSSN=$P(SDATA,U,9),SDPNAME=$P(SDATA,U) Q:'$L(SDPNAME)
"RTN","SCRPW78",47,0)
 S SDATA=SDSSN_U_$P(SDAP0,U,25)_U_SDFLAG_U_SDSDDT_U_SDSFU_U_SDWAIT_U_SDSDEV_U_SDREB_U_SDASTO_U_SDCMPL_U_SDSCHED
"RTN","SCRPW78",48,0)
 S ^TMP("SDIPLST",$J,DFN,SDCL,SDT,SDPNAME,SDADT)=SDATA
"RTN","SCRPW78",49,0)
 Q
"RTN","SCRPW78",50,0)
FOOT(SDTX,SDLINE) ;
"RTN","SCRPW78",51,0)
 I $G(SDREPORT(5)) D
"RTN","SCRPW78",52,0)
 .S SDTX(5,1)=SDLINE
"RTN","SCRPW78",53,0)
 .S SDTX(5,2)="NOTE: 'APPT TYPE' Values--'0' = user indicated 'Not next available' and calculation indicated 'Not next available' used"
"RTN","SCRPW78",54,0)
 .S SDTX(5,3)="                          '1' = user indicated 'Next available' but calculation indicated next available appt not used"
"RTN","SCRPW78",55,0)
 .S SDTX(5,4)="                          '2' = user indicated 'Not next available' but calculation indicated next available appointment used"
"RTN","SCRPW78",56,0)
 .S SDTX(5,5)="                          '3' = user indicated 'Next available' and calculation indicated 'Next available' apppointment used"
"RTN","SCRPW78",57,0)
 .S SDTX(5,6)="WAIT TIME: -------------- the difference between the 'DATE DESIRED' and 'APPT DATE/TIME'"
"RTN","SCRPW78",58,0)
 .S SDTX(5,7)="TIME TO APPT.: ----------- days from 'DATE SCHEDULED' to 'APPT DATE/TIME'"
"RTN","SCRPW78",59,0)
 .S SDTX(5,8)="APPT STATUS: N - No-show,   CC - Canceled by Clinic,  NA - No Show & Auto Rebook,   CCA -Canceled by  Clinic & Auto Rebook,"
"RTN","SCRPW78",60,0)
 .S SDTX(5,9)="             I - Inpatient, CP - Canceled by Patient, CPA - Canceled by Patient & Auto Rebook, NT - No Action Taken,"
"RTN","SCRPW78",61,0)
 .S SDTX(5,10)="             F - Future,    CI - Checked In,          COA - Checked Out/Action Required,       CO - Checked Out"
"RTN","SCRPW78",62,0)
 .S SDTX(5,11)=SDLINE Q
"RTN","SCRPW78",63,0)
 Q
"VER")
8.0^22
**END**
**END**
