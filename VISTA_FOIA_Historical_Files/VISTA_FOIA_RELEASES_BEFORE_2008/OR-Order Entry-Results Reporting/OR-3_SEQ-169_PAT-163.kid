Released OR*3*163 SEQ #169
Extracted from mail message
**KIDS**:OR*3.0*163^

**INSTALL NAME**
OR*3.0*163
"BLD",3781,0)
OR*3.0*163^ORDER ENTRY/RESULTS REPORTING^0^3030721^y
"BLD",3781,1,0)
^^1^1^3021120^^^^
"BLD",3781,1,1,0)
Refer to the patch description on the patch message.
"BLD",3781,4,0)
^9.64PA^^0
"BLD",3781,"ABNS",0)
^9.66A^^
"BLD",3781,"ABPKG")
n^y^G.LABTEST@ISC-SLC.VA.GOV
"BLD",3781,"INI")
PRE^ORY163
"BLD",3781,"INIT")
POST^ORY163
"BLD",3781,"KRN",0)
^9.67PA^8989.52^20
"BLD",3781,"KRN",.4,0)
.4
"BLD",3781,"KRN",.401,0)
.401
"BLD",3781,"KRN",.402,0)
.402
"BLD",3781,"KRN",.403,0)
.403
"BLD",3781,"KRN",.5,0)
.5
"BLD",3781,"KRN",.84,0)
.84
"BLD",3781,"KRN",3.6,0)
3.6
"BLD",3781,"KRN",3.8,0)
3.8
"BLD",3781,"KRN",9.2,0)
9.2
"BLD",3781,"KRN",9.8,0)
9.8
"BLD",3781,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",3781,"KRN",9.8,"NM",1,0)
ORWOR^^0^B29680452
"BLD",3781,"KRN",9.8,"NM",2,0)
ORWORR^^0^B61684915
"BLD",3781,"KRN",9.8,"NM",3,0)
ORCACT01^^0^B71322628
"BLD",3781,"KRN",9.8,"NM",4,0)
ORX8^^0^B13883123
"BLD",3781,"KRN",9.8,"NM",5,0)
ORY163^^0^B1345938
"BLD",3781,"KRN",9.8,"NM",6,0)
ORWDPS1^^0^B29850798
"BLD",3781,"KRN",9.8,"NM",7,0)
ORCSAVE1^^0^B30102142
"BLD",3781,"KRN",9.8,"NM",8,0)
ORWOR1^^0^B21551426
"BLD",3781,"KRN",9.8,"NM",9,0)
ORCSAVE^^0^B58561641
"BLD",3781,"KRN",9.8,"NM","B","ORCACT01",3)

"BLD",3781,"KRN",9.8,"NM","B","ORCSAVE",9)

"BLD",3781,"KRN",9.8,"NM","B","ORCSAVE1",7)

"BLD",3781,"KRN",9.8,"NM","B","ORWDPS1",6)

"BLD",3781,"KRN",9.8,"NM","B","ORWOR",1)

"BLD",3781,"KRN",9.8,"NM","B","ORWOR1",8)

"BLD",3781,"KRN",9.8,"NM","B","ORWORR",2)

"BLD",3781,"KRN",9.8,"NM","B","ORX8",4)

"BLD",3781,"KRN",9.8,"NM","B","ORY163",5)

"BLD",3781,"KRN",19,0)
19
"BLD",3781,"KRN",19,"NM",0)
^9.68A^^
"BLD",3781,"KRN",19.1,0)
19.1
"BLD",3781,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",3781,"KRN",101,0)
101
"BLD",3781,"KRN",101,"NM",0)
^9.68A^^0
"BLD",3781,"KRN",409.61,0)
409.61
"BLD",3781,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",3781,"KRN",771,0)
771
"BLD",3781,"KRN",869.2,0)
869.2
"BLD",3781,"KRN",870,0)
870
"BLD",3781,"KRN",8989.51,0)
8989.51
"BLD",3781,"KRN",8989.52,0)
8989.52
"BLD",3781,"KRN",8994,0)
8994
"BLD",3781,"KRN",8994,"NM",0)
^9.68A^3^3
"BLD",3781,"KRN",8994,"NM",1,0)
ORWOR1 SETDTEXT^^0
"BLD",3781,"KRN",8994,"NM",2,0)
ORWOR1 GETDEA^^0
"BLD",3781,"KRN",8994,"NM",3,0)
ORWOR1 GETDSCH^^0
"BLD",3781,"KRN",8994,"NM","B","ORWOR1 GETDEA",2)

"BLD",3781,"KRN",8994,"NM","B","ORWOR1 GETDSCH",3)

"BLD",3781,"KRN",8994,"NM","B","ORWOR1 SETDTEXT",1)

"BLD",3781,"KRN","B",.4,.4)

"BLD",3781,"KRN","B",.401,.401)

"BLD",3781,"KRN","B",.402,.402)

"BLD",3781,"KRN","B",.403,.403)

"BLD",3781,"KRN","B",.5,.5)

"BLD",3781,"KRN","B",.84,.84)

"BLD",3781,"KRN","B",3.6,3.6)

"BLD",3781,"KRN","B",3.8,3.8)

"BLD",3781,"KRN","B",9.2,9.2)

"BLD",3781,"KRN","B",9.8,9.8)

"BLD",3781,"KRN","B",19,19)

"BLD",3781,"KRN","B",19.1,19.1)

"BLD",3781,"KRN","B",101,101)

"BLD",3781,"KRN","B",409.61,409.61)

"BLD",3781,"KRN","B",771,771)

"BLD",3781,"KRN","B",869.2,869.2)

"BLD",3781,"KRN","B",870,870)

"BLD",3781,"KRN","B",8989.51,8989.51)

"BLD",3781,"KRN","B",8989.52,8989.52)

"BLD",3781,"KRN","B",8994,8994)

"BLD",3781,"PRE")
ORY163
"BLD",3781,"QUES",0)
^9.62^^
"BLD",3781,"REQB",0)
^9.611^3^3
"BLD",3781,"REQB",1,0)
OR*3.0*141^2
"BLD",3781,"REQB",2,0)
XU*8.0*267^2
"BLD",3781,"REQB",3,0)
XU*8.0*288^2
"BLD",3781,"REQB","B","OR*3.0*141",1)

"BLD",3781,"REQB","B","XU*8.0*267",2)

"BLD",3781,"REQB","B","XU*8.0*288",3)

"INI")
PRE^ORY163
"INIT")
POST^ORY163
"KRN",8994,1814,-1)
0^1
"KRN",8994,1814,0)
ORWOR1 SETDTEXT^SETDTEXT^ORWOR1^2
"KRN",8994,1814,1,0)
^8994.01^2^2^3030403^^^^
"KRN",8994,1814,1,1,0)
Sets/updates the external text of an order.
"KRN",8994,1814,1,2,0)
The updated text is also returned.
"KRN",8994,1815,-1)
0^2
"KRN",8994,1815,0)
ORWOR1 GETDEA^GETDEA^ORWOR1^1
"KRN",8994,1815,1,0)
^8994.01^1^1^3030403^^^^
"KRN",8994,1815,1,1,0)
Returns a users DEA number.
"KRN",8994,1816,-1)
0^3
"KRN",8994,1816,0)
ORWOR1 GETDSCH^GETDSCH^ORWOR1^1
"KRN",8994,1816,1,0)
^8994.01^1^1^3030403^^^^
"KRN",8994,1816,1,1,0)
Returns the schedule of the drug.
"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",110,-1)
1^1
"PKG",110,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",110,20,0)
^9.402P^^
"PKG",110,22,0)
^9.49I^1^1
"PKG",110,22,1,0)
3.0^2971217
"PKG",110,22,1,"PAH",1,0)
163^3030721^5
"PKG",110,22,1,"PAH",1,1,0)
^^1^1^3030721
"PKG",110,22,1,"PAH",1,1,1,0)
Refer to the patch description on the patch message.
"PRE")
ORY163
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","ORCACT01")
0^3^B71322628
"RTN","ORCACT01",1,0)
ORCACT01        ;SLC/MKB-Validate order actions cont ;2/12/03  13:14
"RTN","ORCACT01",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,134,141,163**;Dec 17, 1997
"RTN","ORCACT01",3,0)
 ;
"RTN","ORCACT01",4,0)
ES ; -- sign [on chart]
"RTN","ORCACT01",5,0)
 I ORDSTS=11,VER<3,PKG'="OR" S ERROR="This order cannot be released and must be discontinued!" Q
"RTN","ORCACT01",6,0)
 N X I ACTSTS=11!(ACTSTS=10) D  Q:$L($G(ERROR))
"RTN","ORCACT01",7,0)
 . I $P(ORA0,U,2)="DC",$$DONE^ORCACT0 D CANCEL^ORCSEND(+IFN),UNOTIF^ORCSIGN S OREBUILD=1 Q
"RTN","ORCACT01",8,0)
 . S X=$$DISABLED^ORCACT0 I X S ERROR=$P(X,U,2) Q
"RTN","ORCACT01",9,0)
 S X=$P(ORA0,U,4) I X=3 S:ACTSTS'=11&(ACTSTS'=10) ERROR="This order does not require a signature!" Q
"RTN","ORCACT01",10,0)
 I X'=2 S ERROR="This order has been signed!" Q
"RTN","ORCACT01",11,0)
 I DG="O RX",ACTION'="ES",ACTION'="DS",$G(NATR)'="I" S ERROR="Outpatient meds may not be released without a clinician's signature!" Q
"RTN","ORCACT01",12,0)
 I (ACTION="ES"!(ACTION="DS")),$D(^XUSEC("ORELSE",DUZ)),$P(OR0,U,16)'<2 S ERROR="You are not privileged to sign this order!" Q
"RTN","ORCACT01",13,0)
 I ACTION="OC" S:MEDPARM<2 ERROR="You are not authorized to release med orders!" Q
"RTN","ORCACT01",14,0)
 I ACTION="RS" D  Q:$D(ERROR)  Q:$G(NATR)'="I"
"RTN","ORCACT01",15,0)
 . Q:ACTSTS=11  Q:ACTSTS=10  ;unreleased - ok
"RTN","ORCACT01",16,0)
 . S ERROR="This order has already been released!"
"RTN","ORCACT01",17,0)
ES1 I PKG="PS" D  ;authorized to write meds?
"RTN","ORCACT01",18,0)
 . N TYPE,OI,PSOI,DEAFLG,PKI
"RTN","ORCACT01",19,0)
 . S X=$G(^VA(200,DUZ,"PS"))
"RTN","ORCACT01",20,0)
 . I '$P(X,U) S ERROR="You are not authorized to sign med orders!" Q
"RTN","ORCACT01",21,0)
 . I $P(X,U,4),$$NOW^XLFDT>$P(X,U,4) S ERROR="You are no longer authorized to sign med orders!" Q
"RTN","ORCACT01",22,0)
 . Q:DG="IV RX"  Q:$P(ORA0,U,2)="DC"  ;don't need to ck DEA#
"RTN","ORCACT01",23,0)
 . S OI=+$$VALUE^ORX8(+IFN,"ORDERABLE")
"RTN","ORCACT01",24,0)
 . S PSOI=+$P($G(^ORD(101.43,OI,0)),U,2) Q:PSOI'>0
"RTN","ORCACT01",25,0)
 . S TYPE=$S($P(DG," ")="O":"O",1:"I"),DEAFLG=$$OIDEA^PSSUTLA1(PSOI,TYPE)
"RTN","ORCACT01",26,0)
 . I DEAFLG>0,'$L($$DEA^XUSER()) S ERROR="You must have a valid DEA# or VA# to sign this order!" Q
"RTN","ORCACT01",27,0)
 . D PKISITE^ORWOR(.PKI)
"RTN","ORCACT01",28,0)
 . I $G(PKI),ACTION="RS",DEAFLG>0 S ERROR="This order cannot be released without a Digital Signature" Q
"RTN","ORCACT01",29,0)
 Q
"RTN","ORCACT01",30,0)
 ;
"RTN","ORCACT01",31,0)
XFR ; -- transfer to inpt/outpt [IFN=order to be transferred]
"RTN","ORCACT01",32,0)
 N OI,PS I DG="TPN" S ERROR="TPN orders may not be copied!" Q
"RTN","ORCACT01",33,0)
 I $$INACTIVE S ERROR="Orders for inactive orderables may not be transferred; please enter a new order!" Q
"RTN","ORCACT01",34,0)
 S OI=+$O(^OR(100,+IFN,.1,"B",0)),ORPS=$G(^ORD(101.43,OI,"PS"))
"RTN","ORCACT01",35,0)
 I DG="UD RX",'$P(ORPS,U,2) S ERROR="This drug may not be ordered for an outpatient!" Q
"RTN","ORCACT01",36,0)
 I DG="O RX" D  Q:$L($G(ERROR))
"RTN","ORCACT01",37,0)
 . I '$P(ORPS,U) S ERROR="This drug may not be ordered for an inpatient!" Q
"RTN","ORCACT01",38,0)
 . D:$O(^OR(100,+IFN,4.5,"ID","MISC",0)) DOSES^ORCACT02(+IFN)
"RTN","ORCACT01",39,0)
 Q
"RTN","ORCACT01",40,0)
 ;
"RTN","ORCACT01",41,0)
RW ; -- rewrite/copy
"RTN","ORCACT01",42,0)
 I ACTSTS=12 S ERROR="Orders that have been dc'd due to editing may not be copied!" Q
"RTN","ORCACT01",43,0)
 I DG="TPN" S ERROR="TPN orders may not be rewritten!" Q
"RTN","ORCACT01",44,0)
 I DG="UD RX",$$NTBG(+IFN) S ERROR="This order has been marked 'Not to be Given' and may not be rewritten!" Q
"RTN","ORCACT01",45,0)
 I $$INACTIVE S ERROR="Orders for inactive orderables may not be copied; please enter a new order!" Q
"RTN","ORCACT01",46,0)
 I PKG="PS",'$$MEDOK S ERROR="This drug may not be ordered!" Q
"RTN","ORCACT01",47,0)
 I DG="O RX",$O(^OR(100,+IFN,4.5,"ID","MISC",0)) D DOSES^ORCACT02(+IFN) ;old form
"RTN","ORCACT01",48,0)
 Q
"RTN","ORCACT01",49,0)
 ;
"RTN","ORCACT01",50,0)
RN ; -- renew
"RTN","ORCACT01",51,0)
 I PKG'="PS",PKG'="OR" S ERROR="This order may not be renewed!" Q
"RTN","ORCACT01",52,0)
 I (ORDSTS=11)!(ORDSTS=10) S ERROR="This order has not been released to the service." Q
"RTN","ORCACT01",53,0)
 I ACTSTS=12 S ERROR="Orders that have been dc'd due to editing may not be renewed!" Q
"RTN","ORCACT01",54,0)
 I $P(OR3,U,6) S ERROR="This order has already been "_$S($P($G(^OR(100,+$P(OR3,U,6),3)),U,11)=1:"changed!",1:"renewed!") Q
"RTN","ORCACT01",55,0)
 I PKG="OR" D  Q  ;Generic orders
"RTN","ORCACT01",56,0)
 . I $$INACTIVE S ERROR="Orders for inactive orderables may not be renewed!" Q
"RTN","ORCACT01",57,0)
 . I DG="ADT" S ERROR="M.A.S. orders may not be renewed!" Q
"RTN","ORCACT01",58,0)
 . I "^1^2^6^7^"[(U_ORDSTS_U) Q  ;ok
"RTN","ORCACT01",59,0)
 . S ERROR="This order may not be renewed!"
"RTN","ORCACT01",60,0)
 I (PKG="PS"),$$INACTIVE S ERROR="Orders for inactive orderables may not be renewed!" Q
"RTN","ORCACT01",61,0)
 I '$$MEDOK S ERROR="This drug may not be ordered!" Q
"RTN","ORCACT01",62,0)
RN1 N PSIFN S PSIFN=$G(^OR(100,+IFN,4))
"RTN","ORCACT01",63,0)
 I PSIFN<1,'$O(^OR(100,+IFN,2,0)) S ERROR="Missing or invalid order number!" Q
"RTN","ORCACT01",64,0)
 I DG="O RX" D  Q  ;Outpt Meds
"RTN","ORCACT01",65,0)
 . N ORZ,ORD S ORZ=$L($T(RENEW^PSORENW),",")
"RTN","ORCACT01",66,0)
 . I ORZ>1 S ORD=+$$VALUE^ORX8(+IFN,"DRUG"),X=$$RENEW^PSORENW(PSIFN,ORD)
"RTN","ORCACT01",67,0)
 . S:ORZ'>1 X=$$RENEW^PSORENW(PSIFN) I X<1 S ERROR=$P(X,U,2) Q
"RTN","ORCACT01",68,0)
 . S X=+$P(X,U,2) D:X RESET(+IFN,X)
"RTN","ORCACT01",69,0)
 . I $O(^OR(100,+IFN,4.5,"ID","MISC",0)) D DOSES^ORCACT02(+IFN) ;old format
"RTN","ORCACT01",70,0)
 I DG="UD RX",$$NTBG(+IFN) S ERROR="This order has been marked 'Not to be Given' and may not be renewed!" Q
"RTN","ORCACT01",71,0)
 I ORDSTS=7,'$$IV,$P(OR0,U,9)<$$FMADD^XLFDT(DT,-4)  S ERROR="Inpatient med orders may not be renewed more than 4 days after expiration!" Q
"RTN","ORCACT01",72,0)
 I ORDSTS'=6,ORDSTS'=7 S ERROR="This order may not be renewed!" Q
"RTN","ORCACT01",73,0)
RN2 I '$O(^OR(100,+IFN,2,0))!$P(OR3,U,9) D  Q:$D(ERROR)!'PSIFN
"RTN","ORCACT01",74,0)
 . I $P(OR3,U,9),$$VALUE^ORX8(+IFN,"SCHEDULE",1,"E")="NOW" S ERROR="One-time NOW orders may not be renewed!" Q
"RTN","ORCACT01",75,0)
 . N DAD,ORD3,I,Y S DAD=$S($P(OR3,U,9):+$P(OR3,U,9),1:+IFN),Y=0
"RTN","ORCACT01",76,0)
 . S ORD3=$G(^OR(100,DAD,3)) I $P(ORD3,U,6) S ERROR="This complex order has already been renewed!" Q
"RTN","ORCACT01",77,0)
 . I $P(ORD3,U,3)'=6 S ERROR="This complex order is not active and may not be renewed!" Q
"RTN","ORCACT01",78,0)
 . I '$$AND^ORX8(DAD) S ERROR="Complex orders with sequential doses may not be renewed!" Q
"RTN","ORCACT01",79,0)
 . S I=0 F  S I=+$O(^OR(100,DAD,2,I)) Q:I<1  D  Q:Y
"RTN","ORCACT01",80,0)
 .. I $P($G(^OR(100,I,3)),U,3)'=6 S Y=1,ERROR="Complex orders with terminated doses may not be renewed!" Q
"RTN","ORCACT01",81,0)
 .. I PSIFN<1 S X=$$ACTIVE^PSJORREN(+ORVP,$G(^OR(100,I,4))) I +X'=1 S ERROR="This order may not be renewed: "_$S(+X>1:"Inactive orderable item",1:$P(X,U,2)) Q
"RTN","ORCACT01",82,0)
 ;I DG="TPN" S ERROR="TPN orders may not be renewed!" Q
"RTN","ORCACT01",83,0)
 S X=$$ACTIVE^PSJORREN(+ORVP,PSIFN) Q:+X=1  ;Ok
"RTN","ORCACT01",84,0)
 I +X>1,$P(X,U,2) D RESET(+IFN,+$P(X,U,2)) Q  ;replace OI
"RTN","ORCACT01",85,0)
 S ERROR="This order may not be renewed: "_$P(X,U,2)
"RTN","ORCACT01",86,0)
 Q
"RTN","ORCACT01",87,0)
 ;
"RTN","ORCACT01",88,0)
XX ; -- edit/change
"RTN","ORCACT01",89,0)
 I PKG="RA",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Radiology cannot be changed!" Q
"RTN","ORCACT01",90,0)
 I PKG="LR",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Lab cannot be changed!" Q
"RTN","ORCACT01",91,0)
 I PKG="FH",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Dietetics cannot be changed!" Q
"RTN","ORCACT01",92,0)
 I PKG="GMRC",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Consults cannot be changed!" Q
"RTN","ORCACT01",93,0)
 I DG="TPN" S ERROR="TPN orders may not be changed!" Q
"RTN","ORCACT01",94,0)
 I ORDSTS=3 S ERROR="Orders on hold may not be changed!" Q
"RTN","ORCACT01",95,0)
 I DG="UD RX",$$NTBG(+IFN) S ERROR="This order has been marked 'Not to be Given' and may not be changed!" Q
"RTN","ORCACT01",96,0)
 I $O(^OR(100,+IFN,2,0)) S ERROR="Complex orders may not be changed!" Q
"RTN","ORCACT01",97,0)
 I $P(OR3,U,9) D  Q:$D(ERROR)
"RTN","ORCACT01",98,0)
 . Q:$$VALUE^ORX8(+IFN,"SCHEDULE",1,"E")="NOW"  ;NOW ok
"RTN","ORCACT01",99,0)
 . Q:'$O(^OR(100,+$P(OR3,U,9),4.5,"ID","CONJ",0))  ;no conj=1dose/ok
"RTN","ORCACT01",100,0)
 . S ERROR="Complex orders may not be changed!" Q
"RTN","ORCACT01",101,0)
 I $P(OR3,U,6) S ERROR="This order may not be changed - a "_$S($P($G(^OR(100,+$P(OR3,U,6),3)),U,11)=1:"change",1:"renewal")_" order already exists!" Q
"RTN","ORCACT01",102,0)
 I $P(OR3,U,11)=2 D  Q:$D(ERROR)
"RTN","ORCACT01",103,0)
 . I ORDSTS=10!(ORDSTS=11) S ERROR="Unreleased renewals may not be changed!" Q
"RTN","ORCACT01",104,0)
 . I PKG="PS",ORDSTS=5 S ERROR="Pending renewals may not be changed!" Q
"RTN","ORCACT01",105,0)
 I $$INACTIVE S ERROR="Orders for inactive orderables may not be changed; please enter a new order!" Q
"RTN","ORCACT01",106,0)
 I PKG="PS",'$$MEDOK S ERROR="This drug may not be ordered!" Q
"RTN","ORCACT01",107,0)
 I DG="O RX",$O(^OR(100,+IFN,4.5,"ID","MISC",0)) D DOSES^ORCACT02(+IFN) ;old form
"RTN","ORCACT01",108,0)
 Q
"RTN","ORCACT01",109,0)
 ;
"RTN","ORCACT01",110,0)
INACTIVE() ; -- Returns 1 or 0, if OI is now inactive
"RTN","ORCACT01",111,0)
 N I,OI,PREOI,PREOIX,X,Y,ORNOW,DD,PSOI S Y=0,ORNOW=$$NOW^XLFDT
"RTN","ORCACT01",112,0)
 S I=0 F  S I=+$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D  Q:Y
"RTN","ORCACT01",113,0)
 . S OI=+$G(^OR(100,+IFN,4.5,I,1))
"RTN","ORCACT01",114,0)
 . I OI S X=$G(^ORD(101.43,OI,.1)) I X,X<ORNOW S Y=1
"RTN","ORCACT01",115,0)
 I Y,PKG="PS",DG'="IV RX" D  ;replacement OI?
"RTN","ORCACT01",116,0)
 . S I=+$O(^OR(100,+IFN,4.5,"ID","DRUG",0)) Q:I'>0  ;first
"RTN","ORCACT01",117,0)
 . S DD=+$G(^OR(100,+IFN,4.5,I,1)) Q:DD'>0  Q:$G(OI)'>0
"RTN","ORCACT01",118,0)
 . S PSOI=+$P($G(^ORD(101.43,OI,0)),U,2),X=$$ITEM^PSSUTIL1(PSOI,DD)
"RTN","ORCACT01",119,0)
 . Q:X'>0  S X=+$O(^ORD(101.43,"ID",+$P(X,U,2)_";99PSP",0)) Q:X'>0
"RTN","ORCACT01",120,0)
 . I $G(^ORD(101.43,X,.1)),$G(^(.1))<ORNOW Q  ;make sure new OI is active
"RTN","ORCACT01",121,0)
 . S I=+$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",122,0)
 . IF I D
"RTN","ORCACT01",123,0)
 . . S PREOI=$G(^OR(100,+IFN,4.5,I,1))
"RTN","ORCACT01",124,0)
 . . S PREOIX=$O(^OR(100,+IFN,.1,"B",PREOI,0))
"RTN","ORCACT01",125,0)
 . . K ^OR(100,+IFN,.1,"B",PREOI,PREOIX)
"RTN","ORCACT01",126,0)
 . . S ^OR(100,+IFN,.1,"B",X,PREOIX)=""
"RTN","ORCACT01",127,0)
 . . S ^OR(100,+IFN,.1,PREOIX,0)=X
"RTN","ORCACT01",128,0)
 . . S ^OR(100,+IFN,4.5,I,1)=X
"RTN","ORCACT01",129,0)
 . . S Y=0 ;reset
"RTN","ORCACT01",130,0)
 Q Y
"RTN","ORCACT01",131,0)
 ;
"RTN","ORCACT01",132,0)
MEDOK() ; -- Returns 1 or 0, if med OI usage=Y
"RTN","ORCACT01",133,0)
 N Y,OI,ORPS,X S Y=1,X=$P(OR0,U,12)
"RTN","ORCACT01",134,0)
 I (DG="SPLY")!(DG="O RX")!(DG="I RX")!(DG="UD RX") D
"RTN","ORCACT01",135,0)
 . S OI=+$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",136,0)
 . S OI=+$G(^OR(100,+IFN,4.5,OI,1))
"RTN","ORCACT01",137,0)
 . S ORPS=$G(^ORD(101.43,OI,"PS"))
"RTN","ORCACT01",138,0)
 I DG="SPLY",'$P(ORPS,U,5) S Y=0
"RTN","ORCACT01",139,0)
 I DG="O RX",'(X="O"&$P(ORPS,U,2)),'(X="I"&($P(ORPS,U)=2)) S Y=0
"RTN","ORCACT01",140,0)
 I DG="I RX"!(DG="UD RX"),'$P(ORPS,U) S Y=0
"RTN","ORCACT01",141,0)
 I DG="IV RX" D
"RTN","ORCACT01",142,0)
 . N I,X0,X1 S I=0
"RTN","ORCACT01",143,0)
 . F  S I=+$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",I)) Q:I<1  D  Q:Y<1
"RTN","ORCACT01",144,0)
 .. S X0=$G(^OR(100,+IFN,4.5,I,0)),X1=+$G(^(1))
"RTN","ORCACT01",145,0)
 .. I $P($G(^ORD(101.41,+$P(X0,U,2),0)),U)["ADDITIVE" S:'$P($G(^ORD(101.43,X1,"PS")),U,4) Y=0 Q
"RTN","ORCACT01",146,0)
 .. S:'$P($G(^ORD(101.43,X1,"PS")),U,3) Y=0
"RTN","ORCACT01",147,0)
 Q Y
"RTN","ORCACT01",148,0)
 ;
"RTN","ORCACT01",149,0)
IV() ; -- IV order, either Inpt or Fluid?
"RTN","ORCACT01",150,0)
 I DG="IV RX" Q 1
"RTN","ORCACT01",151,0)
 N I,OI,X S I=+$O(^OR(100,IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",152,0)
 S OI=+$G(^OR(100,IFN,4.5,+I,1)),X=$P($G(^ORD(101.43,+OI,"PS")),U)
"RTN","ORCACT01",153,0)
 Q (X>1)
"RTN","ORCACT01",154,0)
 ;
"RTN","ORCACT01",155,0)
NTBG(ORIFN) ; -- Inpt order marked as 'Not to be Given'?
"RTN","ORCACT01",156,0)
 N PSIFN,Y,ORI,ORCH S Y=""
"RTN","ORCACT01",157,0)
 S PSIFN=$G(^OR(100,+ORIFN,4)) I PSIFN>0 Q $$ENNG^PSJORUT2(+ORVP,PSIFN)
"RTN","ORCACT01",158,0)
 S ORI=0 F  S ORI=$O(^OR(100,+ORIFN,2,ORI)) Q:ORI'>0  S ORCH=+$G(^(ORI,0)),PSIFN=$G(^OR(100,ORCH,4)) I PSIFN>0 S Y=$$ENNG^PSJORUT2(+ORVP,PSIFN) Q:Y
"RTN","ORCACT01",159,0)
 Q Y
"RTN","ORCACT01",160,0)
 ;
"RTN","ORCACT01",161,0)
RESET(IFN,NEWOI)   ; -- Update OI if changed before renewing
"RTN","ORCACT01",162,0)
 Q:'$G(IFN)  Q:'$D(^OR(100,+IFN,0))  Q:'$G(NEWOI)
"RTN","ORCACT01",163,0)
 N I,ORIT S ORIT=+$O(^ORD(101.43,"ID",NEWOI_";99PSP",0)) Q:ORIT'>0
"RTN","ORCACT01",164,0)
 S I=$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",165,0)
 S:I ^OR(100,+IFN,4.5,I,1)=ORIT
"RTN","ORCACT01",166,0)
 Q
"RTN","ORCSAVE")
0^9^B58561641
"RTN","ORCSAVE",1,0)
ORCSAVE ;SLC/MKB-Save [ 08/09/96  11:28 PM ] ; 08 May 2002  2:12 PM
"RTN","ORCSAVE",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,73,92,94,116,141,163**;Dec 17, 1997
"RTN","ORCSAVE",3,0)
NEW(ORDIALOG,ORDG,ORPKG,ORCAT,OREVENT,ORDUZ,ORLOG) ; -- New order
"RTN","ORCSAVE",4,0)
 ; Returns ORIFN = [new] order number, if created/saved
"RTN","ORCSAVE",5,0)
 D EN
"RTN","ORCSAVE",6,0)
 Q
"RTN","ORCSAVE",7,0)
 ;
"RTN","ORCSAVE",8,0)
XX ; -- save new/unreleased edited order into Orders file
"RTN","ORCSAVE",9,0)
 ;    Requires: ORDIALOG() = array of dialog values
"RTN","ORCSAVE",10,0)
 ;              ORIFN      = IFN of original order that was edited
"RTN","ORCSAVE",11,0)
 ;  
"RTN","ORCSAVE",12,0)
 N OLDIFN S ORIFN=+ORIFN
"RTN","ORCSAVE",13,0)
 I $S($P(^OR(100,ORIFN,3),U,3)=11:0,$P(^(3),U,3)'=10:1,$P(^(8,1,0),U,4)=2:0,1:1) S OLDIFN=ORIFN K ORIFN ; create new order if released or delayed&signed
"RTN","ORCSAVE",14,0)
 D EN Q:'ORIFN  S:'$G(ORDA) ORDA=1
"RTN","ORCSAVE",15,0)
 I $G(OLDIFN) D  ;save links between orders
"RTN","ORCSAVE",16,0)
 . S $P(^OR(100,ORIFN,3),U,5)=OLDIFN,$P(^(3),U,11)=1
"RTN","ORCSAVE",17,0)
 . S $P(^OR(100,OLDIFN,3),U,6)=ORIFN S:$D(^(5)) ^OR(100,ORIFN,5)=^OR(100,OLDIFN,5)
"RTN","ORCSAVE",18,0)
 Q
"RTN","ORCSAVE",19,0)
 ;
"RTN","ORCSAVE",20,0)
RN ; -- save new/unreleased renewal order into Orders file
"RTN","ORCSAVE",21,0)
 ;    Requires: ORDIALOG() = array of new dialog values
"RTN","ORCSAVE",22,0)
 ;              ORIFN      = IFN of original order that was renewed
"RTN","ORCSAVE",23,0)
 ; 
"RTN","ORCSAVE",24,0)
 N OLDIFN S OLDIFN=+ORIFN K ORIFN
"RTN","ORCSAVE",25,0)
 D EN Q:'ORIFN  S:'$G(ORDA) ORDA=1
"RTN","ORCSAVE",26,0)
 S $P(^OR(100,ORIFN,3),U,5)=OLDIFN,$P(^(3),U,11)=2
"RTN","ORCSAVE",27,0)
 S $P(^OR(100,OLDIFN,3),U,6)=ORIFN S:$D(^(5)) ^OR(100,ORIFN,5)=^OR(100,OLDIFN,5)
"RTN","ORCSAVE",28,0)
 Q
"RTN","ORCSAVE",29,0)
 ;
"RTN","ORCSAVE",30,0)
EN ; -- save new/unreleased order in ORDIALOG() into Orders file
"RTN","ORCSAVE",31,0)
 ;    Requires: ORVP, ORNP [and ORL, ORTS if available]
"RTN","ORCSAVE",32,0)
 ;
"RTN","ORCSAVE",33,0)
 N PKG,NOW,NODE,CNT,CDL,I,X,STS,SIGNREQD,LOC,TRSPEC,NATR,CATG,DG,LOG,USR
"RTN","ORCSAVE",34,0)
 Q:'$G(ORVP)  Q:'$G(ORDIALOG)  Q:'$D(^ORD(101.41,+ORDIALOG,0))
"RTN","ORCSAVE",35,0)
 S NOW=$$NOW^XLFDT,SIGNREQD=+$P(^ORD(101.41,+ORDIALOG,0),U,6)
"RTN","ORCSAVE",36,0)
 S CATG=$S($L($G(ORCAT)):ORCAT,1:$S($$INPT^ORCD:"I",1:"O"))
"RTN","ORCSAVE",37,0)
 S PKG=$S($G(ORPKG):ORPKG,1:$P(^ORD(101.41,+ORDIALOG,0),U,7))
"RTN","ORCSAVE",38,0)
 I $G(ORIFN),$D(^OR(100,ORIFN,0)) S STS=$P(^(3),U,3) G EN2 ; unrel order
"RTN","ORCSAVE",39,0)
 S DG=$S($G(ORDG):+ORDG,1:$P(^ORD(101.41,+ORDIALOG,0),U,5))
"RTN","ORCSAVE",40,0)
 I $G(OREVENT),$$GET1^DIQ(9.4,+PKG_",",1)'="PSO" S LOC="",TRSPEC=""
"RTN","ORCSAVE",41,0)
 E  S LOC=$G(ORL),TRSPEC=$G(ORTS)
"RTN","ORCSAVE",42,0)
 S LOG=$S($G(ORLOG):ORLOG,1:+$E(NOW,1,12)),USR=$S($G(ORDUZ):ORDUZ,1:DUZ)
"RTN","ORCSAVE",43,0)
 S NATR=+$O(^ORD(100.02,"C","E",0)) ;assume Elec Entered until changed
"RTN","ORCSAVE",44,0)
 S STS=$S($G(OREVENT):10,1:11),ORIFN=$$NEXTIFN Q:'ORIFN
"RTN","ORCSAVE",45,0)
EN1 S ^OR(100,ORIFN,0)=ORIFN_U_ORVP_U_U_$G(ORNP)_U_+ORDIALOG_";ORD(101.41,^"_USR_U_LOG_U_U_U_LOC_U_DG_U_CATG_U_TRSPEC_U_PKG_U_U_SIGNREQD_U_$G(OREVENT)
"RTN","ORCSAVE",46,0)
 S ^OR(100,ORIFN,3)=LOG_"^90^"_STS_U_$S($G(ORIT):ORIT_";ORD(101.41,",1:"")_U_$G(ORDIALOG("PREV"))_"^^1^^^^0"
"RTN","ORCSAVE",47,0)
 S ^OR(100,ORIFN,8,0)="^100.008DA^1^1",^OR(100,ORIFN,8,1,0)=LOG_"^NW^"_$G(ORNP)_U_$S(SIGNREQD:2,1:3)_"^^^^^^^^"_NATR_U_USR_"^1^"_STS,^OR(100,ORIFN,8,"C","NW",1)=""
"RTN","ORCSAVE",48,0)
 S ^OR(100,"AF",LOG,ORIFN,1)=""
"RTN","ORCSAVE",49,0)
 S ^OR(100,"ACT",ORVP,9999999-LOG,+DG,ORIFN,1)=""
"RTN","ORCSAVE",50,0)
 S:STS'=10 ^OR(100,"AC",ORVP,9999999-LOG,ORIFN,1)=""
"RTN","ORCSAVE",51,0)
 S:SIGNREQD ^OR(100,"AS",ORVP,9999999-LOG,ORIFN,1)=""
"RTN","ORCSAVE",52,0)
 S:$G(OREVENT) ^OR(100,"AEVNT",ORVP,OREVENT,ORIFN)=""
"RTN","ORCSAVE",53,0)
EN2 S ORIFN=+ORIFN D RESPONSE ; save responses
"RTN","ORCSAVE",54,0)
 I $P(^OR(100,ORIFN,0),"^",5) D  ;Copy orders PKI fix
"RTN","ORCSAVE",55,0)
 . N OI
"RTN","ORCSAVE",56,0)
 . S OI=+$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",0)),OI=+$G(^OR(100,ORIFN,4.5,OI,1)) Q:'OI
"RTN","ORCSAVE",57,0)
 . I PKG'=$O(^DIC(9.4,"B","OUTPATIENT PHARMACY",0)) Q
"RTN","ORCSAVE",58,0)
 . D PKI^ORWDPS1(.ORY,OI,CATG,+ORVP,$$GET^XPAR("ALL^USR.`"_DUZ,"ORWOR PKI USE",1,"Q"))
"RTN","ORCSAVE",59,0)
 . I $E($G(ORY))=2 S ORDEA=ORY
"RTN","ORCSAVE",60,0)
 K ^OR(100,ORIFN,8,1,.1) D ORDTEXT^ORCSAVE1(ORIFN_";1") ; order text
"RTN","ORCSAVE",61,0)
 S NODE=$G(^OR(100,ORIFN,0)) D  S ^OR(100,ORIFN,0)=NODE
"RTN","ORCSAVE",62,0)
 . S $P(NODE,U,4)=$G(ORNP) ; COST?
"RTN","ORCSAVE",63,0)
 . S I=$O(^OR(100,ORIFN,4.5,"ID","LOCATION",0))
"RTN","ORCSAVE",64,0)
 . I I,$P(NODE,U,10) S X=+$G(^OR(100,ORIFN,4.5,+I,1)) S:X $P(NODE,U,10)=X_";SC(" ;reset Loc if prev value
"RTN","ORCSAVE",65,0)
 . S I=$O(^OR(100,ORIFN,4.5,"ID","CLASS",0))
"RTN","ORCSAVE",66,0)
 . I I S X=$G(^OR(100,ORIFN,4.5,+I,1)) S:"^I^O^"[(U_X_U) $P(NODE,U,12)=X
"RTN","ORCSAVE",67,0)
 S $P(^OR(100,ORIFN,3),U)=NOW
"RTN","ORCSAVE",68,0)
 K ^OR(100,ORIFN,9) I $G(ORCHECK) D  ; save order checks
"RTN","ORCSAVE",69,0)
 . S (CNT,CDL)=0 F  S CDL=$O(ORCHECK("NEW",CDL)) Q:CDL'>0  S I=0 D
"RTN","ORCSAVE",70,0)
 . . F  S I=$O(ORCHECK("NEW",CDL,I)) Q:I'>0  S X=ORCHECK("NEW",CDL,I) D
"RTN","ORCSAVE",71,0)
 . . . S CNT=CNT+1,^OR(100,ORIFN,9,"B",+X,CNT)=""
"RTN","ORCSAVE",72,0)
 . . . S ^OR(100,ORIFN,9,CNT,0)=$P(X,U,1,2),^(1)=$E($P(X,U,3),1,245)
"RTN","ORCSAVE",73,0)
 . S:CNT ^OR(100,ORIFN,9,0)="^100.09PA^"_CNT_U_CNT
"RTN","ORCSAVE",74,0)
 K ORDEA
"RTN","ORCSAVE",75,0)
ENQ Q
"RTN","ORCSAVE",76,0)
 ;
"RTN","ORCSAVE",77,0)
NEXTIFN() ; -- Returns next available ORIFN
"RTN","ORCSAVE",78,0)
 N I,HDR,LAST,TOTAL,DA
"RTN","ORCSAVE",79,0)
 F I=1:1:10 L +^OR(100,0):1 Q:$T  H 2
"RTN","ORCSAVE",80,0)
 I '$T Q "^"
"RTN","ORCSAVE",81,0)
 S HDR=$G(^OR(100,0)),TOTAL=+$P(HDR,U,4),LAST=$O(^OR(100,"?"),-1)
"RTN","ORCSAVE",82,0)
 S I=LAST\1 F I=(I+1):1 Q:'$D(^OR(100,I,0))
"RTN","ORCSAVE",83,0)
 S DA=I,^OR(100,DA,0)=DA,$P(HDR,U,3,4)=DA_U_(TOTAL+1)
"RTN","ORCSAVE",84,0)
 S ^OR(100,0)=HDR L -^OR(100,0)
"RTN","ORCSAVE",85,0)
 Q DA
"RTN","ORCSAVE",86,0)
 ;
"RTN","ORCSAVE",87,0)
RESPONSE ; -- Save responses in ORDIALOG() into ^OR(100,ORIFN,4.5)
"RTN","ORCSAVE",88,0)
 N PROMPT,CNT,ITM,TYPE,INST,VALUE,I,START,PAT,X
"RTN","ORCSAVE",89,0)
 S PAT=$P(^OR(100,ORIFN,0),U,2),START=$P(^(0),U,8) K ^(4.5)
"RTN","ORCSAVE",90,0)
 S (PROMPT,CNT)=0 F  S PROMPT=$O(ORDIALOG(PROMPT)) Q:PROMPT'>0  D
"RTN","ORCSAVE",91,0)
 . S ITM=$G(ORDIALOG(PROMPT)) Q:'ITM
"RTN","ORCSAVE",92,0)
 . S TYPE=$E($G(ORDIALOG(PROMPT,0))) Q:'$L(TYPE)
"RTN","ORCSAVE",93,0)
 . S INST=0 F  S INST=$O(ORDIALOG(PROMPT,INST)) Q:INST'>0  D
"RTN","ORCSAVE",94,0)
 . . S VALUE=$G(ORDIALOG(PROMPT,INST)) Q:VALUE=""  S CNT=CNT+1
"RTN","ORCSAVE",95,0)
 . . S ^OR(100,ORIFN,4.5,CNT,0)=+ITM_U_PROMPT_U_INST_U_$P(ITM,U,2)
"RTN","ORCSAVE",96,0)
 . . S:$L($P(ITM,U,2)) ^OR(100,ORIFN,4.5,"ID",$P(ITM,U,2),CNT)=""
"RTN","ORCSAVE",97,0)
 . . S:TYPE'="W" ^OR(100,ORIFN,4.5,CNT,1)=VALUE
"RTN","ORCSAVE",98,0)
 . . M:TYPE="W" ^OR(100,ORIFN,4.5,CNT,2)=@VALUE ; array root
"RTN","ORCSAVE",99,0)
 S ^OR(100,ORIFN,4.5,0)="^100.045A^"_CNT_U_CNT
"RTN","ORCSAVE",100,0)
R1 ; [Reset] Orderables
"RTN","ORCSAVE",101,0)
 I $D(^OR(100,ORIFN,.1)) S I=0 F  S I=$O(^OR(100,ORIFN,.1,I)) Q:I'>0  S X=$G(^(I,0)) I X,PAT,START K ^OR(100,"AOI",X,PAT,9999999-START,ORIFN) ; kill xref
"RTN","ORCSAVE",102,0)
 K ^OR(100,ORIFN,.1) I $D(^OR(100,ORIFN,4.5,"ID","ORDERABLE")) D
"RTN","ORCSAVE",103,0)
 . S (I,CNT)=0
"RTN","ORCSAVE",104,0)
 . F  S I=$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D
"RTN","ORCSAVE",105,0)
 . . S X=$G(^OR(100,ORIFN,4.5,I,1)) Q:'X
"RTN","ORCSAVE",106,0)
 . . S CNT=CNT+1,^OR(100,ORIFN,.1,CNT,0)=X,^OR(100,ORIFN,.1,"B",X,CNT)=""
"RTN","ORCSAVE",107,0)
 . . I PAT,START S ^OR(100,"AOI",X,PAT,9999999-START,ORIFN)=""
"RTN","ORCSAVE",108,0)
 . S ^OR(100,ORIFN,.1,0)="^100.001PA^"_CNT_U_CNT
"RTN","ORCSAVE",109,0)
 Q
"RTN","ORCSAVE",110,0)
 ;
"RTN","ORCSAVE",111,0)
RESUME(IFN) ; -- add Response nodes for RESUME tray service
"RTN","ORCSAVE",112,0)
 ; S ^OR(100,+IFN,4.5,<next>,0)=DT_"^^^RESUME",^(1)=1
"RTN","ORCSAVE",113,0)
 ;
"RTN","ORCSAVE",114,0)
 N X,Y,DA,DIC
"RTN","ORCSAVE",115,0)
 S DIC="^OR(100,"_+IFN_",4.5,",DIC(0)="LX",DA(1)=+IFN,X=DT
"RTN","ORCSAVE",116,0)
 S DIC("DR")=".04///RESUME",DIC("P")=$P(^DD(100,4.5,0),U,2)
"RTN","ORCSAVE",117,0)
 D ^DIC S:Y ^OR(100,+IFN,4.5,+Y,1)=1
"RTN","ORCSAVE",118,0)
 Q
"RTN","ORCSAVE",119,0)
 ;
"RTN","ORCSAVE",120,0)
PROVIDER(ORDER,PROV) ; -- Change PROVider assigned to ORDER
"RTN","ORCSAVE",121,0)
 Q:'$G(ORDER)  Q:'$G(PROV)
"RTN","ORCSAVE",122,0)
 N ORACT S ORACT=+$P(ORDER,";",2) S:'ORACT ORACT=1
"RTN","ORCSAVE",123,0)
 S $P(^OR(100,+ORDER,8,ORACT,0),U,3)=PROV
"RTN","ORCSAVE",124,0)
 S:ORACT=1 $P(^OR(100,+ORDER,0),U,4)=PROV
"RTN","ORCSAVE",125,0)
 Q
"RTN","ORCSAVE",126,0)
 ;
"RTN","ORCSAVE",127,0)
ACTION(CODE,DA,PROV,REASON,WHEN,WHO) ; -- save new action
"RTN","ORCSAVE",128,0)
 N NEXT,TOTAL,HDR,LAST,X,PAT,DGRP,SIG,NATR,TXT S DA=+DA
"RTN","ORCSAVE",129,0)
 Q:'$D(^OR(100,DA,0)) 0 Q:$G(CODE)'?2U 0
"RTN","ORCSAVE",130,0)
 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE",131,0)
 S NATR=+$O(^ORD(100.02,"C","E",0)) ;assume Elec Entered until changed
"RTN","ORCSAVE",132,0)
 S PAT=$P(^OR(100,DA,0),U,2),DGRP=$P(^(0),U,11),SIG=$P(^(0),U,16),X=+$P($G(^(3)),U,7),HDR=$G(^(8,0))
"RTN","ORCSAVE",133,0)
 S:X'>0 X=1 S TXT=$P($G(^OR(100,DA,8,X,0)),U,14) ;current actn's txt ptr
"RTN","ORCSAVE",134,0)
 S:HDR="" HDR="^100.008DA^^" S TOTAL=+$P(HDR,U,4)
"RTN","ORCSAVE",135,0)
 S LAST=$O(^OR(100,DA,8,"C",CODE,"?"),-1) I LAST D
"RTN","ORCSAVE",136,0)
 . S X=$G(^OR(100,DA,8,LAST,0)) Q:$P(X,U,15)'=11  Q:$P(X,U,4)'=2
"RTN","ORCSAVE",137,0)
 . S NEXT=LAST I PAT,$P(X,U) D  ; kill old xref entries
"RTN","ORCSAVE",138,0)
 . . K:DGRP ^OR(100,"ACT",PAT,(9999999-$P(X,U)),DGRP,DA,NEXT)
"RTN","ORCSAVE",139,0)
 . . K ^OR(100,"AC",PAT,(9999999-$P(X,U)),DA,NEXT),^OR(100,"AS",PAT,(9999999-$P(X,U)),DA,NEXT),^OR(100,"AF",$P(X,U),DA,NEXT)
"RTN","ORCSAVE",140,0)
 S:'$G(NEXT) NEXT=$O(^OR(100,DA,8,"?"),-1)+1,TOTAL=TOTAL+1
"RTN","ORCSAVE",141,0)
 S ^OR(100,DA,8,NEXT,0)=WHEN_U_CODE_U_$G(PROV)_U_$S(SIG:2,1:3)_"^^^^^^^^"_NATR_U_WHO_U_TXT_"^11",^OR(100,DA,8,"C",CODE,NEXT)=""
"RTN","ORCSAVE",142,0)
 S ^OR(100,"AF",WHEN,DA,NEXT)=""
"RTN","ORCSAVE",143,0)
 I PAT,DGRP S ^OR(100,"ACT",PAT,9999999-WHEN,DGRP,DA,NEXT)=""
"RTN","ORCSAVE",144,0)
 I PAT S ^OR(100,"AC",PAT,9999999-WHEN,DA,NEXT)=""
"RTN","ORCSAVE",145,0)
 I SIG S ^OR(100,"AS",PAT,9999999-WHEN,DA,NEXT)=""
"RTN","ORCSAVE",146,0)
 S:$L($G(REASON)) ^OR(100,DA,8,NEXT,1)=REASON
"RTN","ORCSAVE",147,0)
 S $P(HDR,U,3,4)=NEXT_U_TOTAL,^OR(100,DA,8,0)=HDR
"RTN","ORCSAVE",148,0)
 Q NEXT
"RTN","ORCSAVE",149,0)
 ;
"RTN","ORCSAVE",150,0)
SET(DLG) ; -- Create new parent for order set ORDIALOG
"RTN","ORCSAVE",151,0)
 ; Returns ORPIFN = ifn of new parent order for set
"RTN","ORCSAVE",152,0)
 ;
"RTN","ORCSAVE",153,0)
 Q:'$G(ORVP)  Q:'$G(DLG)  N OR0,PKG,NOW,CATG,STS,ORLOC,TRSPEC,X
"RTN","ORCSAVE",154,0)
 S OR0=$G(^ORD(101.41,DLG,0)) Q:OR0=""  S ORPIFN=$$NEXTIFN Q:'ORPIFN
"RTN","ORCSAVE",155,0)
 S PKG=$O(^DIC(9.4,"C","OR",0)),CATG=$S($$INPT^ORCD:"I",1:"O"),STS=$S($G(OREVENT):10,1:11),NOW=$S($G(ORSLOG):ORSLOG,1:+$E($$NOW^XLFDT,1,12))
"RTN","ORCSAVE",156,0)
 I $G(OREVENT) S ORLOC="",TRSPEC=""
"RTN","ORCSAVE",157,0)
 S ^OR(100,ORPIFN,0)=ORPIFN_U_ORVP_U_U_$G(ORNP)_U_DLG_";ORD(101.41,^"_DUZ_U_NOW_U_U_U_ORLOC_U_U_CATG_U_TRSPEC_U_PKG_"^^^"_$G(OREVENT),^(3)=NOW_"^90^"_STS_U_$S($G(ORIT):ORIT_"ORD(101.41,",1:"")_"^^^1^^^^0^^"_+$P(OR0,U,6)
"RTN","ORCSAVE",158,0)
 S ^OR(100,ORPIFN,8,0)="^100.008DA^1^1",^(1,0)=NOW_"^NW^"_$G(ORNP)_"^^^^^^^^^^"_DUZ_"^^"_STS,^OR(100,ORPIFN,8,"C","NW",1)="",^OR(100,"AF",NOW,ORPIFN,1)=""
"RTN","ORCSAVE",159,0)
 S ^OR(100,"ACT",ORVP,9999999-NOW,ORPIFN,1)=""
"RTN","ORCSAVE",160,0)
 S:STS=11 ^OR(100,"AC",ORVP,9999999-NOW,ORPIFN,1)=""
"RTN","ORCSAVE",161,0)
 ; AEVNT ??
"RTN","ORCSAVE",162,0)
 S ^OR(100,ORPIFN,1,0)="^100.011^1^1",^(1,0)=$P(OR0,U,2) ; Order text
"RTN","ORCSAVE",163,0)
 Q
"RTN","ORCSAVE1")
0^7^B30102142
"RTN","ORCSAVE1",1,0)
ORCSAVE1 ; SLC/MKB - Save Order Text ;7/21/97  15:47
"RTN","ORCSAVE1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**92,132,141,163**;Dec 17, 1997
"RTN","ORCSAVE1",3,0)
 ;
"RTN","ORCSAVE1",4,0)
 ; ^ORD(101.41,+ORDIALOG,10,ITM,2)=Seq#^Format^Omit^Lead Text^Trail Text
"RTN","ORCSAVE1",5,0)
 ; ^ORD(101.41,+ORDIALOG,10,"ATXT",Seq#,ITM)=""
"RTN","ORCSAVE1",6,0)
 ;
"RTN","ORCSAVE1",7,0)
ORDTEXT(ORDER) ; -- Build and save order text from ORDIALOG() into ORDER
"RTN","ORCSAVE1",8,0)
 N ORTX,I,IFN,ACT,ORSET
"RTN","ORCSAVE1",9,0)
 D ORTX(240) Q:'$G(ORTX)
"RTN","ORCSAVE1",10,0)
 S IFN=+ORDER,ACT=+$P(ORDER,";",2) S:ACT'>0 ACT=1
"RTN","ORCSAVE1",11,0)
 F I=1:1:ORTX S ^OR(100,IFN,8,ACT,.1,I,0)=ORTX(I)
"RTN","ORCSAVE1",12,0)
 S ^OR(100,IFN,8,ACT,.1,0)=U_U_ORTX_U_ORTX_U_DT_U
"RTN","ORCSAVE1",13,0)
 I $E($G(ORDEA))=2 D  ;PKI Drug Schedule - in future may allow 2-5
"RTN","ORCSAVE1",14,0)
 . S ORSET=0
"RTN","ORCSAVE1",15,0)
 . D DIGTEXT(IFN,ORDEA)
"RTN","ORCSAVE1",16,0)
 . F I=1:1:ORSET S ^OR(100,IFN,8,ACT,.2,I,0)=ORSET(I)
"RTN","ORCSAVE1",17,0)
 . I ORSET>0 S ^OR(100,IFN,8,ACT,.2,0)=U_U_ORSET_U_ORSET_U_DT_U
"RTN","ORCSAVE1",18,0)
 Q
"RTN","ORCSAVE1",19,0)
 ;
"RTN","ORCSAVE1",20,0)
ORTX(WIDTH) ; -- May enter here to return order text in ORTX()
"RTN","ORCSAVE1",21,0)
 N ORP,SEQ,ITEM,ORMAX
"RTN","ORCSAVE1",22,0)
 K ORTX S ORMAX=$S(+$G(WIDTH):WIDTH,1:240)
"RTN","ORCSAVE1",23,0)
 D EXT ; get external form of values
"RTN","ORCSAVE1",24,0)
 S SEQ=0 F  S SEQ=$O(^ORD(101.41,+ORDIALOG,10,"ATXT",SEQ)) Q:SEQ'>0  S ITEM=$O(^(SEQ,0)) D TEXT(ITEM)
"RTN","ORCSAVE1",25,0)
 Q
"RTN","ORCSAVE1",26,0)
 ;
"RTN","ORCSAVE1",27,0)
TEXT(DA) ; -- Includes text of item DA
"RTN","ORCSAVE1",28,0)
 Q:$P(^ORD(101.41,ORDIALOG,10,DA,0),U,11)  Q:'$O(ORP(DA,0))
"RTN","ORCSAVE1",29,0)
 N NEWLN,INST,TYPE,PTR,CHSEQ,CHILD,ORI,X,Y
"RTN","ORCSAVE1",30,0)
 S:'$G(ORTX) ORTX=1,ORTX(1)=""
"RTN","ORCSAVE1",31,0)
 S NEWLN=+$P(ORP(DA),U,4),INST=$O(ORP(DA,0)),Y=""
"RTN","ORCSAVE1",32,0)
 I NEWLN,$L(ORTX(ORTX)) S ORTX=ORTX+1,ORTX(ORTX)="",Y=" "
"RTN","ORCSAVE1",33,0)
 S X=$$GETXT($P(ORP(DA),U,2)) I $L(X) S X=Y_X,Y="" D TXT^ORCHTAB ;lead tx
"RTN","ORCSAVE1",34,0)
 S PTR=+ORP(DA),TYPE=$E(ORDIALOG(PTR,0))
"RTN","ORCSAVE1",35,0)
TXT1 I TYPE'="W" S X=Y_ORP(DA,INST),Y="" D TXT^ORCHTAB
"RTN","ORCSAVE1",36,0)
 I TYPE="W" S ORI=0 F  S ORI=$O(ORP(DA,INST,ORI)) Q:ORI'>0  D  S Y=""
"RTN","ORCSAVE1",37,0)
 . S Y=$S(Y=" ":" ",$P(ORP(DA),U,5):" ",1:"") ;new line, or as stored
"RTN","ORCSAVE1",38,0)
 . S X=Y_ORP(DA,INST,ORI,0),Y=""
"RTN","ORCSAVE1",39,0)
 . I ORTX(ORTX)[X Q
"RTN","ORCSAVE1",40,0)
 . I $E(X)'=" " D TXT^ORCHTAB Q  ; wrap
"RTN","ORCSAVE1",41,0)
 . S:$L(ORTX(ORTX)) ORTX=ORTX+1,ORTX(ORTX)="" ; force new line
"RTN","ORCSAVE1",42,0)
 . I X?1." " S ORTX(ORTX)=" ",ORTX=ORTX+1,ORTX(ORTX)="" ; blank line
"RTN","ORCSAVE1",43,0)
 . E  D TXT^ORCHTAB
"RTN","ORCSAVE1",44,0)
 D:$D(^ORD(101.41,+ORDIALOG,10,"DAD",PTR)) CHILD(PTR)
"RTN","ORCSAVE1",45,0)
 S INST=$O(ORP(DA,INST)) ; multiple?
"RTN","ORCSAVE1",46,0)
 I INST S ORTX(ORTX)=ORTX(ORTX)_",",Y="" S:NEWLN ORTX=ORTX+1,ORTX(ORTX)="",Y=" " G TXT1
"RTN","ORCSAVE1",47,0)
 S X=$$GETXT($P(ORP(DA),U,3)) D:$L(X) TXT^ORCHTAB ; trailing text
"RTN","ORCSAVE1",48,0)
 Q
"RTN","ORCSAVE1",49,0)
 ;
"RTN","ORCSAVE1",50,0)
CHILD(PARENT) ; -- add child values
"RTN","ORCSAVE1",51,0)
 N CHSEQ,CHILD S CHSEQ=0
"RTN","ORCSAVE1",52,0)
 F  S CHSEQ=$O(^ORD(101.41,+ORDIALOG,10,"DAD",PARENT,CHSEQ)) Q:CHSEQ'>0  S CHILD=$O(^(CHSEQ,0)) D
"RTN","ORCSAVE1",53,0)
 . Q:'$L($G(ORP(CHILD,INST)))
"RTN","ORCSAVE1",54,0)
 . S X=$$GETXT($P(ORP(CHILD),U,2)) D:$L(X) TXT^ORCHTAB ; lead text
"RTN","ORCSAVE1",55,0)
 . S X=ORP(CHILD,INST) D TXT^ORCHTAB
"RTN","ORCSAVE1",56,0)
 . S X=$$GETXT($P(ORP(CHILD),U,3)) D:$L(X) TXT^ORCHTAB ; trail text
"RTN","ORCSAVE1",57,0)
 Q
"RTN","ORCSAVE1",58,0)
 ;
"RTN","ORCSAVE1",59,0)
GETXT(X) ; -- Returns text of X
"RTN","ORCSAVE1",60,0)
 I $E(X)="@" N VAR S VAR=$E(X,2,99),X=$G(@VAR) K @VAR ; variable w/text
"RTN","ORCSAVE1",61,0)
 Q X
"RTN","ORCSAVE1",62,0)
 ;
"RTN","ORCSAVE1",63,0)
EXT ; -- Build ORP(DA) array of external forms
"RTN","ORCSAVE1",64,0)
 N PROMPT,INST,DA,NODE,FORMAT,OMIT,X,Y,TYPE,PTR
"RTN","ORCSAVE1",65,0)
 S PROMPT=0 F  S PROMPT=$O(ORDIALOG(PROMPT)) Q:PROMPT'>0  D
"RTN","ORCSAVE1",66,0)
 . S DA=+$G(ORDIALOG(PROMPT)),TYPE=$E($G(ORDIALOG(PROMPT,0))) Q:'$L(TYPE)
"RTN","ORCSAVE1",67,0)
 . Q:'DA  S NODE=$G(^ORD(101.41,ORDIALOG,10,DA,2)),FORMAT=$P(NODE,U,2),OMIT=$P(NODE,U,3)
"RTN","ORCSAVE1",68,0)
 . S:$D(ORDIALOG(PROMPT,"FORMAT")) FORMAT=ORDIALOG(PROMPT,"FORMAT")
"RTN","ORCSAVE1",69,0)
 . I $E(FORMAT)="@" S PTR=+$E(FORMAT,2,99) Q:'PTR  ; Don't include
"RTN","ORCSAVE1",70,0)
 . S INST=0 F  S INST=$O(ORDIALOG(PROMPT,INST)) Q:INST'>0  D
"RTN","ORCSAVE1",71,0)
 . . Q:ORDIALOG(PROMPT,INST)=""
"RTN","ORCSAVE1",72,0)
 . . I $E(FORMAT)="@",$L($G(ORDIALOG(PTR,INST))) Q  ; use PTR instead
"RTN","ORCSAVE1",73,0)
 . . I $E(FORMAT)="*" S PTR=+$E(FORMAT,2,99) I '$L($G(ORDIALOG(PTR,INST))) Q  ; must have PTR too
"RTN","ORCSAVE1",74,0)
 . . I $E(FORMAT)="=" S PTR=+$E(FORMAT,2,99) I PTR,$L($G(ORDIALOG(PTR,INST))) S Y=$$EXT^ORCD(PTR,INST),X=$$EXT^ORCD(PROMPT,INST) I (X=Y)!(X[Y)!(Y[X) Q
"RTN","ORCSAVE1",75,0)
 . . I TYPE="W" M ORP(DA,INST)=@ORDIALOG(PROMPT,INST)
"RTN","ORCSAVE1",76,0)
 . . E  S X=$$EXT^ORCD(PROMPT,INST,FORMAT) Q:X=""  Q:OMIT[X  S ORP(DA,INST)=X
"RTN","ORCSAVE1",77,0)
 . . S ORP(DA)=PROMPT_U_$P(NODE,U,4,7) ; ptr^lead^trail^new line^wrap
"RTN","ORCSAVE1",78,0)
 Q
"RTN","ORCSAVE1",79,0)
DIGTEXT(ORDER,ORDEA,ORSIGNER)  ;Build text used to create Digital Signature
"RTN","ORCSAVE1",80,0)
 ;ORDER = ifn of order # (file 100)
"RTN","ORCSAVE1",81,0)
 ;ORDEA = Controlled substance schedule of drug (2-5)
"RTN","ORCSAVE1",82,0)
 ;ORSIGNER = DUZ of sigining physician
"RTN","ORCSAVE1",83,0)
 ;ORSET(1)=1)Date of Prescription (RX) -Date Ordered HL7 format 2)Full Patient Name 3)Patient SSN 4)DFN
"RTN","ORCSAVE1",84,0)
 ;ORSET(2)=5)Patient Street1 6)Patient Street2 7)Patient Street3 8)Patient City 9)Patient State 10)Patient Zip 11)???
"RTN","ORCSAVE1",85,0)
 ;ORSET(3)=12)Drug name (From Dispense Drug or Orderable Item) 13)Variable ptr for Drug (file 50 or 101.43) 14)Drug quantity prescribed 15)Schedule of medication 16)DEA Schedule
"RTN","ORCSAVE1",86,0)
 ;ORSET(4)=17)Direction for use
"RTN","ORCSAVE1",87,0)
 ;ORSET(5)=18)Practitioner's name 19)DUZ 20)Practitioner's (DEA) registration number
"RTN","ORCSAVE1",88,0)
 ;ORSET(6)=22)SiteName 23)SiteStreet1 24)SiteStreet2 25)SiteCity 26)SiteState 27)SiteZip
"RTN","ORCSAVE1",89,0)
 ;ORSET(7)=28)$H
"RTN","ORCSAVE1",90,0)
 N I,DFN,OR80,ORPNM,ORSSN,ORXDT,VAERR,VAPA,X0,X1,X4,X5,X6,X8,X9,X10,X11,X12,X13,X14,SIG
"RTN","ORCSAVE1",91,0)
 S OR80=$G(^OR(100,ORDER,8,1,0))
"RTN","ORCSAVE1",92,0)
 Q:'$L(OR80)
"RTN","ORCSAVE1",93,0)
 S:'$G(ORSIGNER) ORSIGNER=$P(OR80,"^",3)
"RTN","ORCSAVE1",94,0)
 Q:'ORSIGNER
"RTN","ORCSAVE1",95,0)
 S $P(^OR(100,ORDER,8,1,2),"^",4,5)=ORDEA_"^"_1 ;Flag to signing process to get digital signature
"RTN","ORCSAVE1",96,0)
 S ORXDT=$P(OR80,"^"),X1=$$FMTHL7^XLFDT(ORXDT),X4="",X14="",X10=""
"RTN","ORCSAVE1",97,0)
 I '$D(ORVP) S ORVP=$P(^OR(100,ORDER,0),"^",2)
"RTN","ORCSAVE1",98,0)
 S DFN=+ORVP
"RTN","ORCSAVE1",99,0)
 D ADD^VADPT
"RTN","ORCSAVE1",100,0)
 S ORPNM=^DPT(+ORVP,0),ORSSN=$P(ORPNM,"^",9),ORPNM=$P(ORPNM,"^")
"RTN","ORCSAVE1",101,0)
 F I=1:1:6 S X4=X4_$S($L($G(VAPA(I))):$S((I=5):$P(VAPA(I),"^",2),1:VAPA(I)),1:"")_"^"
"RTN","ORCSAVE1",102,0)
 S X11=$$GET1^DIQ(200,ORSIGNER,.01,"E") Q:'$L(X11)
"RTN","ORCSAVE1",103,0)
 S X12=$$DEA^XUSER(,ORSIGNER)
"RTN","ORCSAVE1",104,0)
 S X0=$$GET1^DIQ(4,+$G(DUZ(2)),.01,"E")
"RTN","ORCSAVE1",105,0)
 I $L(X0) S X14=X0_"^"_$$GET1^DIQ(4,DUZ(2),1.01,"E")_"^"_$$GET1^DIQ(4,DUZ(2),1.02,"E")_"^"_$$GET1^DIQ(4,DUZ(2),1.03,"E")_"^"_$$GET1^DIQ(4,DUZ(2),.02,"E")_"^"_$$GET1^DIQ(4,DUZ(2),1.04,"E")
"RTN","ORCSAVE1",106,0)
 S X0=$G(^DIC(4,+$G(DUZ(2)),0)),X=$G(^(1))
"RTN","ORCSAVE1",107,0)
 S X5=$$VALUE^ORX8(ORDER,"DRUG",,"E"),X6=$$VALUE^ORX8(ORDER,"DRUG")_";50"
"RTN","ORCSAVE1",108,0)
 I '$L(X5) S X5=$$VALUE^ORX8(ORDER,"ORDERABLE",,"E"),X6=$$VALUE^ORX8(ORDER,"ORDERABLE")_";101.43"
"RTN","ORCSAVE1",109,0)
 S X8=$$VALUE^ORX8(ORDER,"QTY",,"E"),X9=$$VALUE^ORX8(ORDER,"SCHEDULE",,"E")
"RTN","ORCSAVE1",110,0)
 S SIG=+$O(^OR(100,ORDER,4.5,"ID","SIG",0)) I SIG,$L($G(^OR(100,ORDER,4.5,SIG,2,1,0))) S X10=^(0)
"RTN","ORCSAVE1",111,0)
 S ORSET(1)=X1_"^"_ORPNM_"^"_ORSSN_"^"_+ORVP_"^"
"RTN","ORCSAVE1",112,0)
 S ORSET(2)=X4_"^"
"RTN","ORCSAVE1",113,0)
 S ORSET(3)=X5_"^"_X6_"^"_X8_"^"_X9_"^"_ORDEA_"^"
"RTN","ORCSAVE1",114,0)
 S ORSET(4)=X10_"^"
"RTN","ORCSAVE1",115,0)
 S ORSET(5)=X11_"^"_ORSIGNER_"^"_X12_"^"
"RTN","ORCSAVE1",116,0)
 S ORSET(6)=X14
"RTN","ORCSAVE1",117,0)
 S ORSET(7)=$H
"RTN","ORCSAVE1",118,0)
 S ORSET=7
"RTN","ORCSAVE1",119,0)
 Q
"RTN","ORWDPS1")
0^6^B29850798
"RTN","ORWDPS1",1,0)
ORWDPS1 ; SLC/KCM/JLI - Pharmacy Calls for Windows Dialog; 7/3/2002 3PM
"RTN","ORWDPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**85,132,141,163**;Dec 17, 1997
"RTN","ORWDPS1",3,0)
 ;
"RTN","ORWDPS1",4,0)
ODSLCT(LST,PSTYPE,DFN,LOC) ; return default lists for dialog
"RTN","ORWDPS1",5,0)
 ; PSTYPE: pharmacy type (U=unit dose, F=IV fluids, O=outpatient)
"RTN","ORWDPS1",6,0)
 N ILST S ILST=0
"RTN","ORWDPS1",7,0)
 S ILST=ILST+1,LST(ILST)="~Priority" D PRIOR
"RTN","ORWDPS1",8,0)
 S ILST=ILST+1,LST(ILST)="~DispMsg"
"RTN","ORWDPS1",9,0)
 S ILST=ILST+1,LST(ILST)="d"_$$DISPMSG
"RTN","ORWDPS1",10,0)
 ;
"RTN","ORWDPS1",11,0)
 ; I PSTYPE="F" D  Q                           ; IV Fluids
"RTN","ORWDPS1",12,0)
 ; . S ILST=ILST+1,LST(ILST)="~ShortList" D SHORT
"RTN","ORWDPS1",13,0)
 ;
"RTN","ORWDPS1",14,0)
 I PSTYPE="O" D                                ; Outpatient
"RTN","ORWDPS1",15,0)
 . S ILST=ILST+1,LST(ILST)="~Refills"
"RTN","ORWDPS1",16,0)
 . S ILST=ILST+1,LST(ILST)="d0^0"
"RTN","ORWDPS1",17,0)
 . S ILST=ILST+1,LST(ILST)="~Pickup"
"RTN","ORWDPS1",18,0)
 . S ILST=ILST+1,LST(ILST)="d"_$$DEFPICK($G(LOC))
"RTN","ORWDPS1",19,0)
 . ; S ILST=ILST+1,LST(ILST)="~Supply"
"RTN","ORWDPS1",20,0)
 . ; S ILST=ILST+1,LST(ILST)="d^"_$$DEFSPLY(DFN)
"RTN","ORWDPS1",21,0)
 Q
"RTN","ORWDPS1",22,0)
PKI(ORY,OI,PSTYPE,ORVP,PKIACTIV) ; return DEA Schedule for drug
"RTN","ORWDPS1",23,0)
 N ILST,ORDOSE,ORWPSOI,ORWDOSES,X1,X2,X
"RTN","ORWDPS1",24,0)
 K ^TMP("PSJINS",$J),^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J),^TMP("PSSDIN",$J)
"RTN","ORWDPS1",25,0)
 S ILST=0
"RTN","ORWDPS1",26,0)
 S ORWPSOI=0
"RTN","ORWDPS1",27,0)
 S:+OI ORWPSOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORWDPS1",28,0)
 D START^PSSJORDF(ORWPSOI,$S(PSTYPE="U":"I",1:"O")) ; dflt route, schedule, etc.
"RTN","ORWDPS1",29,0)
 I '$L($T(DOSE^PSSOPKI1)) D DOSE^PSSORUTL(.ORDOSE,ORWPSOI,PSTYPE,ORVP)       ; dflt doses
"RTN","ORWDPS1",30,0)
 I $L($T(DOSE^PSSOPKI1)) D DOSE^PSSOPKI1(.ORDOSE,ORWPSOI,PSTYPE,ORVP)       ; dflt doses NEW PKI CODE from pharmacy
"RTN","ORWDPS1",31,0)
 D EN^PSSDIN(ORWPSOI)                               ; nfi text
"RTN","ORWDPS1",32,0)
 S ORY="" ;PKI
"RTN","ORWDPS1",33,0)
 I $D(ORDOSE("DEA")) S X="",X1=$P(ORDOSE("DEA"),";"),X2=$P(ORDOSE("DEA"),";",2) D
"RTN","ORWDPS1",34,0)
 . I '$L(X2) Q
"RTN","ORWDPS1",35,0)
 . I $G(PKIACTIV) S X=X2
"RTN","ORWDPS1",36,0)
 S ORY=X
"RTN","ORWDPS1",37,0)
 K ^TMP("PSJINS",$J),^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J),^TMP("PSSDIN",$J)
"RTN","ORWDPS1",38,0)
 Q
"RTN","ORWDPS1",39,0)
PRIOR ; from DLGSLCT, get list of allowed priorities
"RTN","ORWDPS1",40,0)
 N X,XREF
"RTN","ORWDPS1",41,0)
 S XREF=$S(PSTYPE="O":"S.PSO",1:"S.PSJ")
"RTN","ORWDPS1",42,0)
 S X="" F  S X=$O(^ORD(101.42,XREF,X)) Q:'$L(X)  D
"RTN","ORWDPS1",43,0)
 . S ILST=ILST+1,LST(ILST)="i"_$O(^ORD(101.42,XREF,X,0))_U_X
"RTN","ORWDPS1",44,0)
 S ILST=ILST+1,LST(ILST)="d"_$O(^ORD(101.42,"B","ROUTINE",0))_U_"ROUTINE"
"RTN","ORWDPS1",45,0)
 Q
"RTN","ORWDPS1",46,0)
DEFPICK(LOC)       ; return default routing
"RTN","ORWDPS1",47,0)
 N X,DLG,PRMT
"RTN","ORWDPS1",48,0)
 S DLG=$O(^ORD(101.41,"AB","PSO OERR",0)),X=""
"RTN","ORWDPS1",49,0)
 S PRMT=$O(^ORD(101.41,"AB","OR GTX ROUTING",0))
"RTN","ORWDPS1",50,0)
 I $D(^TMP("ORECALL",$J,+DLG,+PRMT,1)) S X=^(1)
"RTN","ORWDPS1",51,0)
 I X'="" S EDITONLY=1 Q X  ; EDITONLY used by default action
"RTN","ORWDPS1",52,0)
 ;
"RTN","ORWDPS1",53,0)
 ;S X=$$GET^XPAR("ALL^"_"LOC.`"_LOC,"ORWDPS ROUTING DEFAULT",1,"I")
"RTN","ORWDPS1",54,0)
 S X=$$GET^XPAR("LOC.`"_LOC_"^SYS","ORWDPS ROUTING DEFAULT",1,"I")
"RTN","ORWDPS1",55,0)
 I X="C" S X="C^in Clinic" G XPICK
"RTN","ORWDPS1",56,0)
 I X="M" S X="M^by Mail"   G XPICK
"RTN","ORWDPS1",57,0)
 I X="W" S X="W^at Window" G XPICK
"RTN","ORWDPS1",58,0)
 I X="N" S X=""            G XPICK
"RTN","ORWDPS1",59,0)
 I X=""  S X=$S($D(^PSX(550,"C")):"M^by Mail",1:"W^at Window")
"RTN","ORWDPS1",60,0)
XPICK Q X
"RTN","ORWDPS1",61,0)
 ;
"RTN","ORWDPS1",62,0)
DEFSPLY(DFN)    ; return default days supply for this patient
"RTN","ORWDPS1",63,0)
 N ORWX
"RTN","ORWDPS1",64,0)
 S ORWX("PATIENT")=DFN
"RTN","ORWDPS1",65,0)
 D DSUP^PSOSIGDS(.ORWX)
"RTN","ORWDPS1",66,0)
 Q $G(ORWX("DAYS SUPPLY"))
"RTN","ORWDPS1",67,0)
 ;
"RTN","ORWDPS1",68,0)
DFLTSPLY(VAL,UPD,SCH,PAT,DRG)        ; return days supply given quantity
"RTN","ORWDPS1",69,0)
 ; VAL: default days supply
"RTN","ORWDPS1",70,0)
 N ORWX,I
"RTN","ORWDPS1",71,0)
 S ORWX("PATIENT")=PAT
"RTN","ORWDPS1",72,0)
 I DRG S ORWX("DRUG")=DRG
"RTN","ORWDPS1",73,0)
 F I=1:1:$L(UPD,U)-1 D
"RTN","ORWDPS1",74,0)
 . S ORWX("DOSE ORDERED",I)=$P(UPD,U,I)
"RTN","ORWDPS1",75,0)
 . S ORWX("SCHEDULE",I)=$P(SCH,U,I)
"RTN","ORWDPS1",76,0)
 D DSUP^PSOSIGDS(.ORWX)
"RTN","ORWDPS1",77,0)
 S VAL=$G(ORWX("DAYS SUPPLY"))
"RTN","ORWDPS1",78,0)
 Q
"RTN","ORWDPS1",79,0)
DISPMSG()       ; return 1 to suppress dispense message
"RTN","ORWDPS1",80,0)
 Q +$$GET^XPAR("ALL","ORWDPS SUPPRESS DISPENSE MSG",1,"I")
"RTN","ORWDPS1",81,0)
 ;
"RTN","ORWDPS1",82,0)
SCHALL(LST)     ; return all schedules
"RTN","ORWDPS1",83,0)
 N ILST,SCH,IEN,EXP,TYP,X0
"RTN","ORWDPS1",84,0)
 S ILST=0,SCH=""
"RTN","ORWDPS1",85,0)
 F  S SCH=$O(^PS(51.1,"APPSJ",SCH)) Q:SCH=""  D
"RTN","ORWDPS1",86,0)
 . S IEN=0,EXP=""
"RTN","ORWDPS1",87,0)
 . F  S IEN=$O(^PS(51.1,"APPSJ",SCH,IEN)) Q:'IEN  D  Q:$L(EXP)
"RTN","ORWDPS1",88,0)
 . . S X0=$G(^PS(51.1,IEN,0)),EXP=$P(X0,U,8),TYP=$P(X0,U,5)
"RTN","ORWDPS1",89,0)
 . S ILST=ILST+1,LST(ILST)=SCH_U_EXP_U_TYP
"RTN","ORWDPS1",90,0)
 Q
"RTN","ORWDPS1",91,0)
FORMALT(ORLST,IEN,PSTYPE) ; return a list of formulary alternatives
"RTN","ORWDPS1",92,0)
 N PSID,I
"RTN","ORWDPS1",93,0)
 S IEN=+$P(^ORD(101.43,IEN,0),U,2)
"RTN","ORWDPS1",94,0)
 D EN1^PSSUTIL1(.IEN,PSTYPE)
"RTN","ORWDPS1",95,0)
 S PSID=0,I=0
"RTN","ORWDPS1",96,0)
 F  S PSID=$O(IEN(PSID)) Q:'PSID  D
"RTN","ORWDPS1",97,0)
 . S OI=+$O(^ORD(101.43,"ID",PSID_";99PSP",0))
"RTN","ORWDPS1",98,0)
 . I OI S I=I+1,ORLST(I)=OI,$P(ORLST(I),U,2)=$P(^ORD(101.43,OI,0),U)
"RTN","ORWDPS1",99,0)
 Q
"RTN","ORWDPS1",100,0)
DOSEALT(LST,DDRUG,CUROI,PSTYPE) ; return a list of formulary alternatives for dose
"RTN","ORWDPS1",101,0)
 N I,OI,ORWLST,ILST S ILST=0
"RTN","ORWDPS1",102,0)
 D ENRFA^PSJORUTL(DDRUG,PSTYPE,.ORWLST)
"RTN","ORWDPS1",103,0)
 S I=0 F  S I=$O(ORWLST(I)) Q:'I  D
"RTN","ORWDPS1",104,0)
 . S OI=+$O(^ORD(101.43,"ID",+$P(ORWLST(I),U,4)_";99PSP",0))
"RTN","ORWDPS1",105,0)
 . I OI,OI'=CUROI S ILST=ILST+1,LST(ILST)=OI_U_$P(^ORD(101.43,OI,0),U)
"RTN","ORWDPS1",106,0)
 Q
"RTN","ORWDPS1",107,0)
FAILDEA(FAIL,OI,ORNP,PSTYPE)    ; return 1 if DEA check fails for this provider
"RTN","ORWDPS1",108,0)
 N DEAFLG,PSOI,TPKG
"RTN","ORWDPS1",109,0)
 S FAIL=0,TPKG=$P($G(^ORD(101.43,+$G(OI),0)),U,2)
"RTN","ORWDPS1",110,0)
 Q:TPKG'["PS"
"RTN","ORWDPS1",111,0)
 S PSOI=+TPKG Q:PSOI'>0
"RTN","ORWDPS1",112,0)
 I '$L($T(OIDEA^PSSUTLA1)) Q
"RTN","ORWDPS1",113,0)
 S DEAFLG=$$OIDEA^PSSUTLA1(PSOI,PSTYPE) Q:DEAFLG'>0
"RTN","ORWDPS1",114,0)
 I '$L($$DEA^XUSER(,+$G(ORNP))) S FAIL=1
"RTN","ORWDPS1",115,0)
 Q
"RTN","ORWDPS1",116,0)
FDEA1(FAIL,OI,OITYPE,ORNP) ; only be called for an outpaitent and IV dialog
"RTN","ORWDPS1",117,0)
 ;OI: IV Orderable Item
"RTN","ORWDPS1",118,0)
 ;OITYPE: A:ADDITIVE  S:SOLUTION
"RTN","ORWDPS1",119,0)
 N DEAFLG
"RTN","ORWDPS1",120,0)
 S FAIL=0
"RTN","ORWDPS1",121,0)
 I '$L($T(IVDEA^PSSUTIL1)) Q
"RTN","ORWDPS1",122,0)
 S DEAFLG=$$IVDEA^PSSUTIL1(OI,OITYPE) Q:DEAFLG'>0
"RTN","ORWDPS1",123,0)
 I '$L($P($G(^VA(200,+$G(ORNP),"PS")),U,2)),'$L($P($G(^("PS")),U,3)) S FAIL=1
"RTN","ORWDPS1",124,0)
 Q
"RTN","ORWDPS1",125,0)
 ;
"RTN","ORWDPS1",126,0)
CHK94(VAL)      ; return 1 if patch 94 has been installed
"RTN","ORWDPS1",127,0)
 S VAL=0
"RTN","ORWDPS1",128,0)
 I $O(^ORD(101.41,"B","PS MEDS",0)) S VAL=1
"RTN","ORWDPS1",129,0)
 Q
"RTN","ORWDPS1",130,0)
LOCPICK(Y,LOC) ; return default Location level routing
"RTN","ORWDPS1",131,0)
 S Y=""
"RTN","ORWDPS1",132,0)
 S Y=$$GET^XPAR("LOC.`"_LOC_"^SYS","ORWDPS ROUTING DEFAULT",1,"I")
"RTN","ORWDPS1",133,0)
 I Y="C" S Y="C^in Clinic"
"RTN","ORWDPS1",134,0)
 I Y="M" S Y="M^by Mail"
"RTN","ORWDPS1",135,0)
 I Y="W" S Y="W^at Window"
"RTN","ORWDPS1",136,0)
 I Y="N" S Y=""
"RTN","ORWDPS1",137,0)
 Q
"RTN","ORWDPS1",138,0)
HASOIPI(Y,QOID) ; Check if QO put orderable item's PI into Sig
"RTN","ORWDPS1",139,0)
 N PIIEN,OIX
"RTN","ORWDPS1",140,0)
 S Y=0
"RTN","ORWDPS1",141,0)
 Q:'$D(^ORD(101.41,QOID,0))
"RTN","ORWDPS1",142,0)
 S PIIEN=$O(^ORD(101.41,"B","OR GTX PATIENT INSTRUCTIONS",0))
"RTN","ORWDPS1",143,0)
 Q:'PIIEN
"RTN","ORWDPS1",144,0)
 S OIX=0
"RTN","ORWDPS1",145,0)
 Q:'$D(^ORD(101.41,QOID,6,"D"))
"RTN","ORWDPS1",146,0)
 F  S OIX=$O(^ORD(101.41,+QOID,6,"D",OIX)) Q:'OIX  D
"RTN","ORWDPS1",147,0)
 . I OIX=PIIEN S Y=1 Q
"RTN","ORWDPS1",148,0)
 Q
"RTN","ORWDPS1",149,0)
HASROUTE(Y,QOID) ;Check if QO has a ROUTE defined
"RTN","ORWDPS1",150,0)
 N ROUTID
"RTN","ORWDPS1",151,0)
 S Y=0,ROUTID=0
"RTN","ORWDPS1",152,0)
 S ROUTID=$O(^ORD(101.41,"B","OR GTX ROUTING",0))
"RTN","ORWDPS1",153,0)
 Q:'ROUTID
"RTN","ORWDPS1",154,0)
 Q:'$D(^ORD(101.41,+QOID))
"RTN","ORWDPS1",155,0)
 I $D(^ORD(101.41,+QOID,6,"D",ROUTID)) S Y=1
"RTN","ORWDPS1",156,0)
 Q
"RTN","ORWOR")
0^1^B29680452
"RTN","ORWOR",1,0)
ORWOR ; SLC/KCM - Orders Calls;10:54 PM  02 Feb 2003
"RTN","ORWOR",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,132,141,163**;Dec 17, 1997
"RTN","ORWOR",3,0)
 ;
"RTN","ORWOR",4,0)
CURRENT(LST,DFN) ; Get Current Orders for a Patient
"RTN","ORWOR",5,0)
 ; Returns two lists in ^TMP("ORW",$J), fields and text
"RTN","ORWOR",6,0)
 N TM,IEN,X,X0,X3,CTR,IDX,I
"RTN","ORWOR",7,0)
 K ^TMP("ORW",$J)
"RTN","ORWOR",8,0)
 S IDX=0,DFN=DFN_";DPT("
"RTN","ORWOR",9,0)
 S TM=0 F  S TM=$O(^OR(100,"AC",DFN,TM)) Q:TM<1  D
"RTN","ORWOR",10,0)
 . S IEN=0 F  S IEN=$O(^OR(100,"AC",DFN,TM,IEN)) Q:IEN<1  D
"RTN","ORWOR",11,0)
 . . S X0=^OR(100,IEN,0),X3=^(3)
"RTN","ORWOR",12,0)
 . . S X=IEN_U_$P(X0,U,7)_U_$P(X0,U,11)_U_$P(X3,U,6)_U_$P(X3,U,3)
"RTN","ORWOR",13,0)
 . . S ^TMP("ORW",$J,IDX+1)=X
"RTN","ORWOR",14,0)
 . . S (CTR,I)=0,X=""
"RTN","ORWOR",15,0)
 . . F  S I=$O(^OR(100,IEN,1,I)) Q:I<1  D  Q:CTR>244
"RTN","ORWOR",16,0)
 . . . S X=X_$E(^OR(100,IEN,1,I,0),1,(245-CTR)),CTR=$L(X)
"RTN","ORWOR",17,0)
 . . S ^TMP("ORW",$J,IDX+2)=X,IDX=IDX+2
"RTN","ORWOR",18,0)
 ; S LST=$NA(^TMP("ORW",$J))
"RTN","ORWOR",19,0)
 M LST=^TMP("ORW",$J)
"RTN","ORWOR",20,0)
 Q
"RTN","ORWOR",21,0)
DETAIL(LST,ORID,DFN)    ; Return details of ORID (shell to kill VIDEO subs)
"RTN","ORWOR",22,0)
 I $G(DFN) N ORVP S ORVP=DFN_";DPT("
"RTN","ORWOR",23,0)
 S LST="^TMP(""ORTXT"",$J)"
"RTN","ORWOR",24,0)
 D DETAIL^ORQ2(.LST,ORID)
"RTN","ORWOR",25,0)
 K @LST@("VIDEO")
"RTN","ORWOR",26,0)
 S LST=$NA(^TMP("ORTXT",$J)),@LST=""
"RTN","ORWOR",27,0)
 Q
"RTN","ORWOR",28,0)
RESULT(REF,DFN,ORID,ID)      ; Return results of order identified by ID
"RTN","ORWOR",29,0)
 K ^TMP("ORXPND",$J)
"RTN","ORWOR",30,0)
 N ORESULTS,ORVP,LCNT S ORESULTS=1,LCNT=0,ORVP=DFN_";DPT("
"RTN","ORWOR",31,0)
 D ORDERS^ORCXPND1
"RTN","ORWOR",32,0)
 K ^TMP("ORXPND",$J,"VIDEO")
"RTN","ORWOR",33,0)
 S REF=$NA(^TMP("ORXPND",$J))
"RTN","ORWOR",34,0)
 Q
"RTN","ORWOR",35,0)
RESHIST(REF,DFN,ORID,ID)      ; Return result history of associated tests identified by ID
"RTN","ORWOR",36,0)
 K ^TMP("ORXPND",$J)
"RTN","ORWOR",37,0)
 N ORESULTS,ORVP,LCNT
"RTN","ORWOR",38,0)
 S ORESULTS=1,LCNT=0,ORVP=DFN_";DPT("
"RTN","ORWOR",39,0)
 D ORDHIST^ORWOR2
"RTN","ORWOR",40,0)
 K ^TMP("ORXPND",$J,"VIDEO")
"RTN","ORWOR",41,0)
 S REF=$NA(^TMP("ORXPND",$J))
"RTN","ORWOR",42,0)
 Q
"RTN","ORWOR",43,0)
TSALL(LST)      ; Return list of treating specialties
"RTN","ORWOR",44,0)
 N Y S Y=0
"RTN","ORWOR",45,0)
 F  S Y=$O(^DIC(45.7,Y)) Q:'Y  I $$ACTIVE^DGACT(45.7,Y) S LST(Y)=Y_U_$P(^DIC(45.7,Y,0),U)
"RTN","ORWOR",46,0)
 Q
"RTN","ORWOR",47,0)
DT(X) ; -- Returns FM date for X (SEE ORCHTAB1)
"RTN","ORWOR",48,0)
 N Y,%DT S %DT="T",Y="" D:X'="" ^%DT
"RTN","ORWOR",49,0)
 Q +Y
"RTN","ORWOR",50,0)
VWSET(ANERR,VIEW)       ; Set the preferred view for orders
"RTN","ORWOR",51,0)
 ; VIEW:  semi-colon delimited record
"RTN","ORWOR",52,0)
 ;        1 - Relative From Date/Time or ""
"RTN","ORWOR",53,0)
 ;        2 - Relative Thru Date/Time or ""
"RTN","ORWOR",54,0)
 ;        3 - Filter
"RTN","ORWOR",55,0)
 ;        4 - Display Group Pointer
"RTN","ORWOR",56,0)
 ;        5 - Format (preserve for list manager)
"RTN","ORWOR",57,0)
 ;        6 - chronological display (R or F)
"RTN","ORWOR",58,0)
 ;        7 - sort by display group
"RTN","ORWOR",59,0)
 N FMT
"RTN","ORWOR",60,0)
 ; use short name for display group instead of pointer
"RTN","ORWOR",61,0)
 S $P(VIEW,";",4)=$P($G(^ORD(100.98,+$P(VIEW,";",4),0)),U,3)
"RTN","ORWOR",62,0)
 ; use last saved format, since this is used only by LM
"RTN","ORWOR",63,0)
 S FMT=$P($$GET^XPAR("ALL","ORCH CONTEXT ORDERS",1,"I"),";",5)
"RTN","ORWOR",64,0)
 S:'$L(FMT) FMT="L" S $P(VIEW,";",5)=FMT
"RTN","ORWOR",65,0)
 ; and save the parameter
"RTN","ORWOR",66,0)
 D EN^XPAR(DUZ_";VA(200,","ORCH CONTEXT ORDERS",1,VIEW,.ANERR)
"RTN","ORWOR",67,0)
 Q
"RTN","ORWOR",68,0)
VWGET(REC)      ; Get the preferred view for orders
"RTN","ORWOR",69,0)
 N FROM,THRU,FILTER,DGRP,FRMT,CHRN,BYGRP,S,VNAME,FL
"RTN","ORWOR",70,0)
 S REC=$$GET^XPAR("ALL","ORCH CONTEXT ORDERS",1,"I"),S=";"
"RTN","ORWOR",71,0)
 S FROM=$$DT($P(REC,S)),THRU=$$DT($P(REC,S,2)),FILTER=$P(REC,S,3)
"RTN","ORWOR",72,0)
 S DGRP=$P(REC,S,4),FRMT=$P(REC,S,5),CHRN=$P(REC,S,6),BYGRP=$P(REC,S,7)
"RTN","ORWOR",73,0)
 S:'$L(DGRP) DGRP="ALL" S DGRP=+$O(^ORD(100.98,"B",DGRP,0))
"RTN","ORWOR",74,0)
 I FILTER="" S FILTER=2  ; active orders
"RTN","ORWOR",75,0)
 I CHRN="" S CHRN="R"    ; reverse chronological
"RTN","ORWOR",76,0)
 I BYGRP="" S BYGRP=1    ; sort by display group
"RTN","ORWOR",77,0)
 ; set up view name
"RTN","ORWOR",78,0)
 D REVSTS^ORWORDG(.FL)
"RTN","ORWOR",79,0)
 S I=0 F  S I=$O(FL(I)) Q:'I  Q:+FL(I)=FILTER
"RTN","ORWOR",80,0)
 S VNAME=$P($G(FL(+I)),U,2)
"RTN","ORWOR",81,0)
 I '("^6^8^9^10^19^20^"[(U_FILTER_U)) S VNAME=VNAME_" Orders"
"RTN","ORWOR",82,0)
 I FILTER=2 S VNAME="Active Orders (includes Pending & Recent Activity)"
"RTN","ORWOR",83,0)
 I FILTER=23 S VNAME="Current Orders (Active & Pending Status Only)"
"RTN","ORWOR",84,0)
 S VNAME=VNAME_" - "_$P($G(^ORD(100.98,DGRP,0)),U)
"RTN","ORWOR",85,0)
 I (FROM>0)!(THRU>0) D
"RTN","ORWOR",86,0)
 . S VNAME=VNAME_" ("_$$FMTE^XLFDT(FROM,"2D")_" thru "
"RTN","ORWOR",87,0)
 . S VNAME=VNAME_$S(THRU>0:$$FMTE^XLFDT(THRU,"2D"),1:"")_")"
"RTN","ORWOR",88,0)
 S REC=FROM_S_THRU_S_FILTER_S_DGRP_S_FRMT_S_CHRN_S_BYGRP_S_VNAME
"RTN","ORWOR",89,0)
 Q
"RTN","ORWOR",90,0)
SHEETS(LST,ORVP) ; Return Order Sheets for a patient
"RTN","ORWOR",91,0)
 N ELST,ETYP,ORIFN,TS,I
"RTN","ORWOR",92,0)
 S ORVP=ORVP_";DPT("
"RTN","ORWOR",93,0)
 S ETYP="" F  S ETYP=$O(^OR(100,"AEVNT",ORVP,ETYP)) Q:ETYP=""  D
"RTN","ORWOR",94,0)
 . S ORIFN=0 F  S ORIFN=$O(^OR(100,"AEVNT",ORVP,ETYP,ORIFN)) Q:'ORIFN  D
"RTN","ORWOR",95,0)
 . . I (ETYP="A")!(ETYP="T") S ELST(ETYP,$P($G(^OR(100,+ORIFN,0)),U,13))=""
"RTN","ORWOR",96,0)
 S LST(1)="C;O^Current View",I=1
"RTN","ORWOR",97,0)
 S TS="" F  S TS=$O(ELST("A",TS)) Q:TS=""  D
"RTN","ORWOR",98,0)
 . S I=I+1,LST(I)="A;"_TS_U_"Admit to "_$P($G(^DIC(45.7,TS,0)),U)
"RTN","ORWOR",99,0)
 S I=I+1,LST(I)="A;-1^Admit..."
"RTN","ORWOR",100,0)
 S TS="" F  S TS=$O(ELST("T",TS)) Q:TS=""  D
"RTN","ORWOR",101,0)
 . S I=I+1,LST(I)="T;"_TS_U_"Transfer to "_$P($G(^DIC(45.7,TS,0)),U)
"RTN","ORWOR",102,0)
 I $L($G(^DPT(+ORVP,.1))) D
"RTN","ORWOR",103,0)
 . S I=I+1,LST(I)="T;-1^Transfer..."
"RTN","ORWOR",104,0)
 . S I=I+1,LST(I)="D;0^Discharge"
"RTN","ORWOR",105,0)
 Q
"RTN","ORWOR",106,0)
EVENTS(LST,EVT) ; Return general delayed events categories for a patient
"RTN","ORWOR",107,0)
 N EVTI
"RTN","ORWOR",108,0)
 S EVTI=0
"RTN","ORWOR",109,0)
 S EVTI=EVTI+1,LST(EVTI)="A;-1^Admit..."
"RTN","ORWOR",110,0)
 S EVTI=EVTI+1,LST(EVTI)="T;-1^Transfer..."
"RTN","ORWOR",111,0)
 S EVTI=EVTI+1,LST(EVTI)="D;0^Discharge"
"RTN","ORWOR",112,0)
 Q
"RTN","ORWOR",113,0)
UNSIGN(LST,ORVP,HAVE)   ; Return Unsigned Orders that are not on client
"RTN","ORWOR",114,0)
 N IFN,ACT,X8,ENT,LVL,TM,ILST S ILST=0
"RTN","ORWOR",115,0)
 Q:'$D(^XUSEC("ORES",DUZ))
"RTN","ORWOR",116,0)
 S ORVP=ORVP_";DPT("
"RTN","ORWOR",117,0)
 S ENT="ALL"_$S($G(^VA(200,DUZ,5)):"^SRV.`"_+^(5),1:"")
"RTN","ORWOR",118,0)
 S LVL=$$GET^XPAR(ENT,"OR UNSIGNED ORDERS ON EXIT")
"RTN","ORWOR",119,0)
 Q:'LVL
"RTN","ORWOR",120,0)
 S TM=0 F  S TM=$O(^OR(100,"AS",ORVP,TM)) Q:TM<1  D
"RTN","ORWOR",121,0)
 . S IFN=0 F  S IFN=$O(^OR(100,"AS",ORVP,TM,IFN)) Q:IFN<1  D
"RTN","ORWOR",122,0)
 . . S ACT=0 F  S ACT=$O(^OR(100,"AS",ORVP,TM,IFN,ACT)) Q:ACT<1  D
"RTN","ORWOR",123,0)
 . . . Q:$D(HAVE(IFN_";"_ACT))                        ;in Changes
"RTN","ORWOR",124,0)
 . . . S X8=$G(^OR(100,IFN,8,ACT,0))
"RTN","ORWOR",125,0)
 . . . I '$S(LVL=1&($P(X8,U,3)=DUZ):1,LVL=2:1,1:0) Q  ;chk user
"RTN","ORWOR",126,0)
 . . . S ILST=ILST+1,LST(ILST)=IFN_";"_ACT
"RTN","ORWOR",127,0)
 Q
"RTN","ORWOR",128,0)
PKIUSE(RETURN) ; RPC determines user can use PKI Digital Signature
"RTN","ORWOR",129,0)
 S RETURN=0
"RTN","ORWOR",130,0)
 I $$GET^XPAR("ALL^USR.`"_DUZ,"ORWOR PKI USE",1,"Q") S RETURN=1
"RTN","ORWOR",131,0)
 Q
"RTN","ORWOR",132,0)
PKISITE(RETURN) ; RPC determines if PKI is turned on at the site
"RTN","ORWOR",133,0)
 S RETURN=0
"RTN","ORWOR",134,0)
 Q:'$L($T(STORESIG^XUSSPKI))  ;Check for Kernel piece
"RTN","ORWOR",135,0)
 Q:'$L($T(DOSE^PSSOPKI1))  ;Check for Pharmacy piece
"RTN","ORWOR",136,0)
 I $$GET^XPAR("ALL","ORWOR PKI SITE",1,"Q") S RETURN=1
"RTN","ORWOR",137,0)
 Q
"RTN","ORWOR1")
0^8^B21551426
"RTN","ORWOR1",1,0)
ORWOR1 ; slc/dcm - PKI RPC functions
"RTN","ORWOR1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**132,141,163**;Dec 17, 1997
"RTN","ORWOR1",3,0)
SIG(RET,ID,X1,X2,X3,X4,ORX5,X6) ;Store the signature.
"RTN","ORWOR1",4,0)
 ;ID = orifn;action
"RTN","ORWOR1",5,0)
 ;X1 = Hash
"RTN","ORWOR1",6,0)
 ;X2 = Length of the array
"RTN","ORWOR1",7,0)
 ;X3 = Datafile (100)
"RTN","ORWOR1",8,0)
 ;X4 = Provider DUZ
"RTN","ORWOR1",9,0)
 ;ORX5 = Array for the sig
"RTN","ORWOR1",10,0)
 ;X6 = CRLURL
"RTN","ORWOR1",11,0)
 N Y1,ORIFN,ACT
"RTN","ORWOR1",12,0)
 S Y1=$$STORESIG^XUSSPKI(X1,X2,.ORX5,X4,X3)
"RTN","ORWOR1",13,0)
 I +Y1>0,$L($G(X6)) S Y1=$$CRLURL^XUSSPKI(X6)
"RTN","ORWOR1",14,0)
 I +Y1>0 D
"RTN","ORWOR1",15,0)
 . S ORIFN=+ID,ACT=$P(ID,";",2)
"RTN","ORWOR1",16,0)
 . S $P(^OR(100,ORIFN,8,+ACT,2),"^",3)=X1
"RTN","ORWOR1",17,0)
 S RET=Y1
"RTN","ORWOR1",18,0)
 Q
"RTN","ORWOR1",19,0)
CRLURL(RET,X1) ;Store the URL's
"RTN","ORWOR1",20,0)
 S RET=$$CRLURL^XUSSPKI(X1)
"RTN","ORWOR1",21,0)
 Q
"RTN","ORWOR1",22,0)
VERIFY(RET,ORDER,DFN)       ;Verify PKI Data
"RTN","ORWOR1",23,0)
 ;DBIA #3750
"RTN","ORWOR1",24,0)
 ;ORDER = ORIFN;ACTION - NOTE: if no ACTION then 1 (new order) is assumed
"RTN","ORWOR1",25,0)
 ;Returned values: "1" if digital signature verifies
"RTN","ORWOR1",26,0)
 ;                 "-1^error message" if DS fails during initial parameter checking
"RTN","ORWOR1",27,0)
 ;                 "898020xx^message" if DS fails during verification
"RTN","ORWOR1",28,0)
 N ORIFN,ORACTION,HASH,DATE
"RTN","ORWOR1",29,0)
 K ^TMP("ORPKIDATA",$J)
"RTN","ORWOR1",30,0)
 I '$G(ORDER) S RET="-1^No order number passed" Q
"RTN","ORWOR1",31,0)
 I '$G(DFN) S RET="-1^No DFN passed" Q
"RTN","ORWOR1",32,0)
 S ORIFN=$P(ORDER,";"),ORACTION=$P(ORDER,";",2)
"RTN","ORWOR1",33,0)
 I 'ORACTION S ORACTION=1
"RTN","ORWOR1",34,0)
 I '$D(^OR(100,ORIFN,0)) S RET="-1^Invalid order number" Q
"RTN","ORWOR1",35,0)
 I DFN'=+$P(^OR(100,ORIFN,0),"^",2) S RET="-1^DFN does not match patient on order" Q
"RTN","ORWOR1",36,0)
 I '$D(^OR(100,ORIFN,8,ORACTION)) S RET="-1^Invalid order action passed" Q
"RTN","ORWOR1",37,0)
 S HASH=$P($G(^OR(100,ORIFN,8,ORACTION,2)),"^",3)
"RTN","ORWOR1",38,0)
 I '$L(HASH) S RET="-1^Order has no PKI Hash" Q
"RTN","ORWOR1",39,0)
 I '$O(^OR(100,ORIFN,8,ORACTION,.2,0)) S RET="-1^Order has no PKI Data" Q
"RTN","ORWOR1",40,0)
 S DATE=$P($G(^OR(100,ORIFN,8,ORACTION,.2,1,0)),"^")
"RTN","ORWOR1",41,0)
 I '$L(DATE) S RET="-1^No date associated with PKI Data" Q
"RTN","ORWOR1",42,0)
 S DATE=$$HL7TFM^XLFDT(DATE),I=0
"RTN","ORWOR1",43,0)
 F  S I=$O(^OR(100,ORIFN,8,ORACTION,.2,I)) Q:'I  S ^TMP("ORPKIDATA",$J,I)=^(I,0)
"RTN","ORWOR1",44,0)
 S RET=$$VERIFY^XUSSPKI(HASH,$NA(^TMP("ORPKIDATA",$J)),DATE)
"RTN","ORWOR1",45,0)
 I RET="OK" S RET=1 Q
"RTN","ORWOR1",46,0)
 I $E(RET,1,7)="-898020" S RET=$E(RET,2,99)
"RTN","ORWOR1",47,0)
 Q
"RTN","ORWOR1",48,0)
CHKDIG(REQ,ORDER)       ;Check if Digital Signature is required
"RTN","ORWOR1",49,0)
 N IFN,ACTION
"RTN","ORWOR1",50,0)
 S REQ=0,IFN=+ORDER,ACTION=$P(ORDER,";",2)
"RTN","ORWOR1",51,0)
 I +$P($G(^OR(100,+IFN,8,+ACTION,2)),U,5) S REQ=1
"RTN","ORWOR1",52,0)
 Q
"RTN","ORWOR1",53,0)
GETDTEXT(TEXT,ORDER)    ;Get External Text
"RTN","ORWOR1",54,0)
 N IFN,ACTION
"RTN","ORWOR1",55,0)
 S IFN=+ORDER,ACTION=$P(ORDER,";",2),I=0
"RTN","ORWOR1",56,0)
 F  S I=$O(^OR(100,+IFN,8,+ACTION,.2,I)) Q:'I  S TEXT(I)=^(I,0)
"RTN","ORWOR1",57,0)
 Q
"RTN","ORWOR1",58,0)
GETDSIG(SIG,ORDER)      ;Get Digital Signature
"RTN","ORWOR1",59,0)
 N IFN,ACTION
"RTN","ORWOR1",60,0)
 S SIG=0,IFN=+ORDER,ACTION=$P(ORDER,";",2)
"RTN","ORWOR1",61,0)
 I +$P($G(^OR(100,+IFN,8,+ACTION,2)),U,3) S SIG=$P(^(2),"^",3)
"RTN","ORWOR1",62,0)
 Q
"RTN","ORWOR1",63,0)
GETDEA(Y,ORUSER)        ;Get user DEA
"RTN","ORWOR1",64,0)
 S Y=$$DEA^XUSER(,$G(ORUSER))
"RTN","ORWOR1",65,0)
 Q
"RTN","ORWOR1",66,0)
GETDSCH(Y,ORDER)       ;Check if Drug Schedule
"RTN","ORWOR1",67,0)
 N IFN,ACTION
"RTN","ORWOR1",68,0)
 S IFN=+ORDER,ACTION=$P(ORDER,";",2)
"RTN","ORWOR1",69,0)
 S Y=$P($G(^OR(100,+IFN,8,+ACTION,2)),U,4)
"RTN","ORWOR1",70,0)
 Q
"RTN","ORWOR1",71,0)
SETDTEXT(Y,ORDER,ORDEA,ORSIGNER)        ;Set Digital Text data into file 100 & return the array
"RTN","ORWOR1",72,0)
 ;ORDER = ORIFN;ACTION
"RTN","ORWOR1",73,0)
 ;ORDEA = Schedule of Drug (2-5)
"RTN","ORWOR1",74,0)
 ;ORSIGNER = DUZ of signer
"RTN","ORWOR1",75,0)
 N ORSET,IFN,ACT,I
"RTN","ORWOR1",76,0)
 S Y="-1^Digital Text failed to build",IFN=+ORDER,ACT=$P(ORDER,";",2)
"RTN","ORWOR1",77,0)
 I '$G(ORDEA) Q
"RTN","ORWOR1",78,0)
 I '$G(ORSIGNER) S ORSIGNER=DUZ
"RTN","ORWOR1",79,0)
 D DIGTEXT^ORCSAVE1(IFN,ORDEA,ORSIGNER)
"RTN","ORWOR1",80,0)
 S Y=0
"RTN","ORWOR1",81,0)
 I '$G(ORSET) Q
"RTN","ORWOR1",82,0)
 K ^OR(100,IFN,8,ACT,.2)
"RTN","ORWOR1",83,0)
 F I=1:1:ORSET S (Y(I),^OR(100,IFN,8,ACT,.2,I,0))=ORSET(I)
"RTN","ORWOR1",84,0)
 S ^OR(100,IFN,8,ACT,.2,0)="^^"_ORSET_"^"_ORSET_"^"_DT_"^",Y=ORSET
"RTN","ORWOR1",85,0)
 Q
"RTN","ORWOR1",86,0)
GETDATA(Y,ORDER,DFN)    ;Get PKI Data
"RTN","ORWOR1",87,0)
 ;DBIA #3750
"RTN","ORWOR1",88,0)
 ;On error: Y = -1^Error message
"RTN","ORWOR1",89,0)
 ;Else: Y = 1^ Order # ^ Nature of order ^ Order Status ^ Date Signed
"RTN","ORWOR1",90,0)
 ;Y(1) = Patient name ^ Street1 ^ Street2 ^ Street3 ^ City ^ State ^ Zip
"RTN","ORWOR1",91,0)
 ;Y(2) = Drug name_strength_dosage form (Dispense drug) ^ Drug IEN (file 50) ^ Drug quantity prescribed ^ Schedule of medication ^ DEA Schedule
"RTN","ORWOR1",92,0)
 ;Y(3) = Directions for use (SIG)
"RTN","ORWOR1",93,0)
 ;Y(4) = Practitioner's name ^ DUZ ^ Practitioner's (DEA) registration number
"RTN","ORWOR1",94,0)
 ;Y(5) = SiteName ^ SiteStreet1  ^ SiteStreet2 ^ SiteCity  ^ SiteState ^ SiteZip
"RTN","ORWOR1",95,0)
 ;Y(6) = Orderable Item ^ Orderable Item IEN (file 101.43)
"RTN","ORWOR1",96,0)
 N X0,X1,X2,X3,X4,X5,X6,ORNAT,ORSTAT
"RTN","ORWOR1",97,0)
 I '$D(^OR(100,+$G(ORDER),0)) S Y="-1^INVALID ORDER #" Q
"RTN","ORWOR1",98,0)
 I $G(DFN)'=+$P(^OR(100,ORDER,0),"^",2) S Y="-1^INVALID PATIENT ID" Q
"RTN","ORWOR1",99,0)
 I '$D(^OR(100,ORDER,8,1,.2,0)) S Y="-1^MISSING DIGITAL SIGNATURE TEXT" Q
"RTN","ORWOR1",100,0)
 S X0=$G(^OR(100,ORDER,8,1,0))
"RTN","ORWOR1",101,0)
 I $P($G(^OR(100,ORDER,8,1,0)),"^",4)'=7 S Y="-1^ORDER HAS NOT BEEN DIGITALLY SIGNED" Q
"RTN","ORWOR1",102,0)
 S X1=$G(^OR(100,ORDER,8,1,.2,1,0))
"RTN","ORWOR1",103,0)
 I DFN'=$P(X1,"^",4) S Y="-1^PKI PATIENT ID DOES NOT MATCH DFN" Q
"RTN","ORWOR1",104,0)
 S ORNAT=$P(X0,"^",12),ORSTAT=$P($G(^OR(100,ORDER,3)),"^",3)
"RTN","ORWOR1",105,0)
 I ORNAT S ORNAT=$P($G(^ORD(100.02,ORNAT,0)),"^")
"RTN","ORWOR1",106,0)
 I ORSTAT S ORSTAT=ORSTAT_";"_$P(^ORD(100.01,ORSTAT,0),"^")
"RTN","ORWOR1",107,0)
 S Y="1^"_ORDER_"^"_ORNAT_"^"_ORSTAT_"^"_$P(X0,"^",6)
"RTN","ORWOR1",108,0)
 S X2=$G(^OR(100,ORDER,8,1,.2,2,0)),X3=$G(^OR(100,ORDER,8,1,.2,3,0)),X4=$G(^OR(100,ORDER,8,1,.2,4,0)),X5=$G(^OR(100,ORDER,8,1,.2,5,0)),X6=$G(^OR(100,ORDER,8,1,.2,6,0))
"RTN","ORWOR1",109,0)
 S X3=$$VALUE^ORX8(ORDER,"DRUG",,"E")_"^"_$$VALUE^ORX8(ORDER,"DRUG",,"I")_"^"_$P(X3,"^",3,99)
"RTN","ORWOR1",110,0)
 S Y(1)=$P(X1,"^",2)_"^"_X2
"RTN","ORWOR1",111,0)
 S Y(2)=X3,Y(3)=X4,Y(4)=X5,Y(5)=X6
"RTN","ORWOR1",112,0)
 S Y(6)=$$VALUE^ORX8(ORDER,"ORDERABLE",,"E")_"^"_$$VALUE^ORX8(ORDER,"ORDERABLE",,"I")
"RTN","ORWOR1",113,0)
 Q
"RTN","ORWORR")
0^2^B61684915
"RTN","ORWORR",1,0)
ORWORR ; SLC/KCM/JLI - Retrieve Orders for Broker ;2/5/03 3PM
"RTN","ORWORR",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,92,116,110,132,141,163**;Dec 17, 1997
"RTN","ORWORR",3,0)
 ;
"RTN","ORWORR",4,0)
GET(LST,DFN,FILTER,GROUPS) ; procedure
"RTN","ORWORR",5,0)
 Q  ; don't call until using same treating specialty logic as AGET
"RTN","ORWORR",6,0)
 ;    also until MULT, ORWARD, & ORIGVIEW implemented
"RTN","ORWORR",7,0)
 ;    also until the date ranges are implemented
"RTN","ORWORR",8,0)
 ; Get orders for a patient
"RTN","ORWORR",9,0)
 ;        1   2    3     4      5     6   7   8   9   10     11    12    13    14     15     16 17    18
"RTN","ORWORR",10,0)
 ; .LST=~IFN^Grp^ActTm^StrtTm^StopTm^Sts^Sig^Nrs^Clk^PrvID^PrvNam^ActDA^Flag^DCType^ChrtRev^DEA#^^Schedule
"RTN","ORWORR",11,0)
 ; .LST=tOrder Text (repeating as necessary)
"RTN","ORWORR",12,0)
 ;     DFN=Patient ID
"RTN","ORWORR",13,0)
 ;  FILTER=number indicates which orders to return, default=2 (current)
"RTN","ORWORR",14,0)
 ;  GROUPS=display group of orders to show (default=ALL)
"RTN","ORWORR",15,0)
 ; -- this section uses ORQ1 to get the orders list rather than XGET --
"RTN","ORWORR",16,0)
 N ORLIST,ORIFN,X0,X3,X8,IDX,IFN,ACT,PRV,LN,TXT,STRT,STOP,CSTS,EYE,DEA ;PKI
"RTN","ORWORR",17,0)
 K ^TMP("ORR",$J)
"RTN","ORWORR",18,0)
 S (IDX,LST)=0 S:'$D(GROUPS) GROUPS=1 S:'$D(FILTER) FILTER=2
"RTN","ORWORR",19,0)
 D EN^ORQ1(DFN_";DPT(",GROUPS,FILTER,"","","",0,1)
"RTN","ORWORR",20,0)
 S EYE=0 F  S EYE=$O(^TMP("ORR",$J,ORLIST,EYE)) Q:'EYE  S IFN=^(EYE) D
"RTN","ORWORR",21,0)
 . S ACT=$P(IFN,";",2),IFN=+IFN,X0=^OR(100,IFN,0),X3=^(3),X8=^(8,ACT,0)
"RTN","ORWORR",22,0)
 . D GETFLDS
"RTN","ORWORR",23,0)
 K ^TMP("ORR",$J)
"RTN","ORWORR",24,0)
 G EXIT
"RTN","ORWORR",25,0)
AGET(REF,DFN,FILTER,GROUPS,DTFROM,DTTHRU,EVENT) ;Get an abbreviated event delayed order list for a patient 
"RTN","ORWORR",26,0)
 ; returns ^TMP("ORR",$J,ORLIST,n)=IFN^DGrp^ActTm
"RTN","ORWORR",27,0)
 ; see above for input parameters
"RTN","ORWORR",28,0)
 ; -- from ORWORR
"RTN","ORWORR",29,0)
 ; -- this section uses ORQ1 to get the orders list rather than XGET --
"RTN","ORWORR",30,0)
 N ORLIST,ORIFN,IFN,I,ORWTS,TOT,MULT,ORWARD,TXTVW,ORYD,PTEVTID,EVTNAME
"RTN","ORWORR",31,0)
 S (PTEVTID,EVTNAME)=""
"RTN","ORWORR",32,0)
 K ^TMP("ORR",$J),^TMP("ORRJD",$J)
"RTN","ORWORR",33,0)
 S:'$D(GROUPS) GROUPS=1 S:'$D(FILTER) FILTER=2
"RTN","ORWORR",34,0)
 S ORWTS=+$P(FILTER,U,2),FILTER=+FILTER
"RTN","ORWORR",35,0)
 S MULT=$S("^1^6^8^9^10^11^13^14^20^22^"[(U_FILTER_U):1,1:0)
"RTN","ORWORR",36,0)
 I $L($G(^DPT(DFN,.1))) S ORWARD=1 ; should normally be ptr to 42
"RTN","ORWORR",37,0)
 S:'$L($G(DTFROM)) DTFROM=0
"RTN","ORWORR",38,0)
 S:'$L($G(DTTHRU)) DTTHRU=0
"RTN","ORWORR",39,0)
 S:'$L($G(EVENT)) EVENT=0
"RTN","ORWORR",40,0)
 I $G(EVTDCREL)="TRUE" D
"RTN","ORWORR",41,0)
 . D EN^ORQ1(DFN_";DPT(",GROUPS,FILTER,"",DTFROM,DTTHRU,2,MULT,"","",EVENT)
"RTN","ORWORR",42,0)
 . D GET2^ORWORR1
"RTN","ORWORR",43,0)
 E  D
"RTN","ORWORR",44,0)
 . D EN^ORQ1(DFN_";DPT(",GROUPS,FILTER,"",DTFROM,DTTHRU,0,MULT,"","",EVENT)
"RTN","ORWORR",45,0)
 . D GET1^ORWORR1
"RTN","ORWORR",46,0)
 Q
"RTN","ORWORR",47,0)
RGET(REF,DFN,FILTER,GROUPS,DTFROM,DTTHRU,EVENT) ;Orders of AutoDC/Release Event
"RTN","ORWORR",48,0)
 N EVTDCREL
"RTN","ORWORR",49,0)
 S EVTDCREL="TRUE"
"RTN","ORWORR",50,0)
 D AGET(.REF,DFN,FILTER,GROUPS,DTFROM,DTTHRU,EVENT)
"RTN","ORWORR",51,0)
 Q
"RTN","ORWORR",52,0)
XGET ; -- this was the retrieval algorithm before all the AC xref changes
"RTN","ORWORR",53,0)
 N X,X0,X3,IDX,IFN,LN,TIME,DGRP,MASK,TXT,ACT,PRV,ID,DEA,PASS ;PKI
"RTN","ORWORR",54,0)
 S DFN=DFN_";DPT(",IDX=0,LST=0
"RTN","ORWORR",55,0)
 I '$G(FILTER) S FILTER=2                    ; Default: Current/Active
"RTN","ORWORR",56,0)
 I $D(GROUPS)=1 D
"RTN","ORWORR",57,0)
 . S:'GROUPS GROUPS=$O(^ORD(100.98,"B",GROUPS,0))
"RTN","ORWORR",58,0)
 . D XPND(GROUPS)
"RTN","ORWORR",59,0)
 I FILTER=1  D DOALL G EXIT                  ; All
"RTN","ORWORR",60,0)
 I FILTER=2  D DOCUR G EXIT                  ; Current
"RTN","ORWORR",61,0)
 I FILTER=3  S PASS=";1;"                    ; Discontinued
"RTN","ORWORR",62,0)
 I FILTER=4  S PASS=";2;7;"                  ; Comp/Expired
"RTN","ORWORR",63,0)
 I FILTER=5  S PASS=";3;4;5;6;8;9;"          ; Expiring
"RTN","ORWORR",64,0)
 I FILTER=6  S PASS=";1;2;3;4;5;6;7;8;9;11;" ; New Activity
"RTN","ORWORR",65,0)
 I FILTER=7  S PASS=";5;"                    ; Pending
"RTN","ORWORR",66,0)
 I FILTER=8  Q                               ; Expanded
"RTN","ORWORR",67,0)
 I FILTER=9  S PASS=";3;4;5;6;8;9;11;"       ; Unverified by Nurse
"RTN","ORWORR",68,0)
 I FILTER=10 S PASS=";3;4;5;6;8;9;11;"       ; Unverified by Clerk
"RTN","ORWORR",69,0)
 I FILTER=11 S PASS=";3;4;5;6;7;8;11;"       ; Unsigned
"RTN","ORWORR",70,0)
 I FILTER=12 S PASS=";4;"                    ; Flagged
"RTN","ORWORR",71,0)
 I FILTER=13 S PASS=""                       ; Verbal/Phone
"RTN","ORWORR",72,0)
 I FILTER=14 S PASS=""                       ; Verbal/Phone Unsigned
"RTN","ORWORR",73,0)
 D DOGET
"RTN","ORWORR",74,0)
EXIT I LST=0 D
"RTN","ORWORR",75,0)
 . N %,X,%I D NOW^%DTC
"RTN","ORWORR",76,0)
 . S LST(1)="~0^0^"_%_"^^^97",LST(2)="tNo Orders Found."
"RTN","ORWORR",77,0)
 Q
"RTN","ORWORR",78,0)
DOGET ; Come here if need to filter the orders 
"RTN","ORWORR",79,0)
 S TIME=0 F  S TIME=$O(^OR(100,"AO",DFN,TIME)) Q:'TIME  D
"RTN","ORWORR",80,0)
 . S DGRP=0 F  S DGRP=$O(^OR(100,"AO",DFN,TIME,DGRP)) Q:'DGRP  D
"RTN","ORWORR",81,0)
 . . I $D(GROUPS)>1 Q:'$D(GROUPS(DGRP))           ;filter by display grp
"RTN","ORWORR",82,0)
 . . S IFN=0 F  S IFN=$O(^OR(100,"AO",DFN,TIME,DGRP,IFN)) Q:'IFN  D
"RTN","ORWORR",83,0)
 . . . S X0=^OR(100,IFN,0),X3=^(3)                ;get main nodes
"RTN","ORWORR",84,0)
 . . . I $P(X3,U,8)!$P(X3,U,9)!($P(X3,U,3)=99) Q  ;skip veil,chld,sts=99
"RTN","ORWORR",85,0)
 . . . I $L(PASS),(PASS'[(";"_$P(X3,U,3)_";")) Q  ;filter by status
"RTN","ORWORR",86,0)
 . . . ; do any other filtering
"RTN","ORWORR",87,0)
 . . . D GETFLDS
"RTN","ORWORR",88,0)
 Q
"RTN","ORWORR",89,0)
DOALL ; Come here if retrieve all orders (no filter by status)
"RTN","ORWORR",90,0)
 S TIME=0 F  S TIME=$O(^OR(100,"AO",DFN,TIME)) Q:'TIME  D
"RTN","ORWORR",91,0)
 . S DGRP=0 F  S DGRP=$O(^OR(100,"AO",DFN,TIME,DGRP)) Q:'DGRP  D
"RTN","ORWORR",92,0)
 . . I $D(GROUPS)>1 Q:'$D(GROUPS(DGRP))           ;filter by display grp
"RTN","ORWORR",93,0)
 . . S IFN=0 F  S IFN=$O(^OR(100,"AO",DFN,TIME,DGRP,IFN)) Q:'IFN  D
"RTN","ORWORR",94,0)
 . . . S X0=^OR(100,IFN,0),X3=^(3)                ;get main nodes
"RTN","ORWORR",95,0)
 . . . I $P(X3,U,8)!$P(X3,U,9)!($P(X3,U,3)=99) Q  ;skip veil,chld,sts=99
"RTN","ORWORR",96,0)
 . . . D GETFLDS
"RTN","ORWORR",97,0)
 Q
"RTN","ORWORR",98,0)
DOCUR ; Come here to retrieve all current orders
"RTN","ORWORR",99,0)
 N AOCTXT,STS,STOP,%
"RTN","ORWORR",100,0)
 S X=-$$GET^XPAR("ALL","ORPF ACTIVE ORDERS CONTEXT HRS")
"RTN","ORWORR",101,0)
 S %H=$H,X=(%H*86400+$P(%H,",",2))+(X*3600),%H=(X\86400)_","_(X#86400)
"RTN","ORWORR",102,0)
 D YMD^%DTC S AOCTXT=X_%
"RTN","ORWORR",103,0)
 S MASK="110000100101110"   ; mask out STS=1,2,7,10,12,13,14
"RTN","ORWORR",104,0)
 S TIME=0 F  S TIME=$O(^OR(100,"AC",DFN,TIME)) Q:'TIME  D
"RTN","ORWORR",105,0)
 . S IFN=0 F  S IFN=$O(^OR(100,"AC",DFN,TIME,IFN)) Q:'IFN  D
"RTN","ORWORR",106,0)
 . . ; filter out display groups here
"RTN","ORWORR",107,0)
 . . S ACT=0 F  S ACT=$O(^OR(100,"AC",DFN,TIME,IFN,ACT)) Q:'ACT  D
"RTN","ORWORR",108,0)
 . . . S X0=^OR(100,IFN,0),X3=^(3),X8=^(8,ACT,0)
"RTN","ORWORR",109,0)
 . . . S STS=$P(X3,U,3),STOP=$P(X0,U,9)
"RTN","ORWORR",110,0)
 . . . I $P(X3,U,8)!$P(X3,U,9)!(STS=99) Q
"RTN","ORWORR",111,0)
 . . . I $P(X8,U,15)=13,($P(X8,U)<AOCTXT) D ACKILL Q
"RTN","ORWORR",112,0)
 . . . I $P(X8,U,15)=13!($P(X8,U,15)=""),("RN^XX"[$P(X8,U,2)) D ACKILL Q
"RTN","ORWORR",113,0)
 . . . I $E(MASK,STS),STOP<AOCTXT D ACKILL Q
"RTN","ORWORR",114,0)
 . . . D GETFLDS
"RTN","ORWORR",115,0)
 Q
"RTN","ORWORR",116,0)
ACKILL ; called only from DOCUR - kill AC xref
"RTN","ORWORR",117,0)
 ; K ^OR(100,"AC",DFN,TIME,IFN,ACT)  ; let ORQ1 kill if for now
"RTN","ORWORR",118,0)
 Q
"RTN","ORWORR",119,0)
GET4V11(LST,TXTVW,ORYD,IFNLST) ; get the order fields TEMPORARY
"RTN","ORWORR",120,0)
 G GET41
"RTN","ORWORR",121,0)
GET4LST(LST,IFNLST)     ; get the order fields for a list of orders
"RTN","ORWORR",122,0)
GET41 N ACT,ACTID,IDX,X0,X3,X8,PRV,ID,LN,TXT,STRT,STOP,CSTS,IFN,IFNIDX,ORIGVIEW,DEA ;PKI
"RTN","ORWORR",123,0)
 S (IDX,LST,IFNIDX)=0
"RTN","ORWORR",124,0)
 F  S IFNIDX=$O(IFNLST(IFNIDX)) Q:'IFNIDX  S IFN=IFNLST(IFNIDX) D
"RTN","ORWORR",125,0)
 . S ACT=$S($P(IFN,";",2):$P(IFN,";",2),1:1),IFN=+IFN
"RTN","ORWORR",126,0)
 . S X0=$G(^OR(100,IFN,0)),X3=$G(^(3)),X8=$G(^(8,ACT,0))
"RTN","ORWORR",127,0)
 . D GETFLDS
"RTN","ORWORR",128,0)
 Q
"RTN","ORWORR",129,0)
GETBYIFN(LST,IFN) ; procedure
"RTN","ORWORR",130,0)
 ; get the fields for a single order
"RTN","ORWORR",131,0)
 ; .LST(n)=as described above in GET
"RTN","ORWORR",132,0)
 ;     IFN=internal entry number for order
"RTN","ORWORR",133,0)
 I 'IFN Q
"RTN","ORWORR",134,0)
 N ACT,IDX,X0,X3,X8,PRV,ID,LN,TXT,STRT,STOP,CSTS,ACTID,ORIGVIEW,ORYD,TXTVW,DEA ;PKI
"RTN","ORWORR",135,0)
 S IDX=0,LST=0,ORYD=0
"RTN","ORWORR",136,0)
 S X0=$G(^OR(100,+IFN,0)),X3=$G(^(3))
"RTN","ORWORR",137,0)
 S ACT=$S($P(IFN,";",2):$P(IFN,";",2),$P(X3,U,7):$P(X3,U,7),1:1)
"RTN","ORWORR",138,0)
 S IFN=+IFN,X8=$G(^OR(100,IFN,8,ACT,0))
"RTN","ORWORR",139,0)
GETFLDS ; used by entry points to place order fields into list
"RTN","ORWORR",140,0)
 ; expects IDX=sequence #, IFN=order, X0=node 0, X3=node 3, LST=results
"RTN","ORWORR",141,0)
 ; LST(IDX)=~IFN^Grp^OrdTm^StrtTm^StopTm^Sts^Sig^Nrs^Clk^PrvID^PrvNam^Act^Flagged[^DCType]^ChartRev^DEA#^^DigSig
"RTN","ORWORR",142,0)
 S PRV=$P(X8,U,5) S:'PRV PRV=$P(X8,U,3) S PRV=PRV_U
"RTN","ORWORR",143,0)
 I PRV S PRV=PRV_$P(^VA(200,+PRV,0),U)
"RTN","ORWORR",144,0)
 S DEA=$$DEA^XUSER(,+PRV) ; get user DEA info - PKI
"RTN","ORWORR",145,0)
 S IDX=IDX+1,LST=LST+1,ID=IFN_";"_ACT,ACTID=$P(X8,U,2)
"RTN","ORWORR",146,0)
 S CSTS=$S($P(X8,U,15):$P(X8,U,15),1:$P(X3,U,3))
"RTN","ORWORR",147,0)
 I $P(X8,U,15)=10,$P(X3,U,3)=14 S CSTS=14 ;delayed-lapsed order
"RTN","ORWORR",148,0)
 S STRT=$S($P(X3,U,3)=11:$$RSTRT,ACTID="NW"!(ACTID="XX")!(ACTID="RL"):$P(X0,U,8),ACTID="DC":"",1:$P(X8,U)) ;110
"RTN","ORWORR",149,0)
 S STOP=$S($P(X3,U,3)=11:$$RSTOP,ACTID="HD":$P($G(^OR(100,+IFN,8,ACT,2)),U),1:$P(X0,U,9))
"RTN","ORWORR",150,0)
 S LST(IDX)="~"_ID_U_$P(X0,U,11)_U_$P(X8,U)_U_STRT_U_STOP_U_CSTS_U_$P(X8,U,4)_U_$P(X8,U,8)_U_$P(X8,U,10)_U_PRV
"RTN","ORWORR",151,0)
 S $P(LST(IDX),U,13)=+$G(^OR(100,IFN,8,ACT,3))    ; flagged
"RTN","ORWORR",152,0)
 I +$P(X8,U,8) S $P(LST(IDX),U,8)=$$INITIALS^ORCHTAB2(+$P(X8,U,8))    ;nurse
"RTN","ORWORR",153,0)
 I +$P(X8,U,10) S $P(LST(IDX),U,9)=$$INITIALS^ORCHTAB2(+$P(X8,U,10))  ;clerk
"RTN","ORWORR",154,0)
 I +$P(X8,U,18) S $P(LST(IDX),U,15)=$$INITIALS^ORCHTAB2(+$P(X8,U,18)) ;chart review
"RTN","ORWORR",155,0)
 I $L($G(DEA)) S $P(LST(IDX),U,16)=DEA ;PKI
"RTN","ORWORR",156,0)
 I $P($G(^OR(100,IFN,8,ACT,2)),"^",5) S $P(LST(IDX),U,18)=$P(^(2),"^",4)
"RTN","ORWORR",157,0)
 I '$P($G(^OR(100,IFN,8,ACT,2)),"^",5),$P(X0,"^",5) D  ;Copy orders PKI fix
"RTN","ORWORR",158,0)
 . N OI,ORVP,ORCAT,PKG
"RTN","ORWORR",159,0)
 . S OI=+$O(^OR(100,IFN,4.5,"ID","ORDERABLE",0)),OI=+$G(^OR(100,IFN,4.5,OI,1)) Q:'OI
"RTN","ORWORR",160,0)
 . S ORVP=$P(X0,"^",2),PKG=$P(X0,"^",14)
"RTN","ORWORR",161,0)
 . S ORCAT=$S($L($P($G(^DPT(+ORVP,.1)),U)):"I",1:"O")
"RTN","ORWORR",162,0)
 . I PKG'=$O(^DIC(9.4,"B","OUTPATIENT PHARMACY",0)) Q
"RTN","ORWORR",163,0)
 . D PKI^ORWDPS1(.ORY,OI,ORCAT,+ORVP,$$GET^XPAR("ALL^USR.`"_DUZ,"ORWOR PKI USE",1,"Q"))
"RTN","ORWORR",164,0)
 . I $E($G(ORY))=2 S $P(LST(IDX),U,18)=ORY
"RTN","ORWORR",165,0)
 S ORIGVIEW=$S($G(TXTVW)=0:0,$G(TXTVW)=1:1,ORYD=-1:1,'ORYD:1,$P(X8,U)'<ORYD:0,1:1)
"RTN","ORWORR",166,0)
 K TXT D TEXT^ORQ12(.TXT,ID,255)                  ; optimize this later
"RTN","ORWORR",167,0)
 I $O(^OR(100,+IFN,2,0)) S LN=$O(TXT(0)),TXT(LN)="+"_TXT(LN)
"RTN","ORWORR",168,0)
 I $O(^OR(100,+IFN,8,"C","XX",0)) S LN=$O(TXT(0)),TXT(LN)="*"_TXT(LN)
"RTN","ORWORR",169,0)
 S LN=0 F  S LN=$O(TXT(LN)) Q:'LN  S IDX=IDX+1,LST(IDX)="t"_TXT(LN)
"RTN","ORWORR",170,0)
 I $O(^OR(100,+IFN,8,1,.2,0)) S IDX=IDX+1,LST(IDX)="|" D  ;PKI XMLText
"RTN","ORWORR",171,0)
 . S I=0 F  S I=$O(^OR(100,+IFN,8,1,.2,I)) Q:'I  S IDX=IDX+1,LST(IDX)="x"_^(I,0)
"RTN","ORWORR",172,0)
 Q
"RTN","ORWORR",173,0)
RSTRT() ; return start date from responses
"RTN","ORWORR",174,0)
 Q $G(^OR(100,IFN,4.5,+$O(^OR(100,IFN,4.5,"ID","START",0)),1))
"RTN","ORWORR",175,0)
RSTOP() ; return stop date from responses
"RTN","ORWORR",176,0)
 Q $G(^OR(100,IFN,4.5,+$O(^OR(100,IFN,4.5,"ID","STOP",0)),1))
"RTN","ORWORR",177,0)
GETTXT(LST,IFN)     ; get the text of an order
"RTN","ORWORR",178,0)
 I $L(IFN,";")=1 S IFN=IFN_";1"
"RTN","ORWORR",179,0)
 D TEXT^ORQ12(.LST,IFN,255)
"RTN","ORWORR",180,0)
 Q
"RTN","ORWORR",181,0)
XPND(AGRP) ; procedure
"RTN","ORWORR",182,0)
 ; Expand a display group (GROUPS must be defined outside of call)
"RTN","ORWORR",183,0)
 N I,CHLD
"RTN","ORWORR",184,0)
 S GROUPS(AGRP)=^ORD(100.98,AGRP,0),I=0
"RTN","ORWORR",185,0)
 F  S I=$O(^ORD(100.98,AGRP,1,I)) Q:'I  S CHLD=$P(^(I,0),U) D XPND(CHLD)
"RTN","ORWORR",186,0)
 Q
"RTN","ORWORR",187,0)
GETPKG(Y,IFN) ; get package for an order
"RTN","ORWORR",188,0)
 N ORDERID,PKGID
"RTN","ORWORR",189,0)
 Q:+IFN<1
"RTN","ORWORR",190,0)
 S ORDERID=+IFN,Y=""
"RTN","ORWORR",191,0)
 S PKGID=$P(OR(100,ORDERID,0),U,14)
"RTN","ORWORR",192,0)
 S:PKGID>0 Y=$P(^DIC(9.4,PKGID,0),U,2)
"RTN","ORWORR",193,0)
 Q
"RTN","ORX8")
0^4^B13883123
"RTN","ORX8",1,0)
ORX8 ; slc/dcm,MKB - OE/RR Orders file extracts ; 08 May 2002  2:12 PM
"RTN","ORX8",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**13,21,48,68,92,141,163**;Dec 17, 1997
"RTN","ORX8",3,0)
 ;
"RTN","ORX8",4,0)
EN(ORIFN) ;Returns data from file 100 in the ORUPCHUK array [DBIA#871]
"RTN","ORX8",5,0)
 Q:'$D(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))  K ORUPCHUK
"RTN","ORX8",6,0)
 D A
"RTN","ORX8",7,0)
 K ORTX,X0,X3,%X,%Y,J,ORINDX,X
"RTN","ORX8",8,0)
 Q
"RTN","ORX8",9,0)
A S X0=^OR(100,ORIFN,0),X3=^(3),ORUPCHUK("ORPK")=$S($D(^(4)):^(4),1:"")
"RTN","ORX8",10,0)
 S ORUPCHUK("ORVP")=$P(X0,"^",2),ORUPCHUK("ORPCL")=$P(X0,"^",5),X=$P(X0,"^",6),ORUPCHUK("ORDUZ")=X_"^"_$S($D(^VA(200,+X,0)):$P(^(0),"^"),1:""),ORUPCHUK("ORODT")=$P(X0,"^",7),ORUPCHUK("ORSTOP")=$P(X0,"^",9),ORUPCHUK("ORL")=$P(X0,"^",10)
"RTN","ORX8",11,0)
 S X=$P(X0,"^",11),ORUPCHUK("ORTO")=X_"^"_$S($D(^ORD(100.98,+X,0)):$P(^(0),"^"),1:"")
"RTN","ORX8",12,0)
 S X=$P(X3,"^",3),ORUPCHUK("ORSTS")=X_"^"_$P(^ORD(100.01,X,0),"^"),ORUPCHUK("ORSTRT")=$P(X0,"^",8),X=$P(X0,"^",4),(ORUPCHUK("ORNP"),ORUPCHUK("ORPV"))=X_"^"_$S(X:$S($D(^VA(200,+X,0)):$P(^(0),"^"),1:""),1:"")
"RTN","ORX8",13,0)
 D TEXT^ORQ12(.ORTX,ORIFN,$G(ORLENGTH))
"RTN","ORX8",14,0)
 I $O(ORTX(0)) S %X="ORTX(",%Y="ORUPCHUK(""ORTX""," D %XY^%RCR
"RTN","ORX8",15,0)
 Q
"RTN","ORX8",16,0)
 ;
"RTN","ORX8",17,0)
VALUE(IFN,ID,INST,FORMAT) ; -- Returns value of prompt by ID
"RTN","ORX8",18,0)
 I '$G(IFN)!('$D(^OR(100,+$G(IFN),0)))!($G(ID)="") Q ""
"RTN","ORX8",19,0)
 N I,Y S I=0,Y="" S:'$G(INST) INST=1
"RTN","ORX8",20,0)
 F  S I=$O(^OR(100,+IFN,4.5,"ID",ID,I)) Q:I'>0  I $P($G(^OR(100,+IFN,4.5,+I,0)),U,3)=INST S PRMT=+$P(^(0),U,2),Y=$G(^(1)) Q
"RTN","ORX8",21,0)
 I $L(Y),$G(PRMT),$G(FORMAT)="E" D  ; get external form of Y
"RTN","ORX8",22,0)
 . N ORDIALOG S ORDIALOG(PRMT,0)=$G(^ORD(101.41,PRMT,1))
"RTN","ORX8",23,0)
 . S ORDIALOG(PRMT,1)=Y,Y=$$EXT^ORCD(PRMT,1)
"RTN","ORX8",24,0)
 Q Y
"RTN","ORX8",25,0)
 ;
"RTN","ORX8",26,0)
OI(IFN) ; -- Returns [first] orderable item for order IFN in the format
"RTN","ORX8",27,0)
 ;    ifn ^ name ^ pkg id   [DBIA#2467]
"RTN","ORX8",28,0)
 I '$G(IFN)!('$D(^OR(100,+$G(IFN),0))) Q ""
"RTN","ORX8",29,0)
 N I,X,Y S I=$O(^OR(100,+IFN,.1,0)),X=$G(^(+I,0)),Y=""
"RTN","ORX8",30,0)
 I X,$D(^ORD(101.43,+X,0)) S Y=+X_U_$P(^(0),U,1,2)
"RTN","ORX8",31,0)
 Q Y
"RTN","ORX8",32,0)
 ;
"RTN","ORX8",33,0)
LATEST(ORPAT,ORIT,ORY) ; -- Return most recent orders for ORPAT,ORIT as
"RTN","ORX8",34,0)
 ;        ORY = total number of orders found (or 0 if none found)
"RTN","ORX8",35,0)
 ; ORY(ORSTS) = ORIFN ^ Ord'd By ^ Entered ^ StartDt ^ StopDt ^ Loc ^ Sts
"RTN","ORX8",36,0)
 ; where ORSTS is the ien in the Order Status file #100.01  [DBIA#2842]
"RTN","ORX8",37,0)
 ;
"RTN","ORX8",38,0)
 N ORVP,ORIDT,ORIFN,OR0,OR3,ORSTS,ORSTSNM
"RTN","ORX8",39,0)
 S ORVP=+ORPAT_";DPT(",ORY=0 Q:'$G(ORPAT)  Q:'$G(ORIT)  ;invalid input
"RTN","ORX8",40,0)
 S ORIDT=0 F  S ORIDT=$O(^OR(100,"AOI",+ORIT,ORVP,ORIDT)) Q:ORIDT'>0  D
"RTN","ORX8",41,0)
 . S ORIFN=0 F  S ORIFN=$O(^OR(100,"AOI",+ORIT,ORVP,ORIDT,ORIFN)) Q:ORIFN'>0  D
"RTN","ORX8",42,0)
 .. S OR0=$G(^OR(100,+ORIFN,0)),OR3=$G(^(3)),ORSTS=+$P(OR3,U,3)
"RTN","ORX8",43,0)
 .. Q:ORSTS'>0  Q:$G(ORY(ORSTS))  ;return only latest order per status
"RTN","ORX8",44,0)
 .. S ORSTSNM=$$LOW^XLFSTR($P($G(^ORD(100.01,ORSTS,0)),U))
"RTN","ORX8",45,0)
 .. S ORY=ORY+1,ORY(ORSTS)=ORIFN_U_$P(OR0,U,4)_U_$P(OR0,U,7,10)_U_ORSTSNM
"RTN","ORX8",46,0)
 Q
"RTN","ORX8",47,0)
 ;
"RTN","ORX8",48,0)
DELAYED(ORY,ORDER) ; -- Return delayed order(s) with same OrdItem as ORDER
"RTN","ORX8",49,0)
 ;    in ORY(ORIFN) = PatEventPtr ^ EventName
"RTN","ORX8",50,0)
 ;
"RTN","ORX8",51,0)
 N ORI,ORIT,ORIFN S (ORY,ORI)=0
"RTN","ORX8",52,0)
 F  S ORI=$O(^OR(100,+ORDER,.1,ORI)) Q:ORI'>0  S ORIT=+$G(^(ORI,0)) D
"RTN","ORX8",53,0)
 . S EVT=0 F  S EVT=$O(^ORE(100.2,"AE",+ORVP,EVT)) Q:EVT<1  S PTEVT=+$O(^(EVT,0)) D  ;pending events
"RTN","ORX8",54,0)
 .. S ORIFN=0 F  S ORIFN=+$O(^OR(100,"AEVNT",ORVP,PTEVT,ORIFN)) Q:ORIFN<1  D  ;delayed orders
"RTN","ORX8",55,0)
 ... Q:ORIFN=+ORDER  Q:'$D(^OR(100,ORIFN,.1,"B",ORIT))
"RTN","ORX8",56,0)
 ... Q:"^1^2^7^12^13^14^"[(U_$P($G(^OR(100,ORIFN,3)),U,3)_U)  ;terminated
"RTN","ORX8",57,0)
 ... S ORY=ORY+1,ORY(ORIFN)=PTEVT_U_$P($G(^ORD(100.5,EVT,0)),U)
"RTN","ORX8",58,0)
 Q
"RTN","ORX8",59,0)
 ;
"RTN","ORX8",60,0)
PKGID(ORIFN) ; -- Return package identifier for order ORIFN  [DBIA#3071]
"RTN","ORX8",61,0)
 Q $G(^OR(100,+$G(ORIFN),4))
"RTN","ORX8",62,0)
 ;
"RTN","ORX8",63,0)
ES(ORDER) ; -- Returns the signature status of ORDER [DBIA#3632]
"RTN","ORX8",64,0)
 ;  -1 = invalid order#
"RTN","ORX8",65,0)
 ;  "" = no signature required
"RTN","ORX8",66,0)
 ;   0 = not signed (needs ES)
"RTN","ORX8",67,0)
 ;   1 = electronically or digitally signed
"RTN","ORX8",68,0)
 ;   2 = signed on chart
"RTN","ORX8",69,0)
 ;   3 = corrected or canceled order
"RTN","ORX8",70,0)
 N X,Y,DA I '$G(ORDER)!'$D(^OR(100,+$G(ORDER),0)) Q -1
"RTN","ORX8",71,0)
 S DA=+$P(ORDER,";",2) S:DA<1 DA=+$P($G(^OR(100,+ORDER,3)),U,7)
"RTN","ORX8",72,0)
 S X=$P($G(^OR(100,+ORDER,8,DA,0)),U,4)
"RTN","ORX8",73,0)
 S Y=$S(X=2:0,X=1!(X=7):1,X=0!(X=4):2,X=5!(X=6):3,1:"")
"RTN","ORX8",74,0)
 Q Y
"RTN","ORX8",75,0)
 ;
"RTN","ORX8",76,0)
AND(DAD) ; -- Return 1 or 0, if all conjunctions are AND [DBIA#3632]
"RTN","ORX8",77,0)
 N I,Y S I=0,Y=1
"RTN","ORX8",78,0)
 F  S I=+$O(^OR(100,+$G(DAD),4.5,"ID","CONJ",I)) Q:I<1  I $E($G(^OR(100,+$G(DAD),4.5,I,1)))'="A" S Y=0 Q
"RTN","ORX8",79,0)
 Q Y
"RTN","ORY163")
0^5^B1345938
"RTN","ORY163",1,0)
ORY163 ; slc/dcm - postinit for OR*3*160 ;02/13/03  12:17
"RTN","ORY163",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**163**;Dec 17, 1997
"RTN","ORY163",3,0)
 ;
"RTN","ORY163",4,0)
 Q
"RTN","ORY163",5,0)
 I '$L($$GET1^DIQ(4,+$$SITE^VASITE_",",52)) S XPDQUIT=2 D
"RTN","ORY163",6,0)
 . W !,"Before installing this patch, you need to add the Facility DEA#"
"RTN","ORY163",7,0)
 . W !,"for your institution in the INSTITUTION file (#4).  You should"
"RTN","ORY163",8,0)
 . W !,"be able to get the Facility DEA# from the Pharmacy or Pharmacy Chief."
"RTN","ORY163",9,0)
 . W !,"See the patch description for detailed instructions on how to enter"
"RTN","ORY163",10,0)
 . W !,"the Facility DEA#."
"RTN","ORY163",11,0)
 Q
"RTN","ORY163",12,0)
 ;
"RTN","ORY163",13,0)
PRE ; -- preinit
"RTN","ORY163",14,0)
 Q
"RTN","ORY163",15,0)
POST ; -- postinit
"RTN","ORY163",16,0)
 Q
"VER")
8.0^22.0
**END**
**END**
