Released FB*3.5*70 SEQ #70
Extracted from mail message
**KIDS**:FB*3.5*70^

**INSTALL NAME**
FB*3.5*70
"BLD",4748,0)
FB*3.5*70^FEE BASIS^0^3040607^y
"BLD",4748,1,0)
^^1^1^3040607^
"BLD",4748,1,1,0)
HIPAA CC PHASE III
"BLD",4748,4,0)
^9.64PA^^
"BLD",4748,"KRN",0)
^9.67PA^8989.52^19
"BLD",4748,"KRN",.4,0)
.4
"BLD",4748,"KRN",.401,0)
.401
"BLD",4748,"KRN",.402,0)
.402
"BLD",4748,"KRN",.403,0)
.403
"BLD",4748,"KRN",.5,0)
.5
"BLD",4748,"KRN",.84,0)
.84
"BLD",4748,"KRN",3.6,0)
3.6
"BLD",4748,"KRN",3.8,0)
3.8
"BLD",4748,"KRN",9.2,0)
9.2
"BLD",4748,"KRN",9.8,0)
9.8
"BLD",4748,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",4748,"KRN",9.8,"NM",1,0)
FBAAV4^^0^B34466423
"BLD",4748,"KRN",9.8,"NM",2,0)
FBAACO0^^0^B32636065
"BLD",4748,"KRN",9.8,"NM",3,0)
FBPATDAT^^0^B15288924
"BLD",4748,"KRN",9.8,"NM","B","FBAACO0",2)

"BLD",4748,"KRN",9.8,"NM","B","FBAAV4",1)

"BLD",4748,"KRN",9.8,"NM","B","FBPATDAT",3)

"BLD",4748,"KRN",19,0)
19
"BLD",4748,"KRN",19.1,0)
19.1
"BLD",4748,"KRN",101,0)
101
"BLD",4748,"KRN",409.61,0)
409.61
"BLD",4748,"KRN",771,0)
771
"BLD",4748,"KRN",870,0)
870
"BLD",4748,"KRN",8989.51,0)
8989.51
"BLD",4748,"KRN",8989.52,0)
8989.52
"BLD",4748,"KRN",8994,0)
8994
"BLD",4748,"KRN","B",.4,.4)

"BLD",4748,"KRN","B",.401,.401)

"BLD",4748,"KRN","B",.402,.402)

"BLD",4748,"KRN","B",.403,.403)

"BLD",4748,"KRN","B",.5,.5)

"BLD",4748,"KRN","B",.84,.84)

"BLD",4748,"KRN","B",3.6,3.6)

"BLD",4748,"KRN","B",3.8,3.8)

"BLD",4748,"KRN","B",9.2,9.2)

"BLD",4748,"KRN","B",9.8,9.8)

"BLD",4748,"KRN","B",19,19)

"BLD",4748,"KRN","B",19.1,19.1)

"BLD",4748,"KRN","B",101,101)

"BLD",4748,"KRN","B",409.61,409.61)

"BLD",4748,"KRN","B",771,771)

"BLD",4748,"KRN","B",870,870)

"BLD",4748,"KRN","B",8989.51,8989.51)

"BLD",4748,"KRN","B",8989.52,8989.52)

"BLD",4748,"KRN","B",8994,8994)

"BLD",4748,"QUES",0)
^9.62^^
"BLD",4748,"REQB",0)
^9.611^4^4
"BLD",4748,"REQB",1,0)
FB*3.5*75^2
"BLD",4748,"REQB",2,0)
FB*3.5*37^2
"BLD",4748,"REQB",3,0)
DG*5.3*522^2
"BLD",4748,"REQB",4,0)
XU*8.0*134^2
"BLD",4748,"REQB","B","DG*5.3*522",3)

"BLD",4748,"REQB","B","FB*3.5*37",2)

"BLD",4748,"REQB","B","FB*3.5*75",1)

"BLD",4748,"REQB","B","XU*8.0*134",4)

"MBREQ")
0
"PKG",60,-1)
1^1
"PKG",60,0)
FEE BASIS^FB^Used to pay private vendors
"PKG",60,20,0)
^9.402P^1^1
"PKG",60,20,1,0)
2^^FBPMRG
"PKG",60,20,1,1)

"PKG",60,20,"B",2,1)

"PKG",60,22,0)
^9.49I^1^1
"PKG",60,22,1,0)
3.5^2950130^2950605
"PKG",60,22,1,"PAH",1,0)
70^3040607^100920
"PKG",60,22,1,"PAH",1,1,0)
^^1^1^3040607
"PKG",60,22,1,"PAH",1,1,1,0)
HIPAA CC PHASE III
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","FBAACO0")
0^2^B32636065
"RTN","FBAACO0",1,0)
FBAACO0 ;AISC/GRR-DISPLAY PATIENT ADDRESS DATA AND EDIT ;7/13/2003
"RTN","FBAACO0",2,0)
 ;;3.5;FEE BASIS;**4,38,52,57,61,75,70**;JAN 30, 1995
"RTN","FBAACO0",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACO0",4,0)
 S FBMST=$S(FBTT=1:"Y",1:""),FBTTYPE="A",FBFDC=""
"RTN","FBAACO0",5,0)
 N FBEDPTAD S (FBEDPTAD(1),FBEDPTAD(2))=0
"RTN","FBAACO0",6,0)
 W @IOF,"Patient:  ",$P(^DPT(DFN,0),"^") S (Y(0),HY(0))=$G(^DPT(DFN,.11)) I Y(0)="" W !,*7,"No Address information for this patient!" G EDIT
"RTN","FBAACO0",7,0)
 S VAPA("P")="" D ADD^VADPT
"RTN","FBAACO0",8,0)
 S FBEDPTAD(1)=$$ISCCADR()
"RTN","FBAACO0",9,0)
 S FBEDPTAD(2)="N"
"RTN","FBAACO0",10,0)
 I $$CCADR(2)
"RTN","FBAACO0",11,0)
 W !!,"Patient's Permanent address:"
"RTN","FBAACO0",12,0)
 F Z=1:1:3 I VAPA(Z)]"" W !?2,"Address Line ",Z,":",?18,VAPA(Z)
"RTN","FBAACO0",13,0)
 W !?2,"City:",?18,VAPA(4),!?2,"State:",?18,$P(VAPA(5),U,2)
"RTN","FBAACO0",14,0)
 W !?2,"Zip:",?18,$S(+$G(VAPA(11)):$P(VAPA(11),U,2),1:VAPA(6)),!?2,"County",?18,$P(VAPA(7),U,2)
"RTN","FBAACO0",15,0)
 K VAPA,VAERR
"RTN","FBAACO0",16,0)
RD W ! S DIR("A")="Want to edit Permanent Address data",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR  S:Y&('$D(DIRUT)) FBEDPTAD(2)="Y" G EDIT
"RTN","FBAACO0",17,0)
 Q
"RTN","FBAACO0",18,0)
EDIT I $G(FBEDPTAD(2))'="N" W !! S HY(0)=$G(^DPT(DFN,.11)) D EN^DGREGAED(DFN)
"RTN","FBAACO0",19,0)
 I $$EDTCCADR()=0 I FBTT'=1 I FBEDPTAD(2)="N" Q
"RTN","FBAACO0",20,0)
MRA I FBTT=1!($G(^DPT(DFN,.11))'=$G(HY(0))) S FBD1=FTP D ENT^FBAAAUT K FBD1
"RTN","FBAACO0",21,0)
 Q
"RTN","FBAACO0",22,0)
FEE ;calculates amount paid based on fee schedule
"RTN","FBAACO0",23,0)
 N FB1725
"RTN","FBAACO0",24,0)
 ; set FB1725 flag = true if payment for a 38 U.S.C. 1725 claim
"RTN","FBAACO0",25,0)
 S FB1725=$S($G(FB583):+$P($G(^FB583(+FB583,0)),U,28),1:0)
"RTN","FBAACO0",26,0)
 S FBFY=FY-1
"RTN","FBAACO0",27,0)
 S (FBFSAMT,FBFSUSD)="",FBAMTPD=$S($G(FBAMTPD)>0:FBAMTPD,1:"")
"RTN","FBAACO0",28,0)
 ; if amount not passed then use fee schedule
"RTN","FBAACO0",29,0)
 I '$G(FBAMTPD) D
"RTN","FBAACO0",30,0)
 . N FBX
"RTN","FBAACO0",31,0)
 . S FBX=$$GET^FBAAFS($$CPT^FBAAUTL4(FBAACP),$$MODL^FBAAUTL4("FBMODA","E"),FBAADT,$G(FBZIP),$$FAC^FBAAFS($G(FBHCFA(30))),$G(FBTIME))
"RTN","FBAACO0",32,0)
 . ;
"RTN","FBAACO0",33,0)
 . I '$G(FBAAMM1) D
"RTN","FBAACO0",34,0)
 . . S FBFSAMT=$P(FBX,U),FBFSUSD=$P(FBX,U,2)
"RTN","FBAACO0",35,0)
 . E  W !?2,"Payment is for a contracted service so fee schedule does not apply."
"RTN","FBAACO0",36,0)
 . ;
"RTN","FBAACO0",37,0)
 . I $P($G(FBX),U)]"" D
"RTN","FBAACO0",38,0)
 . . W !?2,$S($G(FBAAMM1):"However, f",1:"F")
"RTN","FBAACO0",39,0)
 . . W "ee schedule amount is $",$P(FBX,U)," from the "
"RTN","FBAACO0",40,0)
 . . W:$P(FBX,U,3)]"" $P(FBX,U,3)," " ; year if returned
"RTN","FBAACO0",41,0)
 . . W:$P(FBX,U,2)]"" $$EXTERNAL^DILFD(162.03,45,"",$P(FBX,U,2))
"RTN","FBAACO0",42,0)
 . E  W !?2,"Unable to determine a FEE schedule amount."
"RTN","FBAACO0",43,0)
 . ;
"RTN","FBAACO0",44,0)
 . I FB1725 D
"RTN","FBAACO0",45,0)
 . . W !!?2,"**Payment is for emergency treatment under 38 U.S.C. 1725."
"RTN","FBAACO0",46,0)
 . . I FBFSAMT D
"RTN","FBAACO0",47,0)
 . . . S FBFSAMT=$J(FBFSAMT*.7,0,2)
"RTN","FBAACO0",48,0)
 . . . W !?2,"  Therefore, fee schedule amount reduced to $",FBFSAMT," (70%)."
"RTN","FBAACO0",49,0)
 . ;
"RTN","FBAACO0",50,0)
 . I $G(FBUNITS)>1 D
"RTN","FBAACO0",51,0)
 . . W !!?2,"Units Paid = ",FBUNITS
"RTN","FBAACO0",52,0)
 . . Q:FBFSAMT'>0
"RTN","FBAACO0",53,0)
 . . N FBFSUNIT
"RTN","FBAACO0",54,0)
 . . ; determine if fee schedule can be multipled by units
"RTN","FBAACO0",55,0)
 . . S FBFSUNIT=$S(FBFSUSD="R":1,FBFSUSD="F"&(FBAADT>3040930):1,1:0)
"RTN","FBAACO0",56,0)
 . . I FBFSUNIT D
"RTN","FBAACO0",57,0)
 . . . S FBFSAMT=$J(FBFSAMT*FBUNITS,0,2)
"RTN","FBAACO0",58,0)
 . . . W !?2,"  Therefore, fee schedule amount increased to $",FBFSAMT
"RTN","FBAACO0",59,0)
 . . E  D
"RTN","FBAACO0",60,0)
 . . . W !?2,"  Fee schedule not complied on per unit basis so amount not adjusted for units."
"RTN","FBAACO0",61,0)
 . ;
"RTN","FBAACO0",62,0)
 . I '$G(FBAAMM1) D
"RTN","FBAACO0",63,0)
 . . ; set default amount paid to lesser of amt claimed (J) or fee sched.
"RTN","FBAACO0",64,0)
 . . S FBAMTPD=$S(FBFSAMT>J:J,FBFSAMT>0:FBFSAMT,1:"")
"RTN","FBAACO0",65,0)
 . ;
"RTN","FBAACO0",66,0)
 . W !
"RTN","FBAACO0",67,0)
 ;
"RTN","FBAACO0",68,0)
AMTPD W !,"AMOUNT PAID: "_$S(FBAMTPD]"":FBAMTPD_"//",1:"") R X:DTIME S:X="" X=FBAMTPD G KILL:$E(X)="^",HELP1:$E(X)="?" S:X["$" X=$P(X,"$",2) I +X'=X&(X'?.N.1".".2N)!(+X>+J)!(+X<0) G HELPPD
"RTN","FBAACO0",69,0)
 I FBAMTPD]"",X>FBAMTPD&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) D  G AMTPD
"RTN","FBAACO0",70,0)
 .W !!,*7,"You must be a holder of the 'FBAASUPERVISOR' key to",!,"exceed the Fee Schedule. Entering an up-arrow ('^') will",!,"delete the payment or you can accept the default.",!
"RTN","FBAACO0",71,0)
 S FBAMTPD=X Q
"RTN","FBAACO0",72,0)
KILL W !!,*7,"Entering an '^' will delete this payment!" R !,?5,"Do you want to delete? No//",X:DTIME S:X="" X="N" D VALCK^FBAAUTL1 G KILL:'VAL,AMTPD:"Nn"[$E(X)
"RTN","FBAACO0",73,0)
 S DIK="^FBAAC("_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1," D WAIT^DICD,^DIK W !,?3,"<DELETED>" K DA,J,K,DIC,DIK,FBAACP,FBAADT,FBX S Y=0,FBDL=1 Q
"RTN","FBAACO0",74,0)
HELP1 W !!,"Enter a dollar amount that does not exceed the amount claimed.",!,"Entering an '^' will delete the payment.",!
"RTN","FBAACO0",75,0)
 I FBAMTPD>0 W !,"Only the holder of the 'FBAASUPERVISOR' key may exceed the",!,"Fee Schedule.",!
"RTN","FBAACO0",76,0)
 G AMTPD
"RTN","FBAACO0",77,0)
HELPPD W !!,*7,"Enter a dollar amount that does not exceed the amount claimed.",! G AMTPD
"RTN","FBAACO0",78,0)
 Q
"RTN","FBAACO0",79,0)
 ;print Confidential Communication address
"RTN","FBAACO0",80,0)
 ;ADD^VADPT must be invoked before this call
"RTN","FBAACO0",81,0)
 ;FBDFN -patient's DFN
"RTN","FBAACO0",82,0)
 ;FBSTPOS - position to start print
"RTN","FBAACO0",83,0)
 ;returns 0 if there is no active CC address
"RTN","FBAACO0",84,0)
 ;returns 1 if active
"RTN","FBAACO0",85,0)
CCADR(FBSTPOS) ;
"RTN","FBAACO0",86,0)
 N FBACT
"RTN","FBAACO0",87,0)
 S FBACT=0
"RTN","FBAACO0",88,0)
 I '$D(VAPA(12)) Q 0  ;if D ADD^VADPT was not invoked before
"RTN","FBAACO0",89,0)
 I 'VAERR D
"RTN","FBAACO0",90,0)
 . S FBACT=$$ACTIVECC()
"RTN","FBAACO0",91,0)
 . Q:'FBACT
"RTN","FBAACO0",92,0)
 . W !!,"Confidential Communication address until: "_$P($G(VAPA(21)),U,2)
"RTN","FBAACO0",93,0)
 . I $G(VAPA(13))]"" W !?FBSTPOS,"Line 1: ",$G(VAPA(13))
"RTN","FBAACO0",94,0)
 . I $G(VAPA(14))]"" W " Line 2: ",$G(VAPA(14))
"RTN","FBAACO0",95,0)
 . I $G(VAPA(15))]"" W !?FBSTPOS,"Line 3: ",$G(VAPA(15))
"RTN","FBAACO0",96,0)
 . W !?FBSTPOS,"City:",?9,$S($G(VAPA(16))]"":$G(VAPA(16)),1:"     ")
"RTN","FBAACO0",97,0)
 . W ?40,"State:",?47,$S($P($G(VAPA(17)),U,2)]"":$P($G(VAPA(17)),U,2),1:"  ")
"RTN","FBAACO0",98,0)
 . W !?FBSTPOS,"Zip:",?9,$P($G(VAPA(18)),U,2)
"RTN","FBAACO0",99,0)
 . W ?20,"County:",?28,$P($G(VAPA(19)),U,2)
"RTN","FBAACO0",100,0)
 Q $G(FBACT)
"RTN","FBAACO0",101,0)
 ;
"RTN","FBAACO0",102,0)
 ;is called after ADD^VADPT to verify whether confidential address is 
"RTN","FBAACO0",103,0)
 ;active or not to encapsulate the logic related to status of CC address
"RTN","FBAACO0",104,0)
 ;input:  VAPA
"RTN","FBAACO0",105,0)
ACTIVECC() ;
"RTN","FBAACO0",106,0)
 Q (+$G(VAPA(12))=1)&($P($G(VAPA(22,3)),"^",3)="Y")
"RTN","FBAACO0",107,0)
 ;
"RTN","FBAACO0",108,0)
 ;edit confidential address
"RTN","FBAACO0",109,0)
 ;returns 1 if CC address has been edited
"RTN","FBAACO0",110,0)
 ;otherwise - 0
"RTN","FBAACO0",111,0)
EDTCCADR() ;
"RTN","FBAACO0",112,0)
 Q:'$G(DFN) 0
"RTN","FBAACO0",113,0)
 I FBEDPTAD(1)=0 D
"RTN","FBAACO0",114,0)
 . N VAPA S VAPA("P")="" D ADD^VADPT S FBEDPTAD(1)=$$ISCCADR()
"RTN","FBAACO0",115,0)
 I FBEDPTAD(1)'="N" D
"RTN","FBAACO0",116,0)
 . W:FBEDPTAD(1)'="B" !!,"WARNING: The Confidential address is NOT active for the Billing Category."
"RTN","FBAACO0",117,0)
 . S DIR("A")="Want to edit Confidential Address data"
"RTN","FBAACO0",118,0)
 E  S DIR("A")="Want to add Confidential Address data"
"RTN","FBAACO0",119,0)
 W ! S DIR("B")="No",DIR(0)="Y"
"RTN","FBAACO0",120,0)
 D ^DIR K DIR
"RTN","FBAACO0",121,0)
 Q:($D(DIRUT)) 0
"RTN","FBAACO0",122,0)
 ;Registration API
"RTN","FBAACO0",123,0)
 I Y D QUES^DGRPU1(+DFN,"ADD4") Q 1
"RTN","FBAACO0",124,0)
 Q 0
"RTN","FBAACO0",125,0)
 ;
"RTN","FBAACO0",126,0)
 ;returns "B" if patient has any (active or inactive) CC address and billing category
"RTN","FBAACO0",127,0)
 ;returns "Y" if patient has any (active or inactive) CC address with another category
"RTN","FBAACO0",128,0)
 ;otherwise returns "N"
"RTN","FBAACO0",129,0)
ISCCADR() ;
"RTN","FBAACO0",130,0)
 Q:($P($G(VAPA(22,3)),"^",3)="Y") "B"
"RTN","FBAACO0",131,0)
 Q:'$O(VAPA(22,0)) "N"
"RTN","FBAACO0",132,0)
 Q "Y"
"RTN","FBAACO0",133,0)
 ;
"RTN","FBAACO0",134,0)
 ;FBAACO0
"RTN","FBAAV4")
0^1^B34466423
"RTN","FBAAV4",1,0)
FBAAV4 ;AISC/GRR-ELECTRONICALLY TRANSMIT PATIENT MRA'S ;12/16/2003
"RTN","FBAAV4",2,0)
 ;;3.5;FEE BASIS;**13,34,37,70**;JAN 30, 1995
"RTN","FBAAV4",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAV4",4,0)
 ;D STATION^FBAAUTL,HD^FBAAUTL Q:$D(FB("ERROR"))
"RTN","FBAAV4",5,0)
 S FBTXT=0,ZMCNT=1 ;FBTXT , ZMCNT 
"RTN","FBAAV4",6,0)
GO S J=0 F  S J=$O(^FBAA(161.26,"AC","P",J)) Q:J'>0  S FB0=$G(^FBAA(161.26,J,0)) I $P(FB0,U) S Y(0)=$G(^DPT($P(FB0,U),0)) I Y(0)]"" S FBTYPE=$S($P(FB0,U,4)]"":$P(FB0,U,4),1:"A"),FBFDC=$P(FB0,U,6),FBMST=$P(FB0,U,7) D
"RTN","FBAAV4",7,0)
 .; GETBT-prepare header 
"RTN","FBAAV4",8,0)
 .; NEWMSG^FBAAV01-get new message number, reset line counter, set subject line 
"RTN","FBAAV4",9,0)
 .; STORE^FBAAV01- increment line counter and store in ^XMB
"RTN","FBAAV4",10,0)
 .; FBLN -line counter; FBFEE- "FEE message" counter; FBOKTX=1 if message pending, 0 otherwise
"RTN","FBAAV4",11,0)
 .I 'FBTXT S FBTXT=1 D GETBT,NEWMSG^FBAAV01,STORE^FBAAV01
"RTN","FBAAV4",12,0)
 .; prepare and store patient MRA portion (can be more than 1)
"RTN","FBAAV4",13,0)
 .D GOT
"RTN","FBAAV4",14,0)
 D:+$G(FBOKTX) XMIT^FBAAV01
"RTN","FBAAV4",15,0)
 Q
"RTN","FBAAV4",16,0)
 ;GETBT - prepare the "header" of the message 
"RTN","FBAAV4",17,0)
GETBT D GETNXB^FBAAUTL ;get next batch # in FBBN
"RTN","FBAAV4",18,0)
 S FBZBN=$E("00000",$L(FBBN)+1,5)_FBBN,FBSN=FBSN_$E("      ",$L(FBSN)+1,6)
"RTN","FBAAV4",19,0)
 S FBSTR=FBHD_"C2"_$E(DT,4,7)_$E(DT,2,3)_FBSN_FBZBN_"$"
"RTN","FBAAV4",20,0)
 Q
"RTN","FBAAV4",21,0)
 ; 
"RTN","FBAAV4",22,0)
GOT ;patient MRA portion of the message
"RTN","FBAAV4",23,0)
 N FBCCFLG,FBPATICN,FB2NDSTR
"RTN","FBAAV4",24,0)
 ; patient info;input:Y(0);output:FBDOB,FBFI,FBFLNAM,FBLNAM,FBMI,FBNAME,FBSEX,FBSSN
"RTN","FBAAV4",25,0)
 D PAT^FBAAUTL2
"RTN","FBAAV4",26,0)
 S DFN=$P(FB0,U)
"RTN","FBAAV4",27,0)
 S FBFLNAM=$$HL7NAME(DFN),FBFI="",FBMI="" ;name (FBFI,FBMI - obsolete)
"RTN","FBAAV4",28,0)
 ; demographic info, output:VADM
"RTN","FBAAV4",29,0)
 D DEM^VADPT Q:$G(VAERR)
"RTN","FBAAV4",30,0)
 S FBBD=$P(VADM(3),"^"),FBBD=$E(FBBD,4,7)_$E(FBBD,2,3) ;DOB
"RTN","FBAAV4",31,0)
 S FBBD=$S(FBBD="":"      ",1:FBBD),FBSEX=$P(VADM(5),"^"),FBSEX=$S(FBSEX="F":2,1:1)
"RTN","FBAAV4",32,0)
 S DOD=$P($P(VADM(6),"^"),".") ;DOD
"RTN","FBAAV4",33,0)
 K VADM,VAERR
"RTN","FBAAV4",34,0)
 ;S Y(0)=$S($D(^DPT(DFN,.11)):^(.11),1:"") Q:Y(0)']""
"RTN","FBAAV4",35,0)
 ;S FBADD=$E($P(Y(0),"^",1),1,21),FBADD=FBADD_$E(PAD,$L(FBADD)+1,21),FBCITY=$E($P(Y(0),"^",4),1,13),FBCITY=FBCITY_$E(PAD,$L(FBCITY)+1,13),FBSTAT="  "
"RTN","FBAAV4",36,0)
 ;S STCD=$P(Y(0),"^",5) I STCD]"" S FBSTAT=$S($D(^DIC(5,STCD,0)):$P(^(0),"^",2),1:"  ")
"RTN","FBAAV4",37,0)
 ;
"RTN","FBAAV4",38,0)
 ;address info, output: VAPA()
"RTN","FBAAV4",39,0)
 S VAPA("P")="" D ADD^VADPT Q:$G(VAERR)
"RTN","FBAAV4",40,0)
 S FBADD=$$LRJ($G(VAPA(1)),35)_$$LRJ($G(VAPA(2)),35)_$$LRJ($G(VAPA(3)),35) ;street address
"RTN","FBAAV4",41,0)
 S FBCITY=$$LRJ($G(VAPA(4)),30) ;city
"RTN","FBAAV4",42,0)
 S STCD=+VAPA(5) I STCD S FBSTAT=$S($D(^DIC(5,STCD,0)):$P(^(0),"^",2),1:"  ") ;state
"RTN","FBAAV4",43,0)
 S FBZIP=$S('+$G(VAPA(11)):VAPA(6),+VAPA(11):$P(VAPA(11),"^"),1:VAPA(6)) ;zip
"RTN","FBAAV4",44,0)
 ;check for Confidential Communication (CC) address
"RTN","FBAAV4",45,0)
 S FBCCFLG=0 I 'VAERR S FBCCFLG=$$SENDCC()
"RTN","FBAAV4",46,0)
 S FB2NDSTR=$$SECLINE()
"RTN","FBAAV4",47,0)
 S FBZIP=$TR(FBZIP,"-","")_$E("000000000",$L(FBZIP)+1,9)
"RTN","FBAAV4",48,0)
 S STCC=+VAPA(7),FBCC="000" I STCC,STCD S FBCC=$S($D(^DIC(5,STCD,1,STCC,0)):$P(^(0),"^",3),1:"000") ;county code
"RTN","FBAAV4",49,0)
 K VAPA,VAERR
"RTN","FBAAV4",50,0)
 ;
"RTN","FBAAV4",51,0)
 ; eligibility, output:VAEL()
"RTN","FBAAV4",52,0)
 D ELIG^VADPT
"RTN","FBAAV4",53,0)
 S POS=$S(+VAEL(2):+VAEL(2),1:"") ;PERIOD OF SERVICE
"RTN","FBAAV4",54,0)
 K VAEL,VAERR
"RTN","FBAAV4",55,0)
 S POS=$S(POS="":8,$D(^DIC(21,POS,0)):$P(^(0),"^",3),1:8) ;default: 8 (POST-VIETNAM)
"RTN","FBAAV4",56,0)
 S DOD=$S(DOD="":"000000",1:$E(DOD,4,7)_$E(DOD,2,3))
"RTN","FBAAV4",57,0)
 ;
"RTN","FBAAV4",58,0)
 ; service information
"RTN","FBAAV4",59,0)
 D SVC^VADPT
"RTN","FBAAV4",60,0)
 S POW=$S(+VASV(4):+VASV(4),1:""),POW=$S(POW="":2,POW=1:1,1:2) ;if prisoner of war
"RTN","FBAAV4",61,0)
 ;
"RTN","FBAAV4",62,0)
 ; remove all variables defined by VADPT
"RTN","FBAAV4",63,0)
 D KVAR^VADPT
"RTN","FBAAV4",64,0)
 ;
"RTN","FBAAV4",65,0)
 ;using pointer FEE BASIS PATIENT MRA file retrieve info from 
"RTN","FBAAV4",66,0)
 ;FEE BASIS PATIENT file#161, from its authorization multiple ^FBAAA(DA(1),1,DA
"RTN","FBAAV4",67,0)
 S FBAUTH=$P(^FBAA(161.26,J,0),"^",3) Q:FBAUTH']""  Q:'$D(^FBAAA(DFN,1,FBAUTH,0))  S Y(0)=^(0)
"RTN","FBAAV4",68,0)
 ;authorisation FROM
"RTN","FBAAV4",69,0)
 S FBFR=$P(Y(0),"^")
"RTN","FBAAV4",70,0)
 ;authorisation TO
"RTN","FBAAV4",71,0)
 S FBTO=$P(Y(0),"^",2)
"RTN","FBAAV4",72,0)
 ;PURPOSE OF VISIT
"RTN","FBAAV4",73,0)
 S POV=$P(Y(0),"^",7),POV=$S(POV="":"",$D(^FBAA(161.82,POV,0)):$P(^(0),"^",3),1:""),POV=$S(POV]"":POV,1:"05")
"RTN","FBAAV4",74,0)
 ;TREATMENT TYPE CODE (SHORT TERM,HOME NURSING,I.D. CARD,STATE HOME)
"RTN","FBAAV4",75,0)
 S FBTT=$P(Y(0),"^",13),FBTT=$S(FBTT]"":FBTT,1:1)
"RTN","FBAAV4",76,0)
 ;
"RTN","FBAAV4",77,0)
 S FBRECT=$S(FBTT=4:"7",FBTT=2:"S",$G(POV)>29&($G(POV)<50):"C",1:2)
"RTN","FBAAV4",78,0)
 ;formatting FORM and TO dates
"RTN","FBAAV4",79,0)
 S FBFR=$E(FBFR,4,7)_$E(FBFR,2,3),FBTO=$E(FBTO,4,7)_$E(FBTO,2,3)
"RTN","FBAAV4",80,0)
 ;flag that the authorization From Date is being changed by this 
"RTN","FBAAV4",81,0)
 ;master record adjustment (see file #161.26, field #5)
"RTN","FBAAV4",82,0)
 I FBTYPE="C" S FBTO=$S(FBFDC=1:"      ",1:FBTO)
"RTN","FBAAV4",83,0)
 ;
"RTN","FBAAV4",84,0)
 I FBTT=2,"^70^71^74^"'[(U_POV_U) S POV=71
"RTN","FBAAV4",85,0)
 ;if 
"RTN","FBAAV4",86,0)
 S ZMCNT=ZMCNT+1 I ZMCNT>100 D GETBT,STORE S ZMCNT=ZMCNT+1
"RTN","FBAAV4",87,0)
 ; patch FB*3.5*13 changed format of delete MRAs to include the From Date
"RTN","FBAAV4",88,0)
 I FBTYPE="D" D  Q
"RTN","FBAAV4",89,0)
 . S FBRECT=$S(FBTT=4:"7",FBTT=2:"S",$G(POV)=31:"C",1:2)
"RTN","FBAAV4",90,0)
 . S FBSTR=FBRECT_FBTYPE_FBSN_FBSSN_FBFR_"$"
"RTN","FBAAV4",91,0)
 . D ZAP
"RTN","FBAAV4",92,0)
 I FBTYPE="R" D
"RTN","FBAAV4",93,0)
 . S FBRECT=$S(FBTT=4:"7",FBTT=2:"S",$G(POV)=31:"C",1:2)
"RTN","FBAAV4",94,0)
 . ; If Re-Instate for a State Home record type then switch to Add
"RTN","FBAAV4",95,0)
 . ;   because Central FEE does not retain deleted State Home auth.
"RTN","FBAAV4",96,0)
 . I FBRECT=7 S FBTYPE="A" Q
"RTN","FBAAV4",97,0)
 . ; For all other record types send a Re-Instate followed by a Change
"RTN","FBAAV4",98,0)
 . S FBSTR=FBRECT_FBTYPE_FBSN_FBSSN_"$"
"RTN","FBAAV4",99,0)
 . D ZAP
"RTN","FBAAV4",100,0)
 . S FBTYPE="C"
"RTN","FBAAV4",101,0)
 ; construct Add and Change record types
"RTN","FBAAV4",102,0)
 S FBTT=$S(FBMST="Y":0,1:FBTT)
"RTN","FBAAV4",103,0)
 S FBPATICN=$$ICN(DFN) ;get patient's ICN
"RTN","FBAAV4",104,0)
 S FBSTR=FBRECT_FBTYPE_FBSN_FBSSN_FBFI_FBMI_FBFLNAM_FBADD_FBCITY_FBSTAT_FBZIP_FBFR_FBTO_FBCC_FBBD_POV_" "_FBTT_FBSEX_POW_DOD_" "_POS_FBPATICN_"~"
"RTN","FBAAV4",105,0)
 ;if no CC address then send only 1st line of Add and Change record
"RTN","FBAAV4",106,0)
 I FBCCFLG=0 S FBSTR=FBSTR_"$" D ZAP Q
"RTN","FBAAV4",107,0)
 ;save 1st line of Add and Change record
"RTN","FBAAV4",108,0)
 D STORE
"RTN","FBAAV4",109,0)
 ;create 2nd line for CC address
"RTN","FBAAV4",110,0)
 S FBSTR=FB2NDSTR
"RTN","FBAAV4",111,0)
 D ZAP
"RTN","FBAAV4",112,0)
 Q
"RTN","FBAAV4",113,0)
 ;place in XMB for transmission and update FBAA(161.26
"RTN","FBAAV4",114,0)
ZAP D STORE
"RTN","FBAAV4",115,0)
 S DA=J,(DIC,DIE)="^FBAA(161.26,",T="T",DR="1///^S X=T;4///^S X=DT" D ^DIE
"RTN","FBAAV4",116,0)
 Q
"RTN","FBAAV4",117,0)
SKIP S FBRECT=$S(FBTT=2:"S",1:2),FBSTR=FBRECT_FBTYPE_FBSN_FBSSN_"$" G ZAP
"RTN","FBAAV4",118,0)
STORE I ZMCNT>100 D XMIT^FBAAV01,NEWMSG^FBAAV01 S ZMCNT=1
"RTN","FBAAV4",119,0)
 D STORE^FBAAV01
"RTN","FBAAV4",120,0)
 Q
"RTN","FBAAV4",121,0)
 ;---
"RTN","FBAAV4",122,0)
 ;Patient's INTEGRATION CONTROL NUMBER
"RTN","FBAAV4",123,0)
 ;to be implemented in future
"RTN","FBAAV4",124,0)
 ;meanwhile returns 17 spaces
"RTN","FBAAV4",125,0)
ICN(FBDFN) ;
"RTN","FBAAV4",126,0)
 Q $$LRJ("",17)
"RTN","FBAAV4",127,0)
 ;---
"RTN","FBAAV4",128,0)
 ;adds spaces on right/left or truncates to make return string FBLEN characters long
"RTN","FBAAV4",129,0)
 ;FBST- original string
"RTN","FBAAV4",130,0)
 ;FBLEN - desired length
"RTN","FBAAV4",131,0)
 ;FBCHR -character (default = SPACE)
"RTN","FBAAV4",132,0)
 ;FBSIDE - on which side to add characters (default = RIGHT)
"RTN","FBAAV4",133,0)
LRJ(FBST,FBLEN,FBCHR,FBSIDE) ;
"RTN","FBAAV4",134,0)
 N Y S $P(Y,$S($L($G(FBCHR)):FBCHR,1:" "),$S(FBLEN-$L(FBST)<0:1,1:FBLEN-$L(FBST)+1))=""
"RTN","FBAAV4",135,0)
 Q $E($S($G(FBSIDE)="L":Y_FBST,1:FBST_Y),1,FBLEN)
"RTN","FBAAV4",136,0)
 ;---
"RTN","FBAAV4",137,0)
 ;parse name components
"RTN","FBAAV4",138,0)
HL7NAME(FBDFN) ;
"RTN","FBAAV4",139,0)
 N FBAR,FBNM
"RTN","FBAAV4",140,0)
 S FBAR("FILE")=2,FBAR("IENS")=FBDFN,FBAR("FIELD")=.01
"RTN","FBAAV4",141,0)
 S FBNM=$$HLNAME^XLFNAME(.FBAR,"L30","|")
"RTN","FBAAV4",142,0)
 Q $$LRJ(FBNM,30)
"RTN","FBAAV4",143,0)
 ;
"RTN","FBAAV4",144,0)
 ;create 2nd line for CC address
"RTN","FBAAV4",145,0)
 ;VAPA should be determined
"RTN","FBAAV4",146,0)
SECLINE() ;
"RTN","FBAAV4",147,0)
 N FBSTR1
"RTN","FBAAV4",148,0)
 S FBSTR1=$$LRJ($G(VAPA(13)),35)_$$LRJ($G(VAPA(14)),35)_$$LRJ($G(VAPA(15)),35)_$$LRJ($G(VAPA(16)),30) ;street address
"RTN","FBAAV4",149,0)
 S FBSTR1=FBSTR1_$$LRJ($S(+$G(VAPA(17)):$P($G(^DIC(5,+$G(VAPA(17)),0)),"^",2),1:""),2) ;state
"RTN","FBAAV4",150,0)
 S FBSTR1=FBSTR1_$$LRJ($TR($P($G(VAPA(18)),"^",1),"-",""),9,"0") ;zip
"RTN","FBAAV4",151,0)
 S FBSTR1=FBSTR1_$$LRJ($E(+$G(VAPA(20)),4,5)_$E(+$G(VAPA(20)),6,7)_$E(+$G(VAPA(20)),2,3),6)
"RTN","FBAAV4",152,0)
 S FBSTR1=FBSTR1_$$LRJ($E(+$G(VAPA(21)),4,5)_$E(+$G(VAPA(21)),6,7)_$E(+$G(VAPA(21)),2,3),6)
"RTN","FBAAV4",153,0)
 S FBSTR1=FBSTR1_$$LRJ($P($G(^DIC(5,+$G(VAPA(17)),1,+$G(VAPA(19)),0)),"^",3),3,"0","L") ;county code
"RTN","FBAAV4",154,0)
 S FBSTR1=FBSTR1_"~$"
"RTN","FBAAV4",155,0)
 Q FBSTR1
"RTN","FBAAV4",156,0)
 ;------
"RTN","FBAAV4",157,0)
 ;SENDCC
"RTN","FBAAV4",158,0)
 ;returns 1 if CC address needs to be sent, otherwise - 0
"RTN","FBAAV4",159,0)
 ;is called after ADD^VADPT, i.e. VAPA should be defined
"RTN","FBAAV4",160,0)
SENDCC() ;
"RTN","FBAAV4",161,0)
 ;if it is currrently active
"RTN","FBAAV4",162,0)
 I $$ACTIVECC^FBAACO0() Q 1
"RTN","FBAAV4",163,0)
 N X D NOW^%DTC ;set X to TODAY
"RTN","FBAAV4",164,0)
 I ($P($G(VAPA(22,3)),"^",3)="Y"),+$G(VAPA(20))>X Q 1
"RTN","FBAAV4",165,0)
 Q 0
"RTN","FBAAV4",166,0)
 ;
"RTN","FBPATDAT")
0^3^B15288924
"RTN","FBPATDAT",1,0)
FBPATDAT ;WOIFO/SS-NOTIFICATION ABOUT PATIENT DATA CHANGE ;4/7/2003
"RTN","FBPATDAT",2,0)
 ;;3.5;FEE BASIS;**57,70**;JAN 30, 1995
"RTN","FBPATDAT",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBPATDAT",4,0)
CHNG ;entry point
"RTN","FBPATDAT",5,0)
 I $G(DGFILE)=2.141 D UPDADR($G(DGDA)) Q  ;CONFIDENTIAL ADDRESS CATEGORY subfile fields
"RTN","FBPATDAT",6,0)
 Q:$G(DGFILE)'=2
"RTN","FBPATDAT",7,0)
 N FBFLAG S FBFLAG=0
"RTN","FBPATDAT",8,0)
 N FBFLD
"RTN","FBPATDAT",9,0)
 F FBFLD=.351,.03,.111,.112,.113,.114,.115,.116,.1112,.1411,.1412,.1413,.1414,.1415,.1416,.1417,.1418,2.141 I $G(DGFIELD)=FBFLD S FBFLAG=1 Q
"RTN","FBPATDAT",10,0)
 Q:'FBFLAG
"RTN","FBPATDAT",11,0)
 D UPDADR($G(DGDA))
"RTN","FBPATDAT",12,0)
 Q
"RTN","FBPATDAT",13,0)
 ;send patient MRA message to AAC
"RTN","FBPATDAT",14,0)
 ;
"RTN","FBPATDAT",15,0)
UPDADR(FBDFN) ;
"RTN","FBPATDAT",16,0)
 Q:+$G(FBDFN)=0
"RTN","FBPATDAT",17,0)
 N FBFRDT,FBTODT,FBTRTYP,FBZTH,FBDEL S (FBZTH,FBDEL)=""
"RTN","FBPATDAT",18,0)
 N FBAUTH,FBARR,FBLIMDT,FBTODAY,FB1 S (FBFRDT,FBTODT,FBTRTYP,FBAUTH,FBARR,FBTODAY,FBLIMDT,FB1)=0
"RTN","FBPATDAT",19,0)
 D  ;limit date is TODAY - 2 year
"RTN","FBPATDAT",20,0)
 . N X D NOW^%DTC S FBTODAY=X,FBLIMDT=+(($E(X,1,3)-2)_$E(X,4,7))
"RTN","FBPATDAT",21,0)
 ;go thru all authorizations for this patient
"RTN","FBPATDAT",22,0)
 ;and process all of them except SHORT TERM (i.e. only ID, HOME HEALTH and STATE HOME)
"RTN","FBPATDAT",23,0)
 F  S FBAUTH=$O(^FBAAA(FBDFN,1,FBAUTH)) Q:+FBAUTH=0  D
"RTN","FBPATDAT",24,0)
 . ;get zeroth node
"RTN","FBPATDAT",25,0)
 . S FBZTH=$G(^FBAAA(FBDFN,1,FBAUTH,0))
"RTN","FBPATDAT",26,0)
 . ;TO DATE, FROM DATE, Treatment type
"RTN","FBPATDAT",27,0)
 . S FBTODT=$P(FBZTH,"^",2),FBFRDT=$P(FBZTH,"^"),FBTRTYP=$P(FBZTH,"^",13)
"RTN","FBPATDAT",28,0)
 . Q:FBTRTYP<1!(FBTRTYP>4)
"RTN","FBPATDAT",29,0)
 . Q:FBTRTYP=1  ;short terms will be processed via file #161.26
"RTN","FBPATDAT",30,0)
 . ;apply to different rules depend on treatment type
"RTN","FBPATDAT",31,0)
 . Q:FBTODT<FBLIMDT&((FBTRTYP=2)!(FBTRTYP=3))  ;ID and HOME HEALTH
"RTN","FBPATDAT",32,0)
 . Q:(FBTRTYP=4)&(FBTODT<FBTODAY)  ;STATE HOME
"RTN","FBPATDAT",33,0)
 . S FBDEL=$G(^FBAAA(FBDFN,1,FBAUTH,"ADEL"))
"RTN","FBPATDAT",34,0)
 . Q:$P(FBDEL,"^")=1!($P(FBDEL,"^")="Y")  ;the 'Delete MRA' was transmitted to Austin DPC.
"RTN","FBPATDAT",35,0)
 . ;store AUTHORIZATION details in the local array
"RTN","FBPATDAT",36,0)
 . S FB1=+$O(FBARR(FBTRTYP,0))
"RTN","FBPATDAT",37,0)
 . I FB1 I FBTODT'>$P(FBARR(FBTRTYP,FB1),"^",4) Q  ;more recent one already there
"RTN","FBPATDAT",38,0)
 . I FB1 K FBARR(FBTRTYP,FB1) ;kill this one and then replace it (below)
"RTN","FBPATDAT",39,0)
 . S FBARR(FBTRTYP,9999999-FBTODT)=FBDFN_"^"_FBAUTH_"^"_FBFRDT_"^"_FBTODT
"RTN","FBPATDAT",40,0)
 ;add SHORT TERM authorizations to the local array from file #161.26
"RTN","FBPATDAT",41,0)
 D DOSHORT(.FBARR,FBDFN,FBTODAY)
"RTN","FBPATDAT",42,0)
 ;go thru all authorizations selected and saved in the local array
"RTN","FBPATDAT",43,0)
 F FBTRTYP=1,2,3,4 D DOEACH(.FBARR,FBTRTYP)
"RTN","FBPATDAT",44,0)
 Q
"RTN","FBPATDAT",45,0)
 ;
"RTN","FBPATDAT",46,0)
 ;SHORT-TERM (1) Authorizations
"RTN","FBPATDAT",47,0)
DOSHORT(FBARR1,FBDFN,FBTODAY) ;
"RTN","FBPATDAT",48,0)
 Q:+$G(FBDFN)=0
"RTN","FBPATDAT",49,0)
 Q:'$D(FBARR1)
"RTN","FBPATDAT",50,0)
 Q:+$G(FBTODAY)=0
"RTN","FBPATDAT",51,0)
 N FBDT30  ;30 days back
"RTN","FBPATDAT",52,0)
 D
"RTN","FBPATDAT",53,0)
 . N X1,X2,X S X1=FBTODAY,X2=-30 D C^%DTC S FBDT30=X
"RTN","FBPATDAT",54,0)
 ;go thru file #161.26
"RTN","FBPATDAT",55,0)
 N FB1,FB2,FB3,FBDT S (FB2,FB1,FB3)=0
"RTN","FBPATDAT",56,0)
 F  S FB1=$O(^FBAA(161.26,"B",FBDFN,FB1)) Q:+FB1=0  D
"RTN","FBPATDAT",57,0)
 . S FB2=^FBAA(161.26,FB1,0)
"RTN","FBPATDAT",58,0)
 . Q:$P(FB2,"^",7)'="Y"  ;only SHORT TERM
"RTN","FBPATDAT",59,0)
 . Q:$P(FB2,"^",4)="D"  ;we are not interested in DELETE transactions
"RTN","FBPATDAT",60,0)
 . S FBDT=+$P(FB2,"^",5)
"RTN","FBPATDAT",61,0)
 . Q:'FBDT  ;no date
"RTN","FBPATDAT",62,0)
 . ; store in local array
"RTN","FBPATDAT",63,0)
 . I FBDT>FBDT30 D
"RTN","FBPATDAT",64,0)
 . . S FB3=+$O(FBARR1(1,0))
"RTN","FBPATDAT",65,0)
 . . I FB3 I FBDT'>$P(FBARR1(1,FB3),"^",4) Q
"RTN","FBPATDAT",66,0)
 . . I FB1 K FBARR1(1,FB3)
"RTN","FBPATDAT",67,0)
 . . S FBARR1(1,9999999-FBDT)=FBDFN_"^"_$P(FB2,"^",3)_"^^"_FBDT
"RTN","FBPATDAT",68,0)
 Q
"RTN","FBPATDAT",69,0)
 ;SHOR TERM (1)
"RTN","FBPATDAT",70,0)
 ;ID CARD (3) Authorizations
"RTN","FBPATDAT",71,0)
 ;HOME HEALTH (2) Authorizations
"RTN","FBPATDAT",72,0)
 ;STATE HOME (4) Authorizations 
"RTN","FBPATDAT",73,0)
DOEACH(FBARR2,FBTYPE) ;
"RTN","FBPATDAT",74,0)
 Q:'$D(FBARR2)
"RTN","FBPATDAT",75,0)
 N FB1,FBAUTH,FBDFN
"RTN","FBPATDAT",76,0)
 S FB1=$O(FBARR2(FBTYPE,0))
"RTN","FBPATDAT",77,0)
 Q:+FB1=0
"RTN","FBPATDAT",78,0)
 S FBDFN=$P($G(FBARR2(FBTYPE,FB1)),"^")
"RTN","FBPATDAT",79,0)
 S FBAUTH=$P($G(FBARR2(FBTYPE,FB1)),"^",2)
"RTN","FBPATDAT",80,0)
 ;check if there is a pending tramsmission in file
"RTN","FBPATDAT",81,0)
 Q:$$ISPEND(FBDFN,FBAUTH)  ;quit if it is there
"RTN","FBPATDAT",82,0)
 ;send patient MRA to AAC
"RTN","FBPATDAT",83,0)
 D SENDMRA(FBDFN,FBAUTH,FBTYPE)
"RTN","FBPATDAT",84,0)
 Q
"RTN","FBPATDAT",85,0)
 ;
"RTN","FBPATDAT",86,0)
 ;returns 1 if pending or if it is "delete" transaction
"RTN","FBPATDAT",87,0)
 ;returns 0 if was transmitted or there are no transmission at all
"RTN","FBPATDAT",88,0)
ISPEND(FBDFN,FBAUTH) ;
"RTN","FBPATDAT",89,0)
 N FB1,FB2,FBFLGP,FBFLGD S (FB2,FB1,FBFLGP,FBFLGD)=0
"RTN","FBPATDAT",90,0)
 F  S FB1=$O(^FBAA(161.26,"B",FBDFN,FB1)) Q:+FB1=0  D  Q:FBFLGP!FBFLGD
"RTN","FBPATDAT",91,0)
 . S FB2=$G(^FBAA(161.26,FB1,0))
"RTN","FBPATDAT",92,0)
 . I +$P(FB2,"^",3)'=FBAUTH Q
"RTN","FBPATDAT",93,0)
 . S:$P(FB2,"^",2)="P" FBFLGP=1
"RTN","FBPATDAT",94,0)
 . S:$P(FB2,"^",4)="D" FBFLGD=1
"RTN","FBPATDAT",95,0)
 Q:FBFLGP 1
"RTN","FBPATDAT",96,0)
 Q:FBFLGD 1
"RTN","FBPATDAT",97,0)
 Q 0
"RTN","FBPATDAT",98,0)
 ;
"RTN","FBPATDAT",99,0)
SENDMRA(FBDFN,FBAUTH,FBTRTYPE) ;
"RTN","FBPATDAT",100,0)
 N DD,DO,DIC,DLAYGO,DDER,DA
"RTN","FBPATDAT",101,0)
 ;SHORT TERM auth-tions:
"RTN","FBPATDAT",102,0)
 I FBTRTYPE=1 D  Q
"RTN","FBPATDAT",103,0)
 . S DIC="^FBAA(161.26,",DIC(0)="L",DLAYGO=161.26,X=FBDFN
"RTN","FBPATDAT",104,0)
 . S DIC("DR")="1///^S X=""P"";2///^S X=FBAUTH;3///^S X=""A"";6////^S X=""Y"""
"RTN","FBPATDAT",105,0)
 . D FILE^DICN
"RTN","FBPATDAT",106,0)
 ;all other types of auth-tions:
"RTN","FBPATDAT",107,0)
 I $$QMRA^FBSHAUT(FBDFN,FBAUTH,"C")
"RTN","FBPATDAT",108,0)
 Q
"RTN","FBPATDAT",109,0)
 ;
"RTN","FBPATDAT",110,0)
 ;FBPATDAT
"VER")
8.0^22.0
**END**
**END**
