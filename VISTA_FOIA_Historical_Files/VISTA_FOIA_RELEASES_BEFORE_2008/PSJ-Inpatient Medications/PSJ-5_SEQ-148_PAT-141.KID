Released PSJ*5*141 SEQ #148
Extracted from mail message
**KIDS**:PSJ*5.0*141^

**INSTALL NAME**
PSJ*5.0*141
"BLD",6494,0)
PSJ*5.0*141^INPATIENT MEDICATIONS^0^3051115^y
"BLD",6494,1,0)
^^10^10^3051115^
"BLD",6494,1,1,0)
This patch addresses two issues in two Remedy tickets. 
"BLD",6494,1,2,0)
The first issue addressed by this patch arose when the site
"BLD",6494,1,3,0)
used the ATZERO (@0) flag on IV Piggybacks to prevent labels
"BLD",6494,1,4,0)
from printing.  Labels printed despite the flag being set.
"BLD",6494,1,5,0)
 
"BLD",6494,1,6,0)
The second issue involves the wrong provider being displayed
"BLD",6494,1,7,0)
by CPRS and backdoor pharmacy when an order is renewed.  
"BLD",6494,1,8,0)
Currently, CPRS and backdoor pharmacy are still displaying the
"BLD",6494,1,9,0)
original provider.  The sites are expecting to see the 
"BLD",6494,1,10,0)
renewing provider to be displayed.
"BLD",6494,4,0)
^9.64PA^^
"BLD",6494,6)
3^
"BLD",6494,"ABPKG")
n
"BLD",6494,"KRN",0)
^9.67PA^8989.52^19
"BLD",6494,"KRN",.4,0)
.4
"BLD",6494,"KRN",.401,0)
.401
"BLD",6494,"KRN",.402,0)
.402
"BLD",6494,"KRN",.403,0)
.403
"BLD",6494,"KRN",.5,0)
.5
"BLD",6494,"KRN",.84,0)
.84
"BLD",6494,"KRN",3.6,0)
3.6
"BLD",6494,"KRN",3.8,0)
3.8
"BLD",6494,"KRN",9.2,0)
9.2
"BLD",6494,"KRN",9.8,0)
9.8
"BLD",6494,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",6494,"KRN",9.8,"NM",1,0)
PSGOER^^0^72290048
"BLD",6494,"KRN",9.8,"NM",2,0)
PSIVWL^^0^33207502
"BLD",6494,"KRN",9.8,"NM",3,0)
PSJHL2^^0^32582079
"BLD",6494,"KRN",9.8,"NM","B","PSGOER",1)

"BLD",6494,"KRN",9.8,"NM","B","PSIVWL",2)

"BLD",6494,"KRN",9.8,"NM","B","PSJHL2",3)

"BLD",6494,"KRN",19,0)
19
"BLD",6494,"KRN",19,"NM",0)
^9.68A^^
"BLD",6494,"KRN",19.1,0)
19.1
"BLD",6494,"KRN",101,0)
101
"BLD",6494,"KRN",409.61,0)
409.61
"BLD",6494,"KRN",771,0)
771
"BLD",6494,"KRN",870,0)
870
"BLD",6494,"KRN",8989.51,0)
8989.51
"BLD",6494,"KRN",8989.52,0)
8989.52
"BLD",6494,"KRN",8994,0)
8994
"BLD",6494,"KRN","B",.4,.4)

"BLD",6494,"KRN","B",.401,.401)

"BLD",6494,"KRN","B",.402,.402)

"BLD",6494,"KRN","B",.403,.403)

"BLD",6494,"KRN","B",.5,.5)

"BLD",6494,"KRN","B",.84,.84)

"BLD",6494,"KRN","B",3.6,3.6)

"BLD",6494,"KRN","B",3.8,3.8)

"BLD",6494,"KRN","B",9.2,9.2)

"BLD",6494,"KRN","B",9.8,9.8)

"BLD",6494,"KRN","B",19,19)

"BLD",6494,"KRN","B",19.1,19.1)

"BLD",6494,"KRN","B",101,101)

"BLD",6494,"KRN","B",409.61,409.61)

"BLD",6494,"KRN","B",771,771)

"BLD",6494,"KRN","B",870,870)

"BLD",6494,"KRN","B",8989.51,8989.51)

"BLD",6494,"KRN","B",8989.52,8989.52)

"BLD",6494,"KRN","B",8994,8994)

"BLD",6494,"QUES",0)
^9.62^^
"BLD",6494,"REQB",0)
^9.611^3^2
"BLD",6494,"REQB",2,0)
PSJ*5.0*133^1
"BLD",6494,"REQB",3,0)
PSJ*5.0*144^1
"BLD",6494,"REQB","B","PSJ*5.0*133",2)

"BLD",6494,"REQB","B","PSJ*5.0*144",3)

"MBREQ")
0
"PKG",203,-1)
1^1
"PKG",203,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",203,20,0)
^9.402P^^
"PKG",203,22,0)
^9.49I^1^1
"PKG",203,22,1,0)
5.0^2971215^2980417^1271
"PKG",203,22,1,"PAH",1,0)
141^3051115^33234
"PKG",203,22,1,"PAH",1,1,0)
^^10^10^3051115
"PKG",203,22,1,"PAH",1,1,1,0)
This patch addresses two issues in two Remedy tickets. 
"PKG",203,22,1,"PAH",1,1,2,0)
The first issue addressed by this patch arose when the site
"PKG",203,22,1,"PAH",1,1,3,0)
used the ATZERO (@0) flag on IV Piggybacks to prevent labels
"PKG",203,22,1,"PAH",1,1,4,0)
from printing.  Labels printed despite the flag being set.
"PKG",203,22,1,"PAH",1,1,5,0)
 
"PKG",203,22,1,"PAH",1,1,6,0)
The second issue involves the wrong provider being displayed
"PKG",203,22,1,"PAH",1,1,7,0)
by CPRS and backdoor pharmacy when an order is renewed.  
"PKG",203,22,1,"PAH",1,1,8,0)
Currently, CPRS and backdoor pharmacy are still displaying the
"PKG",203,22,1,"PAH",1,1,9,0)
original provider.  The sites are expecting to see the 
"PKG",203,22,1,"PAH",1,1,10,0)
renewing provider to be displayed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSGOER")
0^1^B72290048^B72070079
"RTN","PSGOER",1,0)
PSGOER ;BIR/CML3-RENEW A SINGLE ORDER ;07 MAR 96 / 1:23 PM
"RTN","PSGOER",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**11,30,29,35,70,58,95,110,111,133,141**;16 DEC 97
"RTN","PSGOER",3,0)
 ;
"RTN","PSGOER",4,0)
 ; Reference to ^PS(51.1 supported by DBIA 2177.
"RTN","PSGOER",5,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOER",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOER",7,0)
 ; Reference to ^PSBAPIPM is supported by DBIA 3564.
"RTN","PSGOER",8,0)
 ; Reference to ^PS(59.7 is supported by DBIA 2181.
"RTN","PSGOER",9,0)
 ;
"RTN","PSGOER",10,0)
 ; renew a single order
"RTN","PSGOER",11,0)
 I $G(PSJCOM) D ^PSJCOMR Q
"RTN","PSGOER",12,0)
 N PSJEXPIR S PSJEXPIR=$$EXPIRED(PSGP,PSGORD) I PSJEXPIR D  Q
"RTN","PSGOER",13,0)
 .W !!?3,"  THIS ORDER" W:PSJEXPIR'=2 " HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED",!?8," ADMINISTRATIONS AND"
"RTN","PSGOER",14,0)
 .W " CANNOT BE RENEWED!" D PAUSE^VALM1
"RTN","PSGOER",15,0)
 I $G(PSGSCH)]"",($G(PSGS0XT)="D"),($G(PSGAT)="") D  Q
"RTN","PSGOER",16,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOER",17,0)
 .Q:((",P,R,")[(","_$G(PSGST)_","))
"RTN","PSGOER",18,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!?3,"This order contains a 'DAY OF THE WEEK' schedule without admin times"
"RTN","PSGOER",19,0)
 .W !?11," and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",20,0)
 I $G(PSGSCH)]"",'$$DOW^PSIVUTL(PSGSCH),'$$PRNOK^PSGS0(PSGSCH) I '$D(^PS(51.1,"AC","PSJ",PSGSCH)) D  Q
"RTN","PSGOER",21,0)
 .W !!?3,"This order contains an invalid schedule and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",22,0)
 W !! K DIR S DIR(0)="Y",DIR("A")=$S($P(PSJSYSP0,"^",3):"RENEW THIS ORDER",1:"MARK THIS ORDER FOR RENEWAL"),DIR("B")="YES"
"RTN","PSGOER",23,0)
 S DIR("?")="Answer 'YES' to "_$S($P(PSJSYSP0,"^",3):"renew this order",1:"mark this order for renewal")_".  Answer 'NO' (or '^') to stop now." D ^DIR
"RTN","PSGOER",24,0)
 I '$D(DIRUT),Y D NEW S PSGCANFL=1 D DONE Q
"RTN","PSGOER",25,0)
 I '$D(DIRUT),PSJSYSU S PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I $P(PSGND4,"^",15),$P(PSGND4,"^",16) D UNMARK,DONE Q
"RTN","PSGOER",26,0)
 D DONE,ABORT^PSGOEE
"RTN","PSGOER",27,0)
 Q
"RTN","PSGOER",28,0)
 ;
"RTN","PSGOER",29,0)
UNMARK ;  
"RTN","PSGOER",30,0)
 W !!,"THIS ORDER HAS BEEN 'MARKED FOR RENEWAL'.",! K DIR S DIR(0)="Y",DIR("A")="DO YOU WANT TO 'UNMARK IT'",DIR("B")="NO"
"RTN","PSGOER",31,0)
 S DIR("?",1)="  Answer 'YES' to unmark this order.  Answer 'NO' (or '^') to leave the order",DIR("?")="marked.  (An answer is required.)" D ^DIR
"RTN","PSGOER",32,0)
 I 'Y D ABORT^PSGOEE G DONE
"RTN","PSGOER",33,0)
 S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=21180+PSJSYSU D ^PSGAL5 S $P(PSGND4,"^",15,17)="^^",^PS(55,PSGP,5,DA,4)=PSGND4 W "...DONE!"
"RTN","PSGOER",34,0)
 ;
"RTN","PSGOER",35,0)
DONE ;
"RTN","PSGOER",36,0)
 K %DT,DA,DIE,DIR,DR,FDSD,PSGAL,PSGALR,PSGDL,PSGDLS,PSGFD,PSGFOK,PSGND4,PSGOEE,PSGOER0,PSGOER1,PSGOER2,PSGOERDP,PSGOPR,PSGOSD,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGRD,PSGSD,PSGTOL,PSGTOO,PSGUOW,PSGWLL,RF Q
"RTN","PSGOER",37,0)
 ;
"RTN","PSGOER",38,0)
NEW ; get info, write record
"RTN","PSGOER",39,0)
EXTEND ; extend stop date on renewal order
"RTN","PSGOER",40,0)
 N DUOUT,PSJABT,PSGDRG,PSJREN,PSGOREAS S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^"),PSJREN=1
"RTN","PSGOER",41,0)
 I $G(PSGST)="O" N ACT S ACT=$$EN^PSBAPIPM(PSGP,PSGORD) I $P(ACT,"^",2),($P(ACT,"^",3)="G") I $P(ACT,"^",2)>$P($G(^PS(55,PSGP,5,+PSGORD,2)),"^",2) D  Q
"RTN","PSGOER",42,0)
 . W !!?5,"THIS ONE-TIME ORDER HAS ALREADY BEEN GIVEN AND CANNOT BE RENEWED",! S (DIRUT,PSGORQF)=1 D READ
"RTN","PSGOER",43,0)
 D OC55
"RTN","PSGOER",44,0)
 Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSGOER",45,0)
 D NOW^%DTC S PSGDT=%,PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I '$P(PSJSYSP0,"^",3) D MARK Q
"RTN","PSGOER",46,0)
 S PSGWLL=$S('$P(PSJSYSW0,"^",4):0,1:+$G(^PS(55,PSGP,5.1))),PSGOEE="R" K PSGOEOS
"RTN","PSGOER",47,0)
 K ^PS(53.45,PSJSYSP,1),^(2) D MOVE(3,1),MOVE(1,2)
"RTN","PSGOER",48,0)
 D DATE^PSGOER0(PSGP,PSGORD,PSGDT) I ($G(X)="^")!'$D(PSGFOK(106))!$G(DUOUT) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",49,0)
SPEED ;
"RTN","PSGOER",50,0)
 I +$G(PSJSYSU)=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOER",51,0)
 Q:$G(DUOUT)
"RTN","PSGOER",52,0)
 N PSGOEAV S PSGOEAV=+PSJSYSU
"RTN","PSGOER",53,0)
 W !!,"...updating order..." K DA S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5 W "."
"RTN","PSGOER",54,0)
 I $$LS^PSSLOCK(PSGP,PSGORD) D UPDREN(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO),UPDRENOE(PSGP,PSGORD,PSGDT) D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOER",55,0)
 ;
"RTN","PSGOER",56,0)
 I 'PSGOERDP,$P(PSJSYSW0,"^",4),PSGFD'<PSGWLL S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSGOER",57,0)
 W ".DONE!" S VALMBCK="Q" Q
"RTN","PSGOER",58,0)
 ;
"RTN","PSGOER",59,0)
MARK ;
"RTN","PSGOER",60,0)
 I $P(PSGND4,"^",15),$P(PSGND4,"^",16) W $C(7),!!?3,"...THIS ORDER IS ALREADY MARKED FOR RENEWAL!..." Q
"RTN","PSGOER",61,0)
 K DA S $P(PSGND4,"^",15,17)="1^"_DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=PSGND4,PSGAL("C")=13180,DA(1)=PSGP,DA=+PSGORD W "." D ^PSGAL5
"RTN","PSGOER",62,0)
 I $D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="R",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOER",63,0)
 Q
"RTN","PSGOER",64,0)
MOVE(X,Y) ; Move comments/dispense drugs from 55 to 53.45.
"RTN","PSGOER",65,0)
 S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,X,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,Y,Q,0)=$G(^(Q,0))
"RTN","PSGOER",66,0)
 S:Q ^PS(53.45,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSGOER",67,0)
 Q
"RTN","PSGOER",68,0)
OC55 ;* Order checks for Speed finish and regular finish
"RTN","PSGOER",69,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG
"RTN","PSGOER",70,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOER",71,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,+$G(^PS(55,PSGP,5,+PSGORD,1,1,0)))
"RTN","PSGOER",72,0)
 I '$D(PSGORQF) K PSGORQF,^TMP($J,"DI") D
"RTN","PSGOER",73,0)
 . F PSGDDI=1:0 S PSGDDI=$O(^PS(55,PSGP,5,+PSGORD,1,PSGDDI)) Q:'PSGDDI  S PSJDD=+$G(^PS(55,PSGP,5,+PSGORD,1,PSGDDI,0)) K PSJPDRG D IVSOL^PSGSICHK
"RTN","PSGOER",74,0)
 Q
"RTN","PSGOER",75,0)
UPDREN(PSGORD,RNWDT,PSGOEPR,PSGOFD,PSJNOO,RDUZ) ; update renewed order
"RTN","PSGOER",76,0)
 N DR,DA,DIC,DIE,DD,DO,PSGRZERO,PSGRFOUR,PSGOORD
"RTN","PSGOER",77,0)
 S DR="",PSGOEENO=0,PSGOORD=PSGORD,PSGNESD=PSGSD Q:'PSGORD!'RNWDT!'PSGOEPR!'PSGOFD  S PSJNOO=$S($G(PSJNOO)]"":$G(PSJNOO),1:"E")
"RTN","PSGOER",78,0)
 S PSGRZERO="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGOEORD=$P(@PSGRZERO,"^",21)
"RTN","PSGOER",79,0)
 ; PSJ*5*141 - changed PSGOEPR to PSGPR for field 1 of the DR string below.
"RTN","PSGOER",80,0)
 S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5," S DR="34////^S X=PSGFD" S:$G(PSGPR) DR=DR_";1////"_PSGPR_";110////"_PSJNOO D ^DIE
"RTN","PSGOER",81,0)
 K DR,DA,DIC,DIE,DD,DO S DIC="^PS(55,"_PSGP_",5,"_+PSGORD_",14,",DIC(0)="L",DIC("P")="55.6114DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=PSGP,DA(1)=+PSGORD D
"RTN","PSGOER",82,0)
 . S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$S($G(RDUZ):RDUZ,1:$G(DUZ))_";2////"_$G(PSGOEPR)_";3////"_$G(PSGOFD)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSGOER",83,0)
 K DR,DA,DIC,DIE,DD,DO S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="28////A;105////@;107////@"
"RTN","PSGOER",84,0)
 S PSGRFOUR="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGRFOUR=@PSGRFOUR I $P(PSGRFOUR,"^",2)<RNWDT S DR=DR_";16////@;17////@"
"RTN","PSGOER",85,0)
 I '$G(PSJSPEED) I $G(PSGAT)]"",$G(PSGAT)'=$P($G(@(DIE_+PSGORD_",2)")),"^",5) S DR=DR_";41////"_PSGAT
"RTN","PSGOER",86,0)
 D ^DIE
"RTN","PSGOER",87,0)
 Q
"RTN","PSGOER",88,0)
UPDRENOE(PSGP,PSGORD,RDATE) ;
"RTN","PSGOER",89,0)
 D EXPOE(PSGP,PSGORD,$G(RDATE)) ; expire original Orders File order
"RTN","PSGOER",90,0)
 I PSGORD'["P" K DA,DR,DIE S DA(1)=DFN,DA=+PSGORD,DIE="^PS(55,"_DFN_$S(PSGORD="U":",5,",1:",""IV"","),DR=$S(DIE["IV":110,1:66)_"////@" D ^DIE
"RTN","PSGOER",91,0)
 D ENUDTX^PSJOREN(PSGP,PSGORD,"NR")
"RTN","PSGOER",92,0)
 D EN1^PSJHL2(PSGP,"SN",PSGORD,"ORDER RENEWED")
"RTN","PSGOER",93,0)
 Q
"RTN","PSGOER",94,0)
READ ; hold screen
"RTN","PSGOER",95,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","PSGOER",96,0)
 W !?5,"Press return to continue  " R X:$S($D(DTIME):DTIME,1:300)
"RTN","PSGOER",97,0)
 Q
"RTN","PSGOER",98,0)
EXPOE(DFN,PSJORDER,EXPDT) ; expire old Orders File entry
"RTN","PSGOER",99,0)
 I PSJORDER["P" S FILE="^PS(53.1,"_+PSJORDER_",0)",PSJORDER=$P(@FILE,"^",25)
"RTN","PSGOER",100,0)
 I (PSJORDER'["U"),(PSJORDER'["V") Q
"RTN","PSGOER",101,0)
 N CURDAT D NOW^%DTC S CURDAT=$$DATE2^PSJUTL2(%)
"RTN","PSGOER",102,0)
 S PSJEXPOE=$S($G(EXPDT):EXPDT,1:CURDAT) D EN1^PSJHL2(DFN,"SC",PSJORDER) K PSJEXPOE
"RTN","PSGOER",103,0)
 Q
"RTN","PSGOER",104,0)
EXPIRED(PSJX,PSJY) ;
"RTN","PSGOER",105,0)
 ; INPUT 
"RTN","PSGOER",106,0)
 ;       PSJX - Pharmacy Patient, pointer to ^PS(55
"RTN","PSGOER",107,0)
 ;       PSJY - Inpatient Order Number, pointer to IV or UD multiple of Pharmacy Patient file (appended with "V" or "U")
"RTN","PSGOER",108,0)
 ; OUTPUT
"RTN","PSGOER",109,0)
 ;   0  -  Order has not exceeded the Expired Time Limit 
"RTN","PSGOER",110,0)
 ;   1  -  Order has exceeded the Expired Time Limit
"RTN","PSGOER",111,0)
 N STOP,STATUS,NOW,CUTOFF,FREQ,LAST,ST,X,DFN,U,PSGDT,SD,WD,PSJPSTO,PSGDW,PSGOC,ZZND,LASTAT,LSTSTR,PSBCNT S DFN=PSJX,U="^",CUTOFF=0
"RTN","PSGOER",112,0)
 S STATUS=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,0)),"^",9),PSJY["V":$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",17),1:"")
"RTN","PSGOER",113,0)
 S NOW=$S($G(PSGDT):PSGDT,1:$$DATE^PSJUTL2())
"RTN","PSGOER",114,0)
 S STOP=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,2)),U,4),1:$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",3))
"RTN","PSGOER",115,0)
 I NOW<STOP Q 0
"RTN","PSGOER",116,0)
 I PSJY["U" N ND2,ND0 S ND0=$G(^PS(55,PSJX,5,+PSJY,0)),ND2=$G(^PS(55,PSJX,5,+PSJY,2)),FREQ=$P(ND2,"^",6) D
"RTN","PSGOER",117,0)
 .N SCHED S SCHED=$P($G(^PS(55,PSJX,5,+PSJY,2)),"^") I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED)
"RTN","PSGOER",118,0)
 .S LSTSTR=$P(ND2,"^",2)_"^"_$P(ND2,"^",4)_"^"_SCHED_"^"_$P(ND0,"^",7)_"^^"_$P(ND2,"^",5)
"RTN","PSGOER",119,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,($P(ND0,"^",7)="O"),($P(LAST,"^",3)="G") I LAST>$P(ND2,"^",2) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",120,0)
 .I 'LAST!(LAST>$P(ND2,"^",4)) S LAST=$$LASTAT^PSJORP2(DFN,LSTSTR) S:LAST CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",121,0)
 .I SCHED["PRN",($P(LSTSTR,"^",6)="") S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",122,0)
 .I $$DOW^PSIVUTL(SCHED) S CUTOFF=$$NXTDOW(DFN,$P(LSTSTR,"^"),$P(LSTSTR,"^",2),$P(LSTSTR,"^",3),$P(LSTSTR,"^",6)) Q
"RTN","PSGOER",123,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND2,"^",4)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",124,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,,,FREQ) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",125,0)
 I PSJY["V" N LIMIT S LIMIT=$P($G(^PS(59.7,1,31)),"^",4) S LIMIT=$S((LIMIT]""):+LIMIT,1:24) S CUTOFF=$$FMADD^XLFDT(STOP,,LIMIT) D
"RTN","PSGOER",126,0)
 .I '($G(P(4))]"") N P,YP,XP S YP=$G(^PS(55,DFN,"IV",+PSJY,0)) F XP=1:1:23 S P(XP)=$P(YP,U,XP)
"RTN","PSGOER",127,0)
 .Q:'($G(P(4))]"")
"RTN","PSGOER",128,0)
 .Q:'$$SCHREQ^PSJLIVFD(.P)
"RTN","PSGOER",129,0)
 .N INTERVAL,LSTSTR,ND0,SCHED,IVSTYP S ND0=$G(^PS(55,PSJX,"IV",+PSJY,0)),INTERVAL=$P(ND0,"^",15),SCHED=$P(ND0,"^",9) Q:SCHED=""
"RTN","PSGOER",130,0)
 .S IVSTYP=$S($$DOW^PSIVUTL(SCHED):"D",INTERVAL="O":"O",1:"C"),LSTSTR=$P(ND0,"^",2)_"^"_$P(ND0,"^",3)_"^"_SCHED_"^"_IVSTYP_"^^"_$P(ND0,"^",11)
"RTN","PSGOER",131,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,IVSTYP="O",LAST>$P(ND0,"^",2),($P(LAST,"^",3)="G") S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",132,0)
 .I 'LAST!(LAST>$P(ND0,"^",3))!(LAST&(IVSTYP="O")) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",133,0)
 .I IVSTYP="D" S CUTOFF=$$NXTDOW(LAST,SCHED,$G(P(2)),$P($G(P(9)),"@"),$G(P(11))) Q
"RTN","PSGOER",134,0)
 .I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED) S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",135,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND0,"^",3)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",136,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,31) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",137,0)
 K LYN,PSBDT,PSBFLAG,PSBSTR
"RTN","PSGOER",138,0)
 Q $S(CUTOFF<NOW:1,1:0)
"RTN","PSGOER",139,0)
 ;
"RTN","PSGOER",140,0)
NXTDOW(DOWDFN,DOWSD,DOWFD,DOWSCH,DOWAT) ;
"RTN","PSGOER",141,0)
 N NXTADM,DOWSTR S DOWSTR=$$FMADD^XLFDT(DOWFD,,,,1)_"^"_$$FMADD^XLFDT(DOWFD,7)_"^"_DOWSCH_"^D^^"_DOWAT S NXTADM=$$ENQ^PSJORP2(DOWDFN,DOWSTR)
"RTN","PSGOER",142,0)
 Q $S(NXTADM:NXTADM,1:DOWSD)
"RTN","PSGOER",143,0)
 ;
"RTN","PSGOER",144,0)
PRNFREQ(SCHED) ;
"RTN","PSGOER",145,0)
 N ZZND,D,DA,X,PSGAT,PSGOES,PSGST,PSJNSS,PSJPWD,TEST,VALMBCK,PSGS0XT,PSGS0Y,PSGDT
"RTN","PSGOER",146,0)
 F X=$P(SCHED,"PRN"),$P(SCHED,"PRN",2),$P(SCHED," PRN"),$P(SCHED,"PRN ",2) Q:$P($G(ZZND),"^",4)  D ADMIN^PSJORPOE
"RTN","PSGOER",147,0)
 Q $S($G(PSGS0XT):PSGS0XT,1:1440)
"RTN","PSIVWL")
0^2^B33207502^B32855058
"RTN","PSIVWL",1,0)
PSIVWL ;BIR/RGY,PR-COMPILE AND PRT WARD LIST ;13 MAR 97 / 10:18 AM
"RTN","PSIVWL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**41,54,74,84,93,110,111,141**;16 DEC 97
"RTN","PSIVWL",3,0)
 ;
"RTN","PSIVWL",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177
"RTN","PSIVWL",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVWL",6,0)
 ;
"RTN","PSIVWL",7,0)
 K WRD W !!,"Run ward list for DATE: TODAY//" R X:DTIME S:'$T X="^" S:X="" X="T" G Q:X["^" K %DT S %DT="XE" D ^%DT G:Y<0 PSIVWL
"RTN","PSIVWL",8,0)
 S PSIVDT=Y\1 I Y<DT D ENRSET^PSIVWL1 G PSIVWL
"RTN","PSIVWL",9,0)
 D ^PSIVWL1 I '$D(PSIVOD)!('$D(PSIVCD)) G Q
"RTN","PSIVWL",10,0)
 I PSIVPR'=ION D QUE G Q
"RTN","PSIVWL",11,0)
DEQ ;
"RTN","PSIVWL",12,0)
 N PSJOK
"RTN","PSIVWL",13,0)
 D NOW^%DTC S Y=% L +^PS(55,"PSIVWL",PSIVSN):1 E  W:$Y @IOF W !!,"**** WARNING --- WARD LIST NOT RUN, LABEL RUN IN PROGRESS ****" G Q
"RTN","PSIVWL",14,0)
 D:$D(XRTL) T0^%ZOSV S NOFLG=0
"RTN","PSIVWL",15,0)
 S PSIVT="" D ENINIT^PSIVWL1 F PSIV1=0:0 S PSIVT=$O(PSIVOD(PSIVT)) Q:PSIVT=""  S PSIVDT1=PSIVOD(PSIVT)-.0001 F PSIV1=0:0 S PSIVDT1=$O(^PS(55,"AIV",PSIVDT1)) Q:'PSIVDT1  D MAN1
"RTN","PSIVWL",16,0)
 I $D(XRTL) S XRTN="PSIVWL" D T1^%ZOSV
"RTN","PSIVWL",17,0)
 D ENT^PSIVWL1
"RTN","PSIVWL",18,0)
Q L -^PS(55,"PSIVWL",PSIVSN) W:'$D(PSIVPR)&($Y) @IOF K MI,ON,NOFLG,PSCT,PSGCNT,PSGSA,PSIVMT,DIC,PSIVRUN,%DT,PSIVDT1,PSIVDT,PSIV,PSIVOD
"RTN","PSIVWL",19,0)
 K PSIVCD,PSM,%T,D,DFN,I,P,PSIV1,VAERR,X,Y,Z,Z1,Z2,ZTSK S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSIVWL",20,0)
 Q
"RTN","PSIVWL",21,0)
SETP S Y=^PS(55,DFN,"IV",ON,0) F X=1:1:23 S P(X)=$P(Y,"^",X)
"RTN","PSIVWL",22,0)
 N A,PSJST
"RTN","PSIVWL",23,0)
 S PSJST=$$ONE^PSJBCMA(DFN,ON,P(9))
"RTN","PSIVWL",24,0)
 S PSJOK=1 I PSJST="O" S A=0 F  S A=$O(^PS(55,DFN,"IV",+ON,"LAB",A)) Q:A=""  I $P($G(^(A,0)),"^",3)=1 S PSJOK=0 Q
"RTN","PSIVWL",25,0)
 Q
"RTN","PSIVWL",26,0)
MAN1 F DFN=0:0 S DFN=$O(^PS(55,"AIV",PSIVDT1,DFN)) Q:'DFN  S PSIV("NME")=$P($G(^DPT(DFN,0)),U) D INP^VADPT F ON=0:0 S ON=$O(^PS(55,"AIV",PSIVDT1,DFN,ON)) Q:'ON  Q:NOFLG=1  D SETP I PSJOK D MAN3
"RTN","PSIVWL",27,0)
 Q
"RTN","PSIVWL",28,0)
MAN2 S ^PS(55,"PSIVWL",PSIVSN,$S($P(VAIN(4),U,2)]"":$P(VAIN(4),U,2),1:"Outpatient IV"),P(4)_PSIVOD(P(4)),DFN,ON)=$S($P(P(8),"@",2)'=0:PSGCNT,1:0)_"^"_PSGSA_"^"_$P(^PS(55,DFN,"IV",ON,0),"^",16)
"RTN","PSIVWL",29,0)
 ;naked reference on line below refers to full global reference to right of = sign
"RTN","PSIVWL",30,0)
 S $P(^(0),"^",16)=$P(^PS(55,DFN,"IV",ON,0),"^",16)+PSGCNT Q
"RTN","PSIVWL",31,0)
 Q
"RTN","PSIVWL",32,0)
MAN3 ;I P(4)=""!(P(4)'=PSIVT) S NOFLG=1 D NOW^%DTC S PSIVRUN=$E(%,1,12) K %,%I,%H D HDR^PSIVWL1 W !!,"****NO DATA FOUND FOR THIS REPORT!***" Q
"RTN","PSIVWL",33,0)
 Q:P(4)=""!(P(4)'=PSIVT)
"RTN","PSIVWL",34,0)
 Q:'$D(PSIVOD(P(4)))!("DPN"[P(17))!($S($D(^PS(55,DFN,"IV",ON,2)):PSIVSN'=$P(^(2),"^",2),1:0))
"RTN","PSIVWL",35,0)
 I "OH"[P(17) S PSGSA="",PSGCNT=0 D MAN2 Q
"RTN","PSIVWL",36,0)
 S CD=$S(PSIVCD(PSIVT)<P(3):PSIVCD(PSIVT),1:P(3)),OD=$S(P(2)>PSIVOD(PSIVT):P(2),1:PSIVOD(PSIVT)) D ENP3,MAN2 Q
"RTN","PSIVWL",37,0)
QUE S ZTIO=PSIVPR,ZTDESC="IV WARD LIST",ZTRTN="DEQ^PSIVWL",PSIVT="" F I=0:0 S PSIVT=$O(PSIVMT(PSIVT)) Q:PSIVT=""  S (ZTSAVE("PSIVCD("""_PSIVT_""")"),ZTSAVE("PSIVMT("""_PSIVT_""")"),ZTSAVE("PSIVOD("""_PSIVT_""")"))=""
"RTN","PSIVWL",38,0)
 F X="PSIVSN","PSIVDT","PSIVSITE","PSJSYSW0","PSJSYSP0","PSJSYSU" S ZTSAVE(X)=""
"RTN","PSIVWL",39,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"Queued." Q
"RTN","PSIVWL",40,0)
ENP3 ;
"RTN","PSIVWL",41,0)
 ;Needs DFN,ON P-array, OD and CD
"RTN","PSIVWL",42,0)
 Q:'P(2)!'P(3)  S PSIVMI=P(15),PSIVSD=P(2),PSGSA="",PSGCNT=0 S:PSIVMI>1440 P(11)=""
"RTN","PSIVWL",43,0)
 I P(11) G:"AH"[P(4) QSP F X="STAT","ONCE","NOW","ONE-TIME","ONE TIME","ONETIME","1-TIME","1 TIME","1-TIME" I $S(X=P(9):1,1:(P(9)[X)),PSIVSD'<OD,PSIVSD'>CD S PSGSA=PSIVSD_" " G QSP
"RTN","PSIVWL",44,0)
 I P(4)="P"!(P(5))!(P(23)="P"),P(11) D CHK,ENP4 G QSP
"RTN","PSIVWL",45,0)
 G:P(11) QSP I PSIVMI,OD\1>(PSIVSD\1) S X1=OD,X2=PSIVSD D ^%DTC I X>1 S X=X-1,PSIVMIN=X*1440\PSIVMI*PSIVMI D ENT S PSIVSD=Y
"RTN","PSIVWL",46,0)
 I PSIVSD'<OD,PSIVSD<CD S Y=PSIVSD,PSGSA=Y_" "
"RTN","PSIVWL",47,0)
 I PSIVMI F X=0:0 S PSIVMIN=PSIVMI D ENT Q:Y>CD!(Y=CD&(CD=P(3)))  S PSIVSD=Y I Y'<OD,Y'>CD S:$L(PSGSA)+$L(Y)'>240 PSGSA=PSGSA_$S(PSGSA'="":"."_$P(Y,".",2),1:Y)_" "
"RTN","PSIVWL",48,0)
QSP S PSGCNT=$L(PSGSA," ")-1 K PSIVMI,OD,CD,PSIVSD S:P(7)=1 PSGCNT=0 Q  ;PSJ*5*141 Add P(7) check
"RTN","PSIVWL",49,0)
CHK F Y=1:1 Q:$L(P(11))>240!($P(P(11),"-",Y)="")  S $P(P(11),"-",Y)=$P(P(11),"-",Y)_$E("0000",1,4-$L($P(P(11),"-",Y)))
"RTN","PSIVWL",50,0)
 Q
"RTN","PSIVWL",51,0)
ENP4 Q:PSIVSD>CD  S PSIVSD=OD\1 I $G(P(2)),PSIVSD<P(2) S PSIVSD=P(2)\1
"RTN","PSIVWL",52,0)
 NEW ODCDWD,ADM,ADMSD,ADMTM,PSIVX,P9
"RTN","PSIVWL",53,0)
 F X=OD,CD D DW^%DTC S ODCDWD=$G(ODCDWD)_$E(X,1,3)_U
"RTN","PSIVWL",54,0)
 I +$O(^PS(51.1,"APPSJ",P(9),0)) S PSIVX=1 S P9=$P(P(9),"@") F X=1:1:$L(P9,"-") D  Q:'$G(PSIVX)
"RTN","PSIVWL",55,0)
 . I '("MON,TUE,WED,THU,FRI,SAT,SUN,"[$P(P9,"-",X)) S PSIVX=0 Q
"RTN","PSIVWL",56,0)
 . I ODCDWD[$E($P(P9,"-",X),1,2) D
"RTN","PSIVWL",57,0)
 .. S ADMSD=$S($P(ODCDWD,"^")[$P(P9,"-",X):OD,1:CD)\1
"RTN","PSIVWL",58,0)
 .. F ADM=1:1:$L(P(11),"-") S ADMTM=$P(P(11),"-",ADM) I OD'>(ADMSD_"."_ADMTM),(CD'<(ADMSD_"."_ADMTM)) S PSGSA=PSGSA_$S(PSGSA'="":"",1:ADMSD)_"."_ADMTM_" "
"RTN","PSIVWL",59,0)
 .. ;F ADM=1:1:$L(P(11),"-") S ADMTM=$P(P(11),"-",ADM) I OD'>(ADMSD_"."_ADMTM),(CD'<(ADMSD_"."_ADMTM)) S PSGSA=PSGSA_$S(PSGSA'="":"",1:PSIVSD)_"."_ADMTM_" "
"RTN","PSIVWL",60,0)
 Q:+$G(PSIVX)
"RTN","PSIVWL",61,0)
 I '$D(^PS(51.1,"APPSJ",P(9))) S PSIVX=1,P9=$P(P(9),"@") F X=1:1:$L(P9,"-") D  Q:'$G(PSIVX)
"RTN","PSIVWL",62,0)
 . I '(",MO,TU,WE,TH,FR,SA,SU,"[(","_$P(P9,"-",X)_",")) S PSIVX=0 Q
"RTN","PSIVWL",63,0)
 . I ODCDWD[$E($P(P9,"-",X),1,2) D
"RTN","PSIVWL",64,0)
 .. S ADMSD=$S($P(ODCDWD,"^")[$P(P9,"-",X):OD,1:CD)\1
"RTN","PSIVWL",65,0)
 .. F ADM=1:1:$L(P(11),"-") S ADMTM=$P(P(11),"-",ADM) I OD'>(ADMSD_"."_ADMTM),(CD'<(ADMSD_"."_ADMTM)) S PSGSA=PSGSA_$S(PSGSA'="":"",1:ADMSD)_"."_ADMTM_" "
"RTN","PSIVWL",66,0)
 .. ;F ADM=1:1:$L(P(11),"-") S ADMTM=$P(P(11),"-",ADM) I OD'>(ADMSD_"."_ADMTM),(CD'<(ADMSD_"."_ADMTM)) S PSGSA=PSGSA_$S(PSGSA'="":"",1:PSIVSD)_"."_ADMTM_" "
"RTN","PSIVWL",67,0)
 Q:+$G(PSIVX)
"RTN","PSIVWL",68,0)
 F Y=1:1 S (PSIVMI,MI)=$P(P(11),"-",Y),PSIVSD=+(PSIVSD\1_"."_MI) Q:PSIVSD>CD  X:MI="" "S X1=PSIVSD,X2=1 D C^%DTC S PSIVSD=X,Y=0" I MI,PSIVSD'<OD,PSIVSD'>CD,PSIVSD'=P(3),'P(7) S PSGSA=PSGSA_$S(PSGSA'="":"."_$P(PSIVSD,".",2),1:PSIVSD)_" "
"RTN","PSIVWL",69,0)
 ; INSTALL PRECEEDING LINE WITH VERSION 17.3 OF FILEMAN
"RTN","PSIVWL",70,0)
 Q
"RTN","PSIVWL",71,0)
ENT ;PSIVMIN=# of min. to add or sub, PSIVSD=date to add or sub from in FM format -- Answer ret. in 'Y'
"RTN","PSIVWL",72,0)
 S X2=PSIVMIN\1440,HOUR=(PSIVMIN-(1440*X2))\60,MIN=(PSIVMIN-(1440*X2)-(60*HOUR))#$S(PSIVMIN<0:-60,1:60),X1=PSIVSD\1,HR=$E(PSIVSD,9,10),MI=$E(PSIVSD,11,12)
"RTN","PSIVWL",73,0)
 S:$L(HR)=1 HR=HR_0 S:$L(MI)=1 MI=MI_0 S MI=MI+MIN S:MI>59 MI=MI-60,HR=HR+1
"RTN","PSIVWL",74,0)
 S:MI<0 MI=MI+60,HR=HR-1 S HR=HR+HOUR S:HR>23 HR=HR-24,X2=X2+1 S:HR<0 HR=HR+24,X2=X2-1 S:HR+MI=0 X2=X2-1,HR=24,MI=0 S:HR<10 HR=0_HR S:MI<10 MI=0_MI S X=X1 D:X2 C^%DTC S X=$P(X,".") S Y=+(X_"."_HR_MI)
"RTN","PSIVWL",75,0)
 ; install with version 17.3 of fm
"RTN","PSIVWL",76,0)
 K HR,MI,X1,X2,HOUR,MIN,PSIVMIN,O,MI Q
"RTN","PSJHL2")
0^3^B32582079^B31715034
"RTN","PSJHL2",1,0)
PSJHL2 ;BIR/RLW-PATIENT ID AND VISIT SEGMENTS ;22 Nov 1999  9:27 AM
"RTN","PSJHL2",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**1,18,16,23,28,42,50,70,58,100,102,110,111,112,144,141**;16 DEC 97
"RTN","PSJHL2",3,0)
 ;
"RTN","PSJHL2",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL2",5,0)
 ; Reference to ^ORERR is supported by DBIA# 2187.
"RTN","PSJHL2",6,0)
 ;
"RTN","PSJHL2",7,0)
EN1(PSJHLDFN,PSOC,PSJORDER,PSREASON) ; start here
"RTN","PSJHL2",8,0)
 ; passed in are PSJHLDFN (patient ien)
"RTN","PSJHL2",9,0)
 ;               PSJORDER* (order_file (N,P,V, etc))
"RTN","PSJHL2",10,0)
 ;               PSOC* (order control code - NW for new order, OK to return filler number to OE/RR, OC for order canceled, SC for status change)
"RTN","PSJHL2",11,0)
 ;               PSREASON* (text reason)
"RTN","PSJHL2",12,0)
 ; *=optional, only required if an order segment is also to be generated
"RTN","PSJHL2",13,0)
START ;
"RTN","PSJHL2",14,0)
 K ^TMP("PSJHLS",$J,"PS")
"RTN","PSJHL2",15,0)
 N CLERK,J,LIMIT,NAME,NEXT,NODE1,NODE2,NODE4,NOO,PSJCLEAR,PSJHINST,PSJHLSDT,PROVIDER,PSJI,ROOMBED,RXORDER,STATUS,UNDO,VERIFY,WARD
"RTN","PSJHL2",16,0)
 S RXORDER=PSJORDER,PSJORDER=$S((PSJORDER["N")!(PSJORDER["P"):"^PS(53.1,"_+PSJORDER,PSJORDER["V":"^PS(55,"_PSJHLDFN_",""IV"","_+PSJORDER,1:"^PS(55,"_PSJHLDFN_",5,"_+PSJORDER)_","
"RTN","PSJHL2",17,0)
 I RXORDER["P",$P($G(@(PSJORDER_"0)")),U,15)'=PSJHLDFN S ORDCON="Patient does not match/PSJHL2" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON) Q
"RTN","PSJHL2",18,0)
 S UNDO=$S("OC^CR"[PSOC:1,1:0)
"RTN","PSJHL2",19,0)
 D INIT,PID,PV1,ORC
"RTN","PSJHL2",20,0)
 D @$S("SN^SC^OC^OD^DR^CR^OH^OR^XX^ZC^XR"[PSOC:"EN1^PSJHL3(PSJHLDFN,PSOC,PSJORDER)",1:"CALL^PSJHLU(PSJI)")
"RTN","PSJHL2",21,0)
 I UNDO D UNDO
"RTN","PSJHL2",22,0)
 K ^TMP("PSJHLS",$J,"PS"),FIELD
"RTN","PSJHL2",23,0)
 Q
"RTN","PSJHL2",24,0)
 ;
"RTN","PSJHL2",25,0)
INIT ; initialize HL7 variables, set master file identification segment
"RTN","PSJHL2",26,0)
 ; PSJHLMTN = message type - ORR for messages sent as a response to an OE/RR event; ORM for "unsolicited" messages.
"RTN","PSJHL2",27,0)
 S PSJI=0,PSJHLMTN=$S($G(PSJHLMTN)]"":PSJHLMTN,1:"ORM")
"RTN","PSJHL2",28,0)
 D INIT^PSJHLU
"RTN","PSJHL2",29,0)
 S LIMIT=17 X PSJCLEAR
"RTN","PSJHL2",30,0)
 S FIELD(0)="MSH",FIELD(1)="^~\&",FIELD(2)="PHARMACY",FIELD(3)=$G(PSJHINST),FIELD(8)=PSJHLMTN
"RTN","PSJHL2",31,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",32,0)
 Q
"RTN","PSJHL2",33,0)
 ;
"RTN","PSJHL2",34,0)
PID ; get patient data, format PID SEGMENT
"RTN","PSJHL2",35,0)
 S LIMIT=22 X PSJCLEAR
"RTN","PSJHL2",36,0)
 S FIELD(0)="PID"
"RTN","PSJHL2",37,0)
 S FIELD(3)=PSJHLDFN
"RTN","PSJHL2",38,0)
 N DFN S DFN=PSJHLDFN D DEM^VADPT S FIELD(5)=VADM(1)
"RTN","PSJHL2",39,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",40,0)
 Q
"RTN","PSJHL2",41,0)
 ;
"RTN","PSJHL2",42,0)
PV1 ; get patient visit information, format PV1 segment
"RTN","PSJHL2",43,0)
 N PSJAPPT
"RTN","PSJHL2",44,0)
 S LIMIT=50 X PSJCLEAR
"RTN","PSJHL2",45,0)
 S FIELD(0)="PV1"
"RTN","PSJHL2",46,0)
 I PSJHLMTN="ORR" S FIELD(3)=LOC
"RTN","PSJHL2",47,0)
 I PSJHLMTN="ORM" D
"RTN","PSJHL2",48,0)
 .S LOC="",WARD=$G(^DPT(PSJHLDFN,.1)),LOC=$S($G(WARD)]"":$O(^SC("B",WARD,LOC)),1:LOC)
"RTN","PSJHL2",49,0)
 .I $G(LOC)="" D
"RTN","PSJHL2",50,0)
 .. N A
"RTN","PSJHL2",51,0)
 .. I RXORDER["P",($G(^PS(53.1,+RXORDER,"DSS"))) S A=^("DSS"),LOC=$P(A,"^"),PSJAPPT=$P(A,"^",2)
"RTN","PSJHL2",52,0)
 .. I RXORDER["V",($G(^PS(55,PSJHLDFN,"IV",+RXORDER,"DSS"))) S A=^("DSS"),LOC=$P(A,"^"),PSJAPPT=$P(A,"^",2)
"RTN","PSJHL2",53,0)
 .. I RXORDER["U",$G(^PS(55,PSJHLDFN,5,+RXORDER,8)) S A=^(8),LOC=$P(A,"^"),PSJAPPT=$P(A,"^",2)
"RTN","PSJHL2",54,0)
 .I $G(LOC)]"" S ROOMBED=$G(^DPT(PSJHLDFN,.101)),LOC=LOC_"^"_ROOMBED
"RTN","PSJHL2",55,0)
 .S FIELD(3)=LOC I $G(PSJAPPT)]"" S FIELD(44)=$$FMTHL7^XLFDT(PSJAPPT)
"RTN","PSJHL2",56,0)
 S FIELD(2)=$S($G(CLASS)="O":CLASS,1:"I")
"RTN","PSJHL2",57,0)
 I FIELD(2)="I" N DFN S DFN=PSJHLDFN D INP^VADPT S FIELD(19)=VAIN(1)
"RTN","PSJHL2",58,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",59,0)
 Q
"RTN","PSJHL2",60,0)
 ;
"RTN","PSJHL2",61,0)
ORC ; order control segment
"RTN","PSJHL2",62,0)
 S LIMIT=18 X PSJCLEAR
"RTN","PSJHL2",63,0)
 Q:'$D(PSJORDER)!'$D(PSOC)
"RTN","PSJHL2",64,0)
 S NODE1=$G(@(PSJORDER_"0)")),NODE2=$G(@(PSJORDER_"2)"))
"RTN","PSJHL2",65,0)
 S NODE4=$G(@(PSJORDER_"4)"))
"RTN","PSJHL2",66,0)
 S FIELD(0)="ORC"
"RTN","PSJHL2",67,0)
 S FIELD(1)=PSOC
"RTN","PSJHL2",68,0)
 S FIELD(2)=$S(PSOC="SN":"",1:$P(NODE1,"^",21))_"^OR" I $P(FIELD(2),"^")=0 S $P(FIELD(2),"^")="" ; IV orders are created with a zero in the oerr order number, for some reason
"RTN","PSJHL2",69,0)
 S FIELD(3)=RXORDER_"^PS"
"RTN","PSJHL2",70,0)
 ; translate Pharmacy status code to HL7 status code, set in FIELD(5)
"RTN","PSJHL2",71,0)
 S STATUS=$S($G(PSJEXPOE):"E",(($P(NODE1,"^",17)]"")&(RXORDER["V")):($P(NODE1,"^",17)),($P(NODE1,"^",9)]""):$P(NODE1,"^",9),$G(PSIVCOPY):"DE",1:"")
"RTN","PSJHL2",72,0)
 ;BHW;Remedy HD0000000086717;If the order has a pending number, send pending status even if current status is Active.
"RTN","PSJHL2",73,0)
 I STATUS="A",RXORDER["P" S STATUS="N" D @STATUS S STATUS="A"
"RTN","PSJHL2",74,0)
 E  D @STATUS
"RTN","PSJHL2",75,0)
 I STATUS="U",RXORDER["P" S FIELD(3)="^PS"
"RTN","PSJHL2",76,0)
 S FIELD(9)=$S(RXORDER["V":$$FMTHL7^XLFDT($P(NODE2,"^")),1:$$FMTHL7^XLFDT($P(NODE1,"^",16)))
"RTN","PSJHL2",77,0)
 S CLERK=$S(RXORDER["V":$P(NODE2,"^",11),1:$P(NODE4,"^",7))
"RTN","PSJHL2",78,0)
 S NAME=$P($G(^VA(200,+CLERK,0)),"^")
"RTN","PSJHL2",79,0)
 S FIELD(10)=CLERK_"^"_NAME
"RTN","PSJHL2",80,0)
 I PSOC="ZV"!($G(PSJBCBU)) S VERIFY=$P($G(NODE4),"^"),FIELD(11)=VERIFY_"^"_$P($G(^VA(200,+VERIFY,0)),"^"),FIELD(9)=$$FMTHL7^XLFDT($P(NODE4,"^",2))
"RTN","PSJHL2",81,0)
 S PROVIDER=$S($G(PSJDCPRV)]"":$G(PSJDCPRV),RXORDER["V":$P(NODE1,"^",6),1:$P(NODE1,"^",2)) K PSJDCPRV
"RTN","PSJHL2",82,0)
 S NAME=$P($G(^VA(200,+PROVIDER,0)),"^")
"RTN","PSJHL2",83,0)
 S FIELD(12)=PROVIDER_"^"_NAME
"RTN","PSJHL2",84,0)
 S FIELD(15)=$S(RXORDER["V":$$FMTHL7^XLFDT($P(NODE1,"^",2)),1:$$FMTHL7^XLFDT($P(NODE2,"^",2)))
"RTN","PSJHL2",85,0)
 I $S(RXORDER["V":$P(NODE2,"^",8)="R",1:$P(NODE1,"^",24)="R")
"RTN","PSJHL2",86,0)
 ; PSJ*5*141 - If this is a renewal order, update FIELD(10) with the person who entered the renewal order.
"RTN","PSJHL2",87,0)
 N FIELD9 S FIELD9=$$FMTHL7^XLFDT($$LASTREN^PSJLMPRI(PSJHLDFN,RXORDER)) I FIELD9>FIELD(9) S FIELD(9)=FIELD9,FIELD(15)=FIELD9,FIELD(10)=$$LASTRNBY^PSJLMPRI(PSJHLDFN,RXORDER)
"RTN","PSJHL2",88,0)
 S NOO=$S(PSJORDER["IV":$G(P("NAT")),(($G(PSJNOO)="")&($G(P("NAT"))]"")):$G(P("NAT")),1:$G(PSJNOO)),PSREASON=$S(NOO="D":"",1:$G(PSREASON))
"RTN","PSJHL2",89,0)
 S FIELD(16)=NOO_U_$S(NOO="P":"Telephoned",NOO="D":"Duplicate",NOO="X":"Rejected",NOO="A":"Auto",NOO="S":"Service Correction",NOO="W":"Written",NOO="V":"Verbal",NOO="E":"Physician Entered",NOO="I":"Policy",1:"")_U_"99ORN"_U_U_$G(PSREASON)_U
"RTN","PSJHL2",90,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",91,0)
 Q
"RTN","PSJHL2",92,0)
 ;
"RTN","PSJHL2",93,0)
DISPLAY ; just for testing
"RTN","PSJHL2",94,0)
 I $G(MSGTEST) W ! F NEXT=0:1:LIMIT W FIELD(NEXT)_"|"
"RTN","PSJHL2",95,0)
 Q
"RTN","PSJHL2",96,0)
UNDO ;Undo Renew if Pending Renewal is dc'd
"RTN","PSJHL2",97,0)
 I RXORDER["P",(STATUS="D"),($G(PSJNOO)'="A"),($P(NODE1,U,24)="R") D ENBKOUT^PSJOREN(PSJHLDFN,RXORDER)
"RTN","PSJHL2",98,0)
 Q
"RTN","PSJHL2",99,0)
 ;
"RTN","PSJHL2",100,0)
A S FIELD(5)="CM" Q  ; active
"RTN","PSJHL2",101,0)
D S FIELD(5)="DC" Q  ; discontinued
"RTN","PSJHL2",102,0)
I S FIELD(5)="IP" Q  ; incomplete
"RTN","PSJHL2",103,0)
N S FIELD(5)="IP" Q  ; non-verified
"RTN","PSJHL2",104,0)
U S FIELD(5)="ZX" Q  ; unreleased
"RTN","PSJHL2",105,0)
P S FIELD(5)="IP" Q  ; pending
"RTN","PSJHL2",106,0)
DE S FIELD(5)="RP" Q  ; discontinued (edit)
"RTN","PSJHL2",107,0)
E S FIELD(5)="ZE" Q  ; expired
"RTN","PSJHL2",108,0)
H S FIELD(5)="HD" Q  ; hold
"RTN","PSJHL2",109,0)
R S FIELD(5)="ZZ" Q  ; renewed
"RTN","PSJHL2",110,0)
RE S FIELD(5)="CM" Q  ; reinstated
"RTN","PSJHL2",111,0)
DR S FIELD(5)="DC" Q  ; discontinued (renewal)
"RTN","PSJHL2",112,0)
O S FIELD(5)="HD" Q  ; on call (is this kind of like HOLD?)
"VER")
8.0^22.0
"BLD",6494,6)
^148
**END**
**END**
