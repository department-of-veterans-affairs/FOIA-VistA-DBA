Released DVBA*2.7*100 SEQ #96
Extracted from mail message
**KIDS**:DVBA*2.7*100^

**INSTALL NAME**
DVBA*2.7*100
"BLD",5639,0)
DVBA*2.7*100^AUTOMATED MED INFO EXCHANGE^0^3060209^y
"BLD",5639,1,0)
^^9^9^3060209^
"BLD",5639,1,1,0)
This patch corrects two issues:
"BLD",5639,1,2,0)
 
"BLD",5639,1,3,0)
      1. The CAPRI GUI version of the "BATCH 2507 REPRINT" will produce a
"BLD",5639,1,4,0)
         "No data found for requested report criteria." message, while the
"BLD",5639,1,5,0)
         AMIE version produces the correct results.
"BLD",5639,1,6,0)
 
"BLD",5639,1,7,0)
      2. The CAPRI GUI version of the "Discharge Report" will produce a
"BLD",5639,1,8,0)
         "No data found for requested report criteria." message, while the
"BLD",5639,1,9,0)
         AMIE version produces the correct results.
"BLD",5639,4,0)
^9.64PA^^
"BLD",5639,"KRN",0)
^9.67PA^8989.52^19
"BLD",5639,"KRN",.4,0)
.4
"BLD",5639,"KRN",.401,0)
.401
"BLD",5639,"KRN",.402,0)
.402
"BLD",5639,"KRN",.403,0)
.403
"BLD",5639,"KRN",.5,0)
.5
"BLD",5639,"KRN",.84,0)
.84
"BLD",5639,"KRN",3.6,0)
3.6
"BLD",5639,"KRN",3.8,0)
3.8
"BLD",5639,"KRN",9.2,0)
9.2
"BLD",5639,"KRN",9.8,0)
9.8
"BLD",5639,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5639,"KRN",9.8,"NM",1,0)
DVBAB82^^0^B72604404
"BLD",5639,"KRN",9.8,"NM",2,0)
DVBAB53^^0^B21492687
"BLD",5639,"KRN",9.8,"NM","B","DVBAB53",2)

"BLD",5639,"KRN",9.8,"NM","B","DVBAB82",1)

"BLD",5639,"KRN",19,0)
19
"BLD",5639,"KRN",19.1,0)
19.1
"BLD",5639,"KRN",101,0)
101
"BLD",5639,"KRN",409.61,0)
409.61
"BLD",5639,"KRN",771,0)
771
"BLD",5639,"KRN",870,0)
870
"BLD",5639,"KRN",8989.51,0)
8989.51
"BLD",5639,"KRN",8989.52,0)
8989.52
"BLD",5639,"KRN",8994,0)
8994
"BLD",5639,"KRN","B",.4,.4)

"BLD",5639,"KRN","B",.401,.401)

"BLD",5639,"KRN","B",.402,.402)

"BLD",5639,"KRN","B",.403,.403)

"BLD",5639,"KRN","B",.5,.5)

"BLD",5639,"KRN","B",.84,.84)

"BLD",5639,"KRN","B",3.6,3.6)

"BLD",5639,"KRN","B",3.8,3.8)

"BLD",5639,"KRN","B",9.2,9.2)

"BLD",5639,"KRN","B",9.8,9.8)

"BLD",5639,"KRN","B",19,19)

"BLD",5639,"KRN","B",19.1,19.1)

"BLD",5639,"KRN","B",101,101)

"BLD",5639,"KRN","B",409.61,409.61)

"BLD",5639,"KRN","B",771,771)

"BLD",5639,"KRN","B",870,870)

"BLD",5639,"KRN","B",8989.51,8989.51)

"BLD",5639,"KRN","B",8989.52,8989.52)

"BLD",5639,"KRN","B",8994,8994)

"BLD",5639,"QUES",0)
^9.62^^
"BLD",5639,"REQB",0)
^9.611^2^2
"BLD",5639,"REQB",1,0)
DVBA*2.7*90^1
"BLD",5639,"REQB",2,0)
DVBA*2.7*99^1
"BLD",5639,"REQB","B","DVBA*2.7*90",1)

"BLD",5639,"REQB","B","DVBA*2.7*99",2)

"MBREQ")
0
"PKG",223,-1)
1^1
"PKG",223,0)
AUTOMATED MED INFO EXCHANGE^DVBA^The entire AMIE package 7131/2507.
"PKG",223,20,0)
^9.402P^^
"PKG",223,22,0)
^9.49I^1^1
"PKG",223,22,1,0)
2.7^2950410^3010328
"PKG",223,22,1,"PAH",1,0)
100^3060209
"PKG",223,22,1,"PAH",1,1,0)
^^9^9^3060209
"PKG",223,22,1,"PAH",1,1,1,0)
This patch corrects two issues:
"PKG",223,22,1,"PAH",1,1,2,0)
 
"PKG",223,22,1,"PAH",1,1,3,0)
      1. The CAPRI GUI version of the "BATCH 2507 REPRINT" will produce a
"PKG",223,22,1,"PAH",1,1,4,0)
         "No data found for requested report criteria." message, while the
"PKG",223,22,1,"PAH",1,1,5,0)
         AMIE version produces the correct results.
"PKG",223,22,1,"PAH",1,1,6,0)
 
"PKG",223,22,1,"PAH",1,1,7,0)
      2. The CAPRI GUI version of the "Discharge Report" will produce a
"PKG",223,22,1,"PAH",1,1,8,0)
         "No data found for requested report criteria." message, while the
"PKG",223,22,1,"PAH",1,1,9,0)
         AMIE version produces the correct results.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DVBAB53")
0^2^B21492687^B21597257
"RTN","DVBAB53",1,0)
DVBAB53 ;ALB/SPH - CAPRI DISCHARGE REPORT ; 20 Jul 2005  3:39 PM
"RTN","DVBAB53",2,0)
 ;;2.7;AMIE;**35,99,100**;Apr 10, 1995
"RTN","DVBAB53",3,0)
 ;
"RTN","DVBAB53",4,0)
STRT(ZMSG,BDATE,EDATE,ADTYPE)    ;
"RTN","DVBAB53",5,0)
 I BDATE'["." S BDATE=BDATE-.0001   ; DVBA*2.7*99
"RTN","DVBAB53",6,0)
 S DVBABCNT=0
"RTN","DVBAB53",7,0)
 S RONUM=0
"RTN","DVBAB53",8,0)
 S RO="N"
"RTN","DVBAB53",9,0)
 S HEAD="",HEAD1=""
"RTN","DVBAB53",10,0)
 K ^TMP($J) G TERM
"RTN","DVBAB53",11,0)
 ;
"RTN","DVBAB53",12,0)
SET Q:'$D(^DPT(DA,0))  S DFN=DA,DVBASC="" D RCV^DVBAVDPT Q:CFLOC'=RONUM&(RO="Y")&(CFLOC'=0)&(CFLOC'=376)  Q:ADTYPE="S"&(DVBASC'="Y")  Q:ADTYPE="A"&(RCVAA'=1)  Q:ADTYPE="P"&(RCVPEN'="1")
"RTN","DVBAB53",13,0)
 S TDIS=$S($D(^DGPM(+MB,0)):$P(^(0),U,18),1:"")
"RTN","DVBAB53",14,0)
 I $D(^DG(405.2,+TDIS,0)) DO
"RTN","DVBAB53",15,0)
 . ; I '$D(^TMP("DVBA",$J,"DUP",+TDIS)) Q   ; DVBA*2.7*99 commented out
"RTN","DVBAB53",16,0)
 .I '$D(DISTYPE(+TDIS)) Q
"RTN","DVBAB53",17,0)
 .S TDIS=$S($P(^DG(405.2,+TDIS,0),U,1)]"":$P(^(0),U,1),1:"Unknown discharge type")
"RTN","DVBAB53",18,0)
 .S ^TMP($J,XCN,CFLOC,MB,DA)=MA_U_RCVAA_U_RCVPEN_U_CNUM_U_TDIS
"RTN","DVBAB53",19,0)
 .Q
"RTN","DVBAB53",20,0)
 Q
"RTN","DVBAB53",21,0)
 ;
"RTN","DVBAB53",22,0)
PRINTB S MA=$P(DATA,U),RCVAA=$P(DATA,U,2),RCVPEN=$P(DATA,U,3),CNUM=$P(DATA,U,4),TDIS=$P(DATA,U,5),DFN=DA,QUIT1=1 D DCHGDT^DVBAVDPT
"RTN","DVBAB53",23,0)
 W:(IOST?1"C-".E)!($D(DVBAON2)) @IOF
"RTN","DVBAB53",24,0)
 W !!!,?(80-$L(HEAD)\2),HEAD,!,?(80-$L(HEAD1)\2),HEAD1,!!
"RTN","DVBAB53",25,0)
 S ZMSG(DVBABCNT)="",DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",26,0)
 ;
"RTN","DVBAB53",27,0)
 S ZMSG(DVBABCNT)="          Patient Name:    "_PNAM  S DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",28,0)
 S ZMSG(DVBABCNT)="              Claim No:    "_CNUM  S DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",29,0)
 S ZMSG(DVBABCNT)="      Claim Folder Loc:    "_CFLOC  S DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",30,0)
 S ZMSG(DVBABCNT)="         Social Sec No:    "_SSN  S DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",31,0)
 S ZMSG(DVBABCNT)="        Discharge Date:    "_$$FMTE^XLFDT(DCHGDT,"5DZ"),DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",32,0)
 S ZMSG(DVBABCNT)="     Type of Discharge:    "_TDIS,DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",33,0)
 D LOS^DVBAUTIL
"RTN","DVBAB53",34,0)
 S ZMSG(DVBABCNT)="        Length of Stay:    "_LOS_$S(LOS="":"Discharged same day",LOS=1:" day",1:" days"),DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",35,0)
 S ZMSG(DVBABCNT)="           Bed Service:    "_BEDSEC,DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",36,0)
 S ZMSG(DVBABCNT)="             Recv A&A?:    "_$S(RCVAA="0":"NO",RCVAA="1":"YES",1:"Not specified"),DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",37,0)
 S ZMSG(DVBABCNT)="              Pension?:    "_$S(RCVPEN="0":"NO",RCVPEN="1":"YES",1:"Not specified"),DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",38,0)
 ;
"RTN","DVBAB53",39,0)
 ;
"RTN","DVBAB53",40,0)
 ; ELIG INFO...
"RTN","DVBAB53",41,0)
 S ELIG=DVBAELIG,INCMP=""
"RTN","DVBAB53",42,0)
 ;S ZMSG(DVBABCNT)="      Eligibility data:"
"RTN","DVBAB53",43,0)
 I ELIG]"" S ELIG=ELIG_" ("_$S(DVBAELST="P":"Pend Ver",DVBAELST="R":"Pend Re-verif",DVBAELST="V":"Verified",1:"Not Verified")_")"
"RTN","DVBAB53",44,0)
 I $D(^DPT(DA,.29)) S INCMP=$S($P(^(.29),U,12)=1:"Incompetent",1:"")
"RTN","DVBAB53",45,0)
 S ZMSG(DVBABCNT)="       Eligibility data:   "_ELIG_$S(ELIG]"":", ",1:"")  S DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",46,0)
 W:$X>60 !?26 S ZMSG(DVBABCNT)=INCMP  S DVBABCNT=DVBABCNT+1
"RTN","DVBAB53",47,0)
 Q
"RTN","DVBAB53",48,0)
 ;END OF ELIG INFO
"RTN","DVBAB53",49,0)
 ;
"RTN","DVBAB53",50,0)
 ;I IOST?1"C-".E W *7,!,"Press RETURN to continue or ""^"" to stop    " R ANS:DTIME S:ANS=U!('$T) QUIT=1 I ANS=U S DVBAQUIT=1
"RTN","DVBAB53",51,0)
 S DVBAON2=""
"RTN","DVBAB53",52,0)
 Q
"RTN","DVBAB53",53,0)
 ;
"RTN","DVBAB53",54,0)
PRINT U IO S QUIT=""
"RTN","DVBAB53",55,0)
 S XCN="" F M=0:0 S XCN=$O(^TMP($J,XCN)) Q:XCN=""!(QUIT=1)  S CFLOC="" F J=0:0 S CFLOC=$O(^TMP($J,XCN,CFLOC)) Q:CFLOC=""!(QUIT=1)  D PRINT1
"RTN","DVBAB53",56,0)
 Q
"RTN","DVBAB53",57,0)
PRINT1 S ADM="" F K=0:0 S ADM=$O(^TMP($J,XCN,CFLOC,ADM)) Q:ADM=""!(QUIT=1)  S DA="" F L=0:0 S DA=$O(^TMP($J,XCN,CFLOC,ADM,DA)) Q:DA=""!(QUIT=1)  S DATA=^(DA) D PRINTB
"RTN","DVBAB53",58,0)
 Q
"RTN","DVBAB53",59,0)
 ;
"RTN","DVBAB53",60,0)
TERM ;D HOME^%ZIS K NOASK
"RTN","DVBAB53",61,0)
 ;
"RTN","DVBAB53",62,0)
SETUP ;W @IOF,!,"VARO DISCHARGE REPORT" D NOPARM^DVBAUTL2 G:$D(DVBAQUIT) KILL^DVBAUTIL S DTAR=^DVB(396.1,1,0),FDT(0)=$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBAB53",63,0)
 S DSRP=1
"RTN","DVBAB53",64,0)
 ;S HEAD1="FOR "_$P(DTAR,U,1)_" ON "_FDT(0) W !,HEAD1
"RTN","DVBAB53",65,0)
 ;
"RTN","DVBAB53",66,0)
EN1 ;W !!,"Please enter dates for search, oldest date first, most recent date last.",!!,"Last report was run on " S Y=$P(DTAR,U,4) X ^DD("DD") W Y,!!
"RTN","DVBAB53",67,0)
 ;D DATE^DVBAUTIL
"RTN","DVBAB53",68,0)
 ;G:X=""!(Y<0) KILL
"RTN","DVBAB53",69,0)
 ;
"RTN","DVBAB53",70,0)
ADTYPE ;D ADTYPE^DVBAUTL2 G:$D(DVBAQUIT) KILL^DVBAUTIL
"RTN","DVBAB53",71,0)
 ;W @IOF
"RTN","DVBAB53",72,0)
 ;K DVBACEPT
"RTN","DVBAB53",73,0)
 D EN^DVBAB99("DVBA DISCHARGE TYPES")
"RTN","DVBAB53",74,0)
 D ACCEPT^DVBALD
"RTN","DVBAB53",75,0)
 I '$D(DVBACEPT) D KILL^DVBAUTIL Q
"RTN","DVBAB53",76,0)
 I '$O(^TMP("DVBA",$J,"DUP",0)) D KILL^DVBAUTIL Q
"RTN","DVBAB53",77,0)
 M DISTYPE=^TMP("DVBA",$J,"DUP")
"RTN","DVBAB53",78,0)
 ;
"RTN","DVBAB53",79,0)
 ; DVBA*2.7*100 - commented out next line
"RTN","DVBAB53",80,0)
 ; W !!! S %ZIS="Q" D ^%ZIS K %ZIS G:POP KILL^DVBAUTIL
"RTN","DVBAB53",81,0)
 ;
"RTN","DVBAB53",82,0)
QUEUE I $D(IO("Q")) S ZTRTN="DEQUE^DVBADSRT",ZTIO=ION,NOASK=1,ZTDESC="AMIE DISCHARGE REPORT" F I="DISTYPE(","ADTYPE","DVBATYPS","BDATE","BDATE1","EDATE","FDT(0)","HEAD","HEAD1","HD","RO","RONUM","NOASK" S ZTSAVE(I)=""
"RTN","DVBAB53",83,0)
 I $D(IO("Q")) D ^%ZTLOAD W:$D(ZTSK) !!,"Request queued.",! G KILL
"RTN","DVBAB53",84,0)
 ;
"RTN","DVBAB53",85,0)
GO S MA=BDATE F J=0:0 S MA=$O(^DGPM("AMV3",MA)) Q:MA>EDATE!(MA="")  W:'$D(NOASK) "." F DA=0:0 S DA=$O(^DGPM("AMV3",MA,DA)) Q:DA=""  F MB=0:0 S MB=$O(^DGPM("AMV3",MA,DA,MB)) Q:MB=""  D SET
"RTN","DVBAB53",86,0)
 I '$D(^TMP($J)) U IO W !!,*7,"No data found for parameters entered.",!! H 2 G KILL
"RTN","DVBAB53",87,0)
 D PRINT I $D(DVBAQUIT) K DVBAON2,DISTYPE G KILL^DVBAUTIL
"RTN","DVBAB53",88,0)
 ;
"RTN","DVBAB53",89,0)
KILL D ^%ZISC D:$D(ZTQUEUED) KILL^%ZTLOAD S X=4 K DVBAON2,DISTYPE G FINAL^DVBAUTIL
"RTN","DVBAB53",90,0)
 ;
"RTN","DVBAB53",91,0)
DEQUE K ^TMP($J) G GO
"RTN","DVBAB82")
0^1^B72604404^B72472785
"RTN","DVBAB82",1,0)
DVBAB82 ;ALB - CAPRI DVBA REPORTS;03/08/02
"RTN","DVBAB82",2,0)
 ;;2.7;AMIE;**42,90,100**;Apr 10, 1995
"RTN","DVBAB82",3,0)
 Q
"RTN","DVBAB82",4,0)
 ;
"RTN","DVBAB82",5,0)
START(MSG,RPID,PARM) ; CALLED BY REMOTE PROCEDURE DVBAB REPORTS
"RTN","DVBAB82",6,0)
 ;Parameters
"RTN","DVBAB82",7,0)
 ;=============
"RTN","DVBAB82",8,0)
 ; MSG  : Output - ^TMP("DVBA",$J)
"RTN","DVBAB82",9,0)
 ; RPID : Report Identification Number
"RTN","DVBAB82",10,0)
 ; PARM : Input parameters separated by "^"
"RTN","DVBAB82",11,0)
 ;
"RTN","DVBAB82",12,0)
 N DVBHFS,DVBERR,DVBGUI,I
"RTN","DVBAB82",13,0)
 K ^TMP("DVBA",$J)
"RTN","DVBAB82",14,0)
 S DVBGUI=1,DVBERR=0,DVBHFS=$$HFS(),RPID=$G(RPID)
"RTN","DVBAB82",15,0)
 I RPID<1!(RPID>9) S ^TMP("DVBA",$J,1)="0^Undefined Report ID" G END
"RTN","DVBAB82",16,0)
 D HFSOPEN("DVBRP",DVBHFS,"W") I DVBERR G END
"RTN","DVBAB82",17,0)
 I RPID=1 D CRMS G END
"RTN","DVBAB82",18,0)
 I RPID=3 D CPRNT G END
"RTN","DVBAB82",19,0)
 D CHECK I DVBERR G END
"RTN","DVBAB82",20,0)
 I RPID=2 D CRRR G END
"RTN","DVBAB82",21,0)
 I RPID=4 D CRPON G END
"RTN","DVBAB82",22,0)
 I RPID=5 D CIRPT G END
"RTN","DVBAB82",23,0)
 I RPID=6 D DSRP G END
"RTN","DVBAB82",24,0)
 I RPID=7 D SDPP G END
"RTN","DVBAB82",25,0)
 I RPID=8 D SPRPT G END
"RTN","DVBAB82",26,0)
 I RPID=9 D VIEW
"RTN","DVBAB82",27,0)
 ;
"RTN","DVBAB82",28,0)
END D HFSCLOSE("DVBRP",DVBHFS)
"RTN","DVBAB82",29,0)
 S I=0 F  S I=$O(^TMP("DVBA",$J,1,I)) Q:'I  S ^TMP("DVBA",$J,1,I)=^TMP("DVBA",$J,1,I)_$C(13)
"RTN","DVBAB82",30,0)
 S MSG=$NA(^TMP("DVBA",$J))
"RTN","DVBAB82",31,0)
 Q
"RTN","DVBAB82",32,0)
CHECK ; VALIDATE INPUT PARAMETERS
"RTN","DVBAB82",33,0)
 I $G(PARM)="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Input Parameters"
"RTN","DVBAB82",34,0)
 Q
"RTN","DVBAB82",35,0)
 ;
"RTN","DVBAB82",36,0)
SDPP ; Report # 7 - Full (Patient Profile MAS) Report
"RTN","DVBAB82",37,0)
 ;Parameters
"RTN","DVBAB82",38,0)
 ;=============
"RTN","DVBAB82",39,0)
 ; DFN : Patient Identification Number
"RTN","DVBAB82",40,0)
 ; SDR : R/Range or A/All
"RTN","DVBAB82",41,0)
 ; SDBD : Begining date
"RTN","DVBAB82",42,0)
 ; SDED : Ending date
"RTN","DVBAB82",43,0)
 ; SDP : Print the profile? 1 OR 0
"RTN","DVBAB82",44,0)
 ; SDTYP(2) : Print appointments? 1 OR 0
"RTN","DVBAB82",45,0)
 ; SDTYP(1) : Print add/edits? 1 or 0
"RTN","DVBAB82",46,0)
 ; SDTYP(4) : Print enrollments? 1 or 0
"RTN","DVBAB82",47,0)
 ; SDTYP(3) : Print dispositions? 1 OR 0
"RTN","DVBAB82",48,0)
 ; SDTYP(7) : Print team information? 1 OR 0
"RTN","DVBAB82",49,0)
 ; SDTYP(5) : Print means test? 1 OR 0
"RTN","DVBAB82",50,0)
 ;
"RTN","DVBAB82",51,0)
 N SDTYP,SDBD,SDED,SDACT,SDPRINT,SDYES,SDRANGE,SDBEG,SDEN
"RTN","DVBAB82",52,0)
 S DFN=$P(PARM,"^",1),SDR=$P(PARM,"^",2),SDBD=$P(PARM,"^",3),SDED=$P(PARM,"^",4)
"RTN","DVBAB82",53,0)
 S SDP=$P(PARM,"^",5),SDTYP(2)=$P(PARM,"^",6),SDTYP(1)=$P(PARM,"^",7)
"RTN","DVBAB82",54,0)
 S SDTYP(4)=$P(PARM,"^",8),SDTYP(3)=$P(PARM,"^",9),SDTYP(7)=$P(PARM,"^",10),SDTYP(5)=$P(PARM,"^",11)
"RTN","DVBAB82",55,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",56,0)
 S SDACT="",(SDYES,SDRANGE,SDPRINT)=0
"RTN","DVBAB82",57,0)
 I SDR="R" S SDRANGE=1
"RTN","DVBAB82",58,0)
 I SDP=1 S SDYES=1,SDPRINT=1
"RTN","DVBAB82",59,0)
 I 'SDRANGE S (SDBD,SDBEG)=2800101,(SDED,SDEND)=$$ENDDT(),SDHDR=1
"RTN","DVBAB82",60,0)
 D ENS^%ZISS
"RTN","DVBAB82",61,0)
 N SDYN,DVB S SDPRINT=1,DVB(1)=SDBD_";"_SDED,DVB(4)=DFN,DVB("FLDS")=1
"RTN","DVBAB82",62,0)
 ;I $$SDAPI^SDAMA301(.DVB)>0 D
"RTN","DVBAB82",63,0)
 I $O(^DPT(DFN,"S",SDBD)) D
"RTN","DVBAB82",64,0)
 . I SDTYP(2)=1 S SDTYP(2)="" Q
"RTN","DVBAB82",65,0)
 . K SDTYP(2)
"RTN","DVBAB82",66,0)
 IF $$EXOE^SDOE(DFN,SDBD,SDED) D
"RTN","DVBAB82",67,0)
 . I SDTYP(1)=1 S SDTYP(1)="" Q
"RTN","DVBAB82",68,0)
 . K SDTYP(1)
"RTN","DVBAB82",69,0)
 I $D(^DPT(DFN,"DE")) D
"RTN","DVBAB82",70,0)
 . I SDTYP(4)=1 S SDTYP(4)="",SDACT=0 Q
"RTN","DVBAB82",71,0)
 . K SDTYP(4)
"RTN","DVBAB82",72,0)
 I $D(^DPT(DFN,"DIS")),$S('SDRANGE:1,+$O(^("DIS",9999999-(SDED+.9)))&($O(^(9999999-(SDED+.9)))<(9999999-(SDBD-.1))):1,1:0) D
"RTN","DVBAB82",73,0)
 . I SDTYP(3)=1 S SDTYP(3)="" Q
"RTN","DVBAB82",74,0)
 . K SDTYP(3)
"RTN","DVBAB82",75,0)
 S SDYN=$$LST^DGMTU(DFN) I SDYN D
"RTN","DVBAB82",76,0)
 . I SDTYP(5)=1 S SDTYP(5)="" Q
"RTN","DVBAB82",77,0)
 . K SDTYP(5)
"RTN","DVBAB82",78,0)
 I SDTYP(7)=1 D
"RTN","DVBAB82",79,0)
 . S SDTYP(7)="",GBL="^TMP(""SDPP"","_$J_")" Q
"RTN","DVBAB82",80,0)
 . K SDTYP(7)
"RTN","DVBAB82",81,0)
 D PRINT^SDPPRT
"RTN","DVBAB82",82,0)
 K ^TMP($J,"SDAMA301") S VALMBCK="R"
"RTN","DVBAB82",83,0)
 Q
"RTN","DVBAB82",84,0)
ENDDT() ;Calculate end date for "all" date
"RTN","DVBAB82",85,0)
 N X S X=$O(^DPT(DFN,"S",""),-1) S:X<DT X=DT_.24 Q X
"RTN","DVBAB82",86,0)
 ;N X,X1,X2,%H S X1=DT,X2=36600
"RTN","DVBAB82",87,0)
 ;D C^%DTC
"RTN","DVBAB82",88,0)
 ;Q X_.24
"RTN","DVBAB82",89,0)
 ;
"RTN","DVBAB82",90,0)
VIEW ; Report # 9 - View Registration Data Report
"RTN","DVBAB82",91,0)
 ; Parameters
"RTN","DVBAB82",92,0)
 ; ==========
"RTN","DVBAB82",93,0)
 ; DFN : Patient Identification Number
"RTN","DVBAB82",94,0)
 ;
"RTN","DVBAB82",95,0)
 U IO
"RTN","DVBAB82",96,0)
 S DFN=$P(PARM,"^",1)
"RTN","DVBAB82",97,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",98,0)
 D EN1^DGRP
"RTN","DVBAB82",99,0)
 Q
"RTN","DVBAB82",100,0)
DSRP ; Report # 6 - Reprint a Notice of Discharge Report
"RTN","DVBAB82",101,0)
 ; Parameters
"RTN","DVBAB82",102,0)
 ; % : 1=Report on all veterans for a given day (BDATE required)
"RTN","DVBAB82",103,0)
 ;   : 0=Report on a single Veteran (DFN required)
"RTN","DVBAB82",104,0)
 ; BDATE : Original Processing Date - $H/FileMan
"RTN","DVBAB82",105,0)
 ; DFN  : Patient Identification Number
"RTN","DVBAB82",106,0)
 ;
"RTN","DVBAB82",107,0)
 N %,BDATE,DFN,DFNIEN
"RTN","DVBAB82",108,0)
 S %=$P(PARM,"^",1),BDATE=$P(PARM,"^",2),DFN=$P(PARM,"^",3),DFNIEN=""
"RTN","DVBAB82",109,0)
 I BDATE="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Date"  Q
"RTN","DVBAB82",110,0)
 D DUZ2^DVBAUTIL
"RTN","DVBAB82",111,0)
 U IO
"RTN","DVBAB82",112,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",113,0)
 I %=1 D  Q
"RTN","DVBAB82",114,0)
 . S HD="SINGLE NOTICE OF DISCHARGE REPRINTING"
"RTN","DVBAB82",115,0)
 . D NOPARM^DVBAUTL2 G:$D(DVBAQUIT) KILL^DVBAUTIL S DTAR=^DVB(396.1,1,0),FDT(0)=$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBAB82",116,0)
 . S HEAD="NOTICE OF DISCHARGE",HEAD1="FOR "_$P(DTAR,U,1)_" ON "_FDT(0)
"RTN","DVBAB82",117,0)
 . I $D(^DVB(396.2,"B",DFN)) D
"RTN","DVBAB82",118,0)
 . . S DFNIEN=$O(^DVB(396.2,"B",DFN,DFNIEN)),ADM=$P(^DVB(396.2,DFNIEN,0),U,3)
"RTN","DVBAB82",119,0)
 . . I $D(^DGPM(+ADM,0)),$P(^(0),U,17)]"" S DCHPTR=$P(^DGPM(+ADM,0),U,17),DISCH=$S($P(^DGPM(DCHPTR,0),U,1)]"":$P(^(0),U,1),1:"") W ?($X+5),"Discharge date: ",$$FMTE^XLFDT(DISCH,"5DZ")
"RTN","DVBAB82",120,0)
 . . I $P(^DVB(396.2,DFNIEN,0),U,7)'=DVBAD2 W *7,!!,"This does not belong to your RO.",!! H 3 Q
"RTN","DVBAB82",121,0)
 . . I DFNIEN>0 S XDA=DFNIEN,DA=$P(^DVB(396.2,DFNIEN,0),U,1),ADMDT=$P(^DVB(396.2,DFNIEN,0),U,2),MB=$P(^(0),U,3)
"RTN","DVBAB82",122,0)
 . . D REPRINT^DVBADSNT
"RTN","DVBAB82",123,0)
 D DEQUE^DVBADSRP
"RTN","DVBAB82",124,0)
 Q
"RTN","DVBAB82",125,0)
 ;
"RTN","DVBAB82",126,0)
SPRPT ; Report # 8 - OP(Operation Report)
"RTN","DVBAB82",127,0)
 ;Parameters
"RTN","DVBAB82",128,0)
 ;=============
"RTN","DVBAB82",129,0)
 ; DFN : Patient Identification Number
"RTN","DVBAB82",130,0)
 ; SRTN : Select Operation
"RTN","DVBAB82",131,0)
 ;
"RTN","DVBAB82",132,0)
 N DFN,SRTN,MAGTMPR2,SRSITE
"RTN","DVBAB82",133,0)
 I $O(^SRO(133,1))'="B" S SRSITE=1
"RTN","DVBAB82",134,0)
 S DFN=$P(PARM,"^",1),SRTN=$P(PARM,"^",2),MAGTMPR2=1
"RTN","DVBAB82",135,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",136,0)
 D ^SROPRPT
"RTN","DVBAB82",137,0)
 Q
"RTN","DVBAB82",138,0)
 ;
"RTN","DVBAB82",139,0)
CRPON ; Report # - 4 Reprint C&P Final Report
"RTN","DVBAB82",140,0)
 ;Parameters
"RTN","DVBAB82",141,0)
 ;=============
"RTN","DVBAB82",142,0)
 ; RTYPE : Select Reprint Option (D)ate or (V)eteran
"RTN","DVBAB82",143,0)
 ; RUNDATE : ORIGINAL PROCESSING date
"RTN","DVBAB82",144,0)
 ; ANS : Reprinted by the RO or MAS
"RTN","DVBAB82",145,0)
 ; % : LAB 1 OR 0
"RTN","DVBAB82",146,0)
 ; DA(1) : Patient IEN for lab results
"RTN","DVBAB82",147,0)
 ; DFN  : Patient Identification Number
"RTN","DVBAB82",148,0)
 ;
"RTN","DVBAB82",149,0)
 U IO
"RTN","DVBAB82",150,0)
 N ONE
"RTN","DVBAB82",151,0)
 S RTYPE=$P(PARM,"^",1),RUNDATE=$P(PARM,"^",2),ANS=$P(PARM,"^",3),%=$P(PARM,"^",4),DA(1)=$P(PARM,"^",5),DFN=$P(PARM,"^",6),DA=DA(1)
"RTN","DVBAB82",152,0)
 I RTYPE="V" D VAL Q:DVBERR
"RTN","DVBAB82",153,0)
 S XDD=^DD("DD"),$P(ULINE,"_",70)="_",ONE="N",Y=DT
"RTN","DVBAB82",154,0)
 X XDD S HD="Reprint C & P Exams",SUPER=0
"RTN","DVBAB82",155,0)
 I $D(^XUSEC("DVBA C SUPERVISOR",DUZ)) S SUPER=1
"RTN","DVBAB82",156,0)
 S DVBCDT(0)=Y,PGHD="Compensation and Pension Exam Report",LOC=DUZ(2),PG=0,DVBCSITE=$S($D(^DVB(396.1,1,0)):$P(^(0),U,1),1:"Not specified")
"RTN","DVBAB82",157,0)
 I "^D^V^"'[RTYPE S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Data Type" Q
"RTN","DVBAB82",158,0)
 I ANS="R" K AUTO
"RTN","DVBAB82",159,0)
 I ANS="M" S AUTO=1
"RTN","DVBAB82",160,0)
 I "^M^R^"'[ANS S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Data Type" Q
"RTN","DVBAB82",161,0)
 I RTYPE="D" D GO^DVBCRPRT Q
"RTN","DVBAB82",162,0)
 I RTYPE="V" D
"RTN","DVBAB82",163,0)
 . S ONE="Y",RO=$P(^DVB(396.3,DA,0),U,3)
"RTN","DVBAB82",164,0)
 . I RO'=DUZ(2)&('$D(AUTO))&(SUPER=0) W !!,*7,"Those results do not belong to your office.",!! Q
"RTN","DVBAB82",165,0)
 . I RO=DUZ(2)&('$D(AUTO))&("RC"'[($P(^DVB(396.3,DA,0),U,18))) W *7,!!,"This request has not been released to the Regional Office yet.",!! Q
"RTN","DVBAB82",166,0)
 . S PRTDATE=$P(^DVB(396.3,DA,0),U,16) I PRTDATE="" W *7,!!,"This has never been printed.",!! I SUPER=0 S OUT=1 Q
"RTN","DVBAB82",167,0)
 . I %=1 D REN2^DVBCLABR Q
"RTN","DVBAB82",168,0)
 . ;D OV^DVBCRPON
"RTN","DVBAB82",169,0)
 . K DVBAON2 D SETLAB^DVBCPRNT,VARS^DVBCUTIL,STEP2^DVBCRPRT
"RTN","DVBAB82",170,0)
 Q
"RTN","DVBAB82",171,0)
 ;
"RTN","DVBAB82",172,0)
CIRPT ; Report # 5 - Insufficient Exam Report
"RTN","DVBAB82",173,0)
 ;Parameters
"RTN","DVBAB82",174,0)
 ;=============
"RTN","DVBAB82",175,0)
 ; RPTTYPE : D/Detailed or S/Summary
"RTN","DVBAB82",176,0)
 ; BEGDT : Beginning date $H/FileMan
"RTN","DVBAB82",177,0)
 ; ENDDT : Ending date $H/FileMan
"RTN","DVBAB82",178,0)
 ; RESANS : Insufficient Reason
"RTN","DVBAB82",179,0)
 ;
"RTN","DVBAB82",180,0)
 U IO
"RTN","DVBAB82",181,0)
 S RPTTYPE=$P(PARM,"^",1),BEGDT=$P(PARM,"^",2),ENDDT=$P(PARM,"^",3),RESANS=$P(PARM,"^",4)
"RTN","DVBAB82",182,0)
 I RPTTYPE="S" D SUM^DVBCIRPT Q
"RTN","DVBAB82",183,0)
 I RPTTYPE="D" D
"RTN","DVBAB82",184,0)
 . I RESANS="" S Y=-1 D INREAS
"RTN","DVBAB82",185,0)
 . I '$D(DVBAARY("REASON")) S DVBAQTSL=""
"RTN","DVBAB82",186,0)
 . S DVBCYQ=""
"RTN","DVBAB82",187,0)
 . I RESANS'="" S Y=RESANS D INREAS
"RTN","DVBAB82",188,0)
 . K DTOUT,DUOUT
"RTN","DVBAB82",189,0)
 . S Y=-1 D EXMTPE,DETAIL^DVBCIRP1
"RTN","DVBAB82",190,0)
 Q
"RTN","DVBAB82",191,0)
 ;
"RTN","DVBAB82",192,0)
EXMTPE ;
"RTN","DVBAB82",193,0)
 N YSAVE,DVBAXIFN
"RTN","DVBAB82",194,0)
 S YSAVE=Y
"RTN","DVBAB82",195,0)
 F DVBAXIFN=0:0 S DVBAXIFN=$O(^DVB(396.6,DVBAXIFN)) Q:+DVBAXIFN=0  DO
"RTN","DVBAB82",196,0)
 . S ^TMP($J,"XMTYPE",DVBAXIFN)=""
"RTN","DVBAB82",197,0)
 S Y=-1
"RTN","DVBAB82",198,0)
 I +YSAVE>0 S ^TMP($J,"XMTYPE",+YSAVE)=""
"RTN","DVBAB82",199,0)
 S Y=YSAVE
"RTN","DVBAB82",200,0)
 Q
"RTN","DVBAB82",201,0)
INREAS ;
"RTN","DVBAB82",202,0)
 N YSAVE,DVBXIFN
"RTN","DVBAB82",203,0)
 S YSAVE=Y
"RTN","DVBAB82",204,0)
 F DVBAXIFN=0:0 S DVBAXIFN=$O(^DVB(396.94,DVBAXIFN)) Q:+DVBAXIFN=0  DO
"RTN","DVBAB82",205,0)
 . S DVBAARY("REASON",DVBAXIFN)=""
"RTN","DVBAB82",206,0)
 S Y=-1
"RTN","DVBAB82",207,0)
 I +YSAVE>0 S DVBAARY("REASON",+YSAVE)=""
"RTN","DVBAB82",208,0)
 S Y=YSAVE
"RTN","DVBAB82",209,0)
 Q
"RTN","DVBAB82",210,0)
 ;
"RTN","DVBAB82",211,0)
CRMS ; Report # 1 - Regional Office 21- day Certificate Printing Report.
"RTN","DVBAB82",212,0)
 ; No Parameters
"RTN","DVBAB82",213,0)
 ;
"RTN","DVBAB82",214,0)
 U IO
"RTN","DVBAB82",215,0)
 D ^DVBACRMS
"RTN","DVBAB82",216,0)
 Q
"RTN","DVBAB82",217,0)
 ;
"RTN","DVBAB82",218,0)
CRRR ; Report # 2 - Reprint a 21 - day Certificate for the RO
"RTN","DVBAB82",219,0)
 ;Parameters
"RTN","DVBAB82",220,0)
 ;=============
"RTN","DVBAB82",221,0)
 ; DVBSEL : Select one of the following:
"RTN","DVBAB82",222,0)
 ;       N         Patient Name
"RTN","DVBAB82",223,0)
 ;       D         ORIGINAL PROCESSING DATE
"RTN","DVBAB82",224,0)
 ; SDATE : ORIGINAL PROCESSING date - $H/FileMan
"RTN","DVBAB82",225,0)
 ; XDA : Patient IEN
"RTN","DVBAB82",226,0)
 ;
"RTN","DVBAB82",227,0)
 U IO
"RTN","DVBAB82",228,0)
 S DVBSEL=$P(PARM,"^",1),SDATE=$P(PARM,"^",2),XDA=$P(PARM,"^",3)
"RTN","DVBAB82",229,0)
 I "^D^N^"'[DVBSEL S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Data Type" Q
"RTN","DVBAB82",230,0)
 I DVBSEL="D" D  I DVBERR Q
"RTN","DVBAB82",231,0)
 . I SDATE="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Date" Q
"RTN","DVBAB82",232,0)
 . S %DT="X" S X=SDATE D ^%DT I Y<0 D  Q
"RTN","DVBAB82",233,0)
 . . S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Date Format"
"RTN","DVBAB82",234,0)
 I DVBSEL="N" D  I DVBERR Q
"RTN","DVBAB82",235,0)
 . I XDA="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Patient IEN" Q
"RTN","DVBAB82",236,0)
 . S DIC=2,DIC(0)="NZX",X=XDA D ^DIC I Y<0 D  I DVBERR Q
"RTN","DVBAB82",237,0)
 . . S DVBERR=1,^TMP("DVBA",$J,1)="0^Invalid Patient Name."
"RTN","DVBAB82",238,0)
 . S DFN=XDA
"RTN","DVBAB82",239,0)
 D INIT^DVBACRRR I 'CONT Q
"RTN","DVBAB82",240,0)
 D HDR^DVBACRRR,DATA^DVBACRRR
"RTN","DVBAB82",241,0)
 Q
"RTN","DVBAB82",242,0)
 ;
"RTN","DVBAB82",243,0)
CPRNT ; Report # 3 - Print C&P Final Report (manual) Report
"RTN","DVBAB82",244,0)
 ; No Parameters
"RTN","DVBAB82",245,0)
 ;
"RTN","DVBAB82",246,0)
 S XDD=^DD("DD"),$P(ULINE,"_",70)="_",Y=DT
"RTN","DVBAB82",247,0)
 X XDD S DVBCDT(0)=Y,PGHD="Compensation and Pension Exam Report",DVBCSITE=$S($D(^DVB(396.1,1,0)):$P(^(0),U,1),1:"Not Specified")
"RTN","DVBAB82",248,0)
 D GO^DVBCPRNT
"RTN","DVBAB82",249,0)
 Q
"RTN","DVBAB82",250,0)
VAL ; VALIDATE PATIENT
"RTN","DVBAB82",251,0)
 I $G(DFN)="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Patient IEN" G END
"RTN","DVBAB82",252,0)
 S DIC=2,DIC(0)="NZX",X=DFN D ^DIC
"RTN","DVBAB82",253,0)
 I Y<0 S DVBERR=1,^TMP("DVBA",$J,1)="0^Invalid Patient Name." G END
"RTN","DVBAB82",254,0)
 Q
"RTN","DVBAB82",255,0)
 ;
"RTN","DVBAB82",256,0)
HFS() ; -- get hfs file name
"RTN","DVBAB82",257,0)
 N H
"RTN","DVBAB82",258,0)
 S H=$H
"RTN","DVBAB82",259,0)
 Q "DVBA_"_$J_"_"_$P(H,",")_"_"_$P(H,",",2)_".DAT"
"RTN","DVBAB82",260,0)
 ;
"RTN","DVBAB82",261,0)
HFSOPEN(HANDLE,DVBHFS,DVBMODE) ; Open File
"RTN","DVBAB82",262,0)
 S DVBDIRY=$$GET^XPAR("DIV","DVB HFS SCRATCH")
"RTN","DVBAB82",263,0)
 ;I DVBDIRY="" S ECERR=1 D  Q
"RTN","DVBAB82",264,0)
 ;. S ^TMP("DVBA",$J,1)="0^A scratch directory for reports doesn't exist"
"RTN","DVBAB82",265,0)
 D OPEN^%ZISH(HANDLE,,DVBHFS,$G(DVBMODE,"W")) D:POP  Q:POP
"RTN","DVBAB82",266,0)
 .S DVBERR=1,^TMP("DVBA",$J,1)="0^Unable to open file "
"RTN","DVBAB82",267,0)
 Q
"RTN","DVBAB82",268,0)
 ;
"RTN","DVBAB82",269,0)
HFSCLOSE(HANDLE,DVBHFS) ;Close HFS and unload data
"RTN","DVBAB82",270,0)
 N DVBDEL,X,%ZIS
"RTN","DVBAB82",271,0)
 D CLOSE^%ZISH(HANDLE)
"RTN","DVBAB82",272,0)
 S ROOT=$NA(^TMP("DVBA",$J,1)),DVBDEL(DVBHFS)=""
"RTN","DVBAB82",273,0)
 K @ROOT
"RTN","DVBAB82",274,0)
 S X=$$FTG^%ZISH(,DVBHFS,$NA(@ROOT@(1)),4)
"RTN","DVBAB82",275,0)
 S X=$$DEL^%ZISH(,$NA(DVBDEL))
"RTN","DVBAB82",276,0)
 Q
"VER")
8.0^22.0
"BLD",5639,6)
^96
**END**
**END**
