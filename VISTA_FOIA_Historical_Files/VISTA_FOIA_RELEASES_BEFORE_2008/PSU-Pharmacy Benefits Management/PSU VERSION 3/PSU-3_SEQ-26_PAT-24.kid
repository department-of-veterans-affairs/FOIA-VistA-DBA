Released PSU*3*24 SEQ #26
Extracted from mail message
**KIDS**:PSU*3.0*24^

**INSTALL NAME**
PSU*3.0*24
"BLD",4778,0)
PSU*3.0*24^PHARMACY BENEFITS MANAGEMENT^0^3040719^y
"BLD",4778,1,0)
^^3^3^3040701^
"BLD",4778,1,1,0)
 
"BLD",4778,1,2,0)
This patch decrease processing time, truncation of the ICN and prevents 
"BLD",4778,1,3,0)
duplicate jobs.
"BLD",4778,4,0)
^9.64PA^^0
"BLD",4778,"ABPKG")
n
"BLD",4778,"KRN",0)
^9.67PA^8989.52^19
"BLD",4778,"KRN",.4,0)
.4
"BLD",4778,"KRN",.401,0)
.401
"BLD",4778,"KRN",.402,0)
.402
"BLD",4778,"KRN",.403,0)
.403
"BLD",4778,"KRN",.5,0)
.5
"BLD",4778,"KRN",.84,0)
.84
"BLD",4778,"KRN",3.6,0)
3.6
"BLD",4778,"KRN",3.8,0)
3.8
"BLD",4778,"KRN",9.2,0)
9.2
"BLD",4778,"KRN",9.8,0)
9.8
"BLD",4778,"KRN",9.8,"NM",0)
^9.68A^35^9
"BLD",4778,"KRN",9.8,"NM",7,0)
PSUCP^^0^B94001150
"BLD",4778,"KRN",9.8,"NM",24,0)
PSUDEM1^^0^B37845798
"BLD",4778,"KRN",9.8,"NM",25,0)
PSUDEM7^^0^B14211015
"BLD",4778,"KRN",9.8,"NM",27,0)
PSUCS5^^0^B5745891
"BLD",4778,"KRN",9.8,"NM",28,0)
PSUIV2^^0^B35293917
"BLD",4778,"KRN",9.8,"NM",32,0)
PSUALERT^^0^B3059763
"BLD",4778,"KRN",9.8,"NM",33,0)
PSUDEM2^^0^B20153453
"BLD",4778,"KRN",9.8,"NM",34,0)
PSUOP3^^0^B23489811
"BLD",4778,"KRN",9.8,"NM",35,0)
PSUCS1^^0^B6741320
"BLD",4778,"KRN",9.8,"NM","B","PSUALERT",32)

"BLD",4778,"KRN",9.8,"NM","B","PSUCP",7)

"BLD",4778,"KRN",9.8,"NM","B","PSUCS1",35)

"BLD",4778,"KRN",9.8,"NM","B","PSUCS5",27)

"BLD",4778,"KRN",9.8,"NM","B","PSUDEM1",24)

"BLD",4778,"KRN",9.8,"NM","B","PSUDEM2",33)

"BLD",4778,"KRN",9.8,"NM","B","PSUDEM7",25)

"BLD",4778,"KRN",9.8,"NM","B","PSUIV2",28)

"BLD",4778,"KRN",9.8,"NM","B","PSUOP3",34)

"BLD",4778,"KRN",19,0)
19
"BLD",4778,"KRN",19,"NM",0)
^9.68A^^0
"BLD",4778,"KRN",19.1,0)
19.1
"BLD",4778,"KRN",101,0)
101
"BLD",4778,"KRN",409.61,0)
409.61
"BLD",4778,"KRN",771,0)
771
"BLD",4778,"KRN",870,0)
870
"BLD",4778,"KRN",8989.51,0)
8989.51
"BLD",4778,"KRN",8989.52,0)
8989.52
"BLD",4778,"KRN",8994,0)
8994
"BLD",4778,"KRN","B",.4,.4)

"BLD",4778,"KRN","B",.401,.401)

"BLD",4778,"KRN","B",.402,.402)

"BLD",4778,"KRN","B",.403,.403)

"BLD",4778,"KRN","B",.5,.5)

"BLD",4778,"KRN","B",.84,.84)

"BLD",4778,"KRN","B",3.6,3.6)

"BLD",4778,"KRN","B",3.8,3.8)

"BLD",4778,"KRN","B",9.2,9.2)

"BLD",4778,"KRN","B",9.8,9.8)

"BLD",4778,"KRN","B",19,19)

"BLD",4778,"KRN","B",19.1,19.1)

"BLD",4778,"KRN","B",101,101)

"BLD",4778,"KRN","B",409.61,409.61)

"BLD",4778,"KRN","B",771,771)

"BLD",4778,"KRN","B",870,870)

"BLD",4778,"KRN","B",8989.51,8989.51)

"BLD",4778,"KRN","B",8989.52,8989.52)

"BLD",4778,"KRN","B",8994,8994)

"BLD",4778,"QUES",0)
^9.62^^
"BLD",4778,"REQB",0)
^9.611^4^2
"BLD",4778,"REQB",2,0)
PSU*3.0*30^1
"BLD",4778,"REQB",4,0)
PSU*3.0*21^1
"BLD",4778,"REQB","B","PSU*3.0*21",4)

"BLD",4778,"REQB","B","PSU*3.0*30",2)

"MBREQ")
0
"PKG",541,-1)
1^1
"PKG",541,0)
PHARMACY BENEFITS MANAGEMENT^PSU^PHARMACY BENEFITS MANAGEMENT
"PKG",541,20,0)
^9.402P^^
"PKG",541,22,0)
^9.49I^1^1
"PKG",541,22,1,0)
3.0^2981015^3010116^66481
"PKG",541,22,1,"PAH",1,0)
24^3040719
"PKG",541,22,1,"PAH",1,1,0)
^^3^3^3040719
"PKG",541,22,1,"PAH",1,1,1,0)
 
"PKG",541,22,1,"PAH",1,1,2,0)
This patch decrease processing time, truncation of the ICN and prevents 
"PKG",541,22,1,"PAH",1,1,3,0)
duplicate jobs.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","PSUALERT")
0^32^B3059763
"RTN","PSUALERT",1,0)
PSUALERT ;OIFIO BAY PINES/TEH - PBM CONTROL POINT - ALERT ;OCT 15,1998
"RTN","PSUALERT",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**24**;OCT 15,1998
"RTN","PSUALERT",3,0)
MANUAL ;MANUAL ALERT MESSAGE - DISPLAY TO SCREEN INCLUDED.
"RTN","PSUALERT",4,0)
 I '$D(^XTMP("PSU","RUNNING")) Q
"RTN","PSUALERT",5,0)
 L ^XTMP("PSU","RUNNING"):1 I '$T D  Q
"RTN","PSUALERT",6,0)
 .W !,"A previously tasked Extract (TASK #: "_$G(^XTMP("PSU","RUNNING"))_") is running....try again later. ",! S PSUALERT=1
"RTN","PSUALERT",7,0)
 .;SEND ALERT JOB RUNNING
"RTN","PSUALERT",8,0)
 .S XQA(DUZ)="",XQA("G.PSU PBM")="",XQAMSG="A PBM Extract is CURRENTLY running in the background...try later."
"RTN","PSUALERT",9,0)
 .S XQAID="PSU",XQAFLG="D",PSUALERT=1 D SETUP^XQALERT
"RTN","PSUALERT",10,0)
 W !,"A Previous job seems to have encountered an error. A new job may encounter the same problem."
"RTN","PSUALERT",11,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUALERT",12,0)
 L  Q
"RTN","PSUALERT",13,0)
 ;
"RTN","PSUALERT",14,0)
AUTO ;AUTO ALERT MESSAGE
"RTN","PSUALERT",15,0)
 I '$D(^XTMP("PSU","RUNNING")) Q
"RTN","PSUALERT",16,0)
 L ^XTMP("PSU","RUNNING"):1 I '$T D  Q
"RTN","PSUALERT",17,0)
 .S XQA(DUZ)="",XQA("G.PSU PBM")="",XQAMSG="A PBM Extract is CURRENTLY running in the background...try later."
"RTN","PSUALERT",18,0)
 .S XQAID="PSU",XQAFLG="D",PSUALERT=1 D SETUP^XQALERT
"RTN","PSUALERT",19,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUALERT",20,0)
 L  Q
"RTN","PSUCP")
0^7^B94001150
"RTN","PSUCP",1,0)
PSUCP ;BIR/TJH,PDW - PBM CONTROL POINT ;25 AUG 1998
"RTN","PSUCP",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**4,5,8,19,24**;Oct 15, 1998
"RTN","PSUCP",3,0)
 ;
"RTN","PSUCP",4,0)
 ; DBIAs
"RTN","PSUCP",5,0)
 ; Reference to File #4    supported by DBIA 10090
"RTN","PSUCP",6,0)
 ; Reference to File #4.3  supported by DBIA 10091
"RTN","PSUCP",7,0)
 ; Reference to File #40.8 supported by DBIA 2438
"RTN","PSUCP",8,0)
 ; Reference to File #59.7 supported by DBIA 2854
"RTN","PSUCP",9,0)
MANUAL ; entry point for manual option
"RTN","PSUCP",10,0)
 S PSUALERT=0 D MANUAL^PSUALERT
"RTN","PSUCP",11,0)
 I PSUALERT K PSUALERT Q
"RTN","PSUCP",12,0)
 K PSUALERT
"RTN","PSUCP",13,0)
 S PSUFQ=1 ; set here for being available in PSUCP1
"RTN","PSUCP",14,0)
 ;
"RTN","PSUCP",15,0)
 I $D(^XTMP("PSUJFLG")) D  Q:Y=0  Q:Y="^"
"RTN","PSUCP",16,0)
 .W !!,"PLEASE NOTE: AN EXTRACT IS CURRENTLY RUNNING, OR"
"RTN","PSUCP",17,0)
 .W !!,"             A PREVIOUS JOB HAS NOT COMPLETED DUE TO"
"RTN","PSUCP",18,0)
 .W !,"             AN ERROR OR SYSTEM PROBLEM."
"RTN","PSUCP",19,0)
 .W !!,"             PLEASE CHECK TASKMAN TO SEE IF AN EXTRACT"
"RTN","PSUCP",20,0)
 .W !,"             IS IN PROGRESS BEFORE CONTINUING."
"RTN","PSUCP",21,0)
 .W !!,"             IF IN PROGRESS, THE JOB MAY ABORT IF YOU"
"RTN","PSUCP",22,0)
 .W !,"             RESPOND 'YES' TO CONTINUE."
"RTN","PSUCP",23,0)
 .W !
"RTN","PSUCP",24,0)
 .S DIR(0)="Y",DIR("B")="NO"
"RTN","PSUCP",25,0)
 .S DIR("A")="Do you wish to continue"
"RTN","PSUCP",26,0)
 .D ^DIR
"RTN","PSUCP",27,0)
 D ^PSUCP3
"RTN","PSUCP",28,0)
 S PSUJOB=$J_"_"_$P($H,",",2)
"RTN","PSUCP",29,0)
 D EN^PSUCP1 ; prompt for report choices
"RTN","PSUCP",30,0)
 ;
"RTN","PSUCP",31,0)
 ;PSU*3.0*24;IOFO BAY PINES;TEH - moved exit to abort setup for mail groups
"RTN","PSUCP",32,0)
 I PSUERR G EXIT
"RTN","PSUCP",33,0)
 D XMY^PSUTL1 ; Setup for mail groups according to choices
"RTN","PSUCP",34,0)
 S ^XTMP("PSUJFLG")=""    ;FLAG to avoid concurrent jobs running
"RTN","PSUCP",35,0)
 ;                         This can't be set to include $J because
"RTN","PSUCP",36,0)
 ;                         it is a flag to see if ANY job is running
"RTN","PSUCP",37,0)
 ;                         rather than a specific job. 
"RTN","PSUCP",38,0)
 S PSUAUTO=0
"RTN","PSUCP",39,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUJOB")=PSUJOB
"RTN","PSUCP",40,0)
 D PUT
"RTN","PSUCP",41,0)
 S PSUTITLE="PSU PBM MANUAL"
"RTN","PSUCP",42,0)
 S PSURC="RUN^PSUCP"
"RTN","PSUCP",43,0)
 S PSURP=$S('$L(PSUIOP):"",1:"PRINT^PSUCP")
"RTN","PSUCP",44,0)
 S PSURX="EXIT^PSUCP"
"RTN","PSUCP",45,0)
 S PSUNS="PS"
"RTN","PSUCP",46,0)
 ;
"RTN","PSUCP",47,0)
 ;
"RTN","PSUCP",48,0)
 D ^PSUDBQUE
"RTN","PSUCP",49,0)
 S ^XTMP("PSU","RUNNING")=$G(ZTSK)
"RTN","PSUCP",50,0)
 K PSUALERT,XAQ,SQAFLG,SQAID,XQAMSG,XQMSG,ZTSK
"RTN","PSUCP",51,0)
MANUALQ Q
"RTN","PSUCP",52,0)
 ;
"RTN","PSUCP",53,0)
AUTO ; set variables for Auto-report option and task to background
"RTN","PSUCP",54,0)
 S PSUALERT=0 D AUTO^PSUALERT
"RTN","PSUCP",55,0)
 I PSUALERT K PSUALERT Q
"RTN","PSUCP",56,0)
 I $G(^XTMP("PSU","RUNNING")) D  Q
"RTN","PSUCP",57,0)
 .S XQA(DUZ)="",XQA("G.PSU PBM")="",XQMSG="An ERROR has occurred. Please contact IRM for assistance."
"RTN","PSUCP",58,0)
 .S XQAID="PSU",XQAFLG="D" D SETUP^XQALERT
"RTN","PSUCP",59,0)
 .Q
"RTN","PSUCP",60,0)
 D ^PSUCP3         ;Clear trash globals
"RTN","PSUCP",61,0)
 S PSUJOB=$J_"_"_$P($H,",",2)
"RTN","PSUCP",62,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")=""   ;flag for mail patient summary reports
"RTN","PSUCP",63,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPSUMFLAG")=1         ;Set 'auto' flag
"RTN","PSUCP",64,0)
 S ^XTMP("PSUJFLG")=""    ;FLAG to avoid concurrent jobs running
"RTN","PSUCP",65,0)
 D  ; schedule job completion check
"RTN","PSUCP",66,0)
 .S PSURC="AUTO^PSUCP2"
"RTN","PSUCP",67,0)
 .S (PSURP,PSURX,PSUIOP)=""
"RTN","PSUCP",68,0)
 .S PSUTITLE="PSU PBM JOB CHECK"
"RTN","PSUCP",69,0)
 .S PSUFQ=1
"RTN","PSUCP",70,0)
 .D NOW^%DTC S X1=%,X2=6 D C^%DTC S PSUDTH=X ; LIVE MODE, wait 6 days (72 hours)
"RTN","PSUCP",71,0)
 .D ^PSUDBQUE
"RTN","PSUCP",72,0)
 .S ^XTMP("PSU","RUNNING")=$G(ZTSK)
"RTN","PSUCP",73,0)
 ;
"RTN","PSUCP",74,0)
 D NOW^%DTC S PSUMON=$S('$D(DT):X,1:DT),PSUMON=$E(PSUMON,1,5)-1 ; get previous month
"RTN","PSUCP",75,0)
 I $E(PSUMON,4,5)="00" S PSUMON=($E(PSUMON,1,3)-1)_"12" ; set to Dec. of previous year if this month is Jan.
"RTN","PSUCP",76,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUMONTH")=PSUMON
"RTN","PSUCP",77,0)
 S PSUSDT=PSUMON_"01"
"RTN","PSUCP",78,0)
 S PSULY=$$LEAPYR(PSUMON)
"RTN","PSUCP",79,0)
 S X=U_$E(PSUMON,4,5)_U
"RTN","PSUCP",80,0)
 S PSUEDT=PSUMON_$S(X["02":$S(PSULY:"29",1:"28"),"^04^06^09^11^"[X:"30",1:"31")
"RTN","PSUCP",81,0)
 S PSUDUZ=$S(DUZ=0:.5,1:DUZ),PSUMASF=1,PSUSMRY=0,PSUPBMG=1
"RTN","PSUCP",82,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPDFLAG")=1   ;Flag-detailed PD won't go to user auto extract
"RTN","PSUCP",83,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSUCP",84,0)
 S PSUOPTS="1,2,3,4,5,6,7,8,9,10,11",PSUAUTO=1,PSUIOP=""
"RTN","PSUCP",85,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUJOB")=PSUJOB
"RTN","PSUCP",86,0)
 D PUT
"RTN","PSUCP",87,0)
 S PSUTITLE="PSU PBM AUTO"
"RTN","PSUCP",88,0)
 S PSURC="RUN^PSUCP"
"RTN","PSUCP",89,0)
 S PSURP=""
"RTN","PSUCP",90,0)
 S PSURX="EXIT^PSUCP"
"RTN","PSUCP",91,0)
 S PSUNS="PS"
"RTN","PSUCP",92,0)
 S PSUFQ=1
"RTN","PSUCP",93,0)
 D NOW^%DTC S PSUDTH=%
"RTN","PSUCP",94,0)
 D ^PSUDBQUE
"RTN","PSUCP",95,0)
 K PSUALERT,XQA,XQAID,XQAFLG,XQA,ZTSK
"RTN","PSUCP",96,0)
AUTOQ Q  ; exit from AUTO
"RTN","PSUCP",97,0)
 ;
"RTN","PSUCP",98,0)
RUN ; run each selected module
"RTN","PSUCP",99,0)
 L ^XTMP("PSU","RUNNING"):1 I '$T Q
"RTN","PSUCP",100,0)
 D PULL,OPTS
"RTN","PSUCP",101,0)
 K PSUMOD,PSUFDA
"RTN","PSUCP",102,0)
 I PSUAUTO S PSUFDA(59.7,"1,",90)="@" D FILE^DIE("","PSUFDA","")
"RTN","PSUCP",103,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUCP",104,0)
 ;
"RTN","PSUCP",105,0)
 S PSUOPTN=""
"RTN","PSUCP",106,0)
 F  S PSUOPTN=$O(PSUMOD(PSUOPTN)) Q:PSUOPTN=""  D
"RTN","PSUCP",107,0)
 .K PSUMSGT
"RTN","PSUCP",108,0)
 .D PULL
"RTN","PSUCP",109,0)
 .I PSUAUTO S PSUPBMG=1
"RTN","PSUCP",110,0)
 .D XMY^PSUTL1
"RTN","PSUCP",111,0)
 .S PSURTN=PSUA(PSUOPTN,"R")
"RTN","PSUCP",112,0)
 .D NOW^%DTC
"RTN","PSUCP",113,0)
 .S ^XTMP("PSU_"_PSUJOB,"STATUS",PSUOPTN,"START")=%
"RTN","PSUCP",114,0)
 .D @PSURTN
"RTN","PSUCP",115,0)
 .D PULL
"RTN","PSUCP",116,0)
 .D NOW^%DTC
"RTN","PSUCP",117,0)
 .S ^XTMP("PSU_"_PSUJOB,"STATUS",PSUOPTN,"STOP")=%
"RTN","PSUCP",118,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUCP",119,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUCP",120,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUCP",121,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUCP",122,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUCP",123,0)
 D TIMING ; send a report of how long each module took to complete
"RTN","PSUCP",124,0)
 I PSUMASF!PSUPBMG D CONFIRM  ;Confirmation message went only if data went to Master File
"RTN","PSUCP",125,0)
 I PSUAUTO D
"RTN","PSUCP",126,0)
 .D NOW^%DTC
"RTN","PSUCP",127,0)
 .S PSUFDA(59.7,"1,",90)=% K %,%H,%I,X
"RTN","PSUCP",128,0)
 .D FILE^DIE("","PSUFDA","") ; file the completion date in 59.7,90;1
"RTN","PSUCP",129,0)
 L
"RTN","PSUCP",130,0)
 ;
"RTN","PSUCP",131,0)
 Q
"RTN","PSUCP",132,0)
 ;
"RTN","PSUCP",133,0)
PRINT ; print hard copy if requested
"RTN","PSUCP",134,0)
 ;Q:'$(PSUIOP)  ; no printer selected, stop right here.
"RTN","PSUCP",135,0)
 D PULL,OPTS
"RTN","PSUCP",136,0)
 K PSUMOD
"RTN","PSUCP",137,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUCP",138,0)
 S PSUOPTN=""
"RTN","PSUCP",139,0)
 F  S PSUOPTN=$O(PSUMOD(PSUOPTN)) Q:PSUOPTN=""  D
"RTN","PSUCP",140,0)
 .D PULL
"RTN","PSUCP",141,0)
 .S PSURTN=PSUA(PSUOPTN,"P")
"RTN","PSUCP",142,0)
 .D @PSURTN
"RTN","PSUCP",143,0)
 L
"RTN","PSUCP",144,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUCP",145,0)
PRINTQ Q
"RTN","PSUCP",146,0)
 ; ********  THE END  *********
"RTN","PSUCP",147,0)
EXIT ; exit point
"RTN","PSUCP",148,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUCP",149,0)
 K ^XTMP("PSUJFLG")   ;Remove flag to prevent concurrent jobs
"RTN","PSUCP",150,0)
 Q
"RTN","PSUCP",151,0)
 ;
"RTN","PSUCP",152,0)
PUT ; put variables in ^XTMP so modules can retrieve them
"RTN","PSUCP",153,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUIOP,PSUSNDR,PSUOPTS,PSUAUTO"
"RTN","PSUCP",154,0)
 S PSUVSTR=""
"RTN","PSUCP",155,0)
 F I=1:1:$L(PSUVARS,",") S $P(PSUVSTR,U,I)=@$P(PSUVARS,",",I)
"RTN","PSUCP",156,0)
 S X1=DT,X2=6 D C^%DTC
"RTN","PSUCP",157,0)
 S ^XTMP("PSU_"_PSUJOB,0)=X_U_DT_U_"Control data for PSU PBM individual modules"
"RTN","PSUCP",158,0)
 S ^XTMP("PSU_"_PSUJOB,1)=PSUVSTR
"RTN","PSUCP",159,0)
 K PSUVARS,PSUVSTR,X,X1
"RTN","PSUCP",160,0)
PUTQ Q
"RTN","PSUCP",161,0)
 ;
"RTN","PSUCP",162,0)
PULL ; pull variables from ^XTMP
"RTN","PSUCP",163,0)
 ; PSUJOB must exist and must be the job number used to store the data desired for this session.
"RTN","PSUCP",164,0)
 N I
"RTN","PSUCP",165,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUIOP,PSUSNDR,PSUOPTS,PSUAUTO"
"RTN","PSUCP",166,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P($G(^XTMP("PSU_"_PSUJOB,1)),U,I)
"RTN","PSUCP",167,0)
PULLQ Q
"RTN","PSUCP",168,0)
 ;
"RTN","PSUCP",169,0)
OPTS ; set option array
"RTN","PSUCP",170,0)
 S PSUA(1,"M")="IVs",PSUA(1,"R")="EN^PSUIV0",PSUA(1,"P")="PRINT^PSUIV0",PSUA(1,"C")="IV"
"RTN","PSUCP",171,0)
 S PSUA(2,"M")="Unit Dose",PSUA(2,"R")="EN^PSUUD0",PSUA(2,"P")="PRINT^PSUUD0",PSUA(2,"C")="UD"
"RTN","PSUCP",172,0)
 S PSUA(3,"M")="AR/WS",PSUA(3,"R")="EN^PSUAR0",PSUA(3,"P")="PRINT^PSUAR0",PSUA(3,"C")="AR"
"RTN","PSUCP",173,0)
 S PSUA(4,"M")="Prescription",PSUA(4,"R")="EN^PSUOP0",PSUA(4,"P")="PRINT^PSUOP0",PSUA(4,"C")="OP"
"RTN","PSUCP",174,0)
 S PSUA(5,"M")="Procurement",PSUA(5,"R")="EN^PSUPR0",PSUA(5,"P")="PRINT^PSUPR0",PSUA(5,"C")="PR"
"RTN","PSUCP",175,0)
 S PSUA(6,"M")="Controlled Substances",PSUA(6,"R")="EN^PSUCS0",PSUA(6,"P")="PRINT^PSUCS0",PSUA(6,"C")="CS"
"RTN","PSUCP",176,0)
 S PSUA(7,"M")="Patient Demographics",PSUA(7,"R")="EN^PSUDEM1",PSUA(7,"P")="PRINT^PSUDEM0",PSUA(7,"C")="PD"
"RTN","PSUCP",177,0)
 S PSUA(8,"M")="Outpatient Visits",PSUA(8,"R")="EN^PSUDEM2",PSUA(8,"P")="OPV^PSUDEM0",PSUA(8,"C")="OV"
"RTN","PSUCP",178,0)
 S PSUA(9,"M")="Inpatient PTF Records",PSUA(9,"R")="EN^PSUDEM7",PSUA(9,"P")="PTF^PSUDEM0",PSUA(9,"C")="PTF"
"RTN","PSUCP",179,0)
 S PSUA(10,"M")="Provider Information",PSUA(10,"R")="EN^PSUDEM4",PSUA(10,"P")="PRO^PSUDEM0",PSUA(10,"C")="PRO"
"RTN","PSUCP",180,0)
 S PSUA(11,"M")="Laboratory Results",PSUA(11,"R")="EN^PSULR0",PSUA(11,"P")="PRINT^PSULR0",PSUA(11,"C")="LR"
"RTN","PSUCP",181,0)
 S PSUA("A")=""
"RTN","PSUCP",182,0)
OPTSQ Q
"RTN","PSUCP",183,0)
 ;
"RTN","PSUCP",184,0)
CONFIRM ;Send confirmation by Division(s)
"RTN","PSUCP",185,0)
 K PSUCONF
"RTN","PSUCP",186,0)
 S PSUDIV=0,$P(PSUDASH,"-",81)=""
"RTN","PSUCP",187,0)
 D OPTS
"RTN","PSUCP",188,0)
 S PSUCONF(1)="The chart below shows the package(s) whose dispensing statistics were extracted"
"RTN","PSUCP",189,0)
 S PSUCONF(2)="by the PBM "_$S(PSUAUTO:"Automatic",1:"Manual")_" Pharmacy Statistics option."
"RTN","PSUCP",190,0)
 S PSUCONF(3)=" "
"RTN","PSUCP",191,0)
 S PSUCONF(4)="PACKAGE"_$J("# Line items",35)_$J("# MailMan msgs",19)
"RTN","PSUCP",192,0)
 S PSUCONF(5)=$E(PSUDASH,1,79)
"RTN","PSUCP",193,0)
 F  S PSUDIV=$O(^XTMP(PSUSUB,"CONFIRM",PSUDIV)) Q:PSUDIV'?1N.E  D
"RTN","PSUCP",194,0)
 .K ^XTMP(PSUSUB,"XMD")
"RTN","PSUCP",195,0)
 .M ^XTMP(PSUSUB,"XMD")=PSUCONF
"RTN","PSUCP",196,0)
 .S PSUOPT=0,PSULCT=5
"RTN","PSUCP",197,0)
 .F  S PSUOPT=$O(^XTMP(PSUSUB,"CONFIRM",PSUDIV,PSUOPT)) Q:PSUOPT'?1.N  D
"RTN","PSUCP",198,0)
 ..S PSULCT=PSULCT+1
"RTN","PSUCP",199,0)
 ..S PSUPKG=PSUA(PSUOPT,"M")
"RTN","PSUCP",200,0)
 ..S PSULIN=^XTMP(PSUSUB,"CONFIRM",PSUDIV,PSUOPT,"L")
"RTN","PSUCP",201,0)
 ..S PSUMSG=^XTMP(PSUSUB,"CONFIRM",PSUDIV,PSUOPT,"M")
"RTN","PSUCP",202,0)
 ..S ^XTMP(PSUSUB,"XMD",PSULCT)=PSUPKG_$J(PSULIN,37-$L(PSUPKG))_$J(PSUMSG,12)
"RTN","PSUCP",203,0)
 .S PSUSUBJ="PBM Stats for "
"RTN","PSUCP",204,0)
 .I PSUMASF=1 D XMD
"RTN","PSUCP",205,0)
CONFIRMQ Q
"RTN","PSUCP",206,0)
 ;
"RTN","PSUCP",207,0)
XMD ;Email
"RTN","PSUCP",208,0)
 ;
"RTN","PSUCP",209,0)
 S XMDUZ=DUZ
"RTN","PSUCP",210,0)
 ;S ^XTMP("PSU_"_PSUJOB,"PSUPBMG")=PSUPBMG
"RTN","PSUCP",211,0)
 D XMY^PSUTL1
"RTN","PSUCP",212,0)
 M XMY=PSUXMYS1
"RTN","PSUCP",213,0)
 I $G(PSUMASF)!$G(PSUPBMG) M XMY=PSUXMYH
"RTN","PSUCP",214,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="XM" D ^DIC
"RTN","PSUCP",215,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCP",216,0)
 S XMSUB=PSUSUBJ_PSURP("START")_" to "_PSURP("END")_" from "_PSUDIV_" "_PSUDIVNM
"RTN","PSUCP",217,0)
 S XMTEXT="^XTMP(PSUSUB,""XMD"","
"RTN","PSUCP",218,0)
 S XMCHAN=1
"RTN","PSUCP",219,0)
 D ^XMD
"RTN","PSUCP",220,0)
XMDQ Q
"RTN","PSUCP",221,0)
 ;
"RTN","PSUCP",222,0)
TIMING ; Timing report
"RTN","PSUCP",223,0)
 K ^XTMP(PSUSUB,"XMD")
"RTN","PSUCP",224,0)
 S $P(PSUSPACE," ",41)=""
"RTN","PSUCP",225,0)
 S PSUX=0,PSULCT=0
"RTN","PSUCP",226,0)
 F  S PSUX=$O(^XTMP(PSUSUB,"STATUS",PSUX)) Q:PSUX=""  D
"RTN","PSUCP",227,0)
 .S (X,Y)=^XTMP(PSUSUB,"STATUS",PSUX,"START") X ^DD("DD") D
"RTN","PSUCP",228,0)
 ..I $E(Y,17)=":" S PSUT1=$E(Y,1,16)
"RTN","PSUCP",229,0)
 ..I $E(Y,17)'=":" S PSUT1=$E(Y,1,17)
"RTN","PSUCP",230,0)
 .S (X1,Y)=^XTMP(PSUSUB,"STATUS",PSUX,"STOP") X ^DD("DD") D
"RTN","PSUCP",231,0)
 ..I $E(Y,17)=":" S PSUT2=$E(Y,1,16)
"RTN","PSUCP",232,0)
 ..I $E(Y,17)'=":" S PSUT2=$E(Y,1,17)
"RTN","PSUCP",233,0)
 .S Y=$E(X1_"000",9,10)-$E(X_"000",9,10)*60+$E(X1_"00000",11,12)-$E(X_"00000",11,12),X2=X,X=$P(X,".",1)'=$P(X1,".",1)
"RTN","PSUCP",234,0)
 .D ^%DTC:X S X=X*1440+Y
"RTN","PSUCP",235,0)
 .S PSULCT=PSULCT+1
"RTN","PSUCP",236,0)
 .S PSUREC=$E(PSUA(PSUX,"M")_PSUSPACE,1,20)_$J(PSUT1,20)_$J(PSUT2,20)_$J(X\60,4)_" hrs,"_$J(X#60,3)_" min"
"RTN","PSUCP",237,0)
 .S ^XTMP(PSUSUB,"XMD",PSULCT)=PSUREC
"RTN","PSUCP",238,0)
 S PSULCT=PSULCT+1
"RTN","PSUCP",239,0)
 S $P(^XTMP(PSUSUB,"XMD",PSULCT),"-",80)="" S PSULCT=PSULCT+1
"RTN","PSUCP",240,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="" S PSULCT=PSULCT+1
"RTN","PSUCP",241,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="**NOTE:  Timing for the Provider Information extract is not recorded when the" S PSULCT=PSULCT+1
"RTN","PSUCP",242,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="         the IV, Unit Dose, Prescription, and Patient Demographics extracts" S PSULCT=PSULCT+1
"RTN","PSUCP",243,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="         are run concurrently."
"RTN","PSUCP",244,0)
 S PSUDIV=PSUSNDR
"RTN","PSUCP",245,0)
 S PSUSUBJ="PBM TIMING for report "
"RTN","PSUCP",246,0)
 D XMD
"RTN","PSUCP",247,0)
TIMINGQ Q
"RTN","PSUCP",248,0)
 ;
"RTN","PSUCP",249,0)
LEAPYR(FMYR) ; Check to see if year is a leap year: 1=leap year, 0=not leap year
"RTN","PSUCP",250,0)
 N YYYY
"RTN","PSUCP",251,0)
 S YYYY=1700+$E(FMYR,1,3)
"RTN","PSUCP",252,0)
 Q (((YYYY#4=0)&(YYYY#100'=0))!((YYYY#100=0)&(YYYY#400=0)))
"RTN","PSUCS1")
0^35^B6741320
"RTN","PSUCS1",1,0)
PSUCS1 ;BIR/DJE - PBM CONTROLLED SUBSTANCE GENERATE RECORDS ;20 OCT 1999
"RTN","PSUCS1",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**1,7,9,16,19,24**;Oct 15, 1998
"RTN","PSUCS1",3,0)
 ;
"RTN","PSUCS1",4,0)
 ;DBIA(s)
"RTN","PSUCS1",5,0)
 ; Reference to file #58.81 supported by DBIA 2520
"RTN","PSUCS1",6,0)
 ;
"RTN","PSUCS1",7,0)
 ;3.2.5.1.  Functional Requirement 1
"RTN","PSUCS1",8,0)
 ;3.2.5.2.  Functional Requirement 2
"RTN","PSUCS1",9,0)
 ; DTTM=DATE/TIME
"RTN","PSUCS1",10,0)
 ; PSULOC=PSULOCATION
"RTN","PSUCS1",11,0)
 ; PSUTYP=DISPENSING TYPE
"RTN","PSUCS1",12,0)
 ; PSUIENDA=TRANSACTION
"RTN","PSUCS1",13,0)
INIT ;
"RTN","PSUCS1",14,0)
 S PSUCSJB=$G(PSUCSJB,"PSUCS_"_PSUJOB)
"RTN","PSUCS1",15,0)
 ;*** THE DEFAULT RECORD INDICATOR IS 'H' AND 
"RTN","PSUCS1",16,0)
 ;
"RTN","PSUCS1",17,0)
 K ^XTMP(PSUCSJB)
"RTN","PSUCS1",18,0)
 I '$D(^XTMP(PSUCSJB)) D
"RTN","PSUCS1",19,0)
 . S X1=DT,X2=6 D C^%DTC
"RTN","PSUCS1",20,0)
 . S ^XTMP(PSUCSJB,0)=X_"^"_DT_"^ Controlled Substance Extraction"
"RTN","PSUCS1",21,0)
 S FACILITY=PSUSNDR
"RTN","PSUCS1",22,0)
 S PSUSDT=$G(PSUSDT,"")
"RTN","PSUCS1",23,0)
 S PSUEDT=$G(PSUEDT,"")
"RTN","PSUCS1",24,0)
 S PSUEDT=PSUEDT\1+.24
"RTN","PSUCS1",25,0)
 S PSURI="H"
"RTN","PSUCS1",26,0)
 S PSUMCHK=0
"RTN","PSUCS1",27,0)
 Q
"RTN","PSUCS1",28,0)
 ;
"RTN","PSUCS1",29,0)
EN ;ENTRY POINT
"RTN","PSUCS1",30,0)
 D INIT
"RTN","PSUCS1",31,0)
 S DTTM=PSUSDT
"RTN","PSUCS1",32,0)
 F  S DTTM=$O(^PSD(58.81,"AF",DTTM)) Q:(DTTM="")!(DTTM'<PSUEDT)  D
"RTN","PSUCS1",33,0)
 .S PSULOC=""
"RTN","PSUCS1",34,0)
 .F  S PSULOC=$O(^PSD(58.81,"AF",DTTM,PSULOC)) Q:PSULOC=""  D
"RTN","PSUCS1",35,0)
 .. S PSUTYP=""
"RTN","PSUCS1",36,0)
 .. F  S PSUTYP=$O(^PSD(58.81,"AF",DTTM,PSULOC,PSUTYP)) Q:PSUTYP=""  D
"RTN","PSUCS1",37,0)
 ... ;3.2.5.3.  Functional Requirement 3
"RTN","PSUCS1",38,0)
 ... ;'2'-Dispensed from Pharmacy or '17'- Logged for Patient.
"RTN","PSUCS1",39,0)
 ... Q:(PSUTYP'=17)&(PSUTYP'=2) 
"RTN","PSUCS1",40,0)
 ... ; section 3.2.5.10.
"RTN","PSUCS1",41,0)
 ... ; Check for type 17
"RTN","PSUCS1",42,0)
 ... S PSUIENDA=""
"RTN","PSUCS1",43,0)
 ... F  S PSUIENDA=$O(^PSD(58.81,"AF",DTTM,PSULOC,PSUTYP,PSUIENDA)) Q:PSUIENDA=""  D
"RTN","PSUCS1",44,0)
 .... ; patient IEN
"RTN","PSUCS1",45,0)
 .... S PSUPIEN(73)=$$VALI^PSUTL(58.81,PSUIENDA,"73")
"RTN","PSUCS1",46,0)
 .... ;
"RTN","PSUCS1",47,0)
 .... ; Screen out test patients
"RTN","PSUCS1",48,0)
 .... Q:$$TESTPAT^PSUTL1(PSUPIEN(73))
"RTN","PSUCS1",49,0)
 .... ; Field # 58.81,3 [DATE/TIME]********Field to be extracted***********
"RTN","PSUCS1",50,0)
 .... S PSUDTM(3)=$$VALI^PSUTL(58.81,PSUIENDA,"3")
"RTN","PSUCS1",51,0)
 .... S PSURI="H" S SENDER=PSUSNDR ;DUZ
"RTN","PSUCS1",52,0)
 .... I PSUTYP=2 D TYP2^PSUCS2 D:'$G(PSUQUIT) BUILDREC^PSUCS5 K PSUSSN,PSUPLC,PSUQUIT ;**9
"RTN","PSUCS1",53,0)
 .... I PSUTYP=17,PSUPIEN(73)'="" D TYP17^PSUCS3 K PSUPLC
"RTN","PSUCS1",54,0)
 .... ;     type 17s to be processed after all are gathered
"RTN","PSUCS1",55,0)
 .... ;     into ^XTMP(,"MC",LOC,PAT,DRG)
"RTN","PSUCS1",56,0)
 ....;3.2.5.5.  Functional Requirement 5
"RTN","PSUCS1",57,0)
 D EN^PSUCS17 ; process type 17s that have been gathered
"RTN","PSUCS1",58,0)
 Q
"RTN","PSUCS5")
0^27^B5745891
"RTN","PSUCS5",1,0)
PSUCS5 ;BIR/DJE,DJM - PBM CS ASSEMBLE RECORD ;10 JUL 1999
"RTN","PSUCS5",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**1,7,14,19,24**;Oct 15, 1998
"RTN","PSUCS5",3,0)
 ;
"RTN","PSUCS5",4,0)
 ; DBIA(s)
"RTN","PSUCS5",5,0)
 ; none needed for this routine
"RTN","PSUCS5",6,0)
 ;
"RTN","PSUCS5",7,0)
 ; ************************************************
"RTN","PSUCS5",8,0)
 ; Build a reporting record(s)
"RTN","PSUCS5",9,0)
 ; ************************************************
"RTN","PSUCS5",10,0)
 ;
"RTN","PSUCS5",11,0)
 ;
"RTN","PSUCS5",12,0)
BUILDREC ; Assemble record
"RTN","PSUCS5",13,0)
 Q:'$G(PSUTQY(5))  ; quit if quantity = 0
"RTN","PSUCS5",14,0)
 K PSUR
"RTN","PSUCS5",15,0)
 I PSUTYP=2,$S(PSULTP(1)="M":0,PSULTP(1)="S":0,1:1) Q
"RTN","PSUCS5",16,0)
 I PSUTYP=17,$S(PSULTP(1)="N":0,1:1) Q
"RTN","PSUCS5",17,0)
 I PSUTYP=2 S PSUMCHK=0
"RTN","PSUCS5",18,0)
 S PSURIEN=$S(PSUMCHK:PSUMCIEN,1:PSUIENDA)
"RTN","PSUCS5",19,0)
 ;S DRUG=$S(PSUTYP=2:PSUDRG(4),1:PSUDSE(4))
"RTN","PSUCS5",20,0)
 S DRUG=PSUDRG(4)
"RTN","PSUCS5",21,0)
 S PSURDIV=$S(PSURI="H":"H",1:1)
"RTN","PSUCS5",22,0)
 S PSUR(0)=PSUTYP
"RTN","PSUCS5",23,0)
 S PSUR(2)=$G(SENDER)
"RTN","PSUCS5",24,0)
 S PSUR(3)=$G(PSURI)
"RTN","PSUCS5",25,0)
 ;S PSUR(4)=$P($S(PSUTYP=2:PSUDTM(3),1:""),".",1) ; Just the data
"RTN","PSUCS5",26,0)
 S PSUR(4)=PSUDTM(3)\1
"RTN","PSUCS5",27,0)
 ;S PSUR(4)=SEE ^XTMP(PSUCSJB,"MC",PSURDIV,PSUIENDA,DRUG)=PSUDTM(3)
"RTN","PSUCS5",28,0)
 S PSUR(5)=$G(PSUPLC(.01))
"RTN","PSUCS5",29,0)
 S PSUR(6)=$G(PSUSSN(.09))
"RTN","PSUCS5",30,0)
 S PSUR(7)=$G(PSUVPN(21))
"RTN","PSUCS5",31,0)
 S PSUR(8)=$G(PSUFID(.01))
"RTN","PSUCS5",32,0)
 S PSUR(9)=$G(PSUGDN(.01))
"RTN","PSUCS5",33,0)
 S PSUR(10)=$G(PSUFID(51))
"RTN","PSUCS5",34,0)
 S PSUR(11)=$G(PSUNFI(17))
"RTN","PSUCS5",35,0)
 S PSUR(12)=$G(PSUNFR(.01))
"RTN","PSUCS5",36,0)
 S PSUR(13)=$G(PSUNDC(31))
"RTN","PSUCS5",37,0)
 S PSUR(14)=$G(UNIT)
"RTN","PSUCS5",38,0)
 I PSUTYP=2 S PSUR(15)=$G(PSUPDT(8))
"RTN","PSUCS5",39,0)
 S PSUR(16)=$G(PSUPDU(16))
"RTN","PSUCS5",40,0)
 S PSUR(17)=PSUTQY(5) ; both from type 2 & 17
"RTN","PSUCS5",41,0)
 S PSUR(18)=$S($G(PSUDRG(52)):"N/F",1:"")
"RTN","PSUCS5",42,0)
 S PSUR(19)=$G(PSUDRG(3))
"RTN","PSUCS5",43,0)
 I PSUR(6)'="" S PSUSSN=PSUR(6) D ICN^PSUIV2 D
"RTN","PSUCS5",44,0)
 .;MVP OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUCS5",45,0)
 .S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUCS5",46,0)
 S PSUR(20)=$G(PSUPICN)
"RTN","PSUCS5",47,0)
 S PSUR=""
"RTN","PSUCS5",48,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S PSUR(I)=$TR(PSUR(I),"^","'")
"RTN","PSUCS5",49,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S $P(PSUR,"^",I)=PSUR(I)
"RTN","PSUCS5",50,0)
 S PSUR=PSUR_"^"
"RTN","PSUCS5",51,0)
 S PSURC=$G(PSURC,0)+1
"RTN","PSUCS5",52,0)
 S PSURDIV=$S(PSURI="H":PSUSNDR,1:SENDER) ;PSUTYP=2:$S(PSUOS(20)="":PSUDIV(3.5),1:PSUOS(20)),1:PSUDIV(.015))
"RTN","PSUCS5",53,0)
 I 'PSUMCHK D
"RTN","PSUCS5",54,0)
 . S ^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN)=PSURC
"RTN","PSUCS5",55,0)
 . M ^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN,PSURC)=PSUR
"RTN","PSUCS5",56,0)
 I PSUMCHK D
"RTN","PSUCS5",57,0)
 . S PSURRC=$G(^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN))
"RTN","PSUCS5",58,0)
 . S $P(^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN,PSURRC),"^",17)=PSUR(17)
"RTN","PSUCS5",59,0)
 K PSUR
"RTN","PSUCS5",60,0)
 Q
"RTN","PSUDEM1")
0^24^B37845798
"RTN","PSUDEM1",1,0)
PSUDEM1 ;BIR/DAM - Patient Demographics Extract ;20 DEC 2001
"RTN","PSUDEM1",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**19,21,24**;Oct 15, 1998
"RTN","PSUDEM1",3,0)
 ;
"RTN","PSUDEM1",4,0)
 ;DBIA's
"RTN","PSUDEM1",5,0)
 ; Reference to file #27.11  supported by DBIA 2462
"RTN","PSUDEM1",6,0)
 ; Reference to file 2       supported by DBIA 10035, 3504
"RTN","PSUDEM1",7,0)
 ; Reference to file 200     supported by DBIA 10060
"RTN","PSUDEM1",8,0)
 ; Reference to file 55      supported by DBIA 3502
"RTN","PSUDEM1",9,0)
 ; Reference to file 4.3     supported by DBIA 2496, 10091
"RTN","PSUDEM1",10,0)
 ; Reference to file 4       supported by DBIA 10090
"RTN","PSUDEM1",11,0)
 ;
"RTN","PSUDEM1",12,0)
EN ;EN   Routine control module
"RTN","PSUDEM1",13,0)
 ;
"RTN","PSUDEM1",14,0)
 D DAT
"RTN","PSUDEM1",15,0)
 D DEM
"RTN","PSUDEM1",16,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D XMD
"RTN","PSUDEM1",17,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUXMD")
"RTN","PSUDEM1",18,0)
 ;
"RTN","PSUDEM1",19,0)
 I $G(^XTMP("PSU_"_PSUJOB,"PSUPSUMFLAG"))=1 D
"RTN","PSUDEM1",20,0)
 .S PSUOPTS="1,2,3,4,5,6,7,8,9,10,11"
"RTN","PSUDEM1",21,0)
 .S PSUAUTO=1
"RTN","PSUDEM1",22,0)
 ;
"RTN","PSUDEM1",23,0)
 D PULL^PSUCP
"RTN","PSUDEM1",24,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUDEM1",25,0)
 ;
"RTN","PSUDEM1",26,0)
 I $D(PSUMOD(10)) D PDSSN^PSUDEM4  ;pt. demographics provider msg
"RTN","PSUDEM1",27,0)
 ;
"RTN","PSUDEM1",28,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUPDFLAG")
"RTN","PSUDEM1",29,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUDM")
"RTN","PSUDEM1",30,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUDMX")
"RTN","PSUDEM1",31,0)
 K PSUDMDFN,PSURAC,PSURDT
"RTN","PSUDEM1",32,0)
 Q
"RTN","PSUDEM1",33,0)
 ;
"RTN","PSUDEM1",34,0)
DAT ;Date Module
"RTN","PSUDEM1",35,0)
 ;
"RTN","PSUDEM1",36,0)
 ;Date extract was run
"RTN","PSUDEM1",37,0)
 S %H=$H
"RTN","PSUDEM1",38,0)
 D YMD^%DTC                   ;Converts $H to FileMan format
"RTN","PSUDEM1",39,0)
 S $P(^TMP("PSUDM",$J),U,3)=X    ;Set extract date in temp global
"RTN","PSUDEM1",40,0)
 S PSURDT=X
"RTN","PSUDEM1",41,0)
 ;
"RTN","PSUDEM1",42,0)
 Q
"RTN","PSUDEM1",43,0)
 ;
"RTN","PSUDEM1",44,0)
INST ;EN  Place institution code sending report into temp global.
"RTN","PSUDEM1",45,0)
 ;Institution Mailman info is in file 4.3 
"RTN","PSUDEM1",46,0)
 ;
"RTN","PSUDEM1",47,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSUDEM1",48,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)=PSUSNDR
"RTN","PSUDEM1",49,0)
 S PSUSIT=PSUSNDR
"RTN","PSUDEM1",50,0)
 ;
"RTN","PSUDEM1",51,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUDEM1",52,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUDEM1",53,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)=PSUDIVNM
"RTN","PSUDEM1",54,0)
 Q
"RTN","PSUDEM1",55,0)
 ;
"RTN","PSUDEM1",56,0)
DEM ;PULL PATIENT DEMOGRAPHICS 
"RTN","PSUDEM1",57,0)
 ;
"RTN","PSUDEM1",58,0)
 N PSUREC
"RTN","PSUDEM1",59,0)
 K PSUREC1,PSUREC2,PSUREC3,PSUREC4,PSUREC5,PSUREC6,PSUREC7
"RTN","PSUDEM1",60,0)
 K PSUREC8,PSUREC9,PSUREC10,PSUREC11,PSUREC12,PSUREC13,PSUREC14
"RTN","PSUDEM1",61,0)
 K PSUREC15,PSUDOD,VAEL,VADM
"RTN","PSUDEM1",62,0)
 ;
"RTN","PSUDEM1",63,0)
 S PSUNAM=0
"RTN","PSUDEM1",64,0)
 F  S PSUNAM=$O(^DPT("B",PSUNAM)) Q:PSUNAM=""  D
"RTN","PSUDEM1",65,0)
 .S PSUDMDFN=0
"RTN","PSUDEM1",66,0)
 .F  S (DFN,PSUDMDFN)=$O(^DPT("B",PSUNAM,PSUDMDFN)) Q:PSUDMDFN=""  D
"RTN","PSUDEM1",67,0)
 ..K PSUREC,PSUREC1,PSUREC2,PSUREC3,PSUREC4,PSUREC5,PSUREC6,PSUREC7
"RTN","PSUDEM1",68,0)
 ..K PSUREC8,PSUREC9,PSUREC10,PSUREC11,PSUREC12,PSUREC13,PSUREC14
"RTN","PSUDEM1",69,0)
 ..K PSUREC15,PSUDOD,VAEL,VADM
"RTN","PSUDEM1",70,0)
 ..S PSUDOD=$P($G(^DPT(PSUDMDFN,.35)),U,1) I PSUDOD,PSUDOD<2980701 Q
"RTN","PSUDEM1",71,0)
 ..Q:'$D(^DPT(PSUDMDFN,0))  S PSUREC1=$G(^DPT(PSUDMDFN,0))
"RTN","PSUDEM1",72,0)
 ..I $P(PSUREC1,U,21)=1 Q
"RTN","PSUDEM1",73,0)
 ..I $E($P(PSUREC1,U,9),1,5)="00000" Q
"RTN","PSUDEM1",74,0)
 ..D DEM^VADPT
"RTN","PSUDEM1",75,0)
 ..D ELIG^VADPT
"RTN","PSUDEM1",76,0)
 ..;RUN DATE
"RTN","PSUDEM1",77,0)
 ..S $P(PSUREC,U,3)=PSURDT
"RTN","PSUDEM1",78,0)
 ..;Gender
"RTN","PSUDEM1",79,0)
 ..S PSUREC3=$TR($P(PSUREC1,U,2),"^","'"),$P(PSUREC,U,8)=PSUREC3
"RTN","PSUDEM1",80,0)
 ..;SSN
"RTN","PSUDEM1",81,0)
 ..S PSUREC4=$TR($P(PSUREC1,U,9),"^","'"),$P(PSUREC,U,12)=PSUREC4
"RTN","PSUDEM1",82,0)
 ..;DOB
"RTN","PSUDEM1",83,0)
 ..S PSUREC5=$TR($P(PSUREC1,U,3),"^","'"),$P(PSUREC,U,5)=PSUREC5
"RTN","PSUDEM1",84,0)
 ..;DT PT ENTERED IN FILE
"RTN","PSUDEM1",85,0)
 ..S PSUREC6=$TR($P(PSUREC1,U,16),"^","'"),$P(PSUREC,U,16)=PSUREC6
"RTN","PSUDEM1",86,0)
 ..S PSUREC7=$G(^PS(55,PSUDMDFN,0)),$P(PSUREC,U,17)=$TR($P(PSUREC7,U,7),"^","'")
"RTN","PSUDEM1",87,0)
 ..;Service Actual/Historical
"RTN","PSUDEM1",88,0)
 ..S $P(PSUREC,U,18)=$TR($P(PSUREC7,U,8),"^","'")
"RTN","PSUDEM1",89,0)
 ..;PLACE "^" AT END OF RECORD
"RTN","PSUDEM1",90,0)
 ..S $P(PSUREC,U,30)=""
"RTN","PSUDEM1",91,0)
 ..;SITE SENDING DATA
"RTN","PSUDEM1",92,0)
 ..S $P(PSUREC,U,2)=PSUSNDR
"RTN","PSUDEM1",93,0)
 ..;RACE
"RTN","PSUDEM1",94,0)
 ..S PSUREC8=$P($G(VADM(8)),U,2),$P(PSUREC,U,7)=PSUREC8
"RTN","PSUDEM1",95,0)
 ..;PRIMARY ELIG CODE
"RTN","PSUDEM1",96,0)
 ..S PSUREC9=$P($G(VAEL(1)),U,2),$P(PSUREC,U,9)=PSUREC9
"RTN","PSUDEM1",97,0)
 ..D PRIO
"RTN","PSUDEM1",98,0)
 ..;MEANS TEST STATUS
"RTN","PSUDEM1",99,0)
 ..S PSUREC11=$P($G(VAEL(9)),U,2),$P(PSUREC,U,10)=PSUREC11
"RTN","PSUDEM1",100,0)
 ..D MISC
"RTN","PSUDEM1",101,0)
 ..;FIND PATIENT ICN-VMP
"RTN","PSUDEM1",102,0)
 ..D ICN
"RTN","PSUDEM1",103,0)
 ..;PATIENT CURRENT AGE
"RTN","PSUDEM1",104,0)
 ..S PSUREC12=$G(VADM(4)),$P(PSUREC,U,6)=PSUREC12
"RTN","PSUDEM1",105,0)
 ..D ETH
"RTN","PSUDEM1",106,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUDMX",PSUDMDFN)=$G(PSUREC)
"RTN","PSUDEM1",107,0)
 Q
"RTN","PSUDEM1",108,0)
 ;
"RTN","PSUDEM1",109,0)
PRIO ;Pull Enrollment Priority
"RTN","PSUDEM1",110,0)
 ;
"RTN","PSUDEM1",111,0)
 S PSUEC=0
"RTN","PSUDEM1",112,0)
 F  S PSUEC=$O(^DGEN(27.11,"C",PSUDMDFN,PSUEC)) Q:PSUEC=""  D
"RTN","PSUDEM1",113,0)
 .S PSUREC10=$TR($P($G(^DGEN(27.11,PSUEC,0)),U,7),"^","'")
"RTN","PSUDEM1",114,0)
 .I PSUREC10'="" S $P(PSUREC,U,11)=PSUREC10
"RTN","PSUDEM1",115,0)
 Q
"RTN","PSUDEM1",116,0)
 ;
"RTN","PSUDEM1",117,0)
MISC ;Pulls miscellaneous additional info via EN^DIQ1 call
"RTN","PSUDEM1",118,0)
 ;Pulls Date of Death, ICN, Primary Care Provider SSN,
"RTN","PSUDEM1",119,0)
 ;Date patient first provided pharmacy care
"RTN","PSUDEM1",120,0)
 ;
"RTN","PSUDEM1",121,0)
 N PSUDATMP,PSUDDTMP,PSUDTMPA
"RTN","PSUDEM1",122,0)
 ;
"RTN","PSUDEM1",123,0)
 S PSUDTMPA=$$OUTPTPR^SDUTL3(PSUDMDFN)   ;Prov IEN^EXTERNAL VALUE in temp variable
"RTN","PSUDEM1",124,0)
 S PSUDATMP=$P($G(PSUDTMPA),U)       ;Prov IEN
"RTN","PSUDEM1",125,0)
 S $P(PSUREC,U,15)=PSUDATMP
"RTN","PSUDEM1",126,0)
 I '$D(PSUDATMP)!PSUDATMP=0 S PSUDATMP=99999999999
"RTN","PSUDEM1",127,0)
 S $P(PSUREC,U,14)=$$GET1^DIQ(200,PSUDATMP,9,"I")   ;Prov SSN
"RTN","PSUDEM1",128,0)
 S $P(PSUREC,U,4)=$S(PSUDOD:PSUDOD\1,1:"")
"RTN","PSUDEM1",129,0)
 Q
"RTN","PSUDEM1",130,0)
 ;
"RTN","PSUDEM1",131,0)
ICN ;Find patient ICN
"RTN","PSUDEM1",132,0)
 ;VMP - OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUDEM1",133,0)
 ;
"RTN","PSUDEM1",134,0)
 N PSUICN,PSUICN1
"RTN","PSUDEM1",135,0)
 S PSUICN=$$GETICN^MPIF001(PSUDMDFN) D
"RTN","PSUDEM1",136,0)
 .I PSUICN'[-1 D
"RTN","PSUDEM1",137,0)
 ..S $P(PSUREC,U,13)=PSUICN    ;ICN
"RTN","PSUDEM1",138,0)
 Q
"RTN","PSUDEM1",139,0)
 ;
"RTN","PSUDEM1",140,0)
ETH ;Ethnicity and multiple race entries
"RTN","PSUDEM1",141,0)
 ;
"RTN","PSUDEM1",142,0)
 S PSUREC14=$P($G(VADM(11,1)),U,2),$P(PSUREC,U,19)=PSUREC14
"RTN","PSUDEM1",143,0)
 ;
"RTN","PSUDEM1",144,0)
 S PSURCE=0,C=20,$P(PSUREC,U,C)=""
"RTN","PSUDEM1",145,0)
 F  S PSURCE=$O(VADM(12,PSURCE)) Q:PSURCE=""  D       ;Race multiple
"RTN","PSUDEM1",146,0)
 .S PSURAC=$P($G(VADM(12,PSURCE)),U,2),$P(PSUREC,U,C)=PSURAC,C=C+1
"RTN","PSUDEM1",147,0)
 Q
"RTN","PSUDEM1",148,0)
 ;
"RTN","PSUDEM1",149,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM1",150,0)
 ;
"RTN","PSUDEM1",151,0)
 S PSUAB=0,PSUPL=1
"RTN","PSUDEM1",152,0)
 F  S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUDMX",PSUAB)) Q:PSUAB=""  D
"RTN","PSUDEM1",153,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSUDM",PSUPL)=^XTMP("PSU_"_PSUJOB,"PSUDMX",PSUAB)  ;Global numerical order
"RTN","PSUDEM1",154,0)
 .S PSUPL=PSUPL+1
"RTN","PSUDEM1",155,0)
 ;
"RTN","PSUDEM1",156,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM1",157,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM1",158,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM1",159,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM1",160,0)
 F PSULC=1:1 S X=$G(^XTMP("PSU_"_PSUJOB,"PSUDM",PSULC)) Q:X=""  D
"RTN","PSUDEM1",161,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM1",162,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM1",163,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM1",164,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM1",165,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM1",166,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM1",167,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM1",168,0)
 ;
"RTN","PSUDEM1",169,0)
 ;   Count Lines sent
"RTN","PSUDEM1",170,0)
 S PSUTLC=0
"RTN","PSUDEM1",171,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM1",172,0)
 ;
"RTN","PSUDEM1",173,0)
 F PSUM=1:1:PSUMC D PDMAIL^PSUDEM5
"RTN","PSUDEM1",174,0)
 D CONF
"RTN","PSUDEM1",175,0)
 Q
"RTN","PSUDEM1",176,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM1",177,0)
 ;
"RTN","PSUDEM1",178,0)
 N PSUDIVIS
"RTN","PSUDEM1",179,0)
 D INST
"RTN","PSUDEM1",180,0)
 S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM1",181,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM1",182,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,7,"M")=PSUMC
"RTN","PSUDEM1",183,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,7,"L")=PSUTLC
"RTN","PSUDEM1",184,0)
 Q
"RTN","PSUDEM1",185,0)
REC ;EN If "^" is contained in any record, replace it with "'"
"RTN","PSUDEM1",186,0)
 ;
"RTN","PSUDEM1",187,0)
 I PSUREC["^" S PSUREC=$TR(PSUREC,"^","'")
"RTN","PSUDEM1",188,0)
 Q
"RTN","PSUDEM2")
0^33^B20153453
"RTN","PSUDEM2",1,0)
PSUDEM2 ;BIR/DAM - Outpatient Visits Extract ;20 DEC 2001
"RTN","PSUDEM2",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**19,24**;Oct 15, 1998
"RTN","PSUDEM2",3,0)
 ;
"RTN","PSUDEM2",4,0)
 ;DBIA's
"RTN","PSUDEM2",5,0)
 ; Reference to file 2            supported by DBIA 10035
"RTN","PSUDEM2",6,0)
 ; Reference to file 9000010.07   supported by DBIA 3094
"RTN","PSUDEM2",7,0)
 ; Reference to file 9000010      supported by DBIA 3512
"RTN","PSUDEM2",8,0)
 ; Reference to file 4.3          supported by DBIA 2496
"RTN","PSUDEM2",9,0)
 ; Reference to file 80           supported by DBIA 10082
"RTN","PSUDEM2",10,0)
 ; Reference to file 9000010.18   supported by DBIA 3560
"RTN","PSUDEM2",11,0)
 ; Reference to file 81           supported by DBIA 2815
"RTN","PSUDEM2",12,0)
EN ;EN Called from PSUCP
"RTN","PSUDEM2",13,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUOPV"),^XTMP("PSU_"_PSUJOB,"PSUTMP")
"RTN","PSUDEM2",14,0)
 K NONE
"RTN","PSUDEM2",15,0)
 NEW CPTDA,CPTNM,ICD9DA,ICD9NM,PSUICN,PSUSSN,PSUSUB,PSUTEDT
"RTN","PSUDEM2",16,0)
 NEW PSUVSTDT,PSUX,PSUY,PTSTAT,SEG,VCPTDA,XX,J
"RTN","PSUDEM2",17,0)
 D DAT1
"RTN","PSUDEM2",18,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUTMP")) D NODATA
"RTN","PSUDEM2",19,0)
 D XMD
"RTN","PSUDEM2",20,0)
EX K ^XTMP("PSU_"_PSUJOB,"PSUPDFLAG")
"RTN","PSUDEM2",21,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUOPV")
"RTN","PSUDEM2",22,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUXMD")
"RTN","PSUDEM2",23,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTMP")
"RTN","PSUDEM2",24,0)
 Q
"RTN","PSUDEM2",25,0)
 ;
"RTN","PSUDEM2",26,0)
 ;
"RTN","PSUDEM2",27,0)
DAT1 ;Find visits from V POV file that fall within the date range
"RTN","PSUDEM2",28,0)
 S PSUTEDT=PSUEDT
"RTN","PSUDEM2",29,0)
 S PSUDT=PSUSDT-1,PSUX=9999999-PSUDT,PSUY=9999999-PSUEDT N PSUEDT
"RTN","PSUDEM2",30,0)
 S PSUY=PSUSDT-.0001
"RTN","PSUDEM2",31,0)
 F  S PSUY=$O(^AUPNVSIT("B",PSUY)) Q:PSUY'>0  Q:((PSUY\1)>PSUTEDT)  D
"RTN","PSUDEM2",32,0)
 . S PSUVIEN=0 F  S PSUVIEN=$O(^AUPNVSIT("B",PSUY,PSUVIEN)) Q:$G(PSUVIEN)'>0  D
"RTN","PSUDEM2",33,0)
 .. S PSUPT=$$VALI^PSUTL(9000010,PSUVIEN,.05)
"RTN","PSUDEM2",34,0)
 .. D DAT2
"RTN","PSUDEM2",35,0)
 Q
"RTN","PSUDEM2",36,0)
DAT2 ;
"RTN","PSUDEM2",37,0)
 S PSUPOV=0 F  S PSUPOV=$O(^AUPNVPOV("AD",PSUVIEN,PSUPOV)) Q:PSUPOV'>0  D
"RTN","PSUDEM2",38,0)
 .N PSUVIEN
"RTN","PSUDEM2",39,0)
 .S PSUVIEN=$P($G(^AUPNVPOV(PSUPOV,0)),U,3)
"RTN","PSUDEM2",40,0)
 .Q:PSUVIEN=""
"RTN","PSUDEM2",41,0)
 .Q:$D(^XTMP("PSU"_PSUJOB,"PSUOPV",PSUVIEN))  ; quit if visit psuvien already stored
"RTN","PSUDEM2",42,0)
 . D POVS
"RTN","PSUDEM2",43,0)
 .S PSUVSTDT=$P($G(^AUPNVSIT(PSUVIEN,0)),U)\1
"RTN","PSUDEM2",44,0)
 .S PSUSSN=$P(^DPT(PSUPT,0),U,9)
"RTN","PSUDEM2",45,0)
 .S PSUICN=$$GETICN^MPIF001(PSUPT)
"RTN","PSUDEM2",46,0)
 .I PSUICN[-1 S PSUICN=""
"RTN","PSUDEM2",47,0)
 .S PTSTAT=$P(^AUPNVSIT(PSUVIEN,150),U,2),PTSTAT=$S(+PTSTAT:"I",1:"O")
"RTN","PSUDEM2",48,0)
 . D SET
"RTN","PSUDEM2",49,0)
 Q
"RTN","PSUDEM2",50,0)
POVS ;severl POVs can have same visit, work all when the first is found
"RTN","PSUDEM2",51,0)
 N PSUPOV
"RTN","PSUDEM2",52,0)
 S PSUPOV=0 F  S PSUPOV=$O(^AUPNVPOV("AD",PSUVIEN,PSUPOV)) Q:PSUPOV'>0  D
"RTN","PSUDEM2",53,0)
 . K ALLICD9,ALLCPT
"RTN","PSUDEM2",54,0)
 .;LOOP CPTs linked by visit 
"RTN","PSUDEM2",55,0)
 . S VCPTDA=0 F  S VCPTDA=$O(^AUPNVCPT("AD",PSUVIEN,VCPTDA)) Q:VCPTDA'>0  D
"RTN","PSUDEM2",56,0)
 .. ; get/gather cpts
"RTN","PSUDEM2",57,0)
 ..S CPTDA=$P($G(^AUPNVCPT(VCPTDA,0)),U),CPTNM=$P($G(^ICPT(CPTDA,0)),U) S:$L(CPTNM) ALLCPT(CPTNM)=""
"RTN","PSUDEM2",58,0)
 .. ;get/gather icd9s 
"RTN","PSUDEM2",59,0)
 ..S ICD9DA=$P($G(^AUPNVCPT(VCPTDA,0)),U,5) I ICD9DA S ICD9NM=$P($G(^ICD9(ICD9DA,0)),U) S:$L(ICD9NM) ALLICD9(ICD9NM)=""
"RTN","PSUDEM2",60,0)
 . ;get orig ICD9
"RTN","PSUDEM2",61,0)
 .S ICD9DA=$P($G(^AUPNVPOV(PSUPOV,0)),U) I ICD9DA S ICD9NM=$P($G(^ICD9(ICD9DA,0)),U) S:$L(ICD9NM) ALLICD9(ICD9NM)=""
"RTN","PSUDEM2",62,0)
 Q
"RTN","PSUDEM2",63,0)
SET ; Set segment
"RTN","PSUDEM2",64,0)
 I '$D(ALLICD9),'$D(ALLCPT) Q  ;insure visit has either CPT or ICD9
"RTN","PSUDEM2",65,0)
 ;assemble elements and set
"RTN","PSUDEM2",66,0)
 S SEG=U_PSUSNDR_U_PTSTAT_U_PSUVSTDT_U_PSUSSN_U_PSUICN_U
"RTN","PSUDEM2",67,0)
 I $D(ALLICD9) S ICD9NM="" F I=7:1:16 S ICD9NM=$O(ALLICD9(ICD9NM)) Q:ICD9NM=""  S $P(SEG,U,I)=ICD9NM
"RTN","PSUDEM2",68,0)
 I $D(ALLCPT) S CPTNM="" F J=17:1:26 S CPTNM=$O(ALLCPT(CPTNM)) Q:CPTNM=""  S $P(SEG,U,J)=CPTNM
"RTN","PSUDEM2",69,0)
 S $P(SEG,U,27)=""
"RTN","PSUDEM2",70,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUVIEN)=SEG
"RTN","PSUDEM2",71,0)
 Q
"RTN","PSUDEM2",72,0)
 ;
"RTN","PSUDEM2",73,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM2",74,0)
 S PSUAB=0
"RTN","PSUDEM2",75,0)
 F PSUPL=1:1 S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUAB)) Q:PSUAB'>0  S XX=^(PSUAB) D
"RTN","PSUDEM2",76,0)
 . S ^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUPL)=XX
"RTN","PSUDEM2",77,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM2",78,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM2",79,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM2",80,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM2",81,0)
 F PSULC=1:1 S X=$G(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSULC)) Q:X=""  D
"RTN","PSUDEM2",82,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM2",83,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM2",84,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM2",85,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM2",86,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM2",87,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM2",88,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM2",89,0)
 ;
"RTN","PSUDEM2",90,0)
TLC ;   Count Lines sent
"RTN","PSUDEM2",91,0)
 S PSUTLC=0
"RTN","PSUDEM2",92,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM2",93,0)
 ;
"RTN","PSUDEM2",94,0)
 F PSUM=1:1:PSUMC D OPV^PSUDEM5
"RTN","PSUDEM2",95,0)
 D CONF
"RTN","PSUDEM2",96,0)
 Q
"RTN","PSUDEM2",97,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM2",98,0)
 ;
"RTN","PSUDEM2",99,0)
 I $G(NONE) S PSUTLC=0
"RTN","PSUDEM2",100,0)
 N PSUDIVIS
"RTN","PSUDEM2",101,0)
 S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM2",102,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM2",103,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,8,"M")=PSUMC
"RTN","PSUDEM2",104,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,8,"L")=PSUTLC
"RTN","PSUDEM2",105,0)
 Q
"RTN","PSUDEM2",106,0)
 ;
"RTN","PSUDEM2",107,0)
NODATA ;Generate a 'No data' message if there is no data in the extract
"RTN","PSUDEM2",108,0)
 ;
"RTN","PSUDEM2",109,0)
 S NONE=1
"RTN","PSUDEM2",110,0)
 M PSUXMYH=PSUXMYS1
"RTN","PSUDEM2",111,0)
 S PSUM=1
"RTN","PSUDEM2",112,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,1)="No data to report"
"RTN","PSUDEM2",113,0)
 Q
"RTN","PSUDEM2",114,0)
REC ;EN If "^" is contained in any record, replace it with "'"
"RTN","PSUDEM2",115,0)
 ;
"RTN","PSUDEM2",116,0)
 I PSUREC["^" S PSUREC=$TR(PSUREC,"^","'")
"RTN","PSUDEM2",117,0)
 Q
"RTN","PSUDEM7")
0^25^B14211015
"RTN","PSUDEM7",1,0)
PSUDEM7 ;BIR/DAM - Inpatient PTF Record Extract ;20 DEC 2001
"RTN","PSUDEM7",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**19,21,24**;Oct 15, 1998
"RTN","PSUDEM7",3,0)
 ;
"RTN","PSUDEM7",4,0)
 ;DBIA's
"RTN","PSUDEM7",5,0)
 ; Reference to file 2    supported by DBIA 10035
"RTN","PSUDEM7",6,0)
 ; Reference to file 4.3  supported by DBIA 2496
"RTN","PSUDEM7",7,0)
 ; Reference to file 45   supported by DBIA 3511
"RTN","PSUDEM7",8,0)
 ;
"RTN","PSUDEM7",9,0)
EN ;EN
"RTN","PSUDEM7",10,0)
 D DAT
"RTN","PSUDEM7",11,0)
 D EN^PSUDEM8    ;Gather ICD9 codes
"RTN","PSUDEM7",12,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUIPV")) D NODATA
"RTN","PSUDEM7",13,0)
 D XMD
"RTN","PSUDEM7",14,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIPV")
"RTN","PSUDEM7",15,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUXMD")
"RTN","PSUDEM7",16,0)
 Q
"RTN","PSUDEM7",17,0)
 ;
"RTN","PSUDEM7",18,0)
DAT ;Find discharge dates that fall within the extract date range
"RTN","PSUDEM7",19,0)
 ;as well as discharge dates within the 30 days prior to day 1 of
"RTN","PSUDEM7",20,0)
 ;of the extract date range.
"RTN","PSUDEM7",21,0)
 ;
"RTN","PSUDEM7",22,0)
 S PSUDD=0
"RTN","PSUDEM7",23,0)
 F  S PSUDD=$O(^DGPT("ADS",PSUDD)) Q:'PSUDD  D
"RTN","PSUDEM7",24,0)
 .S PSUDDT=$E(PSUDD,1,7)
"RTN","PSUDEM7",25,0)
 .S X1=PSUSDT
"RTN","PSUDEM7",26,0)
 .S X2=(-30)
"RTN","PSUDEM7",27,0)
 .D C^%DTC
"RTN","PSUDEM7",28,0)
 .S PSUSDT1=X              ;Date 30 days prior to start date
"RTN","PSUDEM7",29,0)
 .I (PSUDDT>PSUSDT1)!(PSUDDT=PSUSDT1)&(PSUDDT<PSUEDT)!(PSUDDT=PSUEDT) D
"RTN","PSUDEM7",30,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUDM",PSUDDT)=""
"RTN","PSUDEM7",31,0)
 ..S PSUIEN=0
"RTN","PSUDEM7",32,0)
 ..F  S PSUIEN=$O(^DGPT("ADS",PSUDD,PSUIEN)) Q:'PSUIEN  D
"RTN","PSUDEM7",33,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,5)=PSUDDT        ;Discharge Date
"RTN","PSUDEM7",34,0)
 ...N PSUDT
"RTN","PSUDEM7",35,0)
 ...S PSUDT=$P($G(^DGPT(PSUIEN,0)),U,2)
"RTN","PSUDEM7",36,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,4)=$E(PSUDT,1,7)  ;Admit date
"RTN","PSUDEM7",37,0)
 ...D INST^PSUDEM1
"RTN","PSUDEM7",38,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,2)=PSUSIT         ;SITE
"RTN","PSUDEM7",39,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,3)=PSUSIT_PSUIEN  ;Unique PTF ID
"RTN","PSUDEM7",40,0)
 ...D SSNICN
"RTN","PSUDEM7",41,0)
 Q
"RTN","PSUDEM7",42,0)
 ;
"RTN","PSUDEM7",43,0)
SSNICN ;Find patient Admission date, SSN and ICN for inpatient record
"RTN","PSUDEM7",44,0)
 ;VMP - OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUDEM7",45,0)
 ;
"RTN","PSUDEM7",46,0)
 N PSUPT,PSUICN,PSUICN1
"RTN","PSUDEM7",47,0)
 S PSUPT=$P($G(^DGPT(PSUIEN,0)),U)     ;Pointer to patient file
"RTN","PSUDEM7",48,0)
 ;
"RTN","PSUDEM7",49,0)
 N PSUREC
"RTN","PSUDEM7",50,0)
 I PSUPT D
"RTN","PSUDEM7",51,0)
 .S PSUREC=$P($G(^DPT(PSUPT,0)),U,9) D REC D
"RTN","PSUDEM7",52,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,6)=PSUREC     ;Pt SSN
"RTN","PSUDEM7",53,0)
 .S PSUICN=$$GETICN^MPIF001(PSUPT) D
"RTN","PSUDEM7",54,0)
 ..I PSUICN'[-1 D
"RTN","PSUDEM7",55,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,7)=PSUICN   ;ICN
"RTN","PSUDEM7",56,0)
 Q
"RTN","PSUDEM7",57,0)
 ;
"RTN","PSUDEM7",58,0)
REC ;If "^" is contained in any record, replace it with (')
"RTN","PSUDEM7",59,0)
 ;
"RTN","PSUDEM7",60,0)
 I PSUREC["^" S PSUREC=$TR(PSUREC,"^","'")
"RTN","PSUDEM7",61,0)
 Q
"RTN","PSUDEM7",62,0)
 ;
"RTN","PSUDEM7",63,0)
NODATA ;Generate a 'No Data' message if there is no data in the extract
"RTN","PSUDEM7",64,0)
 ;
"RTN","PSUDEM7",65,0)
 S NONE=1
"RTN","PSUDEM7",66,0)
 M PSUXMYH=PSUXMYS1
"RTN","PSUDEM7",67,0)
 S PSUM=1
"RTN","PSUDEM7",68,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,1)="No data to report"
"RTN","PSUDEM7",69,0)
 Q
"RTN","PSUDEM7",70,0)
 ;
"RTN","PSUDEM7",71,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM7",72,0)
 ;
"RTN","PSUDEM7",73,0)
 S PSUAB=0,PSUPL=1
"RTN","PSUDEM7",74,0)
 F  S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUAB)) Q:PSUAB=""  D
"RTN","PSUDEM7",75,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUPL)=^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUAB)  ;Global numerical order
"RTN","PSUDEM7",76,0)
 .S PSUPL=PSUPL+1
"RTN","PSUDEM7",77,0)
 ;
"RTN","PSUDEM7",78,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM7",79,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM7",80,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM7",81,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM7",82,0)
 F PSULC=1:1 S X=$G(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSULC)) Q:X=""  D
"RTN","PSUDEM7",83,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM7",84,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM7",85,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM7",86,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM7",87,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM7",88,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM7",89,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM7",90,0)
 ;
"RTN","PSUDEM7",91,0)
 ;   Count Lines sent
"RTN","PSUDEM7",92,0)
 S PSUTLC=0
"RTN","PSUDEM7",93,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM7",94,0)
 ;
"RTN","PSUDEM7",95,0)
 F PSUM=1:1:PSUMC D PTF^PSUDEM5
"RTN","PSUDEM7",96,0)
 D CONF
"RTN","PSUDEM7",97,0)
 Q
"RTN","PSUDEM7",98,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM7",99,0)
 ;
"RTN","PSUDEM7",100,0)
 ;D INST^PSUDEM1
"RTN","PSUDEM7",101,0)
 I $G(NONE) S PSUTLC=0
"RTN","PSUDEM7",102,0)
 N PSUDIVIS
"RTN","PSUDEM7",103,0)
 ;S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM7",104,0)
 S PSUDIVIS=PSUSNDR
"RTN","PSUDEM7",105,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM7",106,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,9,"M")=PSUMC
"RTN","PSUDEM7",107,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,9,"L")=PSUTLC
"RTN","PSUDEM7",108,0)
 Q
"RTN","PSUIV2")
0^28^B35293917
"RTN","PSUIV2",1,0)
PSUIV2 ;BIR/CFL - IV functions and subroutines ;25 AUG 1998
"RTN","PSUIV2",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**14,15,19,24**;Oct 15, 1998
"RTN","PSUIV2",3,0)
 ;DBIA'S
"RTN","PSUIV2",4,0)
 ; Reference to file #2    supported by DBIA 10035 and 2701
"RTN","PSUIV2",5,0)
 ;
"RTN","PSUIV2",6,0)
GETRATE(TYPE) ;Determine if the IV type is schedule or infusion rate and calculate the subtotal of each type
"RTN","PSUIV2",7,0)
 S PSURATE=""
"RTN","PSUIV2",8,0)
 I TYPE="P" D
"RTN","PSUIV2",9,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUIV2",10,0)
 .S ^XTMP(PSUIVSUB,"TPIG",PSUFAC)=$G(^XTMP(PSUIVSUB,"TPIG",PSUFAC))+PSUDISP
"RTN","PSUIV2",11,0)
 I TYPE="A" D
"RTN","PSUIV2",12,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUIV2",13,0)
 .S ^XTMP(PSUIVSUB,"TADM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TADM",PSUFAC))+PSUDISP
"RTN","PSUIV2",14,0)
 I TYPE="H" D
"RTN","PSUIV2",15,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUIV2",16,0)
 .S ^XTMP(PSUIVSUB,"THYP",PSUFAC)=$G(^XTMP(PSUIVSUB,"THYP",PSUFAC))+PSUDISP
"RTN","PSUIV2",17,0)
 I TYPE="S"&(PSUIV(108)=1) D
"RTN","PSUIV2",18,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUIV2",19,0)
 .S ^XTMP(PSUIVSUB,"TSYR",PSUFAC)=$G(^XTMP(PSUIVSUB,"TSYR",PSUFAC))+PSUDISP
"RTN","PSUIV2",20,0)
 I TYPE="S"&(PSUIV(108)=0) D
"RTN","PSUIV2",21,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUIV2",22,0)
 .S ^XTMP(PSUIVSUB,"TSYR",PSUFAC)=$G(^XTMP(PSUIVSUB,"TSYR",PSUFAC))+PSUDISP
"RTN","PSUIV2",23,0)
 I TYPE="C"&(PSUIV(106)="P") D
"RTN","PSUIV2",24,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUIV2",25,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUIV2",26,0)
 I TYPE="C"&(PSUIV(106)="A") D
"RTN","PSUIV2",27,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUIV2",28,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUIV2",29,0)
 I TYPE="C"&(PSUIV(106)="S")&(PSUIV(108)=1) D
"RTN","PSUIV2",30,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUIV2",31,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUIV2",32,0)
 I TYPE="C"&(PSUIV(106)="S")&(PSUIV(108)=0) D
"RTN","PSUIV2",33,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUIV2",34,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUIV2",35,0)
 Q
"RTN","PSUIV2",36,0)
SETREC ;Set the ^XTMP global for IV Additives and Solutions
"RTN","PSUIV2",37,0)
 S REC="^",DLM="^",INDEX=""
"RTN","PSUIV2",38,0)
 I RECTYP="P" D
"RTN","PSUIV2",39,0)
 .S REC=REC_$TR(PSUFAC,"^","'")_DLM_$TR(PSUIV(.02),"^","'")_DLM_PSUIV(.01)_DLM
"RTN","PSUIV2",40,0)
 .S REC=REC_RECTYP_DLM_$TR(PSUIV(.04),"^","'")_DLM_PSUOUTP_DLM_PSUSSN_DLM
"RTN","PSUIV2",41,0)
 .S REC=REC_PSURATE_DLM_$TR(PSUDOC(9),"^","'")_DLM  ;_$TR(PSUPCLS,"^","'")_DLM
"RTN","PSUIV2",42,0)
 .;S REC=REC_$TR(PSUSERV,"^","'")_DLM_$TR(PSUSP1,"^","'")_DLM_$TR(PSUSP2,"^","'")_DLM
"RTN","PSUIV2",43,0)
 .S REC=REC_$TR(PSUDISP,"^","'")_DLM_$TR(PSUPRNM,"^","'")_DLM
"RTN","PSUIV2",44,0)
 .S REC=REC_$TR(PSUDCLS,"^","'")_DLM_$TR(PSUNDC,"^","'")_DLM
"RTN","PSUIV2",45,0)
 .S REC=REC_$TR(PSUNFI,"^","'")_DLM_$TR(PSIVNFI,"^","'")_DLM
"RTN","PSUIV2",46,0)
 .S REC=REC_$TR(PSIVNFR,"^","'")_DLM_$TR(PSUPNAM,"^","'")_DLM
"RTN","PSUIV2",47,0)
 .S REC=REC_RECIND_DLM_$TR(PSUGNM,"^","'")_DLM_$TR(PSUDGU,"^","'")_DLM
"RTN","PSUIV2",48,0)
 .S REC=REC_PSUDCST_DLM_PSUNITS_DLM_PSUNAF_DLM_PSUDEA_DLM
"RTN","PSUIV2",49,0)
 .D ICN
"RTN","PSUIV2",50,0)
 .;VMP - OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUIV2",51,0)
 .S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUIV2",52,0)
 .S REC=REC_$G(PSUPICN)_DLM_$G(PSUIV(.06))_DLM_$G(PSUIV(.03))_U
"RTN","PSUIV2",53,0)
 .S INDEX=$O(^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX),-1)
"RTN","PSUIV2",54,0)
 .S INDEX=INDEX+1
"RTN","PSUIV2",55,0)
 .S ^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX)=REC
"RTN","PSUIV2",56,0)
 I RECTYP'="P" D
"RTN","PSUIV2",57,0)
 .S REC=REC_$TR(PSUFAC,"^","'")_DLM_$TR(PSUIV(.02),"^","'")_DLM_PSUIV(.01)_DLM
"RTN","PSUIV2",58,0)
 .S REC=REC_DLM_DLM_DLM_PSUSSN_DLM
"RTN","PSUIV2",59,0)
 .S REC=REC_PSURATE_DLM_$TR(PSUDOC(9),"^","'")_DLM   ;_$TR(PSUPCLS,"^","'")_DLM
"RTN","PSUIV2",60,0)
 .;S REC=REC_$TR(PSUSERV,"^","'")_DLM_$TR(PSUSP1,"^","'")_DLM_$TR(PSUSP2,"^","'")_DLM
"RTN","PSUIV2",61,0)
 .S REC=REC_DLM_$TR(PSUPRNM,"^","'")_DLM
"RTN","PSUIV2",62,0)
 .S REC=REC_$TR(PSUDCLS,"^","'")_DLM_$TR(PSUNDC,"^","'")_DLM
"RTN","PSUIV2",63,0)
 .S REC=REC_$TR(PSUNFI,"^","'")_DLM_$TR(PSIVNFI,"^","'")_DLM
"RTN","PSUIV2",64,0)
 .S REC=REC_$TR(PSIVNFR,"^","'")_DLM_$TR(PSUPNAM,"^","'")_DLM
"RTN","PSUIV2",65,0)
 .S REC=REC_RECIND_DLM_$TR(PSUGNM,"^","'")_DLM_$TR(PSUDGU,"^","'")_DLM
"RTN","PSUIV2",66,0)
 .S REC=REC_PSUDCST_DLM_PSUNITS_DLM_PSUNAF_DLM_PSUDEA_DLM
"RTN","PSUIV2",67,0)
 .S REC=REC_$G(PSUPICN)_DLM_$G(PSUDIEN)_DLM_$G(PSUIV(.03))_U
"RTN","PSUIV2",68,0)
 .I '$D(^XTMP(PSUIVSUB,"RECORDS",PSUFAC)) S INDEX=0
"RTN","PSUIV2",69,0)
 .S INDEX=$O(^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX),-1)
"RTN","PSUIV2",70,0)
 .S INDEX=INDEX+1
"RTN","PSUIV2",71,0)
 .S ^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX)=REC
"RTN","PSUIV2",72,0)
 D LAB^PSULR0("IV",PSUFAC,PSUODA,PSUPDA,PSUGNM,PSUDCLS)
"RTN","PSUIV2",73,0)
 Q
"RTN","PSUIV2",74,0)
SETDRUG ;Set the ^XTMP global for the drug distribution report
"RTN","PSUIV2",75,0)
 S REC=""
"RTN","PSUIV2",76,0)
 I '$D(^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)) S ^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)=""
"RTN","PSUIV2",77,0)
 S DATA=^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)
"RTN","PSUIV2",78,0)
 S REC=PSUDGU_U_(PSUNITS+$P(DATA,"^",2))
"RTN","PSUIV2",79,0)
 S REC=REC_U_(PSUDISP+$P(DATA,"^",3))_U_PSUNFI_U_PSIVNFI
"RTN","PSUIV2",80,0)
 S ^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)=REC
"RTN","PSUIV2",81,0)
 Q
"RTN","PSUIV2",82,0)
SETSUM ;Set the ^XTMP global for the summary information
"RTN","PSUIV2",83,0)
 S PSUFAC=""
"RTN","PSUIV2",84,0)
 F  S PSUFAC=$O(PSUFAC(PSUFAC)) Q:PSUFAC=""  D
"RTN","PSUIV2",85,0)
 .S PSUTORD=$G(^XTMP(PSUIVSUB,"ORD",PSUFAC),0)
"RTN","PSUIV2",86,0)
 .S PSUTPAT=$G(^XTMP(PSUIVSUB,"SSN",PSUFAC),0)
"RTN","PSUIV2",87,0)
 .S PSUTCST=$G(^XTMP(PSUIVSUB,"CST",PSUFAC),0)
"RTN","PSUIV2",88,0)
 .S PSUTOP=$G(^XTMP(PSUIVSUB,"OORD",PSUFAC),0)
"RTN","PSUIV2",89,0)
 .S PSUODSP=$G(^XTMP(PSUIVSUB,"ODISP",PSUFAC),0)
"RTN","PSUIV2",90,0)
 .S PSUOCST=$G(^XTMP(PSUIVSUB,"OCST",PSUFAC),0)
"RTN","PSUIV2",91,0)
 .S PSUTPIG=$G(^XTMP(PSUIVSUB,"TPIG",PSUFAC),0)
"RTN","PSUIV2",92,0)
 .S PSUTSYR=$G(^XTMP(PSUIVSUB,"TSYR",PSUFAC),0)
"RTN","PSUIV2",93,0)
 .S PSUTHYP=$G(^XTMP(PSUIVSUB,"THYP",PSUFAC),0)
"RTN","PSUIV2",94,0)
 .S PSUTADM=$G(^XTMP(PSUIVSUB,"TADM",PSUFAC),0)
"RTN","PSUIV2",95,0)
 .S PSUTCHEM=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC),0)
"RTN","PSUIV2",96,0)
 .S PSUSPIG=$G(^XTMP(PSUIVSUB,"SPIG",PSUFAC),0)
"RTN","PSUIV2",97,0)
 .S PSUSSYR=$G(^XTMP(PSUIVSUB,"SSYR",PSUFAC),0)
"RTN","PSUIV2",98,0)
 .S PSUSHYP=$G(^XTMP(PSUIVSUB,"SHYP",PSUFAC),0)
"RTN","PSUIV2",99,0)
 .S PSUSADM=$G(^XTMP(PSUIVSUB,"SADM",PSUFAC),0)
"RTN","PSUIV2",100,0)
 .S PSUSCHEM=$G(^XTMP(PSUIVSUB,"SCHEM",PSUFAC),0)
"RTN","PSUIV2",101,0)
 .S PSUBPIG=$G(^XTMP(PSUIVSUB,"TYPE_P",PSUFAC),0)
"RTN","PSUIV2",102,0)
 .S PSUBSYR=$G(^XTMP(PSUIVSUB,"TYPE_S",PSUFAC),0)
"RTN","PSUIV2",103,0)
 .S PSUBHYP=$G(^XTMP(PSUIVSUB,"TYPE_H",PSUFAC),0)
"RTN","PSUIV2",104,0)
 .S PSUBADM=$G(^XTMP(PSUIVSUB,"TYPE_A",PSUFAC),0)
"RTN","PSUIV2",105,0)
 .S PSUBCHEM=$G(^XTMP(PSUIVSUB,"TYPE_C",PSUFAC),0)
"RTN","PSUIV2",106,0)
 .S PSUAPIG=$S(PSUBPIG:PSUSPIG/PSUBPIG,1:"")
"RTN","PSUIV2",107,0)
 .S PSUASYR=$S(PSUBSYR:PSUSSYR/PSUBSYR,1:"")
"RTN","PSUIV2",108,0)
 .S PSUAHYP=$S(PSUBHYP:PSUSHYP/PSUBHYP,1:"")
"RTN","PSUIV2",109,0)
 .S PSUAADM=$S(PSUBADM:PSUSADM/PSUBADM,1:"")
"RTN","PSUIV2",110,0)
 .S PSUACHEM=$S(PSUBCHEM:PSUSCHEM/PSUBCHEM,1:"")
"RTN","PSUIV2",111,0)
 .S PSUTBAGS=PSUBPIG+PSUBSYR+PSUBHYP+PSUBADM+PSUBCHEM
"RTN","PSUIV2",112,0)
 .S REC=PSUTORD_U_PSUTPAT_U_PSUTBAGS_U_$J(PSUTCST,0,2)_U_PSUTOP_U
"RTN","PSUIV2",113,0)
 .S REC=REC_PSUODSP_U_$J(PSUOCST,0,2)_U_PSUBPIG_U_$J(PSUAPIG,0,2)
"RTN","PSUIV2",114,0)
 .S REC=REC_U_PSUBHYP_U_$J(PSUAHYP,0,2)_U_PSUBADM_U_$J(PSUAADM,0,2)
"RTN","PSUIV2",115,0)
 .S REC=REC_U_PSUBCHEM_U_$J(PSUACHEM,0,2)_U_PSUBSYR_U_$J(PSUASYR,0,2)
"RTN","PSUIV2",116,0)
 .S ^XTMP(PSUIVSUB,"SUMMARY",PSUFAC,0)=REC
"RTN","PSUIV2",117,0)
 .S PSUDIV=PSUFAC D GETDIV^PSUIV3 I PSUDIVNM'="" D
"RTN","PSUIV2",118,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVNM)=PSUTPAT
"RTN","PSUIV2",119,0)
 .I PSUDIVNM="" S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIV)=PSUTPAT
"RTN","PSUIV2",120,0)
 Q
"RTN","PSUIV2",121,0)
ICN ;Find patient ICN 
"RTN","PSUIV2",122,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUIV2",123,0)
 ;
"RTN","PSUIV2",124,0)
 N PSUPICN,PSUPICN1,PSUICN
"RTN","PSUIV2",125,0)
 S PSUPTN=0
"RTN","PSUIV2",126,0)
 I $G(PSUSSN),PSUSSN'="" D
"RTN","PSUIV2",127,0)
 .F  S PSUPTN=$O(^DPT("SSN",PSUSSN,PSUPTN)) Q:PSUPTN=""  D
"RTN","PSUIV2",128,0)
 ..S PSUPICN1=$$GETICN^MPIF001(PSUPTN) D
"RTN","PSUIV2",129,0)
 ...I PSUPICN1'[-1 D
"RTN","PSUIV2",130,0)
 ....S ^XTMP("PSU_"_PSUJOB,"PSUPICN")=PSUPICN1
"RTN","PSUIV2",131,0)
 ...I PSUPICN1[-1 S ^XTMP("PSU_"_PSUJOB,"PSUPICN")=""
"RTN","PSUIV2",132,0)
 Q
"RTN","PSUOP3")
0^34^B23489811
"RTN","PSUOP3",1,0)
PSUOP3 ;BIR/CFL,TJH,PDW-PSU PBM Outpatient Pharmacy shared variables for vers. 6 & 7 ;08/25/2003
"RTN","PSUOP3",2,0)
 ;;3.0;PHARMACY BENEFITS MANAGEMENT;**14,19,20,28,30,24**;Oct 15, 1998
"RTN","PSUOP3",3,0)
 ;
"RTN","PSUOP3",4,0)
 ; Reference to file #7 supported by DBIA 2495
"RTN","PSUOP3",5,0)
 ; Reference to file #50 supported by DBIA 221
"RTN","PSUOP3",6,0)
 ; Reference to file #53 supported by DBIA 1975
"RTN","PSUOP3",7,0)
 ; Reference to file #59 supported by DBIA 2510
"RTN","PSUOP3",8,0)
 ; Reference to file #200 supported by DBIA 10060
"RTN","PSUOP3",9,0)
 ; Reference to file #49  supported by DBIA 10093
"RTN","PSUOP3",10,0)
 ; Reference to file #52  supported by DBIA 2512
"RTN","PSUOP3",11,0)
 ;
"RTN","PSUOP3",12,0)
PROVDR ;Get provider data, site number and AMIS category
"RTN","PSUOP3",13,0)
 S PSUSITE=$S(PSUDIVP="":PSUSNDR,1:$$VALI^PSUTL(59,PSUDIVP,.06))
"RTN","PSUOP3",14,0)
 ;
"RTN","PSUOP3",15,0)
 ;Create storage global of division numbers and names for lab msgs.
"RTN","PSUOP3",16,0)
 S X=PSUSITE,DIC=59,DIC(0)="XM" D ^DIC
"RTN","PSUOP3",17,0)
 S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP3",18,0)
 S ^XTMP("PSU_"_PSUJOB,"DIV",PSUSITE)=PSUDIVNM
"RTN","PSUOP3",19,0)
 ;
"RTN","PSUOP3",20,0)
GETVAR ;Get shared variables
"RTN","PSUOP3",21,0)
 ;Get AMIS workload category
"RTN","PSUOP3",22,0)
 S PSUPST=$$VALI^PSUTL(53,PSURXP,6)
"RTN","PSUOP3",23,0)
 S PSUSC=$S(PSUPST=1:"SC",PSUPST=2:"AA",PSUPST=3:"OT",PSUPST=4:"IP",1:"")
"RTN","PSUOP3",24,0)
 S:$$GET1^DIQ(52,PSURXIEN,201)="YES" PSUSC="NVA"
"RTN","PSUOP3",25,0)
 K PSUPROV
"RTN","PSUOP3",26,0)
 D GETS^PSUTL(200,PSUPRID,"9;29;53.5;53.6","PSUPROV","I")
"RTN","PSUOP3",27,0)
 I '$D(PSUPROV) D NOPROV Q
"RTN","PSUOP3",28,0)
 D MOVEI^PSUTL("PSUPROV")
"RTN","PSUOP3",29,0)
 S PSUPRSSN=PSUPROV(9)
"RTN","PSUOP3",30,0)
 I PSUPRSSN="" S PSUPRSSN=999999999
"RTN","PSUOP3",31,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUPRSSN,PSUPRID)=""
"RTN","PSUOP3",32,0)
 S PSUDOC(9)=PSUPRSSN
"RTN","PSUOP3",33,0)
 S PSUPTYP=$S(PSUPROV(53.6)=4:"F",1:"S")
"RTN","PSUOP3",34,0)
 S:$$GET1^DIQ(52,PSURXIEN,201)="YES" PSUPTYP="NVA"
"RTN","PSUOP3",35,0)
 S PSUPCLS="" I PSUPROV(53.5)'="" D
"RTN","PSUOP3",36,0)
 .S PSUPCLS=$$VALI^PSUTL(7,PSUPROV(53.5),1)
"RTN","PSUOP3",37,0)
 .I PSUPCLS="" S PSUPCLS=$$VALI^PSUTL(7,PSUPROV(53.5),.01)
"RTN","PSUOP3",38,0)
 S PSUPSV=$S($L(PSUPROV(29)):$$VAL^PSUTL(49,PSUPROV(29),.01),1:"")
"RTN","PSUOP3",39,0)
 S PSUPSV=$$UPPER^PSUTL(PSUPSV),PSUPSERV=""
"RTN","PSUOP3",40,0)
 I $L(PSUPSV),$D(PSECT(PSUPSV)) S PSUPSERV=PSECT(PSUPSV)
"RTN","PSUOP3",41,0)
 S PSUSPTY=$$GET^XUA4A72(PSUPRID,PSUFDT)
"RTN","PSUOP3",42,0)
 S PSUSP1=$P(PSUSPTY,U,3),PSUSP2=$P(PSUSPTY,U,4)
"RTN","PSUOP3",43,0)
 ;
"RTN","PSUOP3",44,0)
 Q
"RTN","PSUOP3",45,0)
 ;
"RTN","PSUOP3",46,0)
NOPROV ; set up PSUPROV array when provider isn't found in ^VA(200
"RTN","PSUOP3",47,0)
 F I=9,29,53.5,53.6 S PSUPROV(I)=""
"RTN","PSUOP3",48,0)
 S (PSUPRSSN,PSUPTYP,PSUPCLS,PSUPSERV,PSUSP1,PSUSP2)=""
"RTN","PSUOP3",49,0)
 Q
"RTN","PSUOP3",50,0)
GETDRUG ;Get drug data
"RTN","PSUOP3",51,0)
 K PSUDRUG
"RTN","PSUOP3",52,0)
 D GETS^PSUTL(50,PSUDR,".01;2;3;14.5;20;21;22;25;31;51;52","PSUDRUG","I")
"RTN","PSUOP3",53,0)
 D MOVEI^PSUTL("PSUDRUG")
"RTN","PSUOP3",54,0)
 I '$D(PSUDRUG) F I=.01,2,3,14.5,20,21,22,25,31,51,52 S PSUDRUG(I)=""
"RTN","PSUOP3",55,0)
 S PSUGNM=PSUDRUG(.01)
"RTN","PSUOP3",56,0)
 I PSUGNM="" S PSUGNM="Unknown Generic Name"
"RTN","PSUOP3",57,0)
 S PSUVANM=PSUDRUG(21)
"RTN","PSUOP3",58,0)
 I PSUVANM="" S PSUVANM="Unknown VA Product Name"
"RTN","PSUOP3",59,0)
 S PSUDEA=PSUDRUG(3)
"RTN","PSUOP3",60,0)
 S PSUNFI=$S(PSUDRUG(51)=1:"N/F",1:"")
"RTN","PSUOP3",61,0)
 S PSUDUN=PSUDRUG(14.5)
"RTN","PSUOP3",62,0)
 S PSUVACLS=PSUDRUG(2)
"RTN","PSUOP3",63,0)
 S PSUNDCL=PSUDRUG(22)
"RTN","PSUOP3",64,0)
 S PSUNAF=$S(PSUDRUG(52):"N/F",1:"")
"RTN","PSUOP3",65,0)
 S PSUNADR=PSUDRUG(20)
"RTN","PSUOP3",66,0)
 ;Get the National Formulary Indicator and Restriction
"RTN","PSUOP3",67,0)
 S (PSOPNFI,PSOPNFR)=""
"RTN","PSUOP3",68,0)
 I $$VERSION^XPDUTL("PSN")'<4 D
"RTN","PSUOP3",69,0)
 .S PSOPNFI=$$FORMI^PSNAPIS(PSUNADR,PSUNDCL)
"RTN","PSUOP3",70,0)
 .S PSOPNFR=$$FORMR^PSNAPIS(PSUNADR,PSUNDCL)
"RTN","PSUOP3",71,0)
GETDRUGQ Q
"RTN","PSUOP3",72,0)
 ;
"RTN","PSUOP3",73,0)
SETREC ;Set the record into the ^XTMP global
"RTN","PSUOP3",74,0)
 S:PSUDIVP="" PSUDIVP=PSUSNDR
"RTN","PSUOP3",75,0)
 S REC1="^",REC2="*",PSU2U="^"
"RTN","PSUOP3",76,0)
 S REC1=REC1_$TR(PSUSITE,"^","'")_PSU2U_$TR(PSUFD,"^","'")_PSU2U
"RTN","PSUOP3",77,0)
 S REC1=REC1_$TR(PSURELDT,"^","'")_PSU2U_$TR(PSURXN,"^","'")_PSU2U
"RTN","PSUOP3",78,0)
 S REC1=REC1_$TR(PSUSC,"^","'")_PSU2U_PSUSSN_PSU2U_$TR(PSUVANM,"^","'")_PSU2U
"RTN","PSUOP3",79,0)
 S REC1=REC1_$TR(PSUVACLS,"^","'")_PSU2U_$TR(PSUGNM,"^","'")_PSU2U
"RTN","PSUOP3",80,0)
 S REC1=REC1_$TR(PSUNDC,"^","'")_PSU2U_$TR(PSUNFI,"^","'")_PSU2U
"RTN","PSUOP3",81,0)
 S REC1=REC1_$TR(PSOPNFI,"^","'")_PSU2U_$TR(PSOPNFR,"^","'")_PSU2U
"RTN","PSUOP3",82,0)
 S REC1=REC1_$TR(PSUDEA,"^","'")_PSU2U_$TR(PSUTYP,"^","'")_PSU2U
"RTN","PSUOP3",83,0)
 S REC1=REC1_$TR(PSUCMOP,"^","'")_PSU2U_$TR(PSUMW,"^","'")_PSU2U
"RTN","PSUOP3",84,0)
 S REC1=REC1_$TR(PSUPRSSN,"^","'")_PSU2U_$TR(PSUPTYP,"^","'")_PSU2U
"RTN","PSUOP3",85,0)
 ;S REC1=REC1_$TR(PSUPCLS,"^","'")_PSU2U_$TR(PSUPSERV,"^","'")_PSU2U
"RTN","PSUOP3",86,0)
 ;S REC2=REC2_$TR(PSUSP1,"^","'")_PSU2U_$TR(PSUSP2,"^","'")_PSU2U
"RTN","PSUOP3",87,0)
 S REC2=REC2_$TR(PSUSIG,"^","'")_PSU2U_$TR(PSUWPC,"^","'")_PSU2U
"RTN","PSUOP3",88,0)
 S REC2=REC2_$TR(PSUDUN,"^","'")_PSU2U_$TR(PSUDRCT,"^","'")_PSU2U
"RTN","PSUOP3",89,0)
 S REC2=REC2_$TR(PSUDS,"^","'")_PSU2U_$TR(PSUQTY,"^","'")_PSU2U_PSUNAF_U
"RTN","PSUOP3",90,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUOP3",91,0)
 D ICN^PSUIV2 S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUOP3",92,0)
 S REC2=REC2_$G(PSUPICN)_PSU2U_PSUPRID_PSU2U_$G(PSUCAN)_"^"
"RTN","PSUOP3",93,0)
 S PSURCT=1+$P($G(^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,0)),U,1)
"RTN","PSUOP3",94,0)
 S ^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,PSURCT,1)=REC1
"RTN","PSUOP3",95,0)
 S ^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,PSURCT,2)=REC2
"RTN","PSUOP3",96,0)
 S $P(^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,0),U,1)=PSURCT
"RTN","PSUOP3",97,0)
 I (($E(OPVER)=6)&(PSUTYP="P"))!($E(OPVER)>6) S ^XTMP(PSUOPSUB,"RXIEN",PSURXIEN)=""
"RTN","PSUOP3",98,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUOPFLG")) D
"RTN","PSUOP3",99,0)
 .D LAB^PSULR0("OP",PSUSITE,PSURXIEN,DFN,PSUGNM,PSUVACLS)
"RTN","PSUOP3",100,0)
SUMDRUG ; total drug info for summary report
"RTN","PSUOP3",101,0)
 S PSUVARS="PSUTPART,PSUTFIL,PSUTRFIL,PSUTCST,PSUTQTY"
"RTN","PSUOP3",102,0)
 S PSUREC=$G(^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUGNM,PSUCMOP))
"RTN","PSUOP3",103,0)
 F I=1:1:5 S @$P(PSUVARS,",",I)=+$P(PSUREC,U,I)
"RTN","PSUOP3",104,0)
 I PSUTYP="P" S PSUTPART=PSUTPART+1
"RTN","PSUOP3",105,0)
 I PSUTYP="N" S PSUTFIL=PSUTFIL+1
"RTN","PSUOP3",106,0)
 I PSUTYP="R" S PSUTRFIL=PSUTRFIL+1
"RTN","PSUOP3",107,0)
 S PSUTQTY=PSUQTY+PSUTQTY
"RTN","PSUOP3",108,0)
 S PSUTCST=(PSUDRCT*PSUQTY)+PSUTCST
"RTN","PSUOP3",109,0)
 S REC=PSUTPART_U_PSUTFIL_U_PSUTRFIL_U_$J(PSUTCST,0,2)_U_$J(PSUTQTY,0,2)
"RTN","PSUOP3",110,0)
 S $P(REC,U,6)=$S(PSUNFI="N/F":"*",1:"")
"RTN","PSUOP3",111,0)
 S $P(REC,U,7)=$S(PSOPNFI="0":"#",1:"")
"RTN","PSUOP3",112,0)
 S ^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUGNM,PSUCMOP)=REC
"RTN","PSUOP3",113,0)
 Q
"VER")
8.0^22
**END**
**END**
