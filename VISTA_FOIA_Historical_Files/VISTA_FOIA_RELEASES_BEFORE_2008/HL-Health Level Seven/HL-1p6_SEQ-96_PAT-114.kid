Released HL*1.6*114 SEQ #96
Extracted from mail message
**KIDS**:HL*1.6*114^

**INSTALL NAME**
HL*1.6*114
"BLD",786,0)
HL*1.6*114^HEALTH LEVEL SEVEN^0^3040913^y
"BLD",786,1,0)
^^2^2^3031205^^
"BLD",786,1,1,0)
See patch HL*1.6*114 in the National Patch Module for complete information
"BLD",786,1,2,0)
on this patch.
"BLD",786,4,0)
^9.64PA^^
"BLD",786,"KRN",0)
^9.67PA^8989.52^19
"BLD",786,"KRN",.4,0)
.4
"BLD",786,"KRN",.401,0)
.401
"BLD",786,"KRN",.402,0)
.402
"BLD",786,"KRN",.403,0)
.403
"BLD",786,"KRN",.5,0)
.5
"BLD",786,"KRN",.84,0)
.84
"BLD",786,"KRN",3.6,0)
3.6
"BLD",786,"KRN",3.8,0)
3.8
"BLD",786,"KRN",9.2,0)
9.2
"BLD",786,"KRN",9.8,0)
9.8
"BLD",786,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",786,"KRN",9.8,"NM",1,0)
HLUCM090^^0^B61573251
"BLD",786,"KRN",9.8,"NM",2,0)
HLUCM^^0^B64179272
"BLD",786,"KRN",9.8,"NM",3,0)
HLUCM050^^0^B77272410
"BLD",786,"KRN",9.8,"NM","B","HLUCM",2)

"BLD",786,"KRN",9.8,"NM","B","HLUCM050",3)

"BLD",786,"KRN",9.8,"NM","B","HLUCM090",1)

"BLD",786,"KRN",19,0)
19
"BLD",786,"KRN",19.1,0)
19.1
"BLD",786,"KRN",101,0)
101
"BLD",786,"KRN",409.61,0)
409.61
"BLD",786,"KRN",771,0)
771
"BLD",786,"KRN",870,0)
870
"BLD",786,"KRN",8989.51,0)
8989.51
"BLD",786,"KRN",8989.52,0)
8989.52
"BLD",786,"KRN",8994,0)
8994
"BLD",786,"KRN","B",.4,.4)

"BLD",786,"KRN","B",.401,.401)

"BLD",786,"KRN","B",.402,.402)

"BLD",786,"KRN","B",.403,.403)

"BLD",786,"KRN","B",.5,.5)

"BLD",786,"KRN","B",.84,.84)

"BLD",786,"KRN","B",3.6,3.6)

"BLD",786,"KRN","B",3.8,3.8)

"BLD",786,"KRN","B",9.2,9.2)

"BLD",786,"KRN","B",9.8,9.8)

"BLD",786,"KRN","B",19,19)

"BLD",786,"KRN","B",19.1,19.1)

"BLD",786,"KRN","B",101,101)

"BLD",786,"KRN","B",409.61,409.61)

"BLD",786,"KRN","B",771,771)

"BLD",786,"KRN","B",870,870)

"BLD",786,"KRN","B",8989.51,8989.51)

"BLD",786,"KRN","B",8989.52,8989.52)

"BLD",786,"KRN","B",8994,8994)

"BLD",786,"QUES",0)
^9.62^^
"BLD",786,"REQB",0)
^9.611^1^1
"BLD",786,"REQB",1,0)
HL*1.6*103^0
"BLD",786,"REQB","B","HL*1.6*103",1)

"MBREQ")
0
"PKG",9,-1)
1^1
"PKG",9,0)
HEALTH LEVEL SEVEN^HL^DHCP IMPLEMENTATION OF HEALTH LEVEL SEVEN^
"PKG",9,20,0)
^9.402P^^
"PKG",9,22,0)
^9.49I^1^1
"PKG",9,22,1,0)
1.6^2980130^2980130^6
"PKG",9,22,1,"PAH",1,0)
114^3040913
"PKG",9,22,1,"PAH",1,1,0)
^^2^2^3040913
"PKG",9,22,1,"PAH",1,1,1,0)
See patch HL*1.6*114 in the National Patch Module for complete information
"PKG",9,22,1,"PAH",1,1,2,0)
on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","HLUCM")
0^2^B64179272
"RTN","HLUCM",1,0)
HLUCM ;CIOFO-O/LJA - HL7/Capacity Mgt API ;09/13/04 14:01
"RTN","HLUCM",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**79,88,103,114**;Oct 13, 1995
"RTN","HLUCM",3,0)
 ;
"RTN","HLUCM",4,0)
 QUIT
"RTN","HLUCM",5,0)
 ;
"RTN","HLUCM",6,0)
CM(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Capacity management totals
"RTN","HLUCM",7,0)
 N NMSPTYPE,PROTYPE,RESULTS,SITENM
"RTN","HLUCM",8,0)
 I '$D(HLAPI) N HLAPI S HLAPI="CM"
"RTN","HLUCM",9,0)
 QUIT:'$$PREPARE^HLUCM001 "" ;->
"RTN","HLUCM",10,0)
 D KILLS^HLUCM009("START")
"RTN","HLUCM",11,0)
 S RESULTS=$P($$LOOP,U,1,3)
"RTN","HLUCM",12,0)
 D XTMP
"RTN","HLUCM",13,0)
 D KILLS^HLUCM009("END")
"RTN","HLUCM",14,0)
 KILL HLAPI
"RTN","HLUCM",15,0)
 Q RESULTS
"RTN","HLUCM",16,0)
 ;
"RTN","HLUCM",17,0)
CMF(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Collect Remote Facility data - SYNC
"RTN","HLUCM",18,0)
 N HLAPI
"RTN","HLUCM",19,0)
 S HLAPI="CMF"
"RTN","HLUCM",20,0)
 Q $$CM(START,END,.PNMSP,.IEN101,TOTALS,COND,.ERRINFO)
"RTN","HLUCM",21,0)
 ;
"RTN","HLUCM",22,0)
CM2(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Capacity management totals
"RTN","HLUCM",23,0)
 N NMSPTYPE,PROTYPE,RESULTS,SITENM
"RTN","HLUCM",24,0)
 I '$D(HLAPI) N HLAPI S HLAPI="CM2"
"RTN","HLUCM",25,0)
 QUIT:'$$PREPARE^HLUCM001 "" ;->
"RTN","HLUCM",26,0)
 D KILLS^HLUCM009("START")
"RTN","HLUCM",27,0)
 S RESULTS=$P($$LOOP,U,1,3) ; Counts are aggregate
"RTN","HLUCM",28,0)
 D XTMP
"RTN","HLUCM",29,0)
 D KILLS^HLUCM009("END")
"RTN","HLUCM",30,0)
 KILL HLAPI
"RTN","HLUCM",31,0)
 QUIT RESULTS
"RTN","HLUCM",32,0)
 ;
"RTN","HLUCM",33,0)
CM2F(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Collect Remote Facility data - SYNC
"RTN","HLUCM",34,0)
 N HLAPI
"RTN","HLUCM",35,0)
 S HLAPI="CM2F"
"RTN","HLUCM",36,0)
 Q $$CM2(START,END,.PNMSP,.IEN101,TOTALS,COND,.ERRINFO)
"RTN","HLUCM",37,0)
 ;
"RTN","HLUCM",38,0)
LOOP() ; Loop thru 772's .01... (Called from LOOP^HLUCM)
"RTN","HLUCM",39,0)
 N ANS,API,CHAR,COUNTED,CTDBG,CTPCKG,D0,DATA,DEF,ERR,FAC,FAIL,HL,HLASTNM
"RTN","HLUCM",40,0)
 N HLUCMADD,IEN772,IEN773,LEN,LOOP772,LOOPDT,NMSP,NUM,OK
"RTN","HLUCM",41,0)
 N ORIGETM,ORIGSTM,PCKG,PROT,PROTOCOL,QUES,SEC
"RTN","HLUCM",42,0)
 N SP,SUB,SVNO,TIMEP,TM772,TOT,V1,V2,VAL,VALUE,X,Y
"RTN","HLUCM",43,0)
 ;
"RTN","HLUCM",44,0)
 D LOAD
"RTN","HLUCM",45,0)
 D ADJTIME^HLUCM003
"RTN","HLUCM",46,0)
 D CMDBD
"RTN","HLUCM",47,0)
 D TOTALCM ; Already stored in X (no counted) or C (counted) subscripts...
"RTN","HLUCM",48,0)
 S RESULTS=$G(^TMP(TOTALS,$J))
"RTN","HLUCM",49,0)
 ;
"RTN","HLUCM",50,0)
 QUIT RESULTS
"RTN","HLUCM",51,0)
 ;
"RTN","HLUCM",52,0)
CMDBD ; Create $$CM debug data...
"RTN","HLUCM",53,0)
 ; HLAPI,START,END -- req
"RTN","HLUCM",54,0)
 N DATA,IENPAR,IEN772,OKPP,S1,S2,S3,SUB,TOT,VALNMSP,VALPROT
"RTN","HLUCM",55,0)
 ;
"RTN","HLUCM",56,0)
 S API=$S($G(API)["CM2":1,1:0) ; Async=1, Sync=0
"RTN","HLUCM",57,0)
 ;
"RTN","HLUCM",58,0)
 S IENPAR=0
"RTN","HLUCM",59,0)
 F  S IENPAR=$O(^TMP($J,"HLPARENT",IENPAR)) Q:'IENPAR  D
"RTN","HLUCM",60,0)
 .  S DATA=$G(^TMP($J,"HLPARENT",+IENPAR)) QUIT:DATA']""  ;->
"RTN","HLUCM",61,0)
 .  S VALPROT=$P(DATA,U,7),VALNMSP=$P(DATA,U,9)
"RTN","HLUCM",62,0)
 .  F S1="C","X" F S2="C","X" F S3="C","X" S TOT(S1_S2_S3)=0
"RTN","HLUCM",63,0)
 .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR)=DATA
"RTN","HLUCM",64,0)
 .  S IEN772=0
"RTN","HLUCM",65,0)
 .  F  S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM",66,0)
 .  .  S ^TMP($J,"HLUCMSTORE","X",+IEN772)=+IENPAR
"RTN","HLUCM",67,0)
 .  .  S (OKPP,OKPP(1))=$$PP(+IEN772)
"RTN","HLUCM",68,0)
 .  .  S OKPP=$S(OKPP=U:"X",1:"C")
"RTN","HLUCM",69,0)
 .  .  S OK=$$COLLSYNC(+IEN772,START,END) ; Outside time range?
"RTN","HLUCM",70,0)
 .  .  S SUB=$S(OK:"C",1:"X")
"RTN","HLUCM",71,0)
 .  .  S DATA=$P($G(^TMP($J,"HLCHILD",+IEN772)),"~",2,999) Q:DATA']""  ;->
"RTN","HLUCM",72,0)
 .  .  ; If # seconds exceeds 1799...
"RTN","HLUCM",73,0)
 .  .  S SUB=SUB_$S($P(DATA,U,3)>1799:"X",1:"C")_OKPP
"RTN","HLUCM",74,0)
 .  .  S:$P(DATA,U,7)']"" $P(DATA,U,7)=VALPROT
"RTN","HLUCM",75,0)
 .  .  S:$P(DATA,U,9)']"" $P(DATA,U,9)=VALNMSP
"RTN","HLUCM",76,0)
 .  .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,SUB)=DATA
"RTN","HLUCM",77,0)
 .  .  F I=1:1:3 S $P(TOT(SUB),U,I)=$P(TOT(SUB),U,I)+$P(DATA,U,I)
"RTN","HLUCM",78,0)
 .  .  S DATA=$G(^TMP($J,"HLPARENT",+IENPAR,+IEN772))
"RTN","HLUCM",79,0)
 .  .  S X=OKPP(1),$P(DATA,U,5)=$P(X,U),$P(DATA,U,6)=$P(X,U,2)
"RTN","HLUCM",80,0)
 .  .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,SUB,772)=DATA
"RTN","HLUCM",81,0)
 .
"RTN","HLUCM",82,0)
 .  ; Position #1  C=Count    (Message BEGIN is not before START)
"RTN","HLUCM",83,0)
 .  ;              X=Outside  (Msg BEGIN is before START)
"RTN","HLUCM",84,0)
 .  ;          #2  C=Count    (#Seconds<1800)
"RTN","HLUCM",85,0)
 .  ;              X=Greater  (#Seconds>1799)
"RTN","HLUCM",86,0)
 .  ;          #3  C=Count    (Protocol/Namespace match)
"RTN","HLUCM",87,0)
 .  ;              X=Mismatch (Protocol/Namespace mismatch)
"RTN","HLUCM",88,0)
 .  F S1="C","X" F S2="C","X" F S3="C","X" S SUB=S1_S2_S3 D
"RTN","HLUCM",89,0)
 .  .  QUIT:$TR(TOT(SUB),"0^","")']""  ;->
"RTN","HLUCM",90,0)
 .  .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR,SUB)=TOT(SUB)
"RTN","HLUCM",91,0)
 .  .
"RTN","HLUCM",92,0)
 .  .  S TOT=$G(^TMP($J,"HLUCMSTORE","T",SUB))
"RTN","HLUCM",93,0)
 .  .  D UPTOT
"RTN","HLUCM",94,0)
 .  .  S ^TMP($J,"HLUCMSTORE","T",SUB)=TOT
"RTN","HLUCM",95,0)
 .  .
"RTN","HLUCM",96,0)
 .  .  S ^TMP($J,"HLUCMSTORE","T",SUB,IENPAR)=TOT(SUB)
"RTN","HLUCM",97,0)
 .  .
"RTN","HLUCM",98,0)
 .  .  S TOT=$G(^TMP($J,"HLUCMSTORE","T"))
"RTN","HLUCM",99,0)
 .  .  D UPTOT
"RTN","HLUCM",100,0)
 .  .  S ^TMP($J,"HLUCMSTORE","T")=TOT
"RTN","HLUCM",101,0)
 ;
"RTN","HLUCM",102,0)
 KILL ^TMP($J,"HLCHILD"),^TMP($J,"HLPARENT")
"RTN","HLUCM",103,0)
 ;
"RTN","HLUCM",104,0)
 Q
"RTN","HLUCM",105,0)
 ;
"RTN","HLUCM",106,0)
UPTOT ; Up the totals...
"RTN","HLUCM",107,0)
 ; TOT,TOT(SUB) -- req
"RTN","HLUCM",108,0)
 S $P(TOT,U)=$P(TOT,U)+$P(TOT(SUB),U)
"RTN","HLUCM",109,0)
 S $P(TOT,U,2)=$P(TOT,U,2)+$P(TOT(SUB),U,2)
"RTN","HLUCM",110,0)
 S $P(TOT,U,3)=$P(TOT,U,3)+$P(TOT(SUB),U,3)
"RTN","HLUCM",111,0)
 Q
"RTN","HLUCM",112,0)
 ;
"RTN","HLUCM",113,0)
PP(IEN772) ; Get store value for NMSP and PROT...
"RTN","HLUCM",114,0)
 N PCKG,PP,PROT,X
"RTN","HLUCM",115,0)
 S PP=$$PROTNMSP^HLUCM002(+IEN772)
"RTN","HLUCM",116,0)
 I $P(PP,U)']""!($P(PP,U,2)']"") QUIT U ;->
"RTN","HLUCM",117,0)
 S X=$P(PP,U),PROT=$S(X]"":X,1:"ZZZ")
"RTN","HLUCM",118,0)
 S X=$P(PP,U,2),PCKG=$S(X]"":X,1:"ZZZ")
"RTN","HLUCM",119,0)
 Q PROT_U_PCKG
"RTN","HLUCM",120,0)
 ;
"RTN","HLUCM",121,0)
LOAD ; Load data (Called by $$CM, $$CM2, and all other APIs)
"RTN","HLUCM",122,0)
 ; START,END -- req
"RTN","HLUCM",123,0)
 N IEN772,LOOPDT,X
"RTN","HLUCM",124,0)
 S LOOPDT=START-.000001
"RTN","HLUCM",125,0)
 F  S LOOPDT=$O(^HL(772,"B",LOOPDT)) Q:LOOPDT'>0!(LOOPDT>END)  D
"RTN","HLUCM",126,0)
 .  S IEN772=0
"RTN","HLUCM",127,0)
 .  F  S IEN772=$O(^HL(772,"B",LOOPDT,IEN772)) Q:IEN772'>0  D
"RTN","HLUCM",128,0)
 .  .  QUIT:'$$OK772(+IEN772)  ;->
"RTN","HLUCM",129,0)
 .  .  S X=$$LOAD772S^HLUCM009(IEN772)
"RTN","HLUCM",130,0)
 Q
"RTN","HLUCM",131,0)
 ;
"RTN","HLUCM",132,0)
TOTALCM ; Loop, total for $$CM...
"RTN","HLUCM",133,0)
 ; HLAPI -- req
"RTN","HLUCM",134,0)
 N IEN772,IENPAR
"RTN","HLUCM",135,0)
 S IENPAR=0
"RTN","HLUCM",136,0)
 F  S IENPAR=$O(^TMP($J,"HLUCMSTORE","U",IENPAR)) Q:'IENPAR  D
"RTN","HLUCM",137,0)
 .  ; Don't count anything unless the entire unit is OK...
"RTN","HLUCM",138,0)
 .  QUIT:$O(^TMP($J,"HLUCMSTORE","U",+IENPAR,"CCC"))]""  ;->
"RTN","HLUCM",139,0)
 .  S IEN772=0,HLUCMADD=""
"RTN","HLUCM",140,0)
 .  F  S IEN772=$O(^TMP($J,"HLUCMSTORE","U",IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM",141,0)
 .  .  ;QUIT:'$D(^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,"CCC"))  ;->
"RTN","HLUCM",142,0)
 .  .  D COLLECT(+IENPAR,+IEN772)
"RTN","HLUCM",143,0)
 .  .  I HLAPI["CM2" S HLUCMADD="DON'T ADD.  COLLECT3~HLUCM003"
"RTN","HLUCM",144,0)
 Q
"RTN","HLUCM",145,0)
 ;
"RTN","HLUCM",146,0)
COLLSYNC(IEN772,START,END) ; Does entry fall in START/END range?
"RTN","HLUCM",147,0)
 N DATA,X
"RTN","HLUCM",148,0)
 S DATA=$G(^TMP($J,"HLCHILD",+IEN772)) QUIT:DATA']"" "" ;->
"RTN","HLUCM",149,0)
 S X=$P($P(DATA,"~",2,999),U,4) Q:X'?7N.E!(X<START)!(X>END) "" ;->
"RTN","HLUCM",150,0)
 Q 1
"RTN","HLUCM",151,0)
 ;
"RTN","HLUCM",152,0)
OK772(IEN772) ; Valid entry?
"RTN","HLUCM",153,0)
 N D
"RTN","HLUCM",154,0)
 S D=$G(^HL(772,+IEN772,0))
"RTN","HLUCM",155,0)
 QUIT:$P(D,U)'?7N.E "" ;->
"RTN","HLUCM",156,0)
 I $P(D,U,2)']"",$P(D,U,3)']"",$P(D,U,4)']"",$P(D,U,5)']"" QUIT ""
"RTN","HLUCM",157,0)
 Q 1
"RTN","HLUCM",158,0)
 ;
"RTN","HLUCM",159,0)
COLLECT(PAR,IEN772) ; Collect 772 data and associated 773 data...
"RTN","HLUCM",160,0)
 N CT,CTPCKG,DATA,DBGBL,IEN773,PP,TOT772,TOT772T,TYPEHR,TYPEIO,TYPELR
"RTN","HLUCM",161,0)
 ;
"RTN","HLUCM",162,0)
 ; ^("U",PARENT-IEN,CHILD-IEN,"CCC")
"RTN","HLUCM",163,0)
 S DATA=$G(^TMP($J,"HLUCMSTORE","U",+PAR,+IEN772,"CCC"))
"RTN","HLUCM",164,0)
 S DATA("CHAR")=$P(DATA,U),DATA("DIFF")=$P(DATA,U,3)
"RTN","HLUCM",165,0)
 S DATA("START")=$P(DATA,U,4),DATA("END")=$P(DATA,U,5)
"RTN","HLUCM",166,0)
 S DATA("FAC")=$P(DATA,U,11)
"RTN","HLUCM",167,0)
 ;
"RTN","HLUCM",168,0)
 ; ^("U",PARENT-IEN,CHILD-IEN,"CCC",772)
"RTN","HLUCM",169,0)
 S DATA=$G(^TMP($J,"HLUCMSTORE","U",+PAR,+IEN772,"CCC",772))
"RTN","HLUCM",170,0)
 S DATA("HR")=$P(DATA,U),DATA("IO")=$P(DATA,U,2),DATA("LR")=$P(DATA,U,3)
"RTN","HLUCM",171,0)
 S (DATA("PROT"),PROT)=$P(DATA,U,5)
"RTN","HLUCM",172,0)
 S (DATA("PCKG"),PCKG)=$P(DATA,U,6)
"RTN","HLUCM",173,0)
 ;
"RTN","HLUCM",174,0)
 S DBGBL=1
"RTN","HLUCM",175,0)
 ;
"RTN","HLUCM",176,0)
 ; Store DATA() info in ^TMP(TOTALS,$J,...)
"RTN","HLUCM",177,0)
 D ADDTMP^HLUCM001
"RTN","HLUCM",178,0)
 ;
"RTN","HLUCM",179,0)
 QUIT
"RTN","HLUCM",180,0)
 ;
"RTN","HLUCM",181,0)
TOT772C(IEN772) ; Total number of characters in message...
"RTN","HLUCM",182,0)
 N LEN,LNO,TXT
"RTN","HLUCM",183,0)
 ;
"RTN","HLUCM",184,0)
 ; Use field if present.  (Not present about 25% of time)
"RTN","HLUCM",185,0)
 S LEN=$P($G(^HL(772,IEN772,"S")),U)
"RTN","HLUCM",186,0)
 I LEN D  QUIT  ;->
"RTN","HLUCM",187,0)
 .  S DATA("CHAR",772)=$G(DATA("CHAR",772))+LEN
"RTN","HLUCM",188,0)
 .  S DATA("CHAR")=$G(DATA("CHAR"))+LEN
"RTN","HLUCM",189,0)
 ;
"RTN","HLUCM",190,0)
 ; Total manually...
"RTN","HLUCM",191,0)
 S LNO=0
"RTN","HLUCM",192,0)
 F  S LNO=$O(^HL(772,IEN772,"IN",LNO)) Q:LNO'>0  D
"RTN","HLUCM",193,0)
 .  S TXT=$G(^HL(772,IEN772,"IN",+LNO,0)) QUIT:TXT']""  ;->
"RTN","HLUCM",194,0)
 .  S DATA("CHAR",772)=$G(DATA("CHAR",772))+$L(TXT)
"RTN","HLUCM",195,0)
 .  S DATA("CHAR")=$G(DATA("CHAR"))+$L(TXT)
"RTN","HLUCM",196,0)
 ;
"RTN","HLUCM",197,0)
 QUIT
"RTN","HLUCM",198,0)
 ;
"RTN","HLUCM",199,0)
TOT772T(IEN772) ; Processing time...
"RTN","HLUCM",200,0)
 ; No totals here.  Just set times in DATA() array for later use...
"RTN","HLUCM",201,0)
 N TIME
"RTN","HLUCM",202,0)
 ;
"RTN","HLUCM",203,0)
 ; Time of entry...
"RTN","HLUCM",204,0)
 S TIME=+$G(^HL(772,+IEN772,0))
"RTN","HLUCM",205,0)
 I TIME?7N.E S DATA("TIME",TIME,772,.01)=""
"RTN","HLUCM",206,0)
 ;
"RTN","HLUCM",207,0)
 ; Time processed...
"RTN","HLUCM",208,0)
 S TIME=$P($G(^HL(772,+IEN772,"P")),U,2)
"RTN","HLUCM",209,0)
 I TIME?7N.E S DATA("TIME",TIME,772,21)=""
"RTN","HLUCM",210,0)
 ;
"RTN","HLUCM",211,0)
 QUIT
"RTN","HLUCM",212,0)
 ;
"RTN","HLUCM",213,0)
TOT773C(IEN773) ; Total number of characters...
"RTN","HLUCM",214,0)
 ; DATA() -- passed in  (See COLLECT)
"RTN","HLUCM",215,0)
 N CHAR
"RTN","HLUCM",216,0)
 S CHAR=$$MSGSIZE(+IEN773) QUIT:CHAR'>0  ;->
"RTN","HLUCM",217,0)
 S DATA("CHAR",773,IEN773)=CHAR
"RTN","HLUCM",218,0)
 S DATA("CHAR")=$G(DATA("CHAR"))+CHAR
"RTN","HLUCM",219,0)
 S TOT773(IEN773)=CHAR
"RTN","HLUCM",220,0)
 QUIT
"RTN","HLUCM",221,0)
 ;
"RTN","HLUCM",222,0)
MSGSIZE(IEN773) ; Number characters in 773 entry...
"RTN","HLUCM",223,0)
 N NCH,NO
"RTN","HLUCM",224,0)
 S NCH=0,NO=0
"RTN","HLUCM",225,0)
 F  S NO=$O(^HLMA(+IEN773,"MSH",NO)) Q:NO'>0  D
"RTN","HLUCM",226,0)
 .  S NCH=NCH+$L($G(^HLMA(+IEN773,"MSH",+NO,0)))
"RTN","HLUCM",227,0)
 QUIT NCH
"RTN","HLUCM",228,0)
 ;
"RTN","HLUCM",229,0)
TOT773T(IEN773) ; Set TIMEs...
"RTN","HLUCM",230,0)
 ; DATA() -- passed in  (See COLLECT)
"RTN","HLUCM",231,0)
 N TIME
"RTN","HLUCM",232,0)
 ;
"RTN","HLUCM",233,0)
 ; Creation time already taken from 772...
"RTN","HLUCM",234,0)
 ;
"RTN","HLUCM",235,0)
 ; Processed time...
"RTN","HLUCM",236,0)
 S TIME=+$G(^HLMA(+IEN773,"S")) QUIT:TIME'>0  ;->
"RTN","HLUCM",237,0)
 S DATA("TIME",TIME,773,100)=""
"RTN","HLUCM",238,0)
 ;
"RTN","HLUCM",239,0)
 QUIT
"RTN","HLUCM",240,0)
 ;
"RTN","HLUCM",241,0)
ERR(REA) ; Record error...
"RTN","HLUCM",242,0)
 S NOERR=NOERR+1
"RTN","HLUCM",243,0)
 S REA=$S($G(REA)]"":REA,1:"?")
"RTN","HLUCM",244,0)
 S ERRINFO(REA)=""
"RTN","HLUCM",245,0)
 QUIT
"RTN","HLUCM",246,0)
 ;
"RTN","HLUCM",247,0)
SEC(FMDT) ;
"RTN","HLUCM",248,0)
 S FMDT=$$FMTH^XLFDT(FMDT)
"RTN","HLUCM",249,0)
 QUIT $$SEC^XLFDT(FMDT)
"RTN","HLUCM",250,0)
 ;
"RTN","HLUCM",251,0)
TMDIFF ; DATA("TIME",...) -- req --> DATA("DIFF")
"RTN","HLUCM",252,0)
 S (DATA("DIFF"),DATA("END"),DATA("START"))="" ; Default... HL*1.6*114
"RTN","HLUCM",253,0)
 S DATA("START")=$O(DATA("TIME",0)) QUIT:DATA("START")'>0  ;->
"RTN","HLUCM",254,0)
 S DATA("END")=$O(DATA("TIME",":"),-1)
"RTN","HLUCM",255,0)
 S DATA("DIFF")=$$SEC(DATA("END"))-$$SEC(DATA("START"))
"RTN","HLUCM",256,0)
 QUIT
"RTN","HLUCM",257,0)
 ;
"RTN","HLUCM",258,0)
XTMP ; Store in ^XTMP...
"RTN","HLUCM",259,0)
 ; API Parameters -- req
"RTN","HLUCM",260,0)
 N XTMP
"RTN","HLUCM",261,0)
 ;
"RTN","HLUCM",262,0)
 QUIT:PNMSP'=1!(IEN101'=1)  ;-> Must be ALL,ALL
"RTN","HLUCM",263,0)
 ;
"RTN","HLUCM",264,0)
 S XTMP="HLUCM "_$$DT^XLFDT
"RTN","HLUCM",265,0)
 S:'$D(^XTMP(XTMP,0)) ^XTMP(XTMP,0)=$$FMADD^XLFDT($$DT^XLFDT,7)_U_$$NOW^XLFDT_U_"HLUCM Data"
"RTN","HLUCM",266,0)
 ;
"RTN","HLUCM",267,0)
 S SVNO=$G(^XTMP(XTMP,"P",+START,+END,COND))
"RTN","HLUCM",268,0)
 I SVNO'>0 S SVNO=$O(^XTMP(XTMP,"N",":"),-1)+1
"RTN","HLUCM",269,0)
 S ^XTMP(XTMP,"P",+START,+END,COND)=SVNO_U_$$NOW^XLFDT
"RTN","HLUCM",270,0)
 S ^XTMP(XTMP,"N",+SVNO)=START_U_END_U_COND_U_HLAPI
"RTN","HLUCM",271,0)
 KILL ^XTMP(XTMP,"D",+SVNO)
"RTN","HLUCM",272,0)
 ;
"RTN","HLUCM",273,0)
 MERGE ^XTMP(XTMP,"D",+SVNO)=^TMP(TOTALS,$J)
"RTN","HLUCM",274,0)
 ;
"RTN","HLUCM",275,0)
 Q
"RTN","HLUCM",276,0)
 ;
"RTN","HLUCM",277,0)
EOR ; HLUCM - HL7/Capacity Mgt API ;2/27/01 10:15
"RTN","HLUCM050")
0^3^B77272410
"RTN","HLUCM050",1,0)
HLUCM050 ;CIOFO-O/LJA - HL7/Capacity Mgt API-II ;10/23/01 12:01
"RTN","HLUCM050",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**103,114**;Oct 13, 1995
"RTN","HLUCM050",3,0)
 ;
"RTN","HLUCM050",4,0)
LOADEM(IEN772,HLNMSP) ; Find all related entries, up to 20...
"RTN","HLUCM050",5,0)
 ; HLNMSP is passed by reference...
"RTN","HLUCM050",6,0)
 ;
"RTN","HLUCM050",7,0)
 ; Note!  If entry already loaded, it will not be reloaded.
"RTN","HLUCM050",8,0)
 ;        (Stored ^TMP($J) data will be used instead.)
"RTN","HLUCM050",9,0)
 ;
"RTN","HLUCM050",10,0)
 N ACKTO,CHARC,CHARP,CT,DATA,DATAC,DATAP,DEF,FAC,HL,HLZZI
"RTN","HLUCM050",11,0)
 N HOLDNMSP,I,I772,I773,IEN,IENPAR,LEN,MSGID,MTYPEC
"RTN","HLUCM050",12,0)
 N MTYPEP,NMSP,NMSPP,NUM,PIEN,PROT,PROTP,TIME,TIMEBEG
"RTN","HLUCM050",13,0)
 N TIMEEND,TMDIFF,TMP,TOT772,TOT773,TOTNUM,X,Y
"RTN","HLUCM050",14,0)
 ;
"RTN","HLUCM050",15,0)
 KILL HLNMSP
"RTN","HLUCM050",16,0)
 ;
"RTN","HLUCM050",17,0)
 ; Call already made here?
"RTN","HLUCM050",18,0)
 S IENPAR=+$G(^TMP($J,"HLCHILD",+IEN772)) ; Call already made here?
"RTN","HLUCM050",19,0)
 ;
"RTN","HLUCM050",20,0)
 ; If call already made, just return results...
"RTN","HLUCM050",21,0)
 I IENPAR D  QUIT $P(HLNMSP("HLPARENT",+IENPAR),U,2) ;->
"RTN","HLUCM050",22,0)
 .  S HLNMSP("HLPARENT",+IENPAR)=$G(^TMP($J,"HLPARENT",+IENPAR))
"RTN","HLUCM050",23,0)
 .  ; HL*1.6*114 added TOTNUM to next 3 lines to avoid ALLOC errors...
"RTN","HLUCM050",24,0)
 .  S IEN772=0,TOTNUM=0
"RTN","HLUCM050",25,0)
 .  F  S IEN772=$O(^TMP($J,"HLPARENT",IENPAR,IEN772)) Q:'IEN772!(TOTNUM>19)  D
"RTN","HLUCM050",26,0)
 .  .  S TOTNUM=TOTNUM+1
"RTN","HLUCM050",27,0)
 .  .  S HLNMSP("HLPARENT",+IENPAR,IEN772)=$G(^TMP($J,"HLPARENT",IENPAR,IEN772))
"RTN","HLUCM050",28,0)
 .  .  S HLNMSP("HLCHILD",+IEN772)=$G(^TMP($J,"HLCHILD",+IEN772))
"RTN","HLUCM050",29,0)
 ;
"RTN","HLUCM050",30,0)
 S HLNMSP(+IEN772)="" ; Seed for engine...
"RTN","HLUCM050",31,0)
 ;
"RTN","HLUCM050",32,0)
 S (NUM,TOTNUM)=1
"RTN","HLUCM050",33,0)
 F  D  QUIT:NUM'>NUM(1)!(TOTNUM>19)
"RTN","HLUCM050",34,0)
 .  S NUM(1)=NUM ; Set NUM(1) = # entries found "now"...
"RTN","HLUCM050",35,0)
 .  KILL HOLDNMSP
"RTN","HLUCM050",36,0)
 .  S I772=0
"RTN","HLUCM050",37,0)
 .  F  S I772=$O(HLNMSP(I772)) Q:I772'>0!(TOTNUM>19)  D
"RTN","HLUCM050",38,0)
 .  .  S DATA=$G(^HL(772,+$G(I772),0)) QUIT:DATA']""  ;->
"RTN","HLUCM050",39,0)
 .  .
"RTN","HLUCM050",40,0)
 .  .  ; IEN Search...
"RTN","HLUCM050",41,0)
 .  .  S HLZZI=0 F  S HLZZI=$O(^HL(772,"AF",I772,HLZZI)) Q:'HLZZI!(TOTNUM>19)  I HLZZI'=IEN772 D HOLDTOT(HLZZI)
"RTN","HLUCM050",42,0)
 .  .  ; MSG ID search...
"RTN","HLUCM050",43,0)
 .  .  S MSGID=$P(DATA,U,6)
"RTN","HLUCM050",44,0)
 .  .  I MSGID]"" D
"RTN","HLUCM050",45,0)
 .  .  .  S HLZZI=0 F  S HLZZI=$O(^HL(772,"C",MSGID,HLZZI)) Q:'HLZZI!(TOTNUM>19)  I HLZZI'=IEN772 D HOLDTOT(HLZZI)
"RTN","HLUCM050",46,0)
 .  .  .  D MSGID(MSGID)
"RTN","HLUCM050",47,0)
 .  .  ; 773 MSG ID search...
"RTN","HLUCM050",48,0)
 .  .  S I773=+$O(^HLMA("B",I772,0)) I I773 D
"RTN","HLUCM050",49,0)
 .  .  .  S MSGID=$P($G(^HLMA(+I773,0)),U,2) QUIT:MSGID']""  ;->
"RTN","HLUCM050",50,0)
 .  .  .  S I773(1)=0
"RTN","HLUCM050",51,0)
 .  .  .  F  S I773(1)=$O(^HLMA("AF",I773,I773(1))) Q:I773(1)'>0!(TOTNUM>19)  D
"RTN","HLUCM050",52,0)
 .  .  .  .  S X=+$G(^HLMA(+I773(1),0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",53,0)
 .  .  .  S I773(1)=0
"RTN","HLUCM050",54,0)
 .  .  .  F  S I773(1)=$O(^HLMA("C",MSGID,I773(1))) Q:I773(1)'>0!(TOTNUM>19)  D
"RTN","HLUCM050",55,0)
 .  .  .  .  S X=+$G(^HLMA(+I773(1),0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",56,0)
 .  .  .  KILL I773(1)
"RTN","HLUCM050",57,0)
 .  .  .  D MSGID(MSGID)
"RTN","HLUCM050",58,0)
 .  .
"RTN","HLUCM050",59,0)
 .  .  ;
"RTN","HLUCM050",60,0)
 .  .  ; ACK TO search...
"RTN","HLUCM050",61,0)
 .  .  I $P(DATA,U,7)>0,$P(DATA,U,7)'=IEN772 D
"RTN","HLUCM050",62,0)
 .  .  .  D HOLDTOT(+$P(DATA,U,7))
"RTN","HLUCM050",63,0)
 .  .  I I773 D
"RTN","HLUCM050",64,0)
 .  .  .  S ACKTO=$P($G(^HLMA(+I773,0)),U,10) QUIT:ACKTO'>0  ;->
"RTN","HLUCM050",65,0)
 .  .  .  S X=+$G(^HLMA(+ACKTO,0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",66,0)
 .  .  ;
"RTN","HLUCM050",67,0)
 .  .  ; HLPARENT search...
"RTN","HLUCM050",68,0)
 .  .  I $P(DATA,U,8)>0,$P(DATA,U,8)'=IEN772 D
"RTN","HLUCM050",69,0)
 .  .  .  D HOLDTOT(+$P(DATA,U,8))
"RTN","HLUCM050",70,0)
 .  .  I I773 D
"RTN","HLUCM050",71,0)
 .  .  .  S PIEN=$P($G(^HLMA(+I773,0)),U,6) QUIT:PIEN'>0  ;->
"RTN","HLUCM050",72,0)
 .  .  .  S X=+$G(^HLMA(+PIEN,0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",73,0)
 .  .
"RTN","HLUCM050",74,0)
 .  .  MERGE HLNMSP=HOLDNMSP
"RTN","HLUCM050",75,0)
 .  .  KILL HOLDNMSP
"RTN","HLUCM050",76,0)
 .
"RTN","HLUCM050",77,0)
 .  S I=0,NUM=0 F  S I=$O(HLNMSP(I)) Q:'I  S NUM=NUM+1
"RTN","HLUCM050",78,0)
 ;
"RTN","HLUCM050",79,0)
 I '$$OKALL(.HLNMSP) D  QUIT "" ;->
"RTN","HLUCM050",80,0)
 .  KILL HLNMSP
"RTN","HLUCM050",81,0)
 ;
"RTN","HLUCM050",82,0)
 S FAC=$$FACILITY^HLUCM090(.HLNMSP) I FAC']"" S FAC="UNKNOWN"
"RTN","HLUCM050",83,0)
 S IENPAR=$O(HLNMSP(0))
"RTN","HLUCM050",84,0)
 ;
"RTN","HLUCM050",85,0)
 ; Find total number characters...
"RTN","HLUCM050",86,0)
 KILL TIMEP
"RTN","HLUCM050",87,0)
 S IEN772=0,CHARC=0,CHARP=0,CT=0,MTYPEP="",NMSPP="",PROTP="",NUM=0
"RTN","HLUCM050",88,0)
 F  S IEN772=$O(HLNMSP(IEN772)) Q:'IEN772  D
"RTN","HLUCM050",89,0)
 .  S CT=CT+1,NUM=NUM+1
"RTN","HLUCM050",90,0)
 .
"RTN","HLUCM050",91,0)
 .  S TMP($J,"HLPARENT",+IENPAR,+IEN772)=$$VAL3(+IEN772,FAC)_U_IENPAR
"RTN","HLUCM050",92,0)
 .
"RTN","HLUCM050",93,0)
 .  S CHARC=$$CHAR(+IEN772)
"RTN","HLUCM050",94,0)
 .  S DATAC(IEN772)=CHARC
"RTN","HLUCM050",95,0)
 .  S CHARP=CHARP+CHARC
"RTN","HLUCM050",96,0)
 .
"RTN","HLUCM050",97,0)
 .  S $P(DATAC(IEN772),U,2)=1
"RTN","HLUCM050",98,0)
 .
"RTN","HLUCM050",99,0)
 .  S TIME=$$TIME(+IEN772)
"RTN","HLUCM050",100,0)
 .  F I=1:1:3 S $P(DATAC(IEN772),U,2+I)=$P(TIME,U,I)
"RTN","HLUCM050",101,0)
 .  F I=2,3 S X=$P(TIME,U,I) I X?7N.E S TIMEP(X)=""
"RTN","HLUCM050",102,0)
 .
"RTN","HLUCM050",103,0)
 .  S MTYPEC=$$MSGTYPE^HLUCM009(IEN772)
"RTN","HLUCM050",104,0)
 .  S $P(DATAC(IEN772),U,6)=MTYPEC
"RTN","HLUCM050",105,0)
 .  S MTYPEP=MTYPEP_$S(MTYPEP]"":"~",1:"")_MTYPEC
"RTN","HLUCM050",106,0)
 .
"RTN","HLUCM050",107,0)
 .  S PROT=$$PROT101^HLUCM002(+IEN772)
"RTN","HLUCM050",108,0)
 .  S $P(DATAC(IEN772),U,7)=PROT
"RTN","HLUCM050",109,0)
 .  S:PROT]"" PROTP=PROT
"RTN","HLUCM050",110,0)
 .
"RTN","HLUCM050",111,0)
 .  S NMSP=$$NMSPALL(+IEN772)
"RTN","HLUCM050",112,0)
 .  S $P(DATAC(IEN772),U,9)=NMSP
"RTN","HLUCM050",113,0)
 .  I NMSP]"" D
"RTN","HLUCM050",114,0)
 .  .  I NMSPP]"",NMSP="XWB",NMSPP'="XWB" QUIT  ;->
"RTN","HLUCM050",115,0)
 .  .  S NMSPP=NMSP
"RTN","HLUCM050",116,0)
 .
"RTN","HLUCM050",117,0)
 .  S $P(DATAC(IEN772),U,11)=FAC
"RTN","HLUCM050",118,0)
 ;
"RTN","HLUCM050",119,0)
 S TIMEBEG=$O(TIMEP(0)),TIMEEND=$O(TIMEP(":"),-1)
"RTN","HLUCM050",120,0)
 S TMDIFF=$$FMDIFF^XLFDT(TIMEEND,TIMEBEG,2)
"RTN","HLUCM050",121,0)
 ;
"RTN","HLUCM050",122,0)
 S DATAP=CHARP_U_CT_U_TMDIFF_U_TIMEBEG_U_TIMEEND_U_MTYPEP_U_PROTP_U_U_NMSPP_U_U_FAC
"RTN","HLUCM050",123,0)
 ;
"RTN","HLUCM050",124,0)
 ; Set PARENT node...
"RTN","HLUCM050",125,0)
 S IENPAR=$O(HLNMSP(0))
"RTN","HLUCM050",126,0)
 S TMP($J,"HLPARENT",+IENPAR)=DATAP
"RTN","HLUCM050",127,0)
 ;
"RTN","HLUCM050",128,0)
 ; Set CHILD nodes...
"RTN","HLUCM050",129,0)
 S IEN772=0
"RTN","HLUCM050",130,0)
 F  S IEN772=$O(HLNMSP(IEN772)) Q:IEN772'>0  D
"RTN","HLUCM050",131,0)
 .  S TMP($J,"HLCHILD",+IEN772)=IENPAR_"~"_$G(DATAC(+IEN772))
"RTN","HLUCM050",132,0)
 ;
"RTN","HLUCM050",133,0)
 KILL HLNMSP
"RTN","HLUCM050",134,0)
 MERGE HLNMSP=TMP($J)
"RTN","HLUCM050",135,0)
 MERGE ^TMP($J)=TMP($J)
"RTN","HLUCM050",136,0)
 ;
"RTN","HLUCM050",137,0)
 Q NUM
"RTN","HLUCM050",138,0)
 ;
"RTN","HLUCM050",139,0)
OKALL(HLNMSP) ; Does every 772 entry have a valid .01 node?
"RTN","HLUCM050",140,0)
 N FAIL,I772
"RTN","HLUCM050",141,0)
 S FAIL=0,I772=0
"RTN","HLUCM050",142,0)
 F  S I772=$O(HLNMSP(I772)) Q:'I772!(FAIL)  D
"RTN","HLUCM050",143,0)
 .  QUIT:$P($G(^HL(772,+I772,0)),U)?7N1"."1.N  ;->
"RTN","HLUCM050",144,0)
 .  S FAIL=1
"RTN","HLUCM050",145,0)
 Q 'FAIL
"RTN","HLUCM050",146,0)
 ;
"RTN","HLUCM050",147,0)
VAL3(IEN772,FAC) ; Return sort values...
"RTN","HLUCM050",148,0)
 N TYPEHR,TYPEIO,TYPELR
"RTN","HLUCM050",149,0)
 S TYPEHR=$$TYPETMO^HLUCM002(+IEN772)
"RTN","HLUCM050",150,0)
 S TYPEIO=$$TYPEIO^HLUCM002(+IEN772)
"RTN","HLUCM050",151,0)
 ;S TYPELR=$$TYPELR^HLUCM001(+IEN772,FAC)
"RTN","HLUCM050",152,0)
 S TYPELR=$S(FAC["~DNS":"R",1:"L")
"RTN","HLUCM050",153,0)
 Q TYPEHR_U_TYPEIO_U_TYPELR
"RTN","HLUCM050",154,0)
 ;
"RTN","HLUCM050",155,0)
TIME(IEN772) ; Times...
"RTN","HLUCM050",156,0)
 N CT,DATA,IEN773,TMBEG,TMEND,TMDIFF
"RTN","HLUCM050",157,0)
 D TOT772T^HLUCM(+IEN772)
"RTN","HLUCM050",158,0)
 S IEN773=0,CT=0
"RTN","HLUCM050",159,0)
 F  S IEN773=$O(^HLMA("B",+IEN772,IEN773)) Q:'IEN773!(CT>20)  D
"RTN","HLUCM050",160,0)
 .  S CT=CT+1
"RTN","HLUCM050",161,0)
 .  D TOT773T^HLUCM(+IEN773)
"RTN","HLUCM050",162,0)
 D TMDIFF^HLUCM
"RTN","HLUCM050",163,0)
 Q DATA("DIFF")_U_DATA("START")_U_DATA("END")
"RTN","HLUCM050",164,0)
 ;
"RTN","HLUCM050",165,0)
 ;
"RTN","HLUCM050",166,0)
CHAR(IEN772) ; Number characters...
"RTN","HLUCM050",167,0)
 N CT,DATA,IEN773
"RTN","HLUCM050",168,0)
 D TOT772C^HLUCM(+IEN772)
"RTN","HLUCM050",169,0)
 S IEN773=0,CT=0
"RTN","HLUCM050",170,0)
 F  S IEN773=$O(^HLMA("B",+IEN772,IEN773)) Q:'IEN773!(CT>20)  D
"RTN","HLUCM050",171,0)
 .  S CT=CT+1
"RTN","HLUCM050",172,0)
 .  D TOT773C^HLUCM(+IEN773)
"RTN","HLUCM050",173,0)
 Q $G(DATA("CHAR"))
"RTN","HLUCM050",174,0)
 ;
"RTN","HLUCM050",175,0)
GETNMSP(IEN772) ; The one and only place to ask for NAMESPACE...
"RTN","HLUCM050",176,0)
 N HL,NMSP,NUM,PAR,VAL
"RTN","HLUCM050",177,0)
 S NUM=$$LOADEM^HLUCM050(+IEN772,.HL) QUIT:NUM'>0 "" ;->
"RTN","HLUCM050",178,0)
 S PAR=+$G(HL("HLCHILD",+IEN772))
"RTN","HLUCM050",179,0)
 S VAL=$G(HL("HLPARENT",+PAR))
"RTN","HLUCM050",180,0)
 Q $P(VAL,U,9)
"RTN","HLUCM050",181,0)
 ;
"RTN","HLUCM050",182,0)
GETPROT(IEN772) ; One & only place to ask for PROTOCOL...
"RTN","HLUCM050",183,0)
 N HL,NMSP,NUM,PAR,VAL
"RTN","HLUCM050",184,0)
 S NUM=$$LOADEM^HLUCM050(+IEN772,.HL) QUIT:NUM'>0 "" ;->
"RTN","HLUCM050",185,0)
 S PAR=+$G(HL("HLCHILD",+IEN772))
"RTN","HLUCM050",186,0)
 S VAL=$G(HL("HLPARENT",+PAR))
"RTN","HLUCM050",187,0)
 Q $P(VAL,U,7)
"RTN","HLUCM050",188,0)
 ;
"RTN","HLUCM050",189,0)
HOLDTOT(X) D HOLDTOT^HLUCM009(X) QUIT
"RTN","HLUCM050",190,0)
MSGID(X) D MSGID^HLUCM009(X) QUIT
"RTN","HLUCM050",191,0)
 ;
"RTN","HLUCM050",192,0)
NMSPALL(IEN772) ;Perform all attempts to find NMSP...
"RTN","HLUCM050",193,0)
 N IEN101,IEN94,NMSP
"RTN","HLUCM050",194,0)
 ;
"RTN","HLUCM050",195,0)
 ; If SPR...
"RTN","HLUCM050",196,0)
 S NMSP=$$SPR(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",197,0)
 ;
"RTN","HLUCM050",198,0)
 ; Check MSH segment...
"RTN","HLUCM050",199,0)
 S NMSP=$$MSH772^HLUCM003(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",200,0)
 S NMSP=$$MSHMAIL^HLUCM003(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",201,0)
 ;
"RTN","HLUCM050",202,0)
 ; Get Event Protocol
"RTN","HLUCM050",203,0)
 S IEN101=+$P($G(^HL(772,+IEN772,0)),U,10) QUIT:IEN101'>0 "" ;->
"RTN","HLUCM050",204,0)
 ;
"RTN","HLUCM050",205,0)
 ; Find XEC routines, and try NMSPXRFs...
"RTN","HLUCM050",206,0)
 S NMSP=$$NMSPXRF(+IEN101) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",207,0)
 ;
"RTN","HLUCM050",208,0)
 ; Try 9.4 link...
"RTN","HLUCM050",209,0)
 S IEN94=$P($G(^ORD(101,+IEN101,0)),U,12)
"RTN","HLUCM050",210,0)
 I IEN94 S NMSP=$P($$NMSP94(IEN94),U,2) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",211,0)
 ;
"RTN","HLUCM050",212,0)
 S NMSP=$$MSH773^HLUCM003(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",213,0)
 ;
"RTN","HLUCM050",214,0)
 QUIT ""
"RTN","HLUCM050",215,0)
 ;
"RTN","HLUCM050",216,0)
NMSP94(IEN94) ; From 9.4 find it's namespace...
"RTN","HLUCM050",217,0)
 N D0,DA,DIC,DIQ,DR,NMSP,RET
"RTN","HLUCM050",218,0)
 S RET=$G(^TMP($J,"HLNMSP94",+IEN94)) I RET]"" QUIT RET ;->
"RTN","HLUCM050",219,0)
 S DIC=9.4,DR=".01;1",DA=IEN94,DIQ="NMSP(",DIQ(0)="E"
"RTN","HLUCM050",220,0)
 D EN^DIQ1
"RTN","HLUCM050",221,0)
 S RET=$G(NMSP(9.4,+IEN94,.01,"E"))_U_$G(NMSP(9.4,+IEN94,1,"E"))
"RTN","HLUCM050",222,0)
 S ^TMP($J,"HLNMSP94",+IEN94)=RET
"RTN","HLUCM050",223,0)
 QUIT RET
"RTN","HLUCM050",224,0)
 ;
"RTN","HLUCM050",225,0)
NMSPCHG(NMSP) ; Some miscellaneous special actions first...
"RTN","HLUCM050",226,0)
 N PCKG
"RTN","HLUCM050",227,0)
 ;
"RTN","HLUCM050",228,0)
 ; Check xref first...
"RTN","HLUCM050",229,0)
 D:'$D(^TMP($J,"HLNMSPXRF")) NMSPXRF^HLUCM009
"RTN","HLUCM050",230,0)
 S PCKG=$$NMSPFROM(NMSP) QUIT:PCKG]"" PCKG ;->
"RTN","HLUCM050",231,0)
 ;
"RTN","HLUCM050",232,0)
 S PCKG=NMSP
"RTN","HLUCM050",233,0)
 ;
"RTN","HLUCM050",234,0)
 ; Other conversions here...
"RTN","HLUCM050",235,0)
 I $E(PCKG,1,2)="DG",PCKG'="DG" S PCKG="DG"
"RTN","HLUCM050",236,0)
 I $E(PCKG,1,3)="VEI",PCKG'="VEIB" S PCKG="VEIB"
"RTN","HLUCM050",237,0)
 I $E(PCKG,1,2)="VA" D
"RTN","HLUCM050",238,0)
 .  I PCKG["PIMS" S PCKG="DG" QUIT  ;->
"RTN","HLUCM050",239,0)
 .  I $G(APPR)["HEC " S PCKG="HEC" QUIT  ;->
"RTN","HLUCM050",240,0)
 .  I $G(FACR)["HEC " S PCKG="HEC" QUIT  ;->
"RTN","HLUCM050",241,0)
 I $E(PCKG,1,2)="LA" S PCKG="LA"
"RTN","HLUCM050",242,0)
 I $E(PCKG,1,2)="VA",PCKG[" PIMS" S PCKG="DG"
"RTN","HLUCM050",243,0)
 I $E(PCKG,1,10)="VAFC ADMIT" S PCKG="DG"
"RTN","HLUCM050",244,0)
 I $E(PCKG,1,8)="VAFC ADT" S PCKG="DG"
"RTN","HLUCM050",245,0)
 I $E(PCKG,1,8)?1"VAFH A"2N S PCKG="DG"
"RTN","HLUCM050",246,0)
 I $E(PCKG,1,15)?1"VAFH CLIENT A"2N S PCKG="DG"
"RTN","HLUCM050",247,0)
 I $E(PCKG,1,2)="XM" S PCKG="XM"
"RTN","HLUCM050",248,0)
 I $E(PCKG,1,2)="XU" S PCKG="XU"
"RTN","HLUCM050",249,0)
 ;
"RTN","HLUCM050",250,0)
 QUIT PCKG
"RTN","HLUCM050",251,0)
 ;
"RTN","HLUCM050",252,0)
NMSPXRF(IEN101) ; Find NMSP from ^TMP($J,"NMSPXRF")
"RTN","HLUCM050",253,0)
 N LEN,NMSP,NODE,RTN
"RTN","HLUCM050",254,0)
 I '$D(^TMP($J,"HLNMSPXRF")) D NMSPXRF^HLUCM009 ; Build, if not there
"RTN","HLUCM050",255,0)
 S NMSP=""
"RTN","HLUCM050",256,0)
 F NODE=772,774,771 D  QUIT:NMSP]""
"RTN","HLUCM050",257,0)
 .  S RTN=$E($P($G(^ORD(101,+IEN101,NODE)),U,2),1,4) QUIT:RTN']""  ;->
"RTN","HLUCM050",258,0)
 .  S NMSP=$$NMSPFROM(RTN)
"RTN","HLUCM050",259,0)
 Q NMSP
"RTN","HLUCM050",260,0)
 ;
"RTN","HLUCM050",261,0)
NMSPFROM(TXT) ; From TXT try to find NMSP...
"RTN","HLUCM050",262,0)
 N NMSP
"RTN","HLUCM050",263,0)
 QUIT:$G(TXT)']"" "" ;->
"RTN","HLUCM050",264,0)
 S NMSP=""
"RTN","HLUCM050",265,0)
 F LEN=4:-1:2 D  QUIT:NMSP]""
"RTN","HLUCM050",266,0)
 .  S NMSP=$G(^TMP($J,"HLNMSPXRF",$E(TXT,1,LEN))) QUIT:NMSP]""  ;->
"RTN","HLUCM050",267,0)
 I NMSP']"" F LEN=4:-1:2 D  QUIT:NMSP]""
"RTN","HLUCM050",268,0)
 .  ; See Integration Agreement #10048
"RTN","HLUCM050",269,0)
 .  N D,DIC,X,Y
"RTN","HLUCM050",270,0)
 .  S DIC="^DIC(9.4,",DIC(0)="FO",D="C",X=$E(TXT,1,LEN)
"RTN","HLUCM050",271,0)
 .  D MIX^DIC1 QUIT:+Y'>0  ;->
"RTN","HLUCM050",272,0)
 .  ; Found!  So, set into ^TMP...
"RTN","HLUCM050",273,0)
 .  S NMSP=$E(TXT,1,LEN)
"RTN","HLUCM050",274,0)
 .  S ^TMP($J,"HLNMSPXRF",NMSP)=NMSP
"RTN","HLUCM050",275,0)
 Q NMSP
"RTN","HLUCM050",276,0)
 ;
"RTN","HLUCM050",277,0)
SPR(IEN772) ; Evaluate SPR segment for RPC for package, possible
"RTN","HLUCM050",278,0)
 ; resetting the PCKG variable...
"RTN","HLUCM050",279,0)
 ; PCKG -- req
"RTN","HLUCM050",280,0)
 N CHAR,DEL,IN,NMSP
"RTN","HLUCM050",281,0)
 S IN=$G(^HL(772,+IEN772,"IN",1,0))
"RTN","HLUCM050",282,0)
 QUIT:$E(IN,1,4)'="SPR^" "" ;->
"RTN","HLUCM050",283,0)
 QUIT:IN'["REMOTE RPC^" "" ;->
"RTN","HLUCM050",284,0)
 S DEL=$E(IN,4)
"RTN","HLUCM050",285,0)
 S IN=$P(IN,DEL,5) QUIT:IN']"" "" ;->
"RTN","HLUCM050",286,0)
 S IN=$P(IN,"003RPC",2) QUIT:IN']"" "" ;->
"RTN","HLUCM050",287,0)
 S CHAR=+IN,IN=$TR($E(IN,4,CHAR+4),"&","") QUIT:IN']"" "" ;->
"RTN","HLUCM050",288,0)
 I $E(IN,1,2)="IB" QUIT "IB" ;->
"RTN","HLUCM050",289,0)
 I $E(IN,1,2)="OR" QUIT "OR" ;->
"RTN","HLUCM050",290,0)
 I '$D(^TMP($J,"HLNMSPXRF")) D NMSPXRF^HLUCM009
"RTN","HLUCM050",291,0)
 S NMSP=$$NMSPFROM(IN)
"RTN","HLUCM050",292,0)
 QUIT NMSP
"RTN","HLUCM050",293,0)
 ;
"RTN","HLUCM050",294,0)
EOR ; HLUCM050 - HL7/Capacity Mgt API-II ;10/23/01 12:01
"RTN","HLUCM090")
0^1^B61573251
"RTN","HLUCM090",1,0)
HLUCM090 ;CIOFO-O/LJA - Facility Finder Software ;2/20/2003 - 12:35
"RTN","HLUCM090",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**103,114**;Oct 13, 1995
"RTN","HLUCM090",3,0)
 ;
"RTN","HLUCM090",4,0)
FACILITY(IEN772) ; Return facility name for REMOTE entries
"RTN","HLUCM090",5,0)
 ; IMPORTANT!!  Do not call here unless the entry is REMOTE
"RTN","HLUCM090",6,0)
 ;
"RTN","HLUCM090",7,0)
 N FACNM
"RTN","HLUCM090",8,0)
 N FACNM,IEN773,LOCAL,MSH,NO773
"RTN","HLUCM090",9,0)
 ;
"RTN","HLUCM090",10,0)
 ; Is FAC a local station number?
"RTN","HLUCM090",11,0)
 S LOCAL=$P($$SITE^VASITE,U,3)_"~"_$P($$SITE^VASITE,U,2)_"~LOCAL"
"RTN","HLUCM090",12,0)
 ;
"RTN","HLUCM090",13,0)
 S IEN772=0,FACNM=""
"RTN","HLUCM090",14,0)
 F  S IEN772=$O(IEN772(IEN772)) Q:'IEN772!(FACNM]"")  D
"RTN","HLUCM090",15,0)
 .  S FACNM=$$FACNM(+IEN772)
"RTN","HLUCM090",16,0)
 ;
"RTN","HLUCM090",17,0)
 Q $S(FACNM]"":FACNM,1:LOCAL)
"RTN","HLUCM090",18,0)
 ;
"RTN","HLUCM090",19,0)
FACNM(IEN772) ; Return FACILITY NAME for one 772 entry...
"RTN","HLUCM090",20,0)
 N CT,DATA,FACNM,MSH,NO,PROT
"RTN","HLUCM090",21,0)
 ;
"RTN","HLUCM090",22,0)
 ; Try to extract from MSH segment in file 773...
"RTN","HLUCM090",23,0)
 S FACNM=$$MSH773(+IEN772) QUIT:FACNM]"" $$FACDNS(FACNM) ;->
"RTN","HLUCM090",24,0)
 ;
"RTN","HLUCM090",25,0)
 ; Try to find MSH in 772...
"RTN","HLUCM090",26,0)
 S FACNM=$$SEG772(+IEN772) QUIT:FACNM]"" $$FACDNS(FACNM) ;->
"RTN","HLUCM090",27,0)
 ;
"RTN","HLUCM090",28,0)
 ; Try to find MSH in 870...
"RTN","HLUCM090",29,0)
 S FACNM=$$MSH870(+IEN772) QUIT:FACNM]"" $$FACDNS(FACNM) ;->
"RTN","HLUCM090",30,0)
 ;
"RTN","HLUCM090",31,0)
 Q ""
"RTN","HLUCM090",32,0)
 ;
"RTN","HLUCM090",33,0)
MSH870(IEN772) ; Find facility name from MSH in 870 OUT QUEUE...
"RTN","HLUCM090",34,0)
 N CT,DATA,IEN772N,LL,MSH,NO,PROT,PROTS
"RTN","HLUCM090",35,0)
 ;
"RTN","HLUCM090",36,0)
 ; Look at parent...
"RTN","HLUCM090",37,0)
 S IEN772N=+$G(^TMP($J,"HLOAD772","X",+IEN772))
"RTN","HLUCM090",38,0)
 I IEN772N'>0 S IEN772N=+IEN772
"RTN","HLUCM090",39,0)
 ;
"RTN","HLUCM090",40,0)
 S PROT=$P($G(^HL(772,+IEN772N,0)),U,10) QUIT:'PROT "" ;->
"RTN","HLUCM090",41,0)
 S FACNM="",PROTS=0
"RTN","HLUCM090",42,0)
 F  S PROTS=$O(^ORD(101,+PROT,775,"B",PROTS)) QUIT:'PROTS!(FACNM]"")  D
"RTN","HLUCM090",43,0)
 .  S LL=$P($G(^ORD(101,+PROTS,770)),U,7) QUIT:'LL  ;->
"RTN","HLUCM090",44,0)
 .  S MSH="",NO=0,CT=0
"RTN","HLUCM090",45,0)
 .  F  S NO=$O(^HLCS(870,+LL,2,NO)) Q:MSH]""!('NO)!(CT>10)!(FACNM]"")  D
"RTN","HLUCM090",46,0)
 .  .  S CT=CT+1
"RTN","HLUCM090",47,0)
 .  .  S DATA=$G(^HLCS(870,+LL,2,+NO,1,1,0)) QUIT:$E(DATA,1,3)'="MSH"  ;->
"RTN","HLUCM090",48,0)
 .  .  S MSH=DATA,FACNM=$$MSHXTRCT(MSH,"O")
"RTN","HLUCM090",49,0)
 Q FACNM
"RTN","HLUCM090",50,0)
 ;
"RTN","HLUCM090",51,0)
SEG772(IEN772) ; Try to find SEGment in 772, and extract facility...
"RTN","HLUCM090",52,0)
 N SEG,WAY
"RTN","HLUCM090",53,0)
 S WAY=$P($G(^HL(772,+IEN772,0)),U,4) QUIT:WAY']"" "" ;->
"RTN","HLUCM090",54,0)
 S SEG=$G(^HL(772,+IEN772,"IN",1,0))
"RTN","HLUCM090",55,0)
 I $E(SEG,1,3)="MSH" QUIT $$MSHXTRCT(SEG,WAY) ;->
"RTN","HLUCM090",56,0)
 I $E(SEG,1,3)="SPR" QUIT $$SPRXTRCT(IEN772,SEG) ;->
"RTN","HLUCM090",57,0)
 Q ""
"RTN","HLUCM090",58,0)
 ;
"RTN","HLUCM090",59,0)
MSH773(IEN772) ; Try to extract from MSH segment in file 773...
"RTN","HLUCM090",60,0)
 N FACNM,IEN773,NO773
"RTN","HLUCM090",61,0)
 S NO773=$$IEN773(IEN772,.IEN773)
"RTN","HLUCM090",62,0)
 I NO773 S FACNM=$O(IEN773("")) QUIT:FACNM]"" FACNM ;->
"RTN","HLUCM090",63,0)
 Q ""
"RTN","HLUCM090",64,0)
 ;
"RTN","HLUCM090",65,0)
IEN773(IEN772,IEN773) ; Find associated 773 entries...
"RTN","HLUCM090",66,0)
 N DEL,IEN,MSH,RFN,VAL,WAY
"RTN","HLUCM090",67,0)
 ;
"RTN","HLUCM090",68,0)
 KILL IEN773
"RTN","HLUCM090",69,0)
 S IEN773=0
"RTN","HLUCM090",70,0)
 ;
"RTN","HLUCM090",71,0)
 S IEN=0
"RTN","HLUCM090",72,0)
 F  S IEN=$O(^HLMA("B",+IEN772,IEN)) Q:'IEN  D
"RTN","HLUCM090",73,0)
 .  S VAL=$G(^HLMA(+IEN,0)) QUIT:VAL']""  ;->
"RTN","HLUCM090",74,0)
 .  S WAY=$P(VAL,U,3) QUIT:WAY']""  ;->
"RTN","HLUCM090",75,0)
 .  S MSH=$G(^HLMA(+IEN,"MSH",1,0)) QUIT:MSH']""  ;->
"RTN","HLUCM090",76,0)
 .  S RFN=$$MSHXTRCT(MSH,WAY) QUIT:RFN']""  ;->
"RTN","HLUCM090",77,0)
 .  S IEN773(RFN,+IEN)=WAY
"RTN","HLUCM090",78,0)
 .  S IEN773(RFN)=$G(IEN773(RFN))+1
"RTN","HLUCM090",79,0)
 .  S IEN773=$G(IEN773)+1
"RTN","HLUCM090",80,0)
 ;
"RTN","HLUCM090",81,0)
 Q +IEN773
"RTN","HLUCM090",82,0)
 ;
"RTN","HLUCM090",83,0)
MSHXTRCT(MSH,WAY) ; Given I/O WAY and MSH segment, return facility
"RTN","HLUCM090",84,0)
 N DEL,RFN,X
"RTN","HLUCM090",85,0)
 S DEL=$E(MSH,4)
"RTN","HLUCM090",86,0)
 S RFN=$P(MSH,DEL,$S(WAY="I":4,WAY="O":6,1:999)) QUIT:RFN']"" "" ;->
"RTN","HLUCM090",87,0)
 I RFN?3N!(RFN?3N1U.E) S X=$$FRSTANO(RFN) S:X]"" RFN=X
"RTN","HLUCM090",88,0)
 Q RFN
"RTN","HLUCM090",89,0)
 ;
"RTN","HLUCM090",90,0)
SPRXTRCT(IEN772,SPR) ; Given SPR segment, extract facility
"RTN","HLUCM090",91,0)
 N CHAR,DIV,I773,MSH
"RTN","HLUCM090",92,0)
 S I773=$O(^HLMA("B",+IEN772,0))
"RTN","HLUCM090",93,0)
 S MSH=$G(^HLMA(+I773,"MSH",1,0))
"RTN","HLUCM090",94,0)
 S DIV=$E(MSH,7)
"RTN","HLUCM090",95,0)
 S:DIV']"" DIV="\"
"RTN","HLUCM090",96,0)
 Q $P(SPR,DIV,5)
"RTN","HLUCM090",97,0)
 ;
"RTN","HLUCM090",98,0)
FRSTANO(STANO) ;
"RTN","HLUCM090",99,0)
 N IEN,NM
"RTN","HLUCM090",100,0)
 S IEN=$O(^DIC(4,"D",STANO,0)) QUIT:IEN'>0 "" ;->
"RTN","HLUCM090",101,0)
 S NM=$P($G(^DIC(4,+IEN,0)),U)
"RTN","HLUCM090",102,0)
 QUIT NM
"RTN","HLUCM090",103,0)
 ;
"RTN","HLUCM090",104,0)
ACCUMFAC ; Create ^TMP(TOTALS,$J,"RFAC") data...
"RTN","HLUCM090",105,0)
 N INFO,PARENT,TYPE
"RTN","HLUCM090",106,0)
 ;
"RTN","HLUCM090",107,0)
 D ACCUMLAT^HLUCM009("RFAC","LR","R",FAC,DATA("PCKG"),START,DATA("PROT"))
"RTN","HLUCM090",108,0)
 ;
"RTN","HLUCM090",109,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,"RFAC"))
"RTN","HLUCM090",110,0)
 D INCR^HLUCM001
"RTN","HLUCM090",111,0)
 S ^TMP(TOTALS,$J,"RFAC")=TOTCURR
"RTN","HLUCM090",112,0)
 ;
"RTN","HLUCM090",113,0)
 Q
"RTN","HLUCM090",114,0)
 ;
"RTN","HLUCM090",115,0)
INST870(IEN772,INST) ;
"RTN","HLUCM090",116,0)
 N INST870,LINK
"RTN","HLUCM090",117,0)
 S LINK=$$LINK(IEN772) QUIT:LINK'>0 "" ;->
"RTN","HLUCM090",118,0)
 S INST870=+$P($G(^HLCS(870,+LINK,0)),U,2)
"RTN","HLUCM090",119,0)
 QUIT $S(INST870>0&(INST870'=INST):"R",1:"L")
"RTN","HLUCM090",120,0)
 ;
"RTN","HLUCM090",121,0)
MAIL870(IEN772) ;
"RTN","HLUCM090",122,0)
 N LINK,MAIL
"RTN","HLUCM090",123,0)
 S LINK=$$LINK(IEN772) QUIT:LINK'>0 "" ;->
"RTN","HLUCM090",124,0)
 S MAIL=$P($G(^HLCS(870,+LINK,0)),U,3)
"RTN","HLUCM090",125,0)
 QUIT $S(MAIL=1:"R",1:"L")
"RTN","HLUCM090",126,0)
 ;
"RTN","HLUCM090",127,0)
LINK(IEN772) ;
"RTN","HLUCM090",128,0)
 N IEN773,LINK
"RTN","HLUCM090",129,0)
 S LINK=$P($G(^HL(772,IEN772,0)),U,11)
"RTN","HLUCM090",130,0)
 I LINK'>0 D
"RTN","HLUCM090",131,0)
 .  S IEN773=$O(^HLMA("B",IEN772,0)) QUIT:IEN773'>0  ;->
"RTN","HLUCM090",132,0)
 .  S LINK=$P($G(^HLMA(+IEN773,0)),U,7)
"RTN","HLUCM090",133,0)
 QUIT LINK
"RTN","HLUCM090",134,0)
 ;
"RTN","HLUCM090",135,0)
PRINTDBG ; Print data in ^TMP($J,"HLUCMSTORE")
"RTN","HLUCM090",136,0)
 N CHAR,CT,IEN772,IEN773,IOINHI,IOINORM,LP,PAUSE,PRINT
"RTN","HLUCM090",137,0)
 N S1,S2,SKIP,ST,STOP,VAL
"RTN","HLUCM090",138,0)
 I $G(JOBN)']"" N JOBN S JOBN=$J
"RTN","HLUCM090",139,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","HLUCM090",140,0)
 S LP=$NA(^TMP(JOBN,"HLUCMSTORE")),ST=$P(LP,")")_","
"RTN","HLUCM090",141,0)
 ;
"RTN","HLUCM090",142,0)
 R !!,"Print T nodes(Y/N): No// ",ANS:999 Q:ANS[U  ;->
"RTN","HLUCM090",143,0)
 S SKIP=$S(ANS=""!(ANS="N"):"",1:"T")
"RTN","HLUCM090",144,0)
 ;
"RTN","HLUCM090",145,0)
 R !!,"Print X nodes(Y/N): No// ",ANS:999 Q:ANS[U  ;->
"RTN","HLUCM090",146,0)
 S SKIP=SKIP_$S(ANS=""!(ANS="N"):"",1:"X")
"RTN","HLUCM090",147,0)
 ;
"RTN","HLUCM090",148,0)
 R !!,"Print U nodes(Y/N): Yes// ",ANS:999 Q:ANS[U  ;->
"RTN","HLUCM090",149,0)
 S SKIP=SKIP_$S(ANS=""!(ANS="Y"):"U",1:"")
"RTN","HLUCM090",150,0)
 ;
"RTN","HLUCM090",151,0)
 S CT=0,PAUSE=1,STOP=0
"RTN","HLUCM090",152,0)
 F  S LP=$Q(@LP) Q:LP'[ST!(STOP)  D
"RTN","HLUCM090",153,0)
 .  S X=$E($TR($P(LP,",",3),"""","")_" ") I SKIP'[X QUIT  ;->
"RTN","HLUCM090",154,0)
 .  S DATA=$P(LP,ST,2,99)_"=",PX=$L(DATA),DATA=IOINHI_DATA_IOINORM_@LP
"RTN","HLUCM090",155,0)
 .  F  D  Q:DATA']""  Q:STOP
"RTN","HLUCM090",156,0)
 .  .  S PRINT=$E(DATA,1,77),DATA=$E(DATA,78,999)
"RTN","HLUCM090",157,0)
 .  .  I DATA]"" S DATA=$$REPEAT^XLFSTR(" ",PX)_DATA
"RTN","HLUCM090",158,0)
 .  .  W !,PRINT
"RTN","HLUCM090",159,0)
 .  QUIT:'PAUSE  ;->
"RTN","HLUCM090",160,0)
 .  S CT=CT+1 QUIT:CT<22  ;->
"RTN","HLUCM090",161,0)
 .  W " ",IOINHI,"<",IOINORM
"RTN","HLUCM090",162,0)
 .  R X:999 S:X[U STOP=1 S:X=" " PAUSE=0
"RTN","HLUCM090",163,0)
 .  S CT=0
"RTN","HLUCM090",164,0)
 QUIT
"RTN","HLUCM090",165,0)
 ;
"RTN","HLUCM090",166,0)
PRINT1 ;
"RTN","HLUCM090",167,0)
 N DATA,L1,L2,L3,L4,L5,LAST,TOT,TOT1,TOT2,TOT3,TYP
"RTN","HLUCM090",168,0)
PRINT2 I $G(GBL)']"" N GBL S GBL="^TMP("""_SUB_""","_JOBN_")"
"RTN","HLUCM090",169,0)
 S (TOT,TOT1,TOT2,TOT3)=0
"RTN","HLUCM090",170,0)
 I $O(@GBL@(""))']"" D  QUIT  ;->
"RTN","HLUCM090",171,0)
 .  S X=$$BTE^HLCSMON("No data found.  Press RETURN to continue...  ",1)
"RTN","HLUCM090",172,0)
 S X=$$BTE^HLCSMON("About to print ^TMP("""_$G(SUB)_""",$J) data report.  Press RETURN...",1)
"RTN","HLUCM090",173,0)
 W !!," Total   Total   Total  Main"
"RTN","HLUCM090",174,0)
 W !,"#Chars   #Msgs    #Sec  Sort Sub1 Sub2 Sub3"
"RTN","HLUCM090",175,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM090",176,0)
 S L1=""
"RTN","HLUCM090",177,0)
 F  S L1=$O(@GBL@(L1)) Q:L1']""  D
"RTN","HLUCM090",178,0)
 .  S (TOT1,TOT2,TOT3)=0
"RTN","HLUCM090",179,0)
 .  S L2=""
"RTN","HLUCM090",180,0)
 .  F  S L2=$O(@GBL@(L1,L2)) Q:L2']""  D
"RTN","HLUCM090",181,0)
 .  .  S L3=""
"RTN","HLUCM090",182,0)
 .  .  F  S L3=$O(@GBL@(L1,L2,L3)) Q:L3']""  D
"RTN","HLUCM090",183,0)
 .  .  .  S L4=""
"RTN","HLUCM090",184,0)
 .  .  .  F  S L4=$O(@GBL@(L1,L2,L3,L4)) Q:L4']""  D
"RTN","HLUCM090",185,0)
 .  .  .  .  S TOT=$G(@GBL@(L1,L2,L3,L4))
"RTN","HLUCM090",186,0)
 .  .  .  .  W !,$J(+TOT,6),?8,$J($P(TOT,U,2),6),?16,$J($P(TOT,U,3),6)
"RTN","HLUCM090",187,0)
 .  .  .  .  W ?24,L1,?29,L2,?34,L3,?39,$S($L(L4)<42:L4,1:$E(L4,1,40)_"~")
"RTN","HLUCM090",188,0)
 .  .  .  .  I L1="NMSP",L2'="IO" QUIT  ;->
"RTN","HLUCM090",189,0)
 .  .  .  .  S TOT1=TOT1+$P(TOT,U),TOT2=TOT2+$P(TOT,U,2),TOT3=TOT3+$P(TOT,U,3)
"RTN","HLUCM090",190,0)
 .  .  .  I L1="NMSP" S X=$O(@GBL@(L1,L2,L3)) I X]"",L3'=X W:WAY=1 !
"RTN","HLUCM090",191,0)
 .  .  I L1="NMSP" S X=$O(@GBL@(L1,L2)) I X]"",L2'=X W:WAY=1 !
"RTN","HLUCM090",192,0)
 .  I WAY=1 W !,$$REPEAT^XLFSTR("-",IOM),!,$J(TOT1,6),?8,$J(TOT2,6),?16,$J(TOT3,6),!
"RTN","HLUCM090",193,0)
 Q
"RTN","HLUCM090",194,0)
 ;
"RTN","HLUCM090",195,0)
FACDNS(FAC) ; Return STA#~STA-NAME~DNS if remote...
"RTN","HLUCM090",196,0)
 N FACNM,LOCAL
"RTN","HLUCM090",197,0)
 ;
"RTN","HLUCM090",198,0)
 ; Is FAC a local station number?
"RTN","HLUCM090",199,0)
 S LOCAL=$P($$SITE^VASITE,U,3)_"~"_$P($$SITE^VASITE,U,2)_"~LOCAL"
"RTN","HLUCM090",200,0)
 I +FAC=+LOCAL QUIT LOCAL ;->
"RTN","HLUCM090",201,0)
 ;
"RTN","HLUCM090",202,0)
 ; FAC not a station number, or not local...
"RTN","HLUCM090",203,0)
 S FACNM=$$FACFROM(FAC)
"RTN","HLUCM090",204,0)
 ;
"RTN","HLUCM090",205,0)
 I +FACNM'>0 QUIT LOCAL ;-> No site number found...
"RTN","HLUCM090",206,0)
 I +FACNM=+LOCAL QUIT LOCAL ;-> Local site number...
"RTN","HLUCM090",207,0)
 ;
"RTN","HLUCM090",208,0)
 QUIT:FACNM]"" FACNM ;->
"RTN","HLUCM090",209,0)
 ;
"RTN","HLUCM090",210,0)
 Q LOCAL
"RTN","HLUCM090",211,0)
 ;
"RTN","HLUCM090",212,0)
FACFROM(FAC) ; Find STA#~STA-NAME~DNS if remote...
"RTN","HLUCM090",213,0)
 N D,DIC,FACNM,STANO,X,Y
"RTN","HLUCM090",214,0)
 ;
"RTN","HLUCM090",215,0)
 QUIT:$G(FAC)']"" "" ;-> If no station number...
"RTN","HLUCM090",216,0)
 ;
"RTN","HLUCM090",217,0)
 ; Initial build of facility conversions...
"RTN","HLUCM090",218,0)
 D:'$D(^TMP($J,"HL4")) BLDHL4
"RTN","HLUCM090",219,0)
 ;
"RTN","HLUCM090",220,0)
 ; If facility is in facility conversion in ^TMP($J,"HL4")...
"RTN","HLUCM090",221,0)
 S FACNM=$G(^TMP($J,"HL4",FAC)) QUIT:FACNM]"" FACNM ;->
"RTN","HLUCM090",222,0)
 ;
"RTN","HLUCM090",223,0)
 ; Try to look up.  (See Integration Agreement# 10090)
"RTN","HLUCM090",224,0)
 ;
"RTN","HLUCM090",225,0)
 ; Pure station number lookup if leading 3 station number digits...
"RTN","HLUCM090",226,0)
 ; Otherwise, use the FACility name...
"RTN","HLUCM090",227,0)
 S DIC="^DIC(4,",DIC(0)="FMO",D="B^D",X=$S(+FAC?3N:+FAC,1:FAC)
"RTN","HLUCM090",228,0)
 D MIX^DIC1
"RTN","HLUCM090",229,0)
 ;
"RTN","HLUCM090",230,0)
 D FACVAR
"RTN","HLUCM090",231,0)
 ;
"RTN","HLUCM090",232,0)
 ; Success...
"RTN","HLUCM090",233,0)
 I FACNM]"" D  QUIT FACNM ;->
"RTN","HLUCM090",234,0)
 .  S FACNM=STANO_"~"_FACNM_"~DNS"
"RTN","HLUCM090",235,0)
 .  S ^TMP($J,"HL4",FAC)=FACNM
"RTN","HLUCM090",236,0)
 ;
"RTN","HLUCM090",237,0)
 ; Failed lookup...
"RTN","HLUCM090",238,0)
 I FACNM']"",+FAC'?3N QUIT "" ;-> Lookup on alpha facility name
"RTN","HLUCM090",239,0)
 I FACNM']"",+FAC=FAC QUIT "" ;-> Lookup on pure 3 digit station #
"RTN","HLUCM090",240,0)
 ;
"RTN","HLUCM090",241,0)
 ; Failed on lookup on ###, so try ###A...
"RTN","HLUCM090",242,0)
 KILL D,DIC,X,Y
"RTN","HLUCM090",243,0)
 S DIC="^DIC(4,",DIC(0)="FMO",D="B^D",X=FAC
"RTN","HLUCM090",244,0)
 ;
"RTN","HLUCM090",245,0)
 D FACVAR
"RTN","HLUCM090",246,0)
 ;
"RTN","HLUCM090",247,0)
 ; Success...
"RTN","HLUCM090",248,0)
 I FACNM]"" D  QUIT FACNM ;->
"RTN","HLUCM090",249,0)
 .  S FACNM=STANO_"~"_FACNM_"~DNS"
"RTN","HLUCM090",250,0)
 .  S ^TMP($J,"HL4",FAC)=FACNM
"RTN","HLUCM090",251,0)
 ;
"RTN","HLUCM090",252,0)
 Q ""
"RTN","HLUCM090",253,0)
 ;
"RTN","HLUCM090",254,0)
FACVAR ; Set up variables...
"RTN","HLUCM090",255,0)
 N DIC,X
"RTN","HLUCM090",256,0)
 S FACNO=+$G(Y),FACNM=$P($G(Y),U,2),STANO="" ; HL*1.6*114
"RTN","HLUCM090",257,0)
 QUIT:FACNO'>0  ;->
"RTN","HLUCM090",258,0)
 S DIC=4,DR="99",DA=+FACNO,DIQ="DATA(",DIQ(0)="E"
"RTN","HLUCM090",259,0)
 D EN^DIQ1
"RTN","HLUCM090",260,0)
 S STANO=$G(DATA(4,+FACNO,99,"E"))
"RTN","HLUCM090",261,0)
 Q
"RTN","HLUCM090",262,0)
 ;
"RTN","HLUCM090",263,0)
BLDHL4 ; Build facility conversions...
"RTN","HLUCM090",264,0)
 N I,T F I=2:1 S T=$T(BLDHL4+I) Q:T'[";;"  S T=$P(T,";;",2,99),^TMP($J,"HL4",$P(T,U))=$P(T,U,2)
"RTN","HLUCM090",265,0)
 ;;200M^200M~MPI~DNS
"RTN","HLUCM090",266,0)
 ;;AUSTIN^200~AUSTIN~DNS
"RTN","HLUCM090",267,0)
 Q
"RTN","HLUCM090",268,0)
 ;
"RTN","HLUCM090",269,0)
EOR ;HLUCM090 - Facility Finder Software ;2/20/2003 - 12:35
"VER")
8.0^22.0
**END**
**END**
