Released ECX*3*11 SEQ #11
Extracted from mail message
**KIDS**:ECX*3.0*11^

**INSTALL NAME**
ECX*3.0*11
"BLD",1492,0)
ECX*3.0*11^DSS EXTRACTS^0^2981009^y
"BLD",1492,1,0)
^^1^1^2981009^^^
"BLD",1492,1,1,0)
See the Patch description for ECX*3*11 in the Patch Module.
"BLD",1492,4,0)
^9.64PA^^
"BLD",1492,"ABPKG")
n
"BLD",1492,"KRN",0)
^9.67PA^19^18
"BLD",1492,"KRN",.4,0)
.4
"BLD",1492,"KRN",.401,0)
.401
"BLD",1492,"KRN",.402,0)
.402
"BLD",1492,"KRN",.403,0)
.403
"BLD",1492,"KRN",.5,0)
.5
"BLD",1492,"KRN",.84,0)
.84
"BLD",1492,"KRN",3.6,0)
3.6
"BLD",1492,"KRN",3.8,0)
3.8
"BLD",1492,"KRN",9.2,0)
9.2
"BLD",1492,"KRN",9.8,0)
9.8
"BLD",1492,"KRN",9.8,"NM",0)
^9.68A^19^19
"BLD",1492,"KRN",9.8,"NM",1,0)
ECXADM^^0^B12785242
"BLD",1492,"KRN",9.8,"NM",2,0)
ECXDENT^^0^B6864302
"BLD",1492,"KRN",9.8,"NM",3,0)
ECXEC^^0^B17943243
"BLD",1492,"KRN",9.8,"NM",4,0)
ECXLABN^^0^B18368148
"BLD",1492,"KRN",9.8,"NM",5,0)
ECXLABO^^0^B11778157
"BLD",1492,"KRN",9.8,"NM",6,0)
ECXOPRX^^0^B21310977
"BLD",1492,"KRN",9.8,"NM",7,0)
ECXPIVD^^0^B16993297
"BLD",1492,"KRN",9.8,"NM",8,0)
ECXPIVDN^^0^B22589671
"BLD",1492,"KRN",9.8,"NM",9,0)
ECXPRO1^^0^B31322317
"BLD",1492,"KRN",9.8,"NM",10,0)
ECXQSR^^0^B16625153
"BLD",1492,"KRN",9.8,"NM",11,0)
ECXRAD^^0^B13993874
"BLD",1492,"KRN",9.8,"NM",12,0)
ECXSCNS^^0^B8571243
"BLD",1492,"KRN",9.8,"NM",13,0)
ECXSCX^^0^B55682077
"BLD",1492,"KRN",9.8,"NM",14,0)
ECXSETUP^^0^B28030155
"BLD",1492,"KRN",9.8,"NM",15,0)
ECXSURG^^0^B20313637
"BLD",1492,"KRN",9.8,"NM",16,0)
ECXUTL3^^0^B1803795
"BLD",1492,"KRN",9.8,"NM",17,0)
ECXNDC^^0^B15388802
"BLD",1492,"KRN",9.8,"NM",18,0)
ECXFEKE1^^0^B34081524
"BLD",1492,"KRN",9.8,"NM",19,0)
ECXFEKEY^^0^B63843898
"BLD",1492,"KRN",9.8,"NM","B","ECXADM",1)

"BLD",1492,"KRN",9.8,"NM","B","ECXDENT",2)

"BLD",1492,"KRN",9.8,"NM","B","ECXEC",3)

"BLD",1492,"KRN",9.8,"NM","B","ECXFEKE1",18)

"BLD",1492,"KRN",9.8,"NM","B","ECXFEKEY",19)

"BLD",1492,"KRN",9.8,"NM","B","ECXLABN",4)

"BLD",1492,"KRN",9.8,"NM","B","ECXLABO",5)

"BLD",1492,"KRN",9.8,"NM","B","ECXNDC",17)

"BLD",1492,"KRN",9.8,"NM","B","ECXOPRX",6)

"BLD",1492,"KRN",9.8,"NM","B","ECXPIVD",7)

"BLD",1492,"KRN",9.8,"NM","B","ECXPIVDN",8)

"BLD",1492,"KRN",9.8,"NM","B","ECXPRO1",9)

"BLD",1492,"KRN",9.8,"NM","B","ECXQSR",10)

"BLD",1492,"KRN",9.8,"NM","B","ECXRAD",11)

"BLD",1492,"KRN",9.8,"NM","B","ECXSCNS",12)

"BLD",1492,"KRN",9.8,"NM","B","ECXSCX",13)

"BLD",1492,"KRN",9.8,"NM","B","ECXSETUP",14)

"BLD",1492,"KRN",9.8,"NM","B","ECXSURG",15)

"BLD",1492,"KRN",9.8,"NM","B","ECXUTL3",16)

"BLD",1492,"KRN",19,0)
19
"BLD",1492,"KRN",19,"NM",0)
^9.68A^^
"BLD",1492,"KRN",19.1,0)
19.1
"BLD",1492,"KRN",101,0)
101
"BLD",1492,"KRN",409.61,0)
409.61
"BLD",1492,"KRN",771,0)
771
"BLD",1492,"KRN",869.2,0)
869.2
"BLD",1492,"KRN",870,0)
870
"BLD",1492,"KRN",8994,0)
8994
"BLD",1492,"KRN","B",.4,.4)

"BLD",1492,"KRN","B",.401,.401)

"BLD",1492,"KRN","B",.402,.402)

"BLD",1492,"KRN","B",.403,.403)

"BLD",1492,"KRN","B",.5,.5)

"BLD",1492,"KRN","B",.84,.84)

"BLD",1492,"KRN","B",3.6,3.6)

"BLD",1492,"KRN","B",3.8,3.8)

"BLD",1492,"KRN","B",9.2,9.2)

"BLD",1492,"KRN","B",9.8,9.8)

"BLD",1492,"KRN","B",19,19)

"BLD",1492,"KRN","B",19.1,19.1)

"BLD",1492,"KRN","B",101,101)

"BLD",1492,"KRN","B",409.61,409.61)

"BLD",1492,"KRN","B",771,771)

"BLD",1492,"KRN","B",869.2,869.2)

"BLD",1492,"KRN","B",870,870)

"BLD",1492,"KRN","B",8994,8994)

"BLD",1492,"QUES",0)
^9.62^^
"BLD",1492,"REQB",0)
^9.611^4^4
"BLD",1492,"REQB",1,0)
ECX*3.0*3^2
"BLD",1492,"REQB",2,0)
ECX*3.0*4^2
"BLD",1492,"REQB",3,0)
ECX*3.0*9^2
"BLD",1492,"REQB",4,0)
ECX*3.0*10^2
"BLD",1492,"REQB","B","ECX*3.0*10",4)

"BLD",1492,"REQB","B","ECX*3.0*3",1)

"BLD",1492,"REQB","B","ECX*3.0*4",2)

"BLD",1492,"REQB","B","ECX*3.0*9",3)

"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^2971222^2980112^11714
"PKG",513,22,1,"PAH",1,0)
11^2981009^11714
"PKG",513,22,1,"PAH",1,1,0)
^^1^1^2981013
"PKG",513,22,1,"PAH",1,1,1,0)
See the Patch description for ECX*3*11 in the Patch Module.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
19
"RTN","ECXADM")
0^1^B12785242
"RTN","ECXADM",1,0)
ECXADM ;BIR/DMA,CML,PTD-Admissions Extract ; [ 11/25/96  11:21 AM ]
"RTN","ECXADM",2,0)
 ;;3.0;DSS EXTRACTS;**1,4,11**;Dec 22, 1997
"RTN","ECXADM",3,0)
BEG ;entry point from option
"RTN","ECXADM",4,0)
 D SETUP,^ECXTRAC,^ECXKILL Q
"RTN","ECXADM",5,0)
 ;
"RTN","ECXADM",6,0)
START ; start package specific extract
"RTN","ECXADM",7,0)
 S QFLG=0
"RTN","ECXADM",8,0)
 K ECXDD D FIELD^DID(405,.19,,"SPECIFIER","ECXDD") S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXADM",9,0)
 S ECED=ECED+.3
"RTN","ECXADM",10,0)
 S ECD=ECSD1 F  S ECD=$O(^DGPM("ATT1",ECD)),ECDA=0 Q:'ECD  Q:ECD>ECED  F  S ECDA=$O(^DGPM("ATT1",ECD,ECDA)) Q:'ECDA  I $D(^DGPM(ECDA,0)) S EC=^(0),DFN=$P(EC,"^",3) I $D(^DPT(DFN,0)) S D0=^(0) D GET Q:QFLG
"RTN","ECXADM",11,0)
 Q
"RTN","ECXADM",12,0)
 ;
"RTN","ECXADM",13,0)
GET ;
"RTN","ECXADM",14,0)
 S ECTM=$$ECXTIME^ECXUTL(ECD)
"RTN","ECXADM",15,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXADM",16,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXADM",17,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECD)
"RTN","ECXADM",18,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXADM",19,0)
 S ECODE=DFN_"^"_$P(D0,"^",9)_"^"_$E($P($P(D0,"^"),",")_"    ",1,4)_"^3^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECPTTM_"^"_$P(D0,"^",2)_"^"_$$ECXDOB^ECXUTL($P(D0,"^",3))_"^"_$P(D0,"^",8)_"^"_$P($G(^DPT(DFN,.311)),"^",15)_"^"_+$$INSURED^IBCNS1(DFN,ECD)
"RTN","ECXADM",20,0)
 S D1=$G(^DPT(DFN,.11)),ECSTA=$P(D1,"^",5),STATE=$S(ECSTA:$P(^DIC(5,ECSTA,0),"^",3),1:"")
"RTN","ECXADM",21,0)
 S ECCTY=$P(D1,"^",7),COUNTY=$S(ECCTY:$P(^DIC(5,ECSTA,1,ECCTY,0),"^",3),1:"")
"RTN","ECXADM",22,0)
 S ECODE=ECODE_"^"_STATE_"^"_COUNTY_"^"_$P(D1,"^",6),D1=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),"^",9) I D1 S D1=$C(D1+64)
"RTN","ECXADM",23,0)
 S ECM=$P($G(^DG(408.32,+$P(D0,"^",14),0)),"^",2)
"RTN","ECXADM",24,0)
 S ECODE=ECODE_"^"_D1_"^"_$P($G(^DPT(DFN,"VET")),"^")_"^"_$P($G(^DPT(DFN,.321))_"^^^^","^",1,3)_"^"_$P($G(^DPT(DFN,.52)),"^",5)_"^"_$P($G(^DIC(21,+$P($G(^DPT(DFN,.32)),"^",3),0)),"^",3)_"^"_ECM_"^"_$P(D0,"^",5)
"RTN","ECXADM",25,0)
 S W=$P(EC,"^",6),FAC=$P($G(^DIC(42,+W,0)),"^",11),W=$P($G(^DIC(42,+W,44)),"^")
"RTN","ECXADM",26,0)
 S ECTS="" F J=1:1:100 S ECT1=$G(^DGPM(ECDA+J,0)) I $P(ECT1,"^",14)=ECDA,$P(ECT1,"^",2)=6 S ECTS=ECT1 Q
"RTN","ECXADM",27,0)
 ;get corresponding Treating specialty - should be the next one, but must be close
"RTN","ECXADM",28,0)
 ;it's possible that variable ects is still null at this point
"RTN","ECXADM",29,0)
 S ECODE=FAC_"^"_ECODE_"^"_W_"^"_$P($G(^DIC(45.7,+$P(ECTS,"^",9),0)),"^",2)_"^"_ECPRO_$P(ECTS,"^",19)_"^"_ECDA
"RTN","ECXADM",30,0)
 S (ECDRG,ECDIA)="",ECPTF=+$P(EC,"^",16) I ECPTF,$D(^DGPT(ECPTF,"M")) D PTF S ECODE=ECODE_"^"_ECDRG_"^"_ECDIA
"RTN","ECXADM",31,0)
 S ECXPRV="",ECXPRV=$P(ECTS,"^",8) S:ECXPRV]"" ECXPRV=ECPRO_ECXPRV
"RTN","ECXADM",32,0)
 S $P(ECODE,"^",31)=ECTM,$P(ECODE,"^",32)=ECPTPR,$P(ECODE,"^",33)=$P($G(^DIC(10,+$P(D0,"^",6),0)),"^",2)_"^"_ECXPRV_"^"
"RTN","ECXADM",33,0)
 ;facility^dfn^ssn^name^in/out^day^primary care team^sex^dob^religion^employment status^health ins^state^county^zip^eligibility^
"RTN","ECXADM",34,0)
 ;vet^vietnam^agent orange^radiation^pow^period of service^means test^marital status^ward^treating specialty^
"RTN","ECXADM",35,0)
 ;attending physician^mov #^DRG^diagnosis^time^primary care provider^race^primary ward provider
"RTN","ECXADM",36,0)
FILE S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXADM",37,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXADM",38,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXADM",39,0)
 Q
"RTN","ECXADM",40,0)
 ;
"RTN","ECXADM",41,0)
PTF ; get admitting DRG and diagnosis from PTF
"RTN","ECXADM",42,0)
 ;use number for DRG and .01 for diagnosis
"RTN","ECXADM",43,0)
 S EC=1 I $D(^DGPT(ECPTF,"M",2,0)) S EC=2
"RTN","ECXADM",44,0)
 S EC1=+$P(^DGPT(ECPTF,"M",EC,0),"^",5),ECDRG=$P($G(^DGPT(ECPTF,"M",EC,"P")),"^")
"RTN","ECXADM",45,0)
 S ECDIA=$P($G(^ICD9(EC1,0)),"^") Q
"RTN","ECXADM",46,0)
 ;
"RTN","ECXADM",47,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXADM",48,0)
 S ECPACK="Admission",ECPIECE=13,ECRTN="START^ECXADM",ECGRP="ADMS",ECHEAD="ADM",ECFILE=727.802,ECVER=7
"RTN","ECXADM",49,0)
 Q
"RTN","ECXADM",50,0)
 ;
"RTN","ECXADM",51,0)
LOCAL ; to extract nightly for local use not to be transmitted to TSI
"RTN","ECXADM",52,0)
 ; should be queued with a 1D frequency
"RTN","ECXADM",53,0)
 D SETUP,^ECXTLOCL,^ECXKILL Q
"RTN","ECXADM",54,0)
 ;
"RTN","ECXADM",55,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXADM",56,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXADM",57,0)
 ;
"RTN","ECXDENT")
0^2^B6864302
"RTN","ECXDENT",1,0)
ECXDENT ;BIR/DMA,PTD-Dental Extract for DSS ; [ 11/22/96  5:23 PM ]
"RTN","ECXDENT",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXDENT",3,0)
BEG ;entry point from option
"RTN","ECXDENT",4,0)
 D SETUP,^ECXTRAC,^ECXKILL Q
"RTN","ECXDENT",5,0)
 ;
"RTN","ECXDENT",6,0)
START ;start package specific extract
"RTN","ECXDENT",7,0)
 S QFLG=0
"RTN","ECXDENT",8,0)
 K ECXDD D FIELD^DID(220.5,.01,,"SPECIFIER","ECXDD") S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXDENT",9,0)
 S ECED=ECED+.3
"RTN","ECXDENT",10,0)
 S ECD=ECSD1 F  S ECD=$O(^DENT(221,"B",ECD)),J=0 Q:'ECD  Q:ECD>ECED  F  S J=$O(^DENT(221,"B",ECD,J)) Q:'J  I $D(^DENT(221,J,0)) S DATA=^(0),$P(DATA,"^",50)="" D STUFF Q:QFLG
"RTN","ECXDENT",11,0)
 Q
"RTN","ECXDENT",12,0)
 ;
"RTN","ECXDENT",13,0)
STUFF S DFN=+$P(DATA,"^",4) Q:'$D(^DPT(DFN,0))  S ECP=^(0),SSN=$P(ECP,"^",9),ECNA=$E($P($P(ECP,"^"),",")_"    ",1,4) D INP
"RTN","ECXDENT",14,0)
 S ECDEN=$P(DATA,"^",3),ECDEN=$P($G(^DENT(220.5,ECDEN,0)),"^")
"RTN","ECXDENT",15,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXDENT",16,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXDENT",17,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECD)
"RTN","ECXDENT",18,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXDENT",19,0)
 S ECODE=$P(DATA,"^",40)_"^"_DFN_"^"_SSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL($P(DATA,"^"),ECXYM)_"^"_ECPRO_ECDEN_"^"_$P(DATA,"^",7,9)_"^"_$P(DATA,"^",11,20)_"^"_$P(DATA,"^",22,38)_"^"_$P(DATA,"^",40,45)_"^"_ECMN_"^"_ECTS
"RTN","ECXDENT",20,0)
 S ECODE=ECODE_"^"_ECPTTM_"^"_ECPTPR_"^"_$$ECXTIME^ECXUTL($P(DATA,"^"))_"^"
"RTN","ECXDENT",21,0)
 ;inst^dfn^ssn^name^in/out^day^provider^screen/complete^admin proc^x-rays ex^x-rays int^prophy natural^prophy denture^op room^neoplasm malig^
"RTN","ECXDENT",22,0)
 ;neoplasm removed^biopsy/smear^fracture^pat category^other sig surg^surface restored^root canal^periodontal quads (surg)^perio quads (root plane)^
"RTN","ECXDENT",23,0)
 ;patient ed^spot check exam^indiv crowns^posts & cores^fixed partials (abut)^fixed partials (pont)^removable partials^complete dentures^prosthetic repair^
"RTN","ECXDENT",24,0)
 ;splints & spec procs^extractions^surg extractions^other sig treatment^div^completion/termination^interdisc consult^evaluation^pre-auth 2nd opinion^
"RTN","ECXDENT",25,0)
 ;spot check discrepancy^mov #^treat spec^primary care team^primary care provider^time
"RTN","ECXDENT",26,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXDENT",27,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXDENT",28,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXDENT",29,0)
 Q
"RTN","ECXDENT",30,0)
 ;
"RTN","ECXDENT",31,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXDENT",32,0)
 S ECPACK="Dental",ECPIECE=9,ECRTN="START^ECXDENT",ECGRP="DENT",ECHEAD="DEN",ECFILE=727.806,ECVER=7
"RTN","ECXDENT",33,0)
 Q
"RTN","ECXDENT",34,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXDENT",35,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXDENT",36,0)
 K VAIP,VAERR
"RTN","ECXDENT",37,0)
 Q
"RTN","ECXDENT",38,0)
 ;
"RTN","ECXDENT",39,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXDENT",40,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXEC")
0^3^B17943243
"RTN","ECXEC",1,0)
ECXEC ;BIR/JLP,PTD-DSS Event Capture Extract  [ 02/14/97   2:26 PM ]
"RTN","ECXEC",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXEC",3,0)
BEG ;entry point from option
"RTN","ECXEC",4,0)
 I '$D(^ECH) W !,"Event Capture is not initialized",!! Q
"RTN","ECXEC",5,0)
 D SETUP,^ECXTRAC
"RTN","ECXEC",6,0)
 D ^ECXKILL K ECVER
"RTN","ECXEC",7,0)
 Q
"RTN","ECXEC",8,0)
START ;begin EC extract
"RTN","ECXEC",9,0)
 S QFLG=0
"RTN","ECXEC",10,0)
 S ECED=ECED+.3
"RTN","ECXEC",11,0)
 K ^TMP("EC",$J)
"RTN","ECXEC",12,0)
 S ECLL=0 F  S ECLL=$O(^ECH("AC1",ECLL)),ECD=ECSD-.1 Q:'ECLL  F  S ECD=$O(^ECH("AC1",ECLL,ECD)),ECDA=0 Q:(ECD>ECED)!('ECD)  F  S ECDA=$O(^ECH("AC1",ECLL,ECD,ECDA)) Q:'ECDA  D UPDATE Q:QFLG
"RTN","ECXEC",13,0)
 Q
"RTN","ECXEC",14,0)
UPDATE ;sets record and updates counters
"RTN","ECXEC",15,0)
 ;ecode=inst^dfn^ssn^name^i/o status^day^DSS unit^category^procedure^volume^cost center^ordering sec^section^
"RTN","ECXEC",16,0)
 ;provider^^prov 2^^prov 3^^^mov #^treat spec^time^primary care team^primary care provider^pce cpt code^
"RTN","ECXEC",17,0)
 ;icd-9 code^agent orange^radiation exposure^environmental contaminants^service connected^sent to pce^^dss identifier^dcm dept.
"RTN","ECXEC",18,0)
 ;
"RTN","ECXEC",19,0)
 S ECCH=^ECH(ECDA,0),ECL=$P(ECCH,"^",4),ECDFN=$P(ECCH,"^",2),ECDT=$P(ECCH,"^",3),ECM=$P(ECCH,"^",6),ECC=$P(ECCH,"^",8),ECTM=$$ECXTIME^ECXUTL(ECDT)
"RTN","ECXEC",20,0)
 Q:'$D(^DPT(ECDFN,0))  S SSN=$P(^(0),"^",9),ECNA=$E($P($P(^(0),"^"),",")_"    ",1,4)
"RTN","ECXEC",21,0)
 D INP
"RTN","ECXEC",22,0)
 S ECP=$P(ECCH,"^",9)
"RTN","ECXEC",23,0)
 Q:ECP']""
"RTN","ECXEC",24,0)
 S ECO=$P(ECCH,"^",12),ECV=$P(ECCH,"^",10),ECDU=$P(ECCH,"^",7)
"RTN","ECXEC",25,0)
 S ECXUNIT=$G(^ECD(ECDU,0)),ECCS=+$P(ECXUNIT,"^",4),ECDCM=$P(ECXUNIT,"^",5),ECUSTOP=$P(ECXUNIT,"^",10),ECUPCE=$P(ECXUNIT,"^",14)
"RTN","ECXEC",26,0)
 ;derivation of dss identifier depends on whether dss unit is set to send data to pce
"RTN","ECXEC",27,0)
 S ECAC=$P($G(ECCH),"^",19)
"RTN","ECXEC",28,0)
 ;if this is a record that 'goes to pce', then get the dss identifier from the clinic stop codes
"RTN","ECXEC",29,0)
 S (ECAC1S,ECAC2S)="000"
"RTN","ECXEC",30,0)
 I ECUPCE="A"!(ECUPCE="O"&(ECA=1)) D
"RTN","ECXEC",31,0)
 .I +ECAC D
"RTN","ECXEC",32,0)
 ..S ECAC1=$P($G(^SC(+ECAC,0)),"^",7),ECAC2=$P($G(^(0)),"^",18)
"RTN","ECXEC",33,0)
 ..I 'ECAC2 S ECAC2S="000"
"RTN","ECXEC",34,0)
 ..I 'ECAC1 S (ECAC1S,ECAC2S)="000" Q
"RTN","ECXEC",35,0)
 ..S ECAC1S=$P($G(^DIC(40.7,+ECAC1,0)),"^",2),ECAC2S=$P($G(^DIC(40.7,+ECAC2,0)),"^",2)
"RTN","ECXEC",36,0)
 ..S ECAC1S=$$RJ^XLFSTR(ECAC1S,3,0),ECAC2S=$$RJ^XLFSTR(ECAC2S,3,0)
"RTN","ECXEC",37,0)
 .I 'ECAC D
"RTN","ECXEC",38,0)
 ..S (ECAC1S,ECAC2S)="000"
"RTN","ECXEC",39,0)
 ;if this record doesn't go to pce, then get the dss idetifier from the dss unit
"RTN","ECXEC",40,0)
 I ECUPCE=""!(ECUPCE="N")!(ECUPCE="O"&(ECA=3)) D
"RTN","ECXEC",41,0)
 .I +ECUSTOP D
"RTN","ECXEC",42,0)
 ..S ECAC1S=$P($G(^DIC(40.7,+ECUSTOP,0)),"^",2),ECAC1S=$$RJ^XLFSTR(ECAC1S,3,0)
"RTN","ECXEC",43,0)
 ..S ECAC2S="000"
"RTN","ECXEC",44,0)
 .I 'ECUSTOP D
"RTN","ECXEC",45,0)
 ..S (ECAC1S,ECAC2S)="000"
"RTN","ECXEC",46,0)
 S ECDSS=ECAC1S_ECAC2S
"RTN","ECXEC",47,0)
 ;setup provider(s) as'2'_ien; iens are now only in file #200; keeping obsolete reference
"RTN","ECXEC",48,0)
 ;to file #3.1 for backward compatibility; will be revised in future
"RTN","ECXEC",49,0)
 S ECU=$P(ECCH,"^",11),ECUN1=$S(ECU["DIC(3.1":3_$P(ECU,";"),1:2_$P(ECU,";"))
"RTN","ECXEC",50,0)
 S ECU2=$P(ECCH,"^",15),ECU2A=$S('ECU2:"",ECU2["DIC(3.1":3_$P(ECU2,";"),1:2_$P(ECU2,";"))
"RTN","ECXEC",51,0)
 S ECU3=$P(ECCH,"^",17),ECU3A=$S('ECU3:"",ECU3["DIC(3.1":3_$P(ECU3,";"),1:2_$P(ECU3,";"))
"RTN","ECXEC",52,0)
 ;change for version 2 where ECP is a variable pointer and we want to expand it
"RTN","ECXEC",53,0)
 ;category = category or null if stored as 0
"RTN","ECXEC",54,0)
 I ECP[";" S ECP=$S(ECP["ICPT":$P(^ICPT(+ECP,0),"^"),ECP<90000:$P(^EC(725,+ECP,0),"^",2)_"N",1:$P(^EC(725,+ECP,0),"^",2)_"L"),ECC=$S(ECC:ECC,1:"")
"RTN","ECXEC",55,0)
 ;pick up EC to PCE data from "P" in File 721
"RTN","ECXEC",56,0)
 S ECPCE=$G(^ECH(ECDA,"P"))
"RTN","ECXEC",57,0)
 S ECPCE1=$P(ECPCE,"^"),ECPCE1=$P($G(^ICPT(+ECPCE1,0)),"^"),ECPCE2=$P(ECPCE,"^",2),ECPCE3=$P(ECPCE,"^",3),ECPCE4=$P(ECPCE,"^",4),ECPCE5=$P(ECPCE,"^",5),ECPCE6=$P(ECPCE,"^",6)
"RTN","ECXEC",58,0)
 S ECPCE7=$S($P(ECPCE,"^",7)="Y":"Y",1:"N")
"RTN","ECXEC",59,0)
 S ECPCE=ECPCE1_"^"_ECPCE2_"^"_ECPCE3_"^"_ECPCE4_"^"_ECPCE5_"^"_ECPCE6_"^"_ECPCE7
"RTN","ECXEC",60,0)
 ;setup the variable to be filed in #727.815
"RTN","ECXEC",61,0)
 S ECODE=ECL_"^"_ECDFN_"^"_SSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECDT,ECXYM)_"^"_ECDU_"^"_ECC_"^"_ECP_"^"_ECV_"^"_ECCS_"^"_ECO_"^"_ECM_"^"_ECUN1
"RTN","ECXEC",62,0)
 S ECODE=ECODE_"^^"_ECU2A_"^^"_ECU3A_"^^^"_ECMN_"^"_ECTS_"^"_ECTM_"^"_ECPTTM_"^"_ECPTPR_"^"_ECPCE_"^^"_ECDSS_"^"_ECDCM_"^"
"RTN","ECXEC",63,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXEC",64,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXEC",65,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXEC",66,0)
 Q
"RTN","ECXEC",67,0)
SETUP ; setup for ECXTRAC
"RTN","ECXEC",68,0)
 K ECVER S ECPACK="Event Capture",ECPIECE=3,ECRTN="START^ECXEC",ECGRP="EC",ECHEAD="ECS",ECFILE=727.815,ECVER=3 I $D(^DD(720.3)) S ECVER=7
"RTN","ECXEC",69,0)
 Q
"RTN","ECXEC",70,0)
INP ;Determine in/outpatient status, primary care team and provider.
"RTN","ECXEC",71,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECDT,DFN=ECDFN D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXEC",72,0)
 K VAIP,VAERR
"RTN","ECXEC",73,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(ECDFN,ECDT)
"RTN","ECXEC",74,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXEC",75,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(ECDFN,ECDT)
"RTN","ECXEC",76,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXEC",77,0)
 Q
"RTN","ECXEC",78,0)
 ;
"RTN","ECXEC",79,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXEC",80,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXFEKE1")
0^18^B34081524
"RTN","ECXFEKE1",1,0)
ECXFEKE1 ;BIR/DMA,CML-Print Feeder Keys (CONTINUED); [ 03/28/96  5:44 PM ]
"RTN","ECXFEKE1",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXFEKE1",3,0)
 ;
"RTN","ECXFEKE1",4,0)
SELLABKE() ;** Function to prompt user selection of type of Lab Feeder Key
"RTN","ECXFEKE1",5,0)
 ;
"RTN","ECXFEKE1",6,0)
 ;** Variable Definitions
"RTN","ECXFEKE1",7,0)
 ;**  ECXKEY    - Value of user selection returned to calling code
"RTN","ECXFEKE1",8,0)
 ;**                Returns  N - LMIP Code formated feeder keys
"RTN","ECXFEKE1",9,0)
 ;**                         O - Locally formated feeder keys
"RTN","ECXFEKE1",10,0)
 ;**                        -1 - User uparrow (^) or Time out
"RTN","ECXFEKE1",11,0)
 ;
"RTN","ECXFEKE1",12,0)
 N ECXKEY
"RTN","ECXFEKE1",13,0)
 W !!,"The Feeder Key List for the Feeder System LAB can be printed by:"
"RTN","ECXFEKE1",14,0)
 W !,?5,"(O)ld Feeder Key sort by Local Feeder Key values"
"RTN","ECXFEKE1",15,0)
 W !,?5,"(N)ew Feeder Key sort by LMIP Codes"
"RTN","ECXFEKE1",16,0)
 S DIR(0)="S^O:OLD;N:NEW"
"RTN","ECXFEKE1",17,0)
 S:$D(^ECX(728,1,"LMIP")) DIR("B")="NEW"
"RTN","ECXFEKE1",18,0)
 S:'$D(^ECX(728,1,"LMIP")) DIR("B")="OLD"
"RTN","ECXFEKE1",19,0)
 D ^DIR
"RTN","ECXFEKE1",20,0)
 S:$D(DIRUT) ECXKEY=-1
"RTN","ECXFEKE1",21,0)
 S:'$D(DIRUT) ECXKEY=Y
"RTN","ECXFEKE1",22,0)
 K Y,DIR,DIRUT,DTOUT,DUOUT
"RTN","ECXFEKE1",23,0)
 Q ECXKEY
"RTN","ECXFEKE1",24,0)
 ;
"RTN","ECXFEKE1",25,0)
SUR F EC=1:1:16 S EC1=$P($T(@("S"_EC)),";",3),EC2=$P(EC1,"^"),ECD=$P(EC1,"^",2),^TMP($J,"SUR",EC2_"-10",EC)=ECD_" PATIENT TIME",^TMP($J,"SUR",EC2_"-40",EC)=ECD_" SURGEON TIME" D
"RTN","ECXFEKE1",26,0)
 .S ^TMP($J,"SUR",EC2_"-60",EC)=ECD_" RECOVERY ROOM TIME",^TMP($J,"SUR",EC2_"-70",EC)=ECD_" TECHNICIAN TIME",^TMP($J,"SUR",EC2_"-30",EC)=ECD_" CLEANUP TIME"
"RTN","ECXFEKE1",27,0)
 .S ^TMP($J,"SUR",EC2_"-22",1)=ECD_" ANESTHESIA TIME (SPECIAL)"
"RTN","ECXFEKE1",28,0)
 .S ^TMP($J,"SUR",EC2_"-21",1)=ECD_" ANESTHESIA TIME (GENERAL)"
"RTN","ECXFEKE1",29,0)
 .S ^TMP($J,"SUR",EC2_"-23",1)=ECD_" ANESTHESIA TIME (LOCAL)"
"RTN","ECXFEKE1",30,0)
 .S ^TMP($J,"SUR",EC2_"-24",1)=ECD_" ANESTHESIA TIME (SPI/EPI)"
"RTN","ECXFEKE1",31,0)
 .S ^TMP($J,"SUR",EC2_"-25",1)=ECD_" ANESTHESIA TIME (OTHER)"
"RTN","ECXFEKE1",32,0)
 .S ^TMP($J,"SUR",EC2_"-26",1)=ECD_" ANESTHESIA TIME (UNKNOWN)"
"RTN","ECXFEKE1",33,0)
 .S ^TMP($J,"SUR",EC2_"-27",1)=ECD_" ANESTHESIA TIME (MONITORED)"
"RTN","ECXFEKE1",34,0)
 S EC=0 F  S EC=$O(^SRO(131.9,EC)) Q:'EC  I $D(^(EC,0)) S ECD=$P(^(0),"^"),^TMP($J,"SUR",$$RJ^XLFSTR(EC,5,0),EC)=ECD
"RTN","ECXFEKE1",35,0)
 Q
"RTN","ECXFEKE1",36,0)
S1 ;;050^GENERAL(OR WHEN NOT DEFINED BELOW)
"RTN","ECXFEKE1",37,0)
S2 ;;051^GYNECOLOGY
"RTN","ECXFEKE1",38,0)
S3 ;;052^NEUROSURGERY
"RTN","ECXFEKE1",39,0)
S4 ;;053^OPHTHALMOLOGY
"RTN","ECXFEKE1",40,0)
S5 ;;054^ORTHOPEDICS
"RTN","ECXFEKE1",41,0)
S6 ;;055^OTORHINOLARYNGOLOGY (ENT)
"RTN","ECXFEKE1",42,0)
S7 ;;056^PLASTIC SURGERY (INCLUDES HEAD AND NECK)
"RTN","ECXFEKE1",43,0)
S8 ;;057^PROCTOLOGY
"RTN","ECXFEKE1",44,0)
S9 ;;058^THORACIC SURGERY (INC. CARDIAC SURG.)
"RTN","ECXFEKE1",45,0)
S10 ;;059^UROLOGY
"RTN","ECXFEKE1",46,0)
S11 ;;060^ORAL SURGERY (DENTAL)
"RTN","ECXFEKE1",47,0)
S12 ;;061^PODIATRY
"RTN","ECXFEKE1",48,0)
S13 ;;062^PERIPHERAL VASCULAR
"RTN","ECXFEKE1",49,0)
S14 ;;500^CARDIAC SURGERY
"RTN","ECXFEKE1",50,0)
S15 ;;501^TRANSPLANTATION
"RTN","ECXFEKE1",51,0)
S16 ;;502^ANESTHESIOLOGY
"RTN","ECXFEKE1",52,0)
 ;
"RTN","ECXFEKE1",53,0)
DEN F EC=3:1 S EC1=$T(DEN+EC) Q:EC1'?1"D"2N.E  S ECD=$P(EC1,";",3),EC1=$P(EC1," "),^TMP($J,"DEN",EC1,EC)=ECD
"RTN","ECXFEKE1",54,0)
 Q
"RTN","ECXFEKE1",55,0)
 ;
"RTN","ECXFEKE1",56,0)
D08C ;;COMPLETE EXAM
"RTN","ECXFEKE1",57,0)
D08S ;;SCREENING EXAM
"RTN","ECXFEKE1",58,0)
D09 ;;ADMIN PROCEDURE
"RTN","ECXFEKE1",59,0)
D10 ;;X-RAYS EXTRAORAL #
"RTN","ECXFEKE1",60,0)
D11 ;;X-RAYS INTRAORAL #
"RTN","ECXFEKE1",61,0)
D12 ;;PROPHY NATURAL DENTITION
"RTN","ECXFEKE1",62,0)
D13 ;;PROPHY DENTURE
"RTN","ECXFEKE1",63,0)
D14 ;;OPERATING ROOM
"RTN","ECXFEKE1",64,0)
D15 ;;NEOPLASM CONFIRMED MALIGNANT #
"RTN","ECXFEKE1",65,0)
D16 ;;NEOPLASM REMOVED #
"RTN","ECXFEKE1",66,0)
D17 ;;BIOPSY/SMEAR #
"RTN","ECXFEKE1",67,0)
D18 ;;FRACTURE #
"RTN","ECXFEKE1",68,0)
D20 ;;OTHER SIGNIF. SURG. (CTV)
"RTN","ECXFEKE1",69,0)
D21 ;;SURFACES RESTORED #
"RTN","ECXFEKE1",70,0)
D22 ;;ROOT CANAL THERAPY #
"RTN","ECXFEKE1",71,0)
D23 ;;PERIDONTAL QUADS (SURGICAL) #
"RTN","ECXFEKE1",72,0)
D24 ;;PERIO QUADS (ROOT PLANE) #
"RTN","ECXFEKE1",73,0)
D25G ;;PATIENT ED (CTV) GROUP
"RTN","ECXFEKE1",74,0)
D25I ;;PATIENT ED (CTV) INDIVIDUAL
"RTN","ECXFEKE1",75,0)
D26S ;;SPOT CHECK EXAM (STAFF)
"RTN","ECXFEKE1",76,0)
D26F ;;SPOT CHECK EXAM (FEE)
"RTN","ECXFEKE1",77,0)
D27 ;;INDIVIDUAL CROWNS #
"RTN","ECXFEKE1",78,0)
D28 ;;POST & CORES #
"RTN","ECXFEKE1",79,0)
D29 ;;FIXED PARTIALS (ABUT) #
"RTN","ECXFEKE1",80,0)
D30 ;;FIXED PARTIALS (PONT ONLY) #
"RTN","ECXFEKE1",81,0)
D31 ;;REMOVABLE PARTIALS #
"RTN","ECXFEKE1",82,0)
D32 ;;COMPLETE DENTURES #
"RTN","ECXFEKE1",83,0)
D33 ;;PROSTHETIC REPAIR #
"RTN","ECXFEKE1",84,0)
D34 ;;SPLINT AND SPEC. PROCESS (CTV)
"RTN","ECXFEKE1",85,0)
D35 ;;EXTRACTIONS #
"RTN","ECXFEKE1",86,0)
D36 ;;SURGICAL EXTRACTIONS #
"RTN","ECXFEKE1",87,0)
D37 ;;OTHER SIG TREATMENT (CTV)
"RTN","ECXFEKE1",88,0)
D38 ;;DIVISION (STATION DIVISION)
"RTN","ECXFEKE1",89,0)
D39C ;;COMPLETIONS
"RTN","ECXFEKE1",90,0)
D39T ;;TERMINATIONS
"RTN","ECXFEKE1",91,0)
D40 ;;INTERDISCIPLINARY CONSULT
"RTN","ECXFEKE1",92,0)
D41 ;;EVALUATIONS
"RTN","ECXFEKE1",93,0)
D42 ;;PRE AUTHORIZATION/2ND OPINION
"RTN","ECXFEKE1",94,0)
D43M ;;SPOT CHECK DISCREPANCY (STAFF)
"RTN","ECXFEKE1",95,0)
D43R ;;SPOT CHECK DISCREPANCY (FEE)
"RTN","ECXFEKE1",96,0)
 ;
"RTN","ECXFEKE1",97,0)
PRINT ;
"RTN","ECXFEKE1",98,0)
 ;setting EC9=EC1 is just for the benefit of the new ECS feeder key list - don't want to mess-up the other lists
"RTN","ECXFEKE1",99,0)
 S (QFLG,PG)=0,$P(LN,"-",81)=""
"RTN","ECXFEKE1",100,0)
 S EC="" F  S EC=$O(^TMP($J,EC)),EC1="" Q:EC=""  Q:QFLG  D HEAD F  S EC1=$O(^TMP($J,EC,EC1)),EC9=EC1,EC2=""  Q:EC1=""  Q:QFLG  D
"RTN","ECXFEKE1",101,0)
 .I EC="CLI" S EC9=$P(EC9,";",2)
"RTN","ECXFEKE1",102,0)
 .I EC="ECS",$G(ECECS)="N" S EC9=$P(EC9,";",2)
"RTN","ECXFEKE1",103,0)
 .I EC="LAB",EC9[".8" S EC9=$$ADD0(EC9)
"RTN","ECXFEKE1",104,0)
 .F  S EC2=$O(^TMP($J,EC,EC1,EC2)) Q:EC2=""  D
"RTN","ECXFEKE1",105,0)
 ..D:($Y+3>IOSL) HEAD Q:QFLG
"RTN","ECXFEKE1",106,0)
 ..I EC="PHA" W !,?2,$E(EC9,2,99),?24,$E($P(^TMP($J,EC,EC1,EC2),"^",1),1,32),?58,$E($P(^(EC2),"^",2),2,99) Q
"RTN","ECXFEKE1",107,0)
 ..W !,?5,EC9,?27,^TMP($J,EC,EC1,EC2)
"RTN","ECXFEKE1",108,0)
 I $E(IOST)="C"&('QFLG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","ECXFEKE1",109,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXFEKE1",110,0)
 K EC,EC1,EC2,EC3,EC9,ECCSC,ECD,ECLIST,ECNDC,ECNDF,ECNFC,ECPHA,ECECS,ECLAB,ECSC,ECST,ECY,JJ,LN,P1,P2,P3,PG,POP,QFLG,SC,SS,X,Y,^TMP($J),DIR,DIRUT,DUOUT
"RTN","ECXFEKE1",111,0)
 W:$E(IOST)'="C" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECXFEKE1",112,0)
 Q
"RTN","ECXFEKE1",113,0)
HEAD ;
"RTN","ECXFEKE1",114,0)
 I $E(IOST)="C" S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXFEKE1",115,0)
 I $E(IOST)="C",PG>0 S DIR(0)="E" D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXFEKE1",116,0)
 W:$Y!($E(IOST)="C") @IOF
"RTN","ECXFEKE1",117,0)
 S PG=PG+1 W !,?21,"Feeder Key List For Feeder System ",EC,?70,"Page: ",PG
"RTN","ECXFEKE1",118,0)
 I EC="PHA" D  Q
"RTN","ECXFEKE1",119,0)
 .I $D(ECPHA) W !?22,$S(ECPHA="O":"(OLD Feeder Key from VA Class)",1:"(NEW Feeder Key from NDF Match)")
"RTN","ECXFEKE1",120,0)
 .I $P(ECPHA2,"^",2)=0 W !!,?2,"Feeder Key",?24,"Description",!,LN,!
"RTN","ECXFEKE1",121,0)
 .I $P(ECPHA2,"^",2)=1 W !!,"Pre-FY1999 Feeder Key",?24,"Description",?58,"FY1999 Feeder Key",!,LN,!
"RTN","ECXFEKE1",122,0)
 .I $P(ECPHA2,"^",2)=2 W !!,"FY1999 Feeder Key",?24,"Description",?58,"Pre-FY1999 Feeder Key",!,LN,!
"RTN","ECXFEKE1",123,0)
 I $D(ECECS)&(EC="ECS") W !?21,$S(ECECS="O":"(OLD Feeder Key sorted by Category-Procedure)",1:"(NEW Feeder Key sorted by Procedure-CPT Code)")
"RTN","ECXFEKE1",124,0)
 I $D(ECLAB)&(EC="LAB") W !?15,$S(ECLAB="O":"(OLD Feeder Key sorted by Local Feeder Key values)",1:"      (NEW Feeder Key sorted by LMIP Codes)")
"RTN","ECXFEKE1",125,0)
 W !!,?5,"Feeder Key",?27,"Description",!,LN,!
"RTN","ECXFEKE1",126,0)
 Q
"RTN","ECXFEKE1",127,0)
ADD0(ECXFKEY) ;** Append zeros to decimal place on feeder key
"RTN","ECXFEKE1",128,0)
 ;
"RTN","ECXFEKE1",129,0)
 ;** Variable Definitions
"RTN","ECXFEKE1",130,0)
 ;**  ECXFKEY   - Value of Feeder Key
"RTN","ECXFEKE1",131,0)
 ;**                Returns  feeder key with zeros appended to make a
"RTN","ECXFEKE1",132,0)
 ;**                          four place decimal.
"RTN","ECXFEKE1",133,0)
 ;
"RTN","ECXFEKE1",134,0)
 N ECXD,LPCNT,LPEND,ECXFEKEY,ECXDEC
"RTN","ECXFEKE1",135,0)
 S ECXDEC=$P(ECXFKEY,".",2)
"RTN","ECXFEKE1",136,0)
 S LPEND=4-$L(ECXDEC)
"RTN","ECXFEKE1",137,0)
 F LPCNT=1:1:LPEND S ECXDEC=ECXDEC_"0"
"RTN","ECXFEKE1",138,0)
 S ECXFEKEY=$P(ECXFKEY,".",1)_"."_ECXDEC
"RTN","ECXFEKE1",139,0)
 Q ECXFEKEY
"RTN","ECXFEKE1",140,0)
 ;
"RTN","ECXFEKEY")
0^19^B63843898
"RTN","ECXFEKEY",1,0)
ECXFEKEY ;BIR/DMA,CML-Print Feeder Keys; [ 05/15/96  9:44 AM ]
"RTN","ECXFEKEY",2,0)
 ;;3.0;DSS EXTRACTS;**10,11**;Dec 22, 1997
"RTN","ECXFEKEY",3,0)
EN ;entry point from option
"RTN","ECXFEKEY",4,0)
 W !!,"Print list of Feeder Keys:",!
"RTN","ECXFEKEY",5,0)
 W !,"Select : 1. CLI",!,?9,"2. DEN",!,?9,"3. ECS",!,?9,"4. LAB",!,?9,"5. NUR",!,?9,"6. PHA",!,?9,"7. RAD",!,?9,"8. SUR",! S DIR(0)="L^1:8" D ^DIR Q:$D(DIRUT)
"RTN","ECXFEKEY",6,0)
 S ECY=Y
"RTN","ECXFEKEY",7,0)
 I Y["6" D
"RTN","ECXFEKEY",8,0)
 .S ECPHA="",ECPHA2="0^0"
"RTN","ECXFEKEY",9,0)
 .W !!,"The Feeder Key List for the Feeder System PHA can be printed as:",!?5,"(O)ld Feeder Key by VA Class",!?5,"(N)ew Feeder Key by NDF Match"
"RTN","ECXFEKEY",10,0)
 .S DIR(0)="S^O:OLD;N:NEW",DIR("B")="NEW" D ^DIR K DIR Q:$D(DIRUT)  S ECPHA=Y
"RTN","ECXFEKEY",11,0)
 .I ECPHA="N" S X="PSNAPIS" X ^%ZOSF("TEST") I $T D
"RTN","ECXFEKEY",12,0)
 ..I $T(PSNAPIS+1^PSNAPIS)[";;3.18;",$T(PSNAPIS+1^PSNAPIS)[";**5" S ECPHA2="1^0" Q
"RTN","ECXFEKEY",13,0)
 ..I $T(PSNAPIS+1^PSNAPIS)[";;4.0;" D
"RTN","ECXFEKEY",14,0)
 ...S ECPHA2="2^0"
"RTN","ECXFEKEY",15,0)
 ...W @IOF D NDF4^ECXNDC
"RTN","ECXFEKEY",16,0)
 ...W !!,"Both the pre-FY1999 and FY1999 Feeder keys will appear on this report."
"RTN","ECXFEKEY",17,0)
 ...W !,"But you may select the sort order for the listing."
"RTN","ECXFEKEY",18,0)
 ...W !!,"The NDF Feeder Key List can be sorted by:",!!?5,"(1) Pre-FY1999 Feeder Keys ",!?5,"(2) FY1999 Feeder Keys",!
"RTN","ECXFEKEY",19,0)
 ...S DIR(0)="N^1:2:0" D ^DIR K DIR Q:$D(DIRUT)  S $P(ECPHA2,"^",2)=Y
"RTN","ECXFEKEY",20,0)
 G:$D(DIRUT) QUIT
"RTN","ECXFEKEY",21,0)
 I ECY["3" D
"RTN","ECXFEKEY",22,0)
 .W !!,"The Feeder Key List for the Feeder System ECS can be printed by:",!?5,"(O)ld Feeder Key sort by Category-Procedure",!?5,"(N)ew Feeder Key sort by Procedure-CPT Code"
"RTN","ECXFEKEY",23,0)
 .S DIR(0)="S^O:OLD;N:NEW",DIR("B")="NEW" D ^DIR K DIR Q:$D(DIRUT)  S ECECS=Y
"RTN","ECXFEKEY",24,0)
 S:ECY["4" ECLAB=$$SELLABKE^ECXFEKE1() ;**Prompt to select Lab Feeder key
"RTN","ECXFEKEY",25,0)
 G:($G(ECLAB)=-1) QUIT ;**GOTO Exit point
"RTN","ECXFEKEY",26,0)
 G:$D(DIRUT) QUIT
"RTN","ECXFEKEY",27,0)
 K %ZIS,IOP S %ZIS="QM",%ZIS("B")="" D ^%ZIS
"RTN","ECXFEKEY",28,0)
 I POP W !,"NO DEVICE SELECTED!!" G QUIT
"RTN","ECXFEKEY",29,0)
 I $D(IO("Q")) K IO("Q") D  G QUIT
"RTN","ECXFEKEY",30,0)
 .S ZTRTN="START^ECXFEKEY",ZTDESC="Feeder Key List (DSS)"
"RTN","ECXFEKEY",31,0)
 .S ZTSAVE("ECY")="",ZTSAVE("ECPHA")="",ZTSAVE("ECPHA2")="",ZTSAVE("ECECS")="",ZTSAVE("ECLAB")=""
"RTN","ECXFEKEY",32,0)
 .D ^%ZTLOAD I $D(ZTSK) W !,"Queued Task #: "_ZTSK
"RTN","ECXFEKEY",33,0)
 .D HOME^%ZIS K ZTSK
"RTN","ECXFEKEY",34,0)
 ;
"RTN","ECXFEKEY",35,0)
START ;queued entry point
"RTN","ECXFEKEY",36,0)
 I '$D(DT) S DT=$$HTFM^XLFDT(+$H)
"RTN","ECXFEKEY",37,0)
 K ^TMP($J)
"RTN","ECXFEKEY",38,0)
 F ECLIST=1:1 S EC=$P(ECY,",",ECLIST) Q:EC=""  D:EC=1 CLI D:EC=2 DEN^ECXFEKE1 D:EC=3 ECS D:EC=4 LAB D:EC=5 NUR D:EC=6 PHA D:EC=7 RAD D:EC=8 SUR^ECXFEKE1
"RTN","ECXFEKEY",39,0)
 U IO D PRINT^ECXFEKE1
"RTN","ECXFEKEY",40,0)
 Q
"RTN","ECXFEKEY",41,0)
LAB S EC=0
"RTN","ECXFEKEY",42,0)
 ;
"RTN","ECXFEKEY",43,0)
 ;** OLD Feeder Key format
"RTN","ECXFEKEY",44,0)
 I $G(ECLAB)="O" DO
"RTN","ECXFEKEY",45,0)
 .F  S EC=$O(^LAB(60,EC)) Q:'EC  I $D(^(EC,0)) S EC1=$P(^(0),"^"),^TMP($J,"LAB",EC,EC)=EC1
"RTN","ECXFEKEY",46,0)
 ;
"RTN","ECXFEKEY",47,0)
 ;** NEW Feeder key format (LMIP Code)
"RTN","ECXFEKEY",48,0)
 I $G(ECLAB)="N" DO
"RTN","ECXFEKEY",49,0)
 .N EC2
"RTN","ECXFEKEY",50,0)
 .F  S EC=$O(^LAM(EC)) Q:'EC  DO
"RTN","ECXFEKEY",51,0)
 ..I $D(^LAM(EC,0)) DO
"RTN","ECXFEKEY",52,0)
 ...S EC1=$P(^LAM(EC,0),"^",1),EC1=$P(EC1,"~",1)
"RTN","ECXFEKEY",53,0)
 ...S EC2=$P(^LAM(EC,0),"^",2)
"RTN","ECXFEKEY",54,0)
 ...I EC2'[".9999",(EC2'[".8") S EC2=EC2\1
"RTN","ECXFEKEY",55,0)
 ...S ^TMP($J,"LAB",+EC2,+EC2)=EC1
"RTN","ECXFEKEY",56,0)
 Q
"RTN","ECXFEKEY",57,0)
ECS ;old ECS feeder key list for pre-FY97 data
"RTN","ECXFEKEY",58,0)
 G:$G(ECECS)="N" ECS2
"RTN","ECXFEKEY",59,0)
 S EC=0 I $P($G(^EC(720.1,1,0)),"^",2) D  G ECQ
"RTN","ECXFEKEY",60,0)
 .F  S EC=$O(^ECJ(EC)) Q:'EC  I $D(^(EC,0)) D
"RTN","ECXFEKEY",61,0)
 ..S EC1=$P($P(^(0),"^"),"-",3,4),EC2=$P(EC1,"-"),EC2=$S(+EC2:EC2,1:"***"),EC4=$S($P($G(^EC(726,+EC2,0)),"^")]"":$P(^(0),"^"),1:"***")
"RTN","ECXFEKEY",62,0)
 ..S EC3=$P(EC1,"-",2) Q:'+EC3  S EC3=$S(EC3["ICPT":$P($G(^ICPT(+EC3,0)),"^"),+EC3<90000:$P($G(^EC(725,+EC3,0)),"^",2)_"N",1:$P($G(^EC(725,+EC3,0)),"^",2)_"L")
"RTN","ECXFEKEY",63,0)
 ..S EC5=$P(EC1,"-",2),EC5=$S(EC5["ICPT":$E($P($G(^ICPT(+EC5,0)),"^",2),1,25),EC5["EC":$E($P($G(^EC(725,+EC5,0)),"^"),1,25),1:"UNKNOWN")
"RTN","ECXFEKEY",64,0)
 ..S ^TMP($J,"ECS",EC2_" - "_EC3,EC3)=EC4_" - "_EC5
"RTN","ECXFEKEY",65,0)
 F  S EC=$O(^ECK(EC)) Q:'EC  I $D(^(EC,0)) S EC1=$P($P(^(0),"^"),"-",3,4),EC2=$E($P($G(^ECP(+EC1,0)),"^"),1,25),EC3=$E($P($G(^ECP(+$P(EC1,"-",2),0)),"^"),1,25),^TMP($J,"ECS",EC1,EC1)=EC2_" - "_EC3
"RTN","ECXFEKEY",66,0)
ECQ K EC1,EC2,EC3,EC4,EC5,EC6,EC7,EC8,EC9,EC10 Q
"RTN","ECXFEKEY",67,0)
ECS2 ;new ECS feeder key list for FY97 data
"RTN","ECXFEKEY",68,0)
 ;feeder key is <Procedure> if PCE CPT code is same or null;
"RTN","ECXFEKEY",69,0)
 ;feeder is <Procedure-PCE CPT> otherwise;
"RTN","ECXFEKEY",70,0)
 ;the description column of list shows procedure (EC5) in lowercase and CPT code (EC8) in uppercase;
"RTN","ECXFEKEY",71,0)
 ;but if procedure (EC3) is itself a CPT Code, convert EC5 to uppercase
"RTN","ECXFEKEY",72,0)
 ;concatenation of "A;" and "B;" are for proper sorting - CPT codes 1st, then other procedures
"RTN","ECXFEKEY",73,0)
 S EC=0 I $P($G(^EC(720.1,1,0)),"^",2) D  G ECQ
"RTN","ECXFEKEY",74,0)
 .F  S EC=$O(^ECJ(EC)) Q:'EC  I $D(^ECJ(EC,0)) D
"RTN","ECXFEKEY",75,0)
 ..S EC1=$P($P(^ECJ(EC,0),"^"),"-",3,4)
"RTN","ECXFEKEY",76,0)
 ..S EC3=$P(EC1,"-",2) Q:'+EC3  S EC3=$S(EC3["ICPT":$P($G(^ICPT(+EC3,0)),"^"),+EC3<90000:$P($G(^EC(725,+EC3,0)),"^",2)_"N",1:$P($G(^EC(725,+EC3,0)),"^",2)_"L")
"RTN","ECXFEKEY",77,0)
 ..S EC5=$P(EC1,"-",2),EC5=$S(EC5["ICPT":$E($P($G(^ICPT(+EC5,0)),"^",2),1,25),EC5["EC":$E($P($G(^EC(725,+EC5,0)),"^"),1,25),1:"UNKNOWN")
"RTN","ECXFEKEY",78,0)
 ..S EC5=$$LOW(EC5)
"RTN","ECXFEKEY",79,0)
 ..I EC1["ICPT" S EC5=$$UPP(EC5),EC3="A;"_EC3
"RTN","ECXFEKEY",80,0)
 ..S EC6=$P(EC1,"-",2),EC7="",EC8=""
"RTN","ECXFEKEY",81,0)
 ..I EC6["EC(725," D
"RTN","ECXFEKEY",82,0)
 ...S EC6=$S(+EC6>0:$P($G(^EC(725,+EC6,0)),"^",5),1:"") S EC7=$S(+EC6>0:$P($G(^ICPT(+EC6,0)),"^"),1:"")
"RTN","ECXFEKEY",83,0)
 ...S EC8=$S(+EC6>0:$E($P($G(^ICPT(+EC6,0)),"^",2),1,25),1:"")
"RTN","ECXFEKEY",84,0)
 ...S EC8=$$UPP(EC8),EC3="B;"_EC3
"RTN","ECXFEKEY",85,0)
 ..S EC9=$S(EC7'="":EC3_"-"_EC7,1:EC3),EC10=$S(EC8'="":EC5_" - "_EC8,1:EC5)
"RTN","ECXFEKEY",86,0)
 ..S ^TMP($J,"ECS",EC9,EC3)=EC10
"RTN","ECXFEKEY",87,0)
 G ECQ
"RTN","ECXFEKEY",88,0)
LOW(X) ;convert string to lowercase
"RTN","ECXFEKEY",89,0)
 F %=2:1:$L(X) I $E(X,%)?1U,$E(X,%-1)?1A S X=$E(X,0,%-1)_$C($A(X,%)+32)_$E(X,%+1,999)
"RTN","ECXFEKEY",90,0)
 Q X
"RTN","ECXFEKEY",91,0)
UPP(X) ;convert string to uppercase
"RTN","ECXFEKEY",92,0)
 F %=1:1:$L(X) S:$E(X,%)?1L X=$E(X,0,%-1)_$C($A(X,%)-32)_$E(X,%+1,999)
"RTN","ECXFEKEY",93,0)
 Q X
"RTN","ECXFEKEY",94,0)
 ;
"RTN","ECXFEKEY",95,0)
PHA ; feeder system for all pharmacy extracts is PHA
"RTN","ECXFEKEY",96,0)
 G:$G(ECPHA)="N" PHA2
"RTN","ECXFEKEY",97,0)
 S EC=0 F  S EC=$O(^PSDRUG(EC)) Q:'EC  I $D(^(EC,0)) S ECD=$P(^(0),"^"),EC1=$P(^(0),"^",2),EC2=$P($G(^(2)),"^",4),EC3=$$RJ^XLFSTR($P(EC2,"-"),6,0)_$$RJ^XLFSTR($P(EC2,"-",2),4,0)_$$RJ^XLFSTR($P(EC2,"-",3),2,0),EC3=$TR(EC3,"*","0") D
"RTN","ECXFEKEY",98,0)
 .S:EC1="" EC1="ZZ999" S:EC3="000000000000" EC3="999999999999"
"RTN","ECXFEKEY",99,0)
 .S ^TMP($J,"PHA",EC1_EC3,EC)=ECD
"RTN","ECXFEKEY",100,0)
 Q
"RTN","ECXFEKEY",101,0)
PHA2 ;NEW PHA Feeder Key List sorted by NDF Match
"RTN","ECXFEKEY",102,0)
 S ECXYM(1)=$$ECXYM^ECXUTL(2980930),ECXYM(2)=$$ECXYM^ECXUTL(DT)
"RTN","ECXFEKEY",103,0)
 ;pre ndf v4
"RTN","ECXFEKEY",104,0)
 I +ECPHA2<2 S EC=0 F  S EC=$O(^PSDRUG(EC)) Q:'EC  I $D(^PSDRUG(EC,0)) D
"RTN","ECXFEKEY",105,0)
 .S ECD=$P(^PSDRUG(EC,0),"^"),ECNDC=$P($G(^PSDRUG(EC,2)),"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXFEKEY",106,0)
 .S ECNDF=$G(^PSDRUG(EC,"ND")),P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXFEKEY",107,0)
 .I +ECPHA2=1 S ECNFC=$$DSS^PSNAPIS(P1,P3,DT)_ECNFC
"RTN","ECXFEKEY",108,0)
 .I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXFEKEY",109,0)
 .Q:+ECNFC=0
"RTN","ECXFEKEY",110,0)
 .S ECNFC="A"_ECNFC,^TMP($J,"PHA",ECNFC,EC)=ECD
"RTN","ECXFEKEY",111,0)
 ;after ndf v4
"RTN","ECXFEKEY",112,0)
 I +ECPHA2=2 S EC=0 F  S EC=$O(^PSDRUG(EC)) Q:'EC  I $D(^PSDRUG(EC,0)) D
"RTN","ECXFEKEY",113,0)
 .S ECD=$P(^PSDRUG(EC,0),"^"),ECNDC=$P($G(^PSDRUG(EC,2)),"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXFEKEY",114,0)
 .S ECNDF=$G(^PSDRUG(EC,"ND")),P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXFEKEY",115,0)
 .;get the 19 character key
"RTN","ECXFEKEY",116,0)
 .S ECNFC(1)=$$DSS^PSNAPIS(P1,P3,ECXYM(1))_ECNFC
"RTN","ECXFEKEY",117,0)
 .;get the 17 character key
"RTN","ECXFEKEY",118,0)
 .S ECNFC(2)=$$DSS^PSNAPIS(P1,P3,ECXYM(2))_ECNFC
"RTN","ECXFEKEY",119,0)
 .Q:((+ECNFC(1)=0)&(+ECNFC(2)=0))
"RTN","ECXFEKEY",120,0)
 .;2nd piece of variable ecpha2 determines sort order
"RTN","ECXFEKEY",121,0)
 .S ECNFC(1)="A"_ECNFC(1),ECNFC(2)="A"_ECNFC(2)
"RTN","ECXFEKEY",122,0)
 .I $P(ECPHA2,"^",2)=1 S ^TMP($J,"PHA",ECNFC(1),EC)=ECD_"^"_ECNFC(2)
"RTN","ECXFEKEY",123,0)
 .I $P(ECPHA2,"^",2)=2 S ^TMP($J,"PHA",ECNFC(2),EC)=ECD_"^"_ECNFC(1)
"RTN","ECXFEKEY",124,0)
 Q
"RTN","ECXFEKEY",125,0)
CLI S SC=0 F  S SC=$O(^SC(SC)) Q:'SC  I $D(^(SC,0)) S EC=^(0),ECD=$P(EC,"^") I $P(EC,"^",3)="C" D  S ^TMP($J,"CLI","A;"_P1_P2_ECLEN_P3_"0",SC)=ECD
"RTN","ECXFEKEY",126,0)
 .S ECSC=$P($G(^DIC(40.7,+$P(EC,"^",7),0)),"^",2),ECCSC=$P($G(^DIC(40.7,+$P(EC,"^",18),0)),"^",2)
"RTN","ECXFEKEY",127,0)
 .S ECLEN="NNN" I $D(^SC(SC,"SL")),$P(^("SL"),"^",2)'="V" S ECLEN=$S($P(^("SL"),"^"):$P(^("SL"),"^"),1:"NNN"),ECLEN=$E("000"_ECLEN,$L(ECLEN)+1,$L(ECLEN)+3)
"RTN","ECXFEKEY",128,0)
 .S (P1,P2)="000",P3="0000" I '$D(^ECX(728.44,SC,0)),ECCSC]"" S ECST=5,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3),P2=$E("000"_ECCSC,$L(ECCSC)+1,$L(ECCSC)+3) Q
"RTN","ECXFEKEY",129,0)
 .I '$D(^ECX(728.44,SC,0)) S ECST=1,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3) Q
"RTN","ECXFEKEY",130,0)
 .S EC=^ECX(728.44,SC,0),ECST=$P(EC,"^",6)
"RTN","ECXFEKEY",131,0)
 .I ECST=6 Q
"RTN","ECXFEKEY",132,0)
 .;action code 6 means ignore
"RTN","ECXFEKEY",133,0)
 .I $P(EC,"^",4)]"" S ECSC=$P(EC,"^",4)
"RTN","ECXFEKEY",134,0)
 .I $P(EC,"^",5)]"" S ECCSC=$P(EC,"^",5)
"RTN","ECXFEKEY",135,0)
 .I ECST="" S ECST=4,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3),P3=$E("0000"_SC,$L(SC)+1,$L(SC)+4) S:ECCSC P2=$E("000"_ECCSC,$L(ECCSC)+1,$L(ECCSC)+3) Q
"RTN","ECXFEKEY",136,0)
 .I ECST<2 S P1=ECSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3) Q
"RTN","ECXFEKEY",137,0)
 .I ECST=2 S P1=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3) Q
"RTN","ECXFEKEY",138,0)
 .I ECST=3 S P1=ECSC,P11=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3),P11=$E("000"_P11,$L(P11)+1,$L(P11)+3) Q
"RTN","ECXFEKEY",139,0)
 .I ECST>3,ECST<7 S P1=ECSC,P2=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3),P2=$E("000"_P2,$L(P2)+1,$L(P2)+3) S:ECST=4 P3=$P($G(^ECX(728.441,+$P(^ECX(728.44,SC,0),"^",8),0)),"^") I P3="" S P3=$E("0000"_SC,$L(SC)+1,$L(SC)+4)
"RTN","ECXFEKEY",140,0)
 K ECLEN Q
"RTN","ECXFEKEY",141,0)
RAD S EC=0 F  S EC=$O(^RAMIS(71,EC)) Q:'EC  I $D(^(EC,0)) S EC1=^(0),ECD=$P(EC1,"^"),EC2=$P($G(^ICPT(+$P(EC1,"^",9),0)),"^") S:EC2="" EC2="Unknown" S ^TMP($J,"RAD",EC2,EC)=ECD
"RTN","ECXFEKEY",142,0)
 S ^TMP($J,"RAD",88888,88888)="Portable procedure",^TMP($J,"RAD",99999,99999)="OR procedure"
"RTN","ECXFEKEY",143,0)
 Q
"RTN","ECXFEKEY",144,0)
NUR F EC=1:1:11 S EC1=$P($T(@EC),";",3) F EC2=0:1:5 S ^TMP($J,"NUR",$P(EC1,"^")_"-"_EC2,EC2)=$P(EC1,"^",2)_" LEVEL "_EC2
"RTN","ECXFEKEY",145,0)
1 ;;PSI^PSYCHIATRIC
"RTN","ECXFEKEY",146,0)
2 ;;SUR^SURGICAL
"RTN","ECXFEKEY",147,0)
3 ;;MED^MEDICAL (EXCLUDE SCI)
"RTN","ECXFEKEY",148,0)
4 ;;SCI^MEDICAL (SCI)
"RTN","ECXFEKEY",149,0)
5 ;;NUR^NURSING HOME CARE UNIT
"RTN","ECXFEKEY",150,0)
6 ;;REC^RECOVERY ROOM
"RTN","ECXFEKEY",151,0)
7 ;;ITN^INTENSIVE CARE
"RTN","ECXFEKEY",152,0)
8 ;;HEM^HEMODIALYSIS
"RTN","ECXFEKEY",153,0)
9 ;;INT^INTERMEDIATE CARE
"RTN","ECXFEKEY",154,0)
10 ;;DOM^DOMICILIARY
"RTN","ECXFEKEY",155,0)
11 ;;ALC^ALCOHOL AND DRUG TREATMENT
"RTN","ECXFEKEY",156,0)
 Q
"RTN","ECXFEKEY",157,0)
QUIT ;
"RTN","ECXFEKEY",158,0)
 K ECY,ECPHA,ECECS,ECLAB,DIR,DIRUT,DUOUT,X,Y
"RTN","ECXFEKEY",159,0)
 Q
"RTN","ECXLABN")
0^4^B18368148
"RTN","ECXLABN",1,0)
ECXLABN ;BIR/CML-Lab Extract for DSS (New Format - With LMIP Codes) ; [ 11/22/96  5:14 PM ]
"RTN","ECXLABN",2,0)
 ;;3.0;DSS EXTRACTS;**1,11**;Dec 22, 1997
"RTN","ECXLABN",3,0)
BEG D SETUP,^ECXTRAC
"RTN","ECXLABN",4,0)
END D ^ECXKILL
"RTN","ECXLABN",5,0)
 Q
"RTN","ECXLABN",6,0)
START ; entry when queued
"RTN","ECXLABN",7,0)
 S QFLG=0
"RTN","ECXLABN",8,0)
 K ^LRO(64.03) S LRSDT=ECSD,LREDT=ECED D ^LRCAPDSS
"RTN","ECXLABN",9,0)
 ;quit if no completion date for API compile
"RTN","ECXLABN",10,0)
 I '$P($G(^LRO(64.03,1,1,1,0)),"^",4) Q
"RTN","ECXLABN",11,0)
 ;quit if tasked and user sends stop request
"RTN","ECXLABN",12,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ^LRO(64.03) S ^LRO(64.03,0)="WKLD LOG FILE^64.03^" Q
"RTN","ECXLABN",13,0)
 K ECXDD D FIELD^DID(64.03,1,,"SPECIFIER","ECXDD") S ECPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD ; provider points to
"RTN","ECXLABN",14,0)
 S ECLRN=1 F  S ECLRN=$O(^LRO(64.03,ECLRN)) Q:'ECLRN  I $D(^LRO(64.03,ECLRN,0)) S EC1=^(0),ECDOC=ECPROF_$P(EC1,"^",2),ECLOC=$P(EC1,"^",15),EC=$P(EC1,"^",3) I EC]"" D  Q:QFLG
"RTN","ECXLABN",15,0)
 .S ECF=$S($P(EC,";",2)="DPT(":2,$P(EC,";",2)="LRT(67,":67,1:0) Q:'ECF  S ECIFN=$P(EC,";")
"RTN","ECXLABN",16,0)
 .;resolve ecloc
"RTN","ECXLABN",17,0)
 .S ECXL1=+$P(ECLOC,";",1),ECXL2=$P(ECLOC,";",2)
"RTN","ECXLABN",18,0)
 .I ECF=2 S ECLOC=$S(ECXL1>0:ECXL1,1:"") I ECXL2]"",ECXL2'="SC(" S ECLOC=""
"RTN","ECXLABN",19,0)
 .I ECF=67 D  S ECLOC=ECXSTN
"RTN","ECXLABN",20,0)
 ..S (ECXSTN,ECXAGC)=""
"RTN","ECXLABN",21,0)
 ..I ECXL2'="DIC(4," S ECXSTN="XXXXX",ECXAGC="XX" Q
"RTN","ECXLABN",22,0)
 ..I '$D(^DIC(4,ECXL1)) S ECXSTN="XXXXX",ECXAGC="XX" Q
"RTN","ECXLABN",23,0)
 ..I $D(^DIC(4,ECXL1)) S ECXSTN=$P(^DIC(4,ECXL1,"99"),"^",1),ECXAGC=$E($P(^(99),"^",5),1,2) S:ECXSTN="" ECXSTN="ZZZZZ" S:ECXAGC="" ECXAGC="ZZ"
"RTN","ECXLABN",24,0)
 .S ECDT=$P(EC1,"^",13),ECD=$P(ECDT,"."),ECTM=$$ECXTIME^ECXUTL(ECDT)
"RTN","ECXLABN",25,0)
 .S ECWKLD=$P(EC1,"^",11),ECWK="" I $D(^LAM(ECWKLD,0)) S ECWK=$P(^(0),"^",2)
"RTN","ECXLABN",26,0)
 .S (ECNA,ECSN,ECMN,ECPTTM,ECPTPR)="",ECA=1
"RTN","ECXLABN",27,0)
 .;get the patient data if record is in file #2
"RTN","ECXLABN",28,0)
 .I ECF=2,$D(^DPT(ECIFN,0)) D
"RTN","ECXLABN",29,0)
 ..S EC0=^DPT(ECIFN,0),ECNA=$E($P($P(EC0,"^"),",")_"    ",1,4),ECSN=$P(EC0,"^",9) K VAIP S VAIP("D")=ECD,DFN=ECIFN D IN5^VADPT S ECMN=VAIP(1) S:ECMN ECA=3
"RTN","ECXLABN",30,0)
 ..S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECDT)
"RTN","ECXLABN",31,0)
 ..S:ECPTTM=0 ECPTTM=""
"RTN","ECXLABN",32,0)
 ..S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECDT)
"RTN","ECXLABN",33,0)
 ..S:ECPTPR=0 ECPTPR=""
"RTN","ECXLABN",34,0)
 .K VAIP,VAERR
"RTN","ECXLABN",35,0)
 .;get patient data if record is in file #67
"RTN","ECXLABN",36,0)
 .I ECF=67 S ECSN="000123456",ECNA="RFRL" I $D(^LRT(67,ECIFN,0)) D
"RTN","ECXLABN",37,0)
 ..S EC0=^LRT(67,ECIFN,0),ECNA=$E($P($P(EC0,"^"),",")_"    ",1,4),ECSN=$P(EC0,"^",9) D
"RTN","ECXLABN",38,0)
 ...S ECNA=$TR(ECNA,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ECXLABN",39,0)
 ...I ECSN="" S ECSN="000123456" Q
"RTN","ECXLABN",40,0)
 ...S ECSN=$TR(ECSN," "),ECSN=$TR(ECSN,"-")
"RTN","ECXLABN",41,0)
 ...I ($L(ECSN)<9)!($L(ECSN)>10) S ECSN="000123456" Q
"RTN","ECXLABN",42,0)
 ...I $L(ECSN)=9,ECSN'?9N S ECSN="000123456" Q
"RTN","ECXLABN",43,0)
 ...I $L(ECSN)=10,ECSN'?9N1"P" S ECSN="000123456"
"RTN","ECXLABN",44,0)
 .S ECTREAT=$P(EC1,"^",10) I ECTREAT S ECTREAT=$P($G(^DIC(45.7,+ECTREAT,0)),"^",2)
"RTN","ECXLABN",45,0)
 .;create extract record only if patient name and accession area exist
"RTN","ECXLABN",46,0)
 .I ECNA]"" S ECT=$P(EC1,"^",8),ECURG=$P(EC1,"^",9),EC=+$P(EC1,"^",7) I EC D
"RTN","ECXLABN",47,0)
 ..S:ECF=2 ECACA=EC_"^"_$P($G(^LRO(68,EC,0)),"^",11) S:ECF=67 ECACA=ECXAGC_"^"_$P($G(^LRO(68,EC,0)),"^",11)
"RTN","ECXLABN",48,0)
 ..S ECODE=ECINST_"^"_ECIFN_"^"_ECSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECACA_"^"_ECT_"^"_ECURG_"^"_ECTREAT_"^"_ECLOC_"^"_ECDOC_"^"_ECMN_"^"_ECF_"^"_ECTM_"^"_ECWK_"^"_ECPTTM_"^"_ECPTPR_"^"
"RTN","ECXLABN",49,0)
 ..;inst^patient (or thing) number^SSN (or equivalent)^name^in/out^day^accession area^abbreviation^test^urgency^treating spec^location^provider and file^
"RTN","ECXLABN",50,0)
 ..;movement number^file^time^workload code^primary care team^primary care provider
"RTN","ECXLABN",51,0)
 ..;(ECACA=acc area^abbreviation)
"RTN","ECXLABN",52,0)
 ..S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXLABN",53,0)
 ..S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXLABN",54,0)
 .I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXLABN",55,0)
 K ^LRO(64.03) S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",56,0)
 Q
"RTN","ECXLABN",57,0)
 ;
"RTN","ECXLABN",58,0)
SETUP S ECPACK="Laboratory",ECPIECE=1,ECRTN="START^ECXLABN",ECGRP="LAB",ECHEAD="LAB",ECFILE=727.813,ECVER=7
"RTN","ECXLABN",59,0)
 Q
"RTN","ECXLABN",60,0)
 ;
"RTN","ECXLABN",61,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLABN",62,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXLABO")
0^5^B11778157
"RTN","ECXLABO",1,0)
ECXLABO ;BIR/MAM,DMA,CML-Lab Extract for DSS (Old Version - W/O LMIP Codes); [ 11/22/96  5:28 PM ]
"RTN","ECXLABO",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXLABO",3,0)
V ;;2.0T11;DSS EXTRACTS;**24**;DEC 18,1996
"RTN","ECXLABO",4,0)
 ;This routine was originally called ECXLAB1, as called from the DSS menu.  Now ECXLAB1 is the driver routine to call ECXLABO (old format) or ECXLABN (new format)
"RTN","ECXLABO",5,0)
 D SETUP,^ECXTRAC
"RTN","ECXLABO",6,0)
END D ^ECXKILL
"RTN","ECXLABO",7,0)
 Q
"RTN","ECXLABO",8,0)
START ; entry when queued
"RTN","ECXLABO",9,0)
 S QFLG=0
"RTN","ECXLABO",10,0)
 S ECED=ECED+.3
"RTN","ECXLABO",11,0)
 K ECXDD D FIELD^DID(69.01,7,,"SPECIFIER","ECXDD") S ECPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD ; provider points to
"RTN","ECXLABO",12,0)
 S ECD=ECSD1 F  S ECD=$O(^LRO(69,ECD)),ECLRN=0 Q:'ECD  Q:ECD>ECED  F  S ECLRN=$O(^LRO(69,ECD,1,ECLRN)) Q:'ECLRN  I $D(^(ECLRN,0)) S EC1=^(0),ECDOC=ECPROF_$P(EC1,"^",6),ECLOC=$P(EC1,"^",9),EC=$G(^LR(+EC1,0)) I EC]"" D  Q:QFLG
"RTN","ECXLABO",13,0)
 .S ECDT=$P(EC1,"^",5),ECTM=$$ECXTIME^ECXUTL(ECDT)
"RTN","ECXLABO",14,0)
 .S (ECNA,ECSN,ECMN,ECTREAT,ECPTTM,ECPTPR)="",ECA=1
"RTN","ECXLABO",15,0)
 .S ECF=$P(EC,"^",2),ECIFN=$P(EC,"^",3)
"RTN","ECXLABO",16,0)
 .I ECF=2,$D(^DPT(ECIFN,0)) D
"RTN","ECXLABO",17,0)
 ..S EC0=^(0),ECNA=$E($P($P(EC0,"^"),",")_"    ",1,4),ECSN=$P(EC0,"^",9) K VAIP S VAIP("D")=ECD,DFN=ECIFN D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTREAT=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXLABO",18,0)
 ..S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECDT)
"RTN","ECXLABO",19,0)
 ..S:ECPTTM=0 ECPTTM=""
"RTN","ECXLABO",20,0)
 ..S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECDT)
"RTN","ECXLABO",21,0)
 ..S:ECPTPR=0 ECPTPR=""
"RTN","ECXLABO",22,0)
 .K VAIP,VAERR
"RTN","ECXLABO",23,0)
 .I ECF=67 S ECSN="000123456",ECNA="RFRL"
"RTN","ECXLABO",24,0)
 .I ECF=67.1 S ECSN=888888888,ECNA="RSCH"
"RTN","ECXLABO",25,0)
 .I ECNA]"" S J=0 F  S J=$O(^LRO(69,ECD,1,ECLRN,2,J)) Q:'J  S EC=$G(^(J,0)) I EC]"" S ECT=$P(EC,"^"),ECURG=$P(EC,"^",2),EC=+$P(EC,"^",4),ECACA=EC_"^"_$P($G(^LRO(68,EC,0)),"^",11) I EC D
"RTN","ECXLABO",26,0)
 ..S ECODE=ECINST_"^"_ECIFN_"^"_ECSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECACA_"^"_ECT_"^"_ECURG_"^"_ECTREAT_"^"_ECLOC_"^"_ECDOC_"^"_ECMN_"^"_ECF_"^"_ECTM_"^^"_ECPTTM_"^"_ECPTPR_"^"
"RTN","ECXLABO",27,0)
 ..;inst^patient (or thing) number^SSN (or equivalent)^name^in/out^day^accession area^abbreviation^test^urgency^treating spec^location^provider and file^
"RTN","ECXLABO",28,0)
 ..;movement number^file^time^workload code^primary care team^primary care provider
"RTN","ECXLABO",29,0)
 ..;(ECACA=acc area^abbreviation)
"RTN","ECXLABO",30,0)
 ..S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXLABO",31,0)
 ..S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXLABO",32,0)
 .I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXLABO",33,0)
 Q
"RTN","ECXLABO",34,0)
 ;
"RTN","ECXLABO",35,0)
SETUP S ECPACK="Laboratory",ECPIECE=1,ECRTN="START^ECXLABO",ECGRP="LAB",ECHEAD="LAB",ECFILE=727.813,ECVER=3
"RTN","ECXLABO",36,0)
 Q
"RTN","ECXLABO",37,0)
 ;
"RTN","ECXLABO",38,0)
 ;
"RTN","ECXLABO",39,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLABO",40,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXNDC")
0^17^B15388802
"RTN","ECXNDC",1,0)
ECXNDC ;ALB/JAP BIR/CML - Lookup Routine for NDC's ; [ 08/29/96  2:16 PM ]
"RTN","ECXNDC",2,0)
 ;;3.0;DSS EXTRACTS;**10,11**;Dec 22, 1997
"RTN","ECXNDC",3,0)
EN ;entry point from option
"RTN","ECXNDC",4,0)
 N F5068,QFLG
"RTN","ECXNDC",5,0)
 S F5068=0 I $T(PSNAPIS+1^PSNAPIS)[";;4.0;" S F5068=1
"RTN","ECXNDC",6,0)
 W @IOF
"RTN","ECXNDC",7,0)
 W !!,"Pharmacy Feeder Keys for DSS are built in the following manner."
"RTN","ECXNDC",8,0)
 I 'F5068 D NDF3 Q:QFLG
"RTN","ECXNDC",9,0)
 I F5068 D NDF4 Q:QFLG
"RTN","ECXNDC",10,0)
 W @IOF
"RTN","ECXNDC",11,0)
 W !,"This option will allow lookups on the local DRUG file (#50) using "
"RTN","ECXNDC",12,0)
 W !,"NDCs from DSS Pharmacy Feeder Keys that have been rejected because"
"RTN","ECXNDC",13,0)
 I 'F5068 D
"RTN","ECXNDC",14,0)
 .W !,"the first seven characters are zeros. (Ex. ""0000000051079014120"")"
"RTN","ECXNDC",15,0)
 I F5068 D
"RTN","ECXNDC",16,0)
 .W !,"the first five characters are zeros in a 17 character Feeder Key." 
"RTN","ECXNDC",17,0)
 .W !,"(Ex. ""00000051079014120"")"
"RTN","ECXNDC",18,0)
 .W !,"OR"
"RTN","ECXNDC",19,0)
 .W !,"the first seven characters are zeros in a 19 character Feeder Key." 
"RTN","ECXNDC",20,0)
 .W !,"(Ex. ""0000000051079014120"")"
"RTN","ECXNDC",21,0)
 W !!,"This would occur when a pharmacy item has not been matched to the"
"RTN","ECXNDC",22,0)
 W !,"the National Drug File (NDF)."
"RTN","ECXNDC",23,0)
 W !!,"Enter the NDC (last twelve characters) from a rejected feeder key"
"RTN","ECXNDC",24,0)
 W !,"to display information from the local DRUG file for any drug which"
"RTN","ECXNDC",25,0)
 W !,"has that NDC."
"RTN","ECXNDC",26,0)
 D ASK
"RTN","ECXNDC",27,0)
 K %,%H,%Y,DRG,DRGNM,ECD,LN,POP,X,Y,DUOUT,DTOUT
"RTN","ECXNDC",28,0)
 Q
"RTN","ECXNDC",29,0)
ASK ;select ndc for lookup
"RTN","ECXNDC",30,0)
 K DUOUT,DTOUT
"RTN","ECXNDC",31,0)
 W !!!,"Enter 12 numeric characters at the prompt or <cr> to exit.",!
"RTN","ECXNDC",32,0)
 S DIC=50,DIC(0)="QEA",D="NDC",DIC("A")="Select NDC: "
"RTN","ECXNDC",33,0)
 D MIX^DIC1
"RTN","ECXNDC",34,0)
 Q:Y<0  Q:($D(DUOUT)!$D(DTOUT))
"RTN","ECXNDC",35,0)
 S DRG=+Y
"RTN","ECXNDC",36,0)
 S DA=DRG,DR=".01;2;31;14.5;16",DIQ="ECXDIQ",DIQ(0)="E" D EN^DIQ1
"RTN","ECXNDC",37,0)
 K LN S DRGNM=ECXDIQ(50,DRG,.01,"E"),$P(LN,"-",$L(DRGNM)+1)=""
"RTN","ECXNDC",38,0)
 W !!,DRGNM,!,LN
"RTN","ECXNDC",39,0)
 W !,"NDC:           ",ECXDIQ(50,DRG,31,"E"),?40,"VA Classification:       ",ECXDIQ(50,DRG,2,"E")
"RTN","ECXNDC",40,0)
 W !,"Dispense Unit: ",ECXDIQ(50,DRG,14.5,"E"),?40,"Price per Dispense Unit: ",ECXDIQ(50,DRG,16,"E")
"RTN","ECXNDC",41,0)
 K ECXDIQ,X,Y,DIC,DA,DR,DIQ,DRG,ECXDIQ
"RTN","ECXNDC",42,0)
 G ASK
"RTN","ECXNDC",43,0)
 ;
"RTN","ECXNDC",44,0)
NDF3 ;before ndf v4
"RTN","ECXNDC",45,0)
 S QFLG=0
"RTN","ECXNDC",46,0)
 W !!,"Your site is running NATIONAL DRUG FILE (NDF) v3.18, so"
"RTN","ECXNDC",47,0)
 W !,"PHA Feeder Keys are composed of 19 numeric characters."
"RTN","ECXNDC",48,0)
 W !!?5,"Ex. ""0016006000003073531""   where characters:"
"RTN","ECXNDC",49,0)
 W !!?5,"1-4 (0016)          = pointer to the NATIONAL DRUG file (#50.6)"
"RTN","ECXNDC",50,0)
 W !?5,"5-7 (006)           = pointer to VA PRODUCT NAME subfile (#50.68)"
"RTN","ECXNDC",51,0)
 W !?5,"                      of the NATIONAL DRUG file (#50.6)"
"RTN","ECXNDC",52,0)
 W !?5,"8-19 (000003073531) = NDC from the local DRUG file (#50)"
"RTN","ECXNDC",53,0)
 I $E(IOST)="C" D
"RTN","ECXNDC",54,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXNDC",55,0)
 .S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXNDC",56,0)
 Q
"RTN","ECXNDC",57,0)
 ;
"RTN","ECXNDC",58,0)
NDF4 ;after ndf v4
"RTN","ECXNDC",59,0)
 S QFLG=0
"RTN","ECXNDC",60,0)
 W !!,"Your site is running NATIONAL DRUG FILE (NDF) v4.0."
"RTN","ECXNDC",61,0)
 W !,"If Pharmacy data is dated after September 30, 1998,"
"RTN","ECXNDC",62,0)
 W !,"then PHA Feeder Keys are composed of 17 numeric characters."
"RTN","ECXNDC",63,0)
 W !!?5,"Ex. ""12006000003073531""   where characters:"
"RTN","ECXNDC",64,0)
 W !?5,"1-5 (12006)         = pointer to VA PRODUCT NAME file (#50.68)"
"RTN","ECXNDC",65,0)
 W !?5,"6-17 (000003073531) = NDC from the local DRUG file (#50)"
"RTN","ECXNDC",66,0)
 W !!,"If Pharmacy data is dated prior to October 1, 1998,"
"RTN","ECXNDC",67,0)
 W !,"then PHA Feeder Keys are composed of 19 numeric characters."
"RTN","ECXNDC",68,0)
 W !!?5,"Ex. ""0016006000003073531""   where characters:"
"RTN","ECXNDC",69,0)
 W !!?5,"1-4 (0016)          = pointer to the NATIONAL DRUG file (#50.6)"
"RTN","ECXNDC",70,0)
 W !?5,"5-7 (006)           = pointer to VA PRODUCT NAME subfile (#50.68)"
"RTN","ECXNDC",71,0)
 W !?5,"                      of the NATIONAL DRUG file (#50.6)"
"RTN","ECXNDC",72,0)
 W !?5,"8-19 (000003073531) = NDC from the local DRUG file (#50)"
"RTN","ECXNDC",73,0)
 I $E(IOST)="C" D
"RTN","ECXNDC",74,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXNDC",75,0)
 .S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXNDC",76,0)
 Q
"RTN","ECXOPRX")
0^6^B21310977
"RTN","ECXOPRX",1,0)
ECXOPRX ;BIR/DMA,CML,PTD-Prescription Extract for DSS ; [ 03/26/97  2:09 PM ]
"RTN","ECXOPRX",2,0)
 ;;3.0;DSS EXTRACTS;**10,11**;Dec 22, 1997
"RTN","ECXOPRX",3,0)
 ;
"RTN","ECXOPRX",4,0)
BEG ;entry point from option
"RTN","ECXOPRX",5,0)
 D SETUP,^ECXTRAC
"RTN","ECXOPRX",6,0)
 D ^ECXKILL
"RTN","ECXOPRX",7,0)
 Q
"RTN","ECXOPRX",8,0)
START ;entry when queued
"RTN","ECXOPRX",9,0)
 S QFLG=0
"RTN","ECXOPRX",10,0)
 I '$D(ECINST) D
"RTN","ECXOPRX",11,0)
 .S ECINST=+$P(^ECX(728,1,0),"^") K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXOPRX",12,0)
 .D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXOPRX",13,0)
 S ECPROF=6 ;before V6
"RTN","ECXOPRX",14,0)
 S ECD=$O(^PSRX("AL",0)) I ECD,ECD<ECSD1 G V6
"RTN","ECXOPRX",15,0)
 S ECED=ECED+.3,ECREF=1,ECD=ECSD1
"RTN","ECXOPRX",16,0)
 F  S ECD=$O(^PSRX("AD",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  F  S ECRX=$O(^PSRX("AD",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AD",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",17,0)
 Q
"RTN","ECXOPRX",18,0)
 ;
"RTN","ECXOPRX",19,0)
V6 S ECPROF=2 ; version 6 or better
"RTN","ECXOPRX",20,0)
 S ECED=ECED+.3,ECREF=1,ECD=ECSD1 F  S ECD=$O(^PSRX("AL",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  F  S ECRX=$O(^PSRX("AL",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AL",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",21,0)
 S ECREF="P",ECD=ECSD1 F  S ECD=$O(^PSRX("AM",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  F  S ECRX=$O(^PSRX("AM",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AM",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",22,0)
 Q
"RTN","ECXOPRX",23,0)
 ;
"RTN","ECXOPRX",24,0)
STUFF ;
"RTN","ECXOPRX",25,0)
 S ECTM=$$ECXTIME^ECXUTL(ECD),ECDATA=^PSRX(ECRX,0) I ECRFL S ECDATA1=$G(^PSRX(ECRX,ECREF,ECRFL,0)) I ECDATA1="" Q
"RTN","ECXOPRX",26,0)
 ;ecref set to 1 in extract+5 and v6+1 and to "P" in v6+2
"RTN","ECXOPRX",27,0)
 ;refill nodes and partial nodes are identical in layout
"RTN","ECXOPRX",28,0)
 ;fills and refills from the "AL" cross-reference, partials from the "AM"
"RTN","ECXOPRX",29,0)
 S ECDFN=$P(ECDATA,"^",2),ECPRO=ECPROF_$P(ECDATA,"^",4),ECPRC=$P(ECDATA,"^",17),ECDRG=+$P(ECDATA,"^",6) Q:'$D(^DPT(+ECDFN,0))  S SSN=$P(^(0),"^",9),ECPT=$E($P($P(^(0),"^"),",")_"    ",1,4) D INP
"RTN","ECXOPRX",30,0)
 S DOB=$$ECXDOB^ECXUTL($P(^DPT(ECDFN,0),"^",3)),VET=$P($G(^("VET")),"^"),D1=$P($G(^DIC(8,+$G(^DPT(ECDFN,.36)),0)),"^",9) I D1 S D1=$C(D1+64)
"RTN","ECXOPRX",31,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(ECDFN,ECD)
"RTN","ECXOPRX",32,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXOPRX",33,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(ECDFN,ECD)
"RTN","ECXOPRX",34,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXOPRX",35,0)
 I 'ECRFL S ECMW=$P(ECDATA,"^",11),ECQTY=+$P(ECDATA,"^",7),ECDIV=$S($D(^PSRX(ECRX,2)):$P(^(2),"^",9),1:1),ECOPAY=$P($G(^PSRX(ECRX,"IB")),"^",2)]""
"RTN","ECXOPRX",36,0)
 E  S ECMW=$P(ECDATA1,"^",2),ECQTY=+$P(ECDATA1,"^",4),ECDIV=$S(+$P(ECDATA1,"^",9):$P(ECDATA1,"^",9),1:1),ECPRC=+$P(ECDATA1,"^",11),ECOPAY=$P($G(^PSRX(ECRX,1,ECRFL,"IB")),"^")]"" D
"RTN","ECXOPRX",37,0)
 .S:$P(ECDATA1,"^",17)]"" ECPRO=ECPROF_$P(ECDATA1,"^",17)
"RTN","ECXOPRX",38,0)
 S ECDS=$S(ECRFL:$P(ECDATA1,"^",10),1:$P(ECDATA,"^",8))
"RTN","ECXOPRX",39,0)
 S ECCAT=$P(^PSDRUG(ECDRG,0),"^",2),ECINV=$P(^(0),"^",3)["I",ECINV=$S(ECINV:"I",1:"")
"RTN","ECXOPRX",40,0)
 S ECUI=$P($G(^PSDRUG(ECDRG,660)),"^",8)
"RTN","ECXOPRX",41,0)
 S ECNDC=$P($G(^PSDRUG(ECDRG,2)),"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXOPRX",42,0)
 S ECNDF=$G(^PSDRUG(ECDRG,"ND")),P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXOPRX",43,0)
 S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXOPRX",44,0)
 I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXOPRX",45,0)
 S ECODE=ECINST_"^"_ECDFN_"^"_SSN_"^"_ECPT_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECDIV_"^"_ECPRO_"^"_ECCAT_"^^^^^"_ECQTY_"^"_(ECQTY*ECPRC)_"^^"_ECMN_"^"_ECTS_"^^"_ECUI_"^"_DOB_"^"_D1_"^"_VET_"^"_ECOPAY_"^"_ECNFC_"^"_ECINV_"^"_ECDS
"RTN","ECXOPRX",46,0)
 I ECMW="M" S $P(ECODE,"^",10)=1 I $D(^PSRX("AR",ECD,ECRX)) S $P(ECODE,"^",10)=2
"RTN","ECXOPRX",47,0)
 I ECRFL=0 S $P(ECODE,"^",12)=1
"RTN","ECXOPRX",48,0)
 S ECODE=ECODE_"^"_ECPTTM_"^"_ECPTPR_"^"_ECTM_"^"_$P($G(^DIC(10,+$P(^DPT(ECDFN,0),"^",6),0)),"^",2)_"^"
"RTN","ECXOPRX",49,0)
 ;inst^dfn^ssn^name^in/out^day^division^provider^drug category^mail^placeholder1^new^placeholder2^qty^cost^placeholder3^
"RTN","ECXOPRX",50,0)
 ;mov #^treat spec^placeholder4^unit of issue^dob^elig^vet^copay^feeder key^investigational^days supply^primary care team^primary care provider^time^race
"RTN","ECXOPRX",51,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXOPRX",52,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX(ECFILE," D IX^DIK K DIK,DA
"RTN","ECXOPRX",53,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXOPRX",54,0)
 Q
"RTN","ECXOPRX",55,0)
 ;
"RTN","ECXOPRX",56,0)
SETUP S ECPACK="Prescription",ECPIECE=2,ECRTN="START^ECXOPRX",ECGRP="PRES",ECHEAD="PRE",ECFILE=727.81,ECVER=7
"RTN","ECXOPRX",57,0)
 Q
"RTN","ECXOPRX",58,0)
 ;
"RTN","ECXOPRX",59,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXOPRX",60,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECD,DFN=+ECDFN D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXOPRX",61,0)
 K VAIP,VAERR
"RTN","ECXOPRX",62,0)
 Q
"RTN","ECXOPRX",63,0)
 ;
"RTN","ECXOPRX",64,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXOPRX",65,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXPIVD")
0^7^B16993297
"RTN","ECXPIVD",1,0)
ECXPIVD ;BIR/DMA,CML,PTD-Extract from IV STATS File (#50.8) ; [ 12/05/96  10:41 AM ]
"RTN","ECXPIVD",2,0)
 ;;3.0;DSS EXTRACTS;**10,11**;Dec 22, 1997
"RTN","ECXPIVD",3,0)
BEG ;entry point from option
"RTN","ECXPIVD",4,0)
 D SETUP,^ECXTRAC,^ECXKILL
"RTN","ECXPIVD",5,0)
 Q
"RTN","ECXPIVD",6,0)
 ;
"RTN","ECXPIVD",7,0)
START ; start package specific extract
"RTN","ECXPIVD",8,0)
 S QFLG=0
"RTN","ECXPIVD",9,0)
 S ECED=ECED+.3
"RTN","ECXPIVD",10,0)
 K ^TMP($J)
"RTN","ECXPIVD",11,0)
 S ECIV=0 F  S ECIV=$O(^PS(50.8,ECIV)),ECD=ECSD1 Q:'ECIV  F  S ECD=$O(^PS(50.8,ECIV,2,ECD)) Q:'ECD  Q:ECD>ECED  K ^TMP($J) D  Q:QFLG
"RTN","ECXPIVD",12,0)
 .;go thru AC crossreference to get pointers to 52.6 and 52.7
"RTN","ECXPIVD",13,0)
 .F ECJ=52.6,52.7 S ECK=0 F  S ECK=$O(^PS(50.8,ECIV,2,ECD,2,"AC",ECJ,ECK)),ECL=0 Q:'ECK  F   S ECL=$O(^PS(50.8,ECIV,2,ECD,2,"AC",ECJ,ECK,ECL)) Q:'ECL  S ^TMP($J,ECL,ECK)=""
"RTN","ECXPIVD",14,0)
 .S ECI=0 F  S ECI=$O(^PS(50.8,ECIV,2,ECD,2,ECI)) Q:'ECI  I $D(^(ECI,0)) S ECC=$P(^(0),"^",5),ECF=+$P(^(0),"^",7),ECDRG=+$O(^TMP($J,ECI,0)),EC50=+$P($G(^PS(ECF,ECDRG,0)),"^",2) D  Q:QFLG
"RTN","ECXPIVD",15,0)
 ..S ECCAT=$P($G(^PSDRUG(EC50,0)),"^",2),ECNDC=$P($G(^(2)),"^",4),ECNDF=$G(^("ND")),ECINV=$P(^(0),"^",3),ECINV=$S(ECINV["I":"I",1:"")
"RTN","ECXPIVD",16,0)
 ..S ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXPIVD",17,0)
 ..S P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXPIVD",18,0)
 ..S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXPIVD",19,0)
 ..I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXPIVD",20,0)
 ..S ECDFN=0 F  S ECDFN=$O(^PS(50.8,ECIV,2,ECD,2,ECI,1,ECDFN)) Q:'ECDFN  I $D(^(ECDFN,0)) S EC=^(0),ECQ=$P(EC,"^",2)-$P(EC,"^",3)-$P(EC,"^",6),ECCS=ECQ*ECC,ECW=$P(EC,"^",5) I ECQ D  Q:QFLG
"RTN","ECXPIVD",21,0)
 ...I $D(^DPT(ECDFN,0)) S EC1=^(0),ECODE=ECINST_"^"_ECDFN_"^"_$P(EC1,"^",9)_"^"_$E($P($P(EC1,"^"),",")_"    ",1,4)_"^"_$S(ECW=.5:1,1:3)_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECCAT_"^"_ECQ,(ECWD,ECMN,ECTS,ECADM)="" D
"RTN","ECXPIVD",22,0)
 ....S ECPTTM=+$$OUTPTTM^ECXUTL3(ECDFN,ECD)
"RTN","ECXPIVD",23,0)
 ....S:ECPTTM=0 ECPTTM=""
"RTN","ECXPIVD",24,0)
 ....S ECPTPR=+$$OUTPTPR^ECXUTL3(ECDFN,ECD)
"RTN","ECXPIVD",25,0)
 ....S:ECPTPR=0 ECPTPR=""
"RTN","ECXPIVD",26,0)
 ....I ECW=.5 S ECWD="CLI"
"RTN","ECXPIVD",27,0)
 ....E  S ECWD=$P($G(^DIC(42,+ECW,44)),"^") K VAIP S VAIP("D")=ECD,DFN=ECDFN D IN5^VADPT S ECMN=VAIP(1),ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2) S:+VAIP(13) ECADM=$P(^DGPM(+VAIP(13),0),"^") K VAIP
"RTN","ECXPIVD",28,0)
 ....S ECODE=ECODE_"^"_ECWD_"^"_ECCS_"^"_ECMN_"^"_ECTS_"^"_ECNDC_"^"_ECINV_"^^^^"_ECPTTM_"^"_ECPTPR_"^000000^"_$$ECXDATE^ECXUTL(ECADM,ECXYM)_"^"_$$ECXTIME^ECXUTL(ECADM)_"^^"
"RTN","ECXPIVD",29,0)
 ....;if this is an outpatient, send null for admission date and "000000" for admission time
"RTN","ECXPIVD",30,0)
 ....I ECW=.5 S $P(ECODE,"^",21)="",$P(ECODE,"^",22)="000000"
"RTN","ECXPIVD",31,0)
 ....;fac^dfn^ssn^name^i/o^day^va class^qty^ward^cost^movement #^treat spec^ndc^investigational^iv dispensing fee^new feeder key^total doses^primary care team^primary care provider^IVP time^adm date^adm time^dss identifier
"RTN","ECXPIVD",32,0)
 ....S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXPIVD",33,0)
 ....S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXPIVD",34,0)
 ....I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXPIVD",35,0)
 Q
"RTN","ECXPIVD",36,0)
 ;
"RTN","ECXPIVD",37,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXPIVD",38,0)
 S ECPACK="IVs (detail)",ECPIECE=19,ECRTN="START^ECXPIVD",ECGRP="IV",ECHEAD="IVP",ECFILE=727.819,ECVER=3
"RTN","ECXPIVD",39,0)
 Q
"RTN","ECXPIVD",40,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXPIVD",41,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXPIVDN")
0^8^B22589671
"RTN","ECXPIVDN",1,0)
ECXPIVDN ;BIR/DMA,CML,PTD-Extract from IV EXTRACT DATA File (#728.113) ; [ 03/26/97  2:10 PM ]
"RTN","ECXPIVDN",2,0)
 ;;3.0;DSS EXTRACTS;**10,11**;Dec 22, 1997
"RTN","ECXPIVDN",3,0)
START ; start package specific extract
"RTN","ECXPIVDN",4,0)
 S QFLG=0
"RTN","ECXPIVDN",5,0)
 I '$D(ECINST) D
"RTN","ECXPIVDN",6,0)
 .S ECINST=+$P(^ECX(728,1,0),"^") K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPIVDN",7,0)
 .D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPIVDN",8,0)
 S ECED=ECED+.3
"RTN","ECXPIVDN",9,0)
 K ^TMP($J)
"RTN","ECXPIVDN",10,0)
 S ECD=ECSD1
"RTN","ECXPIVDN",11,0)
 F  S ECD=$O(^ECX(728.113,"A",ECD)),DFN=0 Q:'ECD  Q:ECD>ECED  F  S DFN=$O(^ECX(728.113,"A",ECD,DFN)),ON=0  Q:'DFN  I $D(^DPT(DFN,0)) S EC=^(0) D DEMOG F  S ON=$O(^ECX(728.113,"A",ECD,DFN,ON)),DA=0 Q:'ON  K ^TMP($J) S ECVOL=0 D  Q:QFLG
"RTN","ECXPIVDN",12,0)
 .F  S DA=$O(^ECX(728.113,"A",ECD,DFN,ON,DA)) Q:'DA  I $D(^ECX(728.113,DA,0)) S EC=^(0) D  Q:QFLG
"RTN","ECXPIVDN",13,0)
 ..S DRG=$P(EC,"^",4) I $P(EC,"^",8)]"" D
"RTN","ECXPIVDN",14,0)
 ...I '$D(^TMP($J,"A",DRG)) S ^(DRG)=$P(EC,"^",7,8),^(DRG,1)=0,^(2)=$P(EC,"^",12)
"RTN","ECXPIVDN",15,0)
 ...S ^(1)=^TMP($J,"A",DRG,1)+$S($P(EC,"^",6)=1:1,$P(EC,"^",6)=4:0,1:-1)
"RTN","ECXPIVDN",16,0)
 ..I $P(EC,"^",9) D
"RTN","ECXPIVDN",17,0)
 ...I '$D(^TMP($J,"S",DRG)) S ^(DRG)=$P(EC,"^",9)_"^ML",^(DRG,1)=0,^(2)=$P(EC,"^",12),ECVOL=$P(EC,"^",9)+ECVOL
"RTN","ECXPIVDN",18,0)
 ...S ^(1)=^TMP($J,"S",DRG,1)+$S($P(EC,"^",6)=1:1,$P(EC,"^",6)=4:0,1:-1)
"RTN","ECXPIVDN",19,0)
 ..S ECPRO=$P(EC,"^",10),ECTYP=$P(EC,"^",11),ECTOTC=0,ECDTTM=$$ECXTIME^ECXUTL($P(EC,"^",5))
"RTN","ECXPIVDN",20,0)
 .;looped thru all DAs for this order - now put it together
"RTN","ECXPIVDN",21,0)
 .;leave the next line in case the decision is made to send volume designations
"RTN","ECXPIVDN",22,0)
 .;I ECTYP="H" S ECTYP=ECTYP_$S(ECVOL'>1000:1,ECVOL'>2000:2,1:3)
"RTN","ECXPIVDN",23,0)
 .F SA="S","A" S DRG="" F  S DRG=$O(^TMP($J,SA,DRG)) Q:DRG=""  S ECST=^(DRG),CNT=^(DRG,1),COST=^(2),ECTOTC=ECTOTC+COST,COST=COST*CNT I $D(^PSDRUG(DRG,0)) S EC0=^(0),EC2=$G(^(2)),ECND=$G(^("ND")) D  Q:QFLG
"RTN","ECXPIVDN",24,0)
 ..S ECDIV=""
"RTN","ECXPIVDN",25,0)
 ..I ECA=1,$D(^PS(55,DFN,"IV",ON,2)) S ECIVRM=$P(^(2),"^",2),ECDIV=$P(^PS(59.5,ECIVRM,0),"^",4)
"RTN","ECXPIVDN",26,0)
 ..I ECA=3 S ECDIV=$P(^SC(ECW,0),"^",15)
"RTN","ECXPIVDN",27,0)
 ..S ECODE=ECDIV_"^"_DFN_"^"_SSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_$P(EC0,"^",2)_"^"_CNT_"^"_ECW_"^"_COST_"^"_ECMN_"^"_ECTS_"^"
"RTN","ECXPIVDN",28,0)
 ..S ECINV=$P(EC0,"^",3),ECINV=$S(ECINV["I":"I",1:"")
"RTN","ECXPIVDN",29,0)
 ..S ECST=CNT*ECST_" "_$P(ECST,"^",2)
"RTN","ECXPIVDN",30,0)
 ..S ECNDC=$P(EC2,"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXPIVDN",31,0)
 ..S P1=$P(ECND,"^"),P3=$P(ECND,"^",3)
"RTN","ECXPIVDN",32,0)
 ..S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXPIVDN",33,0)
 ..I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXPIVDN",34,0)
 ..S ECODE=ECODE_ECNDC_"^"_ECINV_"^"_ECTYP_"^"_ECNFC_"^"_ECST_"^"_ECPTTM_"^"_ECPTPR_"^"_ECDTTM_"^"_$$ECXDATE^ECXUTL(ECADM,ECXYM)_"^"_$$ECXTIME^ECXUTL(ECADM)_"^^"
"RTN","ECXPIVDN",35,0)
 ..;if this is an outpatient, send null for admission date and "000000" for admission time
"RTN","ECXPIVDN",36,0)
 ..I ECA=1 S $P(ECODE,"^",21)="",$P(ECODE,"^",22)="000000"
"RTN","ECXPIVDN",37,0)
 ..;facility^dfn^ssn^name^in/out pat^day^VA class^qty^ward^cost^movement #^treating specialty^ndc^investigational^dispensing fee^new feeder key^total doses per day^primary care team^primary care provider^IVP time^adm date^adm time^dss identifier
"RTN","ECXPIVDN",38,0)
 ..S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXPIVDN",39,0)
 ..S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXPIVDN",40,0)
 ..I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXPIVDN",41,0)
 K ^TMP($J),CNT,COST,DA,DFN,DIC,DIK,DRG,EC,EC0,EC2,EC7,EC8,ECA,ECD,ECDA,ECINV,ECMN,ECNA,ECND,ECNDC,ECNFC,ECPRO,ECST,ECTOTC,ECTS,ECTSR,ECTYP,ECVOL,ECW,ECWR,ON,SA,SSN,X,Y
"RTN","ECXPIVDN",42,0)
 Q
"RTN","ECXPIVDN",43,0)
 ;
"RTN","ECXPIVDN",44,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXPIVDN",45,0)
 S ECPACK="IVs (detail)",ECPIECE=19,ECRTN="START^ECXPIVDN",ECGRP="IV",ECHEAD="IVP",ECFILE=727.819,ECVER=7
"RTN","ECXPIVDN",46,0)
 Q
"RTN","ECXPIVDN",47,0)
 ;
"RTN","ECXPIVDN",48,0)
DEMOG ;new patient - get primary care team and provider, name, SSN, and VAIP
"RTN","ECXPIVDN",49,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXPIVDN",50,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXPIVDN",51,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECD)
"RTN","ECXPIVDN",52,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXPIVDN",53,0)
 S SSN=$P(EC,"^",9),ECNA=$E($P($P(EC,"^"),",")_"    ",1,4)
"RTN","ECXPIVDN",54,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXPIVDN",55,0)
 S ECA=1,(ECTS,ECADM)="",ECW=.5,(ECWR,ECTSR)="OUTPATIENT" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1)
"RTN","ECXPIVDN",56,0)
 I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2),ECW=+$G(^DIC(42,+VAIP(5),44)),ECWR=$P(VAIP(5),"^",2),ECTSR=$P(VAIP(8),"^",2)
"RTN","ECXPIVDN",57,0)
 I +VAIP(13) S ECADM=$P(^DGPM(+VAIP(13),0),"^")
"RTN","ECXPIVDN",58,0)
 K VAIP,VAERR
"RTN","ECXPIVDN",59,0)
 Q
"RTN","ECXPIVDN",60,0)
 ;
"RTN","ECXPIVDN",61,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXPIVDN",62,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXPRO1")
0^9^B31322317
"RTN","ECXPRO1",1,0)
ECXPRO1 ;ALB/GTS - Prosthetics Extract for DSS (Continued) ; July 16, 1998
"RTN","ECXPRO1",2,0)
 ;;3.0;DSS EXTRACTS;**9,11**;Dec 22, 1997
"RTN","ECXPRO1",3,0)
 ;
"RTN","ECXPRO1",4,0)
NTEG(ECXLNE,ECXPIEN,ECXN0,ECXNLB,ECINST) ;** Check for required fields
"RTN","ECXPRO1",5,0)
 ;
"RTN","ECXPRO1",6,0)
 ;   Input
"RTN","ECXPRO1",7,0)
 ;    ECXLNE   - The line number variable (passed by reference)
"RTN","ECXPRO1",8,0)
 ;    ECXPIEN  - The IEN for the Prosthetics record
"RTN","ECXPRO1",9,0)
 ;    ECXN0    - The zero node of the Prosthetics record
"RTN","ECXPRO1",10,0)
 ;    ECXNLB   - The LB node of the Prosthetics record
"RTN","ECXPRO1",11,0)
 ;    ECINST   - The Station number being extracted
"RTN","ECXPRO1",12,0)
 ;
"RTN","ECXPRO1",13,0)
 ;   Output (to be KILLed by calling routine)
"RTN","ECXPRO1",14,0)
 ;    ^TMP("ECX-PRO EXC",$J) - Array for the exception message       
"RTN","ECXPRO1",15,0)
 ;    ECXLNE                 - The number of the next line in the msg
"RTN","ECXPRO1",16,0)
 ;    DFN                    - Patient's IEN in the Patient file
"RTN","ECXPRO1",17,0)
 ;    ECXNA                  - 1st four character of patient's last name
"RTN","ECXPRO1",18,0)
 ;    ECXSSN                 - Patients Social Security number
"RTN","ECXPRO1",19,0)
 ;    ECXSTAT                - Patient Station Number
"RTN","ECXPRO1",20,0)
 ;    ECXDTSVC               - Delivery Date of Prosthesis
"RTN","ECXPRO1",21,0)
 ;    ECXTYPE                - Type of Transaction work performed
"RTN","ECXPRO1",22,0)
 ;    ECXSRCE                - Source of prosthesis
"RTN","ECXPRO1",23,0)
 ;    ECXHCPCS               - HCPCS code for prosthesis
"RTN","ECXPRO1",24,0)
 ;    ECXRQST                - Requesting Station
"RTN","ECXPRO1",25,0)
 ;    ECXRCST                - Receiving Station
"RTN","ECXPRO1",26,0)
 ;    ECXFORM                - The Form Requested On
"RTN","ECXPRO1",27,0)
 ;
"RTN","ECXPRO1",28,0)
 ;   Output (KILLed by NTEG)
"RTN","ECXPRO1",29,0)
 ;    ECXMIS                 - 1 indicates missing information
"RTN","ECXPRO1",30,0)
 ;
"RTN","ECXPRO1",31,0)
 N ECXGOOD,ECXMISS
"RTN","ECXPRO1",32,0)
 S (ECXRCST,ECXRQST)=""
"RTN","ECXPRO1",33,0)
 S ECXMISS=""
"RTN","ECXPRO1",34,0)
 S ECXGOOD=1
"RTN","ECXPRO1",35,0)
 ;
"RTN","ECXPRO1",36,0)
 ;* Get Facility Station Number
"RTN","ECXPRO1",37,0)
 S ECXSTAT=$P(ECXN0,"^",10)
"RTN","ECXPRO1",38,0)
 I ECXSTAT]"" DO
"RTN","ECXPRO1",39,0)
 .K ECXDIC S DA=ECXSTAT,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPRO1",40,0)
 .D EN^DIQ1 S ECXSTAT=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPRO1",41,0)
 ;
"RTN","ECXPRO1",42,0)
 ;** Screen out records
"RTN","ECXPRO1",43,0)
 S:($P(ECXN0,"^",17)'="") ECXGOOD=0 ;*SHIP/DEL is not NULL
"RTN","ECXPRO1",44,0)
 S:($P(ECXN0,"^",26)'="") ECXGOOD=0 ;*PICKUP/DEL is not NULL
"RTN","ECXPRO1",45,0)
 S:(+($P($G(^RMPR(660,ECXPIEN,"AM")),"^",2))=1) ECXGOOD=0 ;*NO ADMIN CT=1
"RTN","ECXPRO1",46,0)
 S:(($P(ECXN0,"^",15))'="") ECXGOOD=0 ;*HISTORICAL DATA is not NULL
"RTN","ECXPRO1",47,0)
 ;
"RTN","ECXPRO1",48,0)
 S DFN=$P(ECXN0,"^",2)
"RTN","ECXPRO1",49,0)
 S ECXSSN=$P($G(^DPT(+DFN,0)),"^",9)
"RTN","ECXPRO1",50,0)
 S ECXNA=$E($P($P($G(^DPT(+DFN,0)),"^"),",")_"    ",1,4)
"RTN","ECXPRO1",51,0)
 S ECXDTSVC=$P(ECXN0,"^",12)
"RTN","ECXPRO1",52,0)
 S ECXTYPE=$P(ECXN0,"^",4)
"RTN","ECXPRO1",53,0)
 S ECXSRCE=$P(ECXN0,"^",14)
"RTN","ECXPRO1",54,0)
 S ECXHCPCS=$P($G(^ICPT(+$P(ECXN0,"^",22),0)),"^",1)
"RTN","ECXPRO1",55,0)
 S ECXFORM=$P(ECX0,"^",13)
"RTN","ECXPRO1",56,0)
 ;
"RTN","ECXPRO1",57,0)
 ;* Get Requesting Station Number
"RTN","ECXPRO1",58,0)
 I +ECXFORM=4 DO
"RTN","ECXPRO1",59,0)
 .S ECXRQST=$P(ECXNLB,"^",1)
"RTN","ECXPRO1",60,0)
 .I ECXRQST]"" DO
"RTN","ECXPRO1",61,0)
 ..S DA=ECXRQST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPRO1",62,0)
 ..D EN^DIQ1 S ECXRQST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPRO1",63,0)
 S:(+ECXFORM'=4) ECXRQST=""
"RTN","ECXPRO1",64,0)
 ;
"RTN","ECXPRO1",65,0)
 ;* Screen out records
"RTN","ECXPRO1",66,0)
 S:(+ECXFORM=13) ECXGOOD=0 ;*FORM REQUESTED ON = 13
"RTN","ECXPRO1",67,0)
 ;
"RTN","ECXPRO1",68,0)
 ;* Get Receiving Station Number
"RTN","ECXPRO1",69,0)
 I +ECXFORM=4 DO
"RTN","ECXPRO1",70,0)
 .S ECXRCST=$P(ECXNLB,"^",4)
"RTN","ECXPRO1",71,0)
 .I ECXRCST]"" DO
"RTN","ECXPRO1",72,0)
 ..S DA=ECXRCST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPRO1",73,0)
 ..D EN^DIQ1 S ECXRCST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPRO1",74,0)
 S:(+ECXFORM'=4) ECXRCST=""
"RTN","ECXPRO1",75,0)
 ;
"RTN","ECXPRO1",76,0)
 ;** Check for integrity and set up the problem variable if right DIV
"RTN","ECXPRO1",77,0)
 I ECXGOOD DO
"RTN","ECXPRO1",78,0)
 .I ECXSTAT']"" DO
"RTN","ECXPRO1",79,0)
 ..S ECXMISS="1"
"RTN","ECXPRO1",80,0)
 ..D CHK ;* Set ECXGOOD
"RTN","ECXPRO1",81,0)
 .I ECXSTAT]"" DO
"RTN","ECXPRO1",82,0)
 ..S:(ECINST'=$E(ECXSTAT,1,3)) ECXGOOD=0 ;*Screen for incorrect Station
"RTN","ECXPRO1",83,0)
 ..D:(ECXGOOD=1) CHK ;* Set ECXGOOD
"RTN","ECXPRO1",84,0)
 Q ECXGOOD
"RTN","ECXPRO1",85,0)
 ;
"RTN","ECXPRO1",86,0)
CHK ;*Check variables
"RTN","ECXPRO1",87,0)
 ;
"RTN","ECXPRO1",88,0)
 ; Input
"RTN","ECXPRO1",89,0)
 ;  Variables set in and Output from NTEG^ECXPRO1
"RTN","ECXPRO1",90,0)
 ;
"RTN","ECXPRO1",91,0)
 ; Output
"RTN","ECXPRO1",92,0)
 ;  ^TMP("ECX-PRO EXC",$J,   - Global of records with integrity problems
"RTN","ECXPRO1",93,0)
 ;
"RTN","ECXPRO1",94,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",95,0)
 I DFN']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",96,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",97,0)
 I ECXSSN']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",98,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",99,0)
 I ECXNA="    " S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",100,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",101,0)
 I ECXDTSVC']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",102,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",103,0)
 I ECXTYPE']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",104,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",105,0)
 I ECXSRCE']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",106,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",107,0)
 I ECXHCPCS']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",108,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",109,0)
 I +ECXFORM=4 DO
"RTN","ECXPRO1",110,0)
 .I ECXRQST']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",111,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",112,0)
 I ECXFORM']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",113,0)
 S ECXMISS=ECXMISS_"^"
"RTN","ECXPRO1",114,0)
 I +ECXFORM=4 DO
"RTN","ECXPRO1",115,0)
 .I ECXRCST']"" S ECXMISS=ECXMISS_"1"
"RTN","ECXPRO1",116,0)
 I ECXMISS'="^^^^^^^^^^" DO
"RTN","ECXPRO1",117,0)
 .S ECXGOOD=0
"RTN","ECXPRO1",118,0)
 .D ECXMISLN^ECXPRO2(ECXMISS,.ECXLNE,ECXPIEN)
"RTN","ECXPRO1",119,0)
 Q
"RTN","ECXPRO1",120,0)
 ;
"RTN","ECXPRO1",121,0)
PROSINFO(ECXDA,ECXLB,ECX0) ;*Get Prosthetics Information
"RTN","ECXPRO1",122,0)
 ;
"RTN","ECXPRO1",123,0)
 ;  Input
"RTN","ECXPRO1",124,0)
 ;    ECDA    - The IEN for the Prosthetics record
"RTN","ECXPRO1",125,0)
 ;    ECX0    - The zero node of the Prosthetics record
"RTN","ECXPRO1",126,0)
 ;    ECXLB   - The LB node of the Prosthetics record
"RTN","ECXPRO1",127,0)
 ;    ECXFORM - The Form Requested On (to determine Lab transactions)
"RTN","ECXPRO1",128,0)
 ;
"RTN","ECXPRO1",129,0)
 ;  Output (to be KILLed by calling routine)
"RTN","ECXPRO1",130,0)
 ;    ECXCTAMT   - The Cost of Transaction
"RTN","ECXPRO1",131,0)
 ;    ECXLLC     - The Lab Labor Cost
"RTN","ECXPRO1",132,0)
 ;    ECXLMC     - The Lab Material Cost
"RTN","ECXPRO1",133,0)
 ;    ECXGRPR    - The AMIS Grouper number
"RTN","ECXPRO1",134,0)
 ;    ECXBILST   - The Billing Status
"RTN","ECXPRO1",135,0)
 ;    ECXQTY     - The Quantity
"RTN","ECXPRO1",136,0)
 ;
"RTN","ECXPRO1",137,0)
 S (ECXLLC,ECXLMC,ECXCTAMT)=""
"RTN","ECXPRO1",138,0)
 S ECXBILST=$P($G(^RMPR(660,ECXDA,"AM")),"^",3)
"RTN","ECXPRO1",139,0)
 S ECXQTY=$P(ECX0,"^",7)
"RTN","ECXPRO1",140,0)
 S:(+ECXQTY=0) ECXQTY=1
"RTN","ECXPRO1",141,0)
 S ECXGRPR=$P($G(^RMPR(660,ECXDA,"AMS")),"^",1)
"RTN","ECXPRO1",142,0)
 I +ECXFORM>0,(+ECXFORM<4) S ECXCTAMT=$P(ECX0,"^",16)
"RTN","ECXPRO1",143,0)
 I +ECXFORM>4,(+ECXFORM<13) S ECXCTAMT=$P(ECX0,"^",16)
"RTN","ECXPRO1",144,0)
 I +ECXFORM=14 S ECXCTAMT=$P(ECX0,"^",16)
"RTN","ECXPRO1",145,0)
 I +ECXFORM=4 DO
"RTN","ECXPRO1",146,0)
 .S ECXCTAMT=$P(ECXLB,"^",9)
"RTN","ECXPRO1",147,0)
 .S ECXLLC=$P(ECXLB,"^",7)
"RTN","ECXPRO1",148,0)
 .S ECXLMC=$P(ECXLB,"^",8)
"RTN","ECXPRO1",149,0)
 I ECXCTAMT="" S ECXCTAMT="0.00"
"RTN","ECXPRO1",150,0)
 I ECXLLC="" S ECXLLC="0.00"
"RTN","ECXPRO1",151,0)
 I ECXLMC="" S ECXLMC="0.00"
"RTN","ECXPRO1",152,0)
 ;
"RTN","ECXPRO1",153,0)
 ;* Add decimals if needed
"RTN","ECXPRO1",154,0)
 S:(ECXCTAMT'[".") ECXCTAMT=ECXCTAMT_".00"
"RTN","ECXPRO1",155,0)
 S:($L($P(ECXCTAMT,".",2))<2) $P(ECXCTAMT,".",2)=$$PAD^ECXUTL1($P(ECXCTAMT,".",2),2,"B","0")
"RTN","ECXPRO1",156,0)
 S:(ECXLLC'[".") ECXLLC=ECXLLC_".00"
"RTN","ECXPRO1",157,0)
 S:($L($P(ECXLLC,".",2))<2) $P(ECXLLC,".",2)=$$PAD^ECXUTL1($P(ECXLLC,".",2),2,"B","0")
"RTN","ECXPRO1",158,0)
 S:(ECXLMC'[".") ECXLMC=ECXLMC_".00"
"RTN","ECXPRO1",159,0)
 S:($L($P(ECXLMC,".",2))<2) $P(ECXLMC,".",2)=$$PAD^ECXUTL1($P(ECXLMC,".",2),2,"B","0")
"RTN","ECXPRO1",160,0)
 Q
"RTN","ECXPRO1",161,0)
 ;
"RTN","ECXPRO1",162,0)
PATINFO(ECXDELDT) ;* Get Patient Information
"RTN","ECXPRO1",163,0)
 ;
"RTN","ECXPRO1",164,0)
 ;  Input
"RTN","ECXPRO1",165,0)
 ;    ECXDELDT - The Delivery of the Prosthesis
"RTN","ECXPRO1",166,0)
 ;
"RTN","ECXPRO1",167,0)
 ;  Output (to be KILLed by calling routine)
"RTN","ECXPRO1",168,0)
 ;    ECXIOPT    - The In/Outpatient indicator
"RTN","ECXPRO1",169,0)
 ;    ECXPCT     - The Primary Care Team
"RTN","ECXPRO1",170,0)
 ;    ECXPCP     - The Primary Care Providor
"RTN","ECXPRO1",171,0)
 ;    ECXAO      - The Agent Orange indicator
"RTN","ECXPRO1",172,0)
 ;    ECXRE      - The Radiation Exposure indicator
"RTN","ECXPRO1",173,0)
 ;    ECXEC      - The Environmental Contaminants indicator
"RTN","ECXPRO1",174,0)
 ;    ECXELIG    - The veteran's eligibility
"RTN","ECXPRO1",175,0)
 ;    ECXVET     - The Vet/Non-Vet status
"RTN","ECXPRO1",176,0)
 ;    ECXZIP     - ZIP or ZIP+4
"RTN","ECXPRO1",177,0)
 ;    ECXDOB     - The patient's birth date
"RTN","ECXPRO1",178,0)
 ;    ECXSEX     - The Patient's Gender
"RTN","ECXPRO1",179,0)
 ;
"RTN","ECXPRO1",180,0)
 ;* Determine the In/Outpatient status
"RTN","ECXPRO1",181,0)
 S ECXDELDT=$P(ECXDELDT,".",1)
"RTN","ECXPRO1",182,0)
 S ECXIOPT=1
"RTN","ECXPRO1",183,0)
 K VAIP
"RTN","ECXPRO1",184,0)
 S VAIP("D")=ECXDELDT
"RTN","ECXPRO1",185,0)
 D IN5^VADPT
"RTN","ECXPRO1",186,0)
 I +VAIP(1)>0 S ECXIOPT=3
"RTN","ECXPRO1",187,0)
 K VAIP,VAERR
"RTN","ECXPRO1",188,0)
 ;
"RTN","ECXPRO1",189,0)
 ;* Determine primary care team/provider and eligibility
"RTN","ECXPRO1",190,0)
 S ECXPCT=+$$OUTPTTM^ECXUTL3(DFN,ECXDELDT)
"RTN","ECXPRO1",191,0)
 S:ECXPCT=0 ECXPCT=""
"RTN","ECXPRO1",192,0)
 S ECXPCP=+$$OUTPTPR^ECXUTL3(DFN,ECXDELDT)
"RTN","ECXPRO1",193,0)
 S:ECXPCP=0 ECXPCP=""
"RTN","ECXPRO1",194,0)
 S ECXELIG=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),"^",9)
"RTN","ECXPRO1",195,0)
 I ECXELIG S ECXELIG=$C(ECXELIG+64)
"RTN","ECXPRO1",196,0)
 ;
"RTN","ECXPRO1",197,0)
 ;* Determine Agent Orange, Radiation Exposure and Environment Contmnts
"RTN","ECXPRO1",198,0)
 S ECXAO=$P($G(^DPT(DFN,.321)),"^",2)
"RTN","ECXPRO1",199,0)
 S ECXRE=$P($G(^DPT(DFN,.321)),"^",3)
"RTN","ECXPRO1",200,0)
 S ECXEC=$P($G(^DPT(DFN,.322)),"^",13)
"RTN","ECXPRO1",201,0)
 ;
"RTN","ECXPRO1",202,0)
 ;* Get patient's Sex, Date of Birth, Zip Code and Vet/Non-Vet status
"RTN","ECXPRO1",203,0)
 S ECXSEX=$P(^DPT(DFN,0),"^",2)
"RTN","ECXPRO1",204,0)
 S:ECXSEX="" ECXSEX="U"
"RTN","ECXPRO1",205,0)
 S ECXDOB=$P(^DPT(DFN,0),"^",3)
"RTN","ECXPRO1",206,0)
 S ECXVET=$P($G(^DPT(DFN,"VET")),"^",1)
"RTN","ECXPRO1",207,0)
 S VAPA("P")=""
"RTN","ECXPRO1",208,0)
 D ADD^VADPT
"RTN","ECXPRO1",209,0)
 S ECXZIP=$P($G(VAPA(11)),"^",2)
"RTN","ECXPRO1",210,0)
 K VAPA
"RTN","ECXPRO1",211,0)
 Q
"RTN","ECXQSR")
0^10^B16625153
"RTN","ECXQSR",1,0)
ECXQSR ;BIR/PTD-DSS QUASAR Extract ; 02/14/97 14:07
"RTN","ECXQSR",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXQSR",3,0)
BEG ;entry point from option
"RTN","ECXQSR",4,0)
 I '$O(^ACK(509850.8,0)) W !,"You must be using the Quality Audiology & Speech Pathology",!,"Audit & Review (QUASAR) software to run this extract.",!! Q
"RTN","ECXQSR",5,0)
 I '$D(^ACK(509850.8,1,"DSS")) W !,"Linkage has not been established between QUASAR and the DSS UNIT file (#724).",!! Q
"RTN","ECXQSR",6,0)
 I '$O(^ACK(509850.6,0)) W !,"There is no data in the A&SP CLINIC VISIT file (#509850.6).",!! Q
"RTN","ECXQSR",7,0)
 D SETUP,^ECXTRAC
"RTN","ECXQSR",8,0)
 D ^ECXKILL
"RTN","ECXQSR",9,0)
 Q
"RTN","ECXQSR",10,0)
START ;Begin QUASAR extract.  Examine each clinic visit within selected date range.
"RTN","ECXQSR",11,0)
 S QFLG=0
"RTN","ECXQSR",12,0)
 S ECED=ECED+.9,ECL=+^ACK(509850.8,1,0),ECLINK=^ACK(509850.8,1,"DSS")
"RTN","ECXQSR",13,0)
 S ECD=ECSD1 F  S ECD=$O(^ACK(509850.6,"B",ECD)),ECDA=0 Q:(ECD>ECED)!('ECD)  F  S ECDA=$O(^ACK(509850.6,"B",ECD,ECDA)) Q:'ECDA  D UPDATE Q:QFLG
"RTN","ECXQSR",14,0)
 Q
"RTN","ECXQSR",15,0)
 ;
"RTN","ECXQSR",16,0)
UPDATE ;For each unique CPT code for clinic visit, create record in ECODE.
"RTN","ECXQSR",17,0)
 ;ecode=inst^dfn^ssn^name^i/o status^day^DSS unit^category^procedure^volume^cost center^ordering sec^section^
"RTN","ECXQSR",18,0)
 ;provider^^prov 2^^prov 3^^^mov #^treat spec^time^primary care team^primary care provider^pce cpt code^
"RTN","ECXQSR",19,0)
 ;icd-9 code^agent orange^radiation exposure^environmental contaminants^service connected^sent to pce^^dss identifier^dcm dept.
"RTN","ECXQSR",20,0)
 ;
"RTN","ECXQSR",21,0)
 S ECZNODE=$G(^ACK(509850.6,ECDA,0)),EC2NODE=$G(^ACK(509850.6,ECDA,2))
"RTN","ECXQSR",22,0)
 S ECDT=$P(ECZNODE,"^"),ECDFN=$P(ECZNODE,"^",2)
"RTN","ECXQSR",23,0)
 Q:'$D(^DPT(ECDFN,0))  D INP S ECSTOP=$P(EC2NODE,"^") Q:ECSTOP=""
"RTN","ECXQSR",24,0)
 S ECHL="",(ECHLS,ECHL2S)="000",ECAC=$P($G(ECZNODE),"^",6) I ECAC D
"RTN","ECXQSR",25,0)
 .S ECHL=+$P($G(^SC(ECAC,0)),"^",7),ECHL2=+$P($G(^(0)),"^",18) I ECHL D
"RTN","ECXQSR",26,0)
 ..S ECHLS=$P($G(^DIC(40.7,+ECHL,0)),"^",2),ECHL2S=$P($G(^DIC(40.7,+ECHL2,0)),"^",2)
"RTN","ECXQSR",27,0)
 ..S ECHLS=$$RJ^XLFSTR(ECHLS,3,0),ECHL2S=$$RJ^XLFSTR(ECHL2S,3,0)
"RTN","ECXQSR",28,0)
 S ECDSS=ECHLS_ECHL2S
"RTN","ECXQSR",29,0)
 S ECDU=$S(ECSTOP="A":$P(ECLINK,"^"),ECSTOP="S":$P(ECLINK,"^",2),1:"") Q:'ECDU
"RTN","ECXQSR",30,0)
 S ECDSSU=$G(^ECD(ECDU,0)),ECCS=+$P(ECDSSU,"^",4),(ECO,ECM)=+$P(ECDSSU,"^",3),ECDCM=$P(ECDSSU,"^",5)
"RTN","ECXQSR",31,0)
 S ECUN1=$P(EC2NODE,"^",7) Q:'ECUN1  S ECUN1=2_ECUN1
"RTN","ECXQSR",32,0)
 Q:'$O(^ACK(509850.6,ECDA,3,0))
"RTN","ECXQSR",33,0)
 ;Create local array of procedure codes and # of times each procedure was performed.
"RTN","ECXQSR",34,0)
 S ECPN=0 F  S ECPN=$O(^ACK(509850.6,ECDA,3,ECPN)) Q:'ECPN  D
"RTN","ECXQSR",35,0)
 .S XX=+^ACK(509850.6,ECDA,3,ECPN,0),XX=+$G(^ACK(509850.4,XX,0)),XX=$P($G(^ICPT(XX,0)),"^")
"RTN","ECXQSR",36,0)
 .I XX]"" S LOC(XX)=$G(LOC(XX))+1
"RTN","ECXQSR",37,0)
 Q:'$O(LOC(0))
"RTN","ECXQSR",38,0)
 Q:'$O(^ACK(509850.6,ECDA,1,0))
"RTN","ECXQSR",39,0)
 S ECIEN=$O(^ACK(509850.6,ECDA,1,0)),ECDIA=+^ACK(509850.6,ECDA,1,ECIEN,0),ECDIA=$P($G(^ICD9(ECDIA,0)),"^")
"RTN","ECXQSR",40,0)
 ;Loop through array of unique procedures. Create record in ECODE.
"RTN","ECXQSR",41,0)
 S ECP=0 F  S ECP=$O(LOC(ECP)) Q:'ECP  S ECV=+LOC(ECP) D
"RTN","ECXQSR",42,0)
 .S ECODE=ECL_"^"_ECDFN_"^"_SSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECDT,ECXYM)_"^"_ECDU_"^^"_ECP_"^"_ECV_"^"_ECCS_"^"_ECO_"^"_ECM_"^"_ECUN1_"^^^^^^^"_ECMN_"^"_ECTS_"^000000"
"RTN","ECXQSR",43,0)
 .S ECODE=ECODE_"^"_ECPTTM_"^"_ECPTPR_"^"_ECP_"^"_ECDIA_"^"_ECAO_"^"_ECRE_"^"_$P($G(^DPT(ECDFN,.322)),"^",13)_"^"_ECSC_"^N^^"_ECDSS_"^"_ECDCM_"^"
"RTN","ECXQSR",44,0)
 .D FILE
"RTN","ECXQSR",45,0)
 K LOC
"RTN","ECXQSR",46,0)
 Q
"RTN","ECXQSR",47,0)
 ;
"RTN","ECXQSR",48,0)
FILE ;Create record in QUASAR extract file (#727.825).
"RTN","ECXQSR",49,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXQSR",50,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXQSR",51,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXQSR",52,0)
 Q
"RTN","ECXQSR",53,0)
 ;
"RTN","ECXQSR",54,0)
INP ;Determine in/outpatient status, demographics, primary care team and provider, eligibility, and service history.
"RTN","ECXQSR",55,0)
 ;Returns ECA=1 (outpatient) or =3 (inpatient).
"RTN","ECXQSR",56,0)
 ;Returns ECTS=null (outpatient) or =treating specialty IEN.
"RTN","ECXQSR",57,0)
 ;Returns ECMN=movement number IEN or null (outpatient).
"RTN","ECXQSR",58,0)
 ;Returns SSN=social security number and ECNA=first 4 of last name.
"RTN","ECXQSR",59,0)
 ;Returns ECPTTM=primary care team and ECPTPR=primary care provider.
"RTN","ECXQSR",60,0)
 ;Returns ECAO=agent orange status.
"RTN","ECXQSR",61,0)
 ;Returns ECRE=radiation exposure status.
"RTN","ECXQSR",62,0)
 ;Returns ECSC=service connected status.
"RTN","ECXQSR",63,0)
 S ECA=1,ECTS="" K VAIP,VAEL,VASV,VADM S VARRAY("SVC")="",VARRAY("IN5")="",VARRAY("ELIG")="",VARRAY("DEM")="",VAIP("D")=ECDT,DFN=ECDFN D SEL^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXQSR",64,0)
 S SSN=$P(VADM(2),"^"),ECNA=$E($P(VADM(1),",")_"    ",1,4)
"RTN","ECXQSR",65,0)
 S ECAO=$S(VASV(2)=1:"Y",VASV(2)=0:"N",1:"U")
"RTN","ECXQSR",66,0)
 S ECRE=$S(VASV(3)=1:"Y",VASV(3)=0:"N",1:"U")
"RTN","ECXQSR",67,0)
 S ECSC=$S(+VAEL(3):"Y",1:"N")
"RTN","ECXQSR",68,0)
 K VAIP,VAEL,VASV,VAERR,VADM,VA,VARRAY
"RTN","ECXQSR",69,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(ECDFN,ECDT)
"RTN","ECXQSR",70,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXQSR",71,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(ECDFN,ECDT)
"RTN","ECXQSR",72,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXQSR",73,0)
 Q
"RTN","ECXQSR",74,0)
 ;
"RTN","ECXQSR",75,0)
SETUP ;Set required variables for ECXTRAC.
"RTN","ECXQSR",76,0)
 S ECPACK="QUASAR",ECPIECE=22,ECRTN="START^ECXQSR",ECGRP="QSR",ECHEAD="ECQ",ECFILE=727.825,ECVER=7
"RTN","ECXQSR",77,0)
 Q
"RTN","ECXQSR",78,0)
 ;
"RTN","ECXQSR",79,0)
QUE ;Entry point for the background requeuing handled by ECXTAUTO.
"RTN","ECXQSR",80,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXRAD")
0^11^B13993874
"RTN","ECXRAD",1,0)
ECXRAD ;BIR/PDW,PTD-Extract for Radiology ; [ 11/27/96  10:47 AM ]
"RTN","ECXRAD",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXRAD",3,0)
BEG ;entry point from option
"RTN","ECXRAD",4,0)
 D SETUP
"RTN","ECXRAD",5,0)
 D ^ECXTRAC
"RTN","ECXRAD",6,0)
 D ^ECXKILL
"RTN","ECXRAD",7,0)
 Q
"RTN","ECXRAD",8,0)
START ;start rad extract
"RTN","ECXRAD",9,0)
 S QFLG=0
"RTN","ECXRAD",10,0)
 K ECXDD D FIELD^DID(70.03,14,,"SPECIFIER","ECXDD") S ECPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD ;provider points to??
"RTN","ECXRAD",11,0)
 S ECDFN="",ECDT=ECSD-.1,ECED1=ECED+.3 K ^TMP("ECL",$J)
"RTN","ECXRAD",12,0)
 F  S ECDT=$O(^RADPT("AR",ECDT)) Q:ECDT>ECED1!(ECDT'>0)  D GETDFN Q:QFLG
"RTN","ECXRAD",13,0)
 Q
"RTN","ECXRAD",14,0)
GETDFN ;with date get dfn
"RTN","ECXRAD",15,0)
 S ECDFN=""
"RTN","ECXRAD",16,0)
 F  S ECDFN=$O(^RADPT("AR",ECDT,ECDFN)) Q:ECDFN=""  I '$D(^TMP("ECL",$J,ECDFN)) S ^TMP("ECL",$J,ECDFN)="" I $D(^DPT(ECDFN,0)) S SSN=$P(^(0),"^",9),ECNA=$E($P($P(^(0),"^"),",")_"   ",1,4) D GETXMDT Q:QFLG
"RTN","ECXRAD",17,0)
 Q
"RTN","ECXRAD",18,0)
GETXMDT ; with dfn get all exams within date range
"RTN","ECXRAD",19,0)
 S ECXMDT=ECSD-.1 F  S ECXMDT=$O(^RADPT(ECDFN,"DT","B",ECXMDT)),ECTM=$$ECXTIME^ECXUTL(ECXMDT) Q:((ECXMDT>ECED1)!(ECXMDT=""))  S:ECTM>235959 ECTM=235959 D GETEXAM Q:QFLG
"RTN","ECXRAD",20,0)
 Q
"RTN","ECXRAD",21,0)
GETEXAM ; for dfn & date get exam(s) ien
"RTN","ECXRAD",22,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(ECDFN,ECXMDT)
"RTN","ECXRAD",23,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXRAD",24,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(ECDFN,ECXMDT)
"RTN","ECXRAD",25,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXRAD",26,0)
 S ECXMDA="" F  S ECXMDA=$O(^RADPT(ECDFN,"DT","B",ECXMDT,ECXMDA)) Q:ECXMDA'>0  D GETPROC
"RTN","ECXRAD",27,0)
 Q
"RTN","ECXRAD",28,0)
GETPROC ;pull data, proceedures, and modifiers for specific exam (case numbers)
"RTN","ECXRAD",29,0)
 ;rad division, ssn,name,date,imaging location
"RTN","ECXRAD",30,0)
 D INP S ECODE0=$P(^RADPT(ECDFN,"DT",ECXMDA,0),"^",3)_"^"_ECDFN_"^"_SSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL($P(^(0),"^"),ECXYM),ECLOC=$P(^(0),"^",4),ECTY=$P(^(0),"^",2)
"RTN","ECXRAD",31,0)
 S ECCN=0 F  S ECCN=$O(^RADPT(ECDFN,"DT",ECXMDA,"P",ECCN)) Q:ECCN'>0  S ECCA=^RADPT(ECDFN,"DT",ECXMDA,"P",ECCN,0),ECPRO=$P(ECCA,"^",2),ECCA=$P($G(^RA(72,+$P(ECCA,"^",3),0)),"^",3) I ECPRO I ECCA'=0 D GETMORE D GETMODS D PUT
"RTN","ECXRAD",32,0)
 Q
"RTN","ECXRAD",33,0)
GETMORE ;pickup CPT code,ward/clinic,service,provider,diagnostic code
"RTN","ECXRAD",34,0)
 S ECPT=+$P($G(^RAMIS(71,+ECPRO,0)),"^",9),ECPT=$P($G(^ICPT(ECPT,0)),"^")
"RTN","ECXRAD",35,0)
 S ECTEMP=^RADPT(ECDFN,"DT",ECXMDA,"P",ECCN,0),W=$P(ECTEMP,"^",6),W=$P($G(^DIC(42,+W,44)),"^"),ECS=$P(ECTEMP,"^",7),ECDOC=$P(ECTEMP,"^",14),ECDI=$P(ECTEMP,"^",13)
"RTN","ECXRAD",36,0)
 S:W="" W=$P(ECTEMP,"^",8)
"RTN","ECXRAD",37,0)
 S ECMORE=ECPT_"^"_ECPRO_"^"_ECLOC_"^"_W_"^"_ECS_"^"_ECDI_"^"_ECPROF_ECDOC
"RTN","ECXRAD",38,0)
 Q
"RTN","ECXRAD",39,0)
GETMODS ; get proceedure modifiers
"RTN","ECXRAD",40,0)
 S ECMOD=0,ECMODS="" F  S ECMOD=$O(^RADPT(ECDFN,"DT",ECXMDA,"P",ECCN,"M",ECMOD)) Q:ECMOD'>0  S ECMODS=ECMODS_$P(^(ECMOD,0),"^")_";"
"RTN","ECXRAD",41,0)
 Q
"RTN","ECXRAD",42,0)
PUT ; put variables into ECODE and put into global
"RTN","ECXRAD",43,0)
 ;ecode= rad div^dfn^ssn^name^in/out^day^cpt code^procedure^img loc^ward^ser^diag code^request phy^
"RTN","ECXRAD",44,0)
 ;modifiers;..^mov #^treat spec^time^imaging type^primary care team^primary care provider
"RTN","ECXRAD",45,0)
 S ECODE=ECODE0_"^"_ECMORE_"^"_ECMODS_"^"_ECMN_"^"_ECTS_"^"_ECTM_"^"_ECTY_"^"_ECPTTM_"^"_ECPTPR_"^"
"RTN","ECXRAD",46,0)
FILE S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXRAD",47,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXRAD",48,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXRAD",49,0)
 Q
"RTN","ECXRAD",50,0)
 ;
"RTN","ECXRAD",51,0)
SETUP S ECPACK="Radiology",ECPIECE=6,ECRTN="START^ECXRAD",ECGRP="RAD",ECHEAD="RAD",ECFILE=727.814,ECVER=7
"RTN","ECXRAD",52,0)
 Q
"RTN","ECXRAD",53,0)
INP ; checks for in/outpatient status
"RTN","ECXRAD",54,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECDT,DFN=ECDFN D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXRAD",55,0)
 K VAIP,VAERR
"RTN","ECXRAD",56,0)
 Q
"RTN","ECXSCNS")
0^12^B8571243
"RTN","ECXSCNS",1,0)
ECXSCNS ;BIR/DMA,PTD-No Show Clinic Extract ; [ 11/22/96  5:48 PM ]
"RTN","ECXSCNS",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXSCNS",3,0)
BEG ;entry point from option
"RTN","ECXSCNS",4,0)
 D SETUP,^ECXTRAC,^ECXKILL
"RTN","ECXSCNS",5,0)
 Q
"RTN","ECXSCNS",6,0)
 ;
"RTN","ECXSCNS",7,0)
START ;start package specific extract
"RTN","ECXSCNS",8,0)
 S QFLG=0
"RTN","ECXSCNS",9,0)
 S ECED=ECED+.3
"RTN","ECXSCNS",10,0)
 S SC=0 F  S SC=$O(^SC(SC)) Q:'SC  I $D(^(SC,0)) D  Q:QFLG
"RTN","ECXSCNS",11,0)
 .S EC=^(0) I $P(EC,"^",3)="C" D
"RTN","ECXSCNS",12,0)
 ..S SU=$P(EC,"^",15)
"RTN","ECXSCNS",13,0)
 ..D FEEDER^ECXSCX(SC,ECSD1,.ECXP1,.ECXP2,.ECXP3,.ECXSEND)
"RTN","ECXSCNS",14,0)
 ..Q:ECXSEND=6
"RTN","ECXSCNS",15,0)
 ..S ECXDSS=ECXP1_ECXP2,ECD=ECSD1
"RTN","ECXSCNS",16,0)
 ..F  S ECD=$O(^SC(SC,"S",ECD)) Q:'ECD  Q:ECD>ECED  D MORE Q:QFLG
"RTN","ECXSCNS",17,0)
 Q
"RTN","ECXSCNS",18,0)
 ;
"RTN","ECXSCNS",19,0)
MORE S ECDA=0 F  S ECDA=$O(^SC(SC,"S",ECD,1,ECDA)) Q:'ECDA  I $D(^(ECDA,0)),$S('$D(^("C")):1,1:^("C")="") S EC=^(0),DFN=$P(EC,"^") I $D(^DPT(+DFN,0)) S EC1=^(0) D INP I ECA=1 D GET
"RTN","ECXSCNS",20,0)
 ;log no shows only for outpatients
"RTN","ECXSCNS",21,0)
 Q
"RTN","ECXSCNS",22,0)
GET ;
"RTN","ECXSCNS",23,0)
 S DOB=$$ECXDOB^ECXUTL($P(EC1,"^",3)),VET=$P($G(^("VET")),"^"),RACE=$P($G(^DIC(10,+$P(EC1,"^",6),0)),"^",2),D1=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),"^",9) I D1 S D1=$C(D1+64)
"RTN","ECXSCNS",24,0)
 I $D(^DPT(DFN,"S",ECD,0)),$P(^(0),"^")=SC,$P(^(0),"^",2)]"",$P(^(0),"^",2)["N" D
"RTN","ECXSCNS",25,0)
 .S ECODE=SU_"^"_DFN_"^"_$P(EC1,"^",9)_"^"_$E($P($P(EC1,"^"),",")_"    ",1,4)_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^^"_ECMN_"^"_ECTS_"^"_DOB_"^"_D1_"^"_VET_"^"_$$ECXTIME^ECXUTL(ECD)_"^"_ECPTTM_"^"_ECPTPR_"^^"_RACE_"^"_ECXDSS_"^"
"RTN","ECXSCNS",26,0)
 .D FILE
"RTN","ECXSCNS",27,0)
 ;fac^dfn^ssn^name^in/out^day^^mov #^treat spec^dob^elig^vet^time^primary care team^primary care provider^provider^race^dss identifier
"RTN","ECXSCNS",28,0)
 Q
"RTN","ECXSCNS",29,0)
FILE S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXSCNS",30,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSCNS",31,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSCNS",32,0)
 Q
"RTN","ECXSCNS",33,0)
 ;
"RTN","ECXSCNS",34,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXSCNS",35,0)
 S ECPACK="Clinic no shows",ECPIECE=15,ECRTN="START^ECXSCNS",ECGRP="SCNS",ECFILE=727.804,ECHEAD="NOS",ECVER=7
"RTN","ECXSCNS",36,0)
 Q
"RTN","ECXSCNS",37,0)
 ;
"RTN","ECXSCNS",38,0)
INP ;Determine in/outpatient status, movement number, primary care team and provider.
"RTN","ECXSCNS",39,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXSCNS",40,0)
 K VAIP,VAERR
"RTN","ECXSCNS",41,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXSCNS",42,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXSCNS",43,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECD)
"RTN","ECXSCNS",44,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXSCNS",45,0)
 Q
"RTN","ECXSCNS",46,0)
 ;
"RTN","ECXSCNS",47,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSCNS",48,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSCX")
0^13^B55682077
"RTN","ECXSCX",1,0)
ECXSCX ;BIR/DMA,CML,PTD-Clinic Extract ; 02/06/97 10:24 [ 03/26/97  2:10 PM ]
"RTN","ECXSCX",2,0)
 ;;3.0;DSS EXTRACTS;**1,3,11**;Dec 22, 1997
"RTN","ECXSCX",3,0)
BEG ;entry point from option
"RTN","ECXSCX",4,0)
 D SETUP,^ECXTRAC,^ECXKILL
"RTN","ECXSCX",5,0)
 Q
"RTN","ECXSCX",6,0)
 ;
"RTN","ECXSCX",7,0)
START ;scheduled appts. and appended ekgs: loop through the file (#44);
"RTN","ECXSCX",8,0)
 K ^TMP("ECXS",$J) S ECXMISS=10,ECED=ECED+.3 S SC=0,QFLG=0
"RTN","ECXSCX",9,0)
 F  S SC=$O(^SC(SC)) Q:'SC  I $D(^(SC,0)) S EC=^(0) I $P(EC,"^",3)="C" S ECSU=$P(EC,"^",15) S:'ECSU ECSU=1 D FEEDER(SC,ECSD1,.P1,.P2,.P3,.ECST) I ECST'=6 S ECD=ECSD1 D  Q:QFLG
"RTN","ECXSCX",10,0)
 .F  S ECD=$O(^SC(SC,"S",ECD)) Q:'ECD  Q:ECD>ECED  S ECDA=0 F  S ECDA=$O(^SC(SC,"S",ECD,1,ECDA)) Q:'ECDA  I $D(^(ECDA,0)) D  Q:QFLG
"RTN","ECXSCX",11,0)
 ..;for each patient appointment in the date range (skip cancellations), examine the APPOINTMENT multiple in the PATIENT file (#2)
"RTN","ECXSCX",12,0)
 ..I $S('$D(^SC(SC,"S",ECD,1,ECDA,"C")):1,1:$P(^("C"),"^",3)]"") S PTADT=^(0),DFN=$P(PTADT,"^") I $D(^DPT(+DFN,0)),$P(PTADT,"^",9)="",$P($G(^DPT(DFN,"S",ECD,0)),"^",2)'["C" D
"RTN","ECXSCX",13,0)
 ...S EC1=^DPT(DFN,0),ECO1=ECSU_"^"_DFN_"^"_$P(EC1,"^",9)_"^"_$E($P($P(EC1,"^"),",")_"   ",1,4)_"^^"_$$ECXDATE^ECXUTL(ECD,ECXYM)
"RTN","ECXSCX",14,0)
 ...D AOIRPOW^ECXUTL(DFN,.ECXAIP)
"RTN","ECXSCX",15,0)
 ...S ECL=$P(PTADT,"^",2),ECL=$$RJ^XLFSTR(ECL,3,0),ECOB=$G(^SC(SC,"S",ECD,1,ECDA,"OB"))]""
"RTN","ECXSCX",16,0)
 ...;don't continue with record creation if the clinic appointment can't be found in subfile 2.98
"RTN","ECXSCX",17,0)
 ...Q:'$D(^DPT(DFN,"S",ECD,0))  Q:$P(^DPT(DFN,"S",ECD,0),"^")'=SC
"RTN","ECXSCX",18,0)
 ...K EC2 S EC2=^DPT(DFN,"S",ECD,0) S ECN=$S($P(EC2,"^",2)="N":"N",$P(EC2,"^",2)="NA":"N",$P(EC2,"^",2)="NT":"Q",1:"0")
"RTN","ECXSCX",19,0)
 ...S ECIEN=$P(EC2,"^",20),ECEKG=$P(EC2,"^",5)
"RTN","ECXSCX",20,0)
 ...S ECO2=ECOB_"^"_SC
"RTN","ECXSCX",21,0)
 ...I ECST'=3 S ECFD=P1_P2_ECL_P3_ECN,ECODE=ECO1_"^"_ECFD_"^"_ECO2 D API
"RTN","ECXSCX",22,0)
 ...I ECST=3 S ECFD=P1_"000"_ECL_P3_ECN,ECODE=ECO1_"^"_ECFD_"^"_ECO2 D API
"RTN","ECXSCX",23,0)
 ...I ECST=3 S ECFD=P2_"000"_ECL_P3_ECN,ECODE=ECO1_"^"_ECFD_"^"_ECO2 D API
"RTN","ECXSCX",24,0)
 ...;Check for appended visits for EKG (107). If regular appt. is a no-show, append is a no-show.
"RTN","ECXSCX",25,0)
 ...Q:'ECEKG  S $P(ECODE,"^",7,9)="1070000280000"_ECN_"^^" D FILE2
"RTN","ECXSCX",26,0)
 K DFN,EC,EC1,EC2,ECA,ECCPT,ECCSC,ECD,ECDA,ECEKG,ECFD,ECICD,ECIEN,ECL,ECMN,ECN,ECO1,ECO2,ECOB,ECODE,ECPROV,ECPTPR,ECPTTM,ECREC,ECSC,ECST,ECSU,ECTS,ECVAL,ECVIS,ELIG,P1,P11,P2,P3,PTADT,SC,VAERR,VAIP
"RTN","ECXSCX",27,0)
 ;Dispositions, stand-alones, and appended lab and x-ray: Loop through the OUTPATIENT ENCOUNTER file (#409.68) for date range.
"RTN","ECXSCX",28,0)
 S ECD=ECSD1 F  S ECD=$O(^SCE("B",ECD)) Q:'ECD!(ECD>ECED)  S ECIEN=0 F  S ECIEN=$O(^SCE("B",ECD,ECIEN)) Q:'ECIEN  D PROC Q:QFLG
"RTN","ECXSCX",29,0)
 I '$D(^TMP("ECXS",$J)) Q
"RTN","ECXSCX",30,0)
 Q:QFLG
"RTN","ECXSCX",31,0)
 G ^ECXSCX1
"RTN","ECXSCX",32,0)
 ;
"RTN","ECXSCX",33,0)
PROC ;Process an OUTPATIENT ENCOUNTER.
"RTN","ECXSCX",34,0)
 Q:'$D(^SCE(ECIEN,0))  ;Quit if no OUTPATIENT ENCOUNTER zero node.
"RTN","ECXSCX",35,0)
 S FD=0,NCNTR=^SCE(ECIEN,0),STOP=$P($G(^DIC(40.7,+$P(NCNTR,"^",3),0)),"^",2) Q:'STOP  ;Quit if no clinic stop code for encounter.
"RTN","ECXSCX",36,0)
 ;FD=1>x-ray or lab record, FD=2>disposition, FD=0>stand-alone visit
"RTN","ECXSCX",37,0)
 I (STOP=105)!(STOP=108) S FD=1 G BLD ;Clinic stop code equals 105 (x-ray) or 108 (lab).
"RTN","ECXSCX",38,0)
 I ($P(NCNTR,"^",8)'=2),($P(NCNTR,"^",8)'=3) Q  ;Quit if encounter not STOP CODE ADDITION or DISPOSITION.
"RTN","ECXSCX",39,0)
 I $P(NCNTR,"^",8)=3 S FD=2 G BLD ;ORIGINATING PROCESS TYPE equals DISPOSITION.
"RTN","ECXSCX",40,0)
 ;Else ORIGINATING PROCESS TYPE equals STOP CODE ADDITION (stand-alone).
"RTN","ECXSCX",41,0)
 Q:$P($G(NCNTR),"^",6)  ;Quit if there is a PARENT ENCOUNTER pointer.
"RTN","ECXSCX",42,0)
BLD ;Build record.
"RTN","ECXSCX",43,0)
 S DFN=+$P(NCNTR,"^",2),LOC=$P(NCNTR,"^",4),ECSU=1 S:LOC ECSU=$P(^SC(LOC,0),"^",15)
"RTN","ECXSCX",44,0)
 I $D(^DPT(DFN,0)) S EC1=^(0),ECO1=ECSU_"^"_DFN_"^"_$P(EC1,"^",9)_"^"_$E($P($P(EC1,"^"),",")_"    ",1,4)_"^^"_$$ECXDATE^ECXUTL(ECD,ECXYM) D
"RTN","ECXSCX",45,0)
 .D AOIRPOW^ECXUTL(DFN,.ECXAIP)
"RTN","ECXSCX",46,0)
 .S P1=$$RJ^XLFSTR(STOP,3,0),P2="000",P3="0000",ECST=1
"RTN","ECXSCX",47,0)
 .; for x-ray and lab
"RTN","ECXSCX",48,0)
 .I FD=1 S ECODE=ECO1_"^"_P1_P2_"02800000^^" D API Q
"RTN","ECXSCX",49,0)
 .; for dispositions
"RTN","ECXSCX",50,0)
 .I FD=2 S ECODE=ECO1_"^"_P1_"47906000000^^" D API Q
"RTN","ECXSCX",51,0)
 .; for stand-alone visits
"RTN","ECXSCX",52,0)
 .I LOC,$D(^SC(LOC,0)) S SC=LOC,EC=^(0) D FEEDER(SC,ECD,.P1,.P2,.P3,.ECST)
"RTN","ECXSCX",53,0)
 .I ECST'=6 S ECODE=ECO1_"^"_P1_P2_"029"_P3_"0^^"_SC D API
"RTN","ECXSCX",54,0)
 Q
"RTN","ECXSCX",55,0)
 ;
"RTN","ECXSCX",56,0)
FILE ;facility^dfn^ssn^name^in/out status^day^feeder key^overbook^sc^mov #^treat spec^time^primary care team^
"RTN","ECXSCX",57,0)
 ;primary care provider^provider^CPT code^ICD-9 code^dob^eligibility^vet^race^
"RTN","ECXSCX",58,0)
 ;ao status^ao visit^ir statusir visit^pow status^pow location^provider person class
"RTN","ECXSCX",59,0)
 S $P(ECODE,"^",5)=ECA,ECODE=ECODE_"^"_ECMN_"^"_ECTS_"^"_$$ECXTIME^ECXUTL(ECD)_"^"_ECPTTM_"^"_ECPTPR_"^"_ECPROV_"^"_ECCPT_"^"_ECICD
"RTN","ECXSCX",60,0)
 S ECODE=ECODE_"^"_$$ECXDOB^ECXUTL($P(EC1,"^",3))_"^"_ELIG_"^"_$P($G(^DPT(DFN,"VET")),"^")_"^"_$P($G(^DIC(10,+$P(EC1,"^",6),0)),"^",2)
"RTN","ECXSCX",61,0)
 S ECODE=ECODE_"^"_ECXAIP("AO")_"^"_ECVAO_"^"_ECXAIP("IR")_"^"_ECVIR_"^"_ECXAIP("POW")_"^"_ECXAIP("POWL")_"^"_ECXPRPC_"^"
"RTN","ECXSCX",62,0)
FILE2 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXSCX",63,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSCX",64,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSCX",65,0)
 Q
"RTN","ECXSCX",66,0)
 ;
"RTN","ECXSCX",67,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXSCX",68,0)
 S ECPACK="Clinic",ECPIECE=11,ECRTN="START^ECXSCX",ECGRP="SCX",ECFILE=727.803,ECHEAD="CLI",ECVER=7
"RTN","ECXSCX",69,0)
 Q
"RTN","ECXSCX",70,0)
 ;
"RTN","ECXSCX",71,0)
FEEDER(ECXSC,ECXSD,ECXP1,ECXP2,ECXP3,ECXSEND) ;get transmission style and feeder key variables
"RTN","ECXSCX",72,0)
 ;feeder key is primary stop code_secondary stop code_length of appointment_national clinic code_noshow indicator
"RTN","ECXSCX",73,0)
 ;   input
"RTN","ECXSCX",74,0)
 ;   ECXSCX = ien of clinic in file #44 (required)
"RTN","ECXSCX",75,0)
 ;   ECXSD  = start date of extract date range (required)
"RTN","ECXSCX",76,0)
 ;   ECXP1,ECXP2,ECXP3,ECXSEND passed by reference (required)
"RTN","ECXSCX",77,0)
 ;   output (passed-by-reference variables)
"RTN","ECXSCX",78,0)
 ;   ECXP1  = primary stop code
"RTN","ECXSCX",79,0)
 ;   ECXP2  = secondary stop code
"RTN","ECXSCX",80,0)
 ;   ECXP3  = field #7 of file #728.44
"RTN","ECXSCX",81,0)
 ;   ECXSEND = field #5 of file #728.44
"RTN","ECXSCX",82,0)
 N ECSC,ECCSC,SC,ECSD1,ECXNC,ECXMISS
"RTN","ECXSCX",83,0)
 S (ECXP1,ECXP2)="000",ECXP3="0000"
"RTN","ECXSCX",84,0)
 S ECXSEND=1
"RTN","ECXSCX",85,0)
 I '$D(^ECX(728.44,ECXSC,0)) D  Q
"RTN","ECXSCX",86,0)
 .S ECSC=$P($G(^SC(ECXSC,0)),"^",7),ECCSC=$P(^(0),"^",18)
"RTN","ECXSCX",87,0)
 .S SC=ECXSC,ECSD1=ECXSD D MISS^ECXSCX1
"RTN","ECXSCX",88,0)
 .I ECSC S ECXP1=$P($G(^DIC(40.7,ECSC,0)),"^",2),ECXP1=$$RJ^XLFSTR(ECXP1,3,0)
"RTN","ECXSCX",89,0)
 S EC=$G(^ECX(728.44,ECXSC,0)) Q:EC=""
"RTN","ECXSCX",90,0)
 S ECXSEND=$P(EC,"^",6)
"RTN","ECXSCX",91,0)
 Q:ECXSEND=6
"RTN","ECXSCX",92,0)
 S ECSC=$P(EC,"^",4),ECCSC=$P(EC,"^",5)
"RTN","ECXSCX",93,0)
 I ECSC="" S ECSC=$P(EC,"^",2),ECCSC=$P(EC,"^",3)
"RTN","ECXSCX",94,0)
 I ECSC S ECXP1=$$RJ^XLFSTR(ECSC,3,0),ECXP2=$$RJ^XLFSTR(ECCSC,3,0)
"RTN","ECXSCX",95,0)
 I ECSC="" D
"RTN","ECXSCX",96,0)
 .S ECSC=$P($G(^SC(ECXSC,0)),"^",7),ECCSC=$P($G(^(0)),"^",18) I ECSC D
"RTN","ECXSCX",97,0)
 ..S ECXP1=$P($G(^DIC(40.7,ECSC,0)),"^",2) S:ECCSC]"" ECXP2=$P($G(^DIC(40.7,ECCSC,0)),"^",2)
"RTN","ECXSCX",98,0)
 ..S ECXP1=$$RJ^XLFSTR(ECXP1,3,0),ECXP2=$$RJ^XLFSTR(ECXP2,3,0)
"RTN","ECXSCX",99,0)
 ;for action code=1, secondary stop code is always "000"
"RTN","ECXSCX",100,0)
 I ECXSEND=1 S ECXP2="000" Q
"RTN","ECXSCX",101,0)
 ;action code of 2 or 3 should not be used, but continue to follow v2t11 logic
"RTN","ECXSCX",102,0)
 I ECXSEND=2 S ECXP1=ECXP2,ECXP2="000" Q
"RTN","ECXSCX",103,0)
 I ECXSEND=3 Q
"RTN","ECXSCX",104,0)
 ;for action code=4, need to get national clinic code
"RTN","ECXSCX",105,0)
 I ECXSEND=4 D
"RTN","ECXSCX",106,0)
 .S ECXNC=$P($G(^ECX(728.44,ECXSC,0)),"^",8)
"RTN","ECXSCX",107,0)
 .I ECXNC S ECXNC=$P($G(^ECX(728.441,ECXNC,0)),"^"),ECXP3=$$RJ^XLFSTR(ECXNC,4,0)
"RTN","ECXSCX",108,0)
 Q
"RTN","ECXSCX",109,0)
 ;
"RTN","ECXSCX",110,0)
API ;call external utilities
"RTN","ECXSCX",111,0)
 ;Determine in/out status and movement number.
"RTN","ECXSCX",112,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXSCX",113,0)
 K VAIP,VAERR
"RTN","ECXSCX",114,0)
 ;Determine primary care team/provider and eligibility.
"RTN","ECXSCX",115,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXSCX",116,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXSCX",117,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECD)
"RTN","ECXSCX",118,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXSCX",119,0)
 S ELIG=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),"^",9) I ELIG S ELIG=$C(ELIG+64)
"RTN","ECXSCX",120,0)
PCE ;call PCE API for CPT code, diagnosis/provider designated as primary
"RTN","ECXSCX",121,0)
 S ECPROV="",ECXPRPC="",ECCPT=99199,ECICD=799.9,ECVAO="",ECVIR=""
"RTN","ECXSCX",122,0)
 I 'ECIEN D FILE Q
"RTN","ECXSCX",123,0)
 I ECIEN S ECVIS=$P($G(^SCE(ECIEN,0)),"^",5)
"RTN","ECXSCX",124,0)
 I 'ECVIS D FILE Q
"RTN","ECXSCX",125,0)
 I ECVIS D ENCEVENT^PXAPI(ECVIS)
"RTN","ECXSCX",126,0)
 I $O(^TMP("PXKENC",$J,ECVIS,""))']"" D FILE Q
"RTN","ECXSCX",127,0)
POV ;get ICD9 code; else use 799.9
"RTN","ECXSCX",128,0)
 G:'$O(^TMP("PXKENC",$J,ECVIS,"POV",0)) PRV
"RTN","ECXSCX",129,0)
 S (ECREC,ECVAL)=0
"RTN","ECXSCX",130,0)
 F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"POV",ECREC)) Q:'ECREC  S:($P(^TMP("PXKENC",$J,ECVIS,"POV",ECREC,0),"^",12)="P") ECVAL=+^(0) Q:$P(^TMP("PXKENC",$J,ECVIS,"POV",ECREC,0),"^",12)="P"
"RTN","ECXSCX",131,0)
 I 'ECVAL S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"POV",0)) I ECREC S ECVAL=+^(ECREC,0)
"RTN","ECXSCX",132,0)
 I ECVAL S ECICD=$P($G(^ICD9(ECVAL,0)),"^")
"RTN","ECXSCX",133,0)
PRV ;get first provider designated as primary; if no primary, then get first physician provider; if no physician, then get first provider; if no "prv" array nodes, use null.
"RTN","ECXSCX",134,0)
 G:'$O(^TMP("PXKENC",$J,ECVIS,"PRV",0)) CPT
"RTN","ECXSCX",135,0)
 S (ECREC,ECVAL)=0
"RTN","ECXSCX",136,0)
 F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC)) Q:'ECREC  S:($P(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC,0),"^",4)="P") ECVAL=+^(0) Q:$P(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC,0),"^",4)="P"
"RTN","ECXSCX",137,0)
 I ECVAL S ECPROV=ECVAL,ECXPRPC=$$PRVCLASS^ECXUTL(ECPROV,ECD)
"RTN","ECXSCX",138,0)
 I 'ECVAL S ECREC=0 D
"RTN","ECXSCX",139,0)
 .F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC)) Q:'ECREC  D  Q:ECVAL
"RTN","ECXSCX",140,0)
 ..S ECVAL=+^TMP("PXKENC",$J,ECVIS,"PRV",ECREC,0) Q:'ECVAL
"RTN","ECXSCX",141,0)
 ..S ECXPRPC=$$PRVCLASS^ECXUTL(ECVAL,ECD) Q:ECXPRPC=""
"RTN","ECXSCX",142,0)
 ..S NUM=$E(ECXPRPC,2,7) S:(NUM<110000)!(NUM>119999) ECVAL=0,ECXPRPC=""
"RTN","ECXSCX",143,0)
 ..I ECVAL S ECPROV=ECVAL
"RTN","ECXSCX",144,0)
 I 'ECVAL D
"RTN","ECXSCX",145,0)
 .S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"PRV",0)) Q:'ECREC  S ECVAL=+^(ECREC,0)
"RTN","ECXSCX",146,0)
 .I ECVAL S ECPROV=ECVAL,ECXPRPC=$$PRVCLASS^ECXUTL(ECPROV,ECD)
"RTN","ECXSCX",147,0)
CPT ;get CPT code for IEN, else use default.
"RTN","ECXSCX",148,0)
 G:'$O(^TMP("PXKENC",$J,ECVIS,"CPT",0)) DFLT
"RTN","ECXSCX",149,0)
 S (ECREC,ECVAL)=0
"RTN","ECXSCX",150,0)
 ;if there's a primary provider, get a cpt associated with that provider
"RTN","ECXSCX",151,0)
 I ECPROV'="" D
"RTN","ECXSCX",152,0)
 .F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"CPT",ECREC)) Q:'ECREC  D  Q:ECVAL
"RTN","ECXSCX",153,0)
 ..I $D(^TMP("PXKENC",$J,ECVIS,"CPT",ECREC,12)) S:$P(^(12),"^",4)=ECPROV ECVAL=+^TMP("PXKENC",$J,ECVIS,"CPT",ECREC,0)
"RTN","ECXSCX",154,0)
 ..I ECVAL S ECCPT=$P($G(^ICPT(ECVAL,0)),"^")
"RTN","ECXSCX",155,0)
 I ECVAL=0 D
"RTN","ECXSCX",156,0)
 .S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"CPT",0)),ECVAL=+^(ECREC,0) I ECVAL S ECCPT=$P($G(^ICPT(ECVAL,0)),"^")
"RTN","ECXSCX",157,0)
DFLT S (ECVAO,ECVIR)=""
"RTN","ECXSCX",158,0)
 I $D(^TMP("PXKENC",$J,ECVIS,"VST",ECVIS,800)) D
"RTN","ECXSCX",159,0)
 .S ECVAO=$P(^(800),"^",2),ECVIR=$P(^(800),"^",3)
"RTN","ECXSCX",160,0)
 .S:ECVAO="0" ECVAO="N" S:ECVIR=0 ECVIR="N"
"RTN","ECXSCX",161,0)
 .S:ECVAO="1" ECVAO="Y" S:ECVIR=1 ECVIR="Y"
"RTN","ECXSCX",162,0)
 D FILE
"RTN","ECXSCX",163,0)
 Q
"RTN","ECXSCX",164,0)
 ;
"RTN","ECXSCX",165,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSCX",166,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSETUP")
0^14^B28030155
"RTN","ECXSETUP",1,0)
ECXSETUP ;BIR/DMA,CML,PTD-Generate Patient Population for a Given Day ; [ 11/25/96  11:26 AM ]
"RTN","ECXSETUP",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXSETUP",3,0)
EN ;entry point from option
"RTN","ECXSETUP",4,0)
 ;Pick a day, find everyone who was in the hospital on that day,
"RTN","ECXSETUP",5,0)
 ;find the corresponding admission and the last transfer and treating
"RTN","ECXSETUP",6,0)
 ;speciality change
"RTN","ECXSETUP",7,0)
 ;This routine should only be run once
"RTN","ECXSETUP",8,0)
 I '$D(DT) S DT=$$HTFM^XLFDT(+$H)
"RTN","ECXSETUP",9,0)
 I $P($G(^ECX(728,1,"S")),"^",2)]"" W !,"The setup extract is already running.",! Q
"RTN","ECXSETUP",10,0)
 I $P($G(^ECX(728,1,"S")),"^") W !,"The setup extract has already been run.",! Q
"RTN","ECXSETUP",11,0)
 W !!,"This option will extract the admission data and data for the last",!,"transfer and treating specialty change for all patients who",!,"were in the hospital on the day you select.",!!
"RTN","ECXSETUP",12,0)
 W !!,"NOTE - This will generate a snapshot of your inpatient population on the",!,"BEGINNING of the day you select, not the end of the day as MAS reports do.",!
"RTN","ECXSETUP",13,0)
 W "For example, for the inpatient setup extract if you choose October 1, 1994,",!,"the report will start at midnight at the beginning of the day."
"RTN","ECXSETUP",14,0)
 W "  For the MAS",!,"report, you would choose September 30, 1994.  The MAS report begins at midnight",!,"at the end of the day.",!!!
"RTN","ECXSETUP",15,0)
 S Y=$E(DT,1,3) S:'$E(DT,4) Y=Y-1 S ECDEX=$$FMTE^XLFDT(Y_"1001")
"RTN","ECXSETUP",16,0)
DATE S DIR(0)="D^::EXP",DIR("A")="Select the starting date ",DIR("B")=ECDEX D ^DIR K DIR G END:$D(DIRUT) S ECED=Y I Y>DT W !,"Date must be in the past",! G DATE
"RTN","ECXSETUP",17,0)
 S ECDEX=$$FMTE^XLFDT(Y)
"RTN","ECXSETUP",18,0)
 S ZTSAVE("ECED")="",ZTDESC="Find all inpatients on "_ECDEX,ZTIO="",ZTRTN="START^ECXSETUP" D ^%ZTLOAD
"RTN","ECXSETUP",19,0)
 I $D(ZTSK) W !,"Request queued as Task #",ZTSK,".",!
"RTN","ECXSETUP",20,0)
 G END
"RTN","ECXSETUP",21,0)
 ;
"RTN","ECXSETUP",22,0)
START ;queued entry point
"RTN","ECXSETUP",23,0)
 I $G(^ECX(728,1,"S"))]"",$G(^("S"))'="^" Q  ;already running or finished
"RTN","ECXSETUP",24,0)
 S $P(^ECX(728,1,"S"),"^",2)="R" ; set run flag
"RTN","ECXSETUP",25,0)
 K ECXDD D FIELD^DID(405,.19,,"SPECIFIER","ECXDD") S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXSETUP",26,0)
 S ECPACK="Admission setup",ECPIECE=13,ECRTN="START^ECXSETUP",ECGRP="ADMS",ECHEAD="ADM",ECFILE=727.82,ECSD=ECED,ECD=ECED,ECVER=7
"RTN","ECXSETUP",27,0)
 S ECINST=+$P(^ECX(728,1,0),"^") K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXSETUP",28,0)
 D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXSETUP",29,0)
 S ECRN=0,QFLG=0
"RTN","ECXSETUP",30,0)
 S ECD0=9999999.9999999-ECD
"RTN","ECXSETUP",31,0)
 K ^TMP($J)
"RTN","ECXSETUP",32,0)
 F DFN=0:0 S DFN=$O(^DGPM("ATID1",DFN)) Q:'DFN  S EC1=$O(^(DFN,ECD0)) I EC1 S ECDA=+$O(^(EC1,0)) I $D(^DGPM(ECDA,0)) D  Q:QFLG
"RTN","ECXSETUP",33,0)
 .S EC=^(0),ECX=+$P(EC,"^",17),ECAS=$P(EC,"^",18)=40 D:$S('ECX:1,'$D(^DGPM(ECX,0)):1,^DGPM(ECX,0)>ECD:1,1:0) GET I ECAS D GET1
"RTN","ECXSETUP",34,0)
 I QFLG S ZTSTOP=1 G END
"RTN","ECXSETUP",35,0)
 S ECLAST=-$O(^ECX(ECFILE,"AINV","")),ECTOTAL=$P(^ECX(ECFILE,0),"^",4)+ECRN,$P(^(0),"^",3,4)=ECLAST_"^"_ECTOTAL K ECLAST,ECTOTAL
"RTN","ECXSETUP",36,0)
 G ^ECXSETU1
"RTN","ECXSETUP",37,0)
END K DIR,ECD,ECDEX,X,Y,ECD0,DFN,DA,EC0
"RTN","ECXSETUP",38,0)
 Q
"RTN","ECXSETUP",39,0)
 ;
"RTN","ECXSETUP",40,0)
GET ;
"RTN","ECXSETUP",41,0)
 Q:'$D(^DPT(DFN,0))  S D0=^DPT(DFN,0),ECAD=$P(EC,"^"),^TMP($J,DFN,ECDA)=""
"RTN","ECXSETUP",42,0)
 S ECTM=$$ECXTIME^ECXUTL(ECAD),ECXYM=$$ECXYM^ECXUTL(ECED)
"RTN","ECXSETUP",43,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXSETUP",44,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXSETUP",45,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECAD)
"RTN","ECXSETUP",46,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXSETUP",47,0)
 S ECODE=DFN_"^"_$P(D0,"^",9)_"^"_$E($P($P(D0,"^"),",")_"    ",1,4)_"^3^"_$$ECXDATE^ECXUTL(ECAD,ECXYM)_"^"_ECPTTM
"RTN","ECXSETUP",48,0)
 S ECODE=ECODE_"^"_$P(D0,"^",2)_"^"_$$ECXDOB^ECXUTL($P(D0,"^",3))_"^"_$P(D0,"^",8)_"^"_$P($G(^DPT(DFN,.311)),"^",15)_"^"_+$$INSURED^IBCNS1(DFN,ECD)
"RTN","ECXSETUP",49,0)
 S D1=$G(^DPT(DFN,.11)),ECSTA=$P(D1,"^",5),STATE=$S(ECSTA:$P(^DIC(5,ECSTA,0),"^",3),1:"")
"RTN","ECXSETUP",50,0)
 S ECCTY=$P(D1,"^",7),COUNTY=$S(ECCTY:$P(^DIC(5,ECSTA,1,ECCTY,0),"^",3),1:"")
"RTN","ECXSETUP",51,0)
 S ECODE=ECODE_"^"_STATE_"^"_COUNTY_"^"_$P(D1,"^",6),D1=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),"^",9) I D1 S D1=$C(D1+64)
"RTN","ECXSETUP",52,0)
 S ECM=$P($G(^DG(408.32,+$P(D0,"^",14),0)),"^",2)
"RTN","ECXSETUP",53,0)
 S ECODE=ECODE_"^"_D1_"^"_$P($G(^DPT(DFN,"VET")),"^")_"^"_$P($G(^DPT(DFN,.321))_"^^^^","^",1,3)_"^"_$P($G(^DPT(DFN,.52)),"^",5)_"^"_$P($G(^DIC(21,+$P($G(^DPT(DFN,.32)),"^",3),0)),"^",3)_"^"_ECM_"^"_$P(D0,"^",5)
"RTN","ECXSETUP",54,0)
 S W=$P(EC,"^",6),FAC=$P($G(^DIC(42,+W,0)),"^",11),W=$P($G(^DIC(42,+W,44)),"^")
"RTN","ECXSETUP",55,0)
 S ECTS="" F J=1:1:10 S ECT1=$G(^DGPM(ECDA+J,0)) I $P(ECT1,"^",14)=ECDA,$P(ECT1,"^",2)=6 S ECTS=ECT1 Q
"RTN","ECXSETUP",56,0)
 ;get corresponding Treating specialty - should be the next one, but must be close
"RTN","ECXSETUP",57,0)
 S ECODE=FAC_"^"_ECODE_"^"_W_"^"_$P($G(^DIC(45.7,+$P(ECTS,"^",9),0)),"^",2)_"^"_ECPRO_$P(ECTS,"^",19)_"^"_ECDA
"RTN","ECXSETUP",58,0)
 S (ECDRG,ECDIA)="",ECPTF=+$P(EC,"^",16) I ECPTF,$D(^DGPT(ECPTF,"M")) D PTF S ECODE=ECODE_"^"_ECDRG_"^"_ECDIA
"RTN","ECXSETUP",59,0)
 S $P(ECODE,"^",31)=ECTM,$P(ECODE,"^",32)=ECPTPR,$P(ECODE,"^",33)=$P($G(^DIC(10,+$P(D0,"^",6),0)),"^",2)_"^^"
"RTN","ECXSETUP",60,0)
 ;facility^dfn^ssn^name^in/out^day^primary care team^sex^dob^religion^employment status^health ins^state^county^zip^eligibility^
"RTN","ECXSETUP",61,0)
 ;vet^vietnam^agent orange^radiation^pow^period of service^means test^marital status^ward^treating specialty^
"RTN","ECXSETUP",62,0)
 ;attending physician^mov #^DRG^diagnosis^time^primary care provider^race
"RTN","ECXSETUP",63,0)
FILE S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXSETUP",64,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_ECXYM_"^"_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSETUP",65,0)
 I ECRN>499,'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSETUP",66,0)
 Q
"RTN","ECXSETUP",67,0)
 ;
"RTN","ECXSETUP",68,0)
GET1 ;look again for admission if the one we found was ASIH (ECAS=1)
"RTN","ECXSETUP",69,0)
 F EC1=EC1:0 S EC1=$O(^DGPM("ATID1",DFN,EC1)) Q:'EC1  S ECDA=$O(^(EC1,0)) I ECDA,$D(^DGPM(ECDA,0)) S EC=^DGPM(ECDA,0) I $P(EC,"^",18)'=40 S ECX=$P(EC,"^",17) Q
"RTN","ECXSETUP",70,0)
 I EC1,ECDA,$S('ECX:1,'$D(^DGPM(ECX,0)):1,^DGPM(ECX,0)>ECD:1,1:0) D GET ; find the admission movement (not ASIH) for this ASIH movement
"RTN","ECXSETUP",71,0)
 Q
"RTN","ECXSETUP",72,0)
 ;
"RTN","ECXSETUP",73,0)
 ;
"RTN","ECXSETUP",74,0)
PTF ; get admitting DRG and diagnosis from PTF
"RTN","ECXSETUP",75,0)
 ;use number for DRG and .01 for diagnosis
"RTN","ECXSETUP",76,0)
 S EC=1 I $D(^DGPT(ECPTF,"M",2,0)) S EC=2
"RTN","ECXSETUP",77,0)
 S EC2=+$P(^DGPT(ECPTF,"M",EC,0),"^",5),ECDRG=$P($G(^DGPT(ECPTF,"M",EC,"P")),"^")
"RTN","ECXSETUP",78,0)
 S ECDIA=$P($G(^ICD9(EC2,0)),"^") Q
"RTN","ECXSETUP",79,0)
 ;
"RTN","ECXSETUP",80,0)
 ;
"RTN","ECXSURG")
0^15^B20313637
"RTN","ECXSURG",1,0)
ECXSURG ;BIR/DMA,PTD-Surgery Extract for DSS ; [ 03/20/97  3:04 PM ]
"RTN","ECXSURG",2,0)
 ;;3.0;DSS EXTRACTS;**1,11**;Dec 22, 1997
"RTN","ECXSURG",3,0)
BEG ;entry point from option
"RTN","ECXSURG",4,0)
 D SETUP
"RTN","ECXSURG",5,0)
 D ^ECXTRAC
"RTN","ECXSURG",6,0)
 D ^ECXKILL
"RTN","ECXSURG",7,0)
 Q
"RTN","ECXSURG",8,0)
 ;
"RTN","ECXSURG",9,0)
START ;
"RTN","ECXSURG",10,0)
 S QFLG=0
"RTN","ECXSURG",11,0)
 S ECED=ECED+.3
"RTN","ECXSURG",12,0)
 S ECD=ECSD1 F  S ECD=$O(^SRF("AC",ECD)),ECD0=0 Q:'ECD  Q:ECD>ECED  F  S ECD0=$O(^SRF("AC",ECD,ECD0)) Q:'ECD0  I $D(^SRF(ECD0,0)) S EC0=^(0),DFN=+EC0 I $D(^DPT(DFN,0)) S ECP=^(0) D STUFF Q:QFLG
"RTN","ECXSURG",13,0)
 Q
"RTN","ECXSURG",14,0)
 ;
"RTN","ECXSURG",15,0)
STUFF ;gather data - ECODE0=basic info, ECODE full data
"RTN","ECXSURG",16,0)
 S SSN=$P(ECP,"^",9),ECNA=$E($P($P(ECP,"^"),",")_"    ",1,4)
"RTN","ECXSURG",17,0)
 S ECPTTM=+$$OUTPTTM^ECXUTL3(DFN,ECD)
"RTN","ECXSURG",18,0)
 S:ECPTTM=0 ECPTTM=""
"RTN","ECXSURG",19,0)
 S ECPTPR=+$$OUTPTPR^ECXUTL3(DFN,ECD)
"RTN","ECXSURG",20,0)
 S:ECPTPR=0 ECPTPR=""
"RTN","ECXSURG",21,0)
 S DATA1=$S($D(^SRF(ECD0,.1)):^(.1),1:0),DATA2=$S($D(^(.2)):^(.2),1:""),DATAOP=$S($D(^("OP")):^("OP"),1:""),ECDIV=$S($D(^(8)):^(8),1:ECINST),ECANE="",ECSR=$P(DATA1,"^",4),ECAT=$P(DATA1,"^",13),ECNO=$G(^("NON"))
"RTN","ECXSURG",22,0)
 S ECTM=$$ECXTIME^ECXUTL($P(DATA2,"^",10)) I $P(ECNO,"^")="Y" S ECTM=$$ECXTIME^ECXUTL($P(ECNO,"^",4))
"RTN","ECXSURG",23,0)
 S ECCAN=$G(^SRF(ECD0,30))>0 I ECCAN!('$P(DATA2,"^",10)&($P(ECNO,"^")'="Y")) Q
"RTN","ECXSURG",24,0)
 ;quit if cancelled or no pt. in oper. rm. time
"RTN","ECXSURG",25,0)
 ;look for non-OR
"RTN","ECXSURG",26,0)
 I $P(ECNO,"^")="Y" S ECSR=$P(ECNO,"^",6),ECAT=$P(ECNO,"^",7),A1=$P(ECNO,"^",5),A2=$P(ECNO,"^",4),TIME="##" D:(A1&A2) TIME S ECNT=TIME
"RTN","ECXSURG",27,0)
 S ECNL="" I $P(ECNO,"^")="Y" S ECNL=+$P(ECNO,"^",2),ECNL=$P($G(^ECX(728.44,ECNL,0)),"^",9) I ECNL="" S ECNL="UNKNOWN"
"RTN","ECXSURG",28,0)
 S ECSA=$P($G(^SRF(ECD0,.3)),"^",4),ECO=$P($G(^SRF(ECD0,0)),"^",2) S ECORTY=$P($G(^SRS(+ECO,2)),"^"),ECO=$P($G(^SRS(+ECO,0)),"^")
"RTN","ECXSURG",29,0)
 S:ECAT ECAT=2_ECAT S:ECSR ECSR=2_ECSR S:ECSA ECSA=2_ECSA
"RTN","ECXSURG",30,0)
 ;add leading 2s for pointer to 200
"RTN","ECXSURG",31,0)
 S J=$O(^SRF(ECD0,6,0)) I J,$D(^(J,0)) S ECANE=$P(^(0),"^") I $P(^(0),"^",3)'="Y" F  S J=$O(^SRF(ECD0,6,J)) Q:'J  I $D(^(J,0)),$P(^(0),"^",3)="Y" S ECANE=$P(^(0),"^") Q
"RTN","ECXSURG",32,0)
 S ECSS=$P($G(^SRO(137.45,+$P(EC0,"^",4),0)),"^",2)
"RTN","ECXSURG",33,0)
 S ECSS=$$RJ^XLFSTR($P($G(^DIC(45.3,+ECSS,0)),"^"),3,0) S:ECSS="000" ECSS="999"
"RTN","ECXSURG",34,0)
 S ECODE0=ECDIV_"^"_DFN_"^"_SSN_"^"_ECNA_"^"_$S($P(EC0,"^",12)="I":3,1:1)_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECD0_"^"_ECSS_"^"_ECO_"^"_ECSR_"^"_ECAT_"^"_ECSA_"^"_ECANE
"RTN","ECXSURG",35,0)
 ;ECODE0=division^dfn^ssn^name^in/out^day^case #^surg specialty^or room #^surgeon^attending^anesthesia supervisor^anesthesia technique
"RTN","ECXSURG",36,0)
 ;
"RTN","ECXSURG",37,0)
 ;get service of attending surgeon
"RTN","ECXSURG",38,0)
 S ECAT=$E(ECAT,2,$L(ECAT))
"RTN","ECXSURG",39,0)
 ;remove leading 2
"RTN","ECXSURG",40,0)
 S ECATSV=$P($G(^DIC(49,+$G(^VA(200,+ECAT,5)),730)),"^")
"RTN","ECXSURG",41,0)
 ;get primary
"RTN","ECXSURG",42,0)
 S ECPT=+$P(DATAOP,"^",2),ECPT=$P($G(^ICPT(ECPT,0)),"^")
"RTN","ECXSURG",43,0)
 S ECODE=ECODE0_"^P^"_ECPT_"^"
"RTN","ECXSURG",44,0)
 F J="10,12","2,3","1,4" S A2=$P(DATA2,"^",$P(J,",")),A1=$P(DATA2,"^",$P(J,",",2)),TIME="##" D:(A1&A2) TIME S ECODE=ECODE_"^"_TIME K TIME
"RTN","ECXSURG",45,0)
 S ECRR="" I $D(^SRF(ECD0,1.1)) S A1=$P(^(1.1),"^",8),A2=$P(^(1.1),"^",7),TIME="##" D:(A1&A2) TIME S ECRR=TIME K TIME
"RTN","ECXSURG",46,0)
 I ECNL]"" S $P(ECODE,"^",18)=ECNT
"RTN","ECXSURG",47,0)
 ;primary=ECODE0^P^CPT code^^patient time^operation time^anesthesia time
"RTN","ECXSURG",48,0)
 D FILE K EC0,DATA1,DATA2,DATA6,DATAOP,ECPT
"RTN","ECXSURG",49,0)
 ;get secondaries
"RTN","ECXSURG",50,0)
 S J=0 F  S J=$O(^SRF(ECD0,13,J)) Q:'J  I $D(^(J,0)),$D(^(2)),$P(^(2),"^")]"" S ECPT=$P(^(2),"^"),ECODE=ECODE0_"^S^"_$P($G(^ICPT(ECPT,0)),"^")_"^" D FILE
"RTN","ECXSURG",51,0)
 ;secondary=ECODE0^S^CPT code^
"RTN","ECXSURG",52,0)
 ;get prostheses
"RTN","ECXSURG",53,0)
 S J=0 F  S J=$O(^SRF(ECD0,1,J)) Q:'J  I $D(^(J,0)) S X=+^(0),Q=$P($G(^(1)),"^",2) S:'Q Q=1 S ECODE=ECODE0_"^I^^^^^^"_X_"^"_Q_"^^" D FILE
"RTN","ECXSURG",54,0)
 ;prosthesis=ECODE0^I^^^^^^prosthesis^quantity^
"RTN","ECXSURG",55,0)
 K J,Q,X
"RTN","ECXSURG",56,0)
 Q
"RTN","ECXSURG",57,0)
FILE ;add movement number^treating speciality^cancelled^time^OR type^attending's service^non-or dss id^recovery room time^^primary care team^primary care provider^admission date
"RTN","ECXSURG",58,0)
 D INP S $P(ECODE,"^",5)=ECA,$P(ECODE,"^",23,33)=ECMN_"^"_ECTS_"^"_$S(ECCAN:"C",1:"")_"^"_ECTM_"^"_ECORTY_"^"_ECATSV_"^"_ECNL_"^"_ECRR_"^^"_ECPTTM_"^"_ECPTPR_"^"_ECXADD_"^"
"RTN","ECXSURG",59,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXSURG",60,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSURG",61,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSURG",62,0)
 Q
"RTN","ECXSURG",63,0)
 ;
"RTN","ECXSURG",64,0)
TIME ; given date/time get increment
"RTN","ECXSURG",65,0)
 ;A1=later, A2=earlier, TIME=difference
"RTN","ECXSURG",66,0)
 S TIME=$TR($J($$FMDIFF^XLFDT(A1,A2,2)/900,6,0)," ") I TIME<0 S TIME="###"
"RTN","ECXSURG",67,0)
 Q
"RTN","ECXSURG",68,0)
SETUP S ECPACK="Surgery",ECPIECE=5,ECRTN="START^ECXSURG",ECGRP="SURG",ECHEAD="SUR",ECFILE=727.811,ECVER=7
"RTN","ECXSURG",69,0)
 Q
"RTN","ECXSURG",70,0)
 ;
"RTN","ECXSURG",71,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXSURG",72,0)
 S ECA=1,(ECTS,ECXADD)="" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXSURG",73,0)
 I ECMN S ECXADD=$P(VAIP(13,1),"^",1),ECXADD=$$ECXDATE^ECXUTL(ECXADD,ECXYM)
"RTN","ECXSURG",74,0)
 K VAIP,VAERR
"RTN","ECXSURG",75,0)
 Q
"RTN","ECXSURG",76,0)
 ;
"RTN","ECXSURG",77,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSURG",78,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXUTL3")
0^16^B1803795
"RTN","ECXUTL3",1,0)
ECXUTL3 ;ALB/GTS - Utilities for DSS Extracts ;October 2, 1998
"RTN","ECXUTL3",2,0)
 ;;3.0;DSS EXTRACTS;**11**;Dec 22, 1997
"RTN","ECXUTL3",3,0)
 ;
"RTN","ECXUTL3",4,0)
OUTPTTM(ECXDFN,ECXDT) ;* Return PC Team from PCMM files or DPT
"RTN","ECXUTL3",5,0)
 ; Variables -
"RTN","ECXUTL3",6,0)
 ;            ECXDFN - IEN from Patient file (Required)
"RTN","ECXUTL3",7,0)
 ;            ECXDT  - Relevant Date for Primary Care Team
"RTN","ECXUTL3",8,0)
 ;                      (Defaults to DT)
"RTN","ECXUTL3",9,0)
 ;
"RTN","ECXUTL3",10,0)
 ; Returned: ECXTM -
"RTN","ECXUTL3",11,0)
 ;            Pointer to team file (#404.51)
"RTN","ECXUTL3",12,0)
 ;            or, if error or none defined, returns 0
"RTN","ECXUTL3",13,0)
 ;
"RTN","ECXUTL3",14,0)
 Q:'$G(ECXDFN) 0 ;** Quit if ECXDFN not defined
"RTN","ECXUTL3",15,0)
 N ECXTM
"RTN","ECXUTL3",16,0)
 S:'$D(ECXDT) ECXDT=DT
"RTN","ECXUTL3",17,0)
 I $T(OUTPTTM^SDUTL3)[",SCDATE" D
"RTN","ECXUTL3",18,0)
 .S ECXTM=+$$OUTPTTM^SDUTL3(ECXDFN,ECXDT)
"RTN","ECXUTL3",19,0)
 I $T(OUTPTTM^SDUTL3)'[",SCDATE" D
"RTN","ECXUTL3",20,0)
 .S ECXTM=+$$OUTPTTM^SDUTL3(ECXDFN)
"RTN","ECXUTL3",21,0)
 I ECXTM=0 D
"RTN","ECXUTL3",22,0)
 .S ECXTM=+$P($G(^DPT(+ECXDFN,"PC")),U,2)
"RTN","ECXUTL3",23,0)
 Q ECXTM
"RTN","ECXUTL3",24,0)
 ;
"RTN","ECXUTL3",25,0)
OUTPTPR(ECXDFN,ECXDT) ;* Return PC Provider from PCMM files or DPT
"RTN","ECXUTL3",26,0)
 ; Variables -
"RTN","ECXUTL3",27,0)
 ;            ECXDFN - IEN from Patient file (Required)
"RTN","ECXUTL3",28,0)
 ;            ECXDT  - Relevant Date for Primary Care Provider
"RTN","ECXUTL3",29,0)
 ;                      (Defaults to DT)
"RTN","ECXUTL3",30,0)
 ;
"RTN","ECXUTL3",31,0)
 ; Returned: ECXPR -
"RTN","ECXUTL3",32,0)
 ;            Pointer to file #200 
"RTN","ECXUTL3",33,0)
 ;            or, if error or none defined, returns a 0
"RTN","ECXUTL3",34,0)
 ;
"RTN","ECXUTL3",35,0)
 Q:'$G(ECXDFN) 0 ;** Quit if ECXDFN not defined
"RTN","ECXUTL3",36,0)
 N ECXPR
"RTN","ECXUTL3",37,0)
 S:'$D(ECXDT) ECXDT=DT
"RTN","ECXUTL3",38,0)
 I $T(OUTPTPR^SDUTL3)[",SCDATE" D
"RTN","ECXUTL3",39,0)
 .S ECXPR=+$$OUTPTPR^SDUTL3(ECXDFN,ECXDT)
"RTN","ECXUTL3",40,0)
 I $T(OUTPTPR^SDUTL3)'[",SCDATE" D
"RTN","ECXUTL3",41,0)
 .S ECXPR=+$$OUTPTPR^SDUTL3(ECXDFN)
"RTN","ECXUTL3",42,0)
 I ECXPR=0 D
"RTN","ECXUTL3",43,0)
 .S ECXPR=+$G(^DPT(+ECXDFN,"PC"))
"RTN","ECXUTL3",44,0)
 Q ECXPR
"VER")
8.0^21.0
**END**
**END**
