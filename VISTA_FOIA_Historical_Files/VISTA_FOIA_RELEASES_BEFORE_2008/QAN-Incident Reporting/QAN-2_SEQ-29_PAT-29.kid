Released QAN*2*29 SEQ #29
Extracted from mail message
**KIDS**:QAN*2.0*29^

**INSTALL NAME**
QAN*2.0*29
"BLD",2382,0)
QAN*2.0*29^INCIDENT REPORTING^0^3000913^y
"BLD",2382,4,0)
^9.64PA^^
"BLD",2382,"ABNS",0)
^9.66A^1^1
"BLD",2382,"ABNS",1,0)
QAN
"BLD",2382,"ABNS",1,1,0)
^9.661A^^
"BLD",2382,"ABNS","B","QAN",1)

"BLD",2382,"ABPKG")
n^n
"BLD",2382,"KRN",0)
^9.67PA^19^17
"BLD",2382,"KRN",.4,0)
.4
"BLD",2382,"KRN",.401,0)
.401
"BLD",2382,"KRN",.402,0)
.402
"BLD",2382,"KRN",.402,"NM",0)
^9.68A^2^2
"BLD",2382,"KRN",.402,"NM",1,0)
QAN ENTER TIME    FILE #742.4^742.4^0
"BLD",2382,"KRN",.402,"NM",2,0)
QAN QUICK EDIT    FILE #742.4^742.4^0
"BLD",2382,"KRN",.402,"NM","B","QAN ENTER TIME    FILE #742.4",1)

"BLD",2382,"KRN",.402,"NM","B","QAN QUICK EDIT    FILE #742.4",2)

"BLD",2382,"KRN",.403,0)
.403
"BLD",2382,"KRN",.5,0)
.5
"BLD",2382,"KRN",.84,0)
.84
"BLD",2382,"KRN",3.6,0)
3.6
"BLD",2382,"KRN",3.8,0)
3.8
"BLD",2382,"KRN",9.2,0)
9.2
"BLD",2382,"KRN",9.8,0)
9.8
"BLD",2382,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",2382,"KRN",9.8,"NM",1,0)
QANBENE0^^0^B36305763
"BLD",2382,"KRN",9.8,"NM",2,0)
QANCDNT^^0^B64792066
"BLD",2382,"KRN",9.8,"NM",3,0)
QANQUCK^^0^B18402141
"BLD",2382,"KRN",9.8,"NM",4,0)
QANRPT1^^0^B40805977
"BLD",2382,"KRN",9.8,"NM",5,0)
QANRPT2^^0^B22253022
"BLD",2382,"KRN",9.8,"NM",6,0)
QANUTL3^^0^B9957646
"BLD",2382,"KRN",9.8,"NM","B","QANBENE0",1)

"BLD",2382,"KRN",9.8,"NM","B","QANCDNT",2)

"BLD",2382,"KRN",9.8,"NM","B","QANQUCK",3)

"BLD",2382,"KRN",9.8,"NM","B","QANRPT1",4)

"BLD",2382,"KRN",9.8,"NM","B","QANRPT2",5)

"BLD",2382,"KRN",9.8,"NM","B","QANUTL3",6)

"BLD",2382,"KRN",19,0)
19
"BLD",2382,"KRN",19.1,0)
19.1
"BLD",2382,"KRN",101,0)
101
"BLD",2382,"KRN",409.61,0)
409.61
"BLD",2382,"KRN",771,0)
771
"BLD",2382,"KRN",870,0)
870
"BLD",2382,"KRN",8994,0)
8994
"BLD",2382,"KRN","B",.4,.4)

"BLD",2382,"KRN","B",.401,.401)

"BLD",2382,"KRN","B",.402,.402)

"BLD",2382,"KRN","B",.403,.403)

"BLD",2382,"KRN","B",.5,.5)

"BLD",2382,"KRN","B",.84,.84)

"BLD",2382,"KRN","B",3.6,3.6)

"BLD",2382,"KRN","B",3.8,3.8)

"BLD",2382,"KRN","B",9.2,9.2)

"BLD",2382,"KRN","B",9.8,9.8)

"BLD",2382,"KRN","B",19,19)

"BLD",2382,"KRN","B",19.1,19.1)

"BLD",2382,"KRN","B",101,101)

"BLD",2382,"KRN","B",409.61,409.61)

"BLD",2382,"KRN","B",771,771)

"BLD",2382,"KRN","B",870,870)

"BLD",2382,"KRN","B",8994,8994)

"BLD",2382,"QUES",0)
^9.62^^
"BLD",2382,"REQB",0)
^9.611^3^3
"BLD",2382,"REQB",1,0)
QAN*2.0*28^1
"BLD",2382,"REQB",2,0)
QAN*2.0*26^1
"BLD",2382,"REQB",3,0)
QAQ*1.7*7^1
"BLD",2382,"REQB","B","QAN*2.0*26",2)

"BLD",2382,"REQB","B","QAN*2.0*28",1)

"BLD",2382,"REQB","B","QAQ*1.7*7",3)

"KRN",.402,2432,-1)
0^1
"KRN",.402,2432,0)
QAN ENTER TIME^3000830.1734^@^742.4^^@^3000830
"KRN",.402,2432,"DIAB",4,0,742.4,0)
.03;"DATE/TIME OF INCIDENT"
"KRN",.402,2432,"DR",1,742.4)
.02;@3;I $P(^QA(740,1,"QAN"),U,6)'=1 S Y="@4";.03DATE/TIME OF INCIDENT~;I $P(X,".",2)']"" W !," You must enter a TIME and date." S Y="@3";S Y="@5";@4;.03;@5;.04;
"KRN",.402,2433,-1)
0^2
"KRN",.402,2433,0)
QAN QUICK EDIT^3000509.1337^@^742.4^^@^3000509
"KRN",.402,2433,"DR",1,742.4)
.02;I X'=$G(QANDEATH) S Y="@1";.15;@1;@2;.03;I $P(^QA(740,1,"QAN"),U,6)'=1 S Y="@3";I $P(X,".",2)']"" W !,"  You must enter a TIME and a date." S Y="@2";@3;
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"PKG",371,-1)
1^1
"PKG",371,0)
INCIDENT REPORTING^QAN^This package is designed to track a hospital incident.
"PKG",371,20,0)
^9.402P^^
"PKG",371,22,0)
^9.49I^1^1
"PKG",371,22,1,0)
2.0^2921015^2950914
"PKG",371,22,1,"PAH",1,0)
29^3000913
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","QANBENE0")
0^1^B36305763
"RTN","QANBENE0",1,0)
QANBENE0 ;HISC/GJC-SPECIAL INCIDENTS INVOL. A BENEFICIARY ;4/13/93  08:24
"RTN","QANBENE0",2,0)
 ;;2.0;Incident Reporting;**18,26,28,29**;08/07/1992
"RTN","QANBENE0",3,0)
 ;
"RTN","QANBENE0",4,0)
EN1 ;/*** Catagorize incidents ***/
"RTN","QANBENE0",5,0)
 K DIR S DIR(0)="FAO^1:1^K:""ACDINO""'[X X",DIR("A")="Select Ward type (A/C/D/I/N/O): "
"RTN","QANBENE0",6,0)
 S DIR("?",1)="Enter ""A"" to generate separate reports for Domiciliaries, NHCU'S, "
"RTN","QANBENE0",7,0)
 S DIR("?",2)="Inpatients and Outpatients."
"RTN","QANBENE0",8,0)
 S DIR("?",3)="Enter ""C"" to generate a report of combined data for Domiciliaries, NHCU'S, "
"RTN","QANBENE0",9,0)
 S DIR("?",4)="Inpatients and Outpatients."
"RTN","QANBENE0",10,0)
 S DIR("?",5)="Enter ""D"" for Domiciliary, ""I"" for Inpatients other than Domiciliary or "
"RTN","QANBENE0",11,0)
 S DIR("?")="NHCU, ""N"" for NHCU units, or ""O"" for Outpatients."
"RTN","QANBENE0",12,0)
 D ^DIR K DIR
"RTN","QANBENE0",13,0)
 I $D(DIRUT) D KILL Q
"RTN","QANBENE0",14,0)
 S QANFLG("WARD")=Y
"RTN","QANBENE0",15,0)
TASK ;Call to %ZTLOAD
"RTN","QANBENE0",16,0)
 S Y=DT X ^DD("DD") S TODAY=Y
"RTN","QANBENE0",17,0)
 K IOP,%ZIS S %ZIS("A")="Print on device: ",%ZIS="MQ" W ! D ^%ZIS W !!
"RTN","QANBENE0",18,0)
 G:POP KILL
"RTN","QANBENE0",19,0)
 I $D(IO("Q")) S ZTRTN="START^QANBENE0",ZTDESC="Generate Special Incident Reports For A Beneficiary." D QLOOP,^%ZTLOAD W !,$S($D(ZTSK):"Request Queued!",1:"Request Cancelled!"),! G EXIT
"RTN","QANBENE0",20,0)
START ;IO requests
"RTN","QANBENE0",21,0)
 U IO
"RTN","QANBENE0",22,0)
 I QANFLG("WARD")="A" S QANFLG("WARD A")="D^I^N^O"
"RTN","QANBENE0",23,0)
 I $D(QANFLG("WARD A")),(QANFLG("WARD A")="D^I^N^O") F QAN=1:1:$L(QANFLG("WARD A"),"^") Q:QANQUIT  S QANFLG("WARD")=$P(QANFLG("WARD A"),"^",QAN) Q:QANFLG("WARD")']""  D
"RTN","QANBENE0",24,0)
 . W @IOF
"RTN","QANBENE0",25,0)
 . S PAGE=0
"RTN","QANBENE0",26,0)
 . K ^TMP("QANBEN",$J),QANCOUNT
"RTN","QANBENE0",27,0)
 . D GO D:'QANQUIT HDH^QANBENE3 Q:QANQUIT
"RTN","QANBENE0",28,0)
 G:QANQUIT EXIT
"RTN","QANBENE0",29,0)
 I '$D(QANFLG("WARD A")) D GO
"RTN","QANBENE0",30,0)
 I $D(^TMP("QANBEN",$J,"NOBEN")) D PRNOBEN
"RTN","QANBENE0",31,0)
EXIT ;
"RTN","QANBENE0",32,0)
 W ! D ^%ZISC,HOME^%ZIS
"RTN","QANBENE0",33,0)
KILL ;Kill and quit.
"RTN","QANBENE0",34,0)
 K %ZIS,D,DIC,DIRUT,I,PAGE,POP
"RTN","QANBENE0",35,0)
 K QAN,QAN742,QAN7424,QANAA,QANAB,QANBB,QANBENE,QANCC,QANCONT
"RTN","QANBENE0",36,0)
 K QANCOUNT,QANDATE,QAN1DIV,QANDIV,QANDTH,QANDV,QANDVFLG
"RTN","QANBENE0",37,0)
 K QANFLG,QANHEAD,QANHLOC,QANINPT,QANLBL,QANLP,QANLWLT
"RTN","QANBENE0",38,0)
 K QANPTTY,QANQUIT,QANSLEV,QANSTAT,QANTAB,QANUPLT,QANWARD
"RTN","QANBENE0",39,0)
 K QANINVST,QANSITE,QANSWCH,QANWHICH
"RTN","QANBENE0",40,0)
 K QAQNBEG,QAQNEND
"RTN","QANBENE0",41,0)
 K TODAY,X,Y,ZTDESC,ZTRTN,ZTSAVE,ZTSK
"RTN","QANBENE0",42,0)
 D K^QAQDATE
"RTN","QANBENE0",43,0)
 K ^TMP("QANBEN",$J)
"RTN","QANBENE0",44,0)
 Q
"RTN","QANBENE0",45,0)
GO ;Set up variables.
"RTN","QANBENE0",46,0)
 S QANOWARD=0
"RTN","QANBENE0",47,0)
 S QANLP=QANLWLT
"RTN","QANBENE0",48,0)
 F  S QANLP=$O(^QA(742.4,"BDT",QANLP)) Q:QANLP'>0!(QANLP>QANUPLT)  D
"RTN","QANBENE0",49,0)
 . S QANLP(1)=0
"RTN","QANBENE0",50,0)
 . F  S QANLP(1)=$O(^QA(742.4,"BDT",QANLP,QANLP(1))) Q:QANLP(1)'>0  D
"RTN","QANBENE0",51,0)
 . . I $G(^QA(742.4,QANLP(1),0))]"" D LGIC I QANQUIT  S QANQUIT=0 Q
"RTN","QANBENE0",52,0)
 . . S QANLP(2)=0
"RTN","QANBENE0",53,0)
 . . F  S QANLP(2)=$O(^QA(742,"BCS",QANLP(1),QANLP(2))) Q:QANLP(2)'>0  D
"RTN","QANBENE0",54,0)
 . . . I $G(^QA(742,QANLP(2),0)) D LGIC1
"RTN","QANBENE0",55,0)
 . . . I QANQUIT S QANQUIT=0 Q
"RTN","QANBENE0",56,0)
 . . . S ^TMP("QANBEN",$J,"BEN",QANDIV,QANWARD,QANLP(1),QANLP(2))=""
"RTN","QANBENE0",57,0)
 S QANHEAD(3)=$S(QANFLG("WARD")="I":"INPATIENTS",QANFLG("WARD")="D":"DOMICILIARY",QANFLG("WARD")="N":"NHCU",QANFLG("WARD")="O":"OUTPATIENTS",1:"ALL INCIDENTS REGARDLESS OF LOCATION")
"RTN","QANBENE0",58,0)
 I $G(QANDVFLG)'=1 D HDR
"RTN","QANBENE0",59,0)
 D EN1^QANBENE1
"RTN","QANBENE0",60,0)
 Q
"RTN","QANBENE0",61,0)
LGIC ;Set up valid incidents
"RTN","QANBENE0",62,0)
 S QAN7424=^QA(742.4,QANLP(1),0),QAN("INC")=$P(QAN7424,U,2)
"RTN","QANBENE0",63,0)
 I QAN("INC")'<200 S QANQUIT=1 Q  ;Quit if NOT a National incident.
"RTN","QANBENE0",64,0)
 D VALID^QANBENE I 'QANSWCH S QANQUIT=1 Q  ;Quit if NOT a valid incident
"RTN","QANBENE0",65,0)
 S QANSTAT=+$P(QAN7424,U,8),QANBENE=+$P(QAN7424,U,17)
"RTN","QANBENE0",66,0)
 I 'QANBENE!(QANFLG("IR STAT")'[QANSTAT) S QANQUIT=1 Q
"RTN","QANBENE0",67,0)
 S QANDIV=$P(QAN7424,U,22)
"RTN","QANBENE0",68,0)
 I $G(QANDIV)']"" S QANDIV=0
"RTN","QANBENE0",69,0)
 I $G(QAN1DIV)]"" I QAN1DIV'=QANDIV S QANQUIT=1 Q
"RTN","QANBENE0",70,0)
 I '$D(^QA(740,1,"QAN2","B",QANDIV)) S QANDIV=0
"RTN","QANBENE0",71,0)
 I $G(QANDVFLG)'=1 S QANDIV=0
"RTN","QANBENE0",72,0)
 Q
"RTN","QANBENE0",73,0)
HDR ;Header generator.
"RTN","QANBENE0",74,0)
 S PAGE=PAGE+1 W @IOF,!?69,TODAY,!?69,"Page: ",PAGE,!!
"RTN","QANBENE0",75,0)
 W ?(IOM-$L(QANHEAD(0))\2),QANHEAD(0),!,?(IOM-$L(QANHEAD(1))\2),QANHEAD(1),!
"RTN","QANBENE0",76,0)
 W !?(IOM-$L(QANHEAD(2))\2),QANHEAD(2),!
"RTN","QANBENE0",77,0)
 W !?(IOM-$L(QANHEAD(3))\2),QANHEAD(3)
"RTN","QANBENE0",78,0)
 I $G(QANDVFLG)=1,($G(QANHEAD(4))]"") W !?(IOM-$L(QANHEAD(4))\2),QANHEAD(4)
"RTN","QANBENE0",79,0)
 W !!?QANTAB(5),"Total",?QANTAB(6),"Resulted in"
"RTN","QANBENE0",80,0)
 W !?QANTAB(2),"Incident",?QANTAB(4),"Severity",?QANTAB(5),"Number",?QANTAB(6),"Investigation",!?QANTAB(2),"--------",?QANTAB(4),"--------",?QANTAB(5),"------",?QANTAB(6),"-------------"
"RTN","QANBENE0",81,0)
 I QANCONT,$D(QANLBL) W !!?QANTAB(2),QANLBL_" (cont)"
"RTN","QANBENE0",82,0)
 Q
"RTN","QANBENE0",83,0)
LGIC1 ;Sorting wards into categories.
"RTN","QANBENE0",84,0)
 Q:$D(^QA(742,"BPRS",-1,QANLP(2)))  ;Quit if a deleted patient
"RTN","QANBENE0",85,0)
 S QAN742=^QA(742,QANLP(2),0)
"RTN","QANBENE0",86,0)
 S QANPTTY=+$P(QAN742,U,5),QANWARD=+$P(QAN742,U,6),QANSLEV=+$P(QAN742,U,10)
"RTN","QANBENE0",87,0)
 I $G(QANWARD)'>0 D
"RTN","QANBENE0",88,0)
 . S QANINUM=$P(QAN7424,U) ;Incident number
"RTN","QANBENE0",89,0)
 . S QANWHY="No ward entered for Incident." ;why excluded from report
"RTN","QANBENE0",90,0)
 . D NOBEN
"RTN","QANBENE0",91,0)
 . S QANQUIT=1 Q
"RTN","QANBENE0",92,0)
 I '$D(^SC(QANWARD)) D
"RTN","QANBENE0",93,0)
 . S QANINUM=$P(QAN7424,U) ;Incident number
"RTN","QANBENE0",94,0)
 . S QANWHY="Ward has no valid Hospital Location." ;why excluded
"RTN","QANBENE0",95,0)
 . D NOBEN
"RTN","QANBENE0",96,0)
 . S QANQUIT=1 Q
"RTN","QANBENE0",97,0)
 D WARD
"RTN","QANBENE0",98,0)
 Q
"RTN","QANBENE0",99,0)
QLOOP ;Save variables for %ZTLOAD.
"RTN","QANBENE0",100,0)
 F I="^TMP(""QANBEN"",$J,","PAGE","TODAY","QAN*","QAQ*" S ZTSAVE(I)=""
"RTN","QANBENE0",101,0)
 Q
"RTN","QANBENE0",102,0)
WARD ;determine if record should be included in report
"RTN","QANBENE0",103,0)
 S QANWARD=$G(^SC(QANWARD,42)) D
"RTN","QANBENE0",104,0)
 . I $G(QANWARD)']"" S QANWARD="O" Q
"RTN","QANBENE0",105,0)
 . I $G(QANWARD) S QANWARD=$P(^DIC(42,QANWARD,0),U,3)
"RTN","QANBENE0",106,0)
 . I $G(QANWARD)]"" S QANWARD=$S($G(QANWARD)="D":"D",$G(QANWARD)="NH":"N",1:"I") Q
"RTN","QANBENE0",107,0)
 . I $G(QANWARD)']"" S QANWARD="O"
"RTN","QANBENE0",108,0)
 S QANXXX=$S(QANFLG("WARD")="C":1,QANFLG("WARD")="A":1,QANFLG("WARD")=QANWARD:1,$G(QANFLG("WARD A")):1,1:0)
"RTN","QANBENE0",109,0)
 I QANXXX<1 S QANQUIT=1 Q
"RTN","QANBENE0",110,0)
 Q
"RTN","QANBENE0",111,0)
TALLY ;create and increment globals for report
"RTN","QANBENE0",112,0)
 S QANCOUNT("SLEV",QANAA,QANLBL,QANSLEV)=$G(QANCOUNT("SLEV",QANAA,QANLBL,QANSLEV))+1
"RTN","QANBENE0",113,0)
 I $G(QANINVST)>1 S QANCOUNT("INV",QANAA,QANLBL,QANSLEV)=$G(QANCOUNT("INV",QANAA,QANLBL,QANSLEV))+1
"RTN","QANBENE0",114,0)
 Q
"RTN","QANBENE0",115,0)
NOBEN ;process those records without valid ward information for exception
"RTN","QANBENE0",116,0)
 ;report
"RTN","QANBENE0",117,0)
 S QANOWARD=QANOWARD+1
"RTN","QANBENE0",118,0)
 S ^TMP("QANBEN",$J,"NOBEN",QANOWARD)=QANINUM_"^"_QANWHY
"RTN","QANBENE0",119,0)
 Q
"RTN","QANBENE0",120,0)
PRNOBEN ;print list of records excluded from report
"RTN","QANBENE0",121,0)
 I '$D(^TMP("QANBEN",$J,"NOBEN")) Q
"RTN","QANBENE0",122,0)
 D HDH2
"RTN","QANBENE0",123,0)
 W !!!?25,"EXCEPTION REPORT"
"RTN","QANBENE0",124,0)
 W !?10,"The following records were excluded from this report."
"RTN","QANBENE0",125,0)
 W !?10,"_____________________________________________________"
"RTN","QANBENE0",126,0)
 W !!?5,"Incident Number",?35,"Reason for Exclusion"
"RTN","QANBENE0",127,0)
 W !?5,"---------------",?35,"--------------------"
"RTN","QANBENE0",128,0)
 S QANE=0
"RTN","QANBENE0",129,0)
 F  S QANE=$O(^TMP("QANBEN",$J,"NOBEN",QANE)) Q:QANE'>0  D
"RTN","QANBENE0",130,0)
 . S QANLINE=^TMP("QANBEN",$J,"NOBEN",QANE)
"RTN","QANBENE0",131,0)
 . D:$Y>(IOSL-4) HDH^QANBENE2 Q:QANQUIT
"RTN","QANBENE0",132,0)
 . W !?6,$P(QANLINE,U),?32,$P(QANLINE,U,2)
"RTN","QANBENE0",133,0)
 W !!!?25,"End of Report."
"RTN","QANBENE0",134,0)
 Q
"RTN","QANBENE0",135,0)
HDH2 ;header for exception report
"RTN","QANBENE0",136,0)
 W @IOF
"RTN","QANBENE0",137,0)
 W !?(IOM-$L(QANHEAD(0))\2),QANHEAD(0)
"RTN","QANBENE0",138,0)
 W !?(IOM-$L(QANHEAD(1))\2),QANHEAD(1)
"RTN","QANBENE0",139,0)
 W !!?(IOM-$L(QANHEAD(2))\2),QANHEAD(2)
"RTN","QANBENE0",140,0)
 Q
"RTN","QANCDNT")
0^2^B64792066
"RTN","QANCDNT",1,0)
QANCDNT ;HISC/GJC-Initial sighting of an incident ;10/9/92
"RTN","QANCDNT",2,0)
 ;;2.0;Incident Reporting;**1,9,14,27,26,28,29**;08/07/1992
"RTN","QANCDNT",3,0)
 ;
"RTN","QANCDNT",4,0)
 N QANQFLG
"RTN","QANCDNT",5,0)
 D NEWREC ;I $G(QANLOCK)=1 L -^QA(742.4) S QANLOCK=0 Q
"RTN","QANCDNT",6,0)
 D DIV
"RTN","QANCDNT",7,0)
 I $G(QANQFLG)=1 D DEL Q
"RTN","QANCDNT",8,0)
 D DIE
"RTN","QANCDNT",9,0)
 Q
"RTN","QANCDNT",10,0)
NEWREC  ;create new record number
"RTN","QANCDNT",11,0)
 ;record number will be in the format XXX.YYnnnn where XXX is the
"RTN","QANCDNT",12,0)
 ;three digit station number, YY is the 2 digit year and nnnn is
"RTN","QANCDNT",13,0)
 ;the sequence number (and is also the IEN of file 742.4)
"RTN","QANCDNT",14,0)
 N EE,QANCNT,QANLIST,QANNO,QANQFLG
"RTN","QANCDNT",15,0)
 K QANLOCK
"RTN","QANCDNT",16,0)
 S (QANFLAG,QANXIT,QANOUT)=0,QANST=$S($D(^QA(740,1,0))#2:$P(^(0),"^"),1:""),QANST1=$S($D(^DIC(4,QANST,99))#2:$P(^(99),"^"),1:QANST)
"RTN","QANCDNT",17,0)
 S QANDUZ=$S($D(DUZ):DUZ,1:""),QANTTL=$P(^VA(200,QANDUZ,0),U,9)
"RTN","QANCDNT",18,0)
 ;set QANDT variable as "." concatonated with 2 digit year so that
"RTN","QANCDNT",19,0)
 ;years 2000-2009 don't have leading zeroes.
"RTN","QANCDNT",20,0)
 S QANDT=$S($D(DT):$E(DT,2,3),1:""),QANDT="."_QANDT
"RTN","QANCDNT",21,0)
 S QANINCR=+$P($G(^QA(742.4,0)),U,3)+1 ;Grab the new IEN
"RTN","QANCDNT",22,0)
 F  Q:$D(^QA(742.4,QANINCR,0))=0  S QANINCR=QANINCR+1
"RTN","QANCDNT",23,0)
 S QANCODE(0)=QANDT_QANINCR
"RTN","QANCDNT",24,0)
 I $L(QANINCR)<4 S QANCODE(0)=QANDT_$E("000",1,(4-$L(QANINCR)))_QANINCR
"RTN","QANCDNT",25,0)
 S QANCODE(1)=QANST1_QANCODE(0)
"RTN","QANCDNT",26,0)
 S QANCHK=$O(^QA(742.4,"B",QANCODE(1),0)) I +QANCHK,$D(^(QANCHK))#2 D  Q
"RTN","QANCDNT",27,0)
 . W !!,$C(7),"CASE NUMBER VIOLATION, CONTACT YOUR QA COORDINATOR!!"
"RTN","QANCDNT",28,0)
 . S QANXIT=1
"RTN","QANCDNT",29,0)
 . K QANST,QANST1,QANDT,QANCODE,QANINCR,QANFLAG,QANOUT,QANDUZ,QANCHK,QANTTL
"RTN","QANCDNT",30,0)
 I $G(QANXIT)=1 Q
"RTN","QANCDNT",31,0)
 K DIC,DD,DO,DLAYGO,DINUM S (DIC,DIE)="^QA(742.4,",DIC(0)="L",X=QANCODE(1)
"RTN","QANCDNT",32,0)
 D FILE^DICN
"RTN","QANCDNT",33,0)
 K DIC,DD,DO,DLAYGO,DINUM
"RTN","QANCDNT",34,0)
 L +^QA(742.4,+Y):3 I '$T W !!,"Another user is editing this incident." S QANLOCK=1 Q
"RTN","QANCDNT",35,0)
 S QANBFLG=1 ;set brief flag so that if this subroutine was called
"RTN","QANCDNT",36,0)
 ;from full incident edit you do not re-lock the record when you
"RTN","QANCDNT",37,0)
 ;get back to full incident edit.
"RTN","QANCDNT",38,0)
 Q:+Y<1  S QANIEN=+Y
"RTN","QANCDNT",39,0)
 S QANHOME=$G(^QA(742.4,QANIEN,0)),$P(QANHOME,U,5)=QANDUZ,$P(QANHOME,U,6)=QANTTL,$P(QANHOME,U,15)=1,$P(QANHOME,U,8)=1
"RTN","QANCDNT",40,0)
 K DA,DIK S DIK="^QA(742.4,",DA=QANIEN,^QA(742.4,QANIEN,0)=QANHOME D IX1^DIK K DA,DIK
"RTN","QANCDNT",41,0)
 Q
"RTN","QANCDNT",42,0)
DIV ;check to see if station is multi-divisional for Incid Reporting.  If
"RTN","QANCDNT",43,0)
 ;so, and there are hosp locations in file 740 (node "QAN2") then
"RTN","QANCDNT",44,0)
 ;prompt user for Division.
"RTN","QANCDNT",45,0)
 I $P($G(^QA(740,1,"QAN")),U,5)=1 S TEMPY=$G(Y) D  S Y=$G(TEMPY)
"RTN","QANCDNT",46,0)
 . W !!,"DIVISION: "
"RTN","QANCDNT",47,0)
 . S QANCNT=0 S QANLIST="S EE=0 F  S EE=$O(^QA(740,1,""QAN2"",EE)) Q:EE'>0  W !?5,EE,?10,$P(^DIC(4,$P(^QA(740,1,""QAN2"",EE,0),U),0),U) S QANCNT=QANCNT+1"
"RTN","QANCDNT",48,0)
LIST . S QANCNT=0 X QANLIST
"RTN","QANCDNT",49,0)
 . I $G(QANCNT)<1 W !?5,"There are no divisions entered in your QA Site Parameter File (#704).",!?5,"Ask your IRM support person to edit this file.  If your site"
"RTN","QANCDNT",50,0)
 . I $G(QANCNT)<1 W !?5,"is entered in file #740 as a MULTI-DIVISIONAL INCID REP FACILITY you need",!?5,"entries in the IR HOSPITAL DIVISION multiple."
"RTN","QANCDNT",51,0)
 . S DIR(0)="NA"
"RTN","QANCDNT",52,0)
 . S DIR("A")="Enter the number of your choice: "
"RTN","QANCDNT",53,0)
 . S DIR("?")="Choose the number of your division."
"RTN","QANCDNT",54,0)
 . S DIR("??")="^S X=QANCNT X QANLIST"
"RTN","QANCDNT",55,0)
 . D ^DIR
"RTN","QANCDNT",56,0)
 . I $G(Y)']""!($G(Y)="^") D
"RTN","QANCDNT",57,0)
 . . W !!?5,"You must enter a Division.",!
"RTN","QANCDNT",58,0)
 . . D ^DIR
"RTN","QANCDNT",59,0)
 . . I $G(Y)']""!($G(Y)="^") S QANQFLG=1 Q
"RTN","QANCDNT",60,0)
 . I $G(QANQFLG)=1 Q
"RTN","QANCDNT",61,0)
 . I '$G(^QA(740,1,"QAN2",+Y,0)) W !,"Enter the number of your choice." S QANCNT=0 G LIST
"RTN","QANCDNT",62,0)
 . S QANNO=+Y
"RTN","QANCDNT",63,0)
 . S DIE="^QA(742.4,",DR="52///^S X=$P(^DIC(4,+^QA(740,1,""QAN2"",QANNO,0),0),U)"
"RTN","QANCDNT",64,0)
 . S DA=QANIEN
"RTN","QANCDNT",65,0)
 . D ^DIE I $D(Y)>0 S QANCNT=0 G LIST
"RTN","QANCDNT",66,0)
 Q
"RTN","QANCDNT",67,0)
DIE S DIE="^QA(742.4,",DA=QANIEN,DR="[QAN ENTER TIME]"
"RTN","QANCDNT",68,0)
 D ^DIE K DIE,DR I $D(Y) D DEL Q:QANXIT
"RTN","QANCDNT",69,0)
 S QANST=$P(^QA(742.4,QANIEN,0),U,2) I "12"[$P(^QA(742.1,QANST,0),U,2) S $P(^QA(742.4,QANIEN,0),U,9)=DT,QAQADICT=742.4,QAQAFLD=".1",X=DT D ENSET^QAQAXREF
"RTN","QANCDNT",70,0)
 K ^UTILITY($J,"QAN PAT") F  D PAT Q:QANXIT!(QANOUT)  ;get the patient
"RTN","QANCDNT",71,0)
 Q:QANXIT
"RTN","QANCDNT",72,0)
SC1 ;
"RTN","QANCDNT",73,0)
 K Y S DIE="^QA(742.4,",DA=QANIEN,DR=".05;@1;.08;S X=X" D ^DIE K DIE,DR I $D(Y) Q:QANXIT
"RTN","QANCDNT",74,0)
 K QAUDIT S QAUDIT("FILE")="742.4^50",QAUDIT("DA")=QANIEN,QAUDIT("ACTION")="o",QAUDIT("COMMENT")="Open an incident record" D ^QAQAUDIT
"RTN","QANCDNT",75,0)
 S DIE="^QA(742.4,",DR=".09///"_1,DA=QANIEN D ^DIE ; Set 'Local Case' flag to open.
"RTN","QANCDNT",76,0)
 I $G(QANFFLG)<1 D DISP
"RTN","QANCDNT",77,0)
 I $G(QANFFLG)<0 L -^QA(742.4,QANIEN) ;if this subroutine has not
"RTN","QANCDNT",78,0)
 ;been called from the full incident edit, then unlock incident report.
"RTN","QANCDNT",79,0)
 ;D ^QANBRIF ;transmit message to local mail group
"RTN","QANCDNT",80,0)
 Q
"RTN","QANCDNT",81,0)
DEL ;Delete incident.
"RTN","QANCDNT",82,0)
 K DIK S DIK="^QA(742.4,",DA=QANIEN W !!,$C(7),"Insufficient data entered for an incident, deleting!!" D ^DIK K DA,DIK S QANXIT=1
"RTN","QANCDNT",83,0)
 Q
"RTN","QANCDNT",84,0)
PAT ;Patient data.
"RTN","QANCDNT",85,0)
 K DIC S DIC="^DPT(",DIC(0)="QEAMNZ",DIC("A")="Select Patient: ",DIC("W")="W "" "",$P(^(0),U,9)",D="B^BS5"
"RTN","QANCDNT",86,0)
 D MIX^DIC1 K DIC S:+Y<1&($G(QANFLAG)) QANOUT=1
"RTN","QANCDNT",87,0)
 D:+Y<1&('$G(QANFLAG)) DEL^QANCDNT Q:QANXIT!(QANOUT)
"RTN","QANCDNT",88,0)
 F  D  Q:"-12"[%
"RTN","QANCDNT",89,0)
 . W !?5,$G(Y(0,0))_" OK?"
"RTN","QANCDNT",90,0)
 . S %=1 D YN^DICN Q:"-12"[%
"RTN","QANCDNT",91,0)
 . W " Confirm that this is the correct patient."
"RTN","QANCDNT",92,0)
 D:%=-1&('$G(QANFLAG)) DEL^QANCDNT Q:QANXIT!(QANOUT)
"RTN","QANCDNT",93,0)
 I %=-1,($G(QANFLAG)) S QANXIT=1 Q
"RTN","QANCDNT",94,0)
 I %=2 W " ??" G PAT
"RTN","QANCDNT",95,0)
 D PRIOR I QANXIT D  Q
"RTN","QANCDNT",96,0)
 . I '$G(QANFLAG) K DA,DIK S DA=QANIEN,DIK="^QA(742.4," D ^DIK K DA,DIK
"RTN","QANCDNT",97,0)
 I $D(^UTILITY($J,"QAN PAT",+Y)) W !!,$C(7),$P(^DPT(+Y,0),U)_" has been previously entered for this incident." K Y G PAT
"RTN","QANCDNT",98,0)
 I $D(^DPT(+Y,.35)),$P(^DPT(+Y,.35),U)]"",($P(^DPT(+Y,.35),U)<$P(^QA(742.4,QANIEN,0),U,3)) W !!,$C(7),"The date of death for patient: "_$P(^DPT(+Y,0),U)_" precedes the incident date." K Y G PAT
"RTN","QANCDNT",99,0)
 I $G(QANXIT)!($G(QANOUT)) D DEL Q
"RTN","QANCDNT",100,0)
 S QANPIEN=+Y,QANZERO=Y(0),QANAME=Y(0,0),QANSSN=$P(QANZERO,U,9),^UTILITY($J,"QAN PAT",+Y)=""
"RTN","QANCDNT",101,0)
 S QANDOB=$P(^DPT(QANPIEN,0),U,3)
"RTN","QANCDNT",102,0)
 I QANDOB]"" S X=DT,X1=X,X2=QANDOB,X="" D:X2 ^%DTC S X=X\365.25,QANAGE=X
"RTN","QANCDNT",103,0)
 S QANPSDO(0)=Y(0),QANPSDO(0,0)=Y(0,0)
"RTN","QANCDNT",104,0)
 S QANPID=$E($P(Y(0,0),",",2))_$E($P(Y(0,0)," ",2))_$E($P(Y(0,0),","))_$E(QANSSN,6,9)
"RTN","QANCDNT",105,0)
 D ADMDT^QANUTL1
"RTN","QANCDNT",106,0)
 K DIC,DD,DO,DINUM,DLAYGO S DLAYGO=742,DIC="^QA(742,",DIC(0)="L",X=QANPIEN D FILE^DICN K DIC,DD,DO,DINUM,DLAYGO
"RTN","QANCDNT",107,0)
 I +Y=-1,('$G(QANFLAG)) D DEL Q
"RTN","QANCDNT",108,0)
 I +Y=-1,($G(QANFLAG)) S QANXIT=1 Q  ;Something is wrong, exit.
"RTN","QANCDNT",109,0)
 S QANDFN=+Y
"RTN","QANCDNT",110,0)
 L +^QA(742,QANDFN):10 I '$T W !!,"Another user is editing this patient incident." Q
"RTN","QANCDNT",111,0)
 S $P(^QA(742,QANDFN,0),U,2,6)=QANPID_U_QANIEN_U_QANADMDT_U_QANINPAT_U_QANWARD
"RTN","QANCDNT",112,0)
 S $P(^QA(742,QANDFN,0),U,7)=QANTRSP,$P(^QA(742,QANDFN,0),U,12)=1
"RTN","QANCDNT",113,0)
 S DIK="^QA(742,",DA=QANDFN D IX1^DIK K DA,DIK
"RTN","QANCDNT",114,0)
 L -^QA(742,QANDFN)
"RTN","QANCDNT",115,0)
 S QANFLAG=1 ;D:'$D(QANF) BULL^QANUTL3
"RTN","QANCDNT",116,0)
 K QAUDIT S QAUDIT("FILE")="742^50",QAUDIT("DA")=QANDFN,QAUDIT("ACTION")="o",QAUDIT("COMMENT")="Open a patient record" D ^QAQAUDIT
"RTN","QANCDNT",117,0)
 Q
"RTN","QANCDNT",118,0)
PRIOR ;
"RTN","QANCDNT",119,0)
 S QANTST(1)=$G(^QA(742.4,QANIEN,0))
"RTN","QANCDNT",120,0)
 S QANTST("INC")=$P(QANTST(1),U,2),QANTST("DATE")=$P(QANTST(1),U,3)
"RTN","QANCDNT",121,0)
 F QAN99=0:0 S QAN99=$O(^QA(742,"AA",+Y,QAN99)) Q:QAN99'>0!(QANXIT)  S QANPRS=+$O(^QA(742,"AA",+Y,QAN99,"")) I QANPRS>0,($P(^QA(742,QANPRS,0),U,12)'<0) S QANTST(2)=$G(^QA(742.4,QAN99,0)) D PRIOR1
"RTN","QANCDNT",122,0)
 K QAN99,QANPRS,QANTST
"RTN","QANCDNT",123,0)
 Q
"RTN","QANCDNT",124,0)
PRIOR1 ;
"RTN","QANCDNT",125,0)
 I (QANTST("INC")=$P(QANTST(2),U,2)),(QANTST("DATE")=$P(QANTST(2),U,3)) D
"RTN","QANCDNT",126,0)
 . W !!,$C(7),"Patient "_$P(^DPT(+Y,0),U)_" has a duplicate incident on record."
"RTN","QANCDNT",127,0)
 . W:'$G(QANFLAG) !,"Deleting the incident."
"RTN","QANCDNT",128,0)
 . W:$G(QANFLAG) !,"Exiting!"
"RTN","QANCDNT",129,0)
 . S QANXIT=1
"RTN","QANCDNT",130,0)
 Q
"RTN","QANCDNT",131,0)
DISP ;display to user what has been entered and ask if it is okay
"RTN","QANCDNT",132,0)
 N QANCC,QANEE
"RTN","QANCDNT",133,0)
 W @IOF
"RTN","QANCDNT",134,0)
 S QAN74240=^QA(742.4,QANIEN,0)
"RTN","QANCDNT",135,0)
 W !!!,"Incident Report: "_$P(QAN74240,U)
"RTN","QANCDNT",136,0)
 S Y=$P(QAN74240,U,3) D DD^%DT
"RTN","QANCDNT",137,0)
 W ?35,"Date of Incident: "_Y
"RTN","QANCDNT",138,0)
 W !,"Patient: "
"RTN","QANCDNT",139,0)
 S QANCC=0 F  S QANCC=$O(^QA(742,"BCS",QANIEN,QANCC)) Q:QANCC'>0  D
"RTN","QANCDNT",140,0)
 . W ?10,$P(^DPT($P(^QA(742,QANCC,0),U),0),U),!
"RTN","QANCDNT",141,0)
 W !,"Incident Type: "
"RTN","QANCDNT",142,0)
 I $P(QAN74240,U,2)]"" W $P(^QA(742.1,$P(QAN74240,U,2),0),U)
"RTN","QANCDNT",143,0)
 W !,"Incident Location: "
"RTN","QANCDNT",144,0)
 I $P(QAN74240,U,4)]"" W $P(^QA(742.5,$P(QAN74240,U,4),0),U)
"RTN","QANCDNT",145,0)
 W !,"Was the Incident Witnessed?: "_$S($P(QAN74240,U,7)=1:"Yes",$P(QAN74240,U,7)=0:"No",1:"")
"RTN","QANCDNT",146,0)
 W !,"Incident Description: "
"RTN","QANCDNT",147,0)
 S QANEE=0 F  S QANEE=$O(^QA(742.4,QANIEN,1,QANEE)) Q:QANEE'>0  D
"RTN","QANCDNT",148,0)
 . W !?3,^QA(742.4,QANIEN,1,QANEE,0)
"RTN","QANCDNT",149,0)
 W !!
"RTN","QANCDNT",150,0)
 S DIR("A")="Is this information correct?"
"RTN","QANCDNT",151,0)
 S DIR("B")="Yes"
"RTN","QANCDNT",152,0)
 S DIR("?")="Enter 'Yes' or 'No'."
"RTN","QANCDNT",153,0)
 S DIR(0)="YAO"
"RTN","QANCDNT",154,0)
 S DIR("?",1)="Enter 'Yes' if the information displayed is correct."
"RTN","QANCDNT",155,0)
 S DIR("?",2)="Enter 'No' if you need to edit this information."
"RTN","QANCDNT",156,0)
 D ^DIR
"RTN","QANCDNT",157,0)
GOEDIT ;
"RTN","QANCDNT",158,0)
 ;if info is not right, use code from QANEDIT to edit just the fields
"RTN","QANCDNT",159,0)
 ;in a brief incident.  There must be at least one patient/report.
"RTN","QANCDNT",160,0)
 I Y=0 S QANOUT=0 D
"RTN","QANCDNT",161,0)
 . D DIE^QANEDIT
"RTN","QANCDNT",162,0)
 . I $O(^QA(742,"BCS",QANIEN,0))']"" D
"RTN","QANCDNT",163,0)
 . . W !!,"No patients on this Incident Report - deleting Report."
"RTN","QANCDNT",164,0)
 . . S DIK="^QA(742.4,",DA=QANIEN D ^DIK K DIK
"RTN","QANCDNT",165,0)
 . . ;also need to remove entry from QA Audit file (#740.5)
"RTN","QANCDNT",166,0)
 . . ;get most recent entry for 742 and 742.4 and if matches
"RTN","QANCDNT",167,0)
 . . ;this entry, delete
"RTN","QANCDNT",168,0)
 . . F QANFILE=742,742.4 D DIKAUDIT^QANEDIT(QANFILE) K QANFILE
"RTN","QANCDNT",169,0)
 I $G(^QA(742.4,QANIEN,0))]"" D
"RTN","QANCDNT",170,0)
 . D ^QANBRIF ;transmit message to local mail group
"RTN","QANCDNT",171,0)
 . S QANCC=0
"RTN","QANCDNT",172,0)
 . F  S QANCC=$O(^QA(742,"BCS",QANIEN,QANCC)) Q:QANCC'>0  D
"RTN","QANCDNT",173,0)
 . . S QANPTNUM=$P(^QA(742,QANCC,0),U)
"RTN","QANCDNT",174,0)
 . . S QANODE=^DPT(QANPTNUM,0)
"RTN","QANCDNT",175,0)
 . . S QANAME=$P(QANODE,U)
"RTN","QANCDNT",176,0)
 . . S QANSSN=$P(QANODE,U,9)
"RTN","QANCDNT",177,0)
 . . D:'$D(QANF) BULL^QANUTL3
"RTN","QANCDNT",178,0)
 Q
"RTN","QANQUCK")
0^3^B18402141
"RTN","QANQUCK",1,0)
QANQUCK ;HISC/GJC-Initial sighting of an Incident for a QA person ;10/9/92
"RTN","QANQUCK",2,0)
 ;;2.0;Incident Reporting;**1,9,14,27,26,28,29**;08/07/1992
"RTN","QANQUCK",3,0)
 ;
"RTN","QANQUCK",4,0)
 K QANLOCK
"RTN","QANQUCK",5,0)
 D NEWREC^QANCDNT
"RTN","QANQUCK",6,0)
 D DIV^QANCDNT
"RTN","QANQUCK",7,0)
 I $G(QANQFLG)=1 Q
"RTN","QANQUCK",8,0)
 S QANDEATH=$O(^QA(742.1,"BUPPER","DEATH",0)),QANSUI=$O(^QA(742.1,"BUPPER","SUICIDE",0)),QANHOMCD=$O(^QA(742.1,"BUPPER","HOMICIDE",0))
"RTN","QANQUCK",9,0)
 S QANPTAB=$O(^QA(742.1,"BUPPER","PATIENT ABUSE",0))
"RTN","QANQUCK",10,0)
 S DIE="^QA(742.4,",DA=QANIEN,DR="[QAN QUICK EDIT]" D ^DIE K DIE,DR I $D(Y) D DEL D:QANXIT KILL Q
"RTN","QANQUCK",11,0)
 S QANLTTR=$P(^QA(742.4,QANIEN,0),U,2)
"RTN","QANQUCK",12,0)
 S QANST=$P(^QA(742.4,QANIEN,0),U,2) I "12"[$P(^QA(742.1,QANST,0),U,2) S $P(^QA(742.4,QANIEN,0),U,9)=DT,QAQADICT=742.4,QAQAFLD=".1",X=DT D ENSET^QAQAXREF
"RTN","QANQUCK",13,0)
 K QAUDIT S QAUDIT("FILE")="742.4^50",QAUDIT("DA")=QANIEN,QAUDIT("ACTION")="o",QAUDIT("COMMENT")="Open an incident record" D ^QAQAUDIT
"RTN","QANQUCK",14,0)
 S DIE="^QA(742.4,",DR=".09///"_3,DA=QANIEN D ^DIE ; Set 'Local Case' flag to brief.
"RTN","QANQUCK",15,0)
 ;Get the patient.
"RTN","QANQUCK",16,0)
 K ^UTILITY($J,"QAN PAT") F  D PAT Q:QANXIT!(QANOUT)
"RTN","QANQUCK",17,0)
 L -^QA(742.4,QANIEN) ;unlock record - it was locked in NEWREC^QANCDNT
"RTN","QANQUCK",18,0)
KILL K D0,DA,QANADMDT,QANAGE,QANAME,QANCHK,QANCODE,QANDFN,QANDOB,QANDT,QANDUZ
"RTN","QANQUCK",19,0)
 K QANFLAG,QANHOMCD,QANHOME,QANIEN,QANINCR,QANINPAT,QANLTTR,QANOUT
"RTN","QANQUCK",20,0)
 K QANPTAB,QANPID,QANPIEN,QANPSDO,QANSSN,QANSUI,QANDEATH,QANST,QANST1
"RTN","QANQUCK",21,0)
 K QANTRSP,QANTTL,QANWARD,QANXIT,QANZERO,QAQADICT,QAQAFLD,QUES,VAERR,X
"RTN","QANQUCK",22,0)
 K QANPRS,X1,X2,Y,QANCODE,QANBFLG
"RTN","QANQUCK",23,0)
 Q
"RTN","QANQUCK",24,0)
DEL ;
"RTN","QANQUCK",25,0)
 K DIK S DIK="^QA(742.4,",DA=QANIEN W !!,$C(7),"Insufficient data entered for an incident, deleting!!" D ^DIK K DA,DIK S QANXIT=1
"RTN","QANQUCK",26,0)
 Q
"RTN","QANQUCK",27,0)
PAT ;Patient data.
"RTN","QANQUCK",28,0)
 K DIC S DIC="^DPT(",DIC(0)="QEAMNZ",DIC("A")="Select Patient: ",DIC("W")="W "" "",$P(^(0),U,9)",D="B^BS5"
"RTN","QANQUCK",29,0)
 D MIX^DIC1 K DIC S:+Y<1&(QANFLAG) QANOUT=1
"RTN","QANQUCK",30,0)
 D:+Y<1&('QANFLAG) DEL^QANCDNT Q:QANXIT!(QANOUT)
"RTN","QANQUCK",31,0)
 F  D  Q:"-12"[%
"RTN","QANQUCK",32,0)
 . W !?5,$G(Y(0,0))_" OK?"
"RTN","QANQUCK",33,0)
 . S %=1 D YN^DICN Q:"-12"[%
"RTN","QANQUCK",34,0)
 . W " Confirm that this is the correct patient."
"RTN","QANQUCK",35,0)
 D:%=-1&('QANFLAG) DEL^QANQUCK Q:QANXIT!(QANOUT)
"RTN","QANQUCK",36,0)
 I %=-1,(QANFLAG) S QANXIT=1 Q
"RTN","QANQUCK",37,0)
 I %=2 W " ??" G PAT
"RTN","QANQUCK",38,0)
 D PRIOR^QANCDNT I QANXIT D  Q
"RTN","QANQUCK",39,0)
 . I 'QANFLAG K DA,DIK S DA=QANIEN,DIK="^QA(742.4," D ^DIK K DA,DIK
"RTN","QANQUCK",40,0)
 I $D(^UTILITY($J,"QAN PAT",+Y)) W !!,$C(7),$P(^DPT(+Y,0),U)_" has been previously entered for this incident." K Y G PAT
"RTN","QANQUCK",41,0)
 I $D(^DPT(+Y,.35)),$P(^DPT(+Y,.35),U)]"",($P(^DPT(+Y,.35),U)<$P(^QA(742.4,QANIEN,0),U,3)) W !!,$C(7),"The date of death for patient: "_$P(^DPT(+Y,0),U)_" precedes the incident date." K Y G PAT
"RTN","QANQUCK",42,0)
 S QANPIEN=+Y,QANZERO=Y(0),QANAME=Y(0,0),QANSSN=$P(QANZERO,U,9),^UTILITY($J,"QAN PAT",+Y)=""
"RTN","QANQUCK",43,0)
 S QANDOB=$P(^DPT(QANPIEN,0),U,3)
"RTN","QANQUCK",44,0)
 I QANDOB]"" S X=DT,X1=X,X2=QANDOB,X="" D:X2 ^%DTC S X=X\365.25,QANAGE=X
"RTN","QANQUCK",45,0)
 S QANPSDO(0)=Y(0),QANPSDO(0,0)=Y(0,0)
"RTN","QANQUCK",46,0)
 S QANPID=$E($P(Y(0,0),",",2))_$E($P(Y(0,0)," ",2))_$E($P(Y(0,0),","))_$E(QANSSN,6,9)
"RTN","QANQUCK",47,0)
 D ADMDT^QANUTL1
"RTN","QANQUCK",48,0)
 ;L +^QA(742):10 I '$T W !!,"Another user is editing this file." Q
"RTN","QANQUCK",49,0)
 K DIC,DD,DO,DINUM,DLAYGO S DLAYGO=742,DIC="^QA(742,",DIC(0)="L",X=QANPIEN D FILE^DICN K DIC,DD,DO,DINUM,DLAYGO
"RTN","QANQUCK",50,0)
 I +Y=-1,('QANFLAG) D DEL Q
"RTN","QANQUCK",51,0)
 I +Y=-1,(QANFLAG) S QANXIT=1 Q  ;Something is wrong, exit.
"RTN","QANQUCK",52,0)
 S QANDFN=+Y
"RTN","QANQUCK",53,0)
 ;L -^QA(742)
"RTN","QANQUCK",54,0)
 L +^QA(742,QANDFN):10 I '$T W !!,"Another user is editing this patient incident." Q
"RTN","QANQUCK",55,0)
 S $P(^QA(742,QANDFN,0),U,2,6)=QANPID_U_QANIEN_U_QANADMDT_U_QANINPAT_U_QANWARD
"RTN","QANQUCK",56,0)
 S $P(^QA(742,QANDFN,0),U,7)=QANTRSP,$P(^QA(742,QANDFN,0),U,12)=1
"RTN","QANQUCK",57,0)
 S DIK="^QA(742,",DA=QANDFN D IX1^DIK K DA,DIK
"RTN","QANQUCK",58,0)
 I (QANSUI=QANLTTR)!(QANDEATH=QANLTTR)!(QANHOMCD=QANLTTR) K DA,DIE,DR S DIE="^QA(742,",DA=QANDFN,DR=".1///^S X=3" D ^DIE K DA,DIE,DR
"RTN","QANQUCK",59,0)
 I (QANSUI'=QANLTTR),(QANDEATH'=QANLTTR),(QANHOMCD'=QANLTTR) K DA,DIE,DR S DIE="^QA(742,",DR=".1",DA=QANDFN D ^DIE K DA,DIE,DR
"RTN","QANQUCK",60,0)
 L -^QA(742,QANDFN)
"RTN","QANQUCK",61,0)
 S QANFLAG=1
"RTN","QANQUCK",62,0)
 K QAUDIT S QAUDIT("FILE")="742^50",QAUDIT("DA")=QANDFN,QAUDIT("ACTION")="o",QAUDIT("COMMENT")="Open a patient record" D ^QAQAUDIT
"RTN","QANQUCK",63,0)
 Q
"RTN","QANRPT1")
0^4^B40805977
"RTN","QANRPT1",1,0)
QANRPT1 ;HISC/GJC-SUMMARY OF INCIDENTS/WARD ;5/6/91
"RTN","QANRPT1",2,0)
 ;;2.0;Incident Reporting;**26,29**;08/07/1992
"RTN","QANRPT1",3,0)
 ;
"RTN","QANRPT1",4,0)
 N QANINFLG,QANLCFLG
"RTN","QANRPT1",5,0)
 F  W !,"Do you wish to produce a report by Incident Location" S %=1 D YN^DICN Q:"-112"[%  W !,$C(7),"Enter ""Y""es to issue a report by Incident Location,",!,"""N""o to issue a report by Patient's Ward."
"RTN","QANRPT1",6,0)
 I %=-1 K % Q
"RTN","QANRPT1",7,0)
 S:%=2 QANCHOS="W" S:%=1 QANCHOS="I"
"RTN","QANRPT1",8,0)
 D DIV
"RTN","QANRPT1",9,0)
DATE ;
"RTN","QANRPT1",10,0)
 D ^QAQDATE I QAQQUIT W !!,$C(7),"Invalid date range, no report will be produced." D KILL Q
"RTN","QANRPT1",11,0)
 S (PAGE,QANTYPE)=0
"RTN","QANRPT1",12,0)
 I $D(QAQNBEG) S Y=QAQNBEG D DD^%DT S QANDATE(0)=Y
"RTN","QANRPT1",13,0)
 S:$D(QAQNBEG) QAQNBEG=QAQNBEG-.00000001
"RTN","QANRPT1",14,0)
 S:$D(QAQNEND) QAQNEND=QAQNEND_".99999999"
"RTN","QANRPT1",15,0)
 S QANHEAD(0)="QUALITY MANAGEMENT INCIDENT REPORT",QANHEAD(1)="SUMMARY OF INCIDENTS BY INCIDENT LOCATION",QANHEAD(2)="SUMMARY OF INCIDENTS BY PATIENT WARD"
"RTN","QANRPT1",16,0)
 S Y=$P(QAQNEND,".") D DD^%DT S QANDATE(1)=Y
"RTN","QANRPT1",17,0)
 S QANHEAD(3)="FOR THE PERIOD "_QANDATE(0)_" TO "_QANDATE(1)
"RTN","QANRPT1",18,0)
 D INCD^QANUTL4 I QANY D KILL Q
"RTN","QANRPT1",19,0)
 D:QANCHOS="I" QANLOC^QANUTL4 D:QANCHOS="W" WARD^QANUTL4 I QANY D KILL Q
"RTN","QANRPT1",20,0)
LOOP ;
"RTN","QANRPT1",21,0)
 N QANCC,QANEE
"RTN","QANRPT1",22,0)
 S QANEE=QAQNBEG
"RTN","QANRPT1",23,0)
 F  S QANEE=$O(^QA(742.4,"BDT",QANEE)) Q:QANEE'>0!(QANEE>QAQNEND)  D
"RTN","QANRPT1",24,0)
 . S QANCC=0
"RTN","QANRPT1",25,0)
 . F  S QANCC=$O(^QA(742.4,"BDT",QANEE,QANCC)) Q:QANCC'>0  D
"RTN","QANRPT1",26,0)
 . . S QANDD=0
"RTN","QANRPT1",27,0)
 . . F  S QANDD=$O(^QA(742,"BCS",QANCC,QANDD)) Q:QANDD'>0  D
"RTN","QANRPT1",28,0)
 . . . S QAN7424=^QA(742.4,QANCC,0) Q:$G(QAN7424)']""
"RTN","QANRPT1",29,0)
 . . . S QAN742=^QA(742,QANDD,0) Q:$G(QAN742)']""
"RTN","QANRPT1",30,0)
 . . . I $P(QAN7424,U,8)=2 Q
"RTN","QANRPT1",31,0)
 . . . S QANINC=$P(QAN7424,U,2) I $G(QANINC)']"" Q
"RTN","QANRPT1",32,0)
 . . . I $G(QANINFLG)'=1 I $G(^TMP("QANRPT1",$J,"INC",QANINC))']"" Q
"RTN","QANRPT1",33,0)
 . . . I $P(QAN742,U,5)'=1 Q
"RTN","QANRPT1",34,0)
 . . . S QANLCN=$S($G(QANCHOS)="I":$P(QAN7424,U,4),1:$P(QAN742,U,6)) Q:'$G(QANLCN)
"RTN","QANRPT1",35,0)
 . . . I $G(QANCHOS)="I" S QANLOC=$P(^QA(742.5,QANLCN,0),U)
"RTN","QANRPT1",36,0)
 . . . I $G(QANCHOS)="W" S QANLOC=$P(^SC($P(QAN742,U,6),0),U)
"RTN","QANRPT1",37,0)
 . . . I $G(QANLOC)']"" Q
"RTN","QANRPT1",38,0)
 . . . I $G(QANLCFLG)'=1 I $G(^TMP("QANRPT1",$J,"LOC",QANLCN))']"" Q
"RTN","QANRPT1",39,0)
 . . . S QANDIV=$P(QAN7424,U,22) I $G(QANDIV)']"" S QANDIV=0
"RTN","QANRPT1",40,0)
 . . . I $G(QAN1DIV)]"" Q:QAN1DIV'=QANDIV
"RTN","QANRPT1",41,0)
 . . . I '$D(^QA(740,1,"QAN2","B",QANDIV)) S QANDIV=0
"RTN","QANRPT1",42,0)
 . . . I $P($G(^QA(740,1,"QAN")),U,5)'=1 S QANDIV=0
"RTN","QANRPT1",43,0)
 . . . S QANINC=$P(^QA(742.1,QANINC,0),U)
"RTN","QANRPT1",44,0)
 . . . S QANINC=$TR(QANINC,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","QANRPT1",45,0)
 . . . S ^TMP("QANRPT1",$J,"QAN",QANDIV,QANLOC,QANINC,QANCC,QANDD)=""
"RTN","QANRPT1",46,0)
 I '$D(^TMP("QANRPT1",$J)) W !!,$C(7),"No records found for the selected date range." D KILL Q
"RTN","QANRPT1",47,0)
 S QANWORD=$S($G(QANCHOS)="I":"Incident",1:"Ward")
"RTN","QANRPT1",48,0)
 I '$G(QANLCFLG),('$D(^TMP("QANRPT1",$J,"LOC"))) W !!,$C(7),QANWORD," location(s) not found, exiting the report." D KILL Q
"RTN","QANRPT1",49,0)
 I '$G(QANINFLG),('$D(^TMP("QANRPT1",$J,"INC"))) W !!,$C(7),"Incident(s) not found, exiting the report." D KILL Q
"RTN","QANRPT1",50,0)
 D TOTAL
"RTN","QANRPT1",51,0)
TASK S Y=DT X ^DD("DD") S TODAY=Y,$P(BNDRY,"-",$S(IOM=132:133,1:81))="",QANFIN=""
"RTN","QANRPT1",52,0)
 ;*** Choose device ***
"RTN","QANRPT1",53,0)
 K IOP,%ZIS S %ZIS("A")="Print on device: ",%ZIS="MQ" W ! D ^%ZIS W !!
"RTN","QANRPT1",54,0)
 G:POP KILL
"RTN","QANRPT1",55,0)
 I $D(IO("Q")) S ZTRTN="STRT^QANRPT1",ZTDESC="Generate Incident reports for incidents by type." D QLOOP^QANRPT2,^%ZTLOAD W !,$S($D(ZTSK):"Request queued!",1:"Request cancelled!"),! G EXIT
"RTN","QANRPT1",56,0)
STRT U IO
"RTN","QANRPT1",57,0)
 D:QANFIN'["^" PRINT
"RTN","QANRPT1",58,0)
EXIT W ! D ^%ZISC,HOME^%ZIS
"RTN","QANRPT1",59,0)
KILL ;Kill and quit.
"RTN","QANRPT1",60,0)
 D K^QAQDATE
"RTN","QANRPT1",61,0)
 K QAQNBEG,QAQNEND
"RTN","QANRPT1",62,0)
 K QAN742,QAN7424,QANAA,QANBB,QANCC,QANDD,QANEE,QANFF,QANXX,QANYY,QANZZ
"RTN","QANRPT1",63,0)
 K BNDRY,COUNT,LOOP,PAGE,TODAY,X,Y,%
"RTN","QANRPT1",64,0)
 K QANCDNT,QANCHOS,QANCNT,QANDAT1,QANDAT2,QANDATA1,QANDATA2,QANDATE
"RTN","QANRPT1",65,0)
 K QANDIV,QANDV,QANDVFLG,QANDVN,QANDVSN,QANFLG,QANFIN,QANINC,QANINFLG
"RTN","QANRPT1",66,0)
 K QANHEAD,QANINC,QANINCID,QAN,QANLCFLG,QANLOC,QANLOCA
"RTN","QANRPT1",67,0)
 K QANNODE,QANNUM,QANTYPE,QANY
"RTN","QANRPT1",68,0)
 K ^TMP("QANRPT1"),LP,LP0,LP1,LP2,QA,C
"RTN","QANRPT1",69,0)
 K DIROUT,DIRUT,DTOUT,DUOUT,D
"RTN","QANRPT1",70,0)
 Q
"RTN","QANRPT1",71,0)
FINAL ;Final data summation.
"RTN","QANRPT1",72,0)
 D:$Y>(IOSL-4) HDH,HDR^QANAUX1 Q:QANFIN["^"
"RTN","QANRPT1",73,0)
 I $G(COUNT("TOT"))'>0 W !!,"No incidents found, exiting the report." Q
"RTN","QANRPT1",74,0)
 S QANFF=""
"RTN","QANRPT1",75,0)
 F  S QANFF=$O(COUNT("LOC",QANAA,QANFF)) Q:QANFF']""  D
"RTN","QANRPT1",76,0)
 . S QANLOCA=QANFF
"RTN","QANRPT1",77,0)
 . W !,"Total number of incidents for "_$S(QANCHOS="W":"ward ",1:"incident location ")_QANLOCA_": "_COUNT("LOC",QANAA,QANFF)
"RTN","QANRPT1",78,0)
 I $G(QANDVFLG)=1 W !!,"Total number of Incidents for division "_QANDV_": "_COUNT("DIV",QANAA)
"RTN","QANRPT1",79,0)
 W !!,"Total number of incidents this reporting period: "_COUNT("TOT")
"RTN","QANRPT1",80,0)
 D HDH
"RTN","QANRPT1",81,0)
 Q
"RTN","QANRPT1",82,0)
TOTAL ;
"RTN","QANRPT1",83,0)
 N QANAA,QANBB,QANCC,QANDD
"RTN","QANRPT1",84,0)
 S QANAA=""
"RTN","QANRPT1",85,0)
 F  S QANAA=$O(^TMP("QANRPT1",$J,"QAN",QANAA)) Q:QANAA']""  D
"RTN","QANRPT1",86,0)
 . S QANBB=""
"RTN","QANRPT1",87,0)
 . F  S QANBB=$O(^TMP("QANRPT1",$J,"QAN",QANAA,QANBB)) Q:QANBB']""  D
"RTN","QANRPT1",88,0)
 . . S QANCC=""
"RTN","QANRPT1",89,0)
 . . F  S QANCC=$O(^TMP("QANRPT1",$J,"QAN",QANAA,QANBB,QANCC)) Q:QANCC']""  D
"RTN","QANRPT1",90,0)
 . . . S QANDD=0
"RTN","QANRPT1",91,0)
 . . . F  S QANDD=$O(^TMP("QANRPT1",$J,"QAN",QANAA,QANBB,QANCC,QANDD)) Q:QANDD'>0  D
"RTN","QANRPT1",92,0)
 . . . . S COUNT("INC",QANAA,QANBB,QANCC)=$G(COUNT("INC",QANAA,QANBB,QANCC))+1
"RTN","QANRPT1",93,0)
 . . . . S COUNT("TOT")=$G(COUNT("TOT"))+1
"RTN","QANRPT1",94,0)
 . . . . S COUNT("DIV",QANAA)=$G(COUNT("DIV",QANAA))+1
"RTN","QANRPT1",95,0)
 . . . . S COUNT("LOC",QANAA,QANBB)=$G(COUNT("LOC",QANAA,QANBB))+1
"RTN","QANRPT1",96,0)
 Q
"RTN","QANRPT1",97,0)
HDH ;
"RTN","QANRPT1",98,0)
 I $E(IOST)="C" K DIR S DIR(0)="E" D ^DIR K DIR S:+Y=0 QANFIN="^"
"RTN","QANRPT1",99,0)
 Q
"RTN","QANRPT1",100,0)
WARD ;
"RTN","QANRPT1",101,0)
 N QANCNT,QANDD
"RTN","QANRPT1",102,0)
 S QANDD=0
"RTN","QANRPT1",103,0)
 S QANCNT=1
"RTN","QANRPT1",104,0)
 F  S QANDD=$O(^QA(742,"BCS",QANIEN,QANDD)) Q:QANDD'>0  D
"RTN","QANRPT1",105,0)
 . Q:'$P($G(^QA(742,QANDD,0)),U,6)
"RTN","QANRPT1",106,0)
 . S QANLOC(QANCNT)=$P(^QA(742,QANDD,0),U,6)
"RTN","QANRPT1",107,0)
 . S QANCNT=QANCNT+1
"RTN","QANRPT1",108,0)
 Q
"RTN","QANRPT1",109,0)
INST(QANIEN,QANDV) ;api for getting division name
"RTN","QANRPT1",110,0)
 N DIC
"RTN","QANRPT1",111,0)
 K QANDV
"RTN","QANRPT1",112,0)
 S DIC="^DIC(4,"
"RTN","QANRPT1",113,0)
 S DIC(0)="NZX"
"RTN","QANRPT1",114,0)
 S DIC("S")="I $D(^QA(740,1,""QAN2"",""B"",X))"
"RTN","QANRPT1",115,0)
 S X=QANIEN
"RTN","QANRPT1",116,0)
 D ^DIC K DIC
"RTN","QANRPT1",117,0)
 I Y<0 S QANDV="Unknown" Q
"RTN","QANRPT1",118,0)
 S QANDV=Y(0,0)
"RTN","QANRPT1",119,0)
 Q
"RTN","QANRPT1",120,0)
PRINT ;print or display data
"RTN","QANRPT1",121,0)
 I '$D(COUNT) G FINAL
"RTN","QANRPT1",122,0)
 S QANAA=""
"RTN","QANRPT1",123,0)
 F  S QANAA=$O(COUNT("INC",QANAA)) Q:QANAA']""  D
"RTN","QANRPT1",124,0)
 . D INST(QANAA,.QANDV)
"RTN","QANRPT1",125,0)
 . I $G(QANDVFLG)=1 S QANHEAD(4)="REPORT FOR DIVISION: "_QANDV
"RTN","QANRPT1",126,0)
 . D HDR^QANAUX1
"RTN","QANRPT1",127,0)
 . S QANBB=""
"RTN","QANRPT1",128,0)
 . F  S QANBB=$O(COUNT("INC",QANAA,QANBB)) Q:QANBB']""  D
"RTN","QANRPT1",129,0)
 . . D:$Y>(IOSL-6) HDH,HDR^QANAUX1 Q:QANFIN["^"  W !!,$E(QANBB,1,32)
"RTN","QANRPT1",130,0)
 . . S QANCC=""
"RTN","QANRPT1",131,0)
 . . F  S QANCC=$O(COUNT("INC",QANAA,QANBB,QANCC)) Q:QANCC']""  D
"RTN","QANRPT1",132,0)
 . . . S QANDD=$O(^TMP("QANRPT1",$J,"QAN",QANAA,QANBB,QANCC,0)) Q:QANDD'>0
"RTN","QANRPT1",133,0)
 . . . S QANINCID=$P(^QA(742.1,$P(^QA(742.4,QANDD,0),U,2),0),U)
"RTN","QANRPT1",134,0)
 . . . S QANNUM=COUNT("INC",QANAA,QANBB,QANCC)
"RTN","QANRPT1",135,0)
 . . . D:$Y>(IOSL-4) HDH,HDR^QANAUX1 W ?35,$E(QANINCID,1,35),?72,QANNUM,!
"RTN","QANRPT1",136,0)
 . D FINAL
"RTN","QANRPT1",137,0)
 Q
"RTN","QANRPT1",138,0)
DIV ;
"RTN","QANRPT1",139,0)
 K QANDVFLG,QAN1DIV
"RTN","QANRPT1",140,0)
 S QANDVFLG=$P($G(^QA(740,1,"QAN")),U,5)
"RTN","QANRPT1",141,0)
 Q:$G(QANDVFLG)'=1
"RTN","QANRPT1",142,0)
 N DIR,DIRUT,DTOUT,DUOUT
"RTN","QANRPT1",143,0)
 S DIR(0)="YA"
"RTN","QANRPT1",144,0)
 S DIR("A")="Select ALL Divisions? "
"RTN","QANRPT1",145,0)
 S DIR("B")="YES"
"RTN","QANRPT1",146,0)
 D ^DIR K DIR I $D(DIRUT) S QANPOP=1 Q
"RTN","QANRPT1",147,0)
 I Y S QAN1DIV="" Q
"RTN","QANRPT1",148,0)
 N DIC
"RTN","QANRPT1",149,0)
 S DIC="^QA(740,1,""QAN2"","
"RTN","QANRPT1",150,0)
 S DIC(0)="AEMZQ"
"RTN","QANRPT1",151,0)
 S DIC("A")="Enter Division: "
"RTN","QANRPT1",152,0)
 S QANDVSN=$O(^QA(740,1,"QAN2",0)) Q:$G(QANDVSN)'>0
"RTN","QANRPT1",153,0)
 D INST($G(^QA(740,1,"QAN2",QANDVSN,0)),.QANDVN)
"RTN","QANRPT1",154,0)
 S DIC("B")=$G(QANDVN)
"RTN","QANRPT1",155,0)
 D ^DIC K DIC
"RTN","QANRPT1",156,0)
 I +Y>0 S QAN1DIV=Y(0)
"RTN","QANRPT1",157,0)
 Q
"RTN","QANRPT2")
0^5^B22253022
"RTN","QANRPT2",1,0)
QANRPT2 ;HISC/GJC-SUMMARY OF INCIDENTS FOR OUTPATIENTS ;5/6/91
"RTN","QANRPT2",2,0)
 ;;2.0;Incident Reporting;**26,29**;08/07/1992
"RTN","QANRPT2",3,0)
 ;
"RTN","QANRPT2",4,0)
 S PAGE=0
"RTN","QANRPT2",5,0)
 ;D DIV^QANRPT1
"RTN","QANRPT2",6,0)
 ;DON'T FORGET QAQDATE FOR AD HOC REPORTS!
"RTN","QANRPT2",7,0)
 D ^QAQDATE I QAQQUIT D K^QAQDATE W !!,$C(7),"Invalid date range, no report will be produced." D KILL Q
"RTN","QANRPT2",8,0)
 S QAQNBEG(0)=QAQNBEG-.00000001,QAQNEND(0)=QAQNEND_".99999999"
"RTN","QANRPT2",9,0)
 S (PAGE,QANTYPE,QANTINC)=0
"RTN","QANRPT2",10,0)
 S QANHEAD(0)="QUALITY MANAGEMENT INCIDENT REPORT",QANHEAD(1)="SUMMARY OF INCIDENTS FOR OUTPATIENTS."
"RTN","QANRPT2",11,0)
 S Y=$P(QAQNBEG,".") D DD^%DT S QANDATE(0)=Y
"RTN","QANRPT2",12,0)
 S Y=$P(QAQNEND,".") D DD^%DT S QANDATE(1)=Y
"RTN","QANRPT2",13,0)
 D DIV^QANRPT1
"RTN","QANRPT2",14,0)
 S QANHEAD(3)="FOR THE PERIOD "_QANDATE(0)_" TO "_QANDATE(1)
"RTN","QANRPT2",15,0)
 ;F QAN=0:0 S QAN=$O(^QA(742.4,QAN)) Q:QAN'>0  S QANZER0=$G(^QA(742.4,QAN,0)) I QANZER0]"",($P(QANZER0,U,8)'=2) S QANDATE=$P(QANZER0,U,3) I QANDATE'<QAQNBEG(0),(QANDATE'>QAQNEND(0)) S ^UTILITY($J,"QAN DATE",QAN)=""
"RTN","QANRPT2",16,0)
LOOP ;loop through the date x-ref for records in the date range
"RTN","QANRPT2",17,0)
 N QANCC,QANDD,QANEE
"RTN","QANRPT2",18,0)
 S QANEE=QAQNBEG(0)
"RTN","QANRPT2",19,0)
 F  S QANEE=$O(^QA(742.4,"BDT",QANEE)) Q:QANEE'>0!(QANEE>QAQNEND(0))  D
"RTN","QANRPT2",20,0)
 . S QANCC=0
"RTN","QANRPT2",21,0)
 . F  S QANCC=$O(^QA(742.4,"BDT",QANEE,QANCC)) Q:QANCC'>0  D
"RTN","QANRPT2",22,0)
 . . S QANDD=0
"RTN","QANRPT2",23,0)
 . . F  S QANDD=$O(^QA(742,"BCS",QANCC,QANDD)) Q:QANDD'>0  D
"RTN","QANRPT2",24,0)
 . . . Q:$P(^QA(742,QANDD,0),U,5)'=0
"RTN","QANRPT2",25,0)
 . . . S QANIEN=QANCC Q:QANIEN'>0
"RTN","QANRPT2",26,0)
 . . . S QANZER0=^QA(742.4,QANIEN,0)
"RTN","QANRPT2",27,0)
 . . . Q:$P(QANZER0,U,8)=2
"RTN","QANRPT2",28,0)
 . . . S QANDIV=$P(QANZER0,U,22) I $G(QANDIV)']"" S QANDIV=0
"RTN","QANRPT2",29,0)
 . . . I $G(QAN1DIV)]"" Q:QAN1DIV'=QANDIV
"RTN","QANRPT2",30,0)
 . . . I '$D(^QA(740,1,"QAN2","B",QANDIV)) S QANDIV=0
"RTN","QANRPT2",31,0)
 . . . I $P($G(^QA(740,1,"QAN")),U,5)'=1 S QANDIV=0
"RTN","QANRPT2",32,0)
 . . . S QANINC=$P(QANZER0,U,2) Q:$G(QANINC)'>0
"RTN","QANRPT2",33,0)
 . . . S ^TMP("QANRPT2",$J,"QAN",QANDIV,QANINC,QANIEN,QANDD)=""
"RTN","QANRPT2",34,0)
 I '$D(^TMP("QANRPT2",$J)) W !!,$C(7),"No records found for the selected date range." D KILL Q
"RTN","QANRPT2",35,0)
 D TOTAL
"RTN","QANRPT2",36,0)
TASK S Y=DT X ^DD("DD") S TODAY=Y,$P(BNDRY,"-",$S(IOM=132:133,1:81))="",QANFIN=""
"RTN","QANRPT2",37,0)
 ;*** Choose device ***
"RTN","QANRPT2",38,0)
 K IOP,%ZIS S %ZIS("A")="Print on device: ",%ZIS="MQ" W ! D ^%ZIS W !!
"RTN","QANRPT2",39,0)
 G:POP KILL
"RTN","QANRPT2",40,0)
 I $D(IO("Q")) S ZTRTN="STRT^QANRPT2",ZTDESC="Generate Incident reports for incidents by type." D QLOOP,^%ZTLOAD W !,$S($D(ZTSK):"Request queued!",1:"Request cancelled!"),! G EXIT
"RTN","QANRPT2",41,0)
STRT U IO ;D HDR^QANAUX1
"RTN","QANRPT2",42,0)
 D:QANFIN'["^" PRINT ;ORD D:QANFIN'["^" FINAL
"RTN","QANRPT2",43,0)
EXIT W ! D ^%ZISC,HOME^%ZIS
"RTN","QANRPT2",44,0)
KILL ;Kill and quit.
"RTN","QANRPT2",45,0)
 D K^QAQDATE
"RTN","QANRPT2",46,0)
 K %,C,COUNT,D,DIC,BNDRY,LOOP,PAGE
"RTN","QANRPT2",47,0)
 K QAN,QANCDNT,QANFIN,QANHEAD
"RTN","QANRPT2",48,0)
 K QANINC0,QANINC1,QANJD,QANDATE,QANNCDT,QANWARD,QANZER0,TODAY,Y,QANTINC
"RTN","QANRPT2",49,0)
 K QANTYPE,QANINC,QANINCID,QANY,QANCHOS,X
"RTN","QANRPT2",50,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","QANRPT2",51,0)
 K ^TMP("QANRPT2")
"RTN","QANRPT2",52,0)
 Q
"RTN","QANRPT2",53,0)
FINAL ;Final data summation.
"RTN","QANRPT2",54,0)
 D:$Y>(IOSL-6) HDR^QANAUX1 Q:QANFIN["^"
"RTN","QANRPT2",55,0)
 I '$G(COUNT("TOT")) W !!,"No incidents found, exiting the report." G EXIT
"RTN","QANRPT2",56,0)
 I $G(QANDVFLG)=1 W !!,"Total number if incidents for division "_QANDV_": "_COUNT("DIV",QANAA)
"RTN","QANRPT2",57,0)
 W !!,"The total number of outpatient incidents is: ",COUNT("TOT")
"RTN","QANRPT2",58,0)
 D HDH
"RTN","QANRPT2",59,0)
 Q
"RTN","QANRPT2",60,0)
ORD ;
"RTN","QANRPT2",61,0)
 Q:'$D(QANINC0)
"RTN","QANRPT2",62,0)
 S (QANSUB,QANSUB(0))="" F  S QANSUB=$O(QANINC0(QANSUB)) Q:QANSUB=""!(QANFIN["^")  D:$Y>(IOSL-4) HDH Q:QANFIN["^"  W !?17,QANSUB,?59,QANINC0(QANSUB),!
"RTN","QANRPT2",63,0)
 Q
"RTN","QANRPT2",64,0)
TOTAL ;
"RTN","QANRPT2",65,0)
 ;F QAN=0:0 S QAN=$O(^UTILITY($J,"QAN DATE",QAN)) Q:QAN'>0  F QAN(0)=0:0 S QAN(0)=$O(^QA(742,"BCS",QAN,QAN(0))) Q:QAN(0)'>0  D TOTAL1
"RTN","QANRPT2",66,0)
 N QANAA,QANBB,QANCC,QANDD
"RTN","QANRPT2",67,0)
 S QANAA=""
"RTN","QANRPT2",68,0)
 F  S QANAA=$O(^TMP("QANRPT2",$J,"QAN",QANAA)) Q:QANAA']""  D
"RTN","QANRPT2",69,0)
 . S QANBB=0
"RTN","QANRPT2",70,0)
 . F  S QANBB=$O(^TMP("QANRPT2",$J,"QAN",QANAA,QANBB)) Q:QANBB'>0  D
"RTN","QANRPT2",71,0)
 . . S QANCC=0
"RTN","QANRPT2",72,0)
 . . F  S QANCC=$O(^TMP("QANRPT2",$J,"QAN",QANAA,QANBB,QANCC)) Q:QANCC'>0  D
"RTN","QANRPT2",73,0)
 . . . S QANDD=0
"RTN","QANRPT2",74,0)
 . . . F  S QANDD=$O(^TMP("QANRPT2",$J,"QAN",QANAA,QANBB,QANCC,QANDD)) Q:QANDD'>0  D
"RTN","QANRPT2",75,0)
 . . . . S COUNT("INC",QANAA,QANBB)=$G(COUNT("INC",QANAA,QANBB))+1
"RTN","QANRPT2",76,0)
 . . . . S COUNT("TOT")=$G(COUNT("TOT"))+1
"RTN","QANRPT2",77,0)
 . . . . S COUNT("DIV",QANAA)=$G(COUNT("DIV",QANAA))+1
"RTN","QANRPT2",78,0)
 Q
"RTN","QANRPT2",79,0)
TOTAL1 ;
"RTN","QANRPT2",80,0)
 ;S QANZER0=$S($D(^QA(742.4,QAN,0))#2:^(0),1:""),QANZERO=$S($D(^QA(742,QAN(0),0))#2:^(0),1:"") Q:QANZER0']""!(QANZERO']"")
"RTN","QANRPT2",81,0)
 ;S Y=$P(QANZER0,U,2) I Y]"" S C=$P(^DD(742.4,.02,0),U,2) D Y^DIQ S QANNCDT=Y
"RTN","QANRPT2",82,0)
 ;I (+$P(QANZERO,U,5)=0) D TOTAL2
"RTN","QANRPT2",83,0)
 S (QANDD,QANOUT)=0
"RTN","QANRPT2",84,0)
 F  S QANDD=$O(^QA(742,"BCS",QANCC,QANDD)) Q:QANDD'>0  D
"RTN","QANRPT2",85,0)
 .  I $P(^QA(742,QANDD,0),U,5)'=0 S QANOUT=1
"RTN","QANRPT2",86,0)
 Q
"RTN","QANRPT2",87,0)
TOTAL2 ;
"RTN","QANRPT2",88,0)
 S QANTINC=QANTINC+1
"RTN","QANRPT2",89,0)
 I $D(QANINC0(QANNCDT)) S QANINC0(QANNCDT)=QANINC0(QANNCDT)+1
"RTN","QANRPT2",90,0)
 E  S QANINC0(QANNCDT)=1
"RTN","QANRPT2",91,0)
 Q
"RTN","QANRPT2",92,0)
HDH ;
"RTN","QANRPT2",93,0)
 I $E(IOST)="C" K DIR S DIR(0)="E" D ^DIR K DIR S:+Y=0 QANFIN="^"
"RTN","QANRPT2",94,0)
 ;Q:QANFIN["^"  D HDR^QANAUX1
"RTN","QANRPT2",95,0)
 Q
"RTN","QANRPT2",96,0)
QLOOP ;ZTSAVE for TaskMan.
"RTN","QANRPT2",97,0)
 F BA="^TMP(""QANRPT1"",$J,","^TMP(""QANRPT2"",$J,","BNDRY","PAGE","TODAY","QAN","QAQ*","COUNT(","QANFIN","QANHEAD(","QANCHOS","QANDVFLG" S ZTSAVE(BA)=""
"RTN","QANRPT2",98,0)
 Q
"RTN","QANRPT2",99,0)
PRINT ;print or display data
"RTN","QANRPT2",100,0)
 I '$D(COUNT) G FINAL
"RTN","QANRPT2",101,0)
 S QANAA=""
"RTN","QANRPT2",102,0)
 F  S QANAA=$O(^TMP("QANRPT2",$J,"QAN",QANAA)) Q:QANAA']""  D
"RTN","QANRPT2",103,0)
 . D INST^QANRPT1(QANAA,.QANDV)
"RTN","QANRPT2",104,0)
 . I $G(QANDVFLG)=1 S QANHEAD(4)="REPORT FOR DIVISION: "_QANDV
"RTN","QANRPT2",105,0)
 . D HDR^QANAUX1
"RTN","QANRPT2",106,0)
 . S QANBB=0
"RTN","QANRPT2",107,0)
 . F  S QANBB=$O(^TMP("QANRPT2",$J,"QAN",QANAA,QANBB)) Q:QANBB'>0  D
"RTN","QANRPT2",108,0)
 . . S QANINCID=$P(^QA(742.1,QANBB,0),U)
"RTN","QANRPT2",109,0)
 . . D:$Y>(IOSL-6) HDH,HDR^QANAUX1 Q:QANFIN["^"
"RTN","QANRPT2",110,0)
 . . W !!?17,$E(QANINCID,1,35),?59,COUNT("INC",QANAA,QANBB)
"RTN","QANRPT2",111,0)
 . D HDH,FINAL
"RTN","QANRPT2",112,0)
 Q
"RTN","QANUTL3")
0^6^B9957646
"RTN","QANUTL3",1,0)
QANUTL3 ;HISC/GJC-UTILITIES FOR AN INCIDENT REPORT ;4/22/91
"RTN","QANUTL3",2,0)
 ;;2.0;Incident Reporting;**27,26,29**;08/07/1992
"RTN","QANUTL3",3,0)
 ;
"RTN","QANUTL3",4,0)
BULL ;Generate the bulletin.
"RTN","QANUTL3",5,0)
 I $P(^QA(740,1,"QAN"),U)="" W !!,$C(7),"*** MAILGROUP NOT SPECIFIED, REPORT TO YOUR QA COORDINATOR ***",!!,$C(7) S QANXIT=1 Q
"RTN","QANUTL3",6,0)
 I $P(^QA(740,1,"QAN"),U,2)="" W !!,$C(7),"*** MAILGROUP BULLETIN NOT SENT, REPORT TO YOUR QA COORDINATOR ***",!!,$C(7) S QANXIT=1 Q
"RTN","QANUTL3",7,0)
 D KILL^XM S QANAFRM=+$S($D(^QA(740,1,"QAN"))#2:$P(^("QAN"),U,2),1:"")
"RTN","QANUTL3",8,0)
 S QANMIEN=+$S($D(^QA(740,1,"QAN"))#2:$P(^("QAN"),U),1:"") Q:QANAFRM'>0!(QANMIEN'>0)
"RTN","QANUTL3",9,0)
 S QANMAIL="G."_$P(^XMB(3.8,QANMIEN,0),U),QANSITE=$P(^DIC(4.2,$P(^XMB(1,1,0),U),0),U)
"RTN","QANUTL3",10,0)
 I QANSITE']"" W !!,$C(7),"*** MAILGROUP BULLETIN NOT SENT, REPORT TO YOUR QA COORDINATOR, DOMAIN INFORMATION MISSING ***",!!,$C(7) S QANXIT=1 Q
"RTN","QANUTL3",11,0)
 S XMY(QANMAIL_"@"_QANSITE)=""
"RTN","QANUTL3",12,0)
 S XMSUB=^DD("SITE")_" ("_^DD("SITE",1)_") QAN INCIDENT EVENT",XMDUZ=.5
"RTN","QANUTL3",13,0)
 I $D(DUZ)#2,DUZ>0,$D(^VA(200,DUZ,0)) S X=$P($P(^(0),U),",",2)_" "_$P($P(^(0),U),",") S QANMAIL(1)=X
"RTN","QANUTL3",14,0)
 S X=$S($D(^QA(742.4,QANIEN,0))#2:$P(^(0),U,6),1:"") S:X]"" QANMAIL(2)=$P(^DIC(3.1,X,0),U) S:X']"" QANMAIL(2)=""
"RTN","QANUTL3",15,0)
 S QANMAIL(3)=$S($D(^QA(742.4,QANIEN,0))#2:$P(^(0),U),1:"")
"RTN","QANUTL3",16,0)
 S X=$S($D(^QA(742.4,QANIEN,0))#2:$P(^(0),U,2),1:"") S:X]"" QANMAIL(4)=$P(^QA(742.1,X,0),U) S:X']"" QANMAIL(4)=""
"RTN","QANUTL3",17,0)
 S Y=DT X ^DD("DD") S X=Y,QANMAIL(5)=X
"RTN","QANUTL3",18,0)
 S X=$S($D(^QA(742.4,QANIEN,0))#2:$P(^(0),U,3),1:"")
"RTN","QANUTL3",19,0)
 S Y=X X ^DD("DD") S X=Y,QANMAIL(6)=X
"RTN","QANUTL3",20,0)
 S QANMAIL(7)=$S($D(QANAME):QANAME,1:"")
"RTN","QANUTL3",21,0)
 S QANMAIL(8)=$S($D(QANSSN):QANSSN,1:"")
"RTN","QANUTL3",22,0)
 S QANWORD=$S($G(QANEDFLG)=1:"edited",1:"entered")
"RTN","QANUTL3",23,0)
 S ^UTILITY($J,"QAN PAT",1)="On "_QANMAIL(5)_" User "_QANMAIL(1)_" ("_QANMAIL(2)_") "_QANWORD_" Incident"
"RTN","QANUTL3",24,0)
 S ^UTILITY($J,"QAN PAT",2)="case number "_QANMAIL(3)_" involving an incident, type "_QANMAIL(4)_"."
"RTN","QANUTL3",25,0)
 S ^UTILITY($J,"QAN PAT",3)="Date of Incident: "_QANMAIL(6)
"RTN","QANUTL3",26,0)
 I $D(QANMAIL(7)) S ^UTILITY($J,"QAN PAT",4)="Patient: "_QANMAIL(7)
"RTN","QANUTL3",27,0)
 I $D(QANMAIL(8)) S ^UTILITY($J,"QAN PAT",4)=^UTILITY($J,"QAN PAT",4)_"    SSN: "_QANMAIL(8)
"RTN","QANUTL3",28,0)
 S XMTEXT="^UTILITY($J,""QAN PAT""," D ^XMD,KILL^XM K X,Y,XMB,QANMAIL,QANAFRM,QANMIEN,QANSITE,XMHOLD,XMANS
"RTN","QANUTL3",29,0)
 Q
"RTN","QANUTL3",30,0)
EN1 ;Incident location enter/edit.
"RTN","QANUTL3",31,0)
 D KDIC S (DIC,DIE)="^QA(742.5,",DLAYGO=742.5,DIC("A")="Select an Incident Location: ",DIC(0)="QEAMNLZ",DIC("W")="W ""  ""_$S($P(^(0),U,2)=1:""ACTIVE"",1:""INACTIVE"")"
"RTN","QANUTL3",32,0)
 D ^DIC
"RTN","QANUTL3",33,0)
 I Y=-1 D KDIC Q
"RTN","QANUTL3",34,0)
 S DA=+Y L +^QA(742.5,DA,0):5 I '$T W !!?16,$C(7),"Another person is editing this entry." D KDIC Q
"RTN","QANUTL3",35,0)
 S DR=".01 Incident:" D ^DIE
"RTN","QANUTL3",36,0)
 I $D(Y) D KDIC Q
"RTN","QANUTL3",37,0)
 S DR=".02 Incident Location Status:" D ^DIE
"RTN","QANUTL3",38,0)
 D KDIC
"RTN","QANUTL3",39,0)
 Q
"RTN","QANUTL3",40,0)
KDIC ;
"RTN","QANUTL3",41,0)
 I $D(DA) L -^QA(752.5,DA,0)
"RTN","QANUTL3",42,0)
 K C,D,DA,DIC,DIE,DLAYGO,DINUM,DR,X,Y
"RTN","QANUTL3",43,0)
 Q
"VER")
8.0^22.0
**END**
**END**
