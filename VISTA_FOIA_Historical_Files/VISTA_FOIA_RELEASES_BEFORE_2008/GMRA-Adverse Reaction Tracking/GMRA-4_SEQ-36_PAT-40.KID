Released GMRA*4*40 SEQ #36
Extracted from mail message
**KIDS**:GMRA*4.0*40^

**INSTALL NAME**
GMRA*4.0*40
"BLD",6684,0)
GMRA*4.0*40^ADVERSE REACTION TRACKING^0^3070710^y
"BLD",6684,1,0)
^^5^5^3070613^
"BLD",6684,1,1,0)
This patch reviews updates made in patch GMRA*4*29 related
"BLD",6684,1,2,0)
to terms that begin with the text ANGIOTEN and assures that
"BLD",6684,1,3,0)
they were correctly updated.  A few ANGIOTEN entries were
"BLD",6684,1,4,0)
incorrectly updated to the wrong drug class and need to be
"BLD",6684,1,5,0)
updated to the correct drug class.
"BLD",6684,4,0)
^9.64PA^^
"BLD",6684,6.3)
2
"BLD",6684,"ABPKG")
n
"BLD",6684,"INIT")
POST^GMRAY40
"BLD",6684,"KRN",0)
^9.67PA^8989.52^19
"BLD",6684,"KRN",.4,0)
.4
"BLD",6684,"KRN",.401,0)
.401
"BLD",6684,"KRN",.402,0)
.402
"BLD",6684,"KRN",.403,0)
.403
"BLD",6684,"KRN",.5,0)
.5
"BLD",6684,"KRN",.84,0)
.84
"BLD",6684,"KRN",3.6,0)
3.6
"BLD",6684,"KRN",3.8,0)
3.8
"BLD",6684,"KRN",9.2,0)
9.2
"BLD",6684,"KRN",9.8,0)
9.8
"BLD",6684,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",6684,"KRN",9.8,"NM",1,0)
GMRAY40^^0^B80268399
"BLD",6684,"KRN",9.8,"NM","B","GMRAY40",1)

"BLD",6684,"KRN",19,0)
19
"BLD",6684,"KRN",19.1,0)
19.1
"BLD",6684,"KRN",101,0)
101
"BLD",6684,"KRN",409.61,0)
409.61
"BLD",6684,"KRN",771,0)
771
"BLD",6684,"KRN",870,0)
870
"BLD",6684,"KRN",8989.51,0)
8989.51
"BLD",6684,"KRN",8989.52,0)
8989.52
"BLD",6684,"KRN",8994,0)
8994
"BLD",6684,"KRN","B",.4,.4)

"BLD",6684,"KRN","B",.401,.401)

"BLD",6684,"KRN","B",.402,.402)

"BLD",6684,"KRN","B",.403,.403)

"BLD",6684,"KRN","B",.5,.5)

"BLD",6684,"KRN","B",.84,.84)

"BLD",6684,"KRN","B",3.6,3.6)

"BLD",6684,"KRN","B",3.8,3.8)

"BLD",6684,"KRN","B",9.2,9.2)

"BLD",6684,"KRN","B",9.8,9.8)

"BLD",6684,"KRN","B",19,19)

"BLD",6684,"KRN","B",19.1,19.1)

"BLD",6684,"KRN","B",101,101)

"BLD",6684,"KRN","B",409.61,409.61)

"BLD",6684,"KRN","B",771,771)

"BLD",6684,"KRN","B",870,870)

"BLD",6684,"KRN","B",8989.51,8989.51)

"BLD",6684,"KRN","B",8989.52,8989.52)

"BLD",6684,"KRN","B",8994,8994)

"BLD",6684,"PRET")
PRETRAN^GMRAY40
"BLD",6684,"QUES",0)
^9.62^^
"BLD",6684,"REQB",0)
^9.611^1^1
"BLD",6684,"REQB",1,0)
GMRA*4.0*29^1
"BLD",6684,"REQB","B","GMRA*4.0*29",1)

"INIT")
POST^GMRAY40
"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
40^3070710
"PKG",140,22,1,"PAH",1,1,0)
^^5^5^3070710
"PKG",140,22,1,"PAH",1,1,1,0)
This patch reviews updates made in patch GMRA*4*29 related
"PKG",140,22,1,"PAH",1,1,2,0)
to terms that begin with the text ANGIOTEN and assures that
"PKG",140,22,1,"PAH",1,1,3,0)
they were correctly updated.  A few ANGIOTEN entries were
"PKG",140,22,1,"PAH",1,1,4,0)
incorrectly updated to the wrong drug class and need to be
"PKG",140,22,1,"PAH",1,1,5,0)
updated to the correct drug class.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","GMRAY40")
0^1^B80268399^n/a
"RTN","GMRAY40",1,0)
GMRAY40 ;SLC/DAN Installation Utilities ;7/10/07  12:38
"RTN","GMRAY40",2,0)
 ;;4.0;Adverse Reaction Tracking;**40**;Mar 29, 1996;Build 2
"RTN","GMRAY40",3,0)
 ;
"RTN","GMRAY40",4,0)
 ;DBIA SECTION
"RTN","GMRAY40",5,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAY40",6,0)
 ;10061 - VADPT
"RTN","GMRAY40",7,0)
 ;10013 - DIK
"RTN","GMRAY40",8,0)
 ;2056  - DIQ
"RTN","GMRAY40",9,0)
 ;10018 - DIE
"RTN","GMRAY40",10,0)
 ;10070 - XMD
"RTN","GMRAY40",11,0)
 ;10103 - XLFDT
"RTN","GMRAY40",12,0)
 ;2051  - DIC
"RTN","GMRAY40",13,0)
 ;
"RTN","GMRAY40",14,0)
PRETRAN ;Load conversion table into KIDS build
"RTN","GMRAY40",15,0)
 M @XPDGREF@("GMRAFIX40")=^XTMP("GMRAFIX40")
"RTN","GMRAY40",16,0)
 Q
"RTN","GMRAY40",17,0)
 ;
"RTN","GMRAY40",18,0)
POST ;Post installation processes
"RTN","GMRAY40",19,0)
 K ^XTMP("GMRAFIX40")
"RTN","GMRAY40",20,0)
 M ^XTMP("GMRAFIX40")=@XPDGREF@("GMRAFIX40")
"RTN","GMRAY40",21,0)
 I '$D(^XTMP("GMRAFIX40")) W !,"Conversion table not loaded - INSTALLATION ABORTED" S XPDQUIT=2 Q
"RTN","GMRAY40",22,0)
 D Q Q  ;Queue clean up to background
"RTN","GMRAY40",23,0)
 ;
"RTN","GMRAY40",24,0)
Q ;
"RTN","GMRAY40",25,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK
"RTN","GMRAY40",26,0)
 S ZTRTN="DQ^GMRAY40",ZTDESC="GMRA*4*40 POST INSTALL ROUTINE",ZTIO="",ZTDTH=$H
"RTN","GMRAY40",27,0)
 D ^%ZTLOAD I '$G(ZTSK) D BMES^XPDUTL("POST INSTALL NOT QUEUED - RUN DQ^GMRAY40 AFTER INSTALL FINISHES") Q
"RTN","GMRAY40",28,0)
 D BMES^XPDUTL("Post-install queued as task # "_$G(ZTSK))
"RTN","GMRAY40",29,0)
 Q
"RTN","GMRAY40",30,0)
 ;
"RTN","GMRAY40",31,0)
DQ ;Process begins here
"RTN","GMRAY40",32,0)
 N ERR,TU,TE,TF
"RTN","GMRAY40",33,0)
 D FIXB
"RTN","GMRAY40",34,0)
 D FIXALG
"RTN","GMRAY40",35,0)
 D MAIL
"RTN","GMRAY40",36,0)
 S ^XTMP("GMRAFIX40",0)=$$FMADD^XLFDT(DT,30)_"^"_DT_"^Patch GMRA*4*40 conversion table"
"RTN","GMRAY40",37,0)
 K ^XTMP("GMRAFX","FREE") ;Kill free text list so it forces rebuild
"RTN","GMRAY40",38,0)
 Q
"RTN","GMRAY40",39,0)
 ;
"RTN","GMRAY40",40,0)
FIXB ;Kill and reset "B" xref on file 120.8 to be sure it's correct
"RTN","GMRAY40",41,0)
 N DIK
"RTN","GMRAY40",42,0)
 K ^GMR(120.8,"B")
"RTN","GMRAY40",43,0)
 S DIK="^GMR(120.8,"
"RTN","GMRAY40",44,0)
 S DIK(1)=".01^B"
"RTN","GMRAY40",45,0)
 D ENALL^DIK ;Resets B xref
"RTN","GMRAY40",46,0)
 Q
"RTN","GMRAY40",47,0)
 ;
"RTN","GMRAY40",48,0)
FIXALG ;Loop through 120.8 update existing free text entries
"RTN","GMRAY40",49,0)
 N GMRAI,FREE,REACTANT,ENTRY,GMRAR
"RTN","GMRAY40",50,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.8,GMRAI)) Q:'+GMRAI  D
"RTN","GMRAY40",51,0)
 .I '$D(^GMR(120.8,GMRAI,0))!($L($G(^GMR(120.8,GMRAI,0)),"^")=1) D DEL Q
"RTN","GMRAY40",52,0)
 .Q:+$G(^GMR(120.8,GMRAI,"ER"))!($$TESTPAT^VADPT($P(^GMR(120.8,GMRAI,0),U)))!($$DECEASED^GMRAFX($P(^GMR(120.8,GMRAI,0),U)))  ;stop if entered in error, test patient or deceased patient
"RTN","GMRAY40",53,0)
 .S REACTANT=$P(^GMR(120.8,GMRAI,0),U,2)
"RTN","GMRAY40",54,0)
 .I REACTANT["ANGIOTEN"&(REACTANT["( FREE TEXT )") D  Q
"RTN","GMRAY40",55,0)
 ..S GMRAR=$$UP^XLFSTR($E($P(REACTANT," ( FREE TEXT )"),1,30)) ;Get just term
"RTN","GMRAY40",56,0)
 ..S ENTRY=$G(^XTMP("GMRAFIX40",GMRAR)) ;Is entry in the table
"RTN","GMRAY40",57,0)
 ..I ENTRY="" Q  ;Entry not found or designated free text - leave alone
"RTN","GMRAY40",58,0)
 ..D UPDATE ;Update entry from table
"RTN","GMRAY40",59,0)
 .I REACTANT="ACE INHIBITORS" S GMRAR=REACTANT I $$CHANGED(.GMRAR) D
"RTN","GMRAY40",60,0)
 ..S GMRAR=$E(GMRAR,1,30) ;Get 1st 30 chars of term
"RTN","GMRAY40",61,0)
 ..S ENTRY=$G(^XTMP("GMRAFIX40",GMRAR))
"RTN","GMRAY40",62,0)
 ..I ENTRY="",$D(^XTMP("GMRAFIX40",GMRAR)) S REACTANT=GMRAR D UPDATEF Q  ;Convert term to FREE TEXT as it should have been
"RTN","GMRAY40",63,0)
 ..I $D(^XTMP("GMRAFIX40",GMRAR)) D UPDATE
"RTN","GMRAY40",64,0)
 Q
"RTN","GMRAY40",65,0)
 ;
"RTN","GMRAY40",66,0)
DEL ;No zero node, remove entry
"RTN","GMRAY40",67,0)
 N DIK,DA,GMRADONT
"RTN","GMRAY40",68,0)
 S GMRADONT=1 ;Stop HDR from receiving update as it's not needed
"RTN","GMRAY40",69,0)
 S DIK="^GMR(120.8,",DA=GMRAI
"RTN","GMRAY40",70,0)
 D ^DIK
"RTN","GMRAY40",71,0)
 Q
"RTN","GMRAY40",72,0)
 ;
"RTN","GMRAY40",73,0)
UPDATEF ;Update reactant to say free text so users know it isn't a standardized entry
"RTN","GMRAY40",74,0)
 N FDA,COM,FREE
"RTN","GMRAY40",75,0)
 S FREE=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0)),FREE=FREE_";GMRD(120.82,"
"RTN","GMRAY40",76,0)
 Q:$G(REACTANT)["FREE TEXT"  ;Already updated to free text, can skip.
"RTN","GMRAY40",77,0)
 S REACTANT=REACTANT_" ( FREE TEXT )"
"RTN","GMRAY40",78,0)
 S FDA(120.8,(GMRAI_","),.02)=REACTANT
"RTN","GMRAY40",79,0)
 S FDA(120.8,(GMRAI_","),1)=FREE
"RTN","GMRAY40",80,0)
 D FILE^DIE(,"FDA")
"RTN","GMRAY40",81,0)
 S TF=$G(TF)+1 ;Increment total free text updated counter
"RTN","GMRAY40",82,0)
 S COM="Updated using the auto clean up process from GMRA*4*40.  Changed reactant from ACE INIHIBITORS (file - 50.605) to "_REACTANT
"RTN","GMRAY40",83,0)
 D ADCOM^GMRAFX(GMRAI,"O",COM)
"RTN","GMRAY40",84,0)
 Q
"RTN","GMRAY40",85,0)
 ;
"RTN","GMRAY40",86,0)
UPDATEE ;Mark as entered in error, check for NKA
"RTN","GMRAY40",87,0)
 N DIE,DA,DR,DFN,USER,TIME
"RTN","GMRAY40",88,0)
 S DFN=$P(^GMR(120.8,GMRAI,0),U) ;Patient's IEN
"RTN","GMRAY40",89,0)
 S USER=$P(^GMR(120.8,GMRAI,0),U,5),TIME=$P(^(0),U,4)
"RTN","GMRAY40",90,0)
 S DIE="^GMR(120.8,",DA=GMRAI,DR="22///1;23///NOW;24////"_$G(DUZ,.5)
"RTN","GMRAY40",91,0)
 D ^DIE ;Entry is now entered in error
"RTN","GMRAY40",92,0)
 D ADCOM^GMRAFX(GMRAI,"E","Marked entered in error by auto-update in patch GMRA*4*40") ;Adds comment to allergy record
"RTN","GMRAY40",93,0)
 I $$NKASCR^GMRANKA(DFN) D
"RTN","GMRAY40",94,0)
 .I $P(ENTRY,U,2)="NKDA" S DA=DFN,DIE="^GMR(120.86,",DR="1////0;2////"_$G(USER,DUZ)_";3////"_$G(TIME,$$NOW^XLFDT) D ^DIE Q  ;Set assessment to NKA
"RTN","GMRAY40",95,0)
 .D CLN^GMRANKA ;Delete assessment
"RTN","GMRAY40",96,0)
 S TE=$G(TE)+1 ;Increment total entered in error counter
"RTN","GMRAY40",97,0)
 Q
"RTN","GMRAY40",98,0)
 ;
"RTN","GMRAY40",99,0)
UPDATE ;Update free text entry to data found in table
"RTN","GMRAY40",100,0)
 N DFN,DIE,DA,DR,AIFN,COM,SIEN,FILE,NAME,IEN,GMRAAR,GMRAPA,GMRASCR,ERRCODE
"RTN","GMRAY40",101,0)
 S DFN=$P(^GMR(120.8,GMRAI,0),U)
"RTN","GMRAY40",102,0)
 S GMRAPA=GMRAI
"RTN","GMRAY40",103,0)
 S FILE=$P(ENTRY,U),NAME=$P(ENTRY,U,2)
"RTN","GMRAY40",104,0)
 S IEN=$$FIND1^DIC(FILE,"",$S(FILE=120.82:"X",1:"MX"),NAME,$S(FILE=120.82:"B",1:""),,"ERRCODE")
"RTN","GMRAY40",105,0)
 I '+IEN S IEN=$$FIND1^DIC(FILE,"","MX",NAME_" ","",,"ERRCODE")
"RTN","GMRAY40",106,0)
 I '+IEN,NAME="ANTIMUSCARINICS/ANTISPASMODICS" S IEN=$$FIND1^DIC(FILE,"","MX","GA801","",,"ERRCODE")
"RTN","GMRAY40",107,0)
 I '+IEN,$L($T(SCREEN^XTID)) S GMRASCR="I '$$SCREEN^XTID(FILE,,Y_"","")" S IEN=$$FIND1^DIC(FILE,"","MX",NAME,"",$G(GMRASCR),"ERRCODE")
"RTN","GMRAY40",108,0)
 I '+IEN S ERR(2,DFN,REACTANT)=ENTRY D UPDATEF Q
"RTN","GMRAY40",109,0)
 S GMRAAR=IEN_";"_$S(FILE=50:"PSDRUG(",FILE=50.416:"PS(50.416,",FILE=50.605:"PS(50.605,",FILE=120.82:"GMRD(120.82,",1:"PSNDF(50.6,")
"RTN","GMRAY40",110,0)
 S GMRAAR(0)=NAME
"RTN","GMRAY40",111,0)
 S GMRAAR("O")=$S(FILE=120.82:$P(^GMRD(120.82,IEN,0),U,2),1:"D")
"RTN","GMRAY40",112,0)
 I $$DUP^GMRAFX3 S ERR(3,DFN,REACTANT)=ENTRY D UPDATEF Q  ;Would create a duplicate if update occur
"RTN","GMRAY40",113,0)
 ;Update reactant, allergy and signed off fields
"RTN","GMRAY40",114,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////"_GMRAAR(0)_";1////^S X=GMRAAR"_";3.1////"_GMRAAR("O")_";15///1" D ^DIE
"RTN","GMRAY40",115,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;Observed reaction, need to update data
"RTN","GMRAY40",116,0)
 .S AIFN=0
"RTN","GMRAY40",117,0)
 .F  S AIFN=$O(^GMR(120.85,"C",GMRAPA,AIFN)) Q:'+AIFN  D
"RTN","GMRAY40",118,0)
 ..S SIEN=$O(^GMR(120.85,AIFN,3,"B",REACTANT,0)) Q:'+SIEN  ;Was previous reactant stored as "suspected agent"
"RTN","GMRAY40",119,0)
 ..S DA(1)=AIFN,DA=SIEN
"RTN","GMRAY40",120,0)
 ..S DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=GMRAAR(0)" D ^DIE ;Update suspected agent to new value
"RTN","GMRAY40",121,0)
 D DELMUL^GMRAFX3(2),DELMUL^GMRAFX3(3) ;Delete drug ingredient/drug classes multiples
"RTN","GMRAY40",122,0)
 I GMRAAR("O")["D" D UPDATE^GMRAPES1 K LIST ;If reactant type is Drug then add appropriate ingredients and classes
"RTN","GMRAY40",123,0)
 S COM="Updated using auto clean up process from GMRA*4*40.  Changed reactant from ACE INHIBITORS (file - 50.605) to "_GMRAAR(0)_" (file - "_$P(GMRAAR,";",2)_")"
"RTN","GMRAY40",124,0)
 D ADCOM^GMRAFX(GMRAPA,"O",COM) ;Add a comment for this update
"RTN","GMRAY40",125,0)
 S TU=$G(TU)+1 ;Increment total updated counter
"RTN","GMRAY40",126,0)
 Q
"RTN","GMRAY40",127,0)
 ;
"RTN","GMRAY40",128,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY40",129,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT,CNT,VADM,DFN,REACTANT,LOOP,DIFROM,EXTRA
"RTN","GMRAY40",130,0)
 S XMDUZ="PATCH GMRA*4*40 POST-INSTALL"
"RTN","GMRAY40",131,0)
 S XMY("DAVID.NABER@VA.GOV")="",XMY("CATHERINE.HOANG2@VA.GOV")=""
"RTN","GMRAY40",132,0)
 S XMY("HULET.LEE_ANN@FORUM.VA.GOV")="",XMY("KEN.BARLOW@VA.GOV")=""
"RTN","GMRAY40",133,0)
 S EXTRA=($D(ERR(2))!($D(ERR(3))))
"RTN","GMRAY40",134,0)
 I 'EXTRA S XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY40",135,0)
 S CNT=1
"RTN","GMRAY40",136,0)
 S GMRATXT(CNT)="The post-install routine for patch GMRA*4*40",CNT=CNT+1
"RTN","GMRAY40",137,0)
 S GMRATXT(CNT)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_".",CNT=CNT+1
"RTN","GMRAY40",138,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY40",139,0)
 I $G(ERR)=1 D
"RTN","GMRAY40",140,0)
 .S GMRATXT(CNT)="**NOTE: There was a problem with the installation!",CNT=CNT+1
"RTN","GMRAY40",141,0)
 .S GMRATXT(CNT)="Required entry missing from file 120.82 - CONVERSION ABORTED.",CNT=CNT+1
"RTN","GMRAY40",142,0)
 .S GMRATXT(CNT)="Contact the National Help Desk for Immediate assistance.",CNT=CNT+1
"RTN","GMRAY40",143,0)
 I $G(TU)!($G(TE))!($G(TF)) D
"RTN","GMRAY40",144,0)
 .S GMRATXT(CNT)="Here are the results of the update:",CNT=CNT+1
"RTN","GMRAY40",145,0)
 .S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY40",146,0)
 .F LOOP="TU","TF","TE" D
"RTN","GMRAY40",147,0)
 ..S GMRATXT(CNT)=$S(+$G(@LOOP)=0:"No entries were",$G(@LOOP)=1:"One entry was",1:$G(@LOOP)_" entries were")_" "
"RTN","GMRAY40",148,0)
 ..S GMRATXT(CNT)=GMRATXT(CNT)_$S(LOOP="TU":"updated to new terms",LOOP="TF":"updated to have (FREE TEXT) appended to the term",1:"marked entered in error")_".",CNT=CNT+1
"RTN","GMRAY40",149,0)
 .S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY40",150,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*40 Post Install COMPLETED"
"RTN","GMRAY40",151,0)
 D ^XMD ;Send totals to OI reps, include local if no problems
"RTN","GMRAY40",152,0)
 F LOOP=2,3 D
"RTN","GMRAY40",153,0)
 .I $D(ERR(LOOP)) D
"RTN","GMRAY40",154,0)
 ..S GMRATXT(CNT)="The following patients have allergies that couldn't be converted",CNT=CNT+1
"RTN","GMRAY40",155,0)
 ..S GMRATXT(CNT)=$S(LOOP=2:"because the term to update them to couldn't be found in the local files.",1:"because it would create a duplicate entry."),CNT=CNT+1
"RTN","GMRAY40",156,0)
 ..S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY40",157,0)
 ..S DFN=0 F  S DFN=$O(ERR(LOOP,DFN)) Q:'+DFN  D
"RTN","GMRAY40",158,0)
 ...K VADM D DEM^VADPT
"RTN","GMRAY40",159,0)
 ...S GMRATXT(CNT)="PATIENT: "_VADM(1)_" ("_$E(VADM(2),6,9)_")",CNT=CNT+1
"RTN","GMRAY40",160,0)
 ...S REACTANT="" F  S REACTANT=$O(ERR(LOOP,DFN,REACTANT)) Q:REACTANT=""  D
"RTN","GMRAY40",161,0)
 ....S GMRATXT(CNT)="Can't convert "_REACTANT_" to "_$P(ERR(LOOP,DFN,REACTANT),U,2)_" (file: "_$P(ERR(LOOP,DFN,REACTANT),U)_")",CNT=CNT+1
"RTN","GMRAY40",162,0)
 ...S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY40",163,0)
 ..S $P(GMRATXT(CNT),"*",70)="*",CNT=CNT+1,GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY40",164,0)
 I EXTRA D
"RTN","GMRAY40",165,0)
 .K XMY S XMY(.5)="" S:$G(DUZ) XMY(DUZ)="" ;Send full report to local site only
"RTN","GMRAY40",166,0)
 .S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*40 Post Install COMPLETED"
"RTN","GMRAY40",167,0)
 .D ^XMD
"RTN","GMRAY40",168,0)
 Q
"RTN","GMRAY40",169,0)
 ;
"RTN","GMRAY40",170,0)
CHANGED(GMRAR) ;Was entry changed by patch 29?
"RTN","GMRAY40",171,0)
 N CHANGED,SUB
"RTN","GMRAY40",172,0)
 S CHANGED=0
"RTN","GMRAY40",173,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,GMRAI,26,SUB)) Q:'+SUB!(CHANGED)  D
"RTN","GMRAY40",174,0)
 .I $G(^GMR(120.8,GMRAI,26,SUB,2,1,0))["GMRA*4*29" S GMRAR=$$UP^XLFSTR($P($P(^GMR(120.8,GMRAI,26,SUB,2,1,0),"reactant from ",2)," (free text)",1)) ;get term and upper case it
"RTN","GMRAY40",175,0)
 .I $G(^GMR(120.8,GMRAI,26,SUB,2,1,0))["GMRA*4*29",$G(GMRAR)["ANGIOTEN" S CHANGED=1
"RTN","GMRAY40",176,0)
 Q CHANGED
"TEMP","GMRAFIX40",0)
3070809^3070710^Patch GMRA*4*40 conversion table
"TEMP","GMRAFIX40","ANGIOTEN")

"TEMP","GMRAFIX40","ANGIOTEN RECEPTOR BLOCKER")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN 11 RECEPTOR BLOCKE")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN 2 INHIBITOR")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN I ANTAGONISTS")

"TEMP","GMRAFIX40","ANGIOTENSIN II INHIBITOR (VALS")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN II RECEPTOR BLOCKE")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN RECEPTOR ANTAGS")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN RECEPTOR BLOCKER")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN RECEPTOR BLOCKERS")
50.605^ANGIOTENSIN II INHIBITOR
"TEMP","GMRAFIX40","ANGIOTENSIN RECEPTORS")

"TEMP","GMRAFIX40","ANGIOTENSION")

"TEMP","GMRAFIX40","ANGIOTENSION RECEPTOR BLOCKERS")
50.605^ANGIOTENSIN II INHIBITOR
"VER")
8.0^22.0
"BLD",6684,6)
^36
**END**
**END**
