EMERGENCY Released PSO*7*217 SEQ #191
Extracted from mail message
**KIDS**:PSO*7.0*217^

**INSTALL NAME**
PSO*7.0*217
"BLD",6374,0)
PSO*7.0*217^OUTPATIENT PHARMACY^0^3051012^y
"BLD",6374,1,0)
^^4^4^3050816^
"BLD",6374,1,1,0)
Prompt for a Tally or Back-Bill run and based on this response either 
"BLD",6374,1,2,0)
produce a Tally or Back-Billing message & report of all Outpatient
"BLD",6374,1,3,0)
Pharmacy refills that were released via the OPAI 2.4 automated interface
"BLD",6374,1,4,0)
since the install of patch PSO*7*156.
"BLD",6374,4,0)
^9.64PA^^
"BLD",6374,"ABPKG")
n
"BLD",6374,"INID")
^n
"BLD",6374,"INIT")
PSOCPBK3
"BLD",6374,"KRN",0)
^9.67PA^8989.52^19
"BLD",6374,"KRN",.4,0)
.4
"BLD",6374,"KRN",.401,0)
.401
"BLD",6374,"KRN",.402,0)
.402
"BLD",6374,"KRN",.403,0)
.403
"BLD",6374,"KRN",.5,0)
.5
"BLD",6374,"KRN",.84,0)
.84
"BLD",6374,"KRN",3.6,0)
3.6
"BLD",6374,"KRN",3.8,0)
3.8
"BLD",6374,"KRN",9.2,0)
9.2
"BLD",6374,"KRN",9.8,0)
9.8
"BLD",6374,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",6374,"KRN",9.8,"NM",1,0)
PSOCPBK3^^0^42446579
"BLD",6374,"KRN",9.8,"NM",2,0)
PSOCPBK4^^0^81010442
"BLD",6374,"KRN",9.8,"NM",3,0)
PSOCPBK5^^0^31112048
"BLD",6374,"KRN",9.8,"NM","B","PSOCPBK3",1)

"BLD",6374,"KRN",9.8,"NM","B","PSOCPBK4",2)

"BLD",6374,"KRN",9.8,"NM","B","PSOCPBK5",3)

"BLD",6374,"KRN",19,0)
19
"BLD",6374,"KRN",19.1,0)
19.1
"BLD",6374,"KRN",101,0)
101
"BLD",6374,"KRN",409.61,0)
409.61
"BLD",6374,"KRN",771,0)
771
"BLD",6374,"KRN",870,0)
870
"BLD",6374,"KRN",8989.51,0)
8989.51
"BLD",6374,"KRN",8989.52,0)
8989.52
"BLD",6374,"KRN",8994,0)
8994
"BLD",6374,"KRN","B",.4,.4)

"BLD",6374,"KRN","B",.401,.401)

"BLD",6374,"KRN","B",.402,.402)

"BLD",6374,"KRN","B",.403,.403)

"BLD",6374,"KRN","B",.5,.5)

"BLD",6374,"KRN","B",.84,.84)

"BLD",6374,"KRN","B",3.6,3.6)

"BLD",6374,"KRN","B",3.8,3.8)

"BLD",6374,"KRN","B",9.2,9.2)

"BLD",6374,"KRN","B",9.8,9.8)

"BLD",6374,"KRN","B",19,19)

"BLD",6374,"KRN","B",19.1,19.1)

"BLD",6374,"KRN","B",101,101)

"BLD",6374,"KRN","B",409.61,409.61)

"BLD",6374,"KRN","B",771,771)

"BLD",6374,"KRN","B",870,870)

"BLD",6374,"KRN","B",8989.51,8989.51)

"BLD",6374,"KRN","B",8989.52,8989.52)

"BLD",6374,"KRN","B",8994,8994)

"BLD",6374,"QUES",0)
^9.62^2^2
"BLD",6374,"QUES",1,0)
POS1
"BLD",6374,"QUES",1,1)
YA^^
"BLD",6374,"QUES",1,"A")
Do you want to Run the Back-Billing process? 
"BLD",6374,"QUES",1,"A1",0)
^^1^1^3050912^^
"BLD",6374,"QUES",1,"A1",1,0)
*************************** SELECT JOB OPTION ****************************
"BLD",6374,"QUES",1,"B")

"BLD",6374,"QUES",1,"Q")
Enter Y for Yes to run Back Billing or N for No to install patch only.
"BLD",6374,"QUES",2,0)
POS2
"BLD",6374,"QUES",2,1)
D^::%DT
"BLD",6374,"QUES",2,"A")
Enter when to Queue the Job to run in date@time format
"BLD",6374,"QUES",2,"B")
NOW
"BLD",6374,"QUES",2,"M")
I XPDQUES("POS1")=0 K DIR
"BLD",6374,"QUES",2,"Q")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p.
"BLD",6374,"QUES","B","POS1",1)

"BLD",6374,"QUES","B","POS2",2)

"BLD",6374,"REQB",0)
^9.611^^
"INIT")
PSOCPBK3
"MBREQ")
0
"PKG",134,-1)
1^1
"PKG",134,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",134,20,0)
^9.402P^^
"PKG",134,22,0)
^9.49I^1^1
"PKG",134,22,1,0)
7.0^2971216^2980417^1271
"PKG",134,22,1,"PAH",1,0)
217^3051012
"PKG",134,22,1,"PAH",1,1,0)
^^4^4^3051012
"PKG",134,22,1,"PAH",1,1,1,0)
Prompt for a Tally or Back-Bill run and based on this response either 
"PKG",134,22,1,"PAH",1,1,2,0)
produce a Tally or Back-Billing message & report of all Outpatient
"PKG",134,22,1,"PAH",1,1,3,0)
Pharmacy refills that were released via the OPAI 2.4 automated interface
"PKG",134,22,1,"PAH",1,1,4,0)
since the install of patch PSO*7*156.
"QUES","POS1",0)
YA^^
"QUES","POS1","?")
Enter Y for Yes to run Back Billing or N for No to install patch only.
"QUES","POS1","A")
Do you want to Run the Back-Billing process? 
"QUES","POS1","A",1)
*************************** SELECT JOB OPTION ****************************
"QUES","POS1","B")

"QUES","POS2",0)
D^::%DT
"QUES","POS2","?")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p.
"QUES","POS2","A")
Enter when to Queue the Job to run in date@time format
"QUES","POS2","B")
NOW
"QUES","POS2","M")
I XPDQUES("POS1")=0 K DIR
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSOCPBK3")
0^1^B42446579
"RTN","PSOCPBK3",1,0)
PSOCPBK3 ;BIR/GN-Copay Back Bill for Automated-release refills ;10/6/05 4:57pm
"RTN","PSOCPBK3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**217**;DEC 1997
"RTN","PSOCPBK3",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCPBK3",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCPBK3",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCPBK3",6,0)
 ;
"RTN","PSOCPBK3",7,0)
 N NAMSP,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,RUNOPT,JOBN,Y
"RTN","PSOCPBK3",8,0)
 S NAMSP=$$NAMSP
"RTN","PSOCPBK3",9,0)
 S JOBN="Back Bill"
"RTN","PSOCPBK3",10,0)
 ;
"RTN","PSOCPBK3",11,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCPBK3",12,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","PSOCPBK3",13,0)
 . D MES^XPDUTL("")
"RTN","PSOCPBK3",14,0)
 . D QUIT
"RTN","PSOCPBK3",15,0)
 ;
"RTN","PSOCPBK3",16,0)
 I '$D(^XTMP(NAMSP)) D INITXTMP(NAMSP,"BACK BILLING of unbilled copays for refills via OPAI, PSO*7*217",90)        ;90 day life
"RTN","PSOCPBK3",17,0)
 S QUIT=0
"RTN","PSOCPBK3",18,0)
 ;
"RTN","PSOCPBK3",19,0)
 ;ques 1, if running from mumps prompt
"RTN","PSOCPBK3",20,0)
 I '$D(XPDQUES("POS1")) D  I QUIT D QUIT Q
"RTN","PSOCPBK3",21,0)
 . ;selected cancel run at last install, dont allow to run manually
"RTN","PSOCPBK3",22,0)
 . I $G(^XTMP(NAMSP,0,"LAST"))["CANCEL" D  Q
"RTN","PSOCPBK3",23,0)
 . . S QUIT=1
"RTN","PSOCPBK3",24,0)
 . . W !!,*7,"The last install of this patch you selected to NOT Run Back-Billing"
"RTN","PSOCPBK3",25,0)
 . . W !,"If you have changed your mind, you must re-install the patch to run",!!
"RTN","PSOCPBK3",26,0)
 . K DIR
"RTN","PSOCPBK3",27,0)
 . S DIR("A",1)="****************** SELECT RUN OPTION ******************"
"RTN","PSOCPBK3",28,0)
 . S DIR("A")="Do you want to run the Back-Billing process? "
"RTN","PSOCPBK3",29,0)
 . S DIR(0)="YA^^"
"RTN","PSOCPBK3",30,0)
 . D ^DIR I $D(DTOUT)!($D(DUOUT)) W !,"Halting..." S QUIT=1 Q
"RTN","PSOCPBK3",31,0)
 . S RUNOPT=Y
"RTN","PSOCPBK3",32,0)
 . S:'RUNOPT QUIT=1
"RTN","PSOCPBK3",33,0)
 ;
"RTN","PSOCPBK3",34,0)
 ;ques 1, if running from kids install
"RTN","PSOCPBK3",35,0)
 I $D(XPDQUES("POS1")) D  I 'RUNOPT D QUIT Q
"RTN","PSOCPBK3",36,0)
 . S RUNOPT=XPDQUES("POS1")
"RTN","PSOCPBK3",37,0)
 . S:'RUNOPT ^XTMP(NAMSP,0,"LAST")="CANCEL RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOCPBK3",38,0)
 . D BMES^XPDUTL("***** SELECTED "_$S('RUNOPT:"NOT ",1:"")_"TO RUN BACK-BILLING *****")
"RTN","PSOCPBK3",39,0)
 ;
"RTN","PSOCPBK3",40,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","PSOCPBK3",41,0)
 . W !!,*7,"This job has been run before to completion on "
"RTN","PSOCPBK3",42,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",2)),!!
"RTN","PSOCPBK3",43,0)
 . D QUIT
"RTN","PSOCPBK3",44,0)
 ;
"RTN","PSOCPBK3",45,0)
 ;ques 2, if running from mumps prompt
"RTN","PSOCPBK3",46,0)
 I '$D(XPDQUES("POS2")) D  I 'ZTDTH D QUIT Q
"RTN","PSOCPBK3",47,0)
 . K DIR
"RTN","PSOCPBK3",48,0)
 . S DIR("A")="Enter when to Queue the "_JOBN_" job to run in date@time format "
"RTN","PSOCPBK3",49,0)
 . S DIR("B")="NOW"
"RTN","PSOCPBK3",50,0)
 . S DIR(0)="D^::%DT"
"RTN","PSOCPBK3",51,0)
 . S DIR("?")="Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p"
"RTN","PSOCPBK3",52,0)
 . D ^DIR I $D(DTOUT)!($D(DUOUT)) W !,"Halting..." S ZTDTH="" Q
"RTN","PSOCPBK3",53,0)
 . S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSOCPBK3",54,0)
 ;
"RTN","PSOCPBK3",55,0)
 ;ques 2, if running from kids install
"RTN","PSOCPBK3",56,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","PSOCPBK3",57,0)
 ;
"RTN","PSOCPBK3",58,0)
 D BMES^XPDUTL("===================================================")
"RTN","PSOCPBK3",59,0)
 D MES^XPDUTL("Queuing background job to "_JOBN_" unbilled refills...")
"RTN","PSOCPBK3",60,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSOCPBK3",61,0)
 D MES^XPDUTL("===================================================")
"RTN","PSOCPBK3",62,0)
 I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","PSOCPBK3",63,0)
 ;
"RTN","PSOCPBK3",64,0)
 I $P($G(^XTMP(NAMSP,0,"LAST")),"^")="STOP" D
"RTN","PSOCPBK3",65,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","PSOCPBK3",66,0)
 E  D
"RTN","PSOCPBK3",67,0)
 . S ^XTMP(NAMSP,0,"LAST")="RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOCPBK3",68,0)
 ;
"RTN","PSOCPBK3",69,0)
 S ZTRTN="EN^PSOCPBK3",ZTIO=""
"RTN","PSOCPBK3",70,0)
 S ZTDESC="Background job to "_JOBN_" unbilled copays for refills via OPAI"
"RTN","PSOCPBK3",71,0)
 S ZTSAVE("JOBN")=""
"RTN","PSOCPBK3",72,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK3",73,0)
 D ^%ZTLOAD
"RTN","PSOCPBK3",74,0)
 D:$D(ZTSK)
"RTN","PSOCPBK3",75,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSOCPBK3",76,0)
 . D BMES^XPDUTL("")
"RTN","PSOCPBK3",77,0)
 D BMES^XPDUTL("")
"RTN","PSOCPBK3",78,0)
 K XPDQUES
"RTN","PSOCPBK3",79,0)
 Q
"RTN","PSOCPBK3",80,0)
QUIT ;
"RTN","PSOCPBK3",81,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK3",82,0)
 Q
"RTN","PSOCPBK3",83,0)
EN ;
"RTN","PSOCPBK3",84,0)
 N NAMSP S NAMSP=$$NAMSP
"RTN","PSOCPBK3",85,0)
 ;if can't get Lock, then already running.
"RTN","PSOCPBK3",86,0)
 L +^XTMP(NAMSP):3 I '$T D  Q
"RTN","PSOCPBK3",87,0)
 . S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK3",88,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="LOCKED^"_$$NOW^XLFDT
"RTN","PSOCPBK3",89,0)
 ;
"RTN","PSOCPBK3",90,0)
 N PSODT,RXP,PSOTEXT,XX,YY,PSOCNT,PSOSTART,PSOEND,PSOVETS,PSOTRX,XIEN
"RTN","PSOCPBK3",91,0)
 N PSOSCMX,PSODFN,PSOREL,PSOAMT,FOUND,V24,PSOTRF,PSOEND2,PSOSTRT2,CC
"RTN","PSOCPBK3",92,0)
 N PSOTIME,PSOSTNM,PSOS1,PSOINST,I,PSOTC,PSOCNTS,LIN,%,X1,XMY,STO
"RTN","PSOCPBK3",93,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCPBK3",94,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBK3",95,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCPBK3",96,0)
 S PSODT=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",3)
"RTN","PSOCPBK3",97,0)
 S RXP=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",4)
"RTN","PSOCPBK3",98,0)
 ;
"RTN","PSOCPBK3",99,0)
 ;get 1st occurence of install date of patch PSO*7*156 (OPAI)
"RTN","PSOCPBK3",100,0)
 S XIEN=+$O(^XPD(9.7,"B","PSO*7.0*156",0))
"RTN","PSOCPBK3",101,0)
 S:'PSODT PSODT=+$P($G(^XPD(9.7,XIEN,1)),"^",3)
"RTN","PSOCPBK3",102,0)
 I 'PSODT D  Q
"RTN","PSOCPBK3",103,0)
 . S ^XTMP(NAMSP,0,.1)="OPAI PATCH PSO*7*156 IS NOT INSTALLED"
"RTN","PSOCPBK3",104,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCPBK3",105,0)
 . D MAIL3^PSOCPBK5(^XTMP(NAMSP,0,.1))
"RTN","PSOCPBK3",106,0)
 ;
"RTN","PSOCPBK3",107,0)
 ;check if any division is on v2.4 (OPAI interface)
"RTN","PSOCPBK3",108,0)
 S V24=0
"RTN","PSOCPBK3",109,0)
 F XX=0:0 S XX=$O(^PS(59,XX)) Q:'XX  D  Q:V24
"RTN","PSOCPBK3",110,0)
 . S:+$G(^PS(59,XX,"DISP"))=2.4 V24=1
"RTN","PSOCPBK3",111,0)
 I 'V24 D  Q
"RTN","PSOCPBK3",112,0)
 . S ^XTMP(NAMSP,0,.2)="OPAI IS INSTALLED BUT IS NOT TURNED ON"
"RTN","PSOCPBK3",113,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCPBK3",114,0)
 . D MAIL3^PSOCPBK5(^XTMP(NAMSP,0,.2))
"RTN","PSOCPBK3",115,0)
 ;
"RTN","PSOCPBK3",116,0)
 S (PSOTRX,PSOTRF)=1
"RTN","PSOCPBK3",117,0)
 N STOP K ^XTMP(NAMSP,0,"STOP") S STOP=0          ;init stop flag to 0
"RTN","PSOCPBK3",118,0)
 F CC=1:1 S PSODT=$O(^PSRX("AL",PSODT)) Q:'PSODT  D  Q:STOP
"RTN","PSOCPBK3",119,0)
 . I CC#100=0,$D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCPBK3",120,0)
 . . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCPBK3",121,0)
 . F PSOTRX=PSOTRX+1:1 S RXP=$O(^PSRX("AL",PSODT,RXP)) Q:'RXP  D
"RTN","PSOCPBK3",122,0)
 .. ;save last date & fill info
"RTN","PSOCPBK3",123,0)
 .. S $P(^XTMP(NAMSP,0,"LAST"),"^",3,5)=PSODT_"^"_RXP_"^"_PSOTRX
"RTN","PSOCPBK3",124,0)
 .. S PSODFN=$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSOCPBK3",125,0)
 .. Q:('PSODFN)!('$D(^DPT(PSODFN,0)))        ;quit, no valid DFN info
"RTN","PSOCPBK3",126,0)
 .. D XTYPE^PSOCPBK4
"RTN","PSOCPBK3",127,0)
 .. Q:+PSOSCMX=0                             ;quit, Exempt or deceased
"RTN","PSOCPBK3",128,0)
 .. ;search refills only, ignore 0=orig fill
"RTN","PSOCPBK3",129,0)
 .. F YY=0:0 S YY=$O(^PSRX("AL",PSODT,RXP,YY)) Q:'YY  D ADDBILL^PSOCPBK4
"RTN","PSOCPBK3",130,0)
 Q:STOP
"RTN","PSOCPBK3",131,0)
 ;
"RTN","PSOCPBK3",132,0)
 S PSOCNT=0
"RTN","PSOCPBK3",133,0)
 D BILLIT^PSOCPBK4 Q:STOP
"RTN","PSOCPBK3",134,0)
 D TOTAL^PSOCPBK4
"RTN","PSOCPBK3",135,0)
 S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCPBK3",136,0)
 D MAIL^PSOCPBK5
"RTN","PSOCPBK3",137,0)
 D MAIL2^PSOCPBK5
"RTN","PSOCPBK3",138,0)
 D MAILAAC^PSOCPBK5
"RTN","PSOCPBK3",139,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK3",140,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK3",141,0)
 K JOBN
"RTN","PSOCPBK3",142,0)
 Q
"RTN","PSOCPBK3",143,0)
 ;
"RTN","PSOCPBK3",144,0)
STATUS ;show status of job running
"RTN","PSOCPBK3",145,0)
 I $$ST D
"RTN","PSOCPBK3",146,0)
 . W !,"Currently processing:"
"RTN","PSOCPBK3",147,0)
 . I ^XTMP($$NAMSP,0,"LAST")["COMPLETED" D
"RTN","PSOCPBK3",148,0)
 . . W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOCPBK3",149,0)
 . W !?5,"Released Date > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",3)
"RTN","PSOCPBK3",150,0)
 . W !?5,"         RX # > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",4)
"RTN","PSOCPBK3",151,0)
 . W !?5,"   TOTAL RX's > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",5),!
"RTN","PSOCPBK3",152,0)
 . E  D
"RTN","PSOCPBK3",153,0)
 . I ^XTMP($$NAMSP,0,"LAST")["COMPLETED" D
"RTN","PSOCPBK3",154,0)
 . . W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOCPBK3",155,0)
 Q
"RTN","PSOCPBK3",156,0)
 ;
"RTN","PSOCPBK3",157,0)
STOP ;stop job command
"RTN","PSOCPBK3",158,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSOCPBK3",159,0)
 . W !,"Outpatient RX Copay Tally Job - set to STOP Soon"
"RTN","PSOCPBK3",160,0)
 . W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSOCPBK3",161,0)
 . W !,"     (D STATUS^PSOCPBK3)"
"RTN","PSOCPBK3",162,0)
 Q
"RTN","PSOCPBK3",163,0)
ST() ;status
"RTN","PSOCPBK3",164,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSOCPBK3",165,0)
 . L -^XTMP($$NAMSP)
"RTN","PSOCPBK3",166,0)
 . W !,"*** NOT CURRENTLY RUNNING! ***",!
"RTN","PSOCPBK3",167,0)
 Q 1
"RTN","PSOCPBK3",168,0)
INITXTMP(NAMSP,TITLE,LIFE) ;create ^Xtmp according to SAC std
"RTN","PSOCPBK3",169,0)
 N BEGDT,PURGDT
"RTN","PSOCPBK3",170,0)
 S BEGDT=$$NOW^XLFDT()
"RTN","PSOCPBK3",171,0)
 S PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","PSOCPBK3",172,0)
 S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSOCPBK3",173,0)
 Q
"RTN","PSOCPBK3",174,0)
NAMSP() ;
"RTN","PSOCPBK3",175,0)
 Q $T(+0)
"RTN","PSOCPBK4")
0^2^B81010442
"RTN","PSOCPBK4",1,0)
PSOCPBK4 ;BIR/GN-Copay Back Bill for Automated-release refills cont. ;10/12/05 9:55am
"RTN","PSOCPBK4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**217**;DEC 1997
"RTN","PSOCPBK4",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCPBK4",4,0)
 ;External reference to ^IBAM(354.7 supported by DBIA 3877
"RTN","PSOCPBK4",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCPBK4",6,0)
 ;External reference to $$PTCOV^IBCNSU3 supported by DBIA 4115
"RTN","PSOCPBK4",7,0)
 ;External reference to ^IBARX supported by DBIA 125
"RTN","PSOCPBK4",8,0)
 ;
"RTN","PSOCPBK4",9,0)
 Q
"RTN","PSOCPBK4",10,0)
 ;
"RTN","PSOCPBK4",11,0)
ADDBILL ;add to billable ^XTMP if ok, quit if not
"RTN","PSOCPBK4",12,0)
 S PSOTRF=PSOTRF+1
"RTN","PSOCPBK4",13,0)
 S PSOREL=$P($G(^PSRX(RXP,1,YY,0)),"^",18)
"RTN","PSOCPBK4",14,0)
 Q:'PSOREL                                   ;not released
"RTN","PSOCPBK4",15,0)
 Q:'YY                                       ;orig fill
"RTN","PSOCPBK4",16,0)
 Q:+$$RXST^IBARXEU(PSODFN,$P(PSOREL,"."))    ;Exempt on Rel dte
"RTN","PSOCPBK4",17,0)
 ;check refill
"RTN","PSOCPBK4",18,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",1)'=""    ;already billed
"RTN","PSOCPBK4",19,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",2)'=""    ;exceeded ann. cap
"RTN","PSOCPBK4",20,0)
 ;
"RTN","PSOCPBK4",21,0)
 ;look for Activity log entry per refill # with the below text
"RTN","PSOCPBK4",22,0)
 S FOUND=0
"RTN","PSOCPBK4",23,0)
 F XX=999:0 S XX=$O(^PSRX(RXP,"A",XX),-1) Q:'XX  D  Q:FOUND
"RTN","PSOCPBK4",24,0)
 .Q:$P(^PSRX(RXP,"A",XX,0),"^",4)'=YY
"RTN","PSOCPBK4",25,0)
 .Q:^PSRX(RXP,"A",XX,0)'["External Interface Dispensing is Complete"
"RTN","PSOCPBK4",26,0)
 .S FOUND=1
"RTN","PSOCPBK4",27,0)
 Q:'FOUND
"RTN","PSOCPBK4",28,0)
 ;
"RTN","PSOCPBK4",29,0)
 S ^XTMP(NAMSP,PSODFN,RXP,YY)=$P(PSOREL,".")  ;add to XTMP to be bill
"RTN","PSOCPBK4",30,0)
 Q
"RTN","PSOCPBK4",31,0)
 ;
"RTN","PSOCPBK4",32,0)
XTYPE ;
"RTN","PSOCPBK4",33,0)
 N Y,VADM,I,J,X,SAVY,DFN
"RTN","PSOCPBK4",34,0)
 S DFN=PSODFN D DEM^VADPT I +$G(VADM(6)) S PSOSCMX="" Q  ; DECEASED
"RTN","PSOCPBK4",35,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPBK4",36,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPBK4",37,0)
 I 'X Q
"RTN","PSOCPBK4",38,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCPBK4",39,0)
 I $G(Y)'=1 Q
"RTN","PSOCPBK4",40,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPBK4",41,0)
 I PSOSCMX="",SAVY=0 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPBK4",42,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCPBK4",43,0)
 Q
"RTN","PSOCPBK4",44,0)
 ;
"RTN","PSOCPBK4",45,0)
TOTAL ;
"RTN","PSOCPBK4",46,0)
 N COUNT,COUNTED
"RTN","PSOCPBK4",47,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCPBK4",48,0)
 N I,J
"RTN","PSOCPBK4",49,0)
 F I=1:1:3 S (PSOCNT("YR2004",I),PSOCNT("YR2005",I))=0
"RTN","PSOCPBK4",50,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D
"RTN","PSOCPBK4",51,0)
 .S COUNTED=0
"RTN","PSOCPBK4",52,0)
 .F J="YR2004","YR2005" F I=1:1:3 S COUNT=$G(^XTMP(NAMSP,PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCPBK4",53,0)
 F I=1:1:3 S PSOCNT=PSOCNT+PSOCNT("YR2004",I)+PSOCNT("YR2005",I)
"RTN","PSOCPBK4",54,0)
 Q
"RTN","PSOCPBK4",55,0)
 ;
"RTN","PSOCPBK4",56,0)
BILLIT ;
"RTN","PSOCPBK4",57,0)
 ; IF NO IB NUMBER FOR THIS FILL, SET UP VARIABLES AND TALLY
"RTN","PSOCPBK4",58,0)
 N PSOCAP,PSODIV,PSODV,PSOFILL,PSOLOG,PSOOUT,PSOPAR,PSOPATID,PSOSITE
"RTN","PSOCPBK4",59,0)
 N PSOSITE7,PSOSQ,PSOTOT,PSOYEAR,PSOYR,SSN,SAVCPUN,SAVREF
"RTN","PSOCPBK4",60,0)
 S PSODFN=0
"RTN","PSOCPBK4",61,0)
 F CC=1:1 S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D  Q:STOP
"RTN","PSOCPBK4",62,0)
 .I CC#100=0,$D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCPBK4",63,0)
 ..S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCPBK4",64,0)
 .S (PSOCAP(304),PSOCAP(305))=0 ; INITIAL ANNUAL CAP FOR 2004 & 2005
"RTN","PSOCPBK4",65,0)
 .F RXP=0:0 S RXP=$O(^XTMP(NAMSP,PSODFN,RXP)) Q:'RXP  D
"RTN","PSOCPBK4",66,0)
 ..;calc number of 30-day units eligible to bill
"RTN","PSOCPBK4",67,0)
 ..S (SAVCPUN,PSOCPUN)=($P(^PSRX(RXP,0),"^",8)+29)\30
"RTN","PSOCPBK4",68,0)
 ..F YY=0:0 S YY=$O(^XTMP(NAMSP,PSODFN,RXP,YY)) Q:YY=""  D
"RTN","PSOCPBK4",69,0)
 ...S (SAVREF,PSOREF)=YY
"RTN","PSOCPBK4",70,0)
 ...S PSOREL=$G(^XTMP(NAMSP,PSODFN,RXP,YY))
"RTN","PSOCPBK4",71,0)
 ...I PSOCAP($E(PSOREL,1,3)) Q  ; MET ANNUAL CAP FOR 2004 OR 2005
"RTN","PSOCPBK4",72,0)
 ...I $P($G(^PSRX(RXP,1,YY,"IB")),"^",1)="" D  ; REFILL LEVEL
"RTN","PSOCPBK4",73,0)
 ....D SITE
"RTN","PSOCPBK4",74,0)
 ....D CP^PSOCP                                     ;call back billing
"RTN","PSOCPBK4",75,0)
 ....S PSOCPUN=SAVCPUN,PSOREF=SAVREF
"RTN","PSOCPBK4",76,0)
 ....I $P($G(^PSRX(RXP,1,YY,"IB")),"^",1) D ACCUM   ;Do if was billed?
"RTN","PSOCPBK4",77,0)
 ....D CP I +$G(PSOREF) D ACCUM
"RTN","PSOCPBK4",78,0)
 Q
"RTN","PSOCPBK4",79,0)
 ;
"RTN","PSOCPBK4",80,0)
CP ; Entry point to Check if COPAY  -   Requires RXP,PSOSITE7
"RTN","PSOCPBK4",81,0)
 I '$D(PSOPAR) D ^PSOLSET G CP
"RTN","PSOCPBK4",82,0)
 K PSOCP
"RTN","PSOCPBK4",83,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2) ; Set COPAY dfn PTR TO PATIENT
"RTN","PSOCPBK4",84,0)
 S PSOCP=$P($G(^PSRX(RXP,"IB")),"^") ; IB action type
"RTN","PSOCPBK4",85,0)
 S PSOSAVE=$S(PSOCP:1,1:"") ; save current copay status
"RTN","PSOCPBK4",86,0)
 ;         Set x=service^dfn^actiontype^user duz
"RTN","PSOCPBK4",87,0)
 I +$G(PSOSITE7)'>0 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCPBK4",88,0)
 S X=PSOSITE7_"^"_PSOCPN_"^"_PSOCP_"^"_$P(^PSRX(RXP,0),"^",16)
"RTN","PSOCPBK4",89,0)
 ;
"RTN","PSOCPBK4",90,0)
RX ;         Determine Original or Refill for RX
"RTN","PSOCPBK4",91,0)
 N PSOIB
"RTN","PSOCPBK4",92,0)
 S PSOIB=0
"RTN","PSOCPBK4",93,0)
 S PSOREF=0
"RTN","PSOCPBK4",94,0)
 ;set refill number if this is a refill
"RTN","PSOCPBK4",95,0)
 I $G(^PSRX(RXP,1,+$G(YY),0))]"" S PSOREF=YY
"RTN","PSOCPBK4",96,0)
 ;
"RTN","PSOCPBK4",97,0)
 ;Orig fill -check if bill # already exists
"RTN","PSOCPBK4",98,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1
"RTN","PSOCPBK4",99,0)
 I PSOIB D QUIT Q
"RTN","PSOCPBK4",100,0)
 ;already attempted to bill, but exceeded Anuual Cap
"RTN","PSOCPBK4",101,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",4)>0 D QUIT Q
"RTN","PSOCPBK4",102,0)
 ;
"RTN","PSOCPBK4",103,0)
 ;Refill -check if bill # already exists
"RTN","PSOCPBK4",104,0)
 I PSOREF,+$G(^PSRX(RXP,1,PSOREF,"IB")) D CHKIB^PSOCP1
"RTN","PSOCPBK4",105,0)
 I PSOIB D QUIT Q
"RTN","PSOCPBK4",106,0)
 ;already attempted to bill, but exceeded Anuual Cap
"RTN","PSOCPBK4",107,0)
 I PSOREF,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^",2) G QUIT
"RTN","PSOCPBK4",108,0)
 ;
"RTN","PSOCPBK4",109,0)
 ;set temporary variable to copay and then look for exceptions
"RTN","PSOCPBK4",110,0)
 S PSOCHG=1
"RTN","PSOCPBK4",111,0)
 D COPAYREL
"RTN","PSOCPBK4",112,0)
 I 'PSOCHG D QUIT Q           ;not billable
"RTN","PSOCPBK4",113,0)
 I PSOCHG=2,'PSOCP D QUIT
"RTN","PSOCPBK4",114,0)
 Q
"RTN","PSOCPBK4",115,0)
QUIT ;
"RTN","PSOCPBK4",116,0)
 K Y,PSOCP1,PSOREF,PSOCPUN,PSOCP2,PSOCPN,X,PSOCHG,PSOSAVE,PREA,PSORSN
"RTN","PSOCPBK4",117,0)
 Q
"RTN","PSOCPBK4",118,0)
 ;
"RTN","PSOCPBK4",119,0)
COPAYREL ; Recheck copay status at release
"RTN","PSOCPBK4",120,0)
 ;
"RTN","PSOCPBK4",121,0)
 ; check Rx patient status
"RTN","PSOCPBK4",122,0)
 I $P(^PSRX(RXP,0),"^",3)'="",$P($G(^PS(53,$P(^PSRX(RXP,0),"^",3),0)),"^",7)=1 S PSOCHG=0 Q
"RTN","PSOCPBK4",123,0)
 ; see if drug is investigational or supply
"RTN","PSOCPBK4",124,0)
 N DRG,DRGTYP
"RTN","PSOCPBK4",125,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6),DRGTYP=$P($G(^PSDRUG(DRG,0)),"^",3)
"RTN","PSOCPBK4",126,0)
 I DRGTYP["I" S PSOCHG=0 Q
"RTN","PSOCPBK4",127,0)
 I DRGTYP["S" S PSOCHG=0 Q
"RTN","PSOCPBK4",128,0)
 K PSOTG,CHKXTYPE
"RTN","PSOCPBK4",129,0)
 I +$G(^PSRX(RXP,"IBQ")) D XTYPE1^PSOCP1
"RTN","PSOCPBK4",130,0)
 I $G(^PSRX(RXP,"IBQ"))["1" S PSOCHG=0 Q
"RTN","PSOCPBK4",131,0)
 Q
"RTN","PSOCPBK4",132,0)
 ;
"RTN","PSOCPBK4",133,0)
ACCUM ; ACCUMULATE TOTALS AND SEE IF PATIENT MET ANNUAL CAP
"RTN","PSOCPBK4",134,0)
 S PSOYR=$E(PSOREL,1,3) I PSOYR="" Q
"RTN","PSOCPBK4",135,0)
 S PSOYEAR=$S(PSOYR="304":"YR2004",PSOYR="305":"YR2005",1:"")
"RTN","PSOCPBK4",136,0)
 Q:PSOYEAR=""
"RTN","PSOCPBK4",137,0)
 ;
"RTN","PSOCPBK4",138,0)
 ;get Xtmp billing amt which would be IBAM tot + any previous refills
"RTN","PSOCPBK4",139,0)
 S PSOTOT=$G(^XTMP(NAMSP,PSODFN,PSOYEAR))
"RTN","PSOCPBK4",140,0)
 ;
"RTN","PSOCPBK4",141,0)
 ;if none yet then init to the IBAM total for the year
"RTN","PSOCPBK4",142,0)
 I 'PSOTOT D
"RTN","PSOCPBK4",143,0)
 .F PSOSQ=0:0 S PSOSQ=$O(^IBAM(354.7,PSODFN,1,PSOSQ)) Q:'PSOSQ  D
"RTN","PSOCPBK4",144,0)
 ..S PSOLOG=$G(^IBAM(354.7,PSODFN,1,PSOSQ,0))
"RTN","PSOCPBK4",145,0)
 ..I $E(PSOLOG,1,3)=PSOYR S PSOTOT=PSOTOT+$P(PSOLOG,"^",2)
"RTN","PSOCPBK4",146,0)
 ;
"RTN","PSOCPBK4",147,0)
 ;update Xtmp tot nodes with current refill amounts
"RTN","PSOCPBK4",148,0)
 S ^XTMP(NAMSP,PSODFN,PSOYEAR)=PSOTOT+(PSOCPUN*7)
"RTN","PSOCPBK4",149,0)
 S ^XTMP(NAMSP,PSODFN,PSOYEAR,PSOCPUN)=$G(^XTMP(NAMSP,PSODFN,PSOYEAR,PSOCPUN))+1
"RTN","PSOCPBK4",150,0)
 ;
"RTN","PSOCPBK4",151,0)
 ;indicate this refill may be billable or (was billed, if BILLING run)
"RTN","PSOCPBK4",152,0)
 ;by adding to Xtmp "BILLED"
"RTN","PSOCPBK4",153,0)
 N PSONAM
"RTN","PSOCPBK4",154,0)
 S PSONAM=$P($G(^DPT(PSODFN,0)),"^"),PSONAM=$P(PSONAM,",")
"RTN","PSOCPBK4",155,0)
 S PSONAM=$E(PSONAM,1,6)
"RTN","PSOCPBK4",156,0)
 S ^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOREF)=PSOREL
"RTN","PSOCPBK4",157,0)
 Q
"RTN","PSOCPBK4",158,0)
 ;
"RTN","PSOCPBK4",159,0)
SITE ; SET UP VARIABLES NEEDED BY BILLING
"RTN","PSOCPBK4",160,0)
 S PSOSITE=$S(YY=0:$P(^PSRX(RXP,2),"^",9),1:$P($G(^PSRX(RXP,1,YY,0)),"^",9))
"RTN","PSOCPBK4",161,0)
 Q:PSOSITE=""
"RTN","PSOCPBK4",162,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSOCPBK4",163,0)
 S PSOSITE7=$P($G(^PS(59,PSOSITE,"IB")),"^")
"RTN","PSOCPBK4",164,0)
 Q
"RTN","PSOCPBK4",165,0)
 ;
"RTN","PSOCPBK4",166,0)
RPT ;
"RTN","PSOCPBK4",167,0)
 N JOBN,NAMSP,ZTDESC,ZTRTN
"RTN","PSOCPBK4",168,0)
 S NAMSP=$$NAMSP^PSOCPBK3
"RTN","PSOCPBK4",169,0)
 S JOBN=$S(^XTMP(NAMSP,0)["BACK":"Back Billing",1:"Tally")
"RTN","PSOCPBK4",170,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCPBK4",171,0)
 .W !,JOBN_" job for PSO*7*217 is still running.  Halting..."
"RTN","PSOCPBK4",172,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK4",173,0)
 W !!,"This report shows the patient name and prescription information for refills"
"RTN","PSOCPBK4",174,0)
 W:JOBN["Tally" !,"that were identified as billable by the patch PSO*7*217"
"RTN","PSOCPBK4",175,0)
 W:JOBN["Back" !,"that were back-billed by the patch PSO*7*217"
"RTN","PSOCPBK4",176,0)
 W !!,"You may queue the report to print, if you wish.",!
"RTN","PSOCPBK4",177,0)
 ;
"RTN","PSOCPBK4",178,0)
DVC K %ZIS,POP,IOP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! G DONE
"RTN","PSOCPBK4",179,0)
QUEUE I $D(IO("Q")) S ZTRTN="START^PSOCPBK4",ZTDESC=JOBN_" copay report" D ^%ZTLOAD K %ZSI W !,"Report queued to print.",! G DONE
"RTN","PSOCPBK4",180,0)
START ;
"RTN","PSOCPBK4",181,0)
 U IO
"RTN","PSOCPBK4",182,0)
 N BLDT,RXO,NAMSP,PSOFILL,PSODFN,PSONAM,PSOOUT,PSODV,RXP,SSN,PSODIV
"RTN","PSOCPBK4",183,0)
 N JOBN,PSOPATID
"RTN","PSOCPBK4",184,0)
 S NAMSP=$$NAMSP^PSOCPBK3
"RTN","PSOCPBK4",185,0)
 S JOBN=$S(^XTMP(NAMSP,0)["BACK":"Back Billing",1:"Tally")
"RTN","PSOCPBK4",186,0)
 S PSOOUT=0,PSODV=$S($E(IOST)="C":"C",1:"P")
"RTN","PSOCPBK4",187,0)
 S PSOPGCT=0,PSOPGLN=IOSL-7,PSOPGCT=1
"RTN","PSOCPBK4",188,0)
 S BLDT=$P($G(^XTMP(NAMSP,0,"LAST")),"^",2)
"RTN","PSOCPBK4",189,0)
 D TITLE
"RTN","PSOCPBK4",190,0)
 S PSONAM=""
"RTN","PSOCPBK4",191,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"BILLED",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCPBK4",192,0)
 .S PSODFN=""
"RTN","PSOCPBK4",193,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCPBK4",194,0)
 ..S RXP=""
"RTN","PSOCPBK4",195,0)
 ..F  S RXP=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP)) Q:RXP=""  D
"RTN","PSOCPBK4",196,0)
 ...S PSOFILL=""
"RTN","PSOCPBK4",197,0)
 ...F  S PSOFILL=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSOCPBK4",198,0)
 ....N XX,RXO,Y,PSONAME
"RTN","PSOCPBK4",199,0)
 ....S XX=$G(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOFILL)) D
"RTN","PSOCPBK4",200,0)
 .....D FULL Q:$G(PSOOUT)  S PSONAME=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCPBK4",201,0)
 .....W !,$E(PSONAME,1,14)
"RTN","PSOCPBK4",202,0)
 .....D PRTSSN
"RTN","PSOCPBK4",203,0)
 .....S RXO=$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOCPBK4",204,0)
 .....W ?42," ",RXO," (",PSOFILL,")"
"RTN","PSOCPBK4",205,0)
 .....S Y=XX I Y>0 X ^DD("DD")
"RTN","PSOCPBK4",206,0)
 .....W ?55," ",Y
"RTN","PSOCPBK4",207,0)
 .....W ?69,$S($$PTCOV^IBCNSU3(PSODFN,XX,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCPBK4",208,0)
 .....W ?75,$S($$PTCOV^IBCNSU3(PSODFN,BLDT,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCPBK4",209,0)
 G END
"RTN","PSOCPBK4",210,0)
 ;
"RTN","PSOCPBK4",211,0)
FULL ;
"RTN","PSOCPBK4",212,0)
 I ($Y+7)>IOSL&('$G(PSOOUT)) D TITLE
"RTN","PSOCPBK4",213,0)
 Q
"RTN","PSOCPBK4",214,0)
 ;
"RTN","PSOCPBK4",215,0)
TITLE ;
"RTN","PSOCPBK4",216,0)
 I $G(PSODV)="C",$G(PSOPGCT)'=1 W ! K DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSOOUT=1 Q
"RTN","PSOCPBK4",217,0)
 ;
"RTN","PSOCPBK4",218,0)
 W @IOF D
"RTN","PSOCPBK4",219,0)
 . W !,"Patch PSO*7*217 -COPAY PRESCRIPTION REFILLS "_JOBN
"RTN","PSOCPBK4",220,0)
 S Y=DT X ^DD("DD") W !,"Date printed: ",Y,?70,"Page: ",PSOPGCT,!
"RTN","PSOCPBK4",221,0)
 F MJT=1:1:79 W "="
"RTN","PSOCPBK4",222,0)
 W !,?69,"INS ON DTE"
"RTN","PSOCPBK4",223,0)
 W !,"PATIENT NAME     (SSN)       DIV",?43,"RX# (FILL)",?55,"RELEASE DATE",?69,"REL   BILL"
"RTN","PSOCPBK4",224,0)
 W !,"--------------  -------  ----------------",?42,"------------"
"RTN","PSOCPBK4",225,0)
 W ?55,"------------",?69,"---- -----"
"RTN","PSOCPBK4",226,0)
 S PSOPGCT=PSOPGCT+1
"RTN","PSOCPBK4",227,0)
 Q
"RTN","PSOCPBK4",228,0)
END ;
"RTN","PSOCPBK4",229,0)
 I '$G(PSOOUT),$G(PSODV)="C" W !!,"** End of Report **" K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOCPBK4",230,0)
 I $G(PSODV)="C" W !
"RTN","PSOCPBK4",231,0)
 E  W @IOF
"RTN","PSOCPBK4",232,0)
DONE ;
"RTN","PSOCPBK4",233,0)
 K MJT,PSOPGCT,PSOPGLN,Y,DIR,X,IOP,POP,IO("Q"),DIRUT,DUOUT,DTOUT
"RTN","PSOCPBK4",234,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK4",235,0)
 Q
"RTN","PSOCPBK4",236,0)
 ;
"RTN","PSOCPBK4",237,0)
PRTSSN ;
"RTN","PSOCPBK4",238,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9),SSN=$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","PSOCPBK4",239,0)
 S PSOPATID=$E(PSONAM,1)_SSN
"RTN","PSOCPBK4",240,0)
 S PSODIV=$P($G(^PSRX(RXP,2)),"^",9)
"RTN","PSOCPBK4",241,0)
 S:PSODIV'="" PSODIV=$P($G(^PS(59,PSODIV,0)),"^",1)
"RTN","PSOCPBK4",242,0)
 W ?16,"("_PSOPATID_")"_"  "_PSODIV
"RTN","PSOCPBK4",243,0)
 Q
"RTN","PSOCPBK4",244,0)
 ;
"RTN","PSOCPBK4",245,0)
ETIME(SECTIME) ;convert seconds to day:hr:min:sec
"RTN","PSOCPBK4",246,0)
 N DAY,HR,MIN,SEC,ETIM
"RTN","PSOCPBK4",247,0)
 S (DAY,HR,MIN,SEC)=""
"RTN","PSOCPBK4",248,0)
 I SECTIME>86400 S DAY=SECTIME\86400,SECTIME=SECTIME#86400
"RTN","PSOCPBK4",249,0)
 I SECTIME>3600 S HR=SECTIME\3600,SECTIME=SECTIME#3600
"RTN","PSOCPBK4",250,0)
 I SECTIME>60 S MIN=SECTIME\60,SECTIME=SECTIME#60
"RTN","PSOCPBK4",251,0)
 S SEC=SECTIME
"RTN","PSOCPBK4",252,0)
 S ETIM=""
"RTN","PSOCPBK4",253,0)
 S:$L(HR)=1 HR=0_HR S:$L(MIN)=1 MIN=0_MIN S:$L(SEC)=1 SEC=0_SEC
"RTN","PSOCPBK4",254,0)
 S:DAY ETIM=DAY_" Day " S:HR ETIM=ETIM_HR_":" S:MIN ETIM=ETIM_MIN
"RTN","PSOCPBK4",255,0)
 S ETIM=ETIM_":"_SEC
"RTN","PSOCPBK4",256,0)
 Q ETIM
"RTN","PSOCPBK5")
0^3^B31112048
"RTN","PSOCPBK5",1,0)
PSOCPBK5 ;BIR/GN-Back Billing Automated-release refill copay cont. ;10/11/05 1:56pm
"RTN","PSOCPBK5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**217**;DEC 1997
"RTN","PSOCPBK5",3,0)
 ;
"RTN","PSOCPBK5",4,0)
MAIL ;user mail message
"RTN","PSOCPBK5",5,0)
 N TOTAMT,PSOCXPDA
"RTN","PSOCPBK5",6,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBK5",7,0)
 S PSOEND2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBK5",8,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCPBK5",9,0)
 S XMDUZ="PSO*7*217 "_JOBN
"RTN","PSOCPBK5",10,0)
 S XMSUB="Outpatient Pharmacy Copay "_JOBN
"RTN","PSOCPBK5",11,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPBK5",12,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCPBK5",13,0)
 S PSOTEXT(1)="The Rx copay "_JOBN_" job for the Outpatient Pharmacy patch (PSO*7*217)"
"RTN","PSOCPBK5",14,0)
 S PSOTEXT(2)="started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSOCPBK5",15,0)
 I PSOCNT=0 S PSOTEXT(3)="No released unbilled copay fills were found."
"RTN","PSOCPBK5",16,0)
 I PSOCNT>0 D
"RTN","PSOCPBK5",17,0)
 . S TOTAMT=0
"RTN","PSOCPBK5",18,0)
 . F XX="YR2004","YR2005" D
"RTN","PSOCPBK5",19,0)
 .. F YY=1:1:3 S PSOAMT(XX,YY)=PSOCNT(XX,YY)*YY*7,TOTAMT=TOTAMT+PSOAMT(XX,YY)
"RTN","PSOCPBK5",20,0)
 . S PSOTEXT(3)="Auto-Released refills have now been Billed"
"RTN","PSOCPBK5",21,0)
 . S PSOTEXT(4)="There were "_$FN(PSOCNT,",")_" fills successfully Billed for "_$FN(PSOVETS,",")_" veterans."
"RTN","PSOCPBK5",22,0)
 . S PSOTEXT(5)=" "
"RTN","PSOCPBK5",23,0)
 . S PSOTEXT(6)="Fills back-billing by year:"
"RTN","PSOCPBK5",24,0)
 . S PSOTEXT(7)="2004  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",1),6)
"RTN","PSOCPBK5",25,0)
 . S PSOTEXT(7)=PSOTEXT(7)_"     $"_$J($FN(PSOAMT("YR2004",1),","),9)
"RTN","PSOCPBK5",26,0)
 . S PSOTEXT(8)="2004  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",2),6)
"RTN","PSOCPBK5",27,0)
 . S PSOTEXT(8)=PSOTEXT(8)_"     $"_$J($FN(PSOAMT("YR2004",2),","),9)
"RTN","PSOCPBK5",28,0)
 . S PSOTEXT(9)="2004  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",3),6)
"RTN","PSOCPBK5",29,0)
 . S PSOTEXT(9)=PSOTEXT(9)_"     $"_$J($FN(PSOAMT("YR2004",3),","),9)
"RTN","PSOCPBK5",30,0)
 . S PSOTEXT(10)=""
"RTN","PSOCPBK5",31,0)
 . S PSOTEXT(11)="2005  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",1),6)
"RTN","PSOCPBK5",32,0)
 . S PSOTEXT(11)=PSOTEXT(11)_"     $"_$J($FN(PSOAMT("YR2005",1),","),9)
"RTN","PSOCPBK5",33,0)
 . S PSOTEXT(12)="2005  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",2),6)
"RTN","PSOCPBK5",34,0)
 . S PSOTEXT(12)=PSOTEXT(12)_"     $"_$J($FN(PSOAMT("YR2005",2),","),9)
"RTN","PSOCPBK5",35,0)
 . S PSOTEXT(13)="2005  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",3),6)
"RTN","PSOCPBK5",36,0)
 . S PSOTEXT(13)=PSOTEXT(13)_"     $"_$J($FN(PSOAMT("YR2005",3),","),9)
"RTN","PSOCPBK5",37,0)
 . S PSOTEXT(14)="                                          =========="
"RTN","PSOCPBK5",38,0)
 . S PSOTEXT(15)="                                    TOTAL $"_$J($FN(TOTAMT,","),9)
"RTN","PSOCPBK5",39,0)
 . S PSOTEXT(16)=" "
"RTN","PSOCPBK5",40,0)
 . S PSOTEXT(17)="To get a report of patients/prescriptions that were billed"
"RTN","PSOCPBK5",41,0)
 . S PSOTEXT(18)="as part of this Back Billing, enter D RPT^PSOCPBK4 at the programmer's prompt"
"RTN","PSOCPBK5",42,0)
 ;
"RTN","PSOCPBK5",43,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK5",44,0)
 Q
"RTN","PSOCPBK5",45,0)
 ;
"RTN","PSOCPBK5",46,0)
MAIL2 ;management mail message
"RTN","PSOCPBK5",47,0)
 N J
"RTN","PSOCPBK5",48,0)
 S LIN="",$P(LIN," ",80)=""
"RTN","PSOCPBK5",49,0)
 D NOW^%DTC S PSOTIME=$$FMDIFF^XLFDT(%,$G(PSOS1),2)
"RTN","PSOCPBK5",50,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBK5",51,0)
 S PSOSTNM=$P($G(^DIC(4,PSOINST,0)),"^")
"RTN","PSOCPBK5",52,0)
 K PSOTEXT
"RTN","PSOCPBK5",53,0)
 S XMY(DUZ)="",PSOTC=0,PSOCNTS=""
"RTN","PSOCPBK5",54,0)
 F J="YR2004","YR2005" F I=1:1:3 D
"RTN","PSOCPBK5",55,0)
 .S PSOTC=PSOTC+PSOCNT(J,I)
"RTN","PSOCPBK5",56,0)
 .S PSOCNTS=PSOCNTS_","_PSOCNT(J,I)
"RTN","PSOCPBK5",57,0)
 S XMY("NAPOLIELLO.GREG@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",58,0)
 S:$$PROD^XUPROD(1) XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",59,0)
 S:$$PROD^XUPROD(1) XMY("WILLIAMSON.ERIC@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",60,0)
 S XMDUZ="PSO*7*217 "_JOBN
"RTN","PSOCPBK5",61,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCPBK5",62,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSOCPBK5",63,0)
 S XMSUB=XMSUB_" BACK BILLED COPAYS FOR PRESCRIPTION REFILLS"
"RTN","PSOCPBK5",64,0)
 S PSOTEXT(1)="               Start time: "_PSOSTRT2
"RTN","PSOCPBK5",65,0)
 S PSOTEXT(2)="           Completed time: "_PSOEND2
"RTN","PSOCPBK5",66,0)
 S PSOTEXT(3)="             Elapsed Time: "_$$ETIME^PSOCPBK4(PSOTIME)
"RTN","PSOCPBK5",67,0)
 S PSOTEXT(4)=""
"RTN","PSOCPBK5",68,0)
 S PSOTEXT(5)="     Total RX's processed: "_$J($FN(PSOTRX,","),8)
"RTN","PSOCPBK5",69,0)
 S PSOTEXT(6)="  Total Refills processed: "_$J($FN(PSOTRF,","),8)
"RTN","PSOCPBK5",70,0)
 S PSOTEXT(7)="   Total billable refills: "_$J($FN(PSOTC,","),8)
"RTN","PSOCPBK5",71,0)
 S PSOTEXT(8)="      Total billable vets: "_$J($FN(PSOVETS,","),8)
"RTN","PSOCPBK5",72,0)
 S PSOTEXT(9)=""
"RTN","PSOCPBK5",73,0)
 S PSOTEXT(10)=""
"RTN","PSOCPBK5",74,0)
 S PSOTEXT(11)="Excel comma delimited data below, Two heading, one data line"
"RTN","PSOCPBK5",75,0)
 S PSOTEXT(12)=""
"RTN","PSOCPBK5",76,0)
 S PSOTEXT(13)=$E(("Station,Station,,2004,,,2005"_LIN),1,79)
"RTN","PSOCPBK5",77,0)
 S PSOTEXT(14)=$E(("Name,#,30 days,60 days,90 days,30 days,60 days,90 days"_LIN),1,79)
"RTN","PSOCPBK5",78,0)
 S PSOTEXT(15)=$E((PSOSTNM_","_PSOINST_PSOCNTS_LIN),1,79)
"RTN","PSOCPBK5",79,0)
 S PSOTEXT(16)=""
"RTN","PSOCPBK5",80,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK5",81,0)
 Q
"RTN","PSOCPBK5",82,0)
 ;
"RTN","PSOCPBK5",83,0)
MAIL3(MSG) ;management mail message
"RTN","PSOCPBK5",84,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBK5",85,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBK5",86,0)
 K PSOTEXT
"RTN","PSOCPBK5",87,0)
 S XMY(DUZ)=""
"RTN","PSOCPBK5",88,0)
 S XMY("NAPOLIELLO.GREG@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",89,0)
 S:$$PROD^XUPROD(1) XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",90,0)
 S:$$PROD^XUPROD(1) XMY("WILLIAMSON.ERIC@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",91,0)
 S XMDUZ="PSO*7*217 "_JOBN
"RTN","PSOCPBK5",92,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCPBK5",93,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSOCPBK5",94,0)
 S XMSUB=XMSUB_" BACK BILLED COPAYS FOR PRESCRIPTION REFILLS"
"RTN","PSOCPBK5",95,0)
 S PSOTEXT(1)=""
"RTN","PSOCPBK5",96,0)
 S PSOTEXT(2)="Started "_PSOSTART
"RTN","PSOCPBK5",97,0)
 S PSOTEXT(3)=""
"RTN","PSOCPBK5",98,0)
 S PSOTEXT(4)="   "_MSG
"RTN","PSOCPBK5",99,0)
 S PSOTEXT(5)=""
"RTN","PSOCPBK5",100,0)
 S PSOTEXT(6)="NO FURTHER ACTION REQUIRED."
"RTN","PSOCPBK5",101,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK5",102,0)
 Q
"RTN","PSOCPBK5",103,0)
 ;
"RTN","PSOCPBK5",104,0)
MAILAAC ;send name info to AAC for mail stuffers
"RTN","PSOCPBK5",105,0)
 N VA
"RTN","PSOCPBK5",106,0)
 K XMY,^TMP(NAMSP)
"RTN","PSOCPBK5",107,0)
 S PSOCNT=0
"RTN","PSOCPBK5",108,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBK5",109,0)
 S XMY(DUZ)=""
"RTN","PSOCPBK5",110,0)
 S XMY("NAPOLIELLO.GREG@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",111,0)
 S:$$PROD^XUPROD(1) XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",112,0)
 S:$$PROD^XUPROD(1) XMY("WILLIAMSON.ERIC@FORUM.VA.GOV")=""
"RTN","PSOCPBK5",113,0)
 S XMDUZ="PSO*7*217 "_JOBN
"RTN","PSOCPBK5",114,0)
 S XMSUB=$G(PSOINST)_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSOCPBK5",115,0)
 S XMSUB=XMSUB_" - BACK BILLED COPAYS AAC DATA"
"RTN","PSOCPBK5",116,0)
 S PSONAM=""
"RTN","PSOCPBK5",117,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"BILLED",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCPBK5",118,0)
 .S PSODFN=""
"RTN","PSOCPBK5",119,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCPBK5",120,0)
 ..N DFN S DFN=PSODFN D DEM^VADPT
"RTN","PSOCPBK5",121,0)
 ..S PSOCNT=PSOCNT+1,^TMP(NAMSP,PSOCNT)=PSOINST_"^"_$G(VA("BID"))_$E($P(PSONAM,","),1,5)
"RTN","PSOCPBK5",122,0)
 I '$D(^TMP(NAMSP)) S ^TMP(NAMSP,1)="NO BILLED FILLS FOR INSTITUTION: "_PSOINST
"RTN","PSOCPBK5",123,0)
 S XMTEXT="^TMP(NAMSP," N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK5",124,0)
 K ^TMP(NAMSP)
"RTN","PSOCPBK5",125,0)
 Q
"VER")
8.0^22.0
"BLD",6374,6)
^SEQ #191
**END**
**END**
