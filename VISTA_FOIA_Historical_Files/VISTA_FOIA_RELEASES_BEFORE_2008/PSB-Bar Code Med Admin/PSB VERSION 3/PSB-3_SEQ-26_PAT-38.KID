Released PSB*3*38 SEQ #26
Extracted from mail message
**KIDS**:PSB*3.0*38^

**INSTALL NAME**
PSB*3.0*38
"BLD",6326,0)
PSB*3.0*38^BAR CODE MED ADMIN^0^3070621^y
"BLD",6326,1,0)
^^1^1^3070604^^
"BLD",6326,1,1,0)
Med Route display issues
"BLD",6326,4,0)
^9.64PA^^
"BLD",6326,6)
6^
"BLD",6326,6.3)
8
"BLD",6326,"KRN",0)
^9.67PA^8989.52^19
"BLD",6326,"KRN",.4,0)
.4
"BLD",6326,"KRN",.4,"NM",0)
^9.68A^^
"BLD",6326,"KRN",.401,0)
.401
"BLD",6326,"KRN",.402,0)
.402
"BLD",6326,"KRN",.403,0)
.403
"BLD",6326,"KRN",.5,0)
.5
"BLD",6326,"KRN",.84,0)
.84
"BLD",6326,"KRN",3.6,0)
3.6
"BLD",6326,"KRN",3.8,0)
3.8
"BLD",6326,"KRN",9.2,0)
9.2
"BLD",6326,"KRN",9.8,0)
9.8
"BLD",6326,"KRN",9.8,"NM",0)
^9.68A^14^14
"BLD",6326,"KRN",9.8,"NM",1,0)
PSBVDLPA^^0^B13072762
"BLD",6326,"KRN",9.8,"NM",2,0)
PSBVT^^0^B77039096
"BLD",6326,"KRN",9.8,"NM",3,0)
PSBCSUTL^^0^B81733971
"BLD",6326,"KRN",9.8,"NM",4,0)
PSBODO^^0^B9968689
"BLD",6326,"KRN",9.8,"NM",5,0)
PSBVDLIV^^0^B63842623
"BLD",6326,"KRN",9.8,"NM",6,0)
PSBVDLPB^^0^B83184850
"BLD",6326,"KRN",9.8,"NM",7,0)
PSBVDLUD^^0^B75040119
"BLD",6326,"KRN",9.8,"NM",8,0)
PSBUTL^^0^B82318781
"BLD",6326,"KRN",9.8,"NM",9,0)
PSBOMH^^0^B79507789
"BLD",6326,"KRN",9.8,"NM",10,0)
PSBOMH1^^0^B71636432
"BLD",6326,"KRN",9.8,"NM",11,0)
PSBODL^^0^B83477494
"BLD",6326,"KRN",9.8,"NM",12,0)
PSBMLLKU^^0^B66069590
"BLD",6326,"KRN",9.8,"NM",13,0)
PSBCSUTX^^0^B78303576
"BLD",6326,"KRN",9.8,"NM",14,0)
PSBVDLU3^^0^B39144184
"BLD",6326,"KRN",9.8,"NM","B","PSBCSUTL",3)

"BLD",6326,"KRN",9.8,"NM","B","PSBCSUTX",13)

"BLD",6326,"KRN",9.8,"NM","B","PSBMLLKU",12)

"BLD",6326,"KRN",9.8,"NM","B","PSBODL",11)

"BLD",6326,"KRN",9.8,"NM","B","PSBODO",4)

"BLD",6326,"KRN",9.8,"NM","B","PSBOMH",9)

"BLD",6326,"KRN",9.8,"NM","B","PSBOMH1",10)

"BLD",6326,"KRN",9.8,"NM","B","PSBUTL",8)

"BLD",6326,"KRN",9.8,"NM","B","PSBVDLIV",5)

"BLD",6326,"KRN",9.8,"NM","B","PSBVDLPA",1)

"BLD",6326,"KRN",9.8,"NM","B","PSBVDLPB",6)

"BLD",6326,"KRN",9.8,"NM","B","PSBVDLU3",14)

"BLD",6326,"KRN",9.8,"NM","B","PSBVDLUD",7)

"BLD",6326,"KRN",9.8,"NM","B","PSBVT",2)

"BLD",6326,"KRN",19,0)
19
"BLD",6326,"KRN",19,"NM",0)
^9.68A^^
"BLD",6326,"KRN",19.1,0)
19.1
"BLD",6326,"KRN",101,0)
101
"BLD",6326,"KRN",409.61,0)
409.61
"BLD",6326,"KRN",771,0)
771
"BLD",6326,"KRN",870,0)
870
"BLD",6326,"KRN",8989.51,0)
8989.51
"BLD",6326,"KRN",8989.52,0)
8989.52
"BLD",6326,"KRN",8994,0)
8994
"BLD",6326,"KRN","B",.4,.4)

"BLD",6326,"KRN","B",.401,.401)

"BLD",6326,"KRN","B",.402,.402)

"BLD",6326,"KRN","B",.403,.403)

"BLD",6326,"KRN","B",.5,.5)

"BLD",6326,"KRN","B",.84,.84)

"BLD",6326,"KRN","B",3.6,3.6)

"BLD",6326,"KRN","B",3.8,3.8)

"BLD",6326,"KRN","B",9.2,9.2)

"BLD",6326,"KRN","B",9.8,9.8)

"BLD",6326,"KRN","B",19,19)

"BLD",6326,"KRN","B",19.1,19.1)

"BLD",6326,"KRN","B",101,101)

"BLD",6326,"KRN","B",409.61,409.61)

"BLD",6326,"KRN","B",771,771)

"BLD",6326,"KRN","B",870,870)

"BLD",6326,"KRN","B",8989.51,8989.51)

"BLD",6326,"KRN","B",8989.52,8989.52)

"BLD",6326,"KRN","B",8994,8994)

"BLD",6326,"QUES",0)
^9.62^^
"BLD",6326,"REQB",0)
^9.611^5^5
"BLD",6326,"REQB",1,0)
PSS*1.0*88^2
"BLD",6326,"REQB",2,0)
PSJ*5.0*159^2
"BLD",6326,"REQB",3,0)
PSB*3.0*13^2
"BLD",6326,"REQB",4,0)
PSB*3.0*24^2
"BLD",6326,"REQB",5,0)
PSB*3.0*26^2
"BLD",6326,"REQB","B","PSB*3.0*13",3)

"BLD",6326,"REQB","B","PSB*3.0*24",4)

"BLD",6326,"REQB","B","PSB*3.0*26",5)

"BLD",6326,"REQB","B","PSJ*5.0*159",2)

"BLD",6326,"REQB","B","PSS*1.0*88",1)

"MBREQ")
0
"PKG",536,-1)
1^1
"PKG",536,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",536,20,0)
^9.402P^^
"PKG",536,22,0)
^9.49I^1^1
"PKG",536,22,1,0)
3.0^3040224^3040819^11874
"PKG",536,22,1,"PAH",1,0)
38^3070621^10000000075
"PKG",536,22,1,"PAH",1,1,0)
^^1^1^3070621
"PKG",536,22,1,"PAH",1,1,1,0)
Med Route display issues
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","PSBCSUTL")
0^3^B81733971^B82253654
"RTN","PSBCSUTL",1,0)
PSBCSUTL ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES ;Mar 2004
"RTN","PSBCSUTL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,13,38**;Mar 2004;Build 8
"RTN","PSBCSUTL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBCSUTL",4,0)
 ;
"RTN","PSBCSUTL",5,0)
 ; Reference/IA
"RTN","PSBCSUTL",6,0)
 ;
"RTN","PSBCSUTL",7,0)
 ; EN^PSJBCMA/2828
"RTN","PSBCSUTL",8,0)
 ; IN5^VADPT/10061
"RTN","PSBCSUTL",9,0)
 ; $$GET^XPAR/2263
"RTN","PSBCSUTL",10,0)
 ; ^%DTC/10000
"RTN","PSBCSUTL",11,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBCSUTL",12,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTL",13,0)
 ;
"RTN","PSBCSUTL",14,0)
RPC(RESULTS,DFN) ;
"RTN","PSBCSUTL",15,0)
 K RESULTS,^TMP("PSB",$J),^TMP("PSJ",$J)
"RTN","PSBCSUTL",16,0)
 S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",17,0)
 N PSBCNT S PSBTRFL=0,PSBDFNX=DFN
"RTN","PSBCSUTL",18,0)
 S RESULTS=$NAME(^TMP("PSB",$J,PSBTAB))
"RTN","PSBCSUTL",19,0)
 K ^TMP("PSB",$J,PSBTAB) S ^TMP("PSB",$J,PSBTAB,0)=1 D LIGHTS(PSBDFNX)
"RTN","PSBCSUTL",20,0)
 S ^TMP("PSB",$J,PSBTAB,0)=1,^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,PSBTAB,1)
"RTN","PSBCSUTL",21,0)
 Q:$P(^TMP("PSB",$J,PSBTAB,1),U,4)=-1
"RTN","PSBCSUTL",22,0)
 D NOW^%DTC S PSBNOW=+$E(%,1,10),PSBDT=$P(%,".",1)
"RTN","PSBCSUTL",23,0)
 ;set range
"RTN","PSBCSUTL",24,0)
 S PSBWBEG=$$FMADD^XLFDT(PSBNOW,"",-24),PSBWEND=$$FMADD^XLFDT(PSBNOW,"",24)
"RTN","PSBCSUTL",25,0)
 S PSBTBEG=$$FMADD^XLFDT(PSBNOW,"",-12),PSBTEND=$$FMADD^XLFDT(PSBNOW,"",12)
"RTN","PSBCSUTL",26,0)
 S PSBWADM=$$GET^XPAR("DIV","PSB ADMIN BEFORE"),PSBMHBCK=$$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B") I +PSBMHBCK=0 S PSBMHBCK=30
"RTN","PSBCSUTL",27,0)
 D NOW^%DTC S PSBWADM=$$FMADD^XLFDT(%,"","",+PSBWADM),PSBMHBCK=$$FMADD^XLFDT(%,-1*(PSBMHBCK))
"RTN","PSBCSUTL",28,0)
 ;use lst movemnt for API
"RTN","PSBCSUTL",29,0)
 S VAIP("D")="LAST" D IN5^VADPT S PSBTRDT=+VAIP(3),PSBTRTYP=$P(VAIP(2),U,2),PSBMVTYP=$P(VAIP(4),U,2) K VAIP
"RTN","PSBCSUTL",30,0)
 S PSBPTTR=$$GET^XPAR("DIV","PSB PATIENT TRANSFER") I PSBPTTR="" S PSBPTTR=72
"RTN","PSBCSUTL",31,0)
 D NOW^%DTC S PSBNTDT=$$FMADD^XLFDT(%,"",-PSBPTTR) I PSBNTDT'>PSBTRDT S PSBTRFL=1
"RTN","PSBCSUTL",32,0)
 S X1=$P(PSBNOW,"."),X2=-3 D C^%DTC
"RTN","PSBCSUTL",33,0)
 D EN^PSJBCMA(PSBDFNX,X,PSBMHBCK)
"RTN","PSBCSUTL",34,0)
 ;Devlop Outp
"RTN","PSBCSUTL",35,0)
 S PSBTBOUT=0
"RTN","PSBCSUTL",36,0)
 I ^TMP("PSJ",$J,1,0)>0 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBCSUTL",37,0)
 .S:(PSBTAB'="CVRSHT")&($G(^TMP("PSB",$J,"CVRSHT",2))>0) PSBTBOUT=1
"RTN","PSBCSUTL",38,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX),NOW^%DTC
"RTN","PSBCSUTL",39,0)
 .Q:PSBONX["P"  Q:(PSBOSP<PSBWBEG)&'(PSBONX["V")  ;in rnge?
"RTN","PSBCSUTL",40,0)
 .S (PSBREC,PSBONTAB)=""
"RTN","PSBCSUTL",41,0)
 .S $P(PSBREC,U,1)=PSBDFN ;Dfn
"RTN","PSBCSUTL",42,0)
 .S $P(PSBREC,U,2)=PSBONX ;Ordr 
"RTN","PSBCSUTL",43,0)
 .S $P(PSBREC,U,3)=PSBON ;OrdrIen
"RTN","PSBCSUTL",44,0)
 .S $P(PSBREC,U,4)=PSBOTYP ;iv/ud/pend
"RTN","PSBCSUTL",45,0)
 .S $P(PSBREC,U,5)=PSBSCHT ;Schdtype
"RTN","PSBCSUTL",46,0)
 .S $P(PSBREC,U,6)=PSBSCH ;Schd
"RTN","PSBCSUTL",47,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; selfmed
"RTN","PSBCSUTL",48,0)
 .S $P(PSBREC,U,8)=PSBOITX ;Drgname
"RTN","PSBCSUTL",49,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ;Dose
"RTN","PSBCSUTL",50,0)
 .S $P(PSBREC,U,10)=PSBMR ;med route
"RTN","PSBCSUTL",51,0)
 .;Lst Gvn - AOIP xRef
"RTN","PSBCSUTL",52,0)
 .S (PSBCNT,PSBFLAG)=0,(Y,PSBSTUS)="" K PSBHSTA,PSBHSTAX
"RTN","PSBCSUTL",53,0)
 .F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",54,0)
 ..S:Y>0 $P(PSBREC,U,11)=Y
"RTN","PSBCSUTL",55,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",56,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9) S:$G(PSBSTUS)="" PSBSTUS="X" I (PSBSTUS'="N") S PSBFLAG=1,PSBHSTA(Y,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBCSUTL",57,0)
 ...D:PSBSTUS="N"
"RTN","PSBCSUTL",58,0)
 ....S ($P(PSBREC,U,11),Z)=""
"RTN","PSBCSUTL",59,0)
 ....F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",60,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",61,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",62,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBCSUTL",63,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBCSUTL",64,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBCSUTL",65,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBCSUTL",66,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBCSUTL",67,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBCSUTL",68,0)
 .S $P(PSBREC,U,12)="" ;ien - below
"RTN","PSBCSUTL",69,0)
 .S $P(PSBREC,U,13)="" ;sttus - below
"RTN","PSBCSUTL",70,0)
 .S $P(PSBREC,U,14)="" ;admn dte - below
"RTN","PSBCSUTL",71,0)
 .S $P(PSBREC,U,15)=PSBOIT ;OI Pointer
"RTN","PSBCSUTL",72,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;Set injectable med route flag
"RTN","PSBCSUTL",73,0)
 .;Vari dosg
"RTN","PSBCSUTL",74,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBCSUTL",75,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBCSUTL",76,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ;DosgFrm
"RTN","PSBCSUTL",77,0)
 .D PSJ1^PSBVT(PSBDFN,PSBONX)
"RTN","PSBCSUTL",78,0)
 .S PSBPB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)),PSBLVIV=0
"RTN","PSBCSUTL",79,0)
 .Q:PSBPB&(PSBOSP<PSBWBEG)
"RTN","PSBCSUTL",80,0)
 .S:(PSBONX["V"&'PSBPB) PSBLVIV=1
"RTN","PSBCSUTL",81,0)
 .S $P(PSBREC,U,19)=$S(PSBVNI]"":PSBVNI,PSBVNI']"":"***") ;VerfNrsIntls
"RTN","PSBCSUTL",82,0)
 .S $P(PSBREC,U,20)=PSBSTUS S:$P(PSBREC,U,11)="" $P(PSBREC,U,20)=""  ;LstActnSts
"RTN","PSBCSUTL",83,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBCSUTL",84,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBCSUTL",85,0)
 .S $P(PSBREC,U,25)=0 I $G(PSBTRFL),$P(PSBREC,U,11)]"",$P(PSBREC,U,11)'<$G(PSBNTDT),$P(PSBREC,U,11)'>$G(PSBTRDT) S $P(PSBREC,U,25)=1
"RTN","PSBCSUTL",86,0)
 .S $P(PSBREC,U,26)=PSBOSP  ;OrdrStpDt/Tm
"RTN","PSBCSUTL",87,0)
 .S $P(PSBREC,U,27)=$$LASTG($P(PSBREC,U,1),$P(PSBREC,U,15))
"RTN","PSBCSUTL",88,0)
 .S $P(PSBREC,U,28)=$S((PSBONX["U")&('PSBPB):1,PSBPB:2,(PSBONX["V")&'PSBPB:3,1:"")
"RTN","PSBCSUTL",89,0)
 .;get all Admn(s) pr ordr
"RTN","PSBCSUTL",90,0)
 .;DD info.
"RTN","PSBCSUTL",91,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBCSUTL",92,0)
 .I PSBLVIV D XFERBAGS^PSBCSUTY,LVIV^PSBCSUTY I $G(PSBEXPRD) S X1=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,X1)'="END" ^TMP("PSB",$J,PSBTAB,X1+1)="END" Q
"RTN","PSBCSUTL",93,0)
 .D GETADMX^PSBCSUTY
"RTN","PSBCSUTL",94,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBCSUTL",95,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1  ;drug nactvted
"RTN","PSBCSUTL",96,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ;nactv
"RTN","PSBCSUTL",97,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBCSUTL",98,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4),$P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBCSUTL",99,0)
 .;OnCallOneTmPRN
"RTN","PSBCSUTL",100,0)
 .I ("^O^OC^P^"[(U_PSBSCHT_U))!(PSBLVIV) D  S ($P(PSBREC,U,12),$P(PSBREC,U,14))=""  Q
"RTN","PSBCSUTL",101,0)
 ..S (PSBIENX,PSBGOT1)="",PSBADMTM="" F  S PSBADMTM=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM)) Q:(PSBADMTM="")  D
"RTN","PSBCSUTL",102,0)
 ...Q:(PSBADMTM<PSBMHBCK)&'PSBLVIV
"RTN","PSBCSUTL",103,0)
 ...F  S PSBIENX=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM,PSBIENX)) Q:PSBIENX=""  D
"RTN","PSBCSUTL",104,0)
 ....S $P(PSBREC,U,12)=PSBIENX,$P(PSBREC,U,14)=PSBADMTM,$P(PSBREC,U,23)=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTL",105,0)
 ....S PSBQRR=1 D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBADMTM,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",106,0)
 ..I ('+PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",107,0)
 ..I ('+PSBGOT1)&($D(PSBADMX(PSBONX))) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTL",108,0)
 ..S PSBGLBX=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,PSBGLBX)'="END" ^TMP("PSB",$J,PSBTAB,PSBGLBX+1)="END"
"RTN","PSBCSUTL",109,0)
 .;continu - proces AdmnTm
"RTN","PSBCSUTL",110,0)
 .S (PSBYES,PSBODD,PSBYTF)=0 S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBCSUTL",111,0)
 .I PSBYES,PSBADST="" Q
"RTN","PSBCSUTL",112,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBCSUTL",113,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" Q
"RTN","PSBCSUTL",114,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBCSUTL",115,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBCSUTL",116,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBCSUTL",117,0)
 .S:PSBLVIV PSBYES=1
"RTN","PSBCSUTL",118,0)
 .I 'PSBYES,PSBFREQ<1 Q
"RTN","PSBCSUTL",119,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1(PSBTAB) Q
"RTN","PSBCSUTL",120,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBCSUTL",121,0)
 .I PSBODD,PSBADST'="" Q
"RTN","PSBCSUTL",122,0)
 .S PSBDTX=PSBWBEG\1,PSBGOT1=0
"RTN","PSBCSUTL",123,0)
 .F PSBXX=1:1:2 D  S PSBDTX=$$FMADD^XLFDT(PSBDTX,"",24)  ;incrmnt 1 day!
"RTN","PSBCSUTL",124,0)
 ..F PSBY=1:1:$L(PSBADST,"-") Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBCSUTL",125,0)
 ...S PSB=+(PSBDTX_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",126,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",127,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)      ;actv?
"RTN","PSBCSUTL",128,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",129,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",130,0)
 ...S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",131,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",132,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)      ;actv?
"RTN","PSBCSUTL",133,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",134,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",135,0)
 .I ('PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,+(PSBWEND\1_"."_$P(PSBADST,"-")),PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTL",136,0)
 .K PSBSTUS
"RTN","PSBCSUTL",137,0)
 D EN^PSBVDLPA
"RTN","PSBCSUTL",138,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S PSBI1=$O(^TMP("PSB",$J,PSBTAB,""),-1) I ^TMP("PSB",$J,PSBTAB,PSBI1)'="END" S ^TMP("PSB",$J,PSBTAB,PSBI1+1)="END"
"RTN","PSBCSUTL",139,0)
 S ^TMP("PSB",$J,PSBTAB,0)=$O(^TMP("PSB",$J,PSBTAB,""),-1)
"RTN","PSBCSUTL",140,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))']"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="-1^No orders To display on Coversheet"
"RTN","PSBCSUTL",141,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="1^COVERSHEET DATA FOLLOWS" D ADD^PSBCSUTX
"RTN","PSBCSUTL",142,0)
 D CLEAN
"RTN","PSBCSUTL",143,0)
 Q
"RTN","PSBCSUTL",144,0)
LASTG(PSBPATPT,PSBOIPT) ;LstGvn-(inpt: DFN,OrdrblItm IEN)
"RTN","PSBCSUTL",145,0)
 K PSBHSTG S Y="",LASTG="" F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",146,0)
 .S:Y>0 LASTG="",X="" F  S X=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",147,0)
 ..S PSBSTX=$P(^PSB(53.79,X,0),U,9) S:PSBSTX']"" PSBHSTG(Y)=-1 I PSBSTX="G"  S PSBHSTG(Y)=""
"RTN","PSBCSUTL",148,0)
 ..Q:PSBSTX="N"
"RTN","PSBCSUTL",149,0)
 ..D:(PSBSTX'="G")
"RTN","PSBCSUTL",150,0)
 ...S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",151,0)
 ....I (PSBDATA["Set to 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",152,0)
 ....I (PSBDATA["STATUS 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",153,0)
 ....I PSBCNT#2=0,PSBDATA'["'GIVEN'" Q
"RTN","PSBCSUTL",154,0)
 ....I '$D(PSBHSTG($P(PSBDATA,U))) S PSBFLAG=1,PSBHSTG($P(PSBDATA,U))=""
"RTN","PSBCSUTL",155,0)
 S:$D(PSBHSTG) LASTG="",LASTG=$O(PSBHSTG(LASTG),-1) I LASTG]"" I PSBHSTG(LASTG)=-1 S LASTG=""
"RTN","PSBCSUTL",156,0)
 Q LASTG
"RTN","PSBCSUTL",157,0)
LIGHTS(PSBDFN) ;
"RTN","PSBCSUTL",158,0)
 D RPC^PSBVDLTB(,PSBDFN,"NO TAB",) S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",159,0)
 M ^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,"NO TAB",1) K ^TMP("PSB",$J,"NO TAB")
"RTN","PSBCSUTL",160,0)
 Q
"RTN","PSBCSUTL",161,0)
CLEAN ;
"RTN","PSBCSUTL",162,0)
 D CLEAN^PSBVT
"RTN","PSBCSUTL",163,0)
 K PSBACT,PSBACTBY,PSBACTDT,PSBACTPT,PSBADDS,PSBBAGID,PSBCHDT,PSBCHKV,PSBCNT1,PSBCNT2,PSBDDS,PSBDFNX,PSBWEND
"RTN","PSBCSUTL",164,0)
 K PSBDT,PSBFLAG,PSBHSTAX,PSBI1,PSBIEN,PSBIENX,PSBLSTS,PSBMAUD,PSBMVTYP,PSBMWC,PSBNOW,PSBNTDT,PSBONMBR,PSBY,PSBXX
"RTN","PSBCSUTL",165,0)
 K PSBONXS,PSBORREC,PSBPDT,PSBPRNRE,PSBPTTR,PSBQR,PSBRDOW,PSBREC,PSBRECHD,PSBSCHBR,PSBSCHTM,PSBSOLS,PSBTAB,PSBADMTM,PSBDTX
"RTN","PSBCSUTL",166,0)
 K PSBTBOUT,PSBTRDT,PSBTRFL,PSBTRTYP,PSBUID,PSBUIDS,PSBX,PSBXIEN,PSBX2,PSBYEA,PSBYEA1,PSBYTF,PSBYES,VAIP,PSBWADM,PSBWBEG
"RTN","PSBCSUTL",167,0)
 K PSBXREC,PSBGOT1,PSBCDT,PSBQUIT,PSBUSED,PSBLST4X,PSBADMX,PSBI2,PSBXXX,PSBI,PSBPB,PSBSHWTB,PSBONTAB,PSBDONE,^TMP("PSJ",$J)
"RTN","PSBCSUTL",168,0)
 K PSBNXTDU,LASTG,LSTTIME,PSBMHBCK,PSBHSTG,PSBNXTDT,NEXTADM,PSBLVIV
"RTN","PSBCSUTL",169,0)
 Q
"RTN","PSBCSUTX")
0^13^B78303576^B78201826
"RTN","PSBCSUTX",1,0)
PSBCSUTX ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES 2 ;Mar 2004
"RTN","PSBCSUTX",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,13,38**;Mar 2004;Build 8
"RTN","PSBCSUTX",3,0)
 ;
"RTN","PSBCSUTX",4,0)
 ; Reference/IA
"RTN","PSBCSUTX",5,0)
 ; File 200/10060
"RTN","PSBCSUTX",6,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTX",7,0)
 ; $$SCH^XLFDT/10103
"RTN","PSBCSUTX",8,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBCSUTX",9,0)
 ;
"RTN","PSBCSUTX",10,0)
ADD ; output:  ORD-ORC-DD-ADD-SOL-ID-ADM-CMT-END segmnts
"RTN","PSBCSUTX",11,0)
 K PSBDONE S PSBRECHD="ORD",PSBDONE=0,PSBCNT1=^TMP("PSB",$J,PSBTAB,0),PSBCNT2=1,$P(^TMP("PSB",$J,"CVRSHT2",0),U)=0
"RTN","PSBCSUTX",12,0)
 F PSBI1=1:1:PSBCNT1 D  Q:PSBDONE
"RTN","PSBCSUTX",13,0)
 .I PSBCNT1'>1 S PSBDONE=1 Q
"RTN","PSBCSUTX",14,0)
 .I PSBI1=1 S ^TMP("PSB",$J,"CVRSHT2",PSBCNT2)=^TMP("PSB",$J,"CVRSHT",1) Q
"RTN","PSBCSUTX",15,0)
 .I ^TMP("PSB",$J,PSBTAB,PSBI1)="END" S PSBRECHD="ORD",PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="END"  Q
"RTN","PSBCSUTX",16,0)
 .I PSBRECHD="ORD" D ORD Q
"RTN","PSBCSUTX",17,0)
 .I PSBRECHD="ORC" D ORC Q
"RTN","PSBCSUTX",18,0)
 .I PSBRECHD="MED" D MED Q
"RTN","PSBCSUTX",19,0)
 S $P(^TMP("PSB",$J,"CVRSHT2",0),U)=PSBCNT2
"RTN","PSBCSUTX",20,0)
 M ^TMP("PSB",$J,PSBTAB)=^TMP("PSB",$J,"CVRSHT2") K PSBNXTDU D ADM
"RTN","PSBCSUTX",21,0)
 K ^TMP("PSB",$J,PSBTAB) M ^TMP("PSB",$J,PSBTAB)=^TMP("PSB",$J,"CVRSHT2") K ^TMP("PSB",$J,"CVRSHT2") D FINALPAS
"RTN","PSBCSUTX",22,0)
 K ^TMP("PSB",$J,PSBTAB) M ^TMP("PSB",$J,PSBTAB)=^TMP("PSB",$J,"CVRSHT2") K ^TMP("PSB",$J,"CVRSHT2")
"RTN","PSBCSUTX",23,0)
 Q
"RTN","PSBCSUTX",24,0)
ORD ; Ordr
"RTN","PSBCSUTX",25,0)
 S PSBCNT2=PSBCNT2+1,(PSBORREC,PSBXREC)=^TMP("PSB",$J,PSBTAB,PSBI1)
"RTN","PSBCSUTX",26,0)
 S ($P(PSBXREC,U,12),$P(PSBXREC,U,23),$P(PSBXREC,U,24),PSBSCHTM,PSBONMBR,PSBIENX,PSBBAGID,PSBACT,PSBACTBY,PSBACTDT,PSBACTPT,PSBPRNRE,PSBXX,PSBXXX)=""
"RTN","PSBCSUTX",27,0)
 S ^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORD",$P(^TMP("PSB",$J,"CVRSHT2",PSBCNT2),U,2)=PSBXREC
"RTN","PSBCSUTX",28,0)
 S PSBSCHTM=$P(PSBORREC,U,14),PSBONMBR=$P(PSBORREC,U,2),PSBIENX=$P(PSBORREC,U,12),PSBLRGIV=0
"RTN","PSBCSUTX",29,0)
 D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBONMBR) S:(PSBONMBR["V")&'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)) PSBLRGIV=1
"RTN","PSBCSUTX",30,0)
 I '$D(PSBLST4X(PSBONMBR)) S PSBXX="" F PSBI=1:1 S PSBXX=$O(PSBADMX(PSBONMBR,PSBXX),-1) Q:PSBXX=""  S PSBXXX="" D  Q:$G(PSBLST4X(PSBONMBR))=4
"RTN","PSBCSUTX",31,0)
 .F  S PSBXXX=$O(PSBADMX(PSBONMBR,PSBXX,PSBXXX)) Q:PSBXXX=""  D  Q:$G(PSBLST4X(PSBONMBR))=4
"RTN","PSBCSUTX",32,0)
 ..I $$GET1^DIQ(53.79,PSBXXX_",","ACTION STATUS","I")'="N"  S PSBLST4X(PSBONMBR,PSBXXX)="",PSBLST4X(PSBONMBR)=$G(PSBLST4X(PSBONMBR))+1
"RTN","PSBCSUTX",33,0)
 I PSBIENX]"",$D(PSBLST4X(PSBONMBR,PSBIENX)) D
"RTN","PSBCSUTX",34,0)
 .S PSBBAGID=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTX",35,0)
 .S PSBACTDT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION DATE/TIME","I")
"RTN","PSBCSUTX",36,0)
 .S PSBACT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION STATUS","I")
"RTN","PSBCSUTX",37,0)
 .S PSBPRNRE=$$GET1^DIQ(53.79,PSBIENX_",","PRN REASON")
"RTN","PSBCSUTX",38,0)
 .S PSBACTBY=$$GET1^DIQ(53.79,PSBIENX_",","ACTION BY:INITIAL") S:PSBACTBY']"" PSBACTBY="***"
"RTN","PSBCSUTX",39,0)
 .S PSBACTPT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION BY","I")
"RTN","PSBCSUTX",40,0)
 .I '$D(PSBDONE(PSBIENX)) D
"RTN","PSBCSUTX",41,0)
 ..I PSBLRGIV,(PSBFON]"") Q
"RTN","PSBCSUTX",42,0)
 ..S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^"_PSBBAGID_"^"_PSBIENX_"^"_PSBACT_"^"_PSBACTDT_"^"_PSBACTBY_"^"_PSBACTPT_"^"_PSBPRNRE
"RTN","PSBCSUTX",43,0)
 ..I PSBLRGIV D
"RTN","PSBCSUTX",44,0)
 ...I PSBOSP<PSBNOW S PSBADMS(PSBONMBR,"EXP")=""
"RTN","PSBCSUTX",45,0)
 ...S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX,1)=1
"RTN","PSBCSUTX",46,0)
 ..S PSBDONE(PSBIENX)="" K PSBADMX(PSBONMBR,PSBSCHTM,PSBIENX) D
"RTN","PSBCSUTX",47,0)
 ...S PSBXX="" F  S PSBXX=$O(PSBADMX(PSBONMBR,PSBXX)) Q:PSBXX=""  I $D(PSBADMX(PSBONMBR,PSBXX,PSBIENX)) K PSBADMX(PSBONMBR,PSBXX,PSBIENX)
"RTN","PSBCSUTX",48,0)
 I PSBIENX']"" D
"RTN","PSBCSUTX",49,0)
 .S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^^^^^^^"
"RTN","PSBCSUTX",50,0)
 .I PSBLRGIV S PSBADMS(PSBONMBR,PSBSCHTM,1)=1
"RTN","PSBCSUTX",51,0)
 I "^O^OC^P^"[(U_PSBSCHT_U)&('$D(PSBADMS(PSBONMBR))) S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^^^^^^^"
"RTN","PSBCSUTX",52,0)
 S PSBRECHD="ORC" K PSBSCHTM S PSBXREC=""
"RTN","PSBCSUTX",53,0)
 Q
"RTN","PSBCSUTX",54,0)
ORC ; Ordr commnts
"RTN","PSBCSUTX",55,0)
 S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORC",$P(^TMP("PSB",$J,"CVRSHT2",PSBCNT2),U,2)=^TMP("PSB",$J,PSBTAB,PSBI1),PSBRECHD="MED"
"RTN","PSBCSUTX",56,0)
 Q
"RTN","PSBCSUTX",57,0)
MED ; Cnstr DD,ADD,SOL,ID segms
"RTN","PSBCSUTX",58,0)
 S PSBXREC=^TMP("PSB",$J,PSBTAB,PSBI1)
"RTN","PSBCSUTX",59,0)
 Q:$$QUT^PSBCSUTY()
"RTN","PSBCSUTX",60,0)
 I $P(PSBXREC,U)="ID" S PSBUSED=$$USED^PSBCSUTY()  Q:PSBUSED
"RTN","PSBCSUTX",61,0)
 S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)=^TMP("PSB",$J,PSBTAB,PSBI1)
"RTN","PSBCSUTX",62,0)
 Q
"RTN","PSBCSUTX",63,0)
ADM ; AdmnInfo
"RTN","PSBCSUTX",64,0)
 K PSBDONE S (PSBONMBR,PSBSCHTM)="" F PSBI1=2:1:$P(^TMP("PSB",$J,PSBTAB,0),U) D
"RTN","PSBCSUTX",65,0)
 .I $P(^TMP("PSB",$J,PSBTAB,PSBI1),U)="ORD" S PSBONMBR=$P(^TMP("PSB",$J,PSBTAB,PSBI1),U,3),$P(^TMP("PSB",$J,"CVRSHT2",PSBI1),U,15)=""
"RTN","PSBCSUTX",66,0)
 .S (PSBXX,PSBXXX)="" F  S PSBXX=$O(PSBADMX(PSBONMBR,PSBXX)) Q:PSBXX=""  F  S PSBXXX=$O(PSBADMX(PSBONMBR,PSBXX,PSBXXX)) Q:PSBXXX=""  D
"RTN","PSBCSUTX",67,0)
 ..S PSBSCHTM=PSBXX,PSBIENX=PSBXXX
"RTN","PSBCSUTX",68,0)
 ..Q:'$D(PSBLST4X(PSBONMBR,PSBIENX))
"RTN","PSBCSUTX",69,0)
 ..S PSBACT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION STATUS","I")
"RTN","PSBCSUTX",70,0)
 ..I PSBACT']"" S PSBACT="U"
"RTN","PSBCSUTX",71,0)
 ..S PSBACTDT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION DATE/TIME","I")
"RTN","PSBCSUTX",72,0)
 ..S PSBBAGID=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTX",73,0)
 ..S PSBPRNRE=$$GET1^DIQ(53.79,PSBIENX_",","PRN REASON")
"RTN","PSBCSUTX",74,0)
 ..S PSBACTBY=$$GET1^DIQ(53.79,PSBIENX_",","ACTION BY:INITIAL") S:PSBACTBY']"" PSBACTBY="***"
"RTN","PSBCSUTX",75,0)
 ..S PSBACTPT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION BY","I")
"RTN","PSBCSUTX",76,0)
 ..S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^"_PSBBAGID_"^"_PSBIENX_"^"_PSBACT_"^"_PSBACTDT_"^"_PSBACTBY_"^"_PSBACTPT_"^"_PSBPRNRE
"RTN","PSBCSUTX",77,0)
 ..I PSBIENX]"" K PSBADMX(PSBONMBR,PSBSCHTM,PSBIENX)
"RTN","PSBCSUTX",78,0)
 .I '$D(PSBADMS(PSBONMBR)) K ^TMP("PSB",$J,"CVRSHT2",PSBI1) Q
"RTN","PSBCSUTX",79,0)
 .I $P(^TMP("PSB",$J,PSBTAB,PSBI1),U)="END" K PSBADMS(PSBONMBR) Q
"RTN","PSBCSUTX",80,0)
 .I $P(^TMP("PSB",$J,PSBTAB,PSBI1+1),U)="END" D  Q
"RTN","PSBCSUTX",81,0)
 ..S PSBCNT2=1,PSBSCHTM=""
"RTN","PSBCSUTX",82,0)
 ..F  S PSBSCHTM=$O(PSBADMS(PSBONMBR,PSBSCHTM)) Q:+$G(PSBSCHTM)=0  D
"RTN","PSBCSUTX",83,0)
 ...S PSBIENX=$P(PSBADMS(PSBONMBR,PSBSCHTM),U,3)
"RTN","PSBCSUTX",84,0)
 ...I PSBIENX]"",'$D(PSBDONE(PSBIENX))  D
"RTN","PSBCSUTX",85,0)
 ....S PSBACT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION STATUS","I")
"RTN","PSBCSUTX",86,0)
 ....I PSBACT']"" S PSBACT="U"
"RTN","PSBCSUTX",87,0)
 ....S PSBACTDT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION DATE/TIME","I")
"RTN","PSBCSUTX",88,0)
 ....Q:PSBACT="N"
"RTN","PSBCSUTX",89,0)
 ....Q:$D(PSBADMS(PSBONMBR,"EXP"))&("SI"'[PSBACT)
"RTN","PSBCSUTX",90,0)
 ....S $P(PSBADMS(PSBONMBR,PSBSCHTM),U,4)=PSBACT
"RTN","PSBCSUTX",91,0)
 ....S ^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2)="ADM^"_PSBADMS(PSBONMBR,PSBSCHTM)_"^"_$$NEXTADM(PSBDFNX,PSBONMBR),PSBCNT2=PSBCNT2+1
"RTN","PSBCSUTX",92,0)
 ....S PSBDONE(PSBIENX)=""
"RTN","PSBCSUTX",93,0)
 ....D CMT^PSBCSUTY
"RTN","PSBCSUTX",94,0)
 ...I (PSBIENX']"")&($G(PSBADMS(PSBONMBR,PSBSCHTM,1))'=1) S ^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2)="ADM^"_PSBADMS(PSBONMBR,PSBSCHTM)_"^"_$$NEXTADM(PSBDFNX,PSBONMBR),PSBCNT2=PSBCNT2+1
"RTN","PSBCSUTX",95,0)
 K PSBSCHTM
"RTN","PSBCSUTX",96,0)
 Q
"RTN","PSBCSUTX",97,0)
FINALPAS ;
"RTN","PSBCSUTX",98,0)
 S PSBI1="^TMP(""PSB"",$J,""CVRSHT"")",PSBCNT1=0
"RTN","PSBCSUTX",99,0)
 F  S PSBI1=$Q(@PSBI1) Q:PSBI1["CVRSHT2"  D
"RTN","PSBCSUTX",100,0)
 .I $QS(PSBI1,4)'>1 S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=@PSBI1,PSBCNT1=PSBCNT1+1 Q
"RTN","PSBCSUTX",101,0)
 .K PSBX2 M PSBX2=^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4))
"RTN","PSBCSUTX",102,0)
 .I $QS(PSBI1,5)="" S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=@PSBI1,PSBCNT1=PSBCNT1+1 Q
"RTN","PSBCSUTX",103,0)
 .K PSBDONE
"RTN","PSBCSUTX",104,0)
 .I '$D(PSBX2(1)) S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=@PSBI1,PSBCNT1=PSBCNT1+1 Q
"RTN","PSBCSUTX",105,0)
 .F PSBI2=1:1 Q:'$D(PSBX2(PSBI2))  D  ; Sort actn/commnt revrs chrono
"RTN","PSBCSUTX",106,0)
 ..Q:$D(PSBDONE(PSBI2))
"RTN","PSBCSUTX",107,0)
 ..S PSBXDTTM=(-1*($P(PSBX2(PSBI2),U,6)))_+($E($P(PSBX2(PSBI2),U,4),$L($P(PSBX2(PSBI2),U,4))-6,999)),PSBMCODE=$P(PSBX2(PSBI2),U)
"RTN","PSBCSUTX",108,0)
 ..D:(+PSBXDTTM<0)&(PSBMCODE["ADM")
"RTN","PSBCSUTX",109,0)
 ...S PSBX3(+PSBXDTTM,-999)=PSBX2(PSBI2),PSBDONE(PSBI2)="" K ^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4),PSBI2)
"RTN","PSBCSUTX",110,0)
 ...F PSBI3=1:1 Q:'$D(PSBX2(PSBI2+PSBI3))  Q:$P(PSBX2(PSBI2+PSBI3),U)'["CMT"  D
"RTN","PSBCSUTX",111,0)
 ....S PSBX3(+PSBXDTTM,-1*PSBI3)=PSBX2(PSBI2+PSBI3),PSBDONE(PSBI2+PSBI3)="" K ^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4),PSBI2+PSBI3)
"RTN","PSBCSUTX",112,0)
 ..D:(+PSBXDTTM=0)&(PSBMCODE["ADM")
"RTN","PSBCSUTX",113,0)
 ...S PSBX3(PSBI2,0)=PSBX2(PSBI2),PSBDONE(PSBI2)="" K ^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4),PSBI2)
"RTN","PSBCSUTX",114,0)
 .I $D(PSBX3) D  K PSBX3
"RTN","PSBCSUTX",115,0)
 ..S PSBI2="" F  S PSBI2=$O(PSBX3(PSBI2)) Q:PSBI2=""  S PSBI3="" F  S PSBI3=$O(PSBX3(PSBI2,PSBI3)) Q:PSBI3=""  D
"RTN","PSBCSUTX",116,0)
 ...S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=PSBX3(PSBI2,PSBI3),PSBCNT1=PSBCNT1+1
"RTN","PSBCSUTX",117,0)
 S $P(^TMP("PSB",$J,"CVRSHT2",0),U)=PSBCNT1-1
"RTN","PSBCSUTX",118,0)
 Q
"RTN","PSBCSUTX",119,0)
NEXTADM(XX,YY) ;
"RTN","PSBCSUTX",120,0)
 S NEXTADM=""
"RTN","PSBCSUTX",121,0)
 I $D(PSBNXTDU(YY)) S NEXTADM=PSBNXTDU(YY) Q NEXTADM
"RTN","PSBCSUTX",122,0)
 D:YY'["P"
"RTN","PSBCSUTX",123,0)
 .S PSBPATX=XX,PSBORXX=YY D CLEAN^PSBVT,PSJ1^PSBVT(XX,YY)
"RTN","PSBCSUTX",124,0)
 .Q:(PSBORXX["V")&'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH))
"RTN","PSBCSUTX",125,0)
 .S PSBGSCH=PSBADST,XX=PSBPATX,YY=PSBORXX,(NEXTADM,X,Y)="",X=$O(^PSB(53.79,"AORD",XX,YY,X),-1)
"RTN","PSBCSUTX",126,0)
 .I X]"" S Y=$O(^PSB(53.79,"AORD",XX,YY,X,Y),-1) I ($F("NM",$P(^PSB(53.79,Y,0),U,9))>1)!($P(^PSB(53.79,Y,0),U,9)="") S NEXTADM=X
"RTN","PSBCSUTX",127,0)
 .D:X']""
"RTN","PSBCSUTX",128,0)
 ..S Y="",X=$O(^PSB(53.79,"AORDX",XX,YY,X),-1)
"RTN","PSBCSUTX",129,0)
 ..I X]"" S Y=$O(^PSB(53.79,"AORDX",XX,YY,X,Y),-1) I $F("NM",$P(^PSB(53.79,Y,0),U,9))>1!($P(^PSB(53.79,Y,0),U,9)="") S NEXTADM=$P(^PSB(53.79,Y,0),U,6)
"RTN","PSBCSUTX",130,0)
 .D:NEXTADM=""
"RTN","PSBCSUTX",131,0)
 ..S PSBGOTY=Y,PSBFREQ=$$GETFREQ^PSBVDLU1(XX,YY)
"RTN","PSBCSUTX",132,0)
 ..S PSBFREQ=$S(PSBFREQ="O":1440,PSBFREQ="D":"",1:PSBFREQ)
"RTN","PSBCSUTX",133,0)
 ..S (PSBXSCH,LSTTIME,LSTIEN)=""
"RTN","PSBCSUTX",134,0)
 ..S:PSBGOTY]"" LSTTIME=$O(^PSB(53.79,"AORD",PSBPATX,PSBORXX,LSTTIME),-1) I LSTTIME]"" S LSTIEN=$O(^PSB(53.79,"AORD",PSBPATX,PSBORXX,LSTTIME,""),-1)
"RTN","PSBCSUTX",135,0)
 ..I LSTIEN]"" S:$P(^PSB(53.79,LSTIEN,0),U,9)']"" LSTTIME=""
"RTN","PSBCSUTX",136,0)
 ..S:LSTTIME="" LSTTIME=$$FMADD^XLFDT(PSBOST,,,,-0.1)
"RTN","PSBCSUTX",137,0)
 ..I +PSBFREQ>0 S PSBXSCH=(+PSBFREQ/60)_"H"
"RTN","PSBCSUTX",138,0)
 ..S X=LSTTIME
"RTN","PSBCSUTX",139,0)
 ..F PSBIX1=1:1:($L(PSBGSCH,"-")+1) D  Q:NEXTADM>LSTTIME
"RTN","PSBCSUTX",140,0)
 ...I ($P(PSBGSCH,"-",PSBIX1))']"" D  Q
"RTN","PSBCSUTX",141,0)
 ....I PSBIX1=1 D  Q
"RTN","PSBCSUTX",142,0)
 .....I X<PSBOST S NEXTADM=PSBOST Q
"RTN","PSBCSUTX",143,0)
 .....S X=PSBOST F  S X=$$SCH^XLFDT(PSBXSCH,X) S Y="" S Y=$O(^PSB(53.79,"AORD",PSBPATX,PSBORXX,Y),-1)  I X>Y S NEXTADM=X Q
"RTN","PSBCSUTX",144,0)
 ....I PSBGSCH]"" D  Q
"RTN","PSBCSUTX",145,0)
 .....I (+PSBFREQ'>1440) F I=0:1 S PSBDTXX=$$FMADD^XLFDT(PSBOST,I) S $P(PSBDTXX,".",2)=($P(PSBGSCH,"-")) I PSBDTXX>LSTTIME S NEXTADM=PSBDTXX Q
"RTN","PSBCSUTX",146,0)
 .....I (+PSBFREQ'<1440),(1440#PSBFREQ=1440) F I=0:1 S PSBDTXX=$$FMADD^XLFDT(PSBOST,(I*(PSBFREQ\1440))) S $P(PSBDTXX,".",2)=($P(PSBGSCH,"-")) I PSBDTXX>LSTTIME S NEXTADM=PSBDTXX Q
"RTN","PSBCSUTX",147,0)
 ....S $P(X,".",2)=$P(PSBGSCH,"-"),NEXTADM=$$SCH^XLFDT(PSBXSCH,X) Q
"RTN","PSBCSUTX",148,0)
 ...S $P(X,".",2)=$P(PSBGSCH,"-",PSBIX1),NEXTADM=X
"RTN","PSBCSUTX",149,0)
 .I $$PSBDCHK1^PSBVT1(PSBSCH) D
"RTN","PSBCSUTX",150,0)
 ..S YY=PSBORXX,XX=PSBPATX
"RTN","PSBCSUTX",151,0)
 ..I $G(LSTTIME)]"" S NEXTADM=$S(LSTTIME'<PSBOST:LSTTIME,NEXTADM>LSTTIME:NEXTADM,1:PSBOST)
"RTN","PSBCSUTX",152,0)
 ..I PSBFREQ="" S PSBDTX=$P(NEXTADM,".") F PSBIX3=0:1 S X=$$FMADD^XLFDT(PSBDTX,PSBIX3) Q:X>PSBOSP  D  Q:$G(PSBYS)
"RTN","PSBCSUTX",153,0)
 ...S PSBNXTDT=X D DW^%DTC S PSBYS=0 F PSBIX2=1:1 S PSBDY=$P($P(PSBSCH,"@"),"-",PSBIX2) Q:PSBDY=""  I $F(X,PSBDY)>1 S PSBYS=1
"RTN","PSBCSUTX",154,0)
 ...I PSBYS S PSBSCTM=$$GETADMIN^PSBVDLU1(XX,YY,PSBNXTDT,"","") K ^TMP("PSB",$J,"GETADMIN") D
"RTN","PSBCSUTX",155,0)
 ....F PSBIX4=1:1 S PSBTX=$P(PSBSCTM,"-",PSBIX4) Q:PSBTX=""  D  Q:PSBYS
"RTN","PSBCSUTX",156,0)
 .....I NEXTADM>(PSBNXTDT_"."_PSBTX) S PSBYS=0 Q
"RTN","PSBCSUTX",157,0)
 .....S NEXTADM=PSBNXTDT,$P(NEXTADM,".",2)=PSBTX
"RTN","PSBCSUTX",158,0)
 .....I NEXTADM]"" I (NEXTADM<PSBOST)!$D(^PSB(53.79,"AORD",PSBPATX,PSBORXX,+NEXTADM))!(NEXTADM>PSBOSP) S PSBYS=0,NEXTADM="" Q
"RTN","PSBCSUTX",159,0)
 .....S PSBYS=1
"RTN","PSBCSUTX",160,0)
 .S PSBNXTDU(PSBORXX)=NEXTADM
"RTN","PSBCSUTX",161,0)
 .D CLEAN^PSBVT
"RTN","PSBCSUTX",162,0)
 Q NEXTADM
"RTN","PSBMLLKU")
0^12^B66069590^B65545220
"RTN","PSBMLLKU",1,0)
PSBMLLKU ;BIRMINGHAM/TEJ-BCMA RPC LOOKUP UTLILITIES ;Mar 2004
"RTN","PSBMLLKU",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,9,11,20,13,38**;Mar 2004;Build 8
"RTN","PSBMLLKU",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBMLLKU",4,0)
 ;
"RTN","PSBMLLKU",5,0)
 ; Reference/IA
"RTN","PSBMLLKU",6,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBMLLKU",7,0)
 ; $$DOB^DPTLK1/3266
"RTN","PSBMLLKU",8,0)
 ; $$SSN^DPTLK1/3267
"RTN","PSBMLLKU",9,0)
 ; ^DPT/10035
"RTN","PSBMLLKU",10,0)
 ; ^XUSEC/10076
"RTN","PSBMLLKU",11,0)
 ; File 52.6/436
"RTN","PSBMLLKU",12,0)
 ; File 52.7/437
"RTN","PSBMLLKU",13,0)
 ; File 50/221
"RTN","PSBMLLKU",14,0)
 ;
"RTN","PSBMLLKU",15,0)
 ;
"RTN","PSBMLLKU",16,0)
RPC(RESULTS,PSBREC) ; Remote Procedure Call Entry Point.
"RTN","PSBMLLKU",17,0)
 ;
"RTN","PSBMLLKU",18,0)
 S RESULTS="" D @(PSBREC(0)_"(.RESULTS,.PSBREC)") Q
"RTN","PSBMLLKU",19,0)
 Q
"RTN","PSBMLLKU",20,0)
 ;
"RTN","PSBMLLKU",21,0)
ADMLKUP(RESULTS,PSBREC) ;
"RTN","PSBMLLKU",22,0)
 ;  Lookup ADMinistrations per DFN and search DATE
"RTN","PSBMLLKU",23,0)
 ;   input - PSBREC(1)  DFN
"RTN","PSBMLLKU",24,0)
 ;           PSBREC(2)  Search DATE
"RTN","PSBMLLKU",25,0)
 ;
"RTN","PSBMLLKU",26,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",27,0)
 ;          (Administrations returned will be dated  = to Search Date
"RTN","PSBMLLKU",28,0)
 ;
"RTN","PSBMLLKU",29,0)
 ;
"RTN","PSBMLLKU",30,0)
 K RESULTS
"RTN","PSBMLLKU",31,0)
 S DFN=PSBREC(1),PSBSRCH=$G(PSBREC(2)) I $G(PSBSRCH)']"" D NOW^%DTC S PSBSRCH=$P(%,".")
"RTN","PSBMLLKU",32,0)
 S PSBDT=PSBSRCH,PSBCNT=0 S:PSBSRCH'["." PSBSRCH=PSBSRCH+.9
"RTN","PSBMLLKU",33,0)
 S RESULTS(0)=1,RESULTS(1)="-1^No Meds Found!"
"RTN","PSBMLLKU",34,0)
 F  S PSBSRCH=$O(^PSB(53.79,"AADT",DFN,PSBSRCH),-1) Q:'PSBSRCH!(PSBSRCH<PSBDT)  D
"RTN","PSBMLLKU",35,0)
 .S PSBIEN=""
"RTN","PSBMLLKU",36,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBSRCH,PSBIEN),-1) Q:'PSBIEN  D:'$D(^PSB(53.79,PSBIEN)) KILLAADT  Q:'$D(^PSB(53.79,PSBIEN))  D:$$CHKKEY(PSBIEN)
"RTN","PSBMLLKU",37,0)
 ..L +^PSB(53.79,PSBIEN):1
"RTN","PSBMLLKU",38,0)
 ..I  L -^PSB(53.79,PSBIEN)
"RTN","PSBMLLKU",39,0)
 ..E  Q
"RTN","PSBMLLKU",40,0)
 ..S PSBXORDN=$$GET1^DIQ(53.79,PSBIEN_",",.11) Q:'$D(^PSB(53.79,"AORDX",DFN,PSBXORDN,PSBSRCH))
"RTN","PSBMLLKU",41,0)
 ..Q:($$GET1^DIQ(53.79,PSBIEN_",",.06,"I")>PSBSRCH)
"RTN","PSBMLLKU",42,0)
 ..Q:($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")="N")
"RTN","PSBMLLKU",43,0)
 ..S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=PSBIEN
"RTN","PSBMLLKU",44,0)
 ..S $P(RESULTS(PSBCNT),U,2)=PSBSRCH
"RTN","PSBMLLKU",45,0)
 ..S $P(RESULTS(PSBCNT),U,3)=$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBMLLKU",46,0)
 ..S:$$GET1^DIQ(53.79,PSBIEN_",",.26) $P(RESULTS(PSBCNT),U,4)=$$GET1^DIQ(53.79,PSBIEN_",",.26)
"RTN","PSBMLLKU",47,0)
 ..S $P(RESULTS(PSBCNT),U,5)=$S($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")']"":"U",1:$$GET1^DIQ(53.79,PSBIEN_",",.09,"I"))
"RTN","PSBMLLKU",48,0)
 ..D  ; Get order information
"RTN","PSBMLLKU",49,0)
 ...K ^TMP("PSJ1",$J) D EN^PSJBCMA1(DFN,PSBXORDN,1)
"RTN","PSBMLLKU",50,0)
 ...S $P(RESULTS(PSBCNT),U,3)=$P(^TMP("PSJ1",$J,2),U,2)  ;OItem_" "_Dosage Form
"RTN","PSBMLLKU",51,0)
 ...S $P(RESULTS(PSBCNT),U,6)=$P(^TMP("PSJ1",$J,4),U)    ;Sched Type
"RTN","PSBMLLKU",52,0)
 ...K ^TMP("PSJ1",$J)
"RTN","PSBMLLKU",53,0)
 ..S $P(RESULTS(PSBCNT),U,7)=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I")
"RTN","PSBMLLKU",54,0)
 ..S $P(RESULTS(PSBCNT),U,8)=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBMLLKU",55,0)
 ..S:$D(^PSB(53.79,PSBIEN,.2)) $P(RESULTS(PSBCNT),U,9)=$P(^PSB(53.79,PSBIEN,.2),U),$P(RESULTS(PSBCNT),U,10)=$P(^PSB(53.79,PSBIEN,.2),U,2)
"RTN","PSBMLLKU",56,0)
 S:+$G(RESULTS(1))>0 $P(RESULTS(0),U)=PSBCNT
"RTN","PSBMLLKU",57,0)
 Q
"RTN","PSBMLLKU",58,0)
 ;
"RTN","PSBMLLKU",59,0)
CHKKEY(PSBIENX) ;
"RTN","PSBMLLKU",60,0)
 I '(($D(^XUSEC("PSB MANAGER",DUZ)))!($$GET1^DIQ(53.79,+PSBIENX,.07,"I")=DUZ)) Q 0
"RTN","PSBMLLKU",61,0)
 Q 1
"RTN","PSBMLLKU",62,0)
 ;
"RTN","PSBMLLKU",63,0)
PTLKUP(RESULTS,PSBREC) ; Patient lookup handled separately for security
"RTN","PSBMLLKU",64,0)
 ;   input - PSBREC (array)  User entered patient lookup data
"RTN","PSBMLLKU",65,0)
 ;
"RTN","PSBMLLKU",66,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",67,0)
 ;          (Person(s) in PATIENT File (#2) meeting search criteria)
"RTN","PSBMLLKU",68,0)
 ;
"RTN","PSBMLLKU",69,0)
 ;
"RTN","PSBMLLKU",70,0)
 K RESULTS
"RTN","PSBMLLKU",71,0)
 S PSBDATA=$E(PSBREC(1),1,30)
"RTN","PSBMLLKU",72,0)
 N PSBINDX
"RTN","PSBMLLKU",73,0)
 S PSBINDX=$S(PSBDATA?9N.1P:"SSN",PSBDATA?4N.1P:"BS5^BS",1:"")
"RTN","PSBMLLKU",74,0)
 D FIND^DIC(2,"","@;.01;.02;.03;.09","MP",PSBDATA,200,PSBINDX)
"RTN","PSBMLLKU",75,0)
 I $P($G(^TMP("DILIST",$J,0)),U,3) D  Q
"RTN","PSBMLLKU",76,0)
 .S RESULTS(0)=1,RESULTS(1)="-1^Too many patients found matching '"_PSBDATA_"'. Please be more specific."
"RTN","PSBMLLKU",77,0)
 I $D(^TMP("DILIST",$J,0)) D
"RTN","PSBMLLKU",78,0)
 .F PSBXX=0:0 S PSBXX=$O(^TMP("DILIST",$J,PSBXX)) Q:'PSBXX  D
"RTN","PSBMLLKU",79,0)
 ..S RESULTS(PSBXX)=$$PTREC(+^TMP("DILIST",$J,PSBXX,0))
"RTN","PSBMLLKU",80,0)
 I '$D(RESULTS) S RESULTS(0)=1,RESULTS(1)="-1^No patients matching '"_PSBDATA_"'"
"RTN","PSBMLLKU",81,0)
 E  S RESULTS(0)=+$O(RESULTS(""),-1)
"RTN","PSBMLLKU",82,0)
 Q
"RTN","PSBMLLKU",83,0)
 ;
"RTN","PSBMLLKU",84,0)
PTREC(DFN) ;
"RTN","PSBMLLKU",85,0)
 ; Extrinsic to return a Pt Rec  in standard list format
"RTN","PSBMLLKU",86,0)
 N PSBXX
"RTN","PSBMLLKU",87,0)
 S PSBXX=$G(^DPT(DFN,0))
"RTN","PSBMLLKU",88,0)
 S PSBXX=DFN_U_$P(PSBXX,U,1)_U_$P(PSBXX,U,2)_U_$P(PSBXX,U,3)_U_$P(PSBXX,U,9)
"RTN","PSBMLLKU",89,0)
 S $P(PSBXX,U,6)=$$GET1^DIQ(2,DFN_",",.1)
"RTN","PSBMLLKU",90,0)
 S $P(PSBXX,U,7)=$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBMLLKU",91,0)
 S $P(PSBXX,U,10)=$$DOB^DPTLK1(DFN)
"RTN","PSBMLLKU",92,0)
 S $P(PSBXX,U,11)=$$SSN^DPTLK1(DFN)
"RTN","PSBMLLKU",93,0)
 Q PSBXX
"RTN","PSBMLLKU",94,0)
 ;
"RTN","PSBMLLKU",95,0)
SELECTAD(RESULTS,PSBREC) ; Select Administration
"RTN","PSBMLLKU",96,0)
 ;
"RTN","PSBMLLKU",97,0)
 ;  Process the SELECTed ADministration
"RTN","PSBMLLKU",98,0)
 ;   input - PSBREC(1) = PSB Med Log File (#53.79) IEN
"RTN","PSBMLLKU",99,0)
 ;
"RTN","PSBMLLKU",100,0)
 ;
"RTN","PSBMLLKU",101,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",102,0)
 ;          (Administration data that can be subsequently updated via GUI MED LOG EDIT)
"RTN","PSBMLLKU",103,0)
 ;
"RTN","PSBMLLKU",104,0)
 ;
"RTN","PSBMLLKU",105,0)
 K RESULTS,PSBXIV,PSBPTCHX
"RTN","PSBMLLKU",106,0)
 N PSBIEN,PSBCNT,PSBX S PSBIEN=PSBREC(1),PSBCNT=2
"RTN","PSBMLLKU",107,0)
 ; Construct form data    Patient^SSN^Med^BagID^AdminStat^AdminD/T^InjctSt^PRNReas^PRNEff^DisDrg^UntsGiven^Unt^
"RTN","PSBMLLKU",108,0)
 S RESULTS(0)=0
"RTN","PSBMLLKU",109,0)
 D:$$CHKKEY(PSBIEN)
"RTN","PSBMLLKU",110,0)
 .L +^PSB(53.79,PSBIEN):1
"RTN","PSBMLLKU",111,0)
 .E  I $P(^PSB(53.79,PSBIEN,0),U,9)]"" S PSBCNT=1,RESULTS(1)="-1^ This administration is being modified by another process at this moment." L -^PSB(53.79,PSBIEN) Q
"RTN","PSBMLLKU",112,0)
 .S $P(RESULTS(1),U)=PSBIEN
"RTN","PSBMLLKU",113,0)
 .S $P(RESULTS(1),U,2)=$$GET1^DIQ(53.79,PSBIEN_",",.01,"I")
"RTN","PSBMLLKU",114,0)
 .S $P(RESULTS(1),U,3)=$$GET1^DIQ(53.79,PSBIEN_",",.01)
"RTN","PSBMLLKU",115,0)
 .S $P(RESULTS(1),U,4)=$$GET1^DIQ(2,$P(RESULTS(1),U,2)_",",.09)
"RTN","PSBMLLKU",116,0)
 .S $P(RESULTS(1),U,5)=$$GET1^DIQ(53.79,PSBIEN_",",.08,"I")_"~"_$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBMLLKU",117,0)
 .S $P(RESULTS(1),U,6)=$$GET1^DIQ(53.79,PSBIEN_",",.26)
"RTN","PSBMLLKU",118,0)
 .S $P(RESULTS(1),U,7)=$S($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")']"":"U",1:$$GET1^DIQ(53.79,PSBIEN_",",.09,"I"))
"RTN","PSBMLLKU",119,0)
 .;
"RTN","PSBMLLKU",120,0)
 .D:($P(RESULTS(1),U,7)'="N")&($P(RESULTS(1),U,7)]"") SELSTTUS(.RESULTS)  ; Amend RESULTS(1) data...
"RTN","PSBMLLKU",121,0)
 .S Y=$E($$GET1^DIQ(53.79,PSBIEN_",",.06,"I"),1,12) D DD^%DT
"RTN","PSBMLLKU",122,0)
 .S $P(RESULTS(1),U,8)=Y
"RTN","PSBMLLKU",123,0)
 .S $P(RESULTS(1),U,9)=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I")
"RTN","PSBMLLKU",124,0)
 .S $P(RESULTS(1),U,10)=$$GET1^DIQ(53.79,PSBIEN_",",.16)
"RTN","PSBMLLKU",125,0)
 .S $P(RESULTS(1),U,16)=0
"RTN","PSBMLLKU",126,0)
 .S $P(RESULTS(2),U)=$$GET1^DIQ(53.79,PSBIEN_",",.21),$P(RESULTS(2),U,2)=$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBMLLKU",127,0)
 .; Determine if there are any active IVs/Patchs per order
"RTN","PSBMLLKU",128,0)
 .D:$G(PSBPTCHX)
"RTN","PSBMLLKU",129,0)
 ..S PSBX="",PSBX="^PSB(53.79,""APATCH"","_$P(RESULTS(1),U,2)_")"
"RTN","PSBMLLKU",130,0)
 ..F  S PSBX=$Q(@PSBX) Q:PSBX=""  Q:$QS(PSBX,3)'=$P(RESULTS(1),U,2)  D  Q:$P(RESULTS(1),U,16)
"RTN","PSBMLLKU",131,0)
 ...S PSBXX=$QS(PSBX,5),PSBXXX=$S(($P(^PSB(53.79,PSBXX,0),U,9)="G")&(PSBXX'=PSBIEN):1,1:0)
"RTN","PSBMLLKU",132,0)
 ...I PSBXXX&($P(^PSB(53.79,PSBXX,.1),U)=$P(RESULTS(1),U,15)) S $P(RESULTS(1),U,16)=1
"RTN","PSBMLLKU",133,0)
 .D:$G(PSBXIV)
"RTN","PSBMLLKU",134,0)
 ..S PSBX="",PSBX="^PSB(53.79,""AUID"","_$P(RESULTS(1),U,2)_")"
"RTN","PSBMLLKU",135,0)
 ..F  S PSBX=$Q(@PSBX) Q:PSBX=""  Q:$QS(PSBX,3)'=$P(RESULTS(1),U,2)  Q:$QS(PSBX,4)>$P(RESULTS(1),U,15)  D  Q:$P(RESULTS(1),U,16)
"RTN","PSBMLLKU",136,0)
 ...Q:$QS(PSBX,4)'=$P(RESULTS(1),U,15)
"RTN","PSBMLLKU",137,0)
 ...S PSBXX=$QS(PSBX,6) S:(PSBXX'=PSBIEN) $P(RESULTS(1),U,16)=$S($P(^PSB(53.79,PSBXX,0),U,9)="I":1,$P(^PSB(53.79,PSBXX,0),U,9)="S":1,1:0)
"RTN","PSBMLLKU",138,0)
 .;
"RTN","PSBMLLKU",139,0)
 .; LOOP - Place DD in RESULTS
"RTN","PSBMLLKU",140,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.5,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",141,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",142,0)
 ..S RESULTS(PSBCNT)="DD^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U)_"^"_$$GET1^DIQ(50,$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",143,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,4)
"RTN","PSBMLLKU",144,0)
 ..S:$P(RESULTS(PSBCNT),U,4)?1"."1.N $P(RESULTS(PSBCNT),U,4)=0_+$P(RESULTS(PSBCNT),U,4)
"RTN","PSBMLLKU",145,0)
 ..S:$P(RESULTS(PSBCNT),U,5)?1"."1.N $P(RESULTS(PSBCNT),U,5)=0_+$P(RESULTS(PSBCNT),U,5)
"RTN","PSBMLLKU",146,0)
 .; LOOP - Place ADD in RESULTS
"RTN","PSBMLLKU",147,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.6,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",148,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",149,0)
 ..S RESULTS(PSBCNT)="ADD^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U)_"^"_$$GET1^DIQ(52.6,$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",150,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,4)
"RTN","PSBMLLKU",151,0)
 .; LOOP - Place SOL in RESULTS
"RTN","PSBMLLKU",152,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.7,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",153,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",154,0)
 ..S RESULTS(PSBCNT)="SOL^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U)_"^"_$$GET1^DIQ(52.7,$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",155,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,4)
"RTN","PSBMLLKU",156,0)
 .L -^PSB(53.79,PSBIEN)
"RTN","PSBMLLKU",157,0)
 S:PSBCNT>0 RESULTS(0)=PSBCNT
"RTN","PSBMLLKU",158,0)
 Q
"RTN","PSBMLLKU",159,0)
 ;
"RTN","PSBMLLKU",160,0)
SELSTTUS(RESULTS) ;
"RTN","PSBMLLKU",161,0)
 ; Provide the SELectable STaTUS
"RTN","PSBMLLKU",162,0)
 ;
"RTN","PSBMLLKU",163,0)
 ; Get TAB, ScheduleType, Current Status, provide Selectable Staus(s) in ^8
"RTN","PSBMLLKU",164,0)
 N PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBIVPSH,PSBXTAB
"RTN","PSBMLLKU",165,0)
 K ^TMP("PSJ1",$J) D EN^PSJBCMA1($$GET1^DIQ(53.79,PSBIEN_",",.01,"I"),$$GET1^DIQ(53.79,PSBIEN_",",.11),1)
"RTN","PSBMLLKU",166,0)
 I ^TMP("PSJ1",$J,0)>0 D
"RTN","PSBMLLKU",167,0)
 .S PSBORTYP=$TR($P(^TMP("PSJ1",$J,0),U,3),"1234567890"),PSBIVTYP=$P(^TMP("PSJ1",$J,0),U,6)
"RTN","PSBMLLKU",168,0)
 .S PSBINTSY=$P(^TMP("PSJ1",$J,0),U,7),PSBCHMTY=$P(^TMP("PSJ1",$J,0),U,8),PSBIVPSH=+$P($G(^TMP("PSJ1",$J,1,0)),U,2)
"RTN","PSBMLLKU",169,0)
 .S:$$IVPTAB^PSBVDLU3(PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBIVPSH) PSBXTAB="PB"
"RTN","PSBMLLKU",170,0)
 .D:'$D(PSBXTAB)
"RTN","PSBMLLKU",171,0)
 ..I PSBORTYP="U" S PSBXTAB="UD"
"RTN","PSBMLLKU",172,0)
 ..I PSBORTYP="V" S PSBXTAB="IV"
"RTN","PSBMLLKU",173,0)
 ; Set Results(1) and other flags...
"RTN","PSBMLLKU",174,0)
 I ^TMP("PSJ1",$J,0)>0 D
"RTN","PSBMLLKU",175,0)
 .S $P(RESULTS(1),U,13)=$P(^TMP("PSJ1",$J,4),U)
"RTN","PSBMLLKU",176,0)
 .S $P(RESULTS(1),U,14)=$P(^TMP("PSJ1",$J,1),U,10)
"RTN","PSBMLLKU",177,0)
 .S $P(RESULTS(1),U,15)=$P(^TMP("PSJ1",$J,0),U,3)
"RTN","PSBMLLKU",178,0)
 .I (PSBXTAB="UD"),($P(^TMP("PSJ1",$J,2),U,6)="PATCH") S PSBPTCHX=1
"RTN","PSBMLLKU",179,0)
 .I PSBXTAB="IV" S PSBXIV=1
"RTN","PSBMLLKU",180,0)
 .S:$G(PSBXTAB)]"" $P(RESULTS(1),U,11)=$G(PSBXTAB)
"RTN","PSBMLLKU",181,0)
 K ^TMP("PSJ1",$J)
"RTN","PSBMLLKU",182,0)
 Q
"RTN","PSBMLLKU",183,0)
 ;
"RTN","PSBMLLKU",184,0)
KILLAADT ;
"RTN","PSBMLLKU",185,0)
 ;   Here because there is an errorant index entry via version 1.0/2.0
"RTN","PSBMLLKU",186,0)
 ;   Cleansing!
"RTN","PSBMLLKU",187,0)
 ;
"RTN","PSBMLLKU",188,0)
 K ^PSB(53.79,"AADT",DFN,PSBSRCH,PSBIEN)
"RTN","PSBMLLKU",189,0)
 Q
"RTN","PSBMLLKU",190,0)
 ;
"RTN","PSBODL")
0^11^B83477494^B83407747
"RTN","PSBODL",1,0)
PSBODL ;BIRMINGHAM/EFC-DUE LIST ;Mar 2004
"RTN","PSBODL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,9,38**;Mar 2004;Build 8
"RTN","PSBODL",3,0)
 ;
"RTN","PSBODL",4,0)
 ; Reference/IA
"RTN","PSBODL",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBODL",6,0)
 ; $$GET^XPAR/2263
"RTN","PSBODL",7,0)
 ; ^XLFDT/10103
"RTN","PSBODL",8,0)
 ;
"RTN","PSBODL",9,0)
EN ; Prt DL
"RTN","PSBODL",10,0)
 N PSBGBL,PSBHDR,IOINHI,IOINORM,PSBGIVEN,PSBIEN,PSBLGDT,PSBEVDT,DFN,PSBFLAG
"RTN","PSBODL",11,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS S X=""
"RTN","PSBODL",12,0)
 S PSBGBL="^TMP(""PSBO"",$J,""B"")"
"RTN","PSBODL",13,0)
 F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,1)'="PSBO"!($QS(PSBGBL,2)'=$J)  D
"RTN","PSBODL",14,0)
 .S DFN=$QS(PSBGBL,5)
"RTN","PSBODL",15,0)
 .K PSBHDR
"RTN","PSBODL",16,0)
 .S PSBHDR(1)="MEDICATION DUE LIST for "
"RTN","PSBODL",17,0)
 .S (Y,PSBEVDT)=$P(PSBRPT(.1),U,6) D D^DIQ S PSBHDR(1)=PSBHDR(1)_Y_"  "
"RTN","PSBODL",18,0)
 .S Y=$P(PSBRPT(.1),U,7) S PSBHDR(1)=PSBHDR(1)_$E(Y_"0000",2,5)_"-"
"RTN","PSBODL",19,0)
 .S Y=$P(PSBRPT(.1),U,9) S PSBHDR(1)=PSBHDR(1)_$E(Y_"0000",2,5)
"RTN","PSBODL",20,0)
 .S:$P(PSBRPT(.2),U,6) X="IV "
"RTN","PSBODL",21,0)
 .S:$P(PSBRPT(.2),U,7) X=X_$S(X]"":"& ",1:"")_"Unit Dose "
"RTN","PSBODL",22,0)
 .S PSBHDR(2)="Order Type(s): "_X_" -- "
"RTN","PSBODL",23,0)
 .F Y=1:1:4 S:$P(PSBRPT(.2),U,Y) PSBHDR(2)=PSBHDR(2)_$P("Continuous^PRN^On-Call^One-Time",U,Y)_" "
"RTN","PSBODL",24,0)
 .D PRINT(DFN)
"RTN","PSBODL",25,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J),^TMP("PSBO",$J)
"RTN","PSBODL",26,0)
 Q
"RTN","PSBODL",27,0)
PRINT(DFN) ;^TMP($J.
"RTN","PSBODL",28,0)
 N PSBGBL,PSBOSTRT,PSBOSTOP,PSBODATE,PSBINDX,PSBTYPE,PSBSCH,PSBSCHT
"RTN","PSBODL",29,0)
 N PSBMED,PSBORD,PSB,PSBX,PSBY,PSBZ,PSBSTOP,PSBSTRT,PSBSM,PSBNUM,PSBAT
"RTN","PSBODL",30,0)
 N PSBADMIN,PSBADM,PSBSTAT,PSBWFLAG
"RTN","PSBODL",31,0)
 W $$HDR()
"RTN","PSBODL",32,0)
 S PSBOSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBODL",33,0)
 S PSBOSTOP=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,9)
"RTN","PSBODL",34,0)
 S PSBODATE=$P(PSBRPT(.1),U,6)
"RTN","PSBODL",35,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBODL",36,0)
 D EN^PSJBCMA(DFN,PSBOSTRT,"")
"RTN","PSBODL",37,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 W !!?10,"** NO SPECIFIED MEDICATIONS TO PRINT **",!,$$BLANKS(),$$FTR() Q
"RTN","PSBODL",38,0)
 S PSBINDX=0
"RTN","PSBODL",39,0)
 F  S PSBINDX=$O(^TMP("PSJ",$J,PSBINDX)) Q:'PSBINDX  D
"RTN","PSBODL",40,0)
 .S PSBTYPE=$P(^TMP("PSJ",$J,PSBINDX,0),U,3),PSBTYPE=$E(PSBTYPE,$L(PSBTYPE))
"RTN","PSBODL",41,0)
 .Q:PSBTYPE=""!(PSBTYPE="P")  ; No Pend this ver
"RTN","PSBODL",42,0)
 .S PSBSTAT=^TMP("PSJ",$J,PSBINDX,1)
"RTN","PSBODL",43,0)
 .I $P(PSBSTAT,U,7)["D"!($P(PSBSTAT,U,8)) Q
"RTN","PSBODL",44,0)
 .Q:PSBTYPE="U"&('$P(PSBRPT(.2),U,7))
"RTN","PSBODL",45,0)
 .Q:PSBTYPE="V"&('$P(PSBRPT(.2),U,6))
"RTN","PSBODL",46,0)
 .S PSBTYPE=$S(PSBTYPE="U":"UD-",PSBTYPE="V":"IV-",1:"**")
"RTN","PSBODL",47,0)
 .S Y=$P(PSBSTAT,U,2)
"RTN","PSBODL",48,0)
 .Q:Y="C"&('$P(PSBRPT(.2),U,1))
"RTN","PSBODL",49,0)
 .Q:Y="P"&('$P(PSBRPT(.2),U,2))
"RTN","PSBODL",50,0)
 .Q:Y="OC"&('$P(PSBRPT(.2),U,3))
"RTN","PSBODL",51,0)
 .Q:Y="O"&('$P(PSBRPT(.2),U,4))
"RTN","PSBODL",52,0)
 .S PSBSCHT=Y
"RTN","PSBODL",53,0)
 .S:PSBSCHT="" PSBSCHT="*"
"RTN","PSBODL",54,0)
 .S PSBMED=$P(^TMP("PSJ",$J,PSBINDX,3),U,2)
"RTN","PSBODL",55,0)
 .S PSBORD=$P(^TMP("PSJ",$J,PSBINDX,0),U,3)
"RTN","PSBODL",56,0)
 .S ^TMP("PSB",$J,"B",PSBTYPE,PSBSCHT,PSBMED,PSBORD)=""
"RTN","PSBODL",57,0)
 I '$D(^TMP("PSB",$J,"B")) W !!?10,"** NO SPECIFIED MEDICATIONS TO PRINT **",!,$$BLANKS(),$$FTR() Q
"RTN","PSBODL",58,0)
 S PSBGBL=$NAME(^TMP("PSB",$J,"B")),PSBWFLAG=0
"RTN","PSBODL",59,0)
 F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:($QS(PSBGBL,1)'="PSB")!($QS(PSBGBL,2)'=$J)!($QS(PSBGBL,3)'="B")  D
"RTN","PSBODL",60,0)
 .K PSBORD,PSBFUTRO
"RTN","PSBODL",61,0)
 .S PSBTYPE=$QS(PSBGBL,4)
"RTN","PSBODL",62,0)
 .S PSBSCHT=$QS(PSBGBL,5)
"RTN","PSBODL",63,0)
 .S PSBMED=$QS(PSBGBL,6)
"RTN","PSBODL",64,0)
 .S PSBORD=$QS(PSBGBL,7)
"RTN","PSBODL",65,0)
 .D CLEAN^PSBVT
"RTN","PSBODL",66,0)
 .D PSJ1^PSBVT(DFN,PSBORD)
"RTN","PSBODL",67,0)
 .D NOW^%DTC S PSBNOW=%
"RTN","PSBODL",68,0)
 .Q:PSBOSP<PSBOSTRT
"RTN","PSBODL",69,0)
 .Q:(PSBOSP<PSBOSTRT)&(PSBSCHT'="O")
"RTN","PSBODL",70,0)
 .S (PSBYES,PSBODD,PSBDAYB,PSBSCBR)=0
"RTN","PSBODL",71,0)
 .S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1,PSBDAYB=1
"RTN","PSBODL",72,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBSCBR=1
"RTN","PSBODL",73,0)
 .I PSBYES,PSBADST="",PSBSCHT'="O",PSBSCHT'="OC",PSBSCHT'="P" D  Q
"RTN","PSBODL",74,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBODL",75,0)
 .I PSBSCHT="OC" S PSBYES=1
"RTN","PSBODL",76,0)
 .I PSBSCHT="P" S PSBYES=1
"RTN","PSBODL",77,0)
 .I "PCS"'[PSBIVT S PSBYES=1
"RTN","PSBODL",78,0)
 .I PSBIVT["S",PSBISYR'=1 S PSBYES=1
"RTN","PSBODL",79,0)
 .I PSBIVT["C",PSBCHEMT'="P",PSBISYR'=1 S PSBYES=1
"RTN","PSBODL",80,0)
 .I PSBIVT["C",PSBCHEMT="A" S PSBYES=1
"RTN","PSBODL",81,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBODL",82,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBODL",83,0)
 .I PSBSCHT="P" S PSBFREQ=1440
"RTN","PSBODL",84,0)
 .I PSBSCHT="O" S PSBFREQ=1440
"RTN","PSBODL",85,0)
 .I 'PSBYES,PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBODL",86,0)
 .S PSBVALB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH)
"RTN","PSBODL",87,0)
 .I 'PSBDAYB,'PSBSCBR,PSBSCHT="C",PSBVALB="1",PSBADST'="",PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBODL",88,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBODL",89,0)
 .I PSBODD,PSBADST'="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH) Q
"RTN","PSBODL",90,0)
 .I PSBADST'="" D
"RTN","PSBODL",91,0)
 ..F PSBY=1:1:$L(PSBADST,"-")  D
"RTN","PSBODL",92,0)
 ...D:($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N)
"RTN","PSBODL",93,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBODL",94,0)
 .I PSBSCHT="C",PSBOTYP="U" Q:'$$OKAY^PSBVDLU1(PSBOST,PSBODATE,PSBSCH,PSBONX,PSBOITX,PSBFREQ,)
"RTN","PSBODL",95,0)
 .I PSBSCHT="C",$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH),'$$OKAY^PSBVDLU1(PSBOST,PSBODATE,PSBSCH,PSBONX,PSBOITX,PSBFREQ) Q
"RTN","PSBODL",96,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBODL",97,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBODL",98,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBODL",99,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBODL",100,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBODL",101,0)
 .S PSBRMN=1
"RTN","PSBODL",102,0)
 .I PSBSCHT="O",PSBOST'=PSBOSP,PSBOSP<PSBOSTRT S PSBRMN=0
"RTN","PSBODL",103,0)
 .Q:'PSBRMN
"RTN","PSBODL",104,0)
 .I PSBOST>$$FMADD^XLFDT(PSBNOW,"","",+($$GET^XPAR("DIV","PSB ADMIN BEFORE"))) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE)="" Q
"RTN","PSBODL",105,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBODL",106,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBODL",107,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBODL",108,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBODL",109,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBODL",110,0)
 .S PSBLGDT="",X=""
"RTN","PSBODL",111,0)
 .F  S X=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,X),-1) Q:'X  D  Q:PSBLGDT
"RTN","PSBODL",112,0)
 ..S PSBIEN=""
"RTN","PSBODL",113,0)
 ..F  S PSBIEN=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,X,PSBIEN),-1) Q:PSBIEN=""  D  Q:PSBLGDT
"RTN","PSBODL",114,0)
 ...S:$P($G(^PSB(53.79,PSBIEN,0)),U,9)="G" PSBLGDT=X
"RTN","PSBODL",115,0)
 .S PSBADMIN="" K ^TMP("PSB",$J,"GETADMIN")
"RTN","PSBODL",116,0)
 .I PSBSCHT="C" D  Q:PSBADMIN=""
"RTN","PSBODL",117,0)
 ..S PSBX=PSBADST,PSBFLAG=1
"RTN","PSBODL",118,0)
 ..D:PSBX=""
"RTN","PSBODL",119,0)
 ...I PSBIVT="C",PSBCHEMT="A" S PSBX="0000",PSBFLAG=0
"RTN","PSBODL",120,0)
 ...I PSBIVT="C",PSBISYR=0 S PSBX="0000",PSBFLAG=0
"RTN","PSBODL",121,0)
 ...I PSBIVT="S",PSBISYR'=1 S PSBX="0000",PSBFLAG=0
"RTN","PSBODL",122,0)
 ...I "HA"[PSBIVT S:PSBIVT]"" PSBX="0000",PSBFLAG=0
"RTN","PSBODL",123,0)
 ..I ((PSBIVT="S")!(PSBIVT="C")),(PSBISYR=1) S:+($G(PSBX))=0 PSBX=""
"RTN","PSBODL",124,0)
 ..I (PSBIVT="C"),(PSBCHEMT="P") S:+($G(PSBX))=0 PSBX=""
"RTN","PSBODL",125,0)
 ..I PSBOTYP="U",PSBX="0000" S PSBX=""
"RTN","PSBODL",126,0)
 ..I PSBIVT="P" S:+($G(PSBX))=0 PSBX=""
"RTN","PSBODL",127,0)
 ..I PSBX="" S:($G(PSBFREQ)>29)!(PSBFREQ="D") PSBX=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBEVDT)
"RTN","PSBODL",128,0)
 ..E  S ^TMP("PSB",$J,"GETADMIN",0)=PSBX
"RTN","PSBODL",129,0)
 ..D:PSBX'=""
"RTN","PSBODL",130,0)
 ...F PSBXX=0:1 Q:'$D(^TMP("PSB",$J,"GETADMIN",PSBXX))  S PSBX=$G(^TMP("PSB",$J,"GETADMIN",PSBXX)) D
"RTN","PSBODL",131,0)
 ....F PSBY=1:1:$L(PSBX,"-")  D
"RTN","PSBODL",132,0)
 .....S PSBAT=+(PSBODATE_"."_$P(PSBX,"-",PSBY))
"RTN","PSBODL",133,0)
 .....I PSBFLAG Q:PSBAT<PSBOSTRT!(PSBAT>PSBOSTOP)
"RTN","PSBODL",134,0)
 .....D VAL^PSBMLVAL(.PSBZ,DFN,PSBON,PSBOTYP,PSBAT)
"RTN","PSBODL",135,0)
 .....I (PSBZ(0)<0)&(PSBCNT=1) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE,PSBAT)="" Q
"RTN","PSBODL",136,0)
 .....;I (PSBOST>PSBOSTRT),(PSBORD'["P"),('PSBFLAG) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE,PSBAT)="" Q
"RTN","PSBODL",137,0)
 .....I (PSBAT'["."),($G(PSBORD)["V") I (PSBOST<PSBOSTOP),(PSBOST'<PSBOSTRT) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE,PSBAT)="" Q
"RTN","PSBODL",138,0)
 .....Q:+PSBZ(0)<0
"RTN","PSBODL",139,0)
 .....I $G(PSBOST)'>$G(PSBAT) S PSBADMIN=PSBADMIN_$S(PSBADMIN]"":"-",1:"")_$P(PSBX,"-",PSBY)
"RTN","PSBODL",140,0)
 .....E  I ($P($G(PSBOST),".")'>$P($G(PSBAT),"."))&($P($G(PSBAT),".",2)="") S PSBADMIN=PSBADMIN_$S(PSBADMIN]"":"-",1:"")_$P(PSBX,"-",PSBY)
"RTN","PSBODL",141,0)
 ..I +$G(PSBFREQ)>0,$G(PSBFREQ)<30,PSBADMIN'="0000" S PSBADMIN="Due every "_$G(PSBFREQ)_" minutes."
"RTN","PSBODL",142,0)
 .I $Y>(IOSL-(12+($L(PSBADMIN)/27))) W !?(IOM-36\2),"(Medications Continued on Next Page)",$$FTR(),$$HDR()
"RTN","PSBODL",143,0)
 .I PSBSM S PSBSM=$S(PSBSMX:"H",1:"")_"SM"
"RTN","PSBODL",144,0)
 .E  S PSBSM=""
"RTN","PSBODL",145,0)
 .W !,$J(PSBSM,3),?6,PSBTYPE,$E(PSBSCHT,1,4),?12 S PSBWFLAG=1
"RTN","PSBODL",146,0)
 .S X="",Y=0
"RTN","PSBODL",147,0)
 .W $$WRAP(14,34,PSBMED)
"RTN","PSBODL",148,0)
 .S PSBADM="Give: "_PSBDOSE_"  "_PSBSCH
"RTN","PSBODL",149,0)
 .W $$WRAP(50,27,PSBADM),?78,PSBMRAB
"RTN","PSBODL",150,0)
 .W ?85 D:PSBLGDT
"RTN","PSBODL",151,0)
 ..W $E(PSBLGDT,4,5),"/",$E(PSBLGDT,6,7),"/",$E(PSBLGDT,2,3),"@",$E($P(PSBLGDT,".",2)_"0000",1,4)
"RTN","PSBODL",152,0)
 .W ?100,$P($TR($$FMTE^XLFDT(PSBOST,2),"@"," ")," "),?110,$P($TR($$FMTE^XLFDT(PSBOSP,2),"@"," ")," "),?120,$S(PSBVPHI]"":PSBVPHI,1:"***"),"/"
"RTN","PSBODL",153,0)
 .W $S(PSBVNI]"":PSBVNI,1:"***"),!,?100,"@"_$P(PSBOSTX,"  ",2),?110,"@"_$P(PSBOSPX,"  ",2)
"RTN","PSBODL",154,0)
 .W IOINHI
"RTN","PSBODL",155,0)
 .I $D(PSBDDA) S Y=0 F  S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBODL",156,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<PSBNOW)
"RTN","PSBODL",157,0)
 ..W !?14,"*",$$WRAP(15,33,$P(PSBDDA(Y),U,3)_" ("_+$P(PSBDDA(Y),U,2)_")")
"RTN","PSBODL",158,0)
 .I $D(PSBADA) S Y=0 F  S Y=$O(PSBADA(Y)) Q:'Y  W !?14,"*",$$WRAP(15,33,$P(PSBADA(Y),U,3)_" ("_$P(PSBADA(Y),U,4)_")")
"RTN","PSBODL",159,0)
 .I $D(PSBSOLA) S Y=0 F  S Y=$O(PSBSOLA(Y)) Q:'Y  W !?14,"*",$$WRAP(15,33,$P(PSBSOLA(Y),U,3)_" ("_$P(PSBSOLA(Y),U,4)_")")
"RTN","PSBODL",160,0)
 .W IOINORM ; Hlight Off
"RTN","PSBODL",161,0)
 .S PSBADM=$S(PSBADMIN]"":"Admin Times: "_PSBADMIN,1:"")
"RTN","PSBODL",162,0)
 .W:PSBADM]"" $$WRAP(50,27,PSBADM)
"RTN","PSBODL",163,0)
 .S X=$S(PSBOTXT]"":PSBOTXT,1:"<None Entered>")
"RTN","PSBODL",164,0)
 .I $E(X,1)="!"  S $E(X,1)=""
"RTN","PSBODL",165,0)
 .W $$WRAP(14,34,"Spec Inst: "_X),!,$TR($J("",IOM)," ","-")
"RTN","PSBODL",166,0)
 I '$G(PSBWFLAG) W !!,?10,"** NO SPECIFIED MEDICATIONS TO PRINT **"
"RTN","PSBODL",167,0)
 W $$BLANKS(),$$FTR()
"RTN","PSBODL",168,0)
 S PSBORD=$O(^TMP("PSBO",$J,DFN,""),-1)
"RTN","PSBODL",169,0)
 I +$G(PSBORD)>0,$P(PSBRPT(.4),U,1),$D(^TMP("PSBO",$J,DFN,PSBORD)) D EN^PSBODL1
"RTN","PSBODL",170,0)
 Q
"RTN","PSBODL",171,0)
WRAP(X,Y,Z) ;
"RTN","PSBODL",172,0)
 F  Q:'$L(Z)  D
"RTN","PSBODL",173,0)
 .W:$X>X !
"RTN","PSBODL",174,0)
 .W:$X<X ?X
"RTN","PSBODL",175,0)
 .I $L(Z)<Y W Z S Z="" Q
"RTN","PSBODL",176,0)
 .F PSB=Y:-1:0 Q:$E(Z,PSB)=" "
"RTN","PSBODL",177,0)
 .S:PSB<1 PSB=Y
"RTN","PSBODL",178,0)
 .W $E(Z,1,PSB)
"RTN","PSBODL",179,0)
 .S Z=$E(Z,PSB+1,255)
"RTN","PSBODL",180,0)
 Q ""
"RTN","PSBODL",181,0)
FTR() ;
"RTN","PSBODL",182,0)
 I (IOSL<100) F  Q:$Y>(IOSL-10)  W !
"RTN","PSBODL",183,0)
 W !,$TR($J("",IOM)," ","=")
"RTN","PSBODL",184,0)
 S X="Ward: "_PSBHDR("WARD")_"  Room-Bed: "_PSBHDR("ROOM")
"RTN","PSBODL",185,0)
 W !,PSBHDR("NAME"),?(IOM-11\2),PSBHDR("SSN"),?(IOM-$L(X)),X
"RTN","PSBODL",186,0)
 Q ""
"RTN","PSBODL",187,0)
HDR() ;
"RTN","PSBODL",188,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBODL",189,0)
 W !,"Self",?85,"Last",?100,"Start",?110,"Stop",?120,"Verifying"
"RTN","PSBODL",190,0)
 W !,"Med",?6,"Sched",?14,"Medication",?50,"Dose",?78,"Route",?85,"Given",?100,"Date",?110,"Date",?120,"Rph/Rn"
"RTN","PSBODL",191,0)
 W !,?100,"@Time",?110,"@Time"
"RTN","PSBODL",192,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBODL",193,0)
 Q ""
"RTN","PSBODL",194,0)
BLANKS() ;
"RTN","PSBODL",195,0)
 Q:'$P(PSBRPT(.2),U,5) ""
"RTN","PSBODL",196,0)
 W !
"RTN","PSBODL",197,0)
 D:$Y>(IOSL-26)
"RTN","PSBODL",198,0)
 .W ?(IOM-42\2),"(Changes/Addendums to Orders on Next Page)"
"RTN","PSBODL",199,0)
 .W $$FTR(),$$HDR() ; New page - no room for blanks
"RTN","PSBODL",200,0)
 I IOSL<100 F  Q:$Y>(IOSL-26)  W !
"RTN","PSBODL",201,0)
 W ?(IOM-28\2),"Changes/Addendums to orders"
"RTN","PSBODL",202,0)
 F X=1:1:4 D
"RTN","PSBODL",203,0)
 .W !,$TR($J("",IOM)," ","-")
"RTN","PSBODL",204,0)
 .W !!?3,"CON ___ PRN ___"
"RTN","PSBODL",205,0)
 .W ?20,"Drug: ",$TR($J("",22)," ","_")
"RTN","PSBODL",206,0)
 .W ?50,"Give: ",$TR($J("",42)," ","_")
"RTN","PSBODL",207,0)
 .W ?100,"Start: _________ Stop: _________"
"RTN","PSBODL",208,0)
 .W !?20,"Spec"
"RTN","PSBODL",209,0)
 .W !?3,"OT  ___ OC  ___"
"RTN","PSBODL",210,0)
 .W ?20,"Inst: ",$TR($J("",72)," ","_")
"RTN","PSBODL",211,0)
 .W ?100,"Initials: ______ Date: _________"
"RTN","PSBODL",212,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBODL",213,0)
 Q ""
"RTN","PSBODO")
0^4^B9968689^B9835055
"RTN","PSBODO",1,0)
PSBODO ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBODO",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,21,24,38**;Mar 2004;Build 8
"RTN","PSBODO",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBODO",4,0)
 ;
"RTN","PSBODO",5,0)
 ; Reference/IA
"RTN","PSBODO",6,0)
 ; EN^PSJBCMA2/2830
"RTN","PSBODO",7,0)
EN ;
"RTN","PSBODO",8,0)
 ;
"RTN","PSBODO",9,0)
 ; Description:
"RTN","PSBODO",10,0)
 ; Returns a display for a selected order when double clicked on the VDL
"RTN","PSBODO",11,0)
 ;
"RTN","PSBODO",12,0)
 N PSBGBL,DFN
"RTN","PSBODO",13,0)
 S PSBGBL=$NAME(^TMP("PSBO",$J,"B"))
"RTN","PSBODO",14,0)
 F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'=$J  Q:$QS(PSBGBL,1)'["PSBO"  D
"RTN","PSBODO",15,0)
 .S DFN=$QS(PSBGBL,5)
"RTN","PSBODO",16,0)
 .D DISPORD
"RTN","PSBODO",17,0)
 Q
"RTN","PSBODO",18,0)
 ;
"RTN","PSBODO",19,0)
DISPORD ;
"RTN","PSBODO",20,0)
 N PSBGBL,PSBOI,PSBHDR,PSJGLO
"RTN","PSBODO",21,0)
 S PSBOI=$$GET1^DIQ(53.69,PSBRPT_",",.09)
"RTN","PSBODO",22,0)
 D EN^PSJBCMA2(DFN,PSBOI)
"RTN","PSBODO",23,0)
 S PSJGLO="^TMP(""PSJ"""_","_$J
"RTN","PSBODO",24,0)
 D CLEAN^PSBVT
"RTN","PSBODO",25,0)
 D PSJ1^PSBVT(DFN,PSBOI)
"RTN","PSBODO",26,0)
 S PSBHDR(1)="BCMA - Display Order" D PT^PSBOHDR(DFN,.PSBHDR) W !
"RTN","PSBODO",27,0)
 I '$G(PSBONX) W !,"Invalid Order"
"RTN","PSBODO",28,0)
 D:$G(PSBONX)
"RTN","PSBODO",29,0)
 .W !,"Orderable Item: ",PSBOITX
"RTN","PSBODO",30,0)
 .I PSBONX["V" W !,"Infusion Rate:  ",PSBIFR
"RTN","PSBODO",31,0)
 .I PSBONX'["V" W !,"Dosage Ordered: ",PSBDOSE
"RTN","PSBODO",32,0)
 .W ?40,"Start:    ",PSBOSTX
"RTN","PSBODO",33,0)
 .W !?40,"Stop:     ",PSBOSPX
"RTN","PSBODO",34,0)
 .W !,"Med Route:      ",PSBMR
"RTN","PSBODO",35,0)
 .W !,"Schedule Type:  ",PSBSCHTX
"RTN","PSBODO",36,0)
 .I PSBONX'["V" W ?40,"Self Med: ",PSBSMX
"RTN","PSBODO",37,0)
 .W:PSBSM !?40,"Hosp Sup: ",PSBSMX
"RTN","PSBODO",38,0)
 .W:PSBSCH'="" !,"Schedule: ",PSBSCH
"RTN","PSBODO",39,0)
 .I PSBONX'["V" W !,"Admin Times:    ",PSBADST
"RTN","PSBODO",40,0)
 .I PSBONX["V",((PSBIVT="P")!(PSBISYR=1)) W !,"Admin Times:    ",PSBADST
"RTN","PSBODO",41,0)
 .W !,"Provider: ",PSBMDX
"RTN","PSBODO",42,0)
 .I $E(PSBOTXT,1)="!"  S $E(PSBOTXT,1)=""
"RTN","PSBODO",43,0)
 .W !,"Spec Inst:      ",PSBOTXT
"RTN","PSBODO",44,0)
 .W !
"RTN","PSBODO",45,0)
 .I $D(PSBDDA(1)) D
"RTN","PSBODO",46,0)
 ..W !,"Dispense Drugs",!,"Drug Name",?40,"Units",?50,"Inactive Date"
"RTN","PSBODO",47,0)
 ..W !,$TR($J("",75)," ","-")
"RTN","PSBODO",48,0)
 ..F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBODO",49,0)
 ...S X=$P(PSBDDA(Y),U,4)
"RTN","PSBODO",50,0)
 ...W !,$P(PSBDDA(Y),U,3),?40,$S(X]"":X,1:1)
"RTN","PSBODO",51,0)
 ...S X=$P(PSBDDA(Y),U,5) Q:'X
"RTN","PSBODO",52,0)
 ...W ?50,$E(X,4,5),"/",$E(X,6,7),"/",(1700+$E(X,1,3))
"RTN","PSBODO",53,0)
 .I $D(PSBADA(1)) D
"RTN","PSBODO",54,0)
 ..W !!,"Additives",!,"Name",?40,"Strength"
"RTN","PSBODO",55,0)
 ..W !,$TR($J("",75)," ","-")
"RTN","PSBODO",56,0)
 ..F Y=0:0 S Y=$O(PSBADA(Y)) Q:'Y  D
"RTN","PSBODO",57,0)
 ...W !,$P(PSBADA(Y),U,3),?40,$P(PSBADA(Y),U,4)
"RTN","PSBODO",58,0)
 .I $D(PSBSOLA(1)) D
"RTN","PSBODO",59,0)
 ..W !!,"Solution",!,"Name",?40,"Volume"
"RTN","PSBODO",60,0)
 ..W !,$TR($J("",75)," ","-")
"RTN","PSBODO",61,0)
 ..F Y=0:0 S Y=$O(PSBSOLA(Y)) Q:'Y  D
"RTN","PSBODO",62,0)
 ...W !,$P(PSBSOLA(Y),U,3),?40,$P(PSBSOLA(Y),U,4)
"RTN","PSBODO",63,0)
 .I $P(@(PSJGLO_","_0_")"),U,1)'=-1 D
"RTN","PSBODO",64,0)
 ..W !,$TR($J("",75)," ","-")
"RTN","PSBODO",65,0)
 ..W !,"Pharmacy Activity Log: "
"RTN","PSBODO",66,0)
 ..F I=1:1:$P(@(PSJGLO_","_0_")"),U,4) D
"RTN","PSBODO",67,0)
 ...W !?9,"Date:  ",$$FMTE^XLFDT($P(@(PSJGLO_","_I_","_1_")"),U,1)),?35,"User:  ",$P(@(PSJGLO_","_I_","_1_")"),U,2)
"RTN","PSBODO",68,0)
 ...W !?5,"Activity:  ",$P(@(PSJGLO_","_I_","_1_")"),U,4)
"RTN","PSBODO",69,0)
 ...I $D(@(PSJGLO_","_I_","_2_")")) W !?8,"Field:  ",$P(@(PSJGLO_","_I_","_1_")"),U,3),!?5,"Old Data:  ",@(PSJGLO_","_I_","_2_")")
"RTN","PSBODO",70,0)
 ...I $D(@(PSJGLO_","_I_","_3_")")) W !?7,"Reason:  ",@(PSJGLO_","_I_","_3_")")
"RTN","PSBODO",71,0)
 ...W !
"RTN","PSBODO",72,0)
 W !!
"RTN","PSBODO",73,0)
 D CLEAN^PSBVT K @(PSJGLO_")")
"RTN","PSBODO",74,0)
 Q
"RTN","PSBOMH")
0^9^B79507789^B78896723
"RTN","PSBOMH",1,0)
PSBOMH ;BIRMINGHAM/EFC-MAH ;Mar 2004
"RTN","PSBOMH",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,9,38**;Mar 2004;Build 8
"RTN","PSBOMH",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOMH",4,0)
 ;
"RTN","PSBOMH",5,0)
 ; Reference/IA
"RTN","PSBOMH",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBOMH",7,0)
 ; EN^PSJBCMA2/2830
"RTN","PSBOMH",8,0)
 ; File 200/10060
"RTN","PSBOMH",9,0)
 ; ^DIWP/10011
"RTN","PSBOMH",10,0)
 ;
"RTN","PSBOMH",11,0)
EN ; Called from DQ^PSBO
"RTN","PSBOMH",12,0)
 N PSBGBL,DFN
"RTN","PSBOMH",13,0)
 S PSBGBL=$NAME(^TMP("PSBO",$J,"B"))
"RTN","PSBOMH",14,0)
 F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'=$J  Q:$QS(PSBGBL,1)'["PSBO"  D
"RTN","PSBOMH",15,0)
 .S DFN=$QS(PSBGBL,5)
"RTN","PSBOMH",16,0)
 .S (PSBSTRT,X)=$P(PSBRPT(.1),U,6) D H^%DTC S PSBSTH=%H
"RTN","PSBOMH",17,0)
 .S (PSBSTOP,X)=$P(PSBRPT(.1),U,8)+.235959 D H^%DTC S PSBSPH=%H
"RTN","PSBOMH",18,0)
 .S PSBCNT=0 F I=PSBSTH:1:PSBSPH S PSBAR(I)=PSBSTH+((PSBCNT\7)*7),PSBCNT=PSBCNT+1
"RTN","PSBOMH",19,0)
 .D EN1
"RTN","PSBOMH",20,0)
 K PSBCNT,PSBAR Q
"RTN","PSBOMH",21,0)
EN1 ; Expects DFN,STRT,STOP
"RTN","PSBOMH",22,0)
 N PSBGBL,PSBHDR,PSBX,PSBFLAG
"RTN","PSBOMH",23,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBOMH",24,0)
 S PSBEVDT=PSBSTRT
"RTN","PSBOMH",25,0)
 D EN^PSJBCMA(DFN,PSBSTRT)
"RTN","PSBOMH",26,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 D PT^PSBOHDR(DFN,.PSBHDR) W !!,"****NO MEDICATIONS FOUND****" Q  ; No Ord
"RTN","PSBOMH",27,0)
 S PSBX=""
"RTN","PSBOMH",28,0)
 F  S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:PSBX=""  D
"RTN","PSBOMH",29,0)
 .Q:$P(^TMP("PSJ",$J,PSBX,0),U,3)?.N1"P"  ; No Pnd
"RTN","PSBOMH",30,0)
 .Q:$P(^TMP("PSJ",$J,PSBX,1),U,5)<PSBSTRT!($P(^TMP("PSJ",$J,PSBX,1),U,4)>PSBSTOP)  ;display orders active in date range of report
"RTN","PSBOMH",31,0)
 .S X=$P(^TMP("PSJ",$J,PSBX,1),U,2)
"RTN","PSBOMH",32,0)
 .S ^TMP("PSB",$J,"ORDERS",$P(^TMP("PSJ",$J,PSBX,0),U,3))=X
"RTN","PSBOMH",33,0)
 I '$D(^TMP("PSB",$J,"ORDERS")) D PT^PSBOHDR(DFN,.PSBHDR) W !!,"****NO MEDICATIONS FOUND****" Q    ; No Orders
"RTN","PSBOMH",34,0)
 S PSBMHND="PSBOMH"
"RTN","PSBOMH",35,0)
 ; Act on Orders
"RTN","PSBOMH",36,0)
 S PSBX="" F  S PSBX=$O(^TMP("PSB",$J,"ORDERS",PSBX)) Q:PSBX=""  S PSBTYPE=^(PSBX) D
"RTN","PSBOMH",37,0)
 .S:PSBTYPE'="C" PSBTYPE="P"
"RTN","PSBOMH",38,0)
 .D CLEAN^PSBVT
"RTN","PSBOMH",39,0)
 .D PSJ1^PSBVT(DFN,PSBX)
"RTN","PSBOMH",40,0)
 .S X1=((PSBEVDT)\1)  S X2=-1  D C^%DTC  S PSBCNTST=X
"RTN","PSBOMH",41,0)
 .S X1=((PSBSTOP)\1)  S X2=1  D C^%DTC  S PSBXSTOP=X
"RTN","PSBOMH",42,0)
 .S PSBVALB=""
"RTN","PSBOMH",43,0)
 .S PSBVALB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH)
"RTN","PSBOMH",44,0)
 .S PSBZ=""
"RTN","PSBOMH",45,0)
 .S X1=PSBXSTOP,X2=PSBCNTST D ^%DTC S PSBNCT=X
"RTN","PSBOMH",46,0)
 .F PSBZ=1:1:PSBNCT S X1=PSBCNTST  S X2=1  D C^%DTC  S PSBCNTST=X  D
"RTN","PSBOMH",47,0)
 ..I (PSBX["V")!(PSBX'["V")  D
"RTN","PSBOMH",48,0)
 ...I PSBCNTST'>(PSBOST\1) S ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST)=""
"RTN","PSBOMH",49,0)
 ...I PSBCNTST=(PSBOST\1)!($G(^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST))) K ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST)
"RTN","PSBOMH",50,0)
 ...I PSBCNTST>(PSBOSP\1) S ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST)=""
"RTN","PSBOMH",51,0)
 ...I PSBCNTST=(PSBOSP\1)&($G(^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST))) K ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST) S ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST)=""
"RTN","PSBOMH",52,0)
 ..S PSBDODD=""
"RTN","PSBOMH",53,0)
 ..I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBDODD=1
"RTN","PSBOMH",54,0)
 ..I ((PSBX'["V")!(PSBVALB="1")),((PSBDODD="1")&(PSBADST'="")) S ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST)=""
"RTN","PSBOMH",55,0)
 ..I ((PSBX'["V")!(PSBVALB="1")),('$$OKAY^PSBVDLU1(PSBOST,PSBCNTST,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)) S ^TMP("PSB",$J,"ORDERS",PSBONX,"NTDUE",PSBCNTST)=""  ;W t TMP
"RTN","PSBOMH",56,0)
 .S (PSBYES,PSBODD,PSBFLAG,PSBYTFN,PSBDAYN)=0
"RTN","PSBOMH",57,0)
 .S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1,PSBDAYN=1
"RTN","PSBOMH",58,0)
 .I PSBYES,PSBADST="",PSBSCHT'="O",PSBSCHT'="OC",PSBSCHT'="P" Q 
"RTN","PSBOMH",59,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTFN=1
"RTN","PSBOMH",60,0)
 .I (PSBFREQ="O")!(PSBTYPE="P") S PSBYES=1
"RTN","PSBOMH",61,0)
 .I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBOMH",62,0)
 .;flg / admn t
"RTN","PSBOMH",63,0)
 .S:PSBONX["U" PSBFLAG=1
"RTN","PSBOMH",64,0)
 .I PSBIVT="A" S PSBADST="0000"
"RTN","PSBOMH",65,0)
 .I PSBIVT="H" S PSBADST="0000"
"RTN","PSBOMH",66,0)
 .I PSBIVT="C",PSBCHEMT="P" S:PSBADST="" PSBFLAG=1
"RTN","PSBOMH",67,0)
 .I PSBIVT="C",PSBISYR=1 S:PSBADST="" PSBFLAG=1
"RTN","PSBOMH",68,0)
 .I PSBIVT="C",PSBCHEMT="A" S PSBADST="0000"
"RTN","PSBOMH",69,0)
 .I PSBIVT="C",PSBISYR=0 S PSBADST="0000"
"RTN","PSBOMH",70,0)
 .I PSBIVT="P",($G(PSBADST)=0) S:PSBADST="" PSBFLAG=1
"RTN","PSBOMH",71,0)
 .I PSBIVT="P" S:PSBADST="" PSBFLAG=1
"RTN","PSBOMH",72,0)
 .I PSBIVT="S",PSBISYR=0 S PSBADST="0000"
"RTN","PSBOMH",73,0)
 .I PSBIVT="S",PSBISYR=1 S:PSBADST="" PSBFLAG=1
"RTN","PSBOMH",74,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBOMH",75,0)
 .I 'PSBYES,PSBADST="",PSBFREQ<1 Q
"RTN","PSBOMH",76,0)
 .S (PSBEE,PSBZZ)=0
"RTN","PSBOMH",77,0)
 .I (PSBVALB="1")!(PSBX'["V") D  Q:(PSBEE!PSBZZ)=1
"RTN","PSBOMH",78,0)
 ..I PSBSCHT="C",PSBYTFN="1",PSBADST=""  S PSBEE=1
"RTN","PSBOMH",79,0)
 ..I PSBSCHT="C",PSBDAYN'="1",PSBYTFN'="1",PSBADST'="",PSBFREQ<1  S PSBZZ=1
"RTN","PSBOMH",80,0)
 .I 'PSBODD,PSBFLAG,PSBTYPE="C",PSBADST="" S PSBADST=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBSTOP)
"RTN","PSBOMH",81,0)
 .E  I PSBADST'="" K ^TMP("PSB",$J,"GETADMIN") S ^TMP("PSB",$J,"GETADMIN",0)=PSBADST
"RTN","PSBOMH",82,0)
 .;Calc adm/frq
"RTN","PSBOMH",83,0)
 .S PSBDT=PSBSTRT
"RTN","PSBOMH",84,0)
 .K PSBO,^UTILITY($J)
"RTN","PSBOMH",85,0)
 .F X=1:1:8 S PSBO(X)=""
"RTN","PSBOMH",86,0)
 .S DIWL=0,DIWR=32,DIWF="C32"
"RTN","PSBOMH",87,0)
 .S X=$P(PSBOSTX," ")_"          "_$P(PSBOSPX," ") D ^DIWP
"RTN","PSBOMH",88,0)
 .S X="@"_$P(PSBOSTX," ",3)_"              @"_$P(PSBOSPX," ",3)_"   " D ^DIWP
"RTN","PSBOMH",89,0)
 .S X="" D ^DIWP
"RTN","PSBOMH",90,0)
 .S X=PSBOITX D ^DIWP
"RTN","PSBOMH",91,0)
 .; DD,SOL,ADD
"RTN","PSBOMH",92,0)
 .S X=""
"RTN","PSBOMH",93,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  S X=X_$S(X]"":", ",1:"")_$P(PSBDDA(Y),U,3)
"RTN","PSBOMH",94,0)
 .F Y=0:0 S Y=$O(PSBADA(Y)) Q:'Y  S X=X_$S(X]"":", ",1:"")_$P(PSBADA(Y),U,3)_" "_$P(PSBADA(Y),U,4)_$P(PSBADA(Y),U,5)
"RTN","PSBOMH",95,0)
 .F Y=0:0 S Y=$O(PSBSOLA(Y)) Q:'Y  S X=X_$S(X]"":", ",1:"")_$P(PSBSOLA(Y),U,3)_" "_$P(PSBSOLA(Y),U,4)
"RTN","PSBOMH",96,0)
 .S X=" "_X,DIWF="I2C32" D ^DIWP S DIWF="C32"
"RTN","PSBOMH",97,0)
 .S PSBTXT=" Give: "_PSBDOSE_" "_PSBMRAB_" "_PSBSCH_" "_PSBIFR
"RTN","PSBOMH",98,0)
 .F  S PSBWORD=$P(PSBTXT," ",1),PSBTXT=$P(PSBTXT," ",2,250) D  Q:PSBTXT=""
"RTN","PSBOMH",99,0)
 ..F  Q:'$L(PSBWORD)  S X=$E(PSBWORD,1,30),PSBWORD=$E(PSBWORD,30,250) D ^DIWP
"RTN","PSBOMH",100,0)
 .K ^TMP("PSJ",$J) D EN^PSJBCMA2(DFN,PSBX) I ^TMP("PSJ",$J,0)'=-1 D   ;get activity log
"RTN","PSBOMH",101,0)
 ..S (PSBDISX,PSBHLDX)=0 F I=1:1:$P(^TMP("PSJ",$J,0),U,4) S X=$G(^TMP("PSJ",$J,I,1)) D  ;loop activities
"RTN","PSBOMH",102,0)
 ...Q:X["EDITED"!(X["VERIF")  ;
"RTN","PSBOMH",103,0)
 ...S Z=0
"RTN","PSBOMH",104,0)
 ...I X'["OFF HOLD",X'["UNHOLD",X'["REINSTATE" S Z=1 ; inc iv's
"RTN","PSBOMH",105,0)
 ...S PSBHLDX=PSBHLDX+$S(Z>0:1,1:0)
"RTN","PSBOMH",106,0)
 ...S $P(PSBHLD(PSBHLDX),U,$S(Z>0:1,1:11))=^TMP("PSJ",$J,I,1)  ;set up for multiple on hold entries save start & stop as pair if exists 
"RTN","PSBOMH",107,0)
 ..F PSBHLDX=1:1 S X=$G(PSBHLD(PSBHLDX)) Q:'X  D  ;if a hold index - process 
"RTN","PSBOMH",108,0)
 ...S PSBHLDN=$P(PSBHLD(PSBHLDX),U,1),PSBHLDF=$P(PSBHLD(PSBHLDX),U,11)  ;get on/off hold, dates, IEN number(for UD orders) of person. 
"RTN","PSBOMH",109,0)
 ...Q:PSBHLDN>PSBSTOP  Q:(PSBHLDF<PSBSTRT)&(PSBHLDF'="") 
"RTN","PSBOMH",110,0)
 ...F PSBHLDT=PSBSTRT\1:1:PSBSTOP\1 I (PSBHLDT'<(PSBHLDN\1)),(PSBHLDT'>PSBSTOP) D
"RTN","PSBOMH",111,0)
 ....I X["DISCONTINUED" K ^TMP("PSB",$J,"ORDERS",PSBONX,"HOLD",PSBHLDT) S ^TMP("PSB",$J,"ORDERS",PSBONX,"DISC",PSBHLDT)=""
"RTN","PSBOMH",112,0)
 ....I (X["HOLD")&((PSBHLDN\1)'>PSBHLDT)&((PSBHLDF'<PSBHLDT)!(PSBHLDF="")) S ^TMP("PSB",$J,"ORDERS",PSBONX,"HOLD",PSBHLDT)=""
"RTN","PSBOMH",113,0)
 ....I X["REINSTATE" K ^TMP("PSB",$J,"ORDERS",PSBONX,"DISC",PSBHLDT) I PSBOSTS="H" S ^TMP("PSB",$J,"ORDERS",PSBONX,"HOLD",PSBHLDT)=""
"RTN","PSBOMH",114,0)
 ...F PSBHLDXP=1:10:$P(PSBHLD(PSBHLDX),U,11)]""+10 D
"RTN","PSBOMH",115,0)
 ....S PSBDESC=$P(PSBHLD(PSBHLDX),U,PSBHLDXP+3),X=$S(PSBDESC["DISCONTINUE":"***",1:"")
"RTN","PSBOMH",116,0)
 ....S X=" "_X_PSBDESC D ^DIWP  ;output activity text 
"RTN","PSBOMH",117,0)
 ....S X="",PSBHLDI=$P(PSBHLD(PSBHLDX),U,PSBHLDXP+4) I PSBHLDI'="" S X=$$GET1^DIQ(200,PSBHLDI,"INITIAL")
"RTN","PSBOMH",118,0)
 ....S:X="" X="99" ;no init present
"RTN","PSBOMH",119,0)
 ....I X'="99" S X=" "_X D ^DIWP   ;get init & store
"RTN","PSBOMH",120,0)
 ....S Y=$P(PSBHLD(PSBHLDX),U,PSBHLDXP) D DD^%DT S X=Y D ^DIWP  ;format hold date / write 
"RTN","PSBOMH",121,0)
 ..K PSBHLD,PSBHLDF,PSBHLDN,PSBHLDT,PSBHLDX,PSBHLDXP,PSBHLDI,PSBDISX,PSBDISC,PSBDISXP,PSBDISI,PSBDIST,PSBDISN,PSBDESC
"RTN","PSBOMH",122,0)
 .I PSBOTXT]"" D
"RTN","PSBOMH",123,0)
 ..I $E(PSBOTXT,1)="!"  S $E(PSBOTXT,1)=""
"RTN","PSBOMH",124,0)
 ..S PSBOTXT=" Spec Inst: "_PSBOTXT
"RTN","PSBOMH",125,0)
 ..F  S PSBWORD=$P(PSBOTXT," ",1),PSBOTXT=$P(PSBOTXT," ",2,250) D  Q:PSBOTXT=""
"RTN","PSBOMH",126,0)
 ...F  Q:'$L(PSBWORD)  S X=$E(PSBWORD,1,30),PSBWORD=$E(PSBWORD,30,250) D ^DIWP
"RTN","PSBOMH",127,0)
 .F X=0:0 S X=$O(^UTILITY($J,"W",0,X)) Q:'X  S PSBO(X)=$G(^(X,0)) D
"RTN","PSBOMH",128,0)
 .S X=$O(PSBO(""),-1) S X=$S(X<8:8,1:X+1)
"RTN","PSBOMH",129,0)
 .S PSBO(X)=" RPH: "_PSBVPHI_"  RN: "_PSBVNI
"RTN","PSBOMH",130,0)
 .S PSBVAL=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH)
"RTN","PSBOMH",131,0)
 .I PSBODD="1",PSBADST'="" D
"RTN","PSBOMH",132,0)
 ..I (PSBVAL="1")!(PSBX'["V") D   ;checks iv/pb and u dose
"RTN","PSBOMH",133,0)
 ...S PSBO(X+1)=""
"RTN","PSBOMH",134,0)
 ...S PSBO(X+2)="NOTE - ODD SCHEDULE NO LONGER",PSBO(X+3)="       ALLOWS ADMIN TIMES."
"RTN","PSBOMH",135,0)
 .K ^UTILITY($J)
"RTN","PSBOMH",136,0)
 .M ^TMP("PSB",$J,"ORDERS",PSBX,"INST")=PSBO
"RTN","PSBOMH",137,0)
 .D:PSBTYPE="C"
"RTN","PSBOMH",138,0)
 ..F  D  Q:PSBDT>PSBSTOP
"RTN","PSBOMH",139,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=%H
"RTN","PSBOMH",140,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBONX)=""
"RTN","PSBOMH",141,0)
 ...; Odd schd - msg
"RTN","PSBOMH",142,0)
 ...S PSBIDOW=0 I PSBONX["U"!("PCS"[PSBIVT) S PSBIDOW=1
"RTN","PSBOMH",143,0)
 ...I PSBADST="",PSBIDOW,(PSBODD) D
"RTN","PSBOMH",144,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",0)=7
"RTN","PSBOMH",145,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",1)="odd"
"RTN","PSBOMH",146,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",2)="sched"
"RTN","PSBOMH",147,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",3)=$E(PSBSCH,1,5)
"RTN","PSBOMH",148,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",4)="no"
"RTN","PSBOMH",149,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",5)="fixed"
"RTN","PSBOMH",150,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",6)="admin"
"RTN","PSBOMH",151,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",7)="times"
"RTN","PSBOMH",152,0)
 ...I PSBADST'="",PSBADST'="0000",+$G(PSBFREQ)>0,+$G(PSBFREQ)<45 D
"RTN","PSBOMH",153,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",0)=5
"RTN","PSBOMH",154,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",1)="Due"
"RTN","PSBOMH",155,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",2)="every"
"RTN","PSBOMH",156,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",3)=$E(PSBFREQ,1,5)
"RTN","PSBOMH",157,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",4)="mins."
"RTN","PSBOMH",158,0)
 ....S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",5)=" "
"RTN","PSBOMH",159,0)
 ...S PSBATCNT=0    ; # times to print...
"RTN","PSBOMH",160,0)
 ...I PSBADST'="",((+$G(PSBFREQ)>44)!(PSBFREQ="")!(PSBADST="0000")) F PSBXX=0:1  Q:$G(^TMP("PSB",$J,"GETADMIN",PSBXX))=""  D
"RTN","PSBOMH",161,0)
 ....S PSBADST2=$G(^TMP("PSB",$J,"GETADMIN",PSBXX))
"RTN","PSBOMH",162,0)
 ....F Y=1:1:$L(PSBADST2,"-") D
"RTN","PSBOMH",163,0)
 .....Q:($P(PSBADST2,"-",Y)'?2N)&($P(PSBADST2,"-",Y)'?4N)  S PSBATCNT=PSBATCNT+1,^TMP("PSB",$J,"ORDERS",PSBONX,"AT",PSBATCNT)=$P(PSBADST2,"-",Y)
"RTN","PSBOMH",164,0)
 ...I PSBADST'="",PSBFREQ>44 S ^TMP("PSB",$J,"ORDERS",PSBONX,"AT",0)=PSBATCNT
"RTN","PSBOMH",165,0)
 ...S ^TMP("PSB",$J,PSBWEEK,"SORT",PSBTYPE,PSBOITX,PSBX)=""
"RTN","PSBOMH",166,0)
 ...F PSBDOW=0:1:6 D  Q:X>(PSBSTOP-1)
"RTN","PSBOMH",167,0)
 ....S %H=PSBWEEK+PSBDOW D YMD^%DTC
"RTN","PSBOMH",168,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBONX,X,0)=0
"RTN","PSBOMH",169,0)
 ....I '$D(^TMP("PSB",$J,PSBWEEK,"HDR",X)) S ^TMP("PSB",$J,PSBWEEK,"HDR",X)=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3))
"RTN","PSBOMH",170,0)
 ...S %H=PSBWEEK+7 D YMD^%DTC S PSBDT=X
"RTN","PSBOMH",171,0)
 .D:PSBTYPE'="C"
"RTN","PSBOMH",172,0)
 ..S X=PSBDT D H^%DTC S PSBWEEK=%H
"RTN","PSBOMH",173,0)
 ..S (^TMP("PSB",$J,PSBWEEK,PSBONX),^TMP("PSB",$J,PSBWEEK,PSBONX,"AT",0))="",^TMP("PSB",$J,PSBWEEK,"SORT",PSBTYPE,PSBOITX,PSBX)=""
"RTN","PSBOMH",174,0)
 D EN^PSBOMH1,EN^PSBOMH2
"RTN","PSBOMH",175,0)
 Q
"RTN","PSBOMH",176,0)
INSTR S PSBINIT=PSBINIT_"*"
"RTN","PSBOMH",177,0)
 S PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.06)
"RTN","PSBOMH",178,0)
 Q
"RTN","PSBOMH",179,0)
 ;
"RTN","PSBOMH1")
0^10^B71636432^B71055237
"RTN","PSBOMH1",1,0)
PSBOMH1 ;BIRMINGHAM/EFC-MAH ;Mar 2004
"RTN","PSBOMH1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,9,11,26,38**;Mar 2004;Build 8
"RTN","PSBOMH1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOMH1",4,0)
 ;
"RTN","PSBOMH1",5,0)
 ; Reference/IA
"RTN","PSBOMH1",6,0)
 ; ^DILF/2054
"RTN","PSBOMH1",7,0)
 ; File 200/10060
"RTN","PSBOMH1",8,0)
 ;
"RTN","PSBOMH1",9,0)
EN ;
"RTN","PSBOMH1",10,0)
 ; Load administrations
"RTN","PSBOMH1",11,0)
 S (PSBORD,PSBIEN,PSBR1,PSBADIEN,PSBABR)="",PSBDT=PSBSTRT
"RTN","PSBOMH1",12,0)
 K PSBTSA
"RTN","PSBOMH1",13,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOMH1",14,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  Q:'$D(^PSB(53.79,PSBIEN))  L +^PSB(53.79,PSBIEN):3 I $P(^PSB(53.79,PSBIEN,0),U,9)]"" D  L -^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",15,0)
 ..Q:'$P($G(^PSB(53.79,PSBIEN,0)),U,6)  ; Bad IEN -no evnt dt
"RTN","PSBOMH1",16,0)
 ..Q:$P(^PSB(53.79,PSBIEN,0),U,9)="N"  ;NGiven
"RTN","PSBOMH1",17,0)
 ..S PSBORD=$P($G(^PSB(53.79,PSBIEN,.1)),U,1)
"RTN","PSBOMH1",18,0)
 ..; Continuous
"RTN","PSBOMH1",19,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="C"
"RTN","PSBOMH1",20,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=PSBAR(%H) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,PSBIEN,0),U,1),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",21,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,6)'=PSBDT,'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH) D  D CLEAN^PSBVT Q  ;chck IV audit
"RTN","PSBOMH1",22,0)
 ....S PSBSIEN=PSBIEN
"RTN","PSBOMH1",23,0)
 ....I $P(^PSB(53.79,PSBIEN,0),"^",10)]"" D BAGDTL^PSBRPC2(.PSBAUD,$P(^PSB(53.79,PSBIEN,0),U,10),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",24,0)
 ....S PSBIEN=PSBSIEN K PSBSIEN
"RTN","PSBOMH1",25,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  I $P(PSBAUD(X),U,3)="" K PSBAUD(X)
"RTN","PSBOMH1",26,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  Q:$P(PSBAUD(X),U,1)=PSBDT
"RTN","PSBOMH1",27,0)
 ....I X="" K PSBAUD Q
"RTN","PSBOMH1",28,0)
 ....I '$D(PSBAUD(X)) K PSBAUD Q
"RTN","PSBOMH1",29,0)
 ....S PSBS=$P(PSBAUD(X),U,3)
"RTN","PSBOMH1",30,0)
 ....I PSBS="GIVEN",$P($G(PSBAUD(X-1)),U,3)="NOT GIVEN" Q
"RTN","PSBOMH1",31,0)
 ....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",32,0)
 ....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NOACTION")
"RTN","PSBOMH1",33,0)
 ....D PSBSTIV^PSBOMH2
"RTN","PSBOMH1",34,0)
 ....S X=PSBDT_U_$P(PSBAUD(X),U,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",35,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",36,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X
"RTN","PSBOMH1",37,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",38,0)
 ....D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",39,0)
 ....K PSBAUD
"RTN","PSBOMH1",40,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",41,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",42,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",43,0)
 ...;get instrc info - audt log
"RTN","PSBOMH1",44,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",45,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",46,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",47,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",48,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("A")
"RTN","PSBOMH1",49,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)'="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("B")
"RTN","PSBOMH1",50,0)
 ...I PSBDT'=$P(^PSB(53.79,PSBIEN,0),U,6),$P(^PSB(53.79,PSBIEN,0),U,9)="RM" D
"RTN","PSBOMH1",51,0)
 ....D DDAUD
"RTN","PSBOMH1",52,0)
 ....S I="" F  S I=$O(PSBTAR(I),-1) Q:I=""  I $P(PSBTAR(I),U,1)=PSBDT D
"RTN","PSBOMH1",53,0)
 .....S PSBS=$P(PSBTAR(I),U,3)
"RTN","PSBOMH1",54,0)
 .....I PSBS="GIVEN",$P($G(PSBTAR(I-1)),U,3)="NOT GIVEN" Q  ; canceled - not given
"RTN","PSBOMH1",55,0)
 .....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",56,0)
 .....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NO ACTION")
"RTN","PSBOMH1",57,0)
 .....D PSBCTAR^PSBOMH2
"RTN","PSBOMH1",58,0)
 .....S X=$P(PSBTAR(I),U,1,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",59,0)
 ...S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",60,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X
"RTN","PSBOMH1",61,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",62,0)
 ...D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",63,0)
 ...Q
"RTN","PSBOMH1",64,0)
 ..; 1-Time On Call or PRN
"RTN","PSBOMH1",65,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="C"
"RTN","PSBOMH1",66,0)
 ...I PSBDT'=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I") Q
"RTN","PSBOMH1",67,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",68,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",69,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",70,0)
 ...S (PSBXA,PSBM)=1,(PSBZ,PSBT,PSBFLG)=""
"RTN","PSBOMH1",71,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.09)="REMOVED"  D
"RTN","PSBOMH1",72,0)
 ....F I=1:1 S PSBXA=$O(^PSB(53.79,PSBIEN,.9,PSBXA)) Q:PSBXA=""  I PSBXA?1.3N  S PSBZ=PSBZ+1,PSBT(PSBZ)=^PSB(53.79,PSBIEN,.9,PSBXA,0)
"RTN","PSBOMH1",73,0)
 ....F S=1:1 Q:PSBM<1  S PSBM=PSBZ-S  I (PSBM>0) I (PSBT(PSBM)["GIVEN")  S PSBFLG="1" S PRELINE1=$P(PSBT(PSBM),"'",2)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.04)_" "_$E($P(PSBT(PSBM),"'",4),1,3) Q
"RTN","PSBOMH1",74,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",75,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",76,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",77,0)
 ...I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D PSBOUT(PSBDT,PSBINIT)
"RTN","PSBOMH1",78,0)
 ...S PSBLINE1=$$GET1^DIQ(53.79,PSBIEN_",",.09)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.06)_" "_PSBINIT_"            "_$$GET1^DIQ(53.79,PSBIEN_",",.21),PSBLINE2=""
"RTN","PSBOMH1",79,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",80,0)
 ...D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOMH1",81,0)
 ....I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" S PSBLINE2="  Results: <No PRN Results On File>"
"RTN","PSBOMH1",82,0)
 ....E  D
"RTN","PSBOMH1",83,0)
 .....S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBOMH1",84,0)
 .....S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:NAME")
"RTN","PSBOMH1",85,0)
 .....I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",86,0)
 .....I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",87,0)
 ......S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",88,0)
 ......S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",89,0)
 .....I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D
"RTN","PSBOMH1",90,0)
 ......D:$D(^PSB(53.79,PSBIEN,.9,0))
"RTN","PSBOMH1",91,0)
 .......S (PSBXA2,PSBFG)=0,PSBEFFDT=$P(^PSB(53.79,PSBIEN,.2),U,4) F  S PSBXA2=$O(^PSB(53.79,PSBIEN,.9,PSBXA2)) Q:+PSBXA2'>0  D  Q:PSBFG=1
"RTN","PSBOMH1",92,0)
 ........D:($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U)=PSBEFFDT)&($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)["Instruct")&($P(^PSB(53.79,PSBIEN,.2),U,3)=$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,2))
"RTN","PSBOMH1",93,0)
 .........S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",94,0)
 .........S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)="",PSBFG=1
"RTN","PSBOMH1",95,0)
 .....S PSBLINE2="  Results: "_$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBOMH1",96,0)
 .....S PSBRTXTW="     Entered By "_PSBINIT_" on "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",97,0)
 .....I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",98,0)
 ...S X=PSBDT D H^%DTC F PSBWEEK=PSBAR(%H):-7 Q:$D(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",0))!('$D(PSBAR(PSBWEEK)))
"RTN","PSBOMH1",99,0)
 ...S X=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",""),-1)+1
"RTN","PSBOMH1",100,0)
 ...I PSBFLG="1" S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X)=PRELINE1
"RTN","PSBOMH1",101,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+1)=PSBLINE1
"RTN","PSBOMH1",102,0)
 ...I $G(PSBLINE2)]"" D
"RTN","PSBOMH1",103,0)
 ....I $L(PSBLINE2)<90 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=PSBLINE2 S:$$GET1^DIQ(53.79,PSBIEN_",",.24)'="" ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="      "_PSBRTXTW
"RTN","PSBOMH1",104,0)
 ....I $L(PSBLINE2)>90 D
"RTN","PSBOMH1",105,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=$E(PSBLINE2,1,90)
"RTN","PSBOMH1",106,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="           "_$E(PSBLINE2,91,161)
"RTN","PSBOMH1",107,0)
 .....I $L(PSBLINE2)'>161 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="      "_PSBRTXTW
"RTN","PSBOMH1",108,0)
 .....I $L(PSBLINE2)>161 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="     "_$E(PSBLINE2,162,200),^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+5)="     "_PSBRTXTW
"RTN","PSBOMH1",109,0)
 Q
"RTN","PSBOMH1",110,0)
 ;
"RTN","PSBOMH1",111,0)
DDAUD ;  audits for dispen drugs
"RTN","PSBOMH1",112,0)
 ;
"RTN","PSBOMH1",113,0)
 M PSBMLA=^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",114,0)
 S PSBGA="" I $D(PSBMLA(.9,0)) D
"RTN","PSBOMH1",115,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D  Q
"RTN","PSBOMH1",116,0)
 ..I $D(PSBMLA(.9,PSBX-2,0)) D DT^DILF("ENPST",$P(PSBMLA(.9,PSBX-2,0),"'",2),.PSBDATE)
"RTN","PSBOMH1",117,0)
 ..I '$D(PSBMLA(.9,PSBX-2,0)) S PSBDATE=$P(^PSB(53.79,PSBIEN,0),U,6)
"RTN","PSBOMH1",118,0)
 ..S PSBTMP(10000000-PSBDATE,"B")=PSBDATE_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,5))_U_$P(PSBMLA(.9,PSBX,0),"'",2)
"RTN","PSBOMH1",119,0)
 ..S PSBGA=1
"RTN","PSBOMH1",120,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D
"RTN","PSBOMH1",121,0)
 ..S PSBTMP(10000000-$P(PSBMLA(.9,PSBX,0),U,1),"B")=$P(PSBMLA(.9,PSBX,0),U,1)_U_$$INITIAL^PSBRPC2($P(PSBMLA(.9,PSBX,0),U,2))_U_$P($P(PSBMLA(.9,PSBX,0),U,3),"'",2)
"RTN","PSBOMH1",122,0)
 ..S PSBGA=1
"RTN","PSBOMH1",123,0)
 I PSBGA'=1 S PSBTMP(10000000-$P(PSBMLA(0),U,6),"A")=$P(PSBMLA(0),U,6)_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,7))
"RTN","PSBOMH1",124,0)
 S PSBQRY="PSBTMP",PSBCNT=1 F  S PSBQRY=$Q(@PSBQRY) Q:PSBQRY=""  D  ; does comment go with action
"RTN","PSBOMH1",125,0)
 .S PSBPQRY=$Q(@PSBQRY,-1)
"RTN","PSBOMH1",126,0)
 .I PSBPQRY="" S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; no prev action
"RTN","PSBOMH1",127,0)
 .I $QS(PSBPQRY,2)="C"  S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; prev line = comment
"RTN","PSBOMH1",128,0)
 .I $QS(PSBQRY,2)="C",$E($P(@$Q(@PSBQRY,-1),U,1),1,12)=$E($P(@PSBQRY,U,1),1,12),$P(@$Q(@PSBQRY,-1),U,2)=$P(@PSBQRY,U,2) D  Q
"RTN","PSBOMH1",129,0)
 ..S X=$P(@PSBQRY,U,4) S:X[":" X=$P(X,":",2) S $P(PSBTAR(PSBCNT-1),U,4)=X Q
"RTN","PSBOMH1",130,0)
 .S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1
"RTN","PSBOMH1",131,0)
 Q
"RTN","PSBOMH1",132,0)
 ;
"RTN","PSBOMH1",133,0)
PSBOUT(PSBTET,PSBOT1) ;
"RTN","PSBOMH1",134,0)
 I '$D(^PSB(53.79,PSBIEN,.9,0))  D PSBENT^PSBOMH2(PSBOT1)
"RTN","PSBOMH1",135,0)
 S PSBIDA="" I $P(^PSB(53.79,PSBIEN,0),U,6)=PSBTET S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,7),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",136,0)
 S PSBXA1=0
"RTN","PSBOMH1",137,0)
 F  S PSBXA1=$O(^PSB(53.79,PSBIEN,.9,PSBXA1)) Q:+PSBXA1'>0  I PSBXA1'=0  D  Q:$G(PSBOT1)["*"
"RTN","PSBOMH1",138,0)
 .I $L(PSBXA1)<4  D
"RTN","PSBOMH1",139,0)
 ..I $P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1)=PSBTET  D
"RTN","PSBOMH1",140,0)
 ...S:$G(PSBIDA)="" PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",141,0)
 ...I (PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2)),$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",142,0)
 ....S INSDD=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1),Y=INSDD D DD^%DT S INSDD=Y
"RTN","PSBOMH1",143,0)
 ....S PSBOT1=PSBOT1_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),U,3)_" "_INSDD
"RTN","PSBOMH1",144,0)
 I $G(PSBIDA)="",$P(^PSB(53.79,PSBIEN,0),U,4)=PSBTET D
"RTN","PSBOMH1",145,0)
 .S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",146,0)
 I $G(PSBNAME)="" D
"RTN","PSBOMH1",147,0)
 . S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",148,0)
 S ^TMP("PSB",$J,"LEGEND",$S($G(PSBOT1)="":99,1:PSBOT1),PSBNAME)=""
"RTN","PSBOMH1",149,0)
 Q
"RTN","PSBOMH1",150,0)
 ;
"RTN","PSBUTL")
0^8^B82318781^B82345052
"RTN","PSBUTL",1,0)
PSBUTL ;BIRMINGHAM/EFC-BCMA UTILITIES ;Mar 2004
"RTN","PSBUTL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,9,13,38**;Mar 2004;Build 8
"RTN","PSBUTL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBUTL",4,0)
 ;
"RTN","PSBUTL",5,0)
 ; Reference/IA
"RTN","PSBUTL",6,0)
 ; $$PATCH & $$VERSION^XPDUTL/10141
"RTN","PSBUTL",7,0)
 ; File 50/221
"RTN","PSBUTL",8,0)
 ; File 200/10060
"RTN","PSBUTL",9,0)
 ;
"RTN","PSBUTL",10,0)
 ;
"RTN","PSBUTL",11,0)
DIWP(X,Y,PSB,PSBARGN) ; 
"RTN","PSBUTL",12,0)
 K ^UTILITY($J,"W")
"RTN","PSBUTL",13,0)
 S DIWL=0,DIWR=Y,DIWF="C"_Y D ^DIWP
"RTN","PSBUTL",14,0)
 F X=0:0 S X=$O(^UTILITY($J,"W",0,X)) Q:'X  D
"RTN","PSBUTL",15,0)
 .S Y=$O(@PSB@(""),-1)+1
"RTN","PSBUTL",16,0)
 .; Naked Ref ^UTILITY($J,"W",0,X)
"RTN","PSBUTL",17,0)
 .S @PSB@(Y)=$J("",+$G(PSBARGN))_^(X,0)
"RTN","PSBUTL",18,0)
 S @PSB@(0)=+$O(@PSB@(""),-1)
"RTN","PSBUTL",19,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF
"RTN","PSBUTL",20,0)
 Q
"RTN","PSBUTL",21,0)
 ;
"RTN","PSBUTL",22,0)
SATURDAY(X,PSBDISP) ; 
"RTN","PSBUTL",23,0)
 S X=X\1 D H^%DTC ; Convert to $H
"RTN","PSBUTL",24,0)
 S %H=%H+(6-%Y) ;   Set it forward to Saturday
"RTN","PSBUTL",25,0)
 D YMD^%DTC ;       Back to FM Format
"RTN","PSBUTL",26,0)
 I $G(PSBDISP) S PSBDISP=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3)) D EN^DDIOL("Actual date is Saturday "_PSBDISP)
"RTN","PSBUTL",27,0)
 Q X
"RTN","PSBUTL",28,0)
 ;
"RTN","PSBUTL",29,0)
SUNDAY(X,PSBDISP) ; 
"RTN","PSBUTL",30,0)
 S X=X\1 D H^%DTC ; Convert to $H
"RTN","PSBUTL",31,0)
 S %H=%H-%Y ;       Set it back to Sunday
"RTN","PSBUTL",32,0)
 D YMD^%DTC ;       Back to FM Format
"RTN","PSBUTL",33,0)
 I $G(PSBDISP) S PSBDISP=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3)) D EN^DDIOL("Actual date is Sunday "_PSBDISP)
"RTN","PSBUTL",34,0)
 Q X
"RTN","PSBUTL",35,0)
 ;
"RTN","PSBUTL",36,0)
CLOCK(RESULTS,X) ; Verify Client/Server Date/Times are close enough
"RTN","PSBUTL",37,0)
 ;
"RTN","PSBUTL",38,0)
 ; RPC: PSB SERVER CLOCK VARIANCE
"RTN","PSBUTL",39,0)
 ;
"RTN","PSBUTL",40,0)
 ; Description:
"RTN","PSBUTL",41,0)
 ; Returns variance from server to client in minutes
"RTN","PSBUTL",42,0)
 ;
"RTN","PSBUTL",43,0)
 N PSBCLNT,PSBSRVR,PSBDIFF
"RTN","PSBUTL",44,0)
 S %DT="RS" D ^%DT S PSBCLNT=Y
"RTN","PSBUTL",45,0)
 D NOW^%DTC S PSBSRVR=%
"RTN","PSBUTL",46,0)
 S PSBDIFF=$$DIFF(PSBSRVR,PSBCLNT)
"RTN","PSBUTL",47,0)
 S X=$$GET^XPAR("DIV","PSB SERVER CLOCK VARIANCE")
"RTN","PSBUTL",48,0)
 I PSBDIFF>X!(PSBDIFF<(X*-1)) S RESULTS(0)="-1^"_PSBDIFF
"RTN","PSBUTL",49,0)
 E  S RESULTS(0)="1^"_PSBDIFF
"RTN","PSBUTL",50,0)
 Q
"RTN","PSBUTL",51,0)
 ;
"RTN","PSBUTL",52,0)
DIFF(X,X1) ; Difference in minutes between 2 FM dates
"RTN","PSBUTL",53,0)
 ; Code copied from Fileman Function MINUTES
"RTN","PSBUTL",54,0)
 S Y=$E(X1_"000",9,10)-$E(X_"000",9,10)*60+$E(X1_"00000",11,12)-$E(X_"00000",11,12),X2=X,X=$P(X,".",1)'=$P(X1,".",1) D ^%DTC:X S X=X*1440+Y
"RTN","PSBUTL",55,0)
 Q X
"RTN","PSBUTL",56,0)
 ;
"RTN","PSBUTL",57,0)
DRUGINQ ; Drug File Inquiry
"RTN","PSBUTL",58,0)
 N PSBRET,PSBIEN,DIC,DIR,IOINORM,IOINHI
"RTN","PSBUTL",59,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSBUTL",60,0)
 S X=$TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSBUTL",61,0)
 S DIC="^PSDRUG(",DIC(0)="AEQMVTN",DIC("T")="",D="B^C^VAPN^VAC^NDC^XATC",DIC("A")="Select DRUG: "
"RTN","PSBUTL",62,0)
 ; Display active drugs and those for appl packages IV and Unit Dose
"RTN","PSBUTL",63,0)
 S DIC("S")="I '$G(^PSDRUG(+Y,""I""))!($G(^(""I""))>DT),$P($G(^PSDRUG(+Y,2)),U,3)[""I""!($P($G(^PSDRUG(+Y,2)),U,3)[""U"")"
"RTN","PSBUTL",64,0)
 F  W @IOF,!,"DRUG FILE INQUIRY",! D ^DIC  Q:+Y<1  D
"RTN","PSBUTL",65,0)
 .K PSBRET
"RTN","PSBUTL",66,0)
 .S PSBIEN=+Y_","
"RTN","PSBUTL",67,0)
 .D GETS^DIQ(50,PSBIEN,".01;16;25;51;215;213;101;9*","","PSBRET")
"RTN","PSBUTL",68,0)
 .W @IOF,!,"DRUG NAME: ",IOINHI,PSBRET(50,PSBIEN,.01)
"RTN","PSBUTL",69,0)
 .W "  (IEN: ",+PSBIEN,")",IOINORM,!,$TR($J("",IOM)," ","-"),!
"RTN","PSBUTL",70,0)
 .F X=16,25,51,215,213,101 D
"RTN","PSBUTL",71,0)
 ..D FIELD^DID(50,X,"","LABEL","PSBRET")
"RTN","PSBUTL",72,0)
 ..W !,PSBRET("LABEL"),":",?30,IOINHI
"RTN","PSBUTL",73,0)
 ..D:$L(PSBRET(50,PSBIEN,X))>49
"RTN","PSBUTL",74,0)
 ...F Y=1:1 Q:$L($P(PSBRET(50,PSBIEN,X)," ",1,Y))>49
"RTN","PSBUTL",75,0)
 ...W $P(PSBRET(50,PSBIEN,X)," ",1,Y-1),!?30
"RTN","PSBUTL",76,0)
 ...S PSBRET(50,PSBIEN,X)=$P(PSBRET(50,PSBIEN,X)," ",Y,250)
"RTN","PSBUTL",77,0)
 ..W ?30,PSBRET(50,PSBIEN,X),IOINORM
"RTN","PSBUTL",78,0)
 .W !!,"SYNONYMS:",IOINHI,!?15
"RTN","PSBUTL",79,0)
 .S X="" F  S X=$O(PSBRET(50.1,X)) Q:X=""  W:$X>40 !?15 W:$X>15 ?40 W PSBRET(50.1,X,.01)
"RTN","PSBUTL",80,0)
 .W IOINORM
"RTN","PSBUTL",81,0)
 .F  Q:$Y>(IOSL-3)  W !
"RTN","PSBUTL",82,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSBUTL",83,0)
 Q
"RTN","PSBUTL",84,0)
 ;
"RTN","PSBUTL",85,0)
DPTSET ; Set Logic for pt-merge x-ref on patient field in file 53.79
"RTN","PSBUTL",86,0)
 ;
"RTN","PSBUTL",87,0)
 ; Entered Date/Time
"RTN","PSBUTL",88,0)
 I $P(^PSB(53.79,DA,0),U,4) S ^PSB(53.79,"AEDT",X,$P(^PSB(53.79,DA,0),U,4),DA)=""
"RTN","PSBUTL",89,0)
 ;
"RTN","PSBUTL",90,0)
 ; Administration Date/Time
"RTN","PSBUTL",91,0)
 D:$P(^PSB(53.79,DA,0),U,6)
"RTN","PSBUTL",92,0)
 .S ^PSB(53.79,"AADT",X,$P(^PSB(53.79,DA,0),U,6),DA)=""
"RTN","PSBUTL",93,0)
 .;
"RTN","PSBUTL",94,0)
 .; Orderable Item + Administration Date/Time
"RTN","PSBUTL",95,0)
 .I $P(^PSB(53.79,DA,0),U,8) S ^PSB(53.79,"AOIP",X,$P(^PSB(53.79,DA,0),U,8),$P(^PSB(53.79,DA,0),U,6),DA)=""
"RTN","PSBUTL",96,0)
 ;
"RTN","PSBUTL",97,0)
 ; PRN's by entered date/time
"RTN","PSBUTL",98,0)
 I $P($G(^PSB(53.79,DA,.1)),U,2)="P"&($P(^(0),U,4)) S ^PSB(53.79,"APRN",X,$P(^PSB(53.79,DA,0),U,4),DA)=""
"RTN","PSBUTL",99,0)
 ;
"RTN","PSBUTL",100,0)
 ; Order+Administration Date and Time
"RTN","PSBUTL",101,0)
 I $P($G(^PSB(53.79,DA,.1)),U)]""&($P($G(^PSB(53.79,DA,.1)),U,3)) S ^PSB(53.79,"AORD",X,$P(^PSB(53.79,DA,.1),U),$P(^PSB(53.79,DA,.1),U,3),DA)=""
"RTN","PSBUTL",102,0)
 Q
"RTN","PSBUTL",103,0)
 ;
"RTN","PSBUTL",104,0)
DPTKILL ; Kill Logic for pt-merge x-ref on patient field in file 53.79
"RTN","PSBUTL",105,0)
 ;
"RTN","PSBUTL",106,0)
 ; Entered Date/Time
"RTN","PSBUTL",107,0)
 I $P(^PSB(53.79,DA,0),U,4) K ^PSB(53.79,"AEDT",X,$P(^PSB(53.79,DA,0),U,4),DA)
"RTN","PSBUTL",108,0)
 ;
"RTN","PSBUTL",109,0)
 ; Administration Date/Time
"RTN","PSBUTL",110,0)
 D:$P(^PSB(53.79,DA,0),U,6)
"RTN","PSBUTL",111,0)
 .K ^PSB(53.79,"AADT",X,$P(^PSB(53.79,DA,0),U,6),DA)
"RTN","PSBUTL",112,0)
 .;
"RTN","PSBUTL",113,0)
 .; Orderable Item + Administration Date/Time
"RTN","PSBUTL",114,0)
 .I $P(^PSB(53.79,DA,0),U,8) K ^PSB(53.79,"AOIP",X,$P(^PSB(53.79,DA,0),U,8),$P(^PSB(53.79,DA,0),U,6),DA)
"RTN","PSBUTL",115,0)
 ;
"RTN","PSBUTL",116,0)
 ; PRN's by entered date/time
"RTN","PSBUTL",117,0)
 I $P($G(^PSB(53.79,DA,.1)),U,2)="P"&($P(^(0),U,4)) K ^PSB(53.79,"APRN",X,$P(^PSB(53.79,DA,0),U,4),DA)
"RTN","PSBUTL",118,0)
 ;
"RTN","PSBUTL",119,0)
 ; Order+Administration Date and Time
"RTN","PSBUTL",120,0)
 I $P($G(^PSB(53.79,DA,.1)),U)]""&($P($G(^PSB(53.79,DA,.1)),U,3)) K ^PSB(53.79,"AORD",X,$P(^PSB(53.79,DA,.1),U),$P(^PSB(53.79,DA,.1),U,3),DA)
"RTN","PSBUTL",121,0)
 Q
"RTN","PSBUTL",122,0)
 ;
"RTN","PSBUTL",123,0)
TIMEIN ;
"RTN","PSBUTL",124,0)
 X ^%ZOSF("UPPERCASE") S X=Y
"RTN","PSBUTL",125,0)
 I X="NOON" S X=.12 Q
"RTN","PSBUTL",126,0)
 I X="MID" S X=.24 Q
"RTN","PSBUTL",127,0)
 I (X="NOW")!(X="N") D NOW^%DTC S X=$E($P(%,".",2)_"0000",1,4)
"RTN","PSBUTL",128,0)
 S X="T@"_X,%DT="R" D ^%DT
"RTN","PSBUTL",129,0)
 I Y<1 K X Q
"RTN","PSBUTL",130,0)
 S X=Y-DT
"RTN","PSBUTL",131,0)
 Q
"RTN","PSBUTL",132,0)
 ;
"RTN","PSBUTL",133,0)
TIMEOUT(X) ; 
"RTN","PSBUTL",134,0)
 N HOUR,MIN,AMPM
"RTN","PSBUTL",135,0)
 S X=$E($P(X,".",2)_"0000",1,4)
"RTN","PSBUTL",136,0)
 I X="2400" Q "12:00m"
"RTN","PSBUTL",137,0)
 I X="1200" Q "12:00n"
"RTN","PSBUTL",138,0)
 S HOUR=+$E(X,1,2),MIN=$E(X,3,4)
"RTN","PSBUTL",139,0)
 S AMPM="a"
"RTN","PSBUTL",140,0)
 S AMPM=$S(HOUR<12:"a",HOUR>11:"p",1:"**")
"RTN","PSBUTL",141,0)
 S:HOUR>12 HOUR=HOUR-12
"RTN","PSBUTL",142,0)
 Q HOUR_":"_MIN_AMPM
"RTN","PSBUTL",143,0)
 ;
"RTN","PSBUTL",144,0)
HFSOPEN(HANDLE) ; 
"RTN","PSBUTL",145,0)
 N PSBDIR,PSBFILE
"RTN","PSBUTL",146,0)
 S PSBDIR=$$GET^XPAR("DIV","PSB HFS SCRATCH")
"RTN","PSBUTL",147,0)
 S PSBFILE="PSB"_DUZ_".DAT"
"RTN","PSBUTL",148,0)
 D OPEN^%ZISH(HANDLE,PSBDIR,PSBFILE,"W") Q:POP
"RTN","PSBUTL",149,0)
 S IOM=132,IOSL=99999,IOST="P-DUMMY",IOF=""""""
"RTN","PSBUTL",150,0)
 Q
"RTN","PSBUTL",151,0)
 ;
"RTN","PSBUTL",152,0)
HFSCLOSE(HANDLE) ; 
"RTN","PSBUTL",153,0)
 N PSBDIR,PSBFILE,PSBDEL
"RTN","PSBUTL",154,0)
 D CLOSE^%ZISH(HANDLE)
"RTN","PSBUTL",155,0)
 K ^TMP("PSBO",$J)
"RTN","PSBUTL",156,0)
 S PSBDIR=$$GET^XPAR("DIV","PSB HFS SCRATCH")
"RTN","PSBUTL",157,0)
 S PSBFILE="PSB"_DUZ_".DAT",PSBDEL(PSBFILE)=""
"RTN","PSBUTL",158,0)
 S X=$$FTG^%ZISH(PSBDIR,PSBFILE,$NAME(^TMP("PSBO",$J,2)),3)
"RTN","PSBUTL",159,0)
 S X=$$DEL^%ZISH(PSBDIR,$NA(PSBDEL))
"RTN","PSBUTL",160,0)
 Q
"RTN","PSBUTL",161,0)
 ;
"RTN","PSBUTL",162,0)
AUDIT(PSBREC,PSBDD,PSBFLD,PSBDATA,PSBSK) ; Med Log Audit
"RTN","PSBUTL",163,0)
 ; used by cross references to 53.79 to track changes to fields in Med Log file
"RTN","PSBUTL",164,0)
 ; xref AU05, AU06, AU09, AU16, AU21, AU22 pass the value 53.79 as PSBDD
"RTN","PSBUTL",165,0)
 ; xref AU303, AU304 pass the value 53.795 as PSBDD
"RTN","PSBUTL",166,0)
 ; xref AU603, AU604 pass the value 53.796 as PSBDD
"RTN","PSBUTL",167,0)
 ; xref AU703, AU704 pass the value 53.797 as PSBDD
"RTN","PSBUTL",168,0)
 ;
"RTN","PSBUTL",169,0)
 N PSBDT,PSBTMP
"RTN","PSBUTL",170,0)
 I '$D(PSBOLSTS) S PSBOLSTS=$P(^PSB(53.79,PSBREC,0),U,9)
"RTN","PSBUTL",171,0)
 I '$D(PSBOLDUZ) S PSBOLDUZ=$P(^PSB(53.79,PSBREC,0),U,5)
"RTN","PSBUTL",172,0)
 Q:$G(PSBDATA)=""!('$G(PSBAUDIT))
"RTN","PSBUTL",173,0)
 D NOW^%DTC S PSBDT=%
"RTN","PSBUTL",174,0)
 S PSBDATA=$$EXTERNAL^DILFD(PSBDD,PSBFLD,"",PSBDATA)  ; PSBDD=53.79, 53.795, 53.796, or 53.797 see comment AUDIT
"RTN","PSBUTL",175,0)
 D FIELD^DID(PSBDD,PSBFLD,"","LABEL","PSBTMP")  ; PSBDD=53.79, 53.795, 53.796, or 53.797 see comment AUDIT
"RTN","PSBUTL",176,0)
 S:'$D(^PSB(53.79,PSBREC,.9,0)) ^(0)="^53.799^^"
"RTN","PSBUTL",177,0)
 S Y=$O(^PSB(53.79,PSBREC,.9,""),-1)+1,X=""
"RTN","PSBUTL",178,0)
 I PSBTMP("LABEL")["ACTION STATUS" D  Q
"RTN","PSBUTL",179,0)
 .I PSBSK["K" S XY=Y F  S XY=$O(^PSB(53.79,PSBREC,.9,XY),-1) Q:($D(PSBGOON))!(+XY'>0)  D
"RTN","PSBUTL",180,0)
 ..I ^PSB(53.79,PSBREC,.9,XY,0)["ACTION STATUS Set to '" D  Q
"RTN","PSBUTL",181,0)
 ...S PSBGOON=1,PSBOLDUZ=$P(^PSB(53.79,PSBREC,.9,XY,0),U,2),X=$P(^PSB(53.79,PSBREC,.9,XY,0),"'",2)
"RTN","PSBUTL",182,0)
 .S:$L(X)'>2 X=PSBOLSTS,X=$S(X="G":"GIVEN",X="H":"HELD",X="R":"REFUSED",X="I":"INFUSING",X="C":"COMPLETED",X="S":"STOPPED",X="N":"NOT GIVEN",X="RM":"REMOVED",X="M":"MISSING DOSE",X="":PSBOLSTS)
"RTN","PSBUTL",183,0)
 .I PSBSK["K" S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_" '"_PSBDATA_"' by '"_$$GET1^DIQ(200,PSBOLDUZ,"INITIAL")_"' deleted."
"RTN","PSBUTL",184,0)
 .E  S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_" Set to '"_PSBDATA_"' by '"_$$GET1^DIQ(200,DUZ,"INITIAL")_"'."_U_PSBDATA
"RTN","PSBUTL",185,0)
 I PSBSK["K" S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_" '"_PSBDATA_"' deleted."
"RTN","PSBUTL",186,0)
 E  S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_$S(PSBTMP("LABEL")["DISPENSE DRUG":" Added '",1:" Set to '")_PSBDATA_"'."
"RTN","PSBUTL",187,0)
 K XY,PSBGOON
"RTN","PSBUTL",188,0)
 Q
"RTN","PSBUTL",189,0)
 ;
"RTN","PSBUTL",190,0)
CHECK(RESULTS,PSBWHAT,PSBDATA) ; Checks for KIDS Patch or Build
"RTN","PSBUTL",191,0)
 ; Module added in Patch PSB*1.0*3 DP/TOPEKA 22-DEC-1999 11:51:22 
"RTN","PSBUTL",192,0)
 ; PSBWHAT: B = Returns Build Version for packages by Namespace
"RTN","PSBUTL",193,0)
 ;          P = Returns if Patch is installed
"RTN","PSBUTL",194,0)
 ; PSBDATA: Build/Package namespace (i.e. PSB) or Patch Number
"RTN","PSBUTL",195,0)
 ;         (i.e. PSB*1.0*1)
"RTN","PSBUTL",196,0)
 ;
"RTN","PSBUTL",197,0)
 S RESULTS(0)="-1^Unknown Parameter "_$G(PSBWHAT,"<PSBWHAT Undefined>")
"RTN","PSBUTL",198,0)
 S PSBWHAT=$G(PSBWHAT),PSBDATA=$G(PSBDATA)
"RTN","PSBUTL",199,0)
 D:PSBWHAT="B"
"RTN","PSBUTL",200,0)
 .S X=$$VERSION^XPDUTL(PSBDATA)
"RTN","PSBUTL",201,0)
 .S RESULTS(0)=$S(X="":"-1^Unknown Package/Build",1:"1^"_X)
"RTN","PSBUTL",202,0)
 D:PSBWHAT="P"
"RTN","PSBUTL",203,0)
 .S X=$$PATCH^XPDUTL(PSBDATA)
"RTN","PSBUTL",204,0)
 .S RESULTS(0)=$S(X:"1^Patch Is Installed",1:"-1^Patch Is Not Installed")
"RTN","PSBUTL",205,0)
 Q
"RTN","PSBUTL",206,0)
 ;
"RTN","PSBUTL",207,0)
VERSION() ; [Extrinsic] 
"RTN","PSBUTL",208,0)
 ; Returns V#.# for display purposes
"RTN","PSBUTL",209,0)
 Q "V"_$J(2,0,1)
"RTN","PSBUTL",210,0)
 ;
"RTN","PSBUTL",211,0)
RESETADM ;
"RTN","PSBUTL",212,0)
 ;
"RTN","PSBUTL",213,0)
 ;  This Subroutine will reset a medication order's resources
"RTN","PSBUTL",214,0)
 ;  based on Med Log New Entry or Edit Med Log activity.
"RTN","PSBUTL",215,0)
 ;
"RTN","PSBUTL",216,0)
 ;  No input is necessary. Environment should be setup at call.
"RTN","PSBUTL",217,0)
 ;
"RTN","PSBUTL",218,0)
 I '$G(PSBMMEN) S X=$S($P(PSBIEN,",",2)]"":$P(PSBIEN,",",2),1:+PSBIEN) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,X,0),U),$P(^PSB(53.79,X,.1),U)) D:($$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)))  D CLEAN^PSBVT
"RTN","PSBUTL",219,0)
 .S X=PSBIEN,X2=X_$S(X="+1":",",1:"") Q:'$D(PSBFDA(53.79,X2,.09))  I $F("HR",PSBFDA(53.79,X2,.09))>1 S PSBFDA(53.79,X2,.26)=""
"RTN","PSBUTL",220,0)
 I $G(PSBMMEN),PSBIEN="+1",$G(PSBONX)["V" S PSBWSID=PSBFDA(53.79,"+1,",.26) K PSBFDA(53.79,"+1,",.26),PSBFDA(53.79,"+1,",.09)
"RTN","PSBUTL",221,0)
 I $G(PSBMMEN) I ($D(PSBWSID))&($G(Y(0))="SAVE") D
"RTN","PSBUTL",222,0)
 .S:(PSBREC(3)="G") PSBFDAX(53.79,X,.26)=PSBWSID
"RTN","PSBUTL",223,0)
 .S:$F("HR",PSBREC(3))>1 PSBFDAX(53.79,X,.26)=""
"RTN","PSBUTL",224,0)
 .S X=$P(PSBIEN,"+1,",2)
"RTN","PSBUTL",225,0)
 .D UPDATE^DIE("","PSBFDAX","X","PSBMSG")
"RTN","PSBUTL",226,0)
 Q
"RTN","PSBUTL",227,0)
 ;
"RTN","PSBUTL",228,0)
SCRNPTCH ;
"RTN","PSBUTL",229,0)
 ;
"RTN","PSBUTL",230,0)
 ; Maintain the "APATCH" index from SCREENMAN and Manual Med Entry.
"RTN","PSBUTL",231,0)
 ;
"RTN","PSBUTL",232,0)
 I Y(0)'="GIVEN" S PSBGPTCH=0 Q
"RTN","PSBUTL",233,0)
 S PSBX=0 F  S PSBX=$O(^PSB(53.79,DA,.5,PSBX))  Q:+PSBX=0  Q:$P(^PSB(53.79,DA,.5,+PSBX,0),U,4)="PATCH"
"RTN","PSBUTL",234,0)
 Q:+PSBX=0
"RTN","PSBUTL",235,0)
 S PSBGPTCH=1
"RTN","PSBUTL",236,0)
 Q
"RTN","PSBUTL",237,0)
 ;
"RTN","PSBUTL",238,0)
GIVEPTCH ;
"RTN","PSBUTL",239,0)
 I $D(^PSB(53.79,"AORD",DFN,PSBONX)) N PSBX S PSBX="" F  S PSBX=$O(^PSB(53.79,"AORD",DFN,PSBONX,PSBX)) Q:+PSBX=0  D:$D(^PSB(53.79,"AORD",DFN,PSBONX,PSBX,DA))  Q:'$D(PSBX)
"RTN","PSBUTL",240,0)
 .I $D(^PSB(53.79,"AORD",DFN,PSBONX,PSBX,DA)) D
"RTN","PSBUTL",241,0)
 ..S PSBX=$P(^PSB(53.79,DA,0),U,6)
"RTN","PSBUTL",242,0)
 ..I PSBGPTCH S ^PSB(53.79,"APATCH",DFN,PSBX,DA)="" K PSBX,PSBGPTCH Q
"RTN","PSBUTL",243,0)
 ..I 'PSBGPTCH K ^PSB(53.79,"APATCH",DFN,PSBX,DA),PSBX,PSBGPTCH
"RTN","PSBUTL",244,0)
 Q
"RTN","PSBVDLIV")
0^5^B63842623^B64872965
"RTN","PSBVDLIV",1,0)
PSBVDLIV ;BIRMINGHAM/EFC-BCMA IV VIRTUAL DUE LIST ;Mar 2004
"RTN","PSBVDLIV",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,38**;Mar 2004;Build 8
"RTN","PSBVDLIV",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVDLIV",4,0)
 ;
"RTN","PSBVDLIV",5,0)
 ; Reference/IA
"RTN","PSBVDLIV",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLIV",7,0)
 ; EN^PSJBCMA1/2829 
"RTN","PSBVDLIV",8,0)
 ;
"RTN","PSBVDLIV",9,0)
EN(DFN,PSBDT) ; Default Order List Return for Today
"RTN","PSBVDLIV",10,0)
 ;
"RTN","PSBVDLIV",11,0)
 ; RPC: PSB GETORDERLIST
"RTN","PSBVDLIV",12,0)
 ;
"RTN","PSBVDLIV",13,0)
 ; Description:
"RTN","PSBVDLIV",14,0)
 ; Returns the current IV order set for today to display on the
"RTN","PSBVDLIV",15,0)
 ; client VDL
"RTN","PSBVDLIV",16,0)
 ;
"RTN","PSBVDLIV",17,0)
 N PSBDATA,PSBTBOUT,PSBDOADD
"RTN","PSBVDLIV",18,0)
 S PSBTBOUT=0,PSBDOADD=0
"RTN","PSBVDLIV",19,0)
 S:PSBTAB="IVTAB" PSBDOADD=1
"RTN","PSBVDLIV",20,0)
 ;
"RTN","PSBVDLIV",21,0)
 ; Passing PSBDT as 3rd parameter turns off the V.1.0 One-Time lookback
"RTN","PSBVDLIV",22,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J,"ON IVTAB") S X1=PSBDT,X2=-3 D C^%DTC S PSBDT2=X D EN^PSJBCMA(DFN,PSBDT2,PSBDT)
"RTN","PSBVDLIV",23,0)
 ;
"RTN","PSBVDLIV",24,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 Q  ; No orders
"RTN","PSBVDLIV",25,0)
 ;
"RTN","PSBVDLIV",26,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBVDLIV",27,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX)
"RTN","PSBVDLIV",28,0)
 .;
"RTN","PSBVDLIV",29,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLIV",30,0)
 .;
"RTN","PSBVDLIV",31,0)
 .Q:PSBONX'["V"  ; IVs only
"RTN","PSBVDLIV",32,0)
 .Q:PSBIVT["P"  ; No piggybacks
"RTN","PSBVDLIV",33,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLIV",34,0)
 .Q:PSBOST>($$FMADD^XLFDT($$NOW^XLFDT,,,$$GET^XPAR("DIV","PSB ADMIN BEFORE")))
"RTN","PSBVDLIV",35,0)
 .; Need to see if "last order" in chain is active/not pending.
"RTN","PSBVDLIV",36,0)
 .S PSBFON1=PSBFON,PSBLOOP=0 I $G(PSBFON)]"" S PSBLACTV=$S($G(PSBFON)["P":0,1:1) S PSBFON2=$G(PSBFON) I 'PSBLACTV F  D  Q:($G(PSBFON)="")!($G(PSBFON1)=$G(PSBFON2))!(PSBLOOP)!(PSBLACTV)  ;
"RTN","PSBVDLIV",37,0)
 ..I $G(PSBFON)["P" K ^TMP("PSJ1",$J) D EN^PSJBCMA1(DFN,PSBFON2,1) I ^TMP("PSJ1",$J,0)=-1 S PSBFON=""
"RTN","PSBVDLIV",38,0)
 ..D:$G(PSBFON)["" CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBFON2)
"RTN","PSBVDLIV",39,0)
 ..I PSBFON=PSBFON2 S PSBLOOP=1,PSBLACTV=0 Q
"RTN","PSBVDLIV",40,0)
 ..S PSBLACTV=$S($G(PSBFON)["P":0,$G(PSBFON)']"":PSBLACTV,1:1),PSBFON2=$G(PSBFON)
"RTN","PSBVDLIV",41,0)
 ..S:(PSBLACTV)&($G(PSBOST)>($$FMADD^XLFDT($$NOW^XLFDT,,,$$GET^XPAR("DIV","PSB ADMIN BEFORE")))) PSBLACTV=0
"RTN","PSBVDLIV",42,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX) ;Refresh data
"RTN","PSBVDLIV",43,0)
 .K PSBCOMP,PSBCOMPX,PSBINFDT,PSBINFST D INFUSING^PSBVDLU2
"RTN","PSBVDLIV",44,0)
 .D NOW^%DTC
"RTN","PSBVDLIV",45,0)
 .I ((PSBOSTS="A")!(PSBOSTS="R"))&(PSBOSP<%) S PSBOSTS="E"
"RTN","PSBVDLIV",46,0)
 .I (PSBOSTS["D")&(PSBCOMP=0) Q  ;     Is it DC'd and not infusing or stopped
"RTN","PSBVDLIV",47,0)
 .I PSBOSTS="E",PSBCOMP=0 Q  ; Is expired and not infusing or stopped
"RTN","PSBVDLIV",48,0)
 .I PSBOSTS="D",PSBCOMP=1,($G(PSBFON)]""),PSBLACTV Q  ; order is DC'ed   will be picked up by following order
"RTN","PSBVDLIV",49,0)
 .I PSBOSTS="E",PSBCOMP=1,($G(PSBFON)]""),PSBLACTV Q  ; order is expired will be picked up by following order
"RTN","PSBVDLIV",50,0)
 .I PSBOSTS="R",PSBFOR="R",PSBOSP<PSBWBEG Q  ; order is renewed bag picked up by following order
"RTN","PSBVDLIV",51,0)
 .Q:$G(^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBONX))=1  ; The "previous order" is displayed on the VDL!
"RTN","PSBVDLIV",52,0)
 .I (PSBOSTS["E")&(PSBCOMP=0) Q  ;     Is it expired and not infusing
"RTN","PSBVDLIV",53,0)
 .I PSBIVT["S",PSBISYR=1 Q  ;     No intermittent syringes - done on PB tab
"RTN","PSBVDLIV",54,0)
 .I PSBIVT["C",PSBISYR=1 Q  ;     No intermittent syringes - done on PB tab
"RTN","PSBVDLIV",55,0)
 .I PSBIVT["C",PSBCHEMT="P" Q  ;  No Piggyback Chemos
"RTN","PSBVDLIV",56,0)
 .I PSBNGF&(PSBCOMP=1) Q  ;         Is it marked DO NOT GIVE!
"RTN","PSBVDLIV",57,0)
 .;
"RTN","PSBVDLIV",58,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLIV",59,0)
 .;
"RTN","PSBVDLIV",60,0)
 .D NOW^%DTC
"RTN","PSBVDLIV",61,0)
 .I PSBOSP<%,PSBOSTS'="R",PSBCOMP'=1 Q
"RTN","PSBVDLIV",62,0)
 .;
"RTN","PSBVDLIV",63,0)
 .; include Active, Renewed, ReInstated and On Call and Hold and Expired infusing
"RTN","PSBVDLIV",64,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call or Hold)
"RTN","PSBVDLIV",65,0)
 .Q:PSBSCHT'="O"&((PSBOSTS'="A")&(PSBOSTS'="R")&(PSBOSTS'="RE")&(PSBOSTS'="O")&(PSBOSTS'="D")&(PSBOSTS'="H")&(PSBOSTS'="E"))
"RTN","PSBVDLIV",66,0)
 .;
"RTN","PSBVDLIV",67,0)
 .; Is One Time Given
"RTN","PSBVDLIV",68,0)
 .;
"RTN","PSBVDLIV",69,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLIV",70,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLIV",71,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLIV",72,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLIV",73,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBON,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLIV",74,0)
 .;
"RTN","PSBVDLIV",75,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLIV",76,0)
 .;
"RTN","PSBVDLIV",77,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLIV",78,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLIV",79,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLIV",80,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLIV",81,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBON,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLIV",82,0)
 .;
"RTN","PSBVDLIV",83,0)
OK .S PSBSTRT=PSBOST ; Order Start Date/Time
"RTN","PSBVDLIV",84,0)
 .S PSBSTOP=PSBOSP ; Order Stop Date/Time
"RTN","PSBVDLIV",85,0)
 .;
"RTN","PSBVDLIV",86,0)
 .S PSBREC=""
"RTN","PSBVDLIV",87,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLIV",88,0)
 .S $P(PSBREC,U,2)=PSBONX ; Order
"RTN","PSBVDLIV",89,0)
 .S $P(PSBREC,U,3)=+PSBON ; order ien
"RTN","PSBVDLIV",90,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLIV",91,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLIV",92,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLIV",93,0)
 .S Y=""
"RTN","PSBVDLIV",94,0)
 .S:PSBSM Y="SM"
"RTN","PSBVDLIV",95,0)
 .S:PSBHSM Y="HSM"
"RTN","PSBVDLIV",96,0)
 .S $P(PSBREC,U,7)=Y ; self med
"RTN","PSBVDLIV",97,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLIV",98,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLIV",99,0)
 .S $P(PSBREC,U,10)=PSBMR ; med route
"RTN","PSBVDLIV",100,0)
 .; IV Information Column *new*  -  status date/time
"RTN","PSBVDLIV",101,0)
 .; (only stopped or infusing)
"RTN","PSBVDLIV",102,0)
 .;
"RTN","PSBVDLIV",103,0)
 .D:PSBCOMP 
"RTN","PSBVDLIV",104,0)
 ..S $P(PSBREC,U,11)=PSBINFDT K PSBINFDT
"RTN","PSBVDLIV",105,0)
 ..S PSBSTUS=PSBINFST,$P(PSBREC,U,20)=PSBSTUS K PSBINFST
"RTN","PSBVDLIV",106,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLIV",107,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLIV",108,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;Set injectable med route flag
"RTN","PSBVDLIV",109,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLIV",110,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLIV",111,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLIV",112,0)
 .S $P(PSBREC,U,18)=PSBIVT  ;IV TYPE
"RTN","PSBVDLIV",113,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLIV",114,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLIV",115,0)
 .;
"RTN","PSBVDLIV",116,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLIV",117,0)
 .D NOW^%DTC
"RTN","PSBVDLIV",118,0)
 .S (PSBDDS,PSBSOLS,PSBADDS)="0"
"RTN","PSBVDLIV",119,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLIV",120,0)
 ..Q:$P(PSBDDA(Y),U,4)&($P(PSBDDA(Y),U,4)<%)  ; Inactive
"RTN","PSBVDLIV",121,0)
 ..S:$P(PSBDDA(Y),U,3)="" $P(PSBDDA(Y),U,3)=1
"RTN","PSBVDLIV",122,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,3)
"RTN","PSBVDLIV",123,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLIV",124,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLIV",125,0)
 .S PSBQRR=0
"RTN","PSBVDLIV",126,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D  Q
"RTN","PSBVDLIV",127,0)
 ..I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"IVTAB",0)=2,^TMP("PSB",$J,"IVTAB",1)=1,^TMP("PSB",$J,"IVTAB",2)=1 Q
"RTN","PSBVDLIV",128,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",129,0)
 ..S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",130,0)
 .;
"RTN","PSBVDLIV",131,0)
 .; IV's - don't worry about admin times if blank
"RTN","PSBVDLIV",132,0)
 .I PSBONX["V",PSBIVT'="P",PSBADST="" D  Q
"RTN","PSBVDLIV",133,0)
 ..I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"IVTAB",0)=2,^TMP("PSB",$J,"IVTAB",1)=1,^TMP("PSB",$J,"IVTAB",2)=1 Q
"RTN","PSBVDLIV",134,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",135,0)
 ..S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",136,0)
 .;
"RTN","PSBVDLIV",137,0)
 .; Now we deal with only continuous
"RTN","PSBVDLIV",138,0)
 .; process admintimes
"RTN","PSBVDLIV",139,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLIV",140,0)
 .S PSBADMIN=PSBADST
"RTN","PSBVDLIV",141,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLIV",142,0)
 .; build all orders for both days.
"RTN","PSBVDLIV",143,0)
 .F PSBY=1:1 Q:$P(PSBADMIN,"-",PSBY)=""  D
"RTN","PSBVDLIV",144,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLIV",145,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLIV",146,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLIV",147,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLIV",148,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,$P(PSB,"."),PSBSCH,PSBON,PSBOITX,PSBFREQ)  ; Okay on this date?
"RTN","PSBVDLIV",149,0)
 .....I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"IVTAB",0)=2,^TMP("PSB",$J,"IVTAB",1)=1,^TMP("PSB",$J,"IVTAB",2)=1 Q
"RTN","PSBVDLIV",150,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",151,0)
 .....S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",152,0)
 ..;
"RTN","PSBVDLIV",153,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLIV",154,0)
 ..;
"RTN","PSBVDLIV",155,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLIV",156,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLIV",157,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLIV",158,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLIV",159,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,$P(PSB,"."),PSBSCH,PSBON,PSBOITX,PSBFREQ)  ; Okay on this date?
"RTN","PSBVDLIV",160,0)
 .....I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"IVTAB",0)=2,^TMP("PSB",$J,"IVTAB",1)=1,^TMP("PSB",$J,"IVTAB",2)=1 Q
"RTN","PSBVDLIV",161,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",162,0)
 .....S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",163,0)
 K ^TMP("PSB",$J,"ON IVTAB")
"RTN","PSBVDLIV",164,0)
 ;
"RTN","PSBVDLIV",165,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLIV",166,0)
 D:PSBDOADD VNURSE^PSBVDLU1("IVTAB")
"RTN","PSBVDLIV",167,0)
 Q
"RTN","PSBVDLIV",168,0)
 ;
"RTN","PSBVDLPA")
0^1^B13072762^B13252041
"RTN","PSBVDLPA",1,0)
PSBVDLPA ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBVDLPA",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,16,13,38**;Mar 2004;Build 8
"RTN","PSBVDLPA",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVDLPA",4,0)
 ;
"RTN","PSBVDLPA",5,0)
 ; called by PSBVDLUD to find patches not removed
"RTN","PSBVDLPA",6,0)
 ;
"RTN","PSBVDLPA",7,0)
 ; Reference/IA
"RTN","PSBVDLPA",8,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLPA",9,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBVDLPA",10,0)
 ;
"RTN","PSBVDLPA",11,0)
EN ;
"RTN","PSBVDLPA",12,0)
 S PSBGNODE="^PSB(53.79,"_"""APATCH"""_","_DFN_")"
"RTN","PSBVDLPA",13,0)
 F  S PSBGNODE=$Q(@PSBGNODE) Q:($QS(PSBGNODE,2)'="APATCH")!($QS(PSBGNODE,3)'=DFN)  D
"RTN","PSBVDLPA",14,0)
 .S PSBIEN=$QS(PSBGNODE,5)
"RTN","PSBVDLPA",15,0)
 .I '$D(^PSB(53.79,PSBIEN,.5,1)) Q
"RTN","PSBVDLPA",16,0)
 .I $P(^PSB(53.79,PSBIEN,.5,1,0),U,4)'="PATCH" Q
"RTN","PSBVDLPA",17,0)
 .I "G"'[$P(^PSB(53.79,PSBIEN,0),U,9)!($D(PSBONVDL(PSBIEN))) Q
"RTN","PSBVDLPA",18,0)
 .S PSBPBK=+($$GET^XPAR("DIV","PSB VDL PATCH DAYS"))
"RTN","PSBVDLPA",19,0)
 .S PSBZON=$P(^PSB(53.79,PSBIEN,.1),"^")
"RTN","PSBVDLPA",20,0)
 .D CLEAN^PSBVT
"RTN","PSBVDLPA",21,0)
 .D PSJ1^PSBVT(DFN,PSBZON)
"RTN","PSBVDLPA",22,0)
 .I PSBPBK'=0 D NOW^%DTC I ($$FMADD^XLFDT($P(PSBOSP,"."),(PSBPBK))<X) Q
"RTN","PSBVDLPA",23,0)
 .S $P(PSBREC,U,1)=DFN  ; dfn
"RTN","PSBVDLPA",24,0)
 .S $P(PSBREC,U,2)=PSBONX  ; order numer
"RTN","PSBVDLPA",25,0)
 .S $P(PSBREC,U,3)=PSBON  ; order ien
"RTN","PSBVDLPA",26,0)
 .S $P(PSBREC,U,4)="U"  ; order type U unit dose
"RTN","PSBVDLPA",27,0)
 .S $P(PSBREC,U,5)=PSBSCHT
"RTN","PSBVDLPA",28,0)
 .S $P(PSBREC,U,6)=PSBSCH
"RTN","PSBVDLPA",29,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"")
"RTN","PSBVDLPA",30,0)
 .S $P(PSBREC,U,8)=PSBOITX
"RTN","PSBVDLPA",31,0)
 .S $P(PSBREC,U,9)=PSBDOSE
"RTN","PSBVDLPA",32,0)
 .S $P(PSBREC,U,10)=PSBMR
"RTN","PSBVDLPA",33,0)
 .S:$D(PSBHSTAX(PSBOIT)) $P(PSBREC,U,11)=$O(PSBHSTAX(PSBOIT,""),-1),$P(PSBREC,U,20)=$O(PSBHSTAX(PSBOIT,$P(PSBREC,U,11),""),-1)
"RTN","PSBVDLPA",34,0)
 .D:'$D(PSBHSTAX(PSBOIT))
"RTN","PSBVDLPA",35,0)
 ..N PSBX,PSBY,PSBDONE S PSBDONE=0,PSBX="" F  S PSBX=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,PSBX),-1) Q:PSBX=""  D:'PSBDONE
"RTN","PSBVDLPA",36,0)
 ...S PSBY="" F  S PSBY=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,PSBX,PSBY),-1) Q:PSBY=""  D:'PSBDONE
"RTN","PSBVDLPA",37,0)
 ....S:$P(^PSB(53.79,PSBY,0),U,9)'="N" $P(PSBREC,U,20)=$P(^PSB(53.79,PSBY,0),U,9) S:($P(PSBREC,U,20)'="N")&($P(PSBREC,U,20)]"") $P(PSBREC,U,11)=PSBX,PSBDONE=1
"RTN","PSBVDLPA",38,0)
 .S $P(PSBREC,U,12)=PSBIEN
"RTN","PSBVDLPA",39,0)
 .S $P(PSBREC,U,13)="G"
"RTN","PSBVDLPA",40,0)
 .S $P(PSBREC,U,14)=$P(^PSB(53.79,PSBIEN,.1),U,3)
"RTN","PSBVDLPA",41,0)
 .I $P(PSBREC,U,14)="" S $P(PSBREC,U,14)=PSBNOW\1
"RTN","PSBVDLPA",42,0)
 .S $P(PSBREC,U,15)=PSBOIT
"RTN","PSBVDLPA",43,0)
 .D:$G(PSBTAB)="CVRSHT"
"RTN","PSBVDLPA",44,0)
 ..S $P(PSBREC,U,16)=PSBNJECT  ;Set injectable med route flag
"RTN","PSBVDLPA",45,0)
 ..I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLPA",46,0)
 ..E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLPA",47,0)
 ..S $P(PSBREC,U,19)=$S(PSBVNI]"":PSBVNI,PSBVNI']"":"***")
"RTN","PSBVDLPA",48,0)
 ..S $P(PSBREC,U,23)=""
"RTN","PSBVDLPA",49,0)
 ..S $P(PSBREC,U,26)=PSBOSP
"RTN","PSBVDLPA",50,0)
 ..S $P(PSBREC,U,27)=$$LASTG^PSBCSUTL($P(PSBREC,U),$P(PSBREC,U,15))
"RTN","PSBVDLPA",51,0)
 ..S $P(PSBREC,U,28)=1
"RTN","PSBVDLPA",52,0)
 ..; Place into Coversheet activity ARRAY
"RTN","PSBVDLPA",53,0)
 ..S PSBDIDX="" I $D(^PSB(53.79,"AORD",DFN,PSBONX)) D
"RTN","PSBVDLPA",54,0)
 ...S PSBXDTI="",PSBXDTI=$O(^PSB(53.79,"AORD",DFN,PSBONX,PSBXDTI),-1)
"RTN","PSBVDLPA",55,0)
 ...Q:'$D(^PSB(53.79,"AORD",DFN,PSBONX,PSBXDTI,PSBIEN))
"RTN","PSBVDLPA",56,0)
 ...S PSBADMX(PSBONX,PSBXDTI,PSBIEN)="",PSBDIDX=1
"RTN","PSBVDLPA",57,0)
 ..I ('PSBDIDX)&$D(^PSB(53.79,"AORDX",DFN,PSBONX)) D
"RTN","PSBVDLPA",58,0)
 ...S PSBXXDTI="",PSBXXDTI=$O(^PSB(53.79,"AORDX",DFN,PSBONX,PSBXXDTI),-1)
"RTN","PSBVDLPA",59,0)
 ...Q:'$D(^PSB(53.79,"AORDX",DFN,PSBONX,PSBXXDTI,PSBIEN))
"RTN","PSBVDLPA",60,0)
 ...S PSBADMX(PSBONX,PSBXXDTI,PSBIEN)=""
"RTN","PSBVDLPA",61,0)
 .S $P(PSBREC,U,18)="PATCH"
"RTN","PSBVDLPA",62,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLPA",63,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLPA",64,0)
 .S PSBDDS="" F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1 S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4),$P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLPA",65,0)
 .S PSBQRR=1
"RTN","PSBVDLPA",66,0)
 .D ADD^PSBVDLU1(PSBREC,PSBOTXT,$P(PSBREC,U,14),PSBDDS,"","",$S($G(PSBTAB)="CVRSHT":"CVRSHT",1:"UDTAB"))
"RTN","PSBVDLPA",67,0)
 K PSBPBK,PSBONVDL
"RTN","PSBVDLPA",68,0)
 Q
"RTN","PSBVDLPB")
0^6^B83184850^B84312284
"RTN","PSBVDLPB",1,0)
PSBVDLPB ;BIRMINGHAM/EFC-BCMA IV VIRTUAL DUE LIST ;Mar 2004
"RTN","PSBVDLPB",2,0)
 ;;3.0;BAR CODE MED ADMIN;**11,13,38**;Mar 2004;Build 8
"RTN","PSBVDLPB",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVDLPB",4,0)
 ;
"RTN","PSBVDLPB",5,0)
 ; Reference/IA
"RTN","PSBVDLPB",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLPB",7,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLPB",8,0)
 ; File 200/10060
"RTN","PSBVDLPB",9,0)
 ;
"RTN","PSBVDLPB",10,0)
EN(DFN,PSBDT) ; Default Order List Return for Today
"RTN","PSBVDLPB",11,0)
 ;
"RTN","PSBVDLPB",12,0)
 ; RPC: PSB GETORDERLIST
"RTN","PSBVDLPB",13,0)
 ;
"RTN","PSBVDLPB",14,0)
 ; Description:
"RTN","PSBVDLPB",15,0)
 ; Returns the current IV order set for today to display on the
"RTN","PSBVDLPB",16,0)
 ; client VDL
"RTN","PSBVDLPB",17,0)
 ;
"RTN","PSBVDLPB",18,0)
 ;
"RTN","PSBVDLPB",19,0)
 N PSBDATA,PSBTBOUT
"RTN","PSBVDLPB",20,0)
 S PSBTBOUT=0,PSBDOADD=0
"RTN","PSBVDLPB",21,0)
 S:PSBTAB="PBTAB" PSBDOADD=1
"RTN","PSBVDLPB",22,0)
 ;
"RTN","PSBVDLPB",23,0)
 ;This routine now re-uses the ^TMP("PSJ",$J global built in PSBVDLTB
"RTN","PSBVDLPB",24,0)
 ;
"RTN","PSBVDLPB",25,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 Q  ; No orders
"RTN","PSBVDLPB",26,0)
 ;
"RTN","PSBVDLPB",27,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBVDLPB",28,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX)
"RTN","PSBVDLPB",29,0)
 .;
"RTN","PSBVDLPB",30,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLPB",31,0)
 .;
"RTN","PSBVDLPB",32,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLPB",33,0)
 .Q:'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH)
"RTN","PSBVDLPB",34,0)
 .Q:PSBOST>PSBWADM  ; Order Start Date/Time > admin window
"RTN","PSBVDLPB",35,0)
 .Q:PSBOSP<PSBWBEG  ; For all Order Stop Date/Time < vdl window
"RTN","PSBVDLPB",36,0)
 .Q:PSBOSTS["D"  ;     Is it DC'd
"RTN","PSBVDLPB",37,0)
 .Q:PSBNGF  ;  Is it marked DO NOT GIVE!
"RTN","PSBVDLPB",38,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLPB",39,0)
 .;
"RTN","PSBVDLPB",40,0)
 .D NOW^%DTC
"RTN","PSBVDLPB",41,0)
 .Q:PSBOSP<%
"RTN","PSBVDLPB",42,0)
 .;
"RTN","PSBVDLPB",43,0)
 .; include Active, Renewed, ReInstated and On Call
"RTN","PSBVDLPB",44,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call)
"RTN","PSBVDLPB",45,0)
 .Q:PSBSCHT'="O"&((PSBOSTS'="A")&(PSBOSTS'="R")&(PSBOSTS'="RE")&(PSBOSTS'="O")&(PSBOSTS'="H"))
"RTN","PSBVDLPB",46,0)
 .;
"RTN","PSBVDLPB",47,0)
 .; Is One Time Given
"RTN","PSBVDLPB",48,0)
 .;
"RTN","PSBVDLPB",49,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLPB",50,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLPB",51,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLPB",52,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  S:($P(^PSB(53.79,Y,.1),U)=PSBONX)&($P(^PSB(53.79,Y,0),U,9)="G") PSBGVN=1,(X,Y)=0
"RTN","PSBVDLPB",53,0)
 .;
"RTN","PSBVDLPB",54,0)
 .; How long does One Time remain on VDL ?
"RTN","PSBVDLPB",55,0)
 .S PSBRMN=1
"RTN","PSBVDLPB",56,0)
 .I PSBSCHT="O",PSBOSP'=PSBOST,%>PSBOSP S PSBRMN=0
"RTN","PSBVDLPB",57,0)
 .Q:'PSBRMN
"RTN","PSBVDLPB",58,0)
 .;
"RTN","PSBVDLPB",59,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLPB",60,0)
 .;
"RTN","PSBVDLPB",61,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLPB",62,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLPB",63,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLPB",64,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  S:($P(^PSB(53.79,Y,.1),U)=PSBON)&($P(^PSB(53.79,Y,0),U,9)="G") PSBGVN=1,(X,Y)=0
"RTN","PSBVDLPB",65,0)
 .;
"RTN","PSBVDLPB",66,0)
 .S PSBSTRT=PSBOST ; Order Start Date/Time
"RTN","PSBVDLPB",67,0)
 .S PSBSTOP=PSBOSP ; Order Stop Date/Time
"RTN","PSBVDLPB",68,0)
 .;
"RTN","PSBVDLPB",69,0)
 .S PSBREC=""
"RTN","PSBVDLPB",70,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLPB",71,0)
 .S $P(PSBREC,U,2)=PSBONX ; Order
"RTN","PSBVDLPB",72,0)
 .S $P(PSBREC,U,3)=+PSBON ; order ien
"RTN","PSBVDLPB",73,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLPB",74,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLPB",75,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLPB",76,0)
 .S Y=""
"RTN","PSBVDLPB",77,0)
 .S:PSBSM Y="SM"
"RTN","PSBVDLPB",78,0)
 .S:PSBHSM Y="HSM"
"RTN","PSBVDLPB",79,0)
 .S $P(PSBREC,U,7)=Y ; self med
"RTN","PSBVDLPB",80,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLPB",81,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLPB",82,0)
 .S $P(PSBREC,U,10)=PSBMR ;med route
"RTN","PSBVDLPB",83,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLPB",84,0)
 .S (YZ,PSBSTUS,PSBADMER)="" K PSBHSTA,PSBHSTAX
"RTN","PSBVDLPB",85,0)
 .F XZ=1:1:20 S YZ=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ),-1),(PSBCNT,PSBFLAG)=0 Q:YZ=""  D
"RTN","PSBVDLPB",86,0)
 ..S:YZ>0 $P(PSBREC,U,11)=YZ
"RTN","PSBVDLPB",87,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ,X),-1) Q:X=""  D
"RTN","PSBVDLPB",88,0)
 ...K PSBLCK L +^PSB(53.79,X):1  I  L -^PSB(53.79,X) S PSBLCK=1
"RTN","PSBVDLPB",89,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLPB",90,0)
 ...I $G(PSBSTUS)="" S:'$G(PSBLCK) PSBSTUS="X" I $G(PSBLCK) S PSBADMER=1 D
"RTN","PSBVDLPB",91,0)
 ....K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLPB",92,0)
 ....S PSBPARM6=X,Y=$P(^PSB(53.79,X,.1),U,3) D DD^%DT S PSBPARM3=Y,Y=$P(^PSB(53.79,X,0),U,6) D DD^%DT S PSBPARM5=Y
"RTN","PSBVDLPB",93,0)
 ....S PSBPARM7=$P(^PSB(53.79,X,0),U,7) S PSBPARM7="( # "_PSBPARM7_" ) "_$$GET1^DIQ(200,PSBPARM7_",",.01)
"RTN","PSBVDLPB",94,0)
 ....K PSBXTMP S PSBXTMP=PSBONX
"RTN","PSBVDLPB",95,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,$$GET1^DIQ(53.79,PSBPARM6_",",.11))
"RTN","PSBVDLPB",96,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,PSBPARM3_" admin's ACTION STATUS is ""UNKNOWN"".",PSBSCH,PSBPARM5,PSBPARM6,PSBPARM7) ;  SEND AN E-MAIL
"RTN","PSBVDLPB",97,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBXTMP)  ;Reset Variables
"RTN","PSBVDLPB",98,0)
 ....S X=PSBPARM6 K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLPB",99,0)
 ...K PSBLCK S:(PSBSTUS']"") PSBSTUS="U"  I PSBSTUS'="N",($G(PSBSTUS)'="X") S PSBFLAG=1,PSBHSTA(YZ,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBVDLPB",100,0)
 ...D:PSBSTUS="N"
"RTN","PSBVDLPB",101,0)
 ....S $P(PSBREC,U,11)=""
"RTN","PSBVDLPB",102,0)
 ....S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBVDLPB",103,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLPB",104,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLPB",105,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBVDLPB",106,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBVDLPB",107,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBVDLPB",108,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBVDLPB",109,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBVDLPB",110,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBVDLPB",111,0)
 .S $P(PSBREC,U,12)=""  ;med log ien inserted below for actual date
"RTN","PSBVDLPB",112,0)
 .S $P(PSBREC,U,13)=""  ;med log status inserted below for actual date
"RTN","PSBVDLPB",113,0)
 .S $P(PSBREC,U,14)="" ;admin date inserted below
"RTN","PSBVDLPB",114,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLPB",115,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;Set injectable med route flag
"RTN","PSBVDLPB",116,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLPB",117,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLPB",118,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLPB",119,0)
 .S $P(PSBREC,U,18)=PSBIVT  ;IV TYPE - dosage form
"RTN","PSBVDLPB",120,0)
 .S $P(PSBREC,U,20)=$S((PSBSTUS="X")!(PSBSTUS="N"):"",1:PSBSTUS) ;last action status
"RTN","PSBVDLPB",121,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLPB",122,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLPB",123,0)
 .;
"RTN","PSBVDLPB",124,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLPB",125,0)
 .D NOW^%DTC
"RTN","PSBVDLPB",126,0)
 .S (PSBDDS,PSBSOLS,PSBADDS)="0"
"RTN","PSBVDLPB",127,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLPB",128,0)
 ..Q:$P(PSBDDA(Y),U,4)&($P(PSBDDA(Y),U,4)<%)  ; Inactive
"RTN","PSBVDLPB",129,0)
 ..S:$P(PSBDDA(Y),U,3)="" $P(PSBDDA(Y),U,3)=1
"RTN","PSBVDLPB",130,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,3)
"RTN","PSBVDLPB",131,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLPB",132,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLPB",133,0)
 .S PSBQRR=0
"RTN","PSBVDLPB",134,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D  Q
"RTN","PSBVDLPB",135,0)
 ..I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",136,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",137,0)
 .;
"RTN","PSBVDLPB",138,0)
 .; IV's - don't worry about admin times if blank
"RTN","PSBVDLPB",139,0)
 .I PSBONX["V","PSC"'[PSBIVT,PSBADST="" D  Q
"RTN","PSBVDLPB",140,0)
 ..I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",141,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",142,0)
 .;
"RTN","PSBVDLPB",143,0)
 .; Now we deal with only continuous
"RTN","PSBVDLPB",144,0)
 .; process admintimes
"RTN","PSBVDLPB",145,0)
 .S (PSBYES,PSBODD,PSBYTF)=0
"RTN","PSBVDLPB",146,0)
 .S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBVDLPB",147,0)
 .I PSBYES,PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLPB",148,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBVDLPB",149,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLPB",150,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLPB",151,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBVDLPB",152,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBVDLPB",153,0)
 .I 'PSBYES,PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBVDLPB",154,0)
 .S PSBADMIN=PSBADST
"RTN","PSBVDLPB",155,0)
 .I (PSBADMIN="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1("PBTAB") Q  ;calculate admin times based on frequency
"RTN","PSBVDLPB",156,0)
 .; No admin times, MAYDAY MAYDAY!!
"RTN","PSBVDLPB",157,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBVDLPB",158,0)
 .I PSBODD,PSBADST'="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH) Q
"RTN","PSBVDLPB",159,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLPB",160,0)
 .; build all orders for both days.
"RTN","PSBVDLPB",161,0)
 .F PSBY=1:1 Q:$P(PSBADMIN,"-",PSBY)=""  D
"RTN","PSBVDLPB",162,0)
 ..;For invalid admin times
"RTN","PSBVDLPB",163,0)
 ..I ($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N) D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBVDLPB",164,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLPB",165,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLPB",166,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLPB",167,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLPB",168,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,PSB,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLPB",169,0)
 .....I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",170,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",171,0)
 ..;
"RTN","PSBVDLPB",172,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLPB",173,0)
 ..;
"RTN","PSBVDLPB",174,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLPB",175,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLPB",176,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLPB",177,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLPB",178,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,PSB,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLPB",179,0)
 .....I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",180,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",181,0)
 ;
"RTN","PSBVDLPB",182,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLPB",183,0)
 D:PSBDOADD VNURSE^PSBVDLU1("PBTAB")
"RTN","PSBVDLPB",184,0)
 Q
"RTN","PSBVDLPB",185,0)
 ;
"RTN","PSBVDLU3")
0^14^B39144184^B39075787
"RTN","PSBVDLU3",1,0)
PSBVDLU3 ;BIRMINGHAM/TEJ-BCMA VDL UTILITIES 3 ;Mar 2004
"RTN","PSBVDLU3",2,0)
 ;;3.0;BAR CODE MED ADMIN;**13,38**;Mar 2004;Build 8
"RTN","PSBVDLU3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVDLU3",4,0)
 ;
"RTN","PSBVDLU3",5,0)
 ;This routine file has been created to serve as a container
"RTN","PSBVDLU3",6,0)
 ;for Extrinsic Variables/Functions
"RTN","PSBVDLU3",7,0)
 ;
"RTN","PSBVDLU3",8,0)
 ; Reference/IA
"RTN","PSBVDLU3",9,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLU3",10,0)
 ;
"RTN","PSBVDLU3",11,0)
IVPTAB(PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBPUSH)  ;
"RTN","PSBVDLU3",12,0)
 ;
"RTN","PSBVDLU3",13,0)
 ; This function will return
"RTN","PSBVDLU3",14,0)
 ; the value 1 (one) if the
"RTN","PSBVDLU3",15,0)
 ; specified order input will cause
"RTN","PSBVDLU3",16,0)
 ; the order to display on the "IVP/IVPB"
"RTN","PSBVDLU3",17,0)
 ; tab of the VDL BCMA Virtual Due List (VDL)
"RTN","PSBVDLU3",18,0)
 ; else return the value 0 (zero).
"RTN","PSBVDLU3",19,0)
 ;
"RTN","PSBVDLU3",20,0)
 ; Input Parameters:
"RTN","PSBVDLU3",21,0)
 ;
"RTN","PSBVDLU3",22,0)
 ;     PSBORTYP - Order type (e.g. "U","V")
"RTN","PSBVDLU3",23,0)
 ;     PSBIVTYP - IV Type (e.g. "P","S","C")
"RTN","PSBVDLU3",24,0)
 ;     PSBINTSY - Intermittent Syringe value
"RTN","PSBVDLU3",25,0)
 ;     PSBCHMTY - Chemo type (e.g. "P","S")
"RTN","PSBVDLU3",26,0)
 ;     PSBPUSH - IV PUSH Flag (e.g. 0 or 1, 1=IV PUSH)
"RTN","PSBVDLU3",27,0)
 ;
"RTN","PSBVDLU3",28,0)
 ; Output:
"RTN","PSBVDLU3",29,0)
 ;     1 - order will display on the "IVP/IVPB" Tab of BCMA VDL
"RTN","PSBVDLU3",30,0)
 ;     0 - order will NOT display on the "IVP/IVPB" Tab of BCMA VDL
"RTN","PSBVDLU3",31,0)
 ;    -1 - error processed
"RTN","PSBVDLU3",32,0)
 ;
"RTN","PSBVDLU3",33,0)
 Q:'$D(PSBORTYP) "-1^Missing Parameter"
"RTN","PSBVDLU3",34,0)
 I PSBORTYP="U"&(PSBPUSH) Q 1
"RTN","PSBVDLU3",35,0)
 I '(PSBORTYP="V") Q 0
"RTN","PSBVDLU3",36,0)
 I $G(PSBIVTYP)="P" Q 1
"RTN","PSBVDLU3",37,0)
 I $G(PSBIVTYP)="S",$G(PSBINTSY)=1 Q 1
"RTN","PSBVDLU3",38,0)
 I $G(PSBIVTYP)="C",$G(PSBCHMTY)="P" Q 1
"RTN","PSBVDLU3",39,0)
 I $G(PSBIVTYP)="C",$G(PSBCHMTY)="S",$G(PSBINTSY)=1 Q 1
"RTN","PSBVDLU3",40,0)
 Q 0
"RTN","PSBVDLU3",41,0)
 ;
"RTN","PSBVDLU3",42,0)
SHOVDL(DFN,BDATE,OTDATE,PSBTAB) ;
"RTN","PSBVDLU3",43,0)
 ;
"RTN","PSBVDLU3",44,0)
 ; This function will find orders such as discontinued or expired infusing IV bags 
"RTN","PSBVDLU3",45,0)
 ; or discontinued or expired "given" patches.  Recognizing these types of orders
"RTN","PSBVDLU3",46,0)
 ; will allow these orders to be displayed on the VDL and permits the user to take 
"RTN","PSBVDLU3",47,0)
 ; action on them.  This routine determines if such orders exist for patient,
"RTN","PSBVDLU3",48,0)
 ; time, and "BCMA VDL tab."  This routine is an "extention" to the API EN^PSJBCMA.
"RTN","PSBVDLU3",49,0)
 ;
"RTN","PSBVDLU3",50,0)
 ; INPUT Parameters:
"RTN","PSBVDLU3",51,0)
 ;    DFN           (req)   Patient Internal File Number.
"RTN","PSBVDLU3",52,0)
 ;    BDATE         (opt)   Start searching for "order stop" after this date. 
"RTN","PSBVDLU3",53,0)
 ;    OTDATE        (opt)   Include One-Time orders from this date.
"RTN","PSBVDLU3",54,0)
 ;    PSBTAB        (opt)   "UDTAB" or "IVTAB" - expedites process if specific tab
"RTN","PSBVDLU3",55,0)
 ;                            is given.
"RTN","PSBVDLU3",56,0)
 ;
"RTN","PSBVDLU3",57,0)
 ; OUTPUT Values
"RTN","PSBVDLU3",58,0)
 ;    0               absolutely no orders to display on VDL
"RTN","PSBVDLU3",59,0)
 ;    1               displayable orders have been located.
"RTN","PSBVDLU3",60,0)
 ;
"RTN","PSBVDLU3",61,0)
 ;
"RTN","PSBVDLU3",62,0)
 D EN^PSJBCMA(DFN,$G(BDATE),$G(OTDATE))
"RTN","PSBVDLU3",63,0)
 ; any active Patch orders to show on VDL?
"RTN","PSBVDLU3",64,0)
 S PSBFLG=0
"RTN","PSBVDLU3",65,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 D
"RTN","PSBVDLU3",66,0)
 .;  
"RTN","PSBVDLU3",67,0)
 .; Check the indexice for given patches or infusing IVs
"RTN","PSBVDLU3",68,0)
 .;
"RTN","PSBVDLU3",69,0)
 .; Check APATCH
"RTN","PSBVDLU3",70,0)
 .D:($G(PSBTAB)="UDTAB")!($G(PSBTAB)="")  Q:PSBFLG
"RTN","PSBVDLU3",71,0)
 ..S PSBGNODE="^PSB(53.79,"_"""APATCH"""_","_DFN_")" Q:'$D(PSBGNODE)
"RTN","PSBVDLU3",72,0)
 ..F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE=""  Q:$QS(PSBGNODE,3)'=DFN  Q:PSBFLG  S PSBIEN=$QS(PSBGNODE,5),PSBFLG=$S($P(^PSB(53.79,PSBIEN,0),U,9)="G":1,1:0)
"RTN","PSBVDLU3",73,0)
 .;
"RTN","PSBVDLU3",74,0)
 .; Check AUID
"RTN","PSBVDLU3",75,0)
 .;
"RTN","PSBVDLU3",76,0)
 .D:(($G(PSBTAB)="IVTAB")!($G(PSBTAB)=""))&('PSBFLG)  Q:PSBFLG
"RTN","PSBVDLU3",77,0)
 ..S PSBGNODE="^PSB(53.79,"_"""AUID"""_","_DFN_")" Q:'$D(PSBGNODE)
"RTN","PSBVDLU3",78,0)
 ..F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE=""  Q:$QS(PSBGNODE,3)'=DFN  Q:PSBFLG  S PSBIEN=$QS(PSBGNODE,6),PSBFLG=$S($P(^PSB(53.79,PSBIEN,0),U,9)="I":1,1:0)
"RTN","PSBVDLU3",79,0)
 .;
"RTN","PSBVDLU3",80,0)
 .;  NOTE: Infusing bags will not display if DCed more than 3 days ago!
"RTN","PSBVDLU3",81,0)
 .;
"RTN","PSBVDLU3",82,0)
 S:$G(^TMP("PSJ",$J,1,0))'=-1 PSBFLG=1
"RTN","PSBVDLU3",83,0)
 ;
"RTN","PSBVDLU3",84,0)
 Q PSBFLG
"RTN","PSBVDLU3",85,0)
 ;
"RTN","PSBVDLU3",86,0)
FNDACTV(RESULTS,PARAMS) ;   Utility to check and order for the latest " ? (parameter #3) " order activities per patient (parameter #1)
"RTN","PSBVDLU3",87,0)
 ; #parameter= # "^"piece
"RTN","PSBVDLU3",88,0)
 ;       #1 DFN - Patient's IEN          e.g. 1234               (required)
"RTN","PSBVDLU3",89,0)
 ;       #2 Order Number_Order Type      e.g. "1V"               "" = all orders
"RTN","PSBVDLU3",90,0)
 ;       #3 Search for Activity          e.g. "H"                "" = *unknown* activity
"RTN","PSBVDLU3",91,0)
 ;       #4 Search "back"time(hours)     e.g. 12                 "" = search back 3 admins   
"RTN","PSBVDLU3",92,0)
 ;                                                 NOTE:  ="FREQ"  This Function will use order's frequency.
"RTN","PSBVDLU3",93,0)
 ;                                                 1. If the order is a PRN, On Call or One-Time 
"RTN","PSBVDLU3",94,0)
 ;                                                 the look back a default of 72 hours.
"RTN","PSBVDLU3",95,0)
 ;                                                 2. if the order is a Continuous order key off
"RTN","PSBVDLU3",96,0)
 ;                                                 of the frequency as follows.
"RTN","PSBVDLU3",97,0)
 ;                                                      a.) if the frequency is <24 hours use the
"RTN","PSBVDLU3",98,0)
 ;                                                        default of 72 hours.
"RTN","PSBVDLU3",99,0)
 ;                                                      b.) if the frequency is >= 24 hour, look back
"RTN","PSBVDLU3",100,0)
 ;                                                        3.5 times the frequency
"RTN","PSBVDLU3",101,0)
 ;                                                 NOTE:  ["X#"    This Function will search back # of admins.
"RTN","PSBVDLU3",102,0)
 ;  
"RTN","PSBVDLU3",103,0)
 ;  Example call: D FNDACTV^PSBVDLU3(.results,"1234^1U^H^12")
"RTN","PSBVDLU3",104,0)
 ;
"RTN","PSBVDLU3",105,0)
 ;
"RTN","PSBVDLU3",106,0)
 N PSBNOW,PSBDFN,PSBON,PSBCNT,PSBACT,PSBTMFRM,PSBX,PSBSET,PSBFRQ
"RTN","PSBVDLU3",107,0)
 K RESULTS
"RTN","PSBVDLU3",108,0)
 S PSBDFN=$P(PARAMS,U),PSBON=$P(PARAMS,U,2),PSBACT=$P(PARAMS,U,3),PSBTMFRM=$P(PARAMS,U,4)
"RTN","PSBVDLU3",109,0)
 S RESULTS(0)=1
"RTN","PSBVDLU3",110,0)
 I $G(PSBDFN)']"" S RESULTS(0)=1,RESULTS(1)="-1^ERROR - MISSING PARAMETER (DFN REQ.)" Q
"RTN","PSBVDLU3",111,0)
 I $G(PSBTMFRM)="" S PSBX=3
"RTN","PSBVDLU3",112,0)
 I $G(PSBTMFRM)["X" S PSBX=+($P(PSBTMFRM,"X",2)),PSBTMFRM=""
"RTN","PSBVDLU3",113,0)
 I $G(PSBTMFRM)]"",$G(PSBTMFRM)'["FREQ" D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM),PSBSET=1 S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",114,0)
 I $G(PSBX)="" S PSBX=9999999
"RTN","PSBVDLU3",115,0)
 D:$G(PSBON)'=""
"RTN","PSBVDLU3",116,0)
 .K ^TMP("PSJ",$J) D EN^PSJBCMA1(PSBDFN,PSBON)
"RTN","PSBVDLU3",117,0)
 .;Maintain Time Frame and other order information
"RTN","PSBVDLU3",118,0)
 .I $G(PSBTMFRM)["FREQ" D
"RTN","PSBVDLU3",119,0)
 ..S PSBFRQ=+$P(^TMP("PSJ",$J,4),"^",11) I PSBFRQ=0 S PSBFRQ=1440
"RTN","PSBVDLU3",120,0)
 ..I "P^OC^O^"[($P(^TMP("PSJ",$J,4),"^")_"^") S PSBTMFRM=72 Q
"RTN","PSBVDLU3",121,0)
 ..I (PSBFRQ/60)<24 S PSBTMFRM=72 Q
"RTN","PSBVDLU3",122,0)
 ..I (PSBFRQ/60)'<24 S PSBTMFRM=(PSBFRQ/60)*3.5
"RTN","PSBVDLU3",123,0)
 .I '$G(PSBSET) D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM) S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",124,0)
 .S I="",X=0 F  S I=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I),-1)  Q:(I="")!(I<$S(PSBTMFRM]"":PSBTMFRM,1:-1))  D  Q:X
"RTN","PSBVDLU3",125,0)
 ..S Z=0,J="",PSBCNT=0 F  S J=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I,J),-1)  Q:(J="")  S Z=Z+1 Q:Z>PSBX  D  Q:X
"RTN","PSBVDLU3",126,0)
 ...L +^PSB(53.79,J):1
"RTN","PSBVDLU3",127,0)
 ...I  L -^PSB(53.79,J)
"RTN","PSBVDLU3",128,0)
 ...E  Q
"RTN","PSBVDLU3",129,0)
 ...I ($P(^PSB(53.79,J,0),U,9)=PSBACT) S X=1 D
"RTN","PSBVDLU3",130,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.02)
"RTN","PSBVDLU3",131,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$P(^TMP("PSJ",$J,2),U,2)_"^"_($$GET1^DIQ(53.79,J_",",.11))
"RTN","PSBVDLU3",132,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.06,"I")
"RTN","PSBVDLU3",133,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.13,"I")
"RTN","PSBVDLU3",134,0)
 D:$G(PSBON)=""
"RTN","PSBVDLU3",135,0)
 .S Z="",X=0 F  S Z=$O(^PSB(53.79,"AORDX",PSBDFN,Z),-1)  Q:(Z="")  S PSBON=Z D  Q:X
"RTN","PSBVDLU3",136,0)
 ..;Maintain Time Frame and other order information
"RTN","PSBVDLU3",137,0)
 ..K ^TMP("PSJ",$J) D EN^PSJBCMA1(PSBDFN,PSBON)
"RTN","PSBVDLU3",138,0)
 ..I $G(PSBTMFRM)["FREQ" D
"RTN","PSBVDLU3",139,0)
 ...S PSBFRQ=+$P(^TMP("PSJ",$J,4),"^",11) I PSBFRQ=0 S PSBFRQ=1440
"RTN","PSBVDLU3",140,0)
 ...I "P^OC^O^"[($P(^TMP("PSJ",$J,4),"^")_"^") S PSBTMFRM=72 Q
"RTN","PSBVDLU3",141,0)
 ...I (PSBFRQ/60)<24 S PSBTMFRM=72 Q
"RTN","PSBVDLU3",142,0)
 ...I (PSBFRQ/60)'<24 S PSBTMFRM=(PSBFRQ/60)*3.5
"RTN","PSBVDLU3",143,0)
 ..I '$G(PSBSET) D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM) S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",144,0)
 ..S I="" F  S I=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I),-1)  Q:(I="")!(I<$S(PSBTMFRM]"":PSBTMFRM,1:-1))  D  Q:X
"RTN","PSBVDLU3",145,0)
 ...S ZZ=0,J="",PSBCNT=0 F  S J=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I,J),-1)  Q:(J="")  S ZZ=ZZ+1 Q:ZZ>PSBX  D  Q:X
"RTN","PSBVDLU3",146,0)
 ....L +^PSB(53.79,J):1
"RTN","PSBVDLU3",147,0)
 ....I  L -^PSB(53.79,J)
"RTN","PSBVDLU3",148,0)
 ....E  Q
"RTN","PSBVDLU3",149,0)
 ....I ($P(^PSB(53.79,J,0),U,9)=PSBACT) S X=1 D
"RTN","PSBVDLU3",150,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.02)
"RTN","PSBVDLU3",151,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$P(^TMP("PSJ",$J,2),U,2)_"^"_($$GET1^DIQ(53.79,J_",",.11))
"RTN","PSBVDLU3",152,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.06,"I")
"RTN","PSBVDLU3",153,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.13,"I")
"RTN","PSBVDLU3",154,0)
 I $G(PSBCNT)>0 S RESULTS(0)=PSBCNT
"RTN","PSBVDLU3",155,0)
 K ^TMP("PSJ",$J)
"RTN","PSBVDLU3",156,0)
 Q
"RTN","PSBVDLU3",157,0)
 ;
"RTN","PSBVDLUD")
0^7^B75040119^B75826811
"RTN","PSBVDLUD",1,0)
PSBVDLUD ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBVDLUD",2,0)
 ;;3.0;BAR CODE MED ADMIN;**11,13,38**;Mar 2004;Build 8
"RTN","PSBVDLUD",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVDLUD",4,0)
 ;
"RTN","PSBVDLUD",5,0)
 ; Reference/IA
"RTN","PSBVDLUD",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLUD",7,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLUD",8,0)
 ;
"RTN","PSBVDLUD",9,0)
EN(DFN,PSBDT) ;
"RTN","PSBVDLUD",10,0)
 ;
"RTN","PSBVDLUD",11,0)
 ;
"RTN","PSBVDLUD",12,0)
 ; Description:
"RTN","PSBVDLUD",13,0)
 ; Returns the current unit dose order set for today to display
"RTN","PSBVDLUD",14,0)
 ; on the client VDL
"RTN","PSBVDLUD",15,0)
 ;
"RTN","PSBVDLUD",16,0)
 N PSBDATA,PSBTBOUT
"RTN","PSBVDLUD",17,0)
 S PSBTBOUT=0
"RTN","PSBVDLUD",18,0)
 ;
"RTN","PSBVDLUD",19,0)
 ;This routine now re-uses the ^TMP("PSJ",$J global built in PSBVDLTB
"RTN","PSBVDLUD",20,0)
 ;
"RTN","PSBVDLUD",21,0)
 G:$G(^TMP("PSJ",$J,1,0))=-1 1
"RTN","PSBVDLUD",22,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBVDLUD",23,0)
 .S:(PSBTAB'="UDTAB")&($G(^TMP("PSB",$J,"UDTAB",2))>0) PSBTBOUT=1
"RTN","PSBVDLUD",24,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX)
"RTN","PSBVDLUD",25,0)
 .;
"RTN","PSBVDLUD",26,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLUD",27,0)
 .;
"RTN","PSBVDLUD",28,0)
 .Q:PSBONX["V"  ;No IVs on UD tab
"RTN","PSBVDLUD",29,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLUD",30,0)
 .Q:PSBOST>PSBWADM  ; Order Start Date/Time > admin window
"RTN","PSBVDLUD",31,0)
 .Q:PSBOSP<PSBWBEG  ; For Non one-times Order Stop Date/Time < vdl window
"RTN","PSBVDLUD",32,0)
 .Q:PSBOSTS["D"  ;     Is it DC'd
"RTN","PSBVDLUD",33,0)
 .Q:PSBNGF  ;         Is it marked DO NOT GIVE!
"RTN","PSBVDLUD",34,0)
 .Q:PSBIVPSH
"RTN","PSBVDLUD",35,0)
 .;
"RTN","PSBVDLUD",36,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLUD",37,0)
 .;
"RTN","PSBVDLUD",38,0)
 .D NOW^%DTC
"RTN","PSBVDLUD",39,0)
 .Q:PSBOSP<%
"RTN","PSBVDLUD",40,0)
 .;
"RTN","PSBVDLUD",41,0)
 .; include Active, Renewed, ReInstated and On Call
"RTN","PSBVDLUD",42,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call)
"RTN","PSBVDLUD",43,0)
 .I PSBSCHT'="O",PSBOSTS'="A",PSBOSTS'="H",PSBOSTS'="R",PSBOSTS'="RE",PSBOSTS'="O" Q
"RTN","PSBVDLUD",44,0)
 .;
"RTN","PSBVDLUD",45,0)
 .; Is One Time Given
"RTN","PSBVDLUD",46,0)
 .;
"RTN","PSBVDLUD",47,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLUD",48,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLUD",49,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLUD",50,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLUD",51,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLUD",52,0)
 .;
"RTN","PSBVDLUD",53,0)
 .; How long does One Time remain on VDL ??
"RTN","PSBVDLUD",54,0)
 .S PSBRMN=1
"RTN","PSBVDLUD",55,0)
 .I PSBSCHT="O",PSBOSP'=PSBOST&(%>PSBOSP) S PSBRMN=0
"RTN","PSBVDLUD",56,0)
 .Q:'PSBRMN
"RTN","PSBVDLUD",57,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLUD",58,0)
 .;
"RTN","PSBVDLUD",59,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLUD",60,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLUD",61,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLUD",62,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLUD",63,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLUD",64,0)
 .;
"RTN","PSBVDLUD",65,0)
 .S PSBREC=""
"RTN","PSBVDLUD",66,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLUD",67,0)
 .S $P(PSBREC,U,2)=PSBONX ; order
"RTN","PSBVDLUD",68,0)
 .S $P(PSBREC,U,3)=PSBON ; order ien
"RTN","PSBVDLUD",69,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLUD",70,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLUD",71,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLUD",72,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; self med
"RTN","PSBVDLUD",73,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLUD",74,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLUD",75,0)
 .S $P(PSBREC,U,10)=PSBMR ; med route
"RTN","PSBVDLUD",76,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLUD",77,0)
 .S (PSBCNT,PSBFLAG)=0,(YZ,PSBSTUS,PSBADMER)="" K PSBHSTA,PSBHSTAX
"RTN","PSBVDLUD",78,0)
 .F XZ=1:1:20 S YZ=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ),-1),(PSBCNT,PSBFLAG)=0 Q:YZ=""  D
"RTN","PSBVDLUD",79,0)
 ..S:YZ>0 $P(PSBREC,U,11)=YZ
"RTN","PSBVDLUD",80,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ,X),-1) Q:X=""  D
"RTN","PSBVDLUD",81,0)
 ...K PSBLCK L +^PSB(53.79,X):1  I  L -^PSB(53.79,X) S PSBLCK=1
"RTN","PSBVDLUD",82,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLUD",83,0)
 ...I $G(PSBSTUS)="" S:'$G(PSBLCK) PSBSTUS="X" I $G(PSBLCK) S PSBADMER=1 D
"RTN","PSBVDLUD",84,0)
 ....K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLUD",85,0)
 ....S PSBPARM6=X,Y=$P(^PSB(53.79,X,.1),U,3) D DD^%DT S PSBPARM3=Y,Y=$P(^PSB(53.79,X,0),U,6) D DD^%DT S PSBPARM5=Y
"RTN","PSBVDLUD",86,0)
 ....S PSBPARM7=$P(^PSB(53.79,X,0),U,7) S PSBPARM7="( # "_PSBPARM7_" ) "_$$GET1^DIQ(200,PSBPARM7_",",.01)
"RTN","PSBVDLUD",87,0)
 ....K PSBXTMP S PSBXTMP=PSBONX
"RTN","PSBVDLUD",88,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,$$GET1^DIQ(53.79,PSBPARM6_",",.11))
"RTN","PSBVDLUD",89,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,PSBPARM3_" admin's ACTION STATUS is ""UNKNOWN"".",PSBSCH,PSBPARM5,PSBPARM6,PSBPARM7) ;  SEND AN E-MAIL
"RTN","PSBVDLUD",90,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBXTMP)  ;Reset Variables
"RTN","PSBVDLUD",91,0)
 ....S X=PSBPARM6 K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLUD",92,0)
 ...K PSBLCK S:(PSBSTUS']"") PSBSTUS="U"  I PSBSTUS'="N",($G(PSBSTUS)'="X") S PSBFLAG=1,PSBHSTA(YZ,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBVDLUD",93,0)
 ...D:PSBSTUS="N"
"RTN","PSBVDLUD",94,0)
 ....S $P(PSBREC,U,11)=""
"RTN","PSBVDLUD",95,0)
 ....S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBVDLUD",96,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLUD",97,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLUD",98,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBVDLUD",99,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBVDLUD",100,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBVDLUD",101,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBVDLUD",102,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBVDLUD",103,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBVDLUD",104,0)
 .S $P(PSBREC,U,12)=""  ;med log ien inserted below for actual date
"RTN","PSBVDLUD",105,0)
 .S $P(PSBREC,U,13)=""  ;med log status inserted below for actual date
"RTN","PSBVDLUD",106,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLUD",107,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLUD",108,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;med route injectable flag
"RTN","PSBVDLUD",109,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLUD",110,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLUD",111,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLUD",112,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ; dosage form
"RTN","PSBVDLUD",113,0)
 .S $P(PSBREC,U,20)=$S((PSBSTUS="X")!(PSBSTUS="N"):"",1:PSBSTUS) ; last action status
"RTN","PSBVDLUD",114,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLUD",115,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLUD",116,0)
 .;
"RTN","PSBVDLUD",117,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLUD",118,0)
 .D NOW^%DTC
"RTN","PSBVDLUD",119,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBVDLUD",120,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLUD",121,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1 ;If drug was inactivated
"RTN","PSBVDLUD",122,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ; Inactive
"RTN","PSBVDLUD",123,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBVDLUD",124,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4)
"RTN","PSBVDLUD",125,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLUD",126,0)
 .;
"RTN","PSBVDLUD",127,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLUD",128,0)
 .S PSBQRR=0
"RTN","PSBVDLUD",129,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"UDTAB") Q
"RTN","PSBVDLUD",130,0)
 .;
"RTN","PSBVDLUD",131,0)
 .; Now we deal with only continuous
"RTN","PSBVDLUD",132,0)
 .; process admintimes
"RTN","PSBVDLUD",133,0)
 .; Display an order on the VDL based on the frequency received from IPM **PSB*2.0*3
"RTN","PSBVDLUD",134,0)
 .S (PSBYES,PSBODD,PSBYTF)=0
"RTN","PSBVDLUD",135,0)
 .I PSBSCH="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"No Schedule on this order")
"RTN","PSBVDLUD",136,0)
 .S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBVDLUD",137,0)
 .I PSBYES,PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLUD",138,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBVDLUD",139,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLUD",140,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLUD",141,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBVDLUD",142,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBVDLUD",143,0)
 .I 'PSBYES,PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBVDLUD",144,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1("UDTAB") Q  ;calculate admin times based on frequency
"RTN","PSBVDLUD",145,0)
 .; No admin times, MAYDAY MAYDAY!!
"RTN","PSBVDLUD",146,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBVDLUD",147,0)
 .I PSBODD,PSBADST'="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH) Q
"RTN","PSBVDLUD",148,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLUD",149,0)
 .; build all orders for both days.
"RTN","PSBVDLUD",150,0)
 .F PSBY=1:1 Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBVDLUD",151,0)
 ..;For invalid admin times
"RTN","PSBVDLUD",152,0)
 ..I ($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N) D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBVDLUD",153,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLUD",154,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBVDLUD",155,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLUD",156,0)
 ...D:(PSB'<PSBOST)&(PSB<PSBOSP)  ; Make sure this time is active
"RTN","PSBVDLUD",157,0)
 ....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLUD",158,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",159,0)
 ..;
"RTN","PSBVDLUD",160,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLUD",161,0)
 ..;
"RTN","PSBVDLUD",162,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLUD",163,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBVDLUD",164,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLUD",165,0)
 ...D:(PSB'<PSBOST)&(PSB<PSBOSP)  ; Make sure this time is active
"RTN","PSBVDLUD",166,0)
 ....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLUD",167,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",168,0)
 .K PSBSTUS
"RTN","PSBVDLUD",169,0)
1 K PSBREC D EN^PSBVDLPA
"RTN","PSBVDLUD",170,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLUD",171,0)
 D:PSBTAB="UDTAB" VNURSE^PSBVDLU1("UDTAB")
"RTN","PSBVDLUD",172,0)
 D CLEAN^PSBVT
"RTN","PSBVDLUD",173,0)
 Q
"RTN","PSBVDLUD",174,0)
 ;
"RTN","PSBVT")
0^2^B77039096^B72258371
"RTN","PSBVT",1,0)
PSBVT ;BIRMINGHAM/EFC-BCMA ORDER VARIABLES UTILITY ; 8/4/05 8:05am
"RTN","PSBVT",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,38**;Mar 2004;Build 8
"RTN","PSBVT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVT",4,0)
 ;
"RTN","PSBVT",5,0)
 ; Reference/IA
"RTN","PSBVT",6,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBVT",7,0)
 ; ^TMP("PSJ",$J/2828
"RTN","PSBVT",8,0)
 ;
"RTN","PSBVT",9,0)
PSJ(PSBX1) ;
"RTN","PSBVT",10,0)
 S ^TMP("TK PSJ",PSBX1)=""
"RTN","PSBVT",11,0)
 S PSBSCRT="^TMP(""PSB"",$J,""PSBORDA"")"
"RTN","PSBVT",12,0)
 K @PSBSCRT M @PSBSCRT=^TMP("PSJ",$J,PSBX1)
"RTN","PSBVT",13,0)
 S PSBDFN=DFN
"RTN","PSBVT",14,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",0))
"RTN","PSBVT",15,0)
 S PSBON=+$P(PSBSCRT,U,3)  ; ord num w/o type
"RTN","PSBVT",16,0)
 S PSBONX=$P(PSBSCRT,U,3)  ; ord num w/  type "U" or "V"
"RTN","PSBVT",17,0)
 S PSBOTYP=$E(PSBONX,$L(PSBONX))
"RTN","PSBVT",18,0)
 S PSBPONX=$P(PSBSCRT,U,4)  ; prev ord num
"RTN","PSBVT",19,0)
 S PSBFON=$P(PSBSCRT,U,5)  ; foll ord num
"RTN","PSBVT",20,0)
 S PSBIVT=$P(PSBSCRT,U,6)  ; IV type
"RTN","PSBVT",21,0)
 S PSBISYR=$P(PSBSCRT,U,7)  ; intermit syrg
"RTN","PSBVT",22,0)
 S PSBCHEMT=$P(PSBSCRT,U,8)  ; chemo type
"RTN","PSBVT",23,0)
 S PSBCPRS=$P(PSBSCRT,U,9)  ; ords file entry (CPRS order #)
"RTN","PSBVT",24,0)
 S PSBFOR=$P(PSBSCRT,U,10)  ; reason for foll order
"RTN","PSBVT",25,0)
 Q:PSBSCRT=-1
"RTN","PSBVT",26,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",1))
"RTN","PSBVT",27,0)
 S PSBMR=$P($G(^TMP("PSB",$J,"PSBORDA",1,0)),U,2) ;med rt
"RTN","PSBVT",28,0)
 S PSBMRAB=$P(PSBSCRT,U,1) ;med rt abbr
"RTN","PSBVT",29,0)
 S PSBNJECT=+$G(^TMP("PSB",$J,"PSBORDA",1,0))  ;Inj site
"RTN","PSBVT",30,0)
 S PSBIVPSH=+$P($G(^TMP("PSB",$J,"PSBORDA",1,0)),U,3) ;IV PUSH
"RTN","PSBVT",31,0)
 S PSBSCHT=$P(PSBSCRT,U,2)  ; sched type conversion
"RTN","PSBVT",32,0)
 S PSBSCH=$P(PSBSCRT,U,3)  ; sched
"RTN","PSBVT",33,0)
 S PSBOST=$P(PSBSCRT,U,4)  ; strt dte FM
"RTN","PSBVT",34,0)
 S PSBOSP=$P(PSBSCRT,U,5)  ; stp dte FM
"RTN","PSBVT",35,0)
 S PSBADST=$P(PSBSCRT,U,6)  ; admin times strin in NNNN- format
"RTN","PSBVT",36,0)
 S PSBOSTS=$P(PSBSCRT,U,7)  ; status
"RTN","PSBVT",37,0)
 S PSBNGF=$P(PSBSCRT,U,8)  ; not to be given flag
"RTN","PSBVT",38,0)
 S PSBOSCHT=$P(PSBSCRT,U,9)  ; origin sched type
"RTN","PSBVT",39,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",2))
"RTN","PSBVT",40,0)
 S PSBDOSE=$P(PSBSCRT,U,1)  ; dosage ordered
"RTN","PSBVT",41,0)
 S PSBIFR=$P(PSBSCRT,U,2)  ; infusn rate
"RTN","PSBVT",42,0)
 S PSBSM=$P(PSBSCRT,U,3)  ; self med
"RTN","PSBVT",43,0)
 S PSBHSM=$P(PSBSCRT,U,4)  ; hospital supplied self med
"RTN","PSBVT",44,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",3))
"RTN","PSBVT",45,0)
 S PSBOIT=$P(PSBSCRT,U,1)  ; order item IEN - > ^ORD(101.43)
"RTN","PSBVT",46,0)
 S PSBOITX=$P(PSBSCRT,U,2)  ; order item (expanded)_" "_dosage form
"RTN","PSBVT",47,0)
 I PSBOITX="" S PSBOITX="ZZZZ NO ORDERABLE ITEM"
"RTN","PSBVT",48,0)
 S PSBDOSEF=$P(PSBSCRT,U,3)  ; dosage form
"RTN","PSBVT",49,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",4))
"RTN","PSBVT",50,0)
 S PSBOTXT=PSBSCRT  ; special inst/other print info
"RTN","PSBVT",51,0)
 ; get disp drug
"RTN","PSBVT",52,0)
 I $G(^TMP("PSB",$J,"PSBORDA",700,0)) F PSBX2=1:1:^TMP("PSB",$J,"PSBORDA",700,0) M PSBDDA(PSBX2)=^TMP("PSB",$J,"PSBORDA",700,PSBX2,0) S PSBDDA(PSBX2)="DD^"_PSBDDA(PSBX2) ; # of DDrug
"RTN","PSBVT",53,0)
 ;     "DD"^dispensed drug IEN -> ^PSDRUG() DRUG^dispensed drug name^units per dose^inactive date
"RTN","PSBVT",54,0)
 ; build unique id list
"RTN","PSBVT",55,0)
 ; add addits
"RTN","PSBVT",56,0)
 I $D(^TMP("PSB",$J,"PSBORDA",800)) S PSBX2="" F  S PSBX2=$O(^TMP("PSB",$J,"PSBORDA",800,PSBX2)) Q:PSBX2=""!(PSBX2="ERROR")  D
"RTN","PSBVT",57,0)
 .S PSBUIDA(PSBX2)="ID^"_PSBX2 F J=1:1:^TMP("PSB",$J,"PSBORDA",800,PSBX2,0) S PSBUIDA(PSBX2)=PSBUIDA(PSBX2)_"^"_"ADD;"_$P(^TMP("PSB",$J,"PSBORDA",800,PSBX2,J),U,1)
"RTN","PSBVT",58,0)
 ; add solutions
"RTN","PSBVT",59,0)
 I $D(^TMP("PSB",$J,"PSBORDA",900)) S PSBX2="" F  S PSBX2=$O(^TMP("PSB",$J,"PSBORDA",900,PSBX2)) Q:PSBX2=""!(PSBX2="ERROR")  D
"RTN","PSBVT",60,0)
 .I '$D(PSBUIDA(PSBX2)) S PSBUIDA(PSBX2)="ID^"_PSBX2
"RTN","PSBVT",61,0)
 .F J=1:1:^TMP("PSB",$J,"PSBORDA",900,PSBX2,0) S PSBUIDA(PSBX2)=PSBUIDA(PSBX2)_"^"_"SOL;"_$P(^TMP("PSB",$J,"PSBORDA",900,PSBX2,J),U,1)
"RTN","PSBVT",62,0)
 ;     "ID"   ^   (piece 2,3,)... = type;IEN of each add/sol for this ID ex. "SOL;4"
"RTN","PSBVT",63,0)
 ; get addits
"RTN","PSBVT",64,0)
 I $G(^TMP("PSB",$J,"PSBORDA",850,0)) F PSBX2=1:1:^TMP("PSB",$J,"PSBORDA",850,0) D
"RTN","PSBVT",65,0)
 .M PSBADA(PSBX2)=^TMP("PSB",$J,"PSBORDA",850,PSBX2,0)  ; number od additives (exists only for IV)
"RTN","PSBVT",66,0)
 .S PSBADA(PSBX2)="ADD^"_PSBADA(PSBX2)
"RTN","PSBVT",67,0)
 .S PSBBAGS=$P(PSBADA(PSBX2),U,5) I PSBBAGS'="" S PSBBAG=" IN BAG "_$P(PSBBAGS,",",1) F I=2:1 S X=$P(PSBBAGS,",",I) Q:X=""  S PSBBAG=PSBBAG_" AND "_X
"RTN","PSBVT",68,0)
 .S:PSBBAGS'="" $P(PSBADA(PSBX2),U,5)=PSBBAG,$P(PSBADA(PSBX2),U,6)=PSBBAGS
"RTN","PSBVT",69,0)
 ;     "ADD"^additive IEN -> ^PS(52.6) IV ADDITIVES^additive name^strength ^bottle
"RTN","PSBVT",70,0)
 ; get soluts
"RTN","PSBVT",71,0)
 I $G(^TMP("PSB",$J,"PSBORDA",950,0)) F PSBX2=1:1:^TMP("PSB",$J,"PSBORDA",950,0) M PSBSOLA(PSBX2)=^TMP("PSB",$J,"PSBORDA",950,PSBX2,0) S PSBSOLA(PSBX2)="SOL^"_PSBSOLA(PSBX2)  ; # of SOL
"RTN","PSBVT",72,0)
 ;   "SOL"^solution IEN -> ^PS(52.7) IV SOLUTIONS^solution name^volume
"RTN","PSBVT",73,0)
 K ^TMP("PSB",$J,"PSBORDA"),PSBX1,PSBX2
"RTN","PSBVT",74,0)
 Q
"RTN","PSBVT",75,0)
 ;
"RTN","PSBVT",76,0)
PSJ1(PSBPAR1,PSBPAR2) ; set the variables for an individual order
"RTN","PSBVT",77,0)
 S ^TMP("TK PSJ1",PSBPAR1,PSBPAR2)=""
"RTN","PSBVT",78,0)
 ;     PSBPAR1 = DFN
"RTN","PSBVT",79,0)
 ;     PSBPAR2 = ORDNER NUMBER 
"RTN","PSBVT",80,0)
 S PSBSCRT="^TMP(""PSB"",$J,""PSBORDA"")"
"RTN","PSBVT",81,0)
 K @PSBSCRT
"RTN","PSBVT",82,0)
 N PSBX
"RTN","PSBVT",83,0)
 K ^TMP("PSJ1",$J) D EN^PSJBCMA1(PSBPAR1,PSBPAR2,1)
"RTN","PSBVT",84,0)
 M @PSBSCRT=^TMP("PSJ1",$J) K ^TMP("PSJ1",$J)
"RTN","PSBVT",85,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",0))
"RTN","PSBVT",86,0)
 S PSBDFN=PSBPAR1
"RTN","PSBVT",87,0)
 S PSBON=+$P(PSBSCRT,U,3)  ; ord num w/o type
"RTN","PSBVT",88,0)
 S PSBONX=$P(PSBSCRT,U,3)  ; ord num w/  type "U" or "V"
"RTN","PSBVT",89,0)
 S PSBOTYP=$E(PSBONX,$L(PSBONX))
"RTN","PSBVT",90,0)
 S PSBPONX=$P(PSBSCRT,U,4)  ; prev ord num
"RTN","PSBVT",91,0)
 S PSBFON=$P(PSBSCRT,U,5)  ; foll ord num
"RTN","PSBVT",92,0)
 S PSBIVT=$P(PSBSCRT,U,6)  ; IV type
"RTN","PSBVT",93,0)
 S PSBISYR=$P(PSBSCRT,U,7)  ; intermit syrg
"RTN","PSBVT",94,0)
 S PSBCHEMT=$P(PSBSCRT,U,8)  ; chemo type
"RTN","PSBVT",95,0)
 S PSBCPRS=$P(PSBSCRT,U,0)  ; ord file entry (CPRS order #)
"RTN","PSBVT",96,0)
 Q:PSBSCRT=-1
"RTN","PSBVT",97,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",1))
"RTN","PSBVT",98,0)
 S PSBMD=$P(PSBSCRT,U,1)  ; prov IEN -> ^VA(200)
"RTN","PSBVT",99,0)
 S PSBMDX=$P(PSBSCRT,U,2)  ; prov name
"RTN","PSBVT",100,0)
 S PSBMR=$P(PSBSCRT,U,3)  ; med rt IEN -> ^PS(51.2)
"RTN","PSBVT",101,0)
 I $G(PSBMR)'="" S PSBMR=$P(PSBSCRT,U,13)  ;med rt
"RTN","PSBVT",102,0)
 S PSBMRAB=$P(PSBSCRT,U,4)  ;med rt abbr
"RTN","PSBVT",103,0)
 S PSBNJECT=+$G(^TMP("PSB",$J,"PSBORDA",1,0))  ;Inj site
"RTN","PSBVT",104,0)
 S PSBIVPSH=+$P($G(^TMP("PSB",$J,"PSBORDA",1,0)),U,2)  ;IV PUSH
"RTN","PSBVT",105,0)
 S PSBSM=$P(PSBSCRT,U,5)  ; self med
"RTN","PSBVT",106,0)
 S PSBSMX=$P(PSBSCRT,U,6)  ; expnd to YES/NO
"RTN","PSBVT",107,0)
 S PSBHSM=$P(PSBSCRT,U,7)  ; hospital supplied self med
"RTN","PSBVT",108,0)
 S PSBHSMX=$P(PSBSCRT,U,8)  ; expnd to YES/NO
"RTN","PSBVT",109,0)
 S PSBNGF=$P(PSBSCRT,U,9)  ; not to be given flag
"RTN","PSBVT",110,0)
 S PSBOSTS=$P(PSBSCRT,U,10)  ; ord status
"RTN","PSBVT",111,0)
 S PSBOSTSX=$P(PSBSCRT,U,11)  ; ord status expans
"RTN","PSBVT",112,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",2))
"RTN","PSBVT",113,0)
 S PSBOIT=$P(PSBSCRT,U,1)  ; orderable item IEN -> ^ORD(101.43) ORDERABLE ITEM
"RTN","PSBVT",114,0)
 S PSBOITX=$P(PSBSCRT,U,2)  ; orderable item (expaned)_" "_ dosage form
"RTN","PSBVT",115,0)
 I PSBOITX="" S PSBOITX="ZZZZ NO ORDERABLE ITEM"
"RTN","PSBVT",116,0)
 S PSBDOSE=$P(PSBSCRT,U,3)  ; dosage ordered
"RTN","PSBVT",117,0)
 S PSBIFR=$P(PSBSCRT,U,4)  ; infusion rate
"RTN","PSBVT",118,0)
 S PSBSCH=$P(PSBSCRT,U,5)  ; sched
"RTN","PSBVT",119,0)
 S PSBDOSEF=$P(PSBSCRT,U,6)  ; dosage form
"RTN","PSBVT",120,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",3))
"RTN","PSBVT",121,0)
 S PSBOTXT=$P(PSBSCRT,U,1)  ; UD special inst or IV other print info
"RTN","PSBVT",122,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",4))
"RTN","PSBVT",123,0)
 S PSBSCHT=$P(PSBSCRT,U,1)  ; sched type conversion
"RTN","PSBVT",124,0)
 S PSBSCHTX=$P(PSBSCRT,U,2)  ; sched type expansion
"RTN","PSBVT",125,0)
 S PSBLDT=$P(PSBSCRT,U,3)  ; log-in date FM
"RTN","PSBVT",126,0)
 S PSBLDTX=$P(PSBSCRT,U,4)  ; exp MM/DD/YYYY HH:MM
"RTN","PSBVT",127,0)
 S PSBOST=$P(PSBSCRT,U,5)  ; start date FM
"RTN","PSBVT",128,0)
 S PSBOSTX=$P(PSBSCRT,U,6)  ; exp MM/DD/YYYY HH:MM
"RTN","PSBVT",129,0)
 S PSBOSP=$P(PSBSCRT,U,7)  ; stop date FM
"RTN","PSBVT",130,0)
 S PSBOSPX=$P(PSBSCRT,U,8) ; exp MM/DD/YYYY HH:MM
"RTN","PSBVT",131,0)
 S PSBADST=$P(PSBSCRT,U,9)  ; admin times string in NNNN- format
"RTN","PSBVT",132,0)
 S PSBOSCHT=$P(PSBSCRT,U,10)  ; original schedule type
"RTN","PSBVT",133,0)
 S PSBFREQ=$P(PSBSCRT,U,11)  ; frequency
"RTN","PSBVT",134,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",5))
"RTN","PSBVT",135,0)
 S PSBVN=$P(PSBSCRT,U,1)  ; verify nurse IEN -> ^VA(200)
"RTN","PSBVT",136,0)
 S PSBVNX=$P(PSBSCRT,U,2)  ; nurse name
"RTN","PSBVT",137,0)
 S PSBVNI=$P(PSBSCRT,U,3) ; nurse initials
"RTN","PSBVT",138,0)
 S PSBVPH=$P(PSBSCRT,U,4)  ; verify pharm IEN -> ^VA(200)
"RTN","PSBVT",139,0)
 S PSBVPHX=$P(PSBSCRT,U,5)  ; pharm name
"RTN","PSBVT",140,0)
 S PSBVPHI=$P(PSBSCRT,U,6)  ; pharm initials
"RTN","PSBVT",141,0)
 S PSBSCRT=$G(^TMP("PSB",$J,"PSBORDA",6))
"RTN","PSBVT",142,0)
 S PSBRMRK=$G(PSBSCRT)
"RTN","PSBVT",143,0)
 ;If DayOFWeek set frequen to NULL
"RTN","PSBVT",144,0)
 I $$PSBDCHK1^PSBVT1(PSBSCH) S PSBFREQ=""
"RTN","PSBVT",145,0)
 ; get dispensed drug
"RTN","PSBVT",146,0)
 I $G(^TMP("PSB",$J,"PSBORDA",700,0)) F PSBX=1:1:^TMP("PSB",$J,"PSBORDA",700,0) M PSBDDA(PSBX)=^TMP("PSB",$J,"PSBORDA",700,PSBX,0) S PSBDDA(PSBX)="DD^"_PSBDDA(PSBX) ; # of DDrug
"RTN","PSBVT",147,0)
 ;     "DD"^dispensed drug IEN -> ^PSDRUG() DRUG^dispensed drug name^units per dose^inactive date
"RTN","PSBVT",148,0)
 ; build unique id list
"RTN","PSBVT",149,0)
 ; add addits
"RTN","PSBVT",150,0)
 I $D(^TMP("PSB",$J,"PSBORDA",800)) S PSBX2="" F  S PSBX2=$O(^TMP("PSB",$J,"PSBORDA",800,PSBX2)) Q:PSBX2=""!(PSBX2="ERROR")  D
"RTN","PSBVT",151,0)
 .S PSBUIDA(PSBX2)="ID^"_PSBX2 F J=1:1:^TMP("PSB",$J,"PSBORDA",800,PSBX2,0) S PSBUIDA(PSBX2)=PSBUIDA(PSBX2)_"^"_"ADD;"_$P(^TMP("PSB",$J,"PSBORDA",800,PSBX2,J),U,1)
"RTN","PSBVT",152,0)
 ; add soluts
"RTN","PSBVT",153,0)
 I $D(^TMP("PSB",$J,"PSBORDA",900)) S PSBX2="" F  S PSBX2=$O(^TMP("PSB",$J,"PSBORDA",900,PSBX2)) Q:PSBX2=""!(PSBX2="ERROR")  D
"RTN","PSBVT",154,0)
 .I '$D(PSBUIDA(PSBX2)) S PSBUIDA(PSBX2)="ID^"_PSBX2
"RTN","PSBVT",155,0)
 .F J=1:1:^TMP("PSB",$J,"PSBORDA",900,PSBX2,0) S PSBUIDA(PSBX2)=PSBUIDA(PSBX2)_"^"_"SOL;"_$P(^TMP("PSB",$J,"PSBORDA",900,PSBX2,J),U,1)
"RTN","PSBVT",156,0)
 ;     "ID"   ^   (piece 2,3),... = type;IEN of each add/sol for this ID ex. "SOL;4"
"RTN","PSBVT",157,0)
 ; get addits
"RTN","PSBVT",158,0)
 I $G(^TMP("PSB",$J,"PSBORDA",850,0)) F PSBX=1:1:^TMP("PSB",$J,"PSBORDA",850,0) D
"RTN","PSBVT",159,0)
 .M PSBADA(PSBX)=^TMP("PSB",$J,"PSBORDA",850,PSBX,0)  ; num of addits
"RTN","PSBVT",160,0)
 .S PSBADA(PSBX)="ADD^"_PSBADA(PSBX)
"RTN","PSBVT",161,0)
 .S PSBBAGS=$P(PSBADA(PSBX),U,5) I PSBBAGS'="" S PSBBAG=" IN BAG "_$P(PSBBAGS,",",1) D
"RTN","PSBVT",162,0)
 ..F I=2:1 S X=$P(PSBBAGS,",",I) Q:X=""  S PSBBAG=PSBBAG_" AND "_X
"RTN","PSBVT",163,0)
 .S:PSBBAGS'="" $P(PSBADA(PSBX),U,5)=PSBBAG
"RTN","PSBVT",164,0)
 ;     "ADD"^additive IEN -> ^PS(52.6) IV ADDITIVES^additive name^strength^bottle
"RTN","PSBVT",165,0)
 ; get soluts
"RTN","PSBVT",166,0)
 I $G(^TMP("PSB",$J,"PSBORDA",950,0)) F PSBX=1:1:^TMP("PSB",$J,"PSBORDA",950,0) M PSBSOLA(PSBX)=^TMP("PSB",$J,"PSBORDA",950,PSBX,0) S PSBSOLA(PSBX)="SOL^"_PSBSOLA(PSBX)  ; # of SOLs
"RTN","PSBVT",167,0)
 ;   "SOL"   ^   solution IEN -> ^PS(52.7) IV SOLUTIONS^solution name^volume
"RTN","PSBVT",168,0)
 ; get label
"RTN","PSBVT",169,0)
 I $D(^TMP("PSB",$J,"PSBORDA",1000)) M PSBLBLA=^TMP("PSB",$J,"PSBORDA",1000)
"RTN","PSBVT",170,0)
 K ^TMP("PSB",$J,"PSBORDA")
"RTN","PSBVT",171,0)
 Q
"RTN","PSBVT",172,0)
 ;
"RTN","PSBVT",173,0)
LACTION ; get last action info
"RTN","PSBVT",174,0)
 S (PSBLADT,PSBLAIEN,PSBLASTS)=""
"RTN","PSBVT",175,0)
 I '$D(^PSB(53.79,"AORDX",PSBDFN,PSBONX)) Q
"RTN","PSBVT",176,0)
 S PSBLADT=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,""),-1)
"RTN","PSBVT",177,0)
 S PSBLAIEN=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBLADT,""))
"RTN","PSBVT",178,0)
 S PSBLASTS=$P(^PSB(53.79,PSBLAIEN,0),U,9)
"RTN","PSBVT",179,0)
 Q
"RTN","PSBVT",180,0)
 ;
"RTN","PSBVT",181,0)
CLEAN ;
"RTN","PSBVT",182,0)
 K PSBONX,PSBPONX,PSBFON,PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBMD,PSBMDX,PSBMR,PSBMRAB,PSBSM,PSBSMX,PSBHSM,PSBHSMX
"RTN","PSBVT",183,0)
 K PSBDFN,PSBNGF,PSBOSTS,PSBOSTSX,PSBOIT,PSBOITX,PSBDOSE,PSBIFR,PSBSCH,PSBDOSEF,PSBOTXT,PSBSCHT,PSBSCHTX
"RTN","PSBVT",184,0)
 K PSBLDT,PSBLDTX,PSBOST,PSBOSTX,PSBOSP,PSBOSPX,PSBADST,PSBOSCHT,PSBFREQ,PSBVN,PSBVNX,PSBVNI
"RTN","PSBVT",185,0)
 K PSBVPH,PSBVPHX,PSBVPHI,PSBDDA,PSBADA,PSBSOLA,PSBUIDA,PSBCPRS,PSBON,PSBRMRK,PSBNJECT,PSBIVPSH
"RTN","PSBVT",186,0)
 K PSBLADT,PSBLAIEN,PSBLASTS,PSBBAG,PSBBAGS,PSBLBLA,PSBFOR,PSBSCRT
"RTN","PSBVT",187,0)
 Q
"VER")
8.0^22.0
"BLD",6326,6)
^26
**END**
**END**
