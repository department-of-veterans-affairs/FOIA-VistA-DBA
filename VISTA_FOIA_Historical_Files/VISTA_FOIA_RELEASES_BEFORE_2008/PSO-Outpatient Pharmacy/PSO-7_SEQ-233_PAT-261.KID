Released PSO*7*261 SEQ #233
Extracted from mail message
**KIDS**:PSO*7.0*261^

**INSTALL NAME**
PSO*7.0*261
"BLD",6143,0)
PSO*7.0*261^OUTPATIENT PHARMACY^0^3070425^y
"BLD",6143,1,0)
^^43^43^3070425^
"BLD",6143,1,1,0)
This patch is part of the third quarter enhancements release for
"BLD",6143,1,2,0)
the Outpatient Pharmacy V. 7.0 package.
"BLD",6143,1,3,0)
 
"BLD",6143,1,4,0)
As per the Health Data Repository (HDR) request, thirteen new data fields
"BLD",6143,1,5,0)
were added to the current Outpatient Pharmacy Vista Data Extraction
"BLD",6143,1,6,0)
Framework (VDEF) HEALTH LEVEL SEVEN (HL7) message that sends prescription
"BLD",6143,1,7,0)
information to the HDR.
"BLD",6143,1,8,0)
 
"BLD",6143,1,9,0)
This patch affects the background HL7 processing only; users will not see
"BLD",6143,1,10,0)
any functional changes.
"BLD",6143,1,11,0)
 
"BLD",6143,1,12,0)
For more information on the addition of the thirteen new data fields,
"BLD",6143,1,13,0)
please refer to Appendix D of the Outpatient Pharmacy V. 7.0 Technical
"BLD",6143,1,14,0)
Manual / Security Guide that is being updated with this patch.
"BLD",6143,1,15,0)
 
"BLD",6143,1,16,0)
This patch also corrects the problem of a VDEF message not being sent to
"BLD",6143,1,17,0)
the HDR when a refill is deleted from a prescription as a result of the
"BLD",6143,1,18,0)
refill being returned to stock.
"BLD",6143,1,19,0)
 
"BLD",6143,1,20,0)
**** VERY IMPORTANT ****
"BLD",6143,1,21,0)
 
"BLD",6143,1,22,0)
You must suspend the VDEF Request Queue before installing this patch and
"BLD",6143,1,23,0)
then re-enable it after installation of the patch. Keep in mind that the
"BLD",6143,1,24,0)
suspension of the VDEF Request Queue will not prevent any new requests in
"BLD",6143,1,25,0)
Outpatient Pharmacy VDEF Domain application from being added to the VDEF
"BLD",6143,1,26,0)
Request Queue, it will only delay the building of these VDEF HL7 messages
"BLD",6143,1,27,0)
until the VDEF Request Queue is enabled again. The steps for doing that
"BLD",6143,1,28,0)
are outlined in the Installation Instructions section.
"BLD",6143,1,29,0)
 
"BLD",6143,1,30,0)
 
"BLD",6143,1,31,0)
MISCELLANEOUS FIXES:
"BLD",6143,1,32,0)
--------------------
"BLD",6143,1,33,0)
1. The hidden action "RS" for Reprint Signature log that was sent in
"BLD",6143,1,34,0)
patch PSO*7*200, was overwriting the action "OTH" for Other OP Actions,
"BLD",6143,1,35,0)
making the OTH action unavailable. The post-install routine PSOP261
"BLD",6143,1,36,0)
included in this patch (PSO*7*261) fixes this.
"BLD",6143,1,37,0)
 
"BLD",6143,1,38,0)
2. An undefined error was identified by a site that went live with Remote
"BLD",6143,1,39,0)
Data Interoperability (RDI) patches. A common variable was being killed by
"BLD",6143,1,40,0)
another package. The fix is to save the value of the variable before
"BLD",6143,1,41,0)
making the call to retrieve remote allergy data and to restore the
"BLD",6143,1,42,0)
variable to the saved value once control is returned to the calling
"BLD",6143,1,43,0)
routine.
"BLD",6143,4,0)
^9.64PA^^
"BLD",6143,6)
^208
"BLD",6143,6.3)
9
"BLD",6143,"INID")
^y
"BLD",6143,"INIT")
PSOP261
"BLD",6143,"KRN",0)
^9.67PA^8989.52^19
"BLD",6143,"KRN",.4,0)
.4
"BLD",6143,"KRN",.401,0)
.401
"BLD",6143,"KRN",.402,0)
.402
"BLD",6143,"KRN",.403,0)
.403
"BLD",6143,"KRN",.5,0)
.5
"BLD",6143,"KRN",.84,0)
.84
"BLD",6143,"KRN",3.6,0)
3.6
"BLD",6143,"KRN",3.8,0)
3.8
"BLD",6143,"KRN",9.2,0)
9.2
"BLD",6143,"KRN",9.8,0)
9.8
"BLD",6143,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",6143,"KRN",9.8,"NM",1,0)
PSOVDF1^^0^B89552983
"BLD",6143,"KRN",9.8,"NM",2,0)
PSOVDF2^^0^B86097500
"BLD",6143,"KRN",9.8,"NM",3,0)
PSOVDF3^^0^B66789111
"BLD",6143,"KRN",9.8,"NM",4,0)
PSORESK^^0^B67129775
"BLD",6143,"KRN",9.8,"NM",5,0)
PSOORUT2^^0^B33163050
"BLD",6143,"KRN",9.8,"NM","B","PSOORUT2",5)

"BLD",6143,"KRN",9.8,"NM","B","PSORESK",4)

"BLD",6143,"KRN",9.8,"NM","B","PSOVDF1",1)

"BLD",6143,"KRN",9.8,"NM","B","PSOVDF2",2)

"BLD",6143,"KRN",9.8,"NM","B","PSOVDF3",3)

"BLD",6143,"KRN",19,0)
19
"BLD",6143,"KRN",19,"NM",0)
^9.68A^^0
"BLD",6143,"KRN",19.1,0)
19.1
"BLD",6143,"KRN",101,0)
101
"BLD",6143,"KRN",409.61,0)
409.61
"BLD",6143,"KRN",771,0)
771
"BLD",6143,"KRN",870,0)
870
"BLD",6143,"KRN",8989.51,0)
8989.51
"BLD",6143,"KRN",8989.52,0)
8989.52
"BLD",6143,"KRN",8994,0)
8994
"BLD",6143,"KRN","B",.4,.4)

"BLD",6143,"KRN","B",.401,.401)

"BLD",6143,"KRN","B",.402,.402)

"BLD",6143,"KRN","B",.403,.403)

"BLD",6143,"KRN","B",.5,.5)

"BLD",6143,"KRN","B",.84,.84)

"BLD",6143,"KRN","B",3.6,3.6)

"BLD",6143,"KRN","B",3.8,3.8)

"BLD",6143,"KRN","B",9.2,9.2)

"BLD",6143,"KRN","B",9.8,9.8)

"BLD",6143,"KRN","B",19,19)

"BLD",6143,"KRN","B",19.1,19.1)

"BLD",6143,"KRN","B",101,101)

"BLD",6143,"KRN","B",409.61,409.61)

"BLD",6143,"KRN","B",771,771)

"BLD",6143,"KRN","B",870,870)

"BLD",6143,"KRN","B",8989.51,8989.51)

"BLD",6143,"KRN","B",8989.52,8989.52)

"BLD",6143,"KRN","B",8994,8994)

"BLD",6143,"QUES",0)
^9.62^^
"BLD",6143,"REQB",0)
^9.611^4^2
"BLD",6143,"REQB",3,0)
PSO*7.0*243^2
"BLD",6143,"REQB",4,0)
PSO*7.0*200^2
"BLD",6143,"REQB","B","PSO*7.0*200",4)

"BLD",6143,"REQB","B","PSO*7.0*243",3)

"INIT")
PSOP261
"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
261^3070425
"PKG",141,22,1,"PAH",1,1,0)
^^43^43^3070425
"PKG",141,22,1,"PAH",1,1,1,0)
This patch is part of the third quarter enhancements release for
"PKG",141,22,1,"PAH",1,1,2,0)
the Outpatient Pharmacy V. 7.0 package.
"PKG",141,22,1,"PAH",1,1,3,0)
 
"PKG",141,22,1,"PAH",1,1,4,0)
As per the Health Data Repository (HDR) request, thirteen new data fields
"PKG",141,22,1,"PAH",1,1,5,0)
were added to the current Outpatient Pharmacy Vista Data Extraction
"PKG",141,22,1,"PAH",1,1,6,0)
Framework (VDEF) HEALTH LEVEL SEVEN (HL7) message that sends prescription
"PKG",141,22,1,"PAH",1,1,7,0)
information to the HDR.
"PKG",141,22,1,"PAH",1,1,8,0)
 
"PKG",141,22,1,"PAH",1,1,9,0)
This patch affects the background HL7 processing only; users will not see
"PKG",141,22,1,"PAH",1,1,10,0)
any functional changes.
"PKG",141,22,1,"PAH",1,1,11,0)
 
"PKG",141,22,1,"PAH",1,1,12,0)
For more information on the addition of the thirteen new data fields,
"PKG",141,22,1,"PAH",1,1,13,0)
please refer to Appendix D of the Outpatient Pharmacy V. 7.0 Technical
"PKG",141,22,1,"PAH",1,1,14,0)
Manual / Security Guide that is being updated with this patch.
"PKG",141,22,1,"PAH",1,1,15,0)
 
"PKG",141,22,1,"PAH",1,1,16,0)
This patch also corrects the problem of a VDEF message not being sent to
"PKG",141,22,1,"PAH",1,1,17,0)
the HDR when a refill is deleted from a prescription as a result of the
"PKG",141,22,1,"PAH",1,1,18,0)
refill being returned to stock.
"PKG",141,22,1,"PAH",1,1,19,0)
 
"PKG",141,22,1,"PAH",1,1,20,0)
**** VERY IMPORTANT ****
"PKG",141,22,1,"PAH",1,1,21,0)
 
"PKG",141,22,1,"PAH",1,1,22,0)
You must suspend the VDEF Request Queue before installing this patch and
"PKG",141,22,1,"PAH",1,1,23,0)
then re-enable it after installation of the patch. Keep in mind that the
"PKG",141,22,1,"PAH",1,1,24,0)
suspension of the VDEF Request Queue will not prevent any new requests in
"PKG",141,22,1,"PAH",1,1,25,0)
Outpatient Pharmacy VDEF Domain application from being added to the VDEF
"PKG",141,22,1,"PAH",1,1,26,0)
Request Queue, it will only delay the building of these VDEF HL7 messages
"PKG",141,22,1,"PAH",1,1,27,0)
until the VDEF Request Queue is enabled again. The steps for doing that
"PKG",141,22,1,"PAH",1,1,28,0)
are outlined in the Installation Instructions section.
"PKG",141,22,1,"PAH",1,1,29,0)
 
"PKG",141,22,1,"PAH",1,1,30,0)
 
"PKG",141,22,1,"PAH",1,1,31,0)
MISCELLANEOUS FIXES:
"PKG",141,22,1,"PAH",1,1,32,0)
--------------------
"PKG",141,22,1,"PAH",1,1,33,0)
1. The hidden action "RS" for Reprint Signature log that was sent in
"PKG",141,22,1,"PAH",1,1,34,0)
patch PSO*7*200, was overwriting the action "OTH" for Other OP Actions,
"PKG",141,22,1,"PAH",1,1,35,0)
making the OTH action unavailable. The post-install routine PSOP261
"PKG",141,22,1,"PAH",1,1,36,0)
included in this patch (PSO*7*261) fixes this.
"PKG",141,22,1,"PAH",1,1,37,0)
 
"PKG",141,22,1,"PAH",1,1,38,0)
2. An undefined error was identified by a site that went live with Remote
"PKG",141,22,1,"PAH",1,1,39,0)
Data Interoperability (RDI) patches. A common variable was being killed by
"PKG",141,22,1,"PAH",1,1,40,0)
another package. The fix is to save the value of the variable before
"PKG",141,22,1,"PAH",1,1,41,0)
making the call to retrieve remote allergy data and to restore the
"PKG",141,22,1,"PAH",1,1,42,0)
variable to the saved value once control is returned to the calling
"PKG",141,22,1,"PAH",1,1,43,0)
routine.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","PSOORUT2")
0^5^B33163050^B32770288
"RTN","PSOORUT2",1,0)
PSOORUT2 ;ISC BHAM/SAB - build listman screen ;02/22/95
"RTN","PSOORUT2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,132,182,233,243,261**;DEC 1997;Build 9
"RTN","PSOORUT2",3,0)
 ;External reference to SDPHARM1 supported by DBIA 4196
"RTN","PSOORUT2",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORUT2",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSOORUT2",6,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSOORUT2",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORUT2",8,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOORUT2",9,0)
 ;
"RTN","PSOORUT2",10,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) S DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOORUT2",11,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSOORUT2",12,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSOORUT2",13,0)
 D NVA
"RTN","PSOORUT2",14,0)
 S POERR=1 D RE^PSODEM K POERR
"RTN","PSOORUT2",15,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSOORUT2",16,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSOORUT2",17,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSOORUT2",18,0)
 S $P(^TMP("PSOHDR",$J,9,0)," ",62)="ISSUE  LAST REF DAY"
"RTN","PSOORUT2",19,0)
 S ^TMP("PSOHDR",$J,10,0)=" #  RX #         DRUG                                 QTY ST  DATE  FILL REM SUP"
"RTN","PSOORUT2",20,0)
 D ELIG^VADPT S IEN=1,^TMP("PSOPI",$J,IEN,0)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),IEN=IEN+1
"RTN","PSOORUT2",21,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(^TMP("PSOPI",$J,IEN,0)," ",14)=$P(VAEL(1,N),"^",2),IEN=IEN+1
"RTN","PSOORUT2",22,0)
 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Disabilities: "
"RTN","PSOORUT2",23,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOORUT2",24,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOORUT2",25,0)
 .S:$L(^TMP("PSOPI",$J,IEN,0)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 IEN=IEN+1,$P(^TMP("PSOPI",$J,IEN,0)," ",14)=" "
"RTN","PSOORUT2",26,0)
 .S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOORUT2",27,0)
 S IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORUT2",28,0)
 I +VAPA(9) S ^TMP("PSOPI",$J,IEN,0)="      (Temp Address from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")",IEN=IEN+1
"RTN","PSOORUT2",29,0)
 S ^TMP("PSOPI",$J,IEN,0)=VAPA(1) S:VAPA(2)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(2) S:VAPA(3)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(3)
"RTN","PSOORUT2",30,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(4),$P(^TMP("PSOPI",$J,IEN,0)," ",40)="PHONE: "_VAPA(8)
"RTN","PSOORUT2",31,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6))
"RTN","PSOORUT2",32,0)
 S MAILD=+$P($G(^PS(55,DFN,0)),"^",3) D  K MAILD
"RTN","PSOORUT2",33,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Prescription Mail Delivery: "_$S(MAILD=1:"Certified Mail",MAILD=2:"DO NOT MAIL",MAILD=3:"Local - Regular Mail",MAILD=4:"Local - Certified Mail",1:"Regular Mail")
"RTN","PSOORUT2",34,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$S($P($G(^PS(55,DFN,0)),"^",2):"Cannot use safety caps.",1:"") S $P(^TMP("PSOPI",$J,IEN,0)," ",40)=$S($P($G(^PS(55,DFN,0)),"^",4):"Dialysis Patient.",1:"")
"RTN","PSOORUT2",35,0)
 I $G(^PS(55,DFN,1))]"" S PSON=^(1),IEN=IEN+1 D
"RTN","PSOORUT2",36,0)
 .S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="     Outpatient Narrative: "
"RTN","PSOORUT2",37,0)
 .F I=1:1 Q:$P(PSON," ",I,99)=""  S:$L(^TMP("PSOPI",$J,IEN,0)_$P(PSON," ",I)_" ")>80 IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_$P(PSON," ",I)_" "
"RTN","PSOORUT2",38,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",39,0)
 I $D(^PS(52.91,DFN,0)) I '$P(^(0),"^",3)!($P(^(0),"^",3)>DT) D
"RTN","PSOORUT2",40,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Primary Care Appointment: "_$$PRIAPT^SDPHARM1(DFN)
"RTN","PSOORUT2",41,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",42,0)
 I 'GMRAL D
"RTN","PSOORUT2",43,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:""),IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",44,0)
 .D REMOTE
"RTN","PSOORUT2",45,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOORUT2",46,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOORUT2",47,0)
 K ^UTILITY("VASD",$J),VASD S DFN=PSODFN,VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D SDA^VADPT K VASD I $D(^UTILITY("VASD",$J)) D
"RTN","PSOORUT2",48,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Pending Clinic Appointments:"
"RTN","PSOORUT2",49,0)
 .F PSOAPP=0:0 S PSOAPP=$O(^UTILITY("VASD",$J,PSOAPP)) Q:'PSOAPP  S PSOAPPE=$G(^UTILITY("VASD",$J,PSOAPP,"E")),PSOAPPI=$G(^("I")) D
"RTN","PSOORUT2",50,0)
 ..K X S X2=DT,X1=$P($P($G(PSOAPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOORUT2",51,0)
 ..S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="    "_$P(PSOAPPE,"^")_"  "_$P(PSOAPPE,"^",2)_$S($P(PSOAPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOORUT2",52,0)
 K ^UTILITY("VASD",$J),X,PSOAPPI,PSOAPPE,PSOAPP,N
"RTN","PSOORUT2",53,0)
 S PSOPI=IEN K IEN
"RTN","PSOORUT2",54,0)
 Q
"RTN","PSOORUT2",55,0)
NVA ;
"RTN","PSOORUT2",56,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))
"RTN","PSOORUT2",57,0)
 K LSTDT F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D
"RTN","PSOORUT2",58,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",I,0),"^")
"RTN","PSOORUT2",59,0)
 .I $P(^PS(55,PSODFN,"NVA",I,0),"^",10)>+$G(LSTDT) S LSTDT=$P(^(0),"^",10)
"RTN","PSOORUT2",60,0)
 I $G(LSTDT)]"" D
"RTN","PSOORUT2",61,0)
 .S LSTDT="Non-VA Meds on File - Last entry on "_$E(LSTDT,4,5)_"/"_$E(LSTDT,6,7)_"/"_$E(LSTDT,2,3)
"RTN","PSOORUT2",62,0)
 .I $G(^TMP("PSOHDR",$J,5,0))="MALE" S $P(^TMP("PSOHDR",$J,5,0)," ",22)=LSTDT K LSTDT Q
"RTN","PSOORUT2",63,0)
 .S $P(^TMP("PSOHDR",$J,5,0)," ",20)=LSTDT K LSTDT
"RTN","PSOORUT2",64,0)
 K I
"RTN","PSOORUT2",65,0)
 Q
"RTN","PSOORUT2",66,0)
REMOTE ;
"RTN","PSOORUT2",67,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORUT2",68,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORUT2",69,0)
 N PSORALG,REAC,S1,A,FILE,LEN,I
"RTN","PSOORUT2",70,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",71,0)
 S PSORALG=1,PSORALG(1)="No remote data available"
"RTN","PSOORUT2",72,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOORUT2",73,0)
 I $T(GET^ORRDI1)]"" S PSOSIEN=$G(IEN) D GET^ORRDI1(DFN,"ART") S IEN=PSOSIEN K PSOSIEN D
"RTN","PSOORUT2",74,0)
 .I $P($G(^XTMP("ORRDI","ART",DFN,0)),"^",3)=0 S PSORALG(1)="No remote allergies"
"RTN","PSOORUT2",75,0)
 .S S1=0,LEN=65,PSORALG=1,PSORALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSOORUT2",76,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"REACTANT",0)),REAC=$P(A,"^",2),FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSOORUT2",77,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSOORUT2",78,0)
 ..S ^TMP($J,"PSOART",REAC)=""
"RTN","PSOORUT2",79,0)
 .S REAC="" F  S REAC=$O(^TMP($J,"PSOART",REAC)) Q:REAC=""  D
"RTN","PSOORUT2",80,0)
 ..I $L(PSORALG(PSORALG))+$L(REAC)<LEN S PSORALG(PSORALG)=PSORALG(PSORALG)_REAC_", " Q
"RTN","PSOORUT2",81,0)
 ..S PSORALG=PSORALG+1,PSORALG(PSORALG)="              "_REAC_", ",LEN=76
"RTN","PSOORUT2",82,0)
 .I PSORALG(PSORALG)]"",$E(PSORALG(PSORALG),$L(PSORALG(PSORALG)))="," S PSORALG(PSORALG)=$E(PSORALG(PSORALG),1,$L(PSORALG(PSORALG))-1)
"RTN","PSOORUT2",83,0)
REMOTE2 ;
"RTN","PSOORUT2",84,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="      Remote: "_$G(PSORALG(1)) D
"RTN","PSOORUT2",85,0)
 .F I=2:1:PSORALG S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSORALG(I)
"RTN","PSOORUT2",86,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",87,0)
 Q
"RTN","PSOP261")
0^^B2413203^n/a
"RTN","PSOP261",1,0)
PSOP261 ;BIR/SJA - post install for PSO*7*261 ;04/24/07
"RTN","PSOP261",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**261**;DEC 1997;Build 9
"RTN","PSOP261",3,0)
 ; Reference to ^ORD(101 is supported by DBIA #872
"RTN","PSOP261",4,0)
 ;
"RTN","PSOP261",5,0)
 S PSOPRTCL=$O(^ORD(101,"B","PSO HIDDEN ACTIONS #2",0))
"RTN","PSOP261",6,0)
 S PSOTH=$O(^ORD(101,"B","PSO LM HIDDEN OTHER",0)),PSORS=$O(^ORD(101,"B","PSO SPEED SIG LOG REPRINT",0))
"RTN","PSOP261",7,0)
 S PSODN=$O(^ORD(101,"B","VALM DOWN A LINE",0))
"RTN","PSOP261",8,0)
 I 'PSOPRTCL!'PSOTH!'PSORS!'PSODN Q
"RTN","PSOP261",9,0)
 S PSOTHN=$O(^ORD(101,PSOPRTCL,10,"B",PSOTH,0))
"RTN","PSOP261",10,0)
 S PSORSN=$O(^ORD(101,PSOPRTCL,10,"B",PSORS,0))
"RTN","PSOP261",11,0)
 S PSODNN=$O(^ORD(101,PSOPRTCL,10,"B",PSODN,0))
"RTN","PSOP261",12,0)
 I 'PSOTHN!'PSORSN!'PSODNN Q
"RTN","PSOP261",13,0)
 S PSOTHN3=$P($G(^ORD(101,PSOPRTCL,10,PSOTHN,0)),"^",3),PSORSN3=$P($G(^ORD(101,PSOPRTCL,10,PSORSN,0)),"^",3)
"RTN","PSOP261",14,0)
 S PSODNN3=$P($G(^ORD(101,PSOPRTCL,10,PSODNN,0)),"^",3)
"RTN","PSOP261",15,0)
 Q:PSOTHN3'=PSORSN3
"RTN","PSOP261",16,0)
 S DA(1)=PSOPRTCL
"RTN","PSOP261",17,0)
 K DIE S DA=PSODNN,DIE="^ORD(101,"_DA(1)_",10,",DR="3////"_19 D ^DIE K DR,DIE
"RTN","PSOP261",18,0)
 K DIE S DA=PSOTHN,DIE="^ORD(101,"_DA(1)_",10,",DR="3////"_18 D ^DIE K DR,DIE
"RTN","PSOP261",19,0)
 K DIE S DA=PSORSN,DIE="^ORD(101,"_DA(1)_",10,",DR="3////"_17 D ^DIE K DA,DR,DIE
"RTN","PSOP261",20,0)
 Q
"RTN","PSORESK")
0^4^B67129775^B66758202
"RTN","PSORESK",1,0)
PSORESK ;BIR/SAB-return to stock ;10/24/06 4:22pm
"RTN","PSORESK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,9,27,40,47,55,85,130,185,184,196,148,201,259,261**;DEC 1997;Build 9
"RTN","PSORESK",3,0)
 ;
"RTN","PSORESK",4,0)
 ;REF/IA
"RTN","PSORESK",5,0)
 ;^PSDRUG/221
"RTN","PSORESK",6,0)
 ;^PS(59.7/694
"RTN","PSORESK",7,0)
 ;L, UL, PSOL, and PSOUL^PSSLOCK/2789
"RTN","PSORESK",8,0)
 ;^PS(55/2228
"RTN","PSORESK",9,0)
 ;PSDRTS^PSDOPT0/3064
"RTN","PSORESK",10,0)
 ;
"RTN","PSORESK",11,0)
 ;*259 - if refill was Not deleted, then stop RTS from continuing
"RTN","PSORESK",12,0)
 ;
"RTN","PSORESK",13,0)
AC I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W !!,"Outpatient Pharmacy Site Parameters are required!" Q
"RTN","PSORESK",14,0)
 S RESK=1 K PSODEF,^UTILITY($J,"PSOPCE") S PSOPCECT=1
"RTN","PSORESK",15,0)
BC K PSOWHERE,PSODEFLG,PSOINVTX,XTYPE W !! S DIR("A")="Enter/Wand PRESCRIPTION number",DIR("?")="^D HP^PSORESK1",DIR(0)="FO" D ^DIR K DIR I $D(DIRUT) K PSODEF G EX
"RTN","PSORESK",16,0)
 I X'["-" D BCI W:'$G(RXP) !,"INVALID Rx" G:'$G(RXP) BC G BC1
"RTN","PSORESK",17,0)
 I X["-" D  I $P(X,"-")'=$G(PSORESST) W !,$C(7),$C(7),"   INVALID STATION NUMBER !!",$C(7),$C(7),! K PSORESST G BC
"RTN","PSORESK",18,0)
 .K PSORESST S PSORESSX=$G(X) K PSORESAR S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DIQ="PSORESAR",DR="99" D EN^DIQ1 S PSORESST=$G(PSORESAR(4,DA,99,"I")) K PSORESAR,DIQ,DA,DR S X=$G(PSORESSX) K PSORESSX
"RTN","PSORESK",19,0)
 I X["-" S RXP=$P(X,"-",2) I '$D(^PSRX(+$G(RXP),0))!($G(RXP)']"") W !,$C(7),$C(7),$C(7),"   NON-EXISTENT Rx" G BC
"RTN","PSORESK",20,0)
 G:$D(^PSRX(RXP,0)) BC1 W !,$C(7),$C(7),$C(7),"   IMPROPER BARCODE FORMAT" G BC
"RTN","PSORESK",21,0)
BC1 ;
"RTN","PSORESK",22,0)
 S PSORRDFN=+$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSORESK",23,0)
 D ICN^PSODPT(PSORRDFN)
"RTN","PSORESK",24,0)
 S PSOPLCK=$$L^PSSLOCK(PSORRDFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G BC
"RTN","PSORESK",25,0)
 K PSOPLCK D PSOL^PSSLOCK(RXP) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),! K PSOMSG D UL^PSSLOCK(+$G(PSORRDFN)) G BC
"RTN","PSORESK",26,0)
 S PSOLOUD=1 D:$P($G(^PS(55,+$P(^PSRX(RXP,0),"^",2),0)),"^",6)'=2 EN^PSOHLUP($P(^PSRX(RXP,0),"^",2)) K PSOLOUD
"RTN","PSORESK",27,0)
 I $S('+$P($G(^PSRX(+RXP,"STA")),"^"):0,$P(^("STA"),"^")=11:0,$P(^("STA"),"^")=12:0,$P(^("STA"),"^")=14:0,$P(^("STA"),"^")=15:0,1:1) D STAT^PSORESK1 D UL G BC
"RTN","PSORESK",28,0)
 S COPAYFLG=1,QDRUG=$P($G(^PSRX(RXP,0)),"^",6),QTY=$P($G(^(0)),"^",7) I $O(^PSRX(RXP,1,0)) G REF
"RTN","PSORESK",29,0)
 S Y="O" I $O(^PSRX(RXP,"P",0)) D  I $D(DUOUT)!($D(DTOUT)) D UL G BC
"RTN","PSORESK",30,0)
 .S DIR(0)="SA^O:ORIGINAL;P:PARTIAL",DIR("B")="ORIGINAL",DIR("A",1)="",DIR("A",2)="There are Partials for this Rx.",DIR("A")="Which are you Returning To Stock? "
"RTN","PSORESK",31,0)
 .S DIR("?")=" Press return for Original. Enter 'P' for Partial" D ^DIR K DIR
"RTN","PSORESK",32,0)
 S XTYPE=$S(Y="O":"O",1:"P") G:Y="P" PAR
"RTN","PSORESK",33,0)
 I $P($G(^PSRX(RXP,2)),"^",15) D  G BC
"RTN","PSORESK",34,0)
 .W !,$C(7),$C(7),"Original fill for Rx # "_$P(^PSRX(RXP,0),"^")_" was Returned to Stock." D UL
"RTN","PSORESK",35,0)
 I '$P($G(^PSRX(RXP,2)),"^",13) W !,$C(7),$C(7),"Rx # "_$P(^PSRX(RXP,0),"^")_" was NOT released !" D UL G BC
"RTN","PSORESK",36,0)
 S PSOLOCRL=$P($G(^PSRX(RXP,2)),"^",13),PSOWHERE=$S($D(^PSRX("AR",+$G(PSOLOCRL),RXP,0)):1,1:0)
"RTN","PSORESK",37,0)
 W ! S DIR("B")="YES",DIR("A",1)="Are you sure you want to RETURN TO STOCK Rx # "_$P(^PSRX(RXP,0),"^")
"RTN","PSORESK",38,0)
 S DIR("A",2)="for "_$P(^DPT($P(^PSRX(RXP,0),"^",2),0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",DIR("A")="Drug: "_$P(^PSDRUG($P(^PSRX(RXP,0),"^",6),0),"^")
"RTN","PSORESK",39,0)
 I $G(PSOWHERE) S DIR("A",3)=" ",DIR("A",4)="   *** This prescription was filled at the CMOP *** ",DIR("A",5)=" "
"RTN","PSORESK",40,0)
 S DIR(0)="YO" D ^DIR K DIR I Y=0!($D(DIRUT)) D UL G BC
"RTN","PSORESK",41,0)
 ;ORI
"RTN","PSORESK",42,0)
 D  D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",43,0)
 .;VMP OIFO BAY PINES;PSO*7.0*196;KILL PSDS
"RTN","PSORESK",44,0)
 .I $T(PSDRTS^PSDOPT0)]"" D PSDRTS^PSDOPT0(RXP,"O^"_0,$P(^PSRX(RXP,2),"^",9),$P(^PSRX(RXP,0),"^",7)) D MSG K PSDS
"RTN","PSORESK",45,0)
 .Q:$G(RETSK)
"RTN","PSORESK",46,0)
 .K PSOINVTX,PSODEFLG I $G(PSOWHERE),$G(^PSDRUG(QDRUG,660.1)) D INVT^PSORXDL I $G(PSODEFLG) W !!?5,"Prescription Not Returned to Stock!",! Q
"RTN","PSORESK",47,0)
 .I +$G(^PSRX(RXP,"IB"))!($P($G(^PSRX(RXP,"PFS")),"^",2)) N PSOPFS S:$P($G(^PSRX(RXP,"PFS")),"^",2) PSOPFS="1^"_$P(^PSRX(RXP,"PFS"),"^",1,2) D CP^PSORESK1 Q:'$G(COPAYFLG)
"RTN","PSORESK",48,0)
 .;Ask comments until answered, do not allow exiting.
"RTN","PSORESK",49,0)
 .F  D  I '$D(DIRUT) Q
"RTN","PSORESK",50,0)
 ..K DIR,DUOUT,DTOUT,DIRUT,X,Y
"RTN","PSORESK",51,0)
 ..S DIR(0)="F0^10:75",DIR("A")="Comments",DIR("?")="Comments are required, 10-75 characters."
"RTN","PSORESK",52,0)
 ..S DIR("B")=$S($D(PSODEF):PSODEF,1:"Per Pharmacy Request")
"RTN","PSORESK",53,0)
 ..D ^DIR I $D(DIRUT) W !?5,"Comments are required, 10-75 characters.",! Q
"RTN","PSORESK",54,0)
 ..S (PSODEF,COM)=$G(Y) K DIR,X,Y
"RTN","PSORESK",55,0)
 ..Q
"RTN","PSORESK",56,0)
 .I $G(^PSDRUG(QDRUG,660.1)) D
"RTN","PSORESK",57,0)
 ..I $G(PSOWHERE),'$G(PSOINVTX) Q
"RTN","PSORESK",58,0)
 ..S ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)+QTY
"RTN","PSORESK",59,0)
 .I $G(PSOWHERE) K ^PSRX("AR",+$G(PSOLOCRL),RXP,0)
"RTN","PSORESK",60,0)
 .D NOW^%DTC S DA=RXP,DA=RXP,DIE="^PSRX(",DR="31///@;32.1///"_% D ^DIE K DIE,DR,DA Q:$D(Y)
"RTN","PSORESK",61,0)
 .D ACT^PSORESK1 S DA=$O(^PS(52.5,"B",RXP,0)) I DA S DIK="^PS(52.5," D ^DIK
"RTN","PSORESK",62,0)
 .D REVERSE^PSOBPSU1(RXP,0,"RS",4,,1)
"RTN","PSORESK",63,0)
 .D EN^PSOHLSN1(RXP,"ZD") W !,"Rx # "_$P(^PSRX(RXP,0),"^")_" Returned to Stock.",!
"RTN","PSORESK",64,0)
 .Q
"RTN","PSORESK",65,0)
 ;
"RTN","PSORESK",66,0)
REF I $O(^PSRX(RXP,1,0)),$O(^PSRX(RXP,"P",0)) D  I $D(DTOUT)!($D(DUOUT)) D UL G BC
"RTN","PSORESK",67,0)
 .S DIR(0)="SA^R:REFILL;P:PARTIAL",DIR("B")="REFILL",DIR("A",1)="",DIR("A",2)="There are Refills and Partials for this Rx.",DIR("A")="Which are you Returning To Stock? "
"RTN","PSORESK",68,0)
 .S DIR("?")=" Press return for Refill. Enter 'P' for Partial" D ^DIR K DIR
"RTN","PSORESK",69,0)
 I $O(^PSRX(RXP,1,0)),$O(^PSRX(RXP,"P",0)) S XTYPE=$S(Y="R":1,1:"P")
"RTN","PSORESK",70,0)
PAR S:$G(XTYPE)']"" XTYPE=1 S TYPE=0 F YY=0:0 S YY=$O(^PSRX(RXP,XTYPE,YY)) Q:'YY  S TYPE=YY
"RTN","PSORESK",71,0)
 I 'TYPE D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",72,0)
 I $P($G(^PSRX(RXP,XTYPE,TYPE,0)),"^",16) W $C(7),!!,"Last Fill Already Returned to Stock !",! D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",73,0)
 I '$P(^PSRX(RXP,XTYPE,TYPE,0),"^",$S(XTYPE:18,1:19)) W !!,$C(7),$C(7),$S(XTYPE:"Refill",1:"PARTIAL")_" #"_TYPE_" was NOT released !",! D UL G BC
"RTN","PSORESK",74,0)
 W ! K DIR,DUOUT,DTOUT
"RTN","PSORESK",75,0)
 K PSOLOCRL,PSOWHERE I $G(XTYPE) S PSOLOCRL=$P($G(^PSRX(RXP,XTYPE,+$G(TYPE),0)),"^",18),PSOWHERE=$S($D(^PSRX("AR",+$G(PSOLOCRL),RXP,+$G(TYPE))):1,1:0)
"RTN","PSORESK",76,0)
 W ! S DIR("B")="YES",DIR("A",1)="Are you sure you want to RETURN TO STOCK Rx # "_$P(^PSRX(RXP,0),"^")_$S(XTYPE:" Refill ",1:" Partial ")_"# "_TYPE,DIR(0)="Y"
"RTN","PSORESK",77,0)
 S DIR("A",2)="for "_$P(^DPT($P(^PSRX(RXP,0),"^",2),0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",DIR("A")="Drug: "_$P(^PSDRUG($P(^PSRX(RXP,0),"^",6),0),"^")
"RTN","PSORESK",78,0)
 I $G(PSOWHERE) S DIR("A",3)=" ",DIR("A",4)="   *** This prescription was filled at the CMOP *** ",DIR("A",5)=" "
"RTN","PSORESK",79,0)
 D ^DIR K DIR I 'Y!($D(DUOUT))!($D(DTOUT)) D UL G BC
"RTN","PSORESK",80,0)
 I $T(PSDRTS^PSDOPT0)]"" D
"RTN","PSORESK",81,0)
 .;VMP OIFO BAY PINES;PSO*7.0*196;KILL PSDS
"RTN","PSORESK",82,0)
 .I XTYPE D PSDRTS^PSDOPT0(RXP,"R^"_TYPE,$P(^PSRX(RXP,1,TYPE,0),"^",9),$P(^(0),"^",4)) D MSG K PSDS Q
"RTN","PSORESK",83,0)
 .D PSDRTS^PSDOPT0(RXP,"P^"_TYPE,$P(^PSRX(RXP,"P",TYPE,0),"^",9),$P(^(0),"^",4)) D MSG K PSDS
"RTN","PSORESK",84,0)
 I $G(RETSK) D UL,EX G BC
"RTN","PSORESK",85,0)
 K PSOINVTX,PSODEFLG I $G(PSOWHERE),$G(^PSDRUG(QDRUG,660.1)) D INVT^PSORXDL I $G(PSODEFLG) W !!?5,"Prescription Not Returned to Stock!",! D UL G BC
"RTN","PSORESK",86,0)
 I XTYPE I +$G(^PSRX(RXP,"IB"))!($P($G(^PSRX(RXP,1,TYPE,"PFS")),"^",2)) N PSOPFS S:$P($G(^PSRX(RXP,1,TYPE,"PFS")),"^",2) PSOPFS="1^"_$P(^PSRX(RXP,1,TYPE,"PFS"),"^",1,2) D CP^PSORESK1 I '$G(COPAYFLG) D UL G BC
"RTN","PSORESK",87,0)
 ;Ask comments until answered, do not allow exiting.
"RTN","PSORESK",88,0)
 F  D  I '$D(DIRUT) Q
"RTN","PSORESK",89,0)
 .K DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORESK",90,0)
 .S DIR(0)="F0^10:75",DIR("A")="Comments",DIR("?")="Comments are required, 10-75 characters."
"RTN","PSORESK",91,0)
 .S DIR("B")=$S($D(PSODEF):PSODEF,1:"Per Pharmacy Request")
"RTN","PSORESK",92,0)
 .D ^DIR K DIR I $D(DIRUT) W !?5,"Comments are required, 10-75 characters.",! Q
"RTN","PSORESK",93,0)
 .Q
"RTN","PSORESK",94,0)
 S (PSODEF,COM)=$G(Y) K X,Y
"RTN","PSORESK",95,0)
 D NOW^%DTC S QTY=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",4) I $G(^PSDRUG(QDRUG,660.1)) D
"RTN","PSORESK",96,0)
 .I $G(PSOWHERE),'$G(PSOINVTX) Q
"RTN","PSORESK",97,0)
 .S ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)+$G(QTY)
"RTN","PSORESK",98,0)
 I $G(PSOWHERE) K ^PSRX("AR",+$G(PSOLOCRL),RXP,$G(TYPE))
"RTN","PSORESK",99,0)
 I XTYPE D REVERSE^PSOBPSU1(RXP,TYPE,"RS",4,,1)
"RTN","PSORESK",100,0)
 ;
"RTN","PSORESK",101,0)
 ;save release dates in case can't perform the delete of .01     *259
"RTN","PSORESK",102,0)
 S:XTYPE SVRELDT=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",18)
"RTN","PSORESK",103,0)
 S:'XTYPE SVRELDT=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",19)
"RTN","PSORESK",104,0)
 ;
"RTN","PSORESK",105,0)
 ;del rel date 1st and then attempt to del .01 field
"RTN","PSORESK",106,0)
 S DA(1)=RXP,DA=TYPE,DIE="^PSRX("_DA(1)_","_$S(XTYPE:1,1:"""P""")_",",DR=$S(XTYPE:"17////@",1:"8////@")_";.01///@"
"RTN","PSORESK",107,0)
 W ! D ^DIE
"RTN","PSORESK",108,0)
 ;
"RTN","PSORESK",109,0)
 ;if node still exists then fileman could not delete .01         *259
"RTN","PSORESK",110,0)
 I $D(^PSRX(RXP,XTYPE,TYPE,0)) D  G BC
"RTN","PSORESK",111,0)
 . W " - Not Returned!"
"RTN","PSORESK",112,0)
 . S DA(1)=RXP,DA=TYPE,DIE="^PSRX("_DA(1)_","_$S(XTYPE:1,1:"""P""")_","
"RTN","PSORESK",113,0)
 . S DR=$S(XTYPE:"17////",1:"8////")_SVRELDT   ;put back saved rel dte
"RTN","PSORESK",114,0)
 . D ^DIE,UL
"RTN","PSORESK",115,0)
 ;
"RTN","PSORESK",116,0)
 ;fall thru and perform RTS for refills/partials
"RTN","PSORESK",117,0)
 D:XTYPE'="P" NPF D ACT^PSORESK1
"RTN","PSORESK",118,0)
 W !!,"Rx # "_$P(^PSRX(RXP,0),"^")_$S(XTYPE:" REFILL",1:" PARTIAL")_" #"_TYPE_" Returned to Stock" S DA=$O(^PS(52.5,"B",RXP,0)) I DA S DIK="^PS(52.5," D ^DIK
"RTN","PSORESK",119,0)
 K PSODISPP S:'XTYPE PSODISPP=1 D:XTYPE EN^PSOHDR("PRES",RXP) D EN^PSOHLSN1(RXP,"ZD") K PSODISPP
"RTN","PSORESK",120,0)
 D UL G BC
"RTN","PSORESK",121,0)
EX ;
"RTN","PSORESK",122,0)
 K DA,DR,DIE,X,X1,X2,Y,RXP,REC,DIR,XDT,REC,RDUZ,DIRUT,PSOCPN,PSOCPRX,YY,QDRUG,QTY,TYPE,XTYPE,I,%,DIRUT,COPAYFLG,PSOINVTX,RESK,PSOPCECT,COM,PSOWHERE,PSOLOCRL,PSODEFLG,PSORRDFN,PSOMSG,PSOPLCK,PSDCS,PSDRS,RETSK
"RTN","PSORESK",123,0)
 K DIC,DIK,PSOPFS
"RTN","PSORESK",124,0)
 Q
"RTN","PSORESK",125,0)
MSG I $G(PSDCS),'$G(PSDRS) W !!,"The PSDMGR key is required to return a CONTROLLED SUBSTANCE Rx to stock and",!,"update corresponding vault balances." S RETSK=1
"RTN","PSORESK",126,0)
 Q
"RTN","PSORESK",127,0)
BCI S RXP=0
"RTN","PSORESK",128,0)
RXP S RXP=$O(^PSRX("B",X,RXP)) I $P($G(^PSRX(+RXP,"STA")),"^")=13 G RXP
"RTN","PSORESK",129,0)
 Q
"RTN","PSORESK",130,0)
UL ;
"RTN","PSORESK",131,0)
 I $G(RXP) D PSOUL^PSSLOCK(RXP)
"RTN","PSORESK",132,0)
 D UL^PSSLOCK(+$G(PSORRDFN))
"RTN","PSORESK",133,0)
 Q
"RTN","PSORESK",134,0)
NPF N PSOY I $G(TYPE)-1>0,+$P(^PSRX(RXP,1,TYPE-1,0),"^") D
"RTN","PSORESK",135,0)
 .S X1=+$P(^PSRX(RXP,1,$G(TYPE)-1,0),"^"),X2=$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",136,0)
 .D C^%DTC S PSOY=X,X1=$P(^PSRX(RXP,2),"^",2),X2=TYPE*$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",137,0)
 .D C^%DTC S X=$S(PSOY<X:X,1:PSOY)
"RTN","PSORESK",138,0)
 I $G(TYPE)-1<1 D
"RTN","PSORESK",139,0)
 .S X1=$P(^PSRX(RXP,2),"^",2),X2=$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",140,0)
 .D C^%DTC S:$P(^PSRX(RXP,3),"^",8) X=""
"RTN","PSORESK",141,0)
 I $G(X) S DA=RXP,DIE=52,DR="102///"_X D ^DIE K DIE
"RTN","PSORESK",142,0)
 Q
"RTN","PSOVDF1")
0^1^B89552983^B87117915
"RTN","PSOVDF1",1,0)
PSOVDF1 ;BPOIFO/EL-OUTPATIENT PHARMACY (PRES, PREF, PPAR) HL7 MESSAGE ;10/04/04
"RTN","PSOVDF1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**190,205,220,235,261**;DEC 1997;Build 9
"RTN","PSOVDF1",3,0)
 ;
"RTN","PSOVDF1",4,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","PSOVDF1",5,0)
 ;
"RTN","PSOVDF1",6,0)
 ; DBIA #4248 - $$XCN200^VDEFEL (or <MultipleTag>^VDEFEL)
"RTN","PSOVDF1",7,0)
 ; DBIA #3552 - $$PARAM^HLCS2
"RTN","PSOVDF1",8,0)
 ; DBIA #3630 - BLDPID^VAFCQRY
"RTN","PSOVDF1",9,0)
 ; DBIA #10040 - 0-NODE of ^SC
"RTN","PSOVDF1",10,0)
 ; DBIA 4571 - ERR^VDEFREQ
"RTN","PSOVDF1",11,0)
 ; 
"RTN","PSOVDF1",12,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","PSOVDF1",13,0)
 ;
"RTN","PSOVDF1",14,0)
 Q
"RTN","PSOVDF1",15,0)
 ;
"RTN","PSOVDF1",16,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ;
"RTN","PSOVDF1",17,0)
 ; This routine creates one of three Outpatient Pharmacy HL7 messages:
"RTN","PSOVDF1",18,0)
 ; RDE^O11^PRES, RDS^O13^PREF, or RDS^O13^PPAR
"RTN","PSOVDF1",19,0)
 ;
"RTN","PSOVDF1",20,0)
 ; Input Parameters:
"RTN","PSOVDF1",21,0)
 ;    EVIEN - IEN of message in file 577
"RTN","PSOVDF1",22,0)
 ;    KEY -   IEN to File #52 ^PSRX
"RTN","PSOVDF1",23,0)
 ;    VFLAG - "V" for VistA HL7 destination (default)
"RTN","PSOVDF1",24,0)
 ;    OUT -   Target array.  Must be passed by reference
"RTN","PSOVDF1",25,0)
 ;    MSHP -  4th piece is SUBTYPE (PRES, PREF, PPAR)
"RTN","PSOVDF1",26,0)
 ;
"RTN","PSOVDF1",27,0)
 ; Returns:
"RTN","PSOVDF1",28,0)
 ;    Two piece string with separator '^':
"RTN","PSOVDF1",29,0)
 ;    Piece 1 - "LM" - LOCAL ARRAY
"RTN","PSOVDF1",30,0)
 ;    Piece 2 - MSH segment, is not set
"RTN","PSOVDF1",31,0)
 ;    OUT - OUTPUT array includes HL7 message for every segment except MSH
"RTN","PSOVDF1",32,0)
 ;              
"RTN","PSOVDF1",33,0)
 ;  Message Body "MSH,PID,ORC1,RXE1,RXR1,FT1,OBX1,NTE1,ORC2,ORC3"
"RTN","PSOVDF1",34,0)
 ;  The Pharmacy Original Fill message will be generated by pgm:PSOVDF2 - (ORC1. . NTE1)
"RTN","PSOVDF1",35,0)
 ;
"RTN","PSOVDF1",36,0)
 ;
"RTN","PSOVDF1",37,0)
 N CTR,PSOVDFD0,PSOVDFD1,DFN,DRCODE,PSOVDRUG,ERR,FILE,FIELD,GIVECODE,GL,GLOB,GLOBAL,HLINST,PSOVDDIV,PSOVD59,PSOVERR
"RTN","PSOVDF1",38,0)
 N I,L,MSG,NTE,P,RES,SEPC,SEPE,SEPF,SEPR,SEPS,SRC,SUBTYPE,TARGET,PSOVDFES,PSOVESC,PSOVDFIN
"RTN","PSOVDF1",39,0)
 N HL7DEL,REPSEPC,REPSEPE,REPSEPF,REPSEPR,REPSEPS,TEMP,TP,UNIT,VAL,WR,X,Y,Z,VCMP,VFT7
"RTN","PSOVDF1",40,0)
 ;
"RTN","PSOVDF1",41,0)
 S (ERR,TARGET)=""
"RTN","PSOVDF1",42,0)
 D INIT
"RTN","PSOVDF1",43,0)
 I $G(ERR)'="" D ERR^VDEFREQ(ERR) S ZTSTOP=1 G QUIT
"RTN","PSOVDF1",44,0)
 D MSHPID
"RTN","PSOVDF1",45,0)
 I $G(ERR)'="" D ERR^VDEFREQ(ERR) S ZTSTOP=1 G QUIT
"RTN","PSOVDF1",46,0)
 D PROCESS^PSOVDF2
"RTN","PSOVDF1",47,0)
 D ORC2
"RTN","PSOVDF1",48,0)
QUIT Q TARGET
"RTN","PSOVDF1",49,0)
 ;
"RTN","PSOVDF1",50,0)
INIT ;
"RTN","PSOVDF1",51,0)
 K GL,OUT,TEMP,TP
"RTN","PSOVDF1",52,0)
 S (PSOVDFD0,PSOVDFES,DFN,DRCODE,PSOVDRUG,FILE,GIVECODE,GLOB,SEPC,SEPE,SEPF,SEPR,SEPS,SRC,SUBTYPE,UNIT,VAL)=""
"RTN","PSOVDF1",53,0)
 S (HL7DEL,REPSEPC,REPSEPE,REPSEPF,REPSEPR,REPSEPS)=""
"RTN","PSOVDF1",54,0)
 S OUT("HLS")=0
"RTN","PSOVDF1",55,0)
 S PSOVDFD0=KEY
"RTN","PSOVDF1",56,0)
 I $G(U)'="^" S U="^"
"RTN","PSOVDF1",57,0)
 S FILE=52
"RTN","PSOVDF1",58,0)
 S SUBTYPE=$P($G(MSHP),"~",4)
"RTN","PSOVDF1",59,0)
 S VAL=$G(HL("ECH")) I VAL="" S VAL="~|\&",HL("ECH")=VAL
"RTN","PSOVDF1",60,0)
 S SEPE=$E(VAL,3),REPSEPE=SEPE_"E"_SEPE
"RTN","PSOVDF1",61,0)
 S SEPC=$E(VAL,1),REPSEPC=SEPE_"S"_SEPE
"RTN","PSOVDF1",62,0)
 S SEPR=$E(VAL,2),REPSEPR=SEPE_"R"_SEPE
"RTN","PSOVDF1",63,0)
 S SEPS=$E(VAL,4),REPSEPS=SEPE_"T"_SEPE
"RTN","PSOVDF1",64,0)
 S VAL=$G(HL("FS")) I VAL="" S VAL="^",HL("FS")=VAL
"RTN","PSOVDF1",65,0)
 S SEPF=$E(VAL,1),REPSEPF=SEPE_"F"_SEPE
"RTN","PSOVDF1",66,0)
 S HL7DEL=$G(HL("ECH"))_$G(HL("FS"))
"RTN","PSOVDF1",67,0)
 S GLOB=$$ROOT^DILFD(FILE)_PSOVDFD0_")"
"RTN","PSOVDF1",68,0)
 M GL=@GLOB
"RTN","PSOVDF1",69,0)
 S DFN=$P($G(GL(0)),U,2)
"RTN","PSOVDF1",70,0)
 I $G(DFN)="" S ERR="MISSING DFN IN FILE-52 AT IEN="_PSOVDFD0 Q
"RTN","PSOVDF1",71,0)
 I $G(^DPT(DFN,0))="" S ERR="MISSING DFN IN FILE-2 AT FILE-52/IEN="_PSOVDFD0 Q
"RTN","PSOVDF1",72,0)
 S PSOVDFES=$$REPL(PSOVDFD0)
"RTN","PSOVDF1",73,0)
 S PSOVDFIN=$$SITE^VASITE,PSOVDFIN=$P($G(PSOVDFIN),"^",2),PSOVDFIN=$$REPL(PSOVDFIN)
"RTN","PSOVDF1",74,0)
 Q
"RTN","PSOVDF1",75,0)
 ;
"RTN","PSOVDF1",76,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF1",77,0)
 I $G(VAL)="" Q
"RTN","PSOVDF1",78,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF1",79,0)
 Q
"RTN","PSOVDF1",80,0)
 ;
"RTN","PSOVDF1",81,0)
REPL(L) ; REPLACE HL7 DELIMITER CHAR
"RTN","PSOVDF1",82,0)
 I $G(L)="" Q ""
"RTN","PSOVDF1",83,0)
 I $TR(L,$G(HL7DEL))=L Q L
"RTN","PSOVDF1",84,0)
 N X,Y,Z,RES
"RTN","PSOVDF1",85,0)
 S RES=L
"RTN","PSOVDF1",86,0)
 I $F(L,SEPE) S X=RES D
"RTN","PSOVDF1",87,0)
 . S Z=$P(X,SEPE,2,9999),Y=$P(X,SEPE)_REPSEPE_Z,RES=Y,X=Z I '$F(Z,SEPE) Q
"RTN","PSOVDF1",88,0)
 . F I=2:1 S Z=$P(X,SEPE,2,9999),Y=$P(RES,REPSEPE,1,I-1)_REPSEPE_$P(X,SEPE)_REPSEPE_Z,RES=Y,X=Z I '$F(Z,SEPE) Q
"RTN","PSOVDF1",89,0)
 I $F(RES,SEPC) F I=1:1 S Y=$P(RES,SEPC)_REPSEPC_$P(RES,SEPC,2,9999),RES=Y I '$F(RES,SEPC) Q
"RTN","PSOVDF1",90,0)
 I $F(RES,SEPR) F I=1:1 S Y=$P(RES,SEPR)_REPSEPR_$P(RES,SEPR,2,9999),RES=Y I '$F(RES,SEPR) Q
"RTN","PSOVDF1",91,0)
 I $F(RES,SEPS) F I=1:1 S Y=$P(RES,SEPS)_REPSEPS_$P(RES,SEPS,2,9999),RES=Y I '$F(RES,SEPS) Q
"RTN","PSOVDF1",92,0)
 I $F(RES,SEPF) F I=1:1 S Y=$P(RES,SEPF)_REPSEPF_$P(RES,SEPF,2,9999),RES=Y I '$F(RES,SEPF) Q
"RTN","PSOVDF1",93,0)
 Q RES
"RTN","PSOVDF1",94,0)
 ;
"RTN","PSOVDF1",95,0)
OUT D OUT^PSOVDF2 Q
"RTN","PSOVDF1",96,0)
OUT20 D OUT20^PSOVDF2 Q
"RTN","PSOVDF1",97,0)
 ;
"RTN","PSOVDF1",98,0)
MSHPID ;
"RTN","PSOVDF1",99,0)
MSH ; MSH
"RTN","PSOVDF1",100,0)
 S (HLINST,MSG,SRC)=""
"RTN","PSOVDF1",101,0)
 I '$D(SITEPARM) S SITEPARM=$$PARAM^HLCS2
"RTN","PSOVDF1",102,0)
 S HLINST=$P(SITEPARM,U,6),HLINST=$$REPL(HLINST),SRC=HLINST_"_"_FILE
"RTN","PSOVDF1",103,0)
 S TARGET="LM"_SEPF_MSG
"RTN","PSOVDF1",104,0)
 ;
"RTN","PSOVDF1",105,0)
PID ; PID
"RTN","PSOVDF1",106,0)
 K WR
"RTN","PSOVDF1",107,0)
 S (MSG)=""
"RTN","PSOVDF1",108,0)
 D BLDPID^VAFCQRY(DFN,1,"",.WR,.HL,.ERR)
"RTN","PSOVDF1",109,0)
 I $G(WR(1))="" S ERR="MISSING PID AT DFN="_DFN_" IN FILE-52 AT IEN="_PSOVDFD0 Q
"RTN","PSOVDF1",110,0)
 I $P(WR(1),U,3)="V" S $P(WR(1),U,3)=""
"RTN","PSOVDF1",111,0)
 D OUT20
"RTN","PSOVDF1",112,0)
 K WR
"RTN","PSOVDF1",113,0)
 Q
"RTN","PSOVDF1",114,0)
 ;
"RTN","PSOVDF1",115,0)
ORC2 ; RF
"RTN","PSOVDF1",116,0)
 I '$D(GL(1)) G ORC3
"RTN","PSOVDF1",117,0)
 K TEMP M TEMP=GL(1)
"RTN","PSOVDF1",118,0)
 S PSOVDFD1=0
"RTN","PSOVDF1",119,0)
ORC2A S PSOVDFD1=$O(TEMP(PSOVDFD1)) G ORC3:'PSOVDFD1
"RTN","PSOVDF1",120,0)
 S MSG=""
"RTN","PSOVDF1",121,0)
 S TP=$G(TEMP(PSOVDFD1,0)) I TP="" G ORC2A
"RTN","PSOVDF1",122,0)
 S PSOVESC=$$REPL(PSOVDFD1),VAL=PSOVESC D PUT(3)
"RTN","PSOVDF1",123,0)
 ; (7~4-10.1)
"RTN","PSOVDF1",124,0)
 S (VAL,WR)="",WR=$P(TP,U,19) I $G(WR)'="" D
"RTN","PSOVDF1",125,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="DISPENSED"
"RTN","PSOVDF1",126,0)
 ; (7~5-13)
"RTN","PSOVDF1",127,0)
 S WR=$P(TP,U,15) I $G(WR)'="" D
"RTN","PSOVDF1",128,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),$P(VAL,SEPC,5)=WR,$P(VAL,SEPC,7)=$P(VAL,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF1",129,0)
 D PUT(7)
"RTN","PSOVDF1",130,0)
 S VAL="",$P(VAL,SEPC,2)=PSOVDFES D PUT(8)
"RTN","PSOVDF1",131,0)
 ; (9-7)
"RTN","PSOVDF1",132,0)
 S VAL=$P(TP,U,8) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(9)
"RTN","PSOVDF1",133,0)
 ; (12-15)
"RTN","PSOVDF1",134,0)
 S VAL=$P(TP,U,17) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(12)
"RTN","PSOVDF1",135,0)
 S VAL="REFILL" D PUT(16)
"RTN","PSOVDF1",136,0)
 S VAL=$P(TP,U,9) S:$G(VAL)="" VAL=$P($G(^PSRX(PSOVDFD0,2)),"^",9) I $G(VAL)'="" D
"RTN","PSOVDF1",137,0)
 .S PSOVD59=VAL I $D(PSOVDDIV(VAL)) S VAL=$G(PSOVDDIV(VAL)) S $P(VAL,SEPC,3)=$P($P(VAL,SEPC,3),"_")_"_52.1_8" D PUT(17) Q
"RTN","PSOVDF1",138,0)
 .N PSONCRF,PSONCRFP,PSOSTNUM
"RTN","PSOVDF1",139,0)
 .S X=$G(^PS(59,VAL,0)),PSONCRFP=$P($G(^("SAND")),"^",3)
"RTN","PSOVDF1",140,0)
 .S VAL=$P(X,U),(VAL,PSONCRF)=$$REPL(VAL) Q:VAL=""
"RTN","PSOVDF1",141,0)
 .S PSOSTNUM=$P(X,U,6),PSOSTNUM=$$REPL(PSOSTNUM)
"RTN","PSOVDF1",142,0)
 .S VAL=PSOSTNUM_SEPC_VAL_SEPC_HLINST_"_52.1_8"
"RTN","PSOVDF1",143,0)
 .I PSONCRFP'="" S PSONCRFP=$$REPL(PSONCRFP),VAL=VAL_SEPC_PSONCRFP_SEPC_PSONCRF_SEPC_"NCPDP"
"RTN","PSOVDF1",144,0)
 .S PSOVDDIV(PSOVD59)=$G(VAL)
"RTN","PSOVDF1",145,0)
 .D PUT(17)
"RTN","PSOVDF1",146,0)
 S VAL=$G(PSOVDFIN) D PUT(21)
"RTN","PSOVDF1",147,0)
 I $D(VCMP(PSOVDFD1)) S VAL=SEPC_SEPC_SEPC_VCMP(PSOVDFD1) D PUT(25)
"RTN","PSOVDF1",148,0)
 I $G(MSG)="" G ORC2Q
"RTN","PSOVDF1",149,0)
 S $P(MSG,U)="RF"
"RTN","PSOVDF1",150,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF1",151,0)
ORC2Q ; Q
"RTN","PSOVDF1",152,0)
 ;
"RTN","PSOVDF1",153,0)
RXE2 ; RF
"RTN","PSOVDF1",154,0)
 S MSG=""
"RTN","PSOVDF1",155,0)
 ; (1~4-.01)
"RTN","PSOVDF1",156,0)
 S (VAL,WR)="",WR=$P(TP,U,1) I $G(WR)'="" D
"RTN","PSOVDF1",157,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="REFILL" D PUT(1)
"RTN","PSOVDF1",158,0)
 ; (2~1..~3-6, 2~4-API , 2~6-NDC)
"RTN","PSOVDF1",159,0)
 S VAL=""
"RTN","PSOVDF1",160,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF1",161,0)
 .S VAL=$$NDC^PSOHDR(PSOVDFD0,PSOVDFD1,"R")
"RTN","PSOVDF1",162,0)
 E  S VAL=$P($G(TEMP(PSOVDFD1,1)),U,3) D
"RTN","PSOVDF1",163,0)
 .I $G(VAL)="",$G(PSOVDRUG)'="" S VAL=$P($G(^PSDRUG(PSOVDRUG,2)),"^",4)
"RTN","PSOVDF1",164,0)
 I $G(VAL)'="" D
"RTN","PSOVDF1",165,0)
 .S VAL=$$REPL(VAL)
"RTN","PSOVDF1",166,0)
 .S X="",X=GIVECODE,$P(X,SEPC,4)=VAL,$P(X,SEPC,6)="NDC",VAL=X D PUT(2)
"RTN","PSOVDF1",167,0)
 E  S VAL=GIVECODE D PUT(2)
"RTN","PSOVDF1",168,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF1",169,0)
 ; (5-DEF="UNK" or API)
"RTN","PSOVDF1",170,0)
 S VAL=UNIT D PUT(5)
"RTN","PSOVDF1",171,0)
 ; (8~6-2)
"RTN","PSOVDF1",172,0)
 S (VAL,WR)=""
"RTN","PSOVDF1",173,0)
 S WR=$$GET1^DIQ(52.1,PSOVDFD1_","_PSOVDFD0_",",2,"","","PSOVERR") K PSOVERR I $G(WR)'="" S WR=$$REPL(WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF1",174,0)
 ; (10-1)
"RTN","PSOVDF1",175,0)
 S VAL=$P(TP,U,4),VAL=$$REPL(VAL) D PUT(10)
"RTN","PSOVDF1",176,0)
 ; (14|1-4)
"RTN","PSOVDF1",177,0)
 S VAL=$P(TP,U,5) I $G(VAL)="" G RXE2A
"RTN","PSOVDF1",178,0)
 S VAL=$$XCN200^VDEFEL(VAL,"PHARMACIST") D PUT(14)
"RTN","PSOVDF1",179,0)
 ; (18-17)
"RTN","PSOVDF1",180,0)
RXE2A S VAL=$P(TP,U,18) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(18)
"RTN","PSOVDF1",181,0)
 ; (22-1.1)
"RTN","PSOVDF1",182,0)
 S VAL=$P(TP,U,10) I $G(VAL)'="" S VAL="D"_VAL,VAL=$$REPL(VAL) D PUT(22)
"RTN","PSOVDF1",183,0)
 D RXE31A^PSOVDF3
"RTN","PSOVDF1",184,0)
 D PUT(31)
"RTN","PSOVDF1",185,0)
 I $G(MSG)="" G RXE2Q
"RTN","PSOVDF1",186,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF1",187,0)
RXE2Q ; Q
"RTN","PSOVDF1",188,0)
 ;
"RTN","PSOVDF1",189,0)
NTE2 ; RF
"RTN","PSOVDF1",190,0)
 S MSG=""
"RTN","PSOVDF1",191,0)
 ; (3-52.1_3)
"RTN","PSOVDF1",192,0)
 S WR=$P(TP,U,3) I $G(WR)="" G NTE2Q
"RTN","PSOVDF1",193,0)
 S VAL=PSOVDFD1 D PUT(1)
"RTN","PSOVDF1",194,0)
 S VAL=$$REPL(WR)
"RTN","PSOVDF1",195,0)
 D PUT(3),RREM^PSOVDF3,PUT(4)
"RTN","PSOVDF1",196,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF1",197,0)
NTE2Q ; Q
"RTN","PSOVDF1",198,0)
 ;
"RTN","PSOVDF1",199,0)
FT12 ;  RF
"RTN","PSOVDF1",200,0)
 ; patch 261 - FT1
"RTN","PSOVDF1",201,0)
 D FT1R^PSOVDF3
"RTN","PSOVDF1",202,0)
FT12Q ; Q
"RTN","PSOVDF1",203,0)
 G ORC2A
"RTN","PSOVDF1",204,0)
 ;
"RTN","PSOVDF1",205,0)
ORC3 ; PAR       
"RTN","PSOVDF1",206,0)
 I '$D(GL("P")) Q
"RTN","PSOVDF1",207,0)
 K TEMP M TEMP=GL("P")
"RTN","PSOVDF1",208,0)
 S PSOVDFD1=0
"RTN","PSOVDF1",209,0)
ORC3A S PSOVDFD1=$O(TEMP(PSOVDFD1)) Q:'PSOVDFD1
"RTN","PSOVDF1",210,0)
 S MSG=""
"RTN","PSOVDF1",211,0)
 S TP=$G(TEMP(PSOVDFD1,0)) I TP="" G ORC3A
"RTN","PSOVDF1",212,0)
 S PSOVESC=$$REPL(PSOVDFD1),VAL=PSOVESC D PUT(3)
"RTN","PSOVDF1",213,0)
 ; (7~4-7.5)
"RTN","PSOVDF1",214,0)
 S WR=$P(TP,U,13) I $G(WR)'="" D
"RTN","PSOVDF1",215,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),VAL="",$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="DISPENSED" D PUT(7)
"RTN","PSOVDF1",216,0)
 S VAL="",$P(VAL,SEPC,2)=PSOVDFES D PUT(8)
"RTN","PSOVDF1",217,0)
 ; (9-.08)
"RTN","PSOVDF1",218,0)
 S VAL=$P(TP,U,8) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(9)
"RTN","PSOVDF1",219,0)
 ; (12-6)
"RTN","PSOVDF1",220,0)
 S VAL=$P(TP,U,17) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(12)
"RTN","PSOVDF1",221,0)
 S VAL="PARTIAL" D PUT(16)
"RTN","PSOVDF1",222,0)
 S VAL=$P(TP,U,9) S:$G(VAL)="" VAL=$P($G(^PSRX(PSOVDFD0,2)),"^",9) I $G(VAL)'="" D
"RTN","PSOVDF1",223,0)
 .S PSOVD59=VAL I $D(PSOVDDIV(VAL)) S VAL=$G(PSOVDDIV(VAL)) S $P(VAL,SEPC,3)=$P($P(VAL,SEPC,3),"_")_"_52.2_.09" D PUT(17) Q
"RTN","PSOVDF1",224,0)
 .N PSONCPR,PSONCPRP,PSOSPNUM
"RTN","PSOVDF1",225,0)
 .S X=$G(^PS(59,VAL,0)),PSONCPRP=$P($G(^("SAND")),"^",3)
"RTN","PSOVDF1",226,0)
 .S VAL=$P(X,U),(VAL,PSONCPR)=$$REPL(VAL) Q:VAL=""
"RTN","PSOVDF1",227,0)
 .S PSOSPNUM=$P(X,U,6),PSOSPNUM=$$REPL(PSOSPNUM)
"RTN","PSOVDF1",228,0)
 .S VAL=PSOSPNUM_SEPC_VAL_SEPC_HLINST_"_52.2_.09"
"RTN","PSOVDF1",229,0)
 .I PSONCPRP'="" S PSONCPRP=$$REPL(PSONCPRP),VAL=VAL_SEPC_PSONCPRP_SEPC_PSONCPR_SEPC_"NCPDP"
"RTN","PSOVDF1",230,0)
 .S PSOVDDIV(PSOVD59)=$G(VAL)
"RTN","PSOVDF1",231,0)
 .D PUT(17)
"RTN","PSOVDF1",232,0)
 S VAL=$G(PSOVDFIN) D PUT(21)
"RTN","PSOVDF1",233,0)
 I $G(MSG)="" G ORC3Q
"RTN","PSOVDF1",234,0)
 S $P(MSG,U)="RF"
"RTN","PSOVDF1",235,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF1",236,0)
ORC3Q ; Q
"RTN","PSOVDF1",237,0)
 ;
"RTN","PSOVDF1",238,0)
RXE3 ; PAR
"RTN","PSOVDF1",239,0)
 S MSG=""
"RTN","PSOVDF1",240,0)
 ; (1~4-.01)
"RTN","PSOVDF1",241,0)
 S WR=$P(TP,U,1) I $G(WR)'="" D
"RTN","PSOVDF1",242,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),VAL="",$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="PARTIAL" D PUT(1)
"RTN","PSOVDF1",243,0)
 ; (2~1..~3-6, 2~4-API, 2~6-NDC)
"RTN","PSOVDF1",244,0)
 S VAL=""
"RTN","PSOVDF1",245,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF1",246,0)
 .S VAL=$$NDC^PSOHDR(PSOVDFD0,PSOVDFD1,"P")
"RTN","PSOVDF1",247,0)
 E  S VAL=$P($G(TEMP(PSOVDFD1,0)),U,12) D
"RTN","PSOVDF1",248,0)
 .I $G(VAL)="",$G(PSOVDRUG)'="" S VAL=$P($G(^PSDRUG(PSOVDRUG,2)),"^",4)
"RTN","PSOVDF1",249,0)
 I $G(VAL)'="" D
"RTN","PSOVDF1",250,0)
 .S VAL=$$REPL(VAL)
"RTN","PSOVDF1",251,0)
 .S X="",X=GIVECODE,$P(X,SEPC,4)=VAL,$P(X,SEPC,6)="NDC",VAL=X D PUT(2)
"RTN","PSOVDF1",252,0)
 E  S VAL=GIVECODE D PUT(2)
"RTN","PSOVDF1",253,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF1",254,0)
 ; (5-DEF="UNK" or API)
"RTN","PSOVDF1",255,0)
 S VAL=UNIT D PUT(5)
"RTN","PSOVDF1",256,0)
 ; (8~6-.02)
"RTN","PSOVDF1",257,0)
 S (VAL,WR)=""
"RTN","PSOVDF1",258,0)
 S WR=$$GET1^DIQ(52.2,PSOVDFD1_","_PSOVDFD0_",",.02,"","","PSOVERR") K PSOVERR I $G(WR)'="" S WR=$$REPL(WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF1",259,0)
 ; (10-.04)
"RTN","PSOVDF1",260,0)
 S VAL=$P(TP,U,4),VAL=$$REPL(VAL) D PUT(10)
"RTN","PSOVDF1",261,0)
 ; (14|1-.05)
"RTN","PSOVDF1",262,0)
 S VAL=$P(TP,U,5) I $G(VAL)="" G RXE3B
"RTN","PSOVDF1",263,0)
 S VAL=$$XCN200^VDEFEL(VAL,"PHARMACIST") D PUT(14)
"RTN","PSOVDF1",264,0)
 ; (18-8)
"RTN","PSOVDF1",265,0)
RXE3B S VAL=$P(TP,U,19) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(18)
"RTN","PSOVDF1",266,0)
 S VAL=$P(TP,U,10) I $G(VAL)'="" S VAL="D"_VAL,VAL=$$REPL(VAL) D PUT(22)
"RTN","PSOVDF1",267,0)
 D RXE31^PSOVDF3
"RTN","PSOVDF1",268,0)
 D PUT(31)
"RTN","PSOVDF1",269,0)
 ;
"RTN","PSOVDF1",270,0)
 I $G(MSG)="" G RXE3Q
"RTN","PSOVDF1",271,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF1",272,0)
RXE3Q ; Q
"RTN","PSOVDF1",273,0)
 ;
"RTN","PSOVDF1",274,0)
NTE3 ; PAR
"RTN","PSOVDF1",275,0)
 S MSG=""
"RTN","PSOVDF1",276,0)
 ; (3-.03)
"RTN","PSOVDF1",277,0)
 S WR=$P(TP,U,3) I $G(WR)="" G NTE3Q
"RTN","PSOVDF1",278,0)
 S VAL=PSOVDFD1 D PUT(1)
"RTN","PSOVDF1",279,0)
 S VAL=$$REPL(WR)
"RTN","PSOVDF1",280,0)
 D PUT(3),PREM^PSOVDF3,PUT(4)
"RTN","PSOVDF1",281,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF1",282,0)
NTE3Q ; Q
"RTN","PSOVDF1",283,0)
FT13 ; patch 261
"RTN","PSOVDF1",284,0)
 D FT1R^PSOVDF3
"RTN","PSOVDF1",285,0)
 G ORC3A
"RTN","PSOVDF1",286,0)
 ;
"RTN","PSOVDF1",287,0)
 Q
"RTN","PSOVDF2")
0^2^B86097500^B85283768
"RTN","PSOVDF2",1,0)
PSOVDF2 ;BPOIFO/EL-OUTPATIENT PHARMACY (PRES, PREF, PPAR) HL7 MESSAGE ;10/04/04
"RTN","PSOVDF2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**190,205,220,235,261**;DEC 1997;Build 9
"RTN","PSOVDF2",3,0)
 ;
"RTN","PSOVDF2",4,0)
 ; DBIAs:
"RTN","PSOVDF2",5,0)
 ; 2226-PS(51.2
"RTN","PSOVDF2",6,0)
 ; 221-PSDRUG
"RTN","PSOVDF2",7,0)
 ; 4248-VDEFEL
"RTN","PSOVDF2",8,0)
 ;
"RTN","PSOVDF2",9,0)
 Q
"RTN","PSOVDF2",10,0)
 ;
"RTN","PSOVDF2",11,0)
 ; Creates one of three Outpatient HL7 messages:
"RTN","PSOVDF2",12,0)
 ; RDE^O11^PRES, RDS^O13^PREF, or RDS^O13^PPAR
"RTN","PSOVDF2",13,0)
 ;
"RTN","PSOVDF2",14,0)
 ; Returns:
"RTN","PSOVDF2",15,0)
 ; Piece ^ 1 - "LM"-Local Array
"RTN","PSOVDF2",16,0)
 ; Piece ^ 2 - MSH segment, not set
"RTN","PSOVDF2",17,0)
 ; OUT - OUTPUT array includes HL7 message for every segment except MSH
"RTN","PSOVDF2",18,0)
 ;
"RTN","PSOVDF2",19,0)
 ; Message Body "MSH,PID,ORC1,RXE1,RXR1,FT1,OBX1,NTE1,ORC2,ORC3"
"RTN","PSOVDF2",20,0)
 ;
"RTN","PSOVDF2",21,0)
 ;
"RTN","PSOVDF2",22,0)
OUT ; Output
"RTN","PSOVDF2",23,0)
 N WR K WR
"RTN","PSOVDF2",24,0)
 S L=1
"RTN","PSOVDF2",25,0)
OUT10 I $L(MSG)<247 S WR(L)=MSG
"RTN","PSOVDF2",26,0)
 I $L(MSG)>246 S WR(L)=$E(MSG,1,246),L=L+1,MSG=$E(MSG,247,99999) G OUT10
"RTN","PSOVDF2",27,0)
 ;
"RTN","PSOVDF2",28,0)
OUT20 ; VISTA HL7
"RTN","PSOVDF2",29,0)
 S X=""
"RTN","PSOVDF2",30,0)
 F I=1:1 S X=$G(WR(I)) Q:X=""  D
"RTN","PSOVDF2",31,0)
 .  I I=1 S OUT("HLS")=$G(OUT("HLS"))+1,OUT("HLS",OUT("HLS"))=X
"RTN","PSOVDF2",32,0)
 .  E  I I>1 S OUT("HLS",OUT("HLS"),I-1)=X
"RTN","PSOVDF2",33,0)
 Q
"RTN","PSOVDF2",34,0)
 ;
"RTN","PSOVDF2",35,0)
GET(GLOBAL,L,P) ; GET(GLOBAL,NODE,PIECE)
"RTN","PSOVDF2",36,0)
 I $G(GLOBAL(L))="" Q ""
"RTN","PSOVDF2",37,0)
 N RES
"RTN","PSOVDF2",38,0)
 S RES=$P(GLOBAL(L),U,P)
"RTN","PSOVDF2",39,0)
 Q RES
"RTN","PSOVDF2",40,0)
 ;
"RTN","PSOVDF2",41,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF2",42,0)
 I $G(VAL)="" Q
"RTN","PSOVDF2",43,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF2",44,0)
 Q
"RTN","PSOVDF2",45,0)
 ;
"RTN","PSOVDF2",46,0)
PROCESS ;
"RTN","PSOVDF2",47,0)
ORC1 ; ORC ORIGINAL FILL
"RTN","PSOVDF2",48,0)
 S MSG="",CTR=0
"RTN","PSOVDF2",49,0)
 S VAL=$$GET(.GL,"OR1",2) I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_SRC_"_39.3" D PUT(2)
"RTN","PSOVDF2",50,0)
 S VAL=PSOVDFES_SEPC_SRC_"_.001" D PUT(3)
"RTN","PSOVDF2",51,0)
 S VAL="CM" D PUT(5)
"RTN","PSOVDF2",52,0)
 S (VAL,WR)="",WR=$$GET(.GL,2,2) I $G(WR)'="" D
"RTN","PSOVDF2",53,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="FILL"
"RTN","PSOVDF2",54,0)
 S WR=$$GET(.GL,2,6) I $G(WR)'="" D
"RTN","PSOVDF2",55,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,5)=WR,$P(VAL,SEPC,7)=$P(VAL,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF2",56,0)
 I $G(VAL)'="" S CTR=CTR+1
"RTN","PSOVDF2",57,0)
 S (TP)="",WR=$$GET(.GL,0,13) I $G(WR)'="" D
"RTN","PSOVDF2",58,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)="ISSUED" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",59,0)
 S (TP)="",WR=$$GET(.GL,2,5) I $G(WR)'="" D
"RTN","PSOVDF2",60,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,4)=WR,$P(TP,SEPC,7)="DISPENSED"
"RTN","PSOVDF2",61,0)
 ; (7~5|3-101)
"RTN","PSOVDF2",62,0)
 S WR=$$GET(.GL,3,1) I $G(WR)'="" D
"RTN","PSOVDF2",63,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)=$P(TP,SEPC,7)_"/LAST DISPENSED"
"RTN","PSOVDF2",64,0)
 I $G(TP)'="" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",65,0)
 ; (7~5|4-26.1)
"RTN","PSOVDF2",66,0)
 S (TP)="",WR=$$GET(.GL,3,5) I $G(WR)'="" D
"RTN","PSOVDF2",67,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)="CANCEL" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",68,0)
 I $G(VAL)'="" D PUT(7)
"RTN","PSOVDF2",69,0)
 ; (9-21)
"RTN","PSOVDF2",70,0)
 S VAL=$$GET(.GL,2,1),VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(9)
"RTN","PSOVDF2",71,0)
 ; (10-16)
"RTN","PSOVDF2",72,0)
 S VAL=$$GET(.GL,0,16) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(10)
"RTN","PSOVDF2",73,0)
 ; (12|1-4)
"RTN","PSOVDF2",74,0)
 S WR="",VAL=$$GET(.GL,0,4) I $G(VAL)'="" D
"RTN","PSOVDF2",75,0)
 . S WR=$$XCN200^VDEFEL(VAL,"RE")
"RTN","PSOVDF2",76,0)
 ; (12|2-109)
"RTN","PSOVDF2",77,0)
 S TP="",VAL=$$GET(.GL,3,3) I $G(VAL)'="" D
"RTN","PSOVDF2",78,0)
 . S TP=$$XCN200^VDEFEL(VAL,"COSIGNER"),$P(WR,SEPR,2)=TP
"RTN","PSOVDF2",79,0)
 I $G(WR)'="" S VAL=WR D PUT(12)
"RTN","PSOVDF2",80,0)
 ; (13-5)
"RTN","PSOVDF2",81,0)
 S VAL=$$GET(.GL,0,5)
"RTN","PSOVDF2",82,0)
 I VAL'="" D ORC13^PSOVDF3,PUT(13)
"RTN","PSOVDF2",83,0)
 S (VAL,PSOVD59)=$$GET(.GL,2,9) I $G(VAL)'="" D
"RTN","PSOVDF2",84,0)
 .N PSONCOR,PSONCORP,PSOSINUM
"RTN","PSOVDF2",85,0)
 .S X=$G(^PS(59,VAL,0)),PSONCORP=$P($G(^("SAND")),"^",3)
"RTN","PSOVDF2",86,0)
 .S VAL=$P(X,U),(VAL,PSONCOR)=$$REPL^PSOVDF1(VAL) Q:VAL=""
"RTN","PSOVDF2",87,0)
 .S PSOSINUM=$P(X,U,6),PSOSINUM=$$REPL^PSOVDF1(PSOSINUM)
"RTN","PSOVDF2",88,0)
 .S VAL=PSOSINUM_SEPC_VAL_SEPC_SRC_"_20"
"RTN","PSOVDF2",89,0)
 .I PSONCORP'="" S PSONCORP=$$REPL^PSOVDF1(PSONCORP),VAL=VAL_SEPC_PSONCORP_SEPC_PSONCOR_SEPC_"NCPDP"
"RTN","PSOVDF2",90,0)
 .S PSOVDDIV(PSOVD59)=$G(VAL)
"RTN","PSOVDF2",91,0)
 .D PUT(17)
"RTN","PSOVDF2",92,0)
 S VAL=$G(PSOVDFIN) D PUT(21)
"RTN","PSOVDF2",93,0)
 N PSOVLV,PSOVAR,PSOVEN,DIC,DR,DA,DIQ D
"RTN","PSOVDF2",94,0)
 .I $D(GL(4)) D ORCCS^PSOVDF3
"RTN","PSOVDF2",95,0)
 .S DIC=52,DR="100",(DA,PSOVEN)=PSOVDFD0,DIQ="PSOVAR",DIQ(0)="IE" D EN^DIQ1
"RTN","PSOVDF2",96,0)
 .S VAL=$G(PSOVAR(52,PSOVEN,100,"I")) I VAL'="" D ORC25^PSOVDF3
"RTN","PSOVDF2",97,0)
 .I VAL="",'$D(VCMP) Q
"RTN","PSOVDF2",98,0)
 .S:VAL="" VAL=SEPC_SEPC
"RTN","PSOVDF2",99,0)
 .S VAL=VAL_$S($D(VCMP(0)):SEPC_VCMP(0),1:"") D PUT(25)
"RTN","PSOVDF2",100,0)
 I $G(MSG)="" G ORC1Q
"RTN","PSOVDF2",101,0)
 S $P(MSG,U)="RE"
"RTN","PSOVDF2",102,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF2",103,0)
ORC1Q ; Q
"RTN","PSOVDF2",104,0)
 ;
"RTN","PSOVDF2",105,0)
RXE1 ; RXE ORIGINAL FILL
"RTN","PSOVDF2",106,0)
 S MSG=""
"RTN","PSOVDF2",107,0)
 ; (1~4-22)
"RTN","PSOVDF2",108,0)
 S (VAL,WR)="",CTR=0 I $D(GL(6)) K TEMP M TEMP=GL(6) S WR=$$DOSE^PSOVDF3(.TEMP) I $G(WR)'="" S VAL=WR
"RTN","PSOVDF2",109,0)
 D FINISH^PSOVDF3
"RTN","PSOVDF2",110,0)
 D PUT(1)
"RTN","PSOVDF2",111,0)
 N PSOV568,PSOVNAME,PSOVUIDN,PSOVLL,PSOVNND,PSOVNDF,PSONAM50,PSOVCMOP
"RTN","PSOVDF2",112,0)
 S (GIVECODE,P,PSOVNDF,PSOVDRUG,VAL,PSOVNND,PSOV568,PSOVNAME,PSOVLL,PSOVUIDN,PSOVCMOP,PSONAM50)="",PSOVDRUG=$$GET(.GL,0,6)
"RTN","PSOVDF2",113,0)
 I +$G(PSOVDRUG)'>0 G RXE1A
"RTN","PSOVDF2",114,0)
 S PSOVNND=$G(^PSDRUG(PSOVDRUG,"ND")),PSOV568=0
"RTN","PSOVDF2",115,0)
 I $P(PSOVNND,"^",10)'="" S PSOVCMOP=$$REPL^PSOVDF1($P(PSOVNND,"^",10))
"RTN","PSOVDF2",116,0)
 S PSOVNDF=$P(PSOVNND,"^",3),PSOVLL=$P(PSOVNND,"^") I +PSOVNDF>0 D
"RTN","PSOVDF2",117,0)
 .S PSOVUIDN=$$PROD0^PSNAPIS(+PSOVLL,+PSOVNDF),PSOVNAME=$P(PSOVUIDN,"^"),PSOVNAME=$$REPL^PSOVDF1(PSOVNAME) S PSOV568=$$GETVUID^XTID(50.68,,+PSOVNDF_",")
"RTN","PSOVDF2",118,0)
 I $P($G(PSOV568),"^")'=0 S PSOV568=$$REPL^PSOVDF1(PSOV568) S VAL=$G(PSOV568)_SEPC_$G(PSOVNAME)_SEPC_"99VA_52_6",GIVECODE=VAL G RXE1A
"RTN","PSOVDF2",119,0)
 S PSONAM50=$P($G(^PSDRUG(PSOVDRUG,0)),"^"),PSONAM50=$$REPL^PSOVDF1(PSONAM50) S VAL=SEPC_PSONAM50_SEPC_SRC_"_6",GIVECODE=VAL
"RTN","PSOVDF2",120,0)
 ; (2~4-API or 52_27 or 50_31)
"RTN","PSOVDF2",121,0)
RXE1A S WR=""
"RTN","PSOVDF2",122,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF2",123,0)
 .  S WR=$$NDC^PSOHDR(PSOVDFD0,0)
"RTN","PSOVDF2",124,0)
 E  S WR=$$GET(.GL,2,7) D
"RTN","PSOVDF2",125,0)
 .  I $G(WR)="",($G(PSOVDRUG)'="") S X=$G(^PSDRUG(PSOVDRUG,2)),WR=$P(X,U,4)
"RTN","PSOVDF2",126,0)
 I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,6)="NDC",DRCODE=VAL
"RTN","PSOVDF2",127,0)
 D PUT(2)
"RTN","PSOVDF2",128,0)
 N PSOLUN,PSOLUNI
"RTN","PSOVDF2",129,0)
 S (UNIT,VAL)="" I $G(PSOVNDF)'="" D
"RTN","PSOVDF2",130,0)
 .S PSOLUN=$$DFSU^PSNAPIS(PSOVLL,PSOVNDF)
"RTN","PSOVDF2",131,0)
 .I $G(PSOLUN)'="" N PSOUNTXT S PSOUNTXT=$P(PSOLUN,U,6),PSOUNTXT=$$REPL^PSOVDF1(PSOUNTXT),PSOLUNI=$P(PSOLUN,"^",5),PSOLUNI=$$REPL^PSOVDF1(PSOLUNI) S VAL=PSOLUNI_SEPC_PSOUNTXT_SEPC_SRC_"_6"
"RTN","PSOVDF2",132,0)
 I $G(VAL)="" S VAL="UNK"
"RTN","PSOVDF2",133,0)
 S UNIT=VAL D PUT(5)
"RTN","PSOVDF2",134,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF2",135,0)
 S VAL="" D RXE6^PSOVDF3 D PUT(6)
"RTN","PSOVDF2",136,0)
 S CTR=0,(VAL,WR)=""
"RTN","PSOVDF2",137,0)
 ; (7|3-113)
"RTN","PSOVDF2",138,0)
 I $D(GL(6)) K TEMP M TEMP=GL(6) S WR=$$NSET^PSOVDF3(.TEMP) I $G(WR)'="" S VAL=WR
"RTN","PSOVDF2",139,0)
 ;Don't piece out INS nodes, can possibly contain up-arrow from Provider Comments
"RTN","PSOVDF2",140,0)
 S WR=$G(GL("INS")) I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),CTR=CTR+1,WR=SEPC_WR_SEPC_SRC_"_114",$P(VAL,SEPR,CTR)=WR
"RTN","PSOVDF2",141,0)
 S WR=$$GET(.GL,"INSS",1) I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),CTR=CTR+1,WR=SEPC_WR_SEPC_SRC_"_114.1",$P(VAL,SEPR,CTR)=WR
"RTN","PSOVDF2",142,0)
 I $D(GL("INS1")) K TEMP M TEMP=GL("INS1") S WR=$$SSETX^PSOVDF3(.TEMP,SRC_"_115"),VAL=VAL_SEPR_WR
"RTN","PSOVDF2",143,0)
 D PUT(7)
"RTN","PSOVDF2",144,0)
 ; (8~6-11)
"RTN","PSOVDF2",145,0)
 S (WR,VAL)=""
"RTN","PSOVDF2",146,0)
 S WR=$$GET1^DIQ(52,PSOVDFD0_",",11,"","","PSOVERR") K PSOVERR I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF2",147,0)
 ; (10-7)
"RTN","PSOVDF2",148,0)
 S VAL=$$GET(.GL,0,7),VAL=$$REPL^PSOVDF1(VAL) D PUT(10)
"RTN","PSOVDF2",149,0)
 ; (12-9)
"RTN","PSOVDF2",150,0)
 S VAL=$$GET(.GL,0,9),VAL=$$REPL^PSOVDF1(VAL) D PUT(12)
"RTN","PSOVDF2",151,0)
 ; (14|1-23)
"RTN","PSOVDF2",152,0)
 S WR="",VAL=$$GET(.GL,2,3) I $G(VAL)'="" D
"RTN","PSOVDF2",153,0)
 . S WR=$$XCN200^VDEFEL(VAL,"PHARMACIST")
"RTN","PSOVDF2",154,0)
 ; (14|2-104)
"RTN","PSOVDF2",155,0)
 S TP="",VAL=$$GET(.GL,2,10) I $G(VAL)'="" D
"RTN","PSOVDF2",156,0)
 . S TP=$$XCN200^VDEFEL(VAL,"VERIFIER PHARM"),$P(WR,SEPR,2)=TP
"RTN","PSOVDF2",157,0)
 I $G(WR)'="" S VAL=WR D PUT(14)
"RTN","PSOVDF2",158,0)
 ; (15-.01)
"RTN","PSOVDF2",159,0)
 S VAL=$$GET(.GL,0,1),VAL=$$REPL^PSOVDF1(VAL) D PUT(15)
"RTN","PSOVDF2",160,0)
 ; (18-31)
"RTN","PSOVDF2",161,0)
 S VAL=$$GET(.GL,2,13) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(18)
"RTN","PSOVDF2",162,0)
 ; (21|1-10.2=1 or 10)
"RTN","PSOVDF2",163,0)
 S VAL="" I '$D(GL("SIG")) G RXE1B
"RTN","PSOVDF2",164,0)
 I $P(GL("SIG"),U,2)=1 D
"RTN","PSOVDF2",165,0)
 . I $D(GL("SIG1")) K TEMP M TEMP=GL("SIG1") S VAL=$$SSETX^PSOVDF3(.TEMP,SRC_"_10.2")
"RTN","PSOVDF2",166,0)
 E  S VAL=$$GET(.GL,"SIG",1) I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_SEPC_SRC_"_10"
"RTN","PSOVDF2",167,0)
 D PUT(21)
"RTN","PSOVDF2",168,0)
RXE1B ; (22-8)
"RTN","PSOVDF2",169,0)
 S VAL=$$GET(.GL,0,8) I $G(VAL)'="" S VAL="D"_VAL,VAL=$$REPL^PSOVDF1(VAL) D PUT(22)
"RTN","PSOVDF2",170,0)
 S WR="",VAL=$$GET(.GL,"TN",1)
"RTN","PSOVDF2",171,0)
 I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),WR=VAL_SEPC_SEPC_SRC_"_6.5"
"RTN","PSOVDF2",172,0)
 D RXE1OF31^PSOVDF3,PUT(31)
"RTN","PSOVDF2",173,0)
 ;
"RTN","PSOVDF2",174,0)
 I $G(MSG)="" G RXE1Q
"RTN","PSOVDF2",175,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF2",176,0)
RXE1Q ; Q
"RTN","PSOVDF2",177,0)
 ;
"RTN","PSOVDF2",178,0)
RXR1 ; RXR ORIGINAL FILL
"RTN","PSOVDF2",179,0)
 S MSG=""
"RTN","PSOVDF2",180,0)
 I '$D(GL(6)) G RXR1Q
"RTN","PSOVDF2",181,0)
 N PSOVRTE,PSORTX
"RTN","PSOVDF2",182,0)
 K TEMP M TEMP=GL(6)
"RTN","PSOVDF2",183,0)
 S PSORTX="",PSOVDFD1=0
"RTN","PSOVDF2",184,0)
RXR1A S PSOVDFD1=$O(TEMP(PSOVDFD1)) G RXR1B:'PSOVDFD1
"RTN","PSOVDF2",185,0)
 S PSORTX=$P($G(TEMP(PSOVDFD1,0)),U,7)
"RTN","PSOVDF2",186,0)
 I $G(PSORTX)="" G RXR1A
"RTN","PSOVDF2",187,0)
 I '$D(^PS(51.2,PSORTX,0)) G RXR1A
"RTN","PSOVDF2",188,0)
 S PSOVRTE=$P(^PS(51.2,PSORTX,0),U),PSOVRTE=$$REPL^PSOVDF1(PSOVRTE),PSORTX=$$REPL^PSOVDF1(PSORTX)
"RTN","PSOVDF2",189,0)
 S VAL=PSORTX_SEPC_PSOVRTE_SEPC_HLINST_"_52.0113_6"
"RTN","PSOVDF2",190,0)
 I $G(MSG)'="" S MSG=MSG_SEPR_VAL
"RTN","PSOVDF2",191,0)
 E  S MSG=VAL
"RTN","PSOVDF2",192,0)
 G RXR1A
"RTN","PSOVDF2",193,0)
RXR1B I $G(MSG)="" G RXR1Q
"RTN","PSOVDF2",194,0)
 S MSG="RXR"_SEPF_MSG D OUT
"RTN","PSOVDF2",195,0)
RXR1Q ; Q
"RTN","PSOVDF2",196,0)
 ;
"RTN","PSOVDF2",197,0)
FT1 ;FT1 ORIGINAL FILL
"RTN","PSOVDF2",198,0)
 S (MSG)=""
"RTN","PSOVDF2",199,0)
 ; (4-22)
"RTN","PSOVDF2",200,0)
 S VAL=$$GET(.GL,2,2)
"RTN","PSOVDF2",201,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(4)
"RTN","PSOVDF2",202,0)
 S VAL="CG" D PUT(6)
"RTN","PSOVDF2",203,0)
 S (VAL,VFT7)="" D FT1A7^PSOVDF3,PUT(7)
"RTN","PSOVDF2",204,0)
 ; (12-17)
"RTN","PSOVDF2",205,0)
 S VAL=$$GET(.GL,0,17),VAL=$$REPL^PSOVDF1(VAL) D PUT(12)
"RTN","PSOVDF2",206,0)
 ; (18-3)
"RTN","PSOVDF2",207,0)
 S TP="",TP=$$GET(.GL,0,3)
"RTN","PSOVDF2",208,0)
 I $G(TP)'="" S VAL=$P($G(^PS(53,TP,0)),U,2),VAL=$$REPL^PSOVDF1(VAL) D PUT(18)
"RTN","PSOVDF2",209,0)
 S VAL=$$GET(.GL,"OR1",5)
"RTN","PSOVDF2",210,0)
 I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL,SRC_"_38") D PUT(20)
"RTN","PSOVDF2",211,0)
 I $G(MSG)="" G FT1Q
"RTN","PSOVDF2",212,0)
 S (VAL,CTR)=1 D PUT(1)
"RTN","PSOVDF2",213,0)
 S MSG="FT1"_SEPF_MSG D OUT
"RTN","PSOVDF2",214,0)
FT1Q ; 
"RTN","PSOVDF2",215,0)
 ;patch 261 - new FT1 seg seq 2 for original
"RTN","PSOVDF2",216,0)
 D FT1S2^PSOVDF3
"RTN","PSOVDF2",217,0)
 ;
"RTN","PSOVDF2",218,0)
OBX1 ; OBX ORIGINAL FILL
"RTN","PSOVDF2",219,0)
 S CTR=0
"RTN","PSOVDF2",220,0)
 F FIELD=41,42,116,117,118,119,120,121,201 D OBXLP
"RTN","PSOVDF2",221,0)
 G OBX1B
"RTN","PSOVDF2",222,0)
 ;
"RTN","PSOVDF2",223,0)
OBXLP ;
"RTN","PSOVDF2",224,0)
 S MSG=""
"RTN","PSOVDF2",225,0)
 N DIC,DR,DA,DIQ,PSOOVAR,PSOOVEN
"RTN","PSOVDF2",226,0)
 S DIC=52,DR=FIELD,(DA,PSOOVEN)=PSOVDFD0,DIQ="PSOOVAR",DIQ(0)="IE" D EN^DIQ1 S VAL=$G(PSOOVAR(52,PSOOVEN,FIELD,"I"))
"RTN","PSOVDF2",227,0)
 I $G(VAL)="" Q
"RTN","PSOVDF2",228,0)
 N PSOOVALE S PSOOVALE=$G(PSOOVAR(52,PSOOVEN,FIELD,"E")),PSOOVALE=$$REPL^PSOVDF1(PSOOVALE)
"RTN","PSOVDF2",229,0)
 N PSOVLVU D
"RTN","PSOVDF2",230,0)
 .S PSOVLVU=$$GETVUID^XTID(52,FIELD,VAL) I $P($G(PSOVLVU),"^")'=0 S VAL=$$REPL^PSOVDF1(PSOVLVU)_SEPC_$G(PSOOVALE)_SEPC_"99VA_52_"_FIELD D PUT(5) Q
"RTN","PSOVDF2",231,0)
 .S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_$G(PSOOVALE)_SEPC_SRC_"_"_FIELD D PUT(5)
"RTN","PSOVDF2",232,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",233,0)
 S VAL="CE" D PUT(2)
"RTN","PSOVDF2",234,0)
 N DD D FIELD^DID(52,FIELD,"","LABEL","DD","ERR")
"RTN","PSOVDF2",235,0)
 S VAL=$G(DD("LABEL")),VAL=$$REPL^PSOVDF1(VAL) D PUT(3)
"RTN","PSOVDF2",236,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF2",237,0)
 S MSG="OBX"_SEPF_MSG D OUT
"RTN","PSOVDF2",238,0)
 Q
"RTN","PSOVDF2",239,0)
 ;
"RTN","PSOVDF2",240,0)
OBX1B ;
"RTN","PSOVDF2",241,0)
 S MSG=""
"RTN","PSOVDF2",242,0)
 ; (5-301)
"RTN","PSOVDF2",243,0)
 S VAL=$$GET(.GL,"SAND",1)
"RTN","PSOVDF2",244,0)
 I $G(VAL)'="" D CLOZ^PSOVDF3
"RTN","PSOVDF2",245,0)
 ;
"RTN","PSOVDF2",246,0)
OBX1C ;
"RTN","PSOVDF2",247,0)
 S MSG=""
"RTN","PSOVDF2",248,0)
 ; (5-302)
"RTN","PSOVDF2",249,0)
 S VAL=$$GET(.GL,"SAND",2)
"RTN","PSOVDF2",250,0)
 I $G(VAL)'="" D WBC^PSOVDF3
"RTN","PSOVDF2",251,0)
 ;
"RTN","PSOVDF2",252,0)
NTE1 ;
"RTN","PSOVDF2",253,0)
 D REM^PSOVDF3
"RTN","PSOVDF2",254,0)
 ;
"RTN","PSOVDF2",255,0)
NTE1B ;
"RTN","PSOVDF2",256,0)
 D PRC^PSOVDF3
"RTN","PSOVDF2",257,0)
 ;
"RTN","PSOVDF2",258,0)
NTE1C ;
"RTN","PSOVDF2",259,0)
 D DEL^PSOVDF3
"RTN","PSOVDF2",260,0)
NTE1Q Q
"RTN","PSOVDF3")
0^3^B66789111^B24142157
"RTN","PSOVDF3",1,0)
PSOVDF3 ;BIR/RTR-OUTPATIENT PHARMACY VDEF MESSAGE CONTINUED ;06/16/05
"RTN","PSOVDF3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**205,235,261**;DEC 1997;Build 9
"RTN","PSOVDF3",3,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOVDF3",4,0)
 ;External refernce to PS(50.607 supported by DBIA 2221
"RTN","PSOVDF3",5,0)
 ;
"RTN","PSOVDF3",6,0)
DOSE(GLOBAL) ;Add Dosage information to RXE 1
"RTN","PSOVDF3",7,0)
 N RES S RES=""
"RTN","PSOVDF3",8,0)
 N PSODD1,PSODD2,PSODD3,PSODD5,PSODDL,PSODDN,PSORES1,PSODDUNT,PSOD1FLG
"RTN","PSOVDF3",9,0)
 F PSODDL=0:0 S PSODDL=$O(GLOBAL(PSODDL)) Q:'PSODDL  D
"RTN","PSOVDF3",10,0)
 .S PSODDN=$G(GLOBAL(PSODDL,0)) Q:PSODDN=""
"RTN","PSOVDF3",11,0)
 .S PSODD1=$P(PSODDN,"^"),PSODD2=$P(PSODDN,"^",2),PSODD3=$P(PSODDN,"^",3),PSODD5=$P(PSODDN,"^",5),PSODDUNT=""
"RTN","PSOVDF3",12,0)
 .I PSODD1="",PSODD2="",PSODD5="" Q
"RTN","PSOVDF3",13,0)
 .I PSODD5'="",($E(PSODD5,$L(PSODD5))'?1A) S PSODD5=PSODD5_"D"
"RTN","PSOVDF3",14,0)
 .I PSODD5'="" S PSODD5=$$REPL^PSOVDF1(PSODD5)
"RTN","PSOVDF3",15,0)
 .S PSOD1FLG=0
"RTN","PSOVDF3",16,0)
 .I PSODD2'="",PSODD3'="",$P($G(^PS(50.607,PSODD3,0)),"^")'="" S PSOD1FLG=1,PSODDUNT=$P($G(^(0)),"^"),PSODDUNT=$$REPL^PSOVDF1(PSODDUNT) S:$G(PSODD1)'="" PSODD1=$$REPL^PSOVDF1(PSODD1),PSODD1=PSODD1_PSODDUNT
"RTN","PSOVDF3",17,0)
 .I 'PSOD1FLG,$G(PSODD1)'="" S PSODD1=$$REPL^PSOVDF1(PSODD1)
"RTN","PSOVDF3",18,0)
 .S PSORES1=""
"RTN","PSOVDF3",19,0)
 .I PSODD1'=""!(PSODD2'="") D
"RTN","PSOVDF3",20,0)
 ..I PSODD2'="" S PSODD2=$$REPL^PSOVDF1(PSODD2) S PSORES1=PSODD2 S:PSODD1'="" PSORES1=PSORES1_SEPS_PSODD1 Q
"RTN","PSOVDF3",21,0)
 ..S PSORES1=SEPS_PSODD1
"RTN","PSOVDF3",22,0)
 .I PSODD5'="" D
"RTN","PSOVDF3",23,0)
 ..I PSORES1="" S PSORES1=SEPC_SEPC_PSODD5 Q
"RTN","PSOVDF3",24,0)
 ..S PSORES1=PSORES1_SEPC_SEPC_PSODD5
"RTN","PSOVDF3",25,0)
 .Q:PSORES1=""
"RTN","PSOVDF3",26,0)
 .I $G(RES)'="" S RES=RES_SEPR_PSORES1 Q
"RTN","PSOVDF3",27,0)
 .S RES=PSORES1
"RTN","PSOVDF3",28,0)
 K TEMP
"RTN","PSOVDF3",29,0)
 Q RES
"RTN","PSOVDF3",30,0)
 ;
"RTN","PSOVDF3",31,0)
FINISH ;Finish rest of RXE 1 segment
"RTN","PSOVDF3",32,0)
 N PSOVAL1 S PSOVAL1=$P(VAL,SEPR)
"RTN","PSOVDF3",33,0)
 S WR=""
"RTN","PSOVDF3",34,0)
 S WR=$$GET^PSOVDF2(.GL,2,2)
"RTN","PSOVDF3",35,0)
 I $G(WR)'="" S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(PSOVAL1,SEPC,4)=WR,$P(PSOVAL1,SEPC,7)="FILL"
"RTN","PSOVDF3",36,0)
 ; (1~5-26.1)
"RTN","PSOVDF3",37,0)
 S WR=$$GET^PSOVDF2(.GL,3,5)
"RTN","PSOVDF3",38,0)
 I $G(WR)'="" D
"RTN","PSOVDF3",39,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(PSOVAL1,SEPC,5)=WR,$P(PSOVAL1,SEPC,7)=$P(PSOVAL1,SEPC,7)_"/CANCEL"
"RTN","PSOVDF3",40,0)
 E  S WR=$$GET^PSOVDF2(.GL,2,6) I $G(WR)'="" D
"RTN","PSOVDF3",41,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(PSOVAL1,SEPC,5)=WR,$P(PSOVAL1,SEPC,7)=$P(PSOVAL1,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF3",42,0)
 S $P(VAL,SEPR)=PSOVAL1
"RTN","PSOVDF3",43,0)
 S WR=""
"RTN","PSOVDF3",44,0)
 Q
"RTN","PSOVDF3",45,0)
 ;
"RTN","PSOVDF3",46,0)
REM ;Remarks for Original Fill
"RTN","PSOVDF3",47,0)
 S MSG="",CTR=0
"RTN","PSOVDF3",48,0)
 S VAL=$$GET^PSOVDF2(.GL,3,7)
"RTN","PSOVDF3",49,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",50,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",51,0)
 D PUT(3)
"RTN","PSOVDF3",52,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",53,0)
 S VAL="RE"_SEPC_"REMARKS"_SEPC_SRC_"_12" D PUT(4)
"RTN","PSOVDF3",54,0)
 S MSG="NTE"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",55,0)
 Q
"RTN","PSOVDF3",56,0)
 ;
"RTN","PSOVDF3",57,0)
DEL ;Deletion comments
"RTN","PSOVDF3",58,0)
 S MSG=""
"RTN","PSOVDF3",59,0)
 S VAL=$$GET^PSOVDF2(.GL,"D",1)
"RTN","PSOVDF3",60,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",61,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",62,0)
 D PUT(3)
"RTN","PSOVDF3",63,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",64,0)
 S VAL="DE"_SEPC_"DELETION COMMENTS"_SEPC_SRC_"_108" D PUT(4)
"RTN","PSOVDF3",65,0)
 S MSG="NTE"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",66,0)
 Q
"RTN","PSOVDF3",67,0)
 ;
"RTN","PSOVDF3",68,0)
CLOZ ; Clozapine Dosage
"RTN","PSOVDF3",69,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",70,0)
 D PUT(5)
"RTN","PSOVDF3",71,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",72,0)
 S VAL="NM" D PUT(2)
"RTN","PSOVDF3",73,0)
 S VAL="CLOZAPINE DOSAGE" D PUT(3)
"RTN","PSOVDF3",74,0)
 S VAL="MG/DAY" D PUT(6)
"RTN","PSOVDF3",75,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF3",76,0)
 S MSG="OBX"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",77,0)
 Q
"RTN","PSOVDF3",78,0)
 ;
"RTN","PSOVDF3",79,0)
WBC ; WBC results
"RTN","PSOVDF3",80,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",81,0)
 D PUT(5)
"RTN","PSOVDF3",82,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",83,0)
 S VAL="NM" D PUT(2)
"RTN","PSOVDF3",84,0)
 S VAL="WBC RESULTS" D PUT(3)
"RTN","PSOVDF3",85,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF3",86,0)
 ; (14-303)
"RTN","PSOVDF3",87,0)
 S VAL=$$GET^PSOVDF2(.GL,"SAND",3)
"RTN","PSOVDF3",88,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(14)
"RTN","PSOVDF3",89,0)
 S MSG="OBX"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",90,0)
 Q
"RTN","PSOVDF3",91,0)
PRC ;Provider Comments, do not piece out data, can contain up-arrow
"RTN","PSOVDF3",92,0)
 S MSG=""
"RTN","PSOVDF3",93,0)
 I '$D(GL("PRC")) Q
"RTN","PSOVDF3",94,0)
 S VAL="" K TEMP M TEMP=GL("PRC") S VAL=$$SSETZ(.TEMP,1)
"RTN","PSOVDF3",95,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",96,0)
 D PUT(3)
"RTN","PSOVDF3",97,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",98,0)
 S VAL="PR"_SEPC_"PROVIDER COMMENTS"_SEPC_HLINST_"_52.039_.01" D PUT(4)
"RTN","PSOVDF3",99,0)
 S MSG="NTE"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",100,0)
 Q
"RTN","PSOVDF3",101,0)
SSETZ(GLOBAL,P) ;Format Provider Comments
"RTN","PSOVDF3",102,0)
 N RES,PSOVPCOM,PSOVDFD1,X
"RTN","PSOVDF3",103,0)
 S (RES,X)="",PSOVDFD1=0
"RTN","PSOVDF3",104,0)
SSET10Z S PSOVDFD1=$O(GLOBAL(PSOVDFD1)) G SSETQZ:'PSOVDFD1
"RTN","PSOVDF3",105,0)
 S PSOVPCOM=GLOBAL(PSOVDFD1,0) I PSOVPCOM="" G SSET10Z
"RTN","PSOVDF3",106,0)
 I $G(RES)'="" S RES=RES_" "_PSOVPCOM
"RTN","PSOVDF3",107,0)
 E  S RES=PSOVPCOM
"RTN","PSOVDF3",108,0)
 G SSET10Z
"RTN","PSOVDF3",109,0)
SSETQZ ;
"RTN","PSOVDF3",110,0)
 I $G(RES)'="" S RES=$$REPL^PSOVDF1(RES)
"RTN","PSOVDF3",111,0)
 Q RES
"RTN","PSOVDF3",112,0)
 ;
"RTN","PSOVDF3",113,0)
 Q
"RTN","PSOVDF3",114,0)
 ;
"RTN","PSOVDF3",115,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF3",116,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",117,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF3",118,0)
 Q
"RTN","PSOVDF3",119,0)
 ;
"RTN","PSOVDF3",120,0)
SSET(GL,L) ;Instruction field
"RTN","PSOVDF3",121,0)
 N RES,X,Y
"RTN","PSOVDF3",122,0)
 S RES="",Y=0
"RTN","PSOVDF3",123,0)
 Q:$G(L)="" RES
"RTN","PSOVDF3",124,0)
 F  S Y=$O(GL(Y)) Q:'Y  D
"RTN","PSOVDF3",125,0)
 . S X=GL(Y,0),X=$$REPL^PSOVDF1(X) I X'="" D
"RTN","PSOVDF3",126,0)
 . . S X=SEPC_X
"RTN","PSOVDF3",127,0)
 . . I $G(RES)'="" S RES=RES_SEPR_X_SEPC_L
"RTN","PSOVDF3",128,0)
 . . E  S RES=X_SEPC_L
"RTN","PSOVDF3",129,0)
 . . S CTR=CTR+1
"RTN","PSOVDF3",130,0)
 Q RES
"RTN","PSOVDF3",131,0)
 ;
"RTN","PSOVDF3",132,0)
SSETX(GLOBAL,L) ;Format Sig, don't piece out, can possibly contain up-arrow from Provider Comments
"RTN","PSOVDF3",133,0)
 Q:L=""
"RTN","PSOVDF3",134,0)
 N RES,PSOVSIG,PSOVDFD1,X
"RTN","PSOVDF3",135,0)
 S (RES,X)="",PSOVDFD1=0
"RTN","PSOVDF3",136,0)
SSET10X S PSOVDFD1=$O(GLOBAL(PSOVDFD1)) G SSETQX:'PSOVDFD1
"RTN","PSOVDF3",137,0)
 S PSOVSIG=GLOBAL(PSOVDFD1,0) I PSOVSIG'="" D
"RTN","PSOVDF3",138,0)
 .S PSOVSIG=$$REPL^PSOVDF1(PSOVSIG)
"RTN","PSOVDF3",139,0)
 .I $G(RES)'="" S RES=RES_PSOVSIG
"RTN","PSOVDF3",140,0)
 .E  S RES=$S(L[115:SEPC,1:"")_PSOVSIG
"RTN","PSOVDF3",141,0)
 G SSET10X
"RTN","PSOVDF3",142,0)
SSETQX I $G(RES)="" Q RES
"RTN","PSOVDF3",143,0)
 I L[115 S RES=RES_SEPC_L
"RTN","PSOVDF3",144,0)
 E  S RES=RES_SEPC_SEPC_L
"RTN","PSOVDF3",145,0)
 Q RES
"RTN","PSOVDF3",146,0)
 ;
"RTN","PSOVDF3",147,0)
 Q
"RTN","PSOVDF3",148,0)
ORC13 ;
"RTN","PSOVDF3",149,0)
 S WR="",$P(WR,SEPC,2)=VAL
"RTN","PSOVDF3",150,0)
 S VAL=$P($G(^SC(VAL,0)),U) I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),$P(WR,SEPC)=VAL
"RTN","PSOVDF3",151,0)
 S VAL=WR
"RTN","PSOVDF3",152,0)
 Q
"RTN","PSOVDF3",153,0)
 ;
"RTN","PSOVDF3",154,0)
RXE1OF31 ;
"RTN","PSOVDF3",155,0)
 D RXE31A
"RTN","PSOVDF3",156,0)
 S:WR'="" VAL=WR_SEPR_VAL
"RTN","PSOVDF3",157,0)
 Q
"RTN","PSOVDF3",158,0)
 ;
"RTN","PSOVDF3",159,0)
RXE31 ;
"RTN","PSOVDF3",160,0)
 S VAL=$P($G(^PSDRUG(PSOVDRUG,0)),"^"),VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",161,0)
 S VAL=PSOVDRUG_SEPC_VAL_SEPC_HLINST_"_50_.01"
"RTN","PSOVDF3",162,0)
 Q
"RTN","PSOVDF3",163,0)
 ;
"RTN","PSOVDF3",164,0)
RXE31A ;
"RTN","PSOVDF3",165,0)
 D RXE31
"RTN","PSOVDF3",166,0)
 N CMOP S CMOP=$G(^PSDRUG(PSOVDRUG,"ND"))
"RTN","PSOVDF3",167,0)
 I $P(CMOP,"^",10)'="" S CMOP=$$REPL^PSOVDF1($P(CMOP,"^",10)),VAL=VAL_SEPR_CMOP_SEPC_SEPC_HLINST_"_50_27"
"RTN","PSOVDF3",168,0)
 Q
"RTN","PSOVDF3",169,0)
 ;
"RTN","PSOVDF3",170,0)
RXE6 ;
"RTN","PSOVDF3",171,0)
 N DOSF,DOS,VDOS
"RTN","PSOVDF3",172,0)
 S DOSF="",VDOS=$$GET^PSOVDF2(.GL,"OR1",1)
"RTN","PSOVDF3",173,0)
 Q:VDOS=""
"RTN","PSOVDF3",174,0)
 I $G(VDOS) S DOS=$P($G(^PS(50.7,VDOS,0)),"^",2) D:$G(DOS)
"RTN","PSOVDF3",175,0)
 . S DOSF=$$REPL^PSOVDF1($P($G(^PS(50.606,DOS,0)),"^")) D:DOSF'=""
"RTN","PSOVDF3",176,0)
 . . S VAL=DOS_SEPC_DOSF_SEPC_HLINST_"_50.7_.02"
"RTN","PSOVDF3",177,0)
 . . S VDOS=$$GETVUID^XTID(50.7,.02,DOS) D:$P(VDOS,"^")'=0
"RTN","PSOVDF3",178,0)
 . . . S VDOS=$P(VDOS,"^"),VDOS=$$REPL^PSOVDF1(VDOS) S VAL=VAL_SEPC_VDOS_SEPC_DOSF_SEPC_"99VA_50.7_.02"
"RTN","PSOVDF3",179,0)
 Q
"RTN","PSOVDF3",180,0)
 ;
"RTN","PSOVDF3",181,0)
FT1A7 ;
"RTN","PSOVDF3",182,0)
 S TP=$$GET^PSOVDF2(.GL,"OR1",1)
"RTN","PSOVDF3",183,0)
 S:$G(TP) VAL=$$REPL^PSOVDF1($P($G(^PS(50.7,TP,0)),"^"))
"RTN","PSOVDF3",184,0)
 I VAL'="" S VAL=TP_SEPC_VAL_SEPC_SRC_"_39.2",VFT7=VAL
"RTN","PSOVDF3",185,0)
 Q
"RTN","PSOVDF3",186,0)
 ;
"RTN","PSOVDF3",187,0)
FT1S2 ;  ORIGINAL SEQ# 2
"RTN","PSOVDF3",188,0)
 S VAL=$$GET1^DIQ(52,PSOVDFD0_",",105,"I") Q:VAL=""
"RTN","PSOVDF3",189,0)
 S WR=$$GET1^DIQ(52,PSOVDFD0_",",105) Q:WR=""
"RTN","PSOVDF3",190,0)
 S MSG="",WR=$$REPL^PSOVDF1(WR)
"RTN","PSOVDF3",191,0)
 S VAL=VAL_SEPC_WR_SEPC_SRC_"_105" D PUT(7)
"RTN","PSOVDF3",192,0)
 S VAL=$G(CTR)+1 D PUT(1)
"RTN","PSOVDF3",193,0)
 S VAL=$$GET^PSOVDF2(.GL,2,2)
"RTN","PSOVDF3",194,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(4)
"RTN","PSOVDF3",195,0)
 S VAL="CO" D PUT(6)
"RTN","PSOVDF3",196,0)
 S MSG="FT1"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",197,0)
 Q
"RTN","PSOVDF3",198,0)
 ;
"RTN","PSOVDF3",199,0)
FT1R ; REFILL & PARTIAL
"RTN","PSOVDF3",200,0)
 S VAL=$P(TP,U,11) Q:VAL="" 
"RTN","PSOVDF3",201,0)
 S MSG="",VAL=$$REPL^PSOVDF1(VAL) D PUT(12)
"RTN","PSOVDF3",202,0)
 S VAL=PSOVDFD1 D PUT(1)
"RTN","PSOVDF3",203,0)
 S VAL=$P(TP,U,1) I VAL'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(4)
"RTN","PSOVDF3",204,0)
 S VAL="CG" D PUT(6)
"RTN","PSOVDF3",205,0)
 I $G(VFT7) S VAL=VFT7 D PUT(7)
"RTN","PSOVDF3",206,0)
 S MSG="FT1"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",207,0)
 Q
"RTN","PSOVDF3",208,0)
 ;
"RTN","PSOVDF3",209,0)
NSET(GLOBAL) ;Verb-8, Noun-3, Schedule-7, Conjuntion-5
"RTN","PSOVDF3",210,0)
 N I,J,K,L,M,N,O,P,X,Y,Z
"RTN","PSOVDF3",211,0)
 S (Z,X)="",Y=0,M=52.0113
"RTN","PSOVDF3",212,0)
NSET1 ;
"RTN","PSOVDF3",213,0)
 F  S Y=$O(GLOBAL(Y)) Q:'Y  D
"RTN","PSOVDF3",214,0)
 . S X=$G(GLOBAL(Y,0)) Q:X=""
"RTN","PSOVDF3",215,0)
 . F I=9,4,8,6 S N=I-1,O=M_"_"_N,L=HLINST_"_"_O D
"RTN","PSOVDF3",216,0)
 . . S J=$P($G(X),U,I),J=$$REPL^PSOVDF1(J) I J'="" D
"RTN","PSOVDF3",217,0)
 . . . S P=0 I I=6 S J=$$GET1^DIQ(M,Y_","_PSOVDFD0,N) D
"RTN","PSOVDF3",218,0)
 . . . . S K=$$GETVUID^XTID(M,N) I $P(K,"^")'=0 S K=$P(K,"^"),K=$$REPL^PSOVDF1(K),J=K_SEPC_J_SEPC_"99VA_",P=1
"RTN","PSOVDF3",219,0)
 . . . S J=$S(P:"",1:SEPC)_J
"RTN","PSOVDF3",220,0)
 . . . I Z'="" S Z=Z_SEPR_J_$S(P:O,1:SEPC_L)
"RTN","PSOVDF3",221,0)
 . . . E  S Z=J_SEPC_$S(P:O,1:L)
"RTN","PSOVDF3",222,0)
 . . . S CTR=CTR+1
"RTN","PSOVDF3",223,0)
 Q Z
"RTN","PSOVDF3",224,0)
 ;
"RTN","PSOVDF3",225,0)
ORCCS ; ORC 25,4-6 - Checking the CMOP EVENT sub-file (#52.01)
"RTN","PSOVDF3",226,0)
 N X,Y,RF,VU,I,ST S I=0
"RTN","PSOVDF3",227,0)
 F  S I=$O(GL(4,I)) Q:'I  S X=GL(4,I,0) I X'="" S RF=$P(X,"^",3),Y=$P(X,"^",4) D
"RTN","PSOVDF3",228,0)
 . I Y'="" S ST=$$GET1^DIQ(52.01,I_","_PSOVDFD0,3) I ST'="" S VU=$$GETVUID^XTID(52.01,3) D
"RTN","PSOVDF3",229,0)
 . . I $P(VU,"^")'=0 S VU=$P(VU,"^"),VU=$$REPL^PSOVDF1(VU)
"RTN","PSOVDF3",230,0)
 . . E  S VU=""
"RTN","PSOVDF3",231,0)
 . . S ST=$$REPL^PSOVDF1(ST)
"RTN","PSOVDF3",232,0)
 . . S VCMP(RF)=$S(VU'="":VU,1:Y)_SEPC_ST_SEPC_$S(VU'="":"99VA",1:HLINST)_"_52_400"
"RTN","PSOVDF3",233,0)
 Q
"RTN","PSOVDF3",234,0)
 ;
"RTN","PSOVDF3",235,0)
ORC25 ;
"RTN","PSOVDF3",236,0)
 N PSOVALE S PSOVALE=$G(PSOVAR(52,PSOVEN,100,"E")),PSOVALE=$$REPL^PSOVDF1(PSOVALE)
"RTN","PSOVDF3",237,0)
 S PSOVLV=$$GETVUID^XTID(52,100,VAL)
"RTN","PSOVDF3",238,0)
 I $P($G(PSOVLV),"^")'=0 S PSOVLV=$P(PSOVLV,"^"),PSOVLV=$$REPL^PSOVDF1(PSOVLV) D  Q
"RTN","PSOVDF3",239,0)
 . S VAL=$G(PSOVLV)_SEPC_$G(PSOVALE)_SEPC_"99VA_52_100"
"RTN","PSOVDF3",240,0)
 I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_$G(PSOVALE)_SEPC_SRC_"_100"
"RTN","PSOVDF3",241,0)
 Q
"RTN","PSOVDF3",242,0)
  ; 
"RTN","PSOVDF3",243,0)
PREM ;
"RTN","PSOVDF3",244,0)
 S VAL="RE"_SEPC_"REMARKS"_SEPC_HLINST_"_52.2_.03"
"RTN","PSOVDF3",245,0)
 Q
"RTN","PSOVDF3",246,0)
 ;
"RTN","PSOVDF3",247,0)
RREM ;
"RTN","PSOVDF3",248,0)
 S VAL="RE"_SEPC_"REMARKS"_SEPC_HLINST_"_52.1_3"
"RTN","PSOVDF3",249,0)
 Q
"RTN","PSOVDF3",250,0)
 ; 
"VER")
8.0^22.0
"BLD",6143,6)
^233
**END**
**END**
