EMERGENCY Released ECX*3*14 SEQ #20
Extracted from mail message
**KIDS**:ECX*3.0*14^

**INSTALL NAME**
ECX*3.0*14
"BLD",1683,0)
ECX*3.0*14^DSS EXTRACTS^0^2990215^y
"BLD",1683,4,0)
^9.64PA^^
"BLD",1683,"INIT")
ECX314PT
"BLD",1683,"KRN",0)
^9.67PA^19^18
"BLD",1683,"KRN",.4,0)
.4
"BLD",1683,"KRN",.401,0)
.401
"BLD",1683,"KRN",.402,0)
.402
"BLD",1683,"KRN",.403,0)
.403
"BLD",1683,"KRN",.5,0)
.5
"BLD",1683,"KRN",.84,0)
.84
"BLD",1683,"KRN",3.6,0)
3.6
"BLD",1683,"KRN",3.8,0)
3.8
"BLD",1683,"KRN",9.2,0)
9.2
"BLD",1683,"KRN",9.8,0)
9.8
"BLD",1683,"KRN",9.8,"NM",0)
^9.68A^10^8
"BLD",1683,"KRN",9.8,"NM",1,0)
ECX314PT^^0^B6915527
"BLD",1683,"KRN",9.8,"NM",4,0)
ECXDVSN2^^0^B14513623
"BLD",1683,"KRN",9.8,"NM",5,0)
ECXNURS^^0^B29244196
"BLD",1683,"KRN",9.8,"NM",6,0)
ECXPUTL^^0^B27365320
"BLD",1683,"KRN",9.8,"NM",7,0)
ECXSCX^^0^B68317650
"BLD",1683,"KRN",9.8,"NM",8,0)
ECXTRAC^^0^B36874751
"BLD",1683,"KRN",9.8,"NM",9,0)
ECXUTLA^^0^B52558732
"BLD",1683,"KRN",9.8,"NM",10,0)
ECXTRANS^^0^B31282446
"BLD",1683,"KRN",9.8,"NM","B","ECX314PT",1)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXDVSN2",4)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXNURS",5)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXPUTL",6)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXSCX",7)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXTRAC",8)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXTRANS",10)
 
"BLD",1683,"KRN",9.8,"NM","B","ECXUTLA",9)
 
"BLD",1683,"KRN",19,0)
19
"BLD",1683,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",1683,"KRN",19,"NM",1,0)
ECX PRO SOURCE AUDIT^^0
"BLD",1683,"KRN",19,"NM","B","ECX PRO SOURCE AUDIT",1)
 
"BLD",1683,"KRN",19.1,0)
19.1
"BLD",1683,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",1683,"KRN",101,0)
101
"BLD",1683,"KRN",409.61,0)
409.61
"BLD",1683,"KRN",771,0)
771
"BLD",1683,"KRN",869.2,0)
869.2
"BLD",1683,"KRN",870,0)
870
"BLD",1683,"KRN",8994,0)
8994
"BLD",1683,"KRN","B",.4,.4)
 
"BLD",1683,"KRN","B",.401,.401)
 
"BLD",1683,"KRN","B",.402,.402)
 
"BLD",1683,"KRN","B",.403,.403)
 
"BLD",1683,"KRN","B",.5,.5)
 
"BLD",1683,"KRN","B",.84,.84)
 
"BLD",1683,"KRN","B",3.6,3.6)
 
"BLD",1683,"KRN","B",3.8,3.8)
 
"BLD",1683,"KRN","B",9.2,9.2)
 
"BLD",1683,"KRN","B",9.8,9.8)
 
"BLD",1683,"KRN","B",19,19)
 
"BLD",1683,"KRN","B",19.1,19.1)
 
"BLD",1683,"KRN","B",101,101)
 
"BLD",1683,"KRN","B",409.61,409.61)
 
"BLD",1683,"KRN","B",771,771)
 
"BLD",1683,"KRN","B",869.2,869.2)
 
"BLD",1683,"KRN","B",870,870)
 
"BLD",1683,"KRN","B",8994,8994)
 
"BLD",1683,"QUES",0)
^9.62^^
"BLD",1683,"REQB",0)
^9.611^3^3
"BLD",1683,"REQB",1,0)
ECX*3.0*9^2
"BLD",1683,"REQB",2,0)
ECX*3.0*8^2
"BLD",1683,"REQB",3,0)
ECX*3.0*13^2
"BLD",1683,"REQB","B","ECX*3.0*13",3)
 
"BLD",1683,"REQB","B","ECX*3.0*8",2)
 
"BLD",1683,"REQB","B","ECX*3.0*9",1)
 
"INIT")
ECX314PT
"KRN",19,10855,-1)
0^1
"KRN",19,10855,0)
ECX PRO SOURCE AUDIT^Prosthetics (PRO) Extract Audit^Temporarily out of order.^R^^^^^^^^DSS EXTRACTS
"KRN",19,10855,1,0)
^^2^2^2980715^
"KRN",19,10855,1,1,0)
This option will generate an audit report of the prosthetics information
"KRN",19,10855,1,2,0)
that has been extracted.
"KRN",19,10855,10.1)
PRO Extract Audit
"KRN",19,10855,25)
EN^ECXAPRO
"KRN",19,10855,"U")
PROSTHETICS (PRO) EXTRACT AUDI
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^2971222^2980112^11714
"PKG",513,22,1,"PAH",1,0)
14^2990215
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","ECX314PT")
0^1^B6915527
"RTN","ECX314PT",1,0)
ECX314PT ;ALB/JAP - PATCH ECX*3*14 Post-Install ; October 26, 1998
"RTN","ECX314PT",2,0)
 ;;3.0;DSS EXTRACTS;**14**;Dec 22, 1997
"RTN","ECX314PT",3,0)
 ;
"RTN","ECX314PT",4,0)
POST ;Entry point
"RTN","ECX314PT",5,0)
 N FILE,SPACE,BLANK,LAST
"RTN","ECX314PT",6,0)
 ;get rid of index junk on file #727.826
"RTN","ECX314PT",7,0)
 K ^ECX(727.826,"B"),^DD(727.826,.01,1,1),^DD(727.826,0,"IX","B",727.826,.01)
"RTN","ECX314PT",8,0)
 K ^ECX(727.826,"AINV"),^DD(727.826,.01,1,2),^DD(727.826,0,"IX","AINV",727.826,.01)
"RTN","ECX314PT",9,0)
 K ^DD(727.826,0,"IX","AG1",727.826,8),^DD(727.826,0,"IX","AG2",727.826,14),^DD(727.826,0,"IX","AG3",727.826,32)
"RTN","ECX314PT",10,0)
 K ^DD(727.826,8,1,1),^DD(727.826,14,1,1),^DD(727.826,32,1,1)
"RTN","ECX314PT",11,0)
 ;remove the ainv index on extract files #727.802-#727.825
"RTN","ECX314PT",12,0)
 F I=.802,.803,.804,.805,.806,.808,.809,.81,.811,.813,.814,.815,.817,.819,.823,.824,.825 D
"RTN","ECX314PT",13,0)
 .S FILE=727+I
"RTN","ECX314PT",14,0)
 .W !!,"Deleting ""AINV"" index on file #"_FILE_"."
"RTN","ECX314PT",15,0)
 .K ^DD(FILE,0,"IX","AINV",FILE,.01)
"RTN","ECX314PT",16,0)
 .K ^DD(FILE,.01,1,1)
"RTN","ECX314PT",17,0)
 .K ^ECX(FILE,"AINV")
"RTN","ECX314PT",18,0)
 ;update each file description on all extract files
"RTN","ECX314PT",19,0)
 F I=.802,.803,.804,.805,.806,.808,.809,.81,.811,.813,.814,.815,.817,.819,.823,.824,.825,.826 D
"RTN","ECX314PT",20,0)
 .S FILE=727+I
"RTN","ECX314PT",21,0)
 .W !!,"Updating Description for File #"_FILE_"."
"RTN","ECX314PT",22,0)
 .S BLANK=0,LAST=$O(^DIC(FILE,"%D",""),-1)
"RTN","ECX314PT",23,0)
 .F N=1:1:LAST I $D(^DIC(FILE,"%D",N))  D  Q:BLANK>0
"RTN","ECX314PT",24,0)
 ..S X=^DIC(FILE,"%D",N,0),XX=$L(X),SPACE=0
"RTN","ECX314PT",25,0)
 ..F J=1:1:XX S CHAR=$E(X,J) S:$A(CHAR)'=32 SPACE=SPACE+1
"RTN","ECX314PT",26,0)
 ..I SPACE=0 S BLANK=N
"RTN","ECX314PT",27,0)
 .F N=BLANK+1:1:LAST K ^DIC(FILE,"%D",N,0)
"RTN","ECX314PT",28,0)
 .S N=BLANK
"RTN","ECX314PT",29,0)
 .F ECX=1:1 S ECXX=$P($T(ALL+ECX),";;",2) Q:ECXX="QUIT"  D
"RTN","ECX314PT",30,0)
 ..S N=N+1,^DIC(FILE,"%D",N,0)=ECXX
"RTN","ECX314PT",31,0)
 .S $P(^DIC(FILE,"%D",0),U,3)=N,$P(^DIC(FILE,"%D",0),U,4)=N,$P(^DIC(FILE,"%D",0),U,5)=DT
"RTN","ECX314PT",32,0)
 Q
"RTN","ECX314PT",33,0)
 ;
"RTN","ECX314PT",34,0)
ALL ;update file description for all files 
"RTN","ECX314PT",35,0)
 ;;Since validation techniques will be determined by the local site, it is
"RTN","ECX314PT",36,0)
 ;;intended that the site add whatever cross references deemed necessary.
"RTN","ECX314PT",37,0)
 ;;However, this file contains one nationally determined cross reference,
"RTN","ECX314PT",38,0)
 ;;the "AC" cross reference on the EXTRACT NUMBER field (#2).  This cross
"RTN","ECX314PT",39,0)
 ;;reference is used by the DSS Extracts software package as an essential
"RTN","ECX314PT",40,0)
 ;;feature for managing and purging data in this file and should not be
"RTN","ECX314PT",41,0)
 ;;modified.
"RTN","ECX314PT",42,0)
 ;;  
"RTN","ECX314PT",43,0)
 ;;This file should NOT be modified directly using VA FileMan.  
"RTN","ECX314PT",44,0)
 ;;QUIT
"RTN","ECXDVSN2")
0^4^B14513623
"RTN","ECXDVSN2",1,0)
ECXDVSN2 ;ALB/JAP - Division selection utility (cont.) ;Sep 30, 1997
"RTN","ECXDVSN2",2,0)
 ;;3.0;DSS EXTRACTS;**14**;Dec 22, 1997
"RTN","ECXDVSN2",3,0)
 ;
"RTN","ECXDVSN2",4,0)
RAD(ECXDIV,ECXALL,ECXERR) ;setup division/site information for RAD extract audit report
"RTN","ECXDVSN2",5,0)
 ;   input
"RTN","ECXDVSN2",6,0)
 ;   ECXDIV = passed by reference array variable (required)
"RTN","ECXDVSN2",7,0)
 ;   ECXALL = 0/1 (optional)
"RTN","ECXDVSN2",8,0)
 ;            '0' indicates user to select radiology division;
"RTN","ECXDVSN2",9,0)
 ;            '1' indicates 'all' radiology divisions selected or only one division
"RTN","ECXDVSN2",10,0)
 ;                exists in file #79; default is '1'
"RTN","ECXDVSN2",11,0)
 ;   output
"RTN","ECXDVSN2",12,0)
 ;   ECXDIV = data for radiology division/site;
"RTN","ECXDVSN2",13,0)
 ;            ECXDIV(ien in file #79)=ien in file #4^name^station number
"RTN","ECXDVSN2",14,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",15,0)
 ;            if input problem, then '1' returned
"RTN","ECXDVSN2",16,0)
 N X,Y,DIC,DA,DUOUT,DTOUT,DR,DIQ,OUT,ECXARR,ECXD,ECXIEN
"RTN","ECXDVSN2",17,0)
 S:'$D(ECXALL) ECXALL=1 S:ECXALL="" ECXALL=1
"RTN","ECXDVSN2",18,0)
 S ECXERR=0,ECXD=""
"RTN","ECXDVSN2",19,0)
 ;if ecxall=1, then all radiology divisions/sites are selected
"RTN","ECXDVSN2",20,0)
 I ECXALL=1 D
"RTN","ECXDVSN2",21,0)
 .;ecxd=ecxien; both are iens in file #4
"RTN","ECXDVSN2",22,0)
 .F  S ECXD=$O(^RA(79,"B",ECXD)) Q:ECXD=""  S ECXIEN=$O(^(ECXD,"")) D
"RTN","ECXDVSN2",23,0)
 ..K ECXARR S DA=ECXIEN,DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",24,0)
 ..I $D(ECXARR) S ECXDIV(ECXIEN)=ECXIEN_U_ECXARR(4,ECXIEN,.01)_U_ECXARR(4,ECXIEN,99)
"RTN","ECXDVSN2",25,0)
 ;if ecxall=0, user selects radiology divisions/sites
"RTN","ECXDVSN2",26,0)
 I ECXALL=0 S OUT=0 D
"RTN","ECXDVSN2",27,0)
 .F  Q:OUT!ECXERR  D
"RTN","ECXDVSN2",28,0)
 ..S DIC="^RA(79,",DIC(0)="AEMQ" K X,Y D ^DIC
"RTN","ECXDVSN2",29,0)
 ..I $G(DUOUT)!($G(DTOUT)) S OUT=1,ECXERR=1 Q
"RTN","ECXDVSN2",30,0)
 ..I Y=-1,X="" S OUT=1 Q
"RTN","ECXDVSN2",31,0)
 ..S (ECXIEN,DA)=+Y K ECXARR S DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",32,0)
 ..I $D(ECXARR) S ECXDIV(ECXIEN)=ECXIEN_U_ECXARR(4,ECXIEN,.01)_U_ECXARR(4,ECXIEN,99)
"RTN","ECXDVSN2",33,0)
 I ECXERR=1 K ECXDIV
"RTN","ECXDVSN2",34,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",35,0)
 Q
"RTN","ECXDVSN2",36,0)
 ;
"RTN","ECXDVSN2",37,0)
SUR(ECXDIV,ECXALL,ECXERR) ;setup division/site information for SUR extract audit report
"RTN","ECXDVSN2",38,0)
 ;   input
"RTN","ECXDVSN2",39,0)
 ;   ECXDIV = passed by reference array variable (required)
"RTN","ECXDVSN2",40,0)
 ;   ECXALL = 0/1 (optional)
"RTN","ECXDVSN2",41,0)
 ;            '0' indicates user to select surgery division;
"RTN","ECXDVSN2",42,0)
 ;            '1' indicates 'all' surgery divisions selected or only one division
"RTN","ECXDVSN2",43,0)
 ;                exists in file #133; default is '1'
"RTN","ECXDVSN2",44,0)
 ;   output
"RTN","ECXDVSN2",45,0)
 ;   ECXDIV = data for surgery division/site;
"RTN","ECXDVSN2",46,0)
 ;            ECXDIV(ien in file #133)=ien in file #4^name^station number
"RTN","ECXDVSN2",47,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",48,0)
 ;            if input problem, then '1' returned
"RTN","ECXDVSN2",49,0)
 N X,Y,DIC,DA,DUOUT,DTOUT,DR,DIQ,OUT,ECXARR,ECXD,ECXIEN
"RTN","ECXDVSN2",50,0)
 S:'$D(ECXALL) ECXALL=1 S:ECXALL="" ECXALL=1
"RTN","ECXDVSN2",51,0)
 S ECXERR=0,ECXD=""
"RTN","ECXDVSN2",52,0)
 ;if ecxall=1, then all surgery divisions/sites are selected
"RTN","ECXDVSN2",53,0)
 I ECXALL=1 D
"RTN","ECXDVSN2",54,0)
 .F  S ECXD=$O(^SRO(133,"B",ECXD)) Q:ECXD=""  S ECXIEN=$O(^(ECXD,"")) D
"RTN","ECXDVSN2",55,0)
 ..K ECXARR S DA=ECXD,DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",56,0)
 ..I $D(ECXARR) S ECXDIV(ECXD)=ECXIEN_U_ECXARR(4,ECXD,.01)_U_ECXARR(4,ECXD,99)
"RTN","ECXDVSN2",57,0)
 ;if ecxall=0, user selects surgery divisions/sites
"RTN","ECXDVSN2",58,0)
 I ECXALL=0 S OUT=0 D
"RTN","ECXDVSN2",59,0)
 .F  Q:OUT!ECXERR  D
"RTN","ECXDVSN2",60,0)
 ..S DIC="^SRO(133,",DIC(0)="AEMQ" K X,Y D ^DIC
"RTN","ECXDVSN2",61,0)
 ..I $G(DUOUT)!($G(DTOUT)) S OUT=1,ECXERR=1 Q
"RTN","ECXDVSN2",62,0)
 ..I Y=-1,X="" S OUT=1 Q
"RTN","ECXDVSN2",63,0)
 ..S ECXIEN=+Y,(ECXD,DA)=$P(Y,U,2) K ECXARR S DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",64,0)
 ..I $D(ECXARR) S ECXDIV(ECXD)=ECXIEN_U_ECXARR(4,ECXD,.01)_U_ECXARR(4,ECXD,99)
"RTN","ECXDVSN2",65,0)
 I ECXERR=1 K ECXDIV
"RTN","ECXDVSN2",66,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",67,0)
 Q
"RTN","ECXDVSN2",68,0)
 ;
"RTN","ECXDVSN2",69,0)
PRO(ECXDUZ,ECXPRIME,ECXDIV,ECXALL,ECXERR) ;setup division/site information for PRO extract reports
"RTN","ECXDVSN2",70,0)
 ;   input
"RTN","ECXDVSN2",71,0)
 ;   ECXDUX   = ien in file#200 for user
"RTN","ECXDVSN2",72,0)
 ;   ECXPRIME = primary division ien in file #4 (required)
"RTN","ECXDVSN2",73,0)
 ;   all other variables passed by reference
"RTN","ECXDVSN2",74,0)
 ;   output
"RTN","ECXDVSN2",75,0)
 ;   ECXALL = 0 (one subdivision)
"RTN","ECXDVSN2",76,0)
 ;            1 (all divisions related to primary division)
"RTN","ECXDVSN2",77,0)
 ;   ECXDIV = data array for prosthetics division/site;
"RTN","ECXDVSN2",78,0)
 ;            ECXDIV(n)=ien in file #4^name^station number
"RTN","ECXDVSN2",79,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",80,0)
 ;            if input problem, then '1' returned
"RTN","ECXDVSN2",81,0)
 N X,Y,DA,DR,DUOUT,DTOUT,DIRUT,DIC,DIQ,DIR,OUT,ECXARR
"RTN","ECXDVSN2",82,0)
 S ECXERR=0
"RTN","ECXDVSN2",83,0)
 I +ECXPRIME=0 S ECXERR=1
"RTN","ECXDVSN2",84,0)
 I '$D(^DIC(4,+ECXPRIME)) S ECXERR=1
"RTN","ECXDVSN2",85,0)
 D PDIV3^ECXPUTL(ECXDUZ,ECXPRIME,.ECXDIV)
"RTN","ECXDVSN2",86,0)
 I ECXDIV(1)=0 S ECXERR=1 Q
"RTN","ECXDVSN2",87,0)
 S ECXALL=1
"RTN","ECXDVSN2",88,0)
 S LAST=$O(ECXDIV(99),-1) I LAST>1 D
"RTN","ECXDVSN2",89,0)
 .W !!,"You may select ONE or ALL of the following:",!
"RTN","ECXDVSN2",90,0)
 .F DIV=1:1:LAST D
"RTN","ECXDVSN2",91,0)
 ..W !,"("_DIV_")",?6,$P(ECXDIV(DIV),U,2),?14,$P(ECXDIV(DIV),U,3)
"RTN","ECXDVSN2",92,0)
 .S DIR(0)="SMBA^A:ALL;O:ONE",DIR("A")="Select O(ne) or A(ll): ",DIR("B")="ALL"
"RTN","ECXDVSN2",93,0)
 .W ! K X,Y D ^DIR K DIR
"RTN","ECXDVSN2",94,0)
 .I $D(DUOUT)!($D(DTOUT)) K ECXDIV S OUT=1 Q
"RTN","ECXDVSN2",95,0)
 .Q:Y="A"
"RTN","ECXDVSN2",96,0)
 .S OUT=0 F  D  Q:OUT
"RTN","ECXDVSN2",97,0)
 ..S DIR(0)="NA^1:99:0",DIR("A")="Which one?: ",DIR("?")="^D HELP^ECXDVSN2"
"RTN","ECXDVSN2",98,0)
 ..W ! K X,Y D ^DIR K DIR
"RTN","ECXDVSN2",99,0)
 ..I $D(ECXDIV(+Y)) S DIV=+Y,OUT=1,ECXALL=0 Q
"RTN","ECXDVSN2",100,0)
 ..I $D(DUOUT)!($D(DTOUT)) K ECXDIV S OUT=1 Q
"RTN","ECXDVSN2",101,0)
 .Q:'$D(ECXDIV)
"RTN","ECXDVSN2",102,0)
 .F X=1:1:LAST I X'=DIV K ECXDIV(X)
"RTN","ECXDVSN2",103,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",104,0)
 Q
"RTN","ECXDVSN2",105,0)
 ;
"RTN","ECXDVSN2",106,0)
HELP ;help for dir in pro
"RTN","ECXDVSN2",107,0)
 W !,"A response is required from the following:",!
"RTN","ECXDVSN2",108,0)
 F DIV=1:1:LAST D
"RTN","ECXDVSN2",109,0)
 .W !,"("_DIV_")",?6,$P(ECXDIV(DIV),U,2),?14,$P(ECXDIV(DIV),U,3)
"RTN","ECXDVSN2",110,0)
 W !,"Or ""^"" to exit."
"RTN","ECXDVSN2",111,0)
 Q
"RTN","ECXNURS")
0^5^B29244196
"RTN","ECXNURS",1,0)
ECXNURS ;ALB/JAP,BIR/DMA,PTD-Nursing Extract for DSS ; 11/01/96 10:16
"RTN","ECXNURS",2,0)
 ;;3.0;DSS EXTRACTS;**8,14**;Dec 22, 1997
"RTN","ECXNURS",3,0)
BEG ;entry point from option
"RTN","ECXNURS",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXNURS",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXNURS",6,0)
 Q
"RTN","ECXNURS",7,0)
 ;
"RTN","ECXNURS",8,0)
START ;entry when queued
"RTN","ECXNURS",9,0)
 ;store in ^tmp by patient and date/time
"RTN","ECXNURS",10,0)
 N CNT,QFLG,INP,FIRSTDAY,LASTDAY
"RTN","ECXNURS",11,0)
 S QFLG=0,CNT=0
"RTN","ECXNURS",12,0)
 K ^TMP("ECX",$J)
"RTN","ECXNURS",13,0)
 S FIRSTDAY=$P(ECSD1,".")+1,LASTDAY=$P(ECED,".")
"RTN","ECXNURS",14,0)
 S ECED=ECED+.3,ECD=ECSD1
"RTN","ECXNURS",15,0)
 F  S ECD=$O(^NURSA(214.6,"B",ECD)),ECDA=0 Q:'ECD  Q:ECD>ECED  D  Q:QFLG
"RTN","ECXNURS",16,0)
 .F  S ECDA=$O(^NURSA(214.6,"B",ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXNURS",17,0)
 ..S DIC=214.6,DIQ(0)="I",DA=ECDA,DIQ="LOC",DR=".01;.02;1;3;4;6;7;8"
"RTN","ECXNURS",18,0)
 ..D EN^DIQ1 K DIQ,DIC,DA,DR
"RTN","ECXNURS",19,0)
 ..F J=.01,.02,1,3,4,6,7,8 S EC(J)=LOC(214.6,ECDA,J,"I")
"RTN","ECXNURS",20,0)
 ..Q:EC(8)'=""
"RTN","ECXNURS",21,0)
 ..S INP=$$INP^ECXUTL2(EC(.02),EC(.01))
"RTN","ECXNURS",22,0)
 ..Q:+INP=1
"RTN","ECXNURS",23,0)
 ..; retain latest classification per day per patient
"RTN","ECXNURS",24,0)
 ..S ^TMP("ECX",$J,EC(.02),$P(EC(.01),"."))=EC(1)_U_EC(3)_U_EC(4)_U_EC(6)_U_EC(7)_U_INP_U_EC(.01)
"RTN","ECXNURS",25,0)
 ..K LOC(214.6,ECDA),EC,INP
"RTN","ECXNURS",26,0)
 ..S CNT=CNT+1
"RTN","ECXNURS",27,0)
 ..I $D(ZTQUEUED),(CNT>499),'(CNT#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXNURS",28,0)
 I QFLG K ^TMP("ECX",$J) Q
"RTN","ECXNURS",29,0)
 D RESOLVE
"RTN","ECXNURS",30,0)
 D FILE
"RTN","ECXNURS",31,0)
 K ^TMP("ECX",$J)
"RTN","ECXNURS",32,0)
 Q
"RTN","ECXNURS",33,0)
 ;
"RTN","ECXNURS",34,0)
RESOLVE ;process ^tmp by patient
"RTN","ECXNURS",35,0)
 N DFN,TM,ECD,ECDPREV,ECDNEW,OLDWARD,NEWWARD,NEWDT
"RTN","ECXNURS",36,0)
 S DFN=0
"RTN","ECXNURS",37,0)
 F  S DFN=$O(^TMP("ECX",$J,DFN)) S ECD=0 Q:'DFN  D
"RTN","ECXNURS",38,0)
 .;remove any classifications for day of discharge
"RTN","ECXNURS",39,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD  D
"RTN","ECXNURS",40,0)
 ..I ECD=$P($P(^TMP("ECX",$J,DFN,ECD),U,11),".") K ^TMP("ECX",$J,DFN,ECD)
"RTN","ECXNURS",41,0)
 .;proceed only if ^tmp remains
"RTN","ECXNURS",42,0)
 .Q:'$D(^TMP("ECX",$J,DFN))
"RTN","ECXNURS",43,0)
 .;proceed with fill-in only if processing more than 3 days' data
"RTN","ECXNURS",44,0)
 .Q:LASTDAY<(FIRSTDAY+2)
"RTN","ECXNURS",45,0)
 .;fill-in records for any missing days per inpatient episode
"RTN","ECXNURS",46,0)
 .K TM S ECD=0
"RTN","ECXNURS",47,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD   D
"RTN","ECXNURS",48,0)
 ..S TM(ECD)=$P(^TMP("ECX",$J,DFN,ECD),U,9)
"RTN","ECXNURS",49,0)
 .S (ECD,ECDPREV)=0
"RTN","ECXNURS",50,0)
 .F  S ECD=$O(TM(ECD)) Q:'ECD  D
"RTN","ECXNURS",51,0)
 ..I ECDPREV=0 S ECDPREV=ECD Q
"RTN","ECXNURS",52,0)
 ..I (ECD-ECDPREV)>1,+TM(ECD)=+TM(ECDPREV) D
"RTN","ECXNURS",53,0)
 ...F ECDNEW=ECDPREV+1:1:ECD-1 S ^TMP("ECX",$J,DFN,ECDNEW)=^TMP("ECX",$J,DFN,ECDPREV) D
"RTN","ECXNURS",54,0)
 ....S NEWWARD="",OLDWARD=$P(^TMP("ECX",$J,DFN,ECDPREV),U,10)
"RTN","ECXNURS",55,0)
 ....D NEWWARD(OLDWARD,.NEWWARD)
"RTN","ECXNURS",56,0)
 ....Q:'NEWWARD
"RTN","ECXNURS",57,0)
 ....S $P(^TMP("ECX",$J,DFN,ECDNEW),U,4)=$P(NEWWARD,U,1)
"RTN","ECXNURS",58,0)
 ....S $P(^TMP("ECX",$J,DFN,ECDNEW),U,5)=$P(NEWWARD,U,2)
"RTN","ECXNURS",59,0)
 ..S ECDPREV=ECD
"RTN","ECXNURS",60,0)
 .;fill-in to end of extract date range
"RTN","ECXNURS",61,0)
 .K TM S ECD=0
"RTN","ECXNURS",62,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD   D
"RTN","ECXNURS",63,0)
 ..S TM(ECD)=$P(^TMP("ECX",$J,DFN,ECD),U,11)
"RTN","ECXNURS",64,0)
 .S ECD=$O(TM(""),-1),DCDT=+TM(ECD)
"RTN","ECXNURS",65,0)
 .;if last day in date range is after last classificatin date
"RTN","ECXNURS",66,0)
 .I LASTDAY>ECD D
"RTN","ECXNURS",67,0)
 ..;if there is no d/c date
"RTN","ECXNURS",68,0)
 ..I DCDT=0 F ECDNEW=ECD+1:1:LASTDAY D  Q
"RTN","ECXNURS",69,0)
 ...I '$D(^TMP("ECX",$J,DFN,ECDNEW)) S ^TMP("ECX",$J,DFN,ECDNEW)=^TMP("ECX",$J,DFN,ECD)
"RTN","ECXNURS",70,0)
 ...S NEWWARD="",OLDWARD=$P(^TMP("ECX",$J,DFN,ECD),U,10)
"RTN","ECXNURS",71,0)
 ...D NEWWARD(OLDWARD,.NEWWARD)
"RTN","ECXNURS",72,0)
 ...Q:'NEWWARD
"RTN","ECXNURS",73,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,4)=$P(NEWWARD,U,1)
"RTN","ECXNURS",74,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,5)=$P(NEWWARD,U,2)
"RTN","ECXNURS",75,0)
 ..;if d/c date is after last classification date
"RTN","ECXNURS",76,0)
 ..I $P(DCDT,".")>ECD S NEWDT=$S($P(DCDT,".")>LASTDAY:LASTDAY,1:($P(DCDT,".")-1)) F ECDNEW=ECD+1:1:NEWDT D  Q
"RTN","ECXNURS",77,0)
 ...I '$D(^TMP("ECX",$J,DFN,ECDNEW)) S ^TMP("ECX",$J,DFN,ECDNEW)=^TMP("ECX",$J,DFN,ECD)
"RTN","ECXNURS",78,0)
 ...S NEWWARD="",OLDWARD=$P(^TMP("ECX",$J,DFN,ECD),U,10)
"RTN","ECXNURS",79,0)
 ...D NEWWARD(OLDWARD,.NEWWARD)
"RTN","ECXNURS",80,0)
 ...Q:'NEWWARD
"RTN","ECXNURS",81,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,4)=$P(NEWWARD,U,1)
"RTN","ECXNURS",82,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,5)=$P(NEWWARD,U,2)
"RTN","ECXNURS",83,0)
 Q
"RTN","ECXNURS",84,0)
 ;
"RTN","ECXNURS",85,0)
NEWWARD(OLDWARD,NEWWARD) ;get new nursing location
"RTN","ECXNURS",86,0)
 ; input  OLDWARD = pointer to file #42, previous mas ward
"RTN","ECXNURS",87,0)
 ;        NEWWARD = null
"RTN","ECXNURS",88,0)
 ; output NEWWARD = new nursing location^new nursing bedsection
"RTN","ECXNURS",89,0)
 ;                  OR "^", if new ward same as previous ward or could not be resolved
"RTN","ECXNURS",90,0)
 ;if the new ward is mapped to multiple nursing locations, get the first active location
"RTN","ECXNURS",91,0)
 N NEWW,NEWLOC,NEWSEC,OUT,DA,DR,DIC,DIQ,LOC
"RTN","ECXNURS",92,0)
 S INP=$$INP^ECXUTL2(DFN,ECDNEW) S NEWWARD=$P(INP,U,5)
"RTN","ECXNURS",93,0)
 I NEWWARD=OLDWARD S NEWWARD=""
"RTN","ECXNURS",94,0)
 Q:'NEWWARD
"RTN","ECXNURS",95,0)
 S NEWW="",NEWLOC="",NEWSEC="",OUT=0
"RTN","ECXNURS",96,0)
 F  S NEWW=$O(^NURSF(211.4,"C",NEWWARD,NEWW)) Q:OUT  Q:+NEWW<1  D
"RTN","ECXNURS",97,0)
 .S DIC=211.4,DIQ(0)="I",DIQ="LOC",DA=NEWW,DR="1;1.5"
"RTN","ECXNURS",98,0)
 .D EN^DIQ1 K DIQ,DIC,DA,DR
"RTN","ECXNURS",99,0)
 .Q:LOC(211.4,NEWW,1,"I")="I"
"RTN","ECXNURS",100,0)
 .Q:LOC(211.4,NEWW,1.5,"I")="I"
"RTN","ECXNURS",101,0)
 .S JJ=$O(^NURSF(211.4,"C",NEWWARD,NEWW,""))
"RTN","ECXNURS",102,0)
 .S DIC=211.4,DIQ(0)="I",DIQ="LOC",DA=NEWW,DA(211.41)=JJ,DR="2",DR(211.41)=".01;1"
"RTN","ECXNURS",103,0)
 .D EN^DIQ1 K DIQ,DIC,DA,DR
"RTN","ECXNURS",104,0)
 .Q:NEWWARD'=LOC(211.41,JJ,.01,"I")
"RTN","ECXNURS",105,0)
 .S NEWLOC=NEWW,NEWSEC=LOC(211.41,JJ,1,"I"),OUT=1
"RTN","ECXNURS",106,0)
 I (NEWLOC="")!(NEWSEC="") S NEWWARD="" Q
"RTN","ECXNURS",107,0)
 S NEWWARD=NEWLOC_U_NEWSEC
"RTN","ECXNURS",108,0)
 Q
"RTN","ECXNURS",109,0)
 ;
"RTN","ECXNURS",110,0)
FILE ;file extract records
"RTN","ECXNURS",111,0)
 ;node0
"RTN","ECXNURS",112,0)
 ;inst^dfn^ssn^name^in/out^date^acuity level(category)^entered by^classifier^nurs location^nursing bed section^mov #^treat spec^adm date^adm time
"RTN","ECXNURS",113,0)
 ;node1
"RTN","ECXNURS",114,0)
 ;mpi^dss dept
"RTN","ECXNURS",115,0)
 N DA,DIK
"RTN","ECXNURS",116,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1)
"RTN","ECXNURS",117,0)
 S DFN=0,QFLG=0
"RTN","ECXNURS",118,0)
 F  S DFN=$O(^TMP("ECX",$J,DFN)) Q:'DFN  I $D(^DPT(DFN,0)) D  Q:QFLG
"RTN","ECXNURS",119,0)
 .S ECD=0
"RTN","ECXNURS",120,0)
 .S ECPN=^DPT(DFN,0),ECPT=$P(ECPN,U,9)_U_$E($P($P(ECPN,U),",")_"    ",1,4)_U_"3"
"RTN","ECXNURS",121,0)
 .;file patient's classification data
"RTN","ECXNURS",122,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD   D
"RTN","ECXNURS",123,0)
 ..S ECC=$P(^TMP("ECX",$J,DFN,ECD),U,1,5),ECMN=$P(^(ECD),U,7),ECTS=$P(^(ECD),U,8),ECA=$P(^(ECD),U,9)
"RTN","ECXNURS",124,0)
 ..S EC7=EC7+1
"RTN","ECXNURS",125,0)
 ..S ECODE=EC7_U_EC23
"RTN","ECXNURS",126,0)
 ..S ECODE=ECODE_U_ECINST_U_DFN_U_ECPT_U_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_ECC
"RTN","ECXNURS",127,0)
 ..S ECODE=ECODE_U_ECMN_U_ECTS_U_$$ECXDATE^ECXUTL(ECA,ECXYM)_U_$$ECXTIME^ECXUTL(ECA)
"RTN","ECXNURS",128,0)
 ..S ECODE1=U
"RTN","ECXNURS",129,0)
 ..S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXNURS",130,0)
 ..S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXNURS",131,0)
 ..I $D(ZTQUEUED),ECRN>499,'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXNURS",132,0)
 Q
"RTN","ECXNURS",133,0)
 ;
"RTN","ECXNURS",134,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXNURS",135,0)
 S ECHEAD="NUR"
"RTN","ECXNURS",136,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXNURS",137,0)
 Q
"RTN","ECXNURS",138,0)
 ;
"RTN","ECXNURS",139,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXNURS",140,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXPUTL")
0^6^B27365320
"RTN","ECXPUTL",1,0)
ECXPUTL ;ALB/GTS - Utilities for DSS Prosthetics Extract ;July 15, 1998
"RTN","ECXPUTL",2,0)
 ;;3.0;DSS EXTRACTS;**9,14**;Dec 22, 1997
"RTN","ECXPUTL",3,0)
 ;
"RTN","ECXPUTL",4,0)
PDIV() ; Prompt the user for a division and return its IEN
"RTN","ECXPUTL",5,0)
 ;
"RTN","ECXPUTL",6,0)
 ; Output:
"RTN","ECXPUTL",7,0)
 ;  ECXDIV
"RTN","ECXPUTL",8,0)
 ;     Successful  - Institution file IEN for the selected division
"RTN","ECXPUTL",9,0)
 ;   Unsuccessful  - 0
"RTN","ECXPUTL",10,0)
 ;
"RTN","ECXPUTL",11,0)
 N ECXDIV,ECTMP,ECDIVCT,ECDIVSXS,ECDIVLP
"RTN","ECXPUTL",12,0)
 S ECXDIV=0
"RTN","ECXPUTL",13,0)
 S ECDIVSXS=$$DIV4^XUSER(.ECTMP,DUZ) ;**Set up array of user divisions
"RTN","ECXPUTL",14,0)
 ;
"RTN","ECXPUTL",15,0)
 ;** If the user doesn't have divisions setup
"RTN","ECXPUTL",16,0)
 I 'ECDIVSXS DO
"RTN","ECXPUTL",17,0)
 .S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",18,0)
 .S DIR("A",1)="You do not have any divisions defined in your user set up."
"RTN","ECXPUTL",19,0)
 .S DIR("A",2)="Contact an ADPAC or IRM for assistance."
"RTN","ECXPUTL",20,0)
 .S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",21,0)
 .D ^DIR K DIR,X,Y
"RTN","ECXPUTL",22,0)
 ;
"RTN","ECXPUTL",23,0)
 ;** If the user does have divisions setup
"RTN","ECXPUTL",24,0)
 I ECDIVSXS DO
"RTN","ECXPUTL",25,0)
 .S (ECDIVCT,ECDIVLP)=0
"RTN","ECXPUTL",26,0)
 .F  S ECDIVLP=$O(ECTMP(ECDIVLP)) Q:(+ECDIVLP=0)  DO
"RTN","ECXPUTL",27,0)
 ..I $D(^RMPR(669.9,"C",ECDIVLP)) S ECDIVCT=ECDIVCT+1
"RTN","ECXPUTL",28,0)
 ..I '$D(^RMPR(669.9,"C",ECDIVLP)) K ECTMP(ECDIVLP)
"RTN","ECXPUTL",29,0)
 .I 'ECDIVCT DO
"RTN","ECXPUTL",30,0)
 ..S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",31,0)
 ..S DIR("A",1)="Your division is not set up as a prosthetic division."
"RTN","ECXPUTL",32,0)
 ..S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",33,0)
 ..D ^DIR K DIR,X,Y
"RTN","ECXPUTL",34,0)
 .I ECDIVCT=1 DO
"RTN","ECXPUTL",35,0)
 ..S ECXDIV=$O(ECTMP(""))
"RTN","ECXPUTL",36,0)
 ..K ECXDIC S DA=ECXDIV,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPUTL",37,0)
 ..D EN^DIQ1 S ECXSNUM=$G(ECXDIC(4,DA,99,"I"))
"RTN","ECXPUTL",38,0)
 ..S ECXSNAME=$G(ECXDIC(4,DA,.01,"I"))
"RTN","ECXPUTL",39,0)
 ..K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPUTL",40,0)
 ..I $L(ECXSNUM)>3 DO
"RTN","ECXPUTL",41,0)
 ...K ECTMP(ECXDIV)
"RTN","ECXPUTL",42,0)
 ...S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",43,0)
 ...S DIR("A",1)="Your division ("_ECXSNUM_") is not a prosthetic primary division."
"RTN","ECXPUTL",44,0)
 ...S DIR("A",2)="Note that the Station Number ("_ECXSNUM_") is longer than 3 characters"
"RTN","ECXPUTL",45,0)
 ...S DIR("A",3)=" for the Station "_ECXSNAME_"."
"RTN","ECXPUTL",46,0)
 ...S DIR("A",4)="Check with IRM to identify the primary division and add it to your New Person"
"RTN","ECXPUTL",47,0)
 ...S DIR("A",5)=" file entry."
"RTN","ECXPUTL",48,0)
 ...S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",49,0)
 ...D ^DIR K DIR,X,Y
"RTN","ECXPUTL",50,0)
 ...S ECXDIV=0
"RTN","ECXPUTL",51,0)
 ..K ECXSNUM,ECXSNAME
"RTN","ECXPUTL",52,0)
 .I ECDIVCT>1 DO
"RTN","ECXPUTL",53,0)
 ..S DIC("A")="Select Prosthetic Division: ",DIC(0)="AEQM",DIC="^DIC(4,"
"RTN","ECXPUTL",54,0)
 ..S DIC("S")="I $D(ECTMP(+Y))&(+$L($P($G(^DIC(4,+Y,99)),""^"",1))=3)" D ^DIC
"RTN","ECXPUTL",55,0)
 ..I '$D(DTOUT),'$D(DUOUT),Y>0 S ECXDIV=+Y
"RTN","ECXPUTL",56,0)
 ..I $D(DTOUT)!($D(DUOUT))!(Y<1) DO
"RTN","ECXPUTL",57,0)
 ...S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",58,0)
 ...S DIR("A",1)="You did not select a prosthetic division."
"RTN","ECXPUTL",59,0)
 ...S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",60,0)
 ...D ^DIR K DIR,X,Y
"RTN","ECXPUTL",61,0)
 ...S ECXDIV=0
"RTN","ECXPUTL",62,0)
 Q ECXDIV
"RTN","ECXPUTL",63,0)
 ;
"RTN","ECXPUTL",64,0)
PDIV2(DUZ) ; prompt user for any prosthetics division
"RTN","ECXPUTL",65,0)
 ; input
"RTN","ECXPUTL",66,0)
 ;  DUZ - ien in file #200
"RTN","ECXPUTL",67,0)
 ; Output:
"RTN","ECXPUTL",68,0)
 ;  ECXDIV
"RTN","ECXPUTL",69,0)
 ;     successful  - ien file #4^station number^station name
"RTN","ECXPUTL",70,0)
 ;   unsuccessful  - 0
"RTN","ECXPUTL",71,0)
 ;
"RTN","ECXPUTL",72,0)
 N ECXDIV,ECTMP,ECDIVCT,ECDIVSXS,ECDIVLP
"RTN","ECXPUTL",73,0)
 S ECXDIV=0
"RTN","ECXPUTL",74,0)
 S ECDIVSXS=$$DIV4^XUSER(.ECTMP,DUZ) ;**Set up array of user divisions
"RTN","ECXPUTL",75,0)
 ;If the user doesn't have divisions setup
"RTN","ECXPUTL",76,0)
 I 'ECDIVSXS D
"RTN","ECXPUTL",77,0)
 .S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",78,0)
 .S DIR("A",1)="You do not have any divisions defined in your user set up."
"RTN","ECXPUTL",79,0)
 .S DIR("A",2)="Contact an ADPAC or IRM for assistance."
"RTN","ECXPUTL",80,0)
 .S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",81,0)
 .D ^DIR K DIR,X,Y
"RTN","ECXPUTL",82,0)
 ;If the user does have divisions setup
"RTN","ECXPUTL",83,0)
 I ECDIVSXS D
"RTN","ECXPUTL",84,0)
 .S (ECDIVCT,ECDIVLP)=0
"RTN","ECXPUTL",85,0)
 .F  S ECDIVLP=$O(ECTMP(ECDIVLP)) Q:(+ECDIVLP=0)  D
"RTN","ECXPUTL",86,0)
 ..I $D(^RMPR(669.9,"C",ECDIVLP)) S ECDIVCT=ECDIVCT+1
"RTN","ECXPUTL",87,0)
 ..I '$D(^RMPR(669.9,"C",ECDIVLP)) K ECTMP(ECDIVLP)
"RTN","ECXPUTL",88,0)
 .I 'ECDIVCT D
"RTN","ECXPUTL",89,0)
 ..S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",90,0)
 ..S DIR("A",1)="Your division is not set up as a prosthetic division."
"RTN","ECXPUTL",91,0)
 ..S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",92,0)
 ..D ^DIR K DIR,X,Y
"RTN","ECXPUTL",93,0)
 .I ECDIVCT=1 D
"RTN","ECXPUTL",94,0)
 ..S ECXDIV=$O(ECTMP(""))
"RTN","ECXPUTL",95,0)
 ..K ECXDIC S DA=ECXDIV,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPUTL",96,0)
 ..D EN^DIQ1
"RTN","ECXPUTL",97,0)
 ..S ECXDIV=ECXDIV_U_$G(ECXDIC(4,DA,99,"I"))_U_$G(ECXDIC(4,DA,.01,"I"))
"RTN","ECXPUTL",98,0)
 ..K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPUTL",99,0)
 .I ECDIVCT>1 D
"RTN","ECXPUTL",100,0)
 ..S DIC("A")="Select Prosthetic Division: ",DIC(0)="AEQM",DIC="^DIC(4,"
"RTN","ECXPUTL",101,0)
 ..S DIC("S")="I $D(ECTMP(+Y))" D ^DIC
"RTN","ECXPUTL",102,0)
 ..I $D(DTOUT)!($D(DUOUT))!(Y<1) D  Q
"RTN","ECXPUTL",103,0)
 ...S DIR(0)="FAO^1:1"
"RTN","ECXPUTL",104,0)
 ...S DIR("A",1)="You did not select a prosthetic division."
"RTN","ECXPUTL",105,0)
 ...S DIR("A")="Hit Return to continue."
"RTN","ECXPUTL",106,0)
 ...D ^DIR K DIR,X,Y
"RTN","ECXPUTL",107,0)
 ...S ECXDIV=0
"RTN","ECXPUTL",108,0)
 ..I '$D(DTOUT),'$D(DUOUT),Y>0 S ECXDIV=+Y D  Q
"RTN","ECXPUTL",109,0)
 ...K ECXDIC S DA=ECXDIV,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPUTL",110,0)
 ...D EN^DIQ1
"RTN","ECXPUTL",111,0)
 ...S ECXDIV=ECXDIV_U_$G(ECXDIC(4,DA,99,"I"))_U_$G(ECXDIC(4,DA,.01,"I"))
"RTN","ECXPUTL",112,0)
 ...K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPUTL",113,0)
 Q ECXDIV
"RTN","ECXPUTL",114,0)
 ;
"RTN","ECXPUTL",115,0)
PDIV3(DUZ,PRIME,DIV) ; user divisions in primary prosthetics division
"RTN","ECXPUTL",116,0)
 ; input
"RTN","ECXPUTL",117,0)
 ;  DUZ   - ien in file #200 (required)
"RTN","ECXPUTL",118,0)
 ;  PRIME - primary division - ien file #4^station number^station name (required)
"RTN","ECXPUTL",119,0)
 ;  DIV   - array passed by reference (required)
"RTN","ECXPUTL",120,0)
 ; Output:
"RTN","ECXPUTL",121,0)
 ;  DIV   - array of 1 or more divisions associated with primary division
"RTN","ECXPUTL",122,0)
 ;     successful  - ien file #4^station number^station name
"RTN","ECXPUTL",123,0)
 ;   unsuccessful  - 0
"RTN","ECXPUTL",124,0)
 ;
"RTN","ECXPUTL",125,0)
 N ECXDIV,ECTMP,ECDIVCT,ECDIVSXS,ECDIVLP
"RTN","ECXPUTL",126,0)
 S DIV(1)=0
"RTN","ECXPUTL",127,0)
 S ECDIVSXS=$$DIV4^XUSER(.ECTMP,DUZ) ;**Set up array of user divisions
"RTN","ECXPUTL",128,0)
 ;if the user doesn't have divisions setup
"RTN","ECXPUTL",129,0)
 I 'ECDIVSXS Q
"RTN","ECXPUTL",130,0)
 ;if the user does have divisions setup
"RTN","ECXPUTL",131,0)
 I ECDIVSXS D
"RTN","ECXPUTL",132,0)
 .S (ECDIVCT,ECDIVLP)=0
"RTN","ECXPUTL",133,0)
 .F  S ECDIVLP=$O(ECTMP(ECDIVLP)) Q:(+ECDIVLP=0)  D
"RTN","ECXPUTL",134,0)
 ..I '$D(^RMPR(669.9,"C",ECDIVLP)) K ECTMP(ECDIVLP)
"RTN","ECXPUTL",135,0)
 ..I $D(^RMPR(669.9,"C",ECDIVLP)) D
"RTN","ECXPUTL",136,0)
 ...S DA=ECDIVLP,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99" D EN^DIQ1
"RTN","ECXPUTL",137,0)
 ...;does this division belong to primary division?
"RTN","ECXPUTL",138,0)
 ...I $E($G(ECXDIC(4,DA,99,"I")),1,3)'=$P(PRIME,U,2) K ECTMP(ECDIVLP) Q
"RTN","ECXPUTL",139,0)
 ...S ECDIVCT=ECDIVCT+1
"RTN","ECXPUTL",140,0)
 ...S DIV(ECDIVCT)=ECDIVLP_U_$G(ECXDIC(4,DA,99,"I"))_U_$G(ECXDIC(4,DA,.01,"I"))
"RTN","ECXPUTL",141,0)
 K DIC,DIQ,DA,DR,ECXDIC,X,Y
"RTN","ECXPUTL",142,0)
 Q
"RTN","ECXSCX")
0^7^B68317650
"RTN","ECXSCX",1,0)
ECXSCX ;ALB/JAP,BIR/DMA,CML,PTD-Clinic Extract ; 02/06/97 10:24 [ 03/26/97  2:10 PM ]
"RTN","ECXSCX",2,0)
 ;;3.0;DSS EXTRACTS;**1,3,11,8,13,14**;Dec 22, 1997
"RTN","ECXSCX",3,0)
BEG ;entry point from option
"RTN","ECXSCX",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXSCX",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXSCX",6,0)
 Q
"RTN","ECXSCX",7,0)
 ;
"RTN","ECXSCX",8,0)
START ;entry point
"RTN","ECXSCX",9,0)
 N QFLG,TIU
"RTN","ECXSCX",10,0)
 ;get ien for tiu in file #839.7
"RTN","ECXSCX",11,0)
 S DIC="^PX(839.7,",DIC(0)="X",X="TEXT INTEGRATION UTILITIES" D ^DIC S TIU=0 S:+Y>0 TIU=+Y K DIC,Y
"RTN","ECXSCX",12,0)
 K ^TMP("ECXS",$J) S ECXMISS=10,ECED=ECED+.3 S SC=0,QFLG=0
"RTN","ECXSCX",13,0)
 ;scheduled appts. and appended ekgs: loop through the file (#44)
"RTN","ECXSCX",14,0)
 F  S SC=$O(^SC(SC)) Q:('SC)!(QFLG)  I $D(^(SC,0)) S EC=^(0) I $P(EC,U,3)="C" S ECSU=$P(EC,U,15) S:'ECSU ECSU=1 D FEEDER^ECXSCX1(SC,ECSD1,.P1,.P2,.P3,.ECST) I ECST'=6 S ECD=ECSD1 D  Q:QFLG
"RTN","ECXSCX",15,0)
 .F  S ECD=$O(^SC(SC,"S",ECD)) Q:'ECD  Q:ECD>ECED  Q:QFLG  S ECDA=0 F  S ECDA=$O(^SC(SC,"S",ECD,1,ECDA)) Q:'ECDA  I $D(^(ECDA,0)) D  Q:QFLG
"RTN","ECXSCX",16,0)
 ..;for each patient appointment in the date range (skip cancellations), examine the APPOINTMENT multiple in the PATIENT file (#2)
"RTN","ECXSCX",17,0)
 ..I $S('$D(^SC(SC,"S",ECD,1,ECDA,"C")):1,1:$P(^("C"),U,3)]"") S PTADT=^(0),DFN=$P(PTADT,U) I $D(^DPT(+DFN,0)),$P(PTADT,U,9)="",$P($G(^DPT(DFN,"S",ECD,0)),U,2)'["C" D
"RTN","ECXSCX",18,0)
 ...D PAT,AOIRPOW^ECXUTL(DFN,.ECXAIP)
"RTN","ECXSCX",19,0)
 ...S ECL=$P(PTADT,U,2),ECL=$$RJ^XLFSTR(ECL,3,0),ECOB=$G(^SC(SC,"S",ECD,1,ECDA,"OB"))]""
"RTN","ECXSCX",20,0)
 ...;don't continue with record creation if the clinic appointment can't be found in subfile 2.98
"RTN","ECXSCX",21,0)
 ...Q:'$D(^DPT(DFN,"S",ECD,0))  Q:$P(^DPT(DFN,"S",ECD,0),U)'=SC
"RTN","ECXSCX",22,0)
 ...K EC2 S EC2=^DPT(DFN,"S",ECD,0) S ECN=$S($P(EC2,U,2)="N":"N",$P(EC2,U,2)="NA":"N",$P(EC2,U,2)="NT":"Q",1:"0")
"RTN","ECXSCX",23,0)
 ...S ECIEN=$P(EC2,U,20),ECEKG=$P(EC2,U,5)
"RTN","ECXSCX",24,0)
 ...I ECST'=3 S ECFD=P1_P2_ECL_P3_ECN,ECO1=ECO1_U_ECFD_U_ECOB_U_SC D API,FILE
"RTN","ECXSCX",25,0)
 ...I ECST=3 S ECFD=P1_"000"_ECL_P3_ECN,ECO1=ECO1_U_ECFD_U_ECOB_U_SC D API,FILE
"RTN","ECXSCX",26,0)
 ...I ECST=3 S ECFD=P2_"000"_ECL_P3_ECN,ECO1=ECO1_U_ECFD_U_ECOB_U_SC D API,FILE
"RTN","ECXSCX",27,0)
 ...;check for appended visits for EKG (107); if regular appt. is a no-show, append is a no-show
"RTN","ECXSCX",28,0)
 ...Q:'ECEKG  D
"RTN","ECXSCX",29,0)
 ....S $P(ECODE,U,10,12)="1070000280000"_ECN_U_U
"RTN","ECXSCX",30,0)
 ....S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXSCX",31,0)
 ....S $P(ECODE,U,1)=EC7
"RTN","ECXSCX",32,0)
 ....D FILE2
"RTN","ECXSCX",33,0)
 ;Dispositions, stand-alones, and appended lab and x-ray: loop through the file (#409.68) for date range
"RTN","ECXSCX",34,0)
 S ECD=ECSD1
"RTN","ECXSCX",35,0)
 F  S ECD=$O(^SCE("B",ECD)) Q:'ECD!(ECD>ECED)  S ECIEN=0 D  Q:QFLG
"RTN","ECXSCX",36,0)
 .F  S ECIEN=$O(^SCE("B",ECD,ECIEN)) Q:'ECIEN  D  Q:QFLG
"RTN","ECXSCX",37,0)
 ..;quit if no outpatient encounter zero node
"RTN","ECXSCX",38,0)
 ..Q:'$D(^SCE(ECIEN,0))
"RTN","ECXSCX",39,0)
 ..;fd=1>x-ray or lab record, fd=2>disposition, fd=0>stand-alone visit
"RTN","ECXSCX",40,0)
 ..S FD=0,NCNTR=^SCE(ECIEN,0),STOP=$P($G(^DIC(40.7,+$P(NCNTR,U,3),0)),U,2)
"RTN","ECXSCX",41,0)
 ..S ENELG=$P($G(^DIC(8,+$P(NCNTR,U,13),0)),U,9) I ENELG S ENELG=$C(ENELG+64)
"RTN","ECXSCX",42,0)
 ..;quit if no clinic stop code for encounter
"RTN","ECXSCX",43,0)
 ..Q:'STOP
"RTN","ECXSCX",44,0)
 ..;clinic stop code equals 105 (x-ray) or 108 (lab)
"RTN","ECXSCX",45,0)
 ..I (STOP=105)!(STOP=108) S FD=1 D BLD Q
"RTN","ECXSCX",46,0)
 ..;quit if encounter not stop code addition or disposition
"RTN","ECXSCX",47,0)
 ..I ($P(NCNTR,U,8)'=2),($P(NCNTR,U,8)'=3) Q
"RTN","ECXSCX",48,0)
 ..;originating process type equals disposition
"RTN","ECXSCX",49,0)
 ..I $P(NCNTR,U,8)=3 S FD=2 D BLD Q
"RTN","ECXSCX",50,0)
 ..;else originating process type equals stop code addition (stand-alone)
"RTN","ECXSCX",51,0)
 ..;quit if there is a parent encounter pointer.
"RTN","ECXSCX",52,0)
 ..Q:$P($G(NCNTR),U,6)
"RTN","ECXSCX",53,0)
 ..D BLD
"RTN","ECXSCX",54,0)
 ;send missing clinic msg if needed
"RTN","ECXSCX",55,0)
 D:$D(^TMP("ECXS",$J)) EN^ECXSCX1
"RTN","ECXSCX",56,0)
 K EC,EC1,EC2,ECA,ECCPT,ECCSC,ECD,ECDA,ECEKG,ECFD,ECICD,ECIEN,ECL,ECMN,ECN,ECO1,ECO2,ECOB,ECODE,ECPROV,ECPTPR,ECPTTM,ECREC,ECSC,ECST,ECSU,ECTS,ECVAL,ECVIS
"RTN","ECXSCX",57,0)
 K C,CPT,DFN,ELIG,P1,P11,P2,P3,PTADT,SC,VAERR,VAIP,SEX,ADDR,STATE,CNTY,ENELG,PAYOR,SAI,ENR,MST,MSTEI
"RTN","ECXSCX",58,0)
 Q
"RTN","ECXSCX",59,0)
 ;
"RTN","ECXSCX",60,0)
BLD ;build record from outpatient encounter
"RTN","ECXSCX",61,0)
 S DFN=+$P(NCNTR,U,2),LOC=$P(NCNTR,U,4),ECSU=1 S:LOC ECSU=$P(^SC(LOC,0),U,15)
"RTN","ECXSCX",62,0)
 Q:'$D(^DPT(DFN,0))
"RTN","ECXSCX",63,0)
 D PAT,AOIRPOW^ECXUTL(DFN,.ECXAIP)
"RTN","ECXSCX",64,0)
 S P1=$$RJ^XLFSTR(STOP,3,0),P2="000",P3="0000",ECST=1
"RTN","ECXSCX",65,0)
 ;for x-ray and lab
"RTN","ECXSCX",66,0)
 I FD=1 S ECO1=ECO1_U_P1_P2_"02800000"_U_U D API,FILE Q
"RTN","ECXSCX",67,0)
 ;for dispositions
"RTN","ECXSCX",68,0)
 I FD=2 S ECO1=ECO1_U_P1_"47906000000"_U_U D API,FILE Q
"RTN","ECXSCX",69,0)
 ;for stand-alone visits
"RTN","ECXSCX",70,0)
 I FD=0,LOC,$D(^SC(LOC,0)) D
"RTN","ECXSCX",71,0)
 .S SC=LOC,APTLEN=29
"RTN","ECXSCX",72,0)
 .D FEEDER^ECXSCX1(SC,ECD,.P1,.P2,.P3,.ECST)
"RTN","ECXSCX",73,0)
 .I ECST'=6 D
"RTN","ECXSCX",74,0)
 ..D API
"RTN","ECXSCX",75,0)
 ..I $D(^TMP("PXKENC",$J,ECVIS,"VST",ECVIS,812)) D
"RTN","ECXSCX",76,0)
 ...S ECXSRCE=$P(^TMP("PXKENC",$J,ECVIS,"VST",ECVIS,812),U,3)
"RTN","ECXSCX",77,0)
 ...I ECXSRCE=TIU S APTLEN=+$P($G(^SC(SC,"SL")),U,1) S:APTLEN=0 APTLEN=29
"RTN","ECXSCX",78,0)
 ..S APTLEN=$TR($J(APTLEN,3)," ","0")
"RTN","ECXSCX",79,0)
 ..S ECO1=ECO1_U_P1_P2_APTLEN_P3_"0"_U_U_SC
"RTN","ECXSCX",80,0)
 ..D FILE
"RTN","ECXSCX",81,0)
 Q
"RTN","ECXSCX",82,0)
 ;
"RTN","ECXSCX",83,0)
FILE ;finish record setup
"RTN","ECXSCX",84,0)
 ;node0
"RTN","ECXSCX",85,0)
 ;facility^dfn^ssn^name^in/out status^day^feeder key^overbook^sc^mov #^treat spec^time^primary care team^
"RTN","ECXSCX",86,0)
 ;primary care provider^provider^CPT code^ICD-9 code^dob^eligibility^vet^race^
"RTN","ECXSCX",87,0)
 ;ao status^ao visit^ir status^ir visit^pow status^pow location^provider person class
"RTN","ECXSCX",88,0)
 ;node1
"RTN","ECXSCX",89,0)
 ;mpi^dss dept^sex^zip+4^pc provider npi^provider npi^encounter elig^mst status^mst indicator
"RTN","ECXSCX",90,0)
 ;cpt2^cpt3^cpt4^cpt5^cpt6^cpt7^cpt8^cpt9^cpt10^cpt11^sharing payor^sharing insurance^enr location^state^county^pc prov person class
"RTN","ECXSCX",91,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXSCX",92,0)
 S ECODE=EC7_U_EC23
"RTN","ECXSCX",93,0)
 S ECODE=ECODE_U_ECO1
"RTN","ECXSCX",94,0)
 S $P(ECODE,U,8)=ECA,ECODE=ECODE_U_ECMN_U_ECTS_U_$$ECXTIME^ECXUTL(ECD)_U_ECPTTM_U_ECPTPR_U_ECPROV_U_ECCPT_U_ECICD
"RTN","ECXSCX",95,0)
 S ECODE=ECODE_U_$$ECXDOB^ECXUTL(DOB)_U_ELIG_U_VET_U_RACE
"RTN","ECXSCX",96,0)
 S ECODE=ECODE_U_ECXAIP("AO")_U_ECVAO_U_ECXAIP("IR")_U_ECVIR_U_ECXAIP("POW")_U_ECXAIP("POWL")_U_ECXPRPC
"RTN","ECXSCX",97,0)
 S CPT="" F C=2:1:11 S CPT=CPT_CPT(C) I C<11 S CPT=CPT_U
"RTN","ECXSCX",98,0)
 S ECODE1=U_U_SEX_U_ZIP_U_U_U_ENELG_U_MST_U_MSTEI_U_CPT_U_PAYOR_U_SAI_U_ENR_U_STATE_U_CNTY_U_ECCLAS
"RTN","ECXSCX",99,0)
 D FILE2
"RTN","ECXSCX",100,0)
 Q
"RTN","ECXSCX",101,0)
 ;
"RTN","ECXSCX",102,0)
FILE2 ;file record
"RTN","ECXSCX",103,0)
 N DA,DIK
"RTN","ECXSCX",104,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXSCX",105,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSCX",106,0)
 I $D(ZTQUEUED),ECRN>499,'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSCX",107,0)
 Q
"RTN","ECXSCX",108,0)
 ;
"RTN","ECXSCX",109,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXSCX",110,0)
 S ECHEAD="CLI"
"RTN","ECXSCX",111,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXSCX",112,0)
 Q
"RTN","ECXSCX",113,0)
 ;
"RTN","ECXSCX",114,0)
PAT ;patient file data
"RTN","ECXSCX",115,0)
 N VAPA
"RTN","ECXSCX",116,0)
 S EC1=^DPT(DFN,0)
"RTN","ECXSCX",117,0)
 S ECO1=ECSU_U_DFN_U_$P(EC1,U,9)_U_$E($P($P(EC1,U),",")_"    ",1,4)_U_U_$$ECXDATE^ECXUTL(ECD,ECXYM)
"RTN","ECXSCX",118,0)
 S ELIG=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),U,9) I ELIG S ELIG=$C(ELIG+64)
"RTN","ECXSCX",119,0)
 S SEX=$P(EC1,U,2),DOB=$P(EC1,U,3),VET=$P($G(^DPT(DFN,"VET")),U),RACE=$P($G(^DIC(10,+$P(EC1,U,6),0)),U,2)
"RTN","ECXSCX",120,0)
 D ADD^VADPT
"RTN","ECXSCX",121,0)
 S STATE=VAPA(5),CNTY=VAPA(7),ZIP=$P(VAPA(11),U,2)
"RTN","ECXSCX",122,0)
 S STATE=$P($G(^DIC(5,+STATE,0)),U,3),CNTY=$P($G(^DIC(5,+STATE,1,+CNTY,0)),U,3)
"RTN","ECXSCX",123,0)
 S ENR=$P($G(^DPT(DFN,"ENR")),U,2) I ENR D
"RTN","ECXSCX",124,0)
 .S DIC="^DIC(4,",DA=ENR,DR="99;",DIQ(0)="I",DIQ="ENR"
"RTN","ECXSCX",125,0)
 .D EN^DIQ1 S ENR=ENR(4,ENR,99,"I")
"RTN","ECXSCX",126,0)
 .K DIC,DIQ,DA,DR
"RTN","ECXSCX",127,0)
 S (MST,MSTEI)=""
"RTN","ECXSCX",128,0)
 ;get visn 19 sharing agreement data
"RTN","ECXSCX",129,0)
 D VISN19^ECXUTL2(DFN,.PAYOR,.SAI)
"RTN","ECXSCX",130,0)
 Q
"RTN","ECXSCX",131,0)
API ;call external utilities
"RTN","ECXSCX",132,0)
 ;determine in/out status and primary care
"RTN","ECXSCX",133,0)
 N X,PROV
"RTN","ECXSCX",134,0)
 F C=2:1:11 S CPT(C)=""
"RTN","ECXSCX",135,0)
 S X=$$INP^ECXUTL2(DFN,ECD),ECA=$P(X,U,1),ECMN=$P(X,U,2),ECTS=$P(X,U,3)
"RTN","ECXSCX",136,0)
 S X=$$PRIMARY^ECXUTL2(DFN,ECD),ECPTTM=$P(X,U,1),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3)
"RTN","ECXSCX",137,0)
 ;call pce api for cpt code, diagnosis/provider designated as primary
"RTN","ECXSCX",138,0)
 S ENELG="",ECPROV="",ECXPRPC="",ECCPT=99199,ECICD=799.9,ECVAO="",ECVIR=""
"RTN","ECXSCX",139,0)
 I 'ECIEN Q
"RTN","ECXSCX",140,0)
 I ECIEN D
"RTN","ECXSCX",141,0)
 .S ECVIS=+$P($G(^SCE(ECIEN,0)),U,5)
"RTN","ECXSCX",142,0)
 .S ENELG=+$P($G(^SCE(ECIEN,0)),U,13),ENELG=$P($G(^DIC(8,ENELG,0)),U,9)
"RTN","ECXSCX",143,0)
 .I ENELG S ENELG=$C(ENELG+64)
"RTN","ECXSCX",144,0)
 I 'ECVIS Q
"RTN","ECXSCX",145,0)
 I ECVIS D ENCEVENT^PXAPI(ECVIS)
"RTN","ECXSCX",146,0)
 I $O(^TMP("PXKENC",$J,ECVIS,""))']"" Q
"RTN","ECXSCX",147,0)
 ;get icd9 code; else use 799.9
"RTN","ECXSCX",148,0)
 I $O(^TMP("PXKENC",$J,ECVIS,"POV",0)) D
"RTN","ECXSCX",149,0)
 .S (ECREC,ECVAL)=0
"RTN","ECXSCX",150,0)
 .F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"POV",ECREC)) Q:'ECREC  S:($P(^TMP("PXKENC",$J,ECVIS,"POV",ECREC,0),U,12)="P") ECVAL=+^(0) Q:$P(^TMP("PXKENC",$J,ECVIS,"POV",ECREC,0),U,12)="P"
"RTN","ECXSCX",151,0)
 .I 'ECVAL S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"POV",0)) I ECREC S ECVAL=+^(ECREC,0)
"RTN","ECXSCX",152,0)
 .I ECVAL S ECICD=$P($G(^ICD9(ECVAL,0)),U)
"RTN","ECXSCX",153,0)
 ;get first provider designated as primary; if no primary, then get first physician provider; if no physician, then get first provider; if no "prv" array nodes, use null.
"RTN","ECXSCX",154,0)
 I $O(^TMP("PXKENC",$J,ECVIS,"PRV",0)) D
"RTN","ECXSCX",155,0)
 .S (ECREC,ECVAL)=0
"RTN","ECXSCX",156,0)
 .F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC)) Q:'ECREC  S:($P(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC,0),U,4)="P") ECVAL=+^(0) Q:$P(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC,0),U,4)="P"
"RTN","ECXSCX",157,0)
 .I ECVAL S ECPROV=ECVAL,ECXPRPC=$$PRVCLASS^ECXUTL(ECPROV,ECD)
"RTN","ECXSCX",158,0)
 .I 'ECVAL S ECREC=0 D
"RTN","ECXSCX",159,0)
 ..F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"PRV",ECREC)) Q:'ECREC  D  Q:ECVAL
"RTN","ECXSCX",160,0)
 ...S ECVAL=+^TMP("PXKENC",$J,ECVIS,"PRV",ECREC,0) Q:'ECVAL
"RTN","ECXSCX",161,0)
 ...S ECXPRPC=$$PRVCLASS^ECXUTL(ECVAL,ECD) Q:ECXPRPC=""
"RTN","ECXSCX",162,0)
 ...S NUM=$E(ECXPRPC,2,7) S:(NUM<110000)!(NUM>119999) ECVAL=0,ECXPRPC=""
"RTN","ECXSCX",163,0)
 ...I ECVAL S ECPROV=ECVAL
"RTN","ECXSCX",164,0)
 .I 'ECVAL D
"RTN","ECXSCX",165,0)
 ..S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"PRV",0)) Q:'ECREC  S ECVAL=+^(ECREC,0)
"RTN","ECXSCX",166,0)
 ..I ECVAL S ECPROV=ECVAL,ECXPRPC=$$PRVCLASS^ECXUTL(ECPROV,ECD)
"RTN","ECXSCX",167,0)
 .S:ECPROV]"" ECPROV="2"_ECPROV
"RTN","ECXSCX",168,0)
 ;get cpt code for ien
"RTN","ECXSCX",169,0)
 I $O(^TMP("PXKENC",$J,ECVIS,"CPT",0)) D
"RTN","ECXSCX",170,0)
 .S (ECREC,ECVAL)=0
"RTN","ECXSCX",171,0)
 .;if there's a primary provider, get a cpt associated with that provider
"RTN","ECXSCX",172,0)
 .I ECPROV]"" D
"RTN","ECXSCX",173,0)
 ..S PROV=$E(ECPROV,2,99)
"RTN","ECXSCX",174,0)
 ..F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"CPT",ECREC)) Q:'ECREC  D  Q:ECVAL
"RTN","ECXSCX",175,0)
 ...I $D(^TMP("PXKENC",$J,ECVIS,"CPT",ECREC,12)) S:$P(^(12),U,4)=PROV ECVAL=+^TMP("PXKENC",$J,ECVIS,"CPT",ECREC,0)
"RTN","ECXSCX",176,0)
 ...I ECVAL D
"RTN","ECXSCX",177,0)
 ....S ECCPT=$P($G(^ICPT(ECVAL,0)),U)
"RTN","ECXSCX",178,0)
 ...;get rid of the cpt record
"RTN","ECXSCX",179,0)
 ...K ^TMP("PXKENC",$J,ECVIS,"CPT",ECREC)
"RTN","ECXSCX",180,0)
 .I ECVAL=0 S ECREC=+$O(^TMP("PXKENC",$J,ECVIS,"CPT",0)) I ECREC S ECVAL=+^(ECREC,0)
"RTN","ECXSCX",181,0)
 .I ECVAL D
"RTN","ECXSCX",182,0)
 ..S ECCPT=$P($G(^ICPT(ECVAL,0)),U)
"RTN","ECXSCX",183,0)
 ..;get rid of the cpt record
"RTN","ECXSCX",184,0)
 ..K ^TMP("PXKENC",$J,ECVIS,"CPT",ECREC)
"RTN","ECXSCX",185,0)
 .;get remaining cpt codes
"RTN","ECXSCX",186,0)
 .S ECREC=0,C=2
"RTN","ECXSCX",187,0)
 .F  S ECREC=$O(^TMP("PXKENC",$J,ECVIS,"CPT",ECREC)) Q:'ECREC!(C>11)  D
"RTN","ECXSCX",188,0)
 ..S ECVAL=+^TMP("PXKENC",$J,ECVIS,"CPT",ECREC,0)
"RTN","ECXSCX",189,0)
 ..I ECVAL S CPT(C)=$P($G(^ICPT(ECVAL,0)),U),C=C+1
"RTN","ECXSCX",190,0)
 ;ao and ir
"RTN","ECXSCX",191,0)
 S (ECVAO,ECVIR)=""
"RTN","ECXSCX",192,0)
 I $D(^TMP("PXKENC",$J,ECVIS,"VST",ECVIS,800)) D
"RTN","ECXSCX",193,0)
 .S ECVAO=$P(^(800),U,2),ECVIR=$P(^(800),U,3)
"RTN","ECXSCX",194,0)
 .S:ECVAO="0" ECVAO="N" S:ECVIR=0 ECVIR="N"
"RTN","ECXSCX",195,0)
 .S:ECVAO="1" ECVAO="Y" S:ECVIR=1 ECVIR="Y"
"RTN","ECXSCX",196,0)
 Q
"RTN","ECXSCX",197,0)
 ;
"RTN","ECXSCX",198,0)
QUE ;entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSCX",199,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXTRAC")
0^8^B36874751
"RTN","ECXTRAC",1,0)
ECXTRAC ;ALB/GTS,JAP,BIR/DMA,CML-Package Extracts for DSS ; 11/08/96 15:37
"RTN","ECXTRAC",2,0)
 ;;3.0;DSS EXTRACTS;**9,8,14**;Dec 22, 1997
"RTN","ECXTRAC",3,0)
 ;Date range, queuing and message sending for package extracts
"RTN","ECXTRAC",4,0)
 ;Input ECPACK   printed name of package (e.g. Lab, Prescriptions)
"RTN","ECXTRAC",5,0)
 ;      ECNODE   in file 728 where last date is stored
"RTN","ECXTRAC",6,0)
 ;      ECPIECE  piece of node where last date is stored
"RTN","ECXTRAC",7,0)
 ;      ECRTN    in the form of START^ROUTINE
"RTN","ECXTRAC",8,0)
 ;      ECGRP    name of local mail group to receive summary message
"RTN","ECXTRAC",9,0)
 ;               (MUST BE 1 TO 5 UPPER CASE ALPHA - NO SPACES)
"RTN","ECXTRAC",10,0)
 ;      ECFILE   file number of the local editing file
"RTN","ECXTRAC",11,0)
 ; generates EC23=2nd and 3rd piece of zero node in local editing file
"RTN","ECXTRAC",12,0)
 ;               =YYMM of end date^pointer to 727
"RTN","ECXTRAC",13,0)
 ;
"RTN","ECXTRAC",14,0)
EN ;entry point
"RTN","ECXTRAC",15,0)
 N OUT,CHKFLG
"RTN","ECXTRAC",16,0)
 I '$D(ECNODE) S ECNODE=7
"RTN","ECXTRAC",17,0)
 I '$D(ECHEAD) S ECHEAD=" "
"RTN","ECXTRAC",18,0)
 I $P($G(^ECX(728,1,ECNODE+.1)),U,ECPIECE)]"" D  Q
"RTN","ECXTRAC",19,0)
 .W !!,$C(7),ECPACK," extract is already scheduled to run",!!
"RTN","ECXTRAC",20,0)
 .D PAUSE
"RTN","ECXTRAC",21,0)
 W @IOF,!,"Extract ",ECPACK," Information for DSS",!!
"RTN","ECXTRAC",22,0)
 S:'$D(ECINST) ECINST=+$P(^ECX(728,1,0),U)
"RTN","ECXTRAC",23,0)
 S ECXINST=ECINST
"RTN","ECXTRAC",24,0)
 K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXTRAC",25,0)
 D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXTRAC",26,0)
 ;* get last date for all extracts except prosthetics
"RTN","ECXTRAC",27,0)
 I ECGRP'="PRO" D
"RTN","ECXTRAC",28,0)
 .S ECLDT=$S($D(^ECX(728,1,ECNODE)):$P(^(ECNODE),U,ECPIECE),1:2610624)
"RTN","ECXTRAC",29,0)
 .S:ECLDT="" ECLDT=2610624
"RTN","ECXTRAC",30,0)
 ;* get last date for prosthetics
"RTN","ECXTRAC",31,0)
 I ECGRP="PRO" D
"RTN","ECXTRAC",32,0)
 .N ECXDA1
"RTN","ECXTRAC",33,0)
 .S ECXDA1=$O(^ECX(728,0))
"RTN","ECXTRAC",34,0)
 .I $D(^ECX(728,ECXDA1,1,ECXINST,0)) D
"RTN","ECXTRAC",35,0)
 ..S ECLDT=$P(^ECX(728,ECXDA1,1,ECXINST,0),U,2)
"RTN","ECXTRAC",36,0)
 .I '$D(^ECX(728,ECXDA1,1,ECXINST,0)) D
"RTN","ECXTRAC",37,0)
 ..S DA(1)=ECXDA1
"RTN","ECXTRAC",38,0)
 ..S DIC(0)="L" K ECXDD
"RTN","ECXTRAC",39,0)
 ..D FIELD^DID(728,59,,"SPECIFIER","ECXDD")
"RTN","ECXTRAC",40,0)
 ..S DIC("P")=ECXDD("SPECIFIER") K ECXDD
"RTN","ECXTRAC",41,0)
 ..S DIC="^ECX(728,"_DA(1)_",1,",X=ECXINST,DINUM=X
"RTN","ECXTRAC",42,0)
 ..K DD,DO D FILE^DICN
"RTN","ECXTRAC",43,0)
 ..K DIC,X,DINUM,Y,DA
"RTN","ECXTRAC",44,0)
 ..S ECLDT=2610624
"RTN","ECXTRAC",45,0)
 S OUT=0
"RTN","ECXTRAC",46,0)
 F  S (ECED,ECSD)="" D  Q:OUT
"RTN","ECXTRAC",47,0)
 .K %DT S %DT="AEX",%DT("A")="Starting with Date: " D ^%DT
"RTN","ECXTRAC",48,0)
 .I Y<0 S OUT=1 Q
"RTN","ECXTRAC",49,0)
 .S ECSD=Y
"RTN","ECXTRAC",50,0)
 .K %DT S %DT="AEX",%DT("A")="Ending with Date: " D ^%DT
"RTN","ECXTRAC",51,0)
 .I Y<0 S OUT=1 Q
"RTN","ECXTRAC",52,0)
 .I Y<ECSD D  Q
"RTN","ECXTRAC",53,0)
 ..W !!,"The ending date cannot be earlier than the starting date."
"RTN","ECXTRAC",54,0)
 ..W !,"Please try again.",!!
"RTN","ECXTRAC",55,0)
 .I $E(Y,1,5)'=$E(ECSD,1,5) D  Q
"RTN","ECXTRAC",56,0)
 ..W !!,"Beginning and ending dates must be in the same month and year."
"RTN","ECXTRAC",57,0)
 ..W !,"Please try again.",!!
"RTN","ECXTRAC",58,0)
 .S ECED=Y
"RTN","ECXTRAC",59,0)
 .I ECLDT'<ECSD D  Q
"RTN","ECXTRAC",60,0)
 ..W !!,"The ",ECPACK," information has already been extracted through ",$$FMTE^XLFDT(ECLDT),"."
"RTN","ECXTRAC",61,0)
 ..W !,"Please enter a new date range.",!!
"RTN","ECXTRAC",62,0)
 .S OUT=1
"RTN","ECXTRAC",63,0)
 I ECED]"",ECSD]"" D QUE
"RTN","ECXTRAC",64,0)
 Q
"RTN","ECXTRAC",65,0)
 ;
"RTN","ECXTRAC",66,0)
QUE ;queue extract
"RTN","ECXTRAC",67,0)
 ;if the extract is ivp (i.e., file=727.819), check to see which feeder key format to use
"RTN","ECXTRAC",68,0)
 ;if there is data in the intermediate file (#728.113) for the start date the user selects
"RTN","ECXTRAC",69,0)
 ; or there is data for a date prior to the start date use new format
"RTN","ECXTRAC",70,0)
 N CHKFLG
"RTN","ECXTRAC",71,0)
 I ECFILE=727.819,$O(^ECX(728.113,"A",ECED+1),-1) D  Q:CHKFLG
"RTN","ECXTRAC",72,0)
 .S CHKFLG=0
"RTN","ECXTRAC",73,0)
 .S DATE=$O(^ECX(728.113,"A",ECED+1),-1) D
"RTN","ECXTRAC",74,0)
 ..I DATE<ECSD S CHKFLG=1
"RTN","ECXTRAC",75,0)
 .Q:CHKFLG
"RTN","ECXTRAC",76,0)
 .D CHK^ECXDIVIV Q:CHKFLG
"RTN","ECXTRAC",77,0)
 .D CHK2 Q:CHKFLG
"RTN","ECXTRAC",78,0)
 .S ECRTN="START^ECXPIVDN",ECVER=7
"RTN","ECXTRAC",79,0)
 I '$D(ECNODE) S ECNODE=7
"RTN","ECXTRAC",80,0)
 I '$D(ECHEAD) S ECHEAD=""
"RTN","ECXTRAC",81,0)
 S ECSDN=$$FMTE^XLFDT(ECSD),ECEDN=$$FMTE^XLFDT(ECED),ECSD1=ECSD-.1
"RTN","ECXTRAC",82,0)
 K ZTSAVE
"RTN","ECXTRAC",83,0)
 S (ZTSAVE("ECINST"),ZTSAVE("ECED"),ZTSAVE("ECSD"),ZTSAVE("ECSD1"),ZTSAVE("ECEDN"),ZTSAVE("ECSDN"))=""
"RTN","ECXTRAC",84,0)
 S (ZTSAVE("ECPACK"),ZTSAVE("ECPIECE"),ZTSAVE("ECRTN"),ZTSAVE("ECGRP"),ZTSAVE("ECNODE"),ZTSAVE("ECFILE"),ZTSAVE("ECHEAD"),ZTSAVE("ECVER"))=""
"RTN","ECXTRAC",85,0)
 S (ZTSAVE("ECINST"),ZTSAVE("ECXINST"))=""
"RTN","ECXTRAC",86,0)
 S ZTDESC=ECPACK_" EXTRACT: "_ECSDN_" TO "_ECEDN,ZTRTN="START^ECXTRAC",ZTIO=""
"RTN","ECXTRAC",87,0)
 D ^%ZTLOAD
"RTN","ECXTRAC",88,0)
 I $D(ZTSK) D
"RTN","ECXTRAC",89,0)
 .S $P(^ECX(728,1,ECNODE+.1),U,ECPIECE)="R"
"RTN","ECXTRAC",90,0)
 .W !,"Request queued as Task #",ZTSK,".",!
"RTN","ECXTRAC",91,0)
 .D PAUSE
"RTN","ECXTRAC",92,0)
 Q
"RTN","ECXTRAC",93,0)
 ;
"RTN","ECXTRAC",94,0)
START ; entry when queued
"RTN","ECXTRAC",95,0)
 S QFLG=0
"RTN","ECXTRAC",96,0)
 L +^ECX(727,0) S EC=$P(^ECX(727,0),U,3)+1,$P(^(0),U,3,4)=EC_U_EC L -^ECX(727,0)
"RTN","ECXTRAC",97,0)
 S ^ECX(727,EC,0)=EC_U_DT_U_ECPACK_U_ECSD_U_$E(ECED,1,7)
"RTN","ECXTRAC",98,0)
 S ^ECX(727,EC,"HEAD")=ECHEAD
"RTN","ECXTRAC",99,0)
 S ^ECX(727,EC,"FILE")=ECFILE
"RTN","ECXTRAC",100,0)
 S ^ECX(727,EC,"GRP")=ECGRP
"RTN","ECXTRAC",101,0)
 I $D(ECVER) S ^ECX(727,EC,"VER")=ECVER
"RTN","ECXTRAC",102,0)
 S ^ECX(727,EC,"DIV")=ECXINST
"RTN","ECXTRAC",103,0)
 S DA=EC,DIK="^ECX(727," D IX^DIK K DIK,DA
"RTN","ECXTRAC",104,0)
 S ECRN=0,ECXYM=$$ECXYM^ECXUTL(ECED),EC23=ECXYM_U_EC
"RTN","ECXTRAC",105,0)
 S ECXSTART=$P($$HTE^XLFDT($H),":",1,2),ECXNOW=$H
"RTN","ECXTRAC",106,0)
 ;do specific extract
"RTN","ECXTRAC",107,0)
 D @ECRTN
"RTN","ECXTRAC",108,0)
 ;if task gets stop request, set ztstop and quit
"RTN","ECXTRAC",109,0)
 I QFLG D  Q
"RTN","ECXTRAC",110,0)
 .S $P(^ECX(728,1,ECNODE+.1),U,ECPIECE)="",ZTSTOP=1
"RTN","ECXTRAC",111,0)
 .D ^ECXKILL
"RTN","ECXTRAC",112,0)
 ;* set last date for all extracts except prosthetics
"RTN","ECXTRAC",113,0)
 S:(ECGRP'="PRO") $P(^ECX(728,1,ECNODE),U,ECPIECE)=$P(ECED,".")
"RTN","ECXTRAC",114,0)
 ;* set last date for prosthetics
"RTN","ECXTRAC",115,0)
 I ECGRP="PRO" D
"RTN","ECXTRAC",116,0)
 .N ECXDA1
"RTN","ECXTRAC",117,0)
 .S ECXDA1=$O(^ECX(728,0))
"RTN","ECXTRAC",118,0)
 .S $P(^ECX(728,ECXDA1,1,ECXINST,0),U,2)=$P(ECED,".")
"RTN","ECXTRAC",119,0)
 S TIME=$P($$HTE^XLFDT($H),":",1,2)
"RTN","ECXTRAC",120,0)
 S $P(^ECX(727,$P(EC23,U,2),0),U,6)=ECRN
"RTN","ECXTRAC",121,0)
 ;set piece 3 and 4 of the zero node
"RTN","ECXTRAC",122,0)
 S ECLAST=$O(^ECX(ECFILE,99999999),-1),ECTOTAL=$P(^ECX(ECFILE,0),U,4)+ECRN,$P(^(0),U,3,4)=ECLAST_U_ECTOTAL K ECLAST,ECTOTAL
"RTN","ECXTRAC",123,0)
 D MSG
"RTN","ECXTRAC",124,0)
 S $P(^ECX(728,1,ECNODE+.1),U,ECPIECE)=""
"RTN","ECXTRAC",125,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","ECXTRAC",126,0)
 D ^ECXKILL
"RTN","ECXTRAC",127,0)
 Q
"RTN","ECXTRAC",128,0)
 ;
"RTN","ECXTRAC",129,0)
MSG ; send message to mail group 'DSS-ECGRP'
"RTN","ECXTRAC",130,0)
 N ECSXS
"RTN","ECXTRAC",131,0)
 ;I ECPACK="Prosthetics" D
"RTN","ECXTRAC",132,0)
 ;.S ECSXS=$$MSG^ECXAPRO("G.DSS-"_ECGRP,ECSD,ECED,ECSDN,ECEDN,ECXINST,EC23,QFLG,ECINST)
"RTN","ECXTRAC",133,0)
 S XMSUB=ECINST_" - "_ECPACK_" EXTRACT FOR DSS",XMDUZ="DSS SYSTEM"
"RTN","ECXTRAC",134,0)
 K XMY S XMY("G.DSS-"_ECGRP_"@"_^XMB("NETNAME"))=""
"RTN","ECXTRAC",135,0)
 S ECMSG(1,0)="The DSS-"_ECPACK_" extract (#"_$P(EC23,U,2)_") for "_ECSDN,ECMSG(2,0)="through "_ECEDN_" was begun on "_$P(ECXSTART,"@")_" at "_$P(ECXSTART,"@",2)
"RTN","ECXTRAC",136,0)
 S ECMSG(3,0)="and completed on "_$P(TIME,"@")_" at "_$P(TIME,"@",2)_"."
"RTN","ECXTRAC",137,0)
 S ECMSG(4,0)=" ",ECMSG(5,0)="A total of "_ECRN_" records were written."
"RTN","ECXTRAC",138,0)
 S ECMSG(6,0)=" ",ECMSG(7,0)="Extract time was [HH:MM:SS] "_$$HDIFF^XLFDT($H,ECXNOW,3),ECMSG(8,0)=" "
"RTN","ECXTRAC",139,0)
 I $D(ECSXS),('ECSXS) D
"RTN","ECXTRAC",140,0)
 .S ECMSG(9,0)="There was a problem sending the HCPCS cost bulletin."
"RTN","ECXTRAC",141,0)
 .S ECMSG(10,0)=" "
"RTN","ECXTRAC",142,0)
 S XMTEXT="ECMSG("
"RTN","ECXTRAC",143,0)
 D ^XMD
"RTN","ECXTRAC",144,0)
 Q
"RTN","ECXTRAC",145,0)
 ;
"RTN","ECXTRAC",146,0)
CHK2 ;iv extract check - all active iv rooms to have a division
"RTN","ECXTRAC",147,0)
 S CHKFLG=0,EC=0
"RTN","ECXTRAC",148,0)
 F  S EC=$O(^PS(59.5,EC)) Q:'EC  I '$P(^PS(59.5,EC,0),U,4) D  Q:CHKFLG
"RTN","ECXTRAC",149,0)
 .S CHKFLG=$S('$G(^PS(59.5,EC,"I")):1,$G(^PS(59.5,EC,"I"))>DT:1,1:0)
"RTN","ECXTRAC",150,0)
 .I CHKFLG D
"RTN","ECXTRAC",151,0)
 ..W !!,"All active IV Rooms in the IV Room file (#59.5) must have a ""DIVISION""",!,"assigned to run this extract!"
"RTN","ECXTRAC",152,0)
 ..W !!,"This information can be entered using the DSS Extract Manager's Maintenance ",!,"option ""Enter/Edit IV Room Division""." Q
"RTN","ECXTRAC",153,0)
 ..D PAUSE
"RTN","ECXTRAC",154,0)
 Q
"RTN","ECXTRAC",155,0)
 ;
"RTN","ECXTRAC",156,0)
PAUSE ;pause screen
"RTN","ECXTRAC",157,0)
 S OUT=0
"RTN","ECXTRAC",158,0)
 I $E(IOST)="C" D
"RTN","ECXTRAC",159,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXTRAC",160,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXTRAC",161,0)
 I 'Y S OUT=1
"RTN","ECXTRAC",162,0)
 W !!
"RTN","ECXTRAC",163,0)
 Q
"RTN","ECXTRANS")
0^10^B31282446
"RTN","ECXTRANS",1,0)
ECXTRANS ;ALB/GTS,JAP,BIR/DMA-Extract from Local Editing Files and Transmit ; [ 11/26/96  2:13 PM ]
"RTN","ECXTRANS",2,0)
 ;;3.0;DSS EXTRACTS;**2,9,12,8,13,14**;Dec 22, 1997
"RTN","ECXTRANS",3,0)
EN ;entry point from option
"RTN","ECXTRANS",4,0)
 N ECDA,ECRE,ECTMP,ECCHK,ECDIVVR,ECXDIQ,JJ,SS,OUT,DIR,DUOUT,DTOUT,DIRUT,DIC,X,Y
"RTN","ECXTRANS",5,0)
 I $G(^ECX(728,1,"QUEUE"))'?1"DM"1U D  Q
"RTN","ECXTRANS",6,0)
 .W !,"You have not defined a proper transmission queue"
"RTN","ECXTRANS",7,0)
 .W !,"for entry number 1 in the DSS EXTRACTS file (#728)."
"RTN","ECXTRANS",8,0)
 .W !,"No transmission allowed."
"RTN","ECXTRANS",9,0)
 .D PAUSE
"RTN","ECXTRANS",10,0)
 S ECXQUEUE=$G(^ECX(728,1,"QUEUE"))
"RTN","ECXTRANS",11,0)
 ;** check divisions for transmission
"RTN","ECXTRANS",12,0)
 S ECCHK=$$DIV4^XUSER(.ECTMP,DUZ)
"RTN","ECXTRANS",13,0)
 I 'ECCHK D  Q
"RTN","ECXTRANS",14,0)
 .W !,"You do not have any divisions defined in your user set up and cannot transmit."
"RTN","ECXTRANS",15,0)
 .S DIR(0)="FAO^1:1",DIR("A")="Hit Return to continue." D ^DIR K DIR,X,Y
"RTN","ECXTRANS",16,0)
 W !!,"Your user setup will only allow you to transmit extracts from the"
"RTN","ECXTRANS",17,0)
 W !," following divisions:",!
"RTN","ECXTRANS",18,0)
 S ECDIVVR=""
"RTN","ECXTRANS",19,0)
 F  S ECDIVVR=$O(ECTMP(ECDIVVR)) Q:'(+ECDIVVR)  D
"RTN","ECXTRANS",20,0)
 .K ECXDIC S DA=ECDIVVR,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01"
"RTN","ECXTRANS",21,0)
 .D EN^DIQ1 W !,"   ",$G(ECXDIC(4,DA,.01,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXTRANS",22,0)
 W !!,"If you can't select an extract, it is probably from another division.",!
"RTN","ECXTRANS",23,0)
 D PAUSE Q:OUT
"RTN","ECXTRANS",24,0)
 S ECRE="",DIC="^ECX(727,",DIC(0)="AEQM",DIC("A")="Transmit which extract: "
"RTN","ECXTRANS",25,0)
 S DIC("S")="I '$D(^ECX(727,+Y,""L"")),'$D(^ECX(727,+Y,""PURG"")),$D(ECTMP(+$P($G(^ECX(727,+Y,""DIV"")),U,1)))"
"RTN","ECXTRANS",26,0)
 D ^DIC
"RTN","ECXTRANS",27,0)
 I Y<0 W !! Q
"RTN","ECXTRANS",28,0)
 ;get data on extract
"RTN","ECXTRANS",29,0)
 S DR="1;6;3;4;5;15",(ECDA,DA)=+Y,DIQ(0)="E",DIQ="ECXDIQ" D EN^DIQ1
"RTN","ECXTRANS",30,0)
 W !!,ECXDIQ(727,ECDA,6,"E")_" Extract",?42,"Records:    ",ECXDIQ(727,ECDA,5,"E")
"RTN","ECXTRANS",31,0)
 W !,"Generated on: ",ECXDIQ(727,ECDA,1,"E"),?42,"Start date: ",ECXDIQ(727,ECDA,3,"E")
"RTN","ECXTRANS",32,0)
 W !,"Division:     ",$E(ECXDIQ(727,ECDA,15,"E"),1,26),?42,"End date:   ",ECXDIQ(727,ECDA,4,"E")
"RTN","ECXTRANS",33,0)
 I $G(^ECX(727,ECDA,"PURG")) S ECX=^("PURG") D  Q
"RTN","ECXTRANS",34,0)
 .W !!,"Data for this extract was purged on ",$TR($$FMTE^XLFDT(ECX,"5DF")," ","0")
"RTN","ECXTRANS",35,0)
 .K ECX
"RTN","ECXTRANS",36,0)
 .D PAUSE
"RTN","ECXTRANS",37,0)
 I $G(^ECX(727,ECDA,"TR")) S ECX=^("TR") D  Q:OUT
"RTN","ECXTRANS",38,0)
 .S OUT=0
"RTN","ECXTRANS",39,0)
 .W !!,"This extract was transmitted on ",$TR($$FMTE^XLFDT(ECX,"5DF")," ","0")
"RTN","ECXTRANS",40,0)
 .K ECX S DIR(0)="Y",DIR("A")="Do you want to retransmit " D ^DIR K DIR
"RTN","ECXTRANS",41,0)
 .I 'Y S OUT=1 Q
"RTN","ECXTRANS",42,0)
 .K ^ECX(727,ECDA,"TR")
"RTN","ECXTRANS",43,0)
 .S ECRE="re"
"RTN","ECXTRANS",44,0)
 S ECTYPE=$P(^ECX(727,ECDA,0),U,3),ECIEN=+$O(^ECX(727.1,"AC",ECTYPE,0)),ECPIECE=$P(^ECX(727.1,ECIEN,0),U,10)
"RTN","ECXTRANS",45,0)
 I ECPIECE>0,$P($G(^ECX(728,1,7.1)),U,ECPIECE)]"" D  Q
"RTN","ECXTRANS",46,0)
 .D MES^XPDUTL(" ")
"RTN","ECXTRANS",47,0)
 .D MES^XPDUTL("An "_ECTYPE_" Extract is currently running or scheduled to run.")
"RTN","ECXTRANS",48,0)
 .D MES^XPDUTL("Please wait until that job has completed before attempting")
"RTN","ECXTRANS",49,0)
 .D MES^XPDUTL("this transmission.")
"RTN","ECXTRANS",50,0)
 .D MES^XPDUTL(" ")
"RTN","ECXTRANS",51,0)
 .D PAUSE
"RTN","ECXTRANS",52,0)
 S ZTSK=$G(^ECX(727,ECDA,"Q")) I ZTSK D STAT^%ZTLOAD I ZTSK(0) I ZTSK(1)<3 D  Q
"RTN","ECXTRANS",53,0)
 .W !!,"Task ",ZTSK," is already queued to transmit this extract."
"RTN","ECXTRANS",54,0)
 .K ZTSK
"RTN","ECXTRANS",55,0)
 .D PAUSE
"RTN","ECXTRANS",56,0)
 S ZTSAVE("ECDA")="",ZTSAVE("ECXQUEUE")="",ZTSAVE("ECRE")="",ZTRTN="START^ECXTRANS",ZTIO="",ZTDESC="Transmission of extract # "_ECDA
"RTN","ECXTRANS",57,0)
 W !! D ^%ZTLOAD
"RTN","ECXTRANS",58,0)
 I $D(ZTSK) D
"RTN","ECXTRANS",59,0)
 .W !,"Request queued as Task #",ZTSK,"."
"RTN","ECXTRANS",60,0)
 .S ^ECX(727,ECDA,"Q")=ZTSK K ZTSK
"RTN","ECXTRANS",61,0)
 .D PAUSE
"RTN","ECXTRANS",62,0)
 Q
"RTN","ECXTRANS",63,0)
START ; entry point from task
"RTN","ECXTRANS",64,0)
 N DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXTRANS",65,0)
 S:$P(^ECX(727,ECDA,0),U,3)'="Prosthetics" ECINST=$P(^ECX(728,1,0),U)
"RTN","ECXTRANS",66,0)
 S:$P(^ECX(727,ECDA,0),U,3)="Prosthetics" ECINST=$P(^("DIV"),U)
"RTN","ECXTRANS",67,0)
 S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXTRANS",68,0)
 D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I"))
"RTN","ECXTRANS",69,0)
 S ECF=^ECX(727,ECDA,"FILE"),ECHEAD=^("HEAD"),ECGRP=^("GRP"),ECED=$P(^(0),U,5),ECPACK=$P(^(0),U,3)
"RTN","ECXTRANS",70,0)
 S ECVER=$G(^("VER")) S:'ECVER ECVER=1 S ECVER=$$RJ^XLFSTR(ECVER,3,0)
"RTN","ECXTRANS",71,0)
 ;all setup extracts for all sites to go to queue DMU - Judy Sine 2/16/95
"RTN","ECXTRANS",72,0)
 I ECPACK["(setup)" S ECXQUEUE="DMU"
"RTN","ECXTRANS",73,0)
 ;all LAR extracts for fy96/fy97 for test sites go to queue DMW;BTSO/AAC 11/18/97
"RTN","ECXTRANS",74,0)
 I ECHEAD="LAR",+ECED<2971001 S ECXQUEUE="DMW"
"RTN","ECXTRANS",75,0)
 K ^TMP($J) S ECHD(1)=ECINST_ECHEAD_$$ECXYM^ECXUTL(ECED)_ECVER,ECRN=0,ECMSN=1,ECMIN=2,ECMAX=200,ECLN=ECMIN
"RTN","ECXTRANS",76,0)
 I ECHEAD="PRO" S ECMAX=150
"RTN","ECXTRANS",77,0)
 I ECHEAD="CLI" S ECMAX=150
"RTN","ECXTRANS",78,0)
 I ECHEAD="ADM" S ECMAX=100
"RTN","ECXTRANS",79,0)
 ;* check for and concat nodes 0 and 1 into one message line
"RTN","ECXTRANS",80,0)
 F J=0:0 S J=$O(^ECX(ECF,"AC",ECDA,J)) Q:'J  Q:$$S^%ZTLOAD  I $D(^ECX(ECF,J,0)) D
"RTN","ECXTRANS",81,0)
 .S ^TMP($J,ECMSN,ECLN,0)=$P(^ECX(ECF,J,0),U,4,100)
"RTN","ECXTRANS",82,0)
 .I $D(^ECX(ECF,J,1)) S ^TMP($J,ECMSN,ECLN,0)=^TMP($J,ECMSN,ECLN,0)_U_$P(^ECX(ECF,J,1),U,1,100)
"RTN","ECXTRANS",83,0)
 .S ^TMP($J,ECMSN,ECLN,0)=^TMP($J,ECMSN,ECLN,0)_U_"~"
"RTN","ECXTRANS",84,0)
 .S ECLN=ECLN+1,ECRN=ECRN+1 I ECLN>ECMAX,$O(^ECX(ECF,"AC",ECDA,J)) S ECLN=ECMIN,ECMSN=ECMSN+1
"RTN","ECXTRANS",85,0)
 ;quit if user stopped task
"RTN","ECXTRANS",86,0)
 I $$S^%ZTLOAD D CLEAN Q
"RTN","ECXTRANS",87,0)
 S TIME=$P($$HTE^XLFDT($H),":",1,2)
"RTN","ECXTRANS",88,0)
 ; send message to mail group 'DSS-ECGRP'
"RTN","ECXTRANS",89,0)
 S ECXLNCNT=7
"RTN","ECXTRANS",90,0)
 F ECMS=1:1:ECMSN D SEND
"RTN","ECXTRANS",91,0)
 S XMSUB=ECINST_" - "_ECPACK_" EXTRACT FOR DSS",XMDUZ="DSS SYSTEM"
"RTN","ECXTRANS",92,0)
 K XMY S XMY("G.DSS-"_ECGRP_"@"_^XMB("NETNAME"))=""
"RTN","ECXTRANS",93,0)
 S ^TMP($J,"LOC",1,0)="The DSS "_ECPACK_" extract (#"_ECDA_") was "_ECRE_"transmitted on "_$P(TIME,"@")_" at "_$P(TIME,"@",2)_". "
"RTN","ECXTRANS",94,0)
 S ^TMP($J,"LOC",3,0)=" "
"RTN","ECXTRANS",95,0)
 S ^TMP($J,"LOC",4,0)="A total of "_ECRN_" records were written."
"RTN","ECXTRANS",96,0)
 S ^TMP($J,"LOC",5,0)="A total of "_ECMSN_" messages were sent."
"RTN","ECXTRANS",97,0)
 S ^TMP($J,"LOC",6,0)="    Message numbers :"
"RTN","ECXTRANS",98,0)
 S XMTEXT="^TMP($J,""LOC"","
"RTN","ECXTRANS",99,0)
 D ^XMD
"RTN","ECXTRANS",100,0)
 S ^ECX(727,ECDA,"TR")=DT
"RTN","ECXTRANS",101,0)
 D CLEAN
"RTN","ECXTRANS",102,0)
 Q
"RTN","ECXTRANS",103,0)
 ;
"RTN","ECXTRANS",104,0)
SEND ;send individual messages
"RTN","ECXTRANS",105,0)
 N ECXDD,DA,DIC,DIE,DINUM,X,XMDUZ,XMTEXT,XMSUB,XMY,XMZ
"RTN","ECXTRANS",106,0)
 S XMSUB="("_ECGRP_") "_ECINST_" - "_ECPACK_" DSS EXTRACT, MESSAGE "_ECMS_" OF "_ECMSN
"RTN","ECXTRANS",107,0)
 S XMDUZ="DSS SYSTEM"
"RTN","ECXTRANS",108,0)
 F J=1:1:ECMIN-1 S ^TMP($J,ECMS,J,0)=ECHD(J)
"RTN","ECXTRANS",109,0)
 S XMY("XXX@Q-"_ECXQUEUE_".VA.GOV")=""
"RTN","ECXTRANS",110,0)
 S XMTEXT="^TMP($J,ECMS,"
"RTN","ECXTRANS",111,0)
 D ^XMD
"RTN","ECXTRANS",112,0)
 S ^TMP($J,"LOC",ECXLNCNT,0)=XMZ,ECXLNCNT=ECXLNCNT+1
"RTN","ECXTRANS",113,0)
 ;store msg # in extract log
"RTN","ECXTRANS",114,0)
 D FIELD^DID(727,301,,"SPECIFIER","ECXDD")
"RTN","ECXTRANS",115,0)
 S DA(1)=ECDA,DIC(0)="L",DIC("P")=ECXDD("SPECIFIER")
"RTN","ECXTRANS",116,0)
 S DIC="^ECX(727,"_DA(1)_",1,",X=XMZ,DINUM=X
"RTN","ECXTRANS",117,0)
 K DD,DO D FILE^DICN
"RTN","ECXTRANS",118,0)
 Q
"RTN","ECXTRANS",119,0)
 ;
"RTN","ECXTRANS",120,0)
CLEAN ;clean-up
"RTN","ECXTRANS",121,0)
 S ZTREQ="@"
"RTN","ECXTRANS",122,0)
 K ^TMP($J),^ECX(727,ECDA,"Q"),XMDUZ,XMTEXT,XMSUB,XMY,XMZ
"RTN","ECXTRANS",123,0)
 D ^ECXKILL
"RTN","ECXTRANS",124,0)
 I $$S^%ZTLOAD K ZTREQ S ZTSTOP=1
"RTN","ECXTRANS",125,0)
 Q
"RTN","ECXTRANS",126,0)
 ;
"RTN","ECXTRANS",127,0)
PAUSE ;pause screen
"RTN","ECXTRANS",128,0)
 S OUT=0
"RTN","ECXTRANS",129,0)
 I $E(IOST)="C" D
"RTN","ECXTRANS",130,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXTRANS",131,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXTRANS",132,0)
 I 'Y S OUT=1
"RTN","ECXTRANS",133,0)
 W !!
"RTN","ECXTRANS",134,0)
 Q
"RTN","ECXUTLA")
0^9^B52558732
"RTN","ECXUTLA",1,0)
ECXUTLA ;ALB/JAP - Utilities for Audit Reports ;Sep 25, 1997
"RTN","ECXUTLA",2,0)
 ;;3.0;DSS EXTRACTS;**8,14**;Dec 22, 1997
"RTN","ECXUTLA",3,0)
 ;
"RTN","ECXUTLA",4,0)
AUDIT(ECXHEAD,ECXERR,ECXARRAY,ECXAUD) ;set audit report parameters
"RTN","ECXUTLA",5,0)
 ;   input
"RTN","ECXUTLA",6,0)
 ;   ECXHEAD  = extract HEADER CODE (required)
"RTN","ECXUTLA",7,0)
 ;              (from file #727.1, field #7)
"RTN","ECXUTLA",8,0)
 ;   ECXERR   = passed-by-reference variable (required)
"RTN","ECXUTLA",9,0)
 ;   ECXARRAY = passed-by-reference array (required)
"RTN","ECXUTLA",10,0)
 ;   ECXAUD   = 0/1 (optional)
"RTN","ECXUTLA",11,0)
 ;              0 --> extract audit (default)
"RTN","ECXUTLA",12,0)
 ;              1 --> SAS audit
"RTN","ECXUTLA",13,0)
 ;   output
"RTN","ECXUTLA",14,0)
 ;   ECXARRAY = array of audit parameters
"RTN","ECXUTLA",15,0)
 ;              ECXARRAY("DEF")     = ien of extract type in file #727.1
"RTN","ECXUTLA",16,0)
 ;              ECXARRAY("TYPE")    = print name for extract; field #7 in file #727.1
"RTN","ECXUTLA",17,0)
 ;              ECXARRAY("EXTRACT") = ien of extract in file #727
"RTN","ECXUTLA",18,0)
 ;              ECXARRAY("START")   = start date for extract audit
"RTN","ECXUTLA",19,0)
 ;              ECXARRAY("END")     = end date for extract audit
"RTN","ECXUTLA",20,0)
 ;              ECXARRAY("ERUN")    = date on which extract was generated
"RTN","ECXUTLA",21,0)
 ;              ECXARRAY("DIV")     = ien of station if file #4
"RTN","ECXUTLA",22,0)
 ;   error CODE
"RTN","ECXUTLA",23,0)
 ;   ECXERR   = 1, if input problem occurs
"RTN","ECXUTLA",24,0)
 ;              0, otherwise
"RTN","ECXUTLA",25,0)
 ;
"RTN","ECXUTLA",26,0)
 N X,Y,N,DA,DIC,DIQ,DIR,DTOUT,DUOUT,DIRUT,ECXDA,ECXTYPE,ECXSTART,ECXEND,ECXARR
"RTN","ECXUTLA",27,0)
 S ECXERR=0
"RTN","ECXUTLA",28,0)
 S N=$O(^ECX(727.1,"C",ECXHEAD,"")) S:N="" ECXERR=1
"RTN","ECXUTLA",29,0)
 Q:ECXERR
"RTN","ECXUTLA",30,0)
 S DIC="^ECX(727.1,",DIC(0)="NZ",X=N
"RTN","ECXUTLA",31,0)
 D ^DIC I Y=-1 S ECXERR=1 Q
"RTN","ECXUTLA",32,0)
 S ECXTYPE=$P(Y(0),U,7)_U_+Y K X,Y,DIC
"RTN","ECXUTLA",33,0)
 I $G(ECXAUD)=1,ECXHEAD'="DEN",ECXHEAD'="PRE",ECXHEAD'="RAD",ECXHEAD'="SUR" S ECXERR=1
"RTN","ECXUTLA",34,0)
 Q:ECXERR
"RTN","ECXUTLA",35,0)
 S DIC="^ECX(727,",DIC(0)="AEMQ",DIC("S")="I $P(^(0),U,3)=$P(ECXTYPE,U),'$D(^(""PURG""))"
"RTN","ECXUTLA",36,0)
 D ^DIC
"RTN","ECXUTLA",37,0)
 I Y=-1!($G(DUOUT))!($G(DTOUT)) S ECXERR=1 Q
"RTN","ECXUTLA",38,0)
 S DIC="^ECX(727,",(DA,ECXDA)=+Y,DR=".01;1;2;3;4;5;15;300",DIQ="ECXARR",DIQ(0)="IE"
"RTN","ECXUTLA",39,0)
 D EN^DIQ1
"RTN","ECXUTLA",40,0)
 W !!,?5,"Extract:      ",ECXARR(727,ECXDA,2,"E")," #",ECXDA
"RTN","ECXUTLA",41,0)
 W !!,?5,"Start date:   ",ECXARR(727,ECXDA,3,"E")
"RTN","ECXUTLA",42,0)
 W !,?5,"End date:     ",ECXARR(727,ECXDA,4,"E")
"RTN","ECXUTLA",43,0)
 W !,?5,"# of Records: ",ECXARR(727,ECXDA,5,"E")
"RTN","ECXUTLA",44,0)
 I ECXHEAD="PRO" W !,?5,"Station:      ",ECXARR(727,ECXDA,15,"E")
"RTN","ECXUTLA",45,0)
 ;if transmit date exists, then ask user if audit still needed
"RTN","ECXUTLA",46,0)
 I $L(ECXARR(727,ECXDA,300,"E"))>0 D
"RTN","ECXUTLA",47,0)
 .W !!,?5,"The extract which you have chosen to audit"
"RTN","ECXUTLA",48,0)
 .W !,?5,"was transmitted to AAC/DSS on ",ECXARR(727,ECXDA,300,"E"),".",!
"RTN","ECXUTLA",49,0)
 .S DIR(0)="Y",DIR("A")="Do you want to continue with this audit report",DIR("B")="NO" D ^DIR
"RTN","ECXUTLA",50,0)
 .S:$G(DIRUT) ECXERR=1 S:Y=0 ECXERR=1
"RTN","ECXUTLA",51,0)
 Q:ECXERR
"RTN","ECXUTLA",52,0)
 ;setup the return array
"RTN","ECXUTLA",53,0)
 S ECXARRAY("EXTRACT")=ECXARR(727,ECXDA,.01,"E"),ECXARRAY("DIV")=ECXARR(727,ECXDA,15,"I"),ECXARRAY("TYPE")=$P(ECXTYPE,U),ECXARRAY("DEF")=$P(ECXTYPE,U,2)
"RTN","ECXUTLA",54,0)
 S ECXARRAY("START")=ECXARR(727,ECXDA,3,"E"),ECXARRAY("END")=ECXARR(727,ECXDA,4,"E"),ECXARRAY("ERUN")=ECXARR(727,ECXDA,1,"E")
"RTN","ECXUTLA",55,0)
 ;determine date range only for extract audit reports
"RTN","ECXUTLA",56,0)
 I $G(ECXAUD)=0 D
"RTN","ECXUTLA",57,0)
 .S ECXSTART=ECXARRAY("START"),ECXEND=ECXARRAY("END") D RANGE^ECXUTLA(.ECXSTART,.ECXEND,.ECXERR)
"RTN","ECXUTLA",58,0)
 .I ECXERR K ECXARRAY
"RTN","ECXUTLA",59,0)
 .Q:ECXERR
"RTN","ECXUTLA",60,0)
 .S ECXARRAY("START")=ECXSTART,ECXARRAY("END")=ECXEND
"RTN","ECXUTLA",61,0)
 Q
"RTN","ECXUTLA",62,0)
 ;
"RTN","ECXUTLA",63,0)
RANGE(ECXSTART,ECXEND,ECXERR) ;determine date range for extract audit report
"RTN","ECXUTLA",64,0)
 ;   input
"RTN","ECXUTLA",65,0)
 ;   ECXSTART = start date of extract in file #727 (required)
"RTN","ECXUTLA",66,0)
 ;              passed by reference
"RTN","ECXUTLA",67,0)
 ;   ECXEND   = end date of extract in file #727 (required)
"RTN","ECXUTLA",68,0)
 ;              passed by reference
"RTN","ECXUTLA",69,0)
 ;   ECXERR   = passed by reference (required)
"RTN","ECXUTLA",70,0)
 ;   output
"RTN","ECXUTLA",71,0)
 ;   ECXSTART = user selected start date
"RTN","ECXUTLA",72,0)
 ;   ECXEND   = user selected end date
"RTN","ECXUTLA",73,0)
 ;   error CODE
"RTN","ECXUTLA",74,0)
 ;   ECXERR   = 1, if input problem occurs
"RTN","ECXUTLA",75,0)
 ;              0, otherwise
"RTN","ECXUTLA",76,0)
 ;
"RTN","ECXUTLA",77,0)
 ;
"RTN","ECXUTLA",78,0)
 ;convert dates to internal format
"RTN","ECXUTLA",79,0)
 N DATEA,DATEB,X,Y,%DT,DTOUT,OUT
"RTN","ECXUTLA",80,0)
 S (ECXERR,OUT)=0
"RTN","ECXUTLA",81,0)
 S X=ECXSTART D ^%DT S DATEA=Y
"RTN","ECXUTLA",82,0)
 S X=ECXEND D ^%DT S DATEB=Y
"RTN","ECXUTLA",83,0)
 ;allow user to select start date
"RTN","ECXUTLA",84,0)
 ;can't be less than ecxstart or greater than ecxend
"RTN","ECXUTLA",85,0)
 W !!,?5,"You can narrow the date range, if you wish.",!
"RTN","ECXUTLA",86,0)
 W !,?5,"The Start Date can't be earlier than ",ECXSTART,","
"RTN","ECXUTLA",87,0)
 W !,?5,"or later than ",ECXEND,".",!
"RTN","ECXUTLA",88,0)
 F  Q:OUT!ECXERR  D
"RTN","ECXUTLA",89,0)
 .S %DT="AEX",%DT("A")="Select Start Date: ",%DT("B")=ECXSTART,%DT(0)=DATEA
"RTN","ECXUTLA",90,0)
 .D ^%DT S:Y=-1 ECXERR=1 S:$G(DTOUT) ECXERR=1
"RTN","ECXUTLA",91,0)
 .Q:ECXERR
"RTN","ECXUTLA",92,0)
 .I Y>DATEB D  Q
"RTN","ECXUTLA",93,0)
 ..W !,?5,"But that's later than ",ECXEND,"...try again.",!
"RTN","ECXUTLA",94,0)
 .S DATEA=Y,OUT=1
"RTN","ECXUTLA",95,0)
 I ECXERR K ECXSTART,ECXEND
"RTN","ECXUTLA",96,0)
 Q:ECXERR
"RTN","ECXUTLA",97,0)
 S Y=DATEA D DD^%DT S ECXSTART=Y
"RTN","ECXUTLA",98,0)
 ;allow user to select end date
"RTN","ECXUTLA",99,0)
 ;can't be less than ecxstart or greater than ecxend
"RTN","ECXUTLA",100,0)
 W !!,?5,"The End Date can't be earlier than ",ECXSTART
"RTN","ECXUTLA",101,0)
 W !,?5,"(the Start Date you selected), or later than ",ECXEND,".",!
"RTN","ECXUTLA",102,0)
 S OUT=0
"RTN","ECXUTLA",103,0)
 F  Q:OUT!ECXERR  D
"RTN","ECXUTLA",104,0)
 .S %DT="AEX",%DT("A")="Select End Date: ",%DT("B")=ECXEND,%DT(0)=-DATEB
"RTN","ECXUTLA",105,0)
 .D ^%DT S:Y=-1 ECXERR=1 S:$G(DTOUT) ECXERR=1
"RTN","ECXUTLA",106,0)
 .Q:ECXERR
"RTN","ECXUTLA",107,0)
 .I Y<DATEA D  Q
"RTN","ECXUTLA",108,0)
 ..W !,?5,"But that's earlier than ",ECXSTART,"...try again.",!
"RTN","ECXUTLA",109,0)
 .S DATEB=Y,OUT=1
"RTN","ECXUTLA",110,0)
 I ECXERR K ECXSTART,ECXEND
"RTN","ECXUTLA",111,0)
 Q:ECXERR
"RTN","ECXUTLA",112,0)
 S Y=DATEB D DD^%DT S ECXEND=Y
"RTN","ECXUTLA",113,0)
 Q
"RTN","ECXUTLA",114,0)
 ;
"RTN","ECXUTLA",115,0)
DEVICE(ZTRTN,ZTDESC,ZTSAVE) ;get print device and optionally task to background
"RTN","ECXUTLA",116,0)
 ;   input
"RTN","ECXUTLA",117,0)
 ;   ZTRTN  = line^routine; task entry point (required)
"RTN","ECXUTLA",118,0)
 ;            variable for %ZTLOAD
"RTN","ECXUTLA",119,0)
 ;   ZTDESC = task description (required)
"RTN","ECXUTLA",120,0)
 ;            variable for %ZTLOAD
"RTN","ECXUTLA",121,0)
 ;   ZTSAVE = array; passed by reference (required)
"RTN","ECXUTLA",122,0)
 ;            variables for %ZTLOAD
"RTN","ECXUTLA",123,0)
 ;   output
"RTN","ECXUTLA",124,0)
 ;   ZTSAVE = returns ZTSAVE("POP"),ZTSAVE("ZTSK")
"RTN","ECXUTLA",125,0)
 ;
"RTN","ECXUTLA",126,0)
 N POP,ZTSK
"RTN","ECXUTLA",127,0)
 S ZTSAVE("POP")=0,ZTSAVE("ZTSK")=0
"RTN","ECXUTLA",128,0)
 ;return ztsave("pop")=1 and quit if required input not available
"RTN","ECXUTLA",129,0)
 I '$L(ZTRTN)!('$L(ZTDESC))!('$D(ZTSAVE)) S ZTSAVE("POP")=1 Q
"RTN","ECXUTLA",130,0)
 ;get print device
"RTN","ECXUTLA",131,0)
 K IO("Q") S %ZIS="QM" D ^%ZIS
"RTN","ECXUTLA",132,0)
 S ZTSAVE("POP")=POP
"RTN","ECXUTLA",133,0)
 I POP D
"RTN","ECXUTLA",134,0)
 .W !,"No device selected...exiting.",!
"RTN","ECXUTLA",135,0)
 Q:POP
"RTN","ECXUTLA",136,0)
 I $D(IO("Q")) D
"RTN","ECXUTLA",137,0)
 .S ZTSAVE("ZTREQ")="@"
"RTN","ECXUTLA",138,0)
 .D ^%ZTLOAD
"RTN","ECXUTLA",139,0)
 .I $G(ZTSK)>0 D
"RTN","ECXUTLA",140,0)
 ..W !,"Request queued as Task #",ZTSK,".",!
"RTN","ECXUTLA",141,0)
 ..S ZTSAVE("ZTSK")=ZTSK
"RTN","ECXUTLA",142,0)
 ..S ZTSAVE("POP")=0
"RTN","ECXUTLA",143,0)
 .I '$G(ZTSK) D
"RTN","ECXUTLA",144,0)
 ..W !,"Request to queue cancelled...exiting.",!
"RTN","ECXUTLA",145,0)
 ..S ZTSAVE("ZTSK")=0
"RTN","ECXUTLA",146,0)
 ..S ZTSAVE("POP")=1
"RTN","ECXUTLA",147,0)
 Q
"RTN","ECXUTLA",148,0)
 ;
"RTN","ECXUTLA",149,0)
WARDS(ECXALL,ECXDIV) ;get wards for selected divisions
"RTN","ECXUTLA",150,0)
 ;   input
"RTN","ECXUTLA",151,0)
 ;   ECXALL = 1/0 (optional)
"RTN","ECXUTLA",152,0)
 ;            1==> user selected all divisions OR
"RTN","ECXUTLA",153,0)
 ;                 facility is non-divisional
"RTN","ECXUTLA",154,0)
 ;            0==> user selected some divisions
"RTN","ECXUTLA",155,0)
 ;            if ECXALL not defined, then assume 1
"RTN","ECXUTLA",156,0)
 ;   ECXDIV = array of divisions selected (optional)
"RTN","ECXUTLA",157,0)
 ;            passed by reference array containing
"RTN","ECXUTLA",158,0)
 ;            selected divisions;
"RTN","ECXUTLA",159,0)
 ;            if ECXALL=1, then ECXDIV array isn't
"RTN","ECXUTLA",160,0)
 ;            required; information for all wards will be obtained
"RTN","ECXUTLA",161,0)
 ;            if ECXALL=0, then only wards for divisions in ECXDIV
"RTN","ECXUTLA",162,0)
 ;   output
"RTN","ECXUTLA",163,0)
 ;   ^TMP($J,"ECXWARD", contains ward name, division, g&l order
"RTN","ECXUTLA",164,0)
 ;   ^TMP($J,"ECXORDER", contains ward grouping info
"RTN","ECXUTLA",165,0)
 ;
"RTN","ECXUTLA",166,0)
 N IEN,WARD,ORDX,NAME,NM,ORDER,DIV,HIEN,GROUP,DATA,DEPT,NAMEDEPT
"RTN","ECXUTLA",167,0)
 K ^TMP($J,"ECXWARD"),^TMP($J,"ECXORDER")
"RTN","ECXUTLA",168,0)
 ;if ecxall not here, then set ecxall=1
"RTN","ECXUTLA",169,0)
 S:'$D(ECXALL) ECXALL=1 S:ECXALL="" ECXALL=1
"RTN","ECXUTLA",170,0)
 S ORDX=0,NM=""
"RTN","ECXUTLA",171,0)
 F  S NM=$O(^DIC(42,"B",NM)) Q:NM=""  S IEN=0 F  S IEN=$O(^DIC(42,"B",NM,IEN)) Q:IEN=""  D
"RTN","ECXUTLA",172,0)
 .S DIV=+$P(^DIC(42,IEN,0),U,11) Q:DIV=0
"RTN","ECXUTLA",173,0)
 .I ECXALL=0,'$D(ECXDIV(DIV)) Q
"RTN","ECXUTLA",174,0)
 .S (NAME,ORDER,DEPT)="",NAME=$P(^DIC(42,IEN,0),U,1),ORDER=+$P($G(^DIC(42,IEN,"ORDER")),U,1),DEPT=$P($G(^ECX(727.4,IEN,0)),U,2)
"RTN","ECXUTLA",175,0)
 .;'unordered' ward is probably inactive, but get basic data anyway
"RTN","ECXUTLA",176,0)
 .I ORDER=0 S ORDX=ORDX+1,ORDER="99999"_ORDX,ORDER=+ORDER
"RTN","ECXUTLA",177,0)
 .;get this ward's ien in file #44; file #727.802 & #727.808 use pointers to file #44
"RTN","ECXUTLA",178,0)
 .S HIEN=+$P($G(^DIC(42,IEN,44)),U,1) Q:HIEN=0
"RTN","ECXUTLA",179,0)
 .;if this is last ward in group, then get the group name
"RTN","ECXUTLA",180,0)
 .K GROUP I $D(^DIC(42,IEN,1,1,0)) S GROUP=$P(^DIC(42,IEN,1,1,0),U,1) I GROUP="" K GROUP
"RTN","ECXUTLA",181,0)
 .S ^TMP($J,"ECXWARD",HIEN)=ORDER_U_NAME_U_DIV_U_IEN_U_DEPT
"RTN","ECXUTLA",182,0)
 .I $D(GROUP) S ^TMP($J,"ECXWARD",HIEN,1)=GROUP
"RTN","ECXUTLA",183,0)
 ;after all wards in file #42 are processed, arrange by g&l order
"RTN","ECXUTLA",184,0)
 S HIEN=0
"RTN","ECXUTLA",185,0)
 F  S HIEN=$O(^TMP($J,"ECXWARD",HIEN)) Q:HIEN=""  S DATA=^TMP($J,"ECXWARD",HIEN) D
"RTN","ECXUTLA",186,0)
 .S ORDER=$P(DATA,U,1),NAME=$P(DATA,U,2),DIV=$P(DATA,U,3),DEPT=$P(DATA,U,5)
"RTN","ECXUTLA",187,0)
 .S NAMEDEPT=NAME S:DEPT]"" NAMEDEPT=NAME_" <"_DEPT_">"
"RTN","ECXUTLA",188,0)
 .S ^TMP($J,"ECXORDER",DIV,ORDER)=HIEN_U_NAMEDEPT_U
"RTN","ECXUTLA",189,0)
 .I $D(^TMP($J,"ECXWARD",HIEN,1)) S GROUP=^(1),^TMP($J,"ECXORDER",DIV,ORDER,1)=1_U_GROUP_U
"RTN","ECXUTLA",190,0)
 Q
"RTN","ECXUTLA",191,0)
 ;
"RTN","ECXUTLA",192,0)
SASHEAD(ECXFL,ECXHEAD,ECXDIV,ECXARRAY,ECXPG,ECXTAB) ;header and page control
"RTN","ECXUTLA",193,0)
 ;
"RTN","ECXUTLA",194,0)
 ;   ECXFL   = feeder location (division) (required)
"RTN","ECXUTLA",195,0)
 ;   ECXHEAD = extract header from file #727.1 (required)               
"RTN","ECXUTLA",196,0)
 ;   ECXDIV  = array of divisions selected (required)
"RTN","ECXUTLA",197,0)
 ;   ECXPG   = page number (required)
"RTN","ECXUTLA",198,0)
 ;   ECXTAB  = tab location;
"RTN","ECXUTLA",199,0)
 ;             allows for proper spacing in sub-header line (optional)
"RTN","ECXUTLA",200,0)
 ;
"RTN","ECXUTLA",201,0)
 N JJ,SS,LN
"RTN","ECXUTLA",202,0)
 S $P(LN,"-",80)=""
"RTN","ECXUTLA",203,0)
 I $G(ECXTAB)="" S ECXTAB=40
"RTN","ECXUTLA",204,0)
 I $E(IOST)="C" D
"RTN","ECXUTLA",205,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXUTLA",206,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXUTLA",207,0)
 Q:QFLG
"RTN","ECXUTLA",208,0)
 W:$Y!($E(IOST)="C") @IOF S ECXPG=ECXPG+1
"RTN","ECXUTLA",209,0)
 W !,"SAS Audit Report for "_ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract"
"RTN","ECXUTLA",210,0)
 W !,"DSS Extract Log #:    "_ECXARRAY("EXTRACT")
"RTN","ECXUTLA",211,0)
 W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXUTLA",212,0)
 W !,"Report Run Date/Time: "_ECXRUN
"RTN","ECXUTLA",213,0)
 I $D(ECXDIV(ECXFL)) W !,"Division/Site:        "_$P(ECXDIV(ECXFL),U,2)_" ("_ECXFL_")",?68,"Page: "_ECXPG
"RTN","ECXUTLA",214,0)
 I '$D(ECXDIV(ECXFL)) W !,"Division/Site:        "_"Unknown",?68,"Page: "_ECXPG
"RTN","ECXUTLA",215,0)
 W !!,"Feeder Location",?ECXTAB,"Feeder Key",?68,"Quantity"
"RTN","ECXUTLA",216,0)
 W !,LN,!
"RTN","ECXUTLA",217,0)
 Q
"VER")
8.0^21.0
**END**
**END**
