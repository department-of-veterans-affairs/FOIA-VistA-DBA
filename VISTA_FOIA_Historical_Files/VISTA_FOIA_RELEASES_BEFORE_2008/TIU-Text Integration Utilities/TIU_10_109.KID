KIDS Distribution saved on May 14, 2002@09:54:01
TIU*1.0*109 AND USR*1.0*19 (5/14/02)
**KIDS**:TIU*1.0*109^USR*1.0*19^

**INSTALL NAME**
TIU*1.0*109
"BLD",2651,0)
TIU*1.0*109^TEXT INTEGRATION UTILITIES^0^3020514^y
"BLD",2651,1,0)
^^2^2^3011102^^
"BLD",2651,1,1,0)
The description on this patch may be found in the National Patch Module
"BLD",2651,1,2,0)
under TIU*1*109.
"BLD",2651,4,0)
^9.64PA^8925^1
"BLD",2651,4,8925,0)
8925
"BLD",2651,4,8925,2,0)
^9.641^8925^1
"BLD",2651,4,8925,2,8925,0)
TIU DOCUMENT  (File-top level)
"BLD",2651,4,8925,2,8925,1,0)
^9.6411^70202^2
"BLD",2651,4,8925,2,8925,1,70201,0)
PROCEDURE SUMMARY CODE
"BLD",2651,4,8925,2,8925,1,70202,0)
DATE/TIME PERFORMED
"BLD",2651,4,8925,222)
y^n^p^^^^n
"BLD",2651,4,"APDD",8925,8925)

"BLD",2651,4,"APDD",8925,8925,70201)

"BLD",2651,4,"APDD",8925,8925,70202)

"BLD",2651,4,"B",8925,8925)

"BLD",2651,"ABPKG")
n
"BLD",2651,"INID")
^n
"BLD",2651,"INIT")
TIUPS109
"BLD",2651,"KRN",0)
^9.67PA^19^17
"BLD",2651,"KRN",.4,0)
.4
"BLD",2651,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",2651,"KRN",.401,0)
.401
"BLD",2651,"KRN",.402,0)
.402
"BLD",2651,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",2651,"KRN",.402,"NM",1,0)
TIU ENTER/EDIT CLINPROC RESULT    FILE #8925^8925^0
"BLD",2651,"KRN",.402,"NM","B","TIU ENTER/EDIT CLINPROC RESULT    FILE #8925",1)

"BLD",2651,"KRN",.403,0)
.403
"BLD",2651,"KRN",.5,0)
.5
"BLD",2651,"KRN",.84,0)
.84
"BLD",2651,"KRN",.84,"NM",0)
^9.68A^7^7
"BLD",2651,"KRN",.84,"NM",1,0)
89250006^^0
"BLD",2651,"KRN",.84,"NM",2,0)
89250007^^0
"BLD",2651,"KRN",.84,"NM",3,0)
89250008^^0
"BLD",2651,"KRN",.84,"NM",4,0)
89250009^^0
"BLD",2651,"KRN",.84,"NM",5,0)
89250010^^0
"BLD",2651,"KRN",.84,"NM",6,0)
89250011^^0
"BLD",2651,"KRN",.84,"NM",7,0)
89250012^^0
"BLD",2651,"KRN",.84,"NM","B",89250006,1)

"BLD",2651,"KRN",.84,"NM","B",89250007,2)

"BLD",2651,"KRN",.84,"NM","B",89250008,3)

"BLD",2651,"KRN",.84,"NM","B",89250009,4)

"BLD",2651,"KRN",.84,"NM","B",89250010,5)

"BLD",2651,"KRN",.84,"NM","B",89250011,6)

"BLD",2651,"KRN",.84,"NM","B",89250012,7)

"BLD",2651,"KRN",3.6,0)
3.6
"BLD",2651,"KRN",3.6,"NM",0)
^9.68A^^
"BLD",2651,"KRN",3.8,0)
3.8
"BLD",2651,"KRN",9.2,0)
9.2
"BLD",2651,"KRN",9.8,0)
9.8
"BLD",2651,"KRN",9.8,"NM",0)
^9.68A^27^26
"BLD",2651,"KRN",9.8,"NM",1,0)
TIUPS109^^0^B40166517
"BLD",2651,"KRN",9.8,"NM",2,0)
TIUCP^^0^B1179203
"BLD",2651,"KRN",9.8,"NM",3,0)
TIULP^^0^B35420949
"BLD",2651,"KRN",9.8,"NM",4,0)
TIUSRVP^^0^B73447909
"BLD",2651,"KRN",9.8,"NM",5,0)
TIUSRVP1^^0^B35741111
"BLD",2651,"KRN",9.8,"NM",6,0)
TIUSRVR^^0^B16377964
"BLD",2651,"KRN",9.8,"NM",7,0)
TIUSRVR1^^0^B27364971
"BLD",2651,"KRN",9.8,"NM",8,0)
TIUSRVR2^^0^B30009019
"BLD",2651,"KRN",9.8,"NM",9,0)
TIUCNSLT^^0^B16233337
"BLD",2651,"KRN",9.8,"NM",10,0)
TIUCPCL^^0^B828734
"BLD",2651,"KRN",9.8,"NM",11,0)
TIUSRV^^0^B68149058
"BLD",2651,"KRN",9.8,"NM",13,0)
TIUCHLP^^0^B11855881
"BLD",2651,"KRN",9.8,"NM",14,0)
TIUPUTCP^^0^B68872703
"BLD",2651,"KRN",9.8,"NM",15,0)
TIURS^^0^B46418913
"BLD",2651,"KRN",9.8,"NM",16,0)
TIUCPFIX^^0^B56333160
"BLD",2651,"KRN",9.8,"NM",17,0)
TIURB^^0^B34375935
"BLD",2651,"KRN",9.8,"NM",18,0)
TIURB2^^0^B32735500
"BLD",2651,"KRN",9.8,"NM",19,0)
TIURD2^^0^B68771136
"BLD",2651,"KRN",9.8,"NM",20,0)
TIURS1^^0^B66573079
"BLD",2651,"KRN",9.8,"NM",21,0)
TIUEDIT^^0^B37974979
"BLD",2651,"KRN",9.8,"NM",22,0)
TIUEDITR^^0^B14502322
"BLD",2651,"KRN",9.8,"NM",23,0)
TIUEDIM^^0^B17815252
"BLD",2651,"KRN",9.8,"NM",24,0)
TIURA^^0^B56454761
"BLD",2651,"KRN",9.8,"NM",25,0)
TIULC^^0^B27988155
"BLD",2651,"KRN",9.8,"NM",26,0)
TIUEDI4^^0^B48842233
"BLD",2651,"KRN",9.8,"NM",27,0)
TIURD^^0^B35790600
"BLD",2651,"KRN",9.8,"NM","B","TIUCHLP",13)

"BLD",2651,"KRN",9.8,"NM","B","TIUCNSLT",9)

"BLD",2651,"KRN",9.8,"NM","B","TIUCP",2)

"BLD",2651,"KRN",9.8,"NM","B","TIUCPCL",10)

"BLD",2651,"KRN",9.8,"NM","B","TIUCPFIX",16)

"BLD",2651,"KRN",9.8,"NM","B","TIUEDI4",26)

"BLD",2651,"KRN",9.8,"NM","B","TIUEDIM",23)

"BLD",2651,"KRN",9.8,"NM","B","TIUEDIT",21)

"BLD",2651,"KRN",9.8,"NM","B","TIUEDITR",22)

"BLD",2651,"KRN",9.8,"NM","B","TIULC",25)

"BLD",2651,"KRN",9.8,"NM","B","TIULP",3)

"BLD",2651,"KRN",9.8,"NM","B","TIUPS109",1)

"BLD",2651,"KRN",9.8,"NM","B","TIUPUTCP",14)

"BLD",2651,"KRN",9.8,"NM","B","TIURA",24)

"BLD",2651,"KRN",9.8,"NM","B","TIURB",17)

"BLD",2651,"KRN",9.8,"NM","B","TIURB2",18)

"BLD",2651,"KRN",9.8,"NM","B","TIURD",27)

"BLD",2651,"KRN",9.8,"NM","B","TIURD2",19)

"BLD",2651,"KRN",9.8,"NM","B","TIURS",15)

"BLD",2651,"KRN",9.8,"NM","B","TIURS1",20)

"BLD",2651,"KRN",9.8,"NM","B","TIUSRV",11)

"BLD",2651,"KRN",9.8,"NM","B","TIUSRVP",4)

"BLD",2651,"KRN",9.8,"NM","B","TIUSRVP1",5)

"BLD",2651,"KRN",9.8,"NM","B","TIUSRVR",6)

"BLD",2651,"KRN",9.8,"NM","B","TIUSRVR1",7)

"BLD",2651,"KRN",9.8,"NM","B","TIUSRVR2",8)

"BLD",2651,"KRN",19,0)
19
"BLD",2651,"KRN",19,"NM",0)
^9.68A^^
"BLD",2651,"KRN",19.1,0)
19.1
"BLD",2651,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",2651,"KRN",101,0)
101
"BLD",2651,"KRN",101,"NM",0)
^9.68A^^
"BLD",2651,"KRN",409.61,0)
409.61
"BLD",2651,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",2651,"KRN",771,0)
771
"BLD",2651,"KRN",870,0)
870
"BLD",2651,"KRN",8994,0)
8994
"BLD",2651,"KRN",8994,"NM",0)
^9.68A^5^4
"BLD",2651,"KRN",8994,"NM",1,0)
TIU IS THIS A CLINPROC?^^0
"BLD",2651,"KRN",8994,"NM",3,0)
TIU LONG LIST CLINPROC TITLES^^0
"BLD",2651,"KRN",8994,"NM",4,0)
TIU IDENTIFY CLINPROC CLASS^^0
"BLD",2651,"KRN",8994,"NM",5,0)
TIU CREATE RECORD^^0
"BLD",2651,"KRN",8994,"NM","B","TIU CREATE RECORD",5)

"BLD",2651,"KRN",8994,"NM","B","TIU IDENTIFY CLINPROC CLASS",4)

"BLD",2651,"KRN",8994,"NM","B","TIU IS THIS A CLINPROC?",1)

"BLD",2651,"KRN",8994,"NM","B","TIU LONG LIST CLINPROC TITLES",3)

"BLD",2651,"KRN","B",.4,.4)

"BLD",2651,"KRN","B",.401,.401)

"BLD",2651,"KRN","B",.402,.402)

"BLD",2651,"KRN","B",.403,.403)

"BLD",2651,"KRN","B",.5,.5)

"BLD",2651,"KRN","B",.84,.84)

"BLD",2651,"KRN","B",3.6,3.6)

"BLD",2651,"KRN","B",3.8,3.8)

"BLD",2651,"KRN","B",9.2,9.2)

"BLD",2651,"KRN","B",9.8,9.8)

"BLD",2651,"KRN","B",19,19)

"BLD",2651,"KRN","B",19.1,19.1)

"BLD",2651,"KRN","B",101,101)

"BLD",2651,"KRN","B",409.61,409.61)

"BLD",2651,"KRN","B",771,771)

"BLD",2651,"KRN","B",870,870)

"BLD",2651,"KRN","B",8994,8994)

"BLD",2651,"QUES",0)
^9.62^^
"BLD",2651,"REQB",0)
^9.611^8^5
"BLD",2651,"REQB",1,0)
TEXT INTEGRATION UTILITIES 1.0^2
"BLD",2651,"REQB",5,0)
TIU*1.0*122^2
"BLD",2651,"REQB",6,0)
GMRC*3.0*17^2
"BLD",2651,"REQB",7,0)
TIU*1.0*116^2
"BLD",2651,"REQB",8,0)
TIU*1.0*115^2
"BLD",2651,"REQB","B","GMRC*3.0*17",6)

"BLD",2651,"REQB","B","TEXT INTEGRATION UTILITIES 1.0",1)

"BLD",2651,"REQB","B","TIU*1.0*115",8)

"BLD",2651,"REQB","B","TIU*1.0*116",7)

"BLD",2651,"REQB","B","TIU*1.0*122",5)

"FIA",8925)
TIU DOCUMENT
"FIA",8925,0)
^TIU(8925,
"FIA",8925,0,0)
8925IP
"FIA",8925,0,1)
y^n^p^^^^n
"FIA",8925,0,10)

"FIA",8925,0,11)

"FIA",8925,0,"RLRO")

"FIA",8925,0,"VR")
1.0^TIU
"FIA",8925,8925)
1
"FIA",8925,8925,70201)

"FIA",8925,8925,70202)

"INIT")
TIUPS109
"KRN",.402,1386,-1)
0^1
"KRN",.402,1386,0)
TIU ENTER/EDIT CLINPROC RESULT^3020108.0707^^8925^^^3020108
"KRN",.402,1386,"DIAB",1,0,8925,3)
1301//^S X=$$DATE^TIULS($$NOW^XLFDT,"MM/DD/YY@HR:MIN");T
"KRN",.402,1386,"DIAB",3,0,8925,3)
1202//^S X=$$PERSNAME^TIULC1($S($D(TIUAUTH):+TIUAUTH,1:+DUZ));T;REQ
"KRN",.402,1386,"DIAB",4,0,8925,6)
1208//^S X=TIUDCSNR;REQ
"KRN",.402,1386,"DIAB",8,0,8925,6)
1208;REQ
"KRN",.402,1386,"DIAB",10,0,8925,10)
70201;REQ
"KRN",.402,1386,"DIAB",11,0,8925,10)
70202;REQ
"KRN",.402,1386,"DR",1,8925)
S DIE("NO^")="";.02////^S X=DFN;.03////^S X=$P($G(TIU("VISIT")),U);.07////^S X=$P($G(TIU("EDT")),U);.08////^S X=$P($G(TIU("LDT")),U);1401////^S X=$P($G(TIU("AD#")),U);I '+$G(TIUBY) S Y="@1";
"KRN",.402,1386,"DR",1,8925,1)
I +$P($G(^TIU(8925,+DA,12)),U,5) S Y="@13";1205////^S X=$P($G(TIU("LOC")),U);@13;I +$G(^TIU(8925,+DA,13)) S Y="@14";1301////^S X=$$NOW^TIULC;@14;I +$P($G(^TIU(8925,+DA,12)),U,2) S Y="@1";
"KRN",.402,1386,"DR",1,8925,2)
1202////^S X=$S($D(TIUAUTH):+TIUAUTH,1:+$G(DUZ));@1;I +$G(TIUBY) S Y="@2";I $P($G(^SC(+$G(TIU("LOC")),0)),U,3)="W" S Y="@3";1205////^S X=$P($G(TIU("LOC")),U);S Y="@4";@3;1205//^S X=$P($G(TIU("LOC")),U,2);@4;
"KRN",.402,1386,"DR",1,8925,3)
1301T~//^S X=$$DATE^TIULS($$NOW^XLFDT,"MM/DD/YY@HR:MIN");I +$$DATENOTE^TIULA3($$DATE^TIULS(X,"MM/DD/YY@HR:MIN:SEC"))'>0 S Y="@4";1202R~T~//^S X=$$PERSNAME^TIULC1($S($D(TIUAUTH):+TIUAUTH,1:+DUZ));Q;
"KRN",.402,1386,"DR",1,8925,4)
I +$G(TIUAUTH),(+$P(^TIU(8925,+DA,12),U,2)'=+$G(TIUAUTH)) S TIU("SVC")=$$PROVSVC^TIULV(+$P(^(12),U,2)),TIUAUTH=+$P(^TIU(8925,+DA,12),U,2);@2;1204////^S X=$P($G(^TIU(8925,+DA,12)),U,2);S TIUESNR=X;
"KRN",.402,1386,"DR",1,8925,5)
I +$P($G(^TIU(8925,+DA,13)),U,2) S Y="@5";1302////^S X=DUZ;@5;I +$P($G(^TIU(8925,+DA,12)),U) S Y="@6";1201////^S X=$$NOW^TIULC;@6;I '+$$REQCOSIG^TIULP(+$G(TIUTYP),+DA,+$G(TIUESNR)),($L($P($G(^TIU(8925,+DA,12)),U,8))'>0) S Y="@7";
"KRN",.402,1386,"DR",1,8925,6)
I +$$ISA^USRLM(DUZ,"TRANSCRIPTIONIST") S Y="@8";S TIUDCSNR=$$PERSNAME^TIULC1(+$P($G(TIUPREF),U,9));I TIUDCSNR="UNKNOWN" S Y="@11";1208R~//^S X=TIUDCSNR;K TIUDCSNR;S Y="@9";@11;1208R~;S Y="@9";@8;1208;@9;1506////1;@7;
"KRN",.402,1386,"DR",1,8925,7)
S TIUCDA=+$P($G(^TIU(8925,+DA,14)),U,5);I TIUCDA S Y="@15";S TIUCVP=$$GETCNSLT^TIUCNSLT(DFN,1);I +TIUCVP'>0 W !,"You may only enter a result for a valid Clinical Procedure Request.",! S Y="@999",TIUQUIT=1;
"KRN",.402,1386,"DR",1,8925,8)
S TIUCPACT=$$CPACTM^GMRCCP(+TIUCVP);I TIUCPACT=2 W !,"Document cannot be edited.  Results are not available to interpret." S Y="@999",TIUQUIT=1;
"KRN",.402,1386,"DR",1,8925,9)
I TIUCPACT=3 W !,"Document cannot be entered.  An incomplete document already exists." S Y="@999",TIUQUIT=1;S TIUCDA=+TIUCVP;1405////^S X=TIUCVP;@15;I +$P($G(TIUPREF),U,8)'>0,($G(^TIU(8925,+DA,17))']"") S Y="@10";1701;@10;
"KRN",.402,1386,"DR",1,8925,10)
K TIUESNR;I $P($G(^TIU(8925,+DA,13)),U,3)]"" S Y="@12";1303////^S X="D";@12;I $$REQCPF^TIULP(+$G(TIUCDA)) S Y="@20";70201;70202;S Y="@999";@20;70201R~;70202R~;@999;K TIUCDA,TIUCVP,TIUCPACT;
"KRN",.84,89250006,-1)
0^1
"KRN",.84,89250006,0)
89250006^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250006,1,0)
^^2^2^3010502^
"KRN",.84,89250006,1,1,0)
The TIU DOCUMENT record could not be uploaded because the patient is
"KRN",.84,89250006,1,2,0)
not associated with the specified Consult Request Number.
"KRN",.84,89250006,2,0)
^.844^1^1^3010502^^^
"KRN",.84,89250006,2,1,0)
The Patient is not associated with the Consult Request Number.
"KRN",.84,89250007,-1)
0^2
"KRN",.84,89250007,0)
89250007^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250007,1,0)
^.842^2^2^3010502^^^
"KRN",.84,89250007,1,1,0)
The TIU DOCUMENT record could not be uploaded because the specified TIU
"KRN",.84,89250007,1,2,0)
Document Number does not exist.
"KRN",.84,89250007,2,0)
^^1^1^3010502^
"KRN",.84,89250007,2,1,0)
The TIU Document Number does not exist.
"KRN",.84,89250008,-1)
0^3
"KRN",.84,89250008,0)
89250008^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250008,1,0)
^^3^3^3010502^
"KRN",.84,89250008,1,1,0)
The TIU DOCUMENT record could not be uploaded because the specified TIU
"KRN",.84,89250008,1,2,0)
Document Number is not associated with the specified Consult Request
"KRN",.84,89250008,1,3,0)
Number.
"KRN",.84,89250008,2,0)
^^1^1^3010502^
"KRN",.84,89250008,2,1,0)
The TIU Document Number is not associated with the Consult Request Number.
"KRN",.84,89250009,-1)
0^4
"KRN",.84,89250009,0)
89250009^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250009,1,0)
^.842^2^2^3010502^^
"KRN",.84,89250009,1,1,0)
The TIU DOCUMENT record could not be uploaded because the Consult Request
"KRN",.84,89250009,1,2,0)
Number has not been specified.
"KRN",.84,89250009,2,0)
^^1^1^3010502^
"KRN",.84,89250009,2,1,0)
The Consult Request Number has not been specified. 
"KRN",.84,89250010,-1)
0^5
"KRN",.84,89250010,0)
89250010^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250010,1,0)
^^2^2^3010507^
"KRN",.84,89250010,1,1,0)
The TIU DOCUMENT record could not be uploaded because the specified
"KRN",.84,89250010,1,2,0)
Consult Request Number is not associated with a Clinical Procedure.
"KRN",.84,89250010,2,0)
^^1^1^3010507^
"KRN",.84,89250010,2,1,0)
The Consult Request Number is not associated with a Clinical Procedure.
"KRN",.84,89250011,-1)
0^6
"KRN",.84,89250011,0)
89250011^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250011,1,0)
^^2^2^3010507^
"KRN",.84,89250011,1,1,0)
The TIU DOCUMENT record could not be uploaded because the results for the
"KRN",.84,89250011,1,2,0)
specified Consult Request Number are not available for interpretation.
"KRN",.84,89250011,2,0)
^^1^1^3010507^
"KRN",.84,89250011,2,1,0)
The results for the Consult Request Number are not available to interpret.
"KRN",.84,89250012,-1)
0^7
"KRN",.84,89250012,0)
89250012^1^^TEXT INTEGRATION UTILITIES
"KRN",.84,89250012,1,0)
^^2^2^3010507^
"KRN",.84,89250012,1,1,0)
The TIU DOCUMENT record could not be uploaded because the TIU Document
"KRN",.84,89250012,1,2,0)
Number has not been specified.
"KRN",.84,89250012,2,0)
^^1^1^3010507^
"KRN",.84,89250012,2,1,0)
The TIU Document Number has not been specified.
"KRN",8994,442,-1)
0^5
"KRN",8994,442,0)
TIU CREATE RECORD^MAKE^TIUSRVP^1^S
"KRN",8994,442,1,0)
^8994.01^1^1^3011024^^^^
"KRN",8994,442,1,1,0)
This remote procedure allows the creation of TIU DOCUMENT records.
"KRN",8994,442,2,0)
^8994.02A^9^9
"KRN",8994,442,2,1,0)
DFN^1^^1
"KRN",8994,442,2,1,1,0)
^^1^1^2960708^
"KRN",8994,442,2,1,1,1,0)
This REQUIRED PARAMETER is the pointer to the patient file.
"KRN",8994,442,2,2,0)
TITLE^1^^1
"KRN",8994,442,2,2,1,0)
^^2^2^2960708^
"KRN",8994,442,2,2,1,1,0)
This is the pointer to the TIU DOCUMENT DEFINITION FILE which identifies
"KRN",8994,442,2,2,1,2,0)
the TITLE of the document to be filed.
"KRN",8994,442,2,3,0)
VDT^1^^0
"KRN",8994,442,2,3,1,0)
^^5^5^2960708^
"KRN",8994,442,2,3,1,1,0)
This optional parameter is the Date/time of visit.  If the parameter VSIT
"KRN",8994,442,2,3,1,2,0)
is present, this will be ignored.  Otherwise, the RPC will attempt to
"KRN",8994,442,2,3,1,3,0)
generate a match with a visit based on DFN, VDT, and VLOC (visit
"KRN",8994,442,2,3,1,4,0)
location).  In the event that the RPC cannot generate such a match, a new
"KRN",8994,442,2,3,1,5,0)
EVENT-type Visit will be created with the current date/time.
"KRN",8994,442,2,4,0)
VLOC^1^^0
"KRN",8994,442,2,4,1,0)
^^2^2^2960708^
"KRN",8994,442,2,4,1,1,0)
This optional parameter is the Location of Visit (e.g., Cardiology
"KRN",8994,442,2,4,1,2,0)
Clinic).  It is a pointer to Hospital location (File #44).
"KRN",8994,442,2,5,0)
VSIT^1^^0
"KRN",8994,442,2,5,1,0)
^^2^2^2960708^
"KRN",8994,442,2,5,1,1,0)
This is a pointer to the Visit File (#9000010) entry for the visit to
"KRN",8994,442,2,5,1,2,0)
which the document is to be linked.
"KRN",8994,442,2,6,0)
TIUX^2^^1
"KRN",8994,442,2,6,1,0)
^^3^3^2970616^^
"KRN",8994,442,2,6,1,1,0)
This is the input array in which the identifiers of the document, as well
"KRN",8994,442,2,6,1,2,0)
as its text, are to be stored in the format described for the TIU UPDATE
"KRN",8994,442,2,6,1,3,0)
RECORD RPC.
"KRN",8994,442,2,7,0)
VSTR^1^^0
"KRN",8994,442,2,7,1,0)
^8994.021^4^4^3011024^^^
"KRN",8994,442,2,7,1,1,0)
This parameter identifies the visit location, date/time, and Service
"KRN",8994,442,2,7,1,2,0)
Category (Hospitalization, Ambulatory, Telecommunications, or Event
"KRN",8994,442,2,7,1,3,0)
(HISTORICAL)) in the form of a semi-colon delimited string (e.g.,
"KRN",8994,442,2,7,1,4,0)
"469;2970616.1415;A").
"KRN",8994,442,2,8,0)
SUPPRESS^1^1^0^8
"KRN",8994,442,2,8,1,0)
^8994.021^4^4^3011024^^
"KRN",8994,442,2,8,1,1,0)
BOOLEAN flag indicating whether or not to suppress execution of the COMMIT
"KRN",8994,442,2,8,1,2,0)
ACTION for the document in question. This gives the calling application
"KRN",8994,442,2,8,1,3,0)
control over the circumstances in which the COMMIT CODE should be
"KRN",8994,442,2,8,1,4,0)
executed.
"KRN",8994,442,2,9,0)
NOASF^1^1^0^9
"KRN",8994,442,2,9,1,0)
^^9^9^3020122^
"KRN",8994,442,2,9,1,1,0)
This parameter can optionally be set to 1 to indicate the ASAVE 
"KRN",8994,442,2,9,1,2,0)
cross-reference in the TIU Document file (#8925) should not be set when 
"KRN",8994,442,2,9,1,3,0)
calling this RPC.  The intent of this cross-reference is for telnet type 
"KRN",8994,442,2,9,1,4,0)
sessions where a user could be dropped.  The cross-reference is used to 
"KRN",8994,442,2,9,1,5,0)
provide the user with an easy way to resume editing the TIU Document they 
"KRN",8994,442,2,9,1,6,0)
were working on when they were dropped.  In the Clinical Procedures 
"KRN",8994,442,2,9,1,7,0)
realm, for example, where the stub is created in the 'background' this
"KRN",8994,442,2,9,1,8,0)
cross-reference should not be set since the user is not interactively
"KRN",8994,442,2,9,1,9,0)
involved in the creation of the record.
"KRN",8994,442,2,"B","DFN",1)

"KRN",8994,442,2,"B","NOASF",9)

"KRN",8994,442,2,"B","SUPPRESS",8)

"KRN",8994,442,2,"B","TITLE",2)

"KRN",8994,442,2,"B","TIUX",6)

"KRN",8994,442,2,"B","VDT",3)

"KRN",8994,442,2,"B","VLOC",4)

"KRN",8994,442,2,"B","VSIT",5)

"KRN",8994,442,2,"B","VSTR",7)

"KRN",8994,442,2,"PARAMSEQ",8,8)

"KRN",8994,442,2,"PARAMSEQ",9,9)

"KRN",8994,442,3,0)
^^5^5^2990127^^^^
"KRN",8994,442,3,1,0)
If the call is successful, this will be the record number (IEN) of the
"KRN",8994,442,3,2,0)
resulting entry in the TIU DOCUMENT FILE (#8925).  In the event of a
"KRN",8994,442,3,3,0)
filing error, the first "^"-piece will be zero, and the second "^"-piece
"KRN",8994,442,3,4,0)
of this scalar return variable will be a textual message describing the
"KRN",8994,442,3,5,0)
nature of the error (e.g., 0^Invalid TITLE Selected.").
"KRN",8994,1506,-1)
0^1
"KRN",8994,1506,0)
TIU IS THIS A CLINPROC?^ISCP^TIUCP^1^S
"KRN",8994,1506,1,0)
^^2^2^3010227^
"KRN",8994,1506,1,1,0)
This RPC evaluates whether or not a Title is under the
"KRN",8994,1506,1,2,0)
CLINICAL PROCEDURES Class.
"KRN",8994,1506,2,0)
^8994.02A^1^1
"KRN",8994,1506,2,1,0)
TITLE^1^^1^1
"KRN",8994,1506,2,1,1,0)
^8994.021^1^1^3001219^^^^
"KRN",8994,1506,2,1,1,1,0)
This is the TIU Document file (#8925.1) IEN for the Title selected.
"KRN",8994,1506,2,"B","TITLE",1)

"KRN",8994,1506,2,"PARAMSEQ",1,1)

"KRN",8994,1506,3,0)
^8994.03^4^4^3001219^^^^
"KRN",8994,1506,3,1,0)
A boolean value is returned.
"KRN",8994,1506,3,2,0)
 
"KRN",8994,1506,3,3,0)
1 = True.  The Title is under CLINICAL PROCEDURES Class.
"KRN",8994,1506,3,4,0)
0 = False.  The Title is NOT under the CLINICAL PROCEDURES Class.
"KRN",8994,1507,-1)
0^4
"KRN",8994,1507,0)
TIU IDENTIFY CLINPROC CLASS^CPCLASS^TIUCP^1^S
"KRN",8994,1507,1,0)
^8994.01^2^2^3001219^^
"KRN",8994,1507,1,1,0)
This RPC gets the CLINICAL PROCEDURES TIU Document Definition
"KRN",8994,1507,1,2,0)
file (#8925.1) IEN.
"KRN",8994,1507,3,0)
^^3^3^3001219^
"KRN",8994,1507,3,1,0)
A numeric value is returned.
"KRN",8994,1507,3,2,0)
 
"KRN",8994,1507,3,3,0)
Either the CLINICAL PROCEDURES TIU Document file (#8925.1) IEN or 0.
"KRN",8994,1508,-1)
0^3
"KRN",8994,1508,0)
TIU LONG LIST CLINPROC TITLES^LNGCP^TIUCP^2^S
"KRN",8994,1508,1,0)
^8994.01^2^2^3010227^^^^
"KRN",8994,1508,1,1,0)
This RPC serves data to a longlist of selectable Titles for CLINICAL
"KRN",8994,1508,1,2,0)
PROCEDURES.
"KRN",8994,1508,2,0)
^8994.02A^2^2
"KRN",8994,1508,2,1,0)
FROM^1^^1^1
"KRN",8994,1508,2,1,1,0)
^8994.021^1^1^3001219^^
"KRN",8994,1508,2,1,1,1,0)
This is the reference Title from which the longlist is scrolling.
"KRN",8994,1508,2,2,0)
DIR^1^^^2
"KRN",8994,1508,2,2,1,0)
^8994.021^2^2^3010227^^^^
"KRN",8994,1508,2,2,1,1,0)
This is the direction in which the longlist is scrolling from the
"KRN",8994,1508,2,2,1,2,0)
reference Title.
"KRN",8994,1508,2,"B","DIR",2)

"KRN",8994,1508,2,"B","FROM",1)

"KRN",8994,1508,2,"PARAMSEQ",1,1)

"KRN",8994,1508,2,"PARAMSEQ",2,2)

"KRN",8994,1508,3,0)
^^4^4^3010227^
"KRN",8994,1508,3,1,0)
An array is returned.
"KRN",8994,1508,3,2,0)
 
"KRN",8994,1508,3,3,0)
This is an array of the 44 nearest titles to that indicated by the user in
"KRN",8994,1508,3,4,0)
the direction passed by the longlist component.
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"ORD",9,.84)
.84;9;;;EDEOUT^DIFROMSO(.84,DA,"",XPDA);FPRE^DIFROMSI(.84,"",XPDA);EPRE^DIFROMSI(.84,DA,"",XPDA,"",OLDA);;EPOST^DIFROMSI(.84,DA,"",XPDA);DEL^DIFROMSK(.84,"",%)
"ORD",9,.84,0)
DIALOG
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",193,-1)
1^1
"PKG",193,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",193,20,0)
^9.402P^^
"PKG",193,22,0)
^9.49I^1^1
"PKG",193,22,1,0)
1.0^3010321^3010321^11
"PKG",193,22,1,"PAH",1,0)
109^3020514^1371
"PKG",193,22,1,"PAH",1,1,0)
^^2^2^3020514
"PKG",193,22,1,"PAH",1,1,1,0)
The description on this patch may be found in the National Patch Module
"PKG",193,22,1,"PAH",1,1,2,0)
under TIU*1*109.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
26
"RTN","TIUCHLP")
0^13^B11855881
"RTN","TIUCHLP",1,0)
TIUCHLP ; SLC/SBW - Help for Clinician ;1/15/01@15:45:08
"RTN","TIUCHLP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**3,21,109**;Jun 20, 1997
"RTN","TIUCHLP",3,0)
MAIN ; Control branching
"RTN","TIUCHLP",4,0)
 N DIC,X,Y,TIUI,TIUROOT,TIUFPRIV S TIUFPRIV=1
"RTN","TIUCHLP",5,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUCHLP",6,0)
 S DIC=8925.1,DIC(0)="AEMQZ",DIC("A")="Select DOCUMENT TYPE: "
"RTN","TIUCHLP",7,0)
 S DIC("B")=$G(^DISV(+DUZ,"^TIU(8925.1,"))
"RTN","TIUCHLP",8,0)
 D ^DIC I +Y'>0 D
"RTN","TIUCHLP",9,0)
 . W !!,"Required information for dictation help not set up for this report type."
"RTN","TIUCHLP",10,0)
 I +Y>0 D
"RTN","TIUCHLP",11,0)
 . I $P(TIUPRM0,U,16)="D" S TIUROOT="ITEM"
"RTN","TIUCHLP",12,0)
 . E  I $P(TIUPRM0,U,16)="C" S TIUROOT="HEAD"
"RTN","TIUCHLP",13,0)
 . I $G(TIUROOT)']"" W !!,"Required information for dictation help not set up for this report type." Q
"RTN","TIUCHLP",14,0)
 . W !!,"A Dictated ",$P(Y(0),U),", requires the following:"
"RTN","TIUCHLP",15,0)
 . S TIUI=0
"RTN","TIUCHLP",16,0)
 . F  S TIUI=$O(^TIU(8925.1,+Y,TIUROOT,TIUI)) Q:+TIUI'>0  D
"RTN","TIUCHLP",17,0)
 . . I +$P($G(^TIU(8925.1,+Y,TIUROOT,TIUI,0)),U,6) W !?10,$P($G(^(0)),U,2)
"RTN","TIUCHLP",18,0)
 W !!
"RTN","TIUCHLP",19,0)
 I $$READ^TIUU("YO","Do you want to get patient data","YES") D GETPAT
"RTN","TIUCHLP",20,0)
 Q
"RTN","TIUCHLP",21,0)
GETPAT ; Gets Dictation data for a specific patient
"RTN","TIUCHLP",22,0)
 N TIU,TIUOUT,DFN,SUCCESS,TITLE
"RTN","TIUCHLP",23,0)
 F  D  Q:$D(DUOUT)!$D(DIROUT)!+$G(TIUOUT)
"RTN","TIUCHLP",24,0)
 . S DFN=+$$PATIENT^TIULA
"RTN","TIUCHLP",25,0)
 . D MAIN^TIUMOVE(.TIU,DFN)
"RTN","TIUCHLP",26,0)
 . I $D(TIU) D PATDATA(.TIU)
"RTN","TIUCHLP",27,0)
 . S TIUOUT=$$READ^TIUU("Y","... OK","YES")
"RTN","TIUCHLP",28,0)
 D MAKE^TIUPEFIX(.SUCCESS,DFN,.TITLE,.TIU,$S(+$G(XQADATA):+$G(XQADATA),+$G(BUFDA):+$G(BUFDA),1:""))
"RTN","TIUCHLP",29,0)
 I +SUCCESS S TIUDONE=1
"RTN","TIUCHLP",30,0)
 Q
"RTN","TIUCHLP",31,0)
PATDATA(X) ; Display/validate correct patient/treatment episode
"RTN","TIUCHLP",32,0)
 N DIR,Y
"RTN","TIUCHLP",33,0)
 W !!?1,"Patient: ",$$NAME^TIULS(X("PNM"),"LAST, FIRST MI"),?40,"SSN: ",X("SSN"),?62,"Sex: ",$P(X("SEX"),U,2),!
"RTN","TIUCHLP",34,0)
 W ?4,"Ward: ",$P(X("WARD"),U,2),?39,"Race: ",$E($P(X("RACE"),U,2),1,15),?62,"Age: ",X("AGE"),!
"RTN","TIUCHLP",35,0)
 W "Att Phys: ",$P(X("AMD"),U,2),?34,"Prim Phys: ",$P(X("PMD"),U,2),!
"RTN","TIUCHLP",36,0)
 W "Adm Date: ",$$DATE^TIULS(+X("EDT"),"MM/DD/YY@HR:MIN:SEC")
"RTN","TIUCHLP",37,0)
 W:X("LDT")]"" ?35,"Dis Date: ",$$DATE^TIULS(X("LDT"),"MM/DD/YY")
"RTN","TIUCHLP",38,0)
 W !
"RTN","TIUCHLP",39,0)
 W ?2,"Adm Dx: ",X("ADDX"),!
"RTN","TIUCHLP",40,0)
 I $D(X("DICTDT")) D
"RTN","TIUCHLP",41,0)
 . W !,"A DISCHARGE SUMMARY is already on file:",!
"RTN","TIUCHLP",42,0)
 . W ?2,"Dict'd: ",X("DICTDT"),?41,"By: ",X("AUTHOR"),!
"RTN","TIUCHLP",43,0)
 . W ?2,"Signed: ",X("SIGDT"),?35,"Cosigned: ",X("COSDT"),!
"RTN","TIUCHLP",44,0)
 Q
"RTN","TIUCHLP",45,0)
GETPN ; Help get Fields for PN Dictation/Error Resolution
"RTN","TIUCHLP",46,0)
 N TIU,DFN,TIUY,TITLE
"RTN","TIUCHLP",47,0)
 S DFN=+$$PATIENT^TIULA Q:+DFN'>0
"RTN","TIUCHLP",48,0)
 D ENPN^TIUVSIT(.TIU,+DFN,1)
"RTN","TIUCHLP",49,0)
 I '$D(TIU) Q
"RTN","TIUCHLP",50,0)
 S TIUY=$$CHEKPN(.TIU)
"RTN","TIUCHLP",51,0)
 D MAKE^TIUPEFIX(.SUCCESS,DFN,.TITLE,.TIU,$S(+$G(XQADATA):+$G(XQADATA),+$G(BUFDA):+$G(BUFDA),1:""))
"RTN","TIUCHLP",52,0)
 I +SUCCESS S TIUDONE=1
"RTN","TIUCHLP",53,0)
 Q
"RTN","TIUCHLP",54,0)
CHEKPN(X,TIUBY) ; Display/validate demographic/visit information
"RTN","TIUCHLP",55,0)
 W !!,"Document Identifiers..."
"RTN","TIUCHLP",56,0)
 W !?14,"Patient Name:  ",$S($G(X("PNM"))]"":$G(X("PNM")),1:"UNKNOWN")
"RTN","TIUCHLP",57,0)
 W !?15,"Patient SSN:  ",$S($G(X("SSN"))]"":$G(X("SSN")),1:"UNKNOWN")
"RTN","TIUCHLP",58,0)
 W !?10,"Patient Location:  ",$S(+$G(X("LOC")):$P($G(X("LOC")),U,2),1:"UNKNOWN")
"RTN","TIUCHLP",59,0)
 W !?8,"Date/time of Visit:  ",$S($L($G(X("VSTR"))):$$DATE^TIULS($P(X("VSTR"),";",2),"MM/DD/YY HR:MIN"),1:"UNKNOWN")
"RTN","TIUCHLP",60,0)
 S Y=$$READ^TIUU("YO","   ...OK","YES")
"RTN","TIUCHLP",61,0)
 I $S($D(DIROUT):1,$D(DUOUT):1,$D(DTOUT):1,1:0) Q 0
"RTN","TIUCHLP",62,0)
 I +Y'>0 D
"RTN","TIUCHLP",63,0)
 . K X N TIUINOUT
"RTN","TIUCHLP",64,0)
 . S TIUINOUT=$$INOUT^TIUVSIT
"RTN","TIUCHLP",65,0)
 . I $S($D(DIROUT):1,$D(DUOUT):1,$D(DTOUT):1,1:0) Q
"RTN","TIUCHLP",66,0)
 . I $P(TIUINOUT,U)="o" D MAIN^TIUVSIT(.X,DFN,"","","","",1,"",20,1)
"RTN","TIUCHLP",67,0)
 . I $P(TIUINOUT,U)'="o" D MAIN^TIUMOVE(.X,DFN,"","","",1,"LAST",1)
"RTN","TIUCHLP",68,0)
 . S Y=$S($D(X)>9:$$CHEKPN(.X,.TIUBY),1:0)
"RTN","TIUCHLP",69,0)
 Q Y
"RTN","TIUCNSLT")
0^9^B16233337
"RTN","TIUCNSLT",1,0)
TIUCNSLT ; SLC/JER - Patient movement look-up ;27-MAR-2001 09:40:49
"RTN","TIUCNSLT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**4,31,109**;Jun 20, 1997
"RTN","TIUCNSLT",3,0)
GETCNSLT(DFN,TIUCPF) ; Match consult result to an active request
"RTN","TIUCNSLT",4,0)
 ; Call with:     [DFN] - patient file entry number
"RTN","TIUCNSLT",5,0)
 ;                [TIUCPF] - flag to indicate clinical procedures  (optional)
"RTN","TIUCNSLT",6,0)
 ;   Returns:     TIUY  - Variable pointer to consult request
"RTN","TIUCNSLT",7,0)
AGN ; Loop for handling repeated attempts
"RTN","TIUCNSLT",8,0)
 N TIUI,TIUII,TIUER,TIUOK,TIUOUT,TIUX,TIUY,TIUMTSTR,TIUMLST,TIUCNT,X
"RTN","TIUCNSLT",9,0)
 N TIUOVR
"RTN","TIUCNSLT",10,0)
 I +DFN'>0 S TIUOUT=1 Q 0
"RTN","TIUCNSLT",11,0)
 I +$G(GMRCO) S TIUX=+$G(GMRCO) G GETX
"RTN","TIUCNSLT",12,0)
 I +$P($G(^TIU(8925,+DA,14)),U,5) S TIUX=+$P($G(^(14)),U,5) G GETX
"RTN","TIUCNSLT",13,0)
 I +$$ISADDNDM^TIULC1(+DA) S TIUX=+$$DADCR(DA) G:+TIUX>0 GETX
"RTN","TIUCNSLT",14,0)
 S TIUOVR=+$$ISA^USRLM(DUZ,"MEDICAL INFORMATION SECTION")
"RTN","TIUCNSLT",15,0)
 D SEND^GMRCTIU(DFN,$G(TIUOVR),$G(TIUCPF))
"RTN","TIUCNSLT",16,0)
 ; If no consult requests for patient, then quit
"RTN","TIUCNSLT",17,0)
 I $S($G(^TMP("GMRCR",$J,"TIU",1,0))["No Consults":1,'$D(^TMP("GMRCR",$J,"TIU")):1,1:0) D  Q -1
"RTN","TIUCNSLT",18,0)
 . W !!,$C(7),"No CONSULT REQUESTS to Result for ",$P($G(^DPT(DFN,0)),U),".",!
"RTN","TIUCNSLT",19,0)
 S (TIUCNT,TIUI)=0 F  S TIUI=+$O(^TMP("GMRCR",$J,"TIU",TIUI)) Q:+TIUI'>0  D
"RTN","TIUCNSLT",20,0)
 . S TIUCNT=+$G(TIUCNT)+1
"RTN","TIUCNSLT",21,0)
 W !,"You must link your Result to a Consult Request...",!
"RTN","TIUCNSLT",22,0)
 D  I +TIUER Q:+$G(TIUOUT) 0  G AGN
"RTN","TIUCNSLT",23,0)
 . W !,"The following CONSULT REQUEST"
"RTN","TIUCNSLT",24,0)
 . W $S(+TIUCNT>1:"(S) are",1:" is")," available:"
"RTN","TIUCNSLT",25,0)
 . S (TIUER,TIUOK,TIUI)=0
"RTN","TIUCNSLT",26,0)
 . F  S TIUI=$O(^TMP("GMRCR",$J,"TIU",TIUI)) Q:+TIUI'>0!+TIUER!+TIUOK  D
"RTN","TIUCNSLT",27,0)
 . . S TIUII=TIUI,TIUX=$G(^TMP("GMRCR",$J,"TIU",TIUI,0))
"RTN","TIUCNSLT",28,0)
 . . D WRITE I '(TIUI#5) D BREAK
"RTN","TIUCNSLT",29,0)
 . Q:$D(TIUOUT)
"RTN","TIUCNSLT",30,0)
 . I +TIUER S TIUOUT=1 Q
"RTN","TIUCNSLT",31,0)
 . I TIUII#5 D BREAK Q:$D(TIUOUT)
"RTN","TIUCNSLT",32,0)
 . I +TIUER S TIUOUT=1 Q
"RTN","TIUCNSLT",33,0)
 . S TIUX=$O(^TMP("GMRCR",$J,"TIU","B",+TIUOK,0)),^DISV(DUZ,"^GMR(123,",DFN)=+TIUX
"RTN","TIUCNSLT",34,0)
 . W "  ",+TIUX
"RTN","TIUCNSLT",35,0)
GETX S TIUY=+TIUX_";GMR(123,"
"RTN","TIUCNSLT",36,0)
 Q $G(TIUY)
"RTN","TIUCNSLT",37,0)
BREAK ; Handle prompting
"RTN","TIUCNSLT",38,0)
 W !,"CHOOSE 1-",TIUII W:$D(^TMP("GMRCR",$J,"TIU",TIUII+1,0)) !,"<RETURN> TO CONTINUE",!,"OR '^' TO QUIT" W ": " R X:DTIME
"RTN","TIUCNSLT",39,0)
 I $S('$T!(X["^"):1,X=""&'$D(^TMP("GMRCR",$J,"TIU",TIUII+1)):1,1:0) S TIUER=1 Q
"RTN","TIUCNSLT",40,0)
 I X="" Q
"RTN","TIUCNSLT",41,0)
 I X=" ",$D(^DISV(DUZ,"^GMR(123,",DFN)) S TIUX=^(DFN) I $D(TIUMLST("TIUMVDA",+TIUX)) S TIUOK=+$O(^TMP("GMRCR",$J,"TIU","C",+TIUX,0)) Q
"RTN","TIUCNSLT",42,0)
 I X'=+X!'$D(^TMP("GMRCR",$J,"TIU",+X)) W !!,$C(7),"INVALID RESPONSE",! G BREAK
"RTN","TIUCNSLT",43,0)
 S TIUOK=X
"RTN","TIUCNSLT",44,0)
 Q
"RTN","TIUCNSLT",45,0)
DADCR(DA) ; Get the Consult request associated with the parent record
"RTN","TIUCNSLT",46,0)
 N TIUDADA,TIUY S TIUDADA=$P($G(^TIU(8925,+DA,0)),U,6)
"RTN","TIUCNSLT",47,0)
 S TIUY=$P($G(^TIU(8925,TIUDADA,14)),U,5)
"RTN","TIUCNSLT",48,0)
 Q TIUY
"RTN","TIUCNSLT",49,0)
WRITE W !,TIUX
"RTN","TIUCNSLT",50,0)
 Q
"RTN","TIUCNSLT",51,0)
POST(TIUDA,STATUS) ; Post status updates to Consult Tracking
"RTN","TIUCNSLT",52,0)
 N GMRCDA,DA,TIUAUTH S GMRCDA=+$P($G(^TIU(8925,+TIUDA,14)),U,5)
"RTN","TIUCNSLT",53,0)
 I +GMRCDA'>0 Q
"RTN","TIUCNSLT",54,0)
 S TIUAUTH=$P($G(^TIU(8925,TIUDA,12)),U,2)
"RTN","TIUCNSLT",55,0)
 D GET^GMRCTIU(GMRCDA,TIUDA,STATUS,TIUAUTH)
"RTN","TIUCNSLT",56,0)
 Q 
"RTN","TIUCNSLT",57,0)
ISCNSLT(TIUY,TITLE) ; Boolean RPC to evaluate whether TITLE is a CONSULT
"RTN","TIUCNSLT",58,0)
 N TIUCLASS
"RTN","TIUCNSLT",59,0)
 S TIUCLASS=+$$CLASS
"RTN","TIUCNSLT",60,0)
 I +TIUCLASS'>0 S TIUY=0 Q
"RTN","TIUCNSLT",61,0)
 S TIUY=+$$ISA^TIULX(TITLE,TIUCLASS)
"RTN","TIUCNSLT",62,0)
 Q
"RTN","TIUCNSLT",63,0)
CHANGE(TIUDA,TIUCPF) ; Re-direct the TIU Document to a different CT Record
"RTN","TIUCNSLT",64,0)
 N DA,DFN,DIE,DR,GMRCO,GMRCSTAT,GMRCVP,TIUD0,TIUD14
"RTN","TIUCNSLT",65,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD14=$G(^(14))
"RTN","TIUCNSLT",66,0)
 S DFN=$P(TIUD0,U,2),GMRCO=$P(TIUD14,U,5)
"RTN","TIUCNSLT",67,0)
 Q:+DFN'>0
"RTN","TIUCNSLT",68,0)
 I +GMRCO D ROLLBACK(TIUDA) K GMRCO
"RTN","TIUCNSLT",69,0)
CHAGN S DA=TIUDA
"RTN","TIUCNSLT",70,0)
 W ! S GMRCVP=+$$GETCNSLT(DFN,$G(TIUCPF))_";GMR(123,"
"RTN","TIUCNSLT",71,0)
 I +GMRCVP=0 W !!,$C(7),"You must select a Consult Request...Restoring record.",! W:$$READ^TIUU("EA","Press RETURN to continue...") ""
"RTN","TIUCNSLT",72,0)
 I +GMRCVP'>0 D RETREAT(TIUDA,TIUD14) S TIUPOP=1 Q
"RTN","TIUCNSLT",73,0)
 S DIE=8925,DA=TIUDA,DR="1405////^S X=GMRCVP" D ^DIE
"RTN","TIUCNSLT",74,0)
 S GMRCO=+GMRCVP,GMRCSTAT=$S($P(TIUD0,U,5)>6:"COMPLETED",1:"INCOMPLETE")
"RTN","TIUCNSLT",75,0)
 D POST(TIUDA,GMRCSTAT)
"RTN","TIUCNSLT",76,0)
 Q
"RTN","TIUCNSLT",77,0)
RETREAT(DA,TIUD14) ; If Pt has no requests, retreat gracefully
"RTN","TIUCNSLT",78,0)
 N DIE,DR,GMRCO,GMRCSTAT
"RTN","TIUCNSLT",79,0)
 S DIE=8925,DR="1405////^S X=$P(TIUD14,U,5)" D ^DIE
"RTN","TIUCNSLT",80,0)
 S GMRCO=+$P(TIUD14,U,5)
"RTN","TIUCNSLT",81,0)
 S GMRCSTAT=$S($P(TIUD0,U,5)>6:"COMPLETED",1:"INCOMPLETE")
"RTN","TIUCNSLT",82,0)
 D POST(TIUDA,GMRCSTAT)
"RTN","TIUCNSLT",83,0)
 Q
"RTN","TIUCNSLT",84,0)
ROLLBACK(TIUDA) ; Roll back CT Record when TIU changes require it
"RTN","TIUCNSLT",85,0)
 N GMRCDA,DIE,DR,DA S GMRCDA=+$P($G(^TIU(8925,TIUDA,14)),U,5)
"RTN","TIUCNSLT",86,0)
 Q:+GMRCDA'>0
"RTN","TIUCNSLT",87,0)
 D ROLLBACK^GMRCTIU1(GMRCDA,TIUDA)
"RTN","TIUCNSLT",88,0)
 S DIE="^TIU(8925,",DA=TIUDA,DR="1405///@" D ^DIE
"RTN","TIUCNSLT",89,0)
 Q
"RTN","TIUCNSLT",90,0)
CLASS() ; What is the TIU Class (or Document Class) for CONSULTS
"RTN","TIUCNSLT",91,0)
 N GMRCY
"RTN","TIUCNSLT",92,0)
 S GMRCY=+$O(^TIU(8925.1,"B","CONSULTS",0))
"RTN","TIUCNSLT",93,0)
 I +GMRCY>0,$S($P($G(^TIU(8925.1,+GMRCY,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S GMRCY=0
"RTN","TIUCNSLT",94,0)
 Q GMRCY
"RTN","TIUCP")
0^2^B1179203
"RTN","TIUCP",1,0)
TIUCP ;SLC/RMO - Clinical Procedures API(s) and RPC(s) ;12/18/00@10:54:20
"RTN","TIUCP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**109**;Jun 20, 1997
"RTN","TIUCP",3,0)
 ;
"RTN","TIUCP",4,0)
CLASS() ;Get the CLINICAL PROCEDURES TIU Document Definition file (#8925.1) IEN
"RTN","TIUCP",5,0)
 ; Input  -- None    
"RTN","TIUCP",6,0)
 ; Output -- TIU Document Definition file (#8925.1) IEN
"RTN","TIUCP",7,0)
 N Y
"RTN","TIUCP",8,0)
 S Y=+$O(^TIU(8925.1,"B","CLINICAL PROCEDURES",0))
"RTN","TIUCP",9,0)
 Q Y
"RTN","TIUCP",10,0)
 ;
"RTN","TIUCP",11,0)
ISCP(TIUY,TITLE) ;RPC that evaluates whether or not a Title is under
"RTN","TIUCP",12,0)
 ;the CLINICAL PROCEDURES Class 
"RTN","TIUCP",13,0)
 ; Input  -- TITLE    TIU Document Definition file (#8925.1) IEN
"RTN","TIUCP",14,0)
 ; Output -- TIUY     1=True and 0=False
"RTN","TIUCP",15,0)
 N TIUCLASS
"RTN","TIUCP",16,0)
 ;
"RTN","TIUCP",17,0)
 ;Exit if a Title is not defined
"RTN","TIUCP",18,0)
 I +$G(TITLE)'>0 S TIUY=0 G ISCPQ
"RTN","TIUCP",19,0)
 ;
"RTN","TIUCP",20,0)
 ;Get CLINICAL PROCEDURES TIU Document Definition file (#8925.1) IEN
"RTN","TIUCP",21,0)
 S TIUCLASS=+$$CLASS
"RTN","TIUCP",22,0)
 ;
"RTN","TIUCP",23,0)
 ;Exit if the CLINICAL PROCEDURES Class is not found
"RTN","TIUCP",24,0)
 I +TIUCLASS'>0 S TIUY=0 G ISCPQ
"RTN","TIUCP",25,0)
 ;
"RTN","TIUCP",26,0)
 ;Check if the Title is under the CLINICAL PROCEDURES Class
"RTN","TIUCP",27,0)
 S TIUY=+$$ISA^TIULX(TITLE,TIUCLASS)
"RTN","TIUCP",28,0)
ISCPQ Q
"RTN","TIUCP",29,0)
 ;
"RTN","TIUCP",30,0)
CPCLASS(Y) ;RPC that gets the CLINICAL PROCEDURES TIU Document
"RTN","TIUCP",31,0)
 ;Definition file (#8925.1) IEN
"RTN","TIUCP",32,0)
 ; Input  -- None
"RTN","TIUCP",33,0)
 ; Output -- Y        TIU Document Definition file (#8925.1) IEN
"RTN","TIUCP",34,0)
 S Y=$$CLASS
"RTN","TIUCP",35,0)
 Q
"RTN","TIUCP",36,0)
 ;
"RTN","TIUCP",37,0)
LNGCP(Y,FROM,DIR) ;RPC that serves data to a longlist of selectable Titles
"RTN","TIUCP",38,0)
 ; Input  -- FROM     Reference Title from which the longlist is
"RTN","TIUCP",39,0)
 ;                    scrolling
"RTN","TIUCP",40,0)
 ;           DIR      Direction from which the longlist is scrolling
"RTN","TIUCP",41,0)
 ;                    from the reference Title  (Optional- default 1)
"RTN","TIUCP",42,0)
 ; Output -- Y        An array of the 44 nearest Titles to that indicated
"RTN","TIUCP",43,0)
 ;                    by the user in the direction passed by the longlist
"RTN","TIUCP",44,0)
 ;                    component
"RTN","TIUCP",45,0)
 N TIUCLASS
"RTN","TIUCP",46,0)
 ;
"RTN","TIUCP",47,0)
 ;Exit if a reference Title is not defined
"RTN","TIUCP",48,0)
 I '$D(FROM) G LNGCPQ
"RTN","TIUCP",49,0)
 ;
"RTN","TIUCP",50,0)
 ;Get CLINICAL PROCEDURES TIU Document Definition file (#8925.1) IEN
"RTN","TIUCP",51,0)
 S TIUCLASS=+$$CLASS
"RTN","TIUCP",52,0)
 ;
"RTN","TIUCP",53,0)
 ;Exit if the CLINICAL PROCEDURES Class is not found
"RTN","TIUCP",54,0)
 I +TIUCLASS'>0 G LNGCPQ
"RTN","TIUCP",55,0)
 ;
"RTN","TIUCP",56,0)
 ;Get the longlist of Titles for the CLINICAL PROCEDURES Class
"RTN","TIUCP",57,0)
 D LONGLIST^TIUSRVD(.Y,TIUCLASS,FROM,$G(DIR,1))
"RTN","TIUCP",58,0)
LNGCPQ Q
"RTN","TIUCPCL")
0^10^B828734
"RTN","TIUCPCL",1,0)
TIUCPCL ; SLC/RMO - Clinical Procedure Class Action Entry Points ; 7-MAR-2001 15:20:41
"RTN","TIUCPCL",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**109**;Jun 20, 1997
"RTN","TIUCPCL",3,0)
 ;
"RTN","TIUCPCL",4,0)
POST(TIUDA,STATUS) ;Executed when the document is "committed" to the
"RTN","TIUCPCL",5,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUCPCL",6,0)
 ;           STATUS   TIU Status file (#8925.6) Name field (#.01)
"RTN","TIUCPCL",7,0)
 ; Output -- None
"RTN","TIUCPCL",8,0)
 ;database (i.e., when the document is saved, and prior to release,
"RTN","TIUCPCL",9,0)
 ;verification or signature) or "post-signature" (i.e., following
"RTN","TIUCPCL",10,0)
 ;signature or co-signature).
"RTN","TIUCPCL",11,0)
 ;
"RTN","TIUCPCL",12,0)
 ;Invoke TIU API for Consult Tracking
"RTN","TIUCPCL",13,0)
 D POST^TIUCNSLT(TIUDA,STATUS)
"RTN","TIUCPCL",14,0)
 ;
"RTN","TIUCPCL",15,0)
 ;If Clinical Procedures is installed, invoke Clinical Procedures API
"RTN","TIUCPCL",16,0)
 I $$VERSION^XPDUTL("CLINICAL PROCEDURES"),$$TIUCOMP^MDAPI(TIUDA)
"RTN","TIUCPCL",17,0)
 Q
"RTN","TIUCPCL",18,0)
 ;
"RTN","TIUCPCL",19,0)
CHANGE(TIUDA) ;Executed when a document with a link to a client application
"RTN","TIUCPCL",20,0)
 ;is reassigned.
"RTN","TIUCPCL",21,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUCPCL",22,0)
 ; Output -- None
"RTN","TIUCPCL",23,0)
 ;
"RTN","TIUCPCL",24,0)
 ;Invoke TIU API for Consult Tracking
"RTN","TIUCPCL",25,0)
 D CHANGE^TIUCNSLT(TIUDA,1)
"RTN","TIUCPCL",26,0)
 Q
"RTN","TIUCPCL",27,0)
 ;
"RTN","TIUCPCL",28,0)
ROLLBACK(TIUDA) ;Executed upon deletion of a document.
"RTN","TIUCPCL",29,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUCPCL",30,0)
 ; Output -- None
"RTN","TIUCPCL",31,0)
 ;
"RTN","TIUCPCL",32,0)
 ;Invoke TIU API for Consult Tracking
"RTN","TIUCPCL",33,0)
 D ROLLBACK^TIUCNSLT(TIUDA)
"RTN","TIUCPCL",34,0)
 ;
"RTN","TIUCPCL",35,0)
 ;If Clinical Procedures is installed, invoke Clinical Procedures API
"RTN","TIUCPCL",36,0)
 I $$VERSION^XPDUTL("CLINICAL PROCEDURES"),$$TIUDEL^MDAPI(TIUDA)
"RTN","TIUCPCL",37,0)
 Q
"RTN","TIUCPFIX")
0^16^B56333160
"RTN","TIUCPFIX",1,0)
TIUCPFIX ; SLC/JER,RMO - Resolve Filing errors for CP Documents ;10/30/01
"RTN","TIUCPFIX",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**109**;Jun 20, 1997
"RTN","TIUCPFIX",3,0)
 ; This routine is a modified version of TIUPEFIX
"RTN","TIUCPFIX",4,0)
MAKE(SUCCESS,DFN,TITLE,TIU,TIUBUF,TIUPLDA) ; File new TIU Document
"RTN","TIUCPFIX",5,0)
 ; SUCCESS = (by ref) SUCCESS Returns TIU DOCUMENT # (PTR to 8925)
"RTN","TIUCPFIX",6,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUCPFIX",7,0)
 ; DFN     = Patient (#2)
"RTN","TIUCPFIX",8,0)
 ; TITLE   = Pointer to TIU Document Definition (#8925.1)
"RTN","TIUCPFIX",9,0)
 ; TIU     = Array of demographic and visit attributes
"RTN","TIUCPFIX",10,0)
 ; TIUBUF  = Record number (ien) of entry in TIU Buffer file (#8925.2)
"RTN","TIUCPFIX",11,0)
 ; TIUPLDA = Record number (ien) of entry in TIU Document file (#8925)  (Optional)
"RTN","TIUCPFIX",12,0)
 ;
"RTN","TIUCPFIX",13,0)
 ; -- first, get TIU Document record --
"RTN","TIUCPFIX",14,0)
 ;
"RTN","TIUCPFIX",15,0)
 N TIUDA,LDT,NEWREC,TIUX,TIUTYP,TIUDPRM,HAPPY,TIUCLASS,TIUDTYP,TIUPOST
"RTN","TIUCPFIX",16,0)
 N TIUDFLT,TIUREC,TIUCNNBR,TIUDNB,TIUDTP,TIUPSC,TIUQUIT
"RTN","TIUCPFIX",17,0)
 S SUCCESS=0 ; Initialize SUCCESS to false
"RTN","TIUCPFIX",18,0)
 I '$G(TIUPLDA) D  G MAKEQ:$G(TIUQUIT)
"RTN","TIUCPFIX",19,0)
 . I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,+$G(TIUTYPE)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) S TIUQUIT=1 Q
"RTN","TIUCPFIX",20,0)
 . ; If target file is not 8925 QUIT
"RTN","TIUCPFIX",21,0)
 . I +$G(^TIU(8925.1,+TIUTYPE,1))'=8925 S TIUQUIT=1 Q
"RTN","TIUCPFIX",22,0)
 . S TIUDTYP=$P($G(^TIU(8925.1,+TIUTYPE,0)),U,4)
"RTN","TIUCPFIX",23,0)
 . S TIUCLASS=$S(TIUDTYP="CL":+TIUTYPE,1:38)
"RTN","TIUCPFIX",24,0)
 . S TIUDFLT=$S(TIUCLASS'=TIUTYPE:TIUTYPE,1:"")
"RTN","TIUCPFIX",25,0)
 . I +$G(TITLE)'>0 S TITLE=$$ASKTITLE^TIULA3(TIUCLASS,TIUDFLT)
"RTN","TIUCPFIX",26,0)
 . I +TITLE'>0 S TIUQUIT=1 Q
"RTN","TIUCPFIX",27,0)
 ELSE  D
"RTN","TIUCPFIX",28,0)
 . S TITLE=+$G(^TIU(8925,+TIUPLDA,0))
"RTN","TIUCPFIX",29,0)
 S TIUTYP=TITLE,TIUTYP(1)=1_U_TITLE
"RTN","TIUCPFIX",30,0)
 D DOCPRM^TIULC1(TITLE,.TIUDPRM)
"RTN","TIUCPFIX",31,0)
 ;
"RTN","TIUCPFIX",32,0)
 ; -- second, load the header elements & text into TIUX array
"RTN","TIUCPFIX",33,0)
 ;
"RTN","TIUCPFIX",34,0)
 D LOADTIUX(.TIUX,TIUBUF)
"RTN","TIUCPFIX",35,0)
 ;
"RTN","TIUCPFIX",36,0)
 ;Set variables
"RTN","TIUCPFIX",37,0)
 I $G(TIUPLDA) D
"RTN","TIUCPFIX",38,0)
 . S TIUCNNBR=+$P($G(^TIU(8925,+TIUPLDA,14)),U,5)
"RTN","TIUCPFIX",39,0)
 ELSE  D
"RTN","TIUCPFIX",40,0)
 . S TIUCNNBR=$S(+$P($G(TIUX(1405)),"C.",2):+$P($G(TIUX(1405)),"C.",2),1:"")
"RTN","TIUCPFIX",41,0)
 . S:$G(TIUX(.001)) TIUPLDA=$G(TIUX(.001))
"RTN","TIUCPFIX",42,0)
 S TIUPSC=$G(TIUX(70201))
"RTN","TIUCPFIX",43,0)
 S TIUDTP=$G(TIUX(70202))
"RTN","TIUCPFIX",44,0)
 ;
"RTN","TIUCPFIX",45,0)
 ;Check consult associated with document
"RTN","TIUCPFIX",46,0)
 I '$$CHKCN^TIUPUTCP(TIUCNNBR,DFN,$G(TIUPLDA),.TIUDNB) S SUCCESS="0^"_$$EZBLD^DIALOG($G(TIUDNB)) G MAKEQ
"RTN","TIUCPFIX",47,0)
 ;
"RTN","TIUCPFIX",48,0)
 ;Check consult as it related to CP
"RTN","TIUCPFIX",49,0)
 I '$$CHKCP^TIUPUTCP(TIUCNNBR,$G(TIUPLDA),.TIUDNB) S SUCCESS="0^"_$$EZBLD^DIALOG($G(TIUDNB)) G MAKEQ
"RTN","TIUCPFIX",50,0)
 ;
"RTN","TIUCPFIX",51,0)
 ;If TIU document IEN is defined use it, otherwise call TIUEDI3
"RTN","TIUCPFIX",52,0)
 I $G(TIUPLDA) D
"RTN","TIUCPFIX",53,0)
 . S TIUDA=TIUPLDA
"RTN","TIUCPFIX",54,0)
 ELSE  D
"RTN","TIUCPFIX",55,0)
 . S TIUDA=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.NEWREC,.TIUDPRM)
"RTN","TIUCPFIX",56,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) G MAKEQ
"RTN","TIUCPFIX",57,0)
 I +$$CANEDIT^TIUPUTU(TIUDA)'>0 D  G MAKEX
"RTN","TIUCPFIX",58,0)
 . D MAKEADD(.TIUADD,+TIUDA,TIUBUF) S SUCCESS=TIUADD
"RTN","TIUCPFIX",59,0)
 S SUCCESS=1
"RTN","TIUCPFIX",60,0)
 ;
"RTN","TIUCPFIX",61,0)
 D STUFREC(TIUDA,$G(DFN),$G(PARENT),.TIU,$G(TIUPSC),$G(TIUDTP),$G(TIUPLDA))
"RTN","TIUCPFIX",62,0)
 ;
"RTN","TIUCPFIX",63,0)
 ; -- third, file the data in TIU Document record --
"RTN","TIUCPFIX",64,0)
 ;
"RTN","TIUCPFIX",65,0)
 K ^TIU(8925,+TIUDA,"TEMP"),TIUX(.01),TIUX(.02),TIUX(.03),TIUX(.05)
"RTN","TIUCPFIX",66,0)
 K TIUX(.13),TIUX(1205),TIUX(1211),TIUX(.001),TIUX(70201),TIUX(70202)
"RTN","TIUCPFIX",67,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUCPFIX",68,0)
 D FILE(.HAPPY,+TIUDA,.TIUX,TIUTYP)
"RTN","TIUCPFIX",69,0)
 D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUCPFIX",70,0)
 S TIUPOST=$$POSTFILE^TIULC1(TITLE)
"RTN","TIUCPFIX",71,0)
 S TIUREC("#")=TIUDA
"RTN","TIUCPFIX",72,0)
 I TIUPOST]"" X TIUPOST
"RTN","TIUCPFIX",73,0)
MAKEX D ALERTDEL^TIUPEVNT(+TIUBUF)
"RTN","TIUCPFIX",74,0)
 D RESOLVE^TIUPEVNT($S($D(XQADATA):+$P(XQADATA,";",3),1:$G(ERRDA)),1)
"RTN","TIUCPFIX",75,0)
 D BUFPURGE^TIUPUTC(+TIUBUF)
"RTN","TIUCPFIX",76,0)
 K ^TIU(8925,+TIUDA,"TEMP") W "Done."
"RTN","TIUCPFIX",77,0)
 I +$G(TIUDA),+$D(^TIU(8925,+$G(TIUDA),0)) D
"RTN","TIUCPFIX",78,0)
 . N TIU D GETTIU^TIULD(.TIU,+TIUDA)
"RTN","TIUCPFIX",79,0)
 . D EN^VALM("TIU BROWSE FOR MRT")
"RTN","TIUCPFIX",80,0)
MAKEQ Q
"RTN","TIUCPFIX",81,0)
LOADTIUX(TIUARR,TIUBUF) ; Load TIUX array with header and text
"RTN","TIUCPFIX",82,0)
 N TIUI,TIUHSIG,TIUBGN,TIULINE,X,Y,TYPE I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUCPFIX",83,0)
 S TIUHSIG=$P(TIUPRM0,U,10),TIUBGN=$P(TIUPRM0,U,12)
"RTN","TIUCPFIX",84,0)
 S TIUI=0 F  S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUCPFIX",85,0)
 . S TIULINE=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0))
"RTN","TIUCPFIX",86,0)
 . I TIULINE[TIUHSIG D
"RTN","TIUCPFIX",87,0)
 . . N TIUD1,TIUD4
"RTN","TIUCPFIX",88,0)
 . . S X=$$STRIP^TIULS($P(TIULINE,":",2)),Y=$$WHATYPE^TIUPUTU(X)
"RTN","TIUCPFIX",89,0)
 . . I +Y'>0 D MAIN^TIUPEVNT(TIUBUF,1,3,X) Q
"RTN","TIUCPFIX",90,0)
 . . S TIUD1=$G(^TIU(8925.1,+Y,1)),TIUD4=$G(^TIU(8925.1,+Y,4))
"RTN","TIUCPFIX",91,0)
 . . S TYPE=+Y
"RTN","TIUCPFIX",92,0)
 . . F  D  Q:TIULINE[TIUBGN!(+TIUI'>0)
"RTN","TIUCPFIX",93,0)
 . . . N TIUN,TIUCAP,TIUFLD,TIUREQ S TIUREQ=0
"RTN","TIUCPFIX",94,0)
 . . . S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0
"RTN","TIUCPFIX",95,0)
 . . . S TIULINE=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0)) Q:TIULINE[TIUBGN
"RTN","TIUCPFIX",96,0)
 . . . S TIUCAP=$P(TIULINE,":") Q:TIUCAP']""
"RTN","TIUCPFIX",97,0)
 . . . S TIUN=$O(^TIU(8925.1,+TYPE,"HEAD","B",TIUCAP,0))
"RTN","TIUCPFIX",98,0)
 . . . Q:+TIUN'>0
"RTN","TIUCPFIX",99,0)
 . . . S TIUFLD=$P(^TIU(8925.1,+TYPE,"HEAD",+TIUN,0),U,3)
"RTN","TIUCPFIX",100,0)
 . . . Q:TIUFLD']""
"RTN","TIUCPFIX",101,0)
 . . . S TIUREQ=$P(^TIU(8925.1,+TYPE,"HEAD",+TIUN,0),U,7)
"RTN","TIUCPFIX",102,0)
 . . . S TIUARR(TIUFLD)=$$STRIP^TIULS($P(TIULINE,":",2,99))
"RTN","TIUCPFIX",103,0)
 . . . S:TIUFLD'=.001 TIUARR(TIUFLD)=$$TRNSFRM(+TYPE,TIUFLD,TIUARR(TIUFLD))
"RTN","TIUCPFIX",104,0)
 . . . I +TIUREQ,TIUARR(TIUFLD)="" S TIUARR(TIUFLD)="** REQUIRED FIELD MISSING FROM UPLOAD **"
"RTN","TIUCPFIX",105,0)
 . . . I $S(TIUFLD=.01:1,TIUFLD=.02:1,TIUFLD=.07:1,TIUFLD=1301:1,1:0) K TIUARR(TIUFLD)
"RTN","TIUCPFIX",106,0)
 . . I TIULINE[TIUBGN D
"RTN","TIUCPFIX",107,0)
 . . . N TIUJ S TIUJ=0
"RTN","TIUCPFIX",108,0)
 . . . F  D  Q:+TIUI'>0
"RTN","TIUCPFIX",109,0)
 . . . . S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0
"RTN","TIUCPFIX",110,0)
 . . . . S TIUJ=TIUJ+1
"RTN","TIUCPFIX",111,0)
 . . . . S TIUARR("TEXT",TIUJ,0)=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0))
"RTN","TIUCPFIX",112,0)
 Q
"RTN","TIUCPFIX",113,0)
STUFREC(DA,DFN,PARENT,TIU,TIUPSC,TIUDTP,TIUPLDA) ; Stuff fixed field data
"RTN","TIUCPFIX",114,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIURDT,TIUPSCI,TIUDTPI
"RTN","TIUCPFIX",115,0)
 S IENS=""""_DA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="K"
"RTN","TIUCPFIX",116,0)
 I +$G(PARENT)'>0 D
"RTN","TIUCPFIX",117,0)
 . I '$G(TIUPLDA) D
"RTN","TIUCPFIX",118,0)
 . . S @FDARR@(.02)=$G(DFN),@FDARR@(.03)=$P($G(TIU("VISIT")),U)
"RTN","TIUCPFIX",119,0)
 . . S @FDARR@(.07)=$P(TIU("EDT"),U)
"RTN","TIUCPFIX",120,0)
 . . S @FDARR@(1401)=$P($G(TIU("AD#")),U),@FDARR@(1402)=$P($G(TIU("TS")),U)
"RTN","TIUCPFIX",121,0)
 . . S @FDARR@(1201)=$$NOW^TIULC
"RTN","TIUCPFIX",122,0)
 . . S @FDARR@(1205)=$S(+$P($G(TIU("LOC")),U):$P($G(TIU("LOC")),U),1:$P($G(TIU("VLOC")),U))
"RTN","TIUCPFIX",123,0)
 . . S @FDARR@(1404)=$P($G(TIU("SVC")),U)
"RTN","TIUCPFIX",124,0)
 . S @FDARR@(.05)=$S(+$$REQVER(+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUCPFIX",125,0)
 . S @FDARR@(.08)=$P(TIU("LDT"),U)
"RTN","TIUCPFIX",126,0)
 I +$G(PARENT)>0 D
"RTN","TIUCPFIX",127,0)
 . S @FDARR@(.02)=+$P(^TIU(8925,+PARENT,0),U,2)
"RTN","TIUCPFIX",128,0)
 . S @FDARR@(.03)=$P(^TIU(8925,+PARENT,0),U,3)
"RTN","TIUCPFIX",129,0)
 . S @FDARR@(.05)=$S(+$$REQVER(+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUCPFIX",130,0)
 . S @FDARR@(.06)=PARENT
"RTN","TIUCPFIX",131,0)
 . S @FDARR@(.07)=$P($G(TIU("EDT")),U),@FDARR@(.08)=$P($G(TIU("LDT")),U)
"RTN","TIUCPFIX",132,0)
 . S @FDARR@(1205)=$P($G(^TIU(8925,+PARENT,12)),U,5)
"RTN","TIUCPFIX",133,0)
 . S @FDARR@(1401)=$P($G(^TIU(8925,+PARENT,14)),U)
"RTN","TIUCPFIX",134,0)
 . S @FDARR@(1402)=$P($G(^TIU(8925,+PARENT,14)),U,2)
"RTN","TIUCPFIX",135,0)
 . S @FDARR@(1404)=$P($G(^TIU(8925,+PARENT,14)),U,4)
"RTN","TIUCPFIX",136,0)
 . S @FDARR@(1201)=$$NOW^XLFDT
"RTN","TIUCPFIX",137,0)
 I +$G(TIU("LDT")) S TIURDT=+$G(TIU("LDT"))
"RTN","TIUCPFIX",138,0)
 I +$G(TIU("LDT"))'>0 D
"RTN","TIUCPFIX",139,0)
 . S TIUDICDT=+$$IDATE^TIULC($G(TIUDICDT))
"RTN","TIUCPFIX",140,0)
 . I +TIUDICDT,($P(TIUDICDT,".",2)'>0) D
"RTN","TIUCPFIX",141,0)
 . . S TIUDICDT=$S($P(TIU("VSTR"),";",3)'="H":$P($G(TIU("EDT")),U),1:"")
"RTN","TIUCPFIX",142,0)
 . S TIURDT=$S(+$G(TIUDICDT)>0:+$G(TIUDICDT),1:+$$NOW^TIULC)
"RTN","TIUCPFIX",143,0)
 . S:+$G(TIUTYPE)=1 @FDARR@(.12)=1
"RTN","TIUCPFIX",144,0)
 . K TIUDICDT
"RTN","TIUCPFIX",145,0)
 I '$G(TIUPLDA) S @FDARR@(1301)=TIURDT
"RTN","TIUCPFIX",146,0)
 S @FDARR@(1303)="U"
"RTN","TIUCPFIX",147,0)
 I $G(TIUPSC)]"" D VAL^DIE(8925,DA,70201,,TIUPSC,.TIUPSCI)
"RTN","TIUCPFIX",148,0)
 S @FDARR@(70201)=$S($G(TIUPSCI):TIUPSCI,1:"")
"RTN","TIUCPFIX",149,0)
 I '$G(TIUPLDA)!($P($G(^TIU(8925,+$G(TIUPLDA),702)),U,2))="" D
"RTN","TIUCPFIX",150,0)
 . I $G(TIUDTP)]"" D VAL^DIE(8925,DA,70202,,TIUDTP,.TIUDTPI)
"RTN","TIUCPFIX",151,0)
 . S @FDARR@(70202)=$S($G(TIUDTPI):TIUDTPI,1:"")
"RTN","TIUCPFIX",152,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG")
"RTN","TIUCPFIX",153,0)
 Q
"RTN","TIUCPFIX",154,0)
REQVER(VPARM) ; Evaluate whether verification is required
"RTN","TIUCPFIX",155,0)
 Q $S(VPARM=1:1,VPARM=2:1,1:0)
"RTN","TIUCPFIX",156,0)
MAKEADD(TIUDADD,TIUDA,TIUBUF) ; Create an addendum record
"RTN","TIUCPFIX",157,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUCAN,TIUFPRIV,TIU,TIUX S TIUFPRIV=1
"RTN","TIUCPFIX",158,0)
 N TIUDTTL,TIUPOST,TIUREC
"RTN","TIUCPFIX",159,0)
 S TIUDTTL=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUCPFIX",160,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM")
"RTN","TIUCPFIX",161,0)
 S (DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUCPFIX",162,0)
 D ^DIC
"RTN","TIUCPFIX",163,0)
 S TIUDADD=+Y
"RTN","TIUCPFIX",164,0)
 I +Y'>0 S TIUDADD=TIUDADD_"^Could not create addendum." Q
"RTN","TIUCPFIX",165,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUCPFIX",166,0)
 S TIU("DOCTYP")=TIUATYP_U_$$PNAME^TIULC1(TIUATYP)
"RTN","TIUCPFIX",167,0)
 D STUFREC(TIUDADD,DFN,+TIUDA,.TIU)
"RTN","TIUCPFIX",168,0)
 D LOADTIUX(.TIUX,TIUBUF)
"RTN","TIUCPFIX",169,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUCPFIX",170,0)
 M ^TIU(8925,+TIUDADD,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUCPFIX",171,0)
 D FILE(.SUCCESS,+TIUDADD,.TIUX,TIUATYP)
"RTN","TIUCPFIX",172,0)
 D MERGTEXT^TIUEDI1(+TIUDADD,.TIU)
"RTN","TIUCPFIX",173,0)
 S TIUPOST=$$POSTFILE^TIULC1(TIUDTTL)
"RTN","TIUCPFIX",174,0)
 S TIUREC("#")=TIUDADD
"RTN","TIUCPFIX",175,0)
 I TIUPOST]"" X TIUPOST
"RTN","TIUCPFIX",176,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUCPFIX",177,0)
 Q
"RTN","TIUCPFIX",178,0)
FILE(SUCCESS,TIUDA,TIUX,RTYPE) ; Call FM Filer to commit updates to DB
"RTN","TIUCPFIX",179,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG
"RTN","TIUCPFIX",180,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="KE"
"RTN","TIUCPFIX",181,0)
 M @FDARR=TIUX
"RTN","TIUCPFIX",182,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUCPFIX",183,0)
 I $D(TIUMSG)>9 D
"RTN","TIUCPFIX",184,0)
 . S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1))
"RTN","TIUCPFIX",185,0)
 . D MAIN^TIUPEVNT(TIUBUF,2,"",$P($G(^TIU(8925.1,+RTYPE,0)),U),.FDA,.TIUMSG)
"RTN","TIUCPFIX",186,0)
 E  S SUCCESS=TIUDA
"RTN","TIUCPFIX",187,0)
 Q
"RTN","TIUCPFIX",188,0)
TRNSFRM(RTYPE,FLD,X) ; Executes Transform code for a given header field
"RTN","TIUCPFIX",189,0)
 N XFORM
"RTN","TIUCPFIX",190,0)
 S FLD=$O(^TIU(8925.1,+RTYPE,"HEAD","D",+FLD,0))
"RTN","TIUCPFIX",191,0)
 I +FLD'>0 G TRNSFRMX
"RTN","TIUCPFIX",192,0)
 S XFORM=$G(^TIU(8925.1,+RTYPE,"HEAD",+FLD,1))
"RTN","TIUCPFIX",193,0)
 I XFORM']"" G TRNSFRMX
"RTN","TIUCPFIX",194,0)
 X XFORM
"RTN","TIUCPFIX",195,0)
TRNSFRMX Q X
"RTN","TIUEDI4")
0^26^B48842233
"RTN","TIUEDI4",1,0)
TIUEDI4 ; SLC/JER - Enter/Edit a Document ; 7-FEB-2001 08:01:51
"RTN","TIUEDI4",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**100,109**;Jun 20, 1997
"RTN","TIUEDI4",3,0)
 ;new rtn in TSC, created feb 2 from TIUEDIT
"RTN","TIUEDI4",4,0)
 ; 2/2: Moved LOADDFLT, BOIL, CANXEC, REPLACE, INSMULT to TIUEDI4
"RTN","TIUEDI4",5,0)
 ; 2/3 moved DIE, TEXTEDIT from TIUEDIT to TIUEDI4
"RTN","TIUEDI4",6,0)
 ; 3/2 moved SETTL, GETVST, ASKOK from TIUEDIT to TIUEDI4
"RTN","TIUEDI4",7,0)
 ;
"RTN","TIUEDI4",8,0)
SETTL(TIUTYP,TIUCLASS,TIUTITLE) ; Set array TIUTYP w/ title info
"RTN","TIUEDI4",9,0)
 ;  e.g. TIUTYP(1) = 1^113^CRISIS, where 113 is IFN of CRISIS title,
"RTN","TIUEDI4",10,0)
 ;          TIUTYP = 1 if gotten from TIUTITLE
"RTN","TIUEDI4",11,0)
 ;          TIUTYP = 113 if gotten from user
"RTN","TIUEDI4",12,0)
 ; Requires TIUCLASS
"RTN","TIUEDI4",13,0)
 ; Receives TIUTITLE - optional = Title DA or Title Name or DA^Name
"RTN","TIUEDI4",14,0)
 N TIUDFLT
"RTN","TIUEDI4",15,0)
 ; -- Get title from TIUTITLE if it's there: --
"RTN","TIUEDI4",16,0)
 I $G(TIUTITLE)]"",$S(+$G(NOSAVE):1,+$P(TIUTITLE,U,2):1,1:0) D  I 1
"RTN","TIUEDI4",17,0)
 . S TIUTYP=1,TIUTITLE=$P(TIUTITLE,U)
"RTN","TIUEDI4",18,0)
 . S TIUTYP(1)=1_U_$S(+$G(TIUTITLE)>0:+$G(TIUTITLE),1:+$O(^TIU(8925.1,"B",TIUTITLE,0)))
"RTN","TIUEDI4",19,0)
 . S $P(TIUTYP(1),U,3)=$$PNAME^TIULC1(+$P(TIUTYP(1),U,2))
"RTN","TIUEDI4",20,0)
 ; -- If not, ask user: --
"RTN","TIUEDI4",21,0)
 E  D
"RTN","TIUEDI4",22,0)
 . S TIUDFLT="LAST" ; use user's preferred list of docmts
"RTN","TIUEDI4",23,0)
 . D DOCSPICK^TIULA2(.TIUTYP,TIUCLASS,"1A",TIUDFLT,"","+$$CANPICK^TIULP(+Y),+$$CANENTR^TIULP(+Y)")
"RTN","TIUEDI4",24,0)
 I +$G(TIUTYP)'>0 S TIUOUT=1 Q
"RTN","TIUEDI4",25,0)
 S TIUTYP=+$P($G(TIUTYP(1)),U,2)
"RTN","TIUEDI4",26,0)
 Q
"RTN","TIUEDI4",27,0)
 ;
"RTN","TIUEDI4",28,0)
GETVST(DFN,TIUTYP,TIU,EVNTFLAG) ; Get visit, set array TIU
"RTN","TIUEDI4",29,0)
 ; -- If no eventflag & don't suppress visit, then execute
"RTN","TIUEDI4",30,0)
 ;    visit linkage method: --
"RTN","TIUEDI4",31,0)
 ; Requires DFN
"RTN","TIUEDI4",32,0)
 ; Requires simple variable TIUTYP = title DA
"RTN","TIUEDI4",33,0)
 ; Optional EVNTFLAG
"RTN","TIUEDI4",34,0)
 ; Returns array TIU
"RTN","TIUEDI4",35,0)
 N TIUVSUPP,TIULMETH
"RTN","TIUEDI4",36,0)
 S TIUVSUPP=0
"RTN","TIUEDI4",37,0)
 I '$G(EVNTFLAG) S TIUVSUPP=+$$SUPPVSIT^TIULC1(TIUTYP)
"RTN","TIUEDI4",38,0)
 ; -- execute visit linkage method for TIUTYP --
"RTN","TIUEDI4",39,0)
 I 'TIUVSUPP,'$G(EVNTFLAG) D  I 1
"RTN","TIUEDI4",40,0)
 . S TIULMETH=$$GETLMETH^TIUEDI1(TIUTYP)
"RTN","TIUEDI4",41,0)
 . I '$L(TIULMETH) D  S TIUOUT=1 Q
"RTN","TIUEDI4",42,0)
 . . W !,$C(7),"No Visit Linkage Method defined for "
"RTN","TIUEDI4",43,0)
 . . W $$PNAME^TIULC1(TIUTYP),".",!,"Please contact IRM..."
"RTN","TIUEDI4",44,0)
 . ; -- TIULMETH for PN: D ENPN^TIUVSIT(.TIU,.DFN,1) --
"RTN","TIUEDI4",45,0)
 . X TIULMETH
"RTN","TIUEDI4",46,0)
 ; -- else create new historical "E" visit: --
"RTN","TIUEDI4",47,0)
 E  D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUEDI4",48,0)
 I $S($D(DIROUT):1,$D(DTOUT):1,1:0) S TIUQUIT=1 Q
"RTN","TIUEDI4",49,0)
 I '$D(TIU("VSTR")) D
"RTN","TIUEDI4",50,0)
 . W !,$C(7),"Patient & Visit required." H 2
"RTN","TIUEDI4",51,0)
 Q
"RTN","TIUEDI4",52,0)
 ;
"RTN","TIUEDI4",53,0)
ASKOK(TIUTYP,TIU,TIUBY,TIUASK) ; X Validation method.
"RTN","TIUEDI4",54,0)
 ; Receives and returns array TIU, simple var TIUTYP, [array TIUBY]
"RTN","TIUEDI4",55,0)
 ; Sets TIUASK = answer, = 0 for not OK or 1 for OK
"RTN","TIUEDI4",56,0)
 N TIUVMETH
"RTN","TIUEDI4",57,0)
 S TIUVMETH=$$GETVMETH^TIUEDI1(TIUTYP)
"RTN","TIUEDI4",58,0)
 I '$L(TIUVMETH) D  S TIUOUT=1 Q
"RTN","TIUEDI4",59,0)
 . W !,$C(7),"No Validation Method defined for "
"RTN","TIUEDI4",60,0)
 . W $$PNAME^TIULC1(TIUTYP),".",!,"Please contact IRM..."
"RTN","TIUEDI4",61,0)
 ; -- TIUVMETH for PN: S TIUASK=$$CHEKPN^TIULD(.TIU,.TIUBY) --
"RTN","TIUEDI4",62,0)
 X TIUVMETH
"RTN","TIUEDI4",63,0)
 ; -- If finish without a visit, then quit: --
"RTN","TIUEDI4",64,0)
 I '$D(TIU("VSTR")) D
"RTN","TIUEDI4",65,0)
 . W !,$C(7),"Patient & Visit required." H 2
"RTN","TIUEDI4",66,0)
 Q
"RTN","TIUEDI4",67,0)
 ;
"RTN","TIUEDI4",68,0)
DIE(DA,TIUQUIT,TIUCHNG) ; Invoke ^DIE
"RTN","TIUEDI4",69,0)
 N Y,DIE,DR
"RTN","TIUEDI4",70,0)
 I '$D(TIUPREF) S TIUPREF=$$PERSPRF^TIULE(DUZ)
"RTN","TIUEDI4",71,0)
 L +^TIU(8925,+DA):1
"RTN","TIUEDI4",72,0)
 E  D  Q
"RTN","TIUEDI4",73,0)
 . W !!?5,$C(7),"Another user is editing this entry.",! S TIUQUIT=2
"RTN","TIUEDI4",74,0)
 . I $$READ^TIUU("FOA","Press RETURN to continue...") W ""
"RTN","TIUEDI4",75,0)
 S ^TIU(8925,"ASAVE",DUZ,DA)=""
"RTN","TIUEDI4",76,0)
 S DR=$$GETTMPL^TIUEDI1(+$P(^TIU(8925,+DA,0),U))
"RTN","TIUEDI4",77,0)
 I DR']"" W !?5,$C(7),"No Edit template defined for ",$$PNAME^TIULC1(+$P(^TIU(8925,+DA,0),U)),! S TIUQUIT=2 Q
"RTN","TIUEDI4",78,0)
 S DIE=8925 D ^DIE
"RTN","TIUEDI4",79,0)
 I $D(Y)!($D(DTOUT)) S TIUQUIT=1
"RTN","TIUEDI4",80,0)
 I +$G(TIUQUIT)>0,+$G(TIUNEW)>0 Q
"RTN","TIUEDI4",81,0)
 D:+$G(TIUQUIT) UPDTIRT^TIUDIRT(.TIU,DA),SEND^TIUALRT(DA)
"RTN","TIUEDI4",82,0)
 Q:+$G(TIUQUIT)
"RTN","TIUEDI4",83,0)
 D TEXTEDIT(DA,.TIUCHNG)
"RTN","TIUEDI4",84,0)
 I +$G(^TIU(8925,DA,0))'>0 S TIUQUIT=2 Q
"RTN","TIUEDI4",85,0)
 S DR=".05///"_$$STATUS^TIULC(DA),DIE=8925 D ^DIE
"RTN","TIUEDI4",86,0)
 D UPDTIRT^TIUDIRT(.TIU,DA),SEND^TIUALRT(DA)
"RTN","TIUEDI4",87,0)
 L -^TIU(8925,+DA)
"RTN","TIUEDI4",88,0)
 Q
"RTN","TIUEDI4",89,0)
TEXTEDIT(DA,TIUCMMT,TIUCHNG) ; Call DIWE
"RTN","TIUEDI4",90,0)
 N DIC,DIWE,DIWESUB,DIWPT,DR,DWHD,DWI,DWLC,DWLR,DWLW,DWO,DWPK,DDWRW
"RTN","TIUEDI4",91,0)
 N TIUCKSM0,TIUCKSM1,TIUESNM,TIUESBLK
"RTN","TIUEDI4",92,0)
 S TIUESNM=$$DECRYPT^TIULC1($P($G(^TIU(8925,DA,15)),U,3),1,$$CHKSUM^TIULC("^TIU(8925,"_+DA_",""TEXT"")"))
"RTN","TIUEDI4",93,0)
 S TIUESBLK=$$DECRYPT^TIULC1($P($G(^TIU(8925,DA,15)),U,4),1,$$CHKSUM^TIULC("^TIU(8925,"_+DA_",""TEXT"")"))
"RTN","TIUEDI4",94,0)
 W !!,"Calling text editor, please wait..." H 1
"RTN","TIUEDI4",95,0)
 X:$L($G(TIUPRM3)) TIUPRM3
"RTN","TIUEDI4",96,0)
 D BUFFER^TIUEDIU(DA) ; Load edit buffer to protect original from booboos
"RTN","TIUEDI4",97,0)
 S TIUCKSM0=$$CHKSUM^TIULC("^TIU(8925,"_+DA_",""TEMP"")")
"RTN","TIUEDI4",98,0)
 I $D(^TIU(8925,+DA,"TEXT"))'>9 D LOADDFLT(DA,+$P(TIUTYP(1),U,2))
"RTN","TIUEDI4",99,0)
 S DIWESUB="Patient: "_$G(TIU("PNM")),DIC="^TIU(8925,"_+DA_",""TEMP"","
"RTN","TIUEDI4",100,0)
 I $G(VALMAR)="^TMP(""TIUVIEW"",$J)",(+$G(VALMBG)>5),(+$G(VALMBG)'>(+$P($G(^TIU(8925,+DA,"TEXT",0)),U,3)+4)) S DDWRW=+$G(VALMBG)-4
"RTN","TIUEDI4",101,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","TIUEDI4",102,0)
 ; DELETE if NOSAVE
"RTN","TIUEDI4",103,0)
 I +$G(NOSAVE) D DELETE^TIUEDIT(DA,0) S TIUQUIT=2 Q
"RTN","TIUEDI4",104,0)
 ; Save edit buffer
"RTN","TIUEDI4",105,0)
 S TIUCKSM1=$$CHKSUM^TIULC("^TIU(8925,"_+DA_",""TEMP"")")
"RTN","TIUEDI4",106,0)
 I TIUCKSM0'=TIUCKSM1 D  I 1
"RTN","TIUEDI4",107,0)
 . D COMMIT^TIUEDIU(DA),AUDIT^TIUEDI1(DA,TIUCKSM0,TIUCKSM1)
"RTN","TIUEDI4",108,0)
 . S TIUCHNG=1
"RTN","TIUEDI4",109,0)
 . ; re-file /es/-block
"RTN","TIUEDI4",110,0)
 . I $L(TIUESNM) D
"RTN","TIUEDI4",111,0)
 . . S DR="1503///^S X=TIUESNM;1504///^S X=TIUESBLK",DIE=8925
"RTN","TIUEDI4",112,0)
 . . D ^DIE
"RTN","TIUEDI4",113,0)
 E  W !,"No changes made..." D COMMIT^TIUEDIU(DA,1) S TIUCHNG=0
"RTN","TIUEDI4",114,0)
 S DIE=8925,DR=".1///"_$$LINECNT^TIULC(DA) D ^DIE
"RTN","TIUEDI4",115,0)
 Q
"RTN","TIUEDI4",116,0)
 ;
"RTN","TIUEDI4",117,0)
LOADDFLT(DA,TIUTYP) ; Load bp text
"RTN","TIUEDI4",118,0)
 N TIUI,TIUJ,TIUK,TIUL S TIUI=0
"RTN","TIUEDI4",119,0)
 S TIUJ=+$P($G(^TIU(8925,+DA,"TEMP",0)),U,3)+1
"RTN","TIUEDI4",120,0)
 ; - Set comp hdr -
"RTN","TIUEDI4",121,0)
 S ^TIU(8925,+DA,"TEMP",TIUJ,0)=$S($P($G(^TIU(8925.1,+TIUTYP,0)),U,4)="CO":$P(^TIU(8925.1,+TIUTYP,0),U)_":   ",1:"")
"RTN","TIUEDI4",122,0)
 I +TIUJ=1,($G(^TIU(8925,+DA,"TEMP",TIUJ,0))']"") K ^TIU(8925,+DA,"TEMP",TIUJ,0) S TIUJ=0
"RTN","TIUEDI4",123,0)
 S ^TIU(8925,+DA,"TEMP",0)="^^"_TIUJ_U_TIUJ_U_DT_"^^"
"RTN","TIUEDI4",124,0)
 F  S TIUI=$O(^TIU(8925.1,+TIUTYP,"DFLT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUEDI4",125,0)
 . S TIUJ=TIUJ+1,X=$G(^TIU(8925.1,+TIUTYP,"DFLT",TIUI,0))
"RTN","TIUEDI4",126,0)
 . I $L($T(DOLMLINE^TIUSRVF1)),'$D(XWBOS),(X["{FLD:") S X=$$DOLMLINE^TIUSRVF1(X)
"RTN","TIUEDI4",127,0)
 . I X["|" S X=$$BOIL(X,TIUJ)
"RTN","TIUEDI4",128,0)
 . I X["~@" D INSMULT(X,"^TIU(8925,"_+DA_",""TEMP"")",.TIUJ) I 1
"RTN","TIUEDI4",129,0)
 . E  S ^TIU(8925,+DA,"TEMP",TIUJ,0)=X
"RTN","TIUEDI4",130,0)
 . S ^TIU(8925,+DA,"TEMP",0)="^^"_TIUJ_U_TIUJ_U_DT_"^^"
"RTN","TIUEDI4",131,0)
 I +$O(^TIU(8925.1,+TIUTYP,10,0)) D
"RTN","TIUEDI4",132,0)
 . N TIUFITEM,TIUI
"RTN","TIUEDI4",133,0)
 . D ITEMS^TIUFLT(+TIUTYP)
"RTN","TIUEDI4",134,0)
 . S TIUI=0 F  S TIUI=$O(TIUFITEM(TIUI)) Q:+TIUI'>0  D
"RTN","TIUEDI4",135,0)
 . . S TIUL=+$G(TIUFITEM(+TIUI)) D LOADDFLT(DA,TIUL)
"RTN","TIUEDI4",136,0)
 Q
"RTN","TIUEDI4",137,0)
BOIL(LINE,COUNT) ; execute objects
"RTN","TIUEDI4",138,0)
 N TIUI,DIC,X,Y,TIUFPRIV S TIUFPRIV=1
"RTN","TIUEDI4",139,0)
 S DIC=8925.1,DIC(0)="FMXZ"
"RTN","TIUEDI4",140,0)
 S DIC("S")="I $P($G(^TIU(8925.1,+Y,0)),U,4)=""O"""
"RTN","TIUEDI4",141,0)
 F TIUI=2:2:$L(LINE,"|") S X=$P(LINE,"|",TIUI) D
"RTN","TIUEDI4",142,0)
 . D ^DIC
"RTN","TIUEDI4",143,0)
 . I +Y'>0 S X="The OBJECT "_X_" was NOT found...Contact IRM."
"RTN","TIUEDI4",144,0)
 . I +Y>0 D
"RTN","TIUEDI4",145,0)
 . . I $D(^TIU(8925.1,+Y,9)),+$$CANXEC(+Y) X ^(9) S:$E(X,1,2)="~@" X=X_"~@" I 1
"RTN","TIUEDI4",146,0)
 . . E  S X="The OBJECT "_X_" is INACTIVE...Contact IRM."
"RTN","TIUEDI4",147,0)
 . S LINE=$$REPLACE(LINE,X,TIUI)
"RTN","TIUEDI4",148,0)
 Q $TR(LINE,"|","")
"RTN","TIUEDI4",149,0)
CANXEC(TIUODA) ; Eval Obj Status
"RTN","TIUEDI4",150,0)
 N TIUOST,TIUY S TIUOST=+$P($G(^TIU(8925.1,+TIUODA,0)),U,7)
"RTN","TIUEDI4",151,0)
 S TIUY=$S(TIUOST=11:1,+$G(NOSAVE):1,1:0)
"RTN","TIUEDI4",152,0)
 Q +$G(TIUY)
"RTN","TIUEDI4",153,0)
REPLACE(LINE,X,TIUI) ; Replace TIUIth object in LINE
"RTN","TIUEDI4",154,0)
 S $P(LINE,"|",TIUI)=X
"RTN","TIUEDI4",155,0)
 Q LINE
"RTN","TIUEDI4",156,0)
INSMULT(LINE,TARGET,TIULCNT) ; Mult-valued results
"RTN","TIUEDI4",157,0)
 N TIUPC
"RTN","TIUEDI4",158,0)
 F TIUPC=2:2:$L(LINE,"~@") D
"RTN","TIUEDI4",159,0)
 . N TIUI,TIULINE,TIUX,TIUSRC,TIUSCNT,TIUTAIL
"RTN","TIUEDI4",160,0)
 . S TIUSRC=$P(LINE,"~@",TIUPC)
"RTN","TIUEDI4",161,0)
 . S TIUTAIL=$P(LINE,"~@",TIUPC+1)
"RTN","TIUEDI4",162,0)
 . S TIULINE=$P(LINE,"~@",(TIUPC-1)),(TIUI,TIUSCNT)=0
"RTN","TIUEDI4",163,0)
 . I $E(TIULINE)=" ",(TIUPC>2) S $E(TIULINE)=""
"RTN","TIUEDI4",164,0)
 . F  S TIUI=$O(@TIUSRC@(TIUI)) Q:+TIUI'>0  D
"RTN","TIUEDI4",165,0)
 . . N TIUSLINE
"RTN","TIUEDI4",166,0)
 . . S TIUSCNT=TIUSCNT+1
"RTN","TIUEDI4",167,0)
 . . S TIUSLINE=$G(@TIUSRC@(TIUI,0))
"RTN","TIUEDI4",168,0)
 . . S:'+$O(@TIUSRC@(TIUI))&(TIUPC+2>$L(LINE,"~@")) TIUSLINE=TIUSLINE_TIUTAIL
"RTN","TIUEDI4",169,0)
 . . I TIUSCNT=1,($L(TIULINE_TIUSLINE)>73) D  Q
"RTN","TIUEDI4",170,0)
 . . . S:$D(@TARGET@(TIULCNT,0)) TIULCNT=TIULCNT+1
"RTN","TIUEDI4",171,0)
 . . . S @TARGET@(TIULCNT,0)=TIULINE
"RTN","TIUEDI4",172,0)
 . . . S TIULCNT=TIULCNT+1
"RTN","TIUEDI4",173,0)
 . . . S @TARGET@(TIULCNT,0)=TIUSLINE
"RTN","TIUEDI4",174,0)
 . . I TIUSCNT=1,($L(TIULINE_TIUSLINE)'>73) D  Q
"RTN","TIUEDI4",175,0)
 . . . S:$D(@TARGET@(TIULCNT,0)) TIULCNT=TIULCNT+1
"RTN","TIUEDI4",176,0)
 . . . S @TARGET@(TIULCNT,0)=TIULINE_TIUSLINE
"RTN","TIUEDI4",177,0)
 . . S:$D(@TARGET@(TIULCNT,0)) TIULCNT=TIULCNT+1
"RTN","TIUEDI4",178,0)
 . . S @TARGET@(TIULCNT,0)=$G(TIUSLINE)
"RTN","TIUEDI4",179,0)
 . K @TIUSRC
"RTN","TIUEDI4",180,0)
 Q
"RTN","TIUEDIM")
0^23^B17815252
"RTN","TIUEDIM",1,0)
TIUEDIM ; SLC/JER - Enter/Edit Multiple Document ; 3/7/01
"RTN","TIUEDIM",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**7,41,52,100,109**;Jun 20, 1997
"RTN","TIUEDIM",3,0)
 ; 2/2: Update DIE from TIUEDIT to TIUEDI4
"RTN","TIUEDIM",4,0)
MAIN(TIUCLASS,TIUOUT,TIUNDA,TIUCHNG) ; Control Branching
"RTN","TIUEDIM",5,0)
 N TIUREL,TIUCHK,TIUDA,TIUEDIT,TIUY,TIUNEW,TIUTYP,TIUPAT
"RTN","TIUEDIM",6,0)
 N TIUI,DTOUT S TIUDFLT=""
"RTN","TIUEDIM",7,0)
 K DIROUT
"RTN","TIUEDIM",8,0)
 ; --- Get one or more patients ---
"RTN","TIUEDIM",9,0)
 I '$L($T(PATIENT^ORU1)) Q
"RTN","TIUEDIM",10,0)
 D PATIENT^ORU1(.TIUPAT) I +TIUPAT'>0 S TIUOUT=1 Q
"RTN","TIUEDIM",11,0)
 S TIUI=0 F  S TIUI=+$O(TIUPAT(TIUI)) Q:+TIUI'>0!+$G(TIUOUT)  D
"RTN","TIUEDIM",12,0)
 . N DFN,DUOUT,TIUDPRM,TIU,TIULMETH,TIUVMETH,VAIN,VADM,TIUDA,TIUEDIT
"RTN","TIUEDIM",13,0)
 . N TIUENTRY,TIUCMMTX,TIUVSUPP,CANEDIT
"RTN","TIUEDIM",14,0)
 . S TIUVSUPP=0
"RTN","TIUEDIM",15,0)
 . S DFN=+$G(TIUPAT(TIUI)) Q:+DFN'>0
"RTN","TIUEDIM",16,0)
 . W !!,"For Patient ",$P(TIUPAT(TIUI),U,2)
"RTN","TIUEDIM",17,0)
 . S TIUCLASS=$G(TIUCLASS,38)
"RTN","TIUEDIM",18,0)
 . I TIUCLASS=3,$S(+$$ISA^USRLM(DUZ,"TRANSCRIPTIONIST"):0,1:1),(+$G(NOSAVE)'>0) D EXSTNOTE^TIUEDI2(DFN) D:$G(VALMAR)="^TMP(""OR"",$J,""CURRENT"")" FULL^VALM1
"RTN","TIUEDIM",19,0)
 . I +$G(DIROUT)!+$G(DUOUT)!+$G(DTOUT) S TIUOUT=1 Q
"RTN","TIUEDIM",20,0)
 . ; -- Set title array TIUTYP (use TIUTITLE or ask user) --
"RTN","TIUEDIM",21,0)
 . D SETTL^TIUEDI4(.TIUTYP,TIUCLASS,$G(TIUTITLE)) I +$G(TIUTYP)'>0 S TIUOUT=1 Q
"RTN","TIUEDIM",22,0)
 . ; -- Get doc parameters for title, X entry action --
"RTN","TIUEDIM",23,0)
 . D DOCPRM^TIULC1(TIUTYP,.TIUDPRM)
"RTN","TIUEDIM",24,0)
 . S TIUENTRY=$$GETENTRY^TIUEDI2(+TIUTYP)
"RTN","TIUEDIM",25,0)
 . I $L(TIUENTRY) X TIUENTRY
"RTN","TIUEDIM",26,0)
 . Q:+$G(TIUOUT)  ; If ENTRY ACTION sets TIUOUT=1 Abort Entry
"RTN","TIUEDIM",27,0)
 . ; -- Set visit array TIU --
"RTN","TIUEDIM",28,0)
 . ; NOTE: EVNTFLAG is set in TIUEDIT, prior to calling this routine
"RTN","TIUEDIM",29,0)
 . D GETVST^TIUEDI4(DFN,TIUTYP,.TIU,EVNTFLAG)
"RTN","TIUEDIM",30,0)
 . I $S($G(TIUQUIT):1,'$D(TIU("VSTR")):1,1:0) Q
"RTN","TIUEDIM",31,0)
 . ; -- Ask OK --
"RTN","TIUEDIM",32,0)
 . S TIUVMETH=$$GETVMETH^TIUEDI1(TIUTYP)
"RTN","TIUEDIM",33,0)
 . I '$L(TIUVMETH) D  S TIUOUT=1 Q
"RTN","TIUEDIM",34,0)
 . . W !,$C(7),"No Validation Method defined for "
"RTN","TIUEDIM",35,0)
 . . W $$PNAME^TIULC1(TIUTYP),".",!,"Please contact IRM..."
"RTN","TIUEDIM",36,0)
 . X TIUVMETH
"RTN","TIUEDIM",37,0)
 . I $S($D(DIROUT):1,$D(DTOUT):1,1:0) S TIUQUIT=1 Q
"RTN","TIUEDIM",38,0)
 . I $D(DUOUT) Q
"RTN","TIUEDIM",39,0)
 . ; -- If user OK'd basic info, go on to get text, etc.: --
"RTN","TIUEDIM",40,0)
 . I $D(TIU),+$G(TIUASK) D
"RTN","TIUEDIM",41,0)
 . . ; -- Get record DA --
"RTN","TIUEDIM",42,0)
 . . ; DA is either: new stub record, ready for edit, or
"RTN","TIUEDIM",43,0)
 . . ;               existing record, for edit, or
"RTN","TIUEDIM",44,0)
 . . ;               existing record, for addendum      
"RTN","TIUEDIM",45,0)
 . . N DA
"RTN","TIUEDIM",46,0)
 . . S DA=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.TIUNEW,.TIUDPRM,1,DUZ,.CANEDIT)
"RTN","TIUEDIM",47,0)
 . . I +DA'>0 W !,"Unable to enter/edit." Q
"RTN","TIUEDIM",48,0)
 . . ; -- [Addend DA and Quit] --
"RTN","TIUEDIM",49,0)
 . . ;  If record not new & user can't edit it, user said
"RTN","TIUEDIM",50,0)
 . . ;  in GETRECNW they wanted to addend, so let user write
"RTN","TIUEDIM",51,0)
 . . ;  addendum and quit:
"RTN","TIUEDIM",52,0)
 . . I 'TIUNEW,'CANEDIT D ADDENDUM^TIUADD(DA,"",.TIUCHNG,1) Q
"RTN","TIUEDIM",53,0)
 . . N TIUQUIT,TIUADD,TIUTDA
"RTN","TIUEDIM",54,0)
 . . ; -- Edit new or existing DA --
"RTN","TIUEDIM",55,0)
 . . D DIE^TIUEDI4(DA,.TIUQUIT)
"RTN","TIUEDIM",56,0)
 . . Q:+$G(TIUQUIT)=2  ; DA doesn't exist (e.g. uparrowed w/ bad record)
"RTN","TIUEDIM",57,0)
 . . ;If (CP) and (Timeout or Not Select Consult) and (Consult Associated), Quit before EMPTYDOC check
"RTN","TIUEDIM",58,0)
 . . I +$$ISA^TIULX(TIUTYP,+$$CLASS^TIUCP),+$G(TIUQUIT)=1,+$P($G(^TIU(8925,+DA,14)),U,5)>0 Q
"RTN","TIUEDIM",59,0)
 . . I $$EMPTYDOC^TIULF(DA) D DELETE^TIUEDIT(DA,0) S:$G(VALMAR)="^TMP(""TIUVIEW"",$J)" VALMBCK="Q" S:'+$G(TIUNEW) TIUCHNG("DELETE")=1 H:'+$G(TIUNEW) 2 Q
"RTN","TIUEDIM",60,0)
 . . Q:+$G(TIUQUIT)
"RTN","TIUEDIM",61,0)
 . . S:+DA SUCCESS=+DA
"RTN","TIUEDIM",62,0)
 . . I +$G(TIUONCE) S TIUNDA(+$G(DA))="" ; See TIURC, Across Patients
"RTN","TIUEDIM",63,0)
 . . ; -- Misc after-edit-stuff for DA --
"RTN","TIUEDIM",64,0)
 . . ; -- Mark to ask workload at signature;
"RTN","TIUEDIM",65,0)
 . . ;    (STOP for Stop codes for stand-alone visits): --
"RTN","TIUEDIM",66,0)
 . . I +$G(TIU("STOP")),(+$P($G(TIUDPRM(0)),U,14)'=1) D DEFER^TIUVSIT(DA,TIU("STOP")) I 1
"RTN","TIUEDIM",67,0)
 . . E  D QUE^TIUPXAP1 ; Post workload now in background
"RTN","TIUEDIM",68,0)
 . . S TIUCMMTX=$$COMMIT^TIULC1(+$P(TIUTYP(1),U,2))
"RTN","TIUEDIM",69,0)
 . . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUEDIM",70,0)
 . . D RELEASE^TIUT(DA)
"RTN","TIUEDIM",71,0)
 . . D VERIFY^TIUT(DA)
"RTN","TIUEDIM",72,0)
 . . ; -- Get signature for DA 
"RTN","TIUEDIM",73,0)
 . . D EDSIG^TIURS(DA)
"RTN","TIUEDIM",74,0)
 . . ; - execute EXIT ACTION -
"RTN","TIUEDIM",75,0)
 . . S TIUEXIT=$$GETEXIT^TIUEDI2(+$P(TIUTYP(1),U,2))
"RTN","TIUEDIM",76,0)
 . . I $L(TIUEXIT) S TIUTDA=DA X TIUEXIT S DA=TIUTDA
"RTN","TIUEDIM",77,0)
 . . ; --  [Prompt to print DA] --
"RTN","TIUEDIM",78,0)
 . . I +$P($G(TIUDPRM(0)),U,8) D PRINT^TIUEPRNT(DA)
"RTN","TIUEDIM",79,0)
 Q
"RTN","TIUEDIT")
0^21^B37974979
"RTN","TIUEDIT",1,0)
TIUEDIT ; SLC/JER - Enter/Edit a Document ; 3/7/01
"RTN","TIUEDIT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,7,22,52,100,109**;Jun 20, 1997
"RTN","TIUEDIT",3,0)
 ; Moved LOADDFLT, BOIL, CANXEC, REPLACE, INSMULT to TIUEDI4
"RTN","TIUEDIT",4,0)
 ; Moved DIE, TEXTEDIT from TIUEDIT to TIUEDI4
"RTN","TIUEDIT",5,0)
 ; Separated out modules SETTL, GETVST, ASKOK
"RTN","TIUEDIT",6,0)
 ; Moved SETTL, GETVST, ASKOK from TIUEDIT to TIUEDI4
"RTN","TIUEDIT",7,0)
 ; Changed call to GETREC^TIUEDI1 to call GETRECNW^TIUEDI3
"RTN","TIUEDIT",8,0)
MAIN(TIUCLASS,SUCCESS,DFN,TIUTITLE,EVNTFLAG,NOSAVE,TIUNDA,TIUSNGL,TIUCHNG) ; Create new document(s)
"RTN","TIUEDIT",9,0)
 ; May branch off to edit existing docmt instead of creating new one.
"RTN","TIUEDIT",10,0)
 ; Call with: [TIUCLASS] --> pointer to file (8925) corresponding to
"RTN","TIUEDIT",11,0)
 ;                           the class (e.g., Progress Notes=3)
"RTN","TIUEDIT",12,0)
 ;                           from which to select a title
"RTN","TIUEDIT",13,0)
 ;    [by ref] [SUCCESS] --> Boolean flag returned as IFN when a
"RTN","TIUEDIT",14,0)
 ;                           record is created, or 0 when record
"RTN","TIUEDIT",15,0)
 ;                           creation fails
"RTN","TIUEDIT",16,0)
 ;                 [DFN] --> IEN in patient file (#2)
"RTN","TIUEDIT",17,0)
 ;            [TIUTITLE] --> Pointer or NAME or PTR^NAME of the
"RTN","TIUEDIT",18,0)
 ;                           TITLE from file 8925.1 to be used as
"RTN","TIUEDIT",19,0)
 ;                           the default.
"RTN","TIUEDIT",20,0)
 ;            [EVNTFLAG] --> Boolean flag for visit prompt (0 to
"RTN","TIUEDIT",21,0)
 ;                           prompt, 1 to force event type visit)
"RTN","TIUEDIT",22,0)
 ;              [NOSAVE] --> Boolean flag to suppress saving the data
"RTN","TIUEDIT",23,0)
 ;                           (e.g., when testing new Boilerplates
"RTN","TIUEDIT",24,0)
 ;                           using DDEF action TRY, etc.).
"RTN","TIUEDIT",25,0)
 ;     [by ref] [TIUNDA] --> array of form: TIUNDA(IFN)="".
"RTN","TIUEDIT",26,0)
 ;                           Used in SHOW NOTES ACROSS PATIENTS.
"RTN","TIUEDIT",27,0)
 ;                           See TIURC, which sets TIUONCE.
"RTN","TIUEDIT",28,0)
 ;                           Also used in TIUEDIM, for mult pts.
"RTN","TIUEDIT",29,0)
 ;             [TIUSNGL] --> Boolean flag to create only ONE note
"RTN","TIUEDIT",30,0)
 ;                           regardless of multiple pt preference.
"RTN","TIUEDIT",31,0)
 ;    [by ref] [TIUCHNG] --> If received, passes back TIUCHNG array,
"RTN","TIUEDIT",32,0)
 ;                           which collects info across records about
"RTN","TIUEDIT",33,0)
 ;                           actions taken. Used in feedback
"RTN","TIUEDIT",34,0)
 ;                           msgs to user.
"RTN","TIUEDIT",35,0)
 ; Other variables:
"RTN","TIUEDIT",36,0)
 ; sets [TIUTYP] --> array with form similar to that of XQORNOD:
"RTN","TIUEDIT",37,0)
 ;                           TIUTYP = title IFN
"RTN","TIUEDIT",38,0)
 ;                           TIUTYP(1) = 1^title IFN^title name,
"RTN","TIUEDIT",39,0)
 ;                           where 1 for us is just a positive #
"RTN","TIUEDIT",40,0)
 ; sets  [TIUBY] --> used in some input templates to BYpass fields.
"RTN","TIUEDIT",41,0)
 ; Called by:
"RTN","TIUEDIT",42,0)
 ;   Outpt Pharmacy, Consults, ...
"RTN","TIUEDIT",43,0)
 N TIUASK,TIUOUT,TIUREL,TIUCHK,TIUDA,TIUEDIT,TIUY,TIUTYP,TIUDPRM
"RTN","TIUEDIT",44,0)
 N TIUDFLT,TIUPREF,TIULMETH,TIUVMETH,DIRUT,DUOUT,DTOUT,TIUPRM0
"RTN","TIUEDIT",45,0)
 N TIUPRM1,TIUPRM3,TIUENTRY,TIUEXIT,TIUBY,TIUPNAME,TIUST
"RTN","TIUEDIT",46,0)
 S EVNTFLAG=+$G(EVNTFLAG,0)
"RTN","TIUEDIT",47,0)
 ; --Get user's division parameters, preferences: --
"RTN","TIUEDIT",48,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUEDIT",49,0)
 S TIUPREF=$$PERSPRF^TIULE(DUZ)
"RTN","TIUEDIT",50,0)
 ; -- multiple pts; not in OERR, not TRYing DDEF, not single docmt: --
"RTN","TIUEDIT",51,0)
 I $P(TIUPREF,U,6)="M",(+$G(ORVP)'>0),(+$G(NOSAVE)'>0),'+$G(TIUSNGL) D MAIN^TIUEDIM(TIUCLASS,.TIUOUT,.TIUNDA,.TIUCHNG) Q
"RTN","TIUEDIT",52,0)
 ; -- Loop: Create docmt --
"RTN","TIUEDIT",53,0)
 F  D  Q:+$G(ORVP)!+$G(TIUOUT)!+$G(NOSAVE)!+$G(TIUSNGL)
"RTN","TIUEDIT",54,0)
 . N TIU,TIUCMMTX,TIUBY,TIUEDIT,TIUNEW,TIUTYP,VADM,VAIN,CANEDIT
"RTN","TIUEDIT",55,0)
 . ; -- User specifies basic info for new docmt --
"RTN","TIUEDIT",56,0)
 . ; -- Get patient --
"RTN","TIUEDIT",57,0)
 . I +$G(ORVP) S DFN=+$G(ORVP)
"RTN","TIUEDIT",58,0)
 . I +$G(DFN)'>0 D  I +DFN'>0 S TIUOUT=1 Q
"RTN","TIUEDIT",59,0)
 . . S DFN=+$$PATIENT^TIULA
"RTN","TIUEDIT",60,0)
 . ; -- [For progress notes, show available notes]: --
"RTN","TIUEDIT",61,0)
 . S TIUCLASS=$G(TIUCLASS,38)
"RTN","TIUEDIT",62,0)
 . I TIUCLASS=3,$S(+$$ISA^USRLM(DUZ,"TRANSCRIPTIONIST"):0,1:1),(+$G(NOSAVE)'>0) D EXSTNOTE^TIUEDI2(DFN) D:$G(VALMAR)="^TMP(""OR"",$J,""CURRENT"")" FULL^VALM1
"RTN","TIUEDIT",63,0)
 . I +$G(DIROUT)!+$G(DUOUT)!+$G(DTOUT) S TIUOUT=1 Q
"RTN","TIUEDIT",64,0)
 . ; -- Set title array TIUTYP (use TIUTITLE or ask user) --
"RTN","TIUEDIT",65,0)
 . D SETTL^TIUEDI4(.TIUTYP,TIUCLASS,$G(TIUTITLE)) I +$G(TIUTYP)'>0 S TIUOUT=1 Q
"RTN","TIUEDIT",66,0)
 . ; -- Get doc parameters for title, X entry action --
"RTN","TIUEDIT",67,0)
 . D DOCPRM^TIULC1(TIUTYP,.TIUDPRM)
"RTN","TIUEDIT",68,0)
 . S TIUENTRY=$$GETENTRY^TIUEDI2(+TIUTYP)
"RTN","TIUEDIT",69,0)
 . I $L(TIUENTRY) X TIUENTRY
"RTN","TIUEDIT",70,0)
 . Q:+$G(TIUOUT)  ; If ENTRY ACTION sets TIUOUT=1 Abort entry
"RTN","TIUEDIT",71,0)
 . ; -- Set visit array TIU --
"RTN","TIUEDIT",72,0)
 . D GETVST^TIUEDI4(DFN,TIUTYP,.TIU,EVNTFLAG)
"RTN","TIUEDIT",73,0)
 . I '$D(TIU("VSTR")) K DFN,TIUTYP Q
"RTN","TIUEDIT",74,0)
 . ; -- Ask OK --
"RTN","TIUEDIT",75,0)
 . D ASKOK^TIUEDI4(TIUTYP,.TIU,.TIUBY,.TIUASK) I '$D(TIU("VSTR")) K DFN,TIUTYP Q
"RTN","TIUEDIT",76,0)
 . ; -- If user OK'd basic info, go on to get text, etc.: --
"RTN","TIUEDIT",77,0)
 . I $D(TIU),+$G(TIUASK) D
"RTN","TIUEDIT",78,0)
 . . ; -- Get record DA --
"RTN","TIUEDIT",79,0)
 . . ; DA is either: new stub record, ready for edit, or
"RTN","TIUEDIT",80,0)
 . . ;               existing record, for edit, or
"RTN","TIUEDIT",81,0)
 . . ;               existing record, for addendum      
"RTN","TIUEDIT",82,0)
 . . N DA
"RTN","TIUEDIT",83,0)
 . . S DA=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.TIUNEW,.TIUDPRM,1,DUZ,.CANEDIT)
"RTN","TIUEDIT",84,0)
 . . I +DA'>0 W !,"Unable to enter/edit." Q
"RTN","TIUEDIT",85,0)
 . . ; -- [Addend DA and Quit] --
"RTN","TIUEDIT",86,0)
 . . ;    If record not new & user can't edit it, let user
"RTN","TIUEDIT",87,0)
 . . ;    write addendum and quit:
"RTN","TIUEDIT",88,0)
 . . I 'TIUNEW,'CANEDIT D  Q
"RTN","TIUEDIT",89,0)
 . . . D ADDENDUM^TIUADD(DA,"",.TIUCHNG,1)
"RTN","TIUEDIT",90,0)
 . . N TIUQUIT,TIUADD,TIUTDA
"RTN","TIUEDIT",91,0)
 . . ; -- Edit new or existing DA --
"RTN","TIUEDIT",92,0)
 . . D DIE^TIUEDI4(DA,.TIUQUIT)
"RTN","TIUEDIT",93,0)
 . . Q:+$G(TIUQUIT)=2  ; DA doesn't exist (e.g. uparrowed w/ bad record)
"RTN","TIUEDIT",94,0)
 . . ;If (CP) and (Timeout or Not Select Consult) and (Consult Associated), Quit before EMPTYDOC check
"RTN","TIUEDIT",95,0)
 . . I +$$ISA^TIULX(TIUTYP,+$$CLASS^TIUCP),+$G(TIUQUIT)=1,+$P($G(^TIU(8925,+DA,14)),U,5)>0 Q
"RTN","TIUEDIT",96,0)
 . . I $$EMPTYDOC^TIULF(DA) D DELETE(DA,0) S:$G(VALMAR)="^TMP(""TIUVIEW"",$J)" VALMBCK="Q" S:'+$G(TIUNEW) TIUCHNG("DELETE")=1 H:'+$G(TIUNEW) 2 Q
"RTN","TIUEDIT",97,0)
 . . Q:+$G(TIUQUIT)
"RTN","TIUEDIT",98,0)
 . . S:+DA SUCCESS=+DA
"RTN","TIUEDIT",99,0)
 . . I +$G(TIUONCE) S TIUNDA(+$G(DA))="" ; See TIURC, Across Patients
"RTN","TIUEDIT",100,0)
 . . ; -- Misc after-edit-stuff for DA --
"RTN","TIUEDIT",101,0)
 . . ; -- Mark to ask workload at signature;
"RTN","TIUEDIT",102,0)
 . . ;    (STOP for Stop codes for stand-alone visits): --
"RTN","TIUEDIT",103,0)
 . . I +$G(TIU("STOP")),(+$P($G(TIUDPRM(0)),U,14)'=1) D DEFER^TIUVSIT(DA,TIU("STOP")) I 1 ;piece 14 = suppress DX/CPT on entry
"RTN","TIUEDIT",104,0)
 . . E  D QUE^TIUPXAP1 ; Post workload now in background
"RTN","TIUEDIT",105,0)
 . . S TIUCMMTX=$$COMMIT^TIULC1(+$P(TIUTYP(1),U,2))
"RTN","TIUEDIT",106,0)
 . . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUEDIT",107,0)
 . . D RELEASE^TIUT(DA)
"RTN","TIUEDIT",108,0)
 . . D VERIFY^TIUT(DA)
"RTN","TIUEDIT",109,0)
 . . ; -- Get signature for DA 
"RTN","TIUEDIT",110,0)
 . . D EDSIG^TIURS(DA)
"RTN","TIUEDIT",111,0)
 . . ; - execute EXIT ACTION -
"RTN","TIUEDIT",112,0)
 . . S TIUEXIT=$$GETEXIT^TIUEDI2(+$P(TIUTYP(1),U,2))
"RTN","TIUEDIT",113,0)
 . . I $L(TIUEXIT) S TIUTDA=DA X TIUEXIT S DA=TIUTDA
"RTN","TIUEDIT",114,0)
 . . ; --  [Prompt to add ID stub] --
"RTN","TIUEDIT",115,0)
 . . ; I +$P($G(TIUDPRM(0)),U,20) D ADDSTUB^TIUGEDIT(DA)
"RTN","TIUEDIT",116,0)
 . . ; --  [Prompt to print DA] --
"RTN","TIUEDIT",117,0)
 . . I +$P($G(TIUDPRM(0)),U,8) D PRINT^TIUEPRNT(DA)
"RTN","TIUEDIT",118,0)
 . K DFN ; Free patient
"RTN","TIUEDIT",119,0)
 . S TIUPNAME=$$PNAME^TIULC1(TIUCLASS)
"RTN","TIUEDIT",120,0)
 . I $$UP^XLFSTR($E(TIUPNAME,$L(TIUPNAME)))="S" S TIUPNAME=$E(TIUPNAME,1,$L(TIUPNAME)-1)
"RTN","TIUEDIT",121,0)
 . ; -- [loop again] --
"RTN","TIUEDIT",122,0)
 . I '+$G(NOSAVE),'+$G(ORVP),'+$G(TIUSNGL) W !!,"You may enter another ",TIUPNAME,". Press RETURN to exit.",!
"RTN","TIUEDIT",123,0)
 Q
"RTN","TIUEDIT",124,0)
 ;
"RTN","TIUEDIT",125,0)
DELETE(TIUDA,PROMPT,MSG,HUSH) ; Delete record
"RTN","TIUEDIT",126,0)
 N DIDEL,DIE,DR,TIUD0,TIUVSIT,TIUVKILL,TIUDELX,TIUTYPE
"RTN","TIUEDIT",127,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUVSIT=$P(TIUD0,U,3),TIUTYPE=+TIUD0
"RTN","TIUEDIT",128,0)
 I +$G(PROMPT),'+$$READ^TIUU("YO",MSG,"NO") W !,"Nothing Deleted." Q
"RTN","TIUEDIT",129,0)
 K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIUEDIT",130,0)
 D DELIRT^TIUDIRT(TIUDA)
"RTN","TIUEDIT",131,0)
 ; If a DELETE Action exists for the document definition, execute it
"RTN","TIUEDIT",132,0)
 S TIUDELX=$$DELETE^TIULC1(TIUTYPE)
"RTN","TIUEDIT",133,0)
 I TIUDELX]"" X TIUDELX
"RTN","TIUEDIT",134,0)
 S DA=TIUDA,(DIDEL,DIE)=8925,DR=".01///@"
"RTN","TIUEDIT",135,0)
 D ^DIE W:'+$G(HUSH) !,"<NOTHING ENTERED. "
"RTN","TIUEDIT",136,0)
 I '+$G(HUSH) W:+TIUD0 $$PNAME^TIULC1(+TIUD0)," DELETED>"
"RTN","TIUEDIT",137,0)
 D DELCOMP^TIUEDI1(TIUDA),DELAUDIT^TIUEDI1(TIUDA)
"RTN","TIUEDIT",138,0)
 K ^TIU(8925,"ASAVE",DUZ,TIUDA) ; Remove Save Flag
"RTN","TIUEDIT",139,0)
 D ALERTDEL^TIUALRT(TIUDA),ADDENDEL^TIUALRT(TIUDA)
"RTN","TIUEDIT",140,0)
 ; I +TIUVSIT S TIUVKILL=$$DELVFILE^PXAPI("ALL",TIUVSIT,"","TEXT INTEGRATION UTILITIES")
"RTN","TIUEDIT",141,0)
 Q
"RTN","TIUEDIT",142,0)
 ;
"RTN","TIUEDITR")
0^22^B14502322
"RTN","TIUEDITR",1,0)
TIUEDITR ; SLC/JER - Enter/Edit a Document for Transcriber ;1/21/01
"RTN","TIUEDITR",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**7,41,48,100,109**;Jun 20, 1997
"RTN","TIUEDITR",3,0)
 ; 2/2: Update DIE from TIUEDIT to TIUEDI4
"RTN","TIUEDITR",4,0)
MAIN(TIUCLASS) ; Control Branching
"RTN","TIUEDITR",5,0)
 N TIUPREF,TIUOUT,TIUAUTH
"RTN","TIUEDITR",6,0)
 ; --- Get user's preferences ---
"RTN","TIUEDITR",7,0)
 S TIUPREF=$$PERSPRF^TIULE(DUZ)
"RTN","TIUEDITR",8,0)
 ; --- Get the author to be used for multiple patients
"RTN","TIUEDITR",9,0)
 S TIUAUTH=+$$AUTHOR^TIULA2
"RTN","TIUEDITR",10,0)
 I TIUAUTH'>0 Q
"RTN","TIUEDITR",11,0)
 F  D  Q:+$G(TIUOUT)
"RTN","TIUEDITR",12,0)
 . N DFN,TIUREL,TIUCHK,TIUDA,TIUEDIT,TIUY,TIUNEW,TIUTYP,TIUDPRM
"RTN","TIUEDITR",13,0)
 . N TIUASK,TIU,VAIN,VADM,TIULMETH,TIUVMETH,TIUENTRY,TIUEXIT,TIUCMMTX
"RTN","TIUEDITR",14,0)
 . N DA ;10/3/00
"RTN","TIUEDITR",15,0)
 . ;Removed with TIU*1*41 - Joel didn't think it was appropriate
"RTN","TIUEDITR",16,0)
 . ;I $P(TIUPREF,U,6)="M" D MAIN^TIUEDIM(TIUCLASS,.TIUOUT) Q
"RTN","TIUEDITR",17,0)
 . ; --- Get a patient ---
"RTN","TIUEDITR",18,0)
 . S DFN=+$$PATIENT^TIULA I +DFN'>0 S TIUOUT=1 Q
"RTN","TIUEDITR",19,0)
 . S TIUCLASS=$G(TIUCLASS,38)
"RTN","TIUEDITR",20,0)
 . ; --- Get a document type ---
"RTN","TIUEDITR",21,0)
 . D DOCSPICK^TIULA2(.TIUTYP,TIUCLASS,"1A","LAST","","$P(^TIU(8925.1,+Y,0),U,7)'=13,+$$CANENTR^TIULP(+Y)")
"RTN","TIUEDITR",22,0)
 . I +$G(TIUTYP)'>0 S TIUOUT=1 Q
"RTN","TIUEDITR",23,0)
 . S TIUTYP=+$P($G(TIUTYP(1)),U,2)
"RTN","TIUEDITR",24,0)
 . ; --- Initialize document parameters ---
"RTN","TIUEDITR",25,0)
 . D DOCPRM^TIULC1(TIUTYP,.TIUDPRM)
"RTN","TIUEDITR",26,0)
 . ; --- If an ENTRY ACTION exists, execute it ---
"RTN","TIUEDITR",27,0)
 . S TIUENTRY=$$GETENTRY^TIUEDI2(+TIUTYP)
"RTN","TIUEDITR",28,0)
 . I $L(TIUENTRY) X TIUENTRY
"RTN","TIUEDITR",29,0)
 . Q:+$G(TIUOUT)  ; If entry action sets TIUOUT=1 Abort Entry
"RTN","TIUEDITR",30,0)
 . ; --- Get associated visit ---
"RTN","TIUEDITR",31,0)
 . I +$$SUPPVSIT^TIULC1(TIUTYP)'>0 D  I 1
"RTN","TIUEDITR",32,0)
 . . S TIULMETH=$$GETLMETH^TIUEDI1(TIUTYP)
"RTN","TIUEDITR",33,0)
 . . I '$L(TIULMETH) D  S TIUOUT=1 Q
"RTN","TIUEDITR",34,0)
 . . . W !,$C(7),"No Visit Linkage Method defined for "
"RTN","TIUEDITR",35,0)
 . . . W $$PNAME^TIULC1(TIUTYP),".",!,"Please contact IRM..."
"RTN","TIUEDITR",36,0)
 . . X TIULMETH
"RTN","TIUEDITR",37,0)
 . E  D
"RTN","TIUEDITR",38,0)
 . . D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUEDITR",39,0)
 . I $S($D(DIROUT):1,$D(DTOUT):1,1:0) S TIUQUIT=1 Q
"RTN","TIUEDITR",40,0)
 . I '$D(TIU("VSTR")) D  Q
"RTN","TIUEDITR",41,0)
 . . W !,$C(7),"Patient & Visit required." H 2
"RTN","TIUEDITR",42,0)
 . ; --- Validate Selection ---
"RTN","TIUEDITR",43,0)
 . S TIUVMETH=$$GETVMETH^TIUEDI1(TIUTYP)
"RTN","TIUEDITR",44,0)
 . I '$L(TIUVMETH) D  S TIUOUT=1 Q
"RTN","TIUEDITR",45,0)
 . . W !,$C(7),"No Validation Method defined for "
"RTN","TIUEDITR",46,0)
 . . W $$PNAME^TIULC1(TIUTYP),".",!,"Please contact IRM..."
"RTN","TIUEDITR",47,0)
 . X TIUVMETH
"RTN","TIUEDITR",48,0)
 . I $D(TIU),+$G(TIUASK) D
"RTN","TIUEDITR",49,0)
 . . ;S DA=$$GETREC^TIUEDI1(DFN,.TIU,1,.TIUNEW,.TIUDPRM,1)
"RTN","TIUEDITR",50,0)
 . . S DA=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.TIUNEW,.TIUDPRM,1)
"RTN","TIUEDITR",51,0)
 . . I +DA'>0 W !,"Unable to enter/edit." Q
"RTN","TIUEDITR",52,0)
 . . S TIUEDIT=$S('+$G(TIUNEW):$$CANDO^TIULP(DA,"EDIT RECORD"),1:1)
"RTN","TIUEDITR",53,0)
 . . I '+TIUEDIT D  Q
"RTN","TIUEDITR",54,0)
 . . . W !,$P(TIUEDIT,U,2) ; Echo denial message
"RTN","TIUEDITR",55,0)
 . . . D ADDENDUM^TIUADD(DA,"",.TIUCHNG)
"RTN","TIUEDITR",56,0)
 . . N TIUQUIT,TIUADD
"RTN","TIUEDITR",57,0)
 . . D DIE^TIUEDI4(DA,.TIUQUIT) Q:+$G(TIUQUIT)=2  ; **100**
"RTN","TIUEDITR",58,0)
 . . ;If (CP) and (Timeout or Not Select Consult) and (Consult Associated), Quit before EMPTYDOC check
"RTN","TIUEDITR",59,0)
 . . I +$$ISA^TIULX(TIUTYP,+$$CLASS^TIUCP),+$G(TIUQUIT)=1,+$P($G(^TIU(8925,+DA,14)),U,5)>0 Q
"RTN","TIUEDITR",60,0)
 . . I $$EMPTYDOC^TIULF(DA) D DELETE^TIUEDIT(DA,0) S:'+$G(TIUNEW) TIUCHNG("DELETE")=1 H:'+$G(TIUNEW) 2 Q
"RTN","TIUEDITR",61,0)
 . . Q:+$G(TIUQUIT)
"RTN","TIUEDITR",62,0)
 . . I +$G(TIUONCE) S TIUNDA(+$G(DA))=""
"RTN","TIUEDITR",63,0)
 . . I +$G(TIU("STOP")) D DEFER^TIUVSIT(DA,TIU("STOP")) I 1
"RTN","TIUEDITR",64,0)
 . . E  D QUE^TIUPXAP1
"RTN","TIUEDITR",65,0)
 . . ; --- Execute COMMIT procedure ---
"RTN","TIUEDITR",66,0)
 . . S TIUCMMTX=$$COMMIT^TIULC1(+$G(^TIU(8925,+DA,0)))
"RTN","TIUEDITR",67,0)
 . . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUEDITR",68,0)
 . . ; --- Execute RELEASE procedure ---
"RTN","TIUEDITR",69,0)
 . . D RELEASE^TIUT(DA)
"RTN","TIUEDITR",70,0)
 . . ; --- Execute VERIFY procedure ---
"RTN","TIUEDITR",71,0)
 . . D VERIFY^TIUT(DA)
"RTN","TIUEDITR",72,0)
 . . ; --- Execute SIGNATURE procedure ---
"RTN","TIUEDITR",73,0)
 . . D EDSIG^TIURS(DA)
"RTN","TIUEDITR",74,0)
 . . ; --- If an EXIT ACTION exists, execute it ---
"RTN","TIUEDITR",75,0)
 . . S TIUEXIT=$$GETEXIT^TIUEDI2(+$P(TIUTYP(1),U,2))
"RTN","TIUEDITR",76,0)
 . . I $L(TIUEXIT) X TIUEXIT
"RTN","TIUEDITR",77,0)
 . . ; --- If required, prompt for print
"RTN","TIUEDITR",78,0)
 . . I +$P($G(TIUDPRM(0)),U,8) D PRINT^TIUEPRNT(DA)
"RTN","TIUEDITR",79,0)
 Q
"RTN","TIULC")
0^25^B27988155
"RTN","TIULC",1,0)
TIULC ; SLC/JER - Computational functions ;15-JAN-2001 14:38:41
"RTN","TIULC",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**3,9,19,23,53,93,109**;Jun 20, 1997
"RTN","TIULC",3,0)
LINECNT(DA) ; Compute line count for document record
"RTN","TIULC",4,0)
 N CPL,CCNT S CPL=$S(+$P($G(TIUPRM0),U,3)>0:$P(TIUPRM0,U,3),1:60)
"RTN","TIULC",5,0)
 Q $$CHARCNT(DA)\CPL
"RTN","TIULC",6,0)
CHARCNT(DA) ; Compute character count for a record
"RTN","TIULC",7,0)
 N TIUI
"RTN","TIULC",8,0)
 N:'$D(CCNT) CCNT ; Character count is static
"RTN","TIULC",9,0)
 S TIUI=0 F  S TIUI=$O(^TIU(8925,DA,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIULC",10,0)
 . S CCNT=+$G(CCNT)+$L($$STRIP^TIULS(^TIU(8925,DA,"TEXT",TIUI,0)))
"RTN","TIULC",11,0)
 S TIUI=0
"RTN","TIULC",12,0)
 F  S TIUI=$O(^TIU(8925,"DAD",DA,TIUI)) Q:+TIUI'>0!+$$ISADDNDM^TIULC1(+TIUI)  S CCNT=$$CHARCNT(TIUI)
"RTN","TIULC",13,0)
 Q +$G(CCNT)
"RTN","TIULC",14,0)
STATUS(DA) ; Evaluate Status of Reports
"RTN","TIULC",15,0)
 N NODE12,NODE13,NODE15,NODE16,AMENDED,STATUS,SIGNED,COSIGNED,PURGED
"RTN","TIULC",16,0)
 N VERIFIED,RELEASED,SIGNER,COSIGNER,SIGSTAT,TYPE,REQVER,REQREL,REQCOS
"RTN","TIULC",17,0)
 N DELETED,TIUDPARM
"RTN","TIULC",18,0)
 S STATUS=""
"RTN","TIULC",19,0)
 S TYPE=$S($D(TIUTYP(1)):$P(TIUTYP(1),U,2),1:+$G(^TIU(8925,+DA,0)))
"RTN","TIULC",20,0)
 D DOCPRM^TIULC1(TYPE,.TIUDPARM,DA)
"RTN","TIULC",21,0)
 S REQVER=$$REQVER(+DA,+$P($G(TIUDPARM(0)),U,3))
"RTN","TIULC",22,0)
 S REQREL=+$P($G(TIUDPARM(0)),U,2)
"RTN","TIULC",23,0)
 S NODE12=$G(^TIU(8925,+DA,12)),NODE13=$G(^TIU(8925,+DA,13))
"RTN","TIULC",24,0)
 S NODE15=$G(^TIU(8925,+DA,15)),NODE16=$G(^TIU(8925,+DA,16))
"RTN","TIULC",25,0)
 S SIGNED=+$P(NODE15,U),COSIGNED=+$P(NODE15,U,7),REQCOS=+$P(NODE15,U,6)
"RTN","TIULC",26,0)
 S SIGNER=+$P(NODE12,U,2),COSIGNER=+$P(NODE12,U,4)
"RTN","TIULC",27,0)
 S AMENDED=+$P(NODE16,U),PURGED=+$P(NODE16,U,9),DELETED=+$P(NODE16,U,11)
"RTN","TIULC",28,0)
 S RELEASED=+$P(NODE13,U,4),VERIFIED=+$P(NODE13,U,5)
"RTN","TIULC",29,0)
 I PURGED S STATUS="purged" G STATUSX
"RTN","TIULC",30,0)
 I DELETED S STATUS="deleted" G STATUSX
"RTN","TIULC",31,0)
 I AMENDED S STATUS="amended" G STATUSX
"RTN","TIULC",32,0)
 I +$$ISA^TIULX(+TYPE,+$$CLASS^TIUCP),'SIGNER S STATUS="undictated" G STATUSX
"RTN","TIULC",33,0)
 I '+NODE12,+NODE13 S STATUS="untranscribed" G STATUSX
"RTN","TIULC",34,0)
 I REQREL,'RELEASED S STATUS="unreleased" G STATUSX
"RTN","TIULC",35,0)
 I REQVER,'VERIFIED S STATUS="unverified" G STATUSX
"RTN","TIULC",36,0)
 I SIGNED,$S('REQCOS:1,COSIGNED:1,1:0) S STATUS="completed" G STATUSX
"RTN","TIULC",37,0)
 I 'SIGNED S STATUS="unsigned" G STATUSX
"RTN","TIULC",38,0)
 I REQCOS,'COSIGNED S STATUS="uncosigned"
"RTN","TIULC",39,0)
STATUSX Q STATUS
"RTN","TIULC",40,0)
REQVER(TIUDA,TIUVPRM) ; Evaluate conditions of verification requirement
"RTN","TIULC",41,0)
 N TIUD0,TIUD13,TIUD15,TIUY
"RTN","TIULC",42,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD13=$G(^(13)),TIUD15=$G(^(15))
"RTN","TIULC",43,0)
 I +$G(TIUVPRM)'>0!(+$P(TIUD13,U,5)>0) S TIUY=0 G REQVX
"RTN","TIULC",44,0)
 I +$G(TIUVPRM)>0,+$G(TIUD15) S TIUY=0 G REQVX
"RTN","TIULC",45,0)
 I +$G(TIUVPRM)=1 S TIUY=1 G REQVX
"RTN","TIULC",46,0)
 I +$G(TIUVPRM)=2,($P(TIUD13,U,3)="U") S TIUY=1 G REQVX
"RTN","TIULC",47,0)
 I +$G(TIUVPRM)=3,($P(TIUD13,U,3)="D") S TIUY=1
"RTN","TIULC",48,0)
REQVX Q +$G(TIUY)
"RTN","TIULC",49,0)
PRCDNC(DA,SCREEN) ; Determine sort precedence of each record
"RTN","TIULC",50,0)
 N SIGNED,URGENCY
"RTN","TIULC",51,0)
 S URGENCY=$P($G(^TIU(8925,+DA,0)),U,9)
"RTN","TIULC",52,0)
 I +$$SIGNED(DA,.SCREEN)'>0 S Y=$S(URGENCY="P":1,1:2)
"RTN","TIULC",53,0)
 E  S Y=3
"RTN","TIULC",54,0)
 Q Y
"RTN","TIULC",55,0)
PURGE(TIUDA) ; Checks whether or not a given Document should be purged
"RTN","TIULC",56,0)
 N TIUEDT,TIUY S TIUY=0
"RTN","TIULC",57,0)
 ; if parameters not in symbol table, get them
"RTN","TIULC",58,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIULC",59,0)
 ; exit if no Archive/purge grace period defined
"RTN","TIULC",60,0)
 I +$P(TIUPRM0,U,4)'>0 G PURGEX
"RTN","TIULC",61,0)
 S TIUEDT=$P($G(^TIU(8925,TIUDA,12)),U)
"RTN","TIULC",62,0)
 I +TIUEDT'>0 G PURGEX ;Transcription date blank
"RTN","TIULC",63,0)
 I +$$ISPN^TIULX(+$G(^TIU(8925,+TIUDA,0))) G PURGEX ; PN's exempt
"RTN","TIULC",64,0)
 I +$$ISADDNDM^TIULC1(+TIUDA),+$$ISPN^TIULX(+$G(^TIU(8925,+$P(^TIU(8925,+TIUDA,0),U,6),0))) G PURGEX ; Addenda to Progress Notes exempt
"RTN","TIULC",65,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)<7 G PURGEX ;Incomplete--don't purge
"RTN","TIULC",66,0)
 I +$P($G(^TIU(8925,TIUDA,16)),U,4)>0 G PURGEX ;Document already purged
"RTN","TIULC",67,0)
 I $$FMDIFF^XLFDT(DT,TIUEDT)>+$P(TIUPRM0,U,4) S TIUY=1
"RTN","TIULC",68,0)
PURGEX Q TIUY
"RTN","TIULC",69,0)
OVERDUE(TIUDA) ; Checks whether or not a given document is overdue
"RTN","TIULC",70,0)
 N TIUD0,TIUDATE,TIUY,TIUDPRM S TIUY=0,TIUD0=$G(^TIU(8925,TIUDA,0))
"RTN","TIULC",71,0)
 ; if parameters not in symbol table, get them
"RTN","TIULC",72,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIULC",73,0)
 D DOCPRM^TIULC1(+TIUD0,.TIUDPRM,TIUDA)
"RTN","TIULC",74,0)
 ; exit if no signature grace period defined
"RTN","TIULC",75,0)
 I +$P(TIUPRM0,U,5)'>0 G OVERX
"RTN","TIULC",76,0)
 I '$D(TIUDPRM) G OVERX
"RTN","TIULC",77,0)
 S TIUDATE=$S($$REQVER(TIUDA,+$P(TIUDPRM(0),U,3)):$P($G(^TIU(8925,+TIUDA,13)),U,5),$P(TIUDPRM(0),U,2):$P($G(^TIU(8925,+TIUDA,13)),U,4),1:$P($G(^TIU(8925,+TIUDA,12)),U))
"RTN","TIULC",78,0)
 G:+TIUDATE'>0 OVERX
"RTN","TIULC",79,0)
 I $$FMDIFF^XLFDT(DT,TIUDATE)>$P(TIUPRM0,U,5),(+$P($G(^TIU(8925,+TIUDA,0)),U,5)>4),(+$P($G(^TIU(8925,+TIUDA,0)),U,5)<7) S TIUY=1
"RTN","TIULC",80,0)
OVERX Q TIUY
"RTN","TIULC",81,0)
NOW() ; Extrinsic function returning current date/time to nearest .01 second
"RTN","TIULC",82,0)
 N %,%H,%I,X
"RTN","TIULC",83,0)
 D NOW^%DTC
"RTN","TIULC",84,0)
 Q %
"RTN","TIULC",85,0)
IDATE(X) ; Recieves date in external format, returns internal format
"RTN","TIULC",86,0)
 N %DT,Y
"RTN","TIULC",87,0)
 I ($L(X," ")=2),(X?1.2N1P1.2N1P1.2N1" "1.2N.E) S X=$TR(X," ","@")
"RTN","TIULC",88,0)
 S %DT="TSP" D ^%DT
"RTN","TIULC",89,0)
 Q Y
"RTN","TIULC",90,0)
SIGNED(TIUDA,SCREEN) ; Check whether document requires signature or
"RTN","TIULC",91,0)
 ; cosignature on user-sensitive basis
"RTN","TIULC",92,0)
 N Y S Y=0 ; Initialize return value to FALSE
"RTN","TIULC",93,0)
 ; If archived/purged return TRUE
"RTN","TIULC",94,0)
 I +$P($G(^TIU(8925,+TIUDA,16)),U,9) S Y=1 G SIGNEDX
"RTN","TIULC",95,0)
 ; If OPTION is Act on MY Unsigned Documents, check
"RTN","TIULC",96,0)
 ; whether his/her signature is present
"RTN","TIULC",97,0)
 I $P($G(SCREEN(1)),U)="AAU",($P($G(SCREEN(2)),U)="ASUP") D  G SIGNEDX
"RTN","TIULC",98,0)
 . ; If dictated by user and signed return TRUE
"RTN","TIULC",99,0)
 . I $P($G(^TIU(8925,+TIUDA,12)),U,4)=DUZ,(+$P($G(^(15)),U)>0) S Y=1
"RTN","TIULC",100,0)
 . ; If user is Expected Cosigner and cosigned, return TRUE
"RTN","TIULC",101,0)
 . I $P($G(^TIU(8925,+TIUDA,12)),U,8)=DUZ,(+$P($G(^(15)),U,7)>0) S Y=1
"RTN","TIULC",102,0)
 ; Otherwise check search criteria to determine signature status
"RTN","TIULC",103,0)
 I $P($G(SCREEN(1)),U)="AAU",+$P($G(^TIU(8925,+TIUDA,15)),U) S Y=1 G SIGNEDX
"RTN","TIULC",104,0)
 I $P($G(SCREEN(1)),U)="ASUP",+$P($G(^TIU(8925,+TIUDA,15)),U,7) S Y=1 G SIGNEDX
"RTN","TIULC",105,0)
 I +$P($G(^TIU(8925,+TIUDA,15)),U),+$P($G(^(15)),U,7) S Y=1
"RTN","TIULC",106,0)
SIGNEDX Q Y
"RTN","TIULC",107,0)
BLANK(TIUDA) ; Reads a given document for blank lines
"RTN","TIULC",108,0)
 ; Returns: 1:Record contains 1 or more blanks
"RTN","TIULC",109,0)
 ;          0:Record contains no blanks
"RTN","TIULC",110,0)
 N BLANK,TIUI,Y S (TIUI,Y)=0
"RTN","TIULC",111,0)
 I '$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIULC",112,0)
 I $P($G(TIUPRM1),U,6)']"" G BLANKX
"RTN","TIULC",113,0)
 S BLANK=$P(TIUPRM1,U,6)
"RTN","TIULC",114,0)
 F  S TIUI=$O(^TIU(8925,TIUDA,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIULC",115,0)
 . I $G(^TIU(8925,TIUDA,"TEXT",TIUI,0))[BLANK S Y=1
"RTN","TIULC",116,0)
BLANKX Q Y
"RTN","TIULC",117,0)
CHKSUM(TIUROOT,TIUY) ; Calculates checksum for a record
"RTN","TIULC",118,0)
 N TIUI,X S TIUI=0,TIUY=+$G(TIUY)
"RTN","TIULC",119,0)
 F  S TIUI=$O(@TIUROOT@(TIUI)) Q:+TIUI'>0  D
"RTN","TIULC",120,0)
 . S X=$G(@TIUROOT@(TIUI,0))
"RTN","TIULC",121,0)
 . N TIUJ
"RTN","TIULC",122,0)
 . F TIUJ=1:1:$L(X) S TIUY=+$G(TIUY)+(($A(X,TIUJ)*TIUI)*TIUJ)
"RTN","TIULC",123,0)
 S TIUI=0
"RTN","TIULC",124,0)
 F  S TIUI=$O(^TIU(8925,"DAD",+$P(TIUROOT,",",2),TIUI)) Q:+TIUI'>0  D
"RTN","TIULC",125,0)
 . I +$$ISADDNDM^TIULC1(+TIUI) Q
"RTN","TIULC",126,0)
 . S TIUY=+$G(TIUY)+$$CHKSUM("^TIU(8925,"_+TIUI_",""TEXT"")",TIUY)
"RTN","TIULC",127,0)
 Q +$G(TIUY)
"RTN","TIULP")
0^3^B35420949
"RTN","TIULP",1,0)
TIULP ; SLC/JER - Functions determining privilege ;6/25/01  11:10
"RTN","TIULP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**98,100,116,109**;Jun 20, 1997
"RTN","TIULP",3,0)
CANDO(TIUDA,TIUACT,PERSON) ; Can PERSON perform action now
"RTN","TIULP",4,0)
 ; Receives: TIUDA=Record number in file 8925
"RTN","TIULP",5,0)
 ;           TIUACT=Name of user action in 8930.8 (USR ACTION)
"RTN","TIULP",6,0)
 ;           PERSON=New Person file IFN.
"RTN","TIULP",7,0)
 ;                  Assumed to be DUZ if not received.
"RTN","TIULP",8,0)
 ;                  New **100** ID param, backward compatible.
"RTN","TIULP",9,0)
 ;  Returns:   TIUY=1:yes,0:no_"^"_why not message
"RTN","TIULP",10,0)
 ; tested: MAM 2/2/00
"RTN","TIULP",11,0)
 N TIUI,TIUTYP,TIUROLE,STATUS,TIUY,TIUATYP,MSG,WHO,MODIFIER
"RTN","TIULP",12,0)
 S TIUY=0 I '$G(PERSON) S PERSON=DUZ
"RTN","TIULP",13,0)
 ;**100** was I +TIUACT'>0 S TIUACT etc.
"RTN","TIULP",14,0)
 S TIUACT=$$USREVNT(TIUACT) I +TIUACT'>0 S TIUY=0 G CANDOX
"RTN","TIULP",15,0)
 ; -- In case business rules have changed, & children already existed:
"RTN","TIULP",16,0)
 I +TIUACT=24,$D(^TIU(8925,"GDAD",TIUDA)) D  G CANDOX
"RTN","TIULP",17,0)
 . S TIUY="0^ This note cannot be attached; it has its own children."
"RTN","TIULP",18,0)
 I +TIUACT=25,+$G(^TIU(8925,TIUDA,21)) D  G CANDOX
"RTN","TIULP",19,0)
 . S TIUY="0^ This note cannot receive interdisciplinary children; it is itself a child."
"RTN","TIULP",20,0)
 I +TIUACT=4!(+TIUACT=5),+$$BLANK^TIULC(TIUDA) D  G CANDOX
"RTN","TIULP",21,0)
 . S TIUY="0^ Contains blanks ("_$P(TIUPRM1,U,6)_") which must be filled before "_$P(TIUACT,U,2)_"ATURE."
"RTN","TIULP",22,0)
 S TIUROLE=$$USRROLE(TIUDA,PERSON)
"RTN","TIULP",23,0)
 S STATUS=+$P($G(^TIU(8925,+TIUDA,0)),U,5)
"RTN","TIULP",24,0)
 S TIUTYP=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIULP",25,0)
 I $$ISADDNDM^TIULC1(+TIUDA) S TIUATYP=TIUTYP,TIUTYP=+$G(^TIU(8925,+$P($G(^TIU(8925,+TIUDA,0)),U,6),0))
"RTN","TIULP",26,0)
 I TIUROLE']"" S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,PERSON)
"RTN","TIULP",27,0)
 F TIUI=1:1:($L(TIUROLE,U)-1) D  Q:+$G(TIUY)>0
"RTN","TIULP",28,0)
 . S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,PERSON,$P(TIUROLE,U,TIUI))
"RTN","TIULP",29,0)
 I +$G(TIUATYP) S TIUTYP=+$G(TIUATYP)
"RTN","TIULP",30,0)
 ;**100** update for PERSON param; update for verb modifier:
"RTN","TIULP",31,0)
 I +TIUY'>0 D  G CANDOX
"RTN","TIULP",32,0)
 . S WHO=" You"
"RTN","TIULP",33,0)
 . I PERSON'=DUZ S WHO=$P(^VA(200,PERSON,0),U),WHO=$$NAME^TIULS(WHO,"FIRST LAST")
"RTN","TIULP",34,0)
 . S MODIFIER=$P(TIUACT,U,3) I $L(MODIFIER) S MODIFIER=" "_MODIFIER
"RTN","TIULP",35,0)
 . ;e.g. "You may not ATTACH this UNSIGNED TELEPHONE NOTE TO AN ID NOTE."
"RTN","TIULP",36,0)
 . S MSG=WHO_" may not "_$P(TIUACT,U,2)_" this "_$P($G(^TIU(8925.6,+STATUS,0)),U)_" "_$$PNAME^TIULC1(TIUTYP)_MODIFIER_"."
"RTN","TIULP",37,0)
 . S TIUY=TIUY_U_MSG
"RTN","TIULP",38,0)
 I +TIUACT=15,$$HASIMG^TIURB2(+TIUDA) D  G CANDOX
"RTN","TIULP",39,0)
 . S TIUY="0^ This document contains linked images. You must ""delete"" the Images using the Imaging package before proceeding."
"RTN","TIULP",40,0)
CANDOX Q TIUY
"RTN","TIULP",41,0)
 ;
"RTN","TIULP",42,0)
CANLINK(TIUTYP) ; Can user (DUZ) link (attach) a document of a particular type
"RTN","TIULP",43,0)
 ;to an ID note.
"RTN","TIULP",44,0)
 ; For use in ADD NEW ID NOTE, where docmt is not entered yet.
"RTN","TIULP",45,0)
 ; Assume most favorable circumstances (user will complete
"RTN","TIULP",46,0)
 ;the note, so if user still can't attach, can tell them no,
"RTN","TIULP",47,0)
 ;when they first select title for the new entry.
"RTN","TIULP",48,0)
 ; Rule out if TIUTYP can be an ID parent, since ID parent
"RTN","TIULP",49,0)
 ;and ID kid function as mutually exclusive, (regardless of
"RTN","TIULP",50,0)
 ;business rules).
"RTN","TIULP",51,0)
 N TIUACT,STATUS,USRROLE,TIUY
"RTN","TIULP",52,0)
 S TIUACT=$$USREVNT("ATTACH TO ID NOTE"),STATUS=7 ; complete
"RTN","TIULP",53,0)
 S USRROLE=+$O(^USR(8930.2,"B","COMPLETER",0))
"RTN","TIULP",54,0)
 S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,DUZ,USRROLE)
"RTN","TIULP",55,0)
 I '$G(TIUY) S TIUY="0^ You may not use this title for interdisciplinary child entries." Q TIUY
"RTN","TIULP",56,0)
 ; -- If user can attach a certain note, but note can also receive
"RTN","TIULP",57,0)
 ;    ID entries, don't let user attach it. --
"RTN","TIULP",58,0)
 I $$POSSPRNT^TIULP(TIUTYP) S TIUY="0^ This interdisciplinary PARENT title cannot be used for CHILD entries."
"RTN","TIULP",59,0)
 ; -- If selected type is a CWAD, don't let user attach it: --
"RTN","TIULP",60,0)
 I $$ISCWAD^TIULX(TIUTYP) S TIUY="0^ CWAD titles cannot be used for interdisciplinary entries."
"RTN","TIULP",61,0)
 ; -- If selected type is a consult, don't let user attach it: --
"RTN","TIULP",62,0)
 I $$ISA^TIULX(TIUTYP,+$$CLASS^TIUCNSLT) S TIUY="0^ Consult titles cannot be used for interdisciplinary entries."
"RTN","TIULP",63,0)
 Q TIUY
"RTN","TIULP",64,0)
 ;
"RTN","TIULP",65,0)
POSSPRNT(TIUTYP) ; Is a docmt intended as a possible ID parent?
"RTN","TIULP",66,0)
 ;Returns 1^WHYCAN'TATTACH if there are business rules permitting ANYONE
"RTN","TIULP",67,0)
 ;to attach ID entries to notes of type TIUTYP.
"RTN","TIULP",68,0)
 ;Else returns 0.
"RTN","TIULP",69,0)
 N TIUACT,STATUS,TIUY,DADTYP
"RTN","TIULP",70,0)
 S TIUY=0,TIUACT=+$$USREVNT("ATTACH ID ENTRY")
"RTN","TIULP",71,0)
 F STATUS=6,7,8 D  G:TIUY POSSX
"RTN","TIULP",72,0)
 . I $O(^USR(8930.1,"AR",TIUTYP,STATUS,TIUACT,0)) S TIUY=1 Q
"RTN","TIULP",73,0)
 . I $O(^USR(8930.1,"AC",TIUTYP,STATUS,TIUACT,0)) S TIUY=1
"RTN","TIULP",74,0)
 ; -- If no rules for TIUTYP, try its parent: --
"RTN","TIULP",75,0)
 S DADTYP=$O(^TIU(8925.1,"AD",TIUTYP,0)) G:DADTYP'>0 POSSX
"RTN","TIULP",76,0)
 S TIUY=$$POSSPRNT(DADTYP)
"RTN","TIULP",77,0)
POSSX I TIUY S TIUY="1^ Interdisciplinary PARENT notes cannot be attached as CHILD entries."
"RTN","TIULP",78,0)
 Q TIUY
"RTN","TIULP",79,0)
 ;
"RTN","TIULP",80,0)
CANENTR(TIUTYP) ; Evaluate privilege to enter a document of a particular type
"RTN","TIULP",81,0)
 N TIUACT,STATUS,USRROLE,TIUY
"RTN","TIULP",82,0)
 S TIUACT=$$USREVNT("ENTRY"),STATUS=2 ; untranscribed
"RTN","TIULP",83,0)
 S USRROLE=3 ; transcriber
"RTN","TIULP",84,0)
 S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,DUZ,USRROLE)
"RTN","TIULP",85,0)
 Q TIUY
"RTN","TIULP",86,0)
USRROLE(TIUDA,PERSON) ; Identify the user's role with respect to the document
"RTN","TIULP",87,0)
 ; 3/20/00 **100** Added role COMPLETER
"RTN","TIULP",88,0)
 ; 3/20/00 **100** Added PERSON param
"RTN","TIULP",89,0)
 N TIU0,TIU12,TIU13,TIUY,TIU15,COMPLTR,STATUS
"RTN","TIULP",90,0)
 S PERSON=$G(PERSON,DUZ)
"RTN","TIULP",91,0)
 S TIU0=$G(^TIU(8925,+TIUDA,0)),STATUS=$P(TIU0,U,5)
"RTN","TIULP",92,0)
 S TIU12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIULP",93,0)
 S TIU13=$G(^TIU(8925,+TIUDA,13)),TIU15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIULP",94,0)
 I PERSON=+$P(TIU13,U,2) S TIUY=+$O(^USR(8930.2,"B","TRANSCRIBER",0))_U
"RTN","TIULP",95,0)
 I PERSON=+$P(TIU12,U,2) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","AUTHOR/DICTATOR",0))_U
"RTN","TIULP",96,0)
 I PERSON=+$P(TIU12,U,9) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","ATTENDING PHYSICIAN",0))_U
"RTN","TIULP",97,0)
 I PERSON=+$P(TIU12,U,4) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","EXPECTED SIGNER",0))_U
"RTN","TIULP",98,0)
 I PERSON=+$P(TIU12,U,8) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","EXPECTED COSIGNER",0))_U
"RTN","TIULP",99,0)
 ;Check if the person can be an Interpreter for this document via a Consult API
"RTN","TIULP",100,0)
 I $$CPINTERP^GMRCCP(+TIUDA,PERSON) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","INTERPRETER",0))_U
"RTN","TIULP",101,0)
 I STATUS>6 D  I COMPLTR S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","COMPLETER",0))_U
"RTN","TIULP",102,0)
 . S COMPLTR=0
"RTN","TIULP",103,0)
 . I PERSON=+$P(TIU15,U,8) S COMPLTR=1 Q
"RTN","TIULP",104,0)
 . I '$P(TIU15,U,8),PERSON=+$P(TIU15,U,2) S COMPLTR=1
"RTN","TIULP",105,0)
 I +$O(^TIU(8925.7,"AE",+TIUDA,+PERSON,0)) D
"RTN","TIULP",106,0)
 . N TIUXTRA S TIUXTRA=+$O(^TIU(8925.7,"AE",+TIUDA,+PERSON,0))
"RTN","TIULP",107,0)
 . I +$P($G(^TIU(8925.7,+TIUXTRA,0)),U,4) Q
"RTN","TIULP",108,0)
 . S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","ADDITIONAL SIGNER",0))_U
"RTN","TIULP",109,0)
 Q $G(TIUY)
"RTN","TIULP",110,0)
USREVNT(EVENT) ; Given event name, return:
"RTN","TIULP",111,0)
 ;EVENT = event pointer^user verb^verb modifier
"RTN","TIULP",112,0)
 ; **100** added verb modifier piece (.07)
"RTN","TIULP",113,0)
 N TIUY,TIUDA,NODE0
"RTN","TIULP",114,0)
 S TIUDA=+$O(^USR(8930.8,"B",EVENT,0))
"RTN","TIULP",115,0)
 S NODE0=$G(^USR(8930.8,TIUDA,0))
"RTN","TIULP",116,0)
 S TIUY=TIUDA_U_$P(NODE0,U,5)_U_$P(NODE0,U,7)
"RTN","TIULP",117,0)
 Q TIUY
"RTN","TIULP",118,0)
CANPICK(TIUTYP) ; Screens selection of title by title status and
"RTN","TIULP",119,0)
 ;(for status TEST), by owner.
"RTN","TIULP",120,0)
 N TIUPOWN,TIUCOWN,TIUT0,TIUTSTAT,TIUY S TIUY=0
"RTN","TIULP",121,0)
 S TIUT0=$G(^TIU(8925.1,+TIUTYP,0)),TIUTSTAT=$P(TIUT0,U,7)
"RTN","TIULP",122,0)
 I TIUTSTAT']"" S TIUY=0 G CANPIX
"RTN","TIULP",123,0)
 I TIUTSTAT=13 S TIUY=0 G CANPIX
"RTN","TIULP",124,0)
 I TIUTSTAT=11 S TIUY=1 G CANPIX
"RTN","TIULP",125,0)
 S TIUPOWN=$P(TIUT0,U,5),TIUCOWN=+$P(TIUT0,U,6)
"RTN","TIULP",126,0)
 I TIUTSTAT=10 S TIUY=$S(TIUPOWN=DUZ:1,+$$ISA^USRLM(DUZ,TIUCOWN):1,1:0)
"RTN","TIULP",127,0)
CANPIX Q +$G(TIUY)
"RTN","TIULP",128,0)
REQCOSIG(TIUTYP,TIUDA,USER) ; Evaluate whether user requires cosignature
"RTN","TIULP",129,0)
 N TIUI,TIUY S USER=$S(+$G(USER):+$G(USER),1:+$G(DUZ))
"RTN","TIULP",130,0)
 I '$D(TIUDPRM) D DOCPRM^TIULC1(TIUTYP,.TIUDPRM,+$G(TIUDA))
"RTN","TIULP",131,0)
 I $G(TIUDPRM(5))="" G REQCOSX
"RTN","TIULP",132,0)
 F TIUI=1:1:$L(TIUDPRM(5),U) D  Q:+TIUY>0
"RTN","TIULP",133,0)
 . S TIUY=+$$ISA^USRLM(+USER,+$P(TIUDPRM(5),U,TIUI))
"RTN","TIULP",134,0)
REQCOSX Q +$G(TIUY)
"RTN","TIULP",135,0)
 ;
"RTN","TIULP",136,0)
REQCPF(TIUCDA) ;Check if clinical procedure fields are required
"RTN","TIULP",137,0)
 ; Input  -- TIUCDA   Request/Consult File (#123) IEN
"RTN","TIULP",138,0)
 ; Output -- 1=Required and 0=Not Required
"RTN","TIULP",139,0)
 N TIUCPACT,REQF
"RTN","TIULP",140,0)
 I '$G(TIUCDA) G REQCPFQ
"RTN","TIULP",141,0)
 S TIUCPACT=$$CPACTM^GMRCCP(TIUCDA)
"RTN","TIULP",142,0)
 I TIUCPACT=1!(TIUCPACT=3) S REQF=1
"RTN","TIULP",143,0)
REQCPFQ Q +$G(REQF)
"RTN","TIUPS109")
0^1^B40166517
"RTN","TIUPS109",1,0)
TIUPS109 ;SLC/RMO - Post-Install for TIU*1*109 ;11/7/00@10:04:20
"RTN","TIUPS109",2,0)
 ;;1.0;Text Integration Utilities;**109**;Jun 20, 1997
"RTN","TIUPS109",3,0)
 ;
"RTN","TIUPS109",4,0)
 ;Register TIU RPCs that support Clinical Procedures
"RTN","TIUPS109",5,0)
 D ENREG
"RTN","TIUPS109",6,0)
 ;
"RTN","TIUPS109",7,0)
 ;Create or Update Clinical Procedures Class
"RTN","TIUPS109",8,0)
 D ENCP
"RTN","TIUPS109",9,0)
 Q
"RTN","TIUPS109",10,0)
 ;
"RTN","TIUPS109",11,0)
ENREG ;Entry point to Register TIU RPCs that support Clinical Procedures
"RTN","TIUPS109",12,0)
 N MENU,RPC
"RTN","TIUPS109",13,0)
 S MENU="OR CPRS GUI CHART"
"RTN","TIUPS109",14,0)
 F RPC="TIU IS THIS A CLINPROC?","TIU IDENTIFY CLINPROC CLASS","TIU LONG LIST CLINPROC TITLES" D INSERT(MENU,RPC)
"RTN","TIUPS109",15,0)
 Q
"RTN","TIUPS109",16,0)
 ;
"RTN","TIUPS109",17,0)
INSERT(OPTION,RPC) ; Call FM Updater with each RPC
"RTN","TIUPS109",18,0)
 ; Input  -- OPTION   Option file (#19) Name field (#.01)
"RTN","TIUPS109",19,0)
 ;           RPC      RPC sub-file (#19.05) RPC field (#.01)
"RTN","TIUPS109",20,0)
 ; Output -- None
"RTN","TIUPS109",21,0)
 N FDA,FDAIEN,ERR,DIERR
"RTN","TIUPS109",22,0)
 S FDA(19,"?1,",.01)=OPTION
"RTN","TIUPS109",23,0)
 S FDA(19.05,"?+2,?1,",.01)=RPC
"RTN","TIUPS109",24,0)
 D UPDATE^DIE("E","FDA","FDAIEN","ERR")
"RTN","TIUPS109",25,0)
 Q
"RTN","TIUPS109",26,0)
 ;
"RTN","TIUPS109",27,0)
ENCP ;Entry point to Create Clinical Procedures Class
"RTN","TIUPS109",28,0)
 ; Input  -- None
"RTN","TIUPS109",29,0)
 ; Output -- None
"RTN","TIUPS109",30,0)
 N TIUDA,TIUFPRIV,TIUNEW
"RTN","TIUPS109",31,0)
 S TIUFPRIV=1,TIUNEW=0,TIUDA=$$CHKCP
"RTN","TIUPS109",32,0)
 I +TIUDA>0,$P(TIUDA,U,2)="CL" D
"RTN","TIUPS109",33,0)
 . D BMES^XPDUTL("You already have a CLASS called CLINICAL PROCEDURES...")
"RTN","TIUPS109",34,0)
 . D BMES^XPDUTL("The new methods and properties to support the TIU/CP interface")
"RTN","TIUPS109",35,0)
 . D BMES^XPDUTL("will be MERGED with the existing data. UPLOAD HEADERS")
"RTN","TIUPS109",36,0)
 . D BMES^XPDUTL("which you have defined will NOT be overwritten.")
"RTN","TIUPS109",37,0)
 . S TIUDA=+TIUDA
"RTN","TIUPS109",38,0)
 ELSE  D  G ENCPQ:+TIUDA'>0
"RTN","TIUPS109",39,0)
 . D BMES^XPDUTL("I'm going to create a new Document Definition for CLINICAL PROCEDURES now.")
"RTN","TIUPS109",40,0)
 . S TIUDA=$$CREATE(TIUFPRIV) S:+TIUDA TIUNEW=1
"RTN","TIUPS109",41,0)
 . I +TIUDA'>0 D BMES^XPDUTL("Couldn't create Document Definition entry for CLINICAL PROCEDURES...")
"RTN","TIUPS109",42,0)
 D SET(TIUDA,TIUFPRIV)
"RTN","TIUPS109",43,0)
 D INDEX(TIUDA,TIUFPRIV)
"RTN","TIUPS109",44,0)
 I +TIUNEW D ATTACH(TIUDA,TIUFPRIV)
"RTN","TIUPS109",45,0)
 D DONE
"RTN","TIUPS109",46,0)
ENCPQ Q
"RTN","TIUPS109",47,0)
 ;
"RTN","TIUPS109",48,0)
CHKCP() ;Check for CLINICAL PROCEDURES entry in Document Definition file
"RTN","TIUPS109",49,0)
 ; Input  -- None
"RTN","TIUPS109",50,0)
 ; Output -- Document Definition Data from the TIU Document Definition file (#8925.1)
"RTN","TIUPS109",51,0)
 ;           1st Piece=IEN
"RTN","TIUPS109",52,0)
 ;           2nd Piece=Type field (#.04)
"RTN","TIUPS109",53,0)
 N TIUY
"RTN","TIUPS109",54,0)
 S TIUY=+$O(^TIU(8925.1,"B","CLINICAL PROCEDURES",0))
"RTN","TIUPS109",55,0)
 I +TIUY S $P(TIUY,U,2)=$P($G(^TIU(8925.1,+TIUY,0)),U,4)
"RTN","TIUPS109",56,0)
 Q TIUY
"RTN","TIUPS109",57,0)
 ;
"RTN","TIUPS109",58,0)
CREATE(TIUFPRIV) ;Create a record for the CLINICAL PROCEDURES Document Definition
"RTN","TIUPS109",59,0)
 ; Input  -- TIUFPRIV DD Privilege Flag
"RTN","TIUPS109",60,0)
 ; Output -- TIU Document Defintion file (#8925.1) IEN
"RTN","TIUPS109",61,0)
 N DIC,DLAYGO,X,Y
"RTN","TIUPS109",62,0)
 S (DIC,DLAYGO)="^TIU(8925.1,",DIC(0)="MXL",X="CLINICAL PROCEDURES"
"RTN","TIUPS109",63,0)
 D ^DIC
"RTN","TIUPS109",64,0)
 Q +$G(Y)
"RTN","TIUPS109",65,0)
 ;
"RTN","TIUPS109",66,0)
SET(TIUDA,TIUFPRIV) ;Set the data in the new Document Definition record
"RTN","TIUPS109",67,0)
 ; Input  -- TIUDA    TIU Document Definition file (#8925.1) IEN
"RTN","TIUPS109",68,0)
 ;           TIUFPRIV DD Privilege Flag
"RTN","TIUPS109",69,0)
 ; Output -- None
"RTN","TIUPS109",70,0)
 N TIUCLP
"RTN","TIUPS109",71,0)
 S TIUCLP=$$CLPAC
"RTN","TIUPS109",72,0)
 S ^TIU(8925.1,TIUDA,0)="CLINICAL PROCEDURES^CP^Clinical Procedures^CL^^"_TIUCLP_"^11^^^^^^1"
"RTN","TIUPS109",73,0)
 S ^TIU(8925.1,TIUDA,1)="8925^1^2;TEXT"
"RTN","TIUPS109",74,0)
 S ^TIU(8925.1,TIUDA,3)="^1^0"
"RTN","TIUPS109",75,0)
 S ^TIU(8925.1,TIUDA,4)="D LOOKUP^TIUPUTCP" ;Upload
"RTN","TIUPS109",76,0)
 S ^TIU(8925.1,TIUDA,4.1)="D POST^TIUCPCL(DA,""INCOMPLETE"")"
"RTN","TIUPS109",77,0)
 S ^TIU(8925.1,TIUDA,4.4)="D ROLLBACK^TIUCPCL(TIUDA)"
"RTN","TIUPS109",78,0)
 S ^TIU(8925.1,TIUDA,4.45)="D CHANGE^TIUCPCL(TIUDA)"
"RTN","TIUPS109",79,0)
 S ^TIU(8925.1,TIUDA,4.5)="D FOLLOWUP^TIUPUTCP(TIUREC(""#""))" ;Upload
"RTN","TIUPS109",80,0)
 S ^TIU(8925.1,TIUDA,4.8)="D GETCP^TIUPUTCP" ;Upload
"RTN","TIUPS109",81,0)
 S ^TIU(8925.1,TIUDA,4.9)="D POST^TIUCPCL(DA,""COMPLETED"")"
"RTN","TIUPS109",82,0)
 S ^TIU(8925.1,TIUDA,5)="[TIU ENTER/EDIT CLINPROC RESULT]" ;Upload/Edit
"RTN","TIUPS109",83,0)
 S ^TIU(8925.1,TIUDA,6)="D ENTRY^TIUPRCN"
"RTN","TIUPS109",84,0)
 S ^TIU(8925.1,TIUDA,6.1)="Progress Notes^Vice SF 509^^0"
"RTN","TIUPS109",85,0)
 S ^TIU(8925.1,TIUDA,7)="D ENPN^TIUVSIT(.TIU,.DFN,1)"
"RTN","TIUPS109",86,0)
 S ^TIU(8925.1,TIUDA,8)="S TIUASK=$$CHEKPN^TIULD(.TIU,.TIUBY)"
"RTN","TIUPS109",87,0)
 ; -- Don't modify upload header, if already defined --
"RTN","TIUPS109",88,0)
 I '$D(^TIU(8925.1,TIUDA,"HEAD")) D  ;Upload
"RTN","TIUPS109",89,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",0)="^8925.12A^11^11"
"RTN","TIUPS109",90,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",1,0)="TITLE^TITLE OF CLINICAL PROCEDURE^.01^TIUTITLE^GENERAL PROCEDURE^1^1"
"RTN","TIUPS109",91,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",2,0)="SSN^PATIENT SSN^.02^TIUSSN^***********^1^1"
"RTN","TIUPS109",92,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",2,1)="S X=$TR(X,""-/"","""")"
"RTN","TIUPS109",93,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",3,0)="VISIT/EVENT DATE^VISIT/EVENT DATE^.07^TIUVDT^5/15/2001@08:15^1^1"
"RTN","TIUPS109",94,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",4,0)="AUTHOR^DICTATING PROVIDER^1202^^HOWSER,DOOGEY^1^1"
"RTN","TIUPS109",95,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",5,0)="DATE/TIME OF DICTATION^DICTATION DATE/TIME^1307^TIUDDT^5/16/2001@09:25^0^1"
"RTN","TIUPS109",96,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",6,0)="LOCATION^PATIENT LOCATION^1205^TIULOC^MEDICAL-CONSULT 6200^1^1"
"RTN","TIUPS109",97,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",7,0)="EXPECTED COSIGNER^EXPECTED COSIGNER^1208^^WELBY,MARCUS^1^0"
"RTN","TIUPS109",98,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",8,0)="CONSULT REQUEST NUMBER^CONSULT REQUEST #^1405^TIUCNNBR^1455^1^1"
"RTN","TIUPS109",99,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",8,1)="S X=""C.""_X"
"RTN","TIUPS109",100,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",9,0)="TIU DOCUMENT NUMBER^TIU DOCUMENT #^.001^TIUPLDA^543^1^0"
"RTN","TIUPS109",101,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",10,0)="PROCEDURE SUMMARY CODE^PROCEDURE SUMMARY CODE^70201^TIUPSC^Normal^1^0"
"RTN","TIUPS109",102,0)
 . S ^TIU(8925.1,TIUDA,"HEAD",11,0)="DATE/TIME PERFORMED^DATE/TIME PERFORMED^70202^TIUDTP^5/15/2001@08:00^1^0"
"RTN","TIUPS109",103,0)
 ELSE  D
"RTN","TIUPS109",104,0)
 . I $P($G(^TIU(8925.1,TIUDA,"HEAD",5,0)),U,1)="DATE/TIME OF DICTATION",$P(^(0),U,3)=1301 S $P(^(0),U,3)=1307
"RTN","TIUPS109",105,0)
 Q
"RTN","TIUPS109",106,0)
 ;
"RTN","TIUPS109",107,0)
CLPAC() ;Get pointer to CLINICAL COORDINATOR User Class
"RTN","TIUPS109",108,0)
 ; Input  -- None
"RTN","TIUPS109",109,0)
 ; Output -- USR Class file (#8930) IEN
"RTN","TIUPS109",110,0)
 N TIUY
"RTN","TIUPS109",111,0)
 S TIUY=$O(^USR(8930,"B","CLINICAL COORDINATOR",0))
"RTN","TIUPS109",112,0)
 Q TIUY
"RTN","TIUPS109",113,0)
 ;
"RTN","TIUPS109",114,0)
INDEX(DA,TIUFPRIV) ;Call IX^DIK to re-index the CLINICAL PROCEDURES entry
"RTN","TIUPS109",115,0)
 ; Input  -- DA       TIU Document Defintion file (#8925.1) IEN
"RTN","TIUPS109",116,0)
 ;           TIUFPRIV DD Privilege Flag
"RTN","TIUPS109",117,0)
 ; Output -- None
"RTN","TIUPS109",118,0)
 N DIK
"RTN","TIUPS109",119,0)
 S DIK="^TIU(8925.1," D IX^DIK
"RTN","TIUPS109",120,0)
 Q
"RTN","TIUPS109",121,0)
 ;
"RTN","TIUPS109",122,0)
ATTACH(TIUDA,TIUFPRIV) ;Attach CLINICAL PROCEDURES to appropriate parent
"RTN","TIUPS109",123,0)
 ; Input  -- TIUDA    TIU Document Defintion file (#8925.1) IEN
"RTN","TIUPS109",124,0)
 ;           TIUFPRIV DD Privilege Flag
"RTN","TIUPS109",125,0)
 ; Output -- None
"RTN","TIUPS109",126,0)
 N DIC,DLAYGO,DIE,DR,X,Y
"RTN","TIUPS109",127,0)
 D BMES^XPDUTL("The new CLINICAL PROCEDURES Class will now be added under")
"RTN","TIUPS109",128,0)
 S DA(1)=38 ;CLINICAL DOCUMENTS Class
"RTN","TIUPS109",129,0)
 D BMES^XPDUTL("the "_$P(^TIU(8925.1,DA(1),0),U)_" Class...")
"RTN","TIUPS109",130,0)
 S DIC="^TIU(8925.1,"_DA(1)_",10,",DIC(0)="NXL"
"RTN","TIUPS109",131,0)
 S DIC("P")=$P(^DD(8925.1,10,0),U,2),X="`"_TIUDA
"RTN","TIUPS109",132,0)
 D ^DIC ; Create the sub-entry for CLINICAL PROCEDURES
"RTN","TIUPS109",133,0)
 I +Y'>0 D  G ATTACHQ
"RTN","TIUPS109",134,0)
 . D BMES^XPDUTL("Unable to add CLINICAL PROCEDURES under "_$P($G(^TIU(8925.1,DA(1),0)),U))
"RTN","TIUPS109",135,0)
 . D BMES^XPDUTL("You'll have to attach it manually.")
"RTN","TIUPS109",136,0)
 S DA=+Y,DIK=DIC K DIC
"RTN","TIUPS109",137,0)
 S ^TIU(8925.1,DA(1),10,DA,0)=$G(^TIU(8925.1,DA(1),10,DA,0))_"^^^Clinical Procedures"
"RTN","TIUPS109",138,0)
 D IX^DIK ; Cross-reference new subfile entry
"RTN","TIUPS109",139,0)
ATTACHQ Q
"RTN","TIUPS109",140,0)
 ;
"RTN","TIUPS109",141,0)
DONE ;Let the user know
"RTN","TIUPS109",142,0)
 ; Input  -- None
"RTN","TIUPS109",143,0)
 ; Output -- None
"RTN","TIUPS109",144,0)
 D BMES^XPDUTL("Okay, I'm done.")
"RTN","TIUPS109",145,0)
 D BMES^XPDUTL("Please finish your implementation of CLINICAL PROCEDURES by adding")
"RTN","TIUPS109",146,0)
 D BMES^XPDUTL("any Document Classes and Titles as appropriate using the Create")
"RTN","TIUPS109",147,0)
 D BMES^XPDUTL("Document Definitions Option under the TIUF DOCUMENT DEFINITION MGR Menu")
"RTN","TIUPS109",148,0)
 D BMES^XPDUTL("as described in the Post-Installation Instructions.")
"RTN","TIUPS109",149,0)
 Q
"RTN","TIUPUTCP")
0^14^B68872703
"RTN","TIUPUTCP",1,0)
TIUPUTCP ; SLC/JER,RMO - CP Look-up Method ; 5-MAR-2001 09:20:09
"RTN","TIUPUTCP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**109**;Jun 20, 1997
"RTN","TIUPUTCP",3,0)
 ; This routine is a modified version of TIUPUTCN
"RTN","TIUPUTCP",4,0)
LOOKUP ; Look-up code used by router/filer
"RTN","TIUPUTCP",5,0)
 ; Required: TIUSSN, TIUVDT, TIUCNNBR
"RTN","TIUPUTCP",6,0)
 N DA,DFN,TIU,TIUDAD,TIUDPRM,TIUEDIT,TIUEDT,TIULDT,TIUXCRP,TIUTYPE,TIUNEW,TIUDNB
"RTN","TIUPUTCP",7,0)
 I $S('$D(TIUSSN):1,'$D(TIUVDT):1,$G(TIUSSN)?4N:1,$G(TIUSSN)']"":1,1:0) S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",8,0)
 I TIUSSN?3N1P2N1P4N.E S TIUSSN=$TR(TIUSSN,"-/","")
"RTN","TIUPUTCP",9,0)
 I TIUSSN["?" S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",10,0)
 S TIULOC=+$$ILOC(TIULOC)
"RTN","TIUPUTCP",11,0)
 I '$D(^SC(+$G(TIULOC),0)) S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",12,0)
 S TIUEDT=$$IDATE^TIULC(TIUVDT),TIULDT=$$FMADD^XLFDT(TIUEDT,1)
"RTN","TIUPUTCP",13,0)
 I +TIUEDT'>0 S Y=-1 Q
"RTN","TIUPUTCP",14,0)
 S TIUTYPE=$$WHATITLE(TIUTITLE)
"RTN","TIUPUTCP",15,0)
 I +TIUTYPE'>0 S Y=-1 Q
"RTN","TIUPUTCP",16,0)
 I $P($G(^SC(+TIULOC,0)),U,3)="W" D  I 1
"RTN","TIUPUTCP",17,0)
 . D MAIN^TIUMOVE(.TIU,.DFN,TIUSSN,TIUEDT,TIULDT,1,"LAST",0,TIULOC)
"RTN","TIUPUTCP",18,0)
 E  D MAIN^TIUVSIT(.TIU,.DFN,TIUSSN,TIUEDT,TIULDT,"LAST",0,TIULOC)
"RTN","TIUPUTCP",19,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,1:0) S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",20,0)
 I $P(+$G(TIU("EDT")),".")'=$P($$IDATE^TIULC(TIUVDT),".") S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",21,0)
 D DOCPRM^TIULC1(TIUTYPE,.TIUDPRM)
"RTN","TIUPUTCP",22,0)
 ;
"RTN","TIUPUTCP",23,0)
 ;Check consult associated with document
"RTN","TIUPUTCP",24,0)
 I '$$CHKCN($G(TIUCNNBR),DFN,$G(TIUPLDA),.TIUDNB) S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",25,0)
 ;
"RTN","TIUPUTCP",26,0)
 ;Check status of consult as it relates to CP
"RTN","TIUPUTCP",27,0)
 I '$$CHKCP($G(TIUCNNBR),$G(TIUPLDA),.TIUDNB) S Y=-1 G LOOKUPX
"RTN","TIUPUTCP",28,0)
 S TIUTYP(1)=1_U_TIUTYPE_U_$$PNAME^TIULC1(TIUTYPE)
"RTN","TIUPUTCP",29,0)
 ;
"RTN","TIUPUTCP",30,0)
 ;If TIU document IEN is defined use it, otherwise call TIUEDI3
"RTN","TIUPUTCP",31,0)
 I $G(TIUPLDA)>0 D
"RTN","TIUPUTCP",32,0)
 . S Y=TIUPLDA
"RTN","TIUPUTCP",33,0)
 ELSE  D
"RTN","TIUPUTCP",34,0)
 . S Y=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.TIUNEW,.TIUDPRM)
"RTN","TIUPUTCP",35,0)
 I +Y'>0 G LOOKUPX
"RTN","TIUPUTCP",36,0)
 ; If record is not new, has text and can be edited, then replace
"RTN","TIUPUTCP",37,0)
 ; existing text
"RTN","TIUPUTCP",38,0)
 I +$G(TIUNEW)'>0 D
"RTN","TIUPUTCP",39,0)
 . S TIUEDIT=$$CANEDIT(+Y)
"RTN","TIUPUTCP",40,0)
 . I +TIUEDIT>0,$D(^TIU(8925,+Y,"TEXT")) D DELTEXT(+Y)
"RTN","TIUPUTCP",41,0)
 . I +TIUEDIT'>0 S TIUDAD=+Y,Y=$$MAKEADD
"RTN","TIUPUTCP",42,0)
 I +Y'>0 Q
"RTN","TIUPUTCP",43,0)
 D STUFREC(Y,+$G(TIUDAD))
"RTN","TIUPUTCP",44,0)
 I +$G(TIUDAD) D SENDADD^TIUALRT(+Y)
"RTN","TIUPUTCP",45,0)
 ;Kill elements of TIUHDR so data is not filed twice
"RTN","TIUPUTCP",46,0)
 K TIUHDR(.01),TIUHDR(.07),TIUHDR(1301)
"RTN","TIUPUTCP",47,0)
 K TIUHDR(.001),TIUHDR(70201),TIUHDR(70202)
"RTN","TIUPUTCP",48,0)
LOOKUPX Q
"RTN","TIUPUTCP",49,0)
ILOC(LOCATION) ; Get pointer to file 44
"RTN","TIUPUTCP",50,0)
 N DIC,X,Y
"RTN","TIUPUTCP",51,0)
 S DIC=44,DIC(0)="M",X=LOCATION D ^DIC
"RTN","TIUPUTCP",52,0)
 Q Y
"RTN","TIUPUTCP",53,0)
CANEDIT(DA) ; Check whether or not document is signed
"RTN","TIUPUTCP",54,0)
 Q $S(+$P($G(^TIU(8925,+DA,0)),U,5)<6:1,1:0)
"RTN","TIUPUTCP",55,0)
 ;
"RTN","TIUPUTCP",56,0)
CHKCN(TIUCDA,DFN,TIUDA,TIUDNB) ;Check if Consult is associated with correct patient
"RTN","TIUPUTCP",57,0)
 ;and document
"RTN","TIUPUTCP",58,0)
 ; Input  -- TIUCDA   Request/Consult file (#123) IEN
"RTN","TIUPUTCP",59,0)
 ;           DFN      Patient file (#2) IEN
"RTN","TIUPUTCP",60,0)
 ;           TIUDA    TIU Document file (#8925) IEN  (Optional)
"RTN","TIUPUTCP",61,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUPUTCP",62,0)
 ;           TIUDNB   Dialogue Number for Error Message  (Optional)
"RTN","TIUPUTCP",63,0)
 N OKF
"RTN","TIUPUTCP",64,0)
 ;
"RTN","TIUPUTCP",65,0)
 I $G(TIUCDA)']"" S TIUDNB=89250009 G CHKCNQ
"RTN","TIUPUTCP",66,0)
 ;
"RTN","TIUPUTCP",67,0)
 ;Check if the patient is associated with the consult
"RTN","TIUPUTCP",68,0)
 I '$$CPPAT^GMRCCP(TIUCDA,DFN) S TIUDNB=89250006 G CHKCNQ
"RTN","TIUPUTCP",69,0)
 ;
"RTN","TIUPUTCP",70,0)
 ;Check 0th node and consult if document IEN is defined
"RTN","TIUPUTCP",71,0)
 I $G(TIUDA)>0 D  G CHKCNQ:$G(TIUDNB)
"RTN","TIUPUTCP",72,0)
 . ;Check if 0th node of document is defined
"RTN","TIUPUTCP",73,0)
 . I $G(^TIU(8925,TIUDA,0))="" S TIUDNB=89250007 Q
"RTN","TIUPUTCP",74,0)
 . ;Check if consult is associated with the document
"RTN","TIUPUTCP",75,0)
 . I +$P($G(^TIU(8925,TIUDA,14)),U,5)'=TIUCDA S TIUDNB=89250008 Q
"RTN","TIUPUTCP",76,0)
 ;
"RTN","TIUPUTCP",77,0)
 ;Set success flag
"RTN","TIUPUTCP",78,0)
 S OKF=1
"RTN","TIUPUTCP",79,0)
 ;
"RTN","TIUPUTCP",80,0)
CHKCNQ Q +$G(OKF)
"RTN","TIUPUTCP",81,0)
 ;
"RTN","TIUPUTCP",82,0)
CHKCP(TIUCDA,TIUDA,TIUDNB) ;Check status of Consult as it relates to CP
"RTN","TIUPUTCP",83,0)
 ; Input  -- TIUCDA   Request/Consult file (#123) IEN
"RTN","TIUPUTCP",84,0)
 ;           TIUDA    TIU Document file (#8925) IEN  (Optional)
"RTN","TIUPUTCP",85,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUPUTCP",86,0)
 ;           TIUDNB   Dialogue Number for Error Message  (Optional)
"RTN","TIUPUTCP",87,0)
 N OKF,TIUCPACT
"RTN","TIUPUTCP",88,0)
 S TIUCPACT=$$CPACTM^GMRCCP(TIUCDA)
"RTN","TIUPUTCP",89,0)
 I 'TIUCPACT S TIUDNB=89250010 G CHKCPQ
"RTN","TIUPUTCP",90,0)
 I TIUCPACT=2 S TIUDNB=89250011 G CHKCPQ
"RTN","TIUPUTCP",91,0)
 I TIUCPACT=3,$G(TIUDA)'>0 S TIUDNB=89250012 G CHKCPQ
"RTN","TIUPUTCP",92,0)
 ;
"RTN","TIUPUTCP",93,0)
 ;Set success flag
"RTN","TIUPUTCP",94,0)
 S OKF=1
"RTN","TIUPUTCP",95,0)
 ;
"RTN","TIUPUTCP",96,0)
CHKCPQ Q +$G(OKF)
"RTN","TIUPUTCP",97,0)
 ;
"RTN","TIUPUTCP",98,0)
MAKEADD() ; Create an addendum record
"RTN","TIUPUTCP",99,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUFPRIV S TIUFPRIV=1
"RTN","TIUPUTCP",100,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM")
"RTN","TIUPUTCP",101,0)
 S (DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUPUTCP",102,0)
 D ^DIC
"RTN","TIUPUTCP",103,0)
 S DA=+Y
"RTN","TIUPUTCP",104,0)
 I +DA>0 S DIE=DIC,DR=".04////"_$$DOCCLASS^TIULC1(TIUATYP) D ^DIE
"RTN","TIUPUTCP",105,0)
 K TIUHDR(.01)
"RTN","TIUPUTCP",106,0)
 Q +DA
"RTN","TIUPUTCP",107,0)
STUFREC(DA,PARENT) ; Stuff fixed field data
"RTN","TIUPUTCP",108,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIUPSCI,TIUDTPI
"RTN","TIUPUTCP",109,0)
 S IENS=""""_DA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="K"
"RTN","TIUPUTCP",110,0)
 I +$G(PARENT)'>0 D
"RTN","TIUPUTCP",111,0)
 . I '$G(TIUPLDA) D
"RTN","TIUPUTCP",112,0)
 . . S @FDARR@(.02)=$G(DFN),@FDARR@(.03)=$P($G(TIU("VISIT")),U)
"RTN","TIUPUTCP",113,0)
 . . S @FDARR@(.07)=$P($G(TIU("EDT")),U)
"RTN","TIUPUTCP",114,0)
 . . S @FDARR@(.08)=$P($G(TIU("LDT")),U)
"RTN","TIUPUTCP",115,0)
 . . S @FDARR@(1201)=$$NOW^TIULC
"RTN","TIUPUTCP",116,0)
 . . S @FDARR@(1205)=$S(+$P($G(TIU("LOC")),U):$P($G(TIU("LOC")),U),1:$P($G(TIU("VLOC")),U))
"RTN","TIUPUTCP",117,0)
 . . S @FDARR@(1404)=$P($G(TIU("SVC")),U)
"RTN","TIUPUTCP",118,0)
 . I '$G(TIUPLDA)!('$P($G(^TIU(8925,+$G(TIUPLDA),13)),U,4)) S @FDARR@(.05)=3
"RTN","TIUPUTCP",119,0)
 I +$G(PARENT)>0 D
"RTN","TIUPUTCP",120,0)
 . S @FDARR@(.02)=+$P($G(^TIU(8925,+PARENT,0)),U,2)
"RTN","TIUPUTCP",121,0)
 . S @FDARR@(.03)=$P($G(^TIU(8925,+PARENT,0)),U,3)
"RTN","TIUPUTCP",122,0)
 . S @FDARR@(.05)=3
"RTN","TIUPUTCP",123,0)
 . S @FDARR@(.06)=PARENT
"RTN","TIUPUTCP",124,0)
 . S @FDARR@(.07)=$P($G(^TIU(8925,+PARENT,0)),U,7)
"RTN","TIUPUTCP",125,0)
 . S @FDARR@(.08)=$P($G(^TIU(8925,+PARENT,0)),U,8)
"RTN","TIUPUTCP",126,0)
 . S @FDARR@(1205)=$P($G(^TIU(8925,+PARENT,12)),U,5)
"RTN","TIUPUTCP",127,0)
 . S @FDARR@(1404)=$P($G(^TIU(8925,+PARENT,14)),U,4)
"RTN","TIUPUTCP",128,0)
 . S @FDARR@(1201)=$$NOW^TIULC
"RTN","TIUPUTCP",129,0)
 I '$G(TIUPLDA) S @FDARR@(1205)=$P($G(TIU("LOC")),U)
"RTN","TIUPUTCP",130,0)
 S @FDARR@(1301)=$S($G(TIUDDT)]"":$$IDATE^TIULC($G(TIUDDT)),1:"")
"RTN","TIUPUTCP",131,0)
 I @FDARR@(1301)'>0 S @FDARR@(1301)=$G(@FDARR@(.07))
"RTN","TIUPUTCP",132,0)
 S @FDARR@(1303)="U"
"RTN","TIUPUTCP",133,0)
 I $G(TIUPSC)]"" D VAL^DIE(8925,DA,70201,,TIUPSC,.TIUPSCI)
"RTN","TIUPUTCP",134,0)
 S @FDARR@(70201)=$S($G(TIUPSCI):TIUPSCI,1:"")
"RTN","TIUPUTCP",135,0)
 I '$G(TIUPLDA)!($P($G(^TIU(8925,+$G(TIUPLDA),702)),U,2))="" D
"RTN","TIUPUTCP",136,0)
 . I $G(TIUDTP)]"" D VAL^DIE(8925,DA,70202,,TIUDTP,.TIUDTPI)
"RTN","TIUPUTCP",137,0)
 . S @FDARR@(70202)=$S($G(TIUDTPI):TIUDTPI,1:"")
"RTN","TIUPUTCP",138,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUPUTCP",139,0)
 Q
"RTN","TIUPUTCP",140,0)
DELTEXT(DA) ; Delete existing text in preparation for replacement
"RTN","TIUPUTCP",141,0)
 N DIE,DR,X,Y
"RTN","TIUPUTCP",142,0)
 S DIE=8925,DR="2///@" D ^DIE
"RTN","TIUPUTCP",143,0)
 Q
"RTN","TIUPUTCP",144,0)
WHATYPE(X) ; Identify document type
"RTN","TIUPUTCP",145,0)
 ; Receives: X=Document Definition Name
"RTN","TIUPUTCP",146,0)
 ;  Returns: Y=Document Definition IFN
"RTN","TIUPUTCP",147,0)
 N DIC,Y,TIUFPRIV S TIUFPRIV=1
"RTN","TIUPUTCP",148,0)
 S DIC=8925.1,DIC(0)="M"
"RTN","TIUPUTCP",149,0)
 S DIC("S")="I +$O(^TIU(8925.1,+Y,""HEAD"",0))!+$O(^TIU(8295.1,+Y,""ITEM"",0))"
"RTN","TIUPUTCP",150,0)
 D ^DIC K DIC("S")
"RTN","TIUPUTCP",151,0)
WHATYPX Q Y
"RTN","TIUPUTCP",152,0)
WHATITLE(X) ; Identify document title
"RTN","TIUPUTCP",153,0)
 ; Receives: X=Document Definition Name
"RTN","TIUPUTCP",154,0)
 ;  Returns: Y=Document Definition IFN
"RTN","TIUPUTCP",155,0)
 N DIC,Y,TIUFPRIV,SCREEN,TIUCLASS S TIUFPRIV=1
"RTN","TIUPUTCP",156,0)
 S DIC=8925.1,DIC(0)="M",TIUCLASS=+$$CLASS^TIUCP
"RTN","TIUPUTCP",157,0)
 S SCREEN="I $P(^TIU(8925.1,+Y,0),U,4)=""DOC"",+$$ISA^TIULX(+Y,"_TIUCLASS_"),+$$CANPICK^TIULP(+Y)"
"RTN","TIUPUTCP",158,0)
 S DIC("S")=SCREEN
"RTN","TIUPUTCP",159,0)
 D ^DIC K DIC("S")
"RTN","TIUPUTCP",160,0)
WHATITX Q Y
"RTN","TIUPUTCP",161,0)
FOLLOWUP(TIUDA) ; Post-filing code for CLINICAL PROCEDURES
"RTN","TIUPUTCP",162,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIU,DFN
"RTN","TIUPUTCP",163,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="K"
"RTN","TIUPUTCP",164,0)
 S @FDARR@(1204)=$$WHOSIGNS^TIULC1(TIUDA)
"RTN","TIUPUTCP",165,0)
 I +$P($G(^TIU(8925,TIUDA,12)),U,9),'+$P($G(^(12)),U,8) D
"RTN","TIUPUTCP",166,0)
 . S @FDARR@(1208)=$$WHOCOSIG^TIULC1(TIUDA)
"RTN","TIUPUTCP",167,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG")
"RTN","TIUPUTCP",168,0)
 I +$P($G(^TIU(8925,+TIUDA,12)),U,8),(+$P($G(^TIU(8925,+TIUDA,12)),U,4)'=+$P($G(^(12)),U,8)) D
"RTN","TIUPUTCP",169,0)
 . S @FDARR@(1506)=1 D FILE^DIE(FLAGS,"FDA","TIUMSG")
"RTN","TIUPUTCP",170,0)
 D RELEASE^TIUT(TIUDA,1)
"RTN","TIUPUTCP",171,0)
 D AUDIT^TIUEDI1(TIUDA,0,$$CHKSUM^TIULC("^TIU(8925,"_+TIUDA_",""TEXT"")"))
"RTN","TIUPUTCP",172,0)
 I +$P($G(^TIU(8925,+TIUDA,14)),U,5) D
"RTN","TIUPUTCP",173,0)
 . N TIUCDA,DA S TIUCDA=+$P($G(^TIU(8925,+TIUDA,14)),U,5)
"RTN","TIUPUTCP",174,0)
 . W !,$$PNAME^TIULC1(+$G(^TIU(8925,+TIUDA,0)))," #: ",TIUDA
"RTN","TIUPUTCP",175,0)
 . W " Linked to Consult Request #: ",TIUCDA,".",!
"RTN","TIUPUTCP",176,0)
 . ; Post result in CT Pkg
"RTN","TIUPUTCP",177,0)
 . D GET^GMRCTIU(TIUCDA,TIUDA,"INCOMPLETE RPT")
"RTN","TIUPUTCP",178,0)
 I '$D(TIU("VSTR")) D
"RTN","TIUPUTCP",179,0)
 . N TIUD0,TIUD12,TIUVLOC,TIUHLOC,TIUEDT,TIULDT
"RTN","TIUPUTCP",180,0)
 . S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^(12))
"RTN","TIUPUTCP",181,0)
 . S DFN=+$P(TIUD0,U,2),TIUEDT=+$P(TIUD0,U,7)
"RTN","TIUPUTCP",182,0)
 . S TIULDT=$$FMADD^XLFDT(TIUEDT,1),TIUHLOC=+$P(TIUD12,U,5)
"RTN","TIUPUTCP",183,0)
 . S TIUVLOC=$S(+$P(TIUD12,U,11):+$P(TIUD12,U,11),1:+TIUHLOC)
"RTN","TIUPUTCP",184,0)
 . I $S(+DFN'>0:1,+TIUEDT'>0:1,+TIULDT'>0:1,+TIUVLOC'>0:1,1:0) Q
"RTN","TIUPUTCP",185,0)
 . D MAIN^TIUVSIT(.TIU,DFN,"",TIUEDT,TIULDT,"LAST",0,+TIUVLOC)
"RTN","TIUPUTCP",186,0)
 Q:'$D(TIU("VSTR"))
"RTN","TIUPUTCP",187,0)
 D QUE^TIUPXAP1 ; Get/file VISIT
"RTN","TIUPUTCP",188,0)
 Q
"RTN","TIUPUTCP",189,0)
GETCP ; Help get Fields for CP Dictation/Error Resolution
"RTN","TIUPUTCP",190,0)
 N TIU,DFN,TIUY,TITLE,TIUBUF,TIUPLDA,TIUMVN,TIUVSTR
"RTN","TIUPUTCP",191,0)
 W ! S DFN=+$$PATIENT^TIULA G GETCPQ:+DFN'>0
"RTN","TIUPUTCP",192,0)
 S TIUBUF=$S(+$G(BUFDA):+$G(BUFDA),+$G(XQADATA):+$G(XQADATA),1:"")
"RTN","TIUPUTCP",193,0)
 ;If there is a buffer entry with a TIU Document Number, ask for document
"RTN","TIUPUTCP",194,0)
 I $G(TIUBUF),$$CHKUPL(TIUBUF) D  G GETCPQ:'$D(TIU)
"RTN","TIUPUTCP",195,0)
 . I $$ASKUPL(DFN,.TIUPLDA) D
"RTN","TIUPUTCP",196,0)
 . . ;If Patient Movement
"RTN","TIUPUTCP",197,0)
 . . I +$G(^TIU(8925,+TIUPLDA,14)) D
"RTN","TIUPUTCP",198,0)
 . . . S TIUMVN=+$G(^TIU(8925,+TIUPLDA,14))
"RTN","TIUPUTCP",199,0)
 . . ;Else set up Visit string
"RTN","TIUPUTCP",200,0)
 . . ELSE  D
"RTN","TIUPUTCP",201,0)
 . . . S TIUVSTR=$P($G(^TIU(8925,+TIUPLDA,12)),U,11)_";"_$P($G(^TIU(8925,+TIUPLDA,0)),U,7)_";"_$P($G(^TIU(8925,+TIUPLDA,0)),U,13)
"RTN","TIUPUTCP",202,0)
 . . ;Populate demographic and Visit information
"RTN","TIUPUTCP",203,0)
 . . D PATVADPT^TIULV(.TIU,DFN,$G(TIUMVN),$G(TIUVSTR))
"RTN","TIUPUTCP",204,0)
 ELSE  D  G GETCPQ:'$D(TIU)
"RTN","TIUPUTCP",205,0)
 . ;If there is no stub ask for Visit
"RTN","TIUPUTCP",206,0)
 . D ENPN^TIUVSIT(.TIU,+DFN,1)
"RTN","TIUPUTCP",207,0)
 . I '$D(TIU) Q
"RTN","TIUPUTCP",208,0)
 . S TIUY=$$CHEKPN^TIUCHLP(.TIU)
"RTN","TIUPUTCP",209,0)
 D MAKE^TIUCPFIX(.SUCCESS,DFN,.TITLE,.TIU,$G(TIUBUF),$G(TIUPLDA))
"RTN","TIUPUTCP",210,0)
 I +SUCCESS D
"RTN","TIUPUTCP",211,0)
 . S TIUDONE=1
"RTN","TIUPUTCP",212,0)
 ELSE  D
"RTN","TIUPUTCP",213,0)
 . W !!,"Please correct the buffered upload data.",!,$P(SUCCESS,U,2),!
"RTN","TIUPUTCP",214,0)
 . I $$READ^TIUU("FOA","Press RETURN to continue...") W ""
"RTN","TIUPUTCP",215,0)
GETCPQ Q
"RTN","TIUPUTCP",216,0)
 ;
"RTN","TIUPUTCP",217,0)
CHKUPL(TIUBUF) ;Check if Buffer Entry has TIU Document Number
"RTN","TIUPUTCP",218,0)
 ; Input  -- TIUBUF   TIU Upload Buffer file (#8925.2) IEN
"RTN","TIUPUTCP",219,0)
 ; Output -- 1=Yes and 0=No
"RTN","TIUPUTCP",220,0)
 N TIUX,Y
"RTN","TIUPUTCP",221,0)
 D LOADTIUX^TIUCPFIX(.TIUX,TIUBUF)
"RTN","TIUPUTCP",222,0)
 I $G(TIUX(.001)) S Y=1
"RTN","TIUPUTCP",223,0)
 Q +$G(Y)
"RTN","TIUPUTCP",224,0)
 ;
"RTN","TIUPUTCP",225,0)
ASKUPL(DFN,TIUPLDA) ;Ask TIU Document Number for Error Resolution
"RTN","TIUPUTCP",226,0)
 ; Input  -- DFN      Patient file (#2) IEN
"RTN","TIUPUTCP",227,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUPUTCP",228,0)
 ;           TIUPLDA  TIU Document file (#8925) IEN
"RTN","TIUPUTCP",229,0)
 N D,DD,DIC,DINUM,DLAYGO,D0,X,Y
"RTN","TIUPUTCP",230,0)
 S DIC="^TIU(8925,",DIC(0)="EUVX",D="C"
"RTN","TIUPUTCP",231,0)
 S X=DFN
"RTN","TIUPUTCP",232,0)
 S DIC("S")="I $P(^(0),U,5)=1,+$$ISA^TIULX(+$P(^(0),U),+$$CLASS^TIUCP)"
"RTN","TIUPUTCP",233,0)
 S DIC("W")="D ID^TIUPUTCP(+Y)"
"RTN","TIUPUTCP",234,0)
 D IX^DIC
"RTN","TIUPUTCP",235,0)
 I Y>0 S TIUPLDA=+Y
"RTN","TIUPUTCP",236,0)
 Q $S($G(TIUPLDA)="":0,1:1)
"RTN","TIUPUTCP",237,0)
 ;
"RTN","TIUPUTCP",238,0)
ID(TIUDA) ;Display TIU Document Information for Error Resolution
"RTN","TIUPUTCP",239,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN  (Optional)
"RTN","TIUPUTCP",240,0)
 ; Output -- None
"RTN","TIUPUTCP",241,0)
 W !?12,"Document #: ",TIUDA
"RTN","TIUPUTCP",242,0)
 W ?34,"Dated: ",$$DATE^TIULS(+$G(^TIU(8925,+TIUDA,13)),"MM/DD/CCYY@HR:MIN")
"RTN","TIUPUTCP",243,0)
 W ?60,"Consult #: ",+$P($G(^TIU(8925,+TIUDA,14)),U,5)
"RTN","TIUPUTCP",244,0)
 Q
"RTN","TIURA")
0^24^B56454761
"RTN","TIURA",1,0)
TIURA ; SLC/JER - Review screen actions ; 7-MAR-2001 09:12:29
"RTN","TIURA",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,10,20,79,88,58,100,109**;Jun 20, 1997
"RTN","TIURA",3,0)
 ; 6/20/00: Split rtn into TIURA and TIURA2, with DISPLAY,
"RTN","TIURA",4,0)
 ; BROWSE, and BROWS1 going into TIURA2.
"RTN","TIURA",5,0)
EDIT ; Edit Documents
"RTN","TIURA",6,0)
 N TIUDA,DFN,TIUDDT,TIUDATA,TIUCHNG,TIUEDIT,TIUI,DIROUT,TIUDAARY
"RTN","TIURA",7,0)
 N TIULST,MSGVERB
"RTN","TIURA",8,0)
 S TIUI=0
"RTN","TIURA",9,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURA",10,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURA",11,0)
 . N RSTRCTD
"RTN","TIURA",12,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURA",13,0)
 . D CLEAR^VALM1 W !!,"Editing #",+TIUDATA
"RTN","TIURA",14,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURA",15,0)
 . I RSTRCTD D  Q
"RTN","TIURA",16,0)
 . . W !!,$C(7),"Ok, no harm done...",!
"RTN","TIURA",17,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURA",18,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURA",19,0)
 . S TIUCHNG=0
"RTN","TIURA",20,0)
 . I +$D(^TIU(8925,+TIUDA,0)) D EDIT1
"RTN","TIURA",21,0)
 . I +$G(TIUCHNG) D
"RTN","TIURA",22,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURA",23,0)
 ; -- Update or Rebuild list, restore video: --
"RTN","TIURA",24,0)
 I $G(TIUCHNG("ADDM"))!$G(TIUCHNG("DELETE")) S TIUCHNG("RBLD")=1
"RTN","TIURA",25,0)
 E  S TIUCHNG("UPDATE")=1
"RTN","TIURA",26,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURA",27,0)
 S VALMBCK="R"
"RTN","TIURA",28,0)
 S MSGVERB=$S($G(TIUCHNG("ADDM")):"edited/addended",1:"edited")
"RTN","TIURA",29,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,MSGVERB)
"RTN","TIURA",30,0)
 Q
"RTN","TIURA",31,0)
EDIT1 ; Single record edit
"RTN","TIURA",32,0)
 ; Receives TIUDA
"RTN","TIURA",33,0)
 N %X,%Y,C,D,D0,DDWTMP,DFN,DI,DIC,TIUEDIT,TIUMSG,TIUQUIT,TIUADD,TIUREL
"RTN","TIURA",34,0)
 N TIUTYP,TIUT0,TIUDPRM,TIULDT,DIWESUB,TIU,TIUCMMTX
"RTN","TIURA",35,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIURA",36,0)
 I '+$G(TIUDA) W !,"No Documents selected." H 2 Q
"RTN","TIURA",37,0)
 ; Evaluate edit privilege
"RTN","TIURA",38,0)
 S TIUEDIT=$$CANDO^TIULP(TIUDA,"EDIT RECORD")
"RTN","TIURA",39,0)
 ; if 'canedit, offer explanation, and let add addendum
"RTN","TIURA",40,0)
 I '+TIUEDIT D  Q
"RTN","TIURA",41,0)
 . K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIURA",42,0)
 . W !!,$C(7),$P(TIUEDIT,U,2),!
"RTN","TIURA",43,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...")
"RTN","TIURA",44,0)
 . D ADDENDUM^TIUADD(TIUDA,"",.TIUCHNG)
"RTN","TIURA",45,0)
 S TIUTYP=+$G(^TIU(8925,+TIUDA,0)),TIUT0=$G(^TIU(8925.1,+TIUTYP,0))
"RTN","TIURA",46,0)
 S TIUTYP(1)="1^"_+TIUTYP_U_$P(TIUT0,U,3)_U
"RTN","TIURA",47,0)
 S DFN=$P($G(^TIU(8925,+TIUDA,0)),U,2),TIULDT=$P(^(0),U,8)
"RTN","TIURA",48,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIURA",49,0)
 S DIWESUB="Patient: "_$G(TIU("PNM"))
"RTN","TIURA",50,0)
 D DIE^TIUEDI4(TIUDA,.TIUQUIT,.TIUCHNG) ; **100**
"RTN","TIURA",51,0)
 K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIURA",52,0)
 I +$G(TIUCPYNG),+$G(TIUQUIT) D DELETE^TIUEDIT(TIUDA,0,"",1) Q
"RTN","TIURA",53,0)
 Q:+$G(TIUQUIT)=2
"RTN","TIURA",54,0)
 ;If (CP) and (Timeout or Not Select Consult) and (Consult Associated), Quit before EMPTYDOC check
"RTN","TIURA",55,0)
 I +$$ISA^TIULX(TIUTYP,+$$CLASS^TIUCP),+$G(TIUQUIT)=1,+$P($G(^TIU(8925,+TIUDA,14)),U,5)>0 Q
"RTN","TIURA",56,0)
 I $$EMPTYDOC^TIULF(TIUDA) D DELETE^TIUEDIT(TIUDA,0) S TIUCHNG("DELETE")=1 H 2 Q
"RTN","TIURA",57,0)
 Q:+$G(TIUQUIT)
"RTN","TIURA",58,0)
 I +$G(TIU("STOP")) D DEFER^TIUVSIT(TIUDA,TIU("STOP")) I 1
"RTN","TIURA",59,0)
 E  I +$P($G(^TIU(8925,+TIUDA,0)),U,3)'>0 D QUE^TIUPXAP1
"RTN","TIURA",60,0)
 ; - Commit proc -
"RTN","TIURA",61,0)
 S TIUCMMTX=$$COMMIT^TIULC1(+$P(TIUTYP(1),U,2))
"RTN","TIURA",62,0)
 I TIUCMMTX]"" D
"RTN","TIURA",63,0)
 . N DA S DA=TIUDA X TIUCMMTX
"RTN","TIURA",64,0)
 ;   i. Execute RELEASE logic
"RTN","TIURA",65,0)
 D RELEASE^TIUT(+TIUDA)
"RTN","TIURA",66,0)
 ;  ii. Execute VERIFICATION logic
"RTN","TIURA",67,0)
 D VERIFY^TIUT(+TIUDA)
"RTN","TIURA",68,0)
 ; iii. Execute ES logic
"RTN","TIURA",69,0)
 D EDSIG^TIURS(+TIUDA,"",1)
"RTN","TIURA",70,0)
 ;  iv. If document is an ADDENDUM process alert
"RTN","TIURA",71,0)
 I +$$ISADDNDM^TIULC1(+TIUDA) D SENDADD^TIUALRT(+TIUDA)
"RTN","TIURA",72,0)
 I $D(^TMP("TIUR",$J,"CTXT")),(+$P($G(^TIU(8925,+TIUDA,0)),U,5)'<6) S VALMBCK="Q"
"RTN","TIURA",73,0)
 Q
"RTN","TIURA",74,0)
PRINT ; Print selected documents
"RTN","TIURA",75,0)
 N DFN,TIUDA,TIUDARR,TIUDATA,TIUI,DIROUT,TIUDE,POP,TIUPFLG
"RTN","TIURA",76,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0)) G:$D(VALMY)'>9 PRINTX
"RTN","TIURA",77,0)
 D CLEAR^VALM1
"RTN","TIURA",78,0)
 D PRNTSCRN^TIURA2(.VALMY)
"RTN","TIURA",79,0)
 I '$D(VALMY) D  G PRINTX
"RTN","TIURA",80,0)
 . W !!,"No Printable Documents Remain in your List.",!
"RTN","TIURA",81,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...")
"RTN","TIURA",82,0)
 I +$$CHARTANY^TIURA1(.VALMY) S TIUPFLG=$$FLAG^TIUPRPN3
"RTN","TIURA",83,0)
 S TIUDEV=$$DEVICE^TIUDEV(.IO) ; Get Device/allow queueing
"RTN","TIURA",84,0)
 I $S(IO']"":1,TIUDEV']"":1,1:0) G PRINTX
"RTN","TIURA",85,0)
 I $D(IO("Q")) D QUE^TIUDEV("PRINTN^TIURA",TIUDEV) G PRINTX
"RTN","TIURA",86,0)
 D PRINTN
"RTN","TIURA",87,0)
PRINTX N IOSTBM D ^%ZISC,FIXLSTNW^TIULM
"RTN","TIURA",88,0)
 K VALMY S VALMBCK="R"
"RTN","TIURA",89,0)
 Q
"RTN","TIURA",90,0)
PRINTN ; Loop through selected doc's & invoke print code
"RTN","TIURA",91,0)
 N TIUI,TIUTYP,TIUDARR,DFN K ^TMP("TIUPR",$J)
"RTN","TIURA",92,0)
 N ARRAYDA
"RTN","TIURA",93,0)
 U IO
"RTN","TIURA",94,0)
 S TIUI=0
"RTN","TIURA",95,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURA",96,0)
 . N TIUPMTHD,TIUDTYP,TIUPFHDR,TIUPFNBR,TIUPGRP,TIUPRINT,TIUFLAG
"RTN","TIURA",97,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURA",98,0)
 . S TIUDA=+$P(TIUDATA,U,2),TIUTYP=$P(^TIU(8925,TIUDA,0),U)
"RTN","TIURA",99,0)
 . S ARRAYDA(TIUDA)=""
"RTN","TIURA",100,0)
 . ; -- If TIUDA is an addendum, print its parent instead,
"RTN","TIURA",101,0)
 . ;    or quit if the parent has already been printed: --
"RTN","TIURA",102,0)
 . I +$$ISADDNDM^TIULC1(TIUDA) D  Q:'TIUDA
"RTN","TIURA",103,0)
 . . S TIUDA=+$P($G(^TIU(8925,TIUDA,0)),U,6)
"RTN","TIURA",104,0)
 . . I $D(ARRAYDA(TIUDA)) S TIUDA=0 Q
"RTN","TIURA",105,0)
 . . S TIUDTYP=+$G(^TIU(8925,TIUDA,0))
"RTN","TIURA",106,0)
 . ; -- If TIUDA is an ID kid, print its parent instead,
"RTN","TIURA",107,0)
 . ;    or quit if the parent has already been printed: --
"RTN","TIURA",108,0)
 . I $G(^TIU(8925,TIUDA,21)) D  Q:'TIUDA
"RTN","TIURA",109,0)
 . . S TIUDA=^TIU(8925,TIUDA,21)
"RTN","TIURA",110,0)
 . . I $D(ARRAYDA(TIUDA)) S TIUDA=0 Q
"RTN","TIURA",111,0)
 . . S TIUDTYP=+$G(^TIU(8925,TIUDA,0))
"RTN","TIURA",112,0)
 . S TIUPRINT=$$CANDO^TIULP(TIUDA,"PRINT RECORD")
"RTN","TIURA",113,0)
 . I +TIUPRINT'>0 D  Q  ; Exclude records user can't print
"RTN","TIURA",114,0)
 . . W !!,"Item #",TIUI,": ",!,$P(TIUPRINT,U,2),!
"RTN","TIURA",115,0)
 . . I IO=IO(0),'$D(ZTQUEUED),$$READ^TIUU("EA","RETURN to continue...")
"RTN","TIURA",116,0)
 . I +$G(TIUPFLG) S TIUFLAG=+$$CHARTONE^TIURA1(TIUDA)
"RTN","TIURA",117,0)
 . S DFN=$P($G(^TIU(8925,+TIUDA,0)),U,2)
"RTN","TIURA",118,0)
 . I +TIUTYP,'$G(TIUDTYP) D
"RTN","TIURA",119,0)
 . . S TIUPMTHD=$$PRNTMTHD^TIULG(+TIUTYP)
"RTN","TIURA",120,0)
 . . S TIUPGRP=$$PRNTGRP^TIULG(+TIUTYP)
"RTN","TIURA",121,0)
 . . S TIUPFHDR=$$PRNTHDR^TIULG(+TIUTYP)
"RTN","TIURA",122,0)
 . . S TIUPFNBR=$$PRNTNBR^TIULG(+TIUTYP)
"RTN","TIURA",123,0)
 . I +$G(TIUDTYP) S TIUPMTHD=$$PRNTMTHD^TIULG(+TIUDTYP),TIUPGRP=$$PRNTGRP^TIULG(+TIUDTYP),TIUPFHDR=$$PRNTHDR^TIULG(+TIUDTYP),TIUPFNBR=$$PRNTNBR^TIULG(+TIUDTYP)
"RTN","TIURA",124,0)
 . I $G(TIUPMTHD)]"",+$G(TIUPGRP),($G(TIUPFHDR)]""),($G(TIUPFNBR)]"") S TIUDARR(TIUPMTHD,$G(TIUPGRP)_"$"_TIUPFHDR_";"_DFN,TIUI,TIUDA)=TIUPFNBR
"RTN","TIURA",125,0)
 . E  S TIUDARR(TIUPMTHD,DFN,TIUI,TIUDA)=""
"RTN","TIURA",126,0)
 . D:'$D(ZTQUEUED) RESTORE^VALM10(+TIUI)
"RTN","TIURA",127,0)
 S TIUPMTHD="" F  S TIUPMTHD=$O(TIUDARR(TIUPMTHD)) Q:TIUPMTHD=""  D
"RTN","TIURA",128,0)
 . D PRNTDOC(TIUPMTHD,.TIUDARR)
"RTN","TIURA",129,0)
 Q
"RTN","TIURA",130,0)
PRINT1 ; Print a single document
"RTN","TIURA",131,0)
 N TIUDARR,TIUDEV,TIUTYP,DFN,TIUPMTHD,TIUD0,TIUDPRM,TIUFLAG,TIUDTYP
"RTN","TIURA",132,0)
 N TIUPGRP,TIUPFHDR,TIUPFNBR,TIUPRINT,POP,TIUTMPDA
"RTN","TIURA",133,0)
 D CLEAR^VALM1
"RTN","TIURA",134,0)
 S TIUTMPDA=TIUDA
"RTN","TIURA",135,0)
 I +$$ISADDNDM^TIULC1(TIUTMPDA) D
"RTN","TIURA",136,0)
 . S TIUTMPDA=+$P($G(^TIU(8925,TIUTMPDA,0)),U,6)
"RTN","TIURA",137,0)
 . S TIUDTYP=+$G(^TIU(8925,TIUTMPDA,0))
"RTN","TIURA",138,0)
 I $G(^TIU(8925,TIUTMPDA,21)) D
"RTN","TIURA",139,0)
 . S TIUTMPDA=^TIU(8925,TIUTMPDA,21)
"RTN","TIURA",140,0)
 . S TIUDTYP=+$G(^TIU(8925,TIUTMPDA,0))
"RTN","TIURA",141,0)
 S TIUPRINT=$$CANDO^TIULP(TIUTMPDA,"PRINT RECORD")
"RTN","TIURA",142,0)
 I +TIUPRINT'>0 D  Q
"RTN","TIURA",143,0)
 . W !!,$C(7),$P(TIUPRINT,U,2),!
"RTN","TIURA",144,0)
 . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURA",145,0)
 I +$G(TIUDTYP) D
"RTN","TIURA",146,0)
 . S TIUPMTHD=$$PRNTMTHD^TIULG(+TIUDTYP)
"RTN","TIURA",147,0)
 . S TIUPGRP=$$PRNTGRP^TIULG(+TIUDTYP)
"RTN","TIURA",148,0)
 . S TIUPFHDR=$$PRNTHDR^TIULG(+TIUDTYP)
"RTN","TIURA",149,0)
 . S TIUPFNBR=$$PRNTNBR^TIULG(+TIUDTYP)
"RTN","TIURA",150,0)
 . D DOCPRM^TIULC1(+TIUDTYP,.TIUDPRM,TIUTMPDA)
"RTN","TIURA",151,0)
 S TIUD0=$G(^TIU(8925,TIUTMPDA,0))
"RTN","TIURA",152,0)
 S TIUTYP=$P(TIUD0,U),DFN=$P(TIUD0,U,2)
"RTN","TIURA",153,0)
 I +TIUTYP'>0 Q
"RTN","TIURA",154,0)
 I '$G(TIUDTYP) D
"RTN","TIURA",155,0)
 . S TIUPMTHD=$$PRNTMTHD^TIULG(+TIUTYP)
"RTN","TIURA",156,0)
 . S TIUPGRP=$$PRNTGRP^TIULG(+TIUTYP)
"RTN","TIURA",157,0)
 . S TIUPFHDR=$$PRNTHDR^TIULG(+TIUTYP)
"RTN","TIURA",158,0)
 . S TIUPFNBR=$$PRNTNBR^TIULG(+TIUTYP)
"RTN","TIURA",159,0)
 . D DOCPRM^TIULC1(+TIUTYP,.TIUDPRM,TIUTMPDA)
"RTN","TIURA",160,0)
 I +$P($G(TIUDPRM(0)),U,9) S TIUFLAG=$$FLAG^TIUPRPN3
"RTN","TIURA",161,0)
 I (+$P($G(TIUDPRM(0)),U,9)'>0),+$$ISA^USRLM(DUZ,"MEDICAL INFORMATION SECTION") S TIUFLAG=$$FLAG^TIUPRPN3
"RTN","TIURA",162,0)
 I $G(TIUPMTHD)]"",+$G(TIUPGRP),($G(TIUPFHDR)]""),($G(TIUPFNBR)]"") S TIUDARR(TIUPMTHD,$G(TIUPGRP)_"$"_TIUPFHDR_";"_DFN,1,TIUTMPDA)=TIUPFNBR
"RTN","TIURA",163,0)
 E  S TIUDARR(TIUPMTHD,DFN,1,TIUTMPDA)=""
"RTN","TIURA",164,0)
 I $G(TIUPMTHD)']"" W !,$C(7),"No Print Method Defined for ",$P($G(^TIU(8925.1,+TIUTYP,0)),U) H 2 G PRINT1X
"RTN","TIURA",165,0)
 S TIUDEV=$$DEVICE^TIUDEV(.IO) ; Get Device
"RTN","TIURA",166,0)
 I $S(IO']"":1,TIUDEV']"":1,1:0) G PRINT1X
"RTN","TIURA",167,0)
 I $D(IO("Q")) D QUE^TIUDEV("PRINTQ^TIURA",TIUDEV) G PRINT1X
"RTN","TIURA",168,0)
 D PRINTQ
"RTN","TIURA",169,0)
PRINT1X D ^%ZISC
"RTN","TIURA",170,0)
 Q
"RTN","TIURA",171,0)
PRINTQ ; Queued document print
"RTN","TIURA",172,0)
 D PRNTDOC(TIUPMTHD,.TIUDARR)
"RTN","TIURA",173,0)
 Q
"RTN","TIURA",174,0)
PRNTDOC(TIUPMTHD,TIUDARR) ; Print a single document
"RTN","TIURA",175,0)
 ; Receives TIUPMTHD & TIUDARR
"RTN","TIURA",176,0)
 N TIUDA
"RTN","TIURA",177,0)
 I '+$D(TIUDARR) W !,"No Documents selected." Q
"RTN","TIURA",178,0)
 M ^TMP("TIUPR",$J)=TIUDARR(TIUPMTHD)
"RTN","TIURA",179,0)
 I TIUPMTHD']"" D  G PRNTDOCX
"RTN","TIURA",180,0)
 . W !!,"No Print Method Defined for ",$P(TIUTYP,U,2) H 2
"RTN","TIURA",181,0)
 X TIUPMTHD
"RTN","TIURA",182,0)
PRNTDOCX K ^TMP("TIUPR",$J)
"RTN","TIURA",183,0)
 Q
"RTN","TIURA",184,0)
BROWS1(TIULTMP) ; -- Call to BROWS1 for backward compatibility
"RTN","TIURA",185,0)
 D BROWS1^TIURA2(TIULTMP,TIUDA)
"RTN","TIURA",186,0)
 Q
"RTN","TIURB")
0^17^B34375935
"RTN","TIURB",1,0)
TIURB ; SLC/JER - More Review Screen Actions ;17-JAN-2002 17:08:05
"RTN","TIURB",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**4,32,52,78,58,100,109**;Jun 20, 1997
"RTN","TIURB",3,0)
 ; **100** Moved DELETE, DEL, DELTEXT, DIK to new rtn TIURB2
"RTN","TIURB",4,0)
AMEND ; Amendment action
"RTN","TIURB",5,0)
 N TIUDA,DFN,DIE,DR,TIU,TIUDATA,TIUI,TIUSIG,TIUY,X,X1,Y
"RTN","TIURB",6,0)
 N DIROUT,TIUCHNG,TIUDAARY,TIULST
"RTN","TIURB",7,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB",8,0)
 S TIUI=0
"RTN","TIURB",9,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB",10,0)
 . N RSTRCTD
"RTN","TIURB",11,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB",12,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURB",13,0)
 . I RSTRCTD D  Q
"RTN","TIURB",14,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB",15,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB",16,0)
 . W !!,"Amending #",+TIUDATA
"RTN","TIURB",17,0)
 . S TIUCHNG=0
"RTN","TIURB",18,0)
 . D AMEND1
"RTN","TIURB",19,0)
 . I $G(TIUDAARY(TIUI)) D
"RTN","TIURB",20,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURB",21,0)
 ; -- Update or Rebuild list, restore video:
"RTN","TIURB",22,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB",23,0)
 S VALMBCK="R"
"RTN","TIURB",24,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"amended")
"RTN","TIURB",25,0)
 Q
"RTN","TIURB",26,0)
AMEND1 ; Single record amend
"RTN","TIURB",27,0)
 N TIUCMT,TIUT0,TIUTYP,TIUAMND,TIUSNM,TIUSBLK,TIUCSNM,TIUCSBLK,DIE,DR
"RTN","TIURB",28,0)
 N DA,DFN,DIWESUB,TIU,TIUODA
"RTN","TIURB",29,0)
 L +^TIU(8925,+TIUDA):1
"RTN","TIURB",30,0)
 E  D  Q
"RTN","TIURB",31,0)
 . W !?5,$C(7),"Another user is editing this entry." H 3
"RTN","TIURB",32,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",33,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)'>6 D  Q
"RTN","TIURB",34,0)
 . W !?5,$C(7),"Only SIGNED Documents may be amended."
"RTN","TIURB",35,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",36,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",37,0)
 I +$$HASIMG^TIURB2(TIUDA) D IMGNOTE^TIURB2 Q
"RTN","TIURB",38,0)
 S TIUAMND=$$CANDO^TIULP(TIUDA,"AMENDMENT")
"RTN","TIURB",39,0)
 I +TIUAMND'>0 D  Q
"RTN","TIURB",40,0)
 . W !!,$C(7),$C(7),$C(7),$P(TIUAMND,U,2),!
"RTN","TIURB",41,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",42,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",43,0)
 W !!,"Before proceeding, please enter your Electronic Signature Code..."
"RTN","TIURB",44,0)
 S TIUAMND=$$GETSIG^TIURD2
"RTN","TIURB",45,0)
 I +TIUAMND'>0 D  Q
"RTN","TIURB",46,0)
 . W !!,"  Ok, no harm done...",!
"RTN","TIURB",47,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",48,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",49,0)
 W !!,"The ORIGINAL document will be RETRACTED, and a copy will be amended...",!
"RTN","TIURB",50,0)
 S TIUODA=TIUDA
"RTN","TIURB",51,0)
 S TIUDA=+$$RETRACT^TIURD2(TIUDA,"",7)
"RTN","TIURB",52,0)
 I '+TIUDA D  Q
"RTN","TIURB",53,0)
 . W !!,$C(7),$C(7),$C(7),"Retraction of Original Document Failed.",!
"RTN","TIURB",54,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",55,0)
 . S TIUDA=TIUODA,TIUCHNG("REFRESH")=1
"RTN","TIURB",56,0)
 L +^TIU(8925,TIUDA):1
"RTN","TIURB",57,0)
 E  D  Q
"RTN","TIURB",58,0)
 . W !?5,$C(7),"Another user is editing this entry."
"RTN","TIURB",59,0)
 . D RECOVER^TIURD4(TIUODA,TIUDA) H 3
"RTN","TIURB",60,0)
 . S TIUDA=TIUODA,TIUCHNG("REFRESH")=1
"RTN","TIURB",61,0)
 S TIUSNM=$$DECRYPT^TIULC1($P(^TIU(8925,TIUDA,15),U,3),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",62,0)
 S TIUSBLK=$$DECRYPT^TIULC1($P($G(^TIU(8925,TIUDA,15)),U,4),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",63,0)
 S TIUCSNM=$$DECRYPT^TIULC1($P(^TIU(8925,TIUDA,15),U,9),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",64,0)
 S TIUCSBLK=$$DECRYPT^TIULC1($P($G(^TIU(8925,TIUDA,15)),U,10),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",65,0)
 S TIUTYP=+$G(^TIU(8925,+TIUDA,0)),TIUT0=$G(^TIU(8925.1,+TIUTYP,0))
"RTN","TIURB",66,0)
 S TIUTYP(1)="1^"_+TIUTYP_U_$P(TIUT0,U,3)_U
"RTN","TIURB",67,0)
 S DFN=$P($G(^TIU(8925,+TIUDA,0)),U,2)
"RTN","TIURB",68,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIURB",69,0)
 S DIWESUB="Patient: "_$G(TIU("PNM"))
"RTN","TIURB",70,0)
 S TIUCHNG=0 D FULL^VALM1,TEXTEDIT^TIUEDI4(TIUDA,.TIUCMT,.TIUCHNG)
"RTN","TIURB",71,0)
 I '+$G(TIUCHNG) D  Q
"RTN","TIURB",72,0)
 . L -^TIU(8925,TIUDA)
"RTN","TIURB",73,0)
 . D RECOVER^TIURD4(TIUODA,TIUDA)
"RTN","TIURB",74,0)
 . L -^TIU(8925,TIUODA) H 3
"RTN","TIURB",75,0)
 . S TIUDA=TIUODA,TIUCHNG("REFRESH")=1
"RTN","TIURB",76,0)
 I +$G(TIUCHNG) D
"RTN","TIURB",77,0)
 . S DR=".05///AMENDED;1601////"_$$NOW^XLFDT_";1602////"_DUZ,DA=TIUDA,TIUSIG=0
"RTN","TIURB",78,0)
 . S DR=DR_";1603////"_$$NOW^XLFDT_";1604///^S X=$$SIGNAME^TIULS(DUZ);1605///^S X=$$SIGTITL^TIULS(DUZ)",TIUSIG=1
"RTN","TIURB",79,0)
 . S DIE=8925 D ^DIE
"RTN","TIURB",80,0)
 . ; Refile /es/-block fields
"RTN","TIURB",81,0)
 . S DR="1503///^S X=TIUSNM;1504///^S X=TIUSBLK;1509///^S X=TIUCSNM;1510///^S X=TIUCSBLK"
"RTN","TIURB",82,0)
 . D ^DIE
"RTN","TIURB",83,0)
 ; Drop Locks on both documents
"RTN","TIURB",84,0)
 L -^TIU(8925,+TIUDA)
"RTN","TIURB",85,0)
 L -^TIU(8925,+TIUODA)
"RTN","TIURB",86,0)
 S TIUDAARY(TIUI)=TIUDA
"RTN","TIURB",87,0)
 S TIUCHNG("RBLD")=1
"RTN","TIURB",88,0)
 Q
"RTN","TIURB",89,0)
SENDBACK ; Send back a Document to transcription
"RTN","TIURB",90,0)
 N TIUDA,DFN,TIU,TIUDATA,TIUCHNG,TIUI,TIUY,Y,DIROUT,TIULST
"RTN","TIURB",91,0)
 N TIUDAARY
"RTN","TIURB",92,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB",93,0)
 S TIUI=0
"RTN","TIURB",94,0)
 I +$O(VALMY(0)) D CLEAR^VALM1
"RTN","TIURB",95,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB",96,0)
 . N TIU,RSTRCTD
"RTN","TIURB",97,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB",98,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURB",99,0)
 . I RSTRCTD D  Q
"RTN","TIURB",100,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB",101,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB",102,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURB",103,0)
 . S TIUCHNG=0
"RTN","TIURB",104,0)
 . D EN^VALM("TIU SEND BACK")
"RTN","TIURB",105,0)
 . I +$G(TIUCHNG) D
"RTN","TIURB",106,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURB",107,0)
SENDX ; Revise list and cycle back as appropriate
"RTN","TIURB",108,0)
 I $G(TIUCHNG("ADDM"))!$G(TIUCHNG("DELETE")) S TIUCHNG("RBLD")=1
"RTN","TIURB",109,0)
 E  S TIUCHNG("UPDATE")=1
"RTN","TIURB",110,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB",111,0)
 S VALMBCK="R"
"RTN","TIURB",112,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"sent back")
"RTN","TIURB",113,0)
 Q
"RTN","TIURB",114,0)
LINK ; Link to problem(s)
"RTN","TIURB",115,0)
 N TIUCHNG,TIUDA,DFN,TIU,TIUDATA,TIUEDIT,TIUI,TIUY,TIULST,Y,DIROUT
"RTN","TIURB",116,0)
 N TIUDAARY
"RTN","TIURB",117,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB",118,0)
 S TIUI=0
"RTN","TIURB",119,0)
 I +$O(VALMY(0)) D CLEAR^VALM1
"RTN","TIURB",120,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB",121,0)
 . N TIU,VALMY,XQORM,VA,VADM,GMPDFN,GMPLUSER,RSTRCTD
"RTN","TIURB",122,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB",123,0)
 . S TIUDA=+$P(TIUDATA,U,2),GMPLUSER=1
"RTN","TIURB",124,0)
 . I '$D(^TIU(8925,+TIUDA,0)) D  Q
"RTN","TIURB",125,0)
 . . W !,$C(7),"Document no longer exists.",!
"RTN","TIURB",126,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURB",127,0)
 . S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURB",128,0)
 . I RSTRCTD D  Q
"RTN","TIURB",129,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB",130,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB",131,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURB",132,0)
 . S DFN=+$P($G(^TIU(8925,+TIUDA,0)),U,2)
"RTN","TIURB",133,0)
 . I +DFN D DEM^VADPT S GMPDFN=DFN_U_VADM(1)_U_$E(VADM(1))_VA("BID")
"RTN","TIURB",134,0)
 . S TIUCHNG=0
"RTN","TIURB",135,0)
 . D EN^VALM("TIU LINK TO PROBLEM")
"RTN","TIURB",136,0)
 . I +$G(TIUCHNG) S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURB",137,0)
LINKX ; Revise list and cycle back as appropriate
"RTN","TIURB",138,0)
 S TIUCHNG("REFRESH")=1
"RTN","TIURB",139,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB",140,0)
 S VALMBCK="R"
"RTN","TIURB",141,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"linked to problems")
"RTN","TIURB",142,0)
 Q
"RTN","TIURB",143,0)
DEL(DA) ; -- Call to DEL for backward compatibility
"RTN","TIURB",144,0)
 G GODEL^TIURB2
"RTN","TIURB",145,0)
 Q
"RTN","TIURB2")
0^18^B32735500
"RTN","TIURB2",1,0)
TIURB2 ; SLC/JER - More Review Screen Actions ;18-JAN-2002 12:27:10
"RTN","TIURB2",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**100,109**;Jun 20, 1997
"RTN","TIURB2",3,0)
 ; 2/3: Update TEXTEDIT from TIUEDIT to TIUEDI4
"RTN","TIURB2",4,0)
 ; 9/28 Moved DELETE, DEL, DELTEXT, DIK to new rtn TIURB2
"RTN","TIURB2",5,0)
DELETE ; Delete action
"RTN","TIURB2",6,0)
 N TIUI,TIUY,TIUCHNG,Y,DIROUT,DTOUT,DUOUT
"RTN","TIURB2",7,0)
 N TIULNO,TIUJ,PRNTDA,LSTDA
"RTN","TIURB2",8,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB2",9,0)
 S TIUI=0
"RTN","TIURB2",10,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB2",11,0)
 . N TIUDATA,DA,RSTRCTD
"RTN","TIURB2",12,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB2",13,0)
 . S DA=+$P(TIUDATA,U,2)
"RTN","TIURB2",14,0)
 . W !!,"Processing Item #",TIUI
"RTN","TIURB2",15,0)
 . L +^TIU(8925,+DA):1
"RTN","TIURB2",16,0)
 . E  D  Q
"RTN","TIURB2",17,0)
 . . W !?5,$C(7),"Another user is editing this entry."
"RTN","TIURB2",18,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURB2",19,0)
 . . D PICK^TIULM(TIUI)
"RTN","TIURB2",20,0)
 . S RSTRCTD=$$DOCRES^TIULRR(DA)
"RTN","TIURB2",21,0)
 . I RSTRCTD D  Q
"RTN","TIURB2",22,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB2",23,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB2",24,0)
 . D DEL(DA)
"RTN","TIURB2",25,0)
 . L -^TIU(8925,+DA)
"RTN","TIURB2",26,0)
 ; -- Update or Rebuild list, restore video:
"RTN","TIURB2",27,0)
 S TIUCHNG("RBLD")=1
"RTN","TIURB2",28,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB2",29,0)
 S VALMBCK="R"
"RTN","TIURB2",30,0)
 Q
"RTN","TIURB2",31,0)
DEL(DA) ; We don't hand out pencils, without erasers
"RTN","TIURB2",32,0)
GODEL ; -- Called from DEL^TIURB
"RTN","TIURB2",33,0)
 N CANDEL,TIUDA,TIUD0,TIUI,TIUDFLT,TIUPT,TIUVDT,TIUTYP,PROMPT,TIUAUDIT
"RTN","TIURB2",34,0)
 N TIUMSG,TIURSN,TIUVTYP,TIUABORT,ADDMPRNT,IDPRNT,TIUAUTH,TIUD12,STATUS
"RTN","TIURB2",35,0)
 L +^TIU(8925,+DA):1
"RTN","TIURB2",36,0)
 E  D  Q
"RTN","TIURB2",37,0)
 . W !?5,$C(7),"Another user is editing this entry."
"RTN","TIURB2",38,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURB2",39,0)
 I +$$HASIMG(DA) D IMGNOTE Q
"RTN","TIURB2",40,0)
 S TIUD0=$G(^TIU(8925,+DA,0)),TIUD12=$G(^(12))
"RTN","TIURB2",41,0)
 S TIUTYP=$$UP^XLFSTR($$PNAME^TIULC1(+TIUD0)),TIUAUTH=$P(TIUD12,U,2)
"RTN","TIURB2",42,0)
 S STATUS=$P(TIUD0,U,5),ADDMPRNT=+$P(TIUD0,U,6)
"RTN","TIURB2",43,0)
 S IDPRNT=+$P($G(^TMP("TIUR",$J,"IDDATA",DA)),U,3)
"RTN","TIURB2",44,0)
 S TIUPT=$$NAME^TIULS($P($G(^DPT(+$P(TIUD0,U,2),0)),U),"FIRST LAST")
"RTN","TIURB2",45,0)
 S TIUVDT=+$P(TIUD0,U,7)
"RTN","TIURB2",46,0)
 S TIUVDT=$$DATE^TIULS(TIUVDT,"MM/DD/YY"_$S($L(TIUVDT,".")=2:" HR:MIN",1:""))
"RTN","TIURB2",47,0)
 S TIUVTYP=$S(+$$ISDS^TIULX(+TIUD0):" Admission",1:" Visit")
"RTN","TIURB2",48,0)
 S TIUMSG="DELETING "_TIUTYP_" For "_TIUPT_"'s "_TIUVDT_TIUVTYP_"."
"RTN","TIURB2",49,0)
 S CANDEL=$$CANDO^TIULP(DA,"DELETE RECORD")
"RTN","TIURB2",50,0)
 I 'CANDEL W !!,$C(7),$C(7),$C(7),$P(CANDEL,U,2),! H 2 G DELX
"RTN","TIURB2",51,0)
 I $$HASIDKID^TIUGBR(DA) W !!,"This interdisciplinary parent cannot be deleted; it's entries must first",!,"be detached.",! H 3 G DELX
"RTN","TIURB2",52,0)
 I $O(^TIU(8925,"DAD",+DA,0))>0,$$HASADDEN^TIULC1(DA) D
"RTN","TIURB2",53,0)
 . W !!,"This "_TIUTYP_" has ADDENDA."
"RTN","TIURB2",54,0)
 W !,$C(7) F TIUI=1:1:$L(TIUMSG,"|") W !,$P(TIUMSG,"|",TIUI)
"RTN","TIURB2",55,0)
 W ! S PROMPT="Are you SURE you want to DELETE"
"RTN","TIURB2",56,0)
 I '$$READ^TIUU("YO",PROMPT,"NO") W !,"Nothing DELETED.",! H 2 S TIUCHNG=0 G DELX
"RTN","TIURB2",57,0)
 S PROMPT="DELETE the TEXT ONLY, leaving audit trail information"
"RTN","TIURB2",58,0)
 S TIUDA=DA
"RTN","TIURB2",59,0)
 I STATUS'>5,$S(DUZ=TIUAUTH:1,+$$ISA^USRLM(DUZ,"MEDICAL INFORMATION SECTION")'>0:1,1:0) S TIUAUDIT=0 I 1
"RTN","TIURB2",60,0)
 E  D  G:$D(TIUABORT) DELX
"RTN","TIURB2",61,0)
 . I +$P($G(^TIU(8925,+TIUDA,0)),U,5)'<6 S TIUAUDIT=1
"RTN","TIURB2",62,0)
 . E  D
"RTN","TIURB2",63,0)
 . . S TIUAUDIT=+$$READ^TIUU("YO",PROMPT,"NO")
"RTN","TIURB2",64,0)
 . . I $D(DTOUT)!($D(DUOUT)) D
"RTN","TIURB2",65,0)
 . . . W !,"Nothing DELETED.",!
"RTN","TIURB2",66,0)
 . . . S TIUCHNG=0,TIUABORT=1
"RTN","TIURB2",67,0)
 . . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB2",68,0)
 K ^TIU(8925,"ASAVE",DUZ,TIUDA) ; Remove SAVE-flag
"RTN","TIURB2",69,0)
 I +TIUAUDIT'>0 D  G DELX
"RTN","TIURB2",70,0)
 . W !,"DELETING Entire "_TIUTYP_" record.",!
"RTN","TIURB2",71,0)
 . D DELIRT^TIUDIRT(TIUDA),DIK(TIUDA) H 2
"RTN","TIURB2",72,0)
 . S TIUCHNG=2,TIUCHNG("DELETE")=1
"RTN","TIURB2",73,0)
 . D ALERTDEL^TIUALRT(TIUDA),DELSGNR^TIURB1(TIUDA)
"RTN","TIURB2",74,0)
 S PROMPT="Reason for DELETION (Privacy Act or Administrative): "
"RTN","TIURB2",75,0)
 S TIURSN=$P($$READ^TIUU("SA^P:privacy act;A:administrative",PROMPT,"PRIVACY ACT"),U)
"RTN","TIURB2",76,0)
 I '$L(TIURSN) D  G DELX
"RTN","TIURB2",77,0)
 . W !,"Nothing DELETED.",!
"RTN","TIURB2",78,0)
 . S TIUCHNG=0,TIUABORT=1
"RTN","TIURB2",79,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB2",80,0)
 D ALERTDEL^TIUALRT(TIUDA),DELSGNR^TIURB1(TIUDA)
"RTN","TIURB2",81,0)
 D DELTEXT(TIUDA,TIURSN),AUDEL^TIURB1(TIUDA,TIURSN) S TIUCHNG=1
"RTN","TIURB2",82,0)
DELX L -^TIU(8925,+DA)
"RTN","TIURB2",83,0)
 Q
"RTN","TIURB2",84,0)
DELTEXT(DA,TIURSN) ; After signature, only retraction possible
"RTN","TIURB2",85,0)
 N DR,DIE D FULL^VALM1
"RTN","TIURB2",86,0)
 W !!?5,$C(7),"***********************************************************************"
"RTN","TIURB2",87,0)
 W !?5,"*  This document will now be RETRACTED. As such, it has been removed  *"
"RTN","TIURB2",88,0)
 W !?5,"*    from public view, and from typical Releases of Information,      *"
"RTN","TIURB2",89,0)
 W !?5,"*          but will remain indefinitely discoverable to HIMS.         *"
"RTN","TIURB2",90,0)
 W !?5,"***********************************************************************",!
"RTN","TIURB2",91,0)
 S DIE=8925
"RTN","TIURB2",92,0)
 S DR="1610////^S X=+DUZ;1611////^S X=+$$NOW^XLFDT;1612////^S X=TIURSN"
"RTN","TIURB2",93,0)
 D ^DIE
"RTN","TIURB2",94,0)
 S DA=$$RETRACT^TIURD2(DA,"",14)
"RTN","TIURB2",95,0)
 I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB2",96,0)
 Q
"RTN","TIURB2",97,0)
DIK(DA) ; Call ^DIK to delete the record
"RTN","TIURB2",98,0)
 N DIK,TIUTYP,TIUTYPE,TIUDA,TIUVSIT,TIUVKILL,TIUDELX S TIUDA=0
"RTN","TIURB2",99,0)
 F  S TIUDA=+$O(^TIU(8925,"DAD",+DA,TIUDA)) Q:+TIUDA'>0  D DIK(TIUDA)
"RTN","TIURB2",100,0)
 S TIUTYPE=+$G(^TIU(8925,+DA,0))
"RTN","TIURB2",101,0)
 S TIUTYP=$P($G(^TIU(8925.1,TIUTYPE,0)),U)
"RTN","TIURB2",102,0)
 S TIUVSIT=+$P($G(^TIU(8925,DA,0)),U,3),TIUDA=DA
"RTN","TIURB2",103,0)
 S TIUDELX=$$DELETE^TIULC1(TIUTYPE)
"RTN","TIURB2",104,0)
 I TIUDELX]"" X TIUDELX
"RTN","TIURB2",105,0)
 S DIK="^TIU(8925,"
"RTN","TIURB2",106,0)
 D ^DIK ; W:'$D(ZTQUEUED) "."
"RTN","TIURB2",107,0)
 D DELAUDIT^TIUEDI1(DA)
"RTN","TIURB2",108,0)
 D DELPROB^TIURB1(DA)
"RTN","TIURB2",109,0)
 D DELSGNR^TIURB1(DA)
"RTN","TIURB2",110,0)
 D DELIMG(DA)
"RTN","TIURB2",111,0)
 D ALERTDEL^TIUALRT(DA)
"RTN","TIURB2",112,0)
 ; **52** Disable call to $$DELVFILE^PXAPI 'til further notice
"RTN","TIURB2",113,0)
 ; I +TIUVSIT,$D(^AUPNVSIT(+TIUVSIT)) S TIUVKILL=$$DELVFILE^PXAPI("ALL",TIUVSIT,"","TEXT INTEGRATION UTILITIES")
"RTN","TIURB2",114,0)
 Q
"RTN","TIURB2",115,0)
HASIMG(TIUDA) ; Evaluate whether images are linked
"RTN","TIURB2",116,0)
 Q +$O(^TIU(8925.91,"B",TIUDA,0))
"RTN","TIURB2",117,0)
IMGNOTE ; Present Notice of Linked Images
"RTN","TIURB2",118,0)
 D FULL^VALM1
"RTN","TIURB2",119,0)
 W !!?5,$C(7),"***********************************************************************"
"RTN","TIURB2",120,0)
 W !?5,"* This document has linked images. You must ""delete"" the Images using *"
"RTN","TIURB2",121,0)
 W !?5,"*        the Imaging Package before proceeding with this action.      *"
"RTN","TIURB2",122,0)
 W !?5,"*      The images will be hidden from public view, but will remain    *"
"RTN","TIURB2",123,0)
 W !?5,"*                   indefinitely discoverable to HIMS.                *"
"RTN","TIURB2",124,0)
 W !?5,"***********************************************************************",!
"RTN","TIURB2",125,0)
 I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB2",126,0)
 Q
"RTN","TIURB2",127,0)
DELIMG(TIUDA) ; Remove linked images, when document deleted
"RTN","TIURB2",128,0)
 N DA,DIK S DIK="^TIU(8925.91,",DA=0
"RTN","TIURB2",129,0)
 F  S DA=$O(^TIU(8925.91,"B",TIUDA,DA)) Q:+DA'>0  D ^DIK
"RTN","TIURB2",130,0)
 Q
"RTN","TIURD")
0^27^B35790600
"RTN","TIURD",1,0)
TIURD ; SLC/JER - Reassign actions ;13-MAY-2002 11:41:59
"RTN","TIURD",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**4,58,61,100,109**;Jun 20, 1997
"RTN","TIURD",3,0)
 ;
"RTN","TIURD",4,0)
REASSIGN ; Reassign selected Documents
"RTN","TIURD",5,0)
 N TIUCHNG,TIULST,TIUI,TIUY,RSTRCTD,TIUDAARY
"RTN","TIURD",6,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURD",7,0)
 S TIUI=0
"RTN","TIURD",8,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURD",9,0)
 . N TIUDA,DFN,TIU,TIUDATA,TIUVIEW
"RTN","TIURD",10,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURD",11,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURD",12,0)
 . W !!,"Processing Item #",TIUI,"..."
"RTN","TIURD",13,0)
 . I RSTRCTD D  Q
"RTN","TIURD",14,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURD",15,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURD",16,0)
 . I +$$HASIMG^TIURB2(TIUDA) D IMGNOTE^TIURB2 Q
"RTN","TIURD",17,0)
 . S TIUVIEW=$$CANDO^TIULP(TIUDA,"VIEW")
"RTN","TIURD",18,0)
 . I '+TIUVIEW D  Q
"RTN","TIURD",19,0)
 . . W !!,$C(7),$C(7),$C(7),$P(TIUVIEW,U,2),!
"RTN","TIURD",20,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD",21,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURD",22,0)
 . S TIUCHNG=0
"RTN","TIURD",23,0)
 . D EN^VALM("TIU REASSIGN")
"RTN","TIURD",24,0)
 . I +$G(TIUCHNG) D
"RTN","TIURD",25,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURD",26,0)
 ; -- Rebuild list: --
"RTN","TIURD",27,0)
 S TIUCHNG("RBLD")=1
"RTN","TIURD",28,0)
 D UPRBLD^TIURL(.TIUCHNG) K VALMY
"RTN","TIURD",29,0)
 S VALMBCK="R"
"RTN","TIURD",30,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"reassigned")
"RTN","TIURD",31,0)
 Q
"RTN","TIURD",32,0)
 ;
"RTN","TIURD",33,0)
REASSIG1 ; Single record reassign
"RTN","TIURD",34,0)
 N TIUAUTH,TIURSSG,TIUNAME,DA,DR,DIE,TIUTYPE,TIUEDIT,TIUADD,TIUPROMO,TIUY
"RTN","TIURD",35,0)
 N TIUD0,TIUD12,TIUD13,TIUD14,TIUODA,TIUOUT K ^TMP("TIURTRCT",$J)
"RTN","TIURD",36,0)
 D FULL^VALM1
"RTN","TIURD",37,0)
 L +^TIU(8925,+TIUDA):1
"RTN","TIURD",38,0)
 E  W !?5,$C(7),$C(7),$C(7),"Another user is editing this entry." S TIUY=$$READ^TIUU("EA","Press RETURN to continue...") Q
"RTN","TIURD",39,0)
 ; Authorized? NO: echo why not & quit
"RTN","TIURD",40,0)
 I +$$HASIMG^TIURB2(TIUDA) D IMGNOTE^TIURB2 Q
"RTN","TIURD",41,0)
 I +$$ISADDNDM^TIULC1(TIUDA) D  I 1
"RTN","TIURD",42,0)
 . N TIUDAD
"RTN","TIURD",43,0)
 . S TIUDAD=+$P(^TIU(8925,TIUDA,0),U,6)
"RTN","TIURD",44,0)
 . I +$$DADORKID^TIUGBR(TIUDAD) D
"RTN","TIURD",45,0)
 . . S TIURSSG="0^You must first detach the ORIGINAL interdisciplinary entry."
"RTN","TIURD",46,0)
 E  I $$DADORKID^TIUGBR(TIUDA) D  I 1
"RTN","TIURD",47,0)
 . S TIURSSG="0^You must first detach interdisciplinary entries."
"RTN","TIURD",48,0)
 I '$D(TIURSSG) S TIURSSG=$$CANDO^TIULP(+TIUDA,"REASSIGN")
"RTN","TIURD",49,0)
 I +$G(TIURSSG)'>0 D  G REASS1X
"RTN","TIURD",50,0)
 . W !!,$C(7),$C(7),$C(7),$P(TIURSSG,U,2),!
"RTN","TIURD",51,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD",52,0)
 S TIUD0(0)=$G(^TIU(8925,+TIUDA,0)),TIUD12(0)=$G(^(12))
"RTN","TIURD",53,0)
 S TIUD13(0)=$G(^TIU(8925,+TIUDA,13)),TIUD14(0)=$G(^(14))
"RTN","TIURD",54,0)
 S TIUTYPE=$P(TIUD0(0),U)
"RTN","TIURD",55,0)
 S TIUNAME=$$PNAME^TIULC1(+TIUTYPE)
"RTN","TIURD",56,0)
 S TIUAUTH=$P(TIUD12(0),U,2)
"RTN","TIURD",57,0)
 W !,$C(7)
"RTN","TIURD",58,0)
 S TIUY=$$READ^TIUU("YO","Are you sure you want to REASSIGN this "_TIUNAME,"NO","^D REAS1^TIUDIRH")
"RTN","TIURD",59,0)
 I +TIUY'>0 S TIUOUT=1 G REASS1X
"RTN","TIURD",60,0)
 I +$P(TIUD0(0),U,5)>5 D  G:+$G(TIUOUT) REASS1X
"RTN","TIURD",61,0)
 . W !!,$C(7),$C(7),"The status of this document is: ",$$UP^XLFSTR($$STATUS^TIULC(TIUDA))
"RTN","TIURD",62,0)
 . I +$$GETSIG^TIURD2'>0 S TIUOUT=1
"RTN","TIURD",63,0)
 . W !
"RTN","TIURD",64,0)
 ; Addendum? YES: Ask intended action is move, swap with original, or
"RTN","TIURD",65,0)
 ; replace original
"RTN","TIURD",66,0)
 S TIUADD=$$ISADDNDM^TIULC1(+TIUDA)
"RTN","TIURD",67,0)
 I +TIUADD D  G REASS1X
"RTN","TIURD",68,0)
 . D REASSIGA
"RTN","TIURD",69,0)
 D REASSIGO^TIURD3
"RTN","TIURD",70,0)
REASS1X L -^TIU(8925,+TIUDA):1
"RTN","TIURD",71,0)
 I +$G(TIUOUT),+$G(TIUODA),+$G(TIUDA),$D(TIUD0(0)) D RECOVER^TIURD4(TIUODA,TIUDA,.TIUD0) S TIUDA=TIUODA
"RTN","TIURD",72,0)
 ; Remove additional signers who haven't signed from retracted original
"RTN","TIURD",73,0)
 I '+$G(TIUOUT),+$G(TIUODA) D
"RTN","TIURD",74,0)
 . I +$O(^TIU(8925.7,"B",+$G(TIUODA),0)) D DELSGNRS^TIURD4(TIUODA,1)
"RTN","TIURD",75,0)
 . D ALERTDEL^TIUALRT(TIUODA)
"RTN","TIURD",76,0)
 I '+$G(TIUOUT),+$G(TIUODA),+$$ISA^TIULX(+$G(TIUD0(0)),+$$CLASS^TIUCP) D
"RTN","TIURD",77,0)
 . N TIUCPY,TIUNVSTR
"RTN","TIURD",78,0)
 . Q:'$L($T(TIUREAS^MDAPI))
"RTN","TIURD",79,0)
 . S TIUNVSTR=$P(TIUD12(1),U,11)_";"_$P(TIUD0(1),U,7)
"RTN","TIURD",80,0)
 . S TIUNVSTR=TIUNVSTR_";"_$P(TIUD0(1),U,13)
"RTN","TIURD",81,0)
 . S TIUCPY=$$TIUREAS^MDAPI(+$P(TIUD0(0),U,2),+$P(TIUD14(0),U,5),+TIUODA,+$P(TIUD0(1),U,2),+$P($G(^TIU(8925,TIUDA,14)),U,5),TIUNVSTR,TIUDA)
"RTN","TIURD",82,0)
 D SEND^TIUALRT(TIUDA)
"RTN","TIURD",83,0)
 S VALMBCK=$S(+$G(TIUCHNG):"Q",1:"R") K ^TMP("TIURTRCT",$J)
"RTN","TIURD",84,0)
 Q
"RTN","TIURD",85,0)
 ;
"RTN","TIURD",86,0)
REASSIGO ; Reassign an original Document
"RTN","TIURD",87,0)
 G REASSIGO^TIURD3
"RTN","TIURD",88,0)
 ;
"RTN","TIURD",89,0)
REASSIGA ;Reassign an Addendum to an original DS
"RTN","TIURD",90,0)
 N TIUACT,TIUSET S TIUCHNG=0
"RTN","TIURD",91,0)
 W !,"Please choose the appropriate action for this Addendum:"
"RTN","TIURD",92,0)
 S TIUSET="M:move addendum to a different document"
"RTN","TIURD",93,0)
 S TIUSET=TIUSET_";P:promote addendum as document for another visit"
"RTN","TIURD",94,0)
 S TIUSET=TIUSET_";R:replace parent document with this addendum"
"RTN","TIURD",95,0)
 S TIUSET=TIUSET_";S:swap this addendum with its parent document"
"RTN","TIURD",96,0)
 S TIUACT=$$READ^TIUU("S^"_TIUSET,"Select Reassign Action","move")
"RTN","TIURD",97,0)
 I $P(TIUACT,U)="M" D MOVEADD^TIURD1(TIUDA) Q
"RTN","TIURD",98,0)
 I $P(TIUACT,U)="P" D PROMOTE^TIURD1(TIUDA) Q
"RTN","TIURD",99,0)
 I $P(TIUACT,U)="R" D REPLACE^TIURD1(TIUDA) Q
"RTN","TIURD",100,0)
 I $P(TIUACT,U)="S" D SWAPADD^TIURD1(TIUDA)
"RTN","TIURD",101,0)
 Q
"RTN","TIURD",102,0)
 ;
"RTN","TIURD",103,0)
CLAPPLNK ; Re-link selected Documents to different Client Records
"RTN","TIURD",104,0)
 N TIUCHNG,TIULST,TIUDA,DFN,TIU,TIUDATA,TIUEDIT,TIUI,TIUY,Y,DIROUT,TIUPOP
"RTN","TIURD",105,0)
 N TIUDAARY
"RTN","TIURD",106,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURD",107,0)
 S TIUI=0 D FULL^VALM1
"RTN","TIURD",108,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURD",109,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURD",110,0)
 . S TIUDA=+$P(TIUDATA,U,2),TIUDAARY(TIUI)=TIUDA
"RTN","TIURD",111,0)
 . S TIUCHNG=0
"RTN","TIURD",112,0)
 . D CLAPPLN1(TIUDA)
"RTN","TIURD",113,0)
 . I +$G(TIUCHNG)=1 D
"RTN","TIURD",114,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":", ",1:"")_TIUI
"RTN","TIURD",115,0)
 S TIUCHNG("REFRESH")=1
"RTN","TIURD",116,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURD",117,0)
 S VALMBCK="R"
"RTN","TIURD",118,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"reassigned")
"RTN","TIURD",119,0)
 Q
"RTN","TIURD",120,0)
 ;
"RTN","TIURD",121,0)
CLAPPLN1(TIUDA) ; Re-link a single record to the client application
"RTN","TIURD",122,0)
 N TIUREASX,TIUCVP,CANLNK
"RTN","TIURD",123,0)
 I '$D(^TIU(8925,TIUDA,0)) D  Q
"RTN","TIURD",124,0)
 . W !!,$C(7),"Document no longer exists.",!
"RTN","TIURD",125,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD",126,0)
 S TIUCVP=$P($G(^TIU(8925,TIUDA,14)),U,5)
"RTN","TIURD",127,0)
 I +$$ISADDNDM^TIULC1(TIUDA) D  Q
"RTN","TIURD",128,0)
 . W !!,$C(7),"Links for ADDENDA can't be independently changed.",!
"RTN","TIURD",129,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD",130,0)
 S TIUREASX=$$REASSIGN^TIULC1(+$G(^TIU(8925,TIUDA,0)))
"RTN","TIURD",131,0)
 I TIUREASX']"" D  I 1
"RTN","TIURD",132,0)
 . W !!,$C(7),"No PACKAGE REASSIGNMENT ACTION Defined.",!
"RTN","TIURD",133,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD",134,0)
 E  D
"RTN","TIURD",135,0)
 . N CANLNK
"RTN","TIURD",136,0)
 . I $$DADORKID^TIUGBR(TIUDA) D  ;**100**
"RTN","TIURD",137,0)
 . . S CANLNK="0^You must first detach interdisciplinary entries"
"RTN","TIURD",138,0)
 . E  S CANLNK=$$CANDO^TIULP(+TIUDA,"LINK WITH REQUEST")
"RTN","TIURD",139,0)
 . I +CANLNK'>0 D  Q
"RTN","TIURD",140,0)
 . . W !!,$C(7),$C(7),$P(CANLNK,U,2),!
"RTN","TIURD",141,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD",142,0)
 . X TIUREASX S:$P($G(^TIU(8925,TIUDA,14)),U,5)'=TIUCVP TIUCHNG=1
"RTN","TIURD",143,0)
 Q
"RTN","TIURD2")
0^19^B68771136
"RTN","TIURD2",1,0)
TIURD2 ; SLC/JER - Reassignment following signature ; 7-DEC-2001 12:00:36
"RTN","TIURD2",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**61,100,109**;Jun 20, 1997
"RTN","TIURD2",3,0)
RETRACT(TIUDA,TIUDAD,COPYSTAT,NEWDAD,SKIPADD) ; Retract document
"RTN","TIURD2",4,0)
 N TIUOD0,TIUOD12,TIUOD13,TIUOD14,TIUOD15,TIUOD16,TIUOD17,TIUI,TIUPAT
"RTN","TIURD2",5,0)
 N TIUDPRM,TIUCOPY,TIUVSUPP,DUOUT,DIROUT,DTOUT,DA,DR,DFN,TIU,TIULMETH
"RTN","TIURD2",6,0)
 N TIUTYP,TIUVMETH,TIUPATNM,TIUNREC,DFN,TIUNDAD,TIUTNM
"RTN","TIURD2",7,0)
 S TIUOD0=$G(^TIU(8925,+TIUDA,0)),TIUOD12=$G(^(12)),TIUOD13=$G(^(13))
"RTN","TIURD2",8,0)
 S TIUOD14=$G(^TIU(8925,+TIUDA,14)),TIUOD15=$G(^(15)),TIUOD16=$G(^(16))
"RTN","TIURD2",9,0)
 S TIUOD17=$G(^TIU(8925,+TIUDA,17))
"RTN","TIURD2",10,0)
 S TIUTYP=+TIUOD0,^TMP("TIURTRCT",$J,TIUDA,0)=TIUOD0,COPYSTAT=$G(COPYSTAT,5)
"RTN","TIURD2",11,0)
 I $S(+COPYSTAT=14:1,+COPYSTAT=15:1,1:0) D STATUS(TIUDA) G RTADD
"RTN","TIURD2",12,0)
 I +$P(TIUOD0,U,5)'>5 D:+$G(NEWDAD) LINKADD(TIUDA,NEWDAD) G RETRAX
"RTN","TIURD2",13,0)
 I +COPYSTAT'<7,+$G(NEWDAD) D LINKADD(TIUDA,NEWDAD) G RETRAX
"RTN","TIURD2",14,0)
 D FULL^VALM1
"RTN","TIURD2",15,0)
 ; --- Initialize document parameters ---
"RTN","TIURD2",16,0)
 D DOCPRM^TIULC1(TIUTYP,.TIUDPRM,TIUDA)
"RTN","TIURD2",17,0)
 S TIUTNM=$$PNAME^TIULC1(+TIUTYP)
"RTN","TIURD2",18,0)
 ; --- Identify the patient ---
"RTN","TIURD2",19,0)
 S DFN=+$P(TIUOD0,U,2)
"RTN","TIURD2",20,0)
 I +DFN'>0 D  G RETRAX
"RTN","TIURD2",21,0)
 . W !,$C(7),"No patient selected..."
"RTN","TIURD2",22,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W !
"RTN","TIURD2",23,0)
 S TIUPATNM=$$PTNAME^TIULC1(DFN)
"RTN","TIURD2",24,0)
 ; --- Get visit info ---
"RTN","TIURD2",25,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIURD2",26,0)
 I '$D(TIU("VSTR")) W !,$C(7),"Patient & Visit required." H 2 G RETRAX
"RTN","TIURD2",27,0)
 I $D(TIU) D
"RTN","TIURD2",28,0)
 . N TIUNEW,TIUITEM,DA,DR,DIE
"RTN","TIURD2",29,0)
 . S DA=$$GETREC^TIUSRVP(DFN,.TIU,TIUTYP,.TIUNEW) Q:+DA'>0
"RTN","TIURD2",30,0)
 . I '+$G(TIUNEW) D  Q
"RTN","TIURD2",31,0)
 . . W !!,$C(7),"A ",TIUTNM," already exists for this visit."
"RTN","TIURD2",32,0)
 . . W !,"You may not use the reassign function to overwrite an existing ",!,$$UPPER^TIULS($$STATUS^TIULC(DA))," ",TIUTNM,".",!
"RTN","TIURD2",33,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD2",34,0)
 . D REMVSIT(TIUDA,TIUOD0)
"RTN","TIURD2",35,0)
 . D COPY0(DA,TIUOD0,.TIU,$G(TIUDAD),COPYSTAT),COPY12(DA,TIUOD12,.TIU)
"RTN","TIURD2",36,0)
 . D COPY13(DA,TIUOD13,.TIU,COPYSTAT),COPY14(DA,TIUOD14,.TIU)
"RTN","TIURD2",37,0)
 . D COPYSGNR(TIUDA,DA,COPYSTAT)
"RTN","TIURD2",38,0)
 . I COPYSTAT>5 D COPY15(DA,TIUOD15)
"RTN","TIURD2",39,0)
 . I COPYSTAT>6,$L(TIUOD16) S ^TIU(8925,+DA,16)=TIUOD16
"RTN","TIURD2",40,0)
 . I +$$REQCOSIG^TIULP(+TIUTYP,TIUDA,+$P(TIUOD12,U,4)),(COPYSTAT<6) D
"RTN","TIURD2",41,0)
 . . N DIE,DR S DIE=8925
"RTN","TIURD2",42,0)
 . . S DR="1506////1" D ^DIE
"RTN","TIURD2",43,0)
 . D COPY17^TIURC1(DA,TIUOD17),COPYTEXT^TIURC1(TIUDA,DA)
"RTN","TIURD2",44,0)
 . I $D(^TIU(8925,DA,"TEMP")) D MERGTEXT^TIUEDI1(DA,.TIU) K ^TIU(8925,+DA,"TEMP")
"RTN","TIURD2",45,0)
 . S DR=".05///"_$$UPPER^TIULS($$STATUS^TIULC(DA))_";.1////^S X=$$LINECNT^TIULC(DA);1406////"_TIUDA
"RTN","TIURD2",46,0)
 . S DIE=8925 D ^DIE
"RTN","TIURD2",47,0)
 . D AUDIT^TIUEDI1(DA,0,$$CHKSUM^TIULC("^TIU(8925,"_+DA_",""TEXT"")"))
"RTN","TIURD2",48,0)
 . S ^TMP("TIURTRCT",$J,"NEW",DA)=""
"RTN","TIURD2",49,0)
 . S:'+$G(TIUDAD) TIUNDAD=DA
"RTN","TIURD2",50,0)
 . S TIUNREC=$G(TIUNREC)_$S(+$G(TIUNREC):",",1:"")_DA
"RTN","TIURD2",51,0)
 . D STATUS(TIUDA)
"RTN","TIURD2",52,0)
 ; If SKIPADD is TRUE, bypass retraction of addenda...
"RTN","TIURD2",53,0)
 I +$G(SKIPADD) G RETRAX
"RTN","TIURD2",54,0)
RTADD ; Retract all addenda
"RTN","TIURD2",55,0)
 N TIUDADD S TIUDADD=0
"RTN","TIURD2",56,0)
 F  S TIUDADD=$O(^TIU(8925,"DAD",TIUDA,TIUDADD)) Q:+TIUDADD'>0  D
"RTN","TIURD2",57,0)
 . I '$$ISADDNDM^TIULC1(TIUDADD) Q
"RTN","TIURD2",58,0)
 . D ADDENDEL^TIUALRT(TIUDADD)
"RTN","TIURD2",59,0)
 . S TIUNREC=$G(TIUNREC)_$S(+$G(TIUNREC):",",1:"")_$$RETRACT(TIUDADD,TIUDA,$G(COPYSTAT),$G(TIUNDAD))
"RTN","TIURD2",60,0)
RETRAX Q +$G(TIUNREC)
"RTN","TIURD2",61,0)
REMVSIT(DA,TIUOD0) ; Remove VISIT from Retracted Doc
"RTN","TIURD2",62,0)
 N DIE,DR,SVCAT,TIUPOP S TIUPOP=0
"RTN","TIURD2",63,0)
 S SVCAT=$P(TIUOD0,U,13)
"RTN","TIURD2",64,0)
 I +$$ISADDNDM^TIULC1(DA) D  Q:+TIUPOP
"RTN","TIURD2",65,0)
 . I +$P($G(^TIU(8925,+$P(TIUOD0,U,6),0)),U,3)>0 S TIUPOP=1 Q
"RTN","TIURD2",66,0)
 . S:SVCAT="" SVCAT=$P($G(^TIU(8925,+$P(TIUOD0,U,6),0)),U,13)
"RTN","TIURD2",67,0)
 I SVCAT="H" Q
"RTN","TIURD2",68,0)
 W !,"Removing RETRACTED ",TIUTNM," from original Visit..."
"RTN","TIURD2",69,0)
 S DIE=8925,DR=".03///@" D ^DIE
"RTN","TIURD2",70,0)
 Q
"RTN","TIURD2",71,0)
LINKADD(DA,TIUDAD) ; Link addendum (DA) to TIUDAD
"RTN","TIURD2",72,0)
 N DR,DIE
"RTN","TIURD2",73,0)
 S DIE=8925,DR=".06////^S X=TIUDAD" D ^DIE
"RTN","TIURD2",74,0)
 Q
"RTN","TIURD2",75,0)
COPY0(DA,TIUD0,TIU,TIUDAD,STATUS) ; Copy root node
"RTN","TIURD2",76,0)
 N DR,DIE S DIE=8925,STATUS=$G(STATUS,5)
"RTN","TIURD2",77,0)
 S DR=".02////"_DFN_";.03////"_$P(TIUD0,U,3)_";.04////"_$P(TIUD0,U,4)_";.05////"_STATUS_";.06////"_$P(TIUD0,U,6)_";.07////"_$P(TIUD0,U,7)_";.08////"_$P(TIUD0,U,8)_";.09////"_$P(TIUD0,U,9)_";.12////"_$P(TIUD0,U,12)_";.13////"_$P(TIUD0,U,13)
"RTN","TIURD2",78,0)
 I $P($G(TIUDPRM(0)),U,16),'$P($G(^TIU(8925,+DA,0)),U,11),$$WORKOK^TIUPXAP1(+DA) S DR=DR_";.11////1" ;set flag to collect workload
"RTN","TIURD2",79,0)
 D ^DIE
"RTN","TIURD2",80,0)
 Q
"RTN","TIURD2",81,0)
COPY12(DA,TIUD12,TIU) ; Copy 12-node
"RTN","TIURD2",82,0)
 N DR,DIE S DIE=8925
"RTN","TIURD2",83,0)
 S DR="1201////"_+$$NOW^XLFDT_";1202////"_+$P(TIUD12,U,2)_";1203////"_$P(TIUD12,U,3)_";1204////"_$P(TIUD12,U,4)_";1205////"_$P(TIUD12,U,5)
"RTN","TIURD2",84,0)
 S DR=DR_";1206////"_$P(TIUD12,U,6)_";1207////"_$P(TIUD12,U,7)_";1208////"_$P(TIUD12,U,8)_";1209////"_$P(TIUD12,U,9)
"RTN","TIURD2",85,0)
 S DR=DR_";1210////"_$P(TIUD12,U,10)_";1211////"_$P(TIUD12,U,11)
"RTN","TIURD2",86,0)
 D ^DIE
"RTN","TIURD2",87,0)
 Q
"RTN","TIURD2",88,0)
COPY13(DA,TIUD13,TIU,STATUS) ; Copy 13-node
"RTN","TIURD2",89,0)
 N DR,DIE,TIUDT,TIURDT S DIE=8925,TIUDT=$P(TIUD13,U)
"RTN","TIURD2",90,0)
 S TIURDT=$S(+$$ISDS^TIULX(+$G(^TIU(8925,DA,0))):+$$REFDATE^TIULC1(.TIU,TIUDT),1:TIUDT)
"RTN","TIURD2",91,0)
 S:'TIURDT TIURDT=TIUDT
"RTN","TIURD2",92,0)
 S DR="1301////"_TIURDT_";1302////"_$P(TIUD13,U,2)_";1303////O"
"RTN","TIURD2",93,0)
 S DR=DR_";1304////"_$S(STATUS<4:"@",1:TIUDT)
"RTN","TIURD2",94,0)
 S DR=DR_";1305////"_$S(STATUS<5:"@",1:TIUDT)
"RTN","TIURD2",95,0)
 S DR=DR_";1306////"_$S(STATUS<5:"@",+$P(TIUD13,U,6):$P(TIUD13,U,6),1:DUZ)
"RTN","TIURD2",96,0)
 S DR=DR_";1307////"_$P(TIUD13,U,7)
"RTN","TIURD2",97,0)
 D ^DIE
"RTN","TIURD2",98,0)
 Q
"RTN","TIURD2",99,0)
COPY14(DA,TIUD14,TIU) ; Copy 14-node
"RTN","TIURD2",100,0)
 N DR,DIE S DIE=8925
"RTN","TIURD2",101,0)
 S DR="1401////"_$P(TIUD14,U)_";1402////"_$P(TIUD14,U,2)
"RTN","TIURD2",102,0)
 S DR=DR_";1403////"_$P(TIUD14,U,3)_";1404////"_$P(TIUD14,U,4)
"RTN","TIURD2",103,0)
 S DR=DR_";1405////^S X=$P(TIUD14,U,5)"
"RTN","TIURD2",104,0)
 D ^DIE
"RTN","TIURD2",105,0)
 Q
"RTN","TIURD2",106,0)
COPYSGNR(TIUDA,TIUCDA,COPYSTAT) ; Copy Add'nal Signers
"RTN","TIURD2",107,0)
 N TIUSDA S TIUSDA=0
"RTN","TIURD2",108,0)
 F  S TIUSDA=$O(^TIU(8925.7,"B",TIUDA,TIUSDA)) Q:+TIUSDA'>0  D
"RTN","TIURD2",109,0)
 . N TIUSD0,DA,DR,DIC,DIE,DLAYGO
"RTN","TIURD2",110,0)
 . S TIUSD0=$G(^TIU(8925.7,TIUSDA,0))
"RTN","TIURD2",111,0)
 . S (DIC,DLAYGO)=8925.7,DIC(0)="LX",X=""""_"`"_TIUCDA_"""" D ^DIC Q:+Y'>0
"RTN","TIURD2",112,0)
 . S DA=+Y,DIE=DIC,DR=".02////^S X=0;.03////^S X=$P(TIUSD0,U,3)"
"RTN","TIURD2",113,0)
 . I COPYSTAT>5 D
"RTN","TIURD2",114,0)
 . . S DR=DR_";.04////^S X=$P(TIUSD0,U,4);.05////^S X=$P(TIUSD0,U,5)"
"RTN","TIURD2",115,0)
 . . S DR=DR_";.06////^S X=$P(TIUSD0,U,6);.07////^S X=$P(TIUSD0,U,7)"
"RTN","TIURD2",116,0)
 . . S DR=DR_";.08////^S X=$P(TIUSD0,U,8)"
"RTN","TIURD2",117,0)
 . D ^DIE
"RTN","TIURD2",118,0)
 Q
"RTN","TIURD2",119,0)
COPY15(DA,TIUD15) ; Copy 15-node
"RTN","TIURD2",120,0)
 N DR,DIE S DIE=8925
"RTN","TIURD2",121,0)
 S DR="1501////"_$P(TIUD15,U)_";1502////"_$P(TIUD15,U,2)_";1503////^S X=$P(TIUD15,U,3);1504////^S X=$P(TIUD15,U,4)"
"RTN","TIURD2",122,0)
 S DR=DR_";1505////"_$P(TIUD15,U,5)_";1506////"_$P(TIUD15,U,6)_";1507////"_$P(TIUD15,U,7)_";1508////"_$P(TIUD15,U,8)
"RTN","TIURD2",123,0)
 S DR=DR_";1509////^S X=$P(TIUD15,U,9);1510////^S X=$P(TIUD15,U,10);1511////"_$P(TIUD15,U,11)_";1512////"_$P(TIUD15,U,12)
"RTN","TIURD2",124,0)
 S DR=DR_";1513////"_$P(TIUD15,U,13)
"RTN","TIURD2",125,0)
 D ^DIE
"RTN","TIURD2",126,0)
 Q
"RTN","TIURD2",127,0)
STATUS(DA) ; Set original's status to "RETRACTED"
"RTN","TIURD2",128,0)
 N DIE,DR,DIC
"RTN","TIURD2",129,0)
 S DIE=8925,DR=".05///RETRACTED" D ^DIE
"RTN","TIURD2",130,0)
 D ALERTDEL^TIUALRT(DA),DELIRT^TIUDIRT(DA)
"RTN","TIURD2",131,0)
 Q
"RTN","TIURD2",132,0)
ATTACH(TIUDA,TIUDADD) ; Attach TIUDADD as addendum to TIUDA
"RTN","TIURD2",133,0)
 N DR,DIE,DA,TIUD0,TIUD12,TIUD14,TIUDADA
"RTN","TIURD2",134,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^(12)),TIUD14=$G(^(14))
"RTN","TIURD2",135,0)
 S DIE="^TIU(8925,",DA=TIUDADD
"RTN","TIURD2",136,0)
 S DR=".01////81;.02////^S X=$P(TIUD0,U,2);.03////^S X=$P(TIUD0,U,3);.04////^S X=$$DOCCLASS^TIULC1(81)"
"RTN","TIURD2",137,0)
 S DR=DR_";.06////^S X=TIUDA;.07////^S X=$P(TIUD0,U,7);.08////^S X=$P(TIUD0,U,8)"
"RTN","TIURD2",138,0)
 D ^DIE
"RTN","TIURD2",139,0)
 S DR="1205////^S X=$P(TIUD12,U,5);1211////^S X=$P(TIUD12,U,11)"
"RTN","TIURD2",140,0)
 D ^DIE
"RTN","TIURD2",141,0)
 S DR="1301////^S X="_$$REFDTA(TIUDA,TIUDADD,TIUD0)
"RTN","TIURD2",142,0)
 S DR=DR_";1401////^S X=$P(TIUD14,U);1402////^S X=$P(TIUD14,U,2)"
"RTN","TIURD2",143,0)
 D ^DIE
"RTN","TIURD2",144,0)
 ; If TIUDADD has addenda, re-attach them as addenda to TIUDA
"RTN","TIURD2",145,0)
 S TIUDADA=0
"RTN","TIURD2",146,0)
 F  S TIUDADA=$O(^TIU(8925,"DAD",TIUDADD,TIUDADA)) Q:+TIUDADA'>0  D
"RTN","TIURD2",147,0)
 . Q:'+$$ISADDNDM^TIULC1(TIUDADA)
"RTN","TIURD2",148,0)
 . D ATTACH(TIUDA,TIUDADA),SEND^TIUALRT(TIUDADA) W "."
"RTN","TIURD2",149,0)
 W !!,"Done." S TIUCHNG=1
"RTN","TIURD2",150,0)
 Q
"RTN","TIURD2",151,0)
REFDTO(TIUDA,TIU) ; Compute reference date
"RTN","TIURD2",152,0)
 N TIUY,TIUD12,TIUD13
"RTN","TIURD2",153,0)
 S TIUD12=$G(^TIU(8925,+TIUDA,12)),TIUD13=$G(^(13))
"RTN","TIURD2",154,0)
 S TIUY=+TIU("LDT")
"RTN","TIURD2",155,0)
 I TIUY>0 G REFDTOX
"RTN","TIURD2",156,0)
 I +$P(TIUD13,U,7) S TIUY=+$P(TIUD13,U,7) G REFDTOX
"RTN","TIURD2",157,0)
 S TIUY=+$P(TIUD12,U)
"RTN","TIURD2",158,0)
REFDTOX Q TIUY
"RTN","TIURD2",159,0)
REFDTA(TIUDA,TIUDADD,TIUD0) ; Compute reference date for addenda
"RTN","TIURD2",160,0)
 N TIUY,TIUDAD12,TIUDAD13
"RTN","TIURD2",161,0)
 S TIUDAD12=$G(^TIU(8925,+TIUDADD,12)),TIUDAD13=$G(^(13))
"RTN","TIURD2",162,0)
 S TIUY=+TIUDAD13
"RTN","TIURD2",163,0)
 I +$$ISDS^TIULX(+TIUD0)'>0 G REFDTAX
"RTN","TIURD2",164,0)
 I +$P(TIUDAD13,U) S TIUY=+$P(TIUDAD13,U) G REFDTAX
"RTN","TIURD2",165,0)
 I +$P(TIUDAD13,U,7) S TIUY=+$P(TIUDAD13,U,7) G REFDTAX
"RTN","TIURD2",166,0)
 S TIUY=+$P(TIUDAD12,U)
"RTN","TIURD2",167,0)
REFDTAX Q TIUY
"RTN","TIURD2",168,0)
UPDTADD(TIUDA) ; Addenda for reassigned original are updated
"RTN","TIURD2",169,0)
 I $$HASADDEN^TIULC1(+TIUDA) D
"RTN","TIURD2",170,0)
 . N DA
"RTN","TIURD2",171,0)
 . W !!,$C(7),"Addenda for this Document will now be updated..."
"RTN","TIURD2",172,0)
 . S DA=0 F  S DA=$O(^TIU(8925,"DAD",+TIUDA,DA)) Q:+DA'>0  D
"RTN","TIURD2",173,0)
 . . N DR,DIE,TIUD0,TIUD12,TIUD14
"RTN","TIURD2",174,0)
 . . I '+$$ISADDNDM^TIULC1(+DA) Q
"RTN","TIURD2",175,0)
 . . S TIUD0(0)=$G(^TIU(8925,+DA,0)),TIUD12(0)=$G(^(12))
"RTN","TIURD2",176,0)
 . . S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^(12)),TIUD14=$G(^(14))
"RTN","TIURD2",177,0)
 . . S DR=".02////"_$P(TIUD0,U,2)_";.03////"_$S($P(TIUD0,U,3)="":"@",1:$P(TIUD0,U,3))_";.04////"_$P(TIUD0,U,4)_";.07////"_$P(TIUD0,U,7)_";.08////"_$S(+$P(TIUD0,U,8):$P(TIUD0,U,8),1:"@")_";.13////"_$P(TIUD0,U,13)
"RTN","TIURD2",178,0)
 . . S DR=DR_";1401////"_$P(TIUD14,U)_";1402////"_$P(TIUD14,U,2)
"RTN","TIURD2",179,0)
 . . S DIE=8925 D ^DIE
"RTN","TIURD2",180,0)
 . . S DR="1205////"_$P(TIUD12,U,5)_";1211////"_$P(TIUD12,U,11)
"RTN","TIURD2",181,0)
 . . D ^DIE
"RTN","TIURD2",182,0)
 . . S DR="1301////^S X="_$$REFDTA^TIURD2(TIUDA,DA,TIUD0)
"RTN","TIURD2",183,0)
 . . D ^DIE W "."
"RTN","TIURD2",184,0)
 . . ; Remove and resend alerts
"RTN","TIURD2",185,0)
 . . D SEND^TIUALRT(DA)
"RTN","TIURD2",186,0)
 . . S TIUD0(1)=$G(^TIU(8925,+DA,0)),TIUD12(1)=$G(^(12))
"RTN","TIURD2",187,0)
 . . D AUDREASS^TIURB1(DA,.TIUD0,.TIUD12)
"RTN","TIURD2",188,0)
 . . ; If the addendum was retracted, post its audit trail info as well
"RTN","TIURD2",189,0)
 . . I +$P($G(^TIU(8925,DA,14)),U,6) D
"RTN","TIURD2",190,0)
 . . . D AUDREASS^TIURB1(+$P(^TIU(8925,DA,14),U,6),.TIUD0,.TIUD12)
"RTN","TIURD2",191,0)
 Q
"RTN","TIURD2",192,0)
VLOC(LOCDA)     ; Resolve location pointer
"RTN","TIURD2",193,0)
 Q $P($G(^SC(LOCDA,0)),U)
"RTN","TIURD2",194,0)
GETSIG() ; Challenge user for Electronic Signature, when appropriate
"RTN","TIURD2",195,0)
 N X,X1,X2,TIUY S TIUY=0
"RTN","TIURD2",196,0)
 D SIG^XUSESIG
"RTN","TIURD2",197,0)
 I X1']"" D  G GETSIGX
"RTN","TIURD2",198,0)
 . W !!,$C(7),$C(7),"You MUST Enter your CORRECT Electronic Signature to Complete this Task...",!
"RTN","TIURD2",199,0)
 . W:$$READ^TIUU("EA","Press RETURN to continue...") ""
"RTN","TIURD2",200,0)
 S TIUY=1
"RTN","TIURD2",201,0)
GETSIGX Q +$G(TIUY)
"RTN","TIURS")
0^15^B46418913
"RTN","TIURS",1,0)
TIURS ; SLC/JER - Electronic signature actions ;19-JAN-2001 11:14:07
"RTN","TIURS",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**3,4,20,67,79,98,107,58,100,109**;Jun 20, 1997
"RTN","TIURS",3,0)
 ;12/11/00 Moved ELSIG,MULTIPRN,LIST to TIURS1
"RTN","TIURS",4,0)
ACCEPT(TIUSLST,TIUI) ; Accept for signing
"RTN","TIURS",5,0)
 N TIUSGN,TIUMSG,TIUPR,TIUFLAG
"RTN","TIURS",6,0)
 I +$G(TIUDA),($G(TIUEVNT)]"") D  Q:'+$G(TIUSGN)
"RTN","TIURS",7,0)
 . S TIUSGN=$$CANDO^TIULP(TIUDA,TIUEVNT)
"RTN","TIURS",8,0)
 . I '+TIUSGN D
"RTN","TIURS",9,0)
 . . D FULL^VALM1
"RTN","TIURS",10,0)
 . . W !!,"Document has changed...",!,$P(TIUSGN,U,2)
"RTN","TIURS",11,0)
 . . W !!,"Item #",TIUI,": Removed from signature list.",!
"RTN","TIURS",12,0)
 . . W:$$READ^TIUU("EA","Press RETURN to continue...") ""
"RTN","TIURS",13,0)
 S TIUSLST(TIUI)=""
"RTN","TIURS",14,0)
 W !,"Item #",TIUI,": Added to signature list." ;H 2
"RTN","TIURS",15,0)
 I +$P($G(TIUDPRM(0)),U,8) D
"RTN","TIURS",16,0)
 . S TIUMSG="Print this note"
"RTN","TIURS",17,0)
 . S TIUPR=$$READ^TIUU("Y",TIUMSG,"No")
"RTN","TIURS",18,0)
 . I +TIUPR S TIUSLST(TIUI)=1
"RTN","TIURS",19,0)
 I +$G(TIUPR),+$P($G(TIUDPRM(0)),U,9) D
"RTN","TIURS",20,0)
 . S TIUFLAG=$$FLAG^TIUPRPN3
"RTN","TIURS",21,0)
 . I +TIUFLAG S $P(TIUSLST(TIUI),U,2)=1
"RTN","TIURS",22,0)
 I +$G(XTRASGNR) S $P(TIUSLST(TIUI),U,3)=$G(XTRASGNR)
"RTN","TIURS",23,0)
 Q
"RTN","TIURS",24,0)
EDSIG(TIUDA,TIUADD,TIUPASK) ; interactive sign
"RTN","TIURS",25,0)
 N TIU,TIU0,TIU12,ASK,X,X1,TIUTYPE,SIGNER,COSIGNER,TIUTYPE,TIUMSG,TIUSTAT
"RTN","TIURS",26,0)
 N TIUES,TIUACT,TIUDPRM,XTRASGNR,TIUCOM,TIU15,TIUCPFLD
"RTN","TIURS",27,0)
 I +$D(TIUSIGN),(TIUSIGN=0) Q
"RTN","TIURS",28,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIURS",29,0)
 I '+$P(TIUPRM0,U,2) S VALMBCK="R" Q
"RTN","TIURS",30,0)
 S TIUADD=1
"RTN","TIURS",31,0)
 S TIU0=$G(^TIU(8925,+TIUDA,0)),TIU12=$G(^(12)),TIU15=$G(^(15))
"RTN","TIURS",32,0)
 S SIGNER=$S(+$P(TIU12,U,4):$P(TIU12,U,4),1:$P(TIU12,U,2))
"RTN","TIURS",33,0)
 S COSIGNER=$P(TIU12,U,8)
"RTN","TIURS",34,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIURS",35,0)
 S TIUSTAT=+$P(TIU0,U,5)
"RTN","TIURS",36,0)
 S TIUACT=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIURS",37,0)
 S ASK=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIURS",38,0)
 S TIUTYPE=$$PNAME^TIULC1(+TIU0)
"RTN","TIURS",39,0)
 I +ASK'>0 D  Q
"RTN","TIURS",40,0)
 . S VALMBCK="R"
"RTN","TIURS",41,0)
 . I +$$ISA^USRLM(+$G(DUZ),"MEDICAL INFORMATION SECTION"),(+$$ISPN^TIULX(+TIU0)'>0) Q
"RTN","TIURS",42,0)
 . I +$$ISA^USRLM(+$G(DUZ),"MAS TRANSCRIPTIONIST") Q
"RTN","TIURS",43,0)
 . I +$$ISA^USRLM(+$G(DUZ),"TRANSCRIPTIONIST") Q
"RTN","TIURS",44,0)
 . W !,$P(ASK,U,2)
"RTN","TIURS",45,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURS",46,0)
 W:$G(VALMAR)'="^TMP(""TIUVIEW"",$J)" !
"RTN","TIURS",47,0)
 ;If document is a clinical procedures title, check if clinical
"RTN","TIURS",48,0)
 ;procedure fields are required.  If the fields are required, prompt for
"RTN","TIURS",49,0)
 ;them and don't permit the user to sign unless the fields are defined.
"RTN","TIURS",50,0)
 I +$$ISA^TIULX(+TIU0,+$$CLASS^TIUCP),$$REQCPF^TIULP(+$P($G(^TIU(8925,+TIUDA,14)),U,5)) D  Q:+TIUCPFLD'>0
"RTN","TIURS",51,0)
 . I $G(^TIU(8925,+TIUDA,702)),$P(^(702),U)]"",$P(^(702),U,2)]"" S TIUCPFLD=1 Q
"RTN","TIURS",52,0)
 . S TIUCPFLD=$$ASKCPF(TIUDA)
"RTN","TIURS",53,0)
 . I +TIUCPFLD'>0 D
"RTN","TIURS",54,0)
 . . W !!,"The Procedure Summary Code and Date/Time Performed MUST be entered before",!,"you may sign.",!
"RTN","TIURS",55,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") ;pause
"RTN","TIURS",56,0)
 I $S(+$$REQCOSIG^TIULP(+TIU0,+TIUDA,+SIGNER):1,+$P(TIU15,U,6):1,1:0),(+COSIGNER'>0) D  Q:+COSIGNER'>0
"RTN","TIURS",57,0)
 . S COSIGNER=$$ASKCSNR(TIUDA,SIGNER)
"RTN","TIURS",58,0)
 . I +COSIGNER'>0 D
"RTN","TIURS",59,0)
 . . W !!,"This ",TIUTYPE," MUST have a cosigner before you may sign.",!
"RTN","TIURS",60,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURS",61,0)
 I TIUSTAT=5,$G(DUZ)'=SIGNER D
"RTN","TIURS",62,0)
 . S TIUMSG="Author hasn't signed, are you SURE you want to sign "_TIUTYPE
"RTN","TIURS",63,0)
 W ! I $G(TIUMSG)]"",$$READ^TIUU("YO",TIUMSG,"NO","^D SIG^TIUDIRH")'>0 S VALMBCK="R" Q
"RTN","TIURS",64,0)
 L +^TIU(8925,+TIUDA):1
"RTN","TIURS",65,0)
 E  W !?5,$C(7),"Another user is editing this entry.",! W:$$READ^TIUU("EA","Press RETURN to continue...") "" S TIUQUIT=2 Q
"RTN","TIURS",66,0)
 S TIUES=$$ASKSIG^TIULA1 L -^TIU(8925,+TIUDA) I '+TIUES Q
"RTN","TIURS",67,0)
 I $D(VALMAR) D FULL^VALM1
"RTN","TIURS",68,0)
 I +$G(XTRASGNR) D ADDSIG^TIURS1(TIUDA,XTRASGNR)
"RTN","TIURS",69,0)
 I '+$G(XTRASGNR) D ES(TIUDA,TIUES)
"RTN","TIURS",70,0)
 I $G(TIUACT)="COSIGNATURE",(+$$ISADDNDM^TIULC1(TIUDA)'>0) D  Q:+TIUCOM
"RTN","TIURS",71,0)
 . N TIUADDND S TIUCOM=0
"RTN","TIURS",72,0)
 . S TIUADDND=$$READ^TIUU("YO","Do you wish to add your comments in an addendum","NO")
"RTN","TIURS",73,0)
 . I +TIUADDND D ADD^TIUADD(TIUDA,.TIUCHNG) S TIUCOM=1
"RTN","TIURS",74,0)
 I '+$G(TIUPASK) Q
"RTN","TIURS",75,0)
 D DOCPRM^TIULC1(+TIU0,.TIUDPRM,TIUDA)
"RTN","TIURS",76,0)
 I +$P($G(TIUDPRM(0)),U,8) D PRINT^TIUEPRNT(TIUDA)
"RTN","TIURS",77,0)
 Q
"RTN","TIURS",78,0)
 ;
"RTN","TIURS",79,0)
ASKCPF(DA) ;Ask required clinical procedure fields
"RTN","TIURS",80,0)
 N DR,DIE,TIUY
"RTN","TIURS",81,0)
 D FULL^VALM1
"RTN","TIURS",82,0)
AGNCP W !!,$C(7),"You must designate the Procedure Summary Code and Date/Time Performed...",!
"RTN","TIURS",83,0)
 L +^TIU(8925,+DA):1
"RTN","TIURS",84,0)
 E  W !?5,$C(7),"Another user is editing this entry.",! W:$$READ^TIUU("EA","Press RETURN to continue...") "" G ASKCPFQ
"RTN","TIURS",85,0)
 S DR="70201R;70202R"
"RTN","TIURS",86,0)
 S DIE="^TIU(8925," D ^DIE
"RTN","TIURS",87,0)
ASKCPFQ L -^TIU(8925,+DA)
"RTN","TIURS",88,0)
 I $G(^TIU(8925,+DA,702)),$P(^(702),U)]"",$P(^(702),U,2)]"" S TIUY=1
"RTN","TIURS",89,0)
 Q +$G(TIUY)
"RTN","TIURS",90,0)
 ;
"RTN","TIURS",91,0)
ASKCSNR(DA,SIGNER) ; Ask cosigner
"RTN","TIURS",92,0)
 N DR,DIE,TIUY,TIUDCSNR,TIUPREF,TIUFLD
"RTN","TIURS",93,0)
 S TIUPREF=$$PERSPRF^TIULE(SIGNER)
"RTN","TIURS",94,0)
 S TIUDCSNR=$$PERSNAME^TIULC1($P(TIUPREF,U,9))
"RTN","TIURS",95,0)
 I TIUDCSNR="UNKNOWN" S TIUDCSNR=""
"RTN","TIURS",96,0)
 S TIUFLD=$S(+$$ISDS^TIULX(+$G(^TIU(8925,+DA,0))):"ATTENDING PHYSICIAN",1:"EXPECTED COSIGNER")
"RTN","TIURS",97,0)
 D FULL^VALM1
"RTN","TIURS",98,0)
AGN W !!,$C(7),"You must designate an ",TIUFLD,"...",!
"RTN","TIURS",99,0)
 L +^TIU(8925,+DA):1
"RTN","TIURS",100,0)
 E  W !?5,$C(7),"Another user is editing this entry.",! W:$$READ^TIUU("EA","Press RETURN to continue...") "" G ASKCOUT
"RTN","TIURS",101,0)
 I $E(TIUFLD)="A" S DR="1209R//^S X=TIUDCSNR;1208////^S X=$P(^TIU(8925,DA,12),U,9);1506////1"
"RTN","TIURS",102,0)
 E  S DR="1208R//^S X=TIUDCSNR;1506////1"
"RTN","TIURS",103,0)
 S DIE="^TIU(8925," D ^DIE
"RTN","TIURS",104,0)
ASKCOUT L -^TIU(8925,+DA)
"RTN","TIURS",105,0)
 S TIUY=+$P($G(^TIU(8925,+DA,12)),U,8)
"RTN","TIURS",106,0)
 Q TIUY
"RTN","TIURS",107,0)
ES(DA,TIUES,TIUI) ; ^DIE call for /es/
"RTN","TIURS",108,0)
 N SIGNER,DR,DIE,ESDT,TIUSTAT,TIUSTNOW,COSIGNER,SVCHIEF,CSREQ,TIUPRINT
"RTN","TIURS",109,0)
 N CSNEED,TIUTTL,TIUPSIG,TIUDPRM
"RTN","TIURS",110,0)
 D DOCPRM^TIULC1(+$G(^TIU(8925,+DA,0)),.TIUDPRM,DA)
"RTN","TIURS",111,0)
 S TIUSTAT=$P($G(^TIU(8925,+DA,0)),U,5),ESDT=$$NOW^TIULC
"RTN","TIURS",112,0)
 S SVCHIEF=+$$ISA^USRLM(DUZ,"CLINICAL SERVICE CHIEF")
"RTN","TIURS",113,0)
 S SIGNER=$P(^TIU(8925,+DA,12),U,4),COSIGNER=$P(^(12),U,8),CSREQ=0
"RTN","TIURS",114,0)
 S CSNEED=+$P($G(^TIU(8925,+DA,15)),U,6)
"RTN","TIURS",115,0)
 I +CSNEED,(DUZ'=COSIGNER),'+$G(SVCHIEF) S CSREQ=1
"RTN","TIURS",116,0)
 I TIUSTAT=5 D
"RTN","TIURS",117,0)
 . S DR=".05////"_$S(+CSREQ:6,1:7)_";1501////"_ESDT_";1502////"_+DUZ
"RTN","TIURS",118,0)
 . I '+$G(CSREQ),+CSNEED,$S(DUZ=COSIGNER:1,+$G(SVCHIEF):1,1:0) D
"RTN","TIURS",119,0)
 . . S DR=DR_";1506////0;1507////"_ESDT_";1508////"_+DUZ_";1509///^S X=$P(TIUES,U,2);1510///^S X=$P(TIUES,U,3);1511////E"
"RTN","TIURS",120,0)
 I TIUSTAT=6 S DR=".05////7;1506////0;1507////"_ESDT_";1508////"_+DUZ
"RTN","TIURS",121,0)
 Q:'$D(DR)
"RTN","TIURS",122,0)
 S DIE=8925 D ^DIE W:'$D(XWBOS) "."
"RTN","TIURS",123,0)
 I TIUSTAT=5 S DR="1503///^S X=$P(TIUES,U,2);1504///^S X=$P(TIUES,U,3);1505////E"
"RTN","TIURS",124,0)
 I TIUSTAT=6 D
"RTN","TIURS",125,0)
 . N TIUSBY S DR="",TIUSBY=$P($G(^TIU(8925,+DA,15)),U,2)
"RTN","TIURS",126,0)
 . I +TIUSBY>0 S DR="1503///^S X=$$SIGNAME^TIULS("_TIUSBY_");1504///^S X=$$SIGTITL^TIULS("_TIUSBY_");"
"RTN","TIURS",127,0)
 . S DR=$G(DR)_"1509///^S X=$P(TIUES,U,2);1510///^S X=$P(TIUES,U,3);1511////E"
"RTN","TIURS",128,0)
 S DIE=8925 D ^DIE W:'$D(XWBOS) "." S:'+$G(TIUCHNG) TIUCHNG=1
"RTN","TIURS",129,0)
 D SEND^TIUALRT(DA),SIGNIRT^TIUDIRT(+DA)
"RTN","TIURS",130,0)
 I +$$ISADDNDM^TIULC1(DA) S DA=+$P(^(0),U,6)
"RTN","TIURS",131,0)
 I +$G(CSREQ)'>0 D MAIN^TIUPD(DA,"S") I 1
"RTN","TIURS",132,0)
 ;If 'Credit Stop Code on Completion' is Yes
"RTN","TIURS",133,0)
 I +$P(^TIU(8925,+DA,0),U,11) D
"RTN","TIURS",134,0)
 . ;If workload does not exist, process using TIU's interview otherwise
"RTN","TIURS",135,0)
 . ;process as an edit using PCE's interview
"RTN","TIURS",136,0)
 . I '$$CHKVST^TIUPXAP2(+DA) D  I 1
"RTN","TIURS",137,0)
 . . N TIUCONT,TIUPRMT
"RTN","TIURS",138,0)
 . . Q:$D(XWBOS)
"RTN","TIURS",139,0)
 . . I $P(+$P(^TIU(8925,+DA,0),U,7),".")>DT D  Q
"RTN","TIURS",140,0)
 . . . W !!
"RTN","TIURS",141,0)
 . . . D QUE^TIUPXAP1
"RTN","TIURS",142,0)
 . . . W:$$READ^TIUU("EA","Press RETURN to continue...") ""
"RTN","TIURS",143,0)
 . . W !!
"RTN","TIURS",144,0)
 . . ;Check if workload should be entered
"RTN","TIURS",145,0)
 . . I $$CHKWKL^TIUPXAP2(+DA,.TIUDPRM) D CREDIT^TIUVSIT(DA)
"RTN","TIURS",146,0)
 . E  D
"RTN","TIURS",147,0)
 . . ;Check if workload should be entered
"RTN","TIURS",148,0)
 . . I $$CHKWKL^TIUPXAP2(+DA,.TIUDPRM) D EDTENC^TIUPXAP2(DA)
"RTN","TIURS",149,0)
 . D REMFLAG^TIUVSIT(+DA)
"RTN","TIURS",150,0)
 ; post-signature action
"RTN","TIURS",151,0)
 S TIUTTL=+$G(^TIU(8925,+DA,0)),TIUPSIG=$$POSTSIGN^TIULC1(TIUTTL)
"RTN","TIURS",152,0)
 I +$L(TIUPSIG),'+$G(CSREQ) X TIUPSIG
"RTN","TIURS",153,0)
 Q
"RTN","TIURS1")
0^20^B66573079
"RTN","TIURS1",1,0)
TIURS1 ; SLC/JER - Additional /es/ actions ;4/9/01
"RTN","TIURS1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**7,36,58,100,109**;Jun 20, 1997
"RTN","TIURS1",3,0)
 ;12/11/00 Moved ELSIG,MULTIPRN,LIST here from TIURS
"RTN","TIURS1",4,0)
ELSIG ; Sign rec
"RTN","TIURS1",5,0)
 N TIULST,TIUSLST,TIURJCT,TIUES,TIUI,X,X1,Y,TIUDAARY,TIUCHNG
"RTN","TIURS1",6,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIURS1",7,0)
 I $P(TIUPRM0,U,2)'>0 W !,"Electronic signature not yet enabled." H 3 G ELSIGX
"RTN","TIURS1",8,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURS1",9,0)
 S TIUI=0 I $D(VALMY)>9 D CLEAR^VALM1
"RTN","TIURS1",10,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D
"RTN","TIURS1",11,0)
 . N TIU0,TIU12,TIUSTAT,TIUEVNT,TIUTYPE,TIUPOP,TIU15,TIUDPRM
"RTN","TIURS1",12,0)
 . N ASK,SIGNER,COSIGNER,XTRASGNR,TIUDATA,TIUDA,RSTRCTD
"RTN","TIURS1",13,0)
 . S (ASK,TIUPOP)=0
"RTN","TIURS1",14,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURS1",15,0)
 . S TIUDA=$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURS1",16,0)
 . I RSTRCTD D  Q
"RTN","TIURS1",17,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURS1",18,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURS1",19,0)
 . S TIU0=$G(^TIU(8925,+TIUDA,0)),TIU12=$G(^(12)),TIU15=$G(^(15))
"RTN","TIURS1",20,0)
 . S SIGNER=$S(+$P(TIU12,U,4):$P(TIU12,U,4),1:$P(TIU12,U,2))
"RTN","TIURS1",21,0)
 . S COSIGNER=$P(TIU12,U,8)
"RTN","TIURS1",22,0)
 . I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIURS1",23,0)
 . S TIUSTAT=+$P(TIU0,U,5)
"RTN","TIURS1",24,0)
 . S TIUTYPE=$$PNAME^TIULC1(+TIU0)
"RTN","TIURS1",25,0)
 . S TIUEVNT=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIURS1",26,0)
 . D DOCPRM^TIULC1(+TIU0,.TIUDPRM,TIUDA)
"RTN","TIURS1",27,0)
 . S ASK=$$CANDO^TIULP(TIUDA,TIUEVNT)
"RTN","TIURS1",28,0)
 . I +ASK>0 D
"RTN","TIURS1",29,0)
 . . L +^TIU(8925,+TIUDA):1
"RTN","TIURS1",30,0)
 . . E  S ASK="0^ Another user is editing this entry."
"RTN","TIURS1",31,0)
 . I +ASK'>0,$P(ASK,U,2)]"" D  I 1
"RTN","TIURS1",32,0)
 . . D FULL^VALM1
"RTN","TIURS1",33,0)
 . . W !!,"Item #",TIUI,": ",$P(ASK,U,2),! K VALMY(TIUI)
"RTN","TIURS1",34,0)
 . . W !,"Removed from signature list.",!
"RTN","TIURS1",35,0)
 . . I $$READ^TIUU("FOA","Press RETURN to continue...")
"RTN","TIURS1",36,0)
 . E  D
"RTN","TIURS1",37,0)
 . . ;If document is a clinical procedures title, check if clinical
"RTN","TIURS1",38,0)
 . . ;procedure fields are required.  If the fields are required, prompt for
"RTN","TIURS1",39,0)
 . . ;them and don't permit the user to sign unless the fields are defined.
"RTN","TIURS1",40,0)
 . . I +$$ISA^TIULX(+TIU0,+$$CLASS^TIUCP),$$REQCPF^TIULP(+$P($G(^TIU(8925,+TIUDA,14)),U,5)) D  Q:+TIUPOP
"RTN","TIURS1",41,0)
 . . . N TIUCPFLD
"RTN","TIURS1",42,0)
 . . . W !!,"Item #",TIUI,": ",TIUTYPE," for "
"RTN","TIURS1",43,0)
 . . . W $$PTNAME^TIULC1($P(TIU0,U,2))," will need Procedure Summary Code and Date/Time Performed..."
"RTN","TIURS1",44,0)
 . . . I $G(^TIU(8925,+TIUDA,702)),$P(^(702),U)]"",$P(^(702),U,2)]"" S TIUCPFLD=1 Q
"RTN","TIURS1",45,0)
 . . . S TIUCPFLD=$$ASKCPF^TIURS(TIUDA)
"RTN","TIURS1",46,0)
 . . . I +TIUCPFLD'>0 D
"RTN","TIURS1",47,0)
 . . . . S TIUPOP=1
"RTN","TIURS1",48,0)
 . . . . W !!,"Item #",TIUI,": MUST have a Procedure Summary Code and Date/Time Performed",!,"before you may sign."
"RTN","TIURS1",49,0)
 . . . . W !!,"Removed from signature list.",!
"RTN","TIURS1",50,0)
 . . . . I $$READ^TIUU("FOA","Press RETURN to continue...")
"RTN","TIURS1",51,0)
 . . I $S(+$$REQCOSIG^TIULP(+TIU0,+TIUDA,DUZ):1,+$P(TIU15,U,6):1,1:0),(+$P(TIU12,U,8)'>0) D  Q:+TIUPOP
"RTN","TIURS1",52,0)
 . . . N COSIGNER
"RTN","TIURS1",53,0)
 . . . W !!,"Item #",TIUI,": ",TIUTYPE," for "
"RTN","TIURS1",54,0)
 . . . W $$PTNAME^TIULC1($P(TIU0,U,2))," will need cosignature..."
"RTN","TIURS1",55,0)
 . . . S COSIGNER=$$ASKCSNR^TIURS(TIUDA,DUZ)
"RTN","TIURS1",56,0)
 . . . I +COSIGNER'>0 D
"RTN","TIURS1",57,0)
 . . . . S TIUPOP=1
"RTN","TIURS1",58,0)
 . . . . W !!,"Item #",TIUI,": MUST have a cosigner, before you may sign."
"RTN","TIURS1",59,0)
 . . . . W !!,"Removed from signature list.",!
"RTN","TIURS1",60,0)
 . . . . I $$READ^TIUU("FOA","Press RETURN to continue...")
"RTN","TIURS1",61,0)
 . . N TIU,TIUY
"RTN","TIURS1",62,0)
 . . D EN^VALM("TIU SIGN/COSIGN")
"RTN","TIURS1",63,0)
 I $D(TIUSLST)'>9 D  G ELSIGX
"RTN","TIURS1",64,0)
 . S VALMSG="** Signature List Empty...Nothing signed. **"
"RTN","TIURS1",65,0)
 I $D(TIUSLST)>9 D
"RTN","TIURS1",66,0)
 . N TIUIO
"RTN","TIURS1",67,0)
 . S TIUES=$$ASKSIG^TIULA1
"RTN","TIURS1",68,0)
 . I '+TIUES S VALMSG="** Nothing Signed. **" D FIXLSTNW^TIULM Q
"RTN","TIURS1",69,0)
 . D FULL^VALM1
"RTN","TIURS1",70,0)
 . D MULTIPRN(.TIUSLST,.TIUIO)
"RTN","TIURS1",71,0)
 . S TIUI=0 F  S TIUI=$O(TIUSLST(TIUI)) Q:+TIUI'>0  D
"RTN","TIURS1",72,0)
 . . N TIUPY,XTRASGNR
"RTN","TIURS1",73,0)
 . . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI)),TIUDA=$P(TIUDATA,U,2)
"RTN","TIURS1",74,0)
 . . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURS1",75,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURS1",76,0)
 . . S XTRASGNR=+$P(TIUSLST(TIUI),U,3)
"RTN","TIURS1",77,0)
 . . I +$G(XTRASGNR) D ADDSIG^TIURS1(TIUDA,XTRASGNR)
"RTN","TIURS1",78,0)
 . . I '+$G(XTRASGNR) D ES^TIURS(TIUDA,TIUES)
"RTN","TIURS1",79,0)
 . . I +TIUSLST(TIUI),(TIUIO]"") D RPC^TIUPD(.TIUPY,TIUDA,TIUIO,$P(TIUSLST(TIUI),U,2))
"RTN","TIURS1",80,0)
 . D FULL^VALM1
"RTN","TIURS1",81,0)
ELSIGX I $G(TIUCHNG("ADDM"))!$G(TIUCHNG("DELETE")) S TIUCHNG("RBLD")=1
"RTN","TIURS1",82,0)
 E  S TIUCHNG("UPDATE")=1
"RTN","TIURS1",83,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURS1",84,0)
 S VALMBCK="R"
"RTN","TIURS1",85,0)
 D VMSG($G(TIULST),.TIUDAARY,"signed")
"RTN","TIURS1",86,0)
 Q
"RTN","TIURS1",87,0)
VMSG(TIULST,TIUDAARY,ACTION) ; Set VALMSG for messagebar, bold changed items
"RTN","TIURS1",88,0)
 N TIUI,LINENO,ACTFIRST
"RTN","TIURS1",89,0)
 S ACTFIRST=$S(ACTION="Encounter Data Edited":1,ACTION="Signers identified/edited":1,ACTION="Title changed":1,1:0)
"RTN","TIURS1",90,0)
 I TIULST']"" D  Q
"RTN","TIURS1",91,0)
 . I ACTFIRST S VALMSG="** No changes made. **" Q
"RTN","TIURS1",92,0)
 . S VALMSG="** Nothing "_ACTION_". **"
"RTN","TIURS1",93,0)
 I ACTION="copied" S ACTION="copied; See end of list"
"RTN","TIURS1",94,0)
 S TIULST=$$NEWLST(TIULST,.TIUDAARY)
"RTN","TIURS1",95,0)
 I TIULST]"" D
"RTN","TIURS1",96,0)
 . I ACTFIRST D  Q
"RTN","TIURS1",97,0)
 . . S VALMSG="** "_ACTION_" for item"_$S($L(TIULST,",")>1:"s ",$L(TIULST,"-")>1:"s ",1:" ")_TIULST_". **"
"RTN","TIURS1",98,0)
 . S VALMSG="** Item"_$S($L(TIULST,",")>1:"s ",$L(TIULST,"-")>1:"s ",1:" ")_TIULST_" "_ACTION_". **"
"RTN","TIURS1",99,0)
 I TIULST']"" D
"RTN","TIURS1",100,0)
 . I ACTFIRST D  Q
"RTN","TIURS1",101,0)
 . . S VALMSG="** "_ACTION_"; item(s) no longer in list. **"
"RTN","TIURS1",102,0)
 . S VALMSG="** Item"_$S($L(TIULST,",")>1:"s ",$L(TIULST,"-")>1:"s ",1:" ")_TIULST_" "_ACTION_", no longer in list. **"
"RTN","TIURS1",103,0)
 . ;S VALMSG="** Item(s) "_ACTION_", no longer in list. **"
"RTN","TIURS1",104,0)
 Q:$G(^TMP("TIUR",$J,"RTN"))="TIUROR"
"RTN","TIURS1",105,0)
 F TIUI=1:1 S LINENO=$P(TIULST,", ",TIUI) Q:'LINENO  D
"RTN","TIURS1",106,0)
 . D CNTRL^VALM10(LINENO,1,$G(VALM("RM")),IOINHI,IOINORM)
"RTN","TIURS1",107,0)
 Q
"RTN","TIURS1",108,0)
NEWLST(TIULST,TIUDAARY) ; Return TIULST with updated item numbers
"RTN","TIURS1",109,0)
 N TIUI,TIULNO,TIUDA,TIUNLNO,TIUNLST
"RTN","TIURS1",110,0)
 S TIUNLST=""
"RTN","TIURS1",111,0)
 F TIUI=1:1 S TIULNO=$P(TIULST,",",TIUI) Q:'TIULNO  D
"RTN","TIURS1",112,0)
 . S TIUDA=TIUDAARY(TIULNO),TIUNLNO=$O(^TMP("TIUR",$J,"IEN",TIUDA,0))
"RTN","TIURS1",113,0)
 . I TIUNLNO S TIUNLST=$G(TIUNLST)_$S($G(TIUNLST)]"":", ",1:"")_TIUNLNO
"RTN","TIURS1",114,0)
 Q TIUNLST
"RTN","TIURS1",115,0)
 ;
"RTN","TIURS1",116,0)
MULTIPRN(TIUSLST,TIUIO) ; ask device
"RTN","TIURS1",117,0)
 N TIUI,TIUASK,TIUION,TIUPOK,IO,TIUPLIST,TIUSCRN S (TIUI,TIUPOK)=0
"RTN","TIURS1",118,0)
 F  S TIUI=$O(TIUSLST(TIUI)) Q:TIUI'>0!+TIUPOK  S:+TIUSLST(TIUI) TIUPOK=1
"RTN","TIURS1",119,0)
 I '+TIUPOK S TIUIO="" Q
"RTN","TIURS1",120,0)
 S TIUPLIST=$$LIST(.TIUSLST)
"RTN","TIURS1",121,0)
 W !!,"Please specify the device for printing item"
"RTN","TIURS1",122,0)
 W $S(TIUPLIST[",":"s",TIUPLIST["-":"s",1:""),": ",TIUPLIST,!!
"RTN","TIURS1",123,0)
 S TIUSCRN="I $L($G(^%ZIS(1,+Y,""TYPE""))),("";HFS;MT;BAR;VTRM;RES;CHAN;IMPC;""'[("";""_^(""TYPE"")_"";""))"
"RTN","TIURS1",124,0)
 S TIUION=$$DEVICE^TIUDEV(.TIUIO,"LAST","N",TIUSCRN,"Q")
"RTN","TIURS1",125,0)
 I '$L(TIUION) S TIUIO=""
"RTN","TIURS1",126,0)
 D ^%ZISC
"RTN","TIURS1",127,0)
 Q
"RTN","TIURS1",128,0)
LIST(LIST) ; build print list
"RTN","TIURS1",129,0)
 N TIUY,TIUI S TIUI=0
"RTN","TIURS1",130,0)
 F  S TIUI=$O(LIST(TIUI)) Q:+TIUI'>0  D
"RTN","TIURS1",131,0)
 . S:+LIST(TIUI) TIUY=$G(TIUY)_$S($G(TIUY)]"":", ",1:"")_TIUI
"RTN","TIURS1",132,0)
 Q $G(TIUY)
"RTN","TIURS1",133,0)
 ;
"RTN","TIURS1",134,0)
ADDSIG(TIUDA,DA) ; Apply extra signatures to a document
"RTN","TIURS1",135,0)
 N DIE,DR
"RTN","TIURS1",136,0)
 S DIE=8925.7
"RTN","TIURS1",137,0)
 S DR=".04////"_$$NOW^TIULC_";.05////"_DUZ_";.06///^S X=$$SIGNAME^TIULS("_DUZ_");.07///^S X=$$SIGTITL^TIULS("_DUZ_");.08////E"
"RTN","TIURS1",138,0)
 D ^DIE
"RTN","TIURS1",139,0)
 D SEND^TIUALRT(TIUDA)
"RTN","TIURS1",140,0)
 Q
"RTN","TIURS1",141,0)
CNVPOST ; Change Titles/Convert Postings
"RTN","TIURS1",142,0)
 N TIUI,TIULST,Y,TIUVIEW,TIUCHNG,TIUDAARY
"RTN","TIURS1",143,0)
 I $G(TIUGLINK) W !,"Please finish attaching the interdisciplinary note before changing title.",! H 3 Q
"RTN","TIURS1",144,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURS1",145,0)
 S TIUI=0
"RTN","TIURS1",146,0)
 I +$O(VALMY(0)) D FULL^VALM1
"RTN","TIURS1",147,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURS1",148,0)
 . N TIU,TIUDA,DFN,TIUDATA,VALMY,XQORM,TIUVIEW,RSTRCTD
"RTN","TIURS1",149,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURS1",150,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURS1",151,0)
 . I RSTRCTD D  Q
"RTN","TIURS1",152,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURS1",153,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURS1",154,0)
 . S TIUVIEW=$$CANDO^TIULP(TIUDA,"VIEW")
"RTN","TIURS1",155,0)
 . I +TIUVIEW'>0 D  Q  ; Exclude records user can't view
"RTN","TIURS1",156,0)
 . . W !!,$C(7),$P(TIUVIEW,U,2),! ; Echo denial message
"RTN","TIURS1",157,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURS1",158,0)
 . S TIUCHNG=0
"RTN","TIURS1",159,0)
 . D EN^VALM("TIU CHANGE TITLE")
"RTN","TIURS1",160,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURS1",161,0)
 . I +$G(TIUCHNG) S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURS1",162,0)
 ; -- Update list: --
"RTN","TIURS1",163,0)
 S TIUCHNG("UPDATE")=1
"RTN","TIURS1",164,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURS1",165,0)
 S VALMBCK="R"
"RTN","TIURS1",166,0)
 D VMSG($G(TIULST),.TIUDAARY,"Title changed")
"RTN","TIURS1",167,0)
 Q
"RTN","TIURS1",168,0)
CNVPOST1 ; Convert Single Posting to another title
"RTN","TIURS1",169,0)
 N TIUD0,DIE,DR,TIUTITL,CHKSUM,TIUCHTTL
"RTN","TIURS1",170,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUCHNG=0
"RTN","TIURS1",171,0)
 D FULL^VALM1
"RTN","TIURS1",172,0)
 I +TIUD0=81 S TIUCHTTL="0^You may not change the TITLE of an ADDENDUM."
"RTN","TIURS1",173,0)
 I '$D(TIUCHTTL) S TIUCHTTL=$$CANDO^TIULP(TIUDA,"CHANGE TITLE")
"RTN","TIURS1",174,0)
 I +TIUCHTTL,$$DADORKID^TIUGBR(TIUDA) S TIUCHTTL="0^Interdisciplinary entries must be detached before changing titles." ;**100
"RTN","TIURS1",175,0)
 I +TIUCHTTL'>0 D  Q
"RTN","TIURS1",176,0)
 . W !!,$C(7),$P(TIUCHTTL,U,2),! ; Echo denial
"RTN","TIURS1",177,0)
 . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURS1",178,0)
 L +^TIU(8925,TIUDA,0):1
"RTN","TIURS1",179,0)
 E  D  Q
"RTN","TIURS1",180,0)
 . W !!?5,$C(7),"Another user is editing this entry.",! ; Echo denial
"RTN","TIURS1",181,0)
 . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURS1",182,0)
 S TIUTITL=$$ASKTITLE^TIULA3(+$$CLINDOC^TIULC1(+TIUD0,TIUDA),+TIUD0)
"RTN","TIURS1",183,0)
 S DIE=8925,DA=TIUDA
"RTN","TIURS1",184,0)
 S DR=".01////^S X="_TIUTITL_";.04////^S X="_$$DOCCLASS^TIULC1(TIUTITL)
"RTN","TIURS1",185,0)
 D ^DIE
"RTN","TIURS1",186,0)
 I +$G(^TIU(8925,+TIUDA,0))'=+TIUD0 S TIUCHNG=1
"RTN","TIURS1",187,0)
 S CHKSUM=+$$CHKSUM^TIULC("^TIU(8925,"_+TIUDA_",""TEXT"")")
"RTN","TIURS1",188,0)
 D AUDIT^TIUEDI1(TIUDA,CHKSUM,CHKSUM)
"RTN","TIURS1",189,0)
 L -^TIU(8925,TIUDA,0)
"RTN","TIURS1",190,0)
 Q
"RTN","TIUSRV")
0^11^B68149058
"RTN","TIUSRV",1,0)
TIUSRV ; SLC/JER - Silent server functions ;13-APR-2001 14:13:26
"RTN","TIUSRV",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,19,28,87,61,100,109**;Jun 20, 1997
"RTN","TIUSRV",3,0)
RPC(TIUY,TIUDA,REASSIGN) ; RPC for DT
"RTN","TIUSRV",4,0)
 N VALMAR,TIUGDATA,TIUGWHOL K ^TMP("TIUAUDIT",$J)
"RTN","TIUSRV",5,0)
 S TIUY=$NA(^TMP("TIUAUDIT",$J))
"RTN","TIUSRV",6,0)
 D GET(TIUDA,1,+$G(REASSIGN))
"RTN","TIUSRV",7,0)
 K ^TMP("VALM VIDEO",$J)
"RTN","TIUSRV",8,0)
 Q
"RTN","TIUSRV",9,0)
GET(TIUDA,HUSH,REASSIGN) ; Build List
"RTN","TIUSRV",10,0)
 N TIUI,TIUL,TIUREC,TIUDADD,X,TIUCPF S (TIUDADD,TIUI)=0,HUSH=+$G(HUSH)
"RTN","TIUSRV",11,0)
 N DA,DIC,DIQ,DR,TIUNAME K ^TMP("TIUAUDIT",$J)
"RTN","TIUSRV",12,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUSRV",13,0)
 I '$D(IOINORM) S X="IOINORM;IOIHI;IORVON;IORVOFF;IOUON;IOUOFF;IOBON;IOBOFF" D ENDR^%ZISS
"RTN","TIUSRV",14,0)
 S:'$D(VALMAR) VALMAR="^TMP(""TIUAUDIT"",$J)"
"RTN","TIUSRV",15,0)
 S VALMEVL=+$G(VALMEVL)
"RTN","TIUSRV",16,0)
 I '$D(^TIU(8925,+TIUDA,0)) S VALMQUIT=1 Q
"RTN","TIUSRV",17,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRV",18,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRV",19,0)
 S TIUCPF=+$$ISA^TIULX(+$G(^TIU(8925,TIUDA,0)),+$$CLASS^TIUCP)
"RTN","TIUSRV",20,0)
 S DIC=8925,DIQ="TIUREC(",DA=TIUDA
"RTN","TIUSRV",21,0)
 S DR=".01;.02;.05;.07:.1;1201;1202;1204;1208;1301;1302;1305;1306;1501;1502;1505;1507;1508;1511;1601:1602;1610:1612;1701"
"RTN","TIUSRV",22,0)
 ;If the document is a member of the Clinical Procedures Class, include the
"RTN","TIUSRV",23,0)
 ;Procedure Summary Code field and the Date/Time Performed field
"RTN","TIUSRV",24,0)
 I TIUCPF S DR=DR_";70201;70202"
"RTN","TIUSRV",25,0)
 D EN^DIQ1
"RTN","TIUSRV",26,0)
 S TIUI="" F  S TIUI=$O(TIUREC(8925,+TIUDA,TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRV",27,0)
 . I $G(TIUREC(8925,+TIUDA,TIUI))']"" S TIUREC(8925,+TIUDA,TIUI)="None"
"RTN","TIUSRV",28,0)
 . E  S TIUREC(8925,+TIUDA,TIUI)=$$UP^XLFSTR(TIUREC(8925,+TIUDA,TIUI))
"RTN","TIUSRV",29,0)
 I $D(TIUREC)>9 D
"RTN","TIUSRV",30,0)
 . D SOURCE(.TIUREC,HUSH,TIUCPF)
"RTN","TIUSRV",31,0)
 . D:'+$G(REASSIGN) PROBLEM(TIUDA),EDIT(TIUDA)
"RTN","TIUSRV",32,0)
 . D REASSIGN^TIUSRV1(TIUDA,+$G(REASSIGN)) Q:+$G(REASSIGN)
"RTN","TIUSRV",33,0)
 . D IDLINK^TIUSRV1(TIUDA)
"RTN","TIUSRV",34,0)
 . D SIGN(.TIUREC)
"RTN","TIUSRV",35,0)
 . I +$O(^TIU(8925.7,"B",TIUDA,0)) D XTRASIGN(TIUDA)
"RTN","TIUSRV",36,0)
 . I $D(^TIU(8925,+TIUDA,16)) D PRIVACY(.TIUREC)
"RTN","TIUSRV",37,0)
 . D BODY(TIUDA,.VALMCNT)
"RTN","TIUSRV",38,0)
 S:+$G(VALMCNT)<$G(VALM("LINES")) VALMCNT=$G(VALM("LINES"))
"RTN","TIUSRV",39,0)
 Q
"RTN","TIUSRV",40,0)
SOURCE(TIUREC,HUSH,TIUCPF) ; Source Info
"RTN","TIUSRV",41,0)
 N OFFSET,START
"RTN","TIUSRV",42,0)
 S OFFSET=2,START=1
"RTN","TIUSRV",43,0)
 W:'+$G(HUSH) !!,"Opening "_TIUREC(8925,+TIUDA,.01)_" record for review..."
"RTN","TIUSRV",44,0)
 D SET(START,1," Source Information ",$G(IORVON),$G(IORVOFF))
"RTN","TIUSRV",45,0)
 D SET(START+1,OFFSET," Reference Date: "_$G(TIUREC(8925,TIUDA,1301)))
"RTN","TIUSRV",46,0)
 D SET(START+2,OFFSET,"     Entry Date: "_$G(TIUREC(8925,TIUDA,1201)))
"RTN","TIUSRV",47,0)
 D SET(START+3,OFFSET,"Expected Signer: "_$G(TIUREC(8925,TIUDA,1204)))
"RTN","TIUSRV",48,0)
 D SET(START+4,OFFSET,"        Urgency: "_$G(TIUREC(8925,TIUDA,.09)))
"RTN","TIUSRV",49,0)
 D SET(START+5,OFFSET,"     Line Count: "_$G(TIUREC(8925,TIUDA,.1)))
"RTN","TIUSRV",50,0)
 D SET(START+6,OFFSET,"        Subject: "_$G(TIUREC(8925,TIUDA,1701)))
"RTN","TIUSRV",51,0)
 ;If the document is a member of the Clinical Procedures Class, include the
"RTN","TIUSRV",52,0)
 ;Procedure Summary Code field and the Date/Time Performed field
"RTN","TIUSRV",53,0)
 I $G(TIUCPF) D
"RTN","TIUSRV",54,0)
 . D BLANK(START+7)
"RTN","TIUSRV",55,0)
 . D SET(START+8,OFFSET,"Procedure Summary Code: "_$G(TIUREC(8925,TIUDA,70201)))
"RTN","TIUSRV",56,0)
 . D SET(START+9,OFFSET,"   Date/Time Performed: "_$G(TIUREC(8925,TIUDA,70202)))
"RTN","TIUSRV",57,0)
 S OFFSET=40
"RTN","TIUSRV",58,0)
 D SET(START+1,OFFSET,"            Author: "_$G(TIUREC(8925,TIUDA,1202)))
"RTN","TIUSRV",59,0)
 D SET(START+2,OFFSET,"        Entered By: "_$G(TIUREC(8925,TIUDA,1302)))
"RTN","TIUSRV",60,0)
 D SET(START+3,OFFSET," Expected Cosigner: "_$G(TIUREC(8925,TIUDA,1208)))
"RTN","TIUSRV",61,0)
 D SET(START+4,OFFSET,"   Document Status: "_$G(TIUREC(8925,TIUDA,.05)))
"RTN","TIUSRV",62,0)
 D SET(START+5,OFFSET,"    TIU Document #: "_+$G(TIUDA))
"RTN","TIUSRV",63,0)
 S VALMCNT=$S($G(TIUCPF):10,1:7)
"RTN","TIUSRV",64,0)
 Q
"RTN","TIUSRV",65,0)
PROBLEM(TIUDA) ; Problems
"RTN","TIUSRV",66,0)
 N TIUI,DR,DIC,DIQ,TIUCNT,TIUPROB,START S TIUI=0,START=VALMCNT+2
"RTN","TIUSRV",67,0)
 D BLANK(VALMCNT+1)
"RTN","TIUSRV",68,0)
 D SET(START,1," Associated Problems ",$G(IORVON),$G(IORVOFF))
"RTN","TIUSRV",69,0)
 I '+$O(^TIU(8925.9,"B",+TIUDA,0)) D SET(START,25,"No linked problems.")
"RTN","TIUSRV",70,0)
 F  S TIUI=$O(^TIU(8925.9,"B",TIUDA,TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRV",71,0)
 . S DA=TIUI,DR=".02;.05",DIC="^TIU(8925.9,",DIQ="TIUPROB"
"RTN","TIUSRV",72,0)
 . D EN^DIQ1 Q:$D(TIUPROB)'>9
"RTN","TIUSRV",73,0)
 . S TIUCNT=+$G(TIUCNT)+1
"RTN","TIUSRV",74,0)
 . D SET(START+1,19,$$MIXED^TIULS($G(TIUPROB(8925.9,TIUI,.05))))
"RTN","TIUSRV",75,0)
 . D SET(START+1,60,$G(TIUPROB(8925.9,TIUI,.02)))
"RTN","TIUSRV",76,0)
 . S START=START+1
"RTN","TIUSRV",77,0)
 S VALMCNT=START
"RTN","TIUSRV",78,0)
 Q
"RTN","TIUSRV",79,0)
EDIT(TIUDA) ; Edits
"RTN","TIUSRV",80,0)
 N TIUI,DR,DIC,DIQ,TIUCNT,TIUED,START,OFFSET S TIUI=0,START=VALMCNT+2
"RTN","TIUSRV",81,0)
 D BLANK(VALMCNT+1)
"RTN","TIUSRV",82,0)
 D SET(START,1," Edit Information ",$G(IORVON),$G(IORVOFF))
"RTN","TIUSRV",83,0)
 I '+$O(^TIU(8925.5,"B",+TIUDA,0)) D SET(START,22,"No edits since entry.")
"RTN","TIUSRV",84,0)
 F  S TIUI=$O(^TIU(8925.5,"B",TIUDA,TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRV",85,0)
 . S DA=TIUI,DR=".02:03",DIC="^TIU(8925.5,",DIQ="TIUED"
"RTN","TIUSRV",86,0)
 . D EN^DIQ1 Q:$D(TIUED)'>9!($G(TIUED(8925.5,TIUI,.02))']"")
"RTN","TIUSRV",87,0)
 . S TIUCNT=+$G(TIUCNT)+1
"RTN","TIUSRV",88,0)
 . S OFFSET=2
"RTN","TIUSRV",89,0)
 . D SET(START+1,OFFSET,"      Edit Date: "_$G(TIUED(8925.5,TIUI,.02)))
"RTN","TIUSRV",90,0)
 . S OFFSET=44
"RTN","TIUSRV",91,0)
 . D SET(START+1,OFFSET,"     Edited By: "_$G(TIUED(8925.5,TIUI,.03)))
"RTN","TIUSRV",92,0)
 . S START=START+1
"RTN","TIUSRV",93,0)
 S VALMCNT=START
"RTN","TIUSRV",94,0)
 Q
"RTN","TIUSRV",95,0)
SIGN(TIUREC) ; Signature
"RTN","TIUSRV",96,0)
 N OFFSET,START D BLANK(VALMCNT+1)
"RTN","TIUSRV",97,0)
 S OFFSET=2,START=VALMCNT+2
"RTN","TIUSRV",98,0)
 D SET(START,1," Signature Information ",$G(IORVON),$G(IORVOFF))
"RTN","TIUSRV",99,0)
 D SET(START+1,OFFSET,"    Signed Date: "_$G(TIUREC(8925,TIUDA,1501)))
"RTN","TIUSRV",100,0)
 D SET(START+3,OFFSET,"  Cosigned Date: "_$G(TIUREC(8925,TIUDA,1507)))
"RTN","TIUSRV",101,0)
 S OFFSET=40
"RTN","TIUSRV",102,0)
 D SET(START+1,OFFSET,"         Signed By: "_$G(TIUREC(8925,TIUDA,1502)))
"RTN","TIUSRV",103,0)
 D SET(START+2,OFFSET,"    Signature Mode: "_$G(TIUREC(8925,TIUDA,1505)))
"RTN","TIUSRV",104,0)
 D SET(START+3,OFFSET,"       Cosigned By: "_$G(TIUREC(8925,TIUDA,1508)))
"RTN","TIUSRV",105,0)
 D SET(START+4,OFFSET,"  Cosignature Mode: "_$G(TIUREC(8925,TIUDA,1511)))
"RTN","TIUSRV",106,0)
 S VALMCNT=START+4
"RTN","TIUSRV",107,0)
 Q
"RTN","TIUSRV",108,0)
XTRASIGN(TIUDA) ; Additional signers
"RTN","TIUSRV",109,0)
 N OFFSET,TIUI,DA,DR,DIC,DIQ,TIUCNT,TIUXTRA,START
"RTN","TIUSRV",110,0)
 S TIUI=0,START=VALMCNT+2
"RTN","TIUSRV",111,0)
 D BLANK(VALMCNT+1)
"RTN","TIUSRV",112,0)
 D SET(START,1," Receipt Acknowledged By ",$G(IORVON),$G(IORVOFF))
"RTN","TIUSRV",113,0)
 F  S TIUI=$O(^TIU(8925.7,"B",TIUDA,TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRV",114,0)
 . S DA=TIUI,DR=".03:.08",DIC="^TIU(8925.7,",DIQ="TIUXTRA"
"RTN","TIUSRV",115,0)
 . D EN^DIQ1 Q:$D(TIUXTRA)'>9
"RTN","TIUSRV",116,0)
 . S TIUCNT=+$G(TIUCNT)+1,OFFSET=2
"RTN","TIUSRV",117,0)
 . D SET(START+1,OFFSET,"    Signed Date: "_$G(TIUXTRA(8925.7,DA,.04)))
"RTN","TIUSRV",118,0)
 . S OFFSET=40
"RTN","TIUSRV",119,0)
 . D SET(START+1,OFFSET,"         Signed By: "_$G(TIUXTRA(8925.7,DA,.06)))
"RTN","TIUSRV",120,0)
 . D SET(START+2,2,"Expected Signer: "_$G(TIUXTRA(8925.7,DA,.03)))
"RTN","TIUSRV",121,0)
 . D SET(START+2,OFFSET,"    Signature Mode: "_$G(TIUXTRA(8925.7,DA,.08)))
"RTN","TIUSRV",122,0)
 . S (START,VALMCNT)=START+2
"RTN","TIUSRV",123,0)
 Q
"RTN","TIUSRV",124,0)
PRIVACY(TIUREC) ; Privacy Act
"RTN","TIUSRV",125,0)
 N OFFSET,START D BLANK(VALMCNT+1)
"RTN","TIUSRV",126,0)
 S OFFSET=2,START=VALMCNT+2
"RTN","TIUSRV",127,0)
 D SET(START,1," Privacy Act Information ",$G(IORVON),$G(IORVOFF))
"RTN","TIUSRV",128,0)
 D SET(START+1,OFFSET,"   Amended Date: "_$G(TIUREC(8925,TIUDA,1601)))
"RTN","TIUSRV",129,0)
 D SET(START+2,OFFSET,"   Deleted Date: "_$G(TIUREC(8925,TIUDA,1611)))
"RTN","TIUSRV",130,0)
 D SET(START+3,OFFSET,"         Reason: "_$G(TIUREC(8925,TIUDA,1612)))
"RTN","TIUSRV",131,0)
 S OFFSET=40
"RTN","TIUSRV",132,0)
 D SET(START+1,OFFSET,"        Amended By: "_$G(TIUREC(8925,TIUDA,1602)))
"RTN","TIUSRV",133,0)
 D SET(START+2,OFFSET,"        Deleted By: "_$G(TIUREC(8925,TIUDA,1610)))
"RTN","TIUSRV",134,0)
 S VALMCNT=START+3
"RTN","TIUSRV",135,0)
 Q
"RTN","TIUSRV",136,0)
BODY(TIUDA,TIUL) ; body of document
"RTN","TIUSRV",137,0)
 N CANSEE S CANSEE=$$CANDO^TIULP(TIUDA,"VIEW")
"RTN","TIUSRV",138,0)
 S TIUL=+$G(TIUL)+1
"RTN","TIUSRV",139,0)
 D BLANK(TIUL) S TIUL=+$G(TIUL)+1
"RTN","TIUSRV",140,0)
 D SET(TIUL,1," Document Body ",$G(IORVON),$G(IORVOFF)) S TIUL=TIUL+1
"RTN","TIUSRV",141,0)
 D BLANK(TIUL)
"RTN","TIUSRV",142,0)
 I '+CANSEE D NOSEE(CANSEE,.TIUL) Q
"RTN","TIUSRV",143,0)
 ; D TEXT(TIUDA,.TIUL)
"RTN","TIUSRV",144,0)
 I '$D(TIUGDATA) S TIUGDATA=$$IDDATA^TIURECL1(TIUDA)
"RTN","TIUSRV",145,0)
 D LOADREC^TIUBR1(TIUDA,.TIUL,TIUGDATA,$G(TIUGWHOL))
"RTN","TIUSRV",146,0)
 K ^TMP("TIU ADDENDUM",$J)
"RTN","TIUSRV",147,0)
 Q
"RTN","TIUSRV",148,0)
TEXT(TIUDA,TIUL) ; Get each component
"RTN","TIUSRV",149,0)
 N TIUKID,TIUDADT,TIUI S TIUI=0
"RTN","TIUSRV",150,0)
 F  S TIUI=$O(^TIU(8925,+TIUDA,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRV",151,0)
 . S TIUL=+$G(TIUL)+1
"RTN","TIUSRV",152,0)
 . S ^TMP("TIUAUDIT",$J,TIUL,0)=$G(^TIU(8925,+TIUDA,"TEXT",+TIUI,0))
"RTN","TIUSRV",153,0)
 I +$$ISADDNDM^TIULC1(+TIUDA) D  Q
"RTN","TIUSRV",154,0)
 . N TIULINE,TIUPARNT K ^TMP("TIU ADDENDUM",$J) S $P(TIULINE,"=",79)=""
"RTN","TIUSRV",155,0)
 . S ^TMP("TIU ADDENDUM",$J)=TIUDA
"RTN","TIUSRV",156,0)
 . D LOADSIG^TIUBR1(TIUDA,.TIUL)
"RTN","TIUSRV",157,0)
 . S TIUL=+$G(TIUL)+1,^TMP("TIUAUDIT",$J,TIUL,0)=""
"RTN","TIUSRV",158,0)
 . S TIUL=+$G(TIUL)+1,^TMP("TIUAUDIT",$J,TIUL,0)=TIULINE
"RTN","TIUSRV",159,0)
 . S TIUL=+$G(TIUL)+1,^TMP("TIUAUDIT",$J,TIUL,0)=""
"RTN","TIUSRV",160,0)
 . S TIUL=+$G(TIUL)+1,^TMP("TIUAUDIT",$J,TIUL,0)=" --- Original Document ---"
"RTN","TIUSRV",161,0)
 . S TIUL=+$G(TIUL)+1,^TMP("TIUAUDIT",$J,TIUL,0)=""
"RTN","TIUSRV",162,0)
 . S TIUPARNT=+$P(^TIU(8925,+TIUDA,0),U,6) D TEXT(TIUPARNT,.TIUL)
"RTN","TIUSRV",163,0)
 S TIUKID=0
"RTN","TIUSRV",164,0)
 F  S TIUKID=$O(^TIU(8925,"DAD",+TIUDA,TIUKID)) Q:+TIUKID'>0  D
"RTN","TIUSRV",165,0)
 . I +$$ISADDNDM^TIULC1(TIUKID)'>0 D TEXT(TIUKID,.TIUL)
"RTN","TIUSRV",166,0)
 I '$$ISCOMP(TIUDA) D LOADSIG^TIUBR1(TIUDA,.TIUL)
"RTN","TIUSRV",167,0)
 S TIUKID=0
"RTN","TIUSRV",168,0)
 F  S TIUKID=$O(^TIU(8925,"DAD",+TIUDA,TIUKID)) Q:+TIUKID'>0  D
"RTN","TIUSRV",169,0)
 . ; If acting on an addendum, don't show it again
"RTN","TIUSRV",170,0)
 . I +TIUKID=+$G(^TMP("TIU ADDENDUM",$J)) Q
"RTN","TIUSRV",171,0)
 . I +$$ISADDNDM^TIULC1(TIUKID) D LOADADD(TIUKID,.TIUL)
"RTN","TIUSRV",172,0)
 Q
"RTN","TIUSRV",173,0)
ISCOMP(DA) ; Evaluate whether a given record is a component
"RTN","TIUSRV",174,0)
 N TIUY,TIUTYP
"RTN","TIUSRV",175,0)
 S TIUTYP=+$G(^TIU(8925,DA,0))
"RTN","TIUSRV",176,0)
 S TIUY=$S($P($G(^TIU(8925.1,+TIUTYP,0)),U,4)="CO":1,1:0)
"RTN","TIUSRV",177,0)
 Q TIUY
"RTN","TIUSRV",178,0)
LOADADD(TIUDADD,TIUL) ; Load addenda
"RTN","TIUSRV",179,0)
 N TIUDAUTH,TIUDATT,TIUJ,TIUSIG,TIUCSIG,CANSEE
"RTN","TIUSRV",180,0)
 S CANSEE=$$CANDO^TIULP(+TIUDADD,"VIEW")
"RTN","TIUSRV",181,0)
 S TIUJ=0,TIUL=+$G(TIUL)+1,^TMP("TIUAUDIT",$J,TIUL,0)=" "
"RTN","TIUSRV",182,0)
 S TIUDADT=$$DATE^TIULS($P($G(^TIU(8925,+TIUDADD,13)),U),"MM/DD/YY")
"RTN","TIUSRV",183,0)
 S TIUL=TIUL+1,^TMP("TIUAUDIT",$J,TIUL,0)=TIUDADT_" ADDENDUM:"
"RTN","TIUSRV",184,0)
 I +CANSEE'>0 D  Q
"RTN","TIUSRV",185,0)
 . S TIUL=+$G(TIUL)+1
"RTN","TIUSRV",186,0)
 . S ^TMP("TIUAUDIT",$J,TIUL,0)=$P(CANSEE,U,2)
"RTN","TIUSRV",187,0)
 F  S TIUJ=$O(^TIU(8925,+TIUDADD,"TEXT",TIUJ)) Q:+TIUJ'>0  D
"RTN","TIUSRV",188,0)
 . S TIUL=+$G(TIUL)+1
"RTN","TIUSRV",189,0)
 . S ^TMP("TIUAUDIT",$J,TIUL,0)=$G(^TIU(8925,+TIUDADD,"TEXT",TIUJ,0))
"RTN","TIUSRV",190,0)
 D LOADSIG^TIUBR1(TIUDADD,.TIUL)
"RTN","TIUSRV",191,0)
 Q
"RTN","TIUSRV",192,0)
NOSEE(CANSEE,TIUJ) ; When the user shouldn't see the data...
"RTN","TIUSRV",193,0)
 S TIUJ=+$G(TIUJ)+1
"RTN","TIUSRV",194,0)
 D SET(TIUJ,2,$P(CANSEE,U,2))
"RTN","TIUSRV",195,0)
 Q
"RTN","TIUSRV",196,0)
SET(TIULINE,TIUCOL,TIUTEXT,ON,OFF) ; set display info in array
"RTN","TIUSRV",197,0)
 D:'$D(@VALMAR@(TIULINE,0)) BLANK(.TIULINE)
"RTN","TIUSRV",198,0)
 D SET^VALM10(.TIULINE,$$SETSTR^VALM1(.TIUTEXT,@VALMAR@(TIULINE,0),.TIUCOL,$L(TIUTEXT)))
"RTN","TIUSRV",199,0)
 D:$G(ON)]""!($G(OFF)]"") CNTRL^VALM10(.TIULINE,.TIUCOL,$L(TIUTEXT),$G(ON),$G(OFF))
"RTN","TIUSRV",200,0)
 W:'(TIULINE#5)&'+$G(HUSH) "."
"RTN","TIUSRV",201,0)
 Q
"RTN","TIUSRV",202,0)
 ;
"RTN","TIUSRV",203,0)
BLANK(TIULINE) ; blank line
"RTN","TIUSRV",204,0)
 D SET^VALM10(.TIULINE,$J("",80))
"RTN","TIUSRV",205,0)
 Q
"RTN","TIUSRVP")
0^4^B73447909
"RTN","TIUSRVP",1,0)
TIUSRVP ; SLC/JER - RPCs for CREATE & UPDATE ;17-OCT-2001 09:21:50
"RTN","TIUSRVP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,7,19,28,47,89,104,100,115,109**;Jun 20, 1997
"RTN","TIUSRVP",3,0)
MAKE(SUCCESS,DFN,TITLE,VDT,VLOC,VSIT,TIUX,VSTR,SUPPRESS,NOASF) ; New Document
"RTN","TIUSRVP",4,0)
 ; SUCCESS = (by ref) SUCCESS Returns TIU DOCUMENT # (PTR to 8925)
"RTN","TIUSRVP",5,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUSRVP",6,0)
 ; DFN     = Patient (#2)
"RTN","TIUSRVP",7,0)
 ; TITLE   = Pointer to TIU Document Definition (#8925.1)
"RTN","TIUSRVP",8,0)
 ; [VDT]   = Date(/Time) of Visit
"RTN","TIUSRVP",9,0)
 ; [VLOC]  = Visit Location (pointer to HOSPITAL LOCATION
"RTN","TIUSRVP",10,0)
 ; [VSIT]  = Pointer to visit file (#9000010)
"RTN","TIUSRVP",11,0)
 ; [VSTR]  = Visit string (i.e., VLOC;VDT;VTYPE)
"RTN","TIUSRVP",12,0)
 ; [NOASF] = Flag if set to 1=Do Not Set ASAVE cross-reference
"RTN","TIUSRVP",13,0)
 ; TIUX    = (by ref) array containing identifying fields, as
"RTN","TIUSRVP",14,0)
 ;           well as the body of the document
"RTN","TIUSRVP",15,0)
 ;
"RTN","TIUSRVP",16,0)
 ; -- first, get visit record and demographics (if not provided) --
"RTN","TIUSRVP",17,0)
 ;
"RTN","TIUSRVP",18,0)
 N TIU,TIUDA,LDT,NEWREC
"RTN","TIUSRVP",19,0)
 S SUCCESS=0
"RTN","TIUSRVP",20,0)
 I +$G(VSIT) S VSTR=$$VSTRBLD(+VSIT)
"RTN","TIUSRVP",21,0)
 I $L($G(VSTR)) D
"RTN","TIUSRVP",22,0)
 . S VDT=$S(+$G(VDT):+$G(VDT),1:$P(VSTR,";",2))
"RTN","TIUSRVP",23,0)
 . S LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",24,0)
 . S VLOC=$S(+$G(VLOC):+$G(VLOC),1:$P(VSTR,";"))
"RTN","TIUSRVP",25,0)
 . ; If the note is for a Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",26,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",27,0)
 . ; Otherwise, call PATVADPT^TIULV
"RTN","TIUSRVP",28,0)
 . D PATVADPT^TIULV(.TIU,DFN,"",VSTR)
"RTN","TIUSRVP",29,0)
 I '+$G(VSIT),'$L($G(VSTR)),+$G(VDT),+$G(VLOC) D
"RTN","TIUSRVP",30,0)
 . S VDT=$G(VDT),LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",31,0)
 . ; If the note is for a Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",32,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",33,0)
 . ; Otherwise, call MAIN^TIUVSIT
"RTN","TIUSRVP",34,0)
 . D MAIN^TIUVSIT(.TIU,DFN,"",VDT,LDT,"LAST",0,VLOC)
"RTN","TIUSRVP",35,0)
 I '+$G(TIU("VSTR")) D
"RTN","TIUSRVP",36,0)
 . D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUSRVP",37,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) Q
"RTN","TIUSRVP",38,0)
 ;
"RTN","TIUSRVP",39,0)
 ; -- second, get/create TIU Document record --
"RTN","TIUSRVP",40,0)
 ;
"RTN","TIUSRVP",41,0)
 S TIUDA=$$GETREC(DFN,.TIU,TITLE,.NEWREC)
"RTN","TIUSRVP",42,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) Q
"RTN","TIUSRVP",43,0)
 S SUCCESS=+TIUDA
"RTN","TIUSRVP",44,0)
 ;
"RTN","TIUSRVP",45,0)
 ; -- third, file data in TIU Document record --
"RTN","TIUSRVP",46,0)
 ;
"RTN","TIUSRVP",47,0)
 D STUFREC^TIUSRVP1(+TIUDA,.TIUX,DFN,$G(PARENT),TITLE,.TIU)
"RTN","TIUSRVP",48,0)
 S:'+$G(NOASF) ^TIU(8925,"ASAVE",DUZ,TIUDA)=""
"RTN","TIUSRVP",49,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",50,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",51,0)
 D SETXT0(TIUDA)
"RTN","TIUSRVP",52,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",53,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDA) Q
"RTN","TIUSRVP",54,0)
 I +$O(^TIU(8925,+TIUDA,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",55,0)
 I +$G(TIU("STOP")) D DEFER^TIUVSIT(TIUDA,TIU("STOP")) I 1
"RTN","TIUSRVP",56,0)
 E  D QUE^TIUPXAP1
"RTN","TIUSRVP",57,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",58,0)
 . D RELEASE^TIUT(TIUDA,1)
"RTN","TIUSRVP",59,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",60,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",61,0)
 Q
"RTN","TIUSRVP",62,0)
VSTRBLD(VSIT) ; Given a Visit Record, build Visit-Descriptor String
"RTN","TIUSRVP",63,0)
 N TIUY,VSIT0,VLOC,VDT,VSVCAT
"RTN","TIUSRVP",64,0)
 S VSIT0=$G(^AUPNVSIT(+VSIT,0)),VDT=+$P(VSIT0,U),VLOC=+$P(VSIT0,U,22)
"RTN","TIUSRVP",65,0)
 S VSVCAT=$P(VSIT0,U,7)
"RTN","TIUSRVP",66,0)
 S TIUY=VLOC_";"_VDT_";"_VSVCAT
"RTN","TIUSRVP",67,0)
 Q TIUY
"RTN","TIUSRVP",68,0)
SETXT0(TIUDA) ; Set root node of "TEMP" WP-field
"RTN","TIUSRVP",69,0)
 N TIUC,TIUI S (TIUC,TIUI)=0
"RTN","TIUSRVP",70,0)
 F  S TIUI=$O(^TIU(8925,TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",71,0)
 . S:$D(^TIU(8925,TIUDA,"TEMP",TIUI,0)) TIUC=TIUC+1
"RTN","TIUSRVP",72,0)
 S ^TIU(8925,TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",73,0)
 Q
"RTN","TIUSRVP",74,0)
MAKEADD(TIUDADD,TIUDA,TIUX,SUPPRESS) ; Create addendum record
"RTN","TIUSRVP",75,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUCAN,TIUFPRIV,TIU S TIUFPRIV=1
"RTN","TIUSRVP",76,0)
 S TIUCAN=$$CANDO^TIULP(TIUDA,"MAKE ADDENDUM")
"RTN","TIUSRVP",77,0)
 I TIUCAN'>0 S TIUDADD="0^You may not MAKE AN ADDENDUM for this "_$$STATUS^TIULC(TIUDA)_" "_$$PNAME^TIULC1(+$G(^TIU(8925,+TIUDA,0))) Q
"RTN","TIUSRVP",78,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM")
"RTN","TIUSRVP",79,0)
 S (DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUSRVP",80,0)
 D ^DIC
"RTN","TIUSRVP",81,0)
 S TIUDADD=+Y
"RTN","TIUSRVP",82,0)
 I +Y'>0 S TIUDADD=TIUDADD_"^Could not create addendum." Q
"RTN","TIUSRVP",83,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",84,0)
 S TIU("DOCTYP")=TIUATYP_U_$$PNAME^TIULC1(TIUATYP)
"RTN","TIUSRVP",85,0)
 D STUFREC^TIUSRVP1(+TIUDADD,.TIUX,DFN,+$G(TIUDA),TIUATYP,.TIU)
"RTN","TIUSRVP",86,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUSRVP",87,0)
 M ^TIU(8925,+TIUDADD,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",88,0)
 D SETXT0(+TIUDADD)
"RTN","TIUSRVP",89,0)
 D FILE(.SUCCESS,+TIUDADD,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",90,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDADD) Q
"RTN","TIUSRVP",91,0)
 I +$O(^TIU(8925,+TIUDADD,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDADD,.TIU)
"RTN","TIUSRVP",92,0)
 I '+$G(SUPPRESS) D RELEASE^TIUT(+TIUDADD,1)
"RTN","TIUSRVP",93,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUSRVP",94,0)
 Q
"RTN","TIUSRVP",95,0)
UPDATE(SUCCESS,TIUDA,TIUX,SUPPRESS) ; Update existing TIU Document
"RTN","TIUSRVP",96,0)
 N TIU,TIUI,TIUC,TIUD0,TIUD12,TIUD15,TIUCPF,TITLE
"RTN","TIUSRVP",97,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)>6 D  Q
"RTN","TIUSRVP",98,0)
 . S SUCCESS="0^ TIU Document #"_TIUDA_" is already signed..."
"RTN","TIUSRVP",99,0)
 I $D(TIUX("TEXT")) D
"RTN","TIUSRVP",100,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",101,0)
 . M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT")
"RTN","TIUSRVP",102,0)
 . S (TIUC,TIUI)=0
"RTN","TIUSRVP",103,0)
 . F  S TIUI=$O(^TIU(8925,+TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",104,0)
 . . S TIUC=TIUC+1
"RTN","TIUSRVP",105,0)
 . I +TIUC>0 S ^TIU(8925,+TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",106,0)
 . K TIUX("TEXT")
"RTN","TIUSRVP",107,0)
 I +$O(TIUX(""))'>0 S:+$G(SUPPRESS) SUCCESS=+TIUDA Q
"RTN","TIUSRVP",108,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12)),TITLE=+TIUD0
"RTN","TIUSRVP",109,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP",110,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP",111,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP",112,0)
 D SETCOS(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",113,0)
 ; Title changed? Refile DC
"RTN","TIUSRVP",114,0)
 I +$G(TIUX(.01))>0,(+$G(TIUX(.01))'=+TIUD0) D
"RTN","TIUSRVP",115,0)
 . S TIUX(.04)=$$DOCCLASS^TIULC1(+$G(TIUX(.01)))
"RTN","TIUSRVP",116,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS),TIUCPF)
"RTN","TIUSRVP",117,0)
 I +SUCCESS'>0 K ^TIU(8925,+TIUDA,"TEMP") Q
"RTN","TIUSRVP",118,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",119,0)
 I $D(^TIU(8925,+TIUDA,"TEMP")) D
"RTN","TIUSRVP",120,0)
 . K ^TIU(8925,+TIUDA,"TEXT")
"RTN","TIUSRVP",121,0)
 . D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",122,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",123,0)
 . S:'+$G(SUCCESS) SUCCESS=+TIUDA
"RTN","TIUSRVP",124,0)
 ; If document is signed re-file /ES/
"RTN","TIUSRVP",125,0)
 S TIUD15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIUSRVP",126,0)
 I +TIUD15 D
"RTN","TIUSRVP",127,0)
 . N TIUBY,DR,DIE,DA,X,Y S TIUBY=$P(TIUD15,U,2) Q:+TIUBY'>0
"RTN","TIUSRVP",128,0)
 . S DR="1503///^S X=$$SIGNAME^TIULS("_TIUBY_");1504///^S X=$$SIGTITL^TIULS("_TIUBY_")"
"RTN","TIUSRVP",129,0)
 . S DA=TIUDA,DIE=8925 D ^DIE
"RTN","TIUSRVP",130,0)
 ; Evaluate/send alerts
"RTN","TIUSRVP",131,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",132,0)
 . I +$P(TIUD0,U,5)<5,'$D(TIUX(.05)) D UPDSTAT(TIUDA,+$G(TIUD0))
"RTN","TIUSRVP",133,0)
 . D SEND^TIUALRT(TIUDA),SENDID^TIUALRT1(TIUDA):+$G(^TIU(8925,+TIUDA,21))
"RTN","TIUSRVP",134,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",135,0)
 Q
"RTN","TIUSRVP",136,0)
SETCOS(TIUDA,TIUX,TIUD0,TIUD12) ; Evaluate/set cosig req
"RTN","TIUSRVP",137,0)
 N TIUDAD,TIUEXS,TIUNCS,TIUEXCS,TIURCS,TIUATT,TIUTTL,TIUDAD0
"RTN","TIUSRVP",138,0)
 S TIUEXS=$S(+$G(TIUX(1202)):+$G(TIUX(1202)),1:$P(TIUD12,U,4))
"RTN","TIUSRVP",139,0)
 S TIUNCS=$S(+$G(TIUX(1208)):+$G(TIUX(1208)),+$G(TIUX(1209)):+$G(TIUX(1209)),1:0)
"RTN","TIUSRVP",140,0)
 I TIUNCS S TIUX(1506)=$S(TIUNCS=TIUEXS:0,1:1) G SETCOSX
"RTN","TIUSRVP",141,0)
 S TIUEXCS=$P(TIUD12,U,8),TIUATT=$P(TIUD12,U,9)
"RTN","TIUSRVP",142,0)
 S TIUDAD=+$P(TIUD0,U,6),TIUDAD0=$G(^TIU(8925,+TIUDAD,0))
"RTN","TIUSRVP",143,0)
 I +$$ISDS^TIULX($S(+TIUDAD:+TIUDAD0,1:+TIUD0)) D  G SETCOSX
"RTN","TIUSRVP",144,0)
 . S TIUX(1506)=$S(TIUEXS=TIUEXCS:0,1:1)
"RTN","TIUSRVP",145,0)
 S TIUTTL=$S(+$G(TIUX(.01)):+$G(TIUX(.01)),1:+TIUD0)
"RTN","TIUSRVP",146,0)
 S TIUX(1506)=+$$REQCOSIG^TIULP(TIUTTL,TIUDA,TIUEXS)
"RTN","TIUSRVP",147,0)
SETCOSX S:'TIUX(1506) TIUX(1208)="@"
"RTN","TIUSRVP",148,0)
 Q
"RTN","TIUSRVP",149,0)
UPDSTAT(DA,TITLE)       ; Update the status on commitment
"RTN","TIUSRVP",150,0)
 N DR,DIE S DR=".05////"_$$STATUS^TIUSRVP1(DA,0,TITLE)
"RTN","TIUSRVP",151,0)
 I '+$P($G(^TIU(8925,DA,13)),U,4) S DR=DR_";1304////^S X=$$NOW^XLFDT"
"RTN","TIUSRVP",152,0)
 S DIE=8925
"RTN","TIUSRVP",153,0)
 D ^DIE
"RTN","TIUSRVP",154,0)
 Q
"RTN","TIUSRVP",155,0)
GETREC(DFN,TIU,TITLE,TIUNEW) ; Get or create document record
"RTN","TIUSRVP",156,0)
 N DA,DIC,DIE,DLAYGO,DR,X,Y,TIUDPRM,TIUFPRIV,TIUHIT,TIUSCAT
"RTN","TIUSRVP",157,0)
 S (TIUHIT,DA)=0,TIUFPRIV=1
"RTN","TIUSRVP",158,0)
 S (DIC,DLAYGO)=8925,DIC(0)="FL"
"RTN","TIUSRVP",159,0)
 ; S DIC("S")="I +$G(DFN)=+$P(^TIU(8925,+Y,0),U,2),(+$G(TIU(""VISIT""))=+$P(^TIU(8925,+Y,0),U,3))"
"RTN","TIUSRVP",160,0)
 S X=""""_"`"_+TITLE_"""" D ^DIC K DIC("S")
"RTN","TIUSRVP",161,0)
 I +Y'>0 Q Y_U_" Insufficient data to create a new record."
"RTN","TIUSRVP",162,0)
 S DA=+Y,TIUNEW=+$P(Y,U,3)
"RTN","TIUSRVP",163,0)
 N DIE,DR,TIUVISIT S DIE=8925
"RTN","TIUSRVP",164,0)
 S TIUVISIT=$S(+$G(TIU("VISIT")):+$G(TIU("VISIT")),1:"")
"RTN","TIUSRVP",165,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP",166,0)
 S DR=".04////"_$$DOCCLASS^TIULC1(+$P(Y,U,2))_";.13////"_TIUSCAT_";1205////"_$P($G(TIU("LOC")),U)_";1211////"_$P($G(TIU("VLOC")),U)
"RTN","TIUSRVP",167,0)
 D ^DIE
"RTN","TIUSRVP",168,0)
 Q +$G(DA)
"RTN","TIUSRVP",169,0)
FILE(SUCCESS,TIUDA,TIUX,SUPPRESS,TIUCPF) ; Call FM Filer & commit updates
"RTN","TIUSRVP",170,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIUCMMTX
"RTN","TIUSRVP",171,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS=""
"RTN","TIUSRVP",172,0)
 I +$G(TIUX(1202)) S TIUX(1204)=+$G(TIUX(1202))
"RTN","TIUSRVP",173,0)
 I +$G(TIUX(1209)) S TIUX(1208)=+$G(TIUX(1209))
"RTN","TIUSRVP",174,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP",175,0)
 ;Entered By field to the Author/Dictator field
"RTN","TIUSRVP",176,0)
 I $G(TIUCPF),+$G(TIUX(1202)) S TIUX(1302)=+$G(TIUX(1202))
"RTN","TIUSRVP",177,0)
 M @FDARR=TIUX
"RTN","TIUSRVP",178,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUSRVP",179,0)
 I $D(TIUMSG)>9 S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1)) Q
"RTN","TIUSRVP",180,0)
 S SUCCESS=TIUDA
"RTN","TIUSRVP",181,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",182,0)
 . N DA
"RTN","TIUSRVP",183,0)
 . S DA=TIUDA
"RTN","TIUSRVP",184,0)
 . S TIUCMMTX=$$COMMIT^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIUSRVP",185,0)
 . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUSRVP",186,0)
 . K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIUSRVP",187,0)
 Q
"RTN","TIUSRVP",188,0)
SIGN(ERR,TIUDA,TIUX) ; API for /es/
"RTN","TIUSRVP",189,0)
 N X,TIUACT,TIUSIGN,TIUD0,TIUD12,TIUSTAT,SIGNER,COSIGNER,VALID,XTRASGNR
"RTN","TIUSRVP",190,0)
 N TIUES S ERR=0
"RTN","TIUSRVP",191,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIUSRVP",192,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8)
"RTN","TIUSRVP",193,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVP",194,0)
 S TIUSTAT=+$P(TIUD0,U,5)
"RTN","TIUSRVP",195,0)
 S TIUACT=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIUSRVP",196,0)
 S TIUSIGN=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIUSRVP",197,0)
 I +TIUSIGN'>0 S ERR="89250004^"_$P(TIUSIGN,U,2) Q
"RTN","TIUSRVP",198,0)
 S VALID=$$VALIDATE($$DECRYP^XUSRB1(TIUX))
"RTN","TIUSRVP",199,0)
 I +VALID'>0 S ERR="89250005^"_$$EZBLD^DIALOG(89250005) Q
"RTN","TIUSRVP",200,0)
 S TIUES=1_U_$P($G(^VA(200,+DUZ,20)),U,2,3)
"RTN","TIUSRVP",201,0)
 I '+$G(XTRASGNR) D ES^TIURS(TIUDA,TIUES)
"RTN","TIUSRVP",202,0)
 I +$G(XTRASGNR) D ADDSIG^TIURS1(TIUDA,XTRASGNR)
"RTN","TIUSRVP",203,0)
 I +$G(^TIU(8925,TIUDA,21)),(TIUACT="SIGNATURE") D AUDLINK^TIUGR1(TIUDA,"a",+$G(^(21)))
"RTN","TIUSRVP",204,0)
 Q
"RTN","TIUSRVP",205,0)
VALIDATE(X) ; Validate /es/-code
"RTN","TIUSRVP",206,0)
 N TIUY S TIUY=0
"RTN","TIUSRVP",207,0)
 D HASH^XUSHSHP I X]"",(X=$P($G(^VA(200,+DUZ,20)),U,4)) S TIUY=1
"RTN","TIUSRVP",208,0)
 Q TIUY
"RTN","TIUSRVP",209,0)
DELETE(ERR,TIUDA,TIURSN) ; API for record deletion
"RTN","TIUSRVP",210,0)
 N TIUDEL,TIUD0 S ERR=0,TIUDEL=$$CANDO^TIULP(TIUDA,"DELETE RECORD")
"RTN","TIUSRVP",211,0)
 I TIUDEL'>0 S ERR="89250003^"_$$EZBLD^DIALOG(89250003) Q
"RTN","TIUSRVP",212,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP",213,0)
 I +$P(TIUD0,U,5)'<6 D  Q
"RTN","TIUSRVP",214,0)
 . S TIURSN=$G(TIURSN,"A")
"RTN","TIUSRVP",215,0)
 . D DELTEXT^TIURB2(TIUDA,TIURSN)
"RTN","TIUSRVP",216,0)
 D DIK^TIURB2(TIUDA)
"RTN","TIUSRVP",217,0)
 D DELAUDIT^TIUEDI1(TIUDA)
"RTN","TIUSRVP",218,0)
 Q
"RTN","TIUSRVP",219,0)
LOCK(ERR,TIUDA) ; Bid for lock on a TIU Document record
"RTN","TIUSRVP",220,0)
 L +^TIU(8925,+TIUDA):1 I  S ERR=0
"RTN","TIUSRVP",221,0)
 E  S ERR="1^ Another session has this record locked."
"RTN","TIUSRVP",222,0)
 Q
"RTN","TIUSRVP",223,0)
UNLOCK(ERR,TIUDA) ; Decrement Lock on a TIU Document record
"RTN","TIUSRVP",224,0)
 L -^TIU(8925,+TIUDA) S ERR=0
"RTN","TIUSRVP",225,0)
 Q
"RTN","TIUSRVP1")
0^5^B35741111
"RTN","TIUSRVP1",1,0)
TIUSRVP1 ; SLC/JER - More API's in support of PUT ;17-OCT-2001 12:00:00
"RTN","TIUSRVP1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,59,89,100,109**;Jun 20, 1997
"RTN","TIUSRVP1",3,0)
SITEPARM(TIUY) ; Get site parameters for GUI
"RTN","TIUSRVP1",4,0)
 N TIUPRM0,TIUPRM1
"RTN","TIUSRVP1",5,0)
 D SETPARM^TIULE
"RTN","TIUSRVP1",6,0)
 S TIUY=TIUPRM0
"RTN","TIUSRVP1",7,0)
 Q
"RTN","TIUSRVP1",8,0)
DEFDOC(TIUY,HLOC,USER,TIUDT,TIUIEN) ; Get default primary provider
"RTN","TIUSRVP1",9,0)
 N TIUSPRM,TIUDDOC,TIUAUTH
"RTN","TIUSRVP1",10,0)
 D SITEPARM(.TIUSPRM)
"RTN","TIUSRVP1",11,0)
 S TIUDDOC=+$P(TIUSPRM,U,8)
"RTN","TIUSRVP1",12,0)
 S TIUAUTH=$S((+$G(USER)!('+$G(TIUIEN))):0,1:+$P($G(^TIU(8925,+$G(TIUIEN),12)),U,2))
"RTN","TIUSRVP1",13,0)
 S USER=$S(+$G(USER):+$G(USER),+$G(TIUAUTH):+$G(TIUAUTH),1:DUZ)
"RTN","TIUSRVP1",14,0)
 S TIUDT=$S(+$G(TIUDT):+$G(TIUDT),1:DT)
"RTN","TIUSRVP1",15,0)
 S TIUY=$S(TIUDDOC=1:$$DFLTDOC^TIUPXAPI(HLOC),TIUDDOC=2:$$CURDOC(USER),1:"0^")
"RTN","TIUSRVP1",16,0)
 Q
"RTN","TIUSRVP1",17,0)
CURDOC(USER,TIUDT) ; Is the current user a known Provider?
"RTN","TIUSRVP1",18,0)
 N TIUY,TIUPROV S TIUY="0^"
"RTN","TIUSRVP1",19,0)
 S USER=$S(+$G(USER):+$G(USER),1:DUZ)
"RTN","TIUSRVP1",20,0)
 S TIUDT=$S(+$G(TIUDT):+$G(TIUDT),1:DT)
"RTN","TIUSRVP1",21,0)
 S TIUPROV=$$PROVIDER^TIUPXAP1(USER,TIUDT)
"RTN","TIUSRVP1",22,0)
 I +TIUPROV S TIUY=USER_U_$$PERSNAME^TIULC1(USER)
"RTN","TIUSRVP1",23,0)
 Q TIUY
"RTN","TIUSRVP1",24,0)
ISAPROV(TIUY,USER,DATE) ; Is user a provider?
"RTN","TIUSRVP1",25,0)
 S USER=$G(USER,DUZ)
"RTN","TIUSRVP1",26,0)
 S DATE=$G(DATE,DT)
"RTN","TIUSRVP1",27,0)
 S TIUY=$$PROVIDER^TIUPXAP1(USER,DATE)
"RTN","TIUSRVP1",28,0)
 Q
"RTN","TIUSRVP1",29,0)
DOCPARM(TIUY,TIUDA,TIUTYP) ; Get document parameters for GUI
"RTN","TIUSRVP1",30,0)
 I '+$G(TIUTYP),+$G(TIUDA) S TIUTYP=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP1",31,0)
 I '+$G(TIUTYP) S TIUY(0)="" Q
"RTN","TIUSRVP1",32,0)
 D DOCPRM^TIULC1(TIUTYP,.TIUY,$G(TIUDA))
"RTN","TIUSRVP1",33,0)
 I '$D(TIUY) S TIUY(0)=""
"RTN","TIUSRVP1",34,0)
 Q
"RTN","TIUSRVP1",35,0)
CONSTUB(TIUDA,GMRCVP,DFN) ; Create a stub for a Consult Report
"RTN","TIUSRVP1",36,0)
 N DIE,DR,DA
"RTN","TIUSRVP1",37,0)
 D STUB(.TIUDA,"CONSULT REPORT",DFN)
"RTN","TIUSRVP1",38,0)
 I +TIUDA'>0 Q
"RTN","TIUSRVP1",39,0)
 S DIE=8925,DA=+TIUDA,DR="1405////^S X=GMRCVP"
"RTN","TIUSRVP1",40,0)
 D ^DIE
"RTN","TIUSRVP1",41,0)
 Q
"RTN","TIUSRVP1",42,0)
STUB(TIUDA,TIUTITL,DFN) ; Create a stub
"RTN","TIUSRVP1",43,0)
 N TIUVSIT,TIUFPRIV,DIC,DIE,DR,DA,DLAYGO,X,Y S TIUFPRIV=1
"RTN","TIUSRVP1",44,0)
 I +$G(TIUTITL)'>0 S TIUTITL=$$WHATITLE^TIUPUTU(TIUTITL)
"RTN","TIUSRVP1",45,0)
 I +TIUTITL'>0 S TIUDA=-1 Q
"RTN","TIUSRVP1",46,0)
 S (DIC,DLAYGO)=8925,DIC(0)="LF"
"RTN","TIUSRVP1",47,0)
 S X=""""_"`"_+TIUTITL_""""
"RTN","TIUSRVP1",48,0)
 D ^DIC S TIUDA=+Y Q:+Y'>0
"RTN","TIUSRVP1",49,0)
 D EVENT(.TIU,DFN) I $L($G(TIU("VSTR")))'>0 S TIUDA=-1 Q
"RTN","TIUSRVP1",50,0)
 S DIE=DIC,DA=TIUDA
"RTN","TIUSRVP1",51,0)
 S DR=".02////"_+DFN_";.03////"_$P($G(TIU("VISIT")),U)_";.04////"_+$$DOCCLASS^TIULC1(TIUTITL)_";.05///UNDICTATED;.13////E;1301////"_+$$NOW^XLFDT
"RTN","TIUSRVP1",52,0)
 D ^DIE
"RTN","TIUSRVP1",53,0)
 Q
"RTN","TIUSRVP1",54,0)
EVENT(TIUY,DFN) ; Create an Event-type Visit Entry
"RTN","TIUSRVP1",55,0)
 N VDT,VSTR,DGPM
"RTN","TIUSRVP1",56,0)
 S DGPM=$G(^DPT(DFN,.105))
"RTN","TIUSRVP1",57,0)
 I +DGPM'>0 D
"RTN","TIUSRVP1",58,0)
 . S VDT=$$NOW^XLFDT
"RTN","TIUSRVP1",59,0)
 . S VSTR=";"_VDT_";"_"E"
"RTN","TIUSRVP1",60,0)
 D PATVADPT^TIULV(.TIUY,+DFN,DGPM,$G(VSTR))
"RTN","TIUSRVP1",61,0)
 I $G(TIUY("LOC"))="",+DUZ D
"RTN","TIUSRVP1",62,0)
 .N TIUPREF,IDX
"RTN","TIUSRVP1",63,0)
 .S TIUPREF=$$PERSPRF^TIULE(DUZ)
"RTN","TIUSRVP1",64,0)
 .S IDX=+$P(TIUPREF,U,2)
"RTN","TIUSRVP1",65,0)
 .I IDX S TIUY("LOC")=IDX_U_$P($G(^SC(IDX,0)),U,1)
"RTN","TIUSRVP1",66,0)
 Q
"RTN","TIUSRVP1",67,0)
GETPNAME(TIUY,TIUTYPE)  ; Get Print Name of a Document
"RTN","TIUSRVP1",68,0)
 S TIUY=$$PNAME^TIULC1(TIUTYPE)
"RTN","TIUSRVP1",69,0)
 Q
"RTN","TIUSRVP1",70,0)
SAVED(TIUY,TIUDA) ; Was the document committed to the database?
"RTN","TIUSRVP1",71,0)
 N TIUD12,TIUD13,TIUEBY,TIUAUT,TIUECS S TIUY=1
"RTN","TIUSRVP1",72,0)
 S TIUD12=$G(^TIU(8925,TIUDA,12)),TIUD13=$G(^(13))
"RTN","TIUSRVP1",73,0)
 S TIUEBY=$P(TIUD13,U,2),TIUAUT=$P(TIUD12,U,2),TIUECS=$P(TIUD12,U,8)
"RTN","TIUSRVP1",74,0)
 I $D(^TIU(8925,"ASAVE",+DUZ,TIUDA)) D  Q
"RTN","TIUSRVP1",75,0)
 . S TIUY="0^You appear to have been disconnected..."
"RTN","TIUSRVP1",76,0)
 I DUZ'=TIUEBY,(TIUEBY'=TIUAUT),$D(^TIU(8925,"ASAVE",+TIUEBY,TIUDA)) D  Q
"RTN","TIUSRVP1",77,0)
 . S TIUY="0^The transcriber appears to have been disconnected..."
"RTN","TIUSRVP1",78,0)
 I DUZ'=TIUAUT,$D(^TIU(8925,"ASAVE",+TIUAUT,TIUDA)) D  Q
"RTN","TIUSRVP1",79,0)
 . S TIUY="0^The author appears to have been disconnected..."
"RTN","TIUSRVP1",80,0)
 I DUZ'=TIUECS,$D(^TIU(8925,"ASAVE",+TIUECS,TIUDA)) D  Q
"RTN","TIUSRVP1",81,0)
 . S TIUY="0^The expected cosigner appears to have been disconnected..."
"RTN","TIUSRVP1",82,0)
 Q
"RTN","TIUSRVP1",83,0)
STUFREC(TIUDA,TIUREC,DFN,PARENT,TITLE,TIU) ; load TIUREC for create
"RTN","TIUSRVP1",84,0)
 N TIUREQCS,TIUSCAT,TIUSTAT,TIUCPF
"RTN","TIUSRVP1",85,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP1",86,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP1",87,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP1",88,0)
 S TIUSTAT=$$STATUS(TIUDA,+$G(SUPPRESS),$G(TITLE))
"RTN","TIUSRVP1",89,0)
 D REQCOS^TIUSRVA(.TIUREQCS,+TITLE,"",$S(+$G(TIUREC(1202)):+$G(TIUREC(1202)),1:DUZ))
"RTN","TIUSRVP1",90,0)
 I +$G(PARENT)'>0 D
"RTN","TIUSRVP1",91,0)
 . S TIUREC(.02)=$G(DFN),TIUREC(.03)=$P($G(TIU("VISIT")),U)
"RTN","TIUSRVP1",92,0)
 . S TIUREC(.05)=$S(+$G(TIUREC(.05)):+$G(TIUREC(.05)),+TIUSTAT:TIUSTAT,1:5)
"RTN","TIUSRVP1",93,0)
 . S TIUREC(.07)=$P($G(TIU("EDT")),U),TIUREC(.08)=$P($G(TIU("LDT")),U)
"RTN","TIUSRVP1",94,0)
 . S TIUREC(1401)=$P($G(TIU("AD#")),U)
"RTN","TIUSRVP1",95,0)
 . S TIUREC(1402)=$P($G(TIU("TS")),U)
"RTN","TIUSRVP1",96,0)
 . S TIUREC(1404)=$P($G(TIU("SVC")),U)
"RTN","TIUSRVP1",97,0)
 I +$G(PARENT)>0 D
"RTN","TIUSRVP1",98,0)
 . S TIUREC(.02)=+$P($G(^TIU(8925,+PARENT,0)),U,2)
"RTN","TIUSRVP1",99,0)
 . S TIUREC(.03)=+$P($G(^TIU(8925,+PARENT,0)),U,3)
"RTN","TIUSRVP1",100,0)
 . S TIUREC(.05)=$S(+$G(TIUREC(.05)):+$G(TIUREC(.05)),+TIUSTAT:TIUSTAT,1:5)
"RTN","TIUSRVP1",101,0)
 . S TIUREC(.06)=PARENT,TIUREC(.07)=$P(TIU("EDT"),U)
"RTN","TIUSRVP1",102,0)
 . S TIUREC(.08)=$P(TIU("LDT"),U)
"RTN","TIUSRVP1",103,0)
 . S TIUREC(1401)=$P($G(^TIU(8925,+PARENT,14)),U)
"RTN","TIUSRVP1",104,0)
 . S TIUREC(1402)=$P($G(^TIU(8925,+PARENT,14)),U,2)
"RTN","TIUSRVP1",105,0)
 . S TIUREC(1404)=$P($G(^TIU(8925,+PARENT,14)),U,4)
"RTN","TIUSRVP1",106,0)
 S TIUREC(.04)=$$DOCCLASS^TIULC1(TITLE)
"RTN","TIUSRVP1",107,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP1",108,0)
 S TIUREC(.13)=TIUSCAT
"RTN","TIUSRVP1",109,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP1",110,0)
 ;Author/Dictator and the Expected Signer fields to Null
"RTN","TIUSRVP1",111,0)
 S (TIUREC(1202),TIUREC(1204))=$S(+$G(TIUREC(1202)):+$G(TIUREC(1202)),TIUCPF:"",1:+$G(DUZ))
"RTN","TIUSRVP1",112,0)
 S TIUREC(1205)=$P($G(TIU("LOC")),U)
"RTN","TIUSRVP1",113,0)
 S TIUREC(1211)=$P($G(TIU("VLOC")),U)
"RTN","TIUSRVP1",114,0)
 S TIUREC(1201)=$$NOW^XLFDT
"RTN","TIUSRVP1",115,0)
 S TIUREC(1301)=$S($G(TIUREC(1301))]"":$P(TIUREC(1301),U),1:$$NOW^XLFDT)
"RTN","TIUSRVP1",116,0)
 I +$$ISDS^TIULX(TITLE) D
"RTN","TIUSRVP1",117,0)
 . I +$G(TIU("LDT"))'>0 S TIUREC(.12)=1
"RTN","TIUSRVP1",118,0)
 . S TIUREC(.13)="H"
"RTN","TIUSRVP1",119,0)
 . D REFDT(.TIUREC)
"RTN","TIUSRVP1",120,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP1",121,0)
 ;Entered By field to Null
"RTN","TIUSRVP1",122,0)
 S TIUREC(1303)="R",TIUREC(1302)=$S(TIUCPF:"",1:$G(DUZ))
"RTN","TIUSRVP1",123,0)
 I $S(+$G(TIUREC(1208)):1,+$G(TIUREQCS):1,1:0) S TIUREC(1506)=1
"RTN","TIUSRVP1",124,0)
 Q
"RTN","TIUSRVP1",125,0)
REFDT(TIUX) ; Hack Ref Date/time for DS's
"RTN","TIUSRVP1",126,0)
 S TIUX(1301)=$S(+$G(TIU("LDT")):+$G(TIU("LDT")),1:$G(TIUX(1301)))
"RTN","TIUSRVP1",127,0)
 Q
"RTN","TIUSRVP1",128,0)
STATUS(TIUDA,SUPPRESS,TITLE)  ; Compute the status of the current record
"RTN","TIUSRVP1",129,0)
 N TIUDPRM,TIUY
"RTN","TIUSRVP1",130,0)
 ; If the document is an addendum, compute status based on processing
"RTN","TIUSRVP1",131,0)
 ; requirements of the Parent document or its ancestors
"RTN","TIUSRVP1",132,0)
 I +$$ISADDNDM^TIULC1(TIUDA)!+$G(PARENT) D
"RTN","TIUSRVP1",133,0)
 . S TIUDA=$S(+$P(^TIU(8925,TIUDA,0),U,6):$P(^(0),U,6),+$G(PARENT):+$G(PARENT),1:TIUDA)
"RTN","TIUSRVP1",134,0)
 . S TITLE=+$G(^TIU(8925,TIUDA,0))
"RTN","TIUSRVP1",135,0)
 D DOCPRM^TIULC1(TITLE,.TIUDPRM,$G(TIUDA))
"RTN","TIUSRVP1",136,0)
 I +$P(TIUDPRM(0),U,2),+$G(SUPPRESS) S TIUY=3 G STATUX
"RTN","TIUSRVP1",137,0)
 S TIUY=$S(+$$REQVER^TIULC(+TIUDA,+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUSRVP1",138,0)
STATUX Q TIUY
"RTN","TIUSRVP1",139,0)
IDATTCH(TIUY,TIUDA,TIUDAD) ; Attach TIUDA as ID Child entry to TIUDAD
"RTN","TIUSRVP1",140,0)
 N TIUX
"RTN","TIUSRVP1",141,0)
 S TIUX(2101)=TIUDAD
"RTN","TIUSRVP1",142,0)
 D FILE^TIUSRVP(.TIUY,TIUDA,.TIUX,1)
"RTN","TIUSRVP1",143,0)
 D AUDLINK^TIUGR1(TIUDA,"a",TIUDAD)
"RTN","TIUSRVP1",144,0)
 D SENDID^TIUALRT1(TIUDA)
"RTN","TIUSRVP1",145,0)
 Q
"RTN","TIUSRVP1",146,0)
IDDTCH(TIUY,TIUDA) ; Detach TIUDA from its ID Parent
"RTN","TIUSRVP1",147,0)
 N TIUX,IDDAD
"RTN","TIUSRVP1",148,0)
 I '+$G(^TIU(8925,TIUDA,21)) D  Q
"RTN","TIUSRVP1",149,0)
 . S TIUY="0^Record #"_TIUDA_" is NOT an ID Entry."
"RTN","TIUSRVP1",150,0)
 S IDDAD=+$G(^TIU(8925,TIUDA,21))
"RTN","TIUSRVP1",151,0)
 S TIUX(2101)="@"
"RTN","TIUSRVP1",152,0)
 D FILE^TIUSRVP(.TIUY,TIUDA,.TIUX,1)
"RTN","TIUSRVP1",153,0)
 D AUDLINK^TIUGR1(TIUDA,"d",IDDAD)
"RTN","TIUSRVP1",154,0)
 D IDDEL^TIUALRT1(TIUDA)
"RTN","TIUSRVP1",155,0)
 Q
"RTN","TIUSRVR")
0^6^B16377964
"RTN","TIUSRVR",1,0)
TIUSRVR ; SLC/JER - Server fns for record manipulation ;31-OCT-2001 16:43:14
"RTN","TIUSRVR",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,28,69,89,122,109**;Jun 20, 1997
"RTN","TIUSRVR",3,0)
SGET(TIUY,DA) ; Get fixed fields for record TIUDA
"RTN","TIUSRVR",4,0)
 N DOC,LOC,PT,AUT,EDT,DTFMT,TIUPT,TIULST4,TIUREC,TIUR0,TIUR12,TIUR13
"RTN","TIUSRVR",5,0)
 N SUBJ,TIUCNT
"RTN","TIUSRVR",6,0)
 S TIUR0=$G(^TIU(8925,+DA,0)),TIUR12=$G(^TIU(8925,+DA,12))
"RTN","TIUSRVR",7,0)
 S TIUR13=$G(^TIU(8925,+DA,13)),TIUPT=$G(^DPT(+$P(TIUR0,U,2),0))
"RTN","TIUSRVR",8,0)
 S SUBJ=$G(^TIU(8925,+DA,17))
"RTN","TIUSRVR",9,0)
 S DOC=$$PNAME^TIULC1(+TIUR0)
"RTN","TIUSRVR",10,0)
 S LOC=$P($G(^SC(+$P(TIUR12,U,5),0)),U)
"RTN","TIUSRVR",11,0)
 S PT=$$NAME^TIULS($P(TIUPT,U),"LAST, FIRST MI")
"RTN","TIUSRVR",12,0)
 S TIULST4=$E($P(TIUPT,U,9),6,9)
"RTN","TIUSRVR",13,0)
 S TIULST4="("_$E(PT)_TIULST4_")"
"RTN","TIUSRVR",14,0)
 S AUT=$$SIGNAME^TIULS(+$P(TIUR12,U,2))
"RTN","TIUSRVR",15,0)
 S DTFMT=$S($L(+TIUR13,".")=2:"MM/DD/YY HR:MIN",1:"MM/DD/YY")
"RTN","TIUSRVR",16,0)
 S EDT=$$DATE^TIULS(+TIUR13,DTFMT)
"RTN","TIUSRVR",17,0)
 S TIUCNT=+$G(TIUCNT)+1
"RTN","TIUSRVR",18,0)
 S TIUY=DOC_U_EDT_U_PT_" "_TIULST4_U_AUT_U_LOC_U_SUBJ
"RTN","TIUSRVR",19,0)
 Q
"RTN","TIUSRVR",20,0)
TGET(TIUY,TIUDA,TIUJ,TIUDAD) ; Get each component
"RTN","TIUSRVR",21,0)
 N TIUKID,TIUDADT,TIUI,TIUSEE S TIUI=0
"RTN","TIUSRVR",22,0)
 S TIUSEE=$$CANDO^TIULP(TIUDA,"VIEW")
"RTN","TIUSRVR",23,0)
 I '+TIUSEE D  Q
"RTN","TIUSRVR",24,0)
 . S TIUY(1)="  "
"RTN","TIUSRVR",25,0)
 . S TIUY(2)=$P(TIUSEE,"^ ",2),(TIUI,TIUJ)=2
"RTN","TIUSRVR",26,0)
 F  S TIUI=$O(^TIU(8925,+TIUDA,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVR",27,0)
 . S TIUJ=+$G(TIUJ)+1
"RTN","TIUSRVR",28,0)
 . S TIUY(TIUJ)=$G(^TIU(8925,+TIUDA,"TEXT",TIUI,0))
"RTN","TIUSRVR",29,0)
 . ;S ^TMP("TIUTEXT",$J,TIUJ,0)=$G(^TIU(8925,+TIUDA,"TEXT",TIUI,0))
"RTN","TIUSRVR",30,0)
 ; Iterate through children, and get their text fields
"RTN","TIUSRVR",31,0)
 S TIUKID=0
"RTN","TIUSRVR",32,0)
 F  S TIUKID=$O(^TIU(8925,"DAD",+TIUDA,TIUKID)) Q:+TIUKID'>0  D
"RTN","TIUSRVR",33,0)
 . D TGET(.TIUY,TIUKID,.TIUJ,$G(TIUDAD,TIUDA))
"RTN","TIUSRVR",34,0)
 ;I $D(^TMP("TIUTEXT",$J)) S TIUY="^TMP(""TIUTEXT"",$J)"
"RTN","TIUSRVR",35,0)
 Q
"RTN","TIUSRVR",36,0)
GET4EDIT(TIUY,TIUDA,DR) ; Get data in preparation for editing a record
"RTN","TIUSRVR",37,0)
 N CANEDIT,ERR,D0,DIQ2,TIUARR,TIUF,TIUI
"RTN","TIUSRVR",38,0)
 I +$D(^TIU(8925,TIUDA,"TEMP")) D MERGTEXT(TIUDA)
"RTN","TIUSRVR",39,0)
 K ^TMP("TIUEDIT",$J),^TMP("TIULQ",$J)
"RTN","TIUSRVR",40,0)
 S TIUY=$NA(^TMP("TIUEDIT",$J)),TIUARR=$NA(^TMP("TIULQ",$J))
"RTN","TIUSRVR",41,0)
 S CANEDIT=$$CANDO^TIULP(TIUDA,"EDIT RECORD")
"RTN","TIUSRVR",42,0)
 I +CANEDIT'>0 S ^TMP("TIUEDIT",$J,0)="~"_$P(CANEDIT,U,2) Q
"RTN","TIUSRVR",43,0)
 D EXTRACT^TIULQ(TIUDA,TIUARR,.ERR,$G(DR),"",1,"IE",1)
"RTN","TIUSRVR",44,0)
 I $D(ERR) M TIUY=ERR Q
"RTN","TIUSRVR",45,0)
 S TIUF=0
"RTN","TIUSRVR",46,0)
 F  S TIUF=$O(@TIUARR@(TIUDA,TIUF)) Q:+TIUF'>0  D
"RTN","TIUSRVR",47,0)
 . S ^TMP("TIUEDIT",$J,TIUF)=TIUF_U_@TIUARR@(TIUDA,TIUF,"I")_U_@TIUARR@(TIUDA,TIUF,"E")
"RTN","TIUSRVR",48,0)
 S TIUI=0
"RTN","TIUSRVR",49,0)
 F  S TIUI=$O(@TIUARR@(TIUDA,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVR",50,0)
 . S ^TMP("TIUEDIT",$J,"TEXT",TIUI)=$G(@TIUARR@(TIUDA,"TEXT",TIUI,0))
"RTN","TIUSRVR",51,0)
 S ^TMP("TIUEDIT",$J,"TEXT",0)="$TXT",^TIU(8925,"ASAVE",DUZ,TIUDA)=""
"RTN","TIUSRVR",52,0)
 K @TIUARR
"RTN","TIUSRVR",53,0)
 Q
"RTN","TIUSRVR",54,0)
GETPREF(TIUY,USER) ; Get user's personal preferences
"RTN","TIUSRVR",55,0)
 ; Call with TIUY (by ref)
"RTN","TIUSRVR",56,0)
 ;           USER is pointer to file 200
"RTN","TIUSRVR",57,0)
 ; Returns   TIUY = USER ^ DEFAULT LOCATION ^ REVIEW SCREEN SORT FIELD ^
"RTN","TIUSRVR",58,0)
 ;               ==>REVIEW SCREEN SORT ORDER ^ DISPLAY MENUS ^ PATIENT
"RTN","TIUSRVR",59,0)
 ;               ==>SELECTION PREFERENCE ^ ASK 'Save changes?' AFTER
"RTN","TIUSRVR",60,0)
 ;               ==>EDIT ^ ASK SUBJECT FOR PROGRESS NOTES ^
"RTN","TIUSRVR",61,0)
 S TIUY=$$PERSPRF^TIULE(USER)
"RTN","TIUSRVR",62,0)
 Q
"RTN","TIUSRVR",63,0)
GETALRT(TIUY,XQAID) ;  Retrieve DFN and document type for a TIU alert
"RTN","TIUSRVR",64,0)
 N X,TIUDA,TIUDFN,ORTAB,TIUDAD,GMRCO
"RTN","TIUSRVR",65,0)
 S TIUDA=$TR($P(XQAID,";",1),"ABCDEFGHIJKLMNOPQRSTUVWXYZ") ; Strip Text
"RTN","TIUSRVR",66,0)
 I '+TIUDA!('$D(^TIU(8925,+TIUDA,0))) S TIUY="-1" Q
"RTN","TIUSRVR",67,0)
 S X=$P($G(^TIU(8925,TIUDA,0)),U)
"RTN","TIUSRVR",68,0)
 S TIUDFN=$P(^TIU(8925,TIUDA,0),U,2)
"RTN","TIUSRVR",69,0)
 I $P(^TIU(8925,TIUDA,0),U,6)'="" D
"RTN","TIUSRVR",70,0)
 . S TIUDAD=$P(^TIU(8925,TIUDA,0),U,6)
"RTN","TIUSRVR",71,0)
 . S X=$P($G(^TIU(8925,TIUDAD,0)),U)
"RTN","TIUSRVR",72,0)
 I ('+X)!('+TIUDFN) S TIUY="-1" Q
"RTN","TIUSRVR",73,0)
 S ORTAB=903    ;DEFAULT TO PN
"RTN","TIUSRVR",74,0)
 I +$$ISDS^TIULX(X) S ORTAB=901
"RTN","TIUSRVR",75,0)
 I +$$ISA^TIULX(X,$$CLASS^TIUCNSLT)!(+$$ISA^TIULX(X,+$$CLASS^TIUCP)) D
"RTN","TIUSRVR",76,0)
 . S GMRCO=$P(^TIU(8925,$S(+$G(TIUDAD):TIUDAD,1:TIUDA),14),U,5)
"RTN","TIUSRVR",77,0)
 . S ORTAB=902_";"_GMRCO
"RTN","TIUSRVR",78,0)
 S TIUY=TIUDA_U_TIUDFN_U_ORTAB
"RTN","TIUSRVR",79,0)
 Q
"RTN","TIUSRVR",80,0)
GET1405(TIUY,TIUDA) ; Get the Request (field #1405) for a document
"RTN","TIUSRVR",81,0)
 N TIUDAD,TIUTYP,TIU1405
"RTN","TIUSRVR",82,0)
 I '+TIUDA!('$D(^TIU(8925,+TIUDA,0))) S TIUY="-1^TIU Document does not exist" Q
"RTN","TIUSRVR",83,0)
 S TIUTYP=$P($G(^TIU(8925,TIUDA,0)),U)
"RTN","TIUSRVR",84,0)
 I $P(^TIU(8925,TIUDA,0),U,6)'="" D
"RTN","TIUSRVR",85,0)
 . S TIUDAD=$P(^TIU(8925,TIUDA,0),U,6)
"RTN","TIUSRVR",86,0)
 . S TIUTYP=$P($G(^TIU(8925,TIUDAD,0)),U)
"RTN","TIUSRVR",87,0)
 I '+TIUTYP S TIUY="-1^TIU parent document does not exist" Q
"RTN","TIUSRVR",88,0)
 S TIU1405=$P($G(^TIU(8925,$S(+$G(TIUDAD):TIUDAD,1:TIUDA),14)),U,5)
"RTN","TIUSRVR",89,0)
 I '+TIU1405 S TIUY="-1^No Request found for this document" Q
"RTN","TIUSRVR",90,0)
 S TIUY=TIU1405
"RTN","TIUSRVR",91,0)
 Q
"RTN","TIUSRVR",92,0)
MERGTEXT(TIUDA) ; Merge text from "TEMP"-node to "TEXT"-node
"RTN","TIUSRVR",93,0)
 N TIU
"RTN","TIUSRVR",94,0)
 D CLEANTXT(TIUDA)
"RTN","TIUSRVR",95,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVR",96,0)
 D MERGTEXT^TIUEDI1(TIUDA,.TIU)
"RTN","TIUSRVR",97,0)
 K ^TIU(8925,TIUDA,"TEMP")
"RTN","TIUSRVR",98,0)
 Q
"RTN","TIUSRVR",99,0)
CLEANTXT(TIUDA) ; Remove "TEXT"-nodes of document and components
"RTN","TIUSRVR",100,0)
 N TIUI S TIUI=0
"RTN","TIUSRVR",101,0)
 K ^TIU(8925,TIUDA,"TEXT")
"RTN","TIUSRVR",102,0)
 F  S TIUI=$O(^TIU(8925,"DAD",TIUDA,TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVR",103,0)
 . I +$$ISADDNDM^TIULC1(TIUI) Q
"RTN","TIUSRVR",104,0)
 . K ^TIU(8925,TIUI,"TEXT")
"RTN","TIUSRVR",105,0)
 Q
"RTN","TIUSRVR1")
0^7^B27364971
"RTN","TIUSRVR1",1,0)
TIUSRVR1 ; SLC/JER - RPC for record-wise GET ;23-MAR-2001 17:21:18
"RTN","TIUSRVR1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,32,87,89,100,109**;Jun 20, 1997
"RTN","TIUSRVR1",3,0)
TGET(TIUY,TIUDA,ACTION) ; Build ^TMP("TIUVIEW",$J,
"RTN","TIUSRVR1",4,0)
 N TIUL,TIUREC,TIUARR,TIUGDATA,TIUNAME,TIUPRM0,TIUPRM1,X,Y,TIUCPF
"RTN","TIUSRVR1",5,0)
 K ^TMP("TIUVIEW",$J),^TMP("TIU FOCUS",$J)
"RTN","TIUSRVR1",6,0)
 S ACTION=$G(ACTION,"VIEW"),TIUL=0
"RTN","TIUSRVR1",7,0)
 D SETPARM^TIULE
"RTN","TIUSRVR1",8,0)
 S TIUGDATA=$$SETGDATA(TIUDA)
"RTN","TIUSRVR1",9,0)
 I +$D(^TIU(8925,TIUDA,"TEMP")) D MERGTEXT^TIUSRVR(TIUDA)
"RTN","TIUSRVR1",10,0)
 S TIUY=$NA(^TMP("TIUVIEW",$J))
"RTN","TIUSRVR1",11,0)
 S TIUARR="^TMP(""TIUVIEW"",$J)"
"RTN","TIUSRVR1",12,0)
 I '$D(^TIU(8925,+TIUDA,0)) S VALMQUIT=1 Q
"RTN","TIUSRVR1",13,0)
 ; Initialize ^TMP("TIU FOCUS",$J) to the entry that has focus
"RTN","TIUSRVR1",14,0)
 S ^TMP("TIU FOCUS",$J)=TIUDA
"RTN","TIUSRVR1",15,0)
 ;Set a flag to indicate whether or not a Title is a memer of the
"RTN","TIUSRVR1",16,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVR1",17,0)
 S TIUCPF=+$$ISA^TIULX(+$G(^TIU(8925,TIUDA,0)),+$$CLASS^TIUCP)
"RTN","TIUSRVR1",18,0)
 ; Call INQUIRE to get record
"RTN","TIUSRVR1",19,0)
 D INQUIRE^TIUSRVR2(TIUDA,.TIUREC,TIUCPF)
"RTN","TIUSRVR1",20,0)
 ; First, load dictation, transcription data, etc.
"RTN","TIUSRVR1",21,0)
 D LOADTOP(.TIUREC,TIUDA,.TIUL,TIUGDATA,TIUCPF)
"RTN","TIUSRVR1",22,0)
 ; Next, load the remainder of the record
"RTN","TIUSRVR1",23,0)
 D LOADREC^TIUSRVR2(TIUDA,.TIUL,TIUGDATA,0,ACTION)
"RTN","TIUSRVR1",24,0)
 K ^TMP("TIU FOCUS",$J)
"RTN","TIUSRVR1",25,0)
 S VALMCNT=+$G(TIUL)
"RTN","TIUSRVR1",26,0)
 Q
"RTN","TIUSRVR1",27,0)
SETGDATA(TIUDA) ; Set TIUGDATA
"RTN","TIUSRVR1",28,0)
 N TIUY,SORT S TIUY=""
"RTN","TIUSRVR1",29,0)
 D DOCPRM^TIULC1(+$G(^TIU(8925,TIUDA,0)),.TIUDPRM,TIUDA)
"RTN","TIUSRVR1",30,0)
 S SORT=$S(+$P(TIUDPRM(0),U,18):"TITLE",1:"REFDT")
"RTN","TIUSRVR1",31,0)
 I +$G(^TIU(8925,TIUDA,21)) S TIUY=TIUDA_U_0_U_+$G(^(21))_U_SORT G SETGX
"RTN","TIUSRVR1",32,0)
 I +$O(^TIU(8925,"GDAD",TIUDA,0)) S TIUY=TIUDA_U_1_U_0_U_SORT
"RTN","TIUSRVR1",33,0)
SETGX Q TIUY
"RTN","TIUSRVR1",34,0)
LOADTOP(TIUREC,TIUDA,TIUL,TIUGDATA,TIUCPF) ; Load top information
"RTN","TIUSRVR1",35,0)
 N TIUY,SHORT,CURCHLD,CURPRNT,SELCHLD,SELPRNT
"RTN","TIUSRVR1",36,0)
 ; ---- For ID note, include Title, [Location, & Visit] with each
"RTN","TIUSRVR1",37,0)
 ;      entry, since they vary by entry.
"RTN","TIUSRVR1",38,0)
 ; ---- Follow with Date, Author, etc.
"RTN","TIUSRVR1",39,0)
 ; ---- For ID children in whole note display, shorten top info:
"RTN","TIUSRVR1",40,0)
 ;      Instead of Title, Location, Visit, Date, Author, etc.,
"RTN","TIUSRVR1",41,0)
 ;      use just Title, followed by just Date and Status:
"RTN","TIUSRVR1",42,0)
 S (SHORT,CURCHLD,CURPRNT,SELCHLD,SELPRNT)=0
"RTN","TIUSRVR1",43,0)
 I $P(TIUGDATA,U,3) S SELCHLD=1 ; Selected record was IDchild
"RTN","TIUSRVR1",44,0)
 I $P(TIUGDATA,U,2) S SELPRNT=1
"RTN","TIUSRVR1",45,0)
 I SELCHLD,TIUDA'=$P(TIUGDATA,U,3) S CURCHLD=1 ; Current rec is IDchild
"RTN","TIUSRVR1",46,0)
 I SELCHLD,TIUDA=$P(TIUGDATA,U,3) S CURPRNT=1
"RTN","TIUSRVR1",47,0)
 I SELPRNT,TIUDA=+TIUGDATA S CURPRNT=1
"RTN","TIUSRVR1",48,0)
 I SELPRNT,TIUDA'=+TIUGDATA S CURCHLD=1
"RTN","TIUSRVR1",49,0)
 I SELPRNT,CURCHLD S SHORT=1 ;Child in whole note: shorten top info
"RTN","TIUSRVR1",50,0)
 I SELCHLD,CURCHLD,$G(TIUGWHOL) S SHORT=1
"RTN","TIUSRVR1",51,0)
 I SELCHLD!SELPRNT D IDTOP(TIUDA,.TIUL,SHORT,CURPRNT) I 1
"RTN","TIUSRVR1",52,0)
 S TIUY=""
"RTN","TIUSRVR1",53,0)
 E  I $L(TIUREC(8925,+TIUDA,.01)) D
"RTN","TIUSRVR1",54,0)
 . S TIUY=$$SETSTR^VALM1("TITLE: "_TIUREC(8925,+TIUDA,.01),TIUY,8,64)
"RTN","TIUSRVR1",55,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",56,0)
 S TIUY=""
"RTN","TIUSRVR1",57,0)
 I SHORT D
"RTN","TIUSRVR1",58,0)
 . S TIUY=$$SETSTR^VALM1("DATE OF NOTE: "_TIUREC(8925,+TIUDA,1301),TIUY,1,39)
"RTN","TIUSRVR1",59,0)
 . S TIUY=$$SETSTR^VALM1("STATUS: "_TIUREC(8925,+TIUDA,.05),TIUY,42,38)
"RTN","TIUSRVR1",60,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",61,0)
 S TIUY=""
"RTN","TIUSRVR1",62,0)
 I 'SHORT D
"RTN","TIUSRVR1",63,0)
 . I $L(TIUREC(8925,+TIUDA,1307)) D  I 1
"RTN","TIUSRVR1",64,0)
 . . S TIUY=$$SETSTR^VALM1("DICT DATE: "_TIUREC(8925,+TIUDA,1307),TIUY,4,39)
"RTN","TIUSRVR1",65,0)
 . E  S TIUY=$$SETSTR^VALM1("DATE OF NOTE: "_TIUREC(8925,+TIUDA,1301),TIUY,1,39)
"RTN","TIUSRVR1",66,0)
 . S TIUY=$$SETSTR^VALM1("ENTRY DATE: "_TIUREC(8925,+TIUDA,1201),$G(TIUY),38,39)
"RTN","TIUSRVR1",67,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",68,0)
 . S TIUY=""
"RTN","TIUSRVR1",69,0)
 . I $L(TIUREC(8925,+TIUDA,1307)) D  I 1
"RTN","TIUSRVR1",70,0)
 . . S TIUY=$$SETSTR^VALM1("DICTATED BY: "_TIUREC(8925,+TIUDA,1202),TIUY,2,32)
"RTN","TIUSRVR1",71,0)
 . E  S TIUY=$$SETSTR^VALM1("AUTHOR: "_TIUREC(8925,+TIUDA,1202),TIUY,7,32)
"RTN","TIUSRVR1",72,0)
 . I $L(TIUREC(8925,+TIUDA,1209)) D  I 1
"RTN","TIUSRVR1",73,0)
 . . S TIUY=$$SETSTR^VALM1("ATTENDING: "_TIUREC(8925,+TIUDA,1209),TIUY,39,40)
"RTN","TIUSRVR1",74,0)
 . E  S TIUY=$$SETSTR^VALM1("EXP COSIGNER: "_TIUREC(8925,+TIUDA,1208),TIUY,36,40)
"RTN","TIUSRVR1",75,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",76,0)
 . S TIUY=""
"RTN","TIUSRVR1",77,0)
 . S TIUY=$$SETSTR^VALM1("URGENCY: "_TIUREC(8925,+TIUDA,.09),TIUY,6,36)
"RTN","TIUSRVR1",78,0)
 . S TIUY=$$SETSTR^VALM1("STATUS: "_TIUREC(8925,+TIUDA,.05),TIUY,42,38)
"RTN","TIUSRVR1",79,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",80,0)
 S TIUY=""
"RTN","TIUSRVR1",81,0)
 I '$L($G(^TIU(8925,+TIUDA,17))) D  I 1
"RTN","TIUSRVR1",82,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",83,0)
 E  D
"RTN","TIUSRVR1",84,0)
 . S TIUY=$$SETSTR^VALM1("SUBJECT: "_$G(^TIU(8925,+TIUDA,17)),TIUY,6,74)
"RTN","TIUSRVR1",85,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",86,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR1",87,0)
 ;If the document is a member of the Clinical Procedures Class, include the
"RTN","TIUSRVR1",88,0)
 ; Procedure Summary Code field and the Date/Time Performed field
"RTN","TIUSRVR1",89,0)
 I $G(TIUCPF) D
"RTN","TIUSRVR1",90,0)
 . S TIUL=TIUL+1,TIUY=""
"RTN","TIUSRVR1",91,0)
 . S TIUY=$$SETSTR^VALM1("PROCEDURE SUMMARY CODE: "_TIUREC(8925,+TIUDA,70201),$G(TIUY),1,54)
"RTN","TIUSRVR1",92,0)
 . S @TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",93,0)
 . S TIUL=TIUL+1,TIUY=""
"RTN","TIUSRVR1",94,0)
 . S TIUY=$$SETSTR^VALM1("DATE/TIME PERFORMED: "_TIUREC(8925,+TIUDA,70202),$G(TIUY),1,41)
"RTN","TIUSRVR1",95,0)
 . S @TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",96,0)
 . S TIUL=TIUL+1,TIUY="",@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",97,0)
 I +$$HASADDEN^TIULC1(TIUDA) D
"RTN","TIUSRVR1",98,0)
 . S TIUY="   *** "_$$PNAME^TIULC1(+$G(^TIU(8925,TIUDA,0)))
"RTN","TIUSRVR1",99,0)
 . S TIUY=TIUY_" Has ADDENDA ***"
"RTN","TIUSRVR1",100,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",101,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR1",102,0)
 Q
"RTN","TIUSRVR1",103,0)
 ;
"RTN","TIUSRVR1",104,0)
ISCOMP(DA) ; Evaluate whether a given record is a component
"RTN","TIUSRVR1",105,0)
 N TIUY,TIUTYP
"RTN","TIUSRVR1",106,0)
 S TIUTYP=+$G(^TIU(8925,DA,0))
"RTN","TIUSRVR1",107,0)
 S TIUY=$S($P($G(^TIU(8925.1,+TIUTYP,0)),U,4)="CO":1,1:0)
"RTN","TIUSRVR1",108,0)
 Q TIUY
"RTN","TIUSRVR1",109,0)
IDTOP(TIUDA,TIUL,SHORT,CURPRNT) ; Load entry-specific info:
"RTN","TIUSRVR1",110,0)
 ;Title, [Location, Visit] for ID entry.
"RTN","TIUSRVR1",111,0)
 ; Called by LOADTOP
"RTN","TIUSRVR1",112,0)
 N TIUY,TIUX,TIU
"RTN","TIUSRVR1",113,0)
 I CURPRNT S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL)="                         << Interdisciplinary Note >>"
"RTN","TIUSRVR1",114,0)
 I SHORT S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL)="                      << Interdisciplinary Note - Cont. >>"
"RTN","TIUSRVR1",115,0)
 D GETTIU^TIULD(.TIU,+TIUDA)
"RTN","TIUSRVR1",116,0)
 S TIUY="",TIUX="TITLE: "_$P($G(TIU("DOCTYP")),U,2)
"RTN","TIUSRVR1",117,0)
 S TIUY=$$SETSTR^VALM1(TIUX,TIUY,1,67)
"RTN","TIUSRVR1",118,0)
 S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",119,0)
 Q:SHORT
"RTN","TIUSRVR1",120,0)
 S TIUY="",TIUX="LOCATION: "_$P($G(TIU("LOC")),U,2)
"RTN","TIUSRVR1",121,0)
 S TIUY=$$SETSTR^VALM1(TIUX,TIUY,5,31)
"RTN","TIUSRVR1",122,0)
 I $L($G(TIU("WARD"))) D  I 1
"RTN","TIUSRVR1",123,0)
 . S TIUX="ADMISSION DATE: "_$P($G(TIU("EDT")),U,2)
"RTN","TIUSRVR1",124,0)
 . S TIUY=$$SETSTR^VALM1(TIUX,TIUY,34,37)
"RTN","TIUSRVR1",125,0)
 E  D
"RTN","TIUSRVR1",126,0)
 . S TIUX="VISIT DATE: "_$P($G(TIU("EDT")),U,2)
"RTN","TIUSRVR1",127,0)
 . S TIUY=$$SETSTR^VALM1(TIUX,TIUY,38,33)
"RTN","TIUSRVR1",128,0)
 S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",129,0)
 Q
"RTN","TIUSRVR2")
0^8^B30009019
"RTN","TIUSRVR2",1,0)
TIUSRVR2 ; SLC/JER - RPC for record-wise GET ;4/12/01
"RTN","TIUSRVR2",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**100,109**;Jun 20, 1997
"RTN","TIUSRVR2",3,0)
 ; 4/12/01 Moved signature modules to new rtn TIUSRVR3
"RTN","TIUSRVR2",4,0)
LOADREC(TIUDA,TIUL,TIUGDATA,TIUGWHOL,ACTION) ; Load ^TMP
"RTN","TIUSRVR2",5,0)
 ;Requires TIUDA, array TIUL, TIUGDATA
"RTN","TIUSRVR2",6,0)
 ;optional TIUGWHOL = 1 if we're mid-load for browse, and we're already
"RTN","TIUSRVR2",7,0)
 ;                    loading the whole note after the original entry,
"RTN","TIUSRVR2",8,0)
 ;                    so DON'T load the whole note again.
"RTN","TIUSRVR2",9,0)
 N TIUKID,TIUDADT,TIUI,CANSEE
"RTN","TIUSRVR2",10,0)
 N TIUPARNT,TIUPNAME,TIUPDATE
"RTN","TIUSRVR2",11,0)
 N TIUGPRNT,TIUGPNM,TIUGPDT,TIUPDATA,TIUHASKD
"RTN","TIUSRVR2",12,0)
 S ACTION=$G(ACTION,"VIEW")
"RTN","TIUSRVR2",13,0)
 ; ---- If user cannot view, say so and quit: ----
"RTN","TIUSRVR2",14,0)
 ;      TIU*1*100
"RTN","TIUSRVR2",15,0)
 S CANSEE=$S(+$$ISCOMP^TIUSRVR1(TIUDA)>0:1,1:$$CANDO^TIULP(+TIUDA,ACTION))
"RTN","TIUSRVR2",16,0)
 I +CANSEE'>0 D  Q
"RTN","TIUSRVR2",17,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=$P(CANSEE,U,2)
"RTN","TIUSRVR2",18,0)
 ; ---- Load text of TIUDA: ----
"RTN","TIUSRVR2",19,0)
 S TIUI=0
"RTN","TIUSRVR2",20,0)
 F  S TIUI=$O(^TIU(8925,+TIUDA,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVR2",21,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=$G(^TIU(8925,+TIUDA,"TEXT",+TIUI,0))
"RTN","TIUSRVR2",22,0)
 ; ---- if TIUDA is a COMPONENT, QUIT
"RTN","TIUSRVR2",23,0)
 Q:+$$ISCOMP^TIUSRVR1(TIUDA)
"RTN","TIUSRVR2",24,0)
 ; ---- If TIUDA **IS** an addendum, load addm signature,
"RTN","TIUSRVR2",25,0)
 ;         load original document, quit: ----
"RTN","TIUSRVR2",26,0)
 I +$$ISADDNDM^TIULC1(+TIUDA) D  Q
"RTN","TIUSRVR2",27,0)
 . N TIULINE,TIUPARNT S $P(TIULINE,"=",79)=""
"RTN","TIUSRVR2",28,0)
 . D LOADSIG^TIUSRVR3(TIUDA,.TIUL)
"RTN","TIUSRVR2",29,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",30,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIULINE
"RTN","TIUSRVR2",31,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",32,0)
 . S TIUPARNT=+$P(^TIU(8925,+TIUDA,0),U,6)
"RTN","TIUSRVR2",33,0)
 . S TIUPNAME=$$PNAME^TIULC1(+^TIU(8925,TIUPARNT,0))
"RTN","TIUSRVR2",34,0)
 . S TIUPDATE=+$G(^TIU(8925,TIUPARNT,13))
"RTN","TIUSRVR2",35,0)
 . S TIUPDATE=$$DATE^TIULS(TIUPDATE,"MM/DD/YY")
"RTN","TIUSRVR2",36,0)
 . S TIUPDATA=$$IDDATA^TIURECL1(TIUPARNT)
"RTN","TIUSRVR2",37,0)
 . S TIUHASKD=$P(TIUPDATA,U,2),TIUGPRNT=+$P(TIUPDATA,U,3)
"RTN","TIUSRVR2",38,0)
 . S TIUL=+$G(TIUL)+1
"RTN","TIUSRVR2",39,0)
 . I TIUHASKD D
"RTN","TIUSRVR2",40,0)
 . . S @TIUARR@(TIUL)=" --- Original Addended Interdisciplinary Entry ---"
"RTN","TIUSRVR2",41,0)
 . I TIUGPRNT D
"RTN","TIUSRVR2",42,0)
 . . S @TIUARR@(TIUL)=" --- Original Addended Interdisciplinary Entry ---"
"RTN","TIUSRVR2",43,0)
 . . S TIUGPNM=$$PNAME^TIULC1(+^TIU(8925,TIUGPRNT,0))
"RTN","TIUSRVR2",44,0)
 . . S TIUGPDT=+$G(^TIU(8925,TIUGPRNT,13))
"RTN","TIUSRVR2",45,0)
 . . S TIUGPDT=$$DATE^TIULS(TIUGPDT,"MM/DD/YY")
"RTN","TIUSRVR2",46,0)
 . I 'TIUHASKD,'TIUGPRNT S @TIUARR@(TIUL)=" --- Original Document ---"
"RTN","TIUSRVR2",47,0)
 . S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",48,0)
 . S TIUL=+$G(TIUL)+1
"RTN","TIUSRVR2",49,0)
 . I TIUHASKD D
"RTN","TIUSRVR2",50,0)
 . . S @TIUARR@(TIUL)="                    << Addended Interdisciplinary Entry >>"
"RTN","TIUSRVR2",51,0)
 . . S TIUL=+$G(TIUL)+1
"RTN","TIUSRVR2",52,0)
 . . S @TIUARR@(TIUL)=TIUPDATE_" "_TIUPNAME_":"
"RTN","TIUSRVR2",53,0)
 . I TIUGPRNT D
"RTN","TIUSRVR2",54,0)
 . . S @TIUARR@(TIUL)="                         << Interdisciplinary Note >>"
"RTN","TIUSRVR2",55,0)
 . . S TIUL=+$G(TIUL)+1
"RTN","TIUSRVR2",56,0)
 . . S @TIUARR@(TIUL)=TIUGPDT_" "_TIUGPNM
"RTN","TIUSRVR2",57,0)
 . . S TIUL=+$G(TIUL)+1
"RTN","TIUSRVR2",58,0)
 . . S @TIUARR@(TIUL)="                    << Addended Interdisciplinary Entry >>"
"RTN","TIUSRVR2",59,0)
 . . S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL)=TIUPDATE_" "_TIUPNAME_":"
"RTN","TIUSRVR2",60,0)
 . I 'TIUHASKD,'TIUGPRNT D
"RTN","TIUSRVR2",61,0)
 . . S @TIUARR@(TIUL)=TIUPDATE_" "_TIUPNAME_":"
"RTN","TIUSRVR2",62,0)
 . D LOADREC(TIUPARNT,.TIUL,TIUGDATA)
"RTN","TIUSRVR2",63,0)
 ; ---- Load components of TIUDA: ----
"RTN","TIUSRVR2",64,0)
 S TIUKID=0
"RTN","TIUSRVR2",65,0)
 F  S TIUKID=$O(^TIU(8925,"DAD",+TIUDA,TIUKID)) Q:+TIUKID'>0  D
"RTN","TIUSRVR2",66,0)
 . I +$$ISADDNDM^TIULC1(TIUKID)'>0 D LOADREC(TIUKID,.TIUL,$G(TIUGDATA))
"RTN","TIUSRVR2",67,0)
 ; ---- Load signature of TIUDA if TIUDA is not addm
"RTN","TIUSRVR2",68,0)
 ;           or comp: ----
"RTN","TIUSRVR2",69,0)
 I '$$ISCOMP^TIUSRVR1(TIUDA) D LOADSIG^TIUSRVR3(TIUDA,.TIUL)
"RTN","TIUSRVR2",70,0)
 ; ---- Load addenda of TIUDA: ----
"RTN","TIUSRVR2",71,0)
 S TIUKID=0
"RTN","TIUSRVR2",72,0)
 F  S TIUKID=$O(^TIU(8925,"DAD",+TIUDA,TIUKID)) Q:+TIUKID'>0  D
"RTN","TIUSRVR2",73,0)
 . ; If acting on an addendum, don't show it again.
"RTN","TIUSRVR2",74,0)
 . I +TIUKID=+$G(^TMP("TIU FOCUS",$J)) Q
"RTN","TIUSRVR2",75,0)
 . I +$$ISADDNDM^TIULC1(TIUKID) D LOADADD(TIUKID,.TIUL)
"RTN","TIUSRVR2",76,0)
 N IDDAD
"RTN","TIUSRVR2",77,0)
 S IDDAD=+$P(TIUGDATA,U,3)
"RTN","TIUSRVR2",78,0)
 ; ---- If Browsed Record is an ID Note, & this cycle has
"RTN","TIUSRVR2",79,0)
 ;      just loaded the parent entry, then load ID kids
"RTN","TIUSRVR2",80,0)
 ;      and quit: **100** ----
"RTN","TIUSRVR2",81,0)
 I $P(TIUGDATA,U,2),TIUDA=+TIUGDATA D LOADKIDS(TIUDA,.TIUL,TIUGDATA) Q
"RTN","TIUSRVR2",82,0)
 ; ---- If Browsed Record is an ID Entry, & this cycle hasn't begun
"RTN","TIUSRVR2",83,0)
 ;      loading the whole note, then load the whole ID Note after
"RTN","TIUSRVR2",84,0)
 ;      the browsed entry and quit: ----
"RTN","TIUSRVR2",85,0)
 I IDDAD,'$G(TIUGWHOL) D  Q
"RTN","TIUSRVR2",86,0)
 . S TIUGWHOL=1
"RTN","TIUSRVR2",87,0)
 . N TIULINE S $P(TIULINE,"=",79)=""
"RTN","TIUSRVR2",88,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",89,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIULINE
"RTN","TIUSRVR2",90,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",91,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=" --- Interdisciplinary Note ---"
"RTN","TIUSRVR2",92,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",93,0)
 . D LOADID(IDDAD,.TIUL,TIUGDATA,TIUGWHOL)
"RTN","TIUSRVR2",94,0)
 ; ---- If Browsed Record is an ID Entry, & this cycle has begun
"RTN","TIUSRVR2",95,0)
 ;      loading the whole ID note, and is currently loading the first
"RTN","TIUSRVR2",96,0)
 ;      entry of the whole note, then load kids and quit: ----
"RTN","TIUSRVR2",97,0)
 I IDDAD,$G(TIUGWHOL),TIUDA=IDDAD D LOADKIDS(TIUDA,.TIUL,TIUGDATA,TIUGWHOL) K TIUGWHOL
"RTN","TIUSRVR2",98,0)
 Q
"RTN","TIUSRVR2",99,0)
 ;
"RTN","TIUSRVR2",100,0)
LOADKIDS(TIUDA,TIUL,TIUGDATA,TIUGWHOL) ; Load ID kids of TIUDA
"RTN","TIUSRVR2",101,0)
 ; Requires TIUDA, array TIUL, TIUGDATA
"RTN","TIUSRVR2",102,0)
 N TIUK,PRMSORT,KIDDA,TIUD0,TIUD21
"RTN","TIUSRVR2",103,0)
 I $G(^TMP("TIUR",$J,"IDDATA",TIUDA)) S PRMSORT=$P(^TMP("TIUR",$J,"IDDATA",TIUDA),U,4)
"RTN","TIUSRVR2",104,0)
 E  S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD21=$G(^TIU(8925,TIUDA,21)),PRMSORT=$P($$IDDATA^TIURECL1(TIUDA,TIUD0,TIUD21),U,4)
"RTN","TIUSRVR2",105,0)
 D GETIDKID^TIURECL2(TIUDA,PRMSORT) ; sets array ^TMP("TIUIDKID",$J,
"RTN","TIUSRVR2",106,0)
 S TIUK=0
"RTN","TIUSRVR2",107,0)
 F  S TIUK=$O(^TMP("TIUIDKID",$J,TIUDA,TIUK)) Q:+TIUK'>0  D
"RTN","TIUSRVR2",108,0)
 . S KIDDA=^TMP("TIUIDKID",$J,TIUDA,TIUK)
"RTN","TIUSRVR2",109,0)
 . D LOADID(KIDDA,.TIUL,TIUGDATA,$G(TIUGWHOL))
"RTN","TIUSRVR2",110,0)
 K ^TMP("TIUIDKID",$J)
"RTN","TIUSRVR2",111,0)
 Q
"RTN","TIUSRVR2",112,0)
 ;
"RTN","TIUSRVR2",113,0)
LOADID(TIUDA,TIUL,TIUGDATA,TIUWHOL) ; Load ID note for browse
"RTN","TIUSRVR2",114,0)
 N TIUREC,TIU
"RTN","TIUSRVR2",115,0)
 I '$D(^TIU(8925,+TIUDA,0)) Q
"RTN","TIUSRVR2",116,0)
 ; ---- If ID Kid has focus, don't show it again ----
"RTN","TIUSRVR2",117,0)
 ; I TIUDA=+$G(^TMP("TIU FOCUS",$J)) Q
"RTN","TIUSRVR2",118,0)
 S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",119,0)
 D GETTIU^TIULD(.TIU,+TIUDA)
"RTN","TIUSRVR2",120,0)
 D INQUIRE(TIUDA,.TIUREC)
"RTN","TIUSRVR2",121,0)
 ; ---- Load info missing from header since this is ID note entry: ----
"RTN","TIUSRVR2",122,0)
 ; ---- Load dictation, transcription data, etc.: ----
"RTN","TIUSRVR2",123,0)
 D LOADTOP^TIUSRVR1(.TIUREC,TIUDA,.TIUL,$G(TIUGDATA))
"RTN","TIUSRVR2",124,0)
 ; ---- Load the remainder of the record: ----
"RTN","TIUSRVR2",125,0)
 D LOADREC(TIUDA,.TIUL,$G(TIUGDATA),$G(TIUWHOL))
"RTN","TIUSRVR2",126,0)
 Q
"RTN","TIUSRVR2",127,0)
 ;
"RTN","TIUSRVR2",128,0)
INQUIRE(TIUDA,TIUREC,TIUCPF) ; Inquire to document TIUDA and set TIUREC
"RTN","TIUSRVR2",129,0)
 N DA,DIC,DIQ,DR
"RTN","TIUSRVR2",130,0)
 S DA=TIUDA,DIC=8925,DIQ="TIUREC("
"RTN","TIUSRVR2",131,0)
 S DR=".01;.02;.05;.09;1201;1202;1208;1209;1301;1307;1501;1502;1505;1506"
"RTN","TIUSRVR2",132,0)
 ;If the document is a member of the Clinical Procedures Class, include the
"RTN","TIUSRVR2",133,0)
 ;Procedure Summary Code field and the Date/Time Performed field
"RTN","TIUSRVR2",134,0)
 I $G(TIUCPF) S DR=DR_";70201;70202"
"RTN","TIUSRVR2",135,0)
 D EN^DIQ1
"RTN","TIUSRVR2",136,0)
 Q
"RTN","TIUSRVR2",137,0)
LOADADD(TIUDADD,TIUL) ; Load addenda
"RTN","TIUSRVR2",138,0)
 N TIUDAUTH,TIUDATT,TIUJ,TIUSIG,TIUCSIG,TIUVIEW
"RTN","TIUSRVR2",139,0)
 S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR2",140,0)
 S TIUDADT=$$DATE^TIULS($P($G(^TIU(8925,+TIUDADD,13)),U),"MM/DD/CCYY")
"RTN","TIUSRVR2",141,0)
 S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUDADT_" ADDENDUM:"
"RTN","TIUSRVR2",142,0)
 S TIUVIEW=$$CANDO^TIULP(+TIUDADD,"VIEW")
"RTN","TIUSRVR2",143,0)
 I '+TIUVIEW D  Q
"RTN","TIUSRVR2",144,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=$P(TIUVIEW,U,2)
"RTN","TIUSRVR2",145,0)
 S TIUJ=0
"RTN","TIUSRVR2",146,0)
 F  S TIUJ=$O(^TIU(8925,+TIUDADD,"TEXT",TIUJ)) Q:+TIUJ'>0  D
"RTN","TIUSRVR2",147,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=$G(^TIU(8925,+TIUDADD,"TEXT",TIUJ,0))
"RTN","TIUSRVR2",148,0)
 D LOADSIG^TIUSRVR3(TIUDADD,.TIUL)
"RTN","TIUSRVR2",149,0)
 Q
"VER")
8.0^22.0
"^DD",8925,8925,70201,0)
PROCEDURE SUMMARY CODE^S^1:Normal;2:Abnormal;3:Borderline;4:Incomplete;^702;1^Q
"^DD",8925,8925,70201,3)
Indicate the summary code for this procedure once it is complete.
"^DD",8925,8925,70201,21,0)
^.001^2^2^3020109^^
"^DD",8925,8925,70201,21,1,0)
This field contains the summary code for this procedure once it is
"^DD",8925,8925,70201,21,2,0)
complete.
"^DD",8925,8925,70201,"DT")
3001128
"^DD",8925,8925,70202,0)
DATE/TIME PERFORMED^DX^^702;2^S %DT="ETXR",%DT(0)="-NOW" D ^%DT S X=Y K:Y<1 X
"^DD",8925,8925,70202,3)
Time is required.  Future date/time is not allowed.
"^DD",8925,8925,70202,21,0)
^^1^1^3020508^
"^DD",8925,8925,70202,21,1,0)
This field contains the Date/Time when the procedure was performed.
"^DD",8925,8925,70202,"DT")
3020321
**INSTALL NAME**
USR*1.0*19
"BLD",2971,0)
USR*1.0*19^AUTHORIZATION/SUBSCRIPTION^0^3020514^y
"BLD",2971,1,0)
^^2^2^3011009^^^^
"BLD",2971,1,1,0)
A description of this build can be found on the NATIONAL PATCH MODULE UNDER 
"BLD",2971,1,2,0)
USR*1*19.
"BLD",2971,4,0)
^9.64PA^8930.2^1
"BLD",2971,4,8930.2,0)
8930.2
"BLD",2971,4,8930.2,222)
y^y^f^^n^^y^o^n
"BLD",2971,4,"B",8930.2,8930.2)

"BLD",2971,"INID")
^
"BLD",2971,"INIT")

"BLD",2971,"KRN",0)
^9.67PA^19^17
"BLD",2971,"KRN",.4,0)
.4
"BLD",2971,"KRN",.401,0)
.401
"BLD",2971,"KRN",.402,0)
.402
"BLD",2971,"KRN",.403,0)
.403
"BLD",2971,"KRN",.5,0)
.5
"BLD",2971,"KRN",.84,0)
.84
"BLD",2971,"KRN",3.6,0)
3.6
"BLD",2971,"KRN",3.8,0)
3.8
"BLD",2971,"KRN",9.2,0)
9.2
"BLD",2971,"KRN",9.8,0)
9.8
"BLD",2971,"KRN",9.8,"NM",0)
^9.68A^^0
"BLD",2971,"KRN",19,0)
19
"BLD",2971,"KRN",19,"NM",0)
^9.68A^^
"BLD",2971,"KRN",19.1,0)
19.1
"BLD",2971,"KRN",101,0)
101
"BLD",2971,"KRN",409.61,0)
409.61
"BLD",2971,"KRN",771,0)
771
"BLD",2971,"KRN",870,0)
870
"BLD",2971,"KRN",8994,0)
8994
"BLD",2971,"KRN","B",.4,.4)

"BLD",2971,"KRN","B",.401,.401)

"BLD",2971,"KRN","B",.402,.402)

"BLD",2971,"KRN","B",.403,.403)

"BLD",2971,"KRN","B",.5,.5)

"BLD",2971,"KRN","B",.84,.84)

"BLD",2971,"KRN","B",3.6,3.6)

"BLD",2971,"KRN","B",3.8,3.8)

"BLD",2971,"KRN","B",9.2,9.2)

"BLD",2971,"KRN","B",9.8,9.8)

"BLD",2971,"KRN","B",19,19)

"BLD",2971,"KRN","B",19.1,19.1)

"BLD",2971,"KRN","B",101,101)

"BLD",2971,"KRN","B",409.61,409.61)

"BLD",2971,"KRN","B",771,771)

"BLD",2971,"KRN","B",870,870)

"BLD",2971,"KRN","B",8994,8994)

"BLD",2971,"QUES",0)
^9.62^^
"BLD",2971,"REQB",0)
^9.611^1^1
"BLD",2971,"REQB",1,0)
USR*1.0*15^2
"BLD",2971,"REQB","B","USR*1.0*15",1)

"DATA",8930.2,1,0)
AUTHOR/DICTATOR^Author (Dictator)^AU
"DATA",8930.2,2,0)
ATTENDING PHYSICIAN^Attending Physician^ATT
"DATA",8930.2,3,0)
TRANSCRIBER^Transciber^TR
"DATA",8930.2,4,0)
EXPECTED COSIGNER^Expected Cosigner^EC
"DATA",8930.2,5,0)
EXPECTED SIGNER^Expected Signer^ES
"DATA",8930.2,6,0)
SURROGATE^Surrogate^SUR
"DATA",8930.2,7,0)
ADDITIONAL SIGNER^Additional Signer^X
"DATA",8930.2,8,0)
COMPLETER^Completer^CP
"DATA",8930.2,8,1,0)
^^3^3^3001026^
"DATA",8930.2,8,1,1,0)
The completer of a document is the person whose signature completes
"DATA",8930.2,8,1,2,0)
(authenticates) the document.  If the document requires cosignature, the
"DATA",8930.2,8,1,3,0)
completer is the cosigner.  Otherwise the completer is the signer.
"DATA",8930.2,9,0)
INTERPRETER^Interpreter^IN
"DATA",8930.2,9,1,0)
^8930.21^1^1^3010420^^
"DATA",8930.2,9,1,1,0)
This is the person that will interpret the clinical procedure.
"FIA",8930.2)
USR ROLE
"FIA",8930.2,0)
^USR(8930.2,
"FIA",8930.2,0,0)
8930.2
"FIA",8930.2,0,1)
y^y^f^^n^^y^o^n
"FIA",8930.2,0,10)

"FIA",8930.2,0,11)

"FIA",8930.2,0,"RLRO")

"FIA",8930.2,0,"VR")
1.0^USR
"FIA",8930.2,8930.2)
0
"FIA",8930.2,8930.21)
0
"MBREQ")
0
"PKG",194,-1)
1^1
"PKG",194,0)
AUTHORIZATION/SUBSCRIPTION^USR^User Authorization
"PKG",194,20,0)
^9.402P^^
"PKG",194,22,0)
^9.49I^1^1
"PKG",194,22,1,0)
1.0^2970620
"PKG",194,22,1,"PAH",1,0)
19^3020514
"PKG",194,22,1,"PAH",1,1,0)
^^2^2^3020514
"PKG",194,22,1,"PAH",1,1,1,0)
A description of this build can be found on the NATIONAL PATCH MODULE UNDER 
"PKG",194,22,1,"PAH",1,1,2,0)
USR*1*19.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"SEC","^DIC",8930.2,8930.2,0,"AUDIT")
@
"SEC","^DIC",8930.2,8930.2,0,"DD")
@
"SEC","^DIC",8930.2,8930.2,0,"DEL")
@
"SEC","^DIC",8930.2,8930.2,0,"LAYGO")
@
"SEC","^DIC",8930.2,8930.2,0,"RD")
@
"SEC","^DIC",8930.2,8930.2,0,"WR")
@
"VER")
8.0^22.0
"^DD",8930.2,8930.2,0)
FIELD^^1^4
"^DD",8930.2,8930.2,0,"DDA")
N
"^DD",8930.2,8930.2,0,"DT")
3001026
"^DD",8930.2,8930.2,0,"IX","B",8930.2,.01)

"^DD",8930.2,8930.2,0,"NM","USR ROLE")

"^DD",8930.2,8930.2,0,"PT",8930.1,.06)

"^DD",8930.2,8930.2,0,"VRPK")
AUTHORIZATION/SUBSCRIPTION
"^DD",8930.2,8930.2,.01,0)
USER ROLE^RF^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",8930.2,8930.2,.01,1,0)
^.1
"^DD",8930.2,8930.2,.01,1,1,0)
8930.2^B
"^DD",8930.2,8930.2,.01,1,1,1)
S ^USR(8930.2,"B",$E(X,1,30),DA)=""
"^DD",8930.2,8930.2,.01,1,1,2)
K ^USR(8930.2,"B",$E(X,1,30),DA)
"^DD",8930.2,8930.2,.01,3)
Enter the role of the user with respect to the record.
"^DD",8930.2,8930.2,.01,21,0)
^^3^3^2950213^
"^DD",8930.2,8930.2,.01,21,1,0)
This is role which the user occupies with respect to a given record (e.g., 
"^DD",8930.2,8930.2,.01,21,2,0)
author (dictator), transcriber, expected signer, expected cosigner, 
"^DD",8930.2,8930.2,.01,21,3,0)
attending physician, etc.).
"^DD",8930.2,8930.2,.01,"DT")
2950213
"^DD",8930.2,8930.2,.02,0)
DISPLAY NAME^F^^0;2^K:$L(X)>30!($L(X)<3) X
"^DD",8930.2,8930.2,.02,3)
Enter the name of the user role which will be presented to the user.
"^DD",8930.2,8930.2,.02,"DT")
2950213
"^DD",8930.2,8930.2,.03,0)
CODE^F^^0;3^K:$L(X)>3!($L(X)<1) X
"^DD",8930.2,8930.2,.03,3)
Enter an abbreviated code by which the user role may be identified.
"^DD",8930.2,8930.2,.03,"DT")
2950213
"^DD",8930.2,8930.2,1,0)
DESCRIPTION^8930.21^^1;0
"^DD",8930.2,8930.21,0)
DESCRIPTION SUB-FIELD^^.01^1
"^DD",8930.2,8930.21,0,"DT")
3001026
"^DD",8930.2,8930.21,0,"NM","DESCRIPTION")

"^DD",8930.2,8930.21,0,"UP")
8930.2
"^DD",8930.2,8930.21,.01,0)
DESCRIPTION^W^^0;1^Q
"^DD",8930.2,8930.21,.01,3)
Enter a description of the role.
"^DD",8930.2,8930.21,.01,21,0)
^^2^2^3001026^
"^DD",8930.2,8930.21,.01,21,1,0)
This field permits description of roles such as COMPLETER, which
"^DD",8930.2,8930.21,.01,21,2,0)
may not be obvious.
"^DD",8930.2,8930.21,.01,"DT")
3001026
"^DIC",8930.2,8930.2,0)
USR ROLE^8930.2
"^DIC",8930.2,8930.2,0,"GL")
^USR(8930.2,
"^DIC",8930.2,"B","USR ROLE",8930.2)

**END**
**END**
