EMERGENCY Released RG*1*28 SEQ #27
Extracted from mail message
**KIDS**:RG*1.0*28^

**INSTALL NAME**
RG*1.0*28
"BLD",1658,0)
RG*1.0*28^CLINICAL INFO RESOURCE NETWORK^0^3021206^y
"BLD",1658,1,0)
^^3^3^3021206^
"BLD",1658,1,1,0)
DUPLICATE A03 MESSAGES
"BLD",1658,1,2,0)
Refer to patch RG*1*28 in the FORUM Patch Module for a complete
"BLD",1658,1,3,0)
description.
"BLD",1658,4,0)
^9.64PA^^
"BLD",1658,"ABNS",0)
^9.66A^^
"BLD",1658,"ABPKG")
^^
"BLD",1658,"KRN",0)
^9.67PA^8989.52^19
"BLD",1658,"KRN",.4,0)
.4
"BLD",1658,"KRN",.401,0)
.401
"BLD",1658,"KRN",.402,0)
.402
"BLD",1658,"KRN",.403,0)
.403
"BLD",1658,"KRN",.5,0)
.5
"BLD",1658,"KRN",.84,0)
.84
"BLD",1658,"KRN",3.6,0)
3.6
"BLD",1658,"KRN",3.8,0)
3.8
"BLD",1658,"KRN",9.2,0)
9.2
"BLD",1658,"KRN",9.8,0)
9.8
"BLD",1658,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",1658,"KRN",9.8,"NM",1,0)
RGADT1^^0^B40573035
"BLD",1658,"KRN",9.8,"NM",2,0)
RGMTHL2^^0^B28067795
"BLD",1658,"KRN",9.8,"NM","B","RGADT1",1)

"BLD",1658,"KRN",9.8,"NM","B","RGMTHL2",2)

"BLD",1658,"KRN",19,0)
19
"BLD",1658,"KRN",19.1,0)
19.1
"BLD",1658,"KRN",101,0)
101
"BLD",1658,"KRN",409.61,0)
409.61
"BLD",1658,"KRN",771,0)
771
"BLD",1658,"KRN",870,0)
870
"BLD",1658,"KRN",8989.51,0)
8989.51
"BLD",1658,"KRN",8989.52,0)
8989.52
"BLD",1658,"KRN",8994,0)
8994
"BLD",1658,"KRN","B",.4,.4)

"BLD",1658,"KRN","B",.401,.401)

"BLD",1658,"KRN","B",.402,.402)

"BLD",1658,"KRN","B",.403,.403)

"BLD",1658,"KRN","B",.5,.5)

"BLD",1658,"KRN","B",.84,.84)

"BLD",1658,"KRN","B",3.6,3.6)

"BLD",1658,"KRN","B",3.8,3.8)

"BLD",1658,"KRN","B",9.2,9.2)

"BLD",1658,"KRN","B",9.8,9.8)

"BLD",1658,"KRN","B",19,19)

"BLD",1658,"KRN","B",19.1,19.1)

"BLD",1658,"KRN","B",101,101)

"BLD",1658,"KRN","B",409.61,409.61)

"BLD",1658,"KRN","B",771,771)

"BLD",1658,"KRN","B",870,870)

"BLD",1658,"KRN","B",8989.51,8989.51)

"BLD",1658,"KRN","B",8989.52,8989.52)

"BLD",1658,"KRN","B",8994,8994)

"BLD",1658,"QUES",0)
^9.62^^
"BLD",1658,"REQB",0)
^9.611^1^1
"BLD",1658,"REQB",1,0)
RG*1.0*27^2
"BLD",1658,"REQB","B","RG*1.0*27",1)

"MBREQ")
0
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
28^3021206
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3021206
"PKG",272,22,1,"PAH",1,1,1,0)
DUPLICATE A03 MESSAGES
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*28 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","RGADT1")
0^1^B40573035
"RTN","RGADT1",1,0)
RGADT1 ;HIRMFO/GJC-BUILD ADT MESSAGES (A01/A03) ;09/21/99
"RTN","RGADT1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,14,17,27,28**;30 Apr 99
"RTN","RGADT1",3,0)
 Q  ; quit if called from the top
"RTN","RGADT1",4,0)
 ;
"RTN","RGADT1",5,0)
EN ; entry point to build/transmit ADT messages
"RTN","RGADT1",6,0)
 ; Messages built by this software are fired off by server protocols:
"RTN","RGADT1",7,0)
 ; RG ADT-A01 SERVER -or- RG ADT-A03 SERVER
"RTN","RGADT1",8,0)
 ;
"RTN","RGADT1",9,0)
 ; This code is called from the RG ADT INPATIENT ENCOUNTER DRIVER &
"RTN","RGADT1",10,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER protocols.
"RTN","RGADT1",11,0)
 ;
"RTN","RGADT1",12,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER is an item protocol under the
"RTN","RGADT1",13,0)
 ; SDAM APPOINTMENTS EVENTS protocol & RG ADT INPATIENT ENCOUNTER DRIVER
"RTN","RGADT1",14,0)
 ; hangs off of the DGPM MOVEMENT EVENTS protocol.
"RTN","RGADT1",15,0)
 ;
"RTN","RGADT1",16,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER hangs off of SDAM APPOINTMENTS
"RTN","RGADT1",17,0)
 ; EVENTS because of DBIA: 1320; RG ADT INPATIENT ENCOUNTER DRIVER
"RTN","RGADT1",18,0)
 ; hangs off of DGPM MOVEMENT EVENTS because of DBIA: 1181.
"RTN","RGADT1",19,0)
 ;
"RTN","RGADT1",20,0)
 ; Integration Agreements (IAs) utilized in this application:
"RTN","RGADT1",21,0)
 ; #1181-subscribers for the DGPM MOVEMENT EVENTS event driver
"RTN","RGADT1",22,0)
 ; #1320-subscribers for the SDAM APPOINTMENT EVENTS event driver
"RTN","RGADT1",23,0)
 ; #2070-check for a national ICN 1st piece, "MPI" node (global read)
"RTN","RGADT1",24,0)
 ; #2161-INIT^HLFNC2
"RTN","RGADT1",25,0)
 ; #2164-GENERATE^HLMA
"RTN","RGADT1",26,0)
 ; #2171-$$WHAT^XUAF4 (Name_"^"_Station Number, we're after Station #)
"RTN","RGADT1",27,0)
 ; #2541-$$KSP^XUPARAM (facility ien, file 4)
"RTN","RGADT1",28,0)
 ; #2624-$$SEND^VAFHUTL()
"RTN","RGADT1",29,0)
 ; #3015-PID segment generation (CIRN PD)
"RTN","RGADT1",30,0)
 ; #3016-EVN segment generation (CIRN PD)
"RTN","RGADT1",31,0)
 ; #3017-PD1 segment generator (CIRN PD)
"RTN","RGADT1",32,0)
 ; #3018-PV1 segment generator (CIRN PD)
"RTN","RGADT1",33,0)
 ; #3072-assign a local ICN to a patient
"RTN","RGADT1",34,0)
 ; #3630-BLDEVN^VAFCQRY, BLDPD1^VAFCQRY & BLDPID^VAFCQRY
"RTN","RGADT1",35,0)
 ; #2988-FILE^VAFCTFU
"RTN","RGADT1",36,0)
 ;
"RTN","RGADT1",37,0)
 ; I $D(RGDG101) then we know we've dropped into this software
"RTN","RGADT1",38,0)
 ; from the DGPM MOVEMENT EVENTS protocol (RG ADT INPATIENT
"RTN","RGADT1",39,0)
 ; ENCOUNTER DRIVER)
"RTN","RGADT1",40,0)
 ;
"RTN","RGADT1",41,0)
 ; Note: DFN is a supported variable in the case of admissions and
"RTN","RGADT1",42,0)
 ; discharges within the Registration package. (part of the discovery
"RTN","RGADT1",43,0)
 ; in the development of RG*1.0*14)
"RTN","RGADT1",44,0)
 ;
"RTN","RGADT1",45,0)
 ; first check if HL7 2.3 messaging has been disabled.  DBIA: 2624
"RTN","RGADT1",46,0)
 I '$P($$SEND^VAFHUTL(),"^",2) Q
"RTN","RGADT1",47,0)
 S RGOK=0,RGDATE=""
"RTN","RGADT1",48,0)
 I $D(RGDG101) D
"RTN","RGADT1",49,0)
 . I $G(DFN)'=+$G(DFN) Q  ; DFN must be valid
"RTN","RGADT1",50,0)
 .; if an national ICN is missing, assign a local then quit
"RTN","RGADT1",51,0)
 . I '$P($G(^DPT(DFN,"MPI")),"^") S RGLOCAL=$$ICNLC^MPIF001(DFN) Q
"RTN","RGADT1",52,0)
 . Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit
"RTN","RGADT1",53,0)
 . N %,VAERR,VAIP
"RTN","RGADT1",54,0)
 . S VAIP("D")="LAST" D IN5^VADPT ; dfn should be defined at this point
"RTN","RGADT1",55,0)
 . S RGTYPE=+$G(VAIP(2)) ; RGTYPE=movement type
"RTN","RGADT1",56,0)
 . I RGTYPE'=1&(RGTYPE'=3) Q  ; admission or discharges only
"RTN","RGADT1",57,0)
 . S RGENVR=$S(RGTYPE=1:"A1",1:"A2") ; A1=admission, A2=discharge
"RTN","RGADT1",58,0)
 . S RGDATE=$P($G(VAIP(3)),"^"),RGMOV=$G(VAIP(1))
"RTN","RGADT1",59,0)
 . ; RGDATE=movement date/time, RGMOV=ien #405
"RTN","RGADT1",60,0)
 . S:RGDATE]"" RGOK=1
"RTN","RGADT1",61,0)
 . Q
"RTN","RGADT1",62,0)
 ;
"RTN","RGADT1",63,0)
 ; I $D(RGSD101) then we know we've dropped into this software
"RTN","RGADT1",64,0)
 ; from the SDAM APPOINTMENT EVENTS protocol (RG ADT OUTPATIENT
"RTN","RGADT1",65,0)
 ; ENCOUNTER DRIVER)
"RTN","RGADT1",66,0)
 ;
"RTN","RGADT1",67,0)
 ; Check SDAMEVT for values between five and nine inclusive.  See if
"RTN","RGADT1",68,0)
 ; this particular outpatient encounter has a status of CHECKED OUT.
"RTN","RGADT1",69,0)
 ; gjc@Hines OI for patch 14
"RTN","RGADT1",70,0)
 ;
"RTN","RGADT1",71,0)
 ; Note: DFN is not a supported variable in the case of clinic
"RTN","RGADT1",72,0)
 ; appointments and workload crediting for count clinics within the
"RTN","RGADT1",73,0)
 ; Scheduling package. (part of the discovery in the development of
"RTN","RGADT1",74,0)
 ; RG*1.0*14)
"RTN","RGADT1",75,0)
 ;
"RTN","RGADT1",76,0)
 ; check-out, stop code add/edit, disp add/edit?
"RTN","RGADT1",77,0)
 N I
"RTN","RGADT1",78,0)
 I $D(RGSD101),($D(SDAMEVT))#2 N DFN D
"RTN","RGADT1",79,0)
 . ; Note: DFN is unstable; it's up to us to define it...
"RTN","RGADT1",80,0)
 . ;chk-out, stop code add, stop code change, disp add & disp change
"RTN","RGADT1",81,0)
 . I SDAMEVT<5!(SDAMEVT>9) Q
"RTN","RGADT1",82,0)
 . S RGTYPE=SDAMEVT,RGENVR="A3"
"RTN","RGADT1",83,0)
 . N RGSDOE,RGPARSE,RGPROC,RGTMP S RGPROC=0
"RTN","RGADT1",84,0)
 . F  S RGPROC=$O(^TMP("SDEVT",$J,SDHDL,RGPROC)) Q:'RGPROC  D
"RTN","RGADT1",85,0)
 .. S RGSDOE=0
"RTN","RGADT1",86,0)
 .. F  S RGSDOE=$O(^TMP("SDEVT",$J,SDHDL,RGPROC,"SDOE",RGSDOE)) Q:'RGSDOE  D
"RTN","RGADT1",87,0)
 ... S RGSDOE(0)=$G(^TMP("SDEVT",$J,SDHDL,RGPROC,"SDOE",RGSDOE,0,"AFTER"))
"RTN","RGADT1",88,0)
 ... ; Note: RGSDOE(0)=zero node of 409.68, DFN is the second piece 
"RTN","RGADT1",89,0)
 ... S DFN=$P(RGSDOE(0),"^",2) Q:'DFN  ; DFN must exist
"RTN","RGADT1",90,0)
 ... ; ignore current inpatients
"RTN","RGADT1",91,0)
 ... Q:$L($G(^DPT(DFN,.1)))  ; ward location check IA: 10035
"RTN","RGADT1",92,0)
 ...; if an national ICN is missing, assign a local then quit
"RTN","RGADT1",93,0)
 ... I '$P($G(^DPT(DFN,"MPI")),"^") S RGLOCAL=$$ICNLC^MPIF001(DFN) Q
"RTN","RGADT1",94,0)
 ... Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit
"RTN","RGADT1",95,0)
 ... K RGPARSE D PARSE^SDOE(.RGSDOE,"EXTERNAL","RGPARSE")
"RTN","RGADT1",96,0)
 ... I $G(RGPARSE(.12))="CHECKED OUT" S RGTMP=$P(RGSDOE(0),U)
"RTN","RGADT1",97,0)
 ... S:$G(RGTMP)>RGDATE RGDATE=RGTMP
"RTN","RGADT1",98,0)
 ... Q
"RTN","RGADT1",99,0)
 .. Q
"RTN","RGADT1",100,0)
 . S:$G(RGDATE)]"" RGOK=1
"RTN","RGADT1",101,0)
 . Q
"RTN","RGADT1",102,0)
 ; S ^TMP("RGTRACE",$J)=1
"RTN","RGADT1",103,0)
 I 'RGOK K RGLOCAL,RGTYPE,RGMOV,RGDATE,RGENVR,RGOK Q  ; quit if not A01 or A03
"RTN","RGADT1",104,0)
 I '($G(DGQUIET)) S:$D(^TMP("RGTRACE",$J)) RGTRACE=1
"RTN","RGADT1",105,0)
 N RGSITE S RGSITE=+$$SITE^VASITE
"RTN","RGADT1",106,0)
 ;before updating and broadcasting check to see if the date and/or event changed
"RTN","RGADT1",107,0)
 N LIST,X,OUT,RGCHNG,RGDLT,RGEVN D TFL^VAFCTFU1(.LIST,DFN) S (RGCHNG,OUT,X)=0 F  S X=$O(LIST(X)) Q:'X!(OUT=1)  D
"RTN","RGADT1",108,0)
 . S RGDATE=$P(RGDATE,"."),RGDLT=$P(LIST(X),"^",3),RGDLT=$P(RGDLT,"."),RGEVN=$P(LIST(X),"^",4)
"RTN","RGADT1",109,0)
 . I $P(LIST(X),"^")=$P($$SITE^VASITE,"^",3) S OUT=1 D
"RTN","RGADT1",110,0)
 .. I RGDATE'=RGDLT D  Q
"RTN","RGADT1",111,0)
 ... I RGDATE>RGDLT S RGCHNG=1
"RTN","RGADT1",112,0)
 .. I RGDATE=RGDLT D
"RTN","RGADT1",113,0)
 .. I $E(RGENVR,2)'=RGEVN D
"RTN","RGADT1",114,0)
 ... I RGENVR="A3" S RGCHNG=0
"RTN","RGADT1",115,0)
 ... I RGENVR="A1" S RGCHNG=1
"RTN","RGADT1",116,0)
 ... I RGENVR="A2" S RGCHNG=1
"RTN","RGADT1",117,0)
 ;if no change in DLT or Event Reason quit
"RTN","RGADT1",118,0)
 Q:RGCHNG=0
"RTN","RGADT1",119,0)
 D FILE^VAFCTFU(DFN,RGSITE_"^"_$G(RGDATE)_"^"_$G(RGENVR),1)
"RTN","RGADT1",120,0)
 ;do FILE^VAFCTFU to update DLT and event reason
"RTN","RGADT1",121,0)
 I $D(RGTRACE) D EVENT,EXIT Q
"RTN","RGADT1",122,0)
 N ZTDESC,ZTRTN,ZTSAVE,ZTIO,ZTDTH
"RTN","RGADT1",123,0)
 S ZTDESC="CIRN HL7 ADT-"_$S(RGTYPE=1:"A01",1:"A03")_" Messaging"
"RTN","RGADT1",124,0)
 S ZTRTN="EVENT^RGADT1",ZTIO="",ZTDTH=$H
"RTN","RGADT1",125,0)
 F I="DFN","RGDATE","RGTYPE","RGENVR" S ZTSAVE(I)=""
"RTN","RGADT1",126,0)
 ; check for $D of RGDG101 & RGSD101 need to know protocol executed
"RTN","RGADT1",127,0)
 S:$D(RGDG101) ZTSAVE("RGDG101")="" S:$D(RGSD101) ZTSAVE("RGSD101")=""
"RTN","RGADT1",128,0)
 S:$D(RGMOV) ZTSAVE("RGMOV")="" ; defined for admissions & discharges
"RTN","RGADT1",129,0)
 S:$D(SDOE) ZTSAVE("SDOE")="" ; file ien: 409.68, clinic check out
"RTN","RGADT1",130,0)
 D ^%ZTLOAD,EXIT
"RTN","RGADT1",131,0)
 K DGQUIET
"RTN","RGADT1",132,0)
 Q
"RTN","RGADT1",133,0)
 ;
"RTN","RGADT1",134,0)
EVENT ; build the HL7 message
"RTN","RGADT1",135,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGADT1",136,0)
 S RGEVT=$S(RGTYPE=1:"A01",1:"A03") K HL
"RTN","RGADT1",137,0)
 D INIT^HLFNC2("RG ADT-"_RGEVT_" 2.4 SERVER",.HL)
"RTN","RGADT1",138,0)
 I $G(HL) Q  ; error
"RTN","RGADT1",139,0)
 D BUILD
"RTN","RGADT1",140,0)
 D GENERATE^HLMA("RG ADT-"_RGEVT_" 2.4 SERVER","LM",1,.RGRSLT,"",.HL)
"RTN","RGADT1",141,0)
 D KILL^HLTRANS
"RTN","RGADT1",142,0)
 K HLA("HLS"),RGDATE,RGDG101,RGENVR,RGEVT,RGSD101,RGTYPE
"RTN","RGADT1",143,0)
 Q
"RTN","RGADT1",144,0)
EXIT ; kill and quit
"RTN","RGADT1",145,0)
 K ^TMP("RGTRACE",$J),RGDATE,RGENVR,RGEVT,RGOK,RGLOCAL,RGMOV,RGPAT
"RTN","RGADT1",146,0)
 K RGRSLT,RGFSTR,RGTRACE,RGTYPE
"RTN","RGADT1",147,0)
 Q
"RTN","RGADT1",148,0)
BUILD ; build the ADT message
"RTN","RGADT1",149,0)
 ; EVN segment
"RTN","RGADT1",150,0)
 N CNT,ERR,EVN,RGCNT,SEQ
"RTN","RGADT1",151,0)
 S RGCNT=1
"RTN","RGADT1",152,0)
 D BLDEVN^VAFCQRY(DFN,"1,2,4,5,6,7",.EVN,.HL,$G(HL("ETN")))
"RTN","RGADT1",153,0)
 S HLA("HLS",RGCNT)=$G(EVN(1)) S RGCNT=RGCNT+1
"RTN","RGADT1",154,0)
 N PID S SEQ="1,3,5,6,7,8,11,29" D BLDPID^VAFCQRY(DFN,1,.SEQ,.PID,.HL,.ERR) S HLA("HLS",RGCNT)=PID(1) S X=1,CNT=1 F  S X=$O(PID(X)) Q:'X  I $D(PID(X)) S HLA("HLS",RGCNT,CNT)=PID(X),CNT=CNT+1
"RTN","RGADT1",155,0)
 S RGCNT=RGCNT+1
"RTN","RGADT1",156,0)
 ; PD1 segment
"RTN","RGADT1",157,0)
 N PD1
"RTN","RGADT1",158,0)
 S SEQ="3" D BLDPD1^VAFCQRY(DFN,.SEQ,.PD1,.HL,.ERR) S HLA("HLS",RGCNT)=PD1(1)
"RTN","RGADT1",159,0)
 S RGCNT=RGCNT+1
"RTN","RGADT1",160,0)
 ; PV1 segment
"RTN","RGADT1",161,0)
 S RGFSTR="2,3,4,5,"_$$COMMANUM(7,45)
"RTN","RGADT1",162,0)
 ;for admission/discharges (registration)
"RTN","RGADT1",163,0)
 I RGTYPE=1!(RGTYPE=3) S HLA("HLS",4)=$$IN^VAFHLPV1(DFN,RGDATE,RGFSTR,RGMOV,"","")
"RTN","RGADT1",164,0)
 ;for scheduling events: checkout
"RTN","RGADT1",165,0)
 I RGTYPE'=1&(RGTYPE'=3) S HLA("HLS",4)=$$EN^VAFHLPV1("",,RGFSTR,,HL("Q"),HL("FS"))
"RTN","RGADT1",166,0)
 S HLA("HLS",4)=$$FAC(HLA("HLS",4))
"RTN","RGADT1",167,0)
 Q
"RTN","RGADT1",168,0)
COMMANUM(FROM,TO) ;Build comma seperated list of numbers
"RTN","RGADT1",169,0)
 ;Input  : FROM - Starting number (default = 1)
"RTN","RGADT1",170,0)
 ;                   TO - Ending number (default = FROM)
"RTN","RGADT1",171,0)
 ;Output : Comma separated list of numbers between FROM and TO
"RTN","RGADT1",172,0)
 ;             (Ex: 1,2,3)
"RTN","RGADT1",173,0)
 ;Notes  : Call assumes FROM <= TO
"RTN","RGADT1",174,0)
 ;             copied from COMMANUM^VAFCADT2
"RTN","RGADT1",175,0)
 ;
"RTN","RGADT1",176,0)
 S FROM=$G(FROM) S:(FROM="") FROM=1
"RTN","RGADT1",177,0)
 S TO=$G(TO) S:(TO="") TO=FROM
"RTN","RGADT1",178,0)
 N OUTPUT,X
"RTN","RGADT1",179,0)
 S OUTPUT=FROM
"RTN","RGADT1",180,0)
 F X=(FROM+1):1:TO S OUTPUT=(OUTPUT_","_X)
"RTN","RGADT1",181,0)
 Q OUTPUT
"RTN","RGADT1",182,0)
 ;
"RTN","RGADT1",183,0)
FAC(X) ; set facility information, in the form of the Station Number, into
"RTN","RGADT1",184,0)
 ; PV1(3).
"RTN","RGADT1",185,0)
 ; input: the entire PV1 segment
"RTN","RGADT1",186,0)
 ; yield: updated PV1 segment; PV1(3) has facility information (Sta. #)
"RTN","RGADT1",187,0)
 N Y0,Y1 S Y0=$E(HL("ECH"),$L(HL("ECH")))_$$WHAT^XUAF4(+$$KSP^XUPARAM("INST"),99)
"RTN","RGADT1",188,0)
 S Y1=$P(X,HL("FS"),4),$P(Y1,$E(HL("ECH")),4)=Y0,$P(X,HL("FS"),4)=Y1
"RTN","RGADT1",189,0)
 Q X
"RTN","RGMTHL2")
0^2^B28067795
"RTN","RGMTHL2",1,0)
RGMTHL2 ;BIR/CML-COMPILE MPI/PD HL7 DATA FOR BI-DIRECTIONAL TCP ;11/15/01
"RTN","RGMTHL2",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**21,23,28**;30 Apr 99
"RTN","RGMTHL2",3,0)
 ;
"RTN","RGMTHL2",4,0)
 ;Reference to ^ORD(101 supported by IA #2596
"RTN","RGMTHL2",5,0)
 ;Reference to ^HL(772 supported by IA #3464
"RTN","RGMTHL2",6,0)
 ;Reference to ^HL(771.6 supported by IA #2507
"RTN","RGMTHL2",7,0)
 ;Reference to ^HLMA( supported by IA #3273
"RTN","RGMTHL2",8,0)
 ;
"RTN","RGMTHL2",9,0)
 ;Check to see if the ^XTMP global is present and/or complete
"RTN","RGMTHL2",10,0)
 W @IOF
"RTN","RGMTHL2",11,0)
 W !,"This utility searches the HL7 MESSAGE TEXT (#772) file for a selected"
"RTN","RGMTHL2",12,0)
 W !,"date range.  Each HL7 message in the date range is examined.  If the"
"RTN","RGMTHL2",13,0)
 W !,"RELATED EVENT PROTOCOL field contains the MPI/PD protocols (e.g., ""VAF"","
"RTN","RGMTHL2",14,0)
 W !,"""RG"", or ""MPI"") data is compiled into the ^XTMP(""RGMT"",""HL"" array."
"RTN","RGMTHL2",15,0)
 W !!,"A cross-reference is built on patient ICN and DFN for faster data retrieval"
"RTN","RGMTHL2",16,0)
 W !,"for the associated reports."
"RTN","RGMTHL2",17,0)
 ;
"RTN","RGMTHL2",18,0)
 G:'$D(^XTMP("RGMT","HL")) BEGIN
"RTN","RGMTHL2",19,0)
 I '$D(^XTMP("RGMT","HL","@@@@","STOPPED")) D
"RTN","RGMTHL2",20,0)
 .W !!,$C(7),"The Compile MPI/PD HL7 Data compilation is already running!" G QUIT
"RTN","RGMTHL2",21,0)
 S CDT=$$FMTE^XLFDT($E(+^XTMP("RGMT","HL","@@@@","STOPPED"),1,12))
"RTN","RGMTHL2",22,0)
 W !!,"=> ""Compile MPI/PD HL7 Data"" last ran to completion on "_CDT_".",!
"RTN","RGMTHL2",23,0)
 I $D(^XTMP("RGMT","HL","@@@@","RANGE")) D
"RTN","RGMTHL2",24,0)
 .W !,"=> Data has been compiled for ",^XTMP("RGMT","HL","@@@@","RANGE"),"."
"RTN","RGMTHL2",25,0)
 W ! K DIR S DIR(0)="SMB^D:DELETE;A:APPEND"
"RTN","RGMTHL2",26,0)
 S DIR("A",1)="Do you want to:"
"RTN","RGMTHL2",27,0)
 S DIR("A",2)="(D)elete existing data and recompile."
"RTN","RGMTHL2",28,0)
 S DIR("A")="(A)ppend new data after last date of existing data"
"RTN","RGMTHL2",29,0)
 S DIR("B")="A"
"RTN","RGMTHL2",30,0)
 S DIR("?",1)="Enter:",DIR("?",2)="D if you want to delete exiting data and recompile."
"RTN","RGMTHL2",31,0)
 S DIR("?",3)="A or <RET> to append new data after last date of existing data."
"RTN","RGMTHL2",32,0)
 S DIR("?")="""^"" to HALT."
"RTN","RGMTHL2",33,0)
 D ^DIR K DIR G:$D(DIRUT) QUIT S ACT=Y
"RTN","RGMTHL2",34,0)
 ;
"RTN","RGMTHL2",35,0)
BEGIN ;
"RTN","RGMTHL2",36,0)
 S RGNOW=$$NOW^XLFDT()
"RTN","RGMTHL2",37,0)
 S:'$D(ACT) ACT="D"
"RTN","RGMTHL2",38,0)
 W !!,"Enter date range for data to be compiled."
"RTN","RGMTHL2",39,0)
 I ACT="A" D
"RTN","RGMTHL2",40,0)
 .S X1=^XTMP("RGMT","HL","@@@@","COMPENDDATE"),X2=1 D C^%DTC
"RTN","RGMTHL2",41,0)
 .S RGBDT=X W !,"Beginning Date for Report: ",$$FMTE^XLFDT(X)
"RTN","RGMTHL2",42,0)
 I ACT="D" D  G:$D(DIRUT) QUIT
"RTN","RGMTHL2",43,0)
 .K DIR,DIRUT,DTOUT,DUOUT
"RTN","RGMTHL2",44,0)
 .S DIR(0)="DAO^:"_RGNOW_":EPXT",DIR("A")="Beginning Date for Report:  "
"RTN","RGMTHL2",45,0)
 .D ^DIR K DIR Q:$D(DIRUT)  S RGBDT=Y
"RTN","RGMTHL2",46,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","RGMTHL2",47,0)
 S DIR(0)="DAO^"_RGBDT_":"_RGNOW_":EPXT",DIR("A")="Ending Date for Report:  "
"RTN","RGMTHL2",48,0)
 D ^DIR K DIR G:$D(DIRUT) QUIT S RGEDT=Y
"RTN","RGMTHL2",49,0)
 ;
"RTN","RGMTHL2",50,0)
QUE ;Queue the task.
"RTN","RGMTHL2",51,0)
 S ZTSAVE("RGBDT")="",ZTSAVE("RGEDT")="",ZTSAVE("ACT")=""
"RTN","RGMTHL2",52,0)
 S ZTIO="",ZTRTN="START^RGMTHL2",ZTDESC="Compile MPI/PD HL7 Data (bi-directional)" D ^%ZTLOAD
"RTN","RGMTHL2",53,0)
 G QUIT
"RTN","RGMTHL2",54,0)
START ;
"RTN","RGMTHL2",55,0)
 K ^XTMP("RGMT","HL","@@@@","STOPPED")
"RTN","RGMTHL2",56,0)
 I ACT="D" K ^XTMP("RGMT","HL"),^XTMP("RGMT","HLICN"),^XTMP("RGMT","HLDFN")
"RTN","RGMTHL2",57,0)
 S U="^" D NOW^%DTC
"RTN","RGMTHL2",58,0)
 S ^XTMP("RGMT","HL","@@@@","STARTED")=%
"RTN","RGMTHL2",59,0)
 S ^XTMP("RGMT",0)=$$FMADD^XLFDT(DT,30)_"^"_%_"^MPI/PD Maintenance Data"
"RTN","RGMTHL2",60,0)
 I ACT="D" S ^XTMP("RGMT","HL","@@@@","COMPBEGINDATE")=RGBDT
"RTN","RGMTHL2",61,0)
 S ^XTMP("RGMT","HL","@@@@","COMPENDDATE")=RGEDT
"RTN","RGMTHL2",62,0)
 S PRGBDT=$$FMTE^XLFDT(^XTMP("RGMT","HL","@@@@","COMPBEGINDATE"))
"RTN","RGMTHL2",63,0)
 S PRGEDT=$$FMTE^XLFDT(RGEDT)
"RTN","RGMTHL2",64,0)
 S ^XTMP("RGMT","HL","@@@@","RANGE")=PRGBDT_" to "_PRGEDT
"RTN","RGMTHL2",65,0)
 ;
"RTN","RGMTHL2",66,0)
LOOP ;Loop on ^HL(772 date xref
"RTN","RGMTHL2",67,0)
 S STOPDT=$S($L(RGEDT)=7:RGEDT+.2359,1:RGEDT+.0001)
"RTN","RGMTHL2",68,0)
 S RGDT=RGBDT-.0001 F  S RGDT=$O(^HL(772,"B",RGDT)) Q:'RGDT  Q:RGDT>STOPDT  D
"RTN","RGMTHL2",69,0)
 .S ^XTMP("RGMT","HL","@@@@","NOW PROCESSING DATE")=RGDT
"RTN","RGMTHL2",70,0)
 .S IEN=0
"RTN","RGMTHL2",71,0)
 .F  S IEN=$O(^HL(772,"B",RGDT,IEN)) Q:'IEN  S IEN0=$G(^HL(772,IEN,0)) Q:'IEN0  D
"RTN","RGMTHL2",72,0)
 ..S REP=$P(IEN0,U,10)
"RTN","RGMTHL2",73,0)
 ..I REP D
"RTN","RGMTHL2",74,0)
 ...I '$D(^ORD(101,REP,0)) Q
"RTN","RGMTHL2",75,0)
 ...S REPNM=$P(^ORD(101,REP,0),U),RPNM=$E(REPNM,1,4)
"RTN","RGMTHL2",76,0)
 ...I RPNM["VAF"!(RPNM["RG")!(RPNM["MPI") D
"RTN","RGMTHL2",77,0)
 ....S TYPE=$P(IEN0,U,4),STAT=$P($G(^HL(772,IEN,"P")),U)
"RTN","RGMTHL2",78,0)
 ....I STAT="" D
"RTN","RGMTHL2",79,0)
 .....S HL773=$O(^HLMA("B",IEN,0))
"RTN","RGMTHL2",80,0)
 .....S STAT=$P($G(^HLMA(HL773,"P")),"^")
"RTN","RGMTHL2",81,0)
 ....I STAT S STATNM=$P(^HL(771.6,STAT,0),U)
"RTN","RGMTHL2",82,0)
 ....I STAT="" S STATNM="NO STATUS"
"RTN","RGMTHL2",83,0)
 ....S ^XTMP("RGMT","HL",REPNM,$P(RGDT,"."),TYPE,STATNM,IEN)=""
"RTN","RGMTHL2",84,0)
PAT ....S TXT=0 F  S TXT=$O(^HL(772,IEN,"IN",TXT)) Q:'TXT  D
"RTN","RGMTHL2",85,0)
 .....I $P(^HL(772,IEN,"IN",TXT,0),U)="PID" S GOT=0 D  Q:GOT
"RTN","RGMTHL2",86,0)
 ......I +$P(^(0),U,4) S ICN=+$P(^(0),U,4) D SET Q
"RTN","RGMTHL2",87,0)
 ......I +$P(^(0),U,3) S DFN=+$P(^(0),U,3) S ^XTMP("RGMT","HLDFN",DFN,RGDT,REPNM,TYPE,STATNM,IEN)="",GOT=1
"RTN","RGMTHL2",88,0)
 .....I $P(^HL(772,IEN,"IN",TXT,0),U)="QAK" S GOT=0 D  Q:GOT
"RTN","RGMTHL2",89,0)
 ......I +$P(^(0),U,2) S DFN=+$P(^(0),U,2) S ^XTMP("RGMT","HLDFN",DFN,RGDT,REPNM,TYPE,STATNM,IEN)="",GOT=1
"RTN","RGMTHL2",90,0)
 .....I $P(^HL(772,IEN,"IN",TXT,0),U)="RDT" S ICN=+$P($P(^(0),U,6),"V") I ICN D  Q
"RTN","RGMTHL2",91,0)
 ......S ^XTMP("RGMT","HLICN",ICN,RGDT,REPNM,TYPE,STATNM,IEN)="(Look at ^HL(772,"_IEN_",""IN"","_TXT_",0)",GOT=1
"RTN","RGMTHL2",92,0)
 .....I $P(^HL(772,IEN,"IN",TXT,0),U)="VTQ" S GOT=0 D  Q:GOT
"RTN","RGMTHL2",93,0)
 ......S SSN=$P($P(^HL(772,IEN,"IN",TXT,0),"@00122",2),"~",3) I SSN D
"RTN","RGMTHL2",94,0)
 .......S DFN=$O(^DPT("SSN",SSN,0)) I DFN D
"RTN","RGMTHL2",95,0)
 ........S ^XTMP("RGMT","HLDFN",DFN,RGDT,REPNM,TYPE,STATNM,IEN)="(Look at ^HL(772,"_IEN_",""IN"","_TXT_",0)",GOT=1
"RTN","RGMTHL2",96,0)
 .....I $P(^HL(772,IEN,"IN",TXT,0),U)="MFE",$P(^(0),U,2)="MAD" S ICN=+$P($P(^(0),U,5),"~",4) D SET Q
"RTN","RGMTHL2",97,0)
 .....I $P(^HL(772,IEN,"IN",TXT,0),U)="MFE",$P(^(0),U,2)="MUP" S ICN=+$P(^(0),U,5) D SET Q
"RTN","RGMTHL2",98,0)
 D NOW^%DTC S ^XTMP("RGMT","HL","@@@@","STOPPED")=%
"RTN","RGMTHL2",99,0)
 K ^XTMP("RGMT","HL","@@@@","NOW PROCESSING DATE")
"RTN","RGMTHL2",100,0)
QUIT ;
"RTN","RGMTHL2",101,0)
 K %,ACT,CDT,DFN,GOT,HL773,ICN,IEN,IEN0,PRGBDT,PRGEDT,REP,REPNM,RGBDT,RGDT
"RTN","RGMTHL2",102,0)
 K RGEDT,RGNOW,RPNM,SSN,STAT,STATNM,STOPDT,TYPE,TXT,X,X1,X2,Y,ZTSK
"RTN","RGMTHL2",103,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGMTHL2",104,0)
 Q
"RTN","RGMTHL2",105,0)
 ;
"RTN","RGMTHL2",106,0)
SET ;
"RTN","RGMTHL2",107,0)
 S ^XTMP("RGMT","HLICN",ICN,RGDT,REPNM,TYPE,STATNM,IEN)="" S GOT=1
"RTN","RGMTHL2",108,0)
 Q
"VER")
8.0^22.0
**END**
**END**
