Released PSJ*5*159 SEQ #171
Extracted from mail message
**KIDS**:PSJ*5.0*159^

**INSTALL NAME**
PSJ*5.0*159
"BLD",6022,0)
PSJ*5.0*159^INPATIENT MEDICATIONS^0^3070608^y
"BLD",6022,1,0)
^^26^26^3070524^
"BLD",6022,1,1,0)
1. A site reported a problem with the medication route being blank on the
"BLD",6022,1,2,0)
Bar Code Medication Administration (BCMA) V. 3.0 Virtual Due List. During
"BLD",6022,1,3,0)
investigation of possible corrections for this, it was determined that
"BLD",6022,1,4,0)
another issue needed to be addressed with how to determine when to prompt
"BLD",6022,1,5,0)
for an injection site.
"BLD",6022,1,6,0)
 
"BLD",6022,1,7,0)
This patch assists to correct these problems by adding two new items to 
"BLD",6022,1,8,0)
the Application Programming Interface (API) from Inpatient Medications V. 
"BLD",6022,1,9,0)
5.0 to BCMA. The NAME field (.01) as well as the PROMPT FOR INJ. SITE IN 
"BLD",6022,1,10,0)
BCMA field (#8) from the MEDICATION ROUTE file (#51.2) will now be sent in
"BLD",6022,1,11,0)
the API. HD0000000166204, HD0000000164890, PSI-06-152, PSI-06-158
"BLD",6022,1,12,0)
 
"BLD",6022,1,13,0)
2. In support of the BCMA V. 3.0 project BCMA HSC-III, two changes are 
"BLD",6022,1,14,0)
required to the APIs that supply information to BCMA. First, the flag 
"BLD",6022,1,15,0)
information for both Unit Dose and IV orders has been added to both the 
"BLD",6022,1,16,0)
summary and detail APIs. Second, an indicator has been added that will 
"BLD",6022,1,17,0)
tell BCMA that this order would have triggered a notification to the 
"BLD",6022,1,18,0)
STAT/NOW mail group.
"BLD",6022,1,19,0)
 
"BLD",6022,1,20,0)
3. During testing of the BCMA V. 3.0 project BCMA HSC-III, a problem was 
"BLD",6022,1,21,0)
discovered with the API that determines if an order should trigger a 
"BLD",6022,1,22,0)
notification to the STAT/NOW mail group. If the parameter which controls 
"BLD",6022,1,23,0)
the trigger was not defined, all orders would be flagged. This patch 
"BLD",6022,1,24,0)
corrects this problem. However, it is important to note that if the 
"BLD",6022,1,25,0)
parameter PRIORITIES FOR ACTIVE NOTIFY is not defined, no order will be 
"BLD",6022,1,26,0)
flagged as stat for the purposes of BCMA.
"BLD",6022,4,0)
^9.64PA^^
"BLD",6022,6)
7^
"BLD",6022,6.3)
15
"BLD",6022,"ABPKG")
n
"BLD",6022,"KRN",0)
^9.67PA^8989.52^19
"BLD",6022,"KRN",.4,0)
.4
"BLD",6022,"KRN",.401,0)
.401
"BLD",6022,"KRN",.402,0)
.402
"BLD",6022,"KRN",.403,0)
.403
"BLD",6022,"KRN",.5,0)
.5
"BLD",6022,"KRN",.84,0)
.84
"BLD",6022,"KRN",3.6,0)
3.6
"BLD",6022,"KRN",3.8,0)
3.8
"BLD",6022,"KRN",9.2,0)
9.2
"BLD",6022,"KRN",9.8,0)
9.8
"BLD",6022,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",6022,"KRN",9.8,"NM",1,0)
PSJBCMA^^0^B70029264
"BLD",6022,"KRN",9.8,"NM",2,0)
PSJBCMA1^^0^B70574949
"BLD",6022,"KRN",9.8,"NM",3,0)
PSJHL4A^^0^B37280684
"BLD",6022,"KRN",9.8,"NM","B","PSJBCMA",1)

"BLD",6022,"KRN",9.8,"NM","B","PSJBCMA1",2)

"BLD",6022,"KRN",9.8,"NM","B","PSJHL4A",3)

"BLD",6022,"KRN",19,0)
19
"BLD",6022,"KRN",19.1,0)
19.1
"BLD",6022,"KRN",101,0)
101
"BLD",6022,"KRN",409.61,0)
409.61
"BLD",6022,"KRN",771,0)
771
"BLD",6022,"KRN",870,0)
870
"BLD",6022,"KRN",8989.51,0)
8989.51
"BLD",6022,"KRN",8989.52,0)
8989.52
"BLD",6022,"KRN",8994,0)
8994
"BLD",6022,"KRN","B",.4,.4)

"BLD",6022,"KRN","B",.401,.401)

"BLD",6022,"KRN","B",.402,.402)

"BLD",6022,"KRN","B",.403,.403)

"BLD",6022,"KRN","B",.5,.5)

"BLD",6022,"KRN","B",.84,.84)

"BLD",6022,"KRN","B",3.6,3.6)

"BLD",6022,"KRN","B",3.8,3.8)

"BLD",6022,"KRN","B",9.2,9.2)

"BLD",6022,"KRN","B",9.8,9.8)

"BLD",6022,"KRN","B",19,19)

"BLD",6022,"KRN","B",19.1,19.1)

"BLD",6022,"KRN","B",101,101)

"BLD",6022,"KRN","B",409.61,409.61)

"BLD",6022,"KRN","B",771,771)

"BLD",6022,"KRN","B",870,870)

"BLD",6022,"KRN","B",8989.51,8989.51)

"BLD",6022,"KRN","B",8989.52,8989.52)

"BLD",6022,"KRN","B",8994,8994)

"BLD",6022,"QUES",0)
^9.62^^
"BLD",6022,"REQB",0)
^9.611^3^3
"BLD",6022,"REQB",1,0)
PSJ*5.0*186^2
"BLD",6022,"REQB",2,0)
PSJ*5.0*170^2
"BLD",6022,"REQB",3,0)
PSS*1.0*88^2
"BLD",6022,"REQB","B","PSJ*5.0*170",2)

"BLD",6022,"REQB","B","PSJ*5.0*186",1)

"BLD",6022,"REQB","B","PSS*1.0*88",3)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
159^3070608^11881
"PKG",197,22,1,"PAH",1,1,0)
^^26^26^3070608
"PKG",197,22,1,"PAH",1,1,1,0)
1. A site reported a problem with the medication route being blank on the
"PKG",197,22,1,"PAH",1,1,2,0)
Bar Code Medication Administration (BCMA) V. 3.0 Virtual Due List. During
"PKG",197,22,1,"PAH",1,1,3,0)
investigation of possible corrections for this, it was determined that
"PKG",197,22,1,"PAH",1,1,4,0)
another issue needed to be addressed with how to determine when to prompt
"PKG",197,22,1,"PAH",1,1,5,0)
for an injection site.
"PKG",197,22,1,"PAH",1,1,6,0)
 
"PKG",197,22,1,"PAH",1,1,7,0)
This patch assists to correct these problems by adding two new items to 
"PKG",197,22,1,"PAH",1,1,8,0)
the Application Programming Interface (API) from Inpatient Medications V. 
"PKG",197,22,1,"PAH",1,1,9,0)
5.0 to BCMA. The NAME field (.01) as well as the PROMPT FOR INJ. SITE IN 
"PKG",197,22,1,"PAH",1,1,10,0)
BCMA field (#8) from the MEDICATION ROUTE file (#51.2) will now be sent in
"PKG",197,22,1,"PAH",1,1,11,0)
the API. HD0000000166204, HD0000000164890, PSI-06-152, PSI-06-158
"PKG",197,22,1,"PAH",1,1,12,0)
 
"PKG",197,22,1,"PAH",1,1,13,0)
2. In support of the BCMA V. 3.0 project BCMA HSC-III, two changes are 
"PKG",197,22,1,"PAH",1,1,14,0)
required to the APIs that supply information to BCMA. First, the flag 
"PKG",197,22,1,"PAH",1,1,15,0)
information for both Unit Dose and IV orders has been added to both the 
"PKG",197,22,1,"PAH",1,1,16,0)
summary and detail APIs. Second, an indicator has been added that will 
"PKG",197,22,1,"PAH",1,1,17,0)
tell BCMA that this order would have triggered a notification to the 
"PKG",197,22,1,"PAH",1,1,18,0)
STAT/NOW mail group.
"PKG",197,22,1,"PAH",1,1,19,0)
 
"PKG",197,22,1,"PAH",1,1,20,0)
3. During testing of the BCMA V. 3.0 project BCMA HSC-III, a problem was 
"PKG",197,22,1,"PAH",1,1,21,0)
discovered with the API that determines if an order should trigger a 
"PKG",197,22,1,"PAH",1,1,22,0)
notification to the STAT/NOW mail group. If the parameter which controls 
"PKG",197,22,1,"PAH",1,1,23,0)
the trigger was not defined, all orders would be flagged. This patch 
"PKG",197,22,1,"PAH",1,1,24,0)
corrects this problem. However, it is important to note that if the 
"PKG",197,22,1,"PAH",1,1,25,0)
parameter PRIORITIES FOR ACTIVE NOTIFY is not defined, no order will be 
"PKG",197,22,1,"PAH",1,1,26,0)
flagged as stat for the purposes of BCMA.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSJBCMA")
0^1^B70029264^B63223587
"RTN","PSJBCMA",1,0)
PSJBCMA ;BIR/MV-RETURN INPATIENT ACTIVE MEDS (CONDENSED) ;16 Mar 99 / 10:13 AM
"RTN","PSJBCMA",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,69,58,81,91,104,111,112,186,159**;16 DEC 97;Build 15
"RTN","PSJBCMA",3,0)
 ;
"RTN","PSJBCMA",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA",5,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSJBCMA",6,0)
 ; Reference to ^PS(51.1 is supported by DIBA 2177.
"RTN","PSJBCMA",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA",8,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA",9,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA",10,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA",11,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA",12,0)
 ; Usage of this routine by BCMA is supported by DBIA 2828.
"RTN","PSJBCMA",13,0)
 ;
"RTN","PSJBCMA",14,0)
EN(DFN,BDT,OTDATE)         ; return condensed list of inpat meds
"RTN","PSJBCMA",15,0)
 NEW CNT,DN,F,FON,ON,PST,WBDT,X,X1,X2,Y,%
"RTN","PSJBCMA",16,0)
 D:+$G(DFN) ORDER
"RTN","PSJBCMA",17,0)
 I '$D(^TMP("PSJ",$J,1,0)) S ^(0)=-1
"RTN","PSJBCMA",18,0)
 K PSJINX
"RTN","PSJBCMA",19,0)
 Q
"RTN","PSJBCMA",20,0)
ORDER ;Loop thru orders.
"RTN","PSJBCMA",21,0)
 I '+$G(BDT) D NOW^%DTC S BDT=%
"RTN","PSJBCMA",22,0)
 I BDT'["." S BDT=BDT_".0001"
"RTN","PSJBCMA",23,0)
 S PSJINX=0
"RTN","PSJBCMA",24,0)
 ;U/D orders
"RTN","PSJBCMA",25,0)
 S F="^PS(55,DFN,5,",WBDT=BDT
"RTN","PSJBCMA",26,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",27,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S FON=ON_"U",PSJON(FON)="" D UDVAR
"RTN","PSJBCMA",28,0)
 ;IV orders
"RTN","PSJBCMA",29,0)
 S F="^PS(55,DFN,""IV"",",WBDT=BDT
"RTN","PSJBCMA",30,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",31,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S FON=ON_"V",PSJON(FON)="" D IVVAR
"RTN","PSJBCMA",32,0)
 ;Pending orders
"RTN","PSJBCMA",33,0)
 S F="^PS(53.1,"
"RTN","PSJBCMA",34,0)
 F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  D
"RTN","PSJBCMA",35,0)
 . S FON=ON_"P"
"RTN","PSJBCMA",36,0)
 . S X=$P($G(^PS(53.1,+ON,0)),U,4) D @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA",37,0)
 ;When a one-time order is found, check against PSJON(FON) array to
"RTN","PSJBCMA",38,0)
 ;make sure no duplicate orders is return on ^TMP.
"RTN","PSJBCMA",39,0)
 I '+$G(OTDATE) D NOW^%DTC S X1=$E(%,1,12),X2=-30 D C^%DTC S OTDATE=X
"RTN","PSJBCMA",40,0)
 I OTDATE'["." S OTDATE=OTDATE_".0001"
"RTN","PSJBCMA",41,0)
 Q:BDT'>OTDATE
"RTN","PSJBCMA",42,0)
 S F="^PS(55,DFN,5,",WBDT=OTDATE
"RTN","PSJBCMA",43,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AU","O",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",44,0)
 .  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AU","O",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",45,0)
 .. S FON=ON_"U" D:'$D(PSJON(FON)) UDVAR
"RTN","PSJBCMA",46,0)
 S F="^PS(55,DFN,""IV"",",WBDT=OTDATE
"RTN","PSJBCMA",47,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",48,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",49,0)
 .. S X=$P($G(^PS(55,DFN,"IV",ON,0)),U,9)
"RTN","PSJBCMA",50,0)
 .. I X]"",$$ONE(DFN,ON_"V",X,$P(X,"^",2),$P(X,"^",3))="O" D
"RTN","PSJBCMA",51,0)
 ... S FON=ON_"V" D:'$D(PSJON(FON)) IVVAR
"RTN","PSJBCMA",52,0)
 K PSJON
"RTN","PSJBCMA",53,0)
 Q
"RTN","PSJBCMA",54,0)
 ;
"RTN","PSJBCMA",55,0)
UDVAR ;Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA",56,0)
 D UDPEND Q:'$$CLINICS($G(CLINIC)) 
"RTN","PSJBCMA",57,0)
 D TMP
"RTN","PSJBCMA",58,0)
 ;Setup Dispense drug for ^TMP
"RTN","PSJBCMA",59,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA",60,0)
 F X=0:0 S X=$O(@(F_ON_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA",61,0)
 . S PSJDD=@(F_ON_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA",62,0)
 . S CNT=CNT+1
"RTN","PSJBCMA",63,0)
 . S ^TMP("PSJ",$J,PSJINX,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((FON["U")&($P(PSJDD,U,2)=""):1,(FON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA",64,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,700,0)=CNT
"RTN","PSJBCMA",65,0)
 K PSJ,PSJDD
"RTN","PSJBCMA",66,0)
 Q
"RTN","PSJBCMA",67,0)
IVVAR ;Set variables for IV and pending orders
"RTN","PSJBCMA",68,0)
 NEW ND,X,Y
"RTN","PSJBCMA",69,0)
 I FON["P" D UDPEND Q:'$$CLINICS(CLINIC)  S PSJ("INFRATE")=$P($G(^PS(53.1,ON,8)),U,5)
"RTN","PSJBCMA",70,0)
 I FON["V" D  Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",71,0)
 . S X=$G(^PS(55,DFN,"IV",ON,0)),CLINIC=$G(^("DSS")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",72,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA",73,0)
 . S PSJ("INFRATE")=$P(X,U,8),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA",74,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA",75,0)
 . S PSJ("IVTYPE")=$P(X,U,4),PSJ("INSYR")=$P(X,U,5)
"RTN","PSJBCMA",76,0)
 . S PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA",77,0)
 . S X=$G(^PS(55,DFN,"IV",ON,.2))
"RTN","PSJBCMA",78,0)
 . S PSJ("DO")="",PSJ("MR")=$P(X,U,3),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA",79,0)
 . I PSJ("FLG") D
"RTN","PSJBCMA",80,0)
 .. N S1,A,B,C
"RTN","PSJBCMA",81,0)
 .. S S1="" F  S S1=$O(^PS(55,DFN,"IV",ON,"A",S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,2),B=$P(C,U,4) Q:A="UG"  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA",82,0)
 ... Q:A'="G"
"RTN","PSJBCMA",83,0)
 ... S PSJ("SRC")=$S(B["FLAGGED BY PHARM":"PHARMACIST",B["FLAGGED BY CPRS":"CPRS",1:"")
"RTN","PSJBCMA",84,0)
 ... S PSJ("COM")=$P(B," ",4,99)
"RTN","PSJBCMA",85,0)
 . S PSJ("OI")=+X
"RTN","PSJBCMA",86,0)
 . S X=$G(^PS(55,DFN,"IV",ON,2))
"RTN","PSJBCMA",87,0)
 . S PSJ("PREV")=$P(X,U,5) I PSJ("PREV")["V",(+PSJ("PREV")=+ON) S PSJ("PREV")=""
"RTN","PSJBCMA",88,0)
 . S PSJ("FOLLOW")=$P(X,U,6),PSJ("RFO")=$P(X,U,9) I PSJ("FOLLOW")["V",(+PSJ("FOLLOW")=+ON) S (PSJ("FOLLOW"),PSJ("RFO"))=""
"RTN","PSJBCMA",89,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA",90,0)
 . N SCHD S SCHD=PSJ("SCHD")
"RTN","PSJBCMA",91,0)
 . S PSJ("STC")=$$ONE(DFN,ON_"V",SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA",92,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA",93,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S(SCHD["ON CALL":"OC",SCHD["ON-CALL":"OC",SCHD["ONCALL":"OC",1:"C")
"RTN","PSJBCMA",94,0)
 D TMP
"RTN","PSJBCMA",95,0)
 S CNT=0
"RTN","PSJBCMA",96,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA",97,0)
 . S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0))
"RTN","PSJBCMA",98,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3)
"RTN","PSJBCMA",99,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,850,0)=CNT,CNT=0
"RTN","PSJBCMA",100,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA",101,0)
 . S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0))
"RTN","PSJBCMA",102,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4)
"RTN","PSJBCMA",103,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,950,0)=CNT
"RTN","PSJBCMA",104,0)
 K PSJ
"RTN","PSJBCMA",105,0)
 S X1=0
"RTN","PSJBCMA",106,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA",107,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:ON'=$P(XX,"^",2)  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA",108,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  S X=^(X2,0),^TMP("PSJ",$J,PSJINX,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",109,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,800,PSJBCID,0)=I-1
"RTN","PSJBCMA",110,0)
 . S X2=0
"RTN","PSJBCMA",111,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  S X=^(X2,0),^TMP("PSJ",$J,PSJINX,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",112,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,900,PSJBCID,0)=I-1
"RTN","PSJBCMA",113,0)
 Q
"RTN","PSJBCMA",114,0)
UDPEND ;
"RTN","PSJBCMA",115,0)
 S X=$G(@(F_ON_",0)")) I $P(F,",")[53.1 S CLINIC=$G(@(F_ON_",""DSS"")")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",116,0)
 I $P(F,",")[55 S CLINIC=$G(@(F_ON_",8)")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",117,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA",118,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA",119,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26),PSJ("RFO")=$P(X,U,27)
"RTN","PSJBCMA",120,0)
 S:FON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA",121,0)
 S X=$G(@(F_ON_",.2)"))
"RTN","PSJBCMA",122,0)
 S PSJ("DO")=$P(X,U,2),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA",123,0)
 I PSJ("FLG") D
"RTN","PSJBCMA",124,0)
 . N S1,A,B,C
"RTN","PSJBCMA",125,0)
 . S S1="" F  S S1=$O(^PS(55,DFN,5,ON,9,S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,3),B=$P(C,U,4) Q:A=7010!(A=7030)  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA",126,0)
 .. Q:A'=7000&(A'=7020)
"RTN","PSJBCMA",127,0)
 .. S PSJ("SRC")=$S(A=7000:"PHARMACIST",A=7020:"CPRS",1:"")
"RTN","PSJBCMA",128,0)
 .. S PSJ("COM")=$P(B,"COMMENTS: ",2,99)
"RTN","PSJBCMA",129,0)
 S PSJ("OI")=+X
"RTN","PSJBCMA",130,0)
 S X=$G(@(F_ON_",2)"))
"RTN","PSJBCMA",131,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA",132,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA",133,0)
 S X=$G(@(F_ON_",4)"))
"RTN","PSJBCMA",134,0)
 S PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA",135,0)
 ;naked reference on line below refers to  full reference created by indirect reference to F_ON, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA",136,0)
 S PSJ("SIOPI")=$S($P($G(@(F_ON_",6)")),"^",2)&($P($G(@(F_ON_",6)")),"^")'=""):"!",1:"")_$$ENSET($P($G(^(6)),"^"))
"RTN","PSJBCMA",137,0)
 D SIOPI
"RTN","PSJBCMA",138,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA",139,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P","^ONCALL^ON-CALL^ON CALL^"[("^"_PSJ("SCHD")_"^"):"OC",$$ONE(DFN,FON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA",140,0)
 Q 
"RTN","PSJBCMA",141,0)
TMP ;Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA",142,0)
 N A
"RTN","PSJBCMA",143,0)
 S PSJINX=PSJINX+1
"RTN","PSJBCMA",144,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA",145,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA",146,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA",147,0)
 S A=$G(^PS(51.2,+PSJ("MR"),0)),PSJ("MRABB")=$P(A,U,3),PSJ("MRNM")=$P(A,U)
"RTN","PSJBCMA",148,0)
 S ^TMP("PSJ",$J,PSJINX,0)=DFN_U_+ON_U_FON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")_U_$G(PSJ("RFO"))
"RTN","PSJBCMA",149,0)
 S ^TMP("PSJ",$J,PSJINX,1)=PSJ("MRABB")_U_PSJ("STC")_U_$G(PSJ("SCHD"))_U_PSJ("STARTDT")_U_PSJ("STOPDT")_U_PSJ("ADM")_U_PSJ("STATUS")_U_$G(PSJ("NGIVEN"))_U_$G(PSJ("ST"))_U_$G(PSJ("AUTO"))
"RTN","PSJBCMA",150,0)
 S ^TMP("PSJ",$J,PSJINX,1,0)=$P(A,U,8)_U_PSJ("MRNM")_U_$P(A,U,9)
"RTN","PSJBCMA",151,0)
 S ^TMP("PSJ",$J,PSJINX,2)=PSJ("DO")_U_$G(PSJ("INFRATE"))_U_$G(PSJ("SM"))_U_$G(PSJ("HSM"))
"RTN","PSJBCMA",152,0)
 S ^TMP("PSJ",$J,PSJINX,3)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("OIDF")
"RTN","PSJBCMA",153,0)
 S ^TMP("PSJ",$J,PSJINX,4)=PSJ("SIOPI")
"RTN","PSJBCMA",154,0)
 S A=$$SNDTSTA^PSJHL4A(PSJ("PRI"),PSJ("SCHD"))
"RTN","PSJBCMA",155,0)
 S ^TMP("PSJ",$J,PSJINX,5)=$S(A=1:0,1:1)_U_PSJ("FLG")_U_PSJ("SRC")_U_PSJ("COM")
"RTN","PSJBCMA",156,0)
 Q
"RTN","PSJBCMA",157,0)
SIOPI ; Use provider comments if order is pending and there is no SI
"RTN","PSJBCMA",158,0)
 NEW X,Y,Z
"RTN","PSJBCMA",159,0)
 I FON["P",(PSJ("SIOPI")=""),$O(^PS(53.1,+ON,12,0)) D
"RTN","PSJBCMA",160,0)
 . F X=0:0 S X=$O(^PS(53.1,+ON,12,X)) Q:'X  S Z=$G(^(X,0)) D
"RTN","PSJBCMA",161,0)
 .. S Y=$L(PSJ("SIOPI"))
"RTN","PSJBCMA",162,0)
 .. S:Y+$L(Z)'>179 PSJ("SIOPI")=PSJ("SIOPI")_Z_""
"RTN","PSJBCMA",163,0)
 . I Y+$L(Z)>179 S PSJ("SIOPI")="SEE PROVIDER COMMENTS"
"RTN","PSJBCMA",164,0)
 Q
"RTN","PSJBCMA",165,0)
ENSET(X) ; expands SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSJBCMA",166,0)
 N X1,X2,Y S Y=""
"RTN","PSJBCMA",167,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) I X2]"" S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSJBCMA",168,0)
 S Y=$E(Y,1,$L(Y)-1)
"RTN","PSJBCMA",169,0)
 Q Y
"RTN","PSJBCMA",170,0)
ONE(DFN,ORD,SCH,START,STOP) ;determine if order is a one-time
"RTN","PSJBCMA",171,0)
 ; Input:  DFN - patient's internal entry number
"RTN","PSJBCMA",172,0)
 ;         ORD - order number to check (must contain U or V)
"RTN","PSJBCMA",173,0)
 ;         SCH - schedule text (required)
"RTN","PSJBCMA",174,0)
 ;         START - order start date (optional)
"RTN","PSJBCMA",175,0)
 ;         STOP - order stop date (optional)
"RTN","PSJBCMA",176,0)
 N X
"RTN","PSJBCMA",177,0)
 I $G(PSJ("PREV")),$G(PSJ("FOLLOW")) I +PSJ("PREV")=+PSJ("FOLLOW") S (PSJ("PREV"),PSJ("FOLLOW"))=""
"RTN","PSJBCMA",178,0)
 I $G(DFN)]"",$G(ORD)]"",ORD["U",$P(^PS(55,DFN,5,+ORD,0),"^",7)'="R" Q $P(^PS(55,DFN,5,+ORD,0),"^",7)
"RTN","PSJBCMA",179,0)
 I $G(SCH)="" Q ""
"RTN","PSJBCMA",180,0)
 I SCH="TODAY"!(SCH="ONCE")!(SCH="NOW")!(SCH="ONE TIME")!(SCH="ONETIME")!(SCH="ONE-TIME")!(SCH="1TIME")!(SCH="1 TIME")!(SCH="1-TIME")!(SCH="STAT") Q "O"
"RTN","PSJBCMA",181,0)
 I $D(^PS(51.1,"AC","PSJ",SCH)) S X=$O(^(SCH,"")) S X=$P(^PS(51.1,X,0),"^",5) Q $S(X="D":"C",1:X)
"RTN","PSJBCMA",182,0)
 I $G(START)]"",$G(STOP)]"",START=STOP Q "O"
"RTN","PSJBCMA",183,0)
 Q ""
"RTN","PSJBCMA",184,0)
CLINIC(CL) ;
"RTN","PSJBCMA",185,0)
 I $P(CL,"^",2)?7N!($P(CL,"^",2)?7N1".".N) Q 1
"RTN","PSJBCMA",186,0)
 Q 0
"RTN","PSJBCMA",187,0)
CLINICS(CL) ;
"RTN","PSJBCMA",188,0)
 Q:'$$CLINIC(CL) 1
"RTN","PSJBCMA",189,0)
 Q:'$D(^PS(53.46,"B",+CL)) 1
"RTN","PSJBCMA",190,0)
 N A
"RTN","PSJBCMA",191,0)
 S A=$O(^PS(53.46,"B",+CL,"")) Q:'A 1
"RTN","PSJBCMA",192,0)
 Q $P(^PS(53.46,A,0),"^",4)
"RTN","PSJBCMA1")
0^2^B70574949^B59316594
"RTN","PSJBCMA1",1,0)
PSJBCMA1 ;BIR/MV-RETURN INFORMATION FOR AN ORDER ;16 Mar 99 / 10:59 AM
"RTN","PSJBCMA1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,58,81,91,104,186,159**;16 DEC 97;Build 15
"RTN","PSJBCMA1",3,0)
 ;
"RTN","PSJBCMA1",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA1",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA1",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA1",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA1",8,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA1",9,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA1",10,0)
 ; Reference to ^DIC is supported by DBIA 10006.
"RTN","PSJBCMA1",11,0)
 ; Reference to ^DIQ is supported by DBIA 2056.
"RTN","PSJBCMA1",12,0)
 ; Usage of this routine by BCMA is supported by DBIA 2829.
"RTN","PSJBCMA1",13,0)
 ;
"RTN","PSJBCMA1",14,0)
EN(DFN,ON,PSJTMP)         ; return detail data for Inpatient Meds.
"RTN","PSJBCMA1",15,0)
 NEW F,A
"RTN","PSJBCMA1",16,0)
 S PSJTMP=$S($G(PSJTMP)=1:"PSJ1",1:"PSJ")
"RTN","PSJBCMA1",17,0)
 I $G(ON)["U" S F="^PS(55,+$G(DFN),5,+ON" D:$D(@(F_")")) UDVAR
"RTN","PSJBCMA1",18,0)
 I $G(ON)["V" S F="^PS(55,+$G(DFN),""IV"",+ON" D:$D(@(F_")")) IVVAR
"RTN","PSJBCMA1",19,0)
 I $G(ON)["P" S F="^PS(53.1,+ON",X=$P($G(^PS(53.1,+ON,0)),U,4) D:$D(@(F_")")) @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA1",20,0)
 I '$D(^TMP(PSJTMP,$J,0)) S ^(0)=-1
"RTN","PSJBCMA1",21,0)
 Q
"RTN","PSJBCMA1",22,0)
 ;
"RTN","PSJBCMA1",23,0)
UDVAR ;* Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA1",24,0)
 NEW CNT,X
"RTN","PSJBCMA1",25,0)
 D UDPEND
"RTN","PSJBCMA1",26,0)
 D TMP
"RTN","PSJBCMA1",27,0)
 ;* Setup Dispense drug for ^TMP
"RTN","PSJBCMA1",28,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA1",29,0)
 F X=0:0 S X=$O(@(F_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA1",30,0)
 . S PSJDD=@(F_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA1",31,0)
 . S CNT=CNT+1
"RTN","PSJBCMA1",32,0)
 . S ^TMP(PSJTMP,$J,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((ON["U")&($P(PSJDD,U,2)=""):1,(ON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA1",33,0)
 S:CNT ^TMP(PSJTMP,$J,700,0)=CNT
"RTN","PSJBCMA1",34,0)
 K PSJ,PSJDD,PSJDN
"RTN","PSJBCMA1",35,0)
 Q
"RTN","PSJBCMA1",36,0)
IVVAR ;* Set variables for IV and pending orders
"RTN","PSJBCMA1",37,0)
 NEW CNT,DN,ND,X,Y
"RTN","PSJBCMA1",38,0)
 I ON["P" D UDPEND S PSJ("INFRATE")=$P($G(^PS(53.1,ON,8)),U,5)
"RTN","PSJBCMA1",39,0)
 I ON["V" D
"RTN","PSJBCMA1",40,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,0))
"RTN","PSJBCMA1",41,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA1",42,0)
 . S PSJ("PROVIDER")=$P(X,U,6)
"RTN","PSJBCMA1",43,0)
 . S PSJ("INFRATE")=$P(X,U,8),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA1",44,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA1",45,0)
 . S PSJ("FREQ")=$P(X,U,15),PSJ("IVTYPE")=$P(X,U,4)
"RTN","PSJBCMA1",46,0)
 . S PSJ("INSYR")=$P(X,U,5),PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA1",47,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,.2))
"RTN","PSJBCMA1",48,0)
 . S PSJ("OI")=$P(X,U),PSJ("DO")="",PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA1",49,0)
 . I PSJ("FLG") D
"RTN","PSJBCMA1",50,0)
 .. N S1,A,B,C
"RTN","PSJBCMA1",51,0)
 .. S S1="" F  S S1=$O(^PS(55,DFN,"IV",+ON,"A",S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,2),B=$P(C,U,4) Q:A="UG"  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA1",52,0)
 ... Q:A'="G"
"RTN","PSJBCMA1",53,0)
 ... S PSJ("SRC")=$S(B["FLAGGED BY PHARM":"PHARMACIST",B["FLAGGED BY CPRS":"CPRS",1:"")
"RTN","PSJBCMA1",54,0)
 ... S PSJ("COM")=$P(B," ",4,99)
"RTN","PSJBCMA1",55,0)
 . S PSJ("MR")=$P(X,U,3)
"RTN","PSJBCMA1",56,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,4))
"RTN","PSJBCMA1",57,0)
 . S PSJ("NURSE")=$P(X,U)
"RTN","PSJBCMA1",58,0)
 . S PSJ("PHARM")=$P(X,U,4)
"RTN","PSJBCMA1",59,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,2))
"RTN","PSJBCMA1",60,0)
 . S PSJ("LDT")=$P(X,U)
"RTN","PSJBCMA1",61,0)
 . S PSJ("PREV")=$P(X,U,5),PSJ("FOLLOW")=$P(X,U,6)
"RTN","PSJBCMA1",62,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA1",63,0)
 . N SCHD S SCHD=PSJ("SCHD")  ; SCHD var required to shorten $Select
"RTN","PSJBCMA1",64,0)
 . S PSJ("STC")=$$ONE^PSJBCMA(DFN,ON,SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA1",65,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA1",66,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S(SCHD["ON CALL":"OC",SCHD["ON-CALL":"OC",SCHD["ONCALL":"OC",1:"C")
"RTN","PSJBCMA1",67,0)
 . S PSJ("NURSE")=$P($G(^PS(55,DFN,"IV",+ON,4)),U)
"RTN","PSJBCMA1",68,0)
 D TMP
"RTN","PSJBCMA1",69,0)
 S X=$P($G(^PS(55,DFN,"IV",+ON,1)),U) S:X]"" ^TMP(PSJTMP,$J,6)=X
"RTN","PSJBCMA1",70,0)
 S CNT=0
"RTN","PSJBCMA1",71,0)
 F X=0:0 S X=$O(@(F_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA1",72,0)
 . S ND=$G(@(F_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0)) ;,AOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I AOINAME["NOTFOUND" S AOINAME=""
"RTN","PSJBCMA1",73,0)
 . ;S AOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I AOINAME="" S AOIDF=""
"RTN","PSJBCMA1",74,0)
 . S CNT=CNT+1,^TMP(PSJTMP,$J,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3) ;_U_U_$P(DN,U,11)_U_AOINAME_U_AOIDF
"RTN","PSJBCMA1",75,0)
 S:CNT ^TMP(PSJTMP,$J,850,0)=CNT,CNT=0
"RTN","PSJBCMA1",76,0)
 F X=0:0 S X=$O(@(F_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA1",77,0)
 . S ND=$G(@(F_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)) ;,SOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I SOINAME["NOTFOUND" S SOINAME=""
"RTN","PSJBCMA1",78,0)
 . ;S SOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I SOINAME="" S SOIDF=""
"RTN","PSJBCMA1",79,0)
 . S CNT=CNT+1,^TMP(PSJTMP,$J,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4) ;_U_U_$P(DN,U,11)_U_SOINAME_U_SOIDF
"RTN","PSJBCMA1",80,0)
 S:CNT ^TMP(PSJTMP,$J,950,0)=CNT
"RTN","PSJBCMA1",81,0)
 K PSJ
"RTN","PSJBCMA1",82,0)
 S X1=0
"RTN","PSJBCMA1",83,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA1",84,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:$P(XX,"^",2)'=+ON  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA1",85,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  S X=^(X2,0),^TMP(PSJTMP,$J,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA1",86,0)
 . I I>1 S ^TMP(PSJTMP,$J,800,PSJBCID,0)=I-1
"RTN","PSJBCMA1",87,0)
 . S X2=0
"RTN","PSJBCMA1",88,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  S X=^(X2,0),^TMP(PSJTMP,$J,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA1",89,0)
 . I I>1 S ^TMP(PSJTMP,$J,900,PSJBCID,0)=I-1
"RTN","PSJBCMA1",90,0)
 . S ^TMP(PSJTMP,$J,1000,PSJBCID)=$P(XX,"^",6)_"^"_$P(XX,"^",8)_"^"_$P(XX,"^",7)
"RTN","PSJBCMA1",91,0)
 Q
"RTN","PSJBCMA1",92,0)
UDPEND ;
"RTN","PSJBCMA1",93,0)
 S X=$G(@(F_",0)"))
"RTN","PSJBCMA1",94,0)
 S PSJ("PROVIDER")=$P(X,U,2)
"RTN","PSJBCMA1",95,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA1",96,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA1",97,0)
 S PSJ("LDT")=$P(X,U,16)
"RTN","PSJBCMA1",98,0)
 S:ON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA1",99,0)
 S PSJ("SMYN")=$S(+PSJ("SM"):"YES",1:"NO")
"RTN","PSJBCMA1",100,0)
 S PSJ("HSMYN")=$S(+PSJ("HSM"):"YES",1:"NO")
"RTN","PSJBCMA1",101,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26)
"RTN","PSJBCMA1",102,0)
 S X=$G(@(F_",.2)"))
"RTN","PSJBCMA1",103,0)
 S PSJ("OI")=$P(X,U),PSJ("DO")=$P(X,U,2),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA1",104,0)
 I PSJ("FLG") D
"RTN","PSJBCMA1",105,0)
 . N S1,A,B,C
"RTN","PSJBCMA1",106,0)
 . S S1="" F  S S1=$O(^PS(55,DFN,5,+ON,9,S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,3),B=$P(C,U,4) Q:A=7010!(A=7030)  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA1",107,0)
 .. Q:A'=7000&(A'=7020)
"RTN","PSJBCMA1",108,0)
 .. S PSJ("SRC")=$S(A=7000:"PHARMACIST",A=7020:"CPRS",1:"")
"RTN","PSJBCMA1",109,0)
 .. S PSJ("COM")=$P(B,"COMMENTS: ",2,99)
"RTN","PSJBCMA1",110,0)
 S X=$G(@(F_",2)"))
"RTN","PSJBCMA1",111,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA1",112,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA1",113,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P","^ONCALL^ON-CALL^ON CALL^"[("^"_PSJ("SCHD")_"^"):"OC",$$ONE^PSJBCMA(DFN,ON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA1",114,0)
 I PSJ("STC")="O" S PSJ("ST")="O"
"RTN","PSJBCMA1",115,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA1",116,0)
 S PSJ("FREQ")=$P(X,U,6)
"RTN","PSJBCMA1",117,0)
 S X=$G(@(F_",4)"))
"RTN","PSJBCMA1",118,0)
 S PSJ("NURSE")=$P(X,U),PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA1",119,0)
 S:ON["U" PSJ("PHARM")=+$P(X,U,3)
"RTN","PSJBCMA1",120,0)
 ; the naked reference on the line below refers to the full reference created by indirect reference to F, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA1",121,0)
 S PSJ("SIOPI")=$S($P($G(@(F_",6)")),"^",2)&($P($G(@(F_",6)")),"^")'=""):"!",1:"")_$$ENSET^PSJBCMA($P($G(^(6)),"^"))
"RTN","PSJBCMA1",122,0)
 NEW FON S FON=ON D SIOPI^PSJBCMA
"RTN","PSJBCMA1",123,0)
 Q 
"RTN","PSJBCMA1",124,0)
 ;
"RTN","PSJBCMA1",125,0)
TMP ;* Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA1",126,0)
 D NAME(PSJ("PROVIDER"),.PSJNAME,"","")
"RTN","PSJBCMA1",127,0)
 S PSJ("PRONAME")=PSJNAME K PSJNAME
"RTN","PSJBCMA1",128,0)
 I $D(PSJ("PHARM")) D
"RTN","PSJBCMA1",129,0)
 . D NAME(PSJ("PHARM"),.PSJNAME,.PSJINIT,.PSJPIEN)
"RTN","PSJBCMA1",130,0)
 . S PSJ("PHARM")=PSJPIEN,PSJ("PNAME")=PSJNAME,PSJ("PINIT")=PSJINIT K PSJNAME,PSJINIT,PSJPIEN
"RTN","PSJBCMA1",131,0)
 I +PSJ("NURSE") D
"RTN","PSJBCMA1",132,0)
 . D NAME(PSJ("NURSE"),.PSJNAME,.PSJINIT,"")
"RTN","PSJBCMA1",133,0)
 . S PSJ("NNAME")=PSJNAME,PSJ("NINIT")=PSJINIT K PSJNAME,PSJINIT
"RTN","PSJBCMA1",134,0)
 S A=$G(^PS(51.2,+PSJ("MR"),0)),PSJ("MRNM")=$P(A,U),PSJ("MRABB")=$P(A,U,3),PSJ("MRPIJ")=$P(A,U,8),PSJ("MRIVP")=$P(A,U,9)
"RTN","PSJBCMA1",135,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA1",136,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA1",137,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA1",138,0)
 S PSJ("LDTN")=$$DATE(PSJ("LDT"))
"RTN","PSJBCMA1",139,0)
 S PSJ("STARTDTN")=$$DATE(PSJ("STARTDT"))
"RTN","PSJBCMA1",140,0)
 S PSJ("STOPDTN")=$$DATE(PSJ("STOPDT"))
"RTN","PSJBCMA1",141,0)
 S X=$S(ON["V":PSJ("STC"),1:PSJ("ST"))
"RTN","PSJBCMA1",142,0)
 S PSJ("STNAME")=$S(X="C":"CONTINUOUS",X="O":"ONE TIME",X="P":"PRN",X="R":"FILL ON REQUEST",X="OC":"ON CALL",1:"NOT FOUND")
"RTN","PSJBCMA1",143,0)
 ;
"RTN","PSJBCMA1",144,0)
 S ^TMP(PSJTMP,$J,0)=DFN_U_+ON_U_ON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")
"RTN","PSJBCMA1",145,0)
 S ^TMP(PSJTMP,$J,1)=PSJ("PROVIDER")_U_PSJ("PRONAME")_U_PSJ("MR")_U_PSJ("MRABB")_U_$G(PSJ("SM"))_U_$G(PSJ("SMYN"))_U_$G(PSJ("HSM"))_U_$G(PSJ("HSMYN"))_U_$G(PSJ("NGIVEN"))_U_PSJ("STATUS")
"RTN","PSJBCMA1",146,0)
 S ^TMP(PSJTMP,$J,1)=^TMP(PSJTMP,$J,1)_U_$$STATUS(ON,PSJ("STATUS"))_U_$G(PSJ("AUTO"))_U_$G(PSJ("MRNM"))
"RTN","PSJBCMA1",147,0)
 S ^TMP(PSJTMP,$J,1,0)=PSJ("MRPIJ")_U_$G(PSJ("MRIVP"))
"RTN","PSJBCMA1",148,0)
 S ^TMP(PSJTMP,$J,2)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("DO")_U_$G(PSJ("INFRATE"))_U_$G(PSJ("SCHD"))_U_PSJ("OIDF")
"RTN","PSJBCMA1",149,0)
 S ^TMP(PSJTMP,$J,3)=PSJ("SIOPI")
"RTN","PSJBCMA1",150,0)
 S ^TMP(PSJTMP,$J,4)=PSJ("STC")_U_$G(PSJ("STNAME"))_U_PSJ("LDT")_U_PSJ("LDTN")_U_PSJ("STARTDT")_U_PSJ("STARTDTN")_U_PSJ("STOPDT")_U_PSJ("STOPDTN")_U_$$ADMIN(PSJ("ADM"))_U_$G(PSJ("ST"))_U_$G(PSJ("FREQ"))
"RTN","PSJBCMA1",151,0)
 S ^TMP(PSJTMP,$J,5)=$G(PSJ("NURSE"))_U_$G(PSJ("NNAME"))_U_$G(PSJ("NINIT"))_U_$G(PSJ("PHARM"))_U_$G(PSJ("PNAME"))_U_$G(PSJ("PINIT"))
"RTN","PSJBCMA1",152,0)
 S A=$$SNDTSTA^PSJHL4A(PSJ("PRI"),PSJ("SCHD"))
"RTN","PSJBCMA1",153,0)
 S ^TMP(PSJTMP,$J,7)=$S(A=1:0,1:1)_U_PSJ("FLG")_U_PSJ("SRC")_U_PSJ("COM")
"RTN","PSJBCMA1",154,0)
 Q
"RTN","PSJBCMA1",155,0)
 ;
"RTN","PSJBCMA1",156,0)
NAME(X,NAME,INIT,IEN)  ;Lookup in ^VA(200.
"RTN","PSJBCMA1",157,0)
 ;X = IEN or Name in ^VA(200
"RTN","PSJBCMA1",158,0)
 ;IEN = Return IEN in ^VA(200
"RTN","PSJBCMA1",159,0)
 ;NAME = Return the name in 200
"RTN","PSJBCMA1",160,0)
 ;INIT = Return the initial
"RTN","PSJBCMA1",161,0)
 NEW DIC,Y
"RTN","PSJBCMA1",162,0)
 S DIC="^VA(200,",DIC(0)="NZ" D ^DIC
"RTN","PSJBCMA1",163,0)
 S IEN=+Y
"RTN","PSJBCMA1",164,0)
 S NAME=$G(Y(0,0))
"RTN","PSJBCMA1",165,0)
 S INIT=$P($G(Y(0)),U,2)
"RTN","PSJBCMA1",166,0)
 Q
"RTN","PSJBCMA1",167,0)
 ;
"RTN","PSJBCMA1",168,0)
DATE(Y) ; FM internal date/time to user readable, 4 digit year
"RTN","PSJBCMA1",169,0)
 ; Y - date in FileMan internal format
"RTN","PSJBCMA1",170,0)
 I $G(Y) S Y=Y_$E(".",Y'[".")_"0000" Q $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_($E(Y,1,3)+1700)_"  "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSJBCMA1",171,0)
 Q "********"
"RTN","PSJBCMA1",172,0)
 ;
"RTN","PSJBCMA1",173,0)
STATUS(ON,X)          ;
"RTN","PSJBCMA1",174,0)
 ; ON = IEN_"I/U/P"
"RTN","PSJBCMA1",175,0)
 ; X  = STATUS
"RTN","PSJBCMA1",176,0)
 I X="P" Q $S(ON["P":"PENDING",ON["V":"PURGE",1:"NOT FOUND")
"RTN","PSJBCMA1",177,0)
 Q $S(X="A":"ACTIVE",X="D":"DISCONTINUED",X="E":"EXPIRED",X="H":"HOLD",X="R":"RENEWED",X="RE":"REINSTATED",X="N":"NON-VERFIED",X="DE":"DISCONTINUED (EDIT)",X="O":"ON CALL",1:"NOT FOUND")
"RTN","PSJBCMA1",178,0)
 ;
"RTN","PSJBCMA1",179,0)
ADMIN(X) ;
"RTN","PSJBCMA1",180,0)
 NEW Y,PSJADM,PSJX S PSJADM=""
"RTN","PSJBCMA1",181,0)
 I X="" Q ""
"RTN","PSJBCMA1",182,0)
 F Y=1:1:$L(X,"-") S PSJX=$E($P(X,"-",Y)_"0000",1,4) D
"RTN","PSJBCMA1",183,0)
 . S PSJADM=PSJADM_$S(PSJADM]"":"-",1:"")_PSJX
"RTN","PSJBCMA1",184,0)
 Q PSJADM
"RTN","PSJBCMA1",185,0)
 ;
"RTN","PSJHL4A")
0^3^B37280684^B37280433
"RTN","PSJHL4A",1,0)
PSJHL4A ;BIR/RLW-CONTINUE DECODE HL7 /MESSSAGE FROM OE/RR ;16 Mar 99 / 4:55 PM
"RTN","PSJHL4A",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**105,111,154,170,159**;16 DEC 97;Build 15
"RTN","PSJHL4A",3,0)
 ;
"RTN","PSJHL4A",4,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJHL4A",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJHL4A",6,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL4A",7,0)
 ; Reference to ^PS(59.7 supported by DBIA #2181.
"RTN","PSJHL4A",8,0)
 ;
"RTN","PSJHL4A",9,0)
RXC ; IV order
"RTN","PSJHL4A",10,0)
 N IVFL
"RTN","PSJHL4A",11,0)
 S APPL=FIELD(1)
"RTN","PSJHL4A",12,0)
 I APPL["B" S SOLCNT=SOLCNT+1,PTR=$P(FIELD(2),"^",4) Q:'PTR  S VOLUME=+FIELD(3)_" ML" D  I '$D(^TMP("PSJNVO",$J,"SOL",SOLCNT,0)) D SOLSRCH
"RTN","PSJHL4A",13,0)
 .S SOLUTION="" F  S SOLUTION=$O(^PS(52.7,"AOI",PTR,SOLUTION)) Q:'SOLUTION  S INACT=$G(^PS(52.7,SOLUTION,"I")) I 'INACT!(INACT>DT) I VOLUME=$P(^PS(52.7,SOLUTION,0),U,3) D
"RTN","PSJHL4A",14,0)
 ..S ^TMP("PSJNVO",$J,"SOL",0)=SOLCNT
"RTN","PSJHL4A",15,0)
 ..S ^TMP("PSJNVO",$J,"SOL",SOLCNT,0)=SOLUTION_"^"_VOLUME,TVOLUME=TVOLUME+(+VOLUME)
"RTN","PSJHL4A",16,0)
 I $G(INFRT)]"" S X=INFRT D ENI^PSJHLU S INFRT=$G(X)
"RTN","PSJHL4A",17,0)
 I APPL="A" S ADCNT=ADCNT+1,PTR=$P(FIELD(2),"^",4) Q:'PTR  S STRENGTH=$G(FIELD(3))_" "_$P($G(FIELD(4)),"^",5) D  I '$D(^TMP("PSJNVO",$J,"AD",ADCNT,0)) S PSREASON="Can't find matching additive" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",18,0)
 .S ADDITIVE="" F  S ADDITIVE=$O(^PS(52.6,"AOI",PTR,ADDITIVE)) Q:'ADDITIVE  S INACT=$G(^PS(52.6,ADDITIVE,"I")),IVFL=$P($G(^(0)),"^",13) I 'INACT!(INACT>DT),IVFL'=0 Q:$G(^PS(52.6,ADDITIVE,0))']""  D  Q:ADDITIVE
"RTN","PSJHL4A",19,0)
 ..I $G(PSITEM)="" S PSITEM=PTR
"RTN","PSJHL4A",20,0)
 ..S ^TMP("PSJNVO",$J,"AD",0)=ADCNT
"RTN","PSJHL4A",21,0)
 ..S ^TMP("PSJNVO",$J,"AD",ADCNT,0)=ADDITIVE_"^"_STRENGTH
"RTN","PSJHL4A",22,0)
 Q
"RTN","PSJHL4A",23,0)
 ;
"RTN","PSJHL4A",24,0)
RXO ;
"RTN","PSJHL4A",25,0)
 I $O(PSJMSG(II,0)) D
"RTN","PSJHL4A",26,0)
 .K SEGMENT
"RTN","PSJHL4A",27,0)
 .N KK,JJ,XX
"RTN","PSJHL4A",28,0)
 .S SEGMENT(1)=$G(PSJMSG(II))
"RTN","PSJHL4A",29,0)
 .S KK=1,JJ="" F  S JJ=$O(PSJMSG(II,JJ)) Q:'JJ  S KK=KK+1,SEGMENT(KK)=$G(PSJMSG(II,JJ))
"RTN","PSJHL4A",30,0)
 .S KK=1,JJ=0
"RTN","PSJHL4A",31,0)
 .F  Q:'$D(SEGMENT(KK))  D
"RTN","PSJHL4A",32,0)
 ..I SEGMENT(KK)["|" S FIELD(JJ)=$P(SEGMENT(KK),"|"),SEGMENT(KK)=$E(SEGMENT(KK),$L(FIELD(JJ))+2,$L(SEGMENT(KK))),JJ=JJ+1 Q
"RTN","PSJHL4A",33,0)
 ..I SEGMENT(KK)'["|" S FIELD(JJ)=SEGMENT(KK),KK=KK+1 Q:'$D(SEGMENT(KK))  D
"RTN","PSJHL4A",34,0)
 ...S XX=$P(SEGMENT(KK),"|"),SEGMENT(KK)=$E(SEGMENT(KK),$L(X)+2,$L(SEGMENT(KK))),FIELD(JJ)=FIELD(JJ)_XX,JJ=JJ+1
"RTN","PSJHL4A",35,0)
 S APPL="",PSITEM=$S($P(FIELD(1),"^",5)="IV":"",1:$P(FIELD(1),"^",4))
"RTN","PSJHL4A",36,0)
 S:$P(FIELD(1),"^",6)="ORD" PSITEM=""
"RTN","PSJHL4A",37,0)
 S:$P(FIELD(1),"^",5)="IV" IVTYP="A",SCHTYP="C",INFRT=$G(FIELD(2))
"RTN","PSJHL4A",38,0)
 S DISPENSE=$P($G(FIELD(10)),"^",4)
"RTN","PSJHL4A",39,0)
 S IVLIMIT=$P($G(PSJMSG(II)),"^",3)
"RTN","PSJHL4A",40,0)
 Q
"RTN","PSJHL4A",41,0)
 ;
"RTN","PSJHL4A",42,0)
OBX ;
"RTN","PSJHL4A",43,0)
 S OBXFL=1,OCNARR=FIELD(5),OCPROV=CLERK,OCCNT=OCCNT+1
"RTN","PSJHL4A",44,0)
 S ^TMP("PSJNVO",$J,10,0)=OCCNT
"RTN","PSJHL4A",45,0)
 S ^TMP("PSJNVO",$J,10,OCCNT,0)=OCNARR
"RTN","PSJHL4A",46,0)
 S ^TMP("PSJNVO",$J,10,OCCNT,1)=$P($G(^VA(200,+OCPROV,0)),"^")
"RTN","PSJHL4A",47,0)
 Q
"RTN","PSJHL4A",48,0)
 ;
"RTN","PSJHL4A",49,0)
NTE ;
"RTN","PSJHL4A",50,0)
 S TEXT=$S((FIELD(1)=6)&('OBXFL):"PROCOM",(FIELD(1)=7)&('OBXFL):"ADMINSTR",1:"OCRSN")
"RTN","PSJHL4A",51,0)
 S @TEXT@(1)=$G(FIELD(3))
"RTN","PSJHL4A",52,0)
 S K=1,J="" F  S J=$O(PSJMSG(II,J)) Q:'J  S K=K+1,@TEXT@(K)=$G(PSJMSG(II,J))
"RTN","PSJHL4A",53,0)
 D:$D(OCRSN)
"RTN","PSJHL4A",54,0)
 .S QQ=0 F  S QQ=$O(OCRSN(QQ)) Q:'QQ  S ^TMP("PSJNVO",$J,10,OCCNT,2,QQ,0)=OCRSN(QQ)
"RTN","PSJHL4A",55,0)
 S OBXFL=0
"RTN","PSJHL4A",56,0)
 Q
"RTN","PSJHL4A",57,0)
 ;
"RTN","PSJHL4A",58,0)
ZRX ;
"RTN","PSJHL4A",59,0)
 N ND,ND2,CHK,FOLOR,STDT
"RTN","PSJHL4A",60,0)
 S PREON=$G(FIELD(1)),ROC=$G(FIELD(3))
"RTN","PSJHL4A",61,0)
 S ND=$S((PREON["N")!(PREON["P"):$G(^PS(53.1,+PREON,0)),PREON["V":$G(^PS(55,PSJHLDFN,"IV",+PREON,0)),1:$G(^PS(55,PSJHLDFN,5,+PREON,0)))
"RTN","PSJHL4A",62,0)
 S ND2=$S((PREON["N")!(PREON["P"):$G(^PS(53.1,+PREON,2)),PREON["V":$G(^PS(55,PSJHLDFN,"IV",+PREON,2)),1:$G(^PS(55,PSJHLDFN,5,+PREON,2)))
"RTN","PSJHL4A",63,0)
 I 'ND I ROC'="N" S PSREASON="Invalid Pharmacy order number" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",64,0)
 I ND I ROC="R" S FOLOR=$S(PREON["V":$P(ND2,U,6),1:$P(ND,U,26)) I FOLOR S PSREASON="Duplicate Renewal Request" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",65,0)
 I ND I ROC="R" S CHK=$S(PREON["V":$P(ND,U,17),1:$P(ND,U,9)) I "AE"'[CHK S PSREASON="Pharmacy orders with a status of "_CHK_" may not be renewed" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",66,0)
 I $G(CHK)="E" I PREON'["V" D NOW^%DTC S X1=+$E(%,1,12),X2=-4 D C^%DTC S STDT=$S(PREON["V":$P(ND,U,3),1:$P(ND2,U,4)) I STDT'>X S PSREASON="Pharmacy orders expired longer than 4 days may not be renewed" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",67,0)
 I ND I ROC="E" S FOLOR=$S(PREON["V":$P(ND2,U,6),1:$P(ND,U,26)) I FOLOR S PSREASON="Pharmacy orders may only be edited ONCE" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",68,0)
 I ND I ROC="E" S CHK=$S(PREON["V":$P(ND,U,17),1:$P(ND,U,9)) I "DEHO"[CHK N CHKRTN S CHKRTN=CHK_"^PSJHL6" D @CHKRTN S PSREASON=PSREASON_" orders may not be edited" D ERROR^PSJHL9 Q
"RTN","PSJHL4A",69,0)
 D:ROC'="R" VALID^PSJHL9 Q:QFLG
"RTN","PSJHL4A",70,0)
 I $G(PSITEM)="",$D(^TMP("PSJNVO",$J,"SOL",1,0)) S PSITEM=$P($G(^PS(52.7,+^TMP("PSJNVO",$J,"SOL",1,0),0)),"^",11)
"RTN","PSJHL4A",71,0)
 I PRIORITY="ZD" D VALID^PSJHL10 S QFLG=1 Q
"RTN","PSJHL4A",72,0)
 I (PREON]"")&(ROC="E") D EDITCK^PSJHL5 Q:QFLG
"RTN","PSJHL4A",73,0)
 D NVO^PSJHL9
"RTN","PSJHL4A",74,0)
 I (PREON]"")&(ROC="R") D RENEW^PSJHL7 Q
"RTN","PSJHL4A",75,0)
 I (PREON]"")&(ROC="E") D EDIT^PSJHL5
"RTN","PSJHL4A",76,0)
 Q
"RTN","PSJHL4A",77,0)
 ;
"RTN","PSJHL4A",78,0)
SOLSRCH ;Find solution
"RTN","PSJHL4A",79,0)
 N SSSS,SEG,ON,ROC,SOL,SOL2
"RTN","PSJHL4A",80,0)
 F SSSS=II:0 S SSSS=$O(PSJMSG(SSSS)) Q:'SSSS  I $P(PSJMSG(SSSS),"|")="ZRX" D  Q
"RTN","PSJHL4A",81,0)
 .S SEG=$G(PSJMSG(SSSS)),ON=$P(SEG,"|",2),ROC=$P(SEG,"|",4)
"RTN","PSJHL4A",82,0)
 I $G(ROC)'="N" F SOL=0:0 S SOL=$O(^PS(55,PSJHLDFN,"IV",+ON,"SOL",SOL)) Q:'SOL  S SOL2=$G(^PS(55,PSJHLDFN,"IV",+ON,"SOL",SOL,0)) I $D(^PS(52.7,"AOI",PTR,+SOL2))&($P(SOL2,U,2)=VOLUME) S SOLUTION=+SOL2 D SET Q
"RTN","PSJHL4A",83,0)
 I 'SOLUTION S SOLUTION=$O(^PS(52.7,"AOI",PTR,SOLUTION)) D SET
"RTN","PSJHL4A",84,0)
 Q
"RTN","PSJHL4A",85,0)
SET ;Set solution tmp nodes
"RTN","PSJHL4A",86,0)
 Q:'+SOLUTION
"RTN","PSJHL4A",87,0)
 S ^TMP("PSJNVO",$J,"SOL",0)=SOLCNT
"RTN","PSJHL4A",88,0)
 S ^TMP("PSJNVO",$J,"SOL",SOLCNT,0)=SOLUTION_"^"_VOLUME,TVOLUME=TVOLUME+(+VOLUME)
"RTN","PSJHL4A",89,0)
 Q
"RTN","PSJHL4A",90,0)
 ;
"RTN","PSJHL4A",91,0)
SNDTSTW(PRIO,PSJSCHED,WARD) ; Test to determine if mail message should be sent.
"RTN","PSJHL4A",92,0)
 N SNPRIO,SNSCHD,SNOPT
"RTN","PSJHL4A",93,0)
 S SNPRIO=$S(PRIO="S":"S",PRIO="A":"A",1:"R")
"RTN","PSJHL4A",94,0)
 S SNSCHD=$S(PSJSCHED="STAT":"S",PSJSCHED="NOW":"N",1:"R")
"RTN","PSJHL4A",95,0)
 S SNOPT=$P($G(^PS(59.6,WARD,0)),"^",32)
"RTN","PSJHL4A",96,0)
 S:SNOPT="" SNOPT=$P($G(^PS(59.7,1,27)),"^",1)
"RTN","PSJHL4A",97,0)
 Q:SNOPT="" 0
"RTN","PSJHL4A",98,0)
 Q:SNOPT[SNPRIO 0
"RTN","PSJHL4A",99,0)
 Q:SNOPT[SNSCHD 0
"RTN","PSJHL4A",100,0)
 Q 1
"RTN","PSJHL4A",101,0)
 ;
"RTN","PSJHL4A",102,0)
SNDTSTP(PRIO,PSJSCHED) ; Test to determine if mail message should be sent.
"RTN","PSJHL4A",103,0)
 N SNPRIO,SNSCHD,SNOPT
"RTN","PSJHL4A",104,0)
 S SNPRIO=$S(PRIO="S":"S",PRIO="A":"A",1:"R")
"RTN","PSJHL4A",105,0)
 S SNSCHD=$S(PSJSCHED="STAT":"S",PSJSCHED="NOW":"N",1:"R")
"RTN","PSJHL4A",106,0)
 S SNOPT=$P($G(^PS(59.7,1,27)),"^",1)
"RTN","PSJHL4A",107,0)
 Q:SNOPT="" 1
"RTN","PSJHL4A",108,0)
 Q:SNOPT[SNPRIO 0
"RTN","PSJHL4A",109,0)
 Q:SNOPT[SNSCHD 0
"RTN","PSJHL4A",110,0)
 Q 1
"RTN","PSJHL4A",111,0)
 ;
"RTN","PSJHL4A",112,0)
SNDTSTA(PRIO,PSJSCHED) ; Test to determine if mail message should be sent.
"RTN","PSJHL4A",113,0)
 N SNPRIO,SNSCHD,SNOPT
"RTN","PSJHL4A",114,0)
 S SNPRIO=$S(PRIO="S":"S",PRIO="A":"A",1:"R")
"RTN","PSJHL4A",115,0)
 S SNSCHD=$S(PSJSCHED="STAT":"S",PSJSCHED="NOW":"N",1:"R")
"RTN","PSJHL4A",116,0)
 S SNOPT=$P($G(^PS(59.7,1,27)),"^",2)
"RTN","PSJHL4A",117,0)
 S:SNOPT="" SNOPT=$P($G(^PS(59.7,1,27)),"^",1)
"RTN","PSJHL4A",118,0)
 Q:SNOPT="" 1
"RTN","PSJHL4A",119,0)
 Q:SNOPT[SNPRIO 0
"RTN","PSJHL4A",120,0)
 Q:SNOPT[SNSCHD 0
"RTN","PSJHL4A",121,0)
 Q 1
"VER")
8.0^22.0
"BLD",6022,6)
^171
**END**
**END**
