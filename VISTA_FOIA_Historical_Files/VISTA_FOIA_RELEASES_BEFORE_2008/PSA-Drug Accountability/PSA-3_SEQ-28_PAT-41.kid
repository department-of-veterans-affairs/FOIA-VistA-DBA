Released PSA*3*41 SEQ #28
Extracted from mail message
**KIDS**:PSA*3.0*41^

**INSTALL NAME**
PSA*3.0*41
"BLD",4772,0)
PSA*3.0*41^DRUG ACCOUNTABILITY^0^3040628^y
"BLD",4772,1,0)
^9.61A^3^3^3040628^^^^
"BLD",4772,1,1,0)
 This enhancement contains the updated GUI based changes for the Upload
"BLD",4772,1,2,0)
 Invoices process used by Drug Accountability V. 3.0 to process invoice
"BLD",4772,1,3,0)
 data received from the new Prime Vendor, McKesson. 
"BLD",4772,"ABNS",0)
^9.66A^1^1
"BLD",4772,"ABNS",1,0)
PSA
"BLD",4772,"ABNS","B","PSA",1)

"BLD",4772,"INI")
PSAP41
"BLD",4772,"INID")
^^n
"BLD",4772,"KRN",0)
^9.67PA^^
"BLD",4772,"KRN",.4,0)
.4
"BLD",4772,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",4772,"KRN",.401,0)
.401
"BLD",4772,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",4772,"KRN",.402,0)
.402
"BLD",4772,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",4772,"KRN",.403,0)
.403
"BLD",4772,"KRN",.5,0)
.5
"BLD",4772,"KRN",.84,0)
.84
"BLD",4772,"KRN",3.6,0)
3.6
"BLD",4772,"KRN",3.8,0)
3.8
"BLD",4772,"KRN",9.2,0)
9.2
"BLD",4772,"KRN",9.8,0)
9.8
"BLD",4772,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",4772,"KRN",9.8,"NM",1,0)
PSAP41^^0^B10296519
"BLD",4772,"KRN",9.8,"NM",2,0)
PSABRKU1^^0^B21421525
"BLD",4772,"KRN",9.8,"NM",3,0)
PSABRKU3^^0^B21026171
"BLD",4772,"KRN",9.8,"NM","B","PSABRKU1",2)

"BLD",4772,"KRN",9.8,"NM","B","PSABRKU3",3)

"BLD",4772,"KRN",9.8,"NM","B","PSAP41",1)

"BLD",4772,"KRN",19,0)
19
"BLD",4772,"KRN",19.1,0)
19.1
"BLD",4772,"KRN",101,0)
101
"BLD",4772,"KRN",409.61,0)
409.61
"BLD",4772,"KRN",771,0)
771
"BLD",4772,"KRN",869.2,0)
869.2
"BLD",4772,"KRN",870,0)
870
"BLD",4772,"KRN",8994,0)
8994
"BLD",4772,"KRN","B",.4,.4)

"BLD",4772,"KRN","B",.401,.401)

"BLD",4772,"KRN","B",.402,.402)

"BLD",4772,"KRN","B",.403,.403)

"BLD",4772,"KRN","B",.5,.5)

"BLD",4772,"KRN","B",.84,.84)

"BLD",4772,"KRN","B",3.6,3.6)

"BLD",4772,"KRN","B",3.8,3.8)

"BLD",4772,"KRN","B",9.2,9.2)

"BLD",4772,"KRN","B",9.8,9.8)

"BLD",4772,"KRN","B",19,19)

"BLD",4772,"KRN","B",19.1,19.1)

"BLD",4772,"KRN","B",101,101)

"BLD",4772,"KRN","B",409.61,409.61)

"BLD",4772,"KRN","B",771,771)

"BLD",4772,"KRN","B",869.2,869.2)

"BLD",4772,"KRN","B",870,870)

"BLD",4772,"KRN","B",8994,8994)

"BLD",4772,"QUES",0)
^9.62^^
"BLD",4772,"REQB",0)
^9.611^1^1
"BLD",4772,"REQB",1,0)
PSA*3.0*26^1
"BLD",4772,"REQB","B","PSA*3.0*26",1)

"BLD",4772,"REQG",0)
^9.611^^
"INI")
PSAP41
"MBREQ")
0
"PKG",287,-1)
1^1
"PKG",287,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",287,22,0)
^9.49I^1^1
"PKG",287,22,1,0)
3.0^2971024^2971030^11595
"PKG",287,22,1,"PAH",1,0)
41^3040628^11850
"PKG",287,22,1,"PAH",1,1,0)
^^3^3^3040628
"PKG",287,22,1,"PAH",1,1,1,0)
 This enhancement contains the updated GUI based changes for the Upload
"PKG",287,22,1,"PAH",1,1,2,0)
 Invoices process used by Drug Accountability V. 3.0 to process invoice
"PKG",287,22,1,"PAH",1,1,3,0)
 data received from the new Prime Vendor, McKesson. 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSABRKU1")
0^2^B21421525
"RTN","PSABRKU1",1,0)
PSABRKU1 ;BIR/DB-Upload and Process Prime Vendor Invoice Data ;8/19/99
"RTN","PSABRKU1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26,41**; 10/24/97
"RTN","PSABRKU1",3,0)
 ;
"RTN","PSABRKU1",4,0)
PSAUPLD(RET,TMP) ;uploads data in VISTA
"RTN","PSABRKU1",5,0)
 D NOW^%DTC
"RTN","PSABRKU1",6,0)
 S X=0
"RTN","PSABRKU1",7,0)
 I $G(TMP(0))="******" S PSAOUT=0 D STRT S RET="OK" Q
"RTN","PSABRKU1",8,0)
 I $G(TMP(0))="KEY" G LOGON
"RTN","PSABRKU1",9,0)
 S X=0,CNT=1 F  S X=$O(^TMP($J,"PSAX12",X)) Q:X'>0  S CNT=$G(CNT)+1
"RTN","PSABRKU1",10,0)
 S X=-1 F  S X=$O(TMP(X)) Q:X=""  S DATA=$G(TMP(X)) I $G(DATA)'="" S DATA=$P(DATA,"^",2,99) S ^TMP($J,"PSAX12",CNT,0)=DATA,CNT=$G(CNT)+1
"RTN","PSABRKU1",11,0)
 ;
"RTN","PSABRKU1",12,0)
 ;
"RTN","PSABRKU1",13,0)
 S RET="OK"
"RTN","PSABRKU1",14,0)
 Q
"RTN","PSABRKU1",15,0)
STRT S (PSABBC,PSACNT,PSAISA,PSALINE,PSASEGD,PSALND)=0 K TMP
"RTN","PSABRKU1",16,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","PSABRKU1",17,0)
 S ^TMP($J,"PSA UPLOAD",.3,0)="Results  : "
"RTN","PSABRKU1",18,0)
 S ^TMP($J,"PSA UPLOAD",.5,0)="Finished                : "_Y
"RTN","PSABRKU1",19,0)
 D NOW^%DTC S DT=$P(%,".")
"RTN","PSABRKU1",20,0)
 F  S PSALINE=$O(^TMP($J,"PSAX12",PSALINE)) Q:'PSALINE  D  Q:PSABBC&(PSAISA)
"RTN","PSABRKU1",21,0)
 .I $E($G(^TMP($J,"PSAX12",PSALINE,0)),1,3)="ISA" S PSADB=^TMP($J,"PSAX12",PSALINE,0) S PSASEGD=$E(^(0),4,4),PSALND=$E(^(0),106,106),PSAISA=1 Q
"RTN","PSABRKU1",22,0)
 ;
"RTN","PSABRKU1",23,0)
 I PSASEGD=""!(PSALND="") D  G KILL
"RTN","PSABRKU1",24,0)
 .S PSASTAR="",$P(PSASTAR,"*",80)=""
"RTN","PSABRKU1",25,0)
 G:PSASEGD="~"&(PSALND="^") LINE
"RTN","PSABRKU1",26,0)
 ;
"RTN","PSABRKU1",27,0)
 ;Changes the data element and segment delimiters to ^ and ~.
"RTN","PSABRKU1",28,0)
 S (PSACNT,PSALINE)=0 F  S PSALINE=$O(^TMP($J,"PSAX12",PSALINE)) Q:'PSALINE  D  Q:PSAOUT
"RTN","PSABRKU1",29,0)
 .S PSADATA=^TMP($J,"PSAX12",PSALINE,0)
"RTN","PSABRKU1",30,0)
 .I PSALND'="~" S PSADATA=$TR(PSADATA,PSALND,"~")
"RTN","PSABRKU1",31,0)
 .I PSASEGD'="^" S PSADATA=$TR(PSADATA,PSASEGD,"^")
"RTN","PSABRKU1",32,0)
 .S ^TMP($J,"PSAX12",PSALINE,0)=PSADATA
"RTN","PSABRKU1",33,0)
 ;
"RTN","PSABRKU1",34,0)
LINE ;Places each segment on a node to itself.
"RTN","PSABRKU1",35,0)
 K ^TMP($J,"PSAPV")
"RTN","PSABRKU1",36,0)
 S PSAHOLD="",(PSACNT,PSALINE)=0
"RTN","PSABRKU1",37,0)
 F  S PSALINE=$O(^TMP($J,"PSAX12",PSALINE)) Q:'PSALINE  D
"RTN","PSABRKU1",38,0)
 .S PSADATA=^TMP($J,"PSAX12",PSALINE,0),PSADATA=PSAHOLD_PSADATA
"RTN","PSABRKU1",39,0)
 .I PSADATA'["~" S PSAHOLD=PSADATA Q
"RTN","PSABRKU1",40,0)
 .S PSASTOP=0 F  S PSASEG=$P(PSADATA,"~") Q:PSASEG=""  D  Q:PSASTOP
"RTN","PSABRKU1",41,0)
 ..S PSACNT=PSACNT+1,^TMP($J,"PSAPV",PSACNT,0)=PSASEG
"RTN","PSABRKU1",42,0)
 ..S PSADATA=$P(PSADATA,"~",2,99) I PSADATA'["~" S PSASTOP=1,PSAHOLD=PSADATA Q
"RTN","PSABRKU1",43,0)
 ..S PSAHOLD=""
"RTN","PSABRKU1",44,0)
 ;
"RTN","PSABRKU1",45,0)
SPACES ;remove all leading spaces in all data elements
"RTN","PSABRKU1",46,0)
 S (PSACNT,PSALINE)=0 F  S PSALINE=$O(^TMP($J,"PSAPV",PSALINE)) Q:'PSALINE  D
"RTN","PSABRKU1",47,0)
 .S PSASEG=^TMP($J,"PSAPV",PSALINE,0)
"RTN","PSABRKU1",48,0)
 .I $E(PSASEG,1,3)="ISA" S ^TMP($J,"PSAPVS",PSALINE)=^TMP($J,"PSAPV",PSALINE,0) Q
"RTN","PSABRKU1",49,0)
 .S PSACNT=0,PSASEGL=$L(PSASEG)
"RTN","PSABRKU1",50,0)
 .F PSAEX=1:1:PSASEGL S PSAX=$E(PSASEG,PSAEX,PSAEX) S:PSAX="^" PSACNT=PSACNT+1
"RTN","PSABRKU1",51,0)
 .F PSAPC=1:1:(PSACNT+1) S PSADE=$P(PSASEG,"^",PSAPC) D
"RTN","PSABRKU1",52,0)
 ..F  Q:$E(PSADE,1,1)'=" "  S PSADE=$E(PSADE,2,999)
"RTN","PSABRKU1",53,0)
 ..S $P(PSASEG,"^",PSAPC)=PSADE
"RTN","PSABRKU1",54,0)
 .S ^TMP($J,"PSAPVS",PSALINE)=PSASEG
"RTN","PSABRKU1",55,0)
 K ^TMP($J,"PSAPV")
"RTN","PSABRKU1",56,0)
 ;
"RTN","PSABRKU1",57,0)
CHECK ;Looks for X12 errors. If no errors, loads data into ^TMP($J,"PSAPV SET")
"RTN","PSABRKU1",58,0)
 D ^PSABRKU3
"RTN","PSABRKU1",59,0)
 D XTMP^PSABRKU4
"RTN","PSABRKU1",60,0)
 S PSANEXT=$O(^XTMP("PSAPV",0))
"RTN","PSABRKU1",61,0)
 D ^PSABRKU6
"RTN","PSABRKU1",62,0)
 ;
"RTN","PSABRKU1",63,0)
KILL K ^TMP($J,"PSAPVS"),^TMP($J,"PSAPV SET"),^TMP($J,"PSAX12")
"RTN","PSABRKU1",64,0)
 K %,DIR,DIRUT,DWLC,PSABBC,PSACNT,PSACTN1,PSACOMB,PSACS,PSACTRL,PSACTRL2,PSADATA,PSADE,PSADT,PSADUP,PSAENTRY,PSAERR,PSAEX,PSAEXPEC,PSAFND1,PSAGS,PSAHOLD,PSAIEN,PSAIN,PSAINV,PSAINVDT,PSAINVN,PSAISA,PSAISIT,PSAISITN,PSAITCNT,PSAITEM
"RTN","PSABRKU1",65,0)
 K PSALAST,PSALINE,PSALLCS,PSALLOK,PSALND,PSALOC,PSANDC,PSANEW,PSANEXT,PSANTYPE,PSAOK,PSAORD,PSAORDDT,PSAORDN,PSAOSIT,PSAOSITN,PSAOUT,PSAPC
"RTN","PSABRKU1",66,0)
 K PSAS,PSASEG,PSASEGL,PSASEGD,PSASS,PSAST,PSASTA,PSASTAR,PSASTCNT,PSASUB,PSASYN,PSAUOM,PSAUOM1,PSAUOMH,PSAUOMH1,PSAVSN,PSAX,X,X1,X2,XTKDIC,XTKERR,XTKMODE,Y
"RTN","PSABRKU1",67,0)
 S (X,CNT)=0 F  S X=$O(PSAGUI2(X)) Q:X=""  S CNT=$G(CNT)+1
"RTN","PSABRKU1",68,0)
 I $G(CNT)>0 S ^TMP($J,"PSA UPLOAD",1.6,0)="Orders Uploaded         : "_$G(CNT)
"RTN","PSABRKU1",69,0)
 S (X,CNTR)=0 F  S X=$O(PSAGUI3(X)) Q:X=""  S CNTR=$G(CNTR)+1
"RTN","PSABRKU1",70,0)
 I $G(CNTR)>0 S ^TMP($J,"PSA UPLOAD",1.7,0)="Invoices Uploaded       : "_$G(CNTR)
"RTN","PSABRKU1",71,0)
 S ^TMP($J,"PSA UPLOAD",1.8,0)="Line Items Uploaded     : "_$G(PSAGUI4)
"RTN","PSABRKU1",72,0)
 S RET=$G(CNT)_"^"_$G(CNTR)_"^"_$G(PSAGUI4) K CNT,CNTR
"RTN","PSABRKU1",73,0)
 K PSAGUI1
"RTN","PSABRKU1",74,0)
 I $D(^TMP($J,"PSA UPLOAD")) S XMSUB="Upload Status Report",XMDUZ="DRUG ACCOUNTABILITY UPLOAD INTERFACE",XMY(DUZ)="",XMTEXT="^TMP($J,"_"""PSA UPLOAD"""_"," D ^XMD
"RTN","PSABRKU1",75,0)
 K ^TMP($J,"PSA UPLOAD"),^TMP($J,"PSAX12"),^TMP($J,"PSAPVS")
"RTN","PSABRKU1",76,0)
 Q
"RTN","PSABRKU1",77,0)
LOGON ;Check security key
"RTN","PSABRKU1",78,0)
 S (PSAGUI2,PSAGUI3,PSAGUI4)=0
"RTN","PSABRKU1",79,0)
 K ^TMP($J,"PSAX12"),^TMP($J,"PSA UPLOAD"),PSACNT,CNT
"RTN","PSABRKU1",80,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) S RET(0)="0" Q
"RTN","PSABRKU1",81,0)
 D NOW^%DTC S Y=% X ^DD("DD") S ^TMP($J,"PSA UPLOAD",.4,0)="Upload Started          : "_Y,RET(0)=1 Q
"RTN","PSABRKU1",82,0)
 Q
"RTN","PSABRKU3")
0^3^B21026171
"RTN","PSABRKU3",1,0)
PSABRKU3 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;8/13/97
"RTN","PSABRKU3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26,41**; 10/24/97
"RTN","PSABRKU3",3,0)
 ;Checking the X12 invoice data.
"RTN","PSABRKU3",4,0)
 S (PSASTCNT,PSAITCNT,PSACTRL(1))=0
"RTN","PSABRKU3",5,0)
 K ^TMP($J,"PSAPV SET"),PSAERR
"RTN","PSABRKU3",6,0)
 S PSALAST=""
"RTN","PSABRKU3",7,0)
 S PSALINE=0 F  S PSALINE=$O(^TMP($J,"PSAPVS",PSALINE)) Q:PSALINE=""  S PSADATA=^(PSALINE) D
"RTN","PSABRKU3",8,0)
 .;check segment order
"RTN","PSABRKU3",9,0)
 .D ^PSABRKU5 S PSALAST=$P(PSADATA,"^")
"RTN","PSABRKU3",10,0)
ISA .;control header
"RTN","PSABRKU3",11,0)
 .I PSALAST="ISA" D  Q
"RTN","PSABRKU3",12,0)
 ..S PSASTCNT=0
"RTN","PSABRKU3",13,0)
 ..S PSAISA=PSADATA,PSACTRL="" I $L($P(PSADATA,"^",14))'=9 S PSASEG="ISA" D MSG^PSABRKU8
"RTN","PSABRKU3",14,0)
 .;
"RTN","PSABRKU3",15,0)
IEA .;control trailer
"RTN","PSABRKU3",16,0)
 .I PSALAST="IEA" D  Q
"RTN","PSABRKU3",17,0)
 ..I $P(PSADATA,"^",3)'=$P(PSAISA,"^",14) S PSASEG="IEA" D MSG^PSABRKU8
"RTN","PSABRKU3",18,0)
 .;
"RTN","PSABRKU3",19,0)
GS .;group header
"RTN","PSABRKU3",20,0)
 .I PSALAST="GS" S PSAGS=PSADATA D  Q
"RTN","PSABRKU3",21,0)
 ..F %=3,4 S PSAPC=$S(%=3:7,1:9) I $P(PSADATA,"^",%)'=$TR($P(PSAISA,"^",PSAPC)," ") S PSASEG="GS" D MSG^PSABRKU8
"RTN","PSABRKU3",22,0)
 .;
"RTN","PSABRKU3",23,0)
GE .;group trailer
"RTN","PSABRKU3",24,0)
 .I PSALAST="GE" D  Q
"RTN","PSABRKU3",25,0)
 ..I $P(PSADATA,"^",3)'=$P($G(PSAGS),"^",7) S PSASEG="GE" D MSG^PSABRKU8
"RTN","PSABRKU3",26,0)
 .;
"RTN","PSABRKU3",27,0)
ST .;set header
"RTN","PSABRKU3",28,0)
 .I PSALAST="ST" D  Q
"RTN","PSABRKU3",29,0)
 ..S PSAST=PSADATA,PSACTRL=$P(PSADATA,"^",3),PSASTCNT=1,PSAITCNT=0,PSANTYPE=""
"RTN","PSABRKU3",30,0)
 ..;PSA*3*41 - McKesson probability of multiple files, may have to
"RTN","PSABRKU3",31,0)
 ..;increment transaction set control numbers in 'ST' & 'SE'
"RTN","PSABRKU3",32,0)
 ..I $D(^TMP($J,"PSAPV SET",PSACTRL,"IN")) D RESETST
"RTN","PSABRKU3",33,0)
 ..I $D(^XTMP("PSAPV",PSACTRL)) D RESETST ;may already be on file
"RTN","PSABRKU3",34,0)
 ..I $L(PSACTRL)>3,$L(PSACTRL)<10 Q
"RTN","PSABRKU3",35,0)
 ..S PSASEG="ST" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",36,0)
 .;
"RTN","PSABRKU3",37,0)
SE .;set trailer
"RTN","PSABRKU3",38,0)
 .I PSALAST="SE" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",39,0)
 ..I $G(PSACTRL(1))'>0,$P(PSADATA,"^",3)'=PSACTRL S PSASEG="SE1" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",40,0)
 ..I PSASTCNT'=$P(PSADATA,"^",2) S PSASEG="SE2" D MSG^PSABRKU8
"RTN","PSABRKU3",41,0)
 .;
"RTN","PSABRKU3",42,0)
BIG .;beginning segment for invoice
"RTN","PSABRKU3",43,0)
 .I PSALAST="BIG" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",44,0)
 ..I $P(PSADATA,"^",4)="" S $P(PSADATA,"^",4)=$P(PSADATA,"^",2)
"RTN","PSABRKU3",45,0)
 ..S $P(PSADATA,"^",5)=$TR($P(PSADATA,"^",5)," ")
"RTN","PSABRKU3",46,0)
 ..S ^TMP($J,"PSAPV SET",PSACTRL,"IN")=$P(PSADATA,"^",2,5)
"RTN","PSABRKU3",47,0)
 .;
"RTN","PSABRKU3",48,0)
REF .;(not used)
"RTN","PSABRKU3",49,0)
 .I PSALAST="REF" S PSASTCNT=PSASTCNT+1 Q
"RTN","PSABRKU3",50,0)
 .;
"RTN","PSABRKU3",51,0)
 .;buyer, seller, shipping addresses
"RTN","PSABRKU3",52,0)
N1 .I PSALAST="N1" S PSASTCNT=PSASTCNT+1,PSANTYPE=$P(PSADATA,"^",2) D  Q
"RTN","PSABRKU3",53,0)
 ..I PSANTYPE'="BY",PSANTYPE'="DS",PSANTYPE'="ST" S PSASEG="N1" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",54,0)
 ..S ^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE)=$P(PSADATA,"^",3)
"RTN","PSABRKU3",55,0)
 .;
"RTN","PSABRKU3",56,0)
N2 .I PSALAST="N2" D  Q
"RTN","PSABRKU3",57,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSABRKU3",58,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE),"^",2)=$P(PSADATA,"^",2) S PSASTCNT=PSASTCNT+1
"RTN","PSABRKU3",59,0)
 .;
"RTN","PSABRKU3",60,0)
N3 .I PSALAST="N3" D  Q
"RTN","PSABRKU3",61,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSABRKU3",62,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE),"^",3)=$P(PSADATA,"^",2) S PSASTCNT=PSASTCNT+1
"RTN","PSABRKU3",63,0)
 .;
"RTN","PSABRKU3",64,0)
N4 .I PSALAST="N4" D  Q
"RTN","PSABRKU3",65,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSABRKU3",66,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE),"^",4,6)=$P(PSADATA,"^",2,4) S PSASTCNT=PSASTCNT+1,PSANTYPE=""
"RTN","PSABRKU3",67,0)
 .;
"RTN","PSABRKU3",68,0)
DTM .;date time reference
"RTN","PSABRKU3",69,0)
 .I PSALAST="DTM" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",70,0)
 ..S %=$S($P(PSADATA,"^",2)="002":5,$P(PSADATA,"^",2)="035":6,1:0) I '% Q
"RTN","PSABRKU3",71,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,"IN"),"^",%)=$P(PSADATA,"^",3)
"RTN","PSABRKU3",72,0)
 .;
"RTN","PSABRKU3",73,0)
IT1 .;invoice line item
"RTN","PSABRKU3",74,0)
 .I PSALAST="IT1" S PSASTCNT=PSASTCNT+1,PSAITCNT=PSAITCNT+1 D ITEM Q
"RTN","PSABRKU3",75,0)
CTT .;item count
"RTN","PSABRKU3",76,0)
 .I PSALAST="CTT" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",77,0)
 ..I PSAITCNT'=$P(PSADATA,"^",2) S PSASEG="CTT" D MSG^PSABRKU8
"RTN","PSABRKU3",78,0)
 .;
"RTN","PSABRKU3",79,0)
UNKNOWN .;Segment we don't use
"RTN","PSABRKU3",80,0)
 .S PSASTCNT=PSASTCNT+1
"RTN","PSABRKU3",81,0)
 ;
"RTN","PSABRKU3",82,0)
ERROR S PSASEG=$O(PSAERR("")) D:PSASEG'="" ERROR^PSABRKU8
"RTN","PSABRKU3",83,0)
 Q
"RTN","PSABRKU3",84,0)
 ;
"RTN","PSABRKU3",85,0)
NTYPE S PSASEG="NONTYPE" D NONTYPE^PSABRKU8
"RTN","PSABRKU3",86,0)
 Q
"RTN","PSABRKU3",87,0)
 ;
"RTN","PSABRKU3",88,0)
ITEM ;check line item
"RTN","PSABRKU3",89,0)
 I '$P(PSADATA,"^",2) S PSASEG="IT1-1" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",90,0)
 I $P(PSADATA,"^",6)'="DS" S PSASEG="IT1-2" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",91,0)
 I $P(PSADATA,"^",8)="",$P(PSADATA,"^",10)="",$P(PSADATA,"^",12)="" S PSASEG="IT1-3" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",92,0)
 ;"IT1" Seg=Qty Invoiced ^ Unit of Measure ^ Unit Price ^ Basic Unit Code "DS" ^ NDC ^ VSN
"RTN","PSABRKU3",93,0)
 S PSAITEM=+$P(PSADATA,"^",2),^TMP($J,"PSAPV SET",PSACTRL,"IT",PSAITEM)=+$P(PSADATA,"^",3)_"^"_$P(PSADATA,"^",4)_"^"_$P(PSADATA,"^",5)_"^"_$P(PSADATA,"^",8)_"^"_$P(PSADATA,"^",10)
"RTN","PSABRKU3",94,0)
 I $P(PSADATA,"^",12)'="",$P(PSADATA,"^",11)="UP" S $P(^TMP($J,"PSAPV SET",PSACTRL,"IT",PSAITEM),"^",26)=$P(PSADATA,"^",12)
"RTN","PSABRKU3",95,0)
 Q
"RTN","PSABRKU3",96,0)
RESETST ;Reset PSACTRL
"RTN","PSABRKU3",97,0)
 S PSACTRL(1)=PSACTRL+1,X1=PSACTRL(1) F X=1:1:($L(PSACTRL)-1) S X1="0"_X1
"RTN","PSABRKU3",98,0)
 S PSACTRL=X1 I $D(^TMP($J,"PSAPV SET",PSACTRL)) G RESETST
"RTN","PSABRKU3",99,0)
 I $D(^XTMP("PSAPV",PSACTRL)) G RESETST
"RTN","PSABRKU3",100,0)
 Q
"RTN","PSAP41")
0^1^B10296519
"RTN","PSAP41",1,0)
PSAP41 ;BHM/DB - PRIME VENDOR CONVERSION ROUTINE ;3/30/04
"RTN","PSAP41",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**41**; 10/24/97
"RTN","PSAP41",3,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAP41",4,0)
 W !!,"This routine is only to be run prior to the first execution of the Drug",!,"Accountability upload utility used with the new prime vendor (McKesson).",!
"RTN","PSAP41",5,0)
ASK K DIR S DIR("A")="Is it safe to run this utility",DIR(0)="Y",DIR("B")="NO" D ^DIR W "  ",$S($G(Y)=1:"YES",$G(Y)="^":"^ Install Aborted",1:"NO")
"RTN","PSAP41",6,0)
 I $D(DIRUT) S (XPDQUIT,XPDABORT)=1 G DONE
"RTN","PSAP41",7,0)
 K DIR I $G(Y)'=1 W !!,"This utility can be run at anytime in the future from the programmer prompt",!,"by running the routine PSAP41.",! G DONE
"RTN","PSAP41",8,0)
DEV W ! K DIR S DIR(0)="DA^NOW::ERSX",DIR("A")="When do you want to run this utility? ",DIR("B")="NOW",DIR("?")="Complete date and time must be stated." D ^DIR I $D(DIRUT) W !!,"Incomplete information, try again" G ASK
"RTN","PSAP41",9,0)
 S ZTDTH=Y,ZTRTN="PSABGN^PSAP41",ZTDESC="DRUG ACCOUNTABILITY VSN CONVERSION",ZTIO="",PSADUZ=DUZ,ZTSAVE("PSADUZ")=""
"RTN","PSAP41",10,0)
 D ^%ZTLOAD I '$D(ZTSK) D HOME^%ZIS W !,"Task was not started properly.",! G DONE
"RTN","PSAP41",11,0)
 W !!,"Task Queued - Task Number: ",ZTSK,!!
"RTN","PSAP41",12,0)
 G DONE
"RTN","PSAP41",13,0)
PSABGN ;begin process
"RTN","PSAP41",14,0)
 S (PSADRG,PSACNT2)=0
"RTN","PSAP41",15,0)
1 S PSADRG=$O(^PSDRUG(PSADRG)) G MSG:PSADRG'>0 I '$D(^PSDRUG(PSADRG,1,0)) G 1
"RTN","PSAP41",16,0)
 S PSASYN=0
"RTN","PSAP41",17,0)
2 S PSASYN=$O(^PSDRUG(PSADRG,1,PSASYN)) G 1:PSASYN'>0 S PSADATA=$G(^PSDRUG(PSADRG,1,PSASYN,0))
"RTN","PSAP41",18,0)
 S PSAVEND=$P($G(PSADATA),"^",9),PSAVEND=$TR(PSAVEND,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSAP41",19,0)
 I PSAVEND["AMERISOURCE" S DIE="^PSDRUG("_PSADRG_",1,",DA(1)=PSADRG,DA=PSASYN,DR="400///UNKNOWN" D ^DIE K DA,DR S PSACNT2=$G(PSACNT2)+1
"RTN","PSAP41",20,0)
 G 2
"RTN","PSAP41",21,0)
DONE K DIE,DA,DR,DIR,PSADRG,PSASYN,PSADATA,PSAVEND
"RTN","PSAP41",22,0)
Q Q
"RTN","PSAP41",23,0)
MSG S XMSUB="PSA*3*41 Pre-install routine completed"
"RTN","PSAP41",24,0)
 S ^TMP("PSA",$J,1,0)="The post Amerisource/Pre-McKesson conversion of synonym data has completed."
"RTN","PSAP41",25,0)
 S ^TMP("PSA",$J,2,0)=" ",^TMP("PSA",$J,3,0)="Synonym Vendor Stock Numbers converted: "_$G(PSACNT2)
"RTN","PSAP41",26,0)
 S XMY(PSADUZ)="",XMDUZ="Drug Accountability Pre-installation routine",XMTEXT="^TMP(""PSA"",$J,"
"RTN","PSAP41",27,0)
 D ^XMD K PSADUZ
"RTN","PSAP41",28,0)
 G DONE
"VER")
8.0^22.0
**END**
**END**
