Released PSO*7*200 SEQ #231
Extracted from mail message
**KIDS**:PSO*7.0*200^

**INSTALL NAME**
PSO*7.0*200
"BLD",6229,0)
PSO*7.0*200^OUTPATIENT PHARMACY^0^3070321^y
"BLD",6229,1,0)
^^255^255^3070308^
"BLD",6229,1,1,0)
 This patch contains the FY 2007 Quarter 2 Outpatient Pharmacy V. 7.0
"BLD",6229,1,2,0)
enhancements. 
"BLD",6229,1,3,0)
 
"BLD",6229,1,4,0)
 
"BLD",6229,1,5,0)
***** NOTE TO SITES USING AUTOMATED FILLING EQUIPMENT *****
"BLD",6229,1,6,0)
Please ensure that your vendor is aware of the changes being made by this 
"BLD",6229,1,7,0)
patch. There are changes (described below) that affect both the HEALTH 
"BLD",6229,1,8,0)
LEVEL SEVEN (HL7) messages (content of fields only - no new fields are
"BLD",6229,1,9,0)
added) and the laser label stream.
"BLD",6229,1,10,0)
 
"BLD",6229,1,11,0)
If you are using automated dispensing equipment that relies on 
"BLD",6229,1,12,0)
the data stream sent to the laser labels port, you have 2 options:
"BLD",6229,1,13,0)
  1. Implement the Outpatient Automation Interface (OPAI) (available with
"BLD",6229,1,14,0)
     released patch PSO*7*156) or 
"BLD",6229,1,15,0)
  2. Contact your vendor to make adjustments based on the new data stream.
"BLD",6229,1,16,0)
 
"BLD",6229,1,17,0)
 
"BLD",6229,1,18,0)
Outpatient Pharmacy Automation Interface (OPAI) enhancements: 
"BLD",6229,1,19,0)
-------------------------------------------------------------
"BLD",6229,1,20,0)
1. Modified to use the new commercial warning label source to send the
"BLD",6229,1,21,0)
warning label text to the automated filling equipment. The OPAI WARNING
"BLD",6229,1,22,0)
LABEL SOURCE field (#16.2) in the PHARMACY SYSTEM file (#59.7) must be set
"BLD",6229,1,23,0)
to "N" for "New" to send the warning labels from the new commercial data
"BLD",6229,1,24,0)
source to OPAI. It can be set by using the Pharmacy System Parameters Edit
"BLD",6229,1,25,0)
[PSS SYS EDIT] option.
"BLD",6229,1,26,0)
 Example:
"BLD",6229,1,27,0)
 
"BLD",6229,1,28,0)
Select OPTION NAME: PSS SYS EDIT       Pharmacy System Parameters Edit
"BLD",6229,1,29,0)
Pharmacy System Parameters Edit
"BLD",6229,1,30,0)
 
"BLD",6229,1,31,0)
PMIS PRINTER: L8150$PRT// 
"BLD",6229,1,32,0)
PMIS LANGUAGE: English// 
"BLD",6229,1,33,0)
WARNING LABEL SOURCE: NEW// 
"BLD",6229,1,34,0)
CMOP WARNING LABEL SOURCE: NEW//
"BLD",6229,1,35,0)
OPAI WARNING LABEL SOURCE: ?
"BLD",6229,1,36,0)
     Enter "N" for NEW to use commercial data source for OPAI warning 
"BLD",6229,1,37,0)
labels.
"BLD",6229,1,38,0)
     Choose from: 
"BLD",6229,1,39,0)
       N        NEW
"BLD",6229,1,40,0)
OPAI WARNING LABEL SOURCE: N  NEW
"BLD",6229,1,41,0)
 
"BLD",6229,1,42,0)
   a. The warning text is sent as one record per warning.
"BLD",6229,1,43,0)
   b. The text is sent in English or Spanish depending on the patient's
"BLD",6229,1,44,0)
      other language settings. 
"BLD",6229,1,45,0)
   c. If the DEA, SPECIAL HDLG field (#3) in the DRUG file (#50) begins
"BLD",6229,1,46,0)
      with numbers 1,2,3,4, or 5, the NO TRANSFER warning text from the RX
"BLD",6229,1,47,0)
      CONSULT file (#54) entry number 20 is automatically sent as one of
"BLD",6229,1,48,0)
      the first 5 warnings when the OPAI WARNING LABEL SOURCE is set to 
"BLD",6229,1,49,0)
      "New".
"BLD",6229,1,50,0)
 
"BLD",6229,1,51,0)
 
"BLD",6229,1,52,0)
2. If the BAD ADDRESS INDICATOR (BAI) field (#.121) of the PATIENT file
"BLD",6229,1,53,0)
(#2) is set and the routing is WINDOW, the text "VAB" concatenated with
"BLD",6229,1,54,0)
the BAI code is sent in the Address field of the PID segment of the HL7
"BLD",6229,1,55,0)
message to the filling equipment.
"BLD",6229,1,56,0)
 
"BLD",6229,1,57,0)
Here are some examples of this field:
"BLD",6229,1,58,0)
 
"BLD",6229,1,59,0)
When the permanent address is active:
"BLD",6229,1,60,0)
PADD-1~PADD-2~SPRING~TX~77379~~P~PADD-3~201^~~""~""~~~N|""|||||||
"BLD",6229,1,61,0)
|
"BLD",6229,1,62,0)
 
"BLD",6229,1,63,0)
When the temporary address is active:
"BLD",6229,1,64,0)
PADD-1~PADD-2~SPRING~TX~77379~~P~PADD-3~201^~~""~""~~~N^TADD-1~TADD-2 
"BLD",6229,1,65,0)
TADD-3~PLANO~TX~12345~~C~~""~~~
"BLD",6229,1,66,0)
^HL(772,10388,"IN",2,0)=20070223&""|""|||||||||
"BLD",6229,1,67,0)
 
"BLD",6229,1,68,0)
When the address is flagged as BAI:
"BLD",6229,1,69,0)
PADD-1~PADD-2~SPRING~TX~77379~~VAB1~PADD-3~201^~~""~""~~~N|""||||||
"BLD",6229,1,70,0)
|||
"BLD",6229,1,71,0)
 
"BLD",6229,1,72,0)
"VAB1" - indicates Bad Address Indicator and 1 is for UNDELIVERABLE (2 for
"BLD",6229,1,73,0)
HOMELESS, 3 for OTHER)
"BLD",6229,1,74,0)
 
"BLD",6229,1,75,0)
 
"BLD",6229,1,76,0)
Laser Label enhancements:
"BLD",6229,1,77,0)
-------------------------
"BLD",6229,1,78,0)
1. Print the last 4 digits of the Social Security Number (SSN) instead of
"BLD",6229,1,79,0)
the last 6 digits.
"BLD",6229,1,80,0)
 
"BLD",6229,1,81,0)
2. Change the name on the mailing label back to Last name,First name
"BLD",6229,1,82,0)
format.
"BLD",6229,1,83,0)
 
"BLD",6229,1,84,0)
3. On the Pharmacy Fill Card portion of the label, replace the text 
"BLD",6229,1,85,0)
"Mfr ___________________" with:
"BLD",6229,1,86,0)
   a. NDC/MFR_______________ for non-ePharmacy sites
"BLD",6229,1,87,0)
   b. NDC nnnnn-nnnn-nn for ePharmacy sites 
"BLD",6229,1,88,0)
 
"BLD",6229,1,89,0)
4. Signature log enhancements:
"BLD",6229,1,90,0)
   a. Print current date at top
"BLD",6229,1,91,0)
   b. Do not print user name (if more than 1 prescription was included to
"BLD",6229,1,92,0)
      be signed, the user name could be different for each one).
"BLD",6229,1,93,0)
   c. Correct the spacing and continuation paging issues if one or more 
"BLD",6229,1,94,0)
      of the prescriptions has been discontinued before printing the 
"BLD",6229,1,95,0)
      signature log.
"BLD",6229,1,96,0)
   d. Add a barcode to enable scanning to remove the patient's name from 
"BLD",6229,1,97,0)
      the Bingo Board.
"BLD",6229,1,98,0)
   e. Add as much of the drug name as will fit on the label.
"BLD",6229,1,99,0)
   f. Add hidden action "RS" for Reprint Signature log to the prescription
"BLD",6229,1,100,0)
      profile screen.
"BLD",6229,1,101,0)
   g. While printing original labels (not reprint of the signature log), 
"BLD",6229,1,102,0)
      if all of the fills have a routing of mail, the signature log will
"BLD",6229,1,103,0)
      not be printed.
"BLD",6229,1,104,0)
   h. The line "Relationship_________________ Counseled? _____" is changed
"BLD",6229,1,105,0)
      to "Relation_____ Counseling Refused__ Accepted__".
"BLD",6229,1,106,0)
 
"BLD",6229,1,107,0)
 
"BLD",6229,1,108,0)
5. When a fill is released, if the BAI is no longer set or there is an 
"BLD",6229,1,109,0)
active temporary address, the "B" is removed from the status column of 
"BLD",6229,1,110,0)
the patient profile. (This is removed by making an additional entry in 
"BLD",6229,1,111,0)
the label log. The "B" comes from the "last" entry having a bad address 
"BLD",6229,1,112,0)
condition at the time the label printed).
"BLD",6229,1,113,0)
 
"BLD",6229,1,114,0)
 
"BLD",6229,1,115,0)
 
"BLD",6229,1,116,0)
To address E3R 19820, the following code changes are included in this 
"BLD",6229,1,117,0)
patch:
"BLD",6229,1,118,0)
 
"BLD",6229,1,119,0)
1. Add the capability to tie a ScripTalk printer to regular Pharmacy
"BLD",6229,1,120,0)
label printer(s) to control where the ScripTalk labels print for
"BLD",6229,1,121,0)
multi-divisional sites. The new SCRIPTALK PRINT DEVICE MAPPING multiple
"BLD",6229,1,122,0)
(#47) in PHARMACY SYSTEM file (#59.7) has been created to store this
"BLD",6229,1,123,0)
information in Pharmacy Data Management patch PSS*1*122. The multiple
"BLD",6229,1,124,0)
contains PRINTER TO BE MAPPED field (#.01) and SCRIPTALK DEVICE field
"BLD",6229,1,125,0)
(#.02).
"BLD",6229,1,126,0)
 
"BLD",6229,1,127,0)
The added functionality works in conjunction with the existing ScripTalk 
"BLD",6229,1,128,0)
divisional functionality, so a divisional ScripTalk device must be
"BLD",6229,1,129,0)
defined.  If no mapping is defined in the new fields, ScripTalk labels
"BLD",6229,1,130,0)
will continue to print on the printer defined for the division.  If
"BLD",6229,1,131,0)
a pharmacy printer is mapped to a ScripTalk printer, the ScripTalk label
"BLD",6229,1,132,0)
will automatically be printed on the mapped ScripTalk printer.
"BLD",6229,1,133,0)
 
"BLD",6229,1,134,0)
 
"BLD",6229,1,135,0)
2. Modify the ScripTalk Device Definition Enter/Edit [PSO SCRIPTALK
"BLD",6229,1,136,0)
DEVICE DEF'N] option to allow definition of printer mapping for 
"BLD",6229,1,137,0)
ScripTalk devices.  The user will be prompted to define the ScripTalk 
"BLD",6229,1,138,0)
printer by division or by printer mapping.  After selecting D for 
"BLD",6229,1,139,0)
division, the divisional definition has not changed.  After selecting 
"BLD",6229,1,140,0)
P for printer mapping, the user will be prompted "LABEL PRINTER TO BE
"BLD",6229,1,141,0)
MAPPED". The device entered into this field corresponds to the label
"BLD",6229,1,142,0)
printer selected during Pharmacy login and/or the printer selected during
"BLD",6229,1,143,0)
print from suspense functions. Next, "SCRIPTALK DEVICE" will be prompted,
"BLD",6229,1,144,0)
and this field should contain the ScripTalk printer to be mapped to the
"BLD",6229,1,145,0)
regular label printer.
"BLD",6229,1,146,0)
 
"BLD",6229,1,147,0)
 
"BLD",6229,1,148,0)
MISCELLANEOUS ENHANCEMENTS:
"BLD",6229,1,149,0)
---------------------------
"BLD",6229,1,150,0)
1. A new field FINISH DATE/TIME field (#38.3) is added to the
"BLD",6229,1,151,0)
PRESCRIPTION file (#52).
"BLD",6229,1,152,0)
 
"BLD",6229,1,153,0)
2. When using the Print from Suspense File [PSO PNDLBL] option, if the
"BLD",6229,1,154,0)
routing is not WINDOW and the BAD ADDRESS INDICATOR (#.121) field of the
"BLD",6229,1,155,0)
PATIENT file (#2) is set (value of 1=UNDELIVERABLE, 2=HOMELESS, 3=OTHER)
"BLD",6229,1,156,0)
and the patient does not have an active temporary address, the
"BLD",6229,1,157,0)
prescription fill will not be sent to automated filling equipment and/or
"BLD",6229,1,158,0)
to the label printer. Also, if the fill's routing is mail and the 
"BLD",6229,1,159,0)
patient's MAIL field (#.03) in the PHARMACY PATIENT file (#55) is set to
"BLD",6229,1,160,0)
"DO NOT MAIL" and the current date is before the MAIL STATUS EXPIRATION
"BLD",6229,1,161,0)
DATE field (#.05) in the PHARMACY PATIENT file (#55), the label will not
"BLD",6229,1,162,0)
print and the fill will not be sent to the automated filling equipment.
"BLD",6229,1,163,0)
 
"BLD",6229,1,164,0)
The first time a prescription is not sent/label printed, a MailMan message
"BLD",6229,1,165,0)
will be generated to the user who queued the print from suspense and the
"BLD",6229,1,166,0)
members of the PSO EXTERNAL DISPENSE ALERTS mail group. An entry will also
"BLD",6229,1,167,0)
be set in the PRESCRIPTION file (#52) activity log.
"BLD",6229,1,168,0)
 
"BLD",6229,1,169,0)
Example activity log entry:
"BLD",6229,1,170,0)
---------------------------
"BLD",6229,1,171,0)
Activity Log:
"BLD",6229,1,172,0)
#   Date        Reason         Rx Ref           Initiator Of Activity
"BLD",6229,1,173,0)
=====================================================================
"BLD",6229,1,174,0)
1   02/19/07    SUSPENSE       ORIGINAL         OPPHARMACIST,ONE
"BLD",6229,1,175,0)
Comments: RX not printed from suspense due to BAD ADDRESS INDICATOR
"BLD",6229,1,176,0)
 
"BLD",6229,1,177,0)
- or -
"BLD",6229,1,178,0)
Comments: RX not printed from suspense due to DO NOT MAIL
"BLD",6229,1,179,0)
 
"BLD",6229,1,180,0)
Example MailMan message:
"BLD",6229,1,181,0)
------------------------
"BLD",6229,1,182,0)
Subj: 500 BAD ADDRESS SUSPENSE NOT PRINTED  [#169828] 02/26/07@07:30  11
"BLD",6229,1,183,0)
lines
"BLD",6229,1,184,0)
From: OUTPATIENT PHARMACY PACKAGE  In 'IN' basket.   Page 1
"BLD",6229,1,185,0)
--------------------------------------------------------------------------
"BLD",6229,1,186,0)
-----
"BLD",6229,1,187,0)
The following prescriptions with a routing of mail were not printed/sent 
"BLD",6229,1,188,0)
to
"BLD",6229,1,189,0)
external interface due to the BAD ADDRESS INDICATOR being set and no 
"BLD",6229,1,190,0)
active
"BLD",6229,1,191,0)
temporary address or patient has an active MAIL status of DO NOT MAIL:
"BLD",6229,1,192,0)
 
"BLD",6229,1,193,0)
OPPATIENT,ONE   000001234   (BAD ADDRESS INDICATOR)
"BLD",6229,1,194,0)
  100002608  (1)  A AND Z OINTMENT
"BLD",6229,1,195,0)
  100002609  (0)  ASPIRIN 325MG TABS
"BLD",6229,1,196,0)
 
"BLD",6229,1,197,0)
OPPATIENT,FOUR   000004321   (DO NOT MAIL)
"BLD",6229,1,198,0)
  100002654A  (0)  BACITRACIN OINTMENT 1OZ
"BLD",6229,1,199,0)
 
"BLD",6229,1,200,0)
 
"BLD",6229,1,201,0)
3. Modify the report from the Bad Address Suspended List [PSO BAI 
"BLD",6229,1,202,0)
SUSPENDED] option to allow printing by more than one division and also 
"BLD",6229,1,203,0)
include prescriptions suspended for Consolidated Mail Outpatient Pharmacy 
"BLD",6229,1,204,0)
(CMOP). This report was also changed to not prompt for a start date.
"BLD",6229,1,205,0)
 
"BLD",6229,1,206,0)
Example:
"BLD",6229,1,207,0)
--------
"BLD",6229,1,208,0)
Select OPTION NAME: PSO BAI SUSPENDED     Bad Address Suspended List
"BLD",6229,1,209,0)
Bad Address Suspended List
"BLD",6229,1,210,0)
 
"BLD",6229,1,211,0)
This option shows unprinted suspended prescriptions for patients who have 
"BLD",6229,1,212,0)
the
"BLD",6229,1,213,0)
BAD ADDRESS INDICATOR set in the PATIENT file and no active temporary 
"BLD",6229,1,214,0)
address.
"BLD",6229,1,215,0)
 
"BLD",6229,1,216,0)
 
"BLD",6229,1,217,0)
Ending suspense date: T+3  (MAR 01, 2007)
"BLD",6229,1,218,0)
Outpatient Pharmacy software - Version 7.0
"BLD",6229,1,219,0)
 
"BLD",6229,1,220,0)
Division:    EXT  500  
"BLD",6229,1,221,0)
 
"BLD",6229,1,222,0)
          You are logged on under the EXT division.
"BLD",6229,1,223,0)
 
"BLD",6229,1,224,0)
Select LABEL PRINTER: HOME//   GENERIC INCOMING TELNET
"BLD",6229,1,225,0)
 
"BLD",6229,1,226,0)
OK to assume label alignment is correct? YES// 
"BLD",6229,1,227,0)
 
"BLD",6229,1,228,0)
Bingo Board Display: OUTPATIENT//   
"BLD",6229,1,229,0)
 
"BLD",6229,1,230,0)
   You are logged in under the EXT division.
"BLD",6229,1,231,0)
 
"BLD",6229,1,232,0)
Print only those Rx's suspended for this division? Yes// NO
"BLD",6229,1,233,0)
DEVICE: HOME//   GENERIC INCOMING TELNET
"BLD",6229,1,234,0)
 
"BLD",6229,1,235,0)
 
"BLD",6229,1,236,0)
Suspense bad address report - division = ALL                       PAGE: 1
"BLD",6229,1,237,0)
for suspense dates through MAR 01, 2007
"BLD",6229,1,238,0)
--------------------------------------------------------------------------
"BLD",6229,1,239,0)
 
"BLD",6229,1,240,0)
OPPATIENT,TEN   (00-0187)      
"BLD",6229,1,241,0)
MAR 01, 2007    Rx#: 301054     CIMETIDINE 200MG TAB
"BLD",6229,1,242,0)
MAR 01, 2007    Rx#: 301055     COAL TAR 5% GEL 3 OZ TUBE
"BLD",6229,1,243,0)
 
"BLD",6229,1,244,0)
OPPATIENT,FIVE   (00-0773)        
"BLD",6229,1,245,0)
FEB 27, 2007    Rx#: 100002655  BACITRACIN OINTMENT 1OZ
"BLD",6229,1,246,0)
 
"BLD",6229,1,247,0)
End of Report.
"BLD",6229,1,248,0)
Press Return to continue: 
"BLD",6229,1,249,0)
 
"BLD",6229,1,250,0)
4. As per the request of Computerized Patient Record System (CPRS)
"BLD",6229,1,251,0)
package the following were added to the Applications Program Interface
"BLD",6229,1,252,0)
(API) PSOHCSUM:
"BLD",6229,1,253,0)
   a. PLACER ORDER # field (#39.3) of the PRESCRIPTION file (#52).
"BLD",6229,1,254,0)
   b. Letter "R" when the original fill is returned to stock.
"BLD",6229,1,255,0)
For more details please see the IA (Integration Agreement) #330.
"BLD",6229,4,0)
^9.64PA^52^1
"BLD",6229,4,52,0)
52
"BLD",6229,4,52,2,0)
^9.641^52^1
"BLD",6229,4,52,2,52,0)
PRESCRIPTION  (File-top level)
"BLD",6229,4,52,2,52,1,0)
^9.6411^38.3^1
"BLD",6229,4,52,2,52,1,38.3,0)
FINISH DATE/TIME
"BLD",6229,4,52,222)
y^n^p^^^^n^^n
"BLD",6229,4,52,224)

"BLD",6229,4,"APDD",52,52)

"BLD",6229,4,"APDD",52,52,38.3)

"BLD",6229,4,"B",52,52)

"BLD",6229,6.3)
7
"BLD",6229,"KRN",0)
^9.67PA^8989.52^19
"BLD",6229,"KRN",.4,0)
.4
"BLD",6229,"KRN",.401,0)
.401
"BLD",6229,"KRN",.402,0)
.402
"BLD",6229,"KRN",.403,0)
.403
"BLD",6229,"KRN",.5,0)
.5
"BLD",6229,"KRN",.84,0)
.84
"BLD",6229,"KRN",3.6,0)
3.6
"BLD",6229,"KRN",3.8,0)
3.8
"BLD",6229,"KRN",9.2,0)
9.2
"BLD",6229,"KRN",9.8,0)
9.8
"BLD",6229,"KRN",9.8,"NM",0)
^9.68A^23^20
"BLD",6229,"KRN",9.8,"NM",1,0)
PSOHLDS1^^0^B48302679
"BLD",6229,"KRN",9.8,"NM",2,0)
PSOLLL1^^0^B67443546
"BLD",6229,"KRN",9.8,"NM",3,0)
PSOLLL3^^0^B7197716
"BLD",6229,"KRN",9.8,"NM",4,0)
PSOLLL5^^0^B37264779
"BLD",6229,"KRN",9.8,"NM",5,0)
PSOLLL7^^0^B34122114
"BLD",6229,"KRN",9.8,"NM",6,0)
PSOLLLH^^0^B33423186
"BLD",6229,"KRN",9.8,"NM",7,0)
PSOLLLI^^0^B65923392
"BLD",6229,"KRN",9.8,"NM",10,0)
PSOHLDS2^^0^B62771501
"BLD",6229,"KRN",9.8,"NM",12,0)
PSOLLL2^^0^B16255333
"BLD",6229,"KRN",9.8,"NM",13,0)
PSORN52C^^0^B49841543
"BLD",6229,"KRN",9.8,"NM",14,0)
PSOTALK^^0^B84758414
"BLD",6229,"KRN",9.8,"NM",15,0)
PSOTALK3^^0^B20856163
"BLD",6229,"KRN",9.8,"NM",16,0)
PSOBAIR2^^0^B25644262
"BLD",6229,"KRN",9.8,"NM",17,0)
PSODISP^^0^B55029655
"BLD",6229,"KRN",9.8,"NM",18,0)
PSODISPS^^0^B34175351
"BLD",6229,"KRN",9.8,"NM",19,0)
PSOHLDIS^^0^B67346410
"BLD",6229,"KRN",9.8,"NM",20,0)
PSOLLLHN^^0^B9199678
"BLD",6229,"KRN",9.8,"NM",21,0)
PSOSULBL^^0^B61486377
"BLD",6229,"KRN",9.8,"NM",22,0)
PSOHCSUM^^0^B24687274
"BLD",6229,"KRN",9.8,"NM",23,0)
PSOSULB1^^0^B25215096
"BLD",6229,"KRN",9.8,"NM","B","PSOBAIR2",16)

"BLD",6229,"KRN",9.8,"NM","B","PSODISP",17)

"BLD",6229,"KRN",9.8,"NM","B","PSODISPS",18)

"BLD",6229,"KRN",9.8,"NM","B","PSOHCSUM",22)

"BLD",6229,"KRN",9.8,"NM","B","PSOHLDIS",19)

"BLD",6229,"KRN",9.8,"NM","B","PSOHLDS1",1)

"BLD",6229,"KRN",9.8,"NM","B","PSOHLDS2",10)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLL1",2)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLL2",12)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLL3",3)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLL5",4)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLL7",5)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLLH",6)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLLHN",20)

"BLD",6229,"KRN",9.8,"NM","B","PSOLLLI",7)

"BLD",6229,"KRN",9.8,"NM","B","PSORN52C",13)

"BLD",6229,"KRN",9.8,"NM","B","PSOSULB1",23)

"BLD",6229,"KRN",9.8,"NM","B","PSOSULBL",21)

"BLD",6229,"KRN",9.8,"NM","B","PSOTALK",14)

"BLD",6229,"KRN",9.8,"NM","B","PSOTALK3",15)

"BLD",6229,"KRN",19,0)
19
"BLD",6229,"KRN",19,"NM",0)
^9.68A^^0
"BLD",6229,"KRN",19.1,0)
19.1
"BLD",6229,"KRN",101,0)
101
"BLD",6229,"KRN",101,"NM",0)
^9.68A^2^2
"BLD",6229,"KRN",101,"NM",1,0)
PSO HIDDEN ACTIONS #2^^2
"BLD",6229,"KRN",101,"NM",2,0)
PSO SPEED SIG LOG REPRINT^^0
"BLD",6229,"KRN",101,"NM","B","PSO HIDDEN ACTIONS #2",1)

"BLD",6229,"KRN",101,"NM","B","PSO SPEED SIG LOG REPRINT",2)

"BLD",6229,"KRN",409.61,0)
409.61
"BLD",6229,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",6229,"KRN",771,0)
771
"BLD",6229,"KRN",870,0)
870
"BLD",6229,"KRN",8989.51,0)
8989.51
"BLD",6229,"KRN",8989.52,0)
8989.52
"BLD",6229,"KRN",8994,0)
8994
"BLD",6229,"KRN","B",.4,.4)

"BLD",6229,"KRN","B",.401,.401)

"BLD",6229,"KRN","B",.402,.402)

"BLD",6229,"KRN","B",.403,.403)

"BLD",6229,"KRN","B",.5,.5)

"BLD",6229,"KRN","B",.84,.84)

"BLD",6229,"KRN","B",3.6,3.6)

"BLD",6229,"KRN","B",3.8,3.8)

"BLD",6229,"KRN","B",9.2,9.2)

"BLD",6229,"KRN","B",9.8,9.8)

"BLD",6229,"KRN","B",19,19)

"BLD",6229,"KRN","B",19.1,19.1)

"BLD",6229,"KRN","B",101,101)

"BLD",6229,"KRN","B",409.61,409.61)

"BLD",6229,"KRN","B",771,771)

"BLD",6229,"KRN","B",870,870)

"BLD",6229,"KRN","B",8989.51,8989.51)

"BLD",6229,"KRN","B",8989.52,8989.52)

"BLD",6229,"KRN","B",8994,8994)

"BLD",6229,"QUES",0)
^9.62^^
"BLD",6229,"REQB",0)
^9.611^6^6
"BLD",6229,"REQB",1,0)
PSO*7.0*211^2
"BLD",6229,"REQB",2,0)
PSO*7.0*233^2
"BLD",6229,"REQB",3,0)
PSO*7.0*247^2
"BLD",6229,"REQB",4,0)
PSO*7.0*255^2
"BLD",6229,"REQB",5,0)
PSO*7.0*259^2
"BLD",6229,"REQB",6,0)
PSO*7.0*214^2
"BLD",6229,"REQB","B","PSO*7.0*211",1)

"BLD",6229,"REQB","B","PSO*7.0*214",6)

"BLD",6229,"REQB","B","PSO*7.0*233",2)

"BLD",6229,"REQB","B","PSO*7.0*247",3)

"BLD",6229,"REQB","B","PSO*7.0*255",4)

"BLD",6229,"REQB","B","PSO*7.0*259",5)

"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^n^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,0,"VR")
7.0^PSO
"FIA",52,52)
1
"FIA",52,52,38.3)

"KRN",101,3824,-1)
2^1
"KRN",101,3824,0)
PSO HIDDEN ACTIONS #2^Outpatient Pharmacy Hidden Actions #2^^M^11843^^^^^^^141
"KRN",101,3824,10,0)
^101.01PA^25^25
"KRN",101,3824,10,25,0)
5608^RS^17^
"KRN",101,3824,10,25,"^")
PSO SPEED SIG LOG REPRINT
"KRN",101,5608,-1)
0^2
"KRN",101,5608,0)
PSO SPEED SIG LOG REPRINT^Reprint Sig Log^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,5608,2,0)
^101.02A^^0
"KRN",101,5608,20)
D ST^PSOLLLHN
"KRN",101,5608,99)
60682,57631
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
200^3070321
"PKG",141,22,1,"PAH",1,1,0)
^^255^255^3070321
"PKG",141,22,1,"PAH",1,1,1,0)
 This patch contains the FY 2007 Quarter 2 Outpatient Pharmacy V. 7.0
"PKG",141,22,1,"PAH",1,1,2,0)
enhancements. 
"PKG",141,22,1,"PAH",1,1,3,0)
 
"PKG",141,22,1,"PAH",1,1,4,0)
 
"PKG",141,22,1,"PAH",1,1,5,0)
***** NOTE TO SITES USING AUTOMATED FILLING EQUIPMENT *****
"PKG",141,22,1,"PAH",1,1,6,0)
Please ensure that your vendor is aware of the changes being made by this 
"PKG",141,22,1,"PAH",1,1,7,0)
patch. There are changes (described below) that affect both the HEALTH 
"PKG",141,22,1,"PAH",1,1,8,0)
LEVEL SEVEN (HL7) messages (content of fields only - no new fields are
"PKG",141,22,1,"PAH",1,1,9,0)
added) and the laser label stream.
"PKG",141,22,1,"PAH",1,1,10,0)
 
"PKG",141,22,1,"PAH",1,1,11,0)
If you are using automated dispensing equipment that relies on 
"PKG",141,22,1,"PAH",1,1,12,0)
the data stream sent to the laser labels port, you have 2 options:
"PKG",141,22,1,"PAH",1,1,13,0)
  1. Implement the Outpatient Automation Interface (OPAI) (available with
"PKG",141,22,1,"PAH",1,1,14,0)
     released patch PSO*7*156) or 
"PKG",141,22,1,"PAH",1,1,15,0)
  2. Contact your vendor to make adjustments based on the new data stream.
"PKG",141,22,1,"PAH",1,1,16,0)
 
"PKG",141,22,1,"PAH",1,1,17,0)
 
"PKG",141,22,1,"PAH",1,1,18,0)
Outpatient Pharmacy Automation Interface (OPAI) enhancements: 
"PKG",141,22,1,"PAH",1,1,19,0)
-------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,20,0)
1. Modified to use the new commercial warning label source to send the
"PKG",141,22,1,"PAH",1,1,21,0)
warning label text to the automated filling equipment. The OPAI WARNING
"PKG",141,22,1,"PAH",1,1,22,0)
LABEL SOURCE field (#16.2) in the PHARMACY SYSTEM file (#59.7) must be set
"PKG",141,22,1,"PAH",1,1,23,0)
to "N" for "New" to send the warning labels from the new commercial data
"PKG",141,22,1,"PAH",1,1,24,0)
source to OPAI. It can be set by using the Pharmacy System Parameters Edit
"PKG",141,22,1,"PAH",1,1,25,0)
[PSS SYS EDIT] option.
"PKG",141,22,1,"PAH",1,1,26,0)
 Example:
"PKG",141,22,1,"PAH",1,1,27,0)
 
"PKG",141,22,1,"PAH",1,1,28,0)
Select OPTION NAME: PSS SYS EDIT       Pharmacy System Parameters Edit
"PKG",141,22,1,"PAH",1,1,29,0)
Pharmacy System Parameters Edit
"PKG",141,22,1,"PAH",1,1,30,0)
 
"PKG",141,22,1,"PAH",1,1,31,0)
PMIS PRINTER: L8150$PRT// 
"PKG",141,22,1,"PAH",1,1,32,0)
PMIS LANGUAGE: English// 
"PKG",141,22,1,"PAH",1,1,33,0)
WARNING LABEL SOURCE: NEW// 
"PKG",141,22,1,"PAH",1,1,34,0)
CMOP WARNING LABEL SOURCE: NEW//
"PKG",141,22,1,"PAH",1,1,35,0)
OPAI WARNING LABEL SOURCE: ?
"PKG",141,22,1,"PAH",1,1,36,0)
     Enter "N" for NEW to use commercial data source for OPAI warning 
"PKG",141,22,1,"PAH",1,1,37,0)
labels.
"PKG",141,22,1,"PAH",1,1,38,0)
     Choose from: 
"PKG",141,22,1,"PAH",1,1,39,0)
       N        NEW
"PKG",141,22,1,"PAH",1,1,40,0)
OPAI WARNING LABEL SOURCE: N  NEW
"PKG",141,22,1,"PAH",1,1,41,0)
 
"PKG",141,22,1,"PAH",1,1,42,0)
   a. The warning text is sent as one record per warning.
"PKG",141,22,1,"PAH",1,1,43,0)
   b. The text is sent in English or Spanish depending on the patient's
"PKG",141,22,1,"PAH",1,1,44,0)
      other language settings. 
"PKG",141,22,1,"PAH",1,1,45,0)
   c. If the DEA, SPECIAL HDLG field (#3) in the DRUG file (#50) begins
"PKG",141,22,1,"PAH",1,1,46,0)
      with numbers 1,2,3,4, or 5, the NO TRANSFER warning text from the RX
"PKG",141,22,1,"PAH",1,1,47,0)
      CONSULT file (#54) entry number 20 is automatically sent as one of
"PKG",141,22,1,"PAH",1,1,48,0)
      the first 5 warnings when the OPAI WARNING LABEL SOURCE is set to 
"PKG",141,22,1,"PAH",1,1,49,0)
      "New".
"PKG",141,22,1,"PAH",1,1,50,0)
 
"PKG",141,22,1,"PAH",1,1,51,0)
 
"PKG",141,22,1,"PAH",1,1,52,0)
2. If the BAD ADDRESS INDICATOR (BAI) field (#.121) of the PATIENT file
"PKG",141,22,1,"PAH",1,1,53,0)
(#2) is set and the routing is WINDOW, the text "VAB" concatenated with
"PKG",141,22,1,"PAH",1,1,54,0)
the BAI code is sent in the Address field of the PID segment of the HL7
"PKG",141,22,1,"PAH",1,1,55,0)
message to the filling equipment.
"PKG",141,22,1,"PAH",1,1,56,0)
 
"PKG",141,22,1,"PAH",1,1,57,0)
Here are some examples of this field:
"PKG",141,22,1,"PAH",1,1,58,0)
 
"PKG",141,22,1,"PAH",1,1,59,0)
When the permanent address is active:
"PKG",141,22,1,"PAH",1,1,60,0)
PADD-1~PADD-2~SPRING~TX~77379~~P~PADD-3~201^~~""~""~~~N|""|||||||
"PKG",141,22,1,"PAH",1,1,61,0)
|
"PKG",141,22,1,"PAH",1,1,62,0)
 
"PKG",141,22,1,"PAH",1,1,63,0)
When the temporary address is active:
"PKG",141,22,1,"PAH",1,1,64,0)
PADD-1~PADD-2~SPRING~TX~77379~~P~PADD-3~201^~~""~""~~~N^TADD-1~TADD-2 
"PKG",141,22,1,"PAH",1,1,65,0)
TADD-3~PLANO~TX~12345~~C~~""~~~
"PKG",141,22,1,"PAH",1,1,66,0)
^HL(772,10388,"IN",2,0)=20070223&""|""|||||||||
"PKG",141,22,1,"PAH",1,1,67,0)
 
"PKG",141,22,1,"PAH",1,1,68,0)
When the address is flagged as BAI:
"PKG",141,22,1,"PAH",1,1,69,0)
PADD-1~PADD-2~SPRING~TX~77379~~VAB1~PADD-3~201^~~""~""~~~N|""||||||
"PKG",141,22,1,"PAH",1,1,70,0)
|||
"PKG",141,22,1,"PAH",1,1,71,0)
 
"PKG",141,22,1,"PAH",1,1,72,0)
"VAB1" - indicates Bad Address Indicator and 1 is for UNDELIVERABLE (2 for
"PKG",141,22,1,"PAH",1,1,73,0)
HOMELESS, 3 for OTHER)
"PKG",141,22,1,"PAH",1,1,74,0)
 
"PKG",141,22,1,"PAH",1,1,75,0)
 
"PKG",141,22,1,"PAH",1,1,76,0)
Laser Label enhancements:
"PKG",141,22,1,"PAH",1,1,77,0)
-------------------------
"PKG",141,22,1,"PAH",1,1,78,0)
1. Print the last 4 digits of the Social Security Number (SSN) instead of
"PKG",141,22,1,"PAH",1,1,79,0)
the last 6 digits.
"PKG",141,22,1,"PAH",1,1,80,0)
 
"PKG",141,22,1,"PAH",1,1,81,0)
2. Change the name on the mailing label back to Last name,First name
"PKG",141,22,1,"PAH",1,1,82,0)
format.
"PKG",141,22,1,"PAH",1,1,83,0)
 
"PKG",141,22,1,"PAH",1,1,84,0)
3. On the Pharmacy Fill Card portion of the label, replace the text 
"PKG",141,22,1,"PAH",1,1,85,0)
"Mfr ___________________" with:
"PKG",141,22,1,"PAH",1,1,86,0)
   a. NDC/MFR_______________ for non-ePharmacy sites
"PKG",141,22,1,"PAH",1,1,87,0)
   b. NDC nnnnn-nnnn-nn for ePharmacy sites 
"PKG",141,22,1,"PAH",1,1,88,0)
 
"PKG",141,22,1,"PAH",1,1,89,0)
4. Signature log enhancements:
"PKG",141,22,1,"PAH",1,1,90,0)
   a. Print current date at top
"PKG",141,22,1,"PAH",1,1,91,0)
   b. Do not print user name (if more than 1 prescription was included to
"PKG",141,22,1,"PAH",1,1,92,0)
      be signed, the user name could be different for each one).
"PKG",141,22,1,"PAH",1,1,93,0)
   c. Correct the spacing and continuation paging issues if one or more 
"PKG",141,22,1,"PAH",1,1,94,0)
      of the prescriptions has been discontinued before printing the 
"PKG",141,22,1,"PAH",1,1,95,0)
      signature log.
"PKG",141,22,1,"PAH",1,1,96,0)
   d. Add a barcode to enable scanning to remove the patient's name from 
"PKG",141,22,1,"PAH",1,1,97,0)
      the Bingo Board.
"PKG",141,22,1,"PAH",1,1,98,0)
   e. Add as much of the drug name as will fit on the label.
"PKG",141,22,1,"PAH",1,1,99,0)
   f. Add hidden action "RS" for Reprint Signature log to the prescription
"PKG",141,22,1,"PAH",1,1,100,0)
      profile screen.
"PKG",141,22,1,"PAH",1,1,101,0)
   g. While printing original labels (not reprint of the signature log), 
"PKG",141,22,1,"PAH",1,1,102,0)
      if all of the fills have a routing of mail, the signature log will
"PKG",141,22,1,"PAH",1,1,103,0)
      not be printed.
"PKG",141,22,1,"PAH",1,1,104,0)
   h. The line "Relationship_________________ Counseled? _____" is changed
"PKG",141,22,1,"PAH",1,1,105,0)
      to "Relation_____ Counseling Refused__ Accepted__".
"PKG",141,22,1,"PAH",1,1,106,0)
 
"PKG",141,22,1,"PAH",1,1,107,0)
 
"PKG",141,22,1,"PAH",1,1,108,0)
5. When a fill is released, if the BAI is no longer set or there is an 
"PKG",141,22,1,"PAH",1,1,109,0)
active temporary address, the "B" is removed from the status column of 
"PKG",141,22,1,"PAH",1,1,110,0)
the patient profile. (This is removed by making an additional entry in 
"PKG",141,22,1,"PAH",1,1,111,0)
the label log. The "B" comes from the "last" entry having a bad address 
"PKG",141,22,1,"PAH",1,1,112,0)
condition at the time the label printed).
"PKG",141,22,1,"PAH",1,1,113,0)
 
"PKG",141,22,1,"PAH",1,1,114,0)
 
"PKG",141,22,1,"PAH",1,1,115,0)
 
"PKG",141,22,1,"PAH",1,1,116,0)
To address E3R 19820, the following code changes are included in this 
"PKG",141,22,1,"PAH",1,1,117,0)
patch:
"PKG",141,22,1,"PAH",1,1,118,0)
 
"PKG",141,22,1,"PAH",1,1,119,0)
1. Add the capability to tie a ScripTalk printer to regular Pharmacy
"PKG",141,22,1,"PAH",1,1,120,0)
label printer(s) to control where the ScripTalk labels print for
"PKG",141,22,1,"PAH",1,1,121,0)
multi-divisional sites. The new SCRIPTALK PRINT DEVICE MAPPING multiple
"PKG",141,22,1,"PAH",1,1,122,0)
(#47) in PHARMACY SYSTEM file (#59.7) has been created to store this
"PKG",141,22,1,"PAH",1,1,123,0)
information in Pharmacy Data Management patch PSS*1*122. The multiple
"PKG",141,22,1,"PAH",1,1,124,0)
contains PRINTER TO BE MAPPED field (#.01) and SCRIPTALK DEVICE field
"PKG",141,22,1,"PAH",1,1,125,0)
(#.02).
"PKG",141,22,1,"PAH",1,1,126,0)
 
"PKG",141,22,1,"PAH",1,1,127,0)
The added functionality works in conjunction with the existing ScripTalk 
"PKG",141,22,1,"PAH",1,1,128,0)
divisional functionality, so a divisional ScripTalk device must be
"PKG",141,22,1,"PAH",1,1,129,0)
defined.  If no mapping is defined in the new fields, ScripTalk labels
"PKG",141,22,1,"PAH",1,1,130,0)
will continue to print on the printer defined for the division.  If
"PKG",141,22,1,"PAH",1,1,131,0)
a pharmacy printer is mapped to a ScripTalk printer, the ScripTalk label
"PKG",141,22,1,"PAH",1,1,132,0)
will automatically be printed on the mapped ScripTalk printer.
"PKG",141,22,1,"PAH",1,1,133,0)
 
"PKG",141,22,1,"PAH",1,1,134,0)
 
"PKG",141,22,1,"PAH",1,1,135,0)
2. Modify the ScripTalk Device Definition Enter/Edit [PSO SCRIPTALK
"PKG",141,22,1,"PAH",1,1,136,0)
DEVICE DEF'N] option to allow definition of printer mapping for 
"PKG",141,22,1,"PAH",1,1,137,0)
ScripTalk devices.  The user will be prompted to define the ScripTalk 
"PKG",141,22,1,"PAH",1,1,138,0)
printer by division or by printer mapping.  After selecting D for 
"PKG",141,22,1,"PAH",1,1,139,0)
division, the divisional definition has not changed.  After selecting 
"PKG",141,22,1,"PAH",1,1,140,0)
P for printer mapping, the user will be prompted "LABEL PRINTER TO BE
"PKG",141,22,1,"PAH",1,1,141,0)
MAPPED". The device entered into this field corresponds to the label
"PKG",141,22,1,"PAH",1,1,142,0)
printer selected during Pharmacy login and/or the printer selected during
"PKG",141,22,1,"PAH",1,1,143,0)
print from suspense functions. Next, "SCRIPTALK DEVICE" will be prompted,
"PKG",141,22,1,"PAH",1,1,144,0)
and this field should contain the ScripTalk printer to be mapped to the
"PKG",141,22,1,"PAH",1,1,145,0)
regular label printer.
"PKG",141,22,1,"PAH",1,1,146,0)
 
"PKG",141,22,1,"PAH",1,1,147,0)
 
"PKG",141,22,1,"PAH",1,1,148,0)
MISCELLANEOUS ENHANCEMENTS:
"PKG",141,22,1,"PAH",1,1,149,0)
---------------------------
"PKG",141,22,1,"PAH",1,1,150,0)
1. A new field FINISH DATE/TIME field (#38.3) is added to the
"PKG",141,22,1,"PAH",1,1,151,0)
PRESCRIPTION file (#52).
"PKG",141,22,1,"PAH",1,1,152,0)
 
"PKG",141,22,1,"PAH",1,1,153,0)
2. When using the Print from Suspense File [PSO PNDLBL] option, if the
"PKG",141,22,1,"PAH",1,1,154,0)
routing is not WINDOW and the BAD ADDRESS INDICATOR (#.121) field of the
"PKG",141,22,1,"PAH",1,1,155,0)
PATIENT file (#2) is set (value of 1=UNDELIVERABLE, 2=HOMELESS, 3=OTHER)
"PKG",141,22,1,"PAH",1,1,156,0)
and the patient does not have an active temporary address, the
"PKG",141,22,1,"PAH",1,1,157,0)
prescription fill will not be sent to automated filling equipment and/or
"PKG",141,22,1,"PAH",1,1,158,0)
to the label printer. Also, if the fill's routing is mail and the 
"PKG",141,22,1,"PAH",1,1,159,0)
patient's MAIL field (#.03) in the PHARMACY PATIENT file (#55) is set to
"PKG",141,22,1,"PAH",1,1,160,0)
"DO NOT MAIL" and the current date is before the MAIL STATUS EXPIRATION
"PKG",141,22,1,"PAH",1,1,161,0)
DATE field (#.05) in the PHARMACY PATIENT file (#55), the label will not
"PKG",141,22,1,"PAH",1,1,162,0)
print and the fill will not be sent to the automated filling equipment.
"PKG",141,22,1,"PAH",1,1,163,0)
 
"PKG",141,22,1,"PAH",1,1,164,0)
The first time a prescription is not sent/label printed, a MailMan message
"PKG",141,22,1,"PAH",1,1,165,0)
will be generated to the user who queued the print from suspense and the
"PKG",141,22,1,"PAH",1,1,166,0)
members of the PSO EXTERNAL DISPENSE ALERTS mail group. An entry will also
"PKG",141,22,1,"PAH",1,1,167,0)
be set in the PRESCRIPTION file (#52) activity log.
"PKG",141,22,1,"PAH",1,1,168,0)
 
"PKG",141,22,1,"PAH",1,1,169,0)
Example activity log entry:
"PKG",141,22,1,"PAH",1,1,170,0)
---------------------------
"PKG",141,22,1,"PAH",1,1,171,0)
Activity Log:
"PKG",141,22,1,"PAH",1,1,172,0)
#   Date        Reason         Rx Ref           Initiator Of Activity
"PKG",141,22,1,"PAH",1,1,173,0)
=====================================================================
"PKG",141,22,1,"PAH",1,1,174,0)
1   02/19/07    SUSPENSE       ORIGINAL         OPPHARMACIST,ONE
"PKG",141,22,1,"PAH",1,1,175,0)
Comments: RX not printed from suspense due to BAD ADDRESS INDICATOR
"PKG",141,22,1,"PAH",1,1,176,0)
 
"PKG",141,22,1,"PAH",1,1,177,0)
- or -
"PKG",141,22,1,"PAH",1,1,178,0)
Comments: RX not printed from suspense due to DO NOT MAIL
"PKG",141,22,1,"PAH",1,1,179,0)
 
"PKG",141,22,1,"PAH",1,1,180,0)
Example MailMan message:
"PKG",141,22,1,"PAH",1,1,181,0)
------------------------
"PKG",141,22,1,"PAH",1,1,182,0)
Subj: 500 BAD ADDRESS SUSPENSE NOT PRINTED  [#169828] 02/26/07@07:30  11
"PKG",141,22,1,"PAH",1,1,183,0)
lines
"PKG",141,22,1,"PAH",1,1,184,0)
From: OUTPATIENT PHARMACY PACKAGE  In 'IN' basket.   Page 1
"PKG",141,22,1,"PAH",1,1,185,0)
--------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,186,0)
-----
"PKG",141,22,1,"PAH",1,1,187,0)
The following prescriptions with a routing of mail were not printed/sent 
"PKG",141,22,1,"PAH",1,1,188,0)
to
"PKG",141,22,1,"PAH",1,1,189,0)
external interface due to the BAD ADDRESS INDICATOR being set and no 
"PKG",141,22,1,"PAH",1,1,190,0)
active
"PKG",141,22,1,"PAH",1,1,191,0)
temporary address or patient has an active MAIL status of DO NOT MAIL:
"PKG",141,22,1,"PAH",1,1,192,0)
 
"PKG",141,22,1,"PAH",1,1,193,0)
OPPATIENT,ONE   000001234   (BAD ADDRESS INDICATOR)
"PKG",141,22,1,"PAH",1,1,194,0)
  100002608  (1)  A AND Z OINTMENT
"PKG",141,22,1,"PAH",1,1,195,0)
  100002609  (0)  ASPIRIN 325MG TABS
"PKG",141,22,1,"PAH",1,1,196,0)
 
"PKG",141,22,1,"PAH",1,1,197,0)
OPPATIENT,FOUR   000004321   (DO NOT MAIL)
"PKG",141,22,1,"PAH",1,1,198,0)
  100002654A  (0)  BACITRACIN OINTMENT 1OZ
"PKG",141,22,1,"PAH",1,1,199,0)
 
"PKG",141,22,1,"PAH",1,1,200,0)
 
"PKG",141,22,1,"PAH",1,1,201,0)
3. Modify the report from the Bad Address Suspended List [PSO BAI 
"PKG",141,22,1,"PAH",1,1,202,0)
SUSPENDED] option to allow printing by more than one division and also 
"PKG",141,22,1,"PAH",1,1,203,0)
include prescriptions suspended for Consolidated Mail Outpatient Pharmacy 
"PKG",141,22,1,"PAH",1,1,204,0)
(CMOP). This report was also changed to not prompt for a start date.
"PKG",141,22,1,"PAH",1,1,205,0)
 
"PKG",141,22,1,"PAH",1,1,206,0)
Example:
"PKG",141,22,1,"PAH",1,1,207,0)
--------
"PKG",141,22,1,"PAH",1,1,208,0)
Select OPTION NAME: PSO BAI SUSPENDED     Bad Address Suspended List
"PKG",141,22,1,"PAH",1,1,209,0)
Bad Address Suspended List
"PKG",141,22,1,"PAH",1,1,210,0)
 
"PKG",141,22,1,"PAH",1,1,211,0)
This option shows unprinted suspended prescriptions for patients who have 
"PKG",141,22,1,"PAH",1,1,212,0)
the
"PKG",141,22,1,"PAH",1,1,213,0)
BAD ADDRESS INDICATOR set in the PATIENT file and no active temporary 
"PKG",141,22,1,"PAH",1,1,214,0)
address.
"PKG",141,22,1,"PAH",1,1,215,0)
 
"PKG",141,22,1,"PAH",1,1,216,0)
 
"PKG",141,22,1,"PAH",1,1,217,0)
Ending suspense date: T+3  (MAR 01, 2007)
"PKG",141,22,1,"PAH",1,1,218,0)
Outpatient Pharmacy software - Version 7.0
"PKG",141,22,1,"PAH",1,1,219,0)
 
"PKG",141,22,1,"PAH",1,1,220,0)
Division:    EXT  500  
"PKG",141,22,1,"PAH",1,1,221,0)
 
"PKG",141,22,1,"PAH",1,1,222,0)
          You are logged on under the EXT division.
"PKG",141,22,1,"PAH",1,1,223,0)
 
"PKG",141,22,1,"PAH",1,1,224,0)
Select LABEL PRINTER: HOME//   GENERIC INCOMING TELNET
"PKG",141,22,1,"PAH",1,1,225,0)
 
"PKG",141,22,1,"PAH",1,1,226,0)
OK to assume label alignment is correct? YES// 
"PKG",141,22,1,"PAH",1,1,227,0)
 
"PKG",141,22,1,"PAH",1,1,228,0)
Bingo Board Display: OUTPATIENT//   
"PKG",141,22,1,"PAH",1,1,229,0)
 
"PKG",141,22,1,"PAH",1,1,230,0)
   You are logged in under the EXT division.
"PKG",141,22,1,"PAH",1,1,231,0)
 
"PKG",141,22,1,"PAH",1,1,232,0)
Print only those Rx's suspended for this division? Yes// NO
"PKG",141,22,1,"PAH",1,1,233,0)
DEVICE: HOME//   GENERIC INCOMING TELNET
"PKG",141,22,1,"PAH",1,1,234,0)
 
"PKG",141,22,1,"PAH",1,1,235,0)
 
"PKG",141,22,1,"PAH",1,1,236,0)
Suspense bad address report - division = ALL                       PAGE: 1
"PKG",141,22,1,"PAH",1,1,237,0)
for suspense dates through MAR 01, 2007
"PKG",141,22,1,"PAH",1,1,238,0)
--------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,239,0)
 
"PKG",141,22,1,"PAH",1,1,240,0)
OPPATIENT,TEN   (00-0187)      
"PKG",141,22,1,"PAH",1,1,241,0)
MAR 01, 2007    Rx#: 301054     CIMETIDINE 200MG TAB
"PKG",141,22,1,"PAH",1,1,242,0)
MAR 01, 2007    Rx#: 301055     COAL TAR 5% GEL 3 OZ TUBE
"PKG",141,22,1,"PAH",1,1,243,0)
 
"PKG",141,22,1,"PAH",1,1,244,0)
OPPATIENT,FIVE   (00-0773)        
"PKG",141,22,1,"PAH",1,1,245,0)
FEB 27, 2007    Rx#: 100002655  BACITRACIN OINTMENT 1OZ
"PKG",141,22,1,"PAH",1,1,246,0)
 
"PKG",141,22,1,"PAH",1,1,247,0)
End of Report.
"PKG",141,22,1,"PAH",1,1,248,0)
Press Return to continue: 
"PKG",141,22,1,"PAH",1,1,249,0)
 
"PKG",141,22,1,"PAH",1,1,250,0)
4. As per the request of Computerized Patient Record System (CPRS)
"PKG",141,22,1,"PAH",1,1,251,0)
package the following were added to the Applications Program Interface
"PKG",141,22,1,"PAH",1,1,252,0)
(API) PSOHCSUM:
"PKG",141,22,1,"PAH",1,1,253,0)
   a. PLACER ORDER # field (#39.3) of the PRESCRIPTION file (#52).
"PKG",141,22,1,"PAH",1,1,254,0)
   b. Letter "R" when the original fill is returned to stock.
"PKG",141,22,1,"PAH",1,1,255,0)
For more details please see the IA (Integration Agreement) #330.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
20
"RTN","PSOBAIR2")
0^16^B25644262^B20289266
"RTN","PSOBAIR2",1,0)
PSOBAIR2 ;BIR/RTR-Report of suspended prescriptions with bad address ;08/16/2006
"RTN","PSOBAIR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**233,200**;DEC 1997;Build 7
"RTN","PSOBAIR2",3,0)
 ;
"RTN","PSOBAIR2",4,0)
EN ;
"RTN","PSOBAIR2",5,0)
 N PSOAPAT,PSOSDT,PSOEDT,PSOSDTX,PSOEDTX,X,Y,X1,X2,PSUSDIV,PII,PSOCNT
"RTN","PSOBAIR2",6,0)
 W !!,"This option shows unprinted suspended prescriptions for patients who have the"
"RTN","PSOBAIR2",7,0)
 W !,"BAD ADDRESS INDICATOR set in the PATIENT file and no active temporary address.",!
"RTN","PSOBAIR2",8,0)
DATE ;
"RTN","PSOBAIR2",9,0)
 W ! S %DT="AEX",%DT("A")="Ending suspense date: " D ^%DT K %DT I Y<0!($D(DTOUT))!($D(DUOUT)) D MESS Q
"RTN","PSOBAIR2",10,0)
 S PSOEDT=Y D DD^%DT S PSOEDTX=Y
"RTN","PSOBAIR2",11,0)
 S X1=PSOEDT,X2=+1 D C^%DTC S PSOEDT=X
"RTN","PSOBAIR2",12,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MESS Q
"RTN","PSOBAIR2",13,0)
 S PSOCNT=0 F PII=0:0 S PII=$O(^PS(59,PII)) Q:'PII  S PSOCNT=PSOCNT+1
"RTN","PSOBAIR2",14,0)
 I PSOCNT=1 G SKIP
"RTN","PSOBAIR2",15,0)
 W !!?3,"You are logged in under the "_$P($G(^PS(59,+$G(PSOSITE),0)),"^")_" division.",!
"RTN","PSOBAIR2",16,0)
 K DIR S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Print only those Rx's suspended for this division",DIR("?")="Enter 'Yes' to print only those Rx's for this division, enter 'No' to print Rx's suspended for all divisions."
"RTN","PSOBAIR2",17,0)
 D ^DIR K DIR I Y["^"!($D(DIRUT)) D MESS Q
"RTN","PSOBAIR2",18,0)
 S PSUSDIV=Y
"RTN","PSOBAIR2",19,0)
SKIP ;
"RTN","PSOBAIR2",20,0)
 K IOP,%ZIS,POP S %ZIS="QM" D ^%ZIS I $G(POP) D MESS Q
"RTN","PSOBAIR2",21,0)
 I $D(IO("Q")) D  Q
"RTN","PSOBAIR2",22,0)
 .N GG
"RTN","PSOBAIR2",23,0)
 .S ZTRTN="REP^PSOBAIR2",ZTDESC="Pharmacy bad address suspense report" D
"RTN","PSOBAIR2",24,0)
 ..F GG="PSOSITE","PSOAPAT","PSOSDT","PSOEDT","PSOEDTX","PSOSDTX","PSUSDIV" S:$D(@GG) ZTSAVE(GG)=""
"RTN","PSOBAIR2",25,0)
 ..D ^%ZTLOAD K %ZIS
"RTN","PSOBAIR2",26,0)
 .W !!,"Report queued to print.",!
"RTN","PSOBAIR2",27,0)
REP ;
"RTN","PSOBAIR2",28,0)
 K ^TMP("PSOBADL",$J)
"RTN","PSOBAIR2",29,0)
 N PSODEV,PSOUT,PSOLINE,PSOPAGE,PSOADND,PSOADF,PSOADFF,PSOAOPT,PSOAOPTA,PSOAOPTZ,PSOAOPTB,PSOAOPTC,PSOADLP,PSOANODE,PSOADX,SFN,PSOADATE,PSOC,PSOAALL,PSODFN,PSOANAME,PSONI,PSONX,PSONB,PSOASN,VA,DFN,PSONSSN,PSOAFLAG
"RTN","PSOBAIR2",30,0)
 U IO
"RTN","PSOBAIR2",31,0)
 S (PSOUT,PSOAFLAG)=0,PSODEV=$S($E(IOST,1,2)'="C-":0,1:1),PSOPAGE=1
"RTN","PSOBAIR2",32,0)
 S $P(PSOLINE,"-",78)=""
"RTN","PSOBAIR2",33,0)
ALL ;
"RTN","PSOBAIR2",34,0)
 N PSORD,SFN,PSOLBL,PSOX,PSODFN,RXIEN,PRINTED,RXSITE,RXSTS,PARTIAL
"RTN","PSOBAIR2",35,0)
 S PSODFN=0 F  S PSODFN=$O(^PS(52.5,"AC",PSODFN)) Q:'PSODFN  D
"RTN","PSOBAIR2",36,0)
 .S PSOBAI=0 D CHKADDR I 'PSOBAI Q
"RTN","PSOBAIR2",37,0)
 .S PSORD=0 F  S PSORD=$O(^PS(52.5,"AC",PSODFN,PSORD)) Q:'PSORD!(PSORD>PSOEDT)  D
"RTN","PSOBAIR2",38,0)
 ..S SFN=0 F  S SFN=$O(^PS(52.5,"AC",PSODFN,PSORD,SFN)) Q:'SFN  D DETAIL
"RTN","PSOBAIR2",39,0)
 S PSODFN=0 F  S PSODFN=$O(^PS(52.5,"AG",PSODFN)) Q:'PSODFN  D
"RTN","PSOBAIR2",40,0)
 .S PSOBAI=0 D CHKADDR I 'PSOBAI Q
"RTN","PSOBAIR2",41,0)
 .S SFN=0 F  S SFN=$O(^PS(52.5,"AG",PSODFN,SFN)) Q:'SFN  D
"RTN","PSOBAIR2",42,0)
 ..S PSORD=$G(^PS(52.5,SFN,0)),PSORD=$P(PSORD,"^",2) I PSORD<PSOEDT D DETAIL
"RTN","PSOBAIR2",43,0)
 D HD
"RTN","PSOBAIR2",44,0)
 I '$D(^TMP("PSOBADL",$J)) W !!,"No data found to print for this date range.",! G END
"RTN","PSOBAIR2",45,0)
 S PSONI="" F  S PSONI=$O(^TMP("PSOBADL",$J,PSONI)) Q:PSONI=""!(PSOUT)  D
"RTN","PSOBAIR2",46,0)
 .S PSONX="" F  S PSONX=$O(^TMP("PSOBADL",$J,PSONI,PSONX)) Q:PSONX=""!(PSOUT)  D NAME,PRALL D
"RTN","PSOBAIR2",47,0)
 ..S PSONB="" F  S PSONB=$O(^TMP("PSOBADL",$J,PSONI,PSONX,PSONB)) Q:PSONB=""!(PSOUT)  D
"RTN","PSOBAIR2",48,0)
 ...S SFN="" F  S SFN=$O(^TMP("PSOBADL",$J,PSONI,PSONX,PSONB,SFN)) Q:SFN=""!(PSOUT)  D
"RTN","PSOBAIR2",49,0)
 ....I ($Y+5)>IOSL D HD Q:PSOUT
"RTN","PSOBAIR2",50,0)
 ....S Y=PSONB D DD^%DT S PSOADATE=Y
"RTN","PSOBAIR2",51,0)
 ....D PRONE
"RTN","PSOBAIR2",52,0)
END ;
"RTN","PSOBAIR2",53,0)
 K ^TMP("PSOBADL",$J)
"RTN","PSOBAIR2",54,0)
 K DTOUT,DUOUT,PSOBAI
"RTN","PSOBAIR2",55,0)
 I '$G(PSOUT),PSODEV W !!,"End of Report." K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOBAIR2",56,0)
 I 'PSODEV W !!,"End of Report."
"RTN","PSOBAIR2",57,0)
 I PSODEV W !
"RTN","PSOBAIR2",58,0)
 E  W @IOF
"RTN","PSOBAIR2",59,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOBAIR2",60,0)
 Q
"RTN","PSOBAIR2",61,0)
HD ;
"RTN","PSOBAIR2",62,0)
 S PSOAFLAG=1
"RTN","PSOBAIR2",63,0)
 I PSODEV,PSOPAGE'=1 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue, '^' to exit" D ^DIR K DIR I 'Y S PSOUT=1 Q
"RTN","PSOBAIR2",64,0)
 I PSOPAGE=1,'PSODEV W ! I 1
"RTN","PSOBAIR2",65,0)
 E  W @IOF
"RTN","PSOBAIR2",66,0)
 D  W ?67,"PAGE: "_PSOPAGE S PSOPAGE=PSOPAGE+1
"RTN","PSOBAIR2",67,0)
 .W !,"Suspense bad address report - division = ",$S($G(PSUSDIV):$P($G(^PS(59,+$G(PSOSITE),0)),"^"),1:"ALL")
"RTN","PSOBAIR2",68,0)
 W !,"for suspense dates through "_$G(PSOEDTX)
"RTN","PSOBAIR2",69,0)
 W !,PSOLINE
"RTN","PSOBAIR2",70,0)
 Q
"RTN","PSOBAIR2",71,0)
MESS ;
"RTN","PSOBAIR2",72,0)
 W !!,"Nothing queued to print.",!
"RTN","PSOBAIR2",73,0)
 K DTOUT,DUOUT
"RTN","PSOBAIR2",74,0)
 Q
"RTN","PSOBAIR2",75,0)
NAME ;Set name(ssn)
"RTN","PSOBAIR2",76,0)
 K VA S DFN=PSONX D PID^VADPT6
"RTN","PSOBAIR2",77,0)
 S PSONSSN=$G(PSONI)_"   ("_$E(VA("PID"),5,12)_")"
"RTN","PSOBAIR2",78,0)
 K VA
"RTN","PSOBAIR2",79,0)
 Q
"RTN","PSOBAIR2",80,0)
PRALL ;Print data for all patients
"RTN","PSOBAIR2",81,0)
 N PSOADDR
"RTN","PSOBAIR2",82,0)
 S PSOADDR=""
"RTN","PSOBAIR2",83,0)
 S PSOAFLAG=0
"RTN","PSOBAIR2",84,0)
 W !!,$G(PSONSSN) D CHKADDR W ?30,"  ",PSOADDR I ($Y+5)>IOSL D HD Q:PSOUT
"RTN","PSOBAIR2",85,0)
 Q
"RTN","PSOBAIR2",86,0)
PRONE ;Print data for one patient
"RTN","PSOBAIR2",87,0)
 N SFN0
"RTN","PSOBAIR2",88,0)
 S SFN0=$G(^PSRX(SFN,0)) I SFN0=""!($P(SFN0,"^",6)="") Q
"RTN","PSOBAIR2",89,0)
 D CON W !,$G(PSOADATE),?15," Rx#: ",$P(SFN0,"^"),?30,"  ",$P($G(^PSDRUG($P(SFN0,"^",6),0)),"^")
"RTN","PSOBAIR2",90,0)
 I ($Y+5)>IOSL D HD Q:PSOUT
"RTN","PSOBAIR2",91,0)
 Q
"RTN","PSOBAIR2",92,0)
CON ;
"RTN","PSOBAIR2",93,0)
 I PSOAFLAG W !,$G(PSONSSN) S PSOAFLAG=0
"RTN","PSOBAIR2",94,0)
 Q
"RTN","PSOBAIR2",95,0)
 ;
"RTN","PSOBAIR2",96,0)
CHKADDR ;
"RTN","PSOBAIR2",97,0)
 N PSOBADR,PSOTEMP
"RTN","PSOBAIR2",98,0)
 S PSOBADR=$$BADADR^DGUTL3(PSODFN)
"RTN","PSOBAIR2",99,0)
 I PSOBADR D
"RTN","PSOBAIR2",100,0)
 .S PSOTEMP=$$CHKTEMP^PSOBAI(PSODFN)
"RTN","PSOBAIR2",101,0)
 I PSOBADR,'PSOTEMP S PSOBAI=1 Q
"RTN","PSOBAIR2",102,0)
 Q
"RTN","PSOBAIR2",103,0)
 ;
"RTN","PSOBAIR2",104,0)
DETAIL ;
"RTN","PSOBAIR2",105,0)
 I '$D(^PS(52.5,SFN,0))!'$D(^DPT(+PSODFN,0)) Q
"RTN","PSOBAIR2",106,0)
 S RXIEN=+$$GET1^DIQ(52.5,SFN,.01,"I")
"RTN","PSOBAIR2",107,0)
 S RXSITE=+$$GET1^DIQ(52.5,SFN,.06,"I")
"RTN","PSOBAIR2",108,0)
 I $G(PSUSDIV),RXSITE'=$G(PSOSITE) Q
"RTN","PSOBAIR2",109,0)
 S RXSTS=$$GET1^DIQ(52,RXIEN,100,"I") I RXSTS>8 Q
"RTN","PSOBAIR2",110,0)
 S PARTIAL=+$$GET1^DIQ(52.5,SFN,.05,"I")
"RTN","PSOBAIR2",111,0)
 I PARTIAL,'$D(^PSRX(RXIEN,"P",PARTIAL)) Q
"RTN","PSOBAIR2",112,0)
 S PSOANAME=$P($G(^DPT(PSODFN,0)),"^") Q:PSOANAME=""
"RTN","PSOBAIR2",113,0)
 S ^TMP("PSOBADL",$J,PSOANAME,PSODFN,PSORD,RXIEN)=""
"RTN","PSOBAIR2",114,0)
 Q
"RTN","PSODISP")
0^17^B55029655^B54704509
"RTN","PSODISP",1,0)
PSODISP ;BIR/SAB,PWC-MANUAL BARCODE RELEASE FUNCTION ;03/02/93
"RTN","PSODISP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,71,131,156,185,148,247,200**;DEC 1997;Build 7
"RTN","PSODISP",3,0)
 ;Reference to $$SERV^IBARX1 supported by DBIA 2245
"RTN","PSODISP",4,0)
 ;Reference to ^PSD(58.8 supported by DBIA 1036
"RTN","PSODISP",5,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSODISP",6,0)
 ;Reference to ^PSDRUG supported by DBIA 221
"RTN","PSODISP",7,0)
 ;Reference to ^PSDRUG("AQ" supported by DBIA 3165
"RTN","PSODISP",8,0)
 ;Reference to ^XTMP("PSA" supported by DBIA 1036
"RTN","PSODISP",9,0)
 ;Reference to ^PS(59.7 supported by DBIA 694
"RTN","PSODISP",10,0)
 ;Reference to ^DIC(19.2 supported by DBIA 1064
"RTN","PSODISP",11,0)
AC K CX,PSODA,PSODT,PSRH,DA,DR,DIE,X,X1,X2,Y,RXP,CX,PX,REC,DIR,YDT,REC,RDUZ,DIRUT,PSOCPN,PSOCPRX,YY,QDRUG,QTY,TYPE,XTYPE,DUOUT,PSOPID
"RTN","PSODISP",12,0)
 K ^UTILITY($J,"PSOHL") S PSOPID=1
"RTN","PSODISP",13,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W $C(7),!!,?5,"Site Parameters must be defined to use the Release option!",! G EXIT
"RTN","PSODISP",14,0)
 S Y=$G(^PS(59,PSOSITE,"IB")),PSOIBSS=$$SERV^IBARX1(+Y) I 'PSOIBSS D IBSSR^PSOUTL I 'PSOIBFL D   G EXIT
"RTN","PSODISP",15,0)
 .W $C(7),!!,"The IB SERVICE/SECTION defined in your site parameter file is not valid.",!,"You will not be able to release any medication until this is corrected!",!
"RTN","PSODISP",16,0)
AC1 W !! S PSIN=+$P($G(^PS(59.7,1,49.99)),"^",2)
"RTN","PSODISP",17,0)
 S DIC("S")="I $D(^XUSEC(""PSORPH"",+Y))",DIC("A")="Enter PHARMACIST: ",DIC="^VA(200,",DIC(0)="QEAM" D ^DIC G:"^"[X EXIT K DIC G:$D(DTOUT)!($D(DUOUT))!($D(DIRUT))!(Y=-1) EXIT S PSRH=+Y
"RTN","PSODISP",18,0)
 ;check for Drug Acct background job K8 & K7.1
"RTN","PSODISP",19,0)
 S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19.2 D ^DIC I Y=-1 K DIC,X,Y G BC
"RTN","PSODISP",20,0)
 I $P($G(Y(0)),U,2)>DT S PSODA=1 S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT G BC
"RTN","PSODISP",21,0)
 S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19 D ^DIC K DIC,X G:Y=-1 BC
"RTN","PSODISP",22,0)
 K DIQ,PSA S DA=+Y,DIC=19,DIQ="PSA",DR=200,DIQ(0)="IN" D EN^DIQ1
"RTN","PSODISP",23,0)
 I '$D(PSA(19,DA,200,"I")) K DIC,DA,X,Y,DIQ G BC
"RTN","PSODISP",24,0)
 I PSA(19,DA,200,"I")>DT S PSODA=1 S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT
"RTN","PSODISP",25,0)
 K PSA,DIC,DA,X,Y,DIQ
"RTN","PSODISP",26,0)
BC ;
"RTN","PSODISP",27,0)
 K MAN I $G(RXP),$D(DISGROUP),$D(BINGNAM),($D(BINGDIV)!$D(BNGPDV)!$D(BNGRDV)),($D(BINGRO)!$D(BINGRPR)) D REL^PSOBING1 K BINGNAM,BINGDIV,BINGRO,BINGRPR,BNGPDV,BNGRDV
"RTN","PSODISP",28,0)
 Q:$G(POERR)  W !! K CMOP,ISUF,DIR,LBL,LBLP S DIR("A")="Enter/Wand PRESCRIPTION number",DIR("?")="^D HELP^PSODISP",DIR(0)="FO" D ^DIR
"RTN","PSODISP",29,0)
 I $D(DIRUT)!($D(DTOUT))!($D(DUOUT)) K DIRUT,DTOUT,DUOUT G AC1
"RTN","PSODISP",30,0)
 I X'["-" D BCI W:'$G(RXP) !,"INVALID PRESCRIPTION NUMBER" G:'$G(RXP) BC S MAN=1 G BC1
"RTN","PSODISP",31,0)
 I X["-",$P(X,"-")'=$P($$SITE^VASITE(),"^",3) W !?7,$C(7),$C(7),"   INVALID STATION NUMBER !!",$C(7),$C(7),! G BC
"RTN","PSODISP",32,0)
 I X["-" S RXP=$P(X,"-",2) I '$D(^PSRX(+$G(RXP),0))!($G(RXP)']"") W !?7,$C(7),$C(7),$C(7),"   NON-EXISTENT PRESCRIPTION" G BC
"RTN","PSODISP",33,0)
 I $D(^PSRX(RXP,0)) D  G BC1
"RTN","PSODISP",34,0)
 .S PSOLOUD=1 D:$P($G(^PS(55,+$P(^PSRX(+RXP,0),"^",2),0)),"^",6)'=2 EN^PSOHLUP($P(^PSRX(+RXP,0),"^",2)) K PSOLOUD
"RTN","PSODISP",35,0)
 W !?7,$C(7),$C(7),$C(7),"   IMPROPER BARCODE FORMAT" G BC
"RTN","PSODISP",36,0)
BC1 ;
"RTN","PSODISP",37,0)
 D ICN^PSODPT(+$P(^PSRX(RXP,0),"^",2))
"RTN","PSODISP",38,0)
 I +$P($G(^PSRX(+RXP,"PKI")),"^") D  Q:$G(POERR)  G BC
"RTN","PSODISP",39,0)
 .I $G(SPEED) W !!?7,$C(7),$C(7),"Rx# "_$P(^PSRX(RXP,0),"^") S PSOLIST=4
"RTN","PSODISP",40,0)
 .W !!,?7,"UNABLE TO RELEASE - THIS ORDER MUST BE RELEASED THROUGH THE OUTPATIENT",!,?7,"RX'S [PSD OUTPATIENT] OPTION IN THE CONTROLLED SUBSTANCE MENU"
"RTN","PSODISP",41,0)
 I +$P($G(^PSRX(+RXP,"STA")),"^")=13!(+$P($G(^PSRX(+RXP,0)),"^",2)=0) W !?7,$C(7),$C(7),"    PRESCRIPTION IS A DELETED PRESCRIPTION NUMBER" Q:$G(POERR)  D DCHK G BC
"RTN","PSODISP",42,0)
 I +$P($G(^PSRX(+RXP,"STA")),"^"),$S($P(^("STA"),"^")=2:0,$P(^("STA"),"^")=5:0,$P(^("STA"),"^")=11:0,$P(^("STA"),"^")=12:0,$P(^("STA"),"^")=14:0,$P(^("STA"),"^")=15:0,1:1) D STAT^PSODISPS Q:$G(POERR)  D DCHK G BC
"RTN","PSODISP",43,0)
 ;drug stocked in Drug Acct Location?
"RTN","PSODISP",44,0)
 S PSODA(1)=$S($D(^PSD(58.8,+$O(^PSD(58.8,"AOP",+PSOSITE,0)),1,+$P(^PSRX(RXP,0),U,6))):1,1:0)
"RTN","PSODISP",45,0)
 I $P(^PSRX(RXP,2),"^",13) S Y=$P(^PSRX(RXP,2),"^",13) X ^DD("DD") S OUT=1 D  K OUT Q:$G(POERR)  D DCHK G BC
"RTN","PSODISP",46,0)
 .W !!?7,$C(7),$C(7),$S($G(SPEED):"Rx# "_$P(^PSRX(RXP,0),"^"),1:"Original prescription")_" was last released on "_Y,!?7,"Checking for unreleased refills/partials " D REF
"RTN","PSODISP",47,0)
BATCH ;
"RTN","PSODISP",48,0)
 I $P(^PSRX(RXP,2),"^",15),'$P(^(2),"^",14) S RESK=$P(^(2),"^",15)  W !!?5,"Rx# "_$P(^PSRX(RXP,0),"^")_" Original Fill returned to stock on "_$E(RESK,4,5)_"/"_$E(RESK,6,7)_"/"_$E(RESK,2,3),! G REF
"RTN","PSODISP",49,0)
 ;flag to determine if site is running HL7 v.2.4 Dispense Machines
"RTN","PSODISP",50,0)
 N PSODISP S PSODISP=$$GET1^DIQ(59,PSOSITE_",",105,"I")
"RTN","PSODISP",51,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2),QTY=$P($G(^PSRX(RXP,0)),"^",7),QDRUG=$P(^PSRX(RXP,0),"^",6)
"RTN","PSODISP",52,0)
 ;original
"RTN","PSODISP",53,0)
 I '$P($G(^PSRX(RXP,2)),"^",13),+$P($G(^(2)),"^",2)'<PSIN S RXFD=$P(^(2),"^",2) D  D:$G(LBLP) UPDATE I $G(ISUF) D UPDATE G REF
"RTN","PSODISP",54,0)
 .S SUPN=$O(^PS(52.5,"B",RXP,0)) I SUPN,$D(^PS(52.5,"C",RXFD,SUPN)),$G(^PS(52.5,SUPN,"P"))'=1,'$P($G(^(0)),"^",5) S ISUF=1 Q
"RTN","PSODISP",55,0)
 .I $D(^PSDRUG("AQ",QDRUG)) K CMOP D OREL^PSOCMOPB(RXP) K CMOP I $G(ISUF) K ISUF,CMOP Q
"RTN","PSODISP",56,0)
 .;
"RTN","PSODISP",57,0)
 .F LBL=0:0 S LBL=$O(^PSRX(RXP,"L",LBL)) Q:'LBL  I '+$P(^PSRX(RXP,"L",LBL,0),"^",2),'$P(^(0),"^",5),$P(^(0),"^",3)'["INTERACTION" S LBLP=1
"RTN","PSODISP",58,0)
 .D CHKADDR^PSODISPS(RXP)
"RTN","PSODISP",59,0)
 .Q:'$G(LBLP)
"RTN","PSODISP",60,0)
 .;
"RTN","PSODISP",61,0)
 .; - Checking for OPEN/UNRESOLVED 3rd. Party Payer Rejects / NDC Editing
"RTN","PSODISP",62,0)
 .I $$MANREL^PSOBPSUT(RXP,0,$G(PSOPID))="^" K LBLP Q
"RTN","PSODISP",63,0)
 .;
"RTN","PSODISP",64,0)
 .S:$D(^PSDRUG(QDRUG,660.1)) ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)-QTY
"RTN","PSODISP",65,0)
 .D NOW^%DTC S DIE="^PSRX(",DA=RXP,DR="31///"_%_";23////"_PSRH_";32.1///@;32.2///@",PSODT=% D ^DIE K DIE,DR,DA,LBL
"RTN","PSODISP",66,0)
 .;
"RTN","PSODISP",67,0)
 .; - Notifying IB through ECME of the Rx has been released
"RTN","PSODISP",68,0)
 .D IBSEND^PSOBPSUT(RXP,0)
"RTN","PSODISP",69,0)
 .;
"RTN","PSODISP",70,0)
 .D EN^PSOHLSN1(RXP,"ZD")
"RTN","PSODISP",71,0)
 .;if appropriate update ^XTMP("PSA", for Drug Acct
"RTN","PSODISP",72,0)
 .I $G(PSODA),$G(PSODA(1)),'$D(^PSRX("AR",+PSODT,+RXP,0)) S ^XTMP("PSA",+PSOSITE,+QDRUG,+DT)=$G(^XTMP("PSA",+PSOSITE,+QDRUG,+DT))+QTY
"RTN","PSODISP",73,0)
REF ;release refills and partials
"RTN","PSODISP",74,0)
 K LBLP,IFN F XTYPE=1,"P" K IFN D QTY^PSODISPS
"RTN","PSODISP",75,0)
 Q:+$G(OUT)!($G(POERR))  D DCHK
"RTN","PSODISP",76,0)
 G BC
"RTN","PSODISP",77,0)
UPDATE I $G(ISUF) W $C(7),!!?7,"Prescription "_$P(^PSRX(RXP,0),"^")_" - Original Fill on Suspense !",!,$C(7) Q
"RTN","PSODISP",78,0)
 N BFILL S BFILL=0
"RTN","PSODISP",79,0)
 S PSOCPRX=$P(^PSRX(RXP,0),"^") D CP^PSOCP
"RTN","PSODISP",80,0)
 W !?7,"Prescription Number "_$P(^PSRX(RXP,0),"^")_" Released"
"RTN","PSODISP",81,0)
 ;initialize bingo board variables
"RTN","PSODISP",82,0)
 I $G(LBLP),$P(^PSRX(RXP,0),"^",11)["W" S BINGRO="W",BINGNAM=$P(^PSRX(RXP,0),"^",2),BINGDIV=$P(^PSRX(RXP,2),"^",9)
"RTN","PSODISP",83,0)
 I $G(PSODISP)=2.4 D    ;HL7 v2.4 dispensing machines
"RTN","PSODISP",84,0)
 . F I=0:0 S SUB=$O(^PSRX(RXP,"A",I)) Q:'I  I $P(^PSRX(RXP,"A",I,0),"^",2)="N" D XMIT    ;only send release dt/time transmission for dispensed orders
"RTN","PSODISP",85,0)
 Q
"RTN","PSODISP",86,0)
EXIT ;
"RTN","PSODISP",87,0)
 K OUT,RX2,RXFD,RESK,ISUF,SUPN,%,DIC,IFN,J,DA,DR,DIE,X,X1,X2,Y,RXP,CX,PX,REC,DIR,YDT,REC,RDUZ,DIRUT,PSOCPN,PSOCPRX,PSOIBSS,PSOIBFL,PSOIBLP,PSOIBST,YY,QDRUG,QTY,TYPE,XTYPE,DUOUT,PSRH,XX,Y,PSIN,MAN,PSODISP,SUB
"RTN","PSODISP",88,0)
 Q
"RTN","PSODISP",89,0)
GETFILL ; get the fill number
"RTN","PSODISP",90,0)
 S NFLD=0,UU="" F  S UU=$O(^PSRX(+RXP,1,UU)) Q:UU=""  S:$D(^PSRX(+RXP,1,UU,0)) NFLD=NFLD+1
"RTN","PSODISP",91,0)
 Q
"RTN","PSODISP",92,0)
HELP W !!,"Wand the barcode number of the prescription or manually key in",!,"the number below the barcode or the prescription number.",!,"The barcode number should be of the format - 'NNN-NNNNNNN'"
"RTN","PSODISP",93,0)
 Q
"RTN","PSODISP",94,0)
BCI S RXP=0
"RTN","PSODISP",95,0)
RXP S RXP=$O(^PSRX("B",X,RXP)) I $P($G(^PSRX(+RXP,"STA")),"^")=13 G RXP ;GET RECORD NUMBER FROM SCRIPT NUMBER
"RTN","PSODISP",96,0)
 Q
"RTN","PSODISP",97,0)
DCHK ;checks for duplicate
"RTN","PSODISP",98,0)
 Q:'$G(MAN)
"RTN","PSODISP",99,0)
 I $D(DISGROUP),$D(BINGNAM),($D(BINGDIV)!$D(BNGPDV)!$D(BNGRDV)),($D(BINGRO)!$D(BINGRPR)) D REL^PSOBING1 K BINGNAM,BINGDIV,BINGRO,BINGRPR,BNGPDV,BNGRDV
"RTN","PSODISP",100,0)
 S RXP=$O(^PSRX("B",$P(^PSRX(RXP,0),"^"),RXP)) I 'RXP K POERR,MAN Q
"RTN","PSODISP",101,0)
 I $P($G(^PSRX(RXP,"STA")),"^")=13 G DCHK
"RTN","PSODISP",102,0)
 I $D(DISGROUP),$D(BINGNAM),($D(BINGDIV)!$D(BNGPDV)!$D(BNGRDV)),($D(BINGRO)!$D(BINGRPR)) D REL^PSOBING1 K BINGNAM,BINGDIV,BINGRO,BINGRPR,BNGPDV,BNGRDV
"RTN","PSODISP",103,0)
 W !!,"Duplicate Rx # "_$P(^PSRX(RXP,0),"^")_" found."
"RTN","PSODISP",104,0)
 S POERR=1 D BC1^PSODISP
"RTN","PSODISP",105,0)
 I $D(DISGROUP),$D(BINGNAM),($D(BINGDIV)!$D(BNGPDV)!$D(BNGRDV)),($D(BINGRO)!$D(BINGRPR)) D REL^PSOBING1 K BINGNAM,BINGDIV,BINGRO,BINGRPR,BNGPDV,BNGRDV
"RTN","PSODISP",106,0)
 G DCHK
"RTN","PSODISP",107,0)
 Q
"RTN","PSODISP",108,0)
XMIT D NOW^%DTC S PSODTM=%
"RTN","PSODISP",109,0)
 S IDGN=$P(^PSRX(+RXP,0),"^",6)
"RTN","PSODISP",110,0)
 K ^UTILITY($J,"PSOHL")
"RTN","PSODISP",111,0)
 S ^UTILITY($J,"PSOHL",1)=+RXP_"^"_IDGN_"^"_PSODTM_"^"_+$G(PDUZ)_"^0^^PSO DISP^^^"_FP_"^"_FPN
"RTN","PSODISP",112,0)
 S ZTRTN="INIT^PSORELDT",ZTDESC="EXTERNAL INTERFACE FOR RELEASE DATE/TIME",ZTIO="",ZTDTH=$H,ZTSAVE("^UTILITY($J,""PSOHL"",")="",ZTSAVE("PSOSITE")="",ZTSAVE("RXP")="",ZTSAVE("PSOLAP")="" D ^%ZTLOAD K ^UTILITY($J,"PSOHL")
"RTN","PSODISP",113,0)
 Q
"RTN","PSODISPS")
0^18^B34175351^B30402405
"RTN","PSODISPS",1,0)
PSODISPS ;BIR/SAB-CONTINUATION OF RELEASE FUNCTION ;3/2/93
"RTN","PSODISPS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,13,9,27,67,71,156,118,148,247,200**;DEC 1997;Build 7
"RTN","PSODISPS",3,0)
 ;External reference ^PS(59.7 supported by DBIA 694
"RTN","PSODISPS",4,0)
 ;External reference to ^PSDRUG("AQ" supported by DBIA 3165
"RTN","PSODISPS",5,0)
 ;External reference ^XTMP("PSA" supported by DBIA 1036
"RTN","PSODISPS",6,0)
 ;External reference $$SERV^IBARX1 supported by DBIA 2245
"RTN","PSODISPS",7,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSODISPS",8,0)
 ;Reference to ^DIC(19.2 supported by DBIA 1064
"RTN","PSODISPS",9,0)
 ;
"RTN","PSODISPS",10,0)
QTY ; Refill Release
"RTN","PSODISPS",11,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2),QDRUG=$P(^PSRX(RXP,0),"^",6) K LBLP
"RTN","PSODISPS",12,0)
 F YY=0:0 S YY=$O(^PSRX(RXP,XTYPE,YY)) Q:'YY  D:$P($G(^PSRX(RXP,XTYPE,YY,0)),"^")'<PSIN  K ISUF,LBLP
"RTN","PSODISPS",13,0)
 .S RXFD=$E($P(^PSRX(RXP,XTYPE,YY,0),"^"),1,7),SUPN=$O(^PS(52.5,"B",RXP,0)) I SUPN,$D(^PS(52.5,"C",RXFD,SUPN)),$G(^PS(52.5,SUPN,"P"))'=1,$G(XTYPE) S ISUF=1 Q
"RTN","PSODISPS",14,0)
 .I XTYPE=1,($D(^PSDRUG("AQ",QDRUG))) K CMOP D RREL^PSOCMOPB(RXP,YY) K CMOP Q:$G(ISUF)
"RTN","PSODISPS",15,0)
 .I $P(^PSRX(RXP,XTYPE,YY,0),"^",$S($G(XTYPE):18,1:19))]""!($P(^(0),"^",16)) K IFN Q
"RTN","PSODISPS",16,0)
 .;
"RTN","PSODISPS",17,0)
 .F LBL=0:0 S LBL=$O(^PSRX(RXP,"L",LBL)) Q:'LBL  I $P(^PSRX(RXP,"L",LBL,0),"^",2)=$S('XTYPE:(99-YY),1:YY) S LBLP=1
"RTN","PSODISPS",18,0)
 .Q:'$G(LBLP)
"RTN","PSODISPS",19,0)
 .D CHKADDR(RXP)
"RTN","PSODISPS",20,0)
 .;
"RTN","PSODISPS",21,0)
 .; - Checking for OPEN/UNRESOLVED 3rd. Party Payer Rejects / NDC Editing
"RTN","PSODISPS",22,0)
 .I XTYPE,$$MANREL^PSOBPSUT(RXP,YY,$G(PSOPID))="^" K LBLP Q
"RTN","PSODISPS",23,0)
 .;
"RTN","PSODISPS",24,0)
 .S IFN=YY S:$G(^PSDRUG(QDRUG,660.1))]"" QTY=$P(^PSRX(RXP,XTYPE,YY,0),"^",4),^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)-QTY
"RTN","PSODISPS",25,0)
 .K DA,DR,DIE D NOW^%DTC S DIE="^PSRX("_RXP_","""_XTYPE_""",",DA(1)=RXP
"RTN","PSODISPS",26,0)
 .S DA=YY,DR=$S(XTYPE:17,1:8)_"///"_%_";"_$S(XTYPE:4,1:.05)_"////"_PSRH
"RTN","PSODISPS",27,0)
 .S PSODT=% D ^DIE K DIE,DR,DA
"RTN","PSODISPS",28,0)
 .;
"RTN","PSODISPS",29,0)
 .; - Notifying IB through ECME of the Rx being released
"RTN","PSODISPS",30,0)
 .I XTYPE D IBSEND^PSOBPSUT(RXP,YY)
"RTN","PSODISPS",31,0)
 .;
"RTN","PSODISPS",32,0)
 .K PSODISPP S:$G(XTYPE)="P" PSODISPP=1 D EN^PSOHLSN1(RXP,"ZD") K PSODISPP
"RTN","PSODISPS",33,0)
 .K:XTYPE ^PSRX("ACP",$P($G(^PSRX(RXP,0)),"^",2),$P($G(^PSRX(RXP,1,YY,0)),"^"),YY,RXP)
"RTN","PSODISPS",34,0)
 .I XTYPE,$G(IFN),'$G(ISUF) S PSOCPRX=$P(^PSRX(RXP,0),"^") D CP^PSOCP
"RTN","PSODISPS",35,0)
 .;if appropriate update ^XTMP("PSA", for Drug Acct.
"RTN","PSODISPS",36,0)
 .I $G(PSODA),$G(PSODA(1)),'$D(^PSRX("AR",+PSODT,+RXP,YY)) D
"RTN","PSODISPS",37,0)
 ..S ^XTMP("PSA",+PSOSITE,+QDRUG,DT)=$G(^XTMP("PSA",+PSOSITE,+QDRUG,DT))+$P($G(^PSRX(RXP,XTYPE,YY,0)),"^",4)
"RTN","PSODISPS",38,0)
 .;initialize bingo board variables
"RTN","PSODISPS",39,0)
 .I $G(IFN),$P($G(^PSRX(RXP,XTYPE,IFN,0)),"^",2)["W" S BINGRPR="W",BNGPDV=$P(^PSRX(RXP,XTYPE,IFN,0),"^",9),BINGNAM=$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSODISPS",40,0)
 W:$G(IFN) !?7,"Prescription Number "_$P(^PSRX(RXP,0),"^")_$S('$G(XTYPE):" Partial Fill",1:" Refill(s)")_" Released" I $G(SPEED) G XMIT
"RTN","PSODISPS",41,0)
 W:'$G(IFN) !?7,"No "_$S($G(XTYPE):"Refill(s)",1:"Partial(s)")_" to be Released"
"RTN","PSODISPS",42,0)
XMIT I $G(PSODISP)=2.4 D  ;build an send HL7 v2.4 messages to dispense system
"RTN","PSODISPS",43,0)
 . F I=0:0 S SUB=$O(^PSRX(RXP,"A",I)) Q:'I  I $P(^PSRX(RXP,"A",I,0),"^",2)="N" D
"RTN","PSODISPS",44,0)
 .. D NOW^%DTC S PSODTM=% K ^UTILITY($J,"PSOHL")
"RTN","PSODISPS",45,0)
 .. S IDGN=$P(^PSRX(+RXP,0),"^",6),FP=$S(XTYPE=1:"R",1:"P")
"RTN","PSODISPS",46,0)
 .. S ^UTILITY($J,"PSOHL",1)=+RXP_"^"_IDGN_"^"_PSODTM_"^"_+$G(PDUZ)_"^0^^PSO DISP^^^"_FP_"^"_IFN
"RTN","PSODISPS",47,0)
 .. S ZTRTN="INIT^PSORELDT",ZTDESC="EXTERNAL INTERFACE FOR RELEASE DATE/TIME",ZTIO="",ZTDTH=$H,ZTSAVE("^UTILITY($J,""PSOHL"",")="",ZTSAVE("PSOSITE")="",ZTSAVE("RXP")="" D ^%ZTLOAD K ^UTILITY($J,"PSOHL")
"RTN","PSODISPS",48,0)
 K IFN
"RTN","PSODISPS",49,0)
 Q
"RTN","PSODISPS",50,0)
STAT S RX0=^PSRX(RXP,0),$P(RX0,"^",15)=+^("STA"),RX2=^PSRX(RXP,2),J=RXP D ^PSOFUNC
"RTN","PSODISPS",51,0)
 W !!?5,$C(7),$C(7),"Rx# "_$P(^PSRX(RXP,0),"^")_" has a status of "_ST_" and is not eligible for",!?5,"release."_$S('$D(^XUSEC("PSORPH",DUZ)):"  Please check with a Pharmacist!",1:"")
"RTN","PSODISPS",52,0)
 K RX0,ST
"RTN","PSODISPS",53,0)
 Q
"RTN","PSODISPS",54,0)
OERR I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W $C(7),!!,?5,"Site Parameters must be defined to use the Release option!",! S VALMBCK="" Q
"RTN","PSODISPS",55,0)
 S VALMBCK="Q",Y=$G(^PS(59,PSOSITE,"IB")),PSOIBSS=$$SERV^IBARX1(+Y) I 'PSOIBSS D IBSSR^PSOUTL I 'PSOIBFL D  S VALMBCK="" G EX
"RTN","PSODISPS",56,0)
 .W $C(7),!!,"The IB SERVICE/SECTION defined in your site parameter file is not valid.",!,"You will not be able to release any medication until this is corrected!",!
"RTN","PSODISPS",57,0)
 W !! S PSIN=+$P($G(^PS(59.7,1,49.99)),"^",2),RXP=$P(PSOLST($P(PSLST,",",ORD)),"^",2)
"RTN","PSODISPS",58,0)
 S DIC("S")="I $D(^XUSEC(""PSORPH"",+Y))",DIC("A")="Enter PHARMACIST: ",DIC="^VA(200,",DIC(0)="QEAM" D ^DIC G:"^"[X EX K DIC G:$D(DTOUT)!($D(DUOUT))!($D(DIRUT))!(Y=-1) EX S PSRH=+Y
"RTN","PSODISPS",59,0)
 ;check for Drug Acct background job K8 & K7.1
"RTN","PSODISPS",60,0)
 S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19.2 D ^DIC I Y=-1 K DIC,X,Y G DOIT
"RTN","PSODISPS",61,0)
 I $P($G(Y(0)),U,2)>DT S PSODA=1 S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT G DOIT
"RTN","PSODISPS",62,0)
 S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19 D ^DIC K DIC,X G:Y=-1 DOIT
"RTN","PSODISPS",63,0)
 K DIQ,PSA S DA=+Y,DIC=19,DIQ="PSA",DR=200,DIQ(0)="IN" D EN^DIQ1
"RTN","PSODISPS",64,0)
 I '$D(PSA(19,DA,200,"I")) K DIC,DA,X,Y,DIQ G DOIT
"RTN","PSODISPS",65,0)
 I PSA(19,DA,200,"I")>DT S PSODA=1 S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT
"RTN","PSODISPS",66,0)
 K PSA,DIC,DA,X,Y,DIQ
"RTN","PSODISPS",67,0)
 ;
"RTN","PSODISPS",68,0)
DOIT S POERR=1 D FULL^VALM1,BC1^PSODISP
"RTN","PSODISPS",69,0)
 I $D(DISGROUP),$D(BINGNAM),($D(BINGDIV)!$D(BNGPDV)!$D(BNGRDV)),($D(BINGRO)!$D(BINGRPR)) N TM,TM1 D REL^PSOBING1 K BINGNAM,BINGDIV,BINGRO,BINGRPR,BNGPDV,BNGRDV
"RTN","PSODISPS",70,0)
EX ;
"RTN","PSODISPS",71,0)
 K OUT,RX2,RXFD,RESK,ISUF,SUPN,%,DIC,IFN,J,DA,DR,DIE,X,X1,X2,Y,RXP,CX,PX,REC,DIR,YDT,REC,RDUZ,DIRUT,PSOCPN,PSOCPRX,PSOIBSS,PSOIBFL,PSOIBLP,PSOIBST,YY,QDRUG,QTY,TYPE,XTYPE,DUOUT,PSRH,XX,Y,PSIN,POERR,SUB
"RTN","PSODISPS",72,0)
 K DIR S DIR("A",1)=" ",DIR("A")="Press Return to Continue",DIR(0)="E" D ^DIR K DIRUT,DUOUT,DTOUT,DIR S VALMBCK="R"
"RTN","PSODISPS",73,0)
 S PSORXED=1 D ^PSOBUILD,ACT^PSOORNE2 K PSORXED
"RTN","PSODISPS",74,0)
 Q
"RTN","PSODISPS",75,0)
 ;
"RTN","PSODISPS",76,0)
CHKADDR(RXP) ;
"RTN","PSODISPS",77,0)
 N PSOTXT,PSOBADR,PSOTEMP,LBL
"RTN","PSODISPS",78,0)
 S LBL=$O(^PSRX(RXP,"L",99999),-1) I LBL>0 D
"RTN","PSODISPS",79,0)
 .S PSOTXT=$G(^PSRX(RXP,"L",LBL,0)) I PSOTXT'["(BAD ADDRESS)" Q
"RTN","PSODISPS",80,0)
 .S PSOBADR=$$CHKRX^PSOBAI(RXP)
"RTN","PSODISPS",81,0)
 .I '$G(PSOBADR) D SETLBL(LBL,"NO BAD ADDRESS INDICATOR AT RELEASE") Q
"RTN","PSODISPS",82,0)
 .I $P(PSOBADR,"^",2) D SETLBL(LBL,"ACTIVE TEMPORARY ADDRESS AT RELEASE")
"RTN","PSODISPS",83,0)
 Q
"RTN","PSODISPS",84,0)
 ;
"RTN","PSODISPS",85,0)
SETLBL(LBL,PSOMSG) ;
"RTN","PSODISPS",86,0)
 N PSOTXT
"RTN","PSODISPS",87,0)
 S PSOTXT=$G(^PSRX(RXP,"L",LBL,0)),$P(PSOTXT,"^",3)=PSOMSG
"RTN","PSODISPS",88,0)
 S LBL=LBL+1,^PSRX(RXP,"L",0)="^52.032DA^"_LBL_"^"_LBL
"RTN","PSODISPS",89,0)
 S ^PSRX(RXP,"L",LBL,0)=PSOTXT
"RTN","PSODISPS",90,0)
 Q
"RTN","PSOHCSUM")
0^22^B24687274^B23286979
"RTN","PSOHCSUM",1,0)
PSOHCSUM ;BHAM ISC/SAB - gather data for outpatient rx health care summary ;03/01/96 8:29
"RTN","PSOHCSUM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,35,48,54,46,103,132,214,200**;DEC 1997;Build 7
"RTN","PSOHCSUM",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSOHCSUM",4,0)
 ;External reference to File ^PSDRUG supported by DBIA 221
"RTN","PSOHCSUM",5,0)
 ;External reference to File ^PS(50.7 supported by DBIA 2223
"RTN","PSOHCSUM",6,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOHCSUM",7,0)
 ;External reference to ^SC supported by DBIA 10040
"RTN","PSOHCSUM",8,0)
 ;Accepts DFN (assumed to be valid)
"RTN","PSOHCSUM",9,0)
 ;Looks for PSOBEGIN as earliest expiration/cancel date for search
"RTN","PSOHCSUM",10,0)
 ;If $D(PSOBEGIN)=0 use DT as earliest expiration/cancel date
"RTN","PSOHCSUM",11,0)
 ;returns data in ^TMP("PSOO",$J,Inverse last fill date,0)
"RTN","PSOHCSUM",12,0)
 ;data is ISSUE DATE^LAST FILL DATE^DRUG^PROVIDER^STATUS^RX#^QTY^#REFILLS^IFN^COST/FILL^EXP/CANC DATE
"RTN","PSOHCSUM",13,0)
 ;and ^TMP("PSOO",$J,Inverse last fill date,n,0)=SIG
"RTN","PSOHCSUM",14,0)
 ;NON-VA Meds: ^TMP("PSOO",$J,"NVA",n,0)=orderable item_" "_dose form^status (active or discontinued)^start date(fm format)^cprs order # (ptr to 100)^date/time documented (fm format)^documented by (ptr to 200_";"_.01)^dc date/time(fm format)
"RTN","PSOHCSUM",15,0)
 ;^TMP("PSOO",$J,"NVA",n,1,0)=dosage^med route^schedule^drug (file #50_";"_.01)^clinic (file #44_";"_.01)
"RTN","PSOHCSUM",16,0)
 ;^TMP("PSOO",$J,"NVA",n,"DSC",nn,0)=statement/explanation/comments
"RTN","PSOHCSUM",17,0)
 ;
"RTN","PSOHCSUM",18,0)
 ;returns PSOBEGIN (if sent or equal DT if not sent)
"RTN","PSOHCSUM",19,0)
 ;
"RTN","PSOHCSUM",20,0)
 ;If $D(PSOACT) loop thru PS(55,DFN,"P","A") from PSOBEGIN to get actives only
"RTN","PSOHCSUM",21,0)
 ;otherwise loop through entire "P" multiple to get all Rx's
"RTN","PSOHCSUM",22,0)
 ;
"RTN","PSOHCSUM",23,0)
 S ACS=0
"RTN","PSOHCSUM",24,0)
EN K ^TMP("PSOO",$J),PSONV
"RTN","PSOHCSUM",25,0)
 S PSOBEGIN=$S($D(PSOBEGIN):PSOBEGIN,1:DT)
"RTN","PSOHCSUM",26,0)
 I $D(PSOACT) F PSODT=PSOBEGIN-1:0 S PSODT=$O(^PS(55,DFN,"P","A",PSODT)) Q:'PSODT  F PSORXX=0:0 S PSORXX=$O(^PS(55,DFN,"P","A",PSODT,PSORXX)) Q:'PSORXX  D:$G(^PSRX(PSORXX,0))]"" GET
"RTN","PSOHCSUM",27,0)
 I '$D(PSOACT) F PSOI=0:0 S PSOI=$O(^PS(55,DFN,"P",PSOI)) Q:'PSOI  S PSORXX=+^(PSOI,0) D:$G(^PSRX(PSORXX,0))]"" GET
"RTN","PSOHCSUM",28,0)
 F I=0:0 S I=$O(^PS(55,DFN,"NVA",I)) Q:'I  S NVA=^PS(55,DFN,"NVA",I,0) D
"RTN","PSOHCSUM",29,0)
 .Q:'$P(NVA,"^")  S PSONV=$G(PSONV)+1
"RTN","PSOHCSUM",30,0)
 .S ^TMP("PSOO",$J,"NVA",PSONV,0)=$S($D(^PS(50.7,$P(+NVA,"^"),0)):$P(^PS(50.7,$P(+NVA,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"")_"^"
"RTN","PSOHCSUM",31,0)
 .S ^TMP("PSOO",$J,"NVA",PSONV,0)=^TMP("PSOO",$J,"NVA",PSONV,0)_$S($P(NVA,"^",6):"Discontinued",1:"Active")_"^"_$P(NVA,"^",9)_"^"_$P(NVA,"^",8)_"^"_$P(NVA,"^",10)_"^"_$P(NVA,"^",11)_";"_$P($G(^VA(200,$P(NVA,"^",11),0)),"^")_"^"_$P(NVA,"^",7)
"RTN","PSOHCSUM",32,0)
 .S ^TMP("PSOO",$J,"NVA",PSONV,1,0)=$P(NVA,"^",3)_"^"_$P(NVA,"^",4)_"^"_$P(NVA,"^",5)_"^"_$S($P(NVA,"^",2):$P(NVA,"^",2)_";"_$P(^PSDRUG($P(NVA,"^",2),0),"^"),1:"")_"^"
"RTN","PSOHCSUM",33,0)
 .S ^TMP("PSOO",$J,"NVA",PSONV,1,0)=^TMP("PSOO",$J,"NVA",PSONV,1,0)_$S($D(^SC(+$P(NVA,"^",12),0)):$P(NVA,"^",12)_";"_$P(^SC($P(NVA,"^",12),0),"^"),1:"")
"RTN","PSOHCSUM",34,0)
 .F S=0:0 S S=$O(^PS(55,DFN,"NVA",I,"DSC",S)) Q:'S  S ^TMP("PSOO",$J,"NVA",PSONV,"DSC",S,0)=^PS(55,DFN,"NVA",I,"DSC",S,0)
"RTN","PSOHCSUM",35,0)
 ;
"RTN","PSOHCSUM",36,0)
END K PSODT,PSOST,PSORXX,PSO0,PSO2,PSOIDD,PSOFD,PSODR,PSOPR,PSOREF,PSORFL,PSOI,PSOJ,PSOX,PSOCF,I,PSONV,NVA,PSOPN,PSORS
"RTN","PSOHCSUM",37,0)
 Q
"RTN","PSOHCSUM",38,0)
 ;
"RTN","PSOHCSUM",39,0)
GET Q:$P($G(^PSRX(PSORXX,"STA")),"^")=13  S PSO0=^PSRX(PSORXX,0),PSO2=$G(^(2)),PSOFD=+$G(^(3)),PSODR=$P(PSO0,"^",6),PSOPR=$P(PSO0,"^",4),PSOREF=$P(PSO0,"^",9),PSOIDD=$P(PSO0,"^",13)
"RTN","PSOHCSUM",40,0)
 I '$P(PSO0,"^",2)!('PSODR)!('PSOPR) Q
"RTN","PSOHCSUM",41,0)
 I $D(^PS(55,$P(PSO0,"^",2),0)) D:$P($G(^PS(55,$P(PSO0,"^",2),0)),"^",6)'=2 EN^PSOHLUP($P(PSO0,"^",2))
"RTN","PSOHCSUM",42,0)
 S PSOST=$P($G(^PSRX(PSORXX,"STA")),"^"),PSOPN=$P($G(^PSRX(PSORXX,"OR1")),"^",2)
"RTN","PSOHCSUM",43,0)
 I '$D(PSOACT) D ODT I PSODT<PSOBEGIN Q
"RTN","PSOHCSUM",44,0)
 I $D(PSOACT) Q:PSOST>10&(PSOST<16)
"RTN","PSOHCSUM",45,0)
 S PSORS="" I PSOFD=+$P(PSO2,"^",2),+$P(PSO2,"^",15) S PSORS="R"
"RTN","PSOHCSUM",46,0)
 I 'PSOFD S PSOFD=$P(PSO0,"^",13) F PSOJ=0:0 S PSOJ=$O(^PSRX(PSORXX,1,PSOJ)) Q:'PSOJ  I $D(^(PSOJ,0)),^(0)>PSOFD S PSOFD=+^(0)
"RTN","PSOHCSUM",47,0)
 S PSOX=$S($D(^PSDRUG(PSODR,0)):$P(^(0),"^"),1:"NOT ON FILE"),PSODR=PSODR_";"_PSOX
"RTN","PSOHCSUM",48,0)
 S PSOX=$G(^VA(200,PSOPR,0)) S PSOPR=PSOPR_";"_$P(PSOX,"^")
"RTN","PSOHCSUM",49,0)
 S PSOX="A;ACTIVE" S:$D(^PS(52.4,PSORXX,0)) PSOX="N;NON-VERIFIED" S:$O(^PS(52.5,"B",PSORXX,0))&($G(^PS(52.5,+$O(^PS(52.5,"B",PSORXX,0)),"P"))'=1) PSOX="S;SUSPENDED"
"RTN","PSOHCSUM",50,0)
 I PSOX["SUSPENDED",$G(ACS) S PSOX="S;ACTIVE/SUSP"
"RTN","PSOHCSUM",51,0)
 S:PSODT<DT PSOX="E;EXPIRED" S:PSOST=4 PSOX="N;NON-VERIFIED" S:PSOST=3!(PSOST=16) PSOX="H;HOLD"
"RTN","PSOHCSUM",52,0)
 S:PSOST=12!(PSOST=14)!(PSOST=15) PSOX="DC;DISCONTINUED"
"RTN","PSOHCSUM",53,0)
 S PSOCF=+$P(PSO0,"^",17)*(+$P(PSO0,"^",7)) ; Cost/Fill
"RTN","PSOHCSUM",54,0)
 S PSORFL=0 F PSOJ=0:0 S PSORFL=$O(^PSRX(PSORXX,1,PSORFL)) Q:PSORFL'>0  S PSOREF=PSOREF-1
"RTN","PSOHCSUM",55,0)
 F PSOJ=9999999-PSOFD:.0001 Q:'$D(^TMP("PSOO",$J,PSOJ))
"RTN","PSOHCSUM",56,0)
 S ^TMP("PSOO",$J,PSOJ,0)=PSOIDD_"^"_PSOFD_"^"_PSODR_"^"_PSOPR_"^"_PSOX_"^"_$P(PSO0,"^")_"^"_$P(PSO0,"^",7)_"^"_PSOREF_"^"_PSORXX_"^"_PSOCF_"^"_PSODT_"^"_PSOPN
"RTN","PSOHCSUM",57,0)
 S:PSORS="R" ^TMP("PSOO",$J,PSOJ,0)=^TMP("PSOO",$J,PSOJ,0)_"^"_PSORS
"RTN","PSOHCSUM",58,0)
 I '$P(^PSRX(PSORXX,"SIG"),"^",2) D SIG Q
"RTN","PSOHCSUM",59,0)
 F I=0:0 S I=$O(^PSRX(PSORXX,"SIG1",I)) Q:'I  S ^TMP("PSOO",$J,PSOJ,I,0)=^PSRX(PSORXX,"SIG1",I,0)
"RTN","PSOHCSUM",60,0)
 Q
"RTN","PSOHCSUM",61,0)
SIG ;formats backdoor SIG
"RTN","PSOHCSUM",62,0)
 S X=$P(^PSRX(PSORXX,"SIG"),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250),ENT=1
"RTN","PSOHCSUM",63,0)
 F SG=1:1:$L(SIG) S:$L($G(^TMP("PSOO",$J,PSOJ,ENT,0))_" "_$P(SIG," ",SG))>80 ENT=ENT+1 S:$P(SIG," ",SG)'="" ^TMP("PSOO",$J,PSOJ,ENT,0)=$G(^TMP("PSOO",$J,PSOJ,ENT,0))_" "_$P(SIG," ",SG)
"RTN","PSOHCSUM",64,0)
 K SIG,ENT,SG,X Q
"RTN","PSOHCSUM",65,0)
ODT ;canceled or expiration date
"RTN","PSOHCSUM",66,0)
 I +PSOST=12!(PSOST=14)!(PSOST=15) D  Q
"RTN","PSOHCSUM",67,0)
 .I $P(^PSRX(PSORXX,3),"^",5) S PSODT=$P(^PSRX(PSORXX,3),"^",5) Q
"RTN","PSOHCSUM",68,0)
 .S PSODT=0 F PSOJ=0:0 S PSOJ=$O(^PSRX(PSORXX,"A",PSOJ)) Q:PSOJ'>0  I $D(^(PSOJ,0)),$P(^(0),"^",2)="C",+$P(^(0),"^")>PSODT S PSODT=+$P(^(0),"^")
"RTN","PSOHCSUM",69,0)
 S PSODT=+$P(PSO2,"^",6)
"RTN","PSOHCSUM",70,0)
 Q
"RTN","PSOHCSUM",71,0)
ACS ;call from OE/RR to get the new active/susp status
"RTN","PSOHCSUM",72,0)
 S ACS=1 D EN
"RTN","PSOHCSUM",73,0)
 Q
"RTN","PSOHLDIS")
0^19^B67346410^B66788990
"RTN","PSOHLDIS",1,0)
PSOHLDIS ;BIR/PWC,SAB - Automated Dispense Completion HL7 v.2.4 ;10/20/06 3:39pm
"RTN","PSOHLDIS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,189,193,209,148,259,200**;DEC 1997;Build 7
"RTN","PSOHLDIS",3,0)
 ;Reference to ^PSDRUG supported by DBIA #221
"RTN","PSOHLDIS",4,0)
 ;Reference to $$NDCFMT^PSSNDCUT supported by IA 4707
"RTN","PSOHLDIS",5,0)
 ;This routine is called by FACK1^PSOHLDS
"RTN","PSOHLDIS",6,0)
 ;
"RTN","PSOHLDIS",7,0)
 ;*209 add Drug accountability & fix Copay for refills
"RTN","PSOHLDIS",8,0)
 ;*259 check for refill node to exist before updating the Release msg
"RTN","PSOHLDIS",9,0)
 ;
"RTN","PSOHLDIS",10,0)
EN ;main entry and process
"RTN","PSOHLDIS",11,0)
 N NONODE
"RTN","PSOHLDIS",12,0)
 D GETHL7,GETPID,GETORC,GETRXD
"RTN","PSOHLDIS",13,0)
 ;
"RTN","PSOHLDIS",14,0)
 ;Begin Updating files           ;*259
"RTN","PSOHLDIS",15,0)
 I MEDDISP  D                    ;if dispensed
"RTN","PSOHLDIS",16,0)
 . I FLL="F",'FLLN D FILL              ;orig fill
"RTN","PSOHLDIS",17,0)
 . I FLL="F",FLLN D REFILL             ;refill
"RTN","PSOHLDIS",18,0)
 . I FLL="P" D PARTIAL                 ;partial fill
"RTN","PSOHLDIS",19,0)
 . D ACTLOG                            ;activity log
"RTN","PSOHLDIS",20,0)
 . Q:$G(NONODE)                        ;quit, no refill node to update
"RTN","PSOHLDIS",21,0)
 . I $D(BGRP),$D(BNAM),$D(BDIV) D BINGREL^PSOHLDI1    ;bingo board rel
"RTN","PSOHLDIS",22,0)
 . D DRGACCT^PSOHLDI1(RXID)            ;drug accountability *209
"RTN","PSOHLDIS",23,0)
 . I '$G(PRT) D CHKADDR^PSODISPS(RXID)
"RTN","PSOHLDIS",24,0)
 E  D                            ;else not dispensed
"RTN","PSOHLDIS",25,0)
 . D ACTLOG                            ;activity log no release
"RTN","PSOHLDIS",26,0)
 ;
"RTN","PSOHLDIS",27,0)
 ;if label was printed
"RTN","PSOHLDIS",28,0)
 I PRT D
"RTN","PSOHLDIS",29,0)
 . S LBI=0 F LB=0:0 S LB=$O(^PSRX(RXID,"L",LB)) Q:'LB  S LBI=LBI+1
"RTN","PSOHLDIS",30,0)
 . S LBI=LBI+1,^PSRX(RXID,"L",0)="^52.032DA^"_LBI_"^"_LBI
"RTN","PSOHLDIS",31,0)
 . S ^PSRX(RXID,"L",LBI,0)=NOW_"^"_$S(FLL="F":FLLN,1:(99-FLLN))_"^"_"From Rx # "_$P(^PSRX(RXID,0),"^")_$S(FLL="P":" (Partial)",1:"")_$S($G(HLRPT):" (Reprint)",1:"")_" (External Interface)"_"^"_HLUSER
"RTN","PSOHLDIS",32,0)
 ;
"RTN","PSOHLDIS",33,0)
 D END
"RTN","PSOHLDIS",34,0)
 Q
"RTN","PSOHLDIS",35,0)
 ;
"RTN","PSOHLDIS",36,0)
GETHL7 ;get HL7 segments from msg
"RTN","PSOHLDIS",37,0)
 K OK
"RTN","PSOHLDIS",38,0)
 F I=0:0 S I=$O(PSOMSG(I)) Q:'I  D
"RTN","PSOHLDIS",39,0)
 .I $P(PSOMSG(I),"|")="MSH" S NODE1=PSOMSG(I) Q
"RTN","PSOHLDIS",40,0)
 .I $P(PSOMSG(I),"|")="MSA" S NODE2=PSOMSG(I) Q
"RTN","PSOHLDIS",41,0)
 .I $P(PSOMSG(I),"|")="PID" S NODE3=PSOMSG(I) Q
"RTN","PSOHLDIS",42,0)
 .I $P(PSOMSG(I),"|")="ORC" S NODE4=PSOMSG(I) Q
"RTN","PSOHLDIS",43,0)
 .I $P(PSOMSG(I),"|")="RXD" S NODE5=PSOMSG(I) Q
"RTN","PSOHLDIS",44,0)
 Q
"RTN","PSOHLDIS",45,0)
 ;
"RTN","PSOHLDIS",46,0)
GETPID ;get PID segment data
"RTN","PSOHLDIS",47,0)
 S PID=$P($G(NODE3),"|",4)   ;this contains all the patient id numbers
"RTN","PSOHLDIS",48,0)
 F XX=1:1 S PIDD=$P(PID,"^",XX) Q:PIDD=""  D
"RTN","PSOHLDIS",49,0)
 . S PIDID=$P(PIDD,"~",5)
"RTN","PSOHLDIS",50,0)
 . I PIDID="NI" S PICN=$P(PIDD,"~",1)   ;ICN #
"RTN","PSOHLDIS",51,0)
 . I PIDID="SS" S PSSN=$P(PIDD,"~",1)   ;SSN #
"RTN","PSOHLDIS",52,0)
 . I PIDID="PI" S PPID=$P(PIDD,"~",1)   ;patient ID
"RTN","PSOHLDIS",53,0)
 . I PIDID="PN" S PCLM=$P(PIDD,"~",1)   ;claim #
"RTN","PSOHLDIS",54,0)
 Q
"RTN","PSOHLDIS",55,0)
GETORC ;get ORC segment data
"RTN","PSOHLDIS",56,0)
 S RXID=$P($P($G(NODE4),"|",3),"^")    ;RX #
"RTN","PSOHLDIS",57,0)
 S DFN=$P(^PSRX(RXID,0),"^",2) D DEM^VADPT
"RTN","PSOHLDIS",58,0)
 S NAME=VADM(1),DOB=$P(VADM(3),"^"),SEX=$P(VADM(5),"^") K VADM
"RTN","PSOHLDIS",59,0)
 S FPER=$P($P($G(NODE4),"|",11),"~")   ;filling person
"RTN","PSOHLDIS",60,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+FPER D
"RTN","PSOHLDIS",61,0)
 .D ^DIC I +Y>0 S FPER=+Y,FPERN=$P(Y,"^",2) Q
"RTN","PSOHLDIS",62,0)
 .S FPER="",FPERN="UNKNOWN"
"RTN","PSOHLDIS",63,0)
 S CPHARM=$P($P($G(NODE4),"|",12),"~") ;checking pharmacist
"RTN","PSOHLDIS",64,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+CPHARM D  K DIC,X,Y
"RTN","PSOHLDIS",65,0)
 .D ^DIC I +Y>0 S CPHARM=+Y,CPHARMN=$P(Y,"^",2) Q
"RTN","PSOHLDIS",66,0)
 .S CPHARM="",CPHARMN="UNKNOWN"
"RTN","PSOHLDIS",67,0)
 Q
"RTN","PSOHLDIS",68,0)
GETRXD ;get RXD segment data
"RTN","PSOHLDIS",69,0)
 S FILL=$P($P($G(NODE5),"|",2),"^")         ;fill #
"RTN","PSOHLDIS",70,0)
 S GIVECOD=$P($P($G(NODE5),"|",3),"^")      ;give code
"RTN","PSOHLDIS",71,0)
 S X=$P($P($G(NODE5),"|",4),"^"),DISPDT=$$FMDATE^HLFNC(X) K X  ;dispense date
"RTN","PSOHLDIS",72,0)
 S PSORX=$P($P($G(NODE5),"|",8),"^")        ;prescription #
"RTN","PSOHLDIS",73,0)
 S NDC=$P($P($G(NODE5),"|",10),"^")  ;NDC #
"RTN","PSOHLDIS",74,0)
 K F I NDC]"" D  K L,F
"RTN","PSOHLDIS",75,0)
 .S F=""
"RTN","PSOHLDIS",76,0)
 .F L=1:1:$L(NDC,"^") I $P(NDC,"^",L)'=""  S F=$G(F)_$P(NDC,"^",L)_$S($P(NDC,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",77,0)
 .S NDC=F
"RTN","PSOHLDIS",78,0)
 S X=$P($P($G(NODE5),"|",10),"^",2),RELDT=$S($$FMDATE^HLFNC(X)>0:$$FMDATE^HLFNC(X),1:"") K X  ;release dt
"RTN","PSOHLDIS",79,0)
 S PRT=$S($P($P($G(NODE5),"|",10),"^",3)=1:1,$P($P($G(NODE5),"|",10),"^",3)=2:1,1:0)  ;label printed by vendor
"RTN","PSOHLDIS",80,0)
 S MEDDISP=$S($P($P($G(NODE5),"|",10),"^",3)=1:1,$P($P($G(NODE5),"|",10),"^",3)=4:1,1:0)  ;med dispensed by vendor
"RTN","PSOHLDIS",81,0)
 S RPHARM=$P($P($G(NODE5),"|",11),"~",1)      ;releasing pharmacist
"RTN","PSOHLDIS",82,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+RPHARM D
"RTN","PSOHLDIS",83,0)
 .D ^DIC I +Y>0 S RPHARM=+Y Q
"RTN","PSOHLDIS",84,0)
 .S RPHARM=""
"RTN","PSOHLDIS",85,0)
 S LOT=$P($G(NODE5),"|",19)
"RTN","PSOHLDIS",86,0)
 I LOT]"" D  K L,F
"RTN","PSOHLDIS",87,0)
 .S F=""
"RTN","PSOHLDIS",88,0)
 .F L=1:1:$L(LOT,"^") I $P(LOT,"^",L)'=""  S F=$G(F)_$P(LOT,"^",L)_$S($P(LOT,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",89,0)
 .S LOT=F
"RTN","PSOHLDIS",90,0)
 S X=$P($P($G(NODE5),"|",20),"^"),EXPDT=$S($$FMDATE^HLFNC(X)>0:$$FMDATE^HLFNC(X),1:"") K X   ;expiration date
"RTN","PSOHLDIS",91,0)
 S MFG=$P($P($G(NODE5),"|",21),"^")         ;manufacturer
"RTN","PSOHLDIS",92,0)
 K F I MFG]"" D  K L,F
"RTN","PSOHLDIS",93,0)
 .F L=1:1:$L(MFG) Q:$P(MFG,"^",L)=""  S F=$G(F)_$P(MFG,"^",L)_$S($P(MFG,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",94,0)
 .S MFG=F
"RTN","PSOHLDIS",95,0)
 S EXRX=^PS(52.51,EIN,0)
"RTN","PSOHLDIS",96,0)
 S IRX=$P(EXRX,"^"),FLL=$P(EXRX,"^",8),FLLN=$P(EXRX,"^",9),RPT=$P(EXRX,"^",5),(DIV,PSOSITE)=$P(EXRX,"^",11),PSOPAR=$G(^PS(59,DIV,0))
"RTN","PSOHLDIS",97,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB")),PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOHLDIS",98,0)
 S RXN=$P(^PSRX(IRX,0),"^"),DRG=$P(^(0),"^",6),QTY=$P(^(0),"^",7)
"RTN","PSOHLDIS",99,0)
 Q
"RTN","PSOHLDIS",100,0)
FILL ;Orig fill
"RTN","PSOHLDIS",101,0)
 S $P(^PSRX(IRX,2),"^",4)=LOT,$P(^(2),"^",8)=MFG,$P(^(2),"^",11)=EXPDT,$P(^PSRX(IRX,"OR1"),"^",6)=FPER,$P(^("OR1"),"^",7)=CPHARM
"RTN","PSOHLDIS",102,0)
 S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-QTY
"RTN","PSOHLDIS",103,0)
 ;if auto release & rel dt
"RTN","PSOHLDIS",104,0)
 I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",105,0)
 .S DIE="^PSRX(",DA=IRX,DR="31///"_RELDT_";23////"_RPHARM_";32.1///@;32.2///@" D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",106,0)
 .I $P(^PSRX(IRX,0),"^",11)["W" S BRT="W",BNAM=$P(^PSRX(IRX,0),"^",2),BDIV=$P(^(2),"^",9) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",107,0)
 .S PSOCPRX=$P(^PSRX(IRX,0),"^"),RXP=IRX D CP^PSOCP
"RTN","PSOHLDIS",108,0)
 .D EN^PSOHLSN1(IRX,"ZD"),AUTOREL^PSOBPSUT(IRX,FLLN,RELDT,NDC,"A",,30)
"RTN","PSOHLDIS",109,0)
 ;else if not auto release nor rel dt
"RTN","PSOHLDIS",110,0)
 E  I $$NDCFMT^PSSNDCUT(NDC)'="",$$STATUS^PSOBPSUT(IRX,FLLN)="" D SAVNDC^PSONDCUT(IRX,FLLN,NDC)
"RTN","PSOHLDIS",111,0)
 Q
"RTN","PSOHLDIS",112,0)
REFILL ;refill
"RTN","PSOHLDIS",113,0)
 I '$D(^PSRX(IRX,1,FLLN,0)) S NONODE=1 Q
"RTN","PSOHLDIS",114,0)
 S $P(^PSRX(IRX,1,FLLN,0),"^",6)=LOT,$P(^(0),"^",14)=MFG,$P(^(0),"^",15)=EXPDT,$P(^(1),"^",4)=FPER,$P(^(1),"^",5)=CPHARM
"RTN","PSOHLDIS",115,0)
 S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-$P(^PSRX(IRX,1,FLLN,0),"^",4)
"RTN","PSOHLDIS",116,0)
 I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",117,0)
 .S DIE="^PSRX("_IRX_","""_1_""",",DA(1)=IRX,DA=FLLN
"RTN","PSOHLDIS",118,0)
 .S DR="17///"_RELDT_";4////"_RPHARM D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",119,0)
 .I $P(^PSRX(IRX,1,FLLN,0),"^",2)["W" S BRT="W",BDIV=$P(^PSRX(IRX,1,FLLN,0),"^",9),BNAM=$P(^PSRX(IRX,0),"^",2) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",120,0)
 .N YY S YY=FLLN        ;*209
"RTN","PSOHLDIS",121,0)
 .S PSOCPRX=$P(^PSRX(IRX,0),"^"),RXP=IRX D CP^PSOCP
"RTN","PSOHLDIS",122,0)
 .D EN^PSOHLSN1(IRX,"ZD"),AUTOREL^PSOBPSUT(IRX,FLLN,RELDT,NDC,"A",,30)
"RTN","PSOHLDIS",123,0)
 ;else if not auto release nor rel dt
"RTN","PSOHLDIS",124,0)
 E  I $$NDCFMT^PSSNDCUT(NDC)'="",$$STATUS^PSOBPSUT(IRX,FLLN)="" D SAVNDC^PSONDCUT(IRX,FLLN,NDC)
"RTN","PSOHLDIS",125,0)
 Q
"RTN","PSOHLDIS",126,0)
PARTIAL ;partial fill dispensed
"RTN","PSOHLDIS",127,0)
 I '$D(^PSRX(IRX,"P",FLLN,0)) S NONODE=1 Q
"RTN","PSOHLDIS",128,0)
 S $P(^PSRX(IRX,"P",FLLN,0),"^",6)=LOT,$P(^(0),"^",12)=NDC,$P(^PSRX(IRX,"P",FLLN,1),"^")=MFG,$P(^(1),"^",3)=FPER,$P(^(1),"^",4)=CPHARM
"RTN","PSOHLDIS",129,0)
 S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-$P(^PSRX(IRX,"P",FLLN,0),"^",4)
"RTN","PSOHLDIS",130,0)
 I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",131,0)
 .S DIE="^PSRX("_IRX_","""_"P"_""",",DA(1)=IRX,DA=FLLN
"RTN","PSOHLDIS",132,0)
 .S DR="8///"_RELDT_";.05////"_RPHARM D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",133,0)
 .I $P(^PSRX(IRX,"P",FLLN,0),"^",2)["W" S BRT="W",BDIV=$P(^PSRX(IRX,"P",FLLN,0),"^",9),BNAM=$P(^PSRX(IRX,0),"^",2) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",134,0)
 Q
"RTN","PSOHLDIS",135,0)
ACTLOG ;activity log entry
"RTN","PSOHLDIS",136,0)
 N ATXT,ACTN,RXF
"RTN","PSOHLDIS",137,0)
 S:FLL="F" RXF=$S(FLLN>5:FLLN+1,1:FLLN)
"RTN","PSOHLDIS",138,0)
 S:FLL="P" RXF=6
"RTN","PSOHLDIS",139,0)
 S ACL=0 F I=0:0 S I=$O(^PSRX(RXID,"A",I)) Q:'I  S ACL=(ACL+1)
"RTN","PSOHLDIS",140,0)
 D NOW^%DTC S NOW=%,ACL=ACL+1,^PSRX(RXID,"A",0)="^52.3DA^"_ACL_"^"_ACL
"RTN","PSOHLDIS",141,0)
 I 'MEDDISP S ATXT="Medication WAS NOT Dispensed through Interface!"
"RTN","PSOHLDIS",142,0)
 ;
"RTN","PSOHLDIS",143,0)
 ;create activity log text
"RTN","PSOHLDIS",144,0)
 I MEDDISP D
"RTN","PSOHLDIS",145,0)
 . S ATXT="External Interface Dispensing is Complete."
"RTN","PSOHLDIS",146,0)
 . I $G(NONODE) D  Q                                ;node was deleted
"RTN","PSOHLDIS",147,0)
 . . S ATXT="External Interface attempted to Release, but "
"RTN","PSOHLDIS",148,0)
 . . S ATXT=ATXT_$S(FLL="P":"Partial fill",1:"Refill")_" NOT on file."
"RTN","PSOHLDIS",149,0)
 . . S ACTN="No update performed."
"RTN","PSOHLDIS",150,0)
 . . D MAIL^PSOHLDI1
"RTN","PSOHLDIS",151,0)
 . I $G(^PSRX(RXID,"STA"))>11 D  Q                  ;non-active status
"RTN","PSOHLDIS",152,0)
 . . S ATXT="Ext. Disp. Released this Rx, which is Status of "
"RTN","PSOHLDIS",153,0)
 . . S ATXT=ATXT_$$GET1^DIQ(52,RXID,100)
"RTN","PSOHLDIS",154,0)
 . . S ACTN=""
"RTN","PSOHLDIS",155,0)
 . . D MAIL^PSOHLDI1
"RTN","PSOHLDIS",156,0)
 S ^PSRX(RXID,"A",ACL,0)=NOW_"^N^"_RPHARM_"^"_RXF_"^"_ATXT
"RTN","PSOHLDIS",157,0)
 ;
"RTN","PSOHLDIS",158,0)
 ;other comments - additional info when dispensed
"RTN","PSOHLDIS",159,0)
 I MEDDISP D
"RTN","PSOHLDIS",160,0)
 .S ^PSRX(RXID,"A",ACL,2,0)="^52.34A^2^2"
"RTN","PSOHLDIS",161,0)
 .S ^PSRX(RXID,"A",ACL,2,1,0)="Filled By: "_FPERN
"RTN","PSOHLDIS",162,0)
 .S ^PSRX(RXID,"A",ACL,2,2,0)="Checking Pharmacist: "_CPHARMN
"RTN","PSOHLDIS",163,0)
 Q
"RTN","PSOHLDIS",164,0)
ERROR ;sends the error message back to the sending station
"RTN","PSOHLDIS",165,0)
 ;parse the data from the msh segment in order to send back the error message release
"RTN","PSOHLDIS",166,0)
 ;OK=1 - segment missing
"RTN","PSOHLDIS",167,0)
 ;OK=2 - Rx does not exists
"RTN","PSOHLDIS",168,0)
 D NOW^%DTC
"RTN","PSOHLDIS",169,0)
 S REJ=$S(OK=1:"MISSING SEGMENT(S)",OK=2:"PRESCRIPTION "_$S($G(PSORX):"#: "_PSORX,1:"")_" DOES NOT EXISTS",1:"")
"RTN","PSOHLDIS",170,0)
 S ACKDATE=$P($$FMTHL7^XLFDT(%),"-",1)
"RTN","PSOHLDIS",171,0)
 S ^TMP("PSO2",$J,1)="MSH|^~\&|PSO VISTA||PSO DISPENSE||"_$G(ACKDATE)_"||RDS^013|10001|P|2.4|||NE|NE"
"RTN","PSOHLDIS",172,0)
 ;S ^TMP("PSO2",$J,2)="MFE|MUP|"_$G(J)_"|"_$G(ACKDATE)_"|"_$G(SITE)_"|CE"
"RTN","PSOHLDIS",173,0)
 ;S ^TMP("PSO2",$J,3)="ZLF|4|^"_$G(USER)_"||"_$G(REJ)
"RTN","PSOHLDIS",174,0)
 K %,ACKDATE,USER,Y,REJ,OK
"RTN","PSOHLDIS",175,0)
 Q
"RTN","PSOHLDIS",176,0)
END K ACL,I,NOW,LBI,LB,PRT,MEDDISP
"RTN","PSOHLDIS",177,0)
 K ADA,BDA,BDIV,BNGRXP,BNGSUS,BNAME,BRX,CNT1,CT,DA,DD,DIC,DIE,DIK,DIR,DO,DR,DTOUT,DUOUT,GRP,GRTP,JOES
"RTN","PSOHLDIS",178,0)
 K NAM,NDA,NFLAG,NME,ODA,PSZ,RXO,SSN,TDFN,TFLAG,TIC,TICK,TIEN,TM,TM1,TSSN,X,Y,XX,BNAM,BRT,BGRP
"RTN","PSOHLDIS",179,0)
 K Y,OK,XQADATA,SITEN,RDOM,CMOP,REQT,RTDTM,SITENUM,XQSOP,XQMSG,SITEN,NAME,XQAMSG,SITEN
"RTN","PSOHLDIS",180,0)
 K XQAROU,XQAID,RDTM,NODE1,NODE2,NODE3,NODE4,NODE5,PIDID,PIDD,PICN,PSSN,PPID,PCLM
"RTN","PSOHLDIS",181,0)
 K CPHARM,CPHARMN,FPER,FPERN,RPHARM
"RTN","PSOHLDIS",182,0)
 Q
"RTN","PSOHLDS1")
0^1^B48302679^B46283720
"RTN","PSOHLDS1",1,0)
PSOHLDS1 ;BIR/LC,PWC-Build HL7 Segments for Automated Interface ;11/22/06 3:24pm
"RTN","PSOHLDS1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,232,255,200**;DEC 1997;Build 7
"RTN","PSOHLDS1",3,0)
 ;HLFNC       supp. by DBIA 10106
"RTN","PSOHLDS1",4,0)
 ;PSNAPIS     supp. by DBIA 2531
"RTN","PSOHLDS1",5,0)
 ;VASITE      supp. by DBIA 10112
"RTN","PSOHLDS1",6,0)
 ;VADPT       supp. by DBIA 10061
"RTN","PSOHLDS1",7,0)
 ;EN^DIQ1     supp. by DBIA 100
"RTN","PSOHLDS1",8,0)
 ;EN^VAFHLZTA supp. by DBIA 758
"RTN","PSOHLDS1",9,0)
 ;PSDRUG      supp. by DBIA 221
"RTN","PSOHLDS1",10,0)
 ;PS(50.607   supp. by DBIA 2221
"RTN","PSOHLDS1",11,0)
 ;PS(55       supp. by DBIA 2228
"RTN","PSOHLDS1",12,0)
 ;DPT         supp. by DBIA 3097
"RTN","PSOHLDS1",13,0)
 ;SC          supp. by DBIA 10040
"RTN","PSOHLDS1",14,0)
 ;VA(200      supp. by DBIA 10060
"RTN","PSOHLDS1",15,0)
 ;SCMSVUT5    supp. by DBIA 4347
"RTN","PSOHLDS1",16,0)
 ;BLDPID^VAFCQRY supp. by DBIA 3630
"RTN","PSOHLDS1",17,0)
 ;MAKEIT^VAFHLU  supp. by DBIA 4346
"RTN","PSOHLDS1",18,0)
 ;
"RTN","PSOHLDS1",19,0)
 ;*232 allow for Do Not Mail
"RTN","PSOHLDS1",20,0)
 ;*255 move NTEPMI to PSOHLDS4.  fix "MP" node test to '=""
"RTN","PSOHLDS1",21,0)
 ;
"RTN","PSOHLDS1",22,0)
START ;
"RTN","PSOHLDS1",23,0)
 D GETDATA
"RTN","PSOHLDS1",24,0)
 D PID(.PSI),PV1(.PSI),PV2(.PSI),IAM^PSOHLDS4(.PSI),ORC^PSOHLDS4(.PSI)
"RTN","PSOHLDS1",25,0)
 D NTE^PSOHLDS2,RXE^PSOHLDS2(.PSI),RXD^PSOHLDS2(.PSI)
"RTN","PSOHLDS1",26,0)
 D NTEPMI^PSOHLDS4(.PSI),RXR^PSOHLDS2(.PSI)                ;*255
"RTN","PSOHLDS1",27,0)
 ; clean up data set by GETDATA
"RTN","PSOHLDS1",28,0)
 K EBY,EBY1,EFDT,EXDT,FDT,PVDR,PVDR1,CSINER,CSINER1,SITE,SITADD,SITPHN
"RTN","PSOHLDS1",29,0)
 K VPHARMID,VPHARM,DEAID,MW,QTY,DASPLY,OLAN,OTHLAN,PRIORDT,RFRM,NFLD,WARN
"RTN","PSOHLDS1",30,0)
 K PSOXN,PSOXN2,PSND1,PSND2,PRODUCT,PSOPROD,UNIT,VANAME,DISPDT,PSONDC
"RTN","PSOHLDS1",31,0)
 K DRUG
"RTN","PSOHLDS1",32,0)
 Q
"RTN","PSOHLDS1",33,0)
GETDATA ; this is the place to set all data needed for several segments
"RTN","PSOHLDS1",34,0)
 I $G(FP)="F"&('$G(FPN)) D    ;original
"RTN","PSOHLDS1",35,0)
 . S FDT=$P(^PSRX(IRXN,2),"^",2),VPHARMID=$P(^(2),"^",10),DISPDT=$P(^(2),"^",5),EXDT=$P(^(2),"^",6),PSONDC=$P(^(2),"^",7)
"RTN","PSOHLDS1",36,0)
 . S PVDR=$P(^PSRX(IRXN,0),"^",4),QTY=$P(^(0),"^",7),DASPLY=$P(^(0),"^",8),MW=$P(^(0),"^",11),EBY=$P(^(0),"^",16)
"RTN","PSOHLDS1",37,0)
 I $G(FP)="F"&($G(FPN)) D    ;refill
"RTN","PSOHLDS1",38,0)
 . S FDT=$P(^PSRX(IRXN,1,FPN,0),"^"),MW=$P(^(0),"^",2),QTY=$P(^(0),"^",4),DASPLY=$P(^(0),"^",10),DISPDT=$P(^(0),"^",19),EXDT=$S($P(^(0),"^",15):$P(^(0),"^",15),1:$P(^PSRX(IRXN,2),"^",6))
"RTN","PSOHLDS1",39,0)
 . S VPHARMID=$S($P(^PSRX(IRXN,1,FPN,0),"^",5)'="":$P(^(0),"^",5),1:$P(^PSRX(IRXN,2),"^",10))
"RTN","PSOHLDS1",40,0)
 . S EBY=$S($P(^PSRX(IRXN,1,FPN,0),"^",5):$P(^(0),"^",5),1:$P(^(0),"^",7)),PVDR=$P(^(0),"^",17),PSONDC=$S($P($G(^PSRX(IRXN,1,FPN,1)),"^",3):$P(^(1),"^",3),1:$P(^PSRX(IRXN,2),"^",7))
"RTN","PSOHLDS1",41,0)
 I $G(FP)="P"&($G(FPN)) D  ;partial
"RTN","PSOHLDS1",42,0)
 . S FDT=$P(^PSRX(IRXN,"P",FPN,0),"^"),MW=$P(^(0),"^",2),QTY=$P(^(0),"^",4),DASPLY=$P(^(0),"^",10),DISPDT=$P(^(0),"^",13),PVDR=$P(^(0),"^",17),EXDT=$P(^PSRX(IRXN,2),"^",6)
"RTN","PSOHLDS1",43,0)
 . S EBY=$S($P(^PSRX(IRXN,"P",FPN,0),"^",5):$P(^(0),"^",5),1:$P(^(0),"^",7)),VPHARMID=$S($P(^(0),"^",5)'="":$P(^(0),"^",5),1:$P(^PSRX(IRXN,2),"^",10)),PVDR=$P(^PSRX(IRXN,"P",FPN,0),"^",17)
"RTN","PSOHLDS1",44,0)
 . S PSONDC=$S($P(^PSRX(IRXN,"P",FPN,0),"^",12):$P(^(0),"^",12),1:$P(^PSRX(IRXN,2),"^",7))
"RTN","PSOHLDS1",45,0)
 S EFDT=$P(^PSRX(IRXN,2),"^",2) S:$G(EFDT) EFDT=$$HLDATE^HLFNC(EFDT,"DT")
"RTN","PSOHLDS1",46,0)
 S ISDT=$P(^PSRX(IRXN,0),"^",13) S:$G(ISDT) ISDT=$$HLDATE^HLFNC(ISDT,"DT")
"RTN","PSOHLDS1",47,0)
 S DEAID=$$GET1^DIQ(200,PVDR_",",53.2)
"RTN","PSOHLDS1",48,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=VPHARMID D ^DIC
"RTN","PSOHLDS1",49,0)
 S VPHARM=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",50,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=EBY D ^DIC
"RTN","PSOHLDS1",51,0)
 S EBY1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",52,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=PVDR D ^DIC
"RTN","PSOHLDS1",53,0)
 S PVDR1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",54,0)
 S PRIORDT=$P(^PSRX(IRXN,3),"^",4),PRIORDT=$$HLDATE^HLFNC(PRIORDT,"DT")
"RTN","PSOHLDS1",55,0)
 S FDT=$$HLDATE^HLFNC(FDT,"DT")
"RTN","PSOHLDS1",56,0)
 S:$G(DISPDT) DISPDT=$$HLDATE^HLFNC(DISPDT,"DT")
"RTN","PSOHLDS1",57,0)
 S:$G(EXDT) EXDT=$$HLDATE^HLFNC(EXDT,"DT")
"RTN","PSOHLDS1",58,0)
 S FIN=$P(^PSRX(IRXN,"OR1"),"^",5)
"RTN","PSOHLDS1",59,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=FIN D ^DIC
"RTN","PSOHLDS1",60,0)
 S FIN1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",61,0)
 S SITE=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOHLDS1",62,0)
 S PSZIP=$P(SITE,"^",5) S PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOHLDS1",63,0)
 S CLN=+$P(^PSRX(IRXN,0),"^",5),CLN1=$S($D(^SC(CLN,0)):$P(^(0),"^",1),1:"UNKNOWN")
"RTN","PSOHLDS1",64,0)
 S CSINER=$P(^PSRX(IRXN,3),"^",3)
"RTN","PSOHLDS1",65,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=CSINER D ^DIC
"RTN","PSOHLDS1",66,0)
 S CSINER1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",67,0)
 D 6^VADPT
"RTN","PSOHLDS1",68,0)
 S X=$S($D(^PS(55,DFN,0)):^(0),1:""),CAP=$P(X,"^",2)
"RTN","PSOHLDS1",69,0)
 D MW(X,.MW,.MP)                                              ;PSO*232
"RTN","PSOHLDS1",70,0)
 I (($P(^PSRX(IRXN,"STA"),"^")>0)&($P(^("STA"),"^")'=2)&('$G(PSODBQ)))!'$G(^PSRX(IRXN,"IB")) S COPAY="NO COPAY"
"RTN","PSOHLDS1",71,0)
 E  S COPAY="COPAY"
"RTN","PSOHLDS1",72,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0)
"RTN","PSOHLDS1",73,0)
 S DATE=$$HLDATE^HLFNC(FDT) D NOW^%DTC S NOW=$$HLDATE^HLFNC(%,"TS")
"RTN","PSOHLDS1",74,0)
 S OLAN=$P($G(^PS(55,DFN,"LAN")),"^",2),OTLAN="N" I OLAN=2 S OTLAN="Y"
"RTN","PSOHLDS1",75,0)
 S CSUB1=$$GET1^DIQ(50,IDGN_",",3),CSUB="N" I $E(CSUB1,1)>1&($E(CSUB1,1)<6) S CSUB="Y"
"RTN","PSOHLDS1",76,0)
 S SCTALK=+$G(^PS(55,"ASTALK",$P(^PSRX(IRXN,0),"^",2)))
"RTN","PSOHLDS1",77,0)
 K DIC,DR,DIQ S DA=$P($$SITE^VASITE(),"^") I DA D
"RTN","PSOHLDS1",78,0)
 .K PSOINST S DIC=4,DIQ(0)="I",DR=99,DIQ="PSOINST" D EN^DIQ1
"RTN","PSOHLDS1",79,0)
 .S PSOINST=PSOINST(4,DA,99,"I") K DIC,DA,DR,DIQ,PSOINST(4)
"RTN","PSOHLDS1",80,0)
 S DRUG=$$ZZ^PSOSUTL(IRXN),DEA=$P(^PSDRUG(IDGN,0),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOHLDS1",81,0)
 S PSND1=$P($G(^PSDRUG(IDGN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3)
"RTN","PSOHLDS1",82,0)
 K PSOXN,PSOXN2,PSOPROD
"RTN","PSOHLDS1",83,0)
 I PSND1,PSND3 D
"RTN","PSOHLDS1",84,0)
 .S PSOPROD=$$PROD2^PSNAPIS(PSND1,PSND3),VANAME=$P($G(PSOPROD),"^",1)
"RTN","PSOHLDS1",85,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3),UNIT=$P($G(PSOXN),"^",6) S PSOXN=$P($G(PSOXN),"^",5) S PSOXN2=$$PROD2^PSNAPIS(PSND1,PSND3) Q
"RTN","PSOHLDS1",86,0)
 .S PSOXN2=$G(^PSNDF(PSND1,5,PSND3,2))
"RTN","PSOHLDS1",87,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0))
"RTN","PSOHLDS1",88,0)
 .I $G(PRODUCT)'="" S PSOXN=+$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^"),UNIT=$P($G(^PS(50.607,PSOXN,0)),"^")
"RTN","PSOHLDS1",89,0)
 S NFLD=0,UU="" F  S UU=$O(^PSRX(IRXN,1,UU)) Q:UU=""  S:$D(^PSRX(IRXN,1,UU,0)) NFLD=NFLD+1
"RTN","PSOHLDS1",90,0)
 S NRFL=$P(^PSRX(IRXN,0),"^",9),RFRM=(NRFL-NFLD)
"RTN","PSOHLDS1",91,0)
 Q
"RTN","PSOHLDS1",92,0)
PID(PSI) ;patient ID segment
"RTN","PSOHLDS1",93,0)
 Q:'$D(DFN)!$D(PAS)
"RTN","PSOHLDS1",94,0)
 S HLFS=HL1("FS"),HLECH=HL1("ECH"),HLQ=HL1("Q"),HLVER=HL1("VER")
"RTN","PSOHLDS1",95,0)
 K PSPID,PSPID1
"RTN","PSOHLDS1",96,0)
 D BLDPID^VAFCQRY(DFN,"","3,5,7,8,11,13",.PSPID,.HL1,.ERR)
"RTN","PSOHLDS1",97,0)
 ; put PID in format needed for segment parser
"RTN","PSOHLDS1",98,0)
 S PSPID=PSPID(1) K PSPID(1)
"RTN","PSOHLDS1",99,0)
 S (X,Y)=1 F  S X=+$O(PSPID(X)) Q:'X  S PSPID(Y)=PSPID(X),Y=Y+1 K PSPID(X)
"RTN","PSOHLDS1",100,0)
 ;parse PID into individual fields
"RTN","PSOHLDS1",101,0)
 K PRSEPID D SEGPRSE^SCMSVUT5("PSPID","PRSEPID",HL1("FS"))
"RTN","PSOHLDS1",102,0)
 ; parse address into individual components
"RTN","PSOHLDS1",103,0)
 K ADDSEQ D SEQPRSE^SCMSVUT5($NA(PRSEPID(11)),"ADDSEQ",HL1("ECH"))
"RTN","PSOHLDS1",104,0)
 ; build ZTA (Temporary Address)
"RTN","PSOHLDS1",105,0)
 K X2 S X2=$$EN^VAFHLZTA(DFN,"1,2,3,4,5,6,7,",1)
"RTN","PSOHLDS1",106,0)
 ; parse X2 (ZTA) into individual fields if temp add. exists
"RTN","PSOHLDS1",107,0)
 D:'$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOHLDS1",108,0)
 . N BADA S BADA=$$CHKRX^PSOBAI(IRXN)
"RTN","PSOHLDS1",109,0)
 . I $P(BADA,"^"),'$P(BADA,"^",2),ADDSEQ(1,7)'["VAB" S BADA=$$GET1^DIQ(2,DFN_",",.121,"I") S:BADA ADDSEQ(1,7)="VAB"_BADA
"RTN","PSOHLDS1",110,0)
 D:$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOHLDS1",111,0)
 . K PRSEZTA D SEGPRSE^SCMSVUT5("X2","PRSEZTA",HL1("FS"))
"RTN","PSOHLDS1",112,0)
 . ; parse temporary address into individual components
"RTN","PSOHLDS1",113,0)
 . K TMPADD D SEQPRSE^SCMSVUT5($NA(PRSEZTA(5)),"TMPADD",HL1("ECH"))
"RTN","PSOHLDS1",114,0)
 . ; add temporary address as next repitition in PID segment
"RTN","PSOHLDS1",115,0)
 . S SPOT=1+$O(ADDSEQ(""),-1)
"RTN","PSOHLDS1",116,0)
 . M ADDSEQ(SPOT)=TMPADD(1)
"RTN","PSOHLDS1",117,0)
 . S ADDSEQ(SPOT,7)="C"
"RTN","PSOHLDS1",118,0)
 . S ADDSEQ(SPOT,9)=PRSEZTA(6)
"RTN","PSOHLDS1",119,0)
 . S ADDSEQ(SPOT,12,1)=PRSEZTA(3)
"RTN","PSOHLDS1",120,0)
 . S ADDSEQ(SPOT,12,2)=PRSEZTA(4)
"RTN","PSOHLDS1",121,0)
 . ;move address sequence back into parse PID segment
"RTN","PSOHLDS1",122,0)
 ; rebuild PID segment
"RTN","PSOHLDS1",123,0)
 K PRSEPID(11) M PRSEPID(11)=ADDSEQ
"RTN","PSOHLDS1",124,0)
 K PSPID1 D MAKEIT^VAFHLU("PID",.PRSEPID,.PSPID1,.PSPID1)
"RTN","PSOHLDS1",125,0)
 ;put rebuilt PID into format used by $$EN^VAFCQRY
"RTN","PSOHLDS1",126,0)
 K PSPID S PSPID(1)=PSPID1
"RTN","PSOHLDS1",127,0)
 S X=0,Y=2 F  S X=+$O(PSPID1(X)) Q:'X  S PSPID(Y)=PSPID1(X) S Y=Y+1
"RTN","PSOHLDS1",128,0)
 S CNT=0 F I=1:1 Q:'$D(PSPID(I))  D
"RTN","PSOHLDS1",129,0)
 . I I=1 S ^TMP("PSO",$J,PSI)=PSPID(I) Q
"RTN","PSOHLDS1",130,0)
 . S CNT=CNT+1 S ^TMP("PSO",$J,PSI,CNT)=PSPID(I)
"RTN","PSOHLDS1",131,0)
 S PSI=PSI+1
"RTN","PSOHLDS1",132,0)
 S PAS=1
"RTN","PSOHLDS1",133,0)
 K PSPID,PSPID1,PRSEPID,PRSEZTA,SPOT,TMPADD,ADDSEQ
"RTN","PSOHLDS1",134,0)
 Q
"RTN","PSOHLDS1",135,0)
PV1(PSI) ;patient visit segment
"RTN","PSOHLDS1",136,0)
 Q:'$D(DFN)!$D(PAS1)
"RTN","PSOHLDS1",137,0)
 N PV1  ;hardcoded to letter O for Outpatient (Patient class)
"RTN","PSOHLDS1",138,0)
 S PV1="PV1"_FS_FS_"O"_FS
"RTN","PSOHLDS1",139,0)
 S ^TMP("PSO",$J,PSI)=PV1
"RTN","PSOHLDS1",140,0)
 S PSI=PSI+1,PAS1=1
"RTN","PSOHLDS1",141,0)
 Q
"RTN","PSOHLDS1",142,0)
PV2(PSI) ;patient visit segment (additional information)
"RTN","PSOHLDS1",143,0)
 ;PATIENT STATUS AND COPAY
"RTN","PSOHLDS1",144,0)
 Q:'$D(DFN)!$D(PAS2)
"RTN","PSOHLDS1",145,0)
 N PV2 S PV2=""
"RTN","PSOHLDS1",146,0)
 S $P(PV2,"|",24)=$P($G(^PS(53,+$P($G(^PSRX(IRXN,0)),"^",3),0)),"^",2)_"~"_COPAY_FS
"RTN","PSOHLDS1",147,0)
 S ^TMP("PSO",$J,PSI)="PV2|"_PV2
"RTN","PSOHLDS1",148,0)
 S PSI=PSI+1,PAS2=1
"RTN","PSOHLDS1",149,0)
 Q
"RTN","PSOHLDS1",150,0)
 ;
"RTN","PSOHLDS1",151,0)
MW(PS55,MW,MP) ;Return Mail/Window and MP expanded text               ;PSO*232
"RTN","PSOHLDS1",152,0)
 I MW="W"!(MW="") D                   ;*255
"RTN","PSOHLDS1",153,0)
 . S MP=$S($P($G(^PSRX(IRXN,"MP")),"^")'="":$P(^("MP"),"^"),1:"""""")
"RTN","PSOHLDS1",154,0)
 . S MW="WINDOW"
"RTN","PSOHLDS1",155,0)
 I MW="M" D
"RTN","PSOHLDS1",156,0)
 . S MP=""""""
"RTN","PSOHLDS1",157,0)
 . S PS55=$P(PS55,"^",3)
"RTN","PSOHLDS1",158,0)
 . S MW=$S(PS55=1:"CERTIFIED MAIL",PS55=2:"DO NOT MAIL",1:"REGULAR MAIL")
"RTN","PSOHLDS1",159,0)
 Q
"RTN","PSOHLDS2")
0^10^B62771501^B62343601
"RTN","PSOHLDS2",1,0)
PSOHLDS2 ;BHAM ISC/PWC,SAB-Build HL7 Segments for automated interface ;11/22/06 3:24pm
"RTN","PSOHLDS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198,255,200**;DEC 1997;Build 7
"RTN","PSOHLDS2",3,0)
 ;DIWP supported by DBIA 10011
"RTN","PSOHLDS2",4,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOHLDS2",5,0)
 ;^PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS2",6,0)
 ;^PS(51 supported by DBIA 2224
"RTN","PSOHLDS2",7,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOHLDS2",8,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOHLDS2",9,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOHLDS2",10,0)
 ;^PS(54 supported by DBIA 2227
"RTN","PSOHLDS2",11,0)
 ;Cont'd build HL7 segments
"RTN","PSOHLDS2",12,0)
 ;
"RTN","PSOHLDS2",13,0)
 ;*198 add check to insert spaces into PMI segments
"RTN","PSOHLDS2",14,0)
 ;*255 add 2 new fields to RXE.21 (label name & VA PRINT NAME)
"RTN","PSOHLDS2",15,0)
 ;     and move NTEPMI tag to PSOHLDS4
"RTN","PSOHLDS2",16,0)
 ;
"RTN","PSOHLDS2",17,0)
RXE(PSI) ;pharmacy encoded order segment
"RTN","PSOHLDS2",18,0)
 Q:'$D(DFN)  N RXE S RXE="" S $P(RXE,"|",1)=""""""
"RTN","PSOHLDS2",19,0)
 S $P(RXE,"|",2)=$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_$G(PSND2)_CS_"99PSNDF"_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",20,0)
 S $P(RXE,"|",3)="" I $G(PSOXN)="" S PSOXN=""""""
"RTN","PSOHLDS2",21,0)
 S $P(RXE,"|",5)=PSOXN_CS_$S($G(UNIT)'="":$G(UNIT),1:"""""")_CS_"99PSU"
"RTN","PSOHLDS2",22,0)
 S POIPTR=$P($G(^PSRX(IRXN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",23,0)
 I '$G(POIPTR) S PODOSE=$P($G(^PS(50.7,$P($G(^PSDRUG(IDGN,2)),"^"),0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",24,0)
 S TRADENM=$G(^PSRX(IRXN,"TN")),$P(RXE,"|",6)=PODOSE_CS_PODOSENM_CS_"99PSF"
"RTN","PSOHLDS2",25,0)
 S $P(RXE,"|",8)=MP,$P(RXE,"|",9)=TRADENM,$P(RXE,"|",10)=QTY
"RTN","PSOHLDS2",26,0)
 S $P(RXE,"|",11)=CS_$P($G(^PSDRUG(IDGN,660)),"^",8),$P(RXE,"|",12)=NRFL
"RTN","PSOHLDS2",27,0)
 S $P(RXE,"|",13)=DEAID,$P(RXE,"|",14)=VPHARMID_CS_$P(VPHARM,",",1)_CS_$P(VPHARM,",",2)
"RTN","PSOHLDS2",28,0)
 S $P(RXE,"|",15)=$P(^PSRX(IRXN,0),"^"),$P(RXE,"|",16)=RFRM,$P(RXE,"|",17)=NFLD
"RTN","PSOHLDS2",29,0)
 S $P(RXE,"|",18)=PRIORDT,$P(RXE,"|",31)=CSUB_RS_SCTALK_RS_OTLAN
"RTN","PSOHLDS2",30,0)
 S $P(RXE,"|",21)=CS_DRUG_RS_CS_$G(VANAME)                       ;*255
"RTN","PSOHLDS2",31,0)
 S ^TMP("PSO",$J,PSI)="RXE|"_RXE,PSI=PSI+1
"RTN","PSOHLDS2",32,0)
 K PODOSE,PODOSENM,POIPTR,TRADENM,UU
"RTN","PSOHLDS2",33,0)
 Q
"RTN","PSOHLDS2",34,0)
RXD(PSI) ;pharmacy dispense segment
"RTN","PSOHLDS2",35,0)
 Q:'$D(DFN)  N RXD,I
"RTN","PSOHLDS2",36,0)
 S WNS="" I $G(WARN) F I=1:1 S WW=$P(WARN,",",I) Q:WW=""  S WNS=WNS_WW_CS_$S(WW'["N":^PS(54,WW,0),1:"")_RS
"RTN","PSOHLDS2",37,0)
 S RXD="RXD"_FS_$S($G(NFLD):NFLD,1:0)_FS_$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_PSND2_CS_"99PSNDF"
"RTN","PSOHLDS2",38,0)
 S RXD=RXD_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",39,0)
 S RXD=RXD_FS_DISPDT_FS_FS_FS_FS_$P(^PSRX(IRXN,0),"^")_FS_NRFL
"RTN","PSOHLDS2",40,0)
 S RXD=RXD_FS_DEA_RS_PSONDC_FS_$S(FIN'="":FIN_CS_FIN1,1:"")_FS
"RTN","PSOHLDS2",41,0)
 S RXD=RXD_FS_DASPLY_FS_MW_FS_FS_CS_$S($G(CAP):"NON-SAFETY",1:"SAFETY")
"RTN","PSOHLDS2",42,0)
 S RXD=RXD_FS_FS_FS_FS_EXDT_FS_FS_FS_FS_FS_FS_WNS_FS_FS
"RTN","PSOHLDS2",43,0)
 S ^TMP("PSO",$J,PSI)=RXD,PSI=PSI+1
"RTN","PSOHLDS2",44,0)
 Q
"RTN","PSOHLDS2",45,0)
RXR(PSI) ;pharmacy route segment
"RTN","PSOHLDS2",46,0)
 Q:'$D(DFN)  N RXR S (PSROUTE,RTNAME)=""""""
"RTN","PSOHLDS2",47,0)
 F PSRTLP=0:0 S PSRTLP=$O(^PSRX(IRXN,6,PSRTLP)) Q:'PSRTLP  D
"RTN","PSOHLDS2",48,0)
 .S PSROUTE=$P($G(^PSRX(IRXN,6,PSRTLP,0)),"^",7)
"RTN","PSOHLDS2",49,0)
 .I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLDS2",50,0)
 I RTNAME="" K PSROUTE,RTNAME,PSRTLP Q
"RTN","PSOHLDS2",51,0)
 S RXR="RXR"_FS_$G(PSROUTE)_CS_$G(RTNAME)_CS_"99PSR"_FS_FS_FS_FS
"RTN","PSOHLDS2",52,0)
 S ^TMP("PSO",$J,PSI)=RXR,PSI=PSI+1
"RTN","PSOHLDS2",53,0)
 K PSROUTE,RTNAME,PSRTLP
"RTN","PSOHLDS2",54,0)
 Q
"RTN","PSOHLDS2",55,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOHLDS2",56,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOHLDS2",57,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,$P($G(^PS(51,OT,4)),"^")]"" S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOHLDS2",58,0)
 ..;S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOHLDS2",59,0)
 .S SGY=SGY_X_" "
"RTN","PSOHLDS2",60,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOHLDS2",61,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOHLDS2",62,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOHLDS2",63,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOHLDS2",64,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOHLDS2",65,0)
 Q
"RTN","PSOHLDS2",66,0)
 ;
"RTN","PSOHLDS2",67,0)
PSOLBL3 ;RX must be defined (Internal), Check already done for OERR SIG
"RTN","PSOHLDS2",68,0)
 ;Format OERR Sig for New and Old label stock
"RTN","PSOHLDS2",69,0)
 N CTCT,FFFF,LLIM,LLLL,LVAR,LVAR1,PPP,PPPP,SGCT,SIG9,ZZZZ,PSLONG,PPPP
"RTN","PSOHLDS2",70,0)
 S RX=IRXN
"RTN","PSOHLDS2",71,0)
 I $P($G(^PS(55,DFN,"LAN")),"^") N II D OTHL^PSOLBL3 G:$G(FND) FMSIG
"RTN","PSOHLDS2",72,0)
 S PSLONG=$S($P(PSOPAR,"^",28):46,1:34)
"RTN","PSOHLDS2",73,0)
 ; NEXT LINE IF SIG IS MOVED BACK TO MULTIPLE
"RTN","PSOHLDS2",74,0)
 S PPPP=1 F PPP=0:0 S PPP=$O(^PSRX(RX,"SIG1",PPP)) Q:'PPP  I $G(^PSRX(RX,"SIG1",PPP,0))'="" S SIG9(PPPP)=^(0) S PPPP=PPPP+1
"RTN","PSOHLDS2",75,0)
 ;NEXT LINE IF 1ST FRONT DOOR SIG LINE LIVES IN BACK DOOR SPOT
"RTN","PSOHLDS2",76,0)
FMSIG S (LVAR,LVAR1)="",LLLL=1
"RTN","PSOHLDS2",77,0)
 F FFFF=0:0 S FFFF=$O(SIG9(FFFF)) Q:'FFFF  S SGCT=0 F ZZZZ=1:1:$L(SIG9(FFFF)) I $E(SIG9(FFFF),ZZZZ)=" "!($L(SIG9(FFFF))=ZZZZ) S SGCT=SGCT+1 D  I $L(LVAR)>PSLONG S SGY(LLLL)=LLIM_" ",LLLL=LLLL+1,LVAR=LVAR1
"RTN","PSOHLDS2",78,0)
 .S LVAR1=$P(SIG9(FFFF)," ",(SGCT)),LLIM=LVAR,LVAR=$S(LVAR="":LVAR1,1:LVAR_" "_LVAR1)
"RTN","PSOHLDS2",79,0)
 I $G(LVAR)'="" S SGY(LLLL)=LVAR
"RTN","PSOHLDS2",80,0)
 I '$P(PSOPAR,"^",28) S SGC=0 F CTCT=0:0 S CTCT=$O(SGY(CTCT)) Q:'CTCT  S SGC=SGC+1
"RTN","PSOHLDS2",81,0)
 I $O(OSGY(0)) D
"RTN","PSOHLDS2",82,0)
 .F I=0:0 S I=$O(SGY(I)) Q:'I  I $G(OSGY(I))']"" S OSGY(I)=" "
"RTN","PSOHLDS2",83,0)
 .F I=0:0 S I=$O(OSGY(I)) Q:'I  I $G(SGY(I))']"" S SGY(I)=" "
"RTN","PSOHLDS2",84,0)
 Q
"RTN","PSOHLDS2",85,0)
NTE ;build NTE segment for SIG
"RTN","PSOHLDS2",86,0)
 ;
"RTN","PSOHLDS2",87,0)
 Q:'$D(DFN)
"RTN","PSOHLDS2",88,0)
 ; 1 = SIG
"RTN","PSOHLDS2",89,0)
 ; 2 = PI Narrative
"RTN","PSOHLDS2",90,0)
 ; 3 = Drug Warning
"RTN","PSOHLDS2",91,0)
 ; 4 = Profile
"RTN","PSOHLDS2",92,0)
 ; 5 = Drug Interaction
"RTN","PSOHLDS2",93,0)
 ; 6 = Drug Allergy
"RTN","PSOHLDS2",94,0)
 ;
"RTN","PSOHLDS2",95,0)
 K FLDX
"RTN","PSOHLDS2",96,0)
 D NTE1(.PSI) K FLDX D NTE2(.PSI) K FLDX D NTE3(.PSI) K FLDX
"RTN","PSOHLDS2",97,0)
 D NTE4(.PSI) K FLDX D NTE5(.PSI) K FLDX D NTE6(.PSI) K FLDX
"RTN","PSOHLDS2",98,0)
 Q
"RTN","PSOHLDS2",99,0)
 ;
"RTN","PSOHLDS2",100,0)
NTE1(PSI) ;SIG
"RTN","PSOHLDS2",101,0)
 S SIG=$P($G(^PSRX(IRXN,"SIG")),"^")
"RTN","PSOHLDS2",102,0)
 I $P($G(^PSRX(IRXN,"SIG")),"^",2) D PSOLBL3,SIGOLD
"RTN","PSOHLDS2",103,0)
 I '$P($G(^PSRX(IRXN,"SIG")),"^",2) D SIG
"RTN","PSOHLDS2",104,0)
 I $O(OSGY(0)) D  G KNTE
"RTN","PSOHLDS2",105,0)
 .K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",106,0)
 .S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions (LANGUAGE PREFERENCE)"
"RTN","PSOHLDS2",107,0)
 .K DRR F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",108,0)
 .S DRR=DRR+1,OSGY(DRR)=FS_"Medication Instructions (ENGLISH)"
"RTN","PSOHLDS2",109,0)
 .K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",110,0)
 .S CLD=1 F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",111,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR)
"RTN","PSOHLDS2",112,0)
 .S PSI=PSI+1,^TMP("PSO",$J,PSI)="NTE"_FS_8_FS_FS
"RTN","PSOHLDS2",113,0)
 .S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",114,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",115,0)
 K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",116,0)
 S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions"
"RTN","PSOHLDS2",117,0)
 K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",118,0)
 S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",119,0)
 .S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",120,0)
KNTE S PSI=PSI+1 K DR,CLD,DRR,SIG,E,F,S,FLD1,X,Y,SGY,SGC,Z,DR,%,J,P,NT1,ST,EN,LTH
"RTN","PSOHLDS2",121,0)
 Q
"RTN","PSOHLDS2",122,0)
LENGTH(NT1) ; compensate for length > 245
"RTN","PSOHLDS2",123,0)
 I $L(NT1)>245 S LTH=$E($L(NT1)/245,1) S:$L(NT1)#245>0 LTH=LTH+1 F WW=1:1:LTH D
"RTN","PSOHLDS2",124,0)
 . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S NT11=$E(NT1,ST,EN)
"RTN","PSOHLDS2",125,0)
 . S:WW=1 ^TMP("PSO",$J,PSI)=NT11 S:WW>1 ^TMP("PSO",$J,PSI,WW-1)=NT11
"RTN","PSOHLDS2",126,0)
 S:'$D(LTH) ^TMP("PSO",$J,PSI)=NT1 S PSI=PSI+1
"RTN","PSOHLDS2",127,0)
 Q
"RTN","PSOHLDS2",128,0)
NTE2(PSI) ; Patient Narrative
"RTN","PSOHLDS2",129,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",130,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOHLDS2",131,0)
 I PSSIXFL S ^TMP("PSO",$J,PSI)="NTE"_FS_2_FS_FS,^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1,FLDX=1
"RTN","PSOHLDS2",132,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",133,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOHLDS2",134,0)
 I PSSEVFL S ^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",135,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",136,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",137,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,PSNACNT-1)=^TMP("PSO",$J,PSI,PSNACNT-1)_FS_"Patient Narrative",PSI=PSI+1
"RTN","PSOHLDS2",138,0)
 K DIWF,DIWL,DIWR,LLL,PSNACNT,PSSEVFL,PSSIXFL,ZZ
"RTN","PSOHLDS2",139,0)
 Q
"RTN","PSOHLDS2",140,0)
NTE3(PSI) ;Drug Warning Narrative
"RTN","PSOHLDS2",141,0)
 N NTE3,J,TEXT,W,CNT,PSSWSITE
"RTN","PSOHLDS2",142,0)
 S WARN=$P($G(^PSDRUG(IDGN,0)),"^",8)
"RTN","PSOHLDS2",143,0)
 S PSSWSITE=+$O(^PS(59.7,0))
"RTN","PSOHLDS2",144,0)
 I $P($G(^PS(59.7,PSSWSITE,10)),"^",11)="N" D
"RTN","PSOHLDS2",145,0)
 .S WARN=$$DRUG^PSSWRNA(IDGN,DFN)
"RTN","PSOHLDS2",146,0)
 I WARN="" Q
"RTN","PSOHLDS2",147,0)
 S NTE3="NTE"_FS_3_FS_FS,^TMP("PSO",$J,PSI)=NTE3,CNT=1
"RTN","PSOHLDS2",148,0)
 F J=1:1:5 S W=$P(WARN,",",J) Q:W=""  D
"RTN","PSOHLDS2",149,0)
 .S TEXT=$$WTEXT^PSSWRNA(W,$G(OLAN)) I TEXT'="" S FLDX=1,^TMP("PSO",$J,PSI,CNT)=TEXT,CNT=CNT+1
"RTN","PSOHLDS2",150,0)
 S:$G(FLDX) ^TMP("PSO",$J,PSI,CNT-1)=$G(^TMP("PSO",$J,PSI,CNT-1))_FS_"Drug Warning Narrative",PSI=PSI+1
"RTN","PSOHLDS2",151,0)
 Q
"RTN","PSOHLDS2",152,0)
NTE4(PSI) ;Profile information
"RTN","PSOHLDS2",153,0)
 S PSODFN=DFN N NTE4
"RTN","PSOHLDS2",154,0)
 I $P(PSOPAR,"^",8) D START^PSOHLDS3
"RTN","PSOHLDS2",155,0)
 S:$D(NTE4) PSI=PSI+1
"RTN","PSOHLDS2",156,0)
 Q
"RTN","PSOHLDS2",157,0)
NTE5(PSI) ;Drug Interactions
"RTN","PSOHLDS2",158,0)
 N NTE5 D:$D(DRI) START2^PSOHLDS3
"RTN","PSOHLDS2",159,0)
 S:$D(NTE5) ^TMP("PSO",$J,PSI)=NTE5_FS_"Drug Interactions",PSI=PSI+1
"RTN","PSOHLDS2",160,0)
 Q
"RTN","PSOHLDS2",161,0)
NTE6(PSI) ;Drug Allergy Indications
"RTN","PSOHLDS2",162,0)
 N NTE6
"RTN","PSOHLDS2",163,0)
 Q:'$G(DAW)
"RTN","PSOHLDS2",164,0)
 D START3^PSOHLDS3
"RTN","PSOHLDS2",165,0)
 Q:NTE6=""
"RTN","PSOHLDS2",166,0)
 S ^TMP("PSO",$J,PSI)=NTE6_FS_"Drug Allergy Indications",PSI=PSI+1
"RTN","PSOHLDS2",167,0)
 Q
"RTN","PSOLLL1")
0^2^B67443546^B68811499
"RTN","PSOLLL1",1,0)
PSOLLL1 ;BIR/BHW - LASER LABELS ;10/24/2002
"RTN","PSOLLL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,141,135,162,161,233,200**;DEC 1997;Build 7
"RTN","PSOLLL1",3,0)
 ;
"RTN","PSOLLL1",4,0)
 ;Reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLLL1",5,0)
 ;Reference ^VA(200,D0,"PS" supported by DBIA 224
"RTN","PSOLLL1",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOLLL1",7,0)
 ;
"RTN","PSOLLL1",8,0)
ST I $P($G(^PSRX(RX,3)),"^",3) S PSOPROV=+$P(^(0),"^",4),PSOPROV=$S($G(RXP):+$P($G(RXP),"^",17),$G(RXF):+$P($G(^PSRX(RX,1,RXF,0)),"^",17),1:PSOPROV) S:'$G(PSOPROV) PSOPROV=+$P(^PSRX(RX,0),"^",4) D
"RTN","PSOLLL1",9,0)
 . I +$P($G(^VA(200,PSOPROV,"PS")),"^",7) S:'$P($G(PHYS),"/",2) PHYS=$G(PHYS)_"/"_+$P($G(^PSRX(RX,3)),"^",3)
"RTN","PSOLLL1",10,0)
 S $P(ULN,"_",34)="",PSOTRAIL=1
"RTN","PSOLLL1",11,0)
 S (Y,X1)=EXPDT X ^DD("DD") S EXPDT=Y,Y=$P(^PSRX(RX,0),"^",13) X ^DD("DD") S ISD=Y,X2=DT D ^%DTC S DIFF=X
"RTN","PSOLLL1",12,0)
 S Y=DATE X ^DD("DD") S DATE=Y
"RTN","PSOLLL1",13,0)
 S TECH="("_$S($P($G(^PSRX(+$G(RX),"OR1")),"^",5):$P($G(^PSRX(+$G(RX),"OR1")),"^",5),1:$P(RXY,"^",16))_"/"_$S($G(VRPH)&($P(PSOPAR,"^",32)):VRPH,1:" ")_")"
"RTN","PSOLLL1",14,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLL1",15,0)
L1 I $G(PSOIO("BLH"))]"" X PSOIO("BLH")
"RTN","PSOLLL1",16,0)
 I 'SIGF,'SIGM,'PMIM K PSOSTLK,ZTKDRUG I $L($T(PSOSTALK^PSOTALK1)) D PSOSTALK^PSOTALK1 D  S PSOSTLK=1 ; PRINT ONE SCRIPTALK LABEL IF APPLICABLE
"RTN","PSOLLL1",17,0)
 .D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLL1",18,0)
 S T="VAMC "_$P(PS,"^",7)_", "_STATE_" "_$G(PSOHZIP) S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",19,0)
 S T=$P(PS2,"^",2)_"  "_TECH_"  Ph: "_$P(PS,"^",3)_"-"_$P(PS,"^",4) S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",20,0)
 S PSDU=$P($G(^PSDRUG($P($G(^PSRX(RX,0)),"^",6),660)),"^",8)
"RTN","PSOLLL1",21,0)
 I $G(PSOIO("BLB"))]"" X PSOIO("BLB")
"RTN","PSOLLL1",22,0)
 S XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL1",23,0)
 S T="Rx# "_RXN_"  " S:SIGF!($G(FILLCONT)) T=" " D PRINT(T,1)
"RTN","PSOLLL1",24,0)
 D STRT^PSOLLU1("RX#",T,.L) S PSOY=PSOY-PSOYI,OPSOX=PSOX,PSOX=L(XFONT)*300+PSOX
"RTN","PSOLLL1",25,0)
 S DR=$G(SIGF("DR"))
"RTN","PSOLLL1",26,0)
 S T="  "_DATE_"  "_$S('SIGF:"Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9)),1:"(label continued)") S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",27,0)
 S PSOX=OPSOX,T=PNM S:SIGF!($G(FILLCONT)) T=" " I T'=" " D PRINT(T,1)
"RTN","PSOLLL1",28,0)
 I DR>1 S PSOX=OPSOX,T="Rx# "_RXN_"  (label continued)" D PRINT(T)
"RTN","PSOLLL1",29,0)
 D STRT^PSOLLU1("SIG",T,.L)
"RTN","PSOLLL1",30,0)
 S OPSOX=PSOX,PSOX=L(XFONT)*300+PSOX,PSOY=PSOY-PSOYI,T="  "_$G(SSNPN) S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",31,0)
 S PSOX=OPSOX,LENGTH=0,PTEXT="",SIGF=0,XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL1",32,0)
 N DP,TEXTP,TEXTL,MORE
"RTN","PSOLLL1",33,0)
 I 'SIGM,'$G(FILLCONT) D COUNTSG^PSOLLLW
"RTN","PSOLLL1",34,0)
 S DR=SIGF("DR")
"RTN","PSOLLL1",35,0)
 I DR>1,'$D(NSGY(DR,4)) D
"RTN","PSOLLL1",36,0)
 .F I=4:-1:1 Q:$D(NSGY(DR,I))  S T=" " D PRINT(T) ; BOTTOM-JUSTIFY CONTINUED BOTTLE SIG JUST ABOVE 'DISCARD' LINE
"RTN","PSOLLL1",37,0)
 F I=1:1 Q:'$D(NSGY(DR,I))  S TEXT=NSGY(DR,I) D PRINT(TEXT)
"RTN","PSOLLL1",38,0)
 I I>4,$D(NSGY(DR,5)) S SIGF=1,SIGF("DR")=DR+1
"RTN","PSOLLL1",39,0)
 I $G(PSOIO("BLF"))]"" X PSOIO("BLF")
"RTN","PSOLLL1",40,0)
 S PSOY=PSODY-PSOYI,PSOFONT=PSODFONT
"RTN","PSOLLL1",41,0)
 I SIGF G WARN:'SIGM&('$G(FILLCONT)),CONT
"RTN","PSOLLL1",42,0)
 I '$D(NSGY) G CONT
"RTN","PSOLLL1",43,0)
 K NSGY,^TMP($J,"PSOSIG",RX)
"RTN","PSOLLL1",44,0)
 D NOW^%DTC S X1=X,X2=365 D C^%DTC S Y=X X ^DD("DD")
"RTN","PSOLLL1",45,0)
 S DEA=$P($G(^PSDRUG($P(RXY,"^",6),0)),"^",3),T=""
"RTN","PSOLLL1",46,0)
 I DEA'["S" S T="Discard after "_$S(DEA[0!(DEA["M"):"_________",1:Y)_"__________   "
"RTN","PSOLLL1",47,0)
 S T=T_"Mfr_________" D PRINT(T)
"RTN","PSOLLL1",48,0)
 S PSOY=PSOY-5
"RTN","PSOLLL1",49,0)
 D  S PSOFONT="F8"  D PRINT(T)
"RTN","PSOLLL1",50,0)
 . S NOR=$P(RXY,"^",9)-RXF
"RTN","PSOLLL1",51,0)
 . I $P(RXY,"^",9)=0 S T="NO REFILL" Q
"RTN","PSOLLL1",52,0)
 . I NOR=0 S T="NO REFILLS LEFT" Q
"RTN","PSOLLL1",53,0)
 . S T="May refill "_NOR_"X by "_EXPDT
"RTN","PSOLLL1",54,0)
 S PPHYS=$G(PHYS)
"RTN","PSOLLL1",55,0)
 S XFONT=$E(PSOQFONT,2,99)
"RTN","PSOLLL1",56,0)
 S TEXT="Qty: " D STRT^PSOLLU1("SIG",TEXT,.L) S Q(1)=L(XFONT)
"RTN","PSOLLL1",57,0)
 S TEXT=" "_PSDU D STRT^PSOLLU1("SIG",TEXT,.L) S Q(2)=L(XFONT)
"RTN","PSOLLL1",58,0)
 S TEXT="       "_$G(PHYS) D STRT^PSOLLU1("SIG",TEXT,.L) S Q(3)=L(XFONT)
"RTN","PSOLLL1",59,0)
 S TEXT=$G(QTY) D STRT^PSOLLU1("SIG",TEXT,.L) S LENGTH=Q(1)+Q(2)+Q(3)+L(XFONT+2),Q(4)=L(XFONT+2)
"RTN","PSOLLL1",60,0)
 I LENGTH>3 F I=$L(PHYS)-1:-1:1 S PPHYS=$E(PHYS,1,I),TEXT="       "_PPHYS D STRT^PSOLLU1("SIG",TEXT,.L) I Q(1)+Q(2)+Q(4)+L(XFONT)<3.3 Q 
"RTN","PSOLLL1",61,0)
 S PSOFONT=PSOTFONT,OPSOX=PSOX,PSOX=PSOX+(Q(1)*300),PSOY=PSOQY-PSOYI,T=$G(QTY) D PRINT(T)
"RTN","PSOLLL1",62,0)
 S PSOX=OPSOX,PSOFONT=PSOQFONT,PSOY=PSOY-PSOYI,T="Qty: " D PRINT(T)
"RTN","PSOLLL1",63,0)
 S PSOX=PSOX+(Q(1)+Q(4)*300),PSOY=PSOY-PSOYI,T=" "_$G(PSDU)_"       "_$G(PPHYS) D PRINT(T)
"RTN","PSOLLL1",64,0)
 S PSOFONT=PSOTFONT,PSOX=OPSOX,PSOY=PSOTY-PSOYI,T=DRUG D STRT^PSOLLU1("SIG",T,.L)
"RTN","PSOLLL1",65,0)
 I L($E(PSOFONT,2,99))>3 S PSOFONT=$S(PSOFONT="F12":"F10",PSOFONT="F10":"F9",PSOFONT="F9":F8,PSOFONT="F8":"F6")
"RTN","PSOLLL1",66,0)
 S ZTKDRUG="XXXXXX   SCRIPTALK RX   XXXXXX"
"RTN","PSOLLL1",67,0)
 I $G(PSOSTLK) S T=$S($G(PSOSTALK):ZTKDRUG,1:DRUG)
"RTN","PSOLLL1",68,0)
 D PRINT(T,1)
"RTN","PSOLLL1",69,0)
 I SIGM G CONT
"RTN","PSOLLL1",70,0)
 S ^PSRX(RX,"TYPE")=0
"RTN","PSOLLL1",71,0)
WARN ;PRINT WARNING LABELS
"RTN","PSOLLL1",72,0)
 I $G(PSOIO("WLI"))]"" X PSOIO("WLI")
"RTN","PSOLLL1",73,0)
 ; IF <5 WARNINGS, PRINT LABELS BOTTOM-JUSTIFIED
"RTN","PSOLLL1",74,0)
 S PSOLAN=$P($G(^PS(55,DFN,"LAN")),"^",2)
"RTN","PSOLLL1",75,0)
 S WARN5=WARN F  Q:$L(WARN5,",")>4  S WARN5=" ,"_WARN5
"RTN","PSOLLL1",76,0)
 F WWW=1:1:5 S PSOWARN=$P(WARN5,",",WWW) I PSOWARN'="" D
"RTN","PSOLLL1",77,0)
 . I PSOWARN["N" D NEWWARN^PSOLLLW Q
"RTN","PSOLLL1",78,0)
 . D WARN54^PSOLLLW
"RTN","PSOLLL1",79,0)
 ;RETURN MAIL
"RTN","PSOLLL1",80,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"") I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLL1",81,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL1",82,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLL1",83,0)
 I $G(PSOIO("RMI"))]"" X PSOIO("RMI")
"RTN","PSOLLL1",84,0)
 S PSOYI=$G(PSOHYI,40),OFONT=PSOFONT,PSOFONT=$G(PSOHFONT)
"RTN","PSOLLL1",85,0)
 S BLNKLIN="",$P(BLNKLIN," ",40)=" "
"RTN","PSOLLL1",86,0)
 S T="Attn: (119)"_BLNKLIN_$$FMTE^XLFDT(DT) D PRINT(T,0)
"RTN","PSOLLL1",87,0)
 S T=$G(VASTREET) D PRINT(T,0)
"RTN","PSOLLL1",88,0)
 S T=$P(PS,"^",7)_", "_$G(STATE)_"  "_$G(PSOHZIP) D PRINT(T,0)
"RTN","PSOLLL1",89,0)
 S PSOY=PSOY+PSOYI,T=$S(PS55=2:"***DO NOT MAIL***",1:"") I T'="" D PRINT(T,0)
"RTN","PSOLLL1",90,0)
 I T'="***DO NOT MAIL***" S T=$S(PS55[0!(PS55[3)!(PS55=""):"REGULAR MAIL",1:"CERTIFIED MAIL") S T=T_"-"_$G(MAILCOM) S:$L(T)>25 PSOFONT="F8" D PRINT(T,0)
"RTN","PSOLLL1",91,0)
 S PSOFONT=OFONT
"RTN","PSOLLL1",92,0)
 S T=PNM
"RTN","PSOLLL1",93,0)
 S PSOY=PSOY+PSOYI,PSOYI=PSORYI D PRINT(T,0)
"RTN","PSOLLL1",94,0)
 I $G(VAPA(1))=""!(PS55=2) G W
"RTN","PSOLLL1",95,0)
 ; ADD CHECK FOR BAD ADDRESS INDICATOR
"RTN","PSOLLL1",96,0)
 N PSOBADR,PSOTEMP
"RTN","PSOLLL1",97,0)
 S PSOBADR=$$BADADR^DGUTL3(DFN)
"RTN","PSOLLL1",98,0)
 I PSOBADR S PSOTEMP=$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOLLL1",99,0)
 F I=1:1:3 I $G(VAPA(I))]"" D
"RTN","PSOLLL1",100,0)
 . S T="" I I=1,PSOBADR,'$G(PSOTEMP) S T="** BAD ADDRESS INDICATED **"
"RTN","PSOLLL1",101,0)
 . I T="" I 'PSOBADR!$G(PSOTEMP) S T=$G(VAPA(I))
"RTN","PSOLLL1",102,0)
 . D STRT^PSOLLU1("ML",T,.L) I L($E(PSOFONT,2,99))<2.37 D PRINT(T,0) Q
"RTN","PSOLLL1",103,0)
 . F F=12,10,9,8,6 I L(F)<2.37 S OFONT=PSOFONT,PSOFONT="F"_F D PRINT(T,0) S PSOFONT=OFONT Q
"RTN","PSOLLL1",104,0)
 S A=+$G(VAPA(5)) I A S A=$S($D(^DIC(5,A,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL1",105,0)
 S T="" I 'PSOBADR!$G(PSOTEMP) S T=$G(VAPA(4))_", "_A_"  "_$S($G(VAPA(11)):$P(VAPA(11),"^",2),1:$G(VAPA(6)))
"RTN","PSOLLL1",106,0)
 D PRINT(T,0)
"RTN","PSOLLL1",107,0)
W ;
"RTN","PSOLLL1",108,0)
 S T=$S(MW="WINDOW":"WINDOW -",1:"MAIL -")
"RTN","PSOLLL1",109,0)
 N XFONT
"RTN","PSOLLL1",110,0)
 S OFONT=PSOFONT,PSOYI=$G(PSOTYI,40),PSOFONT=PSOTFONT,XFONT=$E(PSOFONT,2,99),PSOY=PSOTY
"RTN","PSOLLL1",111,0)
 I T["WINDOW" D
"RTN","PSOLLL1",112,0)
 . I $G(^PSRX(RX,"MP"))'="" S PSOY=PSOY-PSOYI ; START 1 LINE HIGHER IF METHOD OF PICK-UP
"RTN","PSOLLL1",113,0)
 . S OPSOX=PSOX D PRINT(T,1) S PSOX=PSOX+200,PSOY=PSOY-PSOYI
"RTN","PSOLLL1",114,0)
 . S T=$G(^PSRX(RX,"MP")) I T="" S PSOFONT=OFONT,PSOX=OPSOX Q
"RTN","PSOLLL1",115,0)
 . N FIRST
"RTN","PSOLLL1",116,0)
 . S FIRST=1
"RTN","PSOLLL1",117,0)
 . D STRT^PSOLLU1("ML",T,.L)
"RTN","PSOLLL1",118,0)
 . I L(XFONT)<1.75 D PRINT(T,0) S PSOFONT=OFONT,PSOX=OPSOX Q
"RTN","PSOLLL1",119,0)
 . F F=10,9,8,6 I L(F)<4.5 Q
"RTN","PSOLLL1",120,0)
 . S XFONT=F,PSOFONT="F"_F,PSOYI=$S(PSOFONT="F12":40,PSOFONT="F10":35,PSOFONT="F9":30,PSOFONT="F8":25,1:20)
"RTN","PSOLLL1",121,0)
 . F J=$L(T," "):-1:1 S PTEXT=$P(T," ",1,J) D STRT^PSOLLU1("ML",PTEXT,.L) D  Q:T=""
"RTN","PSOLLL1",122,0)
 .. I FIRST I L(XFONT)<1.75 D PRINT(PTEXT,0) S T=$P(T," ",J+1,512),J=$L(T," ")+1,PTEXT="",FIRST=0,PSOX=OPSOX,PSOY=PSOY+20 Q
"RTN","PSOLLL1",123,0)
 .. I 'FIRST I L(XFONT)<2.3 D PRINT(PTEXT,0) S T=$P(T," ",J+1,512),J=$L(T," ")+1,PTEXT=""
"RTN","PSOLLL1",124,0)
 . D:PTEXT]"" PRINT(PTEXT,0)
"RTN","PSOLLL1",125,0)
 I T="MAIL -" D PRINT(T,1)
"RTN","PSOLLL1",126,0)
 S PSOFONT=OFONT
"RTN","PSOLLL1",127,0)
CONT I $G(SIDE) G BARC:'L5,CONT2
"RTN","PSOLLL1",128,0)
 I $G(COPIES)>1 G BARC
"RTN","PSOLLL1",129,0)
 I 'L2!PFM D ^PSOLLL2 S L2=1
"RTN","PSOLLL1",130,0)
 I 'L3 D ^PSOLLL3 S L3=1
"RTN","PSOLLL1",131,0)
 I 'L4!PMIM S PIMI=0 D ^PSOLLL4 S L4=1
"RTN","PSOLLL1",132,0)
 I L5 W @IOF G CONT2
"RTN","PSOLLL1",133,0)
BARC I $G(BOTTLBL) G BARCE ; ONLY PRINT BARCODE ON 1ST BOTTLE LABEL
"RTN","PSOLLL1",134,0)
 S BOTTLBL=1
"RTN","PSOLLL1",135,0)
 I $G(PSOIO("BLBC"))]"" X PSOIO("BLBC") I $G(NOBARC) G BARCE
"RTN","PSOLLL1",136,0)
 S X2=PSOINST_"-"_RX W X2
"RTN","PSOLLL1",137,0)
 I $G(PSOIO("EBLBC"))]"" X PSOIO("EBLBC")
"RTN","PSOLLL1",138,0)
BARCE W @IOF
"RTN","PSOLLL1",139,0)
COPY I SIGF S SIGM=1 G L1 ; NEED TO FINISH PRINTING CONTINUED BOTTLE LABEL
"RTN","PSOLLL1",140,0)
 S FILLCONT=0 I PFM!PMIM S FILLCONT=1 G L1
"RTN","PSOLLL1",141,0)
 I $G(COPIES)>1 D  G L1
"RTN","PSOLLL1",142,0)
 . S COPIES=COPIES-1
"RTN","PSOLLL1",143,0)
 . S (SIGM,PFM,PMIM,L2,L3,L4,L5,BOTTLBL)=0
"RTN","PSOLLL1",144,0)
 . K SIGF,PFF,PMIF S (SIGF,PFF,PMIF)=0 F I="DR","T" S (SIGF(I),PFF(I))=1
"RTN","PSOLLL1",145,0)
 . F I="A","B","I" S PMIF(I)=1
"RTN","PSOLLL1",146,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOLLL1",147,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLLL1",148,0)
 S ^PSRX(RX,"L",IR,0)=PSOFNOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_$S($G(PCOMX)]"":$G(PCOMX),$G(PCOMH(RX))]"":PCOMH(RX),1:"From RX number "_$P(^PSRX(RX,0),"^"))_$S($G(RXP):" (Partial)",1:"")_$S($D(REPRINT):" (Reprint)",1:"")_"^"_PDUZ
"RTN","PSOLLL1",149,0)
 N PSOBADR,PSOTEMP
"RTN","PSOLLL1",150,0)
 S PSOBADR=$$CHKRX^PSOBAI(RX)
"RTN","PSOLLL1",151,0)
 I $G(PSOBADR) S PSOTEMP=$P(PSOBADR,"^",2),PSOBADR=$P(PSOBADR,"^")
"RTN","PSOLLL1",152,0)
 I $G(PSOBADR),'$G(PSOTEMP) D
"RTN","PSOLLL1",153,0)
 .S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLLL1",154,0)
 .S ^PSRX(RX,"L",IR,0)=PSOFNOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_"ROUTING="_$G(MW)_" (BAD ADDRESS)"_"^"_PDUZ
"RTN","PSOLLL1",155,0)
 S L5=1
"RTN","PSOLLL1",156,0)
CONT2 I SIGF S SIGM=1 G L1 ; MORE BOTTLE LABEL SIG TO PRINT
"RTN","PSOLLL1",157,0)
 I PMIM G CONT ; MORE PMI INFO TO PRINT
"RTN","PSOLLL1",158,0)
 I $G(PSOBLALL)=1,$P(PPL,",",PI+1)="" D TRAIL
"RTN","PSOLLL1",159,0)
 Q
"RTN","PSOLLL1",160,0)
PRINT(T,B) ;
"RTN","PSOLLL1",161,0)
 S BOLD=$G(B)
"RTN","PSOLLL1",162,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL1",163,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLL1",164,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL1",165,0)
 W T,!
"RTN","PSOLLL1",166,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL1",167,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLL1",168,0)
 Q
"RTN","PSOLLL1",169,0)
TRAIL I $G(SIDE) G END
"RTN","PSOLLL1",170,0)
 D ^PSOLLL5
"RTN","PSOLLL1",171,0)
 D ^PSOLLLH
"RTN","PSOLLL1",172,0)
 D ^PSOLLL6
"RTN","PSOLLL1",173,0)
 I '$P($G(^PS(59,PSOSITE,1)),"^",18) Q
"RTN","PSOLLL1",174,0)
 I '$G(REPRINT) D ^PSOLLL7
"RTN","PSOLLL1",175,0)
END I '$P(PSOPAR,"^",31) Q
"RTN","PSOLLL1",176,0)
 W @IOF
"RTN","PSOLLL1",177,0)
 I $G(PSOIO("PMII"))]"" X PSOIO("PMII")
"RTN","PSOLLL1",178,0)
 I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL1",179,0)
 S T="NEXT PATIENT"
"RTN","PSOLLL1",180,0)
 S PSOX=1100-(L($E(PSOFONT,2,99))*300/2)
"RTN","PSOLLL1",181,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL1",182,0)
 W T,!
"RTN","PSOLLL1",183,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL1",184,0)
 Q
"RTN","PSOLLL1",185,0)
 ;
"RTN","PSOLLL2")
0^12^B16255333^B14143460
"RTN","PSOLLL2",1,0)
PSOLLL2 ;BIR/JLC-LASER LABEL ;11/19/02
"RTN","PSOLLL2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,138,141,161,200**;DEC 1997;Build 7
"RTN","PSOLLL2",3,0)
 ;
"RTN","PSOLLL2",4,0)
 ;Reference to $$ECMEON^BPSUTIL supported by DBIA 4410
"RTN","PSOLLL2",5,0)
L1 I $G(PSOIO("PFDI"))]"" X PSOIO("PFDI")
"RTN","PSOLLL2",6,0)
 I '$G(PFF) D
"RTN","PSOLLL2",7,0)
 .N PGY
"RTN","PSOLLL2",8,0)
 .M PGY=SGY I $D(OSGY) K PGY M PGY=OSGY
"RTN","PSOLLL2",9,0)
 .D COUNTSGF^PSOLLLW
"RTN","PSOLLL2",10,0)
 S PFM=0,T=$S($D(REPRINT)&($G(PSOBLALL)):"(GROUP REPRINT)",$D(REPRINT):"(REPRINT)",1:"")
"RTN","PSOLLL2",11,0)
 S T=T_$S($G(RXP):"(PARTIAL)",1:"")_$S($D(REPRINT):" ",$G(RXP):" ",1:"")_$P(PS2,"^",2)_"  "_TECH_"  "_$P(PSONOWT,":",1,2) D PRINT(T)
"RTN","PSOLLL2",12,0)
 S T="Rx# "_RXN_"  "_DATE_"  "_$S('PFF:"Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9)),1:"(fill document continued)") D PRINT(T)
"RTN","PSOLLL2",13,0)
 S T=PNM_"  "_$G(SSNPN) D PRINT(T,1)
"RTN","PSOLLL2",14,0)
 S LENGTH=0,PTEXT="",PFF=0,XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL2",15,0)
 N DP,TEXTP,TEXTL,MORE
"RTN","PSOLLL2",16,0)
 S DR=PFF("DR")
"RTN","PSOLLL2",17,0)
 F I=1:1 Q:'$D(NPGY(DR,I))  S TEXT=NPGY(DR,I) D PRINT(TEXT)
"RTN","PSOLLL2",18,0)
 I I>4,$D(NPGY(DR,5)) S PFF=1,PFF("DR")=DR+1
"RTN","PSOLLL2",19,0)
 S OPSOY=PSOY
"RTN","PSOLLL2",20,0)
 I $G(PSOIO("PFDQ"))]"" X PSOIO("PFDQ")
"RTN","PSOLLL2",21,0)
 I PFF S PSOX=PSOCX,PSOY=OPSOY,T="(continued on next fill document)" S PFM=1 D PRINT(T) Q
"RTN","PSOLLL2",22,0)
 K NPGY,^TMP($J,"PSOSIGF")
"RTN","PSOLLL2",23,0)
 S XFONT=$E(PSOQFONT,2,99)
"RTN","PSOLLL2",24,0)
 S TEXT="Qty: " D STRT^PSOLLU1("SIG2",TEXT,.L) S Q(1)=L(XFONT)
"RTN","PSOLLL2",25,0)
 S TEXT=" "_PSDU D STRT^PSOLLU1("SIG2",TEXT,.L) S Q(2)=L(XFONT)
"RTN","PSOLLL2",26,0)
 S TEXT="       "_$G(PHYS) D STRT^PSOLLU1("SIG2",TEXT,.L) S Q(3)=L(XFONT)
"RTN","PSOLLL2",27,0)
 S PPHYS=$G(PHYS)
"RTN","PSOLLL2",28,0)
 S TEXT=$G(QTY) D STRT^PSOLLU1("SIG2",TEXT,.L) S LENGTH=Q(1)+Q(2)+Q(3)+L(XFONT+2),Q(4)=L(XFONT+2)
"RTN","PSOLLL2",29,0)
 I LENGTH>3.7 F I=$L(PHYS)-1:-1:1 S PPHYS=$E(PHYS,1,I),TEXT="       "_PPHYS D STRT^PSOLLU1("SIG2",TEXT,.L) I Q(1)+Q(2)+Q(4)+L(XFONT)<3.7 Q
"RTN","PSOLLL2",30,0)
 S OPSOX=PSOX,PSOX=Q(1)*300+OPSOX,T=$G(QTY) D PRINT(T) S PSOX=OPSOX
"RTN","PSOLLL2",31,0)
 S PSOFONT=PSOQFONT,PSOY=PSOY-PSOYI,T="Qty: " D PRINT(T)
"RTN","PSOLLL2",32,0)
 S PSOY=PSOY-PSOYI,PSOX=Q(1)+Q(4)*300+OPSOX,T=" "_$G(PSDU)_"       "_$G(PPHYS) D PRINT(T)
"RTN","PSOLLL2",33,0)
 I $G(PSOIO("PFDT"))]"" X PSOIO("PFDT")
"RTN","PSOLLL2",34,0)
 S T=DRUG D PRINT(T)
"RTN","PSOLLL2",35,0)
L11 ;
"RTN","PSOLLL2",36,0)
 N NDCTEXT
"RTN","PSOLLL2",37,0)
 S NDCTEXT="NDC/MFR_______________"
"RTN","PSOLLL2",38,0)
 I $$ECMEON^BPSUTIL($$RXSITE^PSOBPSUT(RX,RXF)) S NDCTEXT="NDC "_$$GETNDC^PSONDCUT(RX,RXF)
"RTN","PSOLLL2",39,0)
 S OPSOX=PSOX,T=NDCTEXT D PRINT(T)
"RTN","PSOLLL2",40,0)
 S T="Lot# ___________________" D STRT^PSOLLU1("SIG2",T,.L)
"RTN","PSOLLL2",41,0)
 S PSOY=PSOY-PSOYI,PSOX=L(XFONT+2)*300+OPSOX,T="Lot# _____________________" D PRINT(T)
"RTN","PSOLLL2",42,0)
L12 S PSOX=OPSOX,T="Tech___________________    RPh _____________________" D PRINT(T)
"RTN","PSOLLL2",43,0)
 S PSOFONT=PSOTFONT
"RTN","PSOLLL2",44,0)
 S T="Routing: "_$S("W"[$E(MW):MW,PS55=2:"DO NOT MAIL",1:MW_" MAIL")_"    Days supply: "_$G(DAYS)_"     Cap: "_$S('PSCAP:"SAFETY",1:"") D PRINT(T)
"RTN","PSOLLL2",45,0)
 I PSCAP D
"RTN","PSOLLL2",46,0)
 .D STRT^PSOLLU1("SIG2",T,.L) S LENGTH=L(XFONT+1)
"RTN","PSOLLL2",47,0)
 .S OPSOX=PSOX,T="NON-SAFETY",PSOX=LENGTH*300+OPSOX,PSOY=PSOY-PSOYI D PRINT(T,1) S PSOX=OPSOX
"RTN","PSOLLL2",48,0)
 S T="Isd: "_ISD_"    Exp: "_EXPDT_"    Last Fill: "_$G(PSOFLAST) D PRINT(T)
"RTN","PSOLLL2",49,0)
 S PSOYI=PSOBYI,PSOY=PSOBY
"RTN","PSOLLL2",50,0)
 I $G(PSOIO("SBT"))]"" X PSOIO("SBT")
"RTN","PSOLLL2",51,0)
 S X2=PSOINST_"-"_RX
"RTN","PSOLLL2",52,0)
 W X2
"RTN","PSOLLL2",53,0)
 I $G(PSOIO("EBT"))]"" X PSOIO("EBT")
"RTN","PSOLLL2",54,0)
 I $G(PSOIO("PFDW"))]"" X PSOIO("PFDW")
"RTN","PSOLLL2",55,0)
 S XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL2",56,0)
 I $G(WARN)'="" S PTEXT="DRUG WARNING " D STRT^PSOLLU1("SIG2",PTEXT,.L) S LENGTH=L(XFONT) D
"RTN","PSOLLL2",57,0)
 . F I=1:1:$L(WARN,",") S TEXT=$P(WARN,",",I)_"," D
"RTN","PSOLLL2",58,0)
 .. D STRT^PSOLLU1("SIG2",TEXT,.L)
"RTN","PSOLLL2",59,0)
 .. I LENGTH+L(XFONT)<1.8 S PTEXT=PTEXT_TEXT,LENGTH=LENGTH+L(XFONT) Q
"RTN","PSOLLL2",60,0)
 .. S LENGTH=0,I=I-1
"RTN","PSOLLL2",61,0)
 .. S T=$P(PTEXT,",",1,$L(PTEXT,",")-1) D PRINT(T) S PTEXT=""
"RTN","PSOLLL2",62,0)
 .. I PSOY>PSOYM W "*"
"RTN","PSOLLL2",63,0)
 . I PTEXT]"" S T=$P(PTEXT,",",1,$L(PTEXT,",")-1) D PRINT(T)
"RTN","PSOLLL2",64,0)
 S PTEXT="Pat. Stat "_PATST_" Clinic: "_PSCLN D STRT^PSOLLU1("SIG2",PTEXT,.L) S T=PTEXT D PRINT(T)
"RTN","PSOLLL2",65,0)
 Q
"RTN","PSOLLL2",66,0)
 ;
"RTN","PSOLLL2",67,0)
PRINT(T,B) ;
"RTN","PSOLLL2",68,0)
 S BOLD=$G(B)
"RTN","PSOLLL2",69,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL2",70,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLL2",71,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL2",72,0)
 W T,!
"RTN","PSOLLL2",73,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL2",74,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLL2",75,0)
 Q
"RTN","PSOLLL3")
0^3^B7197716^B8025943
"RTN","PSOLLL3",1,0)
PSOLLL3 ;BHAM/JLC - LASER LABELS ;11/20/02
"RTN","PSOLLL3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,161,148,200**;DEC 1997;Build 7
"RTN","PSOLLL3",3,0)
 ;
"RTN","PSOLLL3",4,0)
 S PRCOPAY=$S('$D(PSOCPN):0,1:1)
"RTN","PSOLLL3",5,0)
PF ;PATIENT FILL DOCUMENT
"RTN","PSOLLL3",6,0)
 I $G(PSOIO("PFI"))]"" X PSOIO("PFI")
"RTN","PSOLLL3",7,0)
 D  S PSOFONT=OFONT
"RTN","PSOLLL3",8,0)
 . S OFONT=PSOFONT,PSOFONT=PSOHFONT
"RTN","PSOLLL3",9,0)
 . I $P(RXY,"^",9)=0 S T="NO REFILL for this prescription" D PRINT(T,1,1) S PSOY=PSOY+PSOYI Q
"RTN","PSOLLL3",10,0)
 . I RXF+1=(1+$P(RXY,"^",9)) S T="NO REFILLS LEFT for this prescription" D PRINT(T,1,1) S PSOY=PSOY+PSOYI Q
"RTN","PSOLLL3",11,0)
 . S T="PHONE IN OR MAIL THIS REFILL REQUEST" D PRINT(T,1,1)
"RTN","PSOLLL3",12,0)
 . S PSOFONT=OFONT,T="Follow the refill instructions provided with your prescription." D PRINT(T,0,1)
"RTN","PSOLLL3",13,0)
 . S PSOFONT=OFONT,OPSOX=PSOX,PSOX=PSOX+300,T="For Refill Call "_$P(PS,"^",3)_"-"_$P(PS,"^",4) D PRINT(T,0) S PSOX=OPSOX
"RTN","PSOLLL3",14,0)
 S T=PNM_"  "_$G(SSNPN) D PRINT(T,1)
"RTN","PSOLLL3",15,0)
 S T="Rx# "_RXN_"   " D PRINT(T,1)
"RTN","PSOLLL3",16,0)
 D STRT^PSOLLU1("SEC2",T,.L) S OPSOX=PSOX,PSOX=L($E(PSOFONT,2,99))*300+PSOX
"RTN","PSOLLL3",17,0)
 S T=DATE_"  Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9)),PSOY=PSOY-PSOYI D PRINT(T) S PSOX=OPSOX
"RTN","PSOLLL3",18,0)
 S T=$S($$STATUS^PSOBPSUT(RX,+RXF)'="":"3rd Party Rx",1:"") D PRINT(T,1)
"RTN","PSOLLL3",19,0)
 S T="Qty: "_$G(QTY)_"  "_$G(PSDU)_"    Days supply: "_$G(DAYS) D PRINT(T,0)
"RTN","PSOLLL3",20,0)
 S T=DRUG D PRINT(T,0)
"RTN","PSOLLL3",21,0)
 S T=$$GETNDC^PSONDCUT(RX,RXF) D PRINT(T,1)
"RTN","PSOLLL3",22,0)
 D  D PRINT(T,1)
"RTN","PSOLLL3",23,0)
 . S NOR=$P(RXY,"^",9)-RXF
"RTN","PSOLLL3",24,0)
 . I $P(RXY,"^",9)=0 S T="NO REFILL" Q
"RTN","PSOLLL3",25,0)
 . I NOR=0 S T="NO REFILLS LEFT" Q
"RTN","PSOLLL3",26,0)
 . S T="May refill "_NOR_"X by "_EXPDT
"RTN","PSOLLL3",27,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLL3",28,0)
 D PRINT(COPAYVAR)
"RTN","PSOLLL3",29,0)
 S T=$P(PS,"^")_"-"_$P(PS,"^",6) D STRT^PSOLLU1("SEC2",T,.L)
"RTN","PSOLLL3",30,0)
 S OPSOX=PSOX,PSOX=2340-(L($E(PSOFONT,2,99))*300),PSOY=PSOY-PSOYI
"RTN","PSOLLL3",31,0)
 D PRINT(T)
"RTN","PSOLLL3",32,0)
 S PSOX=OPSOX,PSOYI=PSOBYI
"RTN","PSOLLL3",33,0)
 I $G(PSOIO("SBT"))]"" X PSOIO("SBT")
"RTN","PSOLLL3",34,0)
 S X2=PSOINST_"-"_RX
"RTN","PSOLLL3",35,0)
 W X2
"RTN","PSOLLL3",36,0)
 I $G(PSOIO("EBT"))]"" X PSOIO("EBT")
"RTN","PSOLLL3",37,0)
 I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL3",38,0)
 Q
"RTN","PSOLLL3",39,0)
PRINT(T,BOLD,HDR) ;
"RTN","PSOLLL3",40,0)
 S BOLD=+$G(BOLD),HDR=+$G(HDR)
"RTN","PSOLLL3",41,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL3",42,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLL3",43,0)
 I HDR D
"RTN","PSOLLL3",44,0)
 . S OPSOX=PSOX D STRT^PSOLLU1("SEC2",T,.L)
"RTN","PSOLLL3",45,0)
 . S PSOX=4.2-L($E(PSOFONT,2,99))*300/2+OPSOX
"RTN","PSOLLL3",46,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL3",47,0)
 W T,!
"RTN","PSOLLL3",48,0)
 I HDR S PSOX=OPSOX
"RTN","PSOLLL3",49,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL3",50,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLL3",51,0)
 Q
"RTN","PSOLLL5")
0^4^B37264779^B37280292
"RTN","PSOLLL5",1,0)
PSOLLL5 ;BIR/RJS - LASER LABEL CONTINUED ;11/14/05 10:09am
"RTN","PSOLLL5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,161,230,200**;DEC 1997;Build 7
"RTN","PSOLLL5",3,0)
 ;
"RTN","PSOLLL5",4,0)
START ;
"RTN","PSOLLL5",5,0)
 N TEXT,BLNKLIN
"RTN","PSOLLL5",6,0)
 S $P(BLNKLIN,"_",90)="_"
"RTN","PSOLLL5",7,0)
 D MAIL^PSOLLL7
"RTN","PSOLLL5",8,0)
 I $G(PSOIO("ACI"))]"" X PSOIO("ACI")
"RTN","PSOLLL5",9,0)
 S TEXT="HAS YOUR ADDRESS CHANGED?" D STRT^PSOLLU1("SEC2",TEXT,.L)
"RTN","PSOLLL5",10,0)
 S OPSOX=PSOX,PSOX=4.2-L($E(PSOHFONT,2,99))*300/2+OPSOX
"RTN","PSOLLL5",11,0)
 S OFONT=PSOFONT,PSOFONT=$G(PSOHFONT,OFONT) D PRINT(TEXT,1) S PSOX=OPSOX,PSOY=PSOY+10,PSOFONT=OFONT
"RTN","PSOLLL5",12,0)
 S TEXT="Write address changes in the blanks, sign the form, and return to" D PRINT(TEXT,0)
"RTN","PSOLLL5",13,0)
 S TEXT="your pharmacy." D PRINT(TEXT,0)
"RTN","PSOLLL5",14,0)
 S X=$S($D(^DPT(DFN,0))#2:^(0),1:""),PNM=$P(X,"^")
"RTN","PSOLLL5",15,0)
 D PID^VADPT6,ADD^VADPT S SSNP=$G(VA("BID"))
"RTN","PSOLLL5",16,0)
 S PSOY=PSOY+PSOYI,TEXT=PNM_"  "_SSNP D PRINT(TEXT,0)
"RTN","PSOLLL5",17,0)
 I $G(VAPA(1))="" G ALLERGY
"RTN","PSOLLL5",18,0)
 F I=1:1:3 I $G(VAPA(I))]"" S TEXT=$G(VAPA(I))_$E(BLNKLIN,1,80-$L(VAPA(I))) D PRINT(TEXT,0)
"RTN","PSOLLL5",19,0)
 S A=+$G(VAPA(5)) I A S A=$S($D(^DIC(5,A,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL5",20,0)
 S B=$G(VAPA(4))_", "_A_"  "_$S($G(VAPA(11)):$P(VAPA(11),"^",2),1:$G(VAPA(6)))
"RTN","PSOLLL5",21,0)
 S TEXT=B_$E(BLNKLIN,1,80-$L(B)) D PRINT(TEXT,0)
"RTN","PSOLLL5",22,0)
 S B=VAPA(8)
"RTN","PSOLLL5",23,0)
 S TEXT=B_$E(BLNKLIN,1,80-$L(B)) D PRINT(TEXT,0)
"RTN","PSOLLL5",24,0)
 S:$G(VAPA(3))="" PSOY=PSOY+PSOYI
"RTN","PSOLLL5",25,0)
 S TEXT="[   ] Permanent                     [   ] Temporary until ____/____/____" D PRINT(TEXT,0)
"RTN","PSOLLL5",26,0)
 S PSOY=$G(PSOFY),TEXT="Signature "_$E(BLNKLIN,1,45) D PRINT(TEXT,0)
"RTN","PSOLLL5",27,0)
 ;
"RTN","PSOLLL5",28,0)
ALLERGY ;ALLERGIES & REACTIONS
"RTN","PSOLLL5",29,0)
 K ^TMP($J,"PSOALWA")
"RTN","PSOLLL5",30,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSOLLL5",31,0)
 I $G(GMRAL) S PSORY=0 F  S PSORY=$O(GMRAL(PSORY)) Q:'PSORY  S ^TMP($J,"PSOALWA",$S($P(GMRAL(PSORY),"^",4):1,1:2),$S('$P(GMRAL(PSORY),"^",5):1,1:2),$P(GMRAL(PSORY),"^",7),$P(GMRAL(PSORY),"^",2))=""
"RTN","PSOLLL5",32,0)
 S ^TMP($J,"PSOAPT",1)=$G(PNM)_"  "_$G(SSNP),^(2)="Verified Allergies"
"RTN","PSOLLL5",33,0)
 S ALCNT=0,EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)=PSOLGA
"RTN","PSOLLL5",34,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)="NKA"
"RTN","PSOLLL5",35,0)
 S ALCNT=0,^TMP($J,"PSOAPT",3)="Non-Verified Allergies"
"RTN","PSOLLL5",36,0)
 S EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=EEE+1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)=PSOLGA
"RTN","PSOLLL5",37,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)="NKA"
"RTN","PSOLLL5",38,0)
 S ALCNT=0,^TMP($J,"PSOAPT",4)="Verified Adverse Reactions"
"RTN","PSOLLL5",39,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",4,ALCNT)=PSOLGA
"RTN","PSOLLL5",40,0)
 S ALCNT=0,^TMP($J,"PSOAPT",5)="Non-Verified Adverse Reactions"
"RTN","PSOLLL5",41,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",5,ALCNT)=PSOLGA
"RTN","PSOLLL5",42,0)
 I $G(PSOIO("ALI"))]"" X PSOIO("ALI")
"RTN","PSOLLL5",43,0)
 S XFONT=$E($G(PSOFONT),2,99)
"RTN","PSOLLL5",44,0)
 S OFONT=PSOFONT,PSOFONT=$G(PSOHFONT,PSOFONT) S TEXT=^TMP($J,"PSOAPT",1) D PRINT(TEXT,1) S PSOFONT=OFONT
"RTN","PSOLLL5",45,0)
 I $$GET1^DIQ(44,$P(RXY,"^",5),2,"I")="W" S TEXT="INPATIENT" D PRINT(TEXT,0)
"RTN","PSOLLL5",46,0)
 F CCC=3,4,5 I '$O(^TMP($J,"PSOAPT",CCC,0)) K ^TMP($J,"PSOAPT",CCC)
"RTN","PSOLLL5",47,0)
 D ASSESS
"RTN","PSOLLL5",48,0)
 I CCC="NKA" S ^TMP($J,"PSOAPT",2,1)="No Known Allergies" K ^TMP($J,"PSOAPT",3)
"RTN","PSOLLL5",49,0)
 S CCC=1,OUT=0
"RTN","PSOLLL5",50,0)
 F  S CCC=$O(^TMP($J,"PSOAPT",CCC)) Q:CCC=""  D  Q:OUT
"RTN","PSOLLL5",51,0)
 .S TEXT=$G(^TMP($J,"PSOAPT",CCC))
"RTN","PSOLLL5",52,0)
 .I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL5",53,0)
 .S PSOY=PSOY+PSOYI D PRINT(TEXT,0,1)
"RTN","PSOLLL5",54,0)
 .I TEXT="No Assessment Made" Q
"RTN","PSOLLL5",55,0)
 .I PSOY>PSOYM S OUT=1 Q
"RTN","PSOLLL5",56,0)
 .S (TEXT,PTEXT,CCC2)="",LENGTH=0
"RTN","PSOLLL5",57,0)
 .F  S CCC2=$O(^TMP($J,"PSOAPT",CCC,CCC2)) Q:CCC2=""  S TEXT=^(CCC2) D  Q:OUT
"RTN","PSOLLL5",58,0)
 ..D STRT^PSOLLU1("SEC2",TEXT,.L)
"RTN","PSOLLL5",59,0)
 ..I LENGTH+L(XFONT)<3.7 S PTEXT=PTEXT_TEXT_",",LENGTH=LENGTH+L(XFONT) Q
"RTN","PSOLLL5",60,0)
 ..I PTEXT="" D  Q
"RTN","PSOLLL5",61,0)
 ... F JJ=$L(TEXT):-1 S PTEXT=$E(TEXT,1,JJ) D STRT^PSOLLU1("SEC2",PTEXT,.L) I L(XFONT)<3.7 D PRINT(PTEXT,0) S PTEXT=$E(TEXT,JJ+1,512)_"," Q
"RTN","PSOLLL5",62,0)
 ... D STRT^PSOLLU1("SEC2",PTEXT,.L) S LENGTH=L(XFONT)
"RTN","PSOLLL5",63,0)
 ..S LENGTH=0,CCC2=CCC2-1
"RTN","PSOLLL5",64,0)
 ..I PSOY>PSOYM S OUT=1 Q
"RTN","PSOLLL5",65,0)
 ..D PRINT(PTEXT,0) S PTEXT=""
"RTN","PSOLLL5",66,0)
 .I 'OUT,PTEXT]"" D PRINT($P(PTEXT,",",1,$L(PTEXT,",")-1),0)
"RTN","PSOLLL5",67,0)
 I OUT S T="Additional Allergies or Adverse Reactions Exist." D PRINT(T,0) S T="Talk to your Physician or Pharmacist." D PRINT(T,0)
"RTN","PSOLLL5",68,0)
 K ^TMP($J,"PSOALWA"),^TMP($J,"PSOAPT"),PSONKA,PSONULL,WWW,GMRA,GMRAL,JJJ,WCNT,RRR,ALG,ALCNT,EEE,FFF,PSOLG,PSOLGA,PSORY,CCC,CCC2,FNTFLG,TEXT,TEXT2
"RTN","PSOLLL5",69,0)
SUSPEN S PSODFN=DFN,(SPPL,RXX,STA)="",XXS=1
"RTN","PSOLLL5",70,0)
 I $G(PSODTCUT)']"" S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X
"RTN","PSOLLL5",71,0)
 D ^PSOBUILD S (STA,RXX)=""
"RTN","PSOLLL5",72,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S RXX=$O(PSOSD(STA,RXX)) Q:RXX=""  I $P(PSOSD(STA,RXX),"^",2)=5 S SPPL=$P(PSOSD(STA,RXX),"^")_","_SPPL
"RTN","PSOLLL5",73,0)
 I SPPL="" Q
"RTN","PSOLLL5",74,0)
SUSP1 I $G(PSOIO("SPI"))]"" X PSOIO("SPI")
"RTN","PSOLLL5",75,0)
 S TOF=0,TEXT=PNM_" "_SSNP_" "_$G(PSONOW) D PRINT(TEXT,0)
"RTN","PSOLLL5",76,0)
 S TEXT="The following prescription(s) have been requested and will be" D PRINT(TEXT,0)
"RTN","PSOLLL5",77,0)
 S TEXT="mailed to you on or after the date indicated." D PRINT(TEXT,0)
"RTN","PSOLLL5",78,0)
 S PSOY=PSOY+PSOYI,TEXT="Rx#                                          Date                                        "
"RTN","PSOLLL5",79,0)
 D PRINT(TEXT,0,1)
"RTN","PSOLLL5",80,0)
 F XX=XXS:1 Q:$P(SPPL,",",XX)=""  S RX=$P(SPPL,",",XX) D  Q:TOF
"RTN","PSOLLL5",81,0)
 . S SPNUM=$O(^PS(52.5,"B",RX,0)) I SPNUM S SPDATE=$P($G(^PS(52.5,SPNUM,0)),"^",2) S Y=SPDATE X ^DD("DD") S SPDATE=Y
"RTN","PSOLLL5",82,0)
 . S T=$P(^PSRX(RX,0),"^") D PRINT(T,0)
"RTN","PSOLLL5",83,0)
 . S PSOY=PSOY-PSOYI,OPSOX=PSOX,PSOX=PSOCX,T=$G(SPDATE) D PRINT(T,0)
"RTN","PSOLLL5",84,0)
 . S PSOX=OPSOX+20,T=$$ZZ^PSOSUTL(RX) D PRINT(T,0) K SPNUM,SPDATE,Y,ZDRUG
"RTN","PSOLLL5",85,0)
 . S PSOX=OPSOX,PSOY=PSOY+PSOYI
"RTN","PSOLLL5",86,0)
 . I PSOY>PSOYM S XXS=XX+1,TOF=1 W:$P(SPPL,",",XXS)]"" @IOF Q
"RTN","PSOLLL5",87,0)
 I TOF,$P(SPPL,",",XXS)]"" G SUSP1
"RTN","PSOLLL5",88,0)
 Q
"RTN","PSOLLL5",89,0)
PRINT(T,B,UL) ;
"RTN","PSOLLL5",90,0)
 S BOLD=$G(B),UL=$G(UL)
"RTN","PSOLLL5",91,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL5",92,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLL5",93,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL5",94,0)
 I UL,$G(PSOIO("FWU"))]"" X PSOIO("FWU")
"RTN","PSOLLL5",95,0)
 W T,!
"RTN","PSOLLL5",96,0)
 I UL,$G(PSOIO("FDU"))]"" X PSOIO("FDU")
"RTN","PSOLLL5",97,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL5",98,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLL5",99,0)
 Q
"RTN","PSOLLL5",100,0)
ASSESS ;
"RTN","PSOLLL5",101,0)
 N FLG3,FLG4,FLG5
"RTN","PSOLLL5",102,0)
 S CCC=$G(^TMP($J,"PSOAPT",2,1))
"RTN","PSOLLL5",103,0)
 S FLG3=$G(^TMP($J,"PSOAPT",3,1))
"RTN","PSOLLL5",104,0)
 S FLG4=$G(^TMP($J,"PSOAPT",4,1))
"RTN","PSOLLL5",105,0)
 S FLG5=$G(^TMP($J,"PSOAPT",5,1))
"RTN","PSOLLL5",106,0)
 I CCC="",FLG3="",FLG4="",FLG5="" S ^TMP($J,"PSOAPT",2,1)="No Assessment Made" K ^TMP($J,"PSOAPT",3)
"RTN","PSOLLL5",107,0)
 Q
"RTN","PSOLLL7")
0^5^B34122114^B34188197
"RTN","PSOLLL7",1,0)
PSOLLL7 ;BHAM/JLC - LASER LABEL MULTI RX REFILL REQUEST FORM ;12/12/92
"RTN","PSOLLL7",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,161,200**;DEC 1997;Build 7
"RTN","PSOLLL7",3,0)
 ;
"RTN","PSOLLL7",4,0)
 ;Reference to ^PS(59.7 supported by DBIA 694
"RTN","PSOLLL7",5,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSOLLL7",6,0)
 ;Read-only reference to %ZIS(2 supported by DBIA 3435
"RTN","PSOLLL7",7,0)
 ;
"RTN","PSOLLL7",8,0)
EN D MAIL
"RTN","PSOLLL7",9,0)
 I $G(PSOIO("PII"))]"" X PSOIO("PII")
"RTN","PSOLLL7",10,0)
 S T="Use the adhesive label above to mail prescription" D PRINT(T)
"RTN","PSOLLL7",11,0)
 S T="documents to your pharmacy." D PRINT(T)
"RTN","PSOLLL7",12,0)
REFILL Q:'DFN  S PS1=$G(^PS(59,PSOSITE,1)),PSOSITE7=$G(^("IB")),PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOLLL7",13,0)
 I '$D(PSSPND) F PSRX=0:0 S PSRX=$O(RX(PSRX)) Q:'PSRX  K RX(PSRX)
"RTN","PSOLLL7",14,0)
 S BLNKLIN="",$P(BLNKLIN,"_",45)="_"
"RTN","PSOLLL7",15,0)
 F PSRX=0:0 S PSRX=$O(^PS(55,DFN,"P",PSRX)) Q:'PSRX  D RZX
"RTN","PSOLLL7",16,0)
 ;NEW LABEL
"RTN","PSOLLL7",17,0)
 S PSOX=0
"RTN","PSOLLL7",18,0)
DOCNEW I $G(PSOIO("RPI"))]"" X PSOIO("RPI")
"RTN","PSOLLL7",19,0)
 S PSOYI=PSOTYI,PSOX=PSOLX,ORIGY=PSOY
"RTN","PSOLLL7",20,0)
 D HDR S PSA=0
"RTN","PSOLLL7",21,0)
 F J=1:1 S PSA=$O(RX(PSA)) Q:'PSA  D SCRPTNEW
"RTN","PSOLLL7",22,0)
 I $O(RX(0))="" G EXIT
"RTN","PSOLLL7",23,0)
 I PSOY=ORIGY G EXIT
"RTN","PSOLLL7",24,0)
 S PSOYI=PSOSYI,T=BLNKLIN D PRINT(T) S PSOYI=PSOTYI
"RTN","PSOLLL7",25,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLL7",26,0)
 S T="Patient's Signature & Date        "_$P(PS,"^",6)_"     "_PSONOW D PRINT(T)
"RTN","PSOLLL7",27,0)
EXIT K PSINF,AMC,PSA,PSDFN,PSDO,PSDT2,PSRFL,PSRX,PSLN,PSRXX,PSSS,PSST,PSOCR,DIWL,DIWR,DIWF,PSO9
"RTN","PSOLLL7",28,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOLLL7",29,0)
 Q
"RTN","PSOLLL7",30,0)
SCRPTNEW S T="____"_$$ZZ^PSOSUTL(PSA) K ZDRUG D PRINT(T) S PSOYI=PSOTYI
"RTN","PSOLLL7",31,0)
 D DTCONNW
"RTN","PSOLLL7",32,0)
 S PSOYI=PSOTYI,OPSOX=PSOX,PSOX=PSOX+PSOXI,T="Refills "_$P(RX(PSA),"^",2)_"   Exp "_PSDT2_"    Rx# "_$P(^PSRX(PSA,0),"^") K TN D PRINT(T)
"RTN","PSOLLL7",33,0)
 S PSOYI=PSOBYI
"RTN","PSOLLL7",34,0)
 I $G(PSOIO("SBT"))]"" X PSOIO("SBT")
"RTN","PSOLLL7",35,0)
 S X2=PSOINST_"-"_PSA,PSOX=PSOX+PSOXI
"RTN","PSOLLL7",36,0)
 W X2
"RTN","PSOLLL7",37,0)
 I $G(PSOIO("EBT"))]"" X PSOIO("EBT")
"RTN","PSOLLL7",38,0)
 S PSOX=OPSOX
"RTN","PSOLLL7",39,0)
 I PSOY>PSOYM D  D:$O(RX(PSA)) HDR Q
"RTN","PSOLLL7",40,0)
 .S T=BLNKLIN,PSOYI=PSOSYI D PRINT(T) S PSOYI=PSOTYI
"RTN","PSOLLL7",41,0)
 .S T="Patient's Signature & Date         "_$P(PS,"^",6)_"     "_PSONOW D PRINT(T)
"RTN","PSOLLL7",42,0)
 .S PSOY=ORIGY,PSOYI=PSOTYI
"RTN","PSOLLL7",43,0)
 .I PSOX=PSORX S PSOX=PSOLX W @IOF Q
"RTN","PSOLLL7",44,0)
 .S PSOX=PSORX
"RTN","PSOLLL7",45,0)
 Q
"RTN","PSOLLL7",46,0)
DTCONNW S PSDT2=$P(RX(PSA),"^"),PSDT2=$E(PSDT2,4,5)_"/"_$E(PSDT2,6,7)_"/"_($E(PSDT2,1,3)+1700) Q
"RTN","PSOLLL7",47,0)
RFILL2 F AMC=0:0 S AMC=$O(^PSRX(PSRXX,1,AMC)) Q:'AMC  S PSRFL=PSRFL-1
"RTN","PSOLLL7",48,0)
 I PSRFL>0 S X1=DT,X2=$P(^PSRX(PSRXX,0),"^",8)-10 D C^%DTC I X'<$P(^(2),"^",6) S PSRFL=0
"RTN","PSOLLL7",49,0)
 Q
"RTN","PSOLLL7",50,0)
RZX S PSRXX=+^PS(55,DFN,"P",PSRX,0)
"RTN","PSOLLL7",51,0)
 I $D(^PSRX(PSRXX,0)) S PSRFL=$P(^(0),"^",9) D:$D(^(1))&PSRFL RFILL2 I PSRFL>0,$P($G(^PSRX(PSRXX,"STA")),"^")<10,134'[$E(+$P($G(^("STA")),"^")),$P(^(2),"^",6)>DT S RX(PSRXX)=$P(^(2),"^",6)_"^"_PSRFL
"RTN","PSOLLL7",52,0)
 Q
"RTN","PSOLLL7",53,0)
HDR S T=PNM_"  "_SSNP D PRINT(T)
"RTN","PSOLLL7",54,0)
 D ADD^VADPT
"RTN","PSOLLL7",55,0)
 I $G(VAPA(1))="" G HDR5
"RTN","PSOLLL7",56,0)
 F I=1:1:3 I $G(VAPA(I))]"" S T=VAPA(I) D PRINT(T)
"RTN","PSOLLL7",57,0)
 S A=+$G(VAPA(5)) I A S A=$S($D(^DIC(5,A,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL7",58,0)
 S B=$G(VAPA(4))_", "_A_"  "_$S($G(VAPA(11)):$P(VAPA(11),"^",2),1:$G(VAPA(6)))
"RTN","PSOLLL7",59,0)
 S T=B D PRINT(T)
"RTN","PSOLLL7",60,0)
HDR5 I $O(RX(0))="" D  S PSOY=PSOY+PSOYI Q
"RTN","PSOLLL7",61,0)
 .S PSOY=PSOY+PSOYI,T="You have no refillable prescriptions as of "_PSONOW_"." D PRINT(T)
"RTN","PSOLLL7",62,0)
 .S T="Please contact your provider if you need new prescriptions." D PRINT(T)
"RTN","PSOLLL7",63,0)
 .I '$D(PSOINST) D SITE
"RTN","PSOLLL7",64,0)
 .S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLL7",65,0)
 .S OPSOX=PSOX,OPSOY=PSOY,T=$P(PS,"^",6) S PSOX=2300,PSOY=3900 D PRINT(T) S PSOX=OPSOX,PSOY=OPSOY
"RTN","PSOLLL7",66,0)
ADD S PSOY=PSOY+PSOYI,T="Please check prescriptions to be refilled, sign the form, then" D PRINT(T)
"RTN","PSOLLL7",67,0)
 S T="mail or return to your pharmacy." D PRINT(T) S PSOY=PSOY+PSOYI
"RTN","PSOLLL7",68,0)
 Q
"RTN","PSOLLL7",69,0)
MAIL ;PRINT MAILING ADHESIVE LABEL
"RTN","PSOLLL7",70,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLL7",71,0)
 I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLL7",72,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL7",73,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLL7",74,0)
 I $G(PSOIO("MLI"))]"" X PSOIO("MLI")
"RTN","PSOLLL7",75,0)
 I $G(PSOIO("PSOFONT"))]"" X PSOIO("PSOFONT")
"RTN","PSOLLL7",76,0)
 S TEXT="Attn: (119)" D PRINT(TEXT)
"RTN","PSOLLL7",77,0)
 S TEXT=VAADDR1 D PRINT(TEXT)
"RTN","PSOLLL7",78,0)
 S TEXT=$G(VASTREET) D PRINT(TEXT)
"RTN","PSOLLL7",79,0)
 S TEXT=$P(PS,"^",7)_", "_$G(STATE)_"  "_$G(PSOHZIP) D PRINT(TEXT)
"RTN","PSOLLL7",80,0)
 Q
"RTN","PSOLLL7",81,0)
PRINT(T) ;
"RTN","PSOLLL7",82,0)
 I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL7",83,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL7",84,0)
 W T,!
"RTN","PSOLLL7",85,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL7",86,0)
 Q
"RTN","PSOLLL7",87,0)
QUEUE ; ENTRY POINT TO PRINT STAND-ALONE MULTI-RX FORM
"RTN","PSOLLL7",88,0)
 S SAVDFN=$D(DFN) ; DFN SET IF COMING FROM HIDDEN ACTION
"RTN","PSOLLL7",89,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) Q
"RTN","PSOLLL7",90,0)
 I '$G(PSOSYS) S PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOLLL7",91,0)
 I '$D(PSOINST) D SITE
"RTN","PSOLLL7",92,0)
 W !
"RTN","PSOLLL7",93,0)
 I $D(DFN) G GETPT2
"RTN","PSOLLL7",94,0)
GETPT S DIC="^DPT(",DIC("A")="Enter patient to reprint Multi-Rx refill form for: ",DIC(0)="QEAM" D ^DIC K P,DIC("A") I Y<0!("^"[X) K DIC,DUOUT,DTOUT,DIROUT,DIRUT Q
"RTN","PSOLLL7",95,0)
 S DFN=$P(Y,"^")
"RTN","PSOLLL7",96,0)
GETPT2 D DEM^VADPT S PNM=VADM(1)
"RTN","PSOLLL7",97,0)
 I $P(VADM(6),"^",2)]"" D  G GETPT
"RTN","PSOLLL7",98,0)
 .W $C(7),!!,PNM_" Died "_$P(VADM(6),"^",2)_".",!
"RTN","PSOLLL7",99,0)
Q1 W ! K POP,ZTSK S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS S PSLION=ION K %ZIS("A")
"RTN","PSOLLL7",100,0)
 I $G(POP) Q
"RTN","PSOLLL7",101,0)
 I $G(IOST(0)),'$D(^%ZIS(2,IOST(0),55,"B","LL")) W !,"Must specify a laser labels printer for Multi-Rx form." G Q1
"RTN","PSOLLL7",102,0)
 I '$G(IOST(0)) W !,"Nothing queued to print." H 1 Q
"RTN","PSOLLL7",103,0)
 D 6^VADPT,PID^VADPT6 S SSNP=$G(VA("BID"))
"RTN","PSOLLL7",104,0)
 D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y
"RTN","PSOLLL7",105,0)
 F G="DFN","PNM","PSOPAR","PSOSITE","SSNP","PSONOW","PSOSYS","PSOINST" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOLLL7",106,0)
 S ZTRTN="DQ^PSOLLL7",ZTIO=PSLION,ZTDESC="Outpatient Pharmacy Multi-Rx print",ZTDTH=$H,PDUZ=DUZ
"RTN","PSOLLL7",107,0)
 D ^%ZISC,^%ZTLOAD W:$D(ZTSK) !!,"Multi-Rx form queued to print",!! H 1 K G
"RTN","PSOLLL7",108,0)
 I $G(SAVDFN)=0 K DFN,SAVDFN
"RTN","PSOLLL7",109,0)
 Q
"RTN","PSOLLL7",110,0)
DQ N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLL7",111,0)
 I $G(PSOIO("LLI"))]"" X PSOIO("LLI")
"RTN","PSOLLL7",112,0)
 G EN
"RTN","PSOLLL7",113,0)
SITE ;
"RTN","PSOLLL7",114,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOLLL7",115,0)
 I $G(DA)>0 S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLLL7",116,0)
 I '$D(PSOINST) S PSOINST=""
"RTN","PSOLLL7",117,0)
 Q
"RTN","PSOLLLH")
0^6^B33423186^B24123418
"RTN","PSOLLLH",1,0)
PSOLLLH ;BIR/EJW - HIPAA/NCPDP LASER LABELS ;7/20/06 10:21am
"RTN","PSOLLLH",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**161,148,244,200**;DEC 1997;Build 7
"RTN","PSOLLLH",3,0)
 ;
"RTN","PSOLLLH",4,0)
 ;Reference to DUR1^BPSNCPD3 supported by DBIA 4560
"RTN","PSOLLLH",5,0)
 ;
"RTN","PSOLLLH",6,0)
 ;*244 ignore Rx status > 11
"RTN","PSOLLLH",7,0)
 ;
"RTN","PSOLLLH",8,0)
SIGLOG N PSOSEQ,J,RXF,RXY,RXN,RX,FIRST,DATE,BLNKLIN,RX2,FDT,BLNKLN2,LAST,CNT
"RTN","PSOLLLH",9,0)
 D DEM^VADPT
"RTN","PSOLLLH",10,0)
 S FIRST=1,LAST=0
"RTN","PSOLLLH",11,0)
 I '$G(REPRINT) D NOWINDOW I NOWIN Q
"RTN","PSOLLLH",12,0)
 K NOWIN
"RTN","PSOLLLH",13,0)
 S $P(BLNKLN2," ",32)=" "
"RTN","PSOLLLH",14,0)
 S $P(BLNKLIN,"_",32)="_"
"RTN","PSOLLLH",15,0)
 F PSOSEQ=1:1:$L(PPL,",") S RX=$P(PPL,",",PSOSEQ) D
"RTN","PSOLLLH",16,0)
 .I RX="" Q
"RTN","PSOLLLH",17,0)
 .Q:$G(^PSRX(RX,"STA"))>11                           ;*244
"RTN","PSOLLLH",18,0)
 .S RXY=$G(^PSRX(RX,0)) I RXY="" Q
"RTN","PSOLLLH",19,0)
 .S CNT=$G(CNT)+1
"RTN","PSOLLLH",20,0)
 .S RX2=$G(^PSRX(RX,2)),FDT=$P(RX2,"^",2)
"RTN","PSOLLLH",21,0)
 .I FIRST!(CNT#4=1) D HDR,BARC S FIRST=0
"RTN","PSOLLLH",22,0)
 .S RXF=+$O(^PSRX(RX,1,"A"),-1)
"RTN","PSOLLLH",23,0)
 .I RXF>0 I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLH",24,0)
 .S DATE=$E(FDT,1,7),Y=DATE X ^DD("DD") S DATE=Y
"RTN","PSOLLLH",25,0)
 .S RXN=$P(RXY,"^")
"RTN","PSOLLLH",26,0)
 .S T=RXN_" ("_(RXF)_") "
"RTN","PSOLLLH",27,0)
 .N PSODRNM
"RTN","PSOLLLH",28,0)
 .S PSODRNM=$$ZZ^PSOSUTL(RX)
"RTN","PSOLLLH",29,0)
 .S T=T_$E(FDT,4,5)_"/"_$E(FDT,6,7)_"/"_$E(FDT,2,3)_" "_$E(PSODRNM,1,(27-$L(RXN))) D PRINT(T)
"RTN","PSOLLLH",30,0)
 S LAST=1 D SIGN
"RTN","PSOLLLH",31,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOLLLH",32,0)
 Q
"RTN","PSOLLLH",33,0)
 ;
"RTN","PSOLLLH",34,0)
SIGN ;
"RTN","PSOLLLH",35,0)
 I '$G(CNT) Q
"RTN","PSOLLLH",36,0)
 N II
"RTN","PSOLLLH",37,0)
 S II=CNT#4
"RTN","PSOLLLH",38,0)
 I LAST,II>0 F J=1:1:(4-II) S T=" " D PRINT(T)
"RTN","PSOLLLH",39,0)
 S PSOY=PSOY+10
"RTN","PSOLLLH",40,0)
 S T="Pt. Sig."_BLNKLIN D PRINT(T)
"RTN","PSOLLLH",41,0)
 S PSOY=PSOY+5
"RTN","PSOLLLH",42,0)
 D PRINT($$PLANNM())
"RTN","PSOLLLH",43,0)
 S PSOY=PSOY+15
"RTN","PSOLLLH",44,0)
 S T="Relation_____ Counseling Refused__ Accepted__" D PRINT(T)
"RTN","PSOLLLH",45,0)
 S PSOY=PSOY+10
"RTN","PSOLLLH",46,0)
 S T=PNM_"  "_$G(SSNP) D PRINT(T,1)
"RTN","PSOLLLH",47,0)
 Q
"RTN","PSOLLLH",48,0)
 ;
"RTN","PSOLLLH",49,0)
HDR ;
"RTN","PSOLLLH",50,0)
 I 'FIRST D SIGN W @IOF
"RTN","PSOLLLH",51,0)
 I $G(PSOIO("BLH"))]"" X PSOIO("BLH")
"RTN","PSOLLLH",52,0)
 S T="VAMC "_$P(PS,"^",7)_", "_STATE_" "_$G(PSOHZIP) D PRINT(T)
"RTN","PSOLLLH",53,0)
 S T=$P(PS2,"^",2)_"  Ph: "_$P(PS,"^",3)_"-"_$P(PS,"^",4)_"       "_$G(PSONOW) D PRINT(T)
"RTN","PSOLLLH",54,0)
 I $G(PSOIO("BLB"))]"" X PSOIO("BLB")
"RTN","PSOLLLH",55,0)
 S XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLLH",56,0)
 N REPMSG
"RTN","PSOLLLH",57,0)
 S REPMSG=BLNKLN2_"(REPRINT)"
"RTN","PSOLLLH",58,0)
 S T="By signing below"_$S($G(REPRINT):REPMSG,1:"") D PRINT(T,1)
"RTN","PSOLLLH",59,0)
 S T="you acknowledge receipt of the following Rx's" D PRINT(T,1)
"RTN","PSOLLLH",60,0)
 S T=" " D PRINT(T)
"RTN","PSOLLLH",61,0)
 S PSOY=PSOY-20
"RTN","PSOLLLH",62,0)
 Q
"RTN","PSOLLLH",63,0)
 ;
"RTN","PSOLLLH",64,0)
PRINT(T,B) ;
"RTN","PSOLLLH",65,0)
 S BOLD=$G(B)
"RTN","PSOLLLH",66,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLLH",67,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLLH",68,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLLH",69,0)
 W T,!
"RTN","PSOLLLH",70,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLLH",71,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLLH",72,0)
 Q
"RTN","PSOLLLH",73,0)
 ;
"RTN","PSOLLLH",74,0)
QUEUE ; ENTRY POINT TO REPRINT SIGNATURE LOG
"RTN","PSOLLLH",75,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) Q
"RTN","PSOLLLH",76,0)
 N REPRINT,PS,STATE,PS2,PSOHZIP
"RTN","PSOLLLH",77,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLLH",78,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLH",79,0)
 I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLLH",80,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLLH",81,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLLH",82,0)
 S REPRINT=1
"RTN","PSOLLLH",83,0)
LRP W !! S DIC("S")="I $P($G(^(0)),""^"",2),$D(^(""STA"")),$P($G(^(""STA"")),""^"")<10",DIC="^PSRX(",DIC("A")="Reprint Signature Log for Prescription: ",DIC(0)="QEAZ" D ^DIC K P,DIC("A") I Y<0!("^"[X) D KILL Q
"RTN","PSOLLLH",84,0)
 W !
"RTN","PSOLLLH",85,0)
 S (PPL,RX)=+Y
"RTN","PSOLLLH",86,0)
 N RXY
"RTN","PSOLLLH",87,0)
 S RXY=$G(^PSRX(RX,0)) I RXY="" Q
"RTN","PSOLLLH",88,0)
 S DFN=$P(RXY,"^",2)
"RTN","PSOLLLH",89,0)
GETPT2 D DEM^VADPT S PNM=VADM(1)
"RTN","PSOLLLH",90,0)
 I $P(VADM(6),"^",2)]"" D  G LRP
"RTN","PSOLLLH",91,0)
 .W $C(7),!!,PNM_" Died "_$P(VADM(6),"^",2)_".",!
"RTN","PSOLLLH",92,0)
 D 6^VADPT,PID^VADPT6 S SSNP=$G(VA("BID"))
"RTN","PSOLLLH",93,0)
Q1 W ! K POP,ZTSK S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS S PSLION=ION K %ZIS("A")
"RTN","PSOLLLH",94,0)
 I $G(POP) Q
"RTN","PSOLLLH",95,0)
 I $G(IOST(0)),'$D(^%ZIS(2,IOST(0),55,"B","LL")) W !,"Must specify a laser labels printer for Signature Log Reprint" G Q1
"RTN","PSOLLLH",96,0)
 I '$G(IOST(0)) W !,"Nothing queued to print." H 1 Q
"RTN","PSOLLLH",97,0)
 D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y
"RTN","PSOLLLH",98,0)
 F G="PPL","REPRINT","PNM","STATE","PS2","PSOHZIP","PSOPAR","PSOSITE","PS","PSONOW","PSOSYS","SSNP" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOLLLH",99,0)
 S ZTRTN="DQ^PSOLLLH",ZTIO=PSLION,ZTDESC="Outpatient Pharmacy Signature Log Reprint",ZTDTH=$H,PDUZ=DUZ
"RTN","PSOLLLH",100,0)
 D ^%ZISC,^%ZTLOAD W:$D(ZTSK) !!,"Signature Log Reprint queued",!! H 1 K G
"RTN","PSOLLLH",101,0)
 G QUEUE
"RTN","PSOLLLH",102,0)
 Q
"RTN","PSOLLLH",103,0)
DQ N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLH",104,0)
 I $G(PSOIO("LLI"))]"" X PSOIO("LLI")
"RTN","PSOLLLH",105,0)
 G SIGLOG
"RTN","PSOLLLH",106,0)
 ;
"RTN","PSOLLLH",107,0)
PLANNM() ; Returns Insurance Name (3rd Party)
"RTN","PSOLLLH",108,0)
 S PLANNM=""
"RTN","PSOLLLH",109,0)
 N I,DUR,RX
"RTN","PSOLLLH",110,0)
 F I=1:1:$L(PPL,",") S RX=+$P(PPL,",",I) D  I PLANNM'="" Q
"RTN","PSOLLLH",111,0)
 .I 'RX Q
"RTN","PSOLLLH",112,0)
 .D DUR1^BPSNCPD3(RX,$$LSTRFL^PSOBPSU1(RX),.DUR) S PLANNM=$G(DUR(1,"INSURANCE NAME"))
"RTN","PSOLLLH",113,0)
 Q PLANNM
"RTN","PSOLLLH",114,0)
BARC I '$G(FIRST) G BARCE ; PRINT BARCODE FOR 1 RX ON 1ST SIGLOG LABEL ONLY
"RTN","PSOLLLH",115,0)
 I $G(PSOIO("BLBC"))]"" X PSOIO("BLBC") I $G(NOBARC) G BARCE
"RTN","PSOLLLH",116,0)
 I '$D(PSOINST) D INST
"RTN","PSOLLLH",117,0)
 S X2=PSOINST_"-"_RX W X2
"RTN","PSOLLLH",118,0)
 I $G(PSOIO("EBLBC"))]"" X PSOIO("EBLBC")
"RTN","PSOLLLH",119,0)
BARCE Q
"RTN","PSOLLLH",120,0)
 ;
"RTN","PSOLLLH",121,0)
KILL ; CLEAN UP VARIABLES
"RTN","PSOLLLH",122,0)
 K DIC,DFN,PNM,PPL,PSZIP,RX,SSNP,VA,VADDR1,VADM,VAEL,VAPA,VASTREET
"RTN","PSOLLLH",123,0)
 Q
"RTN","PSOLLLH",124,0)
INST ;
"RTN","PSOLLLH",125,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOLLLH",126,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I"))
"RTN","PSOLLLH",127,0)
 K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLLLH",128,0)
 Q
"RTN","PSOLLLH",129,0)
 ;
"RTN","PSOLLLH",130,0)
NOWINDOW ; ON ORIGINAL PRINT - DON'T PRINT IF ALL ARE MAIL
"RTN","PSOLLLH",131,0)
 N I,RX,RXF,MW,RXP,RXY
"RTN","PSOLLLH",132,0)
 S NOWIN=1
"RTN","PSOLLLH",133,0)
 F I=1:1:$L(PPL,",") S RX=$P(PPL,",",I) D  I 'NOWIN Q
"RTN","PSOLLLH",134,0)
 .I RX="" Q
"RTN","PSOLLLH",135,0)
 .I $G(^PSRX(RX,"STA"))>11 Q
"RTN","PSOLLLH",136,0)
 .S RXY=$G(^PSRX(RX,0)) I RXY="" Q
"RTN","PSOLLLH",137,0)
 .I '$D(^PSRX(RX,1)) S MW=$P(RXY,"^",11) I MW="W" S NOWIN=0 Q
"RTN","PSOLLLH",138,0)
 .S RXF=$O(^PSRX(RX,1,99),-1) I RXF>0 S MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) I MW="W" S NOWIN=0
"RTN","PSOLLLH",139,0)
 .S RXP=$O(^PSRX(RX,"P",99),-1) I RXP>0 S MW=$P($G(^PSRX(RX,"P",RXP,0)),"^",2) I MW="W" S NOWIN=0
"RTN","PSOLLLH",140,0)
 Q
"RTN","PSOLLLHN")
0^20^B9199678^n/a
"RTN","PSOLLLHN",1,0)
PSOLLLHN ;BIR/SJA - HIPAA/NCPDP LASER LABELS ;2/21/07 10:21am
"RTN","PSOLLLHN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**200**;DEC 1997;Build 7
"RTN","PSOLLLHN",3,0)
 ;
"RTN","PSOLLLHN",4,0)
 ;*244 ignore Rx status > 11
"RTN","PSOLLLHN",5,0)
 ;
"RTN","PSOLLLHN",6,0)
ST ; ENTRY POINT TO SPEED SIGNATURE LOG REPRINT
"RTN","PSOLLLHN",7,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) Q
"RTN","PSOLLLHN",8,0)
 N REPRINT,PS,STATE,PS2,PSOHZIP,PSODISP,PSOOELSE,PSOIEN,VALMCNT
"RTN","PSOLLLHN",9,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLLHN",10,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLHN",11,0)
 I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLLHN",12,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLLHN",13,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLLHN",14,0)
 D 6^VADPT,PID^VADPT6 S SSNP=$E($G(VA("PID")),5,12)
"RTN","PSOLLLHN",15,0)
 S REPRINT=1
"RTN","PSOLLLHN",16,0)
 I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOLLLHN",17,0)
OS K DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR S LST=Y I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" Q
"RTN","PSOLLLHN",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,PSOREPX I '+LST D KILL S VALMBCK="" Q
"RTN","PSOLLLHN",19,0)
 S PSOOELSE=1 D FULL^VALM1
"RTN","PSOLLLHN",20,0)
Q1 K POP,ZTSK S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS S PSLION=ION K %ZIS("A")
"RTN","PSOLLLHN",21,0)
 I $G(POP) S VALMBCK="R",VALMSG="No Labels Reprinted." Q
"RTN","PSOLLLHN",22,0)
 I $G(IOST(0)),'$D(^%ZIS(2,IOST(0),55,"B","LL")) W !,"Must specify a laser labels printer for Signature Log Reprint" G Q1
"RTN","PSOLLLHN",23,0)
 I '$G(IOST(0)) S VALMBCK="R",VALMSG="Nothing queued to print." Q
"RTN","PSOLLLHN",24,0)
 D DEM^VADPT S PNM=VADM(1)
"RTN","PSOLLLHN",25,0)
 I $P(VADM(6),"^",2)]"" D  G OS
"RTN","PSOLLLHN",26,0)
 .W $C(7),!!,PNM_" Died "_$P(VADM(6),"^",2)_".",!
"RTN","PSOLLLHN",27,0)
 S PPL="" F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD),PSOIEN=$P(PSOLST(ORN),"^",2) D
"RTN","PSOLLLHN",28,0)
 .I '$P($G(^PSRX(PSOIEN,0)),"^",2)!($G(^("STA"),"^")>11) Q
"RTN","PSOLLLHN",29,0)
 .I $P($G(^PSRX(PSOIEN,0)),"^",2) S PPL=$S(PPL:PPL_",",1:"")_PSOIEN
"RTN","PSOLLLHN",30,0)
 .S VALMBCK="R"
"RTN","PSOLLLHN",31,0)
 I +PPL D QUEUE W:$D(ZTSK) !!,"Signature Log Reprint queued",!! H 1
"RTN","PSOLLLHN",32,0)
 I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOLLLHN",33,0)
 D ^PSOBUILD
"RTN","PSOLLLHN",34,0)
 D KILL D KVA^VADPT
"RTN","PSOLLLHN",35,0)
 Q
"RTN","PSOLLLHN",36,0)
QUEUE D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y
"RTN","PSOLLLHN",37,0)
 F G="PPL","REPRINT","PNM","STATE","PS2","PSOHZIP","PSOPAR","PSOSITE","PS","PSONOW","PSOSYS","RX","SSNP" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOLLLHN",38,0)
 S ZTRTN="DQ^PSOLLLH",ZTIO=PSLION,ZTDESC="Outpatient Pharmacy Signature Log Reprint",ZTDTH=$H,PDUZ=DUZ
"RTN","PSOLLLHN",39,0)
 D ^%ZISC,^%ZTLOAD K G
"RTN","PSOLLLHN",40,0)
 Q
"RTN","PSOLLLHN",41,0)
 ;
"RTN","PSOLLLHN",42,0)
KILL ; CLEAN UP VARIABLES
"RTN","PSOLLLHN",43,0)
 K DIC,LST,ORD,ORN,PSOIEN,PNM,PPL,PSZIP,RX,SSNP,VA,VADDR1,VADM,VAEL,VAPA,VASTREET
"RTN","PSOLLLHN",44,0)
 Q
"RTN","PSOLLLI")
0^7^B65923392^B66394524
"RTN","PSOLLLI",1,0)
PSOLLLI ;BIR/JLC - LASER LABELS INITIALIZATION ;10 Oct 2006  4:56 PM
"RTN","PSOLLLI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,157,189,161,244,200**;DEC 1997;Build 7
"RTN","PSOLLLI",3,0)
 ;
"RTN","PSOLLLI",4,0)
 ;DBIAs PSDRUG-221, PS(55-2228, SC-10040, IBARX-125, PSXSRP-2201, %ZIS-3435, DPT-3097, ^TMP($J,"PSNPPIO"-3794
"RTN","PSOLLLI",5,0)
 ;External reference to DRUG^PSSWRNA supported by DBIA 4449
"RTN","PSOLLLI",6,0)
 ;
"RTN","PSOLLLI",7,0)
 ;*244 remove test for partial fill when testing status > 11
"RTN","PSOLLLI",8,0)
 ;
"RTN","PSOLLLI",9,0)
DQ N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLI",10,0)
DQ1 I '$D(PPL) G HLEX
"RTN","PSOLLLI",11,0)
 I $P($G(PSOPAR),"^",30)=2,'$G(PSOEXREP) G HLEX
"RTN","PSOLLLI",12,0)
 K RXFLX S PSOCKHN=","_$G(PPL),PSRESOLV=+PPL D CHECK
"RTN","PSOLLLI",13,0)
 S PSOINT=1 F PI=1:1 S RX=$P(PPL,",",PI) Q:RX=""  D
"RTN","PSOLLLI",14,0)
 . S RXY=$G(^PSRX(RX,0)) Q:RXY=""  I PSOPDFN'=$P(RXY,"^",2),'PSOINT D TRAIL^PSOLLL1 S PSOPDFN=$P(RXY,"^",2)
"RTN","PSOLLLI",15,0)
 . K RXP,REPRINT D C
"RTN","PSOLLLI",16,0)
 I 'PSOINT D TRAIL^PSOLLL1
"RTN","PSOLLLI",17,0)
HLEX K RXPI,PSORX,RXP,PSOIOS,PSOLAPPL,XXX,COPAYVAR,TECH,PHYS,MFG,NURSE,STATE,SIDE,COPIES,EXDT,ISD,PSOINST,RXN,RXY,VADT,DEA,WARN,FDT,QTY,PATST,PDA,PS,PS1,RXP,REPRINT
"RTN","PSOLLLI",18,0)
 K SGY,OSGY,PS2,PSL,PSNP,INRX,RR,XTYPE,SSNP,SSNPN,PNM,ADDR,PSODBQ,PSOLASTF,PSRESOLV,PSOEXREP,PSOSXQ
"RTN","PSOLLLI",19,0)
 K DATE,DR,DRUG,LINE,MW,PRTFL,VRPH,EXPDT,X2,DIFF,DAYS,PSZIP,PSOHZIP,PS55,PS55X
"RTN","PSOLLLI",20,0)
 K ^TMP($J,"PSNPMI"),^TMP($J,"PSOCP",+$G(PSOCPN)),PSOCPN,PSOLBLDR,PSOLBLPS,PSOLBLCP,RXPR,RXRP,RXRS,PSOCKHN,RXFLX,PSOLAPPL,PSOPDFN,PSDFNFLG,PSOZERO,NEXTRX,PSOBLALL,STA
"RTN","PSOLLLI",21,0)
 I '$G(PSOSUREP),'$G(PSOSUSPR) S ZTREQ="@"
"RTN","PSOLLLI",22,0)
 Q
"RTN","PSOLLLI",23,0)
C N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLI",24,0)
 U IO Q:'$D(^PSRX(RX,0))  S RXY=^(0),RX2=^(2),RXSTA=^("STA") K SGY,OSGY
"RTN","PSOLLLI",25,0)
 S (SIGM,PFM,PMIM,L2,L3,L4,L5,FILLCONT,BOTTLBL)=0
"RTN","PSOLLLI",26,0)
 K SIGF,PFF,PMIF S (SIGF,PFF,PMIF)=0 F I="DR","T" S (SIGF(I),PFF(I))=1
"RTN","PSOLLLI",27,0)
 F I="A","B","I" S PMIF(I)=1
"RTN","PSOLLLI",28,0)
 D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y,Y=PSOFNOW X ^DD("DD") S PSONOWT=Y
"RTN","PSOLLLI",29,0)
 S:$G(PSOBLALL) PSOBLRX=RX S:$D(RXRP(RX)) REPRINT=1 S:$D(RXPR(RX)) RXP=RXPR(RX)
"RTN","PSOLLLI",30,0)
 I $G(PSOSUREP)!($G(PSOEXREP)) S REPRINT=1 I '$G(RXRP(RX)) S RXRP(RX)=1
"RTN","PSOLLLI",31,0)
 S A=$P(RXSTA,"^") I A>11 D AL^PSOLBL("QT") K RXP,REPRINT Q      ;*244
"RTN","PSOLLLI",32,0)
 I A=3 D AL^PSOLBL("QT") K RXP,REPRINT Q
"RTN","PSOLLLI",33,0)
 I $G(RXPR(RX)),'$D(^PSRX(RX,"P",RXP,0)) K RXP,REPRINT Q
"RTN","PSOLLLI",34,0)
 I $P($G(RXFL(RX)),"^"),'$D(^PSRX(RX,1,$P($G(RXFL(RX)),"^"),0)) K RXP,REPRINT Q
"RTN","PSOLLLI",35,0)
 I $G(PSODBQ)!($G(RXRS(RX))) S RR=$O(^PS(52.5,"B",RX,0)) Q:'RR  I $G(^PS(52.5,RR,"P"))=1 K RXP,REPRINT Q
"RTN","PSOLLLI",36,0)
 I $G(RXRS(RX))!($G(PSOPULL)) S PSOSXQ=0 N DR,DA,DIE D  I $G(PSOSXQ) K RXP,REPRINT Q
"RTN","PSOLLLI",37,0)
 . S DA=$O(^PS(52.5,"B",RX,0)) Q:'DA
"RTN","PSOLLLI",38,0)
 . S A=$P($G(^PS(52.5,DA,0)),"^",7) I A="" Q
"RTN","PSOLLLI",39,0)
 . I A="Q" S DIE="^PS(52.5,",DR="3////P" D ^DIE Q
"RTN","PSOLLLI",40,0)
 . K RXRS(RX) S PSOSXQ=1
"RTN","PSOLLLI",41,0)
 I $G(PSRESOLV)=RX D ENLBL^PSOBSET K PSRESOLV
"RTN","PSOLLLI",42,0)
 I $P(RXSTA,"^")'=4 D
"RTN","PSOLLLI",43,0)
 . I $G(PSOSUSPR) D AREC^PSOSUTL
"RTN","PSOLLLI",44,0)
 . I $G(PSOPULL)!($G(RXRS(RX))) D AREC1^PSOSUTL
"RTN","PSOLLLI",45,0)
 . I $G(PSOSUREP) D AREC^PSOSUSRP
"RTN","PSOLLLI",46,0)
 . I $G(PSXREP) D AREC^PSXSRP
"RTN","PSOLLLI",47,0)
 S RXY=^PSRX(RX,0),RX2=^(2),RXSTA=^("STA")
"RTN","PSOLLLI",48,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOLLLI",49,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLLLI",50,0)
 S RXN=$P(RXY,"^"),DFN=+$P(RXY,"^",2),PSOLBLPS=+$P(RXY,"^",3),PSOLBLDR=+$P(RXY,"^",6)
"RTN","PSOLLLI",51,0)
 S ISD=$P(RXY,"^",13),RXF=0,SIG=$P($G(^PSRX(RX,"SIG")),"^"),ISD=$E(ISD,4,5)_"/"_$E(ISD,6,7)_"/"_($E(ISD,1,3)+1700),ZY=0,$P(LINE,"_",28)="_"
"RTN","PSOLLLI",52,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0)
"RTN","PSOLLLI",53,0)
 S FDT=$P(RX2,"^",2),PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:""),PS1=$S($D(^(1)):^(1),1:""),PSOSITE7=$P(^("IB"),"^")
"RTN","PSOLLLI",54,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLI",55,0)
 S EXPDT=$P(RX2,"^",6),EXDT=$S('EXPDT:"",1:$E(EXPDT,4,5)_"/"_$E(EXPDT,6,7)_"/"_($E(EXPDT,1,3)+1700))
"RTN","PSOLLLI",56,0)
 S COPIES=$S($P($G(RXRP(RX)),"^",2):$P($G(RXRP(RX)),"^",2),$P(RXY,"^",18)]"":$P(RXY,"^",18),1:1)
"RTN","PSOLLLI",57,0)
 K PSOCKHNX S PSOCKHL=$L(RX),PSOCKHN=$E($G(PSOCKHN),(PSOCKHL+2),999) D  K PSOCKHNX,PSOCKHL,PSOCKHA
"RTN","PSOLLLI",58,0)
 .S PSOCKHA=","_RX_","
"RTN","PSOLLLI",59,0)
 .I PSOCKHN'[PSOCKHA Q
"RTN","PSOLLLI",60,0)
 .S PSOCKHA=$E(PSOCKHA,1,($L(PSOCKHA)-1))
"RTN","PSOLLLI",61,0)
 .S PSOCKHNX=$L(PSOCKHN,PSOCKHA)-1
"RTN","PSOLLLI",62,0)
 .I +$G(PSOCKHNX)>0 D DOUB
"RTN","PSOLLLI",63,0)
 I $O(^PSRX(RX,1,0)),$G(RXFL(RX))'=0 S $P(^PSRX(RX,3),"^",6)="" K ^PSRX(RX,"DAI"),^PSRX(RX,"DRI")
"RTN","PSOLLLI",64,0)
 I '$G(RXP),'$O(^PSRX(RX,1,0)) S RXFL(RX)=0
"RTN","PSOLLLI",65,0)
 I '$G(RXP) D OSET I '$O(^PSRX(RX,1,0))!($G(RXFL(RX))=0) G ORIG
"RTN","PSOLLLI",66,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP) D  G STA
"RTN","PSOLLLI",67,0)
 . I '$G(RXFL(RX)) S XTYPE=1 D REF
"RTN","PSOLLLI",68,0)
 I $G(RXP) S XTYPE="P" D REF G STA
"RTN","PSOLLLI",69,0)
ORIG S TECH=$P($G(^VA(200,+$P(RXY,"^",16),0)),"^"),PHYS=$S($D(^VA(200,+$P(RXY,"^",4),0)):$P(^(0),"^"),1:"UKN")
"RTN","PSOLLLI",70,0)
 S DAYS=$P(RXY,"^",8),QTY=$P(RXY,"^",7)
"RTN","PSOLLLI",71,0)
 D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",72,0)
STA S STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UKN")
"RTN","PSOLLLI",73,0)
 S DRUG=$$ZZ^PSOSUTL(RX),DEA=$P($G(^PSDRUG(+$P(RXY,"^",6),0)),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOLLLI",74,0)
 S WARN=$$DRUG^PSSWRNA(+$P(RXY,"^",6),+$P(RXY,"^",2))
"RTN","PSOLLLI",75,0)
 S SIDE=$S($P($G(RXRP(RX)),"^",3):1,1:0)
"RTN","PSOLLLI",76,0)
 I $G(^PSRX(RX,"P",+$G(RXP),0))]"" S RXPI=RXP D
"RTN","PSOLLLI",77,0)
 .S RXP=^PSRX(RX,"P",RXP,0)
"RTN","PSOLLLI",78,0)
 .S RXY=$P(RXP,"^")_"^"_$P(RXY,"^",2,6)_"^"_$P(RXP,"^",4)_"^"_$P(RXP,"^",10)_"^"_$P(RXY,"^",9)_"^"_$P($G(^PSRX(RX,"SIG")),"^",2)_"^"_$P(RXP,"^",2)_"^"_$P(RXY,"^",12,14)_"^"_$P(^PSRX(RX,"STA"),"^")_"^"_$P(RXP,"^",7)_"^"_$P(RXY,"^",17,99)
"RTN","PSOLLLI",79,0)
 .S FDT=$P(RXP,"^")
"RTN","PSOLLLI",80,0)
 S MW=$P(RXY,"^",11) I $G(RXFL(RX))'=0 D:$G(RXFL(RX))  I '$G(RXFL(RX)) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=RXF+1 S:'$G(RXP) MW=$P(^PSRX(RX,1,I,0),"^",2) I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLI",81,0)
 .I $G(RXFL(RX)),'$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLLLI",82,0)
 .S RXF=RXFL(RX) S:'$G(RXP) MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLI",83,0)
 I MW="W",$G(^PSRX(RX,"MP"))]"" D
"RTN","PSOLLLI",84,0)
 .S PSMP=^PSRX(RX,"MP"),PSJ=0 F PSI=1:1:$L(PSMP) S PSMP(PSI)="",PSJ=PSJ+1 F PSJ=PSJ:1 S PSMP(PSI)=PSMP(PSI)_$P(PSMP," ",PSJ)_" " Q:($L(PSMP(PSI))+$L($P(PSMP," ",PSJ+1))>30)
"RTN","PSOLLLI",85,0)
 .K PSMP(PSI)
"RTN","PSOLLLI",86,0)
 ;New mail codes for CMOP
"RTN","PSOLLLI",87,0)
 S MAILCOM=""
"RTN","PSOLLLI",88,0)
 S X=$G(^PS(55,DFN,0)),PSCAP=$P(X,"^",2),PS55=$P(X,"^",3),PS55X=$P(X,"^",5)
"RTN","PSOLLLI",89,0)
 I PS55X]"",PS55>1,PS55X<DT S PS55=1
"RTN","PSOLLLI",90,0)
 S:MW="M" MW=$S((PS55=1!(PS55=4)):"R",1:MW)
"RTN","PSOLLLI",91,0)
 S MAILCOM=$P($G(^PS(59,PSOSITE,9)),"^")
"RTN","PSOLLLI",92,0)
 S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLLLI",93,0)
 I $G(PSMP(1))="",$G(PS55)=2 S PSMP(1)=$G(SSNPN)
"RTN","PSOLLLI",94,0)
 S DATE=$E(FDT,1,7),REF=$P(RXY,"^",9)-RXF S:'$G(RXP) $P(^PSRX(RX,3),"^")=FDT S:REF<1 REF=0 D ^PSOLBL2 S II=RX D ^PSORFL,RFLDT^PSORFL
"RTN","PSOLLLI",95,0)
 S (X,PSOFLAST)=$G(PSOLASTF) I X?1N.E D ^%DT X ^DD("DD") S PSOFLAST=Y
"RTN","PSOLLLI",96,0)
 S PATST=$G(^PS(53,+$P(RXY,"^",3),0)) S PRTFL=1 I REF=0 S:('$P(PATST,"^",5))!(DEA["A"&(DEA'["B"))!(DEA["W") PRTFL=0
"RTN","PSOLLLI",97,0)
 S VRPH=$P(RX2,"^",10),PSCLN=+$P(RXY,"^",5),PSCLN=$G(^SC(PSCLN,0)),PSCLN=$S($P(PSCLN,"^",2)'="":$P(PSCLN,"^",2),1:$E($P(PSCLN,"^"),1,7)) I PSCLN="" S PSCLN="UNKNOWN"
"RTN","PSOLLLI",98,0)
 S PATST=$P(PATST,"^",2),X1=DT,X2=$P(RXY,"^",8)-10 D C^%DTC:REF I $D(^PSRX(RX,2)),$P(^(2),"^",6),REF,X'<$P(^(2),"^",6) S REF=0,VRPH=$P(^(2),"^",10)
"RTN","PSOLLLI",99,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) S COPAYVAR="CHAMPUS" G LBL
"RTN","PSOLLLI",100,0)
 I $G(RXP) S COPAYVAR="" G LBL
"RTN","PSOLLLI",101,0)
 I $P($G(^PS(53,+$G(PSOLBLPS),0)),"^",7) D SNO G LBL
"RTN","PSOLLLI",102,0)
 I DEA["I"!(DEA["S") D SNO G LBL
"RTN","PSOLLLI",103,0)
 I $P(^PSRX(RX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) D SNO G LBL
"RTN","PSOLLLI",104,0)
 I $G(PSOLBLCP)="" D IBCP
"RTN","PSOLLLI",105,0)
 N PSOQI S PSOQI=$G(^PSRX(RX,"IBQ"))
"RTN","PSOLLLI",106,0)
 I $G(PSOLBLCP)=0 D SNO G LBL
"RTN","PSOLLLI",107,0)
 I $G(PSOLBLCP)=1 I $P(PSOQI,"^",2)!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLLLI",108,0)
 I $G(PSOLBLCP)=2 I $P(PSOQI,"^")!($P(PSOQI,"^",2))!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLLLI",109,0)
 I $G(PSOLBLCP)=2,'$P($G(^PSRX(RX,"IB")),"^") D SNO G LBL
"RTN","PSOLLLI",110,0)
 S PSOCPN=$P(RXY,"^",2),INRX=$P(RXY,"^")
"RTN","PSOLLLI",111,0)
 I $G(^TMP($J,"PSOCP",PSOCPN))="" S ^(PSOCPN)=PSOCPN
"RTN","PSOLLLI",112,0)
 S ^TMP($J,"PSOCP",PSOCPN,INRX)=INRX_"^"_$$ZZ^PSOSUTL(RX)_"^"_+$G(DAYS),COPAYVAR="COPAY" K ZDRUG
"RTN","PSOLLLI",113,0)
LBL I $G(PSOIO("LLI"))]"" X PSOIO("LLI")
"RTN","PSOLLLI",114,0)
 I $P(RXSTA,"^")=4 D ^PSOLLL8 Q  ;for a critical interaction entered by a tech - don't allow a label to be printed
"RTN","PSOLLLI",115,0)
 I $D(^PSRX(RX,"DRI")),'$G(RXF),'$G(RXP) D ^PSOLLL8
"RTN","PSOLLLI",116,0)
 I $P($G(^PSRX(RX,3)),"^",6),'$G(RXF),'$G(RXP) D ^PSOLLL9
"RTN","PSOLLLI",117,0)
 S PSOINT=0 G ^PSOLLL1
"RTN","PSOLLLI",118,0)
REF F XXX=0:0 S XXX=$O(^PSRX(RX,XTYPE,XXX)) Q:+XXX'>0  D
"RTN","PSOLLLI",119,0)
 .S TECH=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLLLI",120,0)
 .S QTY=$P(^PSRX(RX,XTYPE,XXX,0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",121,0)
 .S DAYS=$P(^PSRX(RX,XTYPE,XXX,0),"^",10)
"RTN","PSOLLLI",122,0)
 Q
"RTN","PSOLLLI",123,0)
CHECK S PSDFNFLG=0,PSOZERO=$P(PPL,","),PSOPDFN=$P(^PSRX(PSOZERO,0),"^",2)
"RTN","PSOLLLI",124,0)
 Q
"RTN","PSOLLLI",125,0)
OSET ;
"RTN","PSOLLLI",126,0)
 N A
"RTN","PSOLLLI",127,0)
 I $G(RXFL(RX))']""!($G(RXFL(RX))=0) D  Q
"RTN","PSOLLLI",128,0)
 .S A=^PSRX(RX,0)
"RTN","PSOLLLI",129,0)
 .S TECH=$P($G(^VA(200,+$P(A,"^",16),0)),"^"),QTY=$P(A,"^",7),PHYS=$S($D(^VA(200,+$P(A,"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",130,0)
 .S DAYS=$P(A,"^",8)
"RTN","PSOLLLI",131,0)
 I '$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLLLI",132,0)
 S A=^PSRX(RX,1,RXFL(RX),0)
"RTN","PSOLLLI",133,0)
 S TECH=$S($D(^VA(200,+$P(A,"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLLLI",134,0)
 S QTY=$P(A,"^",4),PHYS=$S($D(^VA(200,+$P(A,"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",135,0)
 S DAYS=$P(A,"^",10)
"RTN","PSOLLLI",136,0)
 Q
"RTN","PSOLLLI",137,0)
DOUB ;
"RTN","PSOLLLI",138,0)
 Q:'$D(RXFL(RX))
"RTN","PSOLLLI",139,0)
 I +$G(RXFL(RX))-PSOCKHNX<0 Q
"RTN","PSOLLLI",140,0)
 S RXFLX(RX)=$G(RXFL(RX))
"RTN","PSOLLLI",141,0)
 S RXFL(RX)=$G(RXFL(RX))-PSOCKHNX
"RTN","PSOLLLI",142,0)
 Q
"RTN","PSOLLLI",143,0)
IBCP ;
"RTN","PSOLLLI",144,0)
 N X,Y,PSOJJ,PSOLL
"RTN","PSOLLLI",145,0)
 S PSOLBLCP=""
"RTN","PSOLLLI",146,0)
 S X=$P($G(^PS(59,+$G(PSOSITE),"IB")),"^")_"^"_$G(DFN) D XTYPE^IBARX
"RTN","PSOLLLI",147,0)
 S PSOJJ="" F  S PSOJJ=$O(Y(PSOJJ)) Q:'PSOJJ  S PSOLL="" F  S PSOLL=$O(Y(PSOJJ,PSOLL)) Q:PSOLL=""  S:PSOLL>0 PSOLBLCP=PSOLL
"RTN","PSOLLLI",148,0)
 I '$G(PSOLBLCP) S PSOLBLCP=0
"RTN","PSOLLLI",149,0)
 Q
"RTN","PSOLLLI",150,0)
SNO ;
"RTN","PSOLLLI",151,0)
 S COPAYVAR="NO COPAY"
"RTN","PSOLLLI",152,0)
 Q
"RTN","PSORN52C")
0^13^B49841543^B48742207
"RTN","PSORN52C",1,0)
PSORN52C ;BIR/SAB-files renewal entries con't ;08/09/93
"RTN","PSORN52C",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,11,27,46,75,87,100,111,124,117,131,146,148,200**;DEC 1997;Build 7
"RTN","PSORN52C",3,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORN52C",4,0)
 S DIC="^PSRX(",DLAYGO=52,DIC(0)="L",X=PSOX("NRX #") K DD,DO
"RTN","PSORN52C",5,0)
 D FILE^DICN S PSOX("IRXN")=+Y K DLAYGO,X,Y,DIC,DD,DO
"RTN","PSORN52C",6,0)
 D:+$G(DGI) TECH^PSODGDGI ; L +^PSRX(PSOX("IRXN")):0
"RTN","PSORN52C",7,0)
 D:$G(^TMP("PSODAI",$J,0))
"RTN","PSORN52C",8,0)
 .S $P(^PSRX(PSOX("IRXN"),3),"^",6)=1
"RTN","PSORN52C",9,0)
 .I $O(^TMP("PSODAI",$J,0)) S DAI=0 F  S DAI=$O(^TMP("PSODAI",$J,DAI)) Q:'DAI  D
"RTN","PSORN52C",10,0)
 ..S:'$D(^PSRX(PSOX("IRXN"),"DAI",0)) ^PSRX(PSOX("IRXN"),"DAI",0)="^52.03^^" S ^PSRX(PSOX("IRXN"),"DAI",DAI,0)=^TMP("PSODAI",$J,DAI,0)
"RTN","PSORN52C",11,0)
 ..S $P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1
"RTN","PSORN52C",12,0)
 .K ^TMP("PSODAI",$J),DAI
"RTN","PSORN52C",13,0)
 S PSORN52(PSOX("IRXN"),0)=PSOX("NRX0"),PSORN52(PSOX("IRXN"),2)=PSOX("NRX2"),PSORN52(PSOX("IRXN"),3)=PSOX("NRX3")
"RTN","PSORN52C",14,0)
 S PSORN52(PSOX("IRXN"),"EPH")=PSOX("EPH")
"RTN","PSORN52C",15,0)
 S:'$G(PSOX("ENT")) PSORN52(PSOX("IRXN"),"SIG")=PSOX("SIG")
"RTN","PSORN52C",16,0)
 S PSORN52(PSOX("IRXN"),"STA")=PSOX("STA")
"RTN","PSORN52C",17,0)
 S:$G(PSOX("TN"))]"" PSORN52(PSOX("IRXN"),"TN")=PSOX("TN")
"RTN","PSORN52C",18,0)
 I $G(PSOX("METHOD OF PICK-UP"))]"",PSOX("FILL DATE")'>DT S PSORN52(PSOX("IRXN"),"MP")=PSOX("METHOD OF PICK-UP")
"RTN","PSORN52C",19,0)
 S PSORN52(PSOX("IRXN"),"TYPE")=0
"RTN","PSORN52C",20,0)
 S PSOX1="" F  S PSOX1=$O(PSORN52(PSOX("IRXN"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),PSOX1)=$G(PSORN52(PSOX("IRXN"),PSOX1))
"RTN","PSORN52C",21,0)
 I $O(SIG(0)) D  G ENT
"RTN","PSORN52C",22,0)
 .S II=0 F I=0:0 S I=$O(SIG(I)) Q:'I  S ^PSRX(PSOX("IRXN"),"SIG1",I,0)=SIG(I),II=II+1
"RTN","PSORN52C",23,0)
 .S ^PSRX(PSOX("IRXN"),"SIG1",0)="^52.04A^"_II_"^"_II,$P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1 K I,II
"RTN","PSORN52C",24,0)
 .S $P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1
"RTN","PSORN52C",25,0)
ENT S ^PSRX(PSOX("IRXN"),"POE")=1,^PSRX(PSOX("IRXN"),"INS")=$G(PSOX("INS"))
"RTN","PSORN52C",26,0)
 I $G(OR0) S:$P(OR0,"^",24) ^PSRX(PSOX("IRXN"),"PKI")=1
"RTN","PSORN52C",27,0)
 I $G(PSOX("SIG",1))]"",'$O(PSOX("SIG",1)) S ^PSRX(PSOX("IRXN"),"INS1",1,0)=PSOX("SIG",1),^PSRX(PSOX("IRXN"),"INS1",0)="^52.0115^1^1^"_DT_"^^"
"RTN","PSORN52C",28,0)
 I $O(^PSRX(PSOX("OIRXN"),"INS1",0)) D
"RTN","PSORN52C",29,0)
 .F D=0:0 S D=$O(^PSRX(PSOX("OIRXN"),"INS1",D)) Q:'D  S ^PSRX(PSOX("IRXN"),"INS1",D,0)=^PSRX(PSOX("OIRXN"),"INS1",D,0)
"RTN","PSORN52C",30,0)
 .S ^PSRX(PSOX("IRXN"),"INS1",0)=^PSRX(PSOX("OIRXN"),"INS1",0)
"RTN","PSORN52C",31,0)
TNT F I=1:1:PSOX("ENT") S ^PSRX(PSOX("IRXN"),6,I,0)=PSOX("DOSE",I)_"^"_$G(PSOX("DOSE ORDERED",I))_"^"_$G(PSOX("UNITS",I))_"^"_$G(PSOX("NOUN",I))_"^" D
"RTN","PSORN52C",32,0)
 .S ^PSRX(PSOX("IRXN"),6,I,0)=^PSRX(PSOX("IRXN"),6,I,0)_$G(PSOX("DURATION",I))_"^"_$G(PSOX("CONJUNCTION",I))_"^"_$G(PSOX("ROUTE",I))_"^"_$G(PSOX("SCHEDULE",I))_"^"_$G(PSOX("VERB",I))
"RTN","PSORN52C",33,0)
 .I $G(PSOX("ODOSE",I))]"" S ^PSRX(PSOX("IRXN"),6,I,1)=PSOX("ODOSE",I)
"RTN","PSORN52C",34,0)
 S:$G(PSOX("ENT")) ^PSRX(PSOX("IRXN"),6,0)="^52.0113^"_PSOX("ENT")_"^"_PSOX("ENT")
"RTN","PSORN52C",35,0)
 Q
"RTN","PSORN52C",36,0)
ORC ;
"RTN","PSORN52C",37,0)
 D MARK^PSOTPCAN
"RTN","PSORN52C",38,0)
 K PSORDEDT,GG,PSOHD,PSOID,PTST,PTDY,PTRF,RFCNT,RN,SEG1,SIG,SIGOK,DIC
"RTN","PSORN52C",39,0)
 K ST0,STA,STP,STR,JJ,LSI,MM,ORDG,ORIG,PHARMST,PSCAN,PSCNT,PSOI,GMRAL,DIC,DIE,HDR,IEN,NAME D KVA^VADPT
"RTN","PSORN52C",40,0)
 I $G(PSOFDR) D 
"RTN","PSORN52C",41,0)
 .I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(PSOX("IRXN"))
"RTN","PSORN52C",42,0)
 .S $P(^PSRX(PSOX("IRXN"),"OR1"),"^",2)=$P(OR0,"^"),^PSRX("APL",$P(OR0,"^"),PSOX("IRXN"))=""
"RTN","PSORN52C",43,0)
 .I $P($G(^PS(52.41,+$G(ORD),"EXT")),"^")="" I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) K:'$G(PSOPRC) PRC K PHI
"RTN","PSORN52C",44,0)
 .I $O(PRC(0)) S T=0 F  S T=$O(PRC(T)) Q:'T  S ^PSRX(PSOX("IRXN"),"PRC",T,0)=PRC(T),^PSRX(PSOX("IRXN"),"PRC",0)="^^"_T_"^"_T_"^"_DT_"^"
"RTN","PSORN52C",45,0)
 .I $O(PHI(0)) S T=0 F  S T=$O(PHI(T)) Q:'T  S ^PSRX(PSOX("IRXN"),"PI",T,0)=PHI(T),^PSRX(PSOX("IRXN"),"PI",0)="^^"_T_"^"_T_"^"_DT_"^"
"RTN","PSORN52C",46,0)
 .I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) D  S PSOI=1 Q
"RTN","PSORN52C",47,0)
 ..S POERR("PLACER")=$P(^PS(52.41,ORD,0),"^"),PSORDEDT=ORD
"RTN","PSORN52C",48,0)
 ..K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD)
"RTN","PSORN52C",49,0)
 ..S DA=ORD,DIK="^PS(52.41," D ^DIK
"RTN","PSORN52C",50,0)
 ..S $P(^PSRX(PSOX("IRXN"),"OR1"),"^")=$G(PSODRUG("OI"))
"RTN","PSORN52C",51,0)
 .E  S $P(^PSRX(PSOX("IRXN"),"OR1"),"^")=$P(OR0,"^",8)
"RTN","PSORN52C",52,0)
 .D PSOUL^PSSLOCK(ORD_"S") S DIK="^PS(52.41,",DA=ORD D ^DIK K DIK,DA
"RTN","PSORN52C",53,0)
 S:$G(PSOX("OIRXN"))&('$G(COPY)) $P(^PSRX(PSOX("IRXN"),"OR1"),"^",3)=PSOX("OIRXN"),$P(^PSRX(PSOX("OIRXN"),"OR1"),"^",4)=PSOX("IRXN"),^PSRX("AQ",PSOX("IRXN"),PSOX("OIRXN"))=""
"RTN","PSORN52C",54,0)
 I $O(PRC(0)) S T=0 F  S T=$O(PRC(T)) Q:'T  S ^PSRX(PSOX("IRXN"),"PRC",T,0)=PRC(T),^PSRX(PSOX("IRXN"),"PRC",0)="^^"_T_"^"_T_"^"_DT_"^"
"RTN","PSORN52C",55,0)
 I $O(PHI(0)) S T=0 F  S T=$O(PHI(T)) Q:'T  S ^PSRX(PSOX("IRXN"),"PI",T,0)=PHI(T),^PSRX(PSOX("IRXN"),"PI",0)="^^"_T_"^"_T_"^"_DT_"^"
"RTN","PSORN52C",56,0)
 S $P(^PSRX(PSOX("IRXN"),"OR1"),"^",5)=DUZ
"RTN","PSORN52C",57,0)
 S $P(^PSRX(PSOX("IRXN"),"OR1"),"^",8)=$$NOW^XLFDT D
"RTN","PSORN52C",58,0)
 . N DA,DIK S DA=PSOX("IRXN"),DIK="^PSRX(",DIK(1)=38.3 D EN1^DIK K DIK,DA
"RTN","PSORN52C",59,0)
 S PHARMST="",$P(^PSRX(PSOX("IRXN"),"OR1"),"^")=$G(PSODRUG("OI"))
"RTN","PSORN52C",60,0)
 S RXN=PSOX("IRXN") D SAVE
"RTN","PSORN52C",61,0)
 S STAT=$S($G(OR0)]""&('$G(PSOI)):"SC",$G(PSOI):"RO",1:"SN") S PHARMST=$S('$G(PSORX("VERIFY")):"CM",1:"IP") ;D EN^PSOHLSN1(RXN,STAT,PHARMST,"",PSONOOR)
"RTN","PSORN52C",62,0)
 S ^TMP("PSORXN",$J,RXN)=STAT_"^"_PHARMST_"^"_PSONOOR D PSOL^PSSLOCK(RXN)
"RTN","PSORN52C",63,0)
 D RESTORE K PSORDEDT,PHI,PRC,STAT,COMM,PSOI,OR2,OR1,PHARMST,RXN,DRG,STA,ACT,OCXR,OCXD1,OCXDT,OCXI
"RTN","PSORN52C",64,0)
 Q
"RTN","PSORN52C",65,0)
BBRX ;build bingo board Rx array; called by PSON52,PSOR52,PSORN52
"RTN","PSORN52C",66,0)
 I $G(BBRX(1))']"" S BBRX(1)=PSOX("IRXN")_"," Q
"RTN","PSORN52C",67,0)
 F PSOX1=0:0 S PSOX1=$O(BBRX(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORN52C",68,0)
 I $L(BBRX(PSOX2))+$L(PSOX("IRXN"))<220 S BBRX(PSOX2)=BBRX(PSOX2)_PSOX("IRXN")_","
"RTN","PSORN52C",69,0)
 E  S BBRX(PSOX2+1)=PSOX("IRXN")_","
"RTN","PSORN52C",70,0)
 Q
"RTN","PSORN52C",71,0)
SAVE ;this module will be used to save PSO arrays
"RTN","PSORN52C",72,0)
 K ^TMP("PSOLST",$J) F I=0:0 S I=$O(PSOLST(I)) Q:'I  S ^TMP("PSOLST",$J,I,0)=PSOLST(I)
"RTN","PSORN52C",73,0)
 K ^TMP("PSOSD",$J) S (STA,DRG)="" F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DRG=$O(PSOSD(STA,DRG)) Q:DRG=""  S ^TMP("PSOSD",$J,STA,DRG)=PSOSD(STA,DRG)
"RTN","PSORN52C",74,0)
 I $G(PSOSD) S ^TMP("PSOSD",$J,0)=PSOSD
"RTN","PSORN52C",75,0)
 I $G(PSODRUG("NAME"))]"" K ^TMP("PSODRUG",$J) S STA=""  F  S STA=$O(PSODRUG(STA)) Q:STA=""  S ^TMP("PSODRUG",$J,STA)=PSODRUG(STA)
"RTN","PSORN52C",76,0)
 I $G(PSOX("# OF REFILLS"))]"" K ^TMP("PSOX",$J),^TMP("PSORENW",$J),^TMP("PSONEW",$J),^TMP("PSORXED",$J) D
"RTN","PSORN52C",77,0)
 .S STA="" F  S STA=$O(PSOX(STA)) Q:STA=""  S ^TMP("PSOX",$J,STA)=$G(PSOX(STA)) D
"RTN","PSORN52C",78,0)
 ..I STA="OLD LAST RX#",$O(PSOX(STA,"")) K ^TMP("PSOX",$J,STA) S ^TMP("PSOX",$J,STA,$O(PSOX(STA,"")))=PSOX(STA,$O(PSOX(STA,""))) D  Q
"RTN","PSORN52C",79,0)
 ...I $O(PSONEW(STA,"")) S ^TMP("PSONEW",$J,STA,$O(PSONEW(STA,"")))=PSONEW(STA,$O(PSONEW(STA,"")))
"RTN","PSORN52C",80,0)
 ...I $O(PSORENW(STA,"")) S ^TMP("PSORENW",$J,STA,$O(PSORENW(STA,"")))=PSORENW(STA,$O(PSORENW(STA,"")))
"RTN","PSORN52C",81,0)
 ...I $O(PSORXED(STA,"")) S ^TMP("PSORXED",$J,STA,$O(PSORXED(STA,"")))=PSORXED(STA,$O(PSORXED(STA,"")))
"RTN","PSORN52C",82,0)
 ..F ACT="PSORENW","PSONEW","PSORXED" I $G(@(ACT_"("""_STA_""")"))]"" S ^TMP(ACT,$J,STA)=@(ACT_"("""_STA_""")")
"RTN","PSORN52C",83,0)
 K PSOPTPST,PSOSD,PSONEW,PSOLST,PSORENW,PSORXED,PSODRUG
"RTN","PSORN52C",84,0)
 Q
"RTN","PSORN52C",85,0)
RESTORE ;this module restore saved arrays
"RTN","PSORN52C",86,0)
 S STA=0 F  S STA=$O(^TMP("PSOLST",$J,STA)) Q:'STA  S PSOLST(STA)=^TMP("PSOLST",$J,STA,0)
"RTN","PSORN52C",87,0)
 I $G(^TMP("PSOSD",$J,0)) S PSOSD=$G(^TMP("PSOSD",$J,0))
"RTN","PSORN52C",88,0)
 S (STA,DRG)="" F  S STA=$O(^TMP("PSOSD",$J,STA)) Q:STA=""  F  S DRG=$O(^TMP("PSOSD",$J,STA,DRG)) Q:DRG=""  S PSOSD(STA,DRG)=^TMP("PSOSD",$J,STA,DRG)
"RTN","PSORN52C",89,0)
 S STA="" F  S STA=$O(^TMP("PSODRUG",$J,STA)) Q:STA=""  S PSODRUG(STA)=^TMP("PSODRUG",$J,STA)
"RTN","PSORN52C",90,0)
 S STA="" F ACT="PSOX","PSORENW","PSONEW","PSORXED" D:$O(^TMP(ACT,$J,STA))]""
"RTN","PSORN52C",91,0)
 .F  S STA=$O(^TMP(ACT,$J,STA)) Q:STA=""  I STA'="OLD LAST RX#" S @(ACT_"("""_STA_""")")=^TMP(ACT,$J,STA)
"RTN","PSORN52C",92,0)
 I $O(^TMP("PSOX",$J,"OLD LAST RX#","")) S PSOX("OLD LAST RX#",$O(^TMP("PSOX",$J,"OLD LAST RX#","")))=^TMP("PSOX",$J,"OLD LAST RX#",$O(^TMP("PSOX",$J,"OLD LAST RX#","")))
"RTN","PSORN52C",93,0)
 I $O(^TMP("PSONEW",$J,"OLD LAST RX#","")) S PSONEW("OLD LAST RX#",$O(^TMP("PSONEW",$J,"OLD LAST RX#","")))=^TMP("PSONEW",$J,"OLD LAST RX#",$O(^TMP("PSONEW",$J,"OLD LAST RX#","")))
"RTN","PSORN52C",94,0)
 I $O(^TMP("PSORENW",$J,"OLD LAST RX#","")) S PSORENW("OLD LAST RX#",$O(^TMP("PSORENW",$J,"OLD LAST RX#","")))=^TMP("PSORENW",$J,"OLD LAST RX#",$O(^TMP("PSORENW",$J,"OLD LAST RX#","")))
"RTN","PSORN52C",95,0)
 I $O(^TMP("PSORXED",$J,"OLD LAST RX#","")) S PSORXED("OLD LAST RX#",$O(^TMP("PSORXED",$J,"OLD LAST RX#","")))=^TMP("PSORXED",$J,"OLD LAST RX#",$O(^TMP("PSORXED",$J,"OLD LAST RX#","")))
"RTN","PSORN52C",96,0)
 K ^TMP("PSOSD",$J),^TMP("PSODRUG",$J),^TMP("PSOX",$J),^TMP("PSORENW",$J),^TMP("PSONEW",$J),^TMP("PSORXED",$J),^TMP("PSOLST",$J)
"RTN","PSORN52C",97,0)
 Q
"RTN","PSOSULB1")
0^23^B25215096^B17301699
"RTN","PSOSULB1",1,0)
PSOSULB1 ;BHAM ISC/RTR,SAB-Print suspended labels  cont. ; 10/10/96
"RTN","PSOSULB1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,200**;DEC 1997;Build 7
"RTN","PSOSULB1",3,0)
DEV D:'$D(PSOPAR) ^PSOLSET G:'$D(PSOPAR) DEV S PSOION=ION
"RTN","PSOSULB1",4,0)
 N X S X="PSXRSUS" X ^%ZOSF("TEST") G:($T)&($G(PSXSYS))&($D(^XUSEC("PSXCMOPMGR",DUZ)))&($D(^XUSEC("PSX XMIT",DUZ))) ^PSXRSUS
"RTN","PSOSULB1",5,0)
DEV1 I '$P(PSOPAR,"^",8) G START
"RTN","PSOSULB1",6,0)
 N PSOPROP,PFIO W $C(7),!!,"PROFILES MUST BE SENT TO PRINTER !!",! K IOP,%ZIS,IO("Q"),POP S %ZIS="MNQ",%ZIS("A")="Select PROFILE Device: " D ^%ZIS K %ZIS("A") G:POP EXIT^PSOSULBL G:$E(IOST)["C"!(PSOION=ION) DEV S PSOPROP=ION D ^%ZISC
"RTN","PSOSULB1",7,0)
START I $G(PSOCUTDT)']"" S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,PSOPRPAS=$P(PSOPAR,"^",7)
"RTN","PSOSULB1",8,0)
ASK K ^TMP($J),PSOSU,PSOSUSPR S PFIOQ=0,PDUZ=DUZ W !
"RTN","PSOSULB1",9,0)
 S %DT="AEX",%DT("A")="Print labels through date: ",%DT("B")="TODAY" D ^%DT K %DT D:Y<0 MESS G:Y<0 EXIT^PSOSULBL S PRTDT=Y
"RTN","PSOSULB1",10,0)
 I '$O(^PS(52.5,"C",0))!($O(^(0))>PRTDT) W $C(7),!!,"NOTHING THRU DATE TO PRINT" G ASK
"RTN","PSOSULB1",11,0)
 W ! K DIR S DIR("A")="Sort by Patient Name, ID#, or DEA Special Handling",DIR(0)="SB^P:PATIENT NAME;I:IDENTIFICATION NUMBER;D:DEA SPECIAL HANDLING"
"RTN","PSOSULB1",12,0)
 S DIR("?")="Enter 'P' to sort the labels alphabetically by name, enter 'I' to sort by identification number, enter 'D' to sort by DEA Special Handling."
"RTN","PSOSULB1",13,0)
 S DIR("?",1)="Sorting by DEA Special Handling will print the labels in three groups. The",DIR("?",2)="first will contain labels with drugs marked with an A or C in the DEA Special"
"RTN","PSOSULB1",14,0)
 S DIR("?",3)="Handling field, indicating NARCOTICS AND ALCOHOLICS, and CONTROLLED SUBSTANCES-",DIR("?",4)="NON NARCOTIC. The second group will contain ones marked with an S, indicating"
"RTN","PSOSULB1",15,0)
 S DIR("?",5)="SUPPLY, and all others will print in the third group.",DIR("?",6)=""
"RTN","PSOSULB1",16,0)
 D ^DIR K DIR D:$D(DIRUT) MESS G:$D(DIRUT) EXIT^PSOSULBL S PSRT=$S(Y="D":"D",Y="P":1,1:0)
"RTN","PSOSULB1",17,0)
 I Y="D" W ! K DIR S DIR(0)="SB^P:PATIENT NAME;I:IDENTIFICATION NUMBER",DIR("A")="Within DEA Special Handling, sort by Patient Name or ID#" D ^DIR K DIR D:$D(DIRUT) MESS G:$D(DIRUT) EXIT^PSOSULBL S PSRTONE=Y
"RTN","PSOSULB1",18,0)
 S X1=PRTDT,X2=$P(PSOPAR,"^",27) D C^%DTC S XDATE=X K IOP,POP,IO("Q"),ZTSK
"RTN","PSOSULB1",19,0)
PRLBL W ! S %ZIS("A")="Printer 'LABEL' Device: ",%ZIS("B")="",%ZIS="MQN" D ^%ZIS S PSLION=ION I POP S IOP=PSOION D ^%ZIS D MESS G EXIT^PSOSULBL
"RTN","PSOSULB1",20,0)
 I $E(IOST)'["P" D MESSL G PRLBL
"RTN","PSOSULB1",21,0)
 N PSOIOS S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSOSULB1",22,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&$P(PSOPAR,"^",19)
"RTN","PSOSULB1",23,0)
 K PSOION D ^%ZISC I $D(IO("Q")) K IO("Q")
"RTN","PSOSULB1",24,0)
QUE K %DT,PSOTIME,PSOOUT D NOW^%DTC S %DT="REAX",%DT(0)=%,%DT("B")="NOW",%DT("A")="Queue to run at what time: " D ^%DT K %DT I $D(DTOUT)!(Y<0) D MESS G EXIT^PSOSULBL
"RTN","PSOSULB1",25,0)
 S (PSOSUSPR,PSODBQ)=1,PSOTIME=Y
"RTN","PSOSULB1",26,0)
 S ZTRTN="BEG^PSOSULBL",ZTDESC="PRINT LABELS FROM SUSPENSE",ZTIO=PSLION,ZTDTH=PSOTIME
"RTN","PSOSULB1",27,0)
 F G="PSOPAR","PSOSYS","PSOSUSPR","PSODBQ","PSRT","PSRTONE","PSOPROP","PSLION","PFIO","PSOBARS","PSODTCUT","PSOPRPAS","PRTDT","PDUZ","PSOBAR0","PSOBAR1","PSOSITE","XDATE","PSOTIME" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOSULB1",28,0)
 D ^%ZTLOAD W !!,"PRINT FROM SUSPENSE JOB QUEUED!",! D ^%ZISC G EXIT^PSOSULBL
"RTN","PSOSULB1",29,0)
 ;G:PSRT'="D" BEG^PSOSULBL
"RTN","PSOSULB1",30,0)
MESS W $C(7),!!?3,"NOTHING QUEUED TO PRINT!",! Q
"RTN","PSOSULB1",31,0)
MESSL W $C(7),!?3,"LABELS MUST BE SENT TO A PRINTER!",! Q
"RTN","PSOSULB1",32,0)
BAIMAIL     ;Send mail message
"RTN","PSOSULB1",33,0)
 S:'$G(PDUZ) PDUZ=+$G(DUZ)
"RTN","PSOSULB1",34,0)
 K ^TMP("PSOM",$J)
"RTN","PSOSULB1",35,0)
 N SEQ,XMY,XMDUZ,XMSUB,XMTEXT,SEQ,NAME,PSSN,RX,FILL,FIRST
"RTN","PSOSULB1",36,0)
 S SEQ=1
"RTN","PSOSULB1",37,0)
 S XMY(PDUZ)=""
"RTN","PSOSULB1",38,0)
 S XMY("G.PSO EXTERNAL DISPENSE ALERTS")=""
"RTN","PSOSULB1",39,0)
 S XMDUZ="OUTPATIENT PHARMACY PACKAGE"
"RTN","PSOSULB1",40,0)
 S XMSUB="BAD ADDRESS SUSPENSE NOT PRINTED"
"RTN","PSOSULB1",41,0)
 I $G(PSOSITE) S XMSUB=$$GET1^DIQ(59,PSOSITE,.06)_" "_XMSUB
"RTN","PSOSULB1",42,0)
 S ^TMP("PSOM",$J,SEQ)="The following prescriptions with a routing of mail were not printed/sent to",SEQ=SEQ+1
"RTN","PSOSULB1",43,0)
 S ^TMP("PSOM",$J,SEQ)="external interface due to the BAD ADDRESS INDICATOR being set and no active",SEQ=SEQ+1
"RTN","PSOSULB1",44,0)
 S ^TMP("PSOM",$J,SEQ)="temporary address or patient has an active MAIL status of DO NOT MAIL:",SEQ=SEQ+1
"RTN","PSOSULB1",45,0)
 S NAME="" F  S NAME=$O(^TMP("PSOSM",$J,NAME)) Q:NAME=""  D
"RTN","PSOSULB1",46,0)
 .S PSSN="" F  S PSSN=$O(^TMP("PSOSM",$J,NAME,PSSN)) Q:PSSN=""  D
"RTN","PSOSULB1",47,0)
 ..S ^TMP("PSOM",$J,SEQ)="",SEQ=SEQ+1
"RTN","PSOSULB1",48,0)
 ..S ^TMP("PSOM",$J,SEQ)=NAME_"   "_PSSN,FIRST=1
"RTN","PSOSULB1",49,0)
 ..S RX=0 F  S RX=$O(^TMP("PSOSM",$J,NAME,PSSN,RX)) Q:'RX  S FILL="" F  S FILL=$O(^TMP("PSOSM",$J,NAME,PSSN,RX,FILL)) Q:FILL=""  D
"RTN","PSOSULB1",50,0)
 ...I FIRST D  S FIRST=0
"RTN","PSOSULB1",51,0)
 ....S ^TMP("PSOM",$J,SEQ)=^TMP("PSOM",$J,SEQ)_"   ("_$G(^TMP("PSOSM",$J,NAME,PSSN,RX,FILL))_")"
"RTN","PSOSULB1",52,0)
 ....S SEQ=SEQ+1
"RTN","PSOSULB1",53,0)
 ...S ^TMP("PSOM",$J,SEQ)="  "_$P(^PSRX(RX,0),"^")_" ("_FILL_")  "_$P($G(^PSDRUG($P(^PSRX(RX,0),"^",6),0)),"^"),SEQ=SEQ+1
"RTN","PSOSULB1",54,0)
 S ^TMP("PSOM",$J,SEQ+1)=""
"RTN","PSOSULB1",55,0)
 S XMTEXT="^TMP(""PSOM"",$J," N DIFROM D ^XMD K XMSUB,XMTEXT,XMY,XMDUZ
"RTN","PSOSULB1",56,0)
 Q
"RTN","PSOSULB1",57,0)
 ;
"RTN","PSOSULBL")
0^21^B61486377^B38582182
"RTN","PSOSULBL",1,0)
PSOSULBL ;BHAM ISC/RTR,SAB-Print Suspended labels ;4/8/93
"RTN","PSOSULBL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**139,173,174,148,200**;DEC 1997;Build 7
"RTN","PSOSULBL",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOSULBL",4,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOSULBL",5,0)
 K PDUZ,REPRINT G ^PSOSULB1
"RTN","PSOSULBL",6,0)
BEG ;
"RTN","PSOSULBL",7,0)
 K PSORUNIN,PSORETRY N BPSCNT
"RTN","PSOSULBL",8,0)
 S PSORUNIN="PSOSUSP"_($G(PSOSITE))
"RTN","PSOSULBL",9,0)
 L +@PSORUNIN:10 I '$T D
"RTN","PSOSULBL",10,0)
 . F PSORETRY=1:1:120 L +@PSORUNIN:60 I $T Q  ;wait Max of 2 hrs before continue
"RTN","PSOSULBL",11,0)
 . Q
"RTN","PSOSULBL",12,0)
 K ^UTILITY($J,"PSOPRO"),^TMP("PSOSBAI",$J) S PSOSEQ=1 F DFN=0:0 S DFN=$O(^PS(52.5,"AC",DFN)) Q:'DFN  D  D:'PSRT PID^VADPT6 D CHKDEAD D:'DEAD&($G(PSOSFLAG)) PRT
"RTN","PSOSULBL",13,0)
 .S PSOSFLAG=0 F ZZ=0:0 S ZZ=$O(^PS(52.5,"AC",DFN,ZZ)) Q:'ZZ!$G(PSOSFLAG)  I ZZ'>PRTDT S PSOSFLAG=1
"RTN","PSOSULBL",14,0)
 D PPL
"RTN","PSOSULBL",15,0)
 D:$D(^UTILITY($J,"PSOPRO"))&($P(PSOPAR,"^",8)) PROF
"RTN","PSOSULBL",16,0)
 G EXIT
"RTN","PSOSULBL",17,0)
PRT F SDT=0:0 S SDT=$O(^PS(52.5,"AC",DFN,SDT)) D:SDT CHK Q:'SDT
"RTN","PSOSULBL",18,0)
 Q
"RTN","PSOSULBL",19,0)
EXIT ;
"RTN","PSOSULBL",20,0)
 I $D(^TMP("PSOSBAI",$J)) D CHKMAIL
"RTN","PSOSULBL",21,0)
 K ^TMP($J),^TMP("PSOSBAI",$J)
"RTN","PSOSULBL",22,0)
 I $D(PSORUNIN) L -@PSORUNIN
"RTN","PSOSULBL",23,0)
 D ^%ZISC
"RTN","PSOSULBL",24,0)
 K %,%ZIS,CNT,COM,DA,DEAD,DFN,DIRUT,DTTM,G,HDPPL,JJ,JJJ,JJJJ,PDUZ,IOP,ORD,PFIOQ,PSLION,PSRT,POP,PRF,PRTDT,PSLIO,PSNP,PSODBQ,PSOSEQ,PSOSFLAG,PSOSU,PSOTIME,PSOOUT,PSOPRFLG,PSOSEQ,PSOSUSPR,PSSPND,PST,PTL,PPLHLD,PSFNIEN,ZTSK
"RTN","PSOSULBL",25,0)
 K PSOBADDR,PSORUNIN,PSORETRY,PSRTONE,PSSRT,PSUSDEA,RF,RFCNT,RX,SDT,SFN,SREC,STOP,SUSPT,VADM,VAPA,X,X1,X2,XAK,XDATE,Y,Z,ZZ,WWW,PSDDDATE,SINRX,RXPR,RXPR1,GGGG,XXX,ZII,ZTDESC,ZTRTN,ZTSAVE,RRRR,RXRP,RXRP1,RXFL,SPR S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOSULBL",26,0)
CHK I SDT'>XDATE D TMP Q
"RTN","PSOSULBL",27,0)
 Q
"RTN","PSOSULBL",28,0)
TMP F SFN=0:0 S SFN=$O(^PS(52.5,"AC",DFN,SDT,SFN)) Q:'SFN  D
"RTN","PSOSULBL",29,0)
 . I '$D(^PS(52.5,SFN,0))!'$D(^DPT(+DFN,0)) Q
"RTN","PSOSULBL",30,0)
 . N RXSITE,PRINTED,PSDFN,RXSTS,RXIEN,RXFILL,PARTIAL,RXEXPDT,RESP
"RTN","PSOSULBL",31,0)
 . S RXIEN=+$$GET1^DIQ(52.5,SFN,.01,"I"),RXDFN=$$GET1^DIQ(52,RXIEN,2,"I")
"RTN","PSOSULBL",32,0)
 . S RXSTS=$$GET1^DIQ(52,RXIEN,100,"I"),RXSITE=+$$GET1^DIQ(52.5,SFN,.06,"I"),PRINTED=+$$GET1^DIQ(52.5,SFN,2,"I")
"RTN","PSOSULBL",33,0)
 . S PARTIAL=+$$GET1^DIQ(52.5,SFN,.05,"I"),RXEXPDT=$$GET1^DIQ(52,RXIEN,26,"I")
"RTN","PSOSULBL",34,0)
 . S RXFILL=$$GET1^DIQ(52.5,SFN,9,"I") I RXFILL="" S RXFILL=$$LSTRFL^PSOBPSU1(RXIEN)
"RTN","PSOSULBL",35,0)
 . I RXSITE=$G(PSOSITE),'PRINTED,RXDFN=DFN,RXSTS<9 D
"RTN","PSOSULBL",36,0)
 . . I PARTIAL,'$D(^PSRX(RXIEN,"P",PARTIAL)) Q
"RTN","PSOSULBL",37,0)
 . . I RXEXPDT<DT,RXSTS<11 D  Q
"RTN","PSOSULBL",38,0)
 . . . N RXREC S RXREC=RXIEN D EX^PSOSUTL
"RTN","PSOSULBL",39,0)
 . . . K DIE,DA S DIE=52,DA=RXIEN,DR="100///11" D ^DIE K DIE,DA
"RTN","PSOSULBL",40,0)
 . . . K DIK,DA S DA=SFN,DIK="^PS(52.5," D ^DIK K DIK,DA
"RTN","PSOSULBL",41,0)
 . . S PSOBADDR=0 D CHKBAI I PSOBADDR Q
"RTN","PSOSULBL",42,0)
 . . I PSRT="D" D
"RTN","PSOSULBL",43,0)
 . . . S PSSRT=$S($G(PSRTONE)="I":VA("PID"),1:$P(^DPT(DFN,0),"^")_$P(^(0),"^",9))
"RTN","PSOSULBL",44,0)
 . . . S PSUSDEA=$P($G(^PS(52.5,SFN,0)),"^",10)
"RTN","PSOSULBL",45,0)
 . . . S SRT=$S(PSUSDEA["A"!(PSUSDEA["C"):"A-"_PSSRT,PSUSDEA["S":"S-"_PSSRT,1:"Z-"_PSSRT)
"RTN","PSOSULBL",46,0)
 . . I PSRT'="D" D
"RTN","PSOSULBL",47,0)
 . . . S SRT=$S(PSRT:$P(^DPT(DFN,0),"^")_$P(^(0),"^",9),1:VA("PID"))
"RTN","PSOSULBL",48,0)
 . . ; - If not partial fill, sending Rx to ECME for 3rd Party billing
"RTN","PSOSULBL",49,0)
 . . I 'PARTIAL,$$RETRX^PSOBPSUT(RXIEN,RXFILL),SDT>DT Q
"RTN","PSOSULBL",50,0)
 . . I 'PARTIAL D  I $$FIND^PSOREJUT(RXIEN,RXFILL) Q
"RTN","PSOSULBL",51,0)
 . . . I $$FIND^PSOREJUT(RXIEN,RXFILL) Q
"RTN","PSOSULBL",52,0)
 . . . I '$$RETRX^PSOBPSUT(RXIEN,RXFILL),$$STATUS^PSOBPSUT(RXIEN,RXFILL)'="" Q
"RTN","PSOSULBL",53,0)
 . . . D ECMESND^PSOBPSU1(RXIEN,RXFILL,,"PL",,,,,,.RESP) I $D(RESP),'RESP S BPSCNT=$G(BPSCNT)+1
"RTN","PSOSULBL",54,0)
 . . S ^TMP($J,SRT,SFN)=RXIEN
"RTN","PSOSULBL",55,0)
 Q
"RTN","PSOSULBL",56,0)
PPL ; Wait some time before printing so response from 3rd party payers can be received
"RTN","PSOSULBL",57,0)
 I $G(BPSCNT)>0 H 60+$S((BPSCNT*15)>7200:7200,1:(BPSCNT*15))
"RTN","PSOSULBL",58,0)
 K PPL,PPL1 S ORD="" F  S ORD=$O(^TMP($J,ORD)) Q:ORD=""  D PPL1
"RTN","PSOSULBL",59,0)
 Q
"RTN","PSOSULBL",60,0)
PPL1 ; Printing Labels
"RTN","PSOSULBL",61,0)
 N PARTIAL,REPRINT,REFILL,Z
"RTN","PSOSULBL",62,0)
 S (PSOPRFLG,SUSPT)=1 S:$D(PSOPROP) PFIO=PSOPROP
"RTN","PSOSULBL",63,0)
 S:'$D(PDUZ) PDUZ=DUZ K RXPR,RXPR1,PPL
"RTN","PSOSULBL",64,0)
 F SFN=0:0 S SFN=$O(^TMP($J,ORD,SFN)) Q:'SFN  D
"RTN","PSOSULBL",65,0)
 .I '$D(^PS(52.5,SFN,0)) Q
"RTN","PSOSULBL",66,0)
 .S Z=$G(^PS(52.5,SFN,0)),SINRX=+$P(Z,"^"),REFILL=+$P(Z,"^",13)
"RTN","PSOSULBL",67,0)
 .S PARTIAL=$P(Z,"^",5),REPRINT=$P(Z,"^",12)
"RTN","PSOSULBL",68,0)
 .; - Screening out OPEN/UNRESOLVED Rejects (3rd Party Payer)
"RTN","PSOSULBL",69,0)
 .I 'PARTIAL,'REPRINT,$$FIND^PSOREJUT(SINRX,REFILL) Q
"RTN","PSOSULBL",70,0)
 .I 'PARTIAL,'REPRINT,$$STATUS^PSOBPSUT(SINRX,REFILL)="IN PROGRESS" Q
"RTN","PSOSULBL",71,0)
 .I $L($G(PPL))<240 D
"RTN","PSOSULBL",72,0)
 ..S PPL=$P(^TMP($J,ORD,SFN),"^")_","_$G(PPL),RXPR(SINRX)=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSULBL",73,0)
 ..S:$P(^PS(52.5,SFN,0),"^",12) RXRP(SINRX)=1
"RTN","PSOSULBL",74,0)
 .E  D
"RTN","PSOSULBL",75,0)
 ..S PPL1=$P(^TMP($J,ORD,SFN),"^")_","_$G(PPL1),RXPR1(SINRX)=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSULBL",76,0)
 ..S:$P(^PS(52.5,SFN,0),"^",12) RXRP1(SINRX)=1
"RTN","PSOSULBL",77,0)
 .S DFN=$P(^PS(52.5,SFN,0),"^",3)
"RTN","PSOSULBL",78,0)
 .I $P(PSOPAR,"^",8),'$D(^PSRX($P(^PS(52.5,SFN,0),"^"),1)),'$G(RXPR(SINRX)),'$G(RXPR1(SINRX)) S PSOPRFLG=0
"RTN","PSOSULBL",79,0)
 S PSNP=$S($P(PSOPAR,"^",8):1,1:0)
"RTN","PSOSULBL",80,0)
 I $G(PPL) D
"RTN","PSOSULBL",81,0)
 .S PPLHLD=$G(PPL1),HDPPL=PPL K PPL1 S (PSODBQ,PSOSUSPR)=1
"RTN","PSOSULBL",82,0)
 .F GGGG=0:0 S GGGG=$O(RXPR(GGGG)) Q:'GGGG  K:'$G(RXPR(GGGG)) RXPR(GGGG)
"RTN","PSOSULBL",83,0)
 I $G(PPL) D DQ^PSOLBL,SEQ D:'$G(PSOPRFLG)
"RTN","PSOSULBL",84,0)
 .I $G(PSOPROP)'=$G(PSLION) S ^UTILITY($J,"PSOPRO",DFN)="" Q
"RTN","PSOSULBL",85,0)
 .D DQ^PSOPRFSS
"RTN","PSOSULBL",86,0)
 I $G(PPLHLD) K RXPR S (PPL,HDPPL)=PPLHLD,(PSODBQ,PSOSUSPR)=1,PSNP=0 S:'$D(PDUZ) PDUZ=DUZ F XXX=0:0 S XXX=$O(RXPR1(XXX)) Q:'XXX  S:$G(RXPR1(XXX)) RXPR(XXX)=RXPR1(XXX)
"RTN","PSOSULBL",87,0)
 I $G(PPLHLD) F RRRR=0:0 S RRRR=$O(RXRP1(RRRR)) Q:'RRRR  S:$D(RXRP1(RRRR)) RXRP(RRRR)=1
"RTN","PSOSULBL",88,0)
 I $G(PPLHLD) D DQ^PSOLBL,SEQ D:'$G(PSOPRFLG)
"RTN","PSOSULBL",89,0)
 .I $G(PSOPROP)'=$G(PSLION) S ^UTILITY($J,"PSOPRO",DFN)="" Q
"RTN","PSOSULBL",90,0)
 .D DQ^PSOPRFSS
"RTN","PSOSULBL",91,0)
 K PPL,PPL1,PPLHLD,RXPR,RXPR1,RXFL Q
"RTN","PSOSULBL",92,0)
SEQ ;
"RTN","PSOSULBL",93,0)
 S SQCOUNT=0 F JJJ=1:1:$L(HDPPL) S:$E(HDPPL,JJJ)="," SQCOUNT=SQCOUNT+1
"RTN","PSOSULBL",94,0)
 F JJJJ=1:1:SQCOUNT S PSFNIEN=$P(HDPPL,",",JJJJ) D:PSFNIEN
"RTN","PSOSULBL",95,0)
 .S PSFNIEN=$O(^PS(52.5,"B",PSFNIEN,0)) I PSFNIEN D
"RTN","PSOSULBL",96,0)
 ..S $P(^PS(52.5,PSFNIEN,0),"^",11)=PSOSEQ,PSOSEQ=PSOSEQ+1 S:$P(^PS(52.5,PSFNIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",6)) ^PS(52.5,"AS",$P(^PS(52.5,PSFNIEN,0),"^",8),$P(^(0),"^",9),$P(^(0),"^",6),$P(^(0),"^",11),PSFNIEN)=""
"RTN","PSOSULBL",97,0)
 Q
"RTN","PSOSULBL",98,0)
CHKDEAD D DEM^VADPT I VADM(1)="" S DEAD=0 Q
"RTN","PSOSULBL",99,0)
 I VADM(6)="" S DEAD=0 Q
"RTN","PSOSULBL",100,0)
 S PSDDDATE=$P(VADM(6),"^",2) F WWW=0:0 S WWW=$O(^PS(55,DFN,"P",WWW)) Q:'WWW  I $D(^PS(55,DFN,"P",WWW,0)),$P($G(^(0)),"^") S (DA,RXREC)=$P(^(0),"^") S SFN=$O(^PS(52.5,"B",RXREC,0)) I SFN,$D(^PS(52.5,SFN,0)) S RX=$P(^(0),"^") D DEAD
"RTN","PSOSULBL",101,0)
 Q
"RTN","PSOSULBL",102,0)
DEAD S $P(^PSRX(RX,"STA"),"^")=12,COM="Died ("_$G(PSDDDATE)_")",DA(1)=RX
"RTN","PSOSULBL",103,0)
 S DEAD=1 D ARECD^PSOSUTL S DIK="^PS(52.5,",DA=SFN D ^DIK K DIK
"RTN","PSOSULBL",104,0)
 Q
"RTN","PSOSULBL",105,0)
PROF ;
"RTN","PSOSULBL",106,0)
 S ZTRTN="PRPROF^PSOSULBL",ZTDESC="PRINT PROFILES FROM SUSPENSE",ZTDTH=$H,ZTIO=PSOPROP
"RTN","PSOSULBL",107,0)
 S ZTSAVE("^UTILITY($J,""PSOPRO"",")="",ZTSAVE("PSOPAR")="",ZTSAVE("PSODTCUT")="",ZTSAVE("PSOSITE")="",ZTSAVE("PSOPRPAS")="" D ^%ZTLOAD Q
"RTN","PSOSULBL",108,0)
PRPROF ;
"RTN","PSOSULBL",109,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"PSOPRO",LLL)) Q:'LLL  I $D(^DPT(LLL,0)) S DFN=LLL D DQ^PSOPRFSS
"RTN","PSOSULBL",110,0)
 K PSOPAR,PSODTCUT,PSOSITE,PSOPRPAS,LLL,DFN,^UTILITY($J,"PSOPRO") D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOSULBL",111,0)
 Q
"RTN","PSOSULBL",112,0)
 ;
"RTN","PSOSULBL",113,0)
CHKBAI ; IF BAD ADDRESS INDICATOR, NO ACTIVE TEMPORARY ADDRESS AND ROUTING OF MAIL, DO NOT SEND TO OPAI AND/OR DO NOT PRINT LABEL
"RTN","PSOSULBL",114,0)
 N PSOBADR,ACTSEQ,XX,PSOFIRST,ACTTYPE
"RTN","PSOSULBL",115,0)
 I '$G(RXFILL),$P(^PSRX(RXIEN,0),"^",11)="W" Q
"RTN","PSOSULBL",116,0)
 I $P($G(^PSRX(RXIEN,1,RXFILL,0)),"^",2)="W" Q
"RTN","PSOSULBL",117,0)
 S ACTTYPE="BAD ADDRESS INDICATOR"
"RTN","PSOSULBL",118,0)
 S PSOBADR=$$CHKRX^PSOBAI(RXIEN)
"RTN","PSOSULBL",119,0)
 ; GOOD PERMANENT OR TEMPORARY ADDRESS - CHECK FOR DO NOT MAIL
"RTN","PSOSULBL",120,0)
 I PSOBADR,'$P(PSOBADR,"^",2) D SETTMP(ACTTYPE) Q
"RTN","PSOSULBL",121,0)
 D NOMAIL
"RTN","PSOSULBL",122,0)
 Q
"RTN","PSOSULBL",123,0)
 ;
"RTN","PSOSULBL",124,0)
SETTMP(ACTTYPE) ;
"RTN","PSOSULBL",125,0)
 N ACTSEQ,XX,PSOFIRST,ZZ
"RTN","PSOSULBL",126,0)
 S PSOFIRST=1
"RTN","PSOSULBL",127,0)
 S PSOBADDR=1
"RTN","PSOSULBL",128,0)
 S ACTSEQ=0 F  S ACTSEQ=$O(^PSRX(RXIEN,"A",ACTSEQ)) Q:ACTSEQ=""  D
"RTN","PSOSULBL",129,0)
 .S XX=$G(^PSRX(RXIEN,"A",ACTSEQ,0)) I $P(XX,"^",2)="S" S ZZ=$P(XX,"^",4),ZZ=$S(ZZ<6:ZZ,1:ZZ-1) I ZZ=RXFILL,$P(XX,"^",5)["due to "_ACTTYPE S PSOFIRST=0 Q
"RTN","PSOSULBL",130,0)
 I PSOFIRST D
"RTN","PSOSULBL",131,0)
 .S ^TMP("PSOSBAI",$J,RXIEN,+RXFILL)=ACTTYPE
"RTN","PSOSULBL",132,0)
 .D ACT(ACTTYPE)
"RTN","PSOSULBL",133,0)
 Q
"RTN","PSOSULBL",134,0)
 ;
"RTN","PSOSULBL",135,0)
NOMAIL ; SEE IF FILE 55 STATUS IS DO NOT MAIL
"RTN","PSOSULBL",136,0)
 N ACTTYPE,DFN,MAILST,MAILEXP
"RTN","PSOSULBL",137,0)
 S ACTTYPE="DO NOT MAIL"
"RTN","PSOSULBL",138,0)
 S DFN=+$P($G(^PSRX(RXIEN,0)),"^",2),MAILST=$P($G(^PS(55,DFN,0)),"^",3) I MAILST'=2 Q
"RTN","PSOSULBL",139,0)
 S MAILEXP=$P(^PS(55,DFN,0),"^",5)
"RTN","PSOSULBL",140,0)
 I MAILEXP=""!(MAILEXP>DT) D SETTMP(ACTTYPE)
"RTN","PSOSULBL",141,0)
 Q
"RTN","PSOSULBL",142,0)
 ;
"RTN","PSOSULBL",143,0)
CHKMAIL ; SEE IF MAILMAN MESSAGE SHOULD BE SENT FOR BAI/MAIL ROUTING
"RTN","PSOSULBL",144,0)
 N RXIEN,RXFILL,ACTSEQ,XX,DFN,SSN,NAME,ACTTYPE,ZZ
"RTN","PSOSULBL",145,0)
 K ^TMP("PSOSM",$J)
"RTN","PSOSULBL",146,0)
 S RXIEN=0 F  S RXIEN=$O(^TMP("PSOSBAI",$J,RXIEN)) Q:'RXIEN  D
"RTN","PSOSULBL",147,0)
 .S RXFILL="" F  S RXFILL=$O(^TMP("PSOSBAI",$J,RXIEN,RXFILL)) Q:RXFILL=""  D
"RTN","PSOSULBL",148,0)
 ..S ACTTYPE=^TMP("PSOSBAI",$J,RXIEN,RXFILL)
"RTN","PSOSULBL",149,0)
 ..S ACTSEQ=0 F  S ACTSEQ=$O(^PSRX(RXIEN,"A",ACTSEQ)) Q:ACTSEQ=""  D
"RTN","PSOSULBL",150,0)
 ...S XX=$G(^PSRX(RXIEN,"A",ACTSEQ,0)) I $P(XX,"^",2)="S" S ZZ=$P(XX,"^",4),ZZ=$S(ZZ<6:ZZ,1:ZZ-1) I ZZ=RXFILL,$P(XX,"^",5)["due to "_ACTTYPE Q
"RTN","PSOSULBL",151,0)
 ...S DFN=$P(^PSRX(RXIEN,0),"^",2),NAME=$P(^DPT(DFN,0),"^"),SSN=$P(^(0),"^",9) I SSN="" S SSN=0
"RTN","PSOSULBL",152,0)
 ...S ^TMP("PSOSM",$J,NAME,SSN,RXIEN,RXFILL)=ACTTYPE
"RTN","PSOSULBL",153,0)
 I $D(^TMP("PSOSM",$J)) D BAIMAIL^PSOSULB1
"RTN","PSOSULBL",154,0)
 K ^TMP("PSOSM",$J)
"RTN","PSOSULBL",155,0)
 Q
"RTN","PSOSULBL",156,0)
 ;
"RTN","PSOSULBL",157,0)
ACT(ACTTYPE) ;adds activity info for rx not printed from suspense/not sent to OPAI
"RTN","PSOSULBL",158,0)
 N NOW,IR,FDA
"RTN","PSOSULBL",159,0)
 D NOW^%DTC S NOW=%
"RTN","PSOSULBL",160,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RXIEN,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOSULBL",161,0)
 S IR=IR+1,^PSRX(RXIEN,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOSULBL",162,0)
 S ^PSRX(RXIEN,"A",IR,0)=NOW_"^"_"S"_"^"_DUZ_"^"_$S(+RXFILL>5:RXFILL+1,1:+RXFILL)_"^"_"RX not printed from suspense due to "_ACTTYPE
"RTN","PSOSULBL",163,0)
 K PSUS,RXF,I,FDA,DIC,DIE,DR,Y,X,%,%I,%H,RSDT
"RTN","PSOSULBL",164,0)
 Q
"RTN","PSOTALK")
0^14^B84758414^B76664087
"RTN","PSOTALK",1,0)
PSOTALK ;BIR/EJW - SCRIPTALK INTERFACE FROM VISTA ;04/18/2003
"RTN","PSOTALK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**135,182,211,200**;DEC 1997;Build 7
"RTN","PSOTALK",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOTALK",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOTALK",5,0)
 ;External reference to ^PS(59.7 controlled subscription by DBIA 694
"RTN","PSOTALK",6,0)
 ;ROB SILVERMAN-HINES DEVELOPED ORIGINAL VISTA CUSTOM SOFTWARE FOR SCRIPTALK
"RTN","PSOTALK",7,0)
EN Q:'$$PAT55  ; QUIT IF NOT A SCRIPTALK ELIGIBLE PATIENT
"RTN","PSOTALK",8,0)
 S PSOSTALK=1
"RTN","PSOTALK",9,0)
 N PHONE,RXNUM,RXALPHA,DATE,EDATE,RFILLS,PTNAME,SIG,SIGX,PROV,DRUG,WARN,LINE
"RTN","PSOTALK",10,0)
 D GATHER,TRANS,CLEAN
"RTN","PSOTALK",11,0)
 Q
"RTN","PSOTALK",12,0)
 ;
"RTN","PSOTALK",13,0)
CLEAN K PHONE,RXNUM,RXALPHA,DATE,EDATE,RFILLS,PTNAME,SIG,SIGX,PROV,DRUG,WARN,VADM
"RTN","PSOTALK",14,0)
 K PSOCTP,PSOCTV,XMIT,PSORCT,PSOTSSN,PSOEXPDT
"RTN","PSOTALK",15,0)
 K PSOLNE,PSOLEN,PSOLINE,PSOWORD,PSOWDS,LINE
"RTN","PSOTALK",16,0)
 K PSOSIG1,PSOLSIG,PSOSIG,PSOSTOP,PSOPMAP
"RTN","PSOTALK",17,0)
 Q
"RTN","PSOTALK",18,0)
BARE N RX
"RTN","PSOTALK",19,0)
 D CLEAN
"RTN","PSOTALK",20,0)
 W ! S DIC="^PSRX(",DIC(0)="AEQM" D ^DIC K DIC Q:Y<0  S RX=+Y
"RTN","PSOTALK",21,0)
 D:'$D(PSOPAR) ^PSOLSET
"RTN","PSOTALK",22,0)
 I '$$PAT55 W !,"Patient not enrolled in ScripTalk program." G BAREO
"RTN","PSOTALK",23,0)
 I $P(^PSRX(RX,"STA"),"^")'=0 W !,"Prescription not ACTIVE" G BAREO
"RTN","PSOTALK",24,0)
 D GATHER
"RTN","PSOTALK",25,0)
 W !!,"  Queuing ScripTalk label"
"RTN","PSOTALK",26,0)
 D TRANS
"RTN","PSOTALK",27,0)
BAREO D CLEAN
"RTN","PSOTALK",28,0)
 W !!
"RTN","PSOTALK",29,0)
 G BARE
"RTN","PSOTALK",30,0)
 Q
"RTN","PSOTALK",31,0)
BARI N RX
"RTN","PSOTALK",32,0)
 D CLEAN
"RTN","PSOTALK",33,0)
 S RX=$$READER^PSOTALK1("FO^1:12","Enter Barcode Rx#")
"RTN","PSOTALK",34,0)
 Q:RX']""
"RTN","PSOTALK",35,0)
 G:RX'["-" BARIO
"RTN","PSOTALK",36,0)
 S RX=$P(RX,"-",2)
"RTN","PSOTALK",37,0)
 I '$D(^PSRX(RX,0)) W !,"Prescription not on file" G BARIO
"RTN","PSOTALK",38,0)
 I '$$PAT55 W !,"Patient not enrolled in ScripTalk program." G BARIO
"RTN","PSOTALK",39,0)
 I $P(^PSRX(RX,"STA"),"^")'=0 W !,"Prescription not ACTIVE" G BARIO
"RTN","PSOTALK",40,0)
 D:'$D(PSOPAR) ^PSOLSET
"RTN","PSOTALK",41,0)
 D GATHER
"RTN","PSOTALK",42,0)
 W !!,"  Queuing ScripTalk label"
"RTN","PSOTALK",43,0)
 D TRANS
"RTN","PSOTALK",44,0)
BARIO D CLEAN
"RTN","PSOTALK",45,0)
 W !!
"RTN","PSOTALK",46,0)
 G BARI
"RTN","PSOTALK",47,0)
 Q
"RTN","PSOTALK",48,0)
GATHER ;
"RTN","PSOTALK",49,0)
 N DFN
"RTN","PSOTALK",50,0)
 S DFN=$P(^PSRX(RX,0),"^",2)
"RTN","PSOTALK",51,0)
 D DEM^VADPT
"RTN","PSOTALK",52,0)
 S PHONE=$$PHONE
"RTN","PSOTALK",53,0)
 S RXNUM=+$$RXNUM
"RTN","PSOTALK",54,0)
 S RXALPHA=$$RXALPHA
"RTN","PSOTALK",55,0)
 S DATE=$$DATE
"RTN","PSOTALK",56,0)
 S FILLS=$$RFILLS I $L(RFILLS)=1 S FILLS="0"_FILLS
"RTN","PSOTALK",57,0)
 S PTNAME=VADM(1) D
"RTN","PSOTALK",58,0)
 .N FNAM,MI
"RTN","PSOTALK",59,0)
 .S FNAM=$P(PTNAME,",",2) I FNAM[" " D
"RTN","PSOTALK",60,0)
 ..S MI=$P(FNAM," ",2,99) I MI[" " S MI=$P(MI," ")
"RTN","PSOTALK",61,0)
 ..S FNAM=$P(FNAM," ")
"RTN","PSOTALK",62,0)
 .S PTNAME=FNAM_$S($G(MI)'="":" "_MI,1:"")_" "_$P(PTNAME,",")
"RTN","PSOTALK",63,0)
 .S PTNAME=$$UP^XLFSTR(PTNAME)
"RTN","PSOTALK",64,0)
 .S PTNAME=$TR(PTNAME,"-"," ")
"RTN","PSOTALK",65,0)
 .S PTNAME=$TR(PTNAME,".","")
"RTN","PSOTALK",66,0)
 .S PTNAME=$TR(PTNAME,"'"," ")
"RTN","PSOTALK",67,0)
 S SIG=$TR($$UP^XLFSTR($$SIGPOE),"[\]^_`{|}~","(/) -'( ) ")
"RTN","PSOTALK",68,0)
 S SIGX=$TR($$UP^XLFSTR($$SIGPOEX),"[\]^_`{|}~","(/) -'( ) ")
"RTN","PSOTALK",69,0)
 S PROV=$E($$UP^XLFSTR($$PROV),1,30)
"RTN","PSOTALK",70,0)
 S DRUG=$TR($$UP^XLFSTR($$DRUG),"[\]^_`{|}~","(/) -'( ) ")
"RTN","PSOTALK",71,0)
 S WARN=$$WARN
"RTN","PSOTALK",72,0)
 D PSOEXP
"RTN","PSOTALK",73,0)
 S LINE(1)="VAMC "_$$CITY_", "_$$STATE_"  "_$$ZIP
"RTN","PSOTALK",74,0)
 S LINE(2)=$$SITE_" ("_$$CLERK_"/"_$$VRPH_") "_$$ACODE_"-"_$$EPHON_" Exp: "_PSOEXPDT
"RTN","PSOTALK",75,0)
 S LINE(3)="Rx# "_$$RXNUM_"  "_$$EDATE_"  Fill "_$$FILNO_" of "_$$TFILLS
"RTN","PSOTALK",76,0)
 S LINE(4)=$$EPAT_"  "_$$LAST6
"RTN","PSOTALK",77,0)
 D INST^PSOTALK1 S LINE(5)=$G(PSOLNE(1)),LINE(6)=$G(PSOLNE(2)),LINE(7)=$G(PSOLNE(3))
"RTN","PSOTALK",78,0)
 S LINE(8)=$$EPROV,LINE(10)=$$DRUG
"RTN","PSOTALK",79,0)
 S LINE(9)="Qty: "_$$QTY_"  "_$$DF
"RTN","PSOTALK",80,0)
 Q
"RTN","PSOTALK",81,0)
TRANS ;If printer mapping defined use it; otherwise print by division 01/19/07
"RTN","PSOTALK",82,0)
 D PCHK:'$D(PSOPMAP)  ;don't recheck for mapped printer if PSOPMAP equal 0 (not defined) or 1 (defined)
"RTN","PSOTALK",83,0)
 I '$D(^PS(59.7,1,47,"B",IOS))&('$G(PSOPMAP)) S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U)
"RTN","PSOTALK",84,0)
 Q:ZTIO="`"
"RTN","PSOTALK",85,0)
 S ZTRTN="GO^PSOTALK",ZTSAVE("*")="",ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Interface Transmission"
"RTN","PSOTALK",86,0)
 D ^%ZTLOAD
"RTN","PSOTALK",87,0)
 Q
"RTN","PSOTALK",88,0)
PCHK ;Check for printers that are mapped to a ScripTalk printer
"RTN","PSOTALK",89,0)
 N PSOLPRT,PSONIOS,PSOLBSEQ
"RTN","PSOTALK",90,0)
 S ZTIO="`",PSOLPRT=$S($D(PSOLAP):PSOLAP,$G(SUSPT):PSLION,$D(ION):ION,1:"") Q:PSOLPRT=""  Q:'$D(^%ZIS(1,"B",PSOLPRT))
"RTN","PSOTALK",91,0)
 S PSONIOS="",PSOPMAP=0,PSONIOS=$O(^%ZIS(1,"B",PSOLPRT,PSONIOS))
"RTN","PSOTALK",92,0)
 I $D(^PS(59.7,1,47,"B",PSONIOS)) D
"RTN","PSOTALK",93,0)
 . S PSOLBSEQ="",PSOLBSEQ=$O(^PS(59.7,1,47,"B",PSONIOS,PSOLBSEQ))
"RTN","PSOTALK",94,0)
 . S ZTIO=ZTIO_$P(^PS(59.7,1,47,PSOLBSEQ,0),"^",2),PSOPMAP=1
"RTN","PSOTALK",95,0)
 Q
"RTN","PSOTALK",96,0)
 ;
"RTN","PSOTALK",97,0)
GO W !,"^XA",!,"^FO250,700^XGE:RX.GRF^FS"  ;;1.2e 4-17-02 TO MOVE GRAPHIC
"RTN","PSOTALK",98,0)
 D OVERLAY,PICOTAG  ;;FOR LARGER LABELS
"RTN","PSOTALK",99,0)
 W !,"^PQ1,0,1,Y",!,"^XZ"  ;;FOR LARGER LABELS
"RTN","PSOTALK",100,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK",101,0)
 Q
"RTN","PSOTALK",102,0)
 ;
"RTN","PSOTALK",103,0)
OVERLAY F PSOLINE=1:1:7 D DEFLINE((9+((20-PSOLINE)*28)),50,LINE(PSOLINE),PSOLINE,0)
"RTN","PSOTALK",104,0)
 F PSOLINE=8:1:10 D DEFLINE((9+((19-PSOLINE)*28)),50,LINE(PSOLINE),PSOLINE,0)
"RTN","PSOTALK",105,0)
 Q
"RTN","PSOTALK",106,0)
 ;
"RTN","PSOTALK",107,0)
DEFLINE(XCORD,YCORD,PRTOUT,FIELDNO,OFFSET) ;
"RTN","PSOTALK",108,0)
 W !,"^AFR,20,10^FO"_XCORD_","_YCORD_"^FR^CI0^FD"_PRTOUT_"^FS"
"RTN","PSOTALK",109,0)
 Q
"RTN","PSOTALK",110,0)
 ;
"RTN","PSOTALK",111,0)
PICOTAG S PSOCTP=1
"RTN","PSOTALK",112,0)
 S DRUG=$E(DRUG,1,39)  ;1.2c*1 TEMPORARY FIX FOR DRUG TRUNCATE AT 39
"RTN","PSOTALK",113,0)
 F XMIT=PTNAME,DRUG,SIGX,DATE,FILLS,WARN,PROV,PHONE,RXNUM,RXALPHA D XMITP
"RTN","PSOTALK",114,0)
 Q
"RTN","PSOTALK",115,0)
 ;
"RTN","PSOTALK",116,0)
XMITP W !,"^RX"_$S(PSOCTP<10:"0",1:"")_PSOCTP_","_XMIT_"^FS"
"RTN","PSOTALK",117,0)
 S PSOCTP=PSOCTP+1
"RTN","PSOTALK",118,0)
 Q
"RTN","PSOTALK",119,0)
ID() I $$PAT55 Q "+SCRIPTALK"
"RTN","PSOTALK",120,0)
 E  Q ""
"RTN","PSOTALK",121,0)
AUTO ;;v1.2c - LABEL REPRINTING FUNCTIONS 3-12-02
"RTN","PSOTALK",122,0)
 Q:$G(PSOTREP)  ;NO AUTO-PRINT DURING REGULAR NON-VOIDED LABEL REPRINT
"RTN","PSOTALK",123,0)
 D PCHK
"RTN","PSOTALK",124,0)
 I $P($G(^PS(59,+PSOSITE,"STALK")),U,2)="A"!($G(PSOPMAP)) D EN
"RTN","PSOTALK",125,0)
 Q
"RTN","PSOTALK",126,0)
 ;
"RTN","PSOTALK",127,0)
PAT55() Q +$G(^PS(55,"ASTALK",$P(^PSRX(RX,0),"^",2)))  ;IS PATIENT ENROLLED (NEW FIELD POSITION 2-12-02 RMS UPDATE v1.2b)
"RTN","PSOTALK",128,0)
PHONE() ;changes below 1.2c*1 to swap to site signed-on vs. site from Rx
"RTN","PSOTALK",129,0)
 Q $E($P(^PS(59,+PSOSITE,0),"^",3),1,3)_$E($TR($P(^PS(59,+PSOSITE,0),"^",4),"-,",""),1,7) ; RX DIVISION PHONE NUMBER
"RTN","PSOTALK",130,0)
CITY() Q $P(^PS(59,+PSOSITE,0),"^",7)
"RTN","PSOTALK",131,0)
STATE() Q $P(^DIC(5,$P(^PS(59,+PSOSITE,0),"^",8),0),"^",2)
"RTN","PSOTALK",132,0)
ZIP() Q $P(^PS(59,+PSOSITE,0),"^",5)
"RTN","PSOTALK",133,0)
SITE() Q $P(^PS(59,+PSOSITE,0),"^",6)
"RTN","PSOTALK",134,0)
ACODE() Q $P(^PS(59,+PSOSITE,0),"^",3)
"RTN","PSOTALK",135,0)
EPHON() Q $P(^PS(59,+PSOSITE,0),"^",4)
"RTN","PSOTALK",136,0)
CLERK() Q $P($G(^PSRX(RX,"OR1")),"^",5)
"RTN","PSOTALK",137,0)
PSOEXP ;
"RTN","PSOTALK",138,0)
 N X1,X2,X S X1=DT,X2=365 D C^%DTC S PSOEXPDT=X
"RTN","PSOTALK",139,0)
 S PSOEXPDT=$E(PSOEXPDT,4,5)_"/"_$E(PSOEXPDT,6,7)_"/"_$E(PSOEXPDT,2,3)
"RTN","PSOTALK",140,0)
 Q
"RTN","PSOTALK",141,0)
VRPH() Q $P($G(^PSRX(RX,2)),"^",10)
"RTN","PSOTALK",142,0)
RXNUM() Q $P(^PSRX(RX,0),"^",1) ;RETURN RX EXTERNAL NUMBER
"RTN","PSOTALK",143,0)
RXALPHA() ;RETURN RENEWAL LETTER OR SPACE CHARACTER
"RTN","PSOTALK",144,0)
 N RXALPHA
"RTN","PSOTALK",145,0)
 S RXALPHA=$E($P(^PSRX(RX,0),"^",1),$L($P(^PSRX(RX,0),"^",1)))
"RTN","PSOTALK",146,0)
 Q $S(RXALPHA?1A:RXALPHA,1:" ")
"RTN","PSOTALK",147,0)
DATE() ;CHANGED 7-30-01 TO USE EDATE FORMAT ALSO WHEN SPEAKING
"RTN","PSOTALK",148,0)
 S EDATE=$P(^PSRX(RX,3),"^")
"RTN","PSOTALK",149,0)
 Q $E(EDATE,4,5)_$E(EDATE,6,7)_$E(EDATE,2,3)
"RTN","PSOTALK",150,0)
EDATE() Q $$FMTE^XLFDT($P(^PSRX(RX,3),"^"))  ; EXTERNAL DATE / LAST DISPENSED
"RTN","PSOTALK",151,0)
FILLS() Q $G(RXF)+1 ; FILL COUNT
"RTN","PSOTALK",152,0)
TFILLS() Q $P(^PSRX(RX,0),"^",9)+1 ; TOTAL FILLS
"RTN","PSOTALK",153,0)
RFILLS() ;NEW REFILLS REMAINING METHOD 9-21-00, BASED ON PTST+5^PSORXVW
"RTN","PSOTALK",154,0)
 S RFILLS=$P(^PSRX(RX,0),"^",9),PSORCT=0 F  S PSORCT=$O(^PSRX(RX,1,PSORCT)) Q:'PSORCT  S RFILLS=RFILLS-1
"RTN","PSOTALK",155,0)
 Q RFILLS
"RTN","PSOTALK",156,0)
FILNO() Q $$TFILLS-$$RFILLS
"RTN","PSOTALK",157,0)
EPAT() Q $P(^DPT($P(^PSRX(RX,0),"^",2),0),"^") ; EXTERNAL PATIENT NAME
"RTN","PSOTALK",158,0)
LAST6() S PSOTSSN=$P(^DPT($P(^PSRX(RX,0),"^",2),0),"^",9)  ; LAST 6 OF SSN
"RTN","PSOTALK",159,0)
 Q $E(PSOTSSN,4,5)_"-"_$E(PSOTSSN,6,9)
"RTN","PSOTALK",160,0)
SIG() ;THIS SUBROUTINE WILL BE ABANDONED IF SIGPOE WORKS v1.2c 3-13-02
"RTN","PSOTALK",161,0)
 I $L($P(^PSRX(RX,"SIG"),"^",1))=0 Q $E($$LSIG^PSOTALK1($P(^PSRX(RX,"SIG1",1,0),"^",1)),1,196)
"RTN","PSOTALK",162,0)
 E  Q $E($$LSIG^PSOTALK1($P(^PSRX(RX,"SIG"),"^",1)),1,196) ; SIG -- NEEDS TO BE EXPANDED
"RTN","PSOTALK",163,0)
SIGPOE() ;v1.2c - NEW SUBROUTINE TO GIVE MESSAGE FOR LONG SIGS FOR THE HUMAN READABLE PORTION
"RTN","PSOTALK",164,0)
 S PSOSIG=""
"RTN","PSOTALK",165,0)
 I $P($G(^PS(55,DFN,"LAN")),"^",1) D  G SIGPOEE
"RTN","PSOTALK",166,0)
 .S PSOSIG=" " ; PUT SPACE ON FRONT OF SIG (GETS STRIPPED OFF LATER)
"RTN","PSOTALK",167,0)
 .D OTHL1^PSOLBL3(RX) I $O(SIG2(0))="" Q
"RTN","PSOTALK",168,0)
 .N XX,X
"RTN","PSOTALK",169,0)
 .;PSO*7*211;MODIFIED TO REPLACE SIG IF >138 INSTEAD OF 196
"RTN","PSOTALK",170,0)
 .S XX=0 F  S XX=$O(SIG2(XX)) Q:'XX  S X=SIG2(XX) I X'="" S PSOSIG=PSOSIG_X_" " I $L(PSOSIG)>138 D  Q
"RTN","PSOTALK",171,0)
 ..S PSOSIG=" INDICACIONES MUY LARGAS. IMPRIMA UNA ETIQUETA DE VISTA VALIDA Y APLIQUELA SOBRE ESTA ETIQUETA DE SCRIPTALK EN LA BOTELLA."
"RTN","PSOTALK",172,0)
 E  D  ;
"RTN","PSOTALK",173,0)
 . N PSOSEQ
"RTN","PSOTALK",174,0)
 . S PSOSTOP=0,PSOSIG=""
"RTN","PSOTALK",175,0)
 . S PSOLSIG=" SIG IS TOO LONG. REPRINT A NON-VOIDED VISTA LABEL AND PLACE OVER THIS SCRIPTALK LABEL"
"RTN","PSOTALK",176,0)
 . S PSOSEQ=0 F  S PSOSEQ=$O(^PSRX(RX,"SIG1",PSOSEQ)) Q:PSOSEQ'=+PSOSEQ!($G(PSOSTOP))  D  ;
"RTN","PSOTALK",177,0)
 .. S PSOSIG1=$G(^PSRX(RX,"SIG1",PSOSEQ,0))
"RTN","PSOTALK",178,0)
 ..;PSO*7*211;MODIFIED TO REPLACE SIG IF >138 INSTEAD OF 196
"RTN","PSOTALK",179,0)
 .. I $L(PSOSIG)+$L($G(^PSRX(RX,"SIG1",PSOSEQ,0)))>138 S PSOSIG=PSOLSIG,PSOSTOP=1 Q  ;
"RTN","PSOTALK",180,0)
 .. S PSOSIG=$G(PSOSIG)_" "_PSOSIG1
"RTN","PSOTALK",181,0)
SIGPOEE Q $E(PSOSIG,2,197)
"RTN","PSOTALK",182,0)
 ;
"RTN","PSOTALK",183,0)
SIGPOEX() ;v1.2c - NEW SUBROUTINE TO GIVE MESSAGE FOR LONG SIGS FOR THE READ ALOUD PORTION
"RTN","PSOTALK",184,0)
 S PSOSIG=""
"RTN","PSOTALK",185,0)
 I $P($G(^PS(55,DFN,"LAN")),"^",1) D  G SIGPOEEX
"RTN","PSOTALK",186,0)
 .S PSOSIG=" " ; PUT SPACE ON FRONT OF SIG (GETS STRIPPED OFF LATER)
"RTN","PSOTALK",187,0)
 .D OTHL1^PSOLBL3(RX) I $O(SIG2(0))="" Q
"RTN","PSOTALK",188,0)
 .N XX,X
"RTN","PSOTALK",189,0)
 .S XX=0 F  S XX=$O(SIG2(XX)) Q:'XX  S X=SIG2(XX) I X'="" S PSOSIG=PSOSIG_X_" " I $L(PSOSIG)>196 D  Q
"RTN","PSOTALK",190,0)
 ..S PSOSIG=" LAS INSTRUCCIONES DE ESTA RECETA SON MUY LARGAS.  POR FAVOR SOLICITE A SU CUIDADOR QUE LE LEA LAS INSTRUCCIONES IMPRESAS EN EL ROTULO O COMUNIQUESE CON SU MEDICO PARA INSTRUCCIONES COMPLETAS."
"RTN","PSOTALK",191,0)
 I $L($P(^PSRX(RX,"SIG"),"^",1))'=0 Q $E($$LSIG^PSOTALK1($P(^PSRX(RX,"SIG"),"^",1)),1,196)
"RTN","PSOTALK",192,0)
 E  D  ;
"RTN","PSOTALK",193,0)
 . N PSOSEQ
"RTN","PSOTALK",194,0)
 . S PSOSTOP=0,PSOSIG=""
"RTN","PSOTALK",195,0)
 . S PSOLSIG=" THE INSTRUCTIONS FOR THIS PRESCRIPTION ARE TOO LONG. PLEASE HAVE A CAREGIVER READ THE PRINTED LABEL OR CONTACT YOUR PHYSICIAN FOR COMPLETE INSTRUCTIONS."
"RTN","PSOTALK",196,0)
 . S PSOSEQ=0 F  S PSOSEQ=$O(^PSRX(RX,"SIG1",PSOSEQ)) Q:PSOSEQ'=+PSOSEQ!($G(PSOSTOP))  D  ;
"RTN","PSOTALK",197,0)
 .. S PSOSIG1=$G(^PSRX(RX,"SIG1",PSOSEQ,0))
"RTN","PSOTALK",198,0)
 .. I $L(PSOSIG)+$L($G(^PSRX(RX,"SIG1",PSOSEQ,0)))>196 S PSOSIG=PSOLSIG,PSOSTOP=1 Q  ;
"RTN","PSOTALK",199,0)
 .. S PSOSIG=$G(PSOSIG)_" "_PSOSIG1
"RTN","PSOTALK",200,0)
SIGPOEEX Q $E(PSOSIG,2,197)
"RTN","PSOTALK",201,0)
PROV() ;PROVIDER NAME
"RTN","PSOTALK",202,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_+$P(^PSRX(RX,0),"^",4) D ^DIC S PSOPHYS=$S(+Y:$P(Y,"^",2),1:"UNKNOWN") K DIC,X,Y
"RTN","PSOTALK",203,0)
 Q $P($$NAMEFMT^XLFNAME(PSOPHYS)," MD")
"RTN","PSOTALK",204,0)
EPROV() ;
"RTN","PSOTALK",205,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_+$P(^PSRX(RX,0),"^",4) D ^DIC S PSOPHYS=$S(+Y:$P(Y,"^",2),1:"UNKNOWN") K DIC,X,Y
"RTN","PSOTALK",206,0)
 Q PSOPHYS
"RTN","PSOTALK",207,0)
QTY() Q $S($G(RXP):$P(RXP,"^",4),1:$P(^PSRX(RX,0),"^",7))
"RTN","PSOTALK",208,0)
DF() Q $P($G(^PSDRUG($P(^PSRX(RX,0),"^",6),660)),"^",8)
"RTN","PSOTALK",209,0)
DRUG() Q $P(^PSDRUG($P(^PSRX(RX,0),"^",6),0),"^",1) ; DRUG NAME
"RTN","PSOTALK",210,0)
WARN() N WARN,NWARN,IWARN,XWARN ; 1-28-02 UPDATE v1.2a TO ELIMINATE LOCAL CODES
"RTN","PSOTALK",211,0)
 S WARN=$P(^PSDRUG($P(^PSRX(RX,0),"^",6),0),"^",8) ; WARNING LABEL CODES
"RTN","PSOTALK",212,0)
 F NWARN=1:1:3 S IWARN=$P(WARN,",",NWARN) S:IWARN>20 IWARN="" S:$L(IWARN)=1 IWARN="0"_IWARN S:$L(IWARN)=0 IWARN="00" S XWARN=$G(XWARN)_IWARN
"RTN","PSOTALK",213,0)
 Q XWARN
"RTN","PSOTALK3")
0^15^B20856163^B14117081
"RTN","PSOTALK3",1,0)
PSOTALK3 ;BIR/EJW - SCRIPTALK UTILITIES ;02 Oct 2003  7:31 AM
"RTN","PSOTALK3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**135,200**;DEC 1997;Build 7
"RTN","PSOTALK3",3,0)
 ;External reference to ^PS(59.7 controlled subscription by DBIA 694
"RTN","PSOTALK3",4,0)
TTRANS ;RE-INITIALIZE SCRIPTALK PRINTER
"RTN","PSOTALK3",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOTALK3",6,0)
 S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U)
"RTN","PSOTALK3",7,0)
 I ZTIO="`" W !,"No ScripTalk printer defined for division." Q
"RTN","PSOTALK3",8,0)
 S ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Printer Re-initialize"
"RTN","PSOTALK3",9,0)
 S ZTRTN="TINIT^PSOTALK3",ZTSAVE("*")=""
"RTN","PSOTALK3",10,0)
 D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOTALK3",11,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOTALK3",12,0)
 Q
"RTN","PSOTALK3",13,0)
 ;
"RTN","PSOTALK3",14,0)
TINIT ;
"RTN","PSOTALK3",15,0)
 W !,"^XA ^MD30 ^XZ"
"RTN","PSOTALK3",16,0)
 W !,"^XA ^MD30 ^XZ"
"RTN","PSOTALK3",17,0)
 W !,"^XA ~SD30 ^XZ"
"RTN","PSOTALK3",18,0)
 W !,"^XA ^MFF,F ^XZ"
"RTN","PSOTALK3",19,0)
 W !,"^XA ^LT20 ^XZ"
"RTN","PSOTALK3",20,0)
 W !,"^XA ^MTT ^XZ"
"RTN","PSOTALK3",21,0)
 W !,"^XA ^JUS ^XZ"
"RTN","PSOTALK3",22,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK3",23,0)
 Q
"RTN","PSOTALK3",24,0)
 ;
"RTN","PSOTALK3",25,0)
TEST ;
"RTN","PSOTALK3",26,0)
 I $G(PSOTEST)?."?" R !,"Enter a Zebra Print Language test command to be sent",!,"to the ScripTalk printer: ",PSOTEST:DTIME
"RTN","PSOTALK3",27,0)
 I $G(PSOTEST)="" Q
"RTN","PSOTALK3",28,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOTALK3",29,0)
 S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U),ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Interface Test"
"RTN","PSOTALK3",30,0)
 I ZTIO="`" W !,"No ScripTalk printer defined for division." Q
"RTN","PSOTALK3",31,0)
 S ZTRTN="TPUT^PSOTALK3",ZTSAVE("*")=""
"RTN","PSOTALK3",32,0)
 D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOTALK3",33,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOTALK3",34,0)
 K PSOTEST
"RTN","PSOTALK3",35,0)
 Q
"RTN","PSOTALK3",36,0)
TPUT ;SET VARIABLE 'PSOTEST' TO OUTPUT STRING
"RTN","PSOTALK3",37,0)
 W !,PSOTEST
"RTN","PSOTALK3",38,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK3",39,0)
 Q
"RTN","PSOTALK3",40,0)
 ;
"RTN","PSOTALK3",41,0)
TESTLAB ;
"RTN","PSOTALK3",42,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOTALK3",43,0)
 S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U),ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Sample Label"
"RTN","PSOTALK3",44,0)
 I ZTIO="`" W !,"No ScripTalk printer defined for division." Q
"RTN","PSOTALK3",45,0)
 S ZTRTN="TLABEL^PSOTALK3",ZTSAVE("*")=""
"RTN","PSOTALK3",46,0)
 W !,"The following test data will be sent to the ScripTalk printer:",! D TLABEL W !
"RTN","PSOTALK3",47,0)
 D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOTALK3",48,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOTALK3",49,0)
 Q
"RTN","PSOTALK3",50,0)
TLABEL ;
"RTN","PSOTALK3",51,0)
 W !,"^XA"
"RTN","PSOTALK3",52,0)
 W !,"^FO250,700^XGE:RX.GRF^FS"
"RTN","PSOTALK3",53,0)
 W !,"^FO250,700^XGE:RX.GRF^FS"
"RTN","PSOTALK3",54,0)
 W !,"^AFR,20,10^FO531,50^FR^CI0^FD7305 N. MILITARY TRL  Exp: January 01,2002^FS"
"RTN","PSOTALK3",55,0)
 W !,"^AFR,20,10^FO503,50^FR^CI0^FDRX#82382787 January 01,2001  Fill 01 OF 01^FS"
"RTN","PSOTALK3",56,0)
 W !,"^AFR,20,10^FO475,50^FR^CI0^FDJOE VETERAN^FS"
"RTN","PSOTALK3",57,0)
 W !,"^AFR,20,10^FO447,50^FR^CI0^FDTAKE 1 CAPSULE THREE TIMES DAILY^FS"
"RTN","PSOTALK3",58,0)
 W !,"^AFR,20,10^FO419,50^FR^CI0^FD^FS"
"RTN","PSOTALK3",59,0)
 W !,"^AFR,20,10^FO391,50^FR^CI0^FD^FS"
"RTN","PSOTALK3",60,0)
 W !,"^AFR,20,10^FO363,50^FR^CI0^FD^FS"
"RTN","PSOTALK3",61,0)
 W !,"^AFR,20,10^FO335,50^FR^CI0^FDDr. BEN CASEY MD^FS"
"RTN","PSOTALK3",62,0)
 W !,"^AFR,20,10^FO279,50^FR^CI0^FDQTY: 24 TABS^FS"
"RTN","PSOTALK3",63,0)
 W !,"^AFR,20,10^FO251,50^FR^CI0^FDAMOXICILLIN 500MG CAP^FS"
"RTN","PSOTALK3",64,0)
 W !,"^RX01,JOE VETERAN^FS"
"RTN","PSOTALK3",65,0)
 W !,"^RX02,AMOXICILLIN 500MG CAP^FS"
"RTN","PSOTALK3",66,0)
 W !,"^RX03,TAKE 1 CAPSULE THREE TIMES DAILY ^FS"
"RTN","PSOTALK3",67,0)
 W !,"^RX04,010101^FS"
"RTN","PSOTALK3",68,0)
 W !,"^RX05,00^FS"
"RTN","PSOTALK3",69,0)
 W !,"^RX06,020000^FS"
"RTN","PSOTALK3",70,0)
 W !,"^RX07,BEN CASEY^FS"
"RTN","PSOTALK3",71,0)
 W !,"^RX08,2928993888^FS"
"RTN","PSOTALK3",72,0)
 W !,"^RX09,82382787^FS"
"RTN","PSOTALK3",73,0)
 W !,"^RX10, ^FS"
"RTN","PSOTALK3",74,0)
 W !,"^PQ1,0,1,Y"
"RTN","PSOTALK3",75,0)
 W !,"^XZ"
"RTN","PSOTALK3",76,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK3",77,0)
 Q
"RTN","PSOTALK3",78,0)
 ;
"RTN","PSOTALK3",79,0)
STDEV ;Define ScripTalk printer for a Division or map another print device to the ScripTalk Printer
"RTN","PSOTALK3",80,0)
 N PSOSITE,PSOTYPE
"RTN","PSOTALK3",81,0)
STDEV1 ;
"RTN","PSOTALK3",82,0)
 W !!!
"RTN","PSOTALK3",83,0)
 K DIC,DIR,DIE,DA,DR
"RTN","PSOTALK3",84,0)
 S DIR(0)="SBO^D:Division;P:Printer",DIR("A")="Define ScripTalk Printer by (D)ivision or (P)rinter mapping?"
"RTN","PSOTALK3",85,0)
 S DIR("?")=" "
"RTN","PSOTALK3",86,0)
 S DIR("?",1)="Enter D to define ScripTalk printer by Division or enter P to tie a ScripTalk"
"RTN","PSOTALK3",87,0)
 S DIR("?",2)="printer to regular Pharmacy label printer(s) to control where the ScripTalk"
"RTN","PSOTALK3",88,0)
 S DIR("?",3)="labels print for multi-divisions."
"RTN","PSOTALK3",89,0)
 S PSOSITE=""
"RTN","PSOTALK3",90,0)
 D ^DIR G:$D(DIRUT)!(Y<0) STDEVQ S PSOTYPE=Y
"RTN","PSOTALK3",91,0)
 D STDEVM:PSOTYPE="P"
"RTN","PSOTALK3",92,0)
 D STDEVD:PSOTYPE="D"
"RTN","PSOTALK3",93,0)
 G STDEV1
"RTN","PSOTALK3",94,0)
STDEVQ ;
"RTN","PSOTALK3",95,0)
 K DIC,DIR,DIE,DA,DR,DIRUT,Y
"RTN","PSOTALK3",96,0)
 Q
"RTN","PSOTALK3",97,0)
 ;
"RTN","PSOTALK3",98,0)
STDEVD ;Define ScripTalk device by division
"RTN","PSOTALK3",99,0)
 W ! S DIC("A")="Division: ",DIC=59,DIC(0)="AEMQ"
"RTN","PSOTALK3",100,0)
 S:$G(PSOVEX)'=1 DIC("S")="I $S('$D(^PS(59,+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0)"
"RTN","PSOTALK3",101,0)
 D ^DIC K DIC Q:$D(DIRUT)!(Y<0)
"RTN","PSOTALK3",102,0)
 Q:+Y<0
"RTN","PSOTALK3",103,0)
 S PSOSITE=+Y
"RTN","PSOTALK3",104,0)
 S DIE="^PS(59,",DA=PSOSITE,DR="107;107.1" D ^DIE
"RTN","PSOTALK3",105,0)
 Q
"RTN","PSOTALK3",106,0)
 ;
"RTN","PSOTALK3",107,0)
STDEVM ;Map a printer to a ScripTalk printer
"RTN","PSOTALK3",108,0)
 S DIE="^PS(59.7,",DA=1,DR="47" L +^PS(59.7,1,47):0 D  I $T D ^DIE L -^PS(59.7,1,47)
"RTN","PSOTALK3",109,0)
 . I '$T W !?5,"Another user is editing this entry."
"RTN","PSOTALK3",110,0)
 Q
"RTN","PSOTALK3",111,0)
 ;
"VER")
8.0^22.0
"^DD",52,52,38.3,0)
FINISH DATE/TIME^D^^OR1;8^S %DT="ESTXR" D ^%DT S X=Y K:X<1 X
"^DD",52,52,38.3,1,0)
^.1
"^DD",52,52,38.3,1,1,0)
52^AFDT
"^DD",52,52,38.3,1,1,1)
S ^PSRX("AFDT",$E(X,1,30),DA)=""
"^DD",52,52,38.3,1,1,2)
K ^PSRX("AFDT",$E(X,1,30),DA)
"^DD",52,52,38.3,1,1,"DT")
3070205
"^DD",52,52,38.3,3)
(No range limit on date)
"^DD",52,52,38.3,21,0)
^^1^1^3070205^
"^DD",52,52,38.3,21,1,0)
Date/time prescription is finished.
"^DD",52,52,38.3,23,0)
^^1^1^3070205^
"^DD",52,52,38.3,23,1,0)
Date/time prescription is finished.
"^DD",52,52,38.3,"DT")
3070205
"BLD",6229,6)
^231
**END**
**END**
