KIDS Distribution saved on Jun 22, 2005@14:17:32
PSU 4.0 - 06/22/2005
**KIDS**:PSU 4.0^PSO*7.0*165^

**INSTALL NAME**
PSU 4.0
"BLD",4899,0)
PSU 4.0^PHARMACY BENEFITS MANAGEMENT^0^3050622^y
"BLD",4899,1,0)
^^12^12^3050620^^^^
"BLD",4899,1,1,0)
The PBM V. 4.0 application contains enhancements to support the VA 
"BLD",4899,1,2,0)
National Formulary (VANF), disease management issues and patient safety 
"BLD",4899,1,3,0)
initiatives. 
"BLD",4899,1,4,0)
 
"BLD",4899,1,5,0)
Two new extracts have been created to gather patient vital/immunization 
"BLD",4899,1,6,0)
and allergy/adverse reaction data.  Modifications have also been 
"BLD",4899,1,7,0)
made to existing Prescription, Unit Dose, Intravenous (IV),
"BLD",4899,1,8,0)
Controlled Substance (CS), Automatic Replenishment/Ward Stock (AR/WS),
"BLD",4899,1,9,0)
Procurement, Patient Demographic, Outpatient Visits, Laboratory 
"BLD",4899,1,10,0)
extracts, and existing PBM options.  New summary reports have been 
"BLD",4899,1,11,0)
created for Automated Management Information System (AMIS) reporting.  New
"BLD",4899,1,12,0)
options have also been created to support the added functionality.
"BLD",4899,4,0)
^9.64PA^59.7^2
"BLD",4899,4,59.7,0)
59.7
"BLD",4899,4,59.7,2,0)
^9.641^59.79003^3
"BLD",4899,4,59.7,2,59.79001,0)
PBM AR/WS AOU MAPPINGS  (sub-file)
"BLD",4899,4,59.7,2,59.79001,1,0)
^9.6411^^
"BLD",4899,4,59.7,2,59.79002,0)
PBM CS NAOU MAPPINGS  (sub-file)
"BLD",4899,4,59.7,2,59.79002,1,0)
^9.6411^^
"BLD",4899,4,59.7,2,59.79003,0)
PBM DA PHARM LOC MAPPINGS  (sub-file)
"BLD",4899,4,59.7,2,59.79003,1,0)
^9.6411^^
"BLD",4899,4,59.7,222)
y^y^p^^^^n^^n
"BLD",4899,4,59.7,224)

"BLD",4899,4,59.9,0)
59.9
"BLD",4899,4,59.9,222)
y^y^f^^^^n
"BLD",4899,4,"APDD",59.7,59.79001)

"BLD",4899,4,"APDD",59.7,59.79002)

"BLD",4899,4,"APDD",59.7,59.79003)

"BLD",4899,4,"B",59.7,59.7)

"BLD",4899,4,"B",59.9,59.9)

"BLD",4899,"ABPKG")
n
"BLD",4899,"INIT")

"BLD",4899,"KRN",0)
^9.67PA^8989.52^19
"BLD",4899,"KRN",.4,0)
.4
"BLD",4899,"KRN",.4,"NM",0)
^9.68A^^
"BLD",4899,"KRN",.401,0)
.401
"BLD",4899,"KRN",.402,0)
.402
"BLD",4899,"KRN",.403,0)
.403
"BLD",4899,"KRN",.5,0)
.5
"BLD",4899,"KRN",.84,0)
.84
"BLD",4899,"KRN",3.6,0)
3.6
"BLD",4899,"KRN",3.8,0)
3.8
"BLD",4899,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",4899,"KRN",3.8,"NM",1,0)
PSU PBM^^0
"BLD",4899,"KRN",3.8,"NM","B","PSU PBM",1)

"BLD",4899,"KRN",9.2,0)
9.2
"BLD",4899,"KRN",9.8,0)
9.8
"BLD",4899,"KRN",9.8,"NM",0)
^9.68A^126^103
"BLD",4899,"KRN",9.8,"NM",1,0)
PSUAA1^^0^B16326851
"BLD",4899,"KRN",9.8,"NM",2,0)
PSUAA2^^0^B3886541
"BLD",4899,"KRN",9.8,"NM",4,0)
PSUAMC^^0^B3549679
"BLD",4899,"KRN",9.8,"NM",5,0)
PSUAR0^^0^B4372651
"BLD",4899,"KRN",9.8,"NM",6,0)
PSUAR1^^0^B32275020
"BLD",4899,"KRN",9.8,"NM",7,0)
PSUAR2^^0^B11620969
"BLD",4899,"KRN",9.8,"NM",8,0)
PSUAR3^^0^B9346593
"BLD",4899,"KRN",9.8,"NM",9,0)
PSUAR4^^0^B13068784
"BLD",4899,"KRN",9.8,"NM",10,0)
PSUAR5^^0^B5075475
"BLD",4899,"KRN",9.8,"NM",11,0)
PSUAR6^^0^B100733277
"BLD",4899,"KRN",9.8,"NM",12,0)
PSUAR7^^0^B68473935
"BLD",4899,"KRN",9.8,"NM",13,0)
PSUCP^^0^B89043924
"BLD",4899,"KRN",9.8,"NM",14,0)
PSUCP1^^0^B86988288
"BLD",4899,"KRN",9.8,"NM",15,0)
PSUCP2^^0^B21874165
"BLD",4899,"KRN",9.8,"NM",16,0)
PSUCP3^^0^B410303
"BLD",4899,"KRN",9.8,"NM",17,0)
PSUCS0^^0^B1492272
"BLD",4899,"KRN",9.8,"NM",18,0)
PSUCS1^^0^B6704460
"BLD",4899,"KRN",9.8,"NM",19,0)
PSUCS17^^0^B3906297
"BLD",4899,"KRN",9.8,"NM",20,0)
PSUCS2^^0^B7003780
"BLD",4899,"KRN",9.8,"NM",21,0)
PSUCS3^^0^B7927852
"BLD",4899,"KRN",9.8,"NM",22,0)
PSUCS4^^0^B9091422
"BLD",4899,"KRN",9.8,"NM",23,0)
PSUCS5^^0^B5037710
"BLD",4899,"KRN",9.8,"NM",24,0)
PSUCSR0^^0^B16382128
"BLD",4899,"KRN",9.8,"NM",25,0)
PSUCSR1^^0^B33680851
"BLD",4899,"KRN",9.8,"NM",26,0)
PSUCSR2^^0^B28406983
"BLD",4899,"KRN",9.8,"NM",27,0)
PSUDBQUE^^0^B33491236
"BLD",4899,"KRN",9.8,"NM",28,0)
PSUDEM0^^0^B23741860
"BLD",4899,"KRN",9.8,"NM",29,0)
PSUDEM1^^0^B42786369
"BLD",4899,"KRN",9.8,"NM",30,0)
PSUDEM2^^0^B20153453
"BLD",4899,"KRN",9.8,"NM",32,0)
PSUDEM3^^0^B4556781
"BLD",4899,"KRN",9.8,"NM",33,0)
PSUDEM4^^0^B51977123
"BLD",4899,"KRN",9.8,"NM",34,0)
PSUDEM5^^0^B27210554
"BLD",4899,"KRN",9.8,"NM",35,0)
PSUDEM6^^0^B2342326
"BLD",4899,"KRN",9.8,"NM",36,0)
PSUDEM7^^0^B14211015
"BLD",4899,"KRN",9.8,"NM",37,0)
PSUDEM8^^0^B17454400
"BLD",4899,"KRN",9.8,"NM",38,0)
PSUDEM9^^0^B7601492
"BLD",4899,"KRN",9.8,"NM",39,0)
PSUENV^^0^B5797694
"BLD",4899,"KRN",9.8,"NM",40,0)
PSUHL^^0^B6908275
"BLD",4899,"KRN",9.8,"NM",54,0)
PSULR0^^0^B9269261
"BLD",4899,"KRN",9.8,"NM",55,0)
PSULR1^^0^B4534693
"BLD",4899,"KRN",9.8,"NM",56,0)
PSULR2^^0^B5463694
"BLD",4899,"KRN",9.8,"NM",57,0)
PSULR3^^0^B5904843
"BLD",4899,"KRN",9.8,"NM",58,0)
PSULR4^^0^B11285075
"BLD",4899,"KRN",9.8,"NM",59,0)
PSULR5^^0^B25893998
"BLD",4899,"KRN",9.8,"NM",60,0)
PSULR6^^0^B2906488
"BLD",4899,"KRN",9.8,"NM",63,0)
PSUMAP0^^0^B34947359
"BLD",4899,"KRN",9.8,"NM",64,0)
PSUMAPR^^0^B39514670
"BLD",4899,"KRN",9.8,"NM",66,0)
PSUOP0^^0^B6459337
"BLD",4899,"KRN",9.8,"NM",67,0)
PSUOP1^^0^B18820371
"BLD",4899,"KRN",9.8,"NM",68,0)
PSUOP2^^0^B42214911
"BLD",4899,"KRN",9.8,"NM",69,0)
PSUOP3^^0^B76484061
"BLD",4899,"KRN",9.8,"NM",70,0)
PSUOP4^^0^B18575142
"BLD",4899,"KRN",9.8,"NM",71,0)
PSUOP5^^0^B30961537
"BLD",4899,"KRN",9.8,"NM",72,0)
PSUOP6^^0^B17769512
"BLD",4899,"KRN",9.8,"NM",73,0)
PSUOP7^^0^B17289883
"BLD",4899,"KRN",9.8,"NM",74,0)
PSUOP8^^0^B94498709
"BLD",4899,"KRN",9.8,"NM",75,0)
PSUOPAM^^0^B8835160
"BLD",4899,"KRN",9.8,"NM",76,0)
PSUOPMD^^0^B35176456
"BLD",4899,"KRN",9.8,"NM",77,0)
PSUPR0^^0^B12872882
"BLD",4899,"KRN",9.8,"NM",78,0)
PSUPR1^^0^B16749174
"BLD",4899,"KRN",9.8,"NM",79,0)
PSUPR2^^0^B61724094
"BLD",4899,"KRN",9.8,"NM",80,0)
PSUPR3^^0^B12518601
"BLD",4899,"KRN",9.8,"NM",81,0)
PSUPR4^^0^B9638068
"BLD",4899,"KRN",9.8,"NM",82,0)
PSUPR5^^0^B27289546
"BLD",4899,"KRN",9.8,"NM",83,0)
PSUPR6^^0^B3096100
"BLD",4899,"KRN",9.8,"NM",86,0)
PSURT1^^0^B23572846
"BLD",4899,"KRN",9.8,"NM",87,0)
PSURT2^^0^B8605956
"BLD",4899,"KRN",9.8,"NM",88,0)
PSURTQ^^0^B394637
"BLD",4899,"KRN",9.8,"NM",89,0)
PSUSUM1^^0^B18204899
"BLD",4899,"KRN",9.8,"NM",90,0)
PSUSUM2^^0^B50864698
"BLD",4899,"KRN",9.8,"NM",91,0)
PSUSUM3^^0^B53686214
"BLD",4899,"KRN",9.8,"NM",92,0)
PSUSUM4^^0^B62321362
"BLD",4899,"KRN",9.8,"NM",93,0)
PSUSUM5^^0^B34135480
"BLD",4899,"KRN",9.8,"NM",94,0)
PSUSUM6^^0^B79961216
"BLD",4899,"KRN",9.8,"NM",95,0)
PSUSUM7^^0^B60953912
"BLD",4899,"KRN",9.8,"NM",96,0)
PSUTL^^0^B20235539
"BLD",4899,"KRN",9.8,"NM",98,0)
PSUTL1^^0^B3357438
"BLD",4899,"KRN",9.8,"NM",99,0)
PSUUD0^^0^B3192501
"BLD",4899,"KRN",9.8,"NM",100,0)
PSUUD1^^0^B18098577
"BLD",4899,"KRN",9.8,"NM",101,0)
PSUUD2^^0^B20903599
"BLD",4899,"KRN",9.8,"NM",102,0)
PSUUD3^^0^B14814763
"BLD",4899,"KRN",9.8,"NM",103,0)
PSUUD4^^0^B6212281
"BLD",4899,"KRN",9.8,"NM",104,0)
PSUUD5^^0^B14277220
"BLD",4899,"KRN",9.8,"NM",105,0)
PSUUD6^^0^B44396334
"BLD",4899,"KRN",9.8,"NM",106,0)
PSUUD7^^0^B23116886
"BLD",4899,"KRN",9.8,"NM",108,0)
PSUVIT^^0^B2205
"BLD",4899,"KRN",9.8,"NM",109,0)
PSUVIT0^^0^B4647
"BLD",4899,"KRN",9.8,"NM",110,0)
PSUVIT1^^0^B50144002
"BLD",4899,"KRN",9.8,"NM",111,0)
PSUVIT2^^0^B3903887
"BLD",4899,"KRN",9.8,"NM",113,0)
PSUALERT^^0^B3059763
"BLD",4899,"KRN",9.8,"NM",114,0)
PSUV0^^0^B3912066
"BLD",4899,"KRN",9.8,"NM",115,0)
PSUV1^^0^B78186878
"BLD",4899,"KRN",9.8,"NM",116,0)
PSUV2^^0^B59687439
"BLD",4899,"KRN",9.8,"NM",117,0)
PSUV3^^0^B9610138
"BLD",4899,"KRN",9.8,"NM",118,0)
PSUV4^^0^B16755702
"BLD",4899,"KRN",9.8,"NM",119,0)
PSUV5^^0^B12199979
"BLD",4899,"KRN",9.8,"NM",120,0)
PSUV6^^0^B32261873
"BLD",4899,"KRN",9.8,"NM",121,0)
PSUV7^^0^B32354720
"BLD",4899,"KRN",9.8,"NM",122,0)
PSUV8^^0^B32732574
"BLD",4899,"KRN",9.8,"NM",123,0)
PSUV9^^0^B33134679
"BLD",4899,"KRN",9.8,"NM",124,0)
PSUV10^^0^B32981791
"BLD",4899,"KRN",9.8,"NM",125,0)
PSUV11^^0^B3575024
"BLD",4899,"KRN",9.8,"NM",126,0)
PSUV12^^0^B80238409
"BLD",4899,"KRN",9.8,"NM","B","PSUAA1",1)

"BLD",4899,"KRN",9.8,"NM","B","PSUAA2",2)

"BLD",4899,"KRN",9.8,"NM","B","PSUALERT",113)

"BLD",4899,"KRN",9.8,"NM","B","PSUAMC",4)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR0",5)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR1",6)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR2",7)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR3",8)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR4",9)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR5",10)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR6",11)

"BLD",4899,"KRN",9.8,"NM","B","PSUAR7",12)

"BLD",4899,"KRN",9.8,"NM","B","PSUCP",13)

"BLD",4899,"KRN",9.8,"NM","B","PSUCP1",14)

"BLD",4899,"KRN",9.8,"NM","B","PSUCP2",15)

"BLD",4899,"KRN",9.8,"NM","B","PSUCP3",16)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS0",17)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS1",18)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS17",19)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS2",20)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS3",21)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS4",22)

"BLD",4899,"KRN",9.8,"NM","B","PSUCS5",23)

"BLD",4899,"KRN",9.8,"NM","B","PSUCSR0",24)

"BLD",4899,"KRN",9.8,"NM","B","PSUCSR1",25)

"BLD",4899,"KRN",9.8,"NM","B","PSUCSR2",26)

"BLD",4899,"KRN",9.8,"NM","B","PSUDBQUE",27)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM0",28)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM1",29)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM2",30)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM3",32)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM4",33)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM5",34)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM6",35)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM7",36)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM8",37)

"BLD",4899,"KRN",9.8,"NM","B","PSUDEM9",38)

"BLD",4899,"KRN",9.8,"NM","B","PSUENV",39)

"BLD",4899,"KRN",9.8,"NM","B","PSUHL",40)

"BLD",4899,"KRN",9.8,"NM","B","PSULR0",54)

"BLD",4899,"KRN",9.8,"NM","B","PSULR1",55)

"BLD",4899,"KRN",9.8,"NM","B","PSULR2",56)

"BLD",4899,"KRN",9.8,"NM","B","PSULR3",57)

"BLD",4899,"KRN",9.8,"NM","B","PSULR4",58)

"BLD",4899,"KRN",9.8,"NM","B","PSULR5",59)

"BLD",4899,"KRN",9.8,"NM","B","PSULR6",60)

"BLD",4899,"KRN",9.8,"NM","B","PSUMAP0",63)

"BLD",4899,"KRN",9.8,"NM","B","PSUMAPR",64)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP0",66)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP1",67)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP2",68)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP3",69)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP4",70)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP5",71)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP6",72)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP7",73)

"BLD",4899,"KRN",9.8,"NM","B","PSUOP8",74)

"BLD",4899,"KRN",9.8,"NM","B","PSUOPAM",75)

"BLD",4899,"KRN",9.8,"NM","B","PSUOPMD",76)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR0",77)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR1",78)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR2",79)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR3",80)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR4",81)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR5",82)

"BLD",4899,"KRN",9.8,"NM","B","PSUPR6",83)

"BLD",4899,"KRN",9.8,"NM","B","PSURT1",86)

"BLD",4899,"KRN",9.8,"NM","B","PSURT2",87)

"BLD",4899,"KRN",9.8,"NM","B","PSURTQ",88)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM1",89)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM2",90)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM3",91)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM4",92)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM5",93)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM6",94)

"BLD",4899,"KRN",9.8,"NM","B","PSUSUM7",95)

"BLD",4899,"KRN",9.8,"NM","B","PSUTL",96)

"BLD",4899,"KRN",9.8,"NM","B","PSUTL1",98)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD0",99)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD1",100)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD2",101)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD3",102)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD4",103)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD5",104)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD6",105)

"BLD",4899,"KRN",9.8,"NM","B","PSUUD7",106)

"BLD",4899,"KRN",9.8,"NM","B","PSUV0",114)

"BLD",4899,"KRN",9.8,"NM","B","PSUV1",115)

"BLD",4899,"KRN",9.8,"NM","B","PSUV10",124)

"BLD",4899,"KRN",9.8,"NM","B","PSUV11",125)

"BLD",4899,"KRN",9.8,"NM","B","PSUV12",126)

"BLD",4899,"KRN",9.8,"NM","B","PSUV2",116)

"BLD",4899,"KRN",9.8,"NM","B","PSUV3",117)

"BLD",4899,"KRN",9.8,"NM","B","PSUV4",118)

"BLD",4899,"KRN",9.8,"NM","B","PSUV5",119)

"BLD",4899,"KRN",9.8,"NM","B","PSUV6",120)

"BLD",4899,"KRN",9.8,"NM","B","PSUV7",121)

"BLD",4899,"KRN",9.8,"NM","B","PSUV8",122)

"BLD",4899,"KRN",9.8,"NM","B","PSUV9",123)

"BLD",4899,"KRN",9.8,"NM","B","PSUVIT",108)

"BLD",4899,"KRN",9.8,"NM","B","PSUVIT0",109)

"BLD",4899,"KRN",9.8,"NM","B","PSUVIT1",110)

"BLD",4899,"KRN",9.8,"NM","B","PSUVIT2",111)

"BLD",4899,"KRN",19,0)
19
"BLD",4899,"KRN",19,"NM",0)
^9.68A^6^6
"BLD",4899,"KRN",19,"NM",1,0)
PSU MAP PHARMACY LOCATIONS^^0
"BLD",4899,"KRN",19,"NM",2,0)
PSU PBM AUTO^^0
"BLD",4899,"KRN",19,"NM",3,0)
PSU PBM JOB CHECK^^0
"BLD",4899,"KRN",19,"NM",4,0)
PSU PBM MANAGER MENU^^0
"BLD",4899,"KRN",19,"NM",5,0)
PSU PBM MANUAL^^0
"BLD",4899,"KRN",19,"NM",6,0)
PSU RETRANSMIT PATIENT DATA^^0
"BLD",4899,"KRN",19,"NM","B","PSU MAP PHARMACY LOCATIONS",1)

"BLD",4899,"KRN",19,"NM","B","PSU PBM AUTO",2)

"BLD",4899,"KRN",19,"NM","B","PSU PBM JOB CHECK",3)

"BLD",4899,"KRN",19,"NM","B","PSU PBM MANAGER MENU",4)

"BLD",4899,"KRN",19,"NM","B","PSU PBM MANUAL",5)

"BLD",4899,"KRN",19,"NM","B","PSU RETRANSMIT PATIENT DATA",6)

"BLD",4899,"KRN",19.1,0)
19.1
"BLD",4899,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",4899,"KRN",101,0)
101
"BLD",4899,"KRN",101,"NM",0)
^9.68A^8^2
"BLD",4899,"KRN",101,"NM",3,0)
PSU PATIENT DEMOGRAPHIC CHANGE^^0^
"BLD",4899,"KRN",101,"NM",8,0)
DG FIELD MONITOR^^2
"BLD",4899,"KRN",101,"NM","B","DG FIELD MONITOR",8)

"BLD",4899,"KRN",101,"NM","B","PSU PATIENT DEMOGRAPHIC CHANGE",3)

"BLD",4899,"KRN",409.61,0)
409.61
"BLD",4899,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",4899,"KRN",771,0)
771
"BLD",4899,"KRN",771,"NM",0)
^9.68A^^0
"BLD",4899,"KRN",870,0)
870
"BLD",4899,"KRN",870,"NM",0)
^9.68A^^0
"BLD",4899,"KRN",8989.51,0)
8989.51
"BLD",4899,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",4899,"KRN",8989.52,0)
8989.52
"BLD",4899,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",4899,"KRN",8994,0)
8994
"BLD",4899,"KRN","B",.4,.4)

"BLD",4899,"KRN","B",.401,.401)

"BLD",4899,"KRN","B",.402,.402)

"BLD",4899,"KRN","B",.403,.403)

"BLD",4899,"KRN","B",.5,.5)

"BLD",4899,"KRN","B",.84,.84)

"BLD",4899,"KRN","B",3.6,3.6)

"BLD",4899,"KRN","B",3.8,3.8)

"BLD",4899,"KRN","B",9.2,9.2)

"BLD",4899,"KRN","B",9.8,9.8)

"BLD",4899,"KRN","B",19,19)

"BLD",4899,"KRN","B",19.1,19.1)

"BLD",4899,"KRN","B",101,101)

"BLD",4899,"KRN","B",409.61,409.61)

"BLD",4899,"KRN","B",771,771)

"BLD",4899,"KRN","B",870,870)

"BLD",4899,"KRN","B",8989.51,8989.51)

"BLD",4899,"KRN","B",8989.52,8989.52)

"BLD",4899,"KRN","B",8994,8994)

"BLD",4899,"QUES",0)
^9.62^^0
"BLD",4899,"REQB",0)
^9.611^^
"FIA",59.7)
PHARMACY SYSTEM
"FIA",59.7,0)
^PS(59.7,
"FIA",59.7,0,0)
59.7
"FIA",59.7,0,1)
y^y^p^^^^n^^n
"FIA",59.7,0,10)

"FIA",59.7,0,11)

"FIA",59.7,0,"RLRO")

"FIA",59.7,0,"VR")
4.0^PSU
"FIA",59.7,59.7)
1
"FIA",59.7,59.7,90.01)

"FIA",59.7,59.7,90.02)

"FIA",59.7,59.7,90.03)

"FIA",59.7,59.79001)
0
"FIA",59.7,59.79002)
0
"FIA",59.7,59.79003)
0
"FIA",59.9)
PBM PATIENT DEMOGRAPHICS
"FIA",59.9,0)
^PSUDEM(
"FIA",59.9,0,0)
59.9D
"FIA",59.9,0,1)
y^y^f^^^^n
"FIA",59.9,0,10)

"FIA",59.9,0,11)

"FIA",59.9,0,"RLRO")

"FIA",59.9,0,"VR")
4.0^PSU
"FIA",59.9,59.9)
0
"IX",59.9,59.9,"C",0)
59.9^C^(PATIENT,DATE/TIME,DA) XREF^R^^R^IR^I^59.9^^^^^LS
"IX",59.9,59.9,"C",1)
S ^PSUDEM("C",X(1),X(2),DA)=""
"IX",59.9,59.9,"C",2)
K ^PSUDEM("C",X(1),X(2),DA)
"IX",59.9,59.9,"C",2.5)
K ^PSUDEM("C")
"IX",59.9,59.9,"C",11.1,0)
^.114IA^2^2
"IX",59.9,59.9,"C",11.1,1,0)
1^F^59.9^.02^^1^F
"IX",59.9,59.9,"C",11.1,2,0)
2^F^59.9^.01^^2^F
"KRN",3.8,73,-1)
0^1
"KRN",3.8,73,0)
PSU PBM^PU^^^^^
"KRN",3.8,73,2,0)
^^2^2^2940614^^^^
"KRN",3.8,73,2,1,0)
This mail group contains the persons who will receive mail message
"KRN",3.8,73,2,2,0)
reports from the D&PPM monthly background job.
"KRN",3.8,73,3)

"KRN",19,8212,-1)
0^2
"KRN",19,8212,0)
PSU PBM AUTO^Automatic Pharmacy Statistics^^R^^^^^^^^PHARMACY BENEFITS MANAGEMENT^^
"KRN",19,8212,1,0)
^^22^22^3020206^
"KRN",19,8212,1,1,0)
This option is used to gather statistics for the previous month from the
"KRN",19,8212,1,2,0)
following files:
"KRN",19,8212,1,3,0)
 
"KRN",19,8212,1,4,0)
 1. Pharmacy Patient IV Sub-file            File # 55.01
"KRN",19,8212,1,5,0)
 2. Pharmacy Patient UD Sub-file            File # 55.06
"KRN",19,8212,1,6,0)
 3. AR/WS Stats File                        File # 58.5
"KRN",19,8212,1,7,0)
 4. Prescription                            File # 52
"KRN",19,8212,1,8,0)
 5. Procurement                             File # 442,# 58.811,# 58.81
"KRN",19,8212,1,9,0)
 6. Controlled Substances                   File # 58.81
"KRN",19,8212,1,10,0)
 7. Laboratory                              File # 60,# 63
"KRN",19,8212,1,11,0)
 8. Patient Demographics                    File # 2
"KRN",19,8212,1,12,0)
 9. Outpatient Visits                       File # 9000010,# 9000010.07
"KRN",19,8212,1,13,0)
 10. Inpatient PTF Record                   File # 45
"KRN",19,8212,1,14,0)
 11. Provider Data                          File # 200,# 7,# 49,# 8932.1 
"KRN",19,8212,1,15,0)
 
"KRN",19,8212,1,16,0)
This option is executed as a background job each month. The statistics
"KRN",19,8212,1,17,0)
are gathered and then sent to the National PBM section via MailMan
"KRN",19,8212,1,18,0)
messages.
"KRN",19,8212,1,19,0)
 
"KRN",19,8212,1,20,0)
When scheduling the monthly frequency for this option to be executed,
"KRN",19,8212,1,21,0)
please remember to schedule it to run after the PSGW UPDATE AMIS STATS
"KRN",19,8212,1,22,0)
option has been executed for the previous month.
"KRN",19,8212,20)

"KRN",19,8212,25)
AUTO^PSUCP
"KRN",19,8212,31)

"KRN",19,8212,200.9)
y
"KRN",19,8212,"U")
AUTOMATIC PHARMACY STATISTICS
"KRN",19,8213,-1)
0^5
"KRN",19,8213,0)
PSU PBM MANUAL^Manual Pharmacy Statistics^^R^^^^^^^^PHARMACY BENEFITS MANAGEMENT
"KRN",19,8213,1,0)
^19.06^18^18^3040204^^
"KRN",19,8213,1,1,0)
This option is used to gather the statistical information for a selected
"KRN",19,8213,1,2,0)
date range from the following files:
"KRN",19,8213,1,3,0)
 
"KRN",19,8213,1,4,0)
 1. Pharmacy Patient IV Sub-file           File # 55.01
"KRN",19,8213,1,5,0)
 2. Pharmacy Patient UD Sub-file           File # 55.06
"KRN",19,8213,1,6,0)
 3. AR/WS Stats File                       File # 58.5
"KRN",19,8213,1,7,0)
 4. Prescription                           File # 52
"KRN",19,8213,1,8,0)
 5. Procurement                            File # 442,# 58.811,# 58.81
"KRN",19,8213,1,9,0)
 6. Controlled Substances                  File # 58.81
"KRN",19,8213,1,10,0)
 7. Laboratory                             File # 60,# 63
"KRN",19,8213,1,11,0)
 8. Patient Demographics                   File # 2
"KRN",19,8213,1,12,0)
 9. Outpatient Visits                      File # 9000010,# 9000010.07
"KRN",19,8213,1,13,0)
 10. Inpatient PTF Record                  File # 45
"KRN",19,8213,1,14,0)
 11. Provider Data                         File # 200,# 7,# 49,# 8932.1
"KRN",19,8213,1,15,0)
 
"KRN",19,8213,1,16,0)
This data can be collected for ALL of the files listed or for one or more
"KRN",19,8213,1,17,0)
specific file.  A summary of data or a detailed report by drug can be
"KRN",19,8213,1,18,0)
delivered to you in a mail message or in a hard copy report.
"KRN",19,8213,25)
PSUCP
"KRN",19,8213,99)
55684,35938
"KRN",19,8213,"U")
MANUAL PHARMACY STATISTICS
"KRN",19,11182,-1)
0^3
"KRN",19,11182,0)
PSU PBM JOB CHECK^Pharmacy Background Job Check^^R^^^^^^^^PHARMACY BENEFITS MANAGEMENT
"KRN",19,11182,1,0)
^19.06^6^6^3040505^^^
"KRN",19,11182,1,1,0)
This option will check to see if the monthly PBM statistics ran to
"KRN",19,11182,1,2,0)
completion.  A MailMan message will be sent to the local PSU PBM mail
"KRN",19,11182,1,3,0)
group and to the National PBM group at Hines if the report has not
"KRN",19,11182,1,4,0)
completed in 6 days.  This option is scheduled automatically by the
"KRN",19,11182,1,5,0)
PSU PBM AUTO option and normally does not need user intervention.  In case
"KRN",19,11182,1,6,0)
of computer outage, it could be run manually.
"KRN",19,11182,25)
PSUCP2
"KRN",19,11182,"U")
PHARMACY BACKGROUND JOB CHECK
"KRN",19,12486,-1)
0^1
"KRN",19,12486,0)
PSU MAP PHARMACY LOCATIONS^Map Pharmacy Locations^^R^^^^^^^^PHARMACY BENEFITS MANAGEMENT
"KRN",19,12486,1,0)
^19.06^7^7^3040902^^^^
"KRN",19,12486,1,1,0)
This option allows the mapping of dispensing/procurement locations from 
"KRN",19,12486,1,2,0)
the AR/WS, Controlled Substances, and Drug Accountability applications to 
"KRN",19,12486,1,3,0)
either a Medical Center Division or an Outpatient Site.  Any 
"KRN",19,12486,1,4,0)
dispensing/procurement data associated with an AR/WS AOU, CS NAOU or DA 
"KRN",19,12486,1,5,0)
Pharmacy Location that has not been mapped will be attributed to the 
"KRN",19,12486,1,6,0)
facility at which the database resides.  Any unmapped locations will be 
"KRN",19,12486,1,7,0)
displayed upon entering the option.
"KRN",19,12486,25)
PSUMAP0
"KRN",19,12486,99)
59569,48784
"KRN",19,12486,"U")
MAP PHARMACY LOCATIONS
"KRN",19,12552,-1)
0^4
"KRN",19,12552,0)
PSU PBM MANAGER MENU^Manager Menu Options^^M^^^^^^^y^PHARMACY BENEFITS MANAGEMENT
"KRN",19,12552,10,0)
^19.01IP^3^3
"KRN",19,12552,10,1,0)
8213
"KRN",19,12552,10,1,"^")
PSU PBM MANUAL
"KRN",19,12552,10,2,0)
12486
"KRN",19,12552,10,2,"^")
PSU MAP PHARMACY LOCATIONS
"KRN",19,12552,10,3,0)
12554
"KRN",19,12552,10,3,"^")
PSU RETRANSMIT PATIENT DATA
"KRN",19,12552,99)
60011,59064
"KRN",19,12552,"U")
MANAGER MENU OPTIONS
"KRN",19,12554,-1)
0^6
"KRN",19,12554,0)
PSU RETRANSMIT PATIENT DATA^Retransmit Patient Demographic Data^^R^^^^^^^^
"KRN",19,12554,25)
PSURT1
"KRN",19,12554,"U")
RETRANSMIT PATIENT DEMOGRAPHIC
"KRN",101,4906,-1)
2^8
"KRN",101,4906,0)
DG FIELD MONITOR^DG Field Monitor^^X^10000000012^^^^^^^114
"KRN",101,4906,10,0)
^101.01PA^4^1
"KRN",101,4906,10,4,0)
5141^^^
"KRN",101,4906,10,4,"^")
PSU PATIENT DEMOGRAPHIC CHANGE
"KRN",101,5141,-1)
0^3
"KRN",101,5141,0)
PSU PATIENT DEMOGRAPHIC CHANGE^PATIENT DEMOGRAPHIC CHANGE^^A^^^^^^^^PHARMACY BENEFITS MANAGEMENT
"KRN",101,5141,1,0)
^^5^5^3040520^
"KRN",101,5141,1,1,0)
As an item on the DG FIELD MONITOR protocol, this protocol will call 
"KRN",101,5141,1,2,0)
CHNG^PSUHL to flag changed patient records to facilitate the PSU PBM 
"KRN",101,5141,1,3,0)
PATIENT DEMOGRAPHIC data extract by storing the DFN to the changed record 
"KRN",101,5141,1,4,0)
and the date the of the transaction to the PBM PATIENT DEMOGRAPHICS  file 
"KRN",101,5141,1,5,0)
(#59.9).
"KRN",101,5141,4)
^^^PSUDEM
"KRN",101,5141,20)
D CHNG^PSUHL
"KRN",101,5141,99)
60011,59064
"MBREQ")
0
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1;;MAILGDEL^XPDIA1(%)
"ORD",11,3.8,0)
MAIL GROUP
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",367,-1)
1^1
"PKG",367,0)
PHARMACY BENEFITS MANAGEMENT^PSU^PHARMACY BENEFITS MANAGEMENT
"PKG",367,1)
national product use on a monthly, quarterly, and annual intervals.
"PKG",367,1,0)
^^20^20^2990210^^^^
"PKG",367,1,1,0)
 ;;Pharmacy Benefits Management (PBM) software extracts statistics from
"PKG",367,1,2,0)
 ;;the following files on a monthly basis:
"PKG",367,1,3,0)
 ;;
"PKG",367,1,4,0)
 ;;File Name                                     File Number
"PKG",367,1,5,0)
 ;;---------------------------------------------------------
"PKG",367,1,6,0)
 ;;Pharmacy Patient IV Subfile......................55.01
"PKG",367,1,7,0)
 ;;Pharmacy Patient UD Subfile......................55.06
"PKG",367,1,8,0)
 ;;AR/WS STOCK Stats................................58.5
"PKG",367,1,9,0)
 ;;Prescription.....................................52
"PKG",367,1,10,0)
 ;;Procurement......................................442, 58.811, 58.81
"PKG",367,1,11,0)
 ;;Controlled Substances............................58.81
"PKG",367,1,12,0)
 ;;Laboratory.......................................60, 63
"PKG",367,1,13,0)
 ;;
"PKG",367,1,14,0)
 ;;This data is electronically exported via MailMan to the National
"PKG",367,1,15,0)
 ;;PBM Section. These messages are then passed through a translation
"PKG",367,1,16,0)
 ;;process to convert all local drug names to a common drug name and all
"PKG",367,1,17,0)
 ;;local dispensing units to a common dispensing unit. After translation
"PKG",367,1,18,0)
 ;;the information will be added to a national database. The PBM
"PKG",367,1,19,0)
 ;;Section will be able to provide information on facility, regional, and
"PKG",367,1,20,0)
 ;;national product use on a monthly, quarterly, and annual intervals.
"PKG",367,5)
BIRM
"PKG",367,20,0)
^9.402P^^
"PKG",367,22,0)
^9.49I^1^1
"PKG",367,22,1,0)
4.0^3050622^3050421^10000000012
"PKG",367,22,1,1,0)
^^12^12^3050622
"PKG",367,22,1,1,1,0)
The PBM V. 4.0 application contains enhancements to support the VA 
"PKG",367,22,1,1,2,0)
National Formulary (VANF), disease management issues and patient safety 
"PKG",367,22,1,1,3,0)
initiatives. 
"PKG",367,22,1,1,4,0)
 
"PKG",367,22,1,1,5,0)
Two new extracts have been created to gather patient vital/immunization 
"PKG",367,22,1,1,6,0)
and allergy/adverse reaction data.  Modifications have also been 
"PKG",367,22,1,1,7,0)
made to existing Prescription, Unit Dose, Intravenous (IV),
"PKG",367,22,1,1,8,0)
Controlled Substance (CS), Automatic Replenishment/Ward Stock (AR/WS),
"PKG",367,22,1,1,9,0)
Procurement, Patient Demographic, Outpatient Visits, Laboratory 
"PKG",367,22,1,1,10,0)
extracts, and existing PBM options.  New summary reports have been 
"PKG",367,22,1,1,11,0)
created for Automated Management Information System (AMIS) reporting.  New
"PKG",367,22,1,1,12,0)
options have also been created to support the added functionality.
"PKG",367,"DEV")
HOLLOWAY/WESLEY/BIRMINGHAM
"PKG",367,"VERSION")
4.0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
103
"RTN","PSUAA1")
0^1^B16326851
"RTN","PSUAA1",1,0)
PSUAA1 ;BIR/RDC - ALLERGY/ADVERSE EVENT EXTRACT ; 23 FEB 2004
"RTN","PSUAA1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAA1",3,0)
 ;
"RTN","PSUAA1",4,0)
 ; Reference to file #4          supported by DBIA 10090
"RTN","PSUAA1",5,0)
 ; Reference to file #2          supported by DBIA 10035 AND 3504
"RTN","PSUAA1",6,0)
 ; Reference to file #120.8      supported by DBIA 10099, 2422, AND 4562
"RTN","PSUAA1",7,0)
 ; Reference to file #120.85     supported by DBIA 10099
"RTN","PSUAA1",8,0)
 ; Reference to file #49         supported by DBIA 432
"RTN","PSUAA1",9,0)
 ;
"RTN","PSUAA1",10,0)
EN ;
"RTN","PSUAA1",11,0)
 N ARTMP,DFN,EDATE,GMRA,GMRACT,GMRAL,GMREC,ICN,K,LINECNT,LINEMAX,LINETOT,MSGCNT,NPTR,OPTR,OREC,PN,PREC,RPTR,RRDT,RREC,SDATE,SSN,STAT5ION,V,VPTR,X,Z
"RTN","PSUAA1",12,0)
 ;
"RTN","PSUAA1",13,0)
 D INITZ
"RTN","PSUAA1",14,0)
 D GETRECS
"RTN","PSUAA1",15,0)
 D ^PSUAA2
"RTN","PSUAA1",16,0)
 Q
"RTN","PSUAA1",17,0)
 ;
"RTN","PSUAA1",18,0)
INITZ ;
"RTN","PSUAA1",19,0)
 ;  ** new all non-namespaced variables **
"RTN","PSUAA1",20,0)
 ;
"RTN","PSUAA1",21,0)
 S SDATE=PSUSDT\1-.0001
"RTN","PSUAA1",22,0)
 S EDATE=PSUEDT\1+.2359
"RTN","PSUAA1",23,0)
 ;
"RTN","PSUAA1",24,0)
 S LINEMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUAA1",25,0)
 S:LINEMAX=""!(LINEMAX>10000) LINEMAX=10000
"RTN","PSUAA1",26,0)
 S LINECNT=999999
"RTN","PSUAA1",27,0)
 S LINETOT=0
"RTN","PSUAA1",28,0)
 ;
"RTN","PSUAA1",29,0)
 S PSUFAC=PSUSNDR
"RTN","PSUAA1",30,0)
 ;
"RTN","PSUAA1",31,0)
 ; ** get station number **
"RTN","PSUAA1",32,0)
 S X=$$VALI^PSUTL(4.3,1,217)
"RTN","PSUAA1",33,0)
 S STATION=+$$VAL^PSUTL(4,X,99)
"RTN","PSUAA1",34,0)
 ;
"RTN","PSUAA1",35,0)
 ; ** get run date **
"RTN","PSUAA1",36,0)
 S %H=$H
"RTN","PSUAA1",37,0)
 D YMD^%DTC
"RTN","PSUAA1",38,0)
 S $P(^TMP("PSUAA",$J),U,3)=X
"RTN","PSUAA1",39,0)
 ;
"RTN","PSUAA1",40,0)
 ;
"RTN","PSUAA1",41,0)
 Q  ;  ** end of partition initialization **
"RTN","PSUAA1",42,0)
 ;
"RTN","PSUAA1",43,0)
GETRECS ;  ;  **  extract reactive data  **
"RTN","PSUAA1",44,0)
 F  S SDATE=$O(^GMR(120.8,"V",SDATE)) Q:SDATE>EDATE!('SDATE)  D
"RTN","PSUAA1",45,0)
 . S VPTR=""                       ;*** loop through verified dates  ***
"RTN","PSUAA1",46,0)
 . F  S VPTR=$O(^GMR(120.8,"V",SDATE,VPTR)) Q:VPTR=""  D
"RTN","PSUAA1",47,0)
 .. S VREC=^GMR(120.8,VPTR,0)
"RTN","PSUAA1",48,0)
 .. S DFN=$P(VREC,U)
"RTN","PSUAA1",49,0)
 .. Q:$G(DFN)=""
"RTN","PSUAA1",50,0)
 .. Q:$$TESTPAT^VADPT(DFN)=1                  ;test patient
"RTN","PSUAA1",51,0)
 .. S PREC=$G(^DPT(DFN,0))
"RTN","PSUAA1",52,0)
 .. S SSN=$P(PREC,U,9)
"RTN","PSUAA1",53,0)
 .. S GMRA="0^1^111"
"RTN","PSUAA1",54,0)
 .. D EN1^GMRADPT
"RTN","PSUAA1",55,0)
 .. Q:'$D(GMRAL(VPTR))
"RTN","PSUAA1",56,0)
 .. S GMREC=GMRAL(VPTR)
"RTN","PSUAA1",57,0)
 .. D EN1^GMRAOR2(VPTR,.ARTMP)    ;  ** load multiple variables  **
"RTN","PSUAA1",58,0)
 .. S V="" F  S V=$O(GMRACT("O",V)) Q:V=""!(V=7)  D
"RTN","PSUAA1",59,0)
 ... S Z="$",OREC=""
"RTN","PSUAA1",60,0)
 ... D STATIC
"RTN","PSUAA1",61,0)
 ... S $P(OREC,Z,12)=$P(GMRACT("O",V),U)               ; * event date
"RTN","PSUAA1",62,0)
 ... S $P(OREC,Z,13)=$P(GMRACT("O",V),U,2)             ; * severity
"RTN","PSUAA1",63,0)
 ... S $P(OREC,Z,14)=$G(GMRACT("S",V))                     ; * symptoms
"RTN","PSUAA1",64,0)
 ... S $P(OREC,Z,15)=""
"RTN","PSUAA1",65,0)
 ... D MAKE1                      ; **  load ^XTMP with OREC  **
"RTN","PSUAA1",66,0)
 ... S:$G(MSGCNT) ^XTMP("PSU_"_PSUJOB,"PSUAA","MSGTCNT")=MSGCNT
"RTN","PSUAA1",67,0)
 ... S:LINECNT=999999 LINECNT=1
"RTN","PSUAA1",68,0)
 ... S:$G(LINECNT) ^XTMP("PSU_"_PSUJOB,"PSUAA","LINECNT")=LINECNT
"RTN","PSUAA1",69,0)
 Q
"RTN","PSUAA1",70,0)
 ;
"RTN","PSUAA1",71,0)
STATIC ;  ** set static pieces of record into OREC **
"RTN","PSUAA1",72,0)
 ;
"RTN","PSUAA1",73,0)
 S $P(OREC,Z,1)=""
"RTN","PSUAA1",74,0)
 S $P(OREC,Z,2)=STATION_VPTR          ; ** event ID
"RTN","PSUAA1",75,0)
 S $P(OREC,Z,3)=SSN                   ; ** social security #
"RTN","PSUAA1",76,0)
 ;
"RTN","PSUAA1",77,0)
 S ICN=$$GETICN^MPIF001(DFN)           ; **  ICN
"RTN","PSUAA1",78,0)
 I $E(ICN,1,2)="-1" S ICN=""
"RTN","PSUAA1",79,0)
 S $P(OREC,Z,4)=ICN
"RTN","PSUAA1",80,0)
 ;
"RTN","PSUAA1",81,0)
 S $P(OREC,Z,5)=$P(GMREC,U,2)          ;  ** reactant
"RTN","PSUAA1",82,0)
 S $P(OREC,Z,6)=$P($P($P(GMREC,U,9),"(",2),",")  ; * reactant file #
"RTN","PSUAA1",83,0)
 S $P(OREC,Z,7)=$P(GMREC,U,7)          ;  **  allergy type
"RTN","PSUAA1",84,0)
 S $P(OREC,Z,8)=$P(VREC,U,4)           ;  ** origination date
"RTN","PSUAA1",85,0)
 ;
"RTN","PSUAA1",86,0)
 S NPTR=$P(VREC,U,5)                ; * originator's section/service
"RTN","PSUAA1",87,0)
 I NPTR S OPTR=$P($G(^VA(200,NPTR,5)),U,1)
"RTN","PSUAA1",88,0)
 I OPTR S $P(OREC,Z,9)=$P(^DIC(49,OPTR,0),U,1)
"RTN","PSUAA1",89,0)
 ;
"RTN","PSUAA1",90,0)
 S $P(OREC,Z,10)=$P(VREC,U,6)          ;  ** observed/historical
"RTN","PSUAA1",91,0)
 S $P(OREC,Z,11)=$P(VREC,U,14)         ;  ** mechanism
"RTN","PSUAA1",92,0)
 ;
"RTN","PSUAA1",93,0)
 Q  ;  ** end of static variables for a message **
"RTN","PSUAA1",94,0)
 ;
"RTN","PSUAA1",95,0)
MAKE1 ;   ** load one record/message **
"RTN","PSUAA1",96,0)
 ;
"RTN","PSUAA1",97,0)
 S OREC=$TR(OREC,"^","'")
"RTN","PSUAA1",98,0)
 S OREC=$TR(OREC,Z,U)
"RTN","PSUAA1",99,0)
 ;
"RTN","PSUAA1",100,0)
 S LINECNT=LINECNT+1
"RTN","PSUAA1",101,0)
 S LINETOT=LINETOT+1
"RTN","PSUAA1",102,0)
 I LINECNT>LINEMAX S MSGCNT=$G(MSGCNT)+1,LINECNT=1
"RTN","PSUAA1",103,0)
 I $L(OREC)<254 S ^XTMP("PSU_"_PSUJOB,"PSUAA",MSGCNT,LINECNT)=OREC Q
"RTN","PSUAA1",104,0)
 F K=254:-1 Q:$E(OREC,K)="^"
"RTN","PSUAA1",105,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUAA",MSGCNT,LINECNT)=$E(OREC,1,K)
"RTN","PSUAA1",106,0)
 S LINECNT=LINECNT+1
"RTN","PSUAA1",107,0)
 S LINETOT=LINETOT+1
"RTN","PSUAA1",108,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUAA",MSGCNT,LINECNT)="*"_$E(OREC,K,K+253)
"RTN","PSUAA1",109,0)
 Q
"RTN","PSUAA1",110,0)
PRINT ; ALLOW NO PRINTING
"RTN","PSUAA1",111,0)
 Q
"RTN","PSUAA1",112,0)
 ;
"RTN","PSUAA2")
0^2^B3886541
"RTN","PSUAA2",1,0)
PSUAA2 ;BIR/RDC - ALLERGY/ADVERSE EVENT Mail Messages; 23 FEB 2004
"RTN","PSUAA2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAA2",3,0)
 ;
"RTN","PSUAA2",4,0)
 ; Reference to file #4.3        supported by DBIA 2496
"RTN","PSUAA2",5,0)
 ;
"RTN","PSUAA2",6,0)
EN1 ;ENtry point for ALLERGY/ADVERSE EVENT Mail Message
"RTN","PSUAA2",7,0)
 ;
"RTN","PSUAA2",8,0)
 S DOMSG=""
"RTN","PSUAA2",9,0)
 S XMCHAN=1
"RTN","PSUAA2",10,0)
 S XMDUZ=DUZ
"RTN","PSUAA2",11,0)
 S MSGTOT=$G(^XTMP("PSU_"_PSUJOB,"PSUAA","MSGTCNT"))
"RTN","PSUAA2",12,0)
 S:MSGTOT="" MSGTOT=1
"RTN","PSUAA2",13,0)
 S LINECNT=$G(^XTMP("PSU_"_PSUJOB,"PSUAA","LINECNT"))
"RTN","PSUAA2",14,0)
 S:LINECNT=0 LINECNT=1
"RTN","PSUAA2",15,0)
 ;                                 ** SET THE HEADER DATA
"RTN","PSUAA2",16,0)
 S X=$$VALI^PSUTL(4.3,1,217)
"RTN","PSUAA2",17,0)
 S PSUVFAC=+$$VAL^PSUTL(4,X,99)
"RTN","PSUAA2",18,0)
 ;
"RTN","PSUAA2",19,0)
 S X=PSUVFAC,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAA2",20,0)
 S X=+Y S PSUVDIV=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAA2",21,0)
 ;
"RTN","PSUAA2",22,0)
 I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) S DOMSG=1 D
"RTN","PSUAA2",23,0)
 . I '$D(^XTMP("PSU_"_PSUJOB,"PSUAA","MSGTCNT")) D  Q  ; quit - no data 
"RTN","PSUAA2",24,0)
 .. S CURMSG=1
"RTN","PSUAA2",25,0)
 .. S XMSUB="V. 4.0 PBMAA"_" "_PSUMON_" "_CURMSG_"/"_MSGTOT_" "_PSUVFAC_" "_PSUVDIV
"RTN","PSUAA2",26,0)
 .. S ^XTMP("PSU_"_PSUJOB,"PSUAA","ERR",1)="No data to report"
"RTN","PSUAA2",27,0)
 .. S XMTEXT="^XTMP(""PSU_"_PSUJOB_""",""PSUAA"",""ERR"","
"RTN","PSUAA2",28,0)
 .. M XMY=PSUXMYS1
"RTN","PSUAA2",29,0)
 .. D ^XMD
"RTN","PSUAA2",30,0)
 . ;                    **  there are messages - send them **
"RTN","PSUAA2",31,0)
 . F CURMSG=1:1:MSGTOT D
"RTN","PSUAA2",32,0)
 .. S XMSUB="V. 4.0 PBMAA"_" "_PSUMON_" "_CURMSG_"/"_MSGTOT_" "_PSUVFAC_" "_PSUVDIV
"RTN","PSUAA2",33,0)
 .. S XMTEXT="^XTMP(""PSU_"_PSUJOB_""",""PSUAA"","_CURMSG_","
"RTN","PSUAA2",34,0)
 .. M XMY=PSUXMYH
"RTN","PSUAA2",35,0)
 .. D ^XMD
"RTN","PSUAA2",36,0)
 I DOMSG D  ;                        ** CONFIRMATION MESSAGE **
"RTN","PSUAA2",37,0)
 . S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUVFAC,11,"L")=LINECNT
"RTN","PSUAA2",38,0)
 . S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUVFAC,11,"M")=MSGTOT
"RTN","PSUAA2",39,0)
 ;
"RTN","PSUAA2",40,0)
 Q
"RTN","PSUAA2",41,0)
 ;
"RTN","PSUALERT")
0^113^B3059763
"RTN","PSUALERT",1,0)
PSUALERT ;OIFIO BAY PINES/TEH - PBM CONTROL POINT - ALERT ;OCT 15,1998
"RTN","PSUALERT",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUALERT",3,0)
MANUAL ;MANUAL ALERT MESSAGE - DISPLAY TO SCREEN INCLUDED.
"RTN","PSUALERT",4,0)
 I '$D(^XTMP("PSU","RUNNING")) Q
"RTN","PSUALERT",5,0)
 L ^XTMP("PSU","RUNNING"):1 I '$T D  Q
"RTN","PSUALERT",6,0)
 .W !,"A previously tasked Extract (TASK #: "_$G(^XTMP("PSU","RUNNING"))_") is running....try again later. ",! S PSUALERT=1
"RTN","PSUALERT",7,0)
 .;SEND ALERT JOB RUNNING
"RTN","PSUALERT",8,0)
 .S XQA(DUZ)="",XQA("G.PSU PBM")="",XQAMSG="A PBM Extract is CURRENTLY running in the background...try later."
"RTN","PSUALERT",9,0)
 .S XQAID="PSU",XQAFLG="D",PSUALERT=1 D SETUP^XQALERT
"RTN","PSUALERT",10,0)
 W !,"A Previous job seems to have encountered an error. A new job may encounter the same problem."
"RTN","PSUALERT",11,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUALERT",12,0)
 L  Q
"RTN","PSUALERT",13,0)
 ;
"RTN","PSUALERT",14,0)
AUTO ;AUTO ALERT MESSAGE
"RTN","PSUALERT",15,0)
 I '$D(^XTMP("PSU","RUNNING")) Q
"RTN","PSUALERT",16,0)
 L ^XTMP("PSU","RUNNING"):1 I '$T D  Q
"RTN","PSUALERT",17,0)
 .S XQA(DUZ)="",XQA("G.PSU PBM")="",XQAMSG="A PBM Extract is CURRENTLY running in the background...try later."
"RTN","PSUALERT",18,0)
 .S XQAID="PSU",XQAFLG="D",PSUALERT=1 D SETUP^XQALERT
"RTN","PSUALERT",19,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUALERT",20,0)
 L  Q
"RTN","PSUAMC")
0^4^B3549679
"RTN","PSUAMC",1,0)
PSUAMC ;BIR/DAM - Combined AMIS Summary Report:21 APR 2004
"RTN","PSUAMC",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAMC",3,0)
 ;
"RTN","PSUAMC",4,0)
 ;This routine creates a combined AMIS summary report when
"RTN","PSUAMC",5,0)
 ;the following extracts are run either by the automatic
"RTN","PSUAMC",6,0)
 ;monthly extract or manual selection
"RTN","PSUAMC",7,0)
 ; 1. IV extract
"RTN","PSUAMC",8,0)
 ; 2. UD extract
"RTN","PSUAMC",9,0)
 ; 3. AR/WS extract
"RTN","PSUAMC",10,0)
 ; 4. Prescription extract
"RTN","PSUAMC",11,0)
 ; 6. CS extract
"RTN","PSUAMC",12,0)
 ;
"RTN","PSUAMC",13,0)
 ;
"RTN","PSUAMC",14,0)
EN ;Entry point.  Called from ^PSUCSR2
"RTN","PSUAMC",15,0)
 ;
"RTN","PSUAMC",16,0)
 K AMIS
"RTN","PSUAMC",17,0)
 ;
"RTN","PSUAMC",18,0)
 S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUAMC",19,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUAMC",20,0)
        ;
"RTN","PSUAMC",21,0)
 S AMIS(1,1)="Monthly AMIS Summary for "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUAMC",22,0)
 S AMIS(1,2)=""
"RTN","PSUAMC",23,0)
 S AMIS(1,3)=""
"RTN","PSUAMC",24,0)
 ;
"RTN","PSUAMC",25,0)
 M AMIS(2)=^XTMP("PSU_"_PSUJOB,"OPCOMBO")
"RTN","PSUAMC",26,0)
 ;
"RTN","PSUAMC",27,0)
 M AMIS(3)=^XTMP("PSU_"_PSUJOB,"UDCOMBO")
"RTN","PSUAMC",28,0)
 ;
"RTN","PSUAMC",29,0)
 M AMIS(4)=^XTMP("PSU_"_PSUJOB,"ARCOMBO")
"RTN","PSUAMC",30,0)
 ;
"RTN","PSUAMC",31,0)
 M AMIS(5)=^XTMP("PSU_"_PSUJOB,"CSCOMBO")
"RTN","PSUAMC",32,0)
 ;
"RTN","PSUAMC",33,0)
 M AMIS(6)=^XTMP("PSU_"_PSUJOB,"IVCOMBO")
"RTN","PSUAMC",34,0)
 ;
"RTN","PSUAMC",35,0)
 ;Reorganize AMIS array
"RTN","PSUAMC",36,0)
 S C=1
"RTN","PSUAMC",37,0)
 S PSUCT=0
"RTN","PSUAMC",38,0)
 F  S PSUCT=$O(AMIS(PSUCT)) Q:PSUCT=""  D
"RTN","PSUAMC",39,0)
 .S PSULN=0
"RTN","PSUAMC",40,0)
 .F  S PSULN=$O(AMIS(PSUCT,PSULN)) Q:PSULN=""  D
"RTN","PSUAMC",41,0)
 ..S AMIS(C)=AMIS(PSUCT,PSULN)
"RTN","PSUAMC",42,0)
 ..S C=C+1
"RTN","PSUAMC",43,0)
 ;
"RTN","PSUAMC",44,0)
 D MAIL
"RTN","PSUAMC",45,0)
 Q
"RTN","PSUAMC",46,0)
 ;
"RTN","PSUAMC",47,0)
MAIL ;Mail combo message
"RTN","PSUAMC",48,0)
 ;
"RTN","PSUAMC",49,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)    ;Facility #
"RTN","PSUAMC",50,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)  ;Facility name
"RTN","PSUAMC",51,0)
 ;
"RTN","PSUAMC",52,0)
 S XMSUB="V. 4.0 PBMAMIS "_PSUMON_" "_PSUST_" "_PSUSTNM
"RTN","PSUAMC",53,0)
 S XMTEXT="AMIS("
"RTN","PSUAMC",54,0)
 M ^XTMP("PSU_"_PSUJOB,"COMBOAMIS")=AMIS
"RTN","PSUAMC",55,0)
 S XMCHAN=1
"RTN","PSUAMC",56,0)
 M XMY=PSUXMYS2
"RTN","PSUAMC",57,0)
 D ^XMD
"RTN","PSUAMC",58,0)
 ;
"RTN","PSUAMC",59,0)
 Q
"RTN","PSUAR0")
0^5^B4372651
"RTN","PSUAR0",1,0)
PSUAR0 ; BIR/PDW - Master Routine for AR/WS PBMS Extraction ;25 AUG 1998
"RTN","PSUAR0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR0",3,0)
EN ; EP ENTRY FROM PSUCP
"RTN","PSUAR0",4,0)
PULL ; pull variables from ^XTMP
"RTN","PSUAR0",5,0)
 ;PSUJOB must exist and must be the job number used to store the data desired for this session.
"RTN","PSUAR0",6,0)
 I '$D(PSUJOB) S PSUJOB=$J
"RTN","PSUAR0",7,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,ZTIO,PSUSNDR,PSUOPTS"
"RTN","PSUAR0",8,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P(^XTMP("PSU_"_PSUJOB,1),U,I)
"RTN","PSUAR0",9,0)
 ;
"RTN","PSUAR0",10,0)
 I '$D(PSUJOB) S PSUJOB=$J
"RTN","PSUAR0",11,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,ZTIO,PSUSNDR,PSUOPTS"
"RTN","PSUAR0",12,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P(^XTMP("PSU_"_PSUJOB,1),U,I)
"RTN","PSUAR0",13,0)
COMPUTE ;EP for Compute Cycle of AR/WS Extract
"RTN","PSUAR0",14,0)
 S PSUARJOB=PSUJOB
"RTN","PSUAR0",15,0)
 S PSUARSUB="PSUAR_"_PSUARJOB
"RTN","PSUAR0",16,0)
 K ^XTMP(PSUARSUB)
"RTN","PSUAR0",17,0)
 S X1=DT,X2=6 D C^%DTC
"RTN","PSUAR0",18,0)
 S ^XTMP(PSUARSUB,0)=X_U_DT_"^  Storage for PBMS AR/WS Extract Data"
"RTN","PSUAR0",19,0)
 ;
"RTN","PSUAR0",20,0)
 ;    Save Important Variables
"RTN","PSUAR0",21,0)
 S X="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUSNDR,PSUPRSUB,PSUPRJOB,PSUJOB,PSUOPTN,PSURTN"
"RTN","PSUAR0",22,0)
 F I=1:1 S Y=$P(X,",",I) Q:Y=""  I $D(@Y) S X(Y)=@Y
"RTN","PSUAR0",23,0)
 M ^XTMP(PSUARSUB,"SAVE")=X
"RTN","PSUAR0",24,0)
 ;
"RTN","PSUAR0",25,0)
 D EN^PSUAR1          ; Gather Data
"RTN","PSUAR0",26,0)
 D EN^PSUAR2          ; Build Records from Data
"RTN","PSUAR0",27,0)
 D EN^PSUAR3(.PSUARM) ; Mail Message Generator
"RTN","PSUAR0",28,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUAR0",29,0)
 I $D(^XTMP(PSUSUB)),PSUMASF M ^XTMP(PSUSUB,"CONFIRM")=PSUARM
"RTN","PSUAR0",30,0)
 I $D(^XTMP(PSUSUB)),PSUPBMG M ^XTMP(PSUSUB,"CONFIRM")=PSUARM
"RTN","PSUAR0",31,0)
 D EN^PSUAR4          ; Summary Messages
"RTN","PSUAR0",32,0)
 D EN^PSUAR6          ; AMIST Summary report
"RTN","PSUAR0",33,0)
 K PSUAR,PSUAMIS,AMISAR
"RTN","PSUAR0",34,0)
 Q
"RTN","PSUAR0",35,0)
 ;
"RTN","PSUAR0",36,0)
PRINT ;EP for Print Cycle
"RTN","PSUAR0",37,0)
 D EN^PSUAR5
"RTN","PSUAR0",38,0)
 Q
"RTN","PSUAR0",39,0)
EXIT ;EP for Cleaning up & Restoring variables
"RTN","PSUAR0",40,0)
 M Z=^XTMP(PSUARSUB,"SAVE")
"RTN","PSUAR0",41,0)
 K ^XTMP(PSUARJOB)
"RTN","PSUAR0",42,0)
 ; Kill PSU Variables
"RTN","PSUAR0",43,0)
 D VARKILL^PSUTL
"RTN","PSUAR0",44,0)
 ;      Restore Important Variables
"RTN","PSUAR0",45,0)
 S Y="" F  S Y=$O(Z(Y)) Q:Y=""  S @Y=Z(Y)
"RTN","PSUAR0",46,0)
 K Z
"RTN","PSUAR0",47,0)
 Q
"RTN","PSUAR1")
0^6^B32275020
"RTN","PSUAR1",1,0)
PSUAR1 ;BIR/PDW - Start AR/WS Extract ;11 AUG 1999
"RTN","PSUAR1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR1",3,0)
 ;;
"RTN","PSUAR1",4,0)
 ;PSUDTDA - IEN FOR DATE
"RTN","PSUAR1",5,0)
 ;PSUSDA - IEN FOR INPATIENT SITE
"RTN","PSUAR1",6,0)
 ;PSUDRDA - IEN FOR DRUG
"RTN","PSUAR1",7,0)
 ;PSUCDA - IEN FOR CATEGORY
"RTN","PSUAR1",8,0)
 ;PSUDIV - IEN FOR DIVISION OR "NONE"
"RTN","PSUAR1",9,0)
 ;
"RTN","PSUAR1",10,0)
 ;DBIAs
"RTN","PSUAR1",11,0)
 ; Reference to file #58.5  supported by DBIA 456
"RTN","PSUAR1",12,0)
 ; Reference to file #58.1  supported by DBIA 2515
"RTN","PSUAR1",13,0)
 ; Reference to file #59.4  supported by DBIA 2498
"RTN","PSUAR1",14,0)
 ; Reference to file #44    supported by DBIA 2439
"RTN","PSUAR1",15,0)
 ; Reference to file #40.8  supported by DBIA 2438
"RTN","PSUAR1",16,0)
 ; Reference to file #59    supported by DBIA 1876
"RTN","PSUAR1",17,0)
 ; Reference to file #59.7  supported by DBIA 2854
"RTN","PSUAR1",18,0)
 ;
"RTN","PSUAR1",19,0)
EN ;EP MAIN ENTRY POINT
"RTN","PSUAR1",20,0)
 ;
"RTN","PSUAR1",21,0)
 K PSUTDSP,PSUTRET
"RTN","PSUAR1",22,0)
 ;
"RTN","PSUAR1",23,0)
START ;Start date scan thru stats file
"RTN","PSUAR1",24,0)
 S PSUSDT=PSUSDT-.1
"RTN","PSUAR1",25,0)
 S PSUDT=PSUSDT
"RTN","PSUAR1",26,0)
 S PSUEDT=PSUEDT\1+.24
"RTN","PSUAR1",27,0)
Q F  S PSUDT=$O(^PSI(58.5,"B",PSUDT)) Q:'PSUDT  Q:PSUDT>PSUEDT  D DATE Q:$G(PSUQUIT)
"RTN","PSUAR1",28,0)
 Q
"RTN","PSUAR1",29,0)
DATE ;PROCESS ONE DATE - Loop through inpatient sites
"RTN","PSUAR1",30,0)
 S PSUDTDA=$O(^PSI(58.5,"B",PSUDT,0))
"RTN","PSUAR1",31,0)
 K PSUSITE
"RTN","PSUAR1",32,0)
 D GETM^PSUTL(58.5,PSUDTDA,"1*^.01","PSUSITE")
"RTN","PSUAR1",33,0)
 S PSUSDA=0
"RTN","PSUAR1",34,0)
 F  S PSUSDA=$O(PSUSITE(PSUSDA)) Q:PSUSDA'>0  D SITE Q:$G(PSUQUIT)
"RTN","PSUAR1",35,0)
 K PSUSITE
"RTN","PSUAR1",36,0)
 Q
"RTN","PSUAR1",37,0)
 ;
"RTN","PSUAR1",38,0)
SITE ;Process one site for one date
"RTN","PSUAR1",39,0)
 ; Find division for site for loading drug stats
"RTN","PSUAR1",40,0)
 S PSUDIV=$$DIV(PSUSDA,PSUDTDA)
"RTN","PSUAR1",41,0)
 ;
"RTN","PSUAR1",42,0)
 I PSUDIV="NULL" S PSUDIV=PSUSNDR
"RTN","PSUAR1",43,0)
 ;
"RTN","PSUAR1",44,0)
 ;    Process individual Drug information from 58.52
"RTN","PSUAR1",45,0)
 ;    Drug multiple loaded into PSUDRUG
"RTN","PSUAR1",46,0)
 K PSUDRUG
"RTN","PSUAR1",47,0)
 D GETM^PSUTL(58.501,"PSUDTDA,PSUSDA","2*^.01","PSUDRUG")
"RTN","PSUAR1",48,0)
 S PSUDRDA=0
"RTN","PSUAR1",49,0)
 F  S PSUDRDA=$O(PSUDRUG(PSUDRDA)) Q:PSUDRDA'>0  D DRUG Q:$G(PSUQUIT)
"RTN","PSUAR1",50,0)
 K PSUDRUG
"RTN","PSUAR1",51,0)
 ;
"RTN","PSUAR1",52,0)
 D MAP
"RTN","PSUAR1",53,0)
 ;    Process Amis categories from 58.501
"RTN","PSUAR1",54,0)
 ;    Category multiple loaded into PSUCAT
"RTN","PSUAR1",55,0)
 K PSUCAT
"RTN","PSUAR1",56,0)
CATEGORY ;EP Pull Categories
"RTN","PSUAR1",57,0)
 K PSUAMCAT
"RTN","PSUAR1",58,0)
 D GETM^PSUTL(58.501,"PSUDTDA,PSUSDA","1*^.01;1;2;3;4","PSUAMCAT","I")
"RTN","PSUAR1",59,0)
 ;
"RTN","PSUAR1",60,0)
 ;    Move (da,Fld,"I") values to (da,Fld) nodes
"RTN","PSUAR1",61,0)
 D MOVEMI^PSUTL("PSUAMCAT")
"RTN","PSUAR1",62,0)
 ;
"RTN","PSUAR1",63,0)
 ;   Gather totals for categories and accumulate in
"RTN","PSUAR1",64,0)
 ;   ^XTMP(PSUARSUB,"DIV_CAT",PSUDIV,PSUAMCAT,"DISP":COST")
"RTN","PSUAR1",65,0)
 N PSUDISP,PSUCOST
"RTN","PSUAR1",66,0)
 S PSUCDA=0 F  S PSUCDA=$O(PSUAMCAT(PSUCDA)) Q:PSUCDA'>0  D
"RTN","PSUAR1",67,0)
 . S PSUDISP=PSUAMCAT(PSUCDA,1)-PSUAMCAT(PSUCDA,3)
"RTN","PSUAR1",68,0)
 . S PSUCOST=PSUAMCAT(PSUCDA,2)-PSUAMCAT(PSUCDA,4)
"RTN","PSUAR1",69,0)
 . S PSUAMCAT=PSUAMCAT(PSUCDA,.01) ; "03"-"04"-"06" etc
"RTN","PSUAR1",70,0)
 . S X=$G(^XTMP(PSUARSUB,"DIV_CAT",PSUDIV,PSUAMCAT,"DISP"))
"RTN","PSUAR1",71,0)
 . S ^XTMP(PSUARSUB,"DIV_CAT",PSUDIV,PSUAMCAT,"DISP")=X+PSUDISP
"RTN","PSUAR1",72,0)
 . S X=$G(^XTMP(PSUARSUB,"DIV_CAT",PSUDIV,PSUAMCAT,"COST"))
"RTN","PSUAR1",73,0)
 . S ^XTMP(PSUARSUB,"DIV_CAT",PSUDIV,PSUAMCAT,"COST")=X+PSUCOST
"RTN","PSUAR1",74,0)
 . M ^XTMP("PSUTCST",PSUDIV,PSUAMCAT)=^XTMP(PSUARSUB,"DIV_CAT",PSUDIV,PSUAMCAT,"COST")
"RTN","PSUAR1",75,0)
 ;
"RTN","PSUAR1",76,0)
 Q
"RTN","PSUAR1",77,0)
 ;
"RTN","PSUAR1",78,0)
DRUG ;  Process one drug for one site for one day
"RTN","PSUAR1",79,0)
 ;  Load & loop categories within Drug
"RTN","PSUAR1",80,0)
 ;  total dispense & returns
"RTN","PSUAR1",81,0)
 ;  Category multiple loaded into PSUCAT
"RTN","PSUAR1",82,0)
 ;
"RTN","PSUAR1",83,0)
 S PSUDRIEN=$$VALI^PSUTL(58.52,"PSUDTDA,PSUSDA,PSUDRDA",.01)
"RTN","PSUAR1",84,0)
 K PSUCAT
"RTN","PSUAR1",85,0)
 D GETM^PSUTL(58.52,"PSUDTDA,PSUSDA,PSUDRDA","1*^.01;1","PSUCAT","I")
"RTN","PSUAR1",86,0)
 ;
"RTN","PSUAR1",87,0)
 S PSUCDA=0,PSUDISP=0,PSUTR=0
"RTN","PSUAR1",88,0)
 F  S PSUCDA=$O(PSUCAT(PSUCDA)) Q:PSUCDA'>0  Q:$G(PSUQUIT)  D
"RTN","PSUAR1",89,0)
 . S X=PSUCAT(PSUCDA,.01,"I")
"RTN","PSUAR1",90,0)
 . S Y=PSUCAT(PSUCDA,1,"I")
"RTN","PSUAR1",91,0)
 . I (X="A")!(X="W") S PSUDISP=PSUDISP+Y,PSUTDS=PSUDISP
"RTN","PSUAR1",92,0)
 . I (X="RA")!(X="RW") S PSUDISP=PSUDISP-Y,PSUTR=PSUTR+Y
"RTN","PSUAR1",93,0)
 ;  Adjust accumulative dispenses
"RTN","PSUAR1",94,0)
 ;
"RTN","PSUAR1",95,0)
 S X=$G(^XTMP(PSUARSUB,"DIV_DRUG",PSUDIV,PSUDRIEN))
"RTN","PSUAR1",96,0)
 S ^XTMP(PSUARSUB,"DIV_DRUG",PSUDIV,PSUDRIEN)=X+PSUDISP
"RTN","PSUAR1",97,0)
 ;
"RTN","PSUAR1",98,0)
 N PSUT
"RTN","PSUAR1",99,0)
 S PSUT=$G(PSUTDSP(PSUDIV,PSUDRIEN))
"RTN","PSUAR1",100,0)
 I $D(PSUTDS) D
"RTN","PSUAR1",101,0)
 .S PSUTDSP(PSUDIV,PSUDRIEN)=PSUTDS+PSUT    ;Total Quantity dispensed
"RTN","PSUAR1",102,0)
 .I (PSUTDS+PSUT)=0 S PSUTDSP(PSUDIV,PSUDRIEN)=""
"RTN","PSUAR1",103,0)
 ;
"RTN","PSUAR1",104,0)
 N PSUT1
"RTN","PSUAR1",105,0)
 S PSUT1=$G(PSUTRET(PSUDIV,PSUDRIEN))
"RTN","PSUAR1",106,0)
 I $D(PSUTR) D
"RTN","PSUAR1",107,0)
 .S PSUTRET(PSUDIV,PSUDRIEN)=PSUTR+PSUT1    ;Total Quantity returned
"RTN","PSUAR1",108,0)
 .I (PSUTR+PSUT1)=0 S PSUTRET(PSUDIV,PSUDRIEN)=""
"RTN","PSUAR1",109,0)
 K PSUCAT
"RTN","PSUAR1",110,0)
 Q
"RTN","PSUAR1",111,0)
DIV(PSUSDA,PSUDTDA) ;EP process for a site the associated divisions by date.
"RTN","PSUAR1",112,0)
 ; uses PSUSDA as entry for site ien in file 59.4 : returns division
"RTN","PSUAR1",113,0)
 ; as of 2/99 date is no longer used as a parameter
"RTN","PSUAR1",114,0)
 N PSUDIV,PSUDT
"RTN","PSUAR1",115,0)
 I '$D(^XTMP(PSUARSUB,"DIVLK",PSUSDA)) D AOU
"RTN","PSUAR1",116,0)
 ; ^XTMP(PSUARSUB,"DIVlk",Site IEN, AOU Inactive Date -1)=Division IEN
"RTN","PSUAR1",117,0)
 ;
"RTN","PSUAR1",118,0)
 ; if AOU did not set division then return null 
"RTN","PSUAR1",119,0)
 I '$D(^XTMP(PSUARSUB,"DIVLK",PSUSDA)) S PSUDIV="NULL" Q PSUDIV
"RTN","PSUAR1",120,0)
 ;
"RTN","PSUAR1",121,0)
 S PSUDIV=$O(^XTMP(PSUARSUB,"DIVLK",PSUSDA,""))
"RTN","PSUAR1",122,0)
 Q PSUDIV
"RTN","PSUAR1",123,0)
 ;
"RTN","PSUAR1",124,0)
AOU ;EP map divisions by dates for  inpatient sites from the AOU file
"RTN","PSUAR1",125,0)
 ;PSUADA - ien for AOU Stock file
"RTN","PSUAR1",126,0)
 ;
"RTN","PSUAR1",127,0)
 N PSUADA,PSUDIV,PSUINACT,PSUDIV,PSUSLOC,MAPLOCI
"RTN","PSUAR1",128,0)
 ;
"RTN","PSUAR1",129,0)
 D GETM^PSUTL(59.7,1,"90.01*^.01;.02;.03","MAPLOCI","I")
"RTN","PSUAR1",130,0)
 ;set array MAPLOCI(ien,fld)=internal value
"RTN","PSUAR1",131,0)
 ;field .02 points to 40.8 Medical Center Division where fac num is #1
"RTN","PSUAR1",132,0)
 ;field .03 points to 59 Outpatient site where site num is #.06
"RTN","PSUAR1",133,0)
 D MOVEMI^PSUTL("MAPLOCI")
"RTN","PSUAR1",134,0)
 ;
"RTN","PSUAR1",135,0)
 K ^XTMP(PSUARSUB,"DIVLK")
"RTN","PSUAR1",136,0)
 ;
"RTN","PSUAR1",137,0)
 S PSUADA=0
"RTN","PSUAR1",138,0)
 F  S PSUADA=$O(^PSI(58.1,"ASITE",PSUSDA,PSUADA)) Q:PSUADA'>0  D
"RTN","PSUAR1",139,0)
 . N PSUDIV S PSUDIV=""
"RTN","PSUAR1",140,0)
 . S PSUSLOC=$$VALI^PSUTL(59.4,PSUSDA,.01)
"RTN","PSUAR1",141,0)
 . S PSUINACT=$$VALI^PSUTL(58.1,PSUADA,3)
"RTN","PSUAR1",142,0)
 . I PSUINACT Q  ; inactivated sites are to be ignored regardles of date
"RTN","PSUAR1",143,0)
 . S:'PSUINACT PSUINACT=DT+1
"RTN","PSUAR1",144,0)
 . I '$G(MAPLOCI(PSUADA,.01)) S PSUDIV="NULL"
"RTN","PSUAR1",145,0)
 . I $G(MAPLOCI(PSUADA,.01)) D
"RTN","PSUAR1",146,0)
 .. S X=$G(MAPLOCI(PSUADA,.02)) I X S PSUDIV=$$VALI^PSUTL(40.8,X,1)
"RTN","PSUAR1",147,0)
 .. S X=$G(MAPLOCI(PSUADA,.03)) I X S PSUDIV=$$VALI^PSUTL(59,X,.06)
"RTN","PSUAR1",148,0)
 .. S ^XTMP(PSUARSUB,"DIVLK",PSUSDA,PSUDIV)=""
"RTN","PSUAR1",149,0)
 ;
"RTN","PSUAR1",150,0)
 Q
"RTN","PSUAR1",151,0)
 ;
"RTN","PSUAR1",152,0)
MAP ;Find out whether an Area of Use (AOU) is mapped to a division or
"RTN","PSUAR1",153,0)
 ;outpatient site.  If it is not mapped, store the NAME and INACTIVATION
"RTN","PSUAR1",154,0)
 ;DATE (if applicable) in a global to be mailed to the user.
"RTN","PSUAR1",155,0)
 ;
"RTN","PSUAR1",156,0)
 S PSUNAM=0                         ;This is the name of the Area of USE
"RTN","PSUAR1",157,0)
 ;
"RTN","PSUAR1",158,0)
 F  S PSUNAM=$O(^PSI(58.1,"B",PSUNAM)) Q:PSUNAM=""  D
"RTN","PSUAR1",159,0)
 .S IEN=0                        ;This is the IEN for file 58.1
"RTN","PSUAR1",160,0)
 .F  S IEN=$O(^PSI(58.1,"B",PSUNAM,IEN)) Q:IEN=""  D
"RTN","PSUAR1",161,0)
 ..K AOU
"RTN","PSUAR1",162,0)
 ..D GETS^PSUTL(58.1,IEN,".01;3","AOU(IEN)")  ;Name & Inactive Date
"RTN","PSUAR1",163,0)
 ..D MAP1
"RTN","PSUAR1",164,0)
 Q
"RTN","PSUAR1",165,0)
 ;
"RTN","PSUAR1",166,0)
MAP1 ;MAP continued. This subroutine takes the IEN from file 58.1 and looks
"RTN","PSUAR1",167,0)
 ;to see if it is in file 59.7, field 90.01.  If it is, then it has
"RTN","PSUAR1",168,0)
 ;been mapped if there is a value in subfield .02 or .03.
"RTN","PSUAR1",169,0)
 ;If there is no value in subfield .02 or .03 it has not been mapped
"RTN","PSUAR1",170,0)
 ;
"RTN","PSUAR1",171,0)
 ;Keep only the entries that are NOT mapped
"RTN","PSUAR1",172,0)
 ;
"RTN","PSUAR1",173,0)
 N PSUDA
"RTN","PSUAR1",174,0)
 ;
"RTN","PSUAR1",175,0)
 I $G(^PS(59.7,1,90.01,IEN,0)) D
"RTN","PSUAR1",176,0)
 .D GETM^PSUTL(59.7,1,"90.01*^.01;.02;.03","MAPLOCI")
"RTN","PSUAR1",177,0)
 .S PSUDA=0
"RTN","PSUAR1",178,0)
 .F  S PSUDA=$O(MAPLOCI(PSUDA)) Q:PSUDA=""  D
"RTN","PSUAR1",179,0)
 ..I MAPLOCI(PSUDA,.02)'="" K AOU(PSUDA)
"RTN","PSUAR1",180,0)
 ..I $G(MAPLOCI(PSUDA,.03))'="" K AOU(PSUDA)
"RTN","PSUAR1",181,0)
 M ^XTMP(PSUARSUB,"AOU")=AOU          ;Contains only unmapped locations
"RTN","PSUAR1",182,0)
 Q
"RTN","PSUAR1",183,0)
 ;
"RTN","PSUAR1",184,0)
CLEAR ;EP Clear ^XTMP("PSUAR*")
"RTN","PSUAR1",185,0)
 S X="PSUAR",Y=X
"RTN","PSUAR1",186,0)
 F  S Y=$O(^XTMP(Y)) Q:($E(Y,1,5)'=X)  W !,Y K ^XTMP(Y)
"RTN","PSUAR1",187,0)
 Q
"RTN","PSUAR2")
0^7^B11620969
"RTN","PSUAR2",1,0)
PSUAR2 ;BIR/PDW - ASSEMBLE AR/WS RECORDS FOR TRANSMISSION ;10 JUL 1999
"RTN","PSUAR2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR2",3,0)
 ; DBIA(s)
"RTN","PSUAR2",4,0)
 ; Reference to file #50 supported by DBIA 221
"RTN","PSUAR2",5,0)
 ;
"RTN","PSUAR2",6,0)
EN ;EP Build ("RECORDS") from scan of ^XTMP(PSUARSUB,"DIV_DRUG",Drug,Div)=Total
"RTN","PSUAR2",7,0)
 S PSUDRDA=0,PSULC=0,PSUDIVDA=0
"RTN","PSUAR2",8,0)
 K ^XTMP(PSUARSUB,"RECORDS")
"RTN","PSUAR2",9,0)
 K ^XTMP(PSUARSUB,"DRUG_TOTAL")
"RTN","PSUAR2",10,0)
 F  S PSUDIVDA=$O(^XTMP(PSUARSUB,"DIV_DRUG",PSUDIVDA)) Q:PSUDIVDA=""  D DRUGSCAN
"RTN","PSUAR2",11,0)
 Q
"RTN","PSUAR2",12,0)
 ;
"RTN","PSUAR2",13,0)
DRUGSCAN ;EP Scan for Drugs within division
"RTN","PSUAR2",14,0)
 S PSUDDRDA=0,PSULC=0 ;**1
"RTN","PSUAR2",15,0)
 F  S PSUDRDA=$O(^XTMP(PSUARSUB,"DIV_DRUG",PSUDIVDA,PSUDRDA)) Q:PSUDRDA'>0  S PSUTOT=^(PSUDRDA) D
"RTN","PSUAR2",16,0)
 . S PSULC=PSULC+1
"RTN","PSUAR2",17,0)
 . S ^XTMP(PSUARSUB,"RECORDS",PSUDIVDA,PSULC)=$$RECORD(PSUDRDA,PSUDIVDA,PSUTOT)
"RTN","PSUAR2",18,0)
 . S X=$G(^XTMP(PSUARSUB,"DRUG_TOTAL",PSUDRDA))
"RTN","PSUAR2",19,0)
 . S ^XTMP(PSUARSUB,"DRUG_TOTAL",PSUDRDA)=X+PSUTOT
"RTN","PSUAR2",20,0)
 Q
"RTN","PSUAR2",21,0)
 ;
"RTN","PSUAR2",22,0)
RECORD(PSUDRDA,PSUDIV,PSUTOT) ;EP Return record assembled
"RTN","PSUAR2",23,0)
 ;
"RTN","PSUAR2",24,0)
 ; @x@(Fld) holds the appropriate field values from the drug file 50
"RTN","PSUAR2",25,0)
 ;
"RTN","PSUAR2",26,0)
 N PSU,PSUP,PSUSEND,PSUDIVH
"RTN","PSUAR2",27,0)
 I '$D(^XTMP(PSUARSUB,"PSUDRUG_DET",PSUDRDA)) D DRUG(PSUDRDA)
"RTN","PSUAR2",28,0)
 S X="^XTMP(PSUARSUB,""PSUDRUG_DET"",PSUDRDA)"
"RTN","PSUAR2",29,0)
 ; piece  = value  @X@(field from file 50)
"RTN","PSUAR2",30,0)
 ;   Process for sender being division or site 
"RTN","PSUAR2",31,0)
 S PSUSEND=PSUDIV,PSUDIVH=""
"RTN","PSUAR2",32,0)
 I PSUDIV["_0H" S PSUSEND=$G(PSUSNDR),PSUDIVH="H"
"RTN","PSUAR2",33,0)
 S PSU(2)=PSUSEND
"RTN","PSUAR2",34,0)
 S PSU(3)=PSUDIVH
"RTN","PSUAR2",35,0)
 S PSU(4)=$G(PSUMON)
"RTN","PSUAR2",36,0)
 S PSU(5)=@X@(21)
"RTN","PSUAR2",37,0)
 S PSU(6)=@X@(2)
"RTN","PSUAR2",38,0)
 S PSU(7)=@X@(31)
"RTN","PSUAR2",39,0)
 S PSU(8)=@X@(.01)
"RTN","PSUAR2",40,0)
 S PSU(9)=@X@(51)
"RTN","PSUAR2",41,0)
 S PSU(10)=@X@(99999.17) ;indicator for National Formulary
"RTN","PSUAR2",42,0)
 S PSU(11)=@X@(99999.18) ;Indicator for National Formulary Restriction
"RTN","PSUAR2",43,0)
 S PSU(12)=@X@(14.5)
"RTN","PSUAR2",44,0)
 S PSU(13)=@X@(16)
"RTN","PSUAR2",45,0)
 S PSU(14)=@X@(301)
"RTN","PSUAR2",46,0)
 S PSU(15)=@X@(302)
"RTN","PSUAR2",47,0)
 S PSU(16)=$G(PSUTOT)
"RTN","PSUAR2",48,0)
 S PSU(17)=@X@(52)
"RTN","PSUAR2",49,0)
 S PSU(18)=@X@(3)
"RTN","PSUAR2",50,0)
 S PSU(19)=$G(PSUTDSP(PSUDIVDA,PSUDRDA))    ;Quantity Dispensed
"RTN","PSUAR2",51,0)
 S PSU(20)=$G(PSUTRET(PSUDIVDA,PSUDRDA))    ;Quantity Returned
"RTN","PSUAR2",52,0)
 S PSUP=0
"RTN","PSUAR2",53,0)
 F  S PSUP=$O(PSU(PSUP)) Q:PSUP'>0  S PSU(PSUP)=$TR(PSU(PSUP),"^","'")
"RTN","PSUAR2",54,0)
 S PSUP=0
"RTN","PSUAR2",55,0)
 F  S PSUP=$O(PSU(PSUP)) Q:PSUP'>0  S $P(PSU,"^",PSUP)=PSU(PSUP)
"RTN","PSUAR2",56,0)
 S PSU=PSU_"^"
"RTN","PSUAR2",57,0)
 Q PSU
"RTN","PSUAR2",58,0)
 ;
"RTN","PSUAR2",59,0)
DRUG(PSUDRDA) ;EP assemble from file 50+ needed fields
"RTN","PSUAR2",60,0)
 ;    PSUDRDA is da for the DRUG in file 50 from (58.52,.01)
"RTN","PSUAR2",61,0)
 ;    Store the fields in ^XTMP(PSUARSUB,"PSUDRUG_DET",PSUDDA,Field)=value
"RTN","PSUAR2",62,0)
 N PSUDRUG,PSUNDF
"RTN","PSUAR2",63,0)
 D GETS^PSUTL(50,PSUDRDA,".01;2;14.5;15;16;20;21;22;25;31;51;301;302;52;3","PSUDRUG","I")
"RTN","PSUAR2",64,0)
 ;    Move PSUDRUG(Field,"I") value to PSUDRUG(Field) nodes
"RTN","PSUAR2",65,0)
 D MOVEI^PSUTL("PSUDRUG")
"RTN","PSUAR2",66,0)
 ;
"RTN","PSUAR2",67,0)
PROCESS ;Further process field values into their final values
"RTN","PSUAR2",68,0)
 ;
"RTN","PSUAR2",69,0)
 S PSUDRUG(51)=$$VAL^PSUTL(50,PSUDRDA,51)
"RTN","PSUAR2",70,0)
 I PSUDRUG(31)="" S PSUDRUG(31)="No NDC"
"RTN","PSUAR2",71,0)
 I PSUDRUG(21)="" S PSUDRUG(21)="Unknown VA Product Name"
"RTN","PSUAR2",72,0)
 I PSUDRUG(.01)="" S PSUDRUG(.01)="Unknown Generic Name"
"RTN","PSUAR2",73,0)
 S X=+PSUDRUG(301)
"RTN","PSUAR2",74,0)
 S PSUDRUG(301)=$S(X=0:"03 or 04",X=1:"06 or 07",2:"17",3:"22",1:X)
"RTN","PSUAR2",75,0)
 I PSUDRUG(52) S PSUDRUG(52)="N/F"
"RTN","PSUAR2",76,0)
 ;
"RTN","PSUAR2",77,0)
 ;    Process VA DRUG CLASS
"RTN","PSUAR2",78,0)
 ;    Test for new NDF software s PSUNDF=1 if yes
"RTN","PSUAR2",79,0)
 S PSUNDF=0
"RTN","PSUAR2",80,0)
 I $$VERSION^XPDUTL("PSN")'<4 S PSUNDF=1
"RTN","PSUAR2",81,0)
 ;
"RTN","PSUAR2",82,0)
 ;    Process for National Formulary Indicator & Restrictions
"RTN","PSUAR2",83,0)
 ;    Put into node 99999.17  for file(50.68,17)
"RTN","PSUAR2",84,0)
 ;    Put into node 99999.18  for file(50.68,18)
"RTN","PSUAR2",85,0)
 ;    test to see if file 50.68 exists (comes in with V4 of NDF)
"RTN","PSUAR2",86,0)
 S PSUDRUG(99999.17)=""
"RTN","PSUAR2",87,0)
 S PSUDRUG(99999.18)=""
"RTN","PSUAR2",88,0)
 I 'PSUNDF G STORE
"RTN","PSUAR2",89,0)
 ;    Process for National Formulary Indicator from VA Product Name file
"RTN","PSUAR2",90,0)
 S PSUVPNDA=PSUDRUG(22)
"RTN","PSUAR2",91,0)
 I PSUNDF S PSUDRUG(99999.17)=$$FORMI^PSNAPIS(PSUDRUG(20),PSUDRUG(22))
"RTN","PSUAR2",92,0)
 ;    Process for National Formulary Restriction
"RTN","PSUAR2",93,0)
 I PSUNDF S PSUDRUG(99999.18)=$$FORMR^PSNAPIS(PSUDRUG(20),PSUDRUG(22))
"RTN","PSUAR2",94,0)
 K PSUNFR
"RTN","PSUAR2",95,0)
 ;
"RTN","PSUAR2",96,0)
STORE ;Store the processed values into ^TMP
"RTN","PSUAR2",97,0)
 M ^XTMP(PSUARSUB,"PSUDRUG_DET",PSUDRDA)=PSUDRUG
"RTN","PSUAR2",98,0)
 Q
"RTN","PSUAR2",99,0)
 ;
"RTN","PSUAR2",100,0)
REC ;EP Move PSUAR_RECORDS to PSUAREC)
"RTN","PSUAR2",101,0)
 M ^XTMP(PSUARSUB,"PSUAREC")=^XTMP(PSUARSUB,"RECORDS",$J)
"RTN","PSUAR2",102,0)
 Q
"RTN","PSUAR3")
0^8^B9346593
"RTN","PSUAR3",1,0)
PSUAR3 ;BIR/PDW - PBM AR/WS EXTRACT DETAILED MAIL GENERATOR ;10 JUL 1999
"RTN","PSUAR3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR3",3,0)
 ; DBIA(s)
"RTN","PSUAR3",4,0)
 ; Reference to file  #4.3 supported by DBIA 2496
"RTN","PSUAR3",5,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUAR3",6,0)
 ;PSULC  = Line processing in ^tmp
"RTN","PSUAR3",7,0)
 ;PSUTLC = Total Line count
"RTN","PSUAR3",8,0)
 ;PSUMC  = Message counter
"RTN","PSUAR3",9,0)
 ;PSUMLC = Message Line Counter
"RTN","PSUAR3",10,0)
 ; RETURNS 
"RTN","PSUAR3",11,0)
 ;PSUMSG("M") = # Messages
"RTN","PSUAR3",12,0)
 ;PSUMSG("L") = # Lines
"RTN","PSUAR3",13,0)
 ;
"RTN","PSUAR3",14,0)
EN(PSUMSG) ;Scan and process for Division(s)
"RTN","PSUAR3",15,0)
 ; PSUMSGT ("M")= # MESSAGES  ("L")= # LINES
"RTN","PSUAR3",16,0)
 ;
"RTN","PSUAR3",17,0)
 ;   restore variables
"RTN","PSUAR3",18,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,ZTIO,PSUSNDR,PSUOPTS"
"RTN","PSUAR3",19,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P(^XTMP("PSU_"_PSUJOB,1),U,I)
"RTN","PSUAR3",20,0)
 ;S PSUMSG(PSUDIV,3,"M")=0,PSUMSG("L")=0
"RTN","PSUAR3",21,0)
 I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D
"RTN","PSUAR3",22,0)
 .I '$D(^XTMP(PSUARSUB,"RECORDS")) D NODATA Q
"RTN","PSUAR3",23,0)
 .S PSUDIV=0,Z=0
"RTN","PSUAR3",24,0)
 .F  S PSUDIV=$O(^XTMP(PSUARSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR3",25,0)
 .. D XMD^PSUAR3(.Z) ; ==> process one division
"RTN","PSUAR3",26,0)
 .. S PSUMSG(PSUDIV,3,"M")=$G(PSUMSG(PSUDIV,3,"M"))+Z("M")
"RTN","PSUAR3",27,0)
 .. S PSUMSG(PSUDIV,3,"L")=$G(PSUMSG(PSUDIV,3,"L"))+Z("L")
"RTN","PSUAR3",28,0)
 Q
"RTN","PSUAR3",29,0)
XMD(PSUMSG) ;EP returns PSUMSG("M")= # MESSAGES ("L")= # LINES
"RTN","PSUAR3",30,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUAR3",31,0)
 ; Scan TMP, split lines, transmit per MAX lines in Netmail
"RTN","PSUAR3",32,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUAR3",33,0)
 S:PSUMAX'>0 PSUMAX=10000
"RTN","PSUAR3",34,0)
 ;
"RTN","PSUAR3",35,0)
 ;   Split and store into ^XTMP(PSUARSUB,"XMD",PSUMC,PSUMLC)
"RTN","PSUAR3",36,0)
 K ^XTMP(PSUARSUB,"XMD")
"RTN","PSUAR3",37,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUAR3",38,0)
 F PSULC=1:1 S X=$G(^XTMP(PSUARSUB,"RECORDS",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSUAR3",39,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUAR3",40,0)
 . I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC+1 Q  ; +  message
"RTN","PSUAR3",41,0)
 . I $L(X)<235 S ^XTMP(PSUARSUB,"XMD",PSUMC,PSUMLC)=X Q
"RTN","PSUAR3",42,0)
 . F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUAR3",43,0)
 . S ^XTMP(PSUARSUB,"XMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUAR3",44,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUAR3",45,0)
 . S ^XTMP(PSUARSUB,"XMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUAR3",46,0)
 ;
"RTN","PSUAR3",47,0)
 ;   Count Lines sent
"RTN","PSUAR3",48,0)
 S PSUTLC=0
"RTN","PSUAR3",49,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSUARSUB,"XMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUAR3",50,0)
 ;
"RTN","PSUAR3",51,0)
 ;   Transmit Messages
"RTN","PSUAR3",52,0)
VARS ; Setup variables for contents
"RTN","PSUAR3",53,0)
 F PSUM=1:1:PSUMC D
"RTN","PSUAR3",54,0)
 . S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUAR3",55,0)
 . S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR3",56,0)
 . S XMSUB="V. 4.0 PBMAR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUAR3",57,0)
 . S XMTEXT="^XTMP(PSUARSUB,""XMD"",PSUM,"
"RTN","PSUAR3",58,0)
 . S XMDUZ=DUZ
"RTN","PSUAR3",59,0)
 . M XMY=PSUXMYH
"RTN","PSUAR3",60,0)
 . S XMCHAN=1
"RTN","PSUAR3",61,0)
 . I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D
"RTN","PSUAR3",62,0)
 ..I '$G(PSUSMRY) D ^XMD
"RTN","PSUAR3",63,0)
 ;
"RTN","PSUAR3",64,0)
 S PSUMSG("M")=PSUMC
"RTN","PSUAR3",65,0)
 S PSUMSG("L")=PSUTLC
"RTN","PSUAR3",66,0)
 M ^XTMP(PSUARSUB,"MSGCOUNT")=PSUMSG ; 
"RTN","PSUAR3",67,0)
 Q
"RTN","PSUAR3",68,0)
 ;
"RTN","PSUAR3",69,0)
NODATA ;EP Build a NODATA Message
"RTN","PSUAR3",70,0)
 S PSUDIV=PSUSNDR
"RTN","PSUAR3",71,0)
 S PSUMSG(PSUDIV,11,"M")=PSUMASF,PSUMSG(PSUDIV,11,"L")=0
"RTN","PSUAR3",72,0)
 S XMDUZ=DUZ
"RTN","PSUAR3",73,0)
 M XMY=PSUXMYH
"RTN","PSUAR3",74,0)
 S (X,PSUDIV)=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUAR3",75,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR3",76,0)
 S PSUM=1,PSUMC=1
"RTN","PSUAR3",77,0)
 S XMSUB="V 4.0 PBMAR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUAR3",78,0)
 N X
"RTN","PSUAR3",79,0)
 S X(1)="No data to report"
"RTN","PSUAR3",80,0)
 S XMTEXT="X("
"RTN","PSUAR3",81,0)
 S XMCHAN=1
"RTN","PSUAR3",82,0)
 ;I $G(PSUMASF) D ^XMD
"RTN","PSUAR3",83,0)
 D ^XMD
"RTN","PSUAR3",84,0)
 S PSUMSG(PSUDIV,3,"M")=1,PSUMSG(PSUDIV,3,"L")=0
"RTN","PSUAR3",85,0)
 Q
"RTN","PSUAR4")
0^9^B13068784
"RTN","PSUAR4",1,0)
PSUAR4 ;BIR/PDW - AR/WS SUMMARY MAILMESSAGES ;25 SEP 1998
"RTN","PSUAR4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR4",3,0)
 ;DBIAs
"RTN","PSUAR4",4,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUAR4",5,0)
 ; Reference to file #50   supported by DBIA 221
"RTN","PSUAR4",6,0)
 ;
"RTN","PSUAR4",7,0)
EN ;EP Generate mail message summaries
"RTN","PSUAR4",8,0)
 ;    also store image for printed reports
"RTN","PSUAR4",9,0)
 ;
"RTN","PSUAR4",10,0)
 D DRUGSUM
"RTN","PSUAR4",11,0)
 ;
"RTN","PSUAR4",12,0)
 Q
"RTN","PSUAR4",13,0)
 ;
"RTN","PSUAR4",14,0)
DRUGSUM ;EP Generate Drug Summary Message(s) by DIV
"RTN","PSUAR4",15,0)
 ;     ^XTMP(PSUARSUB,"DIV_DRUG",PSUDIV)=Total Dispenses ;from PSUAR2
"RTN","PSUAR4",16,0)
 S PSUDIV=0
"RTN","PSUAR4",17,0)
 F  S PSUDIV=$O(^XTMP(PSUARSUB,"DIV_DRUG",PSUDIV)) Q:PSUDIV=""  D DRUGXMD
"RTN","PSUAR4",18,0)
 Q
"RTN","PSUAR4",19,0)
 ;
"RTN","PSUAR4",20,0)
DRUGXMD ;EP Generate Mail Message with PSUDIV provided
"RTN","PSUAR4",21,0)
 ;   Assemble top of message
"RTN","PSUAR4",22,0)
 ;   Find Division Name
"RTN","PSUAR4",23,0)
 I '$D(^XTMP(PSUARSUB,"DIV_DRUG")) Q
"RTN","PSUAR4",24,0)
 ;
"RTN","PSUAR4",25,0)
 K DIC
"RTN","PSUAR4",26,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUAR4",27,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR4",28,0)
 S XMSUB="V. 4.0 PBMAR "_$G(PSUMON)_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUAR4",29,0)
 M XMY=PSUXMYS2
"RTN","PSUAR4",30,0)
 S XMDUZ=DUZ
"RTN","PSUAR4",31,0)
 S XMTEXT="PSUMSG("
"RTN","PSUAR4",32,0)
 S XMCHAN=1
"RTN","PSUAR4",33,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUAR4",34,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUAR4",35,0)
 N PSUMSG
"RTN","PSUAR4",36,0)
 S PSUMSG(1)="           Automatic Replenishment/Ward Stock Data Summary"
"RTN","PSUAR4",37,0)
 S PSUMSG(2)="           "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUAR4",38,0)
 S PSUMSG(3)="      "
"RTN","PSUAR4",39,0)
 S X=""
"RTN","PSUAR4",40,0)
 S X=$$SETSTR^VALM1("Total",X,40,5)
"RTN","PSUAR4",41,0)
 S X=$$SETSTR^VALM1("Total",X,52,5)
"RTN","PSUAR4",42,0)
 S PSUMSG(4)=X
"RTN","PSUAR4",43,0)
 S X="",X=$$SETSTR^VALM1("Dispensed",X,40,9),X=$$SETSTR^VALM1("Dispensed",X,52,9),X=$$SETSTR^VALM1("AMIS",X,64,4)
"RTN","PSUAR4",44,0)
 S PSUMSG(5)=X
"RTN","PSUAR4",45,0)
 S X="DRUG NAME",X=$$SETSTR^VALM1("Units",X,40,5),X=$$SETSTR^VALM1("Cost",X,52,4),X=$$SETSTR^VALM1("Category",X,64,8)
"RTN","PSUAR4",46,0)
 S PSUMSG(6)=X
"RTN","PSUAR4",47,0)
 S X="",$P(X,"-",79)=""
"RTN","PSUAR4",48,0)
 S PSUMSG(7)=X
"RTN","PSUAR4",49,0)
 ;
"RTN","PSUAR4",50,0)
 ; Drug Data: Move into local array ^TMP($J,"PSUDRUG",da)=Total dispenses
"RTN","PSUAR4",51,0)
 K ^TMP($J,"PSUDRUG")
"RTN","PSUAR4",52,0)
 M ^TMP($J,"PSUDRUG")=^XTMP(PSUARSUB,"DIV_DRUG",PSUDIV)
"RTN","PSUAR4",53,0)
 ;
"RTN","PSUAR4",54,0)
 ; alphabetize the list of drugs into PSUDRNM()=PSUDRDA
"RTN","PSUAR4",55,0)
 K ^TMP($J,"PSUDRNM")
"RTN","PSUAR4",56,0)
 S PSUDRDA=0 F  S PSUDRDA=$O(^TMP($J,"PSUDRUG",PSUDRDA)) Q:'PSUDRDA  S ^TMP($J,"PSUDRNM",$$VAL^PSUTL(50,PSUDRDA,.01))=PSUDRDA
"RTN","PSUAR4",57,0)
 ;
"RTN","PSUAR4",58,0)
 ;     Build the drug lines of the message
"RTN","PSUAR4",59,0)
 S PSUNM="",PSUTDISP=0,PSUCOSTT=0
"RTN","PSUAR4",60,0)
 F PSULC=8:1 S PSUNM=$O(^TMP($J,"PSUDRNM",PSUNM)) Q:PSUNM=""  D
"RTN","PSUAR4",61,0)
 . S PSUDRDA=^TMP($J,"PSUDRNM",PSUNM)
"RTN","PSUAR4",62,0)
 . ; retrieve drug details
"RTN","PSUAR4",63,0)
 . K PSUD,PSUCAT
"RTN","PSUAR4",64,0)
 . M PSUD=^XTMP(PSUARSUB,"PSUDRUG_DET",PSUDRDA)
"RTN","PSUAR4",65,0)
 . S PSUDISP=^XTMP(PSUARSUB,"DIV_DRUG",PSUDIV,PSUDRDA)
"RTN","PSUAR4",66,0)
 . S PSUCOST=PSUD(16)
"RTN","PSUAR4",67,0)
 . S PSUTCOST=PSUDISP*PSUCOST*100\1/100
"RTN","PSUAR4",68,0)
 . S PSUNFI=PSUD(99999.17),PSUNFI=$S(PSUNFI="":" ",PSUNFI=1:"",1:"#")
"RTN","PSUAR4",69,0)
 . S PSUNONF=PSUD(51),PSUNONF=$S(PSUNONF:"*",1:" ")
"RTN","PSUAR4",70,0)
 . S PSUNMT=$E(PSUNM,1,35)_PSUNONF_PSUNFI
"RTN","PSUAR4",71,0)
 . S PSUCAT=PSUD(301)
"RTN","PSUAR4",72,0)
 . S X=PSUNMT
"RTN","PSUAR4",73,0)
 . S X=$$SETSTR^VALM1($J(PSUDISP,8,2),X,40,8)
"RTN","PSUAR4",74,0)
 . S X=$$SETSTR^VALM1($J(PSUTCOST,8,2),X,52,8)
"RTN","PSUAR4",75,0)
 . S X=$$SETSTR^VALM1(PSUCAT,X,64,$L(PSUCAT))
"RTN","PSUAR4",76,0)
 . S PSUMSG(PSULC)=X
"RTN","PSUAR4",77,0)
 . S PSUTDISP=PSUTDISP+PSUDISP,PSUCOSTT=PSUCOSTT+PSUTCOST
"RTN","PSUAR4",78,0)
 ;
"RTN","PSUAR4",79,0)
 S X=""
"RTN","PSUAR4",80,0)
 S $P(X,"-",79)=""
"RTN","PSUAR4",81,0)
 S PSUMSG(PSULC)=X
"RTN","PSUAR4",82,0)
 S X="TOTALS",X=$$SETSTR^VALM1($J(PSUTDISP,8,2),X,40,8),X=$$SETSTR^VALM1($J(PSUCOSTT,8,2),X,52,8)
"RTN","PSUAR4",83,0)
 S PSUMSG(PSULC+1)=X
"RTN","PSUAR4",84,0)
 S PSUMSG(PSULC+2)=" "
"RTN","PSUAR4",85,0)
 S PSUMSG(PSULC+3)="* Non-Formulary"
"RTN","PSUAR4",86,0)
 S PSUMSG(PSULC+4)="# Not on National Formulary"
"RTN","PSUAR4",87,0)
 S PSUMSG(PSULC+5)="   "
"RTN","PSUAR4",88,0)
 ;
"RTN","PSUAR4",89,0)
 I '$G(PSUSMRY) D ^XMD
"RTN","PSUAR4",90,0)
 M ^XTMP(PSUARSUB,"REPORT2",PSUDIV)=PSUMSG
"RTN","PSUAR4",91,0)
 Q
"RTN","PSUAR5")
0^10^B5075475
"RTN","PSUAR5",1,0)
PSUAR5 ;BIR/PDW - PRINT CYCLE CONTROLLER ;25 AUG 1998
"RTN","PSUAR5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR5",3,0)
EN ;EP for printing reports
"RTN","PSUAR5",4,0)
 N PSUQUIT
"RTN","PSUAR5",5,0)
 S PSUPG=0
"RTN","PSUAR5",6,0)
CATRPT ;
"RTN","PSUAR5",7,0)
 ; Printing Device should be opened by PSUDBQUE by now & IO set
"RTN","PSUAR5",8,0)
 ;For summary print for each division
"RTN","PSUAR5",9,0)
 I '$D(PSUARSUB) S PSUARSUB="PSUAR_"_PSUJOB
"RTN","PSUAR5",10,0)
 S PSUDIV=0 F  S PSUDIV=$O(^XTMP(PSUARSUB,"REPORT1",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR5",11,0)
 . S L="" F  S L=$O(^XTMP(PSUARSUB,"REPORT1",PSUDIV,L)) Q:L=""  S X=^(L) U IO W !,X I L=2 W !,?60,"PAGE: 1"
"RTN","PSUAR5",12,0)
 .;VMP-IOFO BAY PINES;ELR;PSU*3.0*26 - REMOVED FORM FEED
"RTN","PSUAR5",13,0)
 . ;U IO W @IOF
"RTN","PSUAR5",14,0)
 ;
"RTN","PSUAR5",15,0)
 D DRUGRPT
"RTN","PSUAR5",16,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D PRTAMIS  ;Print AR/WS AMIS report
"RTN","PSUAR5",17,0)
 Q
"RTN","PSUAR5",18,0)
 ;
"RTN","PSUAR5",19,0)
PRTAMIS ;Print AMIS summary report
"RTN","PSUAR5",20,0)
 ;
"RTN","PSUAR5",21,0)
 S PSUPGS("PG")=1
"RTN","PSUAR5",22,0)
 D PGHDR1
"RTN","PSUAR5",23,0)
 S PSUL=4
"RTN","PSUAR5",24,0)
 F  S PSUL=$O(^XTMP("PSU_"_PSUJOB,"ARAMIS",PSUL)) Q:PSUL=""  D
"RTN","PSUAR5",25,0)
 .I (LNCNT+4)>IOSL D PGHDR1
"RTN","PSUAR5",26,0)
 .W !,^XTMP("PSU_"_PSUJOB,"ARAMIS",PSUL)
"RTN","PSUAR5",27,0)
 .S LNCNT=LNCNT+1
"RTN","PSUAR5",28,0)
 Q
"RTN","PSUAR5",29,0)
 ;
"RTN","PSUAR5",30,0)
DRUGRPT ; Print Drug Summary
"RTN","PSUAR5",31,0)
 S PSUDIV=0 F  S PSUDIV=$O(^XTMP(PSUARSUB,"REPORT2",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR5",32,0)
 . S PSUPG("PG")=1 D PGHDR S L=7 F  S L=$O(^XTMP(PSUARSUB,"REPORT2",PSUDIV,L)) Q:L=""  S X=^(L) U IO W !,X I $Y+4>IOSL D PG Q:$G(PSUQUIT)
"RTN","PSUAR5",33,0)
 . U IO W @IOF
"RTN","PSUAR5",34,0)
 Q
"RTN","PSUAR5",35,0)
 ;
"RTN","PSUAR5",36,0)
PG ;EP  Page controller
"RTN","PSUAR5",37,0)
 S PSUQUIT=0
"RTN","PSUAR5",38,0)
 I $Y<(IOSL-4) Q
"RTN","PSUAR5",39,0)
 S:'$D(PSUPG("PG")) PSUPG("PG")=0 S PSUPG("PG")=PSUPG("PG")+1
"RTN","PSUAR5",40,0)
 I $E(IOST)="C" K DIR S DIR(0)="E" D ^DIR I ($G(DIROUT)!$G(DUOUT)!$G(DTOUT)!$G(DROUT)) S PSUQUIT=1
"RTN","PSUAR5",41,0)
 ;
"RTN","PSUAR5",42,0)
PGHDR ;PAGE HEADER
"RTN","PSUAR5",43,0)
 U IO W @IOF
"RTN","PSUAR5",44,0)
 F I=1,2 W !,^XTMP(PSUARSUB,"REPORT2",PSUDIV,I)
"RTN","PSUAR5",45,0)
 W !,?60,"Page: ",PSUPG("PG")
"RTN","PSUAR5",46,0)
 F I=4:1:7 I $D(^XTMP(PSUARSUB,"REPORT2",PSUDIV,I)) W !,^(I)
"RTN","PSUAR5",47,0)
 Q
"RTN","PSUAR5",48,0)
PGHDR1 ; Write Page Header (SUBJECT of MAILMESSAGE)
"RTN","PSUAR5",49,0)
 U IO W @IOF
"RTN","PSUAR5",50,0)
 F I=1,2 W !,^XTMP("PSU_"_PSUJOB,"ARAMIS",I)
"RTN","PSUAR5",51,0)
 W !,?68,"Page: ",PSUPG("PG")
"RTN","PSUAR5",52,0)
 S PSUPG("PG")=PSUPG("PG")+1
"RTN","PSUAR5",53,0)
 S LNCNT=3
"RTN","PSUAR5",54,0)
 Q
"RTN","PSUAR6")
0^11^B100733277
"RTN","PSUAR6",1,0)
PSUAR6 ;BIR/DAM - AR/WS AMIS Summary Data;11 March 2004
"RTN","PSUAR6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR6",3,0)
 ;
"RTN","PSUAR6",4,0)
 ;This routine gathers AR/WS DOSES AMIS Summary data
"RTN","PSUAR6",5,0)
 ;No DBIA's needed
"RTN","PSUAR6",6,0)
 ;
"RTN","PSUAR6",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUAR0
"RTN","PSUAR6",8,0)
 ;
"RTN","PSUAR6",9,0)
 K PSUAR     ;Arrays to hold temporary data
"RTN","PSUAR6",10,0)
 N TRUNC,TOT,NET
"RTN","PSUAR6",11,0)
 S PSUDV=0
"RTN","PSUAR6",12,0)
 F  S PSUDV=$O(^XTMP(PSUARSUB,"RECORDS",PSUDV)) Q:PSUDV=""  D
"RTN","PSUAR6",13,0)
 .S PSUCT=0
"RTN","PSUAR6",14,0)
 .F  S PSUCT=$O(^XTMP(PSUARSUB,"RECORDS",PSUDV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUAR6",15,0)
 ..K PSUAMIS
"RTN","PSUAR6",16,0)
 ..M PSUAMIS(PSUDV,PSUCT)=^XTMP(PSUARSUB,"RECORDS",PSUDV,PSUCT)
"RTN","PSUAR6",17,0)
 ..S PSUCAT=""
"RTN","PSUAR6",18,0)
 ..S PSUCAT=$P($G(PSUAMIS(PSUDV,PSUCT)),U,14)   ;AMIS Category
"RTN","PSUAR6",19,0)
 ..D DSP
"RTN","PSUAR6",20,0)
 ..D RET
"RTN","PSUAR6",21,0)
 ..D NET
"RTN","PSUAR6",22,0)
 ..D TCOST
"RTN","PSUAR6",23,0)
 .D AVE
"RTN","PSUAR6",24,0)
 D TOTAL
"RTN","PSUAR6",25,0)
 D EN^PSUAR7    ;Compose and send MailMan message
"RTN","PSUAR6",26,0)
 Q
"RTN","PSUAR6",27,0)
 ;
"RTN","PSUAR6",28,0)
DSP ;Calculate AR/WS  dispensed data
"RTN","PSUAR6",29,0)
 ;
"RTN","PSUAR6",30,0)
 N DSP,DUNT,DFLD,DBLD
"RTN","PSUAR6",31,0)
 I PSUCAT="03 or 04" D                      ;Doses Data
"RTN","PSUAR6",32,0)
 .S DSP=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",33,0)
 .I DSP="" S DSP=0
"RTN","PSUAR6",34,0)
 .S $P(PSUAR("DSP",PSUDV),U,1)=$P($G(PSUAR("DSP",PSUDV)),U,1)+DSP
"RTN","PSUAR6",35,0)
 ;
"RTN","PSUAR6",36,0)
 I PSUCAT="06 or 07" D                      ;Units Data
"RTN","PSUAR6",37,0)
 .S DUNT=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",38,0)
 .S:DUNT="" DUNT=0
"RTN","PSUAR6",39,0)
 .S $P(PSUAR("UNIT",PSUDV),U,1)=$P($G(PSUAR("UNIT",PSUDV)),U,1)+DUNT
"RTN","PSUAR6",40,0)
 ;
"RTN","PSUAR6",41,0)
 I PSUCAT=17 D                              ;Fluids/sets data
"RTN","PSUAR6",42,0)
 .S DFLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",43,0)
 .S:DFLD="" DFLD=0
"RTN","PSUAR6",44,0)
 .S $P(PSUAR("FLD",PSUDV),U,1)=$P($G(PSUAR("FLD",PSUDV)),U,1)+DFLD
"RTN","PSUAR6",45,0)
 ;
"RTN","PSUAR6",46,0)
 I PSUCAT=22 D                              ;Blood products data
"RTN","PSUAR6",47,0)
 .S DBLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",48,0)
 .S:DBLD="" DBLD=0
"RTN","PSUAR6",49,0)
 .S $P(PSUAR("BLD",PSUDV),U,1)=$P($G(PSUAR("BLD",PSUDV)),U,1)+DBLD
"RTN","PSUAR6",50,0)
 Q
"RTN","PSUAR6",51,0)
RET ;Calculate AR/WS returned data
"RTN","PSUAR6",52,0)
 ;
"RTN","PSUAR6",53,0)
 N RET,RUNT,RFLD,RBLD
"RTN","PSUAR6",54,0)
 I PSUCAT="03 or 04" D                      ;Doses data
"RTN","PSUAR6",55,0)
 .S RET=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",56,0)
 .I RET="" S RET=0
"RTN","PSUAR6",57,0)
 .S $P(PSUAR("DSP",PSUDV),U,2)=$P($G(PSUAR("DSP",PSUDV)),U,2)+RET
"RTN","PSUAR6",58,0)
 ;
"RTN","PSUAR6",59,0)
 I PSUCAT="06 or 07" D                      ;Unit data
"RTN","PSUAR6",60,0)
 .S RUNT=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",61,0)
 .I RUNT="" S RUNT=0
"RTN","PSUAR6",62,0)
 .S $P(PSUAR("UNIT",PSUDV),U,2)=$P($G(PSUAR("UNIT",PSUDV)),U,2)+RUNT
"RTN","PSUAR6",63,0)
 ;
"RTN","PSUAR6",64,0)
 I PSUCAT=17 D                              ;Fluids/sets data
"RTN","PSUAR6",65,0)
 .S RFLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",66,0)
 .I RFLD="" S RFLD=0
"RTN","PSUAR6",67,0)
 .S $P(PSUAR("FLD",PSUDV),U,2)=$P($G(PSUAR("FLD",PSUDV)),U,2)+RFLD
"RTN","PSUAR6",68,0)
 ;
"RTN","PSUAR6",69,0)
 I PSUCAT=22 D                              ;Blood products data
"RTN","PSUAR6",70,0)
 .S RBLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",71,0)
 .I RBLD="" S RBLD=0
"RTN","PSUAR6",72,0)
 .S $P(PSUAR("BLD",PSUDV),U,2)=$P($G(PSUAR("BLD",PSUDV)),U,2)+RBLD
"RTN","PSUAR6",73,0)
 Q
"RTN","PSUAR6",74,0)
NET ;Calculate Net dispensed data
"RTN","PSUAR6",75,0)
 ;
"RTN","PSUAR6",76,0)
 I PSUCAT="03 or 04" D                      ;Doses data
"RTN","PSUAR6",77,0)
 .S $P(PSUAR("DSP",PSUDV),U,3)=$P(PSUAR("DSP",PSUDV),U,1)-$P(PSUAR("DSP",PSUDV),U,2)
"RTN","PSUAR6",78,0)
 ;
"RTN","PSUAR6",79,0)
 I PSUCAT="06 or 07" D                      ;Unit data
"RTN","PSUAR6",80,0)
 .S $P(PSUAR("UNIT",PSUDV),U,3)=$P(PSUAR("UNIT",PSUDV),U,1)-$P(PSUAR("UNIT",PSUDV),U,2)
"RTN","PSUAR6",81,0)
 ;
"RTN","PSUAR6",82,0)
 I PSUCAT=17 D                              ;Fluids/sets data
"RTN","PSUAR6",83,0)
 .S $P(PSUAR("FLD",PSUDV),U,3)=$P(PSUAR("FLD",PSUDV),U,1)-$P(PSUAR("FLD",PSUDV),U,2)
"RTN","PSUAR6",84,0)
 ;
"RTN","PSUAR6",85,0)
 I PSUCAT=22 D                              ;Blood products data
"RTN","PSUAR6",86,0)
 .S $P(PSUAR("BLD",PSUDV),U,3)=$P(PSUAR("BLD",PSUDV),U,1)-$P(PSUAR("BLD",PSUDV),U,2)
"RTN","PSUAR6",87,0)
 Q
"RTN","PSUAR6",88,0)
TCOST ;Calculate total cost
"RTN","PSUAR6",89,0)
 ;
"RTN","PSUAR6",90,0)
 N T1,T2
"RTN","PSUAR6",91,0)
 S PSUCA=0
"RTN","PSUAR6",92,0)
 F  S PSUCA=$O(^XTMP("PSUTCST",PSUDV,PSUCA)) Q:PSUCA=""  D
"RTN","PSUAR6",93,0)
 .I (PSUCA="03")!(PSUCA="04") D
"RTN","PSUAR6",94,0)
 ..S T1=$G(^XTMP("PSUTCST",PSUDV,"03"))
"RTN","PSUAR6",95,0)
 ..S T2=$G(^XTMP("PSUTCST",PSUDV,"04"))
"RTN","PSUAR6",96,0)
 ..S $P(PSUAR("DSP",PSUDV),U,4)=T1+T2
"RTN","PSUAR6",97,0)
 ..K T1,T2
"RTN","PSUAR6",98,0)
 .I (PSUCA="06")!(PSUCA="07") D
"RTN","PSUAR6",99,0)
 ..S T1=$G(^XTMP("PSUTCST",PSUDV,"06"))
"RTN","PSUAR6",100,0)
 ..S T2=$G(^XTMP("PSUTCST",PSUDV,"07"))
"RTN","PSUAR6",101,0)
 ..S $P(PSUAR("UNIT",PSUDV),U,4)=T1+T2
"RTN","PSUAR6",102,0)
 ..K T1,T2
"RTN","PSUAR6",103,0)
 .I PSUCA=17 D
"RTN","PSUAR6",104,0)
 ..S $P(PSUAR("FLD",PSUDV),U,4)=^XTMP("PSUTCST",PSUDV,PSUCA)
"RTN","PSUAR6",105,0)
 .I PSUCA=22 D
"RTN","PSUAR6",106,0)
 ..Q:$P($G(PSUAR("BLD",PSUDV)),U,1)=""
"RTN","PSUAR6",107,0)
 ..S $P(PSUAR("BLD",PSUDV),U,4)=^XTMP("PSUTCST",PSUDV,PSUCA)
"RTN","PSUAR6",108,0)
 Q
"RTN","PSUAR6",109,0)
AVE ;Calculate Average cost per dose
"RTN","PSUAR6",110,0)
 ;
"RTN","PSUAR6",111,0)
 N NET,TOT
"RTN","PSUAR6",112,0)
 S NET=$P($G(PSUAR("DSP",PSUDV)),U,3)
"RTN","PSUAR6",113,0)
 I $G(NET)'>0 S NET=1
"RTN","PSUAR6",114,0)
 S TOT=$P($G(PSUAR("DSP",PSUDV)),U,4)
"RTN","PSUAR6",115,0)
 S $P(PSUAR("DSP",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",116,0)
 .S TRUNC=PSUAR("DSP",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",117,0)
 .D TRUNC
"RTN","PSUAR6",118,0)
 .S PSUAR("DSP",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",119,0)
 .K TRUNC
"RTN","PSUAR6",120,0)
 .K TOT,NET
"RTN","PSUAR6",121,0)
 ;
"RTN","PSUAR6",122,0)
 I $D(PSUAR("UNIT")) D
"RTN","PSUAR6",123,0)
 .S NET=$P(PSUAR("UNIT",PSUDV),U,3)
"RTN","PSUAR6",124,0)
 .I $G(NET)'>0 S NET=1
"RTN","PSUAR6",125,0)
 .S TOT=$P($G(PSUAR("UNIT",PSUDV)),U,4)
"RTN","PSUAR6",126,0)
 .S $P(PSUAR("UNIT",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",127,0)
 ..S TRUNC=PSUAR("UNIT",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",128,0)
 ..D TRUNC
"RTN","PSUAR6",129,0)
 ..S PSUAR("UNIT",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",130,0)
 ..K TRUNC
"RTN","PSUAR6",131,0)
 ..K TOT,NET
"RTN","PSUAR6",132,0)
 ;
"RTN","PSUAR6",133,0)
 I $D(PSUAR("FLD")) D
"RTN","PSUAR6",134,0)
 .S NET=$P($G(PSUAR("FLD",PSUDV)),U,3)
"RTN","PSUAR6",135,0)
 .I $G(NET)'>0 S NET=1
"RTN","PSUAR6",136,0)
 .S TOT=$P($G(PSUAR("FLD",PSUDV)),U,4)
"RTN","PSUAR6",137,0)
 .S $P(PSUAR("FLD",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",138,0)
 ..S TRUNC=PSUAR("FLD",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",139,0)
 ..D TRUNC
"RTN","PSUAR6",140,0)
 ..S PSUAR("FLD",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",141,0)
 ..K TRUNC
"RTN","PSUAR6",142,0)
 ..K TOT,NET
"RTN","PSUAR6",143,0)
 I '$D(PSUAR("FLD",PSUDV)) D
"RTN","PSUAR6",144,0)
 .S PSUAR("FLD",PSUDV)="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",145,0)
 ;
"RTN","PSUAR6",146,0)
 I $D(PSUAR("BLD")),$G(PSUDIV) D
"RTN","PSUAR6",147,0)
 .S NET=$P(PSUAR("BLD",PSUDV),U,3)
"RTN","PSUAR6",148,0)
 .I $G(NET)'>0 S NET=1
"RTN","PSUAR6",149,0)
 .S TOT=$P($G(PSUAR("BLD",PSUDV)),U,4)
"RTN","PSUAR6",150,0)
 .S $P(PSUAR("BLD",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",151,0)
 ..S TRUNC=PSUAR("BLD",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",152,0)
 ..D TRUNC
"RTN","PSUAR6",153,0)
 ..S PSUAR("BLD",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",154,0)
 ..K TRUNC
"RTN","PSUAR6",155,0)
 ..K TOT,NET
"RTN","PSUAR6",156,0)
 I '$D(PSUAR("BLD",PSUDV)) D
"RTN","PSUAR6",157,0)
 .S PSUAR("BLD",PSUDV)="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",158,0)
 Q
"RTN","PSUAR6",159,0)
TRUNC ;Truncate pieces with dollar values to 2 decimal places
"RTN","PSUAR6",160,0)
 ;
"RTN","PSUAR6",161,0)
 F I=1:1:5 D
"RTN","PSUAR6",162,0)
 .N A,B,C
"RTN","PSUAR6",163,0)
 .I $P(TRUNC,U,I)'["." D  Q
"RTN","PSUAR6",164,0)
 ..S $P(TRUNC,U,I)=$P(TRUNC,U,I)_".00"
"RTN","PSUAR6",165,0)
 .S A=$F($P(TRUNC,U,I),".")  ;Find first position after decimal
"RTN","PSUAR6",166,0)
 .S B=$E($P(TRUNC,U,I),1,(A-1))  ;Extract dollars and decimal
"RTN","PSUAR6",167,0)
 .S C=$E($P(TRUNC,U,I),A,(A+1))  ;Extract cents after decimal
"RTN","PSUAR6",168,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",169,0)
 .S $P(TRUNC,U,I)=B_C
"RTN","PSUAR6",170,0)
 Q
"RTN","PSUAR6",171,0)
TOTAL ;Calculate column totals for each division
"RTN","PSUAR6",172,0)
 ;
"RTN","PSUAR6",173,0)
 I $D(PSUAR("DSP")) D
"RTN","PSUAR6",174,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",175,0)
 .S PSUDIV=0                                    ;Doses data
"RTN","PSUAR6",176,0)
 .F  S PSUDIV=$O(PSUAR("DSP",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",177,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("DSP",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",178,0)
 ..S TRET=$G(TRET)+$P(PSUAR("DSP",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",179,0)
 ..S TNET=$G(TNET)+$P(PSUAR("DSP",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",180,0)
 ..S TCST=$G(TCST)+$P(PSUAR("DSP",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",181,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",182,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",183,0)
 ...N A,B,C
"RTN","PSUAR6",184,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",185,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",186,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",187,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",188,0)
 ...S TAVE=B_C
"RTN","PSUAR6",189,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",190,0)
 .;
"RTN","PSUAR6",191,0)
 .S TOTAL("DSP")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",192,0)
 ..S TRUNC=TOTAL("DSP")                         ;Transfer to variable
"RTN","PSUAR6",193,0)
 ..D TRUNC
"RTN","PSUAR6",194,0)
 ..S TOTAL("DSP")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",195,0)
 ..K TRUNC
"RTN","PSUAR6",196,0)
 ;
"RTN","PSUAR6",197,0)
 I $D(PSUAR("UNIT")) D
"RTN","PSUAR6",198,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",199,0)
 .S PSUDIV=0                                    ;Unit data
"RTN","PSUAR6",200,0)
 .F  S PSUDIV=$O(PSUAR("UNIT",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",201,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("UNIT",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",202,0)
 ..S TRET=$G(TRET)+$P(PSUAR("UNIT",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",203,0)
 ..S TNET=$G(TNET)+$P(PSUAR("UNIT",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",204,0)
 ..S TCST=$G(TCST)+$P(PSUAR("UNIT",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",205,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",206,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",207,0)
 ...N A,B,C
"RTN","PSUAR6",208,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",209,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",210,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",211,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",212,0)
 ...S TAVE=B_C
"RTN","PSUAR6",213,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",214,0)
 .S TOTAL("UNIT")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",215,0)
 ..S TRUNC=TOTAL("UNIT")                         ;Transfer to variable
"RTN","PSUAR6",216,0)
 ..D TRUNC
"RTN","PSUAR6",217,0)
 ..S TOTAL("UNIT")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",218,0)
 ..K TRUNC
"RTN","PSUAR6",219,0)
 ;
"RTN","PSUAR6",220,0)
 I $D(PSUAR("FLD")) D
"RTN","PSUAR6",221,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",222,0)
 .S PSUDIV=0                                    ;Fluid/sets data
"RTN","PSUAR6",223,0)
 .F  S PSUDIV=$O(PSUAR("FLD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",224,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("FLD",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",225,0)
 ..S TRET=$G(TRET)+$P(PSUAR("FLD",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",226,0)
 ..S TNET=$G(TNET)+$P(PSUAR("FLD",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",227,0)
 ..S TCST=$G(TCST)+$P(PSUAR("FLD",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",228,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",229,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",230,0)
 ...N A,B,C
"RTN","PSUAR6",231,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",232,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",233,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",234,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",235,0)
 ...S TAVE=B_C
"RTN","PSUAR6",236,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",237,0)
 .S TOTAL("FLD")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",238,0)
 ..S TRUNC=TOTAL("FLD")                         ;Transfer to variable
"RTN","PSUAR6",239,0)
 ..D TRUNC
"RTN","PSUAR6",240,0)
 ..S TOTAL("FLD")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",241,0)
 ..K TRUNC
"RTN","PSUAR6",242,0)
 I '$D(PSUAR("FLD")) D
"RTN","PSUAR6",243,0)
 .S TOTAL("FLD")="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",244,0)
 ;
"RTN","PSUAR6",245,0)
 ;
"RTN","PSUAR6",246,0)
 I $D(PSUAR("BLD")) D
"RTN","PSUAR6",247,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",248,0)
 .S PSUDIV=0                                    ;Blood data
"RTN","PSUAR6",249,0)
 .F  S PSUDIV=$O(PSUAR("BLD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",250,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("BLD",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",251,0)
 ..S TRET=$G(TRET)+$P(PSUAR("BLD",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",252,0)
 ..S TNET=$G(TNET)+$P(PSUAR("BLD",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",253,0)
 ..S TCST=$G(TCST)+$P(PSUAR("BLD",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",254,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",255,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",256,0)
 ...N A,B,C
"RTN","PSUAR6",257,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",258,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",259,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",260,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",261,0)
 ...S TAVE=B_C
"RTN","PSUAR6",262,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",263,0)
 .S TOTAL("BLD")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",264,0)
 ..S TRUNC=TOTAL("BLD")                         ;Transfer to variable
"RTN","PSUAR6",265,0)
 ..D TRUNC
"RTN","PSUAR6",266,0)
 ..S TOTAL("BLD")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",267,0)
 ..K TRUNC
"RTN","PSUAR6",268,0)
 I '$D(PSUAR("BLD")) D
"RTN","PSUAR6",269,0)
 .S TOTAL("BLD")="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",270,0)
 Q
"RTN","PSUAR7")
0^12^B68473935
"RTN","PSUAR7",1,0)
PSUAR7 ;BIR/DAM - PBM AR/WS AMIS SUMMARY MESSAGE;15 APR 2004
"RTN","PSUAR7",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUAR7",3,0)
 ;
"RTN","PSUAR7",4,0)
 ;Reference to file #40.8 supported by DBIA 2438
"RTN","PSUAR7",5,0)
 ;
"RTN","PSUAR7",6,0)
EN ;Entry point to create AMIS summary report
"RTN","PSUAR7",7,0)
 ;Called from ^PSUAR6
"RTN","PSUAR7",8,0)
 ;
"RTN","PSUAR7",9,0)
 D DOSES
"RTN","PSUAR7",10,0)
 Q:'$D(^XTMP(PSUARSUB,"DIV_CAT"))   ;QUIT IF NO DATA
"RTN","PSUAR7",11,0)
 D UNITS
"RTN","PSUAR7",12,0)
 D FLDS
"RTN","PSUAR7",13,0)
 D BLD
"RTN","PSUAR7",14,0)
 F PSULN=PSULN:1:(PSULN+3) S AMISAR(PSULN)=""     ;Blank lines
"RTN","PSUAR7",15,0)
 D MAIL
"RTN","PSUAR7",16,0)
 ;
"RTN","PSUAR7",17,0)
 Q
"RTN","PSUAR7",18,0)
 ;
"RTN","PSUAR7",19,0)
 ;
"RTN","PSUAR7",20,0)
DOSES ;Construct DOSES lines for the MailMan message
"RTN","PSUAR7",21,0)
 ;
"RTN","PSUAR7",22,0)
 S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUAR7",23,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUAR7",24,0)
 ;
"RTN","PSUAR7",25,0)
 K AMISAR      ;Array to hold message lines
"RTN","PSUAR7",26,0)
 ;
"RTN","PSUAR7",27,0)
 S AMISAR(1)="Automatic Replenishment/Ward Stock AMIS Summary"
"RTN","PSUAR7",28,0)
 ;
"RTN","PSUAR7",29,0)
 S AMISAR(2)=PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUAR7",30,0)
 ;
"RTN","PSUAR7",31,0)
 S AMISAR(3)=""                       ;Blank line
"RTN","PSUAR7",32,0)
 ;
"RTN","PSUAR7",33,0)
 I '$D(^XTMP(PSUARSUB,"DIV_CAT")) D  G MAIL    ;NO DATA REPORT
"RTN","PSUAR7",34,0)
 .S AMISAR(3)=" "
"RTN","PSUAR7",35,0)
 .S AMISAR(4)="No data to report"
"RTN","PSUAR7",36,0)
 .S AMISAR(5)=" "
"RTN","PSUAR7",37,0)
 ;
"RTN","PSUAR7",38,0)
 S AMISAR(4)="AR/WS DOSES:"
"RTN","PSUAR7",39,0)
 ;
"RTN","PSUAR7",40,0)
 S AMISAR(5)="                     DOSES      DOSES     NET DOSES       TOTAL      AVE COST"
"RTN","PSUAR7",41,0)
 S AMISAR(6)="DIVISION             DISPENSED  RETURNED  DISPENSED       COST       PER DOSE"
"RTN","PSUAR7",42,0)
 ;
"RTN","PSUAR7",43,0)
 S $P(AMISAR(7),"-",78)=""      ;Separator bar
"RTN","PSUAR7",44,0)
 ;
"RTN","PSUAR7",45,0)
 S PSULN=8
"RTN","PSUAR7",46,0)
 ;
"RTN","PSUAR7",47,0)
 S PSUDIV=0
"RTN","PSUAR7",48,0)
 F  S PSUDIV=$O(PSUAR("DSP",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR7",49,0)
 .S PSULINE=""
"RTN","PSUAR7",50,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAR7",51,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR7",52,0)
 .S $E(PSULINE,1,17)=$G(PSUDIVNM)
"RTN","PSUAR7",53,0)
 .I PSUDIVNM="" S $E(PSULINE,1,17)=$G(PSUDIV)
"RTN","PSUAR7",54,0)
 .S $E(PSULINE,19,29)=$J($P(PSUAR("DSP",PSUDIV),U,1),11)
"RTN","PSUAR7",55,0)
 .S $E(PSULINE,30,39)=$J($P(PSUAR("DSP",PSUDIV),U,2),10)
"RTN","PSUAR7",56,0)
 .S $E(PSULINE,40,50)=$J($P(PSUAR("DSP",PSUDIV),U,3),11)
"RTN","PSUAR7",57,0)
 .S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",58,0)
 .S $E(PSULINE,55,65)=$J($P(PSUAR("DSP",PSUDIV),U,4),11)
"RTN","PSUAR7",59,0)
 .S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",60,0)
 .S $E(PSULINE,72,78)=$J($P(PSUAR("DSP",PSUDIV),U,5),7)
"RTN","PSUAR7",61,0)
 .S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",62,0)
 ;
"RTN","PSUAR7",63,0)
 S $P(AMISAR(PSULN),"-",78)=""     ;Separator bar
"RTN","PSUAR7",64,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",65,0)
 ;
"RTN","PSUAR7",66,0)
 S PSULINE=""
"RTN","PSUAR7",67,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUAR7",68,0)
 S $E(PSULINE,19,29)=$J($P(TOTAL("DSP"),U,1),11)
"RTN","PSUAR7",69,0)
 S $E(PSULINE,30,39)=$J($P(TOTAL("DSP"),U,2),10)
"RTN","PSUAR7",70,0)
 S $E(PSULINE,40,50)=$J($P(TOTAL("DSP"),U,3),11)
"RTN","PSUAR7",71,0)
 S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",72,0)
 S $E(PSULINE,55,65)=$J($P(TOTAL("DSP"),U,4),11)
"RTN","PSUAR7",73,0)
 S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",74,0)
 S $E(PSULINE,72,78)=$J($P(TOTAL("DSP"),U,5),7)
"RTN","PSUAR7",75,0)
 S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",76,0)
 ;
"RTN","PSUAR7",77,0)
 Q
"RTN","PSUAR7",78,0)
 ;
"RTN","PSUAR7",79,0)
UNITS ;Construct DOSES lines for the MailMan message
"RTN","PSUAR7",80,0)
 ;
"RTN","PSUAR7",81,0)
 F PSULN=PSULN:1:(PSULN+1) S AMISAR(PSULN)=""
"RTN","PSUAR7",82,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",83,0)
 ;
"RTN","PSUAR7",84,0)
 S AMISAR(PSULN)="AR/WS UNITS:"
"RTN","PSUAR7",85,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",86,0)
 ;
"RTN","PSUAR7",87,0)
 S AMISAR(PSULN)="                     UNITS      UNITS     NET UNITS       TOTAL      AVE COST"
"RTN","PSUAR7",88,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",89,0)
 ;
"RTN","PSUAR7",90,0)
 S AMISAR(PSULN)="DIVISION             DISPENSED  RETURNED  DISPENSED       COST       PER UNIT"
"RTN","PSUAR7",91,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",92,0)
 ;
"RTN","PSUAR7",93,0)
 S $P(AMISAR(PSULN),"-",78)=""      ;Separator bar
"RTN","PSUAR7",94,0)
 ;
"RTN","PSUAR7",95,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",96,0)
 ;
"RTN","PSUAR7",97,0)
 S PSUDIV=0
"RTN","PSUAR7",98,0)
 F  S PSUDIV=$O(PSUAR("UNIT",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR7",99,0)
 .S PSULINE=""
"RTN","PSUAR7",100,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAR7",101,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR7",102,0)
 .S $E(PSULINE,1,17)=$G(PSUDIVNM)
"RTN","PSUAR7",103,0)
 .I PSUDIVNM="" S $E(PSULINE,1,17)=$G(PSUDIV)
"RTN","PSUAR7",104,0)
 .S $E(PSULINE,19,29)=$J($P(PSUAR("UNIT",PSUDIV),U,1),11)
"RTN","PSUAR7",105,0)
 .S $E(PSULINE,30,39)=$J($P(PSUAR("UNIT",PSUDIV),U,2),10)
"RTN","PSUAR7",106,0)
 .S $E(PSULINE,40,50)=$J($P(PSUAR("UNIT",PSUDIV),U,3),11)
"RTN","PSUAR7",107,0)
 .S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",108,0)
 .S $E(PSULINE,55,65)=$J($P(PSUAR("UNIT",PSUDIV),U,4),11)
"RTN","PSUAR7",109,0)
 .S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",110,0)
 .S $E(PSULINE,72,78)=$J($P(PSUAR("UNIT",PSUDIV),U,5),7)
"RTN","PSUAR7",111,0)
 .S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",112,0)
 ;
"RTN","PSUAR7",113,0)
 S $P(AMISAR(PSULN),"-",78)=""     ;Separator bar
"RTN","PSUAR7",114,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",115,0)
 ;
"RTN","PSUAR7",116,0)
 S PSULINE=""
"RTN","PSUAR7",117,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUAR7",118,0)
 S $E(PSULINE,19,29)=$J($P(TOTAL("UNIT"),U,1),11)
"RTN","PSUAR7",119,0)
 S $E(PSULINE,30,39)=$J($P(TOTAL("UNIT"),U,2),10)
"RTN","PSUAR7",120,0)
 S $E(PSULINE,40,50)=$J($P(TOTAL("UNIT"),U,3),11)
"RTN","PSUAR7",121,0)
 S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",122,0)
 S $E(PSULINE,55,65)=$J($P(TOTAL("UNIT"),U,4),11)
"RTN","PSUAR7",123,0)
 S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",124,0)
 S $E(PSULINE,72,78)=$J($P(TOTAL("UNIT"),U,5),7)
"RTN","PSUAR7",125,0)
 S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",126,0)
 ;
"RTN","PSUAR7",127,0)
 Q
"RTN","PSUAR7",128,0)
 ;
"RTN","PSUAR7",129,0)
FLDS ;Compose lines for FLUIDS/SETS portion of message
"RTN","PSUAR7",130,0)
 ;
"RTN","PSUAR7",131,0)
 F PSULN=PSULN:1:(PSULN+1) S AMISAR(PSULN)=""
"RTN","PSUAR7",132,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",133,0)
 ;
"RTN","PSUAR7",134,0)
 S AMISAR(PSULN)="FLUIDS/SETS:"
"RTN","PSUAR7",135,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",136,0)
 ;
"RTN","PSUAR7",137,0)
 S AMISAR(PSULN)="                                             NET"
"RTN","PSUAR7",138,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",139,0)
        ;
"RTN","PSUAR7",140,0)
 S AMISAR(PSULN)="                     FLUIDS/SETS FLUIDS/SETS FLUIDS/SETS TOTAL      AVE COST"
"RTN","PSUAR7",141,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",142,0)
 ;
"RTN","PSUAR7",143,0)
 S AMISAR(PSULN)="DIVISION             DISPENSED   RETURNED    DISPENSED   COST       PER"
"RTN","PSUAR7",144,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",145,0)
 ;
"RTN","PSUAR7",146,0)
 S AMISAR(PSULN)="                                                                    FLUIDS/SETS"
"RTN","PSUAR7",147,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",148,0)
 ;
"RTN","PSUAR7",149,0)
 S $P(AMISAR(PSULN),"-",78)=""      ;Separator bar
"RTN","PSUAR7",150,0)
 ;
"RTN","PSUAR7",151,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",152,0)
 ;
"RTN","PSUAR7",153,0)
 S PSUDIV=0
"RTN","PSUAR7",154,0)
 F  S PSUDIV=$O(PSUAR("FLD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR7",155,0)
 .S PSULINE=""
"RTN","PSUAR7",156,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAR7",157,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR7",158,0)
 .S $E(PSULINE,1,17)=$G(PSUDIVNM)
"RTN","PSUAR7",159,0)
 .I PSUDIVNM="" S $E(PSULINE,1,17)=$G(PSUDIV)
"RTN","PSUAR7",160,0)
 .S $E(PSULINE,19,29)=$J($P(PSUAR("FLD",PSUDIV),U,1),11)
"RTN","PSUAR7",161,0)
 .S $E(PSULINE,30,39)=$J($P(PSUAR("FLD",PSUDIV),U,2),10)
"RTN","PSUAR7",162,0)
 .S $E(PSULINE,40,50)=$J($P(PSUAR("FLD",PSUDIV),U,3),11)
"RTN","PSUAR7",163,0)
 .S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",164,0)
 .S $E(PSULINE,55,65)=$J($P(PSUAR("FLD",PSUDIV),U,4),11)
"RTN","PSUAR7",165,0)
 .S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",166,0)
 .S $E(PSULINE,72,78)=$J($P(PSUAR("FLD",PSUDIV),U,5),7)
"RTN","PSUAR7",167,0)
 .S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",168,0)
 ;
"RTN","PSUAR7",169,0)
 S $P(AMISAR(PSULN),"-",78)=""     ;Separator bar
"RTN","PSUAR7",170,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",171,0)
 ;
"RTN","PSUAR7",172,0)
 S PSULINE=""
"RTN","PSUAR7",173,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUAR7",174,0)
 S $E(PSULINE,19,29)=$J($P(TOTAL("FLD"),U,1),11)
"RTN","PSUAR7",175,0)
 S $E(PSULINE,30,39)=$J($P(TOTAL("FLD"),U,2),10)
"RTN","PSUAR7",176,0)
 S $E(PSULINE,40,50)=$J($P(TOTAL("FLD"),U,3),11)
"RTN","PSUAR7",177,0)
 S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",178,0)
 S $E(PSULINE,55,65)=$J($P(TOTAL("FLD"),U,4),11)
"RTN","PSUAR7",179,0)
 S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",180,0)
 S $E(PSULINE,72,78)=$J($P(TOTAL("FLD"),U,5),7)
"RTN","PSUAR7",181,0)
 S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",182,0)
 ;
"RTN","PSUAR7",183,0)
 Q
"RTN","PSUAR7",184,0)
 ;
"RTN","PSUAR7",185,0)
BLD ;Compose lines for BLOOD PRODUCTS portion of message
"RTN","PSUAR7",186,0)
 ;
"RTN","PSUAR7",187,0)
 F PSULN=PSULN:1:(PSULN+1) S AMISAR(PSULN)=""
"RTN","PSUAR7",188,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",189,0)
 ;
"RTN","PSUAR7",190,0)
 S AMISAR(PSULN)="BLOOD PRODUCTS"
"RTN","PSUAR7",191,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",192,0)
 ;
"RTN","PSUAR7",193,0)
 S AMISAR(PSULN)="                                             NET"
"RTN","PSUAR7",194,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",195,0)
 ;
"RTN","PSUAR7",196,0)
 S AMISAR(PSULN)="                     BLOOD PROD  BLOOD PROD  BLOOD PROD   TOTAL     AVE COST"
"RTN","PSUAR7",197,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",198,0)
 ;
"RTN","PSUAR7",199,0)
 S AMISAR(PSULN)="DIVISION             DISPENSED   RETURNED    DISPENSED    COST      PER"
"RTN","PSUAR7",200,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",201,0)
 ;
"RTN","PSUAR7",202,0)
 S AMISAR(PSULN)="                                                                    BLOOD PROD"
"RTN","PSUAR7",203,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",204,0)
 ;
"RTN","PSUAR7",205,0)
 S $P(AMISAR(PSULN),"-",78)=""      ;Separator bar
"RTN","PSUAR7",206,0)
 ;
"RTN","PSUAR7",207,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",208,0)
 ;
"RTN","PSUAR7",209,0)
 S PSUDIV=0
"RTN","PSUAR7",210,0)
 F  S PSUDIV=$O(PSUAR("BLD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR7",211,0)
 .S PSULINE=""
"RTN","PSUAR7",212,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAR7",213,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR7",214,0)
 .S $E(PSULINE,1,17)=$G(PSUDIVNM)
"RTN","PSUAR7",215,0)
 .I PSUDIVNM="" S $E(PSULINE,1,17)=$G(PSUDIV)
"RTN","PSUAR7",216,0)
 .S $E(PSULINE,19,29)=$J($P(PSUAR("BLD",PSUDIV),U,1),11)
"RTN","PSUAR7",217,0)
 .S $E(PSULINE,30,39)=$J($P(PSUAR("BLD",PSUDIV),U,2),10)
"RTN","PSUAR7",218,0)
 .S $E(PSULINE,40,50)=$J($P(PSUAR("BLD",PSUDIV),U,3),11)
"RTN","PSUAR7",219,0)
 .S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",220,0)
 .S $E(PSULINE,55,65)=$J($P(PSUAR("BLD",PSUDIV),U,4),11)
"RTN","PSUAR7",221,0)
 .S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",222,0)
 .S $E(PSULINE,72,78)=$J($P(PSUAR("BLD",PSUDIV),U,5),7)
"RTN","PSUAR7",223,0)
 .S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",224,0)
 ;
"RTN","PSUAR7",225,0)
 S $P(AMISAR(PSULN),"-",78)=""     ;Separator bar
"RTN","PSUAR7",226,0)
 S PSULN=PSULN+1
"RTN","PSUAR7",227,0)
 ;
"RTN","PSUAR7",228,0)
 S PSULINE=""
"RTN","PSUAR7",229,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUAR7",230,0)
 S $E(PSULINE,19,29)=$J($P(TOTAL("BLD"),U,1),11)
"RTN","PSUAR7",231,0)
 S $E(PSULINE,30,39)=$J($P(TOTAL("BLD"),U,2),10)
"RTN","PSUAR7",232,0)
 S $E(PSULINE,40,50)=$J($P(TOTAL("BLD"),U,3),11)
"RTN","PSUAR7",233,0)
 S $E(PSULINE,53,54)="$"
"RTN","PSUAR7",234,0)
 S $E(PSULINE,55,65)=$J($P(TOTAL("BLD"),U,4),11)
"RTN","PSUAR7",235,0)
 S $E(PSULINE,70,71)="$"
"RTN","PSUAR7",236,0)
 S $E(PSULINE,72,78)=$J($P(TOTAL("BLD"),U,5),7)
"RTN","PSUAR7",237,0)
 S AMISAR(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUAR7",238,0)
 ;
"RTN","PSUAR7",239,0)
 Q
"RTN","PSUAR7",240,0)
 ;
"RTN","PSUAR7",241,0)
 ;
"RTN","PSUAR7",242,0)
 ;
"RTN","PSUAR7",243,0)
MAIL ;Mail CS AMIS summary report
"RTN","PSUAR7",244,0)
 ;
"RTN","PSUAR7",245,0)
 ;Do not send report if option selection includes 1,2,3,4,6
"RTN","PSUAR7",246,0)
 I $D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D  Q
"RTN","PSUAR7",247,0)
 .M ^XTMP("PSU_"_PSUJOB,"ARCOMBO")=AMISAR
"RTN","PSUAR7",248,0)
 .S ^XTMP("PSU_"_PSUJOB,"ARCOMBO",1)=""
"RTN","PSUAR7",249,0)
 .S ^XTMP("PSU_"_PSUJOB,"ARCOMBO",2)=""
"RTN","PSUAR7",250,0)
 ;
"RTN","PSUAR7",251,0)
 M XMY=PSUXMYS2
"RTN","PSUAR7",252,0)
 ;
"RTN","PSUAR7",253,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAR7",254,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAR7",255,0)
 ;
"RTN","PSUAR7",256,0)
 S XMSUB="V. 4.0 PBMAR "_PSUMON_" "_PSUSNDR_" "_PSUDIVNM
"RTN","PSUAR7",257,0)
 S XMTEXT="AMISAR("
"RTN","PSUAR7",258,0)
 M ^XTMP("PSU_"_PSUJOB,"ARAMIS")=AMISAR
"RTN","PSUAR7",259,0)
 S XMCHAN=1
"RTN","PSUAR7",260,0)
 D ^XMD
"RTN","PSUAR7",261,0)
 ;
"RTN","PSUAR7",262,0)
 Q
"RTN","PSUCP")
0^13^B89043924
"RTN","PSUCP",1,0)
PSUCP ;BIR/TJH,PDW - PBM CONTROL POINT ;25 AUG 1998
"RTN","PSUCP",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCP",3,0)
 ; Reference to File #4    supported by DBIA 10090
"RTN","PSUCP",4,0)
 ; Reference to File #4.3  supported by DBIA 10091
"RTN","PSUCP",5,0)
 ; Reference to File #40.8 supported by DBIA 2438
"RTN","PSUCP",6,0)
 ; Reference to File #59.7 supported by DBIA 2854
"RTN","PSUCP",7,0)
MANUAL ; entry point for manual option
"RTN","PSUCP",8,0)
 S PSUALERT=0 D MANUAL^PSUALERT
"RTN","PSUCP",9,0)
 I PSUALERT K PSUALERT Q
"RTN","PSUCP",10,0)
 K PSUALERT
"RTN","PSUCP",11,0)
 S PSUFQ=1
"RTN","PSUCP",12,0)
 I $D(^XTMP("PSUJFLG")) D  Q:Y=0  Q:Y="^"
"RTN","PSUCP",13,0)
 .W !!,"NOTE: A PREVIOUS JOB HAS NOT COMPLETED DUE TO AN ERROR"
"RTN","PSUCP",14,0)
 .W !!,"PLEASE ALERT YOUR IRM."
"RTN","PSUCP",15,0)
 .W !!,"RESPOND 'YES' TO CONTINUE, OR 'NO' TO EXIT"
"RTN","PSUCP",16,0)
 .S DIR(0)="Y",DIR("B")="NO"
"RTN","PSUCP",17,0)
 .S DIR("A")="Do you wish to continue"
"RTN","PSUCP",18,0)
 .D ^DIR
"RTN","PSUCP",19,0)
 D ^PSUCP3
"RTN","PSUCP",20,0)
 S PSUJOB=$J_"_"_$P($H,",",2)
"RTN","PSUCP",21,0)
 S ^XTMP("PSUMANL")=""
"RTN","PSUCP",22,0)
 D EN^PSUCP1 ; prompt for report choices
"RTN","PSUCP",23,0)
 I PSUERR G EXIT
"RTN","PSUCP",24,0)
 D XMY^PSUTL1 ; Setup for mail groups according to choices
"RTN","PSUCP",25,0)
 S ^XTMP("PSUJFLG")="",PSUAUTO=0,^XTMP("PSU_"_PSUJOB,"PSUJOB")=PSUJOB
"RTN","PSUCP",26,0)
 D PUT
"RTN","PSUCP",27,0)
 S PSUTITLE="PSU PBM MANUAL",PSURC="RUN^PSUCP"
"RTN","PSUCP",28,0)
 S PSURP=$S('$L(PSUIOP):"",1:"PRINT^PSUCP")
"RTN","PSUCP",29,0)
 S PSURX="EXIT^PSUCP",PSUNS="PS"
"RTN","PSUCP",30,0)
 S ^XTMP("PSU","RUNNING")=$G(ZTSK)
"RTN","PSUCP",31,0)
 K PSUALERT,XAQ,SQAFLG,SQAID,XQAMSG,XQMSG,ZTSK
"RTN","PSUCP",32,0)
 D ^PSUDBQUE
"RTN","PSUCP",33,0)
MANUALQ Q
"RTN","PSUCP",34,0)
 ;
"RTN","PSUCP",35,0)
AUTO ; set variables for Auto-report option and task to background
"RTN","PSUCP",36,0)
 S PSUALERT=0 D AUTO^PSUALERT
"RTN","PSUCP",37,0)
 I PSUALERT K PSUALERT Q
"RTN","PSUCP",38,0)
 I $G(^XTMP("PSU","RUNNING")) D  Q
"RTN","PSUCP",39,0)
 .S XQA(DUZ)="",XQA("G.PSU PBM")="",XQMSG="An ERROR has occurred. Please contact IRM for assistance."
"RTN","PSUCP",40,0)
 .S XQAID="PSU",XQAFLG="D" D SETUP^XQALERT
"RTN","PSUCP",41,0)
 D ^PSUCP3         ;Clear trash globals
"RTN","PSUCP",42,0)
 S PSUJOB=$J_"_"_$P($H,",",2)
"RTN","PSUCP",43,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")=""   ;flag for mail patient summary reports
"RTN","PSUCP",44,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPSUMFLAG")=1         ;Set 'auto' flag
"RTN","PSUCP",45,0)
 S ^XTMP("PSUJFLG")=""    ;FLAG to avoid concurrent jobs running
"RTN","PSUCP",46,0)
 D  ; schedule job completion check
"RTN","PSUCP",47,0)
 .S PSURC="AUTO^PSUCP2",PSUTITLE="PSU PBM JOB CHECK",PSUFQ=1
"RTN","PSUCP",48,0)
 .S (PSURP,PSURX,PSUIOP)=""
"RTN","PSUCP",49,0)
 .D NOW^%DTC S X1=%,X2=6 D C^%DTC S PSUDTH=X ; LIVE MODE, wait 6 days (72 hours)
"RTN","PSUCP",50,0)
 .D ^PSUDBQUE
"RTN","PSUCP",51,0)
 .S ^XTMP("PSU","RUNNING")=$G(ZTSK)
"RTN","PSUCP",52,0)
 D NOW^%DTC S PSUMON=$S('$D(DT):X,1:DT),PSUMON=$E(PSUMON,1,5)-1 ; get previous month
"RTN","PSUCP",53,0)
 I $E(PSUMON,4,5)="00" S PSUMON=($E(PSUMON,1,3)-1)_"12" ; set to Dec. of previous year if this month is Jan.
"RTN","PSUCP",54,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUMONTH")=PSUMON,PSUSDT=PSUMON_"01"
"RTN","PSUCP",55,0)
 S PSULY=$$LEAPYR(PSUMON),X=U_$E(PSUMON,4,5)_U
"RTN","PSUCP",56,0)
 S PSUEDT=PSUMON_$S(X["02":$S(PSULY:"29",1:"28"),"^04^06^09^11^"[X:"30",1:"31")
"RTN","PSUCP",57,0)
 S PSUDUZ=$S(DUZ=0:.5,1:DUZ),PSUMASF=1,PSUSMRY=0,PSUPBMG=1
"RTN","PSUCP",58,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPDFLAG")=1   ;Flag-detailed PD won't go to user auto extract
"RTN","PSUCP",59,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSUCP",60,0)
 S PSUOPTS="1,2,3,4,5,6,7,8,9,10,11,12,13",PSUAUTO=1,PSUIOP="" D
"RTN","PSUCP",61,0)
 .S ^XTMP("PSU_"_PSUJOB,"CBAMIS")=""
"RTN","PSUCP",62,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUJOB")=PSUJOB
"RTN","PSUCP",63,0)
 D PUT
"RTN","PSUCP",64,0)
 S PSUTITLE="PSU PBM AUTO",PSURC="RUN^PSUCP",PSURX="EXIT^PSUCP",PSURP="",PSUNS="PS",PSUFQ=1
"RTN","PSUCP",65,0)
 D NOW^%DTC S PSUDTH=%
"RTN","PSUCP",66,0)
 D ^PSUDBQUE
"RTN","PSUCP",67,0)
 K PSUALERT,XQA,XQAID,XQAFLG,XQA,ZTSK
"RTN","PSUCP",68,0)
AUTOQ D EXIT Q  ; exit from AUTO
"RTN","PSUCP",69,0)
 ;
"RTN","PSUCP",70,0)
RUN ; run each selected module
"RTN","PSUCP",71,0)
 L ^XTMP("PSU","RUNNING"):1 I '$T Q
"RTN","PSUCP",72,0)
 D PULL,OPTS
"RTN","PSUCP",73,0)
 K PSUMOD,PSUFDA
"RTN","PSUCP",74,0)
 I PSUAUTO S PSUFDA(59.7,"1,",90)="@" D FILE^DIE("","PSUFDA","")
"RTN","PSUCP",75,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUCP",76,0)
 S PSUOPTN=""
"RTN","PSUCP",77,0)
 F  S PSUOPTN=$O(PSUMOD(PSUOPTN)) Q:PSUOPTN=""  D
"RTN","PSUCP",78,0)
 .K PSUMSGT
"RTN","PSUCP",79,0)
 .D PULL
"RTN","PSUCP",80,0)
 .I PSUAUTO S PSUPBMG=1
"RTN","PSUCP",81,0)
 .D XMY^PSUTL1
"RTN","PSUCP",82,0)
 .S PSURTN=PSUA(PSUOPTN,"R")
"RTN","PSUCP",83,0)
 .D NOW^%DTC
"RTN","PSUCP",84,0)
 .S ^XTMP("PSU_"_PSUJOB,"STATUS",PSUOPTN,"START")=%
"RTN","PSUCP",85,0)
 .D @PSURTN,PULL,NOW^%DTC
"RTN","PSUCP",86,0)
 .S ^XTMP("PSU_"_PSUJOB,"STATUS",PSUOPTN,"STOP")=%
"RTN","PSUCP",87,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUCP",88,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUCP",89,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUCP",90,0)
 S PSURP("END")=EXTD(0),PSUSUB="PSU_"_PSUJOB
"RTN","PSUCP",91,0)
 D MMNOMAP^PSUCP2 ; MM send regarding PBM locations not mapped
"RTN","PSUCP",92,0)
 D TIMING ; send a report of how long each module took to complete
"RTN","PSUCP",93,0)
 I PSUMASF!PSUPBMG D CONFIRM  ;Confirmation message sent only if data went to Master File
"RTN","PSUCP",94,0)
 I PSUAUTO D
"RTN","PSUCP",95,0)
 .D NOW^%DTC
"RTN","PSUCP",96,0)
 .S PSUFDA(59.7,"1,",90)=% K %,%H,%I,X
"RTN","PSUCP",97,0)
 .D FILE^DIE("","PSUFDA","") ; file the completion date in 59.7,90;1
"RTN","PSUCP",98,0)
 L
"RTN","PSUCP",99,0)
 ;
"RTN","PSUCP",100,0)
 Q
"RTN","PSUCP",101,0)
PRINT ; print hard copy if requested
"RTN","PSUCP",102,0)
 Q:'$L(PSUIOP)  ; no printer selected, stop right here.
"RTN","PSUCP",103,0)
 D PULL,OPTS
"RTN","PSUCP",104,0)
 K PSUMOD
"RTN","PSUCP",105,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUCP",106,0)
 S PSUOPTN=""
"RTN","PSUCP",107,0)
 F  S PSUOPTN=$O(PSUMOD(PSUOPTN)) Q:PSUOPTN=""  D
"RTN","PSUCP",108,0)
 .D PULL
"RTN","PSUCP",109,0)
 .S PSURTN=PSUA(PSUOPTN,"P")
"RTN","PSUCP",110,0)
 .D @PSURTN
"RTN","PSUCP",111,0)
 L
"RTN","PSUCP",112,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUCP",113,0)
PRINTQ  Q
"RTN","PSUCP",114,0)
EXIT ; exit point
"RTN","PSUCP",115,0)
 K ^XTMP("PSU","RUNNING")
"RTN","PSUCP",116,0)
 K ^XTMP("PSUJFLG")   ;Remove flag to prevent concurrent jobs
"RTN","PSUCP",117,0)
 Q
"RTN","PSUCP",118,0)
PUT ; put variables in ^XTMP so modules can retrieve them
"RTN","PSUCP",119,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUIOP,PSUSNDR,PSUOPTS,PSUAUTO"
"RTN","PSUCP",120,0)
 S PSUVSTR=""
"RTN","PSUCP",121,0)
 F I=1:1:$L(PSUVARS,",") S $P(PSUVSTR,U,I)=@$P(PSUVARS,",",I)
"RTN","PSUCP",122,0)
 S X1=DT,X2=6 D C^%DTC
"RTN","PSUCP",123,0)
 S ^XTMP("PSU_"_PSUJOB,0)=X_U_DT_U_"Control data for PSU PBM individual modules"
"RTN","PSUCP",124,0)
 S ^XTMP("PSU_"_PSUJOB,1)=PSUVSTR
"RTN","PSUCP",125,0)
 K PSUVARS,PSUVSTR,X,X1
"RTN","PSUCP",126,0)
PUTQ Q
"RTN","PSUCP",127,0)
PULL ; pull variables from ^XTMP
"RTN","PSUCP",128,0)
 ; PSUJOB must exist and must be the job number used to store the data desired for this session.
"RTN","PSUCP",129,0)
 N I
"RTN","PSUCP",130,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUIOP,PSUSNDR,PSUOPTS,PSUAUTO"
"RTN","PSUCP",131,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P($G(^XTMP("PSU_"_PSUJOB,1)),U,I)
"RTN","PSUCP",132,0)
PULLQ Q
"RTN","PSUCP",133,0)
 ;
"RTN","PSUCP",134,0)
OPTS ; set option array
"RTN","PSUCP",135,0)
 S PSUA(1,"M")="IVs",PSUA(1,"R")="EN^PSUV0",PSUA(1,"P")="PRINT^PSUV0",PSUA(1,"C")="IV"
"RTN","PSUCP",136,0)
 S PSUA(2,"M")="Unit Dose",PSUA(2,"R")="EN^PSUUD0",PSUA(2,"P")="PRINT^PSUUD0",PSUA(2,"C")="UD"
"RTN","PSUCP",137,0)
 S PSUA(3,"M")="AR/WS",PSUA(3,"R")="EN^PSUAR0",PSUA(3,"P")="PRINT^PSUAR0",PSUA(3,"C")="AR"
"RTN","PSUCP",138,0)
 S PSUA(4,"M")="Prescription",PSUA(4,"R")="EN^PSUOP0",PSUA(4,"P")="PRINT^PSUOP0",PSUA(4,"C")="OP"
"RTN","PSUCP",139,0)
 S PSUA(5,"M")="Procurement",PSUA(5,"R")="EN^PSUPR0",PSUA(5,"P")="PRINT^PSUPR0",PSUA(5,"C")="PR"
"RTN","PSUCP",140,0)
 S PSUA(6,"M")="Controlled Substances",PSUA(6,"R")="EN^PSUCS0",PSUA(6,"P")="PRINT^PSUCS0",PSUA(6,"C")="CS"
"RTN","PSUCP",141,0)
 S PSUA(7,"M")="Patient Demographics",PSUA(7,"R")="EN^PSUDEM1",PSUA(7,"P")="PRINT^PSUDEM0",PSUA(7,"C")="PD"
"RTN","PSUCP",142,0)
 S PSUA(8,"M")="Outpatient Visits",PSUA(8,"R")="EN^PSUDEM2",PSUA(8,"P")="OPV^PSUDEM0",PSUA(8,"C")="OV"
"RTN","PSUCP",143,0)
 S PSUA(9,"M")="Inpatient PTF Records",PSUA(9,"R")="EN^PSUDEM7",PSUA(9,"P")="PTF^PSUDEM0",PSUA(9,"C")="PTF"
"RTN","PSUCP",144,0)
 S PSUA(10,"M")="Provider Data",PSUA(10,"R")="EN^PSUDEM4",PSUA(10,"P")="PRO^PSUDEM0",PSUA(10,"C")="PRO"
"RTN","PSUCP",145,0)
 S PSUA(11,"M")="Allergies/Adverse Events",PSUA(11,"R")="EN^PSUAA1",PSUA(11,"P")="PRINT^PSUAA1",PSUA(11,"C")="AA"
"RTN","PSUCP",146,0)
 S PSUA(12,"M")="Vitals/Immunizations Information",PSUA(12,"R")="EN^PSUVIT1",PSUA(12,"P")="EN^PSUVIT0",PSUA(12,"C")="VI"
"RTN","PSUCP",147,0)
 S PSUA(13,"M")="Laboratory Results",PSUA(13,"R")="EN^PSULR0",PSUA(13,"P")="PRINT^PSULR0",PSUA(13,"C")="LR"
"RTN","PSUCP",148,0)
 S PSUA("A")=""
"RTN","PSUCP",149,0)
OPTSQ Q
"RTN","PSUCP",150,0)
 ;
"RTN","PSUCP",151,0)
CONFIRM ;Send confirmation by Division(s)
"RTN","PSUCP",152,0)
 K PSUCONF
"RTN","PSUCP",153,0)
 S PSUDIV=0,$P(PSUDASH,"-",81)=""
"RTN","PSUCP",154,0)
 D OPTS
"RTN","PSUCP",155,0)
 S PSUCONF(1)="The chart below shows the package(s) whose dispensing statistics were extracted"
"RTN","PSUCP",156,0)
 S PSUCONF(2)="by the PBM "_$S($G(PSUAUTO):"Automatic",$G(PSURXMT):"RETRANSMISSION",1:"Manual")_" Pharmacy Statistics option."
"RTN","PSUCP",157,0)
 ; S PSUCONF(2)="by the PBM "_$S(PSUAUTO:"Automatic",1:"Manual")_" Pharmacy Statistics option."
"RTN","PSUCP",158,0)
 S PSUCONF(3)=" "
"RTN","PSUCP",159,0)
 S PSUCONF(4)="PACKAGE"_$J("# Line items",35)_$J("# MailMan msgs",19)
"RTN","PSUCP",160,0)
 S PSUCONF(5)=$E(PSUDASH,1,79)
"RTN","PSUCP",161,0)
 F  S PSUDIV=$O(^XTMP(PSUSUB,"CONFIRM",PSUDIV)) Q:PSUDIV'?1N.E  D
"RTN","PSUCP",162,0)
 .K ^XTMP(PSUSUB,"XMD")
"RTN","PSUCP",163,0)
 .M ^XTMP(PSUSUB,"XMD")=PSUCONF
"RTN","PSUCP",164,0)
 .S PSUOPT=0,PSULCT=5
"RTN","PSUCP",165,0)
 .F  S PSUOPT=$O(^XTMP(PSUSUB,"CONFIRM",PSUDIV,PSUOPT)) Q:PSUOPT'?1.N  D
"RTN","PSUCP",166,0)
 ..S PSULCT=PSULCT+1
"RTN","PSUCP",167,0)
 ..S PSUPKG=PSUA(PSUOPT,"M")
"RTN","PSUCP",168,0)
 ..S PSULIN=^XTMP(PSUSUB,"CONFIRM",PSUDIV,PSUOPT,"L")
"RTN","PSUCP",169,0)
 ..S PSUMSG=^XTMP(PSUSUB,"CONFIRM",PSUDIV,PSUOPT,"M")
"RTN","PSUCP",170,0)
 ..S ^XTMP(PSUSUB,"XMD",PSULCT)=PSUPKG_$J(PSULIN,37-$L(PSUPKG))_$J(PSUMSG,12)
"RTN","PSUCP",171,0)
 ..Q:PSUPKG'="Prescription"  ;*
"RTN","PSUCP",172,0)
 .. ; process Prescription MultiDose
"RTN","PSUCP",173,0)
 ..S PSULCT=PSULCT+1
"RTN","PSUCP",174,0)
 ..S PSUPKG="Prescription MultiDose"
"RTN","PSUCP",175,0)
 ..S PSULIN=+$G(^XTMP(PSUSUB,"CONFIRMD",PSUDIV,PSUOPT,"L"))
"RTN","PSUCP",176,0)
 ..S PSUMSG=+$G(^XTMP(PSUSUB,"CONFIRMD",PSUDIV,PSUOPT,"M"))
"RTN","PSUCP",177,0)
 ..S ^XTMP(PSUSUB,"XMD",PSULCT)=PSUPKG_$J(PSULIN,37-$L(PSUPKG))_$J(PSUMSG,12) ;*
"RTN","PSUCP",178,0)
 .S PSUSUBJ="PBM Stats for "
"RTN","PSUCP",179,0)
 .I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D XMD
"RTN","PSUCP",180,0)
CONFIRMQ Q
"RTN","PSUCP",181,0)
 ;
"RTN","PSUCP",182,0)
XMD ;Email
"RTN","PSUCP",183,0)
 ;
"RTN","PSUCP",184,0)
 S XMDUZ=DUZ
"RTN","PSUCP",185,0)
 D XMY^PSUTL1
"RTN","PSUCP",186,0)
 M XMY=PSUXMYS1
"RTN","PSUCP",187,0)
 I $G(PSUMASF)!$G(PSUPBMG) M XMY=PSUXMYH
"RTN","PSUCP",188,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="XM" D ^DIC
"RTN","PSUCP",189,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCP",190,0)
 S XMSUB=PSUSUBJ_PSURP("START")_" to "_PSURP("END")_" from "_PSUDIV_" "_PSUDIVNM
"RTN","PSUCP",191,0)
 S XMTEXT="^XTMP(PSUSUB,""XMD"","
"RTN","PSUCP",192,0)
 S XMCHAN=1
"RTN","PSUCP",193,0)
 D ^XMD
"RTN","PSUCP",194,0)
XMDQ Q
"RTN","PSUCP",195,0)
 ;
"RTN","PSUCP",196,0)
TIMING ; Timing report
"RTN","PSUCP",197,0)
 K ^XTMP(PSUSUB,"XMD")
"RTN","PSUCP",198,0)
 S $P(PSUSPACE," ",41)=""
"RTN","PSUCP",199,0)
 S PSUX=0,PSULCT=0
"RTN","PSUCP",200,0)
 F  S PSUX=$O(^XTMP(PSUSUB,"STATUS",PSUX)) Q:PSUX=""  D
"RTN","PSUCP",201,0)
 .S (X,Y)=^XTMP(PSUSUB,"STATUS",PSUX,"START") X ^DD("DD") D
"RTN","PSUCP",202,0)
 ..I $E(Y,17)=":" S PSUT1=$E(Y,1,16)
"RTN","PSUCP",203,0)
 ..I $E(Y,17)'=":" S PSUT1=$E(Y,1,17)
"RTN","PSUCP",204,0)
 .S (X1,Y)=^XTMP(PSUSUB,"STATUS",PSUX,"STOP") X ^DD("DD") D
"RTN","PSUCP",205,0)
 ..I $E(Y,17)=":" S PSUT2=$E(Y,1,16)
"RTN","PSUCP",206,0)
 ..I $E(Y,17)'=":" S PSUT2=$E(Y,1,17)
"RTN","PSUCP",207,0)
 .S Y=$E(X1_"000",9,10)-$E(X_"000",9,10)*60+$E(X1_"00000",11,12)-$E(X_"00000",11,12),X2=X,X=$P(X,".",1)'=$P(X1,".",1)
"RTN","PSUCP",208,0)
 .D ^%DTC:X S X=X*1440+Y
"RTN","PSUCP",209,0)
 .S PSULCT=PSULCT+1
"RTN","PSUCP",210,0)
 .S PSUREC=$E(PSUA(PSUX,"M")_PSUSPACE,1,20)_$J(PSUT1,20)_$J(PSUT2,20)_$J(X\60,4)_" hrs,"_$J(X#60,3)_" min"
"RTN","PSUCP",211,0)
 .S ^XTMP(PSUSUB,"XMD",PSULCT)=PSUREC
"RTN","PSUCP",212,0)
 S PSULCT=PSULCT+1
"RTN","PSUCP",213,0)
 S $P(^XTMP(PSUSUB,"XMD",PSULCT),"-",80)="" S PSULCT=PSULCT+1
"RTN","PSUCP",214,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="" S PSULCT=PSULCT+1
"RTN","PSUCP",215,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="**NOTE:  Timing for the Provider Data extract is not recorded when" S PSULCT=PSULCT+1
"RTN","PSUCP",216,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="         the IV, Unit Dose, Prescription, and Patient Demographics extracts" S PSULCT=PSULCT+1
"RTN","PSUCP",217,0)
 S ^XTMP(PSUSUB,"XMD",PSULCT)="         are run concurrently."
"RTN","PSUCP",218,0)
 S PSUDIV=PSUSNDR
"RTN","PSUCP",219,0)
 S PSUSUBJ="PBM TIMING for report "
"RTN","PSUCP",220,0)
 D XMD
"RTN","PSUCP",221,0)
TIMINGQ Q
"RTN","PSUCP",222,0)
 ;
"RTN","PSUCP",223,0)
LEAPYR(FMYR) ; Check to see if year is a leap year: 1=leap year, 0=not leap year
"RTN","PSUCP",224,0)
 N YYYY
"RTN","PSUCP",225,0)
 S YYYY=1700+$E(FMYR,1,3)
"RTN","PSUCP",226,0)
 Q (((YYYY#4=0)&(YYYY#100'=0))!((YYYY#100=0)&(YYYY#400=0)))
"RTN","PSUCP1")
0^14^B86988288
"RTN","PSUCP1",1,0)
PSUCP1 ;BIR/TJH,PDW - PBM - CONTROL POINT, MANUAL ENTRY ;25 AUG 1998
"RTN","PSUCP1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCP1",3,0)
 ;
"RTN","PSUCP1",4,0)
 ;DBIA's
"RTN","PSUCP1",5,0)
 ; Reference to file #4   supported by DBIA 10090
"RTN","PSUCP1",6,0)
 ; Reference to file #4.3 supported by DBIA 10091
"RTN","PSUCP1",7,0)
 ; 
"RTN","PSUCP1",8,0)
EN ; start here
"RTN","PSUCP1",9,0)
 D PSUHDR ; display option explanation
"RTN","PSUCP1",10,0)
 S PSUERR=0
"RTN","PSUCP1",11,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSUCP1",12,0)
ASK ; ask type of report desired
"RTN","PSUCP1",13,0)
 S DIR("?",1)="If this is the monthly report that will be sent to the PBM section"
"RTN","PSUCP1",14,0)
 S DIR("?",2)="for inclusion into the master file, answer with a 'Y' for YES."
"RTN","PSUCP1",15,0)
 S DIR("?",3)="If this is not the monthly report or you want to specify a date range"
"RTN","PSUCP1",16,0)
 S DIR("?")="then enter 'N' for NO."
"RTN","PSUCP1",17,0)
 S DIR("A")="Is this the monthly report",DIR(0)="YO"
"RTN","PSUCP1",18,0)
 D ^DIR K DIR W !
"RTN","PSUCP1",19,0)
 G ERR:(Y="^")!(Y="")!($D(DTOUT))
"RTN","PSUCP1",20,0)
 K DTOUT
"RTN","PSUCP1",21,0)
 S PSUAM=Y,ERC=0
"RTN","PSUCP1",22,0)
DATES ; do this if user entered N, wants date range
"RTN","PSUCP1",23,0)
 I 'PSUAM D
"RTN","PSUCP1",24,0)
 .K PSUMNTH
"RTN","PSUCP1",25,0)
 .S %DT(0)=2880000,%DT="AEPX",%DT("A")="Select Start Date: "
"RTN","PSUCP1",26,0)
 .D ^%DT K %DT W !
"RTN","PSUCP1",27,0)
 .I +Y'>0 S ERC=1 Q  ; condition 1, exit.
"RTN","PSUCP1",28,0)
 .S PSUSDT=+Y
"RTN","PSUCP1",29,0)
 .S %DT(0)=2880000,%DT="AEPX",%DT("A")="  Select End Date: "
"RTN","PSUCP1",30,0)
 .D ^%DT K %DT W !
"RTN","PSUCP1",31,0)
 .I +Y'>0 S ERC=1 Q  ; condition 1, exit.
"RTN","PSUCP1",32,0)
 .S PSUEDT=+Y
"RTN","PSUCP1",33,0)
 .I PSUEDT'>PSUSDT D  Q
"RTN","PSUCP1",34,0)
 ..W !!,"The end date of the search must be greater than the start date.",!
"RTN","PSUCP1",35,0)
 ..K PSUSDT,PSUEDT
"RTN","PSUCP1",36,0)
 ..S ERC=2 ; condition 2, ask dates again
"RTN","PSUCP1",37,0)
 .I PSUSDT>DT!(PSUEDT>DT) D
"RTN","PSUCP1",38,0)
 ..W !!,"Searches cannot be executed for future dates.",!
"RTN","PSUCP1",39,0)
 ..K PSUSDT,PSUEDT
"RTN","PSUCP1",40,0)
 ..S ERC=2 ; condition 2, ask dates again
"RTN","PSUCP1",41,0)
 I ERC=1 G ERR
"RTN","PSUCP1",42,0)
 I ERC=2 S ERC=0 G DATES
"RTN","PSUCP1",43,0)
 ;
"RTN","PSUCP1",44,0)
PSUMON ; do this if user asked for monthly report
"RTN","PSUCP1",45,0)
 I PSUAM D
"RTN","PSUCP1",46,0)
 .S PSUMNTH=1
"RTN","PSUCP1",47,0)
 .S %DT(0)=2880000,%DT="MAEP",%DT("A")="Select Month/Year: " K DTOUT,X,Y
"RTN","PSUCP1",48,0)
 .D ^%DT K %DT W !
"RTN","PSUCP1",49,0)
 .S ERC=$S($D(DTOUT):1,X="^":1,X="^^":3,+Y'>0:1,1:0)
"RTN","PSUCP1",50,0)
 .Q:ERC  ; check error condition
"RTN","PSUCP1",51,0)
 .I Y>DT!($E(Y,1,5)=$E(DT,1,5)) D  Q:ERC
"RTN","PSUCP1",52,0)
 ..W !!,"PBM statistical data can only be compiled for months that have already passed.",!
"RTN","PSUCP1",53,0)
 ..K Y
"RTN","PSUCP1",54,0)
 ..S ERC=2 ; condition 2, ask month again
"RTN","PSUCP1",55,0)
 .I $E(Y,4,5)="00" D  Q:ERC
"RTN","PSUCP1",56,0)
 ..W !!,"Oops, you forgot to enter a month.  Try again, please."
"RTN","PSUCP1",57,0)
 ..K Y
"RTN","PSUCP1",58,0)
 ..S ERC=2
"RTN","PSUCP1",59,0)
 .S PSUSDT=$E(Y,1,5)_"01",MNUM=$E(Y,4,5)
"RTN","PSUCP1",60,0)
 .S PSUMTH=$E(Y,1,5)    ;leap year correction
"RTN","PSUCP1",61,0)
 .S PSULY=$$LEAPYR^PSUCP(PSUMTH)    ;leap year correction
"RTN","PSUCP1",62,0)
 .S PSUEDT=$E(Y,1,5)_$S(MNUM["02":$S(PSULY:"29",1:"28"),MNUM="04":"30",MNUM="06":"30",MNUM="09":"30",MNUM="11":"30",1:31)   ;leap year correction
"RTN","PSUCP1",63,0)
 .;S PSUEDT=$E(Y,1,5)_$S(MNUM="02":"29",MNUM="04":"30",MNUM="06":"30",MNUM="09":"30",MNUM="11":"30",1:31)
"RTN","PSUCP1",64,0)
 ;
"RTN","PSUCP1",65,0)
 ;
"RTN","PSUCP1",66,0)
 G ERR:ERC=1,ASK:ERC=3
"RTN","PSUCP1",67,0)
 I ERC=2 S ERC=0 G PSUMON ; erroneous input, try again
"RTN","PSUCP1",68,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUMONTH")=$E(PSUSDT,1,5)
"RTN","PSUCP1",69,0)
 ;
"RTN","PSUCP1",70,0)
SETDT ; set month name variables
"RTN","PSUCP1",71,0)
 S X=PSUSDT D DATE S PSUMON1=Y
"RTN","PSUCP1",72,0)
 S X=PSUEDT D DATE S PSUMON2=Y
"RTN","PSUCP1",73,0)
 S X=$E(PSUSDT,1,5)_"00" D DATE S PSUMON=$E(PSUSDT,1,5)
"RTN","PSUCP1",74,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUMONTH")=PSUMON
"RTN","PSUCP1",75,0)
 K X,X1
"RTN","PSUCP1",76,0)
 ;
"RTN","PSUCP1",77,0)
SELF ; include self and PSU PBM mailgroup
"RTN","PSUCP1",78,0)
 S PSUPBMG=0
"RTN","PSUCP1",79,0)
 S PSUDUZ=0
"RTN","PSUCP1",80,0)
 S DIR("A")="Do you want a copy of this report sent to you in a MailMan message"
"RTN","PSUCP1",81,0)
 S DIR("?")="Please answer with a 'Y' or 'N'."
"RTN","PSUCP1",82,0)
 S DIR(0)="YO",DIR("B")="NO"
"RTN","PSUCP1",83,0)
 D ^DIR K DIR,DIRUT,DIROUT,DUOUT,DTOUT W !
"RTN","PSUCP1",84,0)
 G ERR:Y="",ERR:Y="^",DATES:Y["^^"
"RTN","PSUCP1",85,0)
 I Y S PSUDUZ=DUZ,^XTMP("PSU_"_PSUJOB,"PSUFLAG1")="",^XTMP("PSU_"_PSUJOB,"PSUFLAG2")="",PSUFLAG1=1,PSUFLAG2=1
"RTN","PSUCP1",86,0)
 I 'Y S ^XTMP("PSU_"_PSUJOB,"PSUFLAG3")="",PSUFLAG3=1
"RTN","PSUCP1",87,0)
 I Y S PSUPBMG=1  ;Send copy to PSU PBM mail group
"RTN","PSUCP1",88,0)
 ;
"RTN","PSUCP1",89,0)
MASTER ; if monthly, should it be added to master file
"RTN","PSUCP1",90,0)
 S (PSUMASF,Y)=0
"RTN","PSUCP1",91,0)
 I PSUAM D
"RTN","PSUCP1",92,0)
 .S DIR("A")="Send this to the PBM section for addition to the master file"
"RTN","PSUCP1",93,0)
 .S DIR("?")="Please answer with a 'Y' or 'N'."
"RTN","PSUCP1",94,0)
 .S DIR(0)="YO",DIR("B")="NO"
"RTN","PSUCP1",95,0)
 .D ^DIR K DIR,DIRUT,DIROUT,DUOUT,DTOUT W !
"RTN","PSUCP1",96,0)
 G ERR:Y="",ERR:Y="^",SELF:Y["^^"
"RTN","PSUCP1",97,0)
 I Y S PSUMASF=1
"RTN","PSUCP1",98,0)
 ;
"RTN","PSUCP1",99,0)
MODULE ; display and select module(s)
"RTN","PSUCP1",100,0)
 D OPTS^PSUCP ; set up PSUA array with option info
"RTN","PSUCP1",101,0)
 W !!,"Select one or more of the following:",!
"RTN","PSUCP1",102,0)
 F I=1:1:12 W !,I,".",?5,PSUA(I,"M")
"RTN","PSUCP1",103,0)
 W !!,"Laboratory data and a Patient Demographic summary report will be automatically"
"RTN","PSUCP1",104,0)
 W !,"generated if IVs, Unit Dose, or Prescription extracts are chosen."
"RTN","PSUCP1",105,0)
 W !,"You may select all of the modules by entering 'A' for ALL or by using '1:12'."
"RTN","PSUCP1",106,0)
 W !!,"The Provider Data report may take an extended amount of time to run."
"RTN","PSUCP1",107,0)
 W !,"It is recommended that it be run during off peak hours."
"RTN","PSUCP1",108,0)
MODP ; module selection prompt
"RTN","PSUCP1",109,0)
 W !!,"Select the code(s) associated with the data requested: "
"RTN","PSUCP1",110,0)
 R X:DTIME E  G ERR
"RTN","PSUCP1",111,0)
 I X["^" G ERR:X="^",MASTER:PSUAM,SELF
"RTN","PSUCP1",112,0)
 I X="" W "  <??>",$C(7) S X="?"
"RTN","PSUCP1",113,0)
 ;
"RTN","PSUCP1",114,0)
 ;
"RTN","PSUCP1",115,0)
 ;I X["7" D  G MODULE
"RTN","PSUCP1",116,0)
 ;.W !!,"Lab may not be selected directly.  It will be automatically included when"
"RTN","PSUCP1",117,0)
 ;.W !,"options 1, 2 or 4 are part of the selection."
"RTN","PSUCP1",118,0)
 S:"Aa"[$E(X) X="1:12"
"RTN","PSUCP1",119,0)
MODHLP I X["?" D  G MODULE:X["??",MODP
"RTN","PSUCP1",120,0)
 .W !!,"Enter:  A single code number to print just that report."
"RTN","PSUCP1",121,0)
 .W !,?8,"A range of code numbers.  Example:  1:3"
"RTN","PSUCP1",122,0)
 .W !,?8,"Multiple code numbers separated by commas.  Example:  2,4,5"
"RTN","PSUCP1",123,0)
 .W !,?8,"The letter A to select ALL reports."
"RTN","PSUCP1",124,0)
 .W !,?8,"A single up-arrow ( ^ ) to exit now without running any reports."
"RTN","PSUCP1",125,0)
 .W !,?8,"Double up-arrow  ( ^^ ) to go back to a previous prompt.",!
"RTN","PSUCP1",126,0)
 S X=$TR(X,"-;_><.A","::::::")
"RTN","PSUCP1",127,0)
 K PSUMOD
"RTN","PSUCP1",128,0)
 F PII=1:1:$L(X,",") D
"RTN","PSUCP1",129,0)
 .S X1=$P(X,",",PII)
"RTN","PSUCP1",130,0)
 .Q:X1=""
"RTN","PSUCP1",131,0)
 .I X1[":" D  Q
"RTN","PSUCP1",132,0)
 ..S XBEG=$P(X1,":",1),XEND=$P(X1,":",2)
"RTN","PSUCP1",133,0)
 ..I (XBEG="")!(XEND="") Q
"RTN","PSUCP1",134,0)
 ..F PJJ=XBEG:1:XEND S PSUMOD(PJJ)=""
"RTN","PSUCP1",135,0)
 ..K PJJ,XBEG,XEND
"RTN","PSUCP1",136,0)
 .S PSUMOD(X1)=""
"RTN","PSUCP1",137,0)
 S (X,ERC)=0 F  S X=$O(PSUMOD(X)) Q:X=""  I '$D(PSUA(X)) S ERC=1 Q
"RTN","PSUCP1",138,0)
 I ERC W !!,"<INVALID CHOICE - ",X,", TRY AGAIN>",$C(7) G MODP
"RTN","PSUCP1",139,0)
 I '$D(PSUMOD) W !!,"No choices were made." S X="?" G MODHLP
"RTN","PSUCP1",140,0)
 ;
"RTN","PSUCP1",141,0)
 F PII=1,2,4 I $D(PSUMOD(PII)) S PSUMOD(13)="" ; add Lab if IV,UD or OP
"RTN","PSUCP1",142,0)
 ;
"RTN","PSUCP1",143,0)
 W !!,"You have selected: "
"RTN","PSUCP1",144,0)
 S X="",PSUOPTS="" F  S X=$O(PSUMOD(X)) Q:X=""  W ?20,X," - ",PSUA(X,"M"),! S PSUOPTS=PSUOPTS_X_","
"RTN","PSUCP1",145,0)
 I $D(PSUMOD(1))!$D(PSUMOD(2))!$D(PSUMOD(4)) D
"RTN","PSUCP1",146,0)
 . W ?20,"Patient Demographic Summary" W !
"RTN","PSUCP1",147,0)
 S PSUOPTS=$E(PSUOPTS,1,$L(PSUOPTS)-1) ; remove trailing comma
"RTN","PSUCP1",148,0)
 ;
"RTN","PSUCP1",149,0)
 ;Set flag for combined AMIS summary report.
"RTN","PSUCP1",150,0)
 I (PSUOPTS["1,2,3,4")&(PSUOPTS[6) S ^XTMP("PSU_"_PSUJOB,"CBAMIS")=""
"RTN","PSUCP1",151,0)
 ;
"RTN","PSUCP1",152,0)
RPT ; select report type - full report or summary only
"RTN","PSUCP1",153,0)
 D:PSUOPTS'=11&(PSUOPTS'=12)        ; no summary for VITALS/IMMS OR AA**
"RTN","PSUCP1",154,0)
 . S DIR("A")="Print Summary Only"
"RTN","PSUCP1",155,0)
 . S DIR("?",1)="Please answer with a 'Y' or 'N'."
"RTN","PSUCP1",156,0)
 . S DIR("?")="Answer Yes and only the summary report will be generated."
"RTN","PSUCP1",157,0)
 . S DIR(0)="YO",DIR("B")="NO"
"RTN","PSUCP1",158,0)
 . D ^DIR K DIR,DIRUT,DIROUT,DUOUT,DTOUT W !
"RTN","PSUCP1",159,0)
 . G ERR:Y="",ERR:Y="^",MODULE:Y["^^"
"RTN","PSUCP1",160,0)
 . S PSUSMRY=$S(Y:1,1:0)
"RTN","PSUCP1",161,0)
 S:PSUOPTS=11!(PSUOPTS=12) PSUSMRY=0
"RTN","PSUCP1",162,0)
 ;
"RTN","PSUCP1",163,0)
 ;
"RTN","PSUCP1",164,0)
BCKGND ; always run as a background job
"RTN","PSUCP1",165,0)
 W !!,"This report will automatically run as a background job."
"RTN","PSUCP1",166,0)
 ; ask time to queue
"RTN","PSUCP1",167,0)
 S DIR("?",1)="You can start the program now or queue it to start later."
"RTN","PSUCP1",168,0)
 S DIR("?",2)="Past date/time is not allowed.  Future dates up to 10 days are allowed."
"RTN","PSUCP1",169,0)
 S DIR("?")="Enter an appropriate date and time or press <Enter> to start now."
"RTN","PSUCP1",170,0)
 S %DT="RX",X="NOW+10" D ^%DT
"RTN","PSUCP1",171,0)
 S DIR("A")="REQUESTED TIME TO RUN: ",DIR(0)="DAO^NOW:"_Y_":EFRX"
"RTN","PSUCP1",172,0)
 S DIR("B")="NOW"
"RTN","PSUCP1",173,0)
 D ^DIR K DIR W !
"RTN","PSUCP1",174,0)
 G ERR:(Y="^")!(Y="")!($D(DTOUT))
"RTN","PSUCP1",175,0)
 K DTOUT
"RTN","PSUCP1",176,0)
 S PSUDTH=Y
"RTN","PSUCP1",177,0)
 ;
"RTN","PSUCP1",178,0)
DEVICE ;
"RTN","PSUCP1",179,0)
 S PSUIOP="",PSUPOP=1
"RTN","PSUCP1",180,0)
 I 'PSUDUZ D  G ERR:POP
"RTN","PSUCP1",181,0)
 . I PSUOPTS=11!(PSUOPTS=12) W !,"HARDCOPIES NOT AVAILABLE FOR THIS OPTION" S POP=1 Q
"RTN","PSUCP1",182,0)
 .S PSUIO=ION_";"_IOST_";"_IOM_";"_IOSL
"RTN","PSUCP1",183,0)
 .S %ZIS="N0",%ZIS("B")="",%ZIS("A")="Select 132 column device: "
"RTN","PSUCP1",184,0)
 .D ^%ZIS K %ZIS
"RTN","PSUCP1",185,0)
 .I POP!($E(IOST)="C"),$G(PSUFQ) D  I PSUPOP S POP=1 Q
"RTN","PSUCP1",186,0)
 ..W !!,"You have not selected an appropriate print device."
"RTN","PSUCP1",187,0)
 ..W !,"Enter 'C' to continue data compilation and send mail messages"
"RTN","PSUCP1",188,0)
 ..W !,"          but not print any hardcopy."
"RTN","PSUCP1",189,0)
 ..W !,"Enter '^' to abort this whole option now."
"RTN","PSUCP1",190,0)
 ..F  R !,"-> ",PSUX:DTIME Q:"C^"[$E(PSUX)  W "  ??"
"RTN","PSUCP1",191,0)
 ..S PSUPOP=$S(PSUX="C":0,1:1)
"RTN","PSUCP1",192,0)
 .S PSUIOP=$S('PSUPOP:"",1:ION_";"_IOST_";"_IOM_";"_IOSL) ; save printer parameters
"RTN","PSUCP1",193,0)
 .D RESETVAR^%ZIS ; restore terminal parameters
"RTN","PSUCP1",194,0)
EXIT ; exit point for normal finish
"RTN","PSUCP1",195,0)
 ;
"RTN","PSUCP1",196,0)
 Q  ; return to calling routine, ^PSUCP
"RTN","PSUCP1",197,0)
 ;
"RTN","PSUCP1",198,0)
PSUHDR ;Display header
"RTN","PSUCP1",199,0)
 W !!,"The Pharmacy Benefits Management (PBM) report will extract"
"RTN","PSUCP1",200,0)
 W !,"statistics from one or more of the following files:",!
"RTN","PSUCP1",201,0)
 W !,"1. Pharmacy Patient IV Sub-file       File # 55.01"
"RTN","PSUCP1",202,0)
 W !,"2. Pharmacy Patient UD Sub-file       File # 55.06"
"RTN","PSUCP1",203,0)
 W !,"3. AR/WS Stats                        File # 58.5"
"RTN","PSUCP1",204,0)
 W !,"4. Prescription                       File # 52"
"RTN","PSUCP1",205,0)
 W !,"5. Procurement                        File # 58.811,# 58.81"
"RTN","PSUCP1",206,0)
 W !,"6. Controlled Substances              File # 58.81"
"RTN","PSUCP1",207,0)
 W !,"7. Patient Demographics               File # 2"
"RTN","PSUCP1",208,0)
 W !,"8. Outpatient Visits                  File # 9000010,# 9000010.07"
"RTN","PSUCP1",209,0)
 W !,"9. Inpatient PTF Record               File # 45"
"RTN","PSUCP1",210,0)
 W !,"10. Provider Data                     File # 200,# 7,# 49,# 8932.1"
"RTN","PSUCP1",211,0)
 W !,"11. Allergy/Adverse Event             File # 120.8,# 120.85"
"RTN","PSUCP1",212,0)
 W !,"12. Vitals/Immunization Record        File # 120.5,# 9999999.14"
"RTN","PSUCP1",213,0)
 W !,"13. Laboratory                        File # 60,# 63"
"RTN","PSUCP1",214,0)
 ;
"RTN","PSUCP1",215,0)
 W !!,"This data can be collected for ALL of the files listed or for one or"
"RTN","PSUCP1",216,0)
 W !,"more specific files.  A summary of data or a detailed report by drug"
"RTN","PSUCP1",217,0)
 W !,"can be delivered to you in a mail message or in a hard copy report.",!!
"RTN","PSUCP1",218,0)
 Q
"RTN","PSUCP1",219,0)
 ;
"RTN","PSUCP1",220,0)
DATE ;Date conversion
"RTN","PSUCP1",221,0)
 S Y=X X ^DD("DD") S:Y="" Y="Unknown"
"RTN","PSUCP1",222,0)
 Q
"RTN","PSUCP1",223,0)
 ;
"RTN","PSUCP1",224,0)
ERR ; Exit point following erroneous input or ^
"RTN","PSUCP1",225,0)
 K ERC,MNUM,MOD,PII,PSUA,PSUAM,PSUDUZ,PSUEDT,PSUPBMG,PSUMASF,PSUPBMG,PSUMNTH,PSUMOD
"RTN","PSUCP1",226,0)
 ;K PSUMON,PSUMON1,PSUMON2,PSUOPTS,PSUSDT,PSUSMRY,X1
"RTN","PSUCP1",227,0)
 K PSUMON1,PSUMON2,PSUOPTS,PSUSDT,PSUSMRY,X1
"RTN","PSUCP1",228,0)
 S PSUERR=1
"RTN","PSUCP1",229,0)
 Q
"RTN","PSUCP1",230,0)
 ;
"RTN","PSUCP2")
0^15^B21874165
"RTN","PSUCP2",1,0)
PSUCP2 ;BIR/TJH - CHECK COMPLETION OF MONTHLY PBM REPORT ;25 AUG 1998
"RTN","PSUCP2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCP2",3,0)
 ;
"RTN","PSUCP2",4,0)
 ;DBIAs
"RTN","PSUCP2",5,0)
 ; Reference to File #4    supported by DBIA 10090
"RTN","PSUCP2",6,0)
 ; Reference to File #4.3  supported by DBIA 10091
"RTN","PSUCP2",7,0)
 ; Reference to File #40.8 supported by DBIA 2438
"RTN","PSUCP2",8,0)
 ; Reference to File #59.7 supported by DBIA 2854
"RTN","PSUCP2",9,0)
 ;
"RTN","PSUCP2",10,0)
MANUAL ; Entry point if tasked by PSU PBM MANUAL option
"RTN","PSUCP2",11,0)
 S PSUWAY="Manual"
"RTN","PSUCP2",12,0)
AUTO ; Entry point if tasked by PSU PBM AUTO option
"RTN","PSUCP2",13,0)
 I '$D(PSUWAY) S PSUWAY="Automatic"
"RTN","PSUCP2",14,0)
 D NOW^%DTC
"RTN","PSUCP2",15,0)
 S PSUNOW=% K %,%H,%I,X
"RTN","PSUCP2",16,0)
 S PSULRD=$$VALI^PSUTL(59.7,1,90) ; last run date
"RTN","PSUCP2",17,0)
 D
"RTN","PSUCP2",18,0)
 .I PSULRD="" S PSUOK=0 Q  ; it's 24 hours later and finish time is not set, may be a problem.
"RTN","PSUCP2",19,0)
 .S X1=PSUNOW,X2=PSULRD D ^%DTC
"RTN","PSUCP2",20,0)
 .I X>6 S PSUOK=0 Q  ; the last run date must be left over from a previous run, it's a problem.
"RTN","PSUCP2",21,0)
 .S PSUOK=1
"RTN","PSUCP2",22,0)
 G:PSUOK EXIT ; no message sent if OK.
"RTN","PSUCP2",23,0)
 D XMY^PSUTL1
"RTN","PSUCP2",24,0)
 M XMY=PSUXMYS1
"RTN","PSUCP2",25,0)
 I $G(PSUMASF) M XMY=PSUXMYH
"RTN","PSUCP2",26,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUDIV=+$$VAL^PSUTL(4,X,99)
"RTN","PSUCP2",27,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="XM" D ^DIC
"RTN","PSUCP2",28,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCP2",29,0)
 S XMSUB="PBM "_PSUWAY_" Statistics Job "_PSUDIV_" "_PSUDIVNM
"RTN","PSUCP2",30,0)
 S X(1)="The PBM "_PSUWAY_" Statistics background job did not run to completion."
"RTN","PSUCP2",31,0)
 S X(2)="Please correct the problem and retransmit the data to the National PBM"
"RTN","PSUCP2",32,0)
 S X(3)="section at Hines."
"RTN","PSUCP2",33,0)
 S XMTEXT="X("
"RTN","PSUCP2",34,0)
 S XMCHAN=1
"RTN","PSUCP2",35,0)
 D ^XMD
"RTN","PSUCP2",36,0)
EXIT ; normal exit point from PSUCP2
"RTN","PSUCP2",37,0)
 K PSUWAY,PSUNOW,PSULRD,PSUOK,PSUDIV,PSUDIVNM
"RTN","PSUCP2",38,0)
 Q
"RTN","PSUCP2",39,0)
MMNOMAP ; Generate MM regarding locations not mapped
"RTN","PSUCP2",40,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;Quit if user does not want a 
"RTN","PSUCP2",41,0)
 ;copy sent to self
"RTN","PSUCP2",42,0)
 ;
"RTN","PSUCP2",43,0)
 N TXT1,TXT2
"RTN","PSUCP2",44,0)
 ;
"RTN","PSUCP2",45,0)
 D PULL^PSUCP
"RTN","PSUCP2",46,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUCP2",47,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99),PSUNAME=$$VAL^PSUTL(4,X,.01)
"RTN","PSUCP2",48,0)
 K TXT
"RTN","PSUCP2",49,0)
 S TXT(1)="The locations listed below have not been mapped to a Medical Center"
"RTN","PSUCP2",50,0)
 S TXT(2)="Division or Outpatient Site. All data extracted from these locations have"
"RTN","PSUCP2",51,0)
 S TXT(3)="been attributed to "_PSUSNDR_" "_PSUNAME
"RTN","PSUCP2",52,0)
 S TXT(4)=" "
"RTN","PSUCP2",53,0)
 S TLC=4
"RTN","PSUCP2",54,0)
 ;
"RTN","PSUCP2",55,0)
 I $D(PSUARSUB) D
"RTN","PSUCP2",56,0)
 .I $D(^XTMP(PSUARSUB,"AOU")),$D(PSUMOD(3)) D
"RTN","PSUCP2",57,0)
 ..K AOUNMAP,MAP  ;Array to hold unmapped AOU data
"RTN","PSUCP2",58,0)
 ..N LOC,LOC1
"RTN","PSUCP2",59,0)
 ..M MAP=^XTMP(PSUARSUB,"AOU")
"RTN","PSUCP2",60,0)
 ..F TXT=" ","AOUs:" D TXT
"RTN","PSUCP2",61,0)
 ..S IEN=0 F  S IEN=$O(MAP(IEN)) Q:IEN=""  D
"RTN","PSUCP2",62,0)
 ...S LOC=MAP(IEN,.01)
"RTN","PSUCP2",63,0)
 ...M AOUNMAP(LOC)=MAP(IEN)
"RTN","PSUCP2",64,0)
 ..S LOC1=0
"RTN","PSUCP2",65,0)
 ..F  S LOC1=$O(AOUNMAP(LOC1)) Q:LOC1=""  D
"RTN","PSUCP2",66,0)
 ...S TXT1=AOUNMAP(LOC1,.01)
"RTN","PSUCP2",67,0)
 ...S TXT2=$G(AOUNMAP(LOC1,3)) I TXT2'="" S TXT2="   **INACTIVE**"
"RTN","PSUCP2",68,0)
 ...S TXT=TXT1_TXT2 D TXT
"RTN","PSUCP2",69,0)
 .;
"RTN","PSUCP2",70,0)
 .I '$D(^XTMP(PSUARSUB,"AOU")),$D(PSUMOD(3)) D
"RTN","PSUCP2",71,0)
 ..F TXT=" ","AOUs:" D TXT
"RTN","PSUCP2",72,0)
 ..S TXT="There are no unmapped AOU's for the dates of this extract" D TXT
"RTN","PSUCP2",73,0)
 ;
"RTN","PSUCP2",74,0)
 I $D(PSUARSUB) D
"RTN","PSUCP2",75,0)
 .I $D(^XTMP(PSUARSUB,"NAOU")),$D(PSUMOD(6)) D
"RTN","PSUCP2",76,0)
 ..K NAOUMAP,MAP
"RTN","PSUCP2",77,0)
 ..N LOC,LOC1
"RTN","PSUCP2",78,0)
 ..M MAP=^XTMP(PSUARSUB,"NAOU")
"RTN","PSUCP2",79,0)
 ..F TXT="","NAOUs:" D TXT
"RTN","PSUCP2",80,0)
 ..S IEN=0 F  S IEN=$O(MAP(IEN)) Q:IEN'>0  D
"RTN","PSUCP2",81,0)
 ...S LOC=MAP(IEN,.01)
"RTN","PSUCP2",82,0)
 ...M NAOUMAP(LOC)=MAP(IEN)
"RTN","PSUCP2",83,0)
 ..S LOC1=0
"RTN","PSUCP2",84,0)
 ..F  S LOC1=$O(NAOUMAP(LOC1)) Q:LOC1=""  D
"RTN","PSUCP2",85,0)
 ...S TXT1=NAOUMAP(LOC1,.01)
"RTN","PSUCP2",86,0)
 ...S TXT2=$G(NAOUMAP(LOC1,4)) I TXT2'="" S TXT2="   **INACTIVE**"
"RTN","PSUCP2",87,0)
 ...S TXT=TXT1_TXT2 D TXT
"RTN","PSUCP2",88,0)
 .;
"RTN","PSUCP2",89,0)
 .I '$D(^XTMP(PSUARSUB,"NAOU")),$D(PSUMOD(6)) D
"RTN","PSUCP2",90,0)
 .. F TXT=" ","NAOUs:" D TXT
"RTN","PSUCP2",91,0)
 ..S TXT="There are no unmapped NAOU's for the dates of this extract" D TXT
"RTN","PSUCP2",92,0)
 ;
"RTN","PSUCP2",93,0)
 I $D(PSUARSUB) D
"RTN","PSUCP2",94,0)
 .I $D(^XTMP(PSUARSUB,"DAPH")),$D(PSUMOD(5)) D
"RTN","PSUCP2",95,0)
 ..K DAPH,MAP
"RTN","PSUCP2",96,0)
 ..N LOC,LOC1
"RTN","PSUCP2",97,0)
 ..M MAP=^XTMP(PSUARSUB,"DAPH")
"RTN","PSUCP2",98,0)
 ..F TXT="","DA Pharmacy Locations:" D TXT
"RTN","PSUCP2",99,0)
 ..S IEN=0 F  S IEN=$O(MAP(IEN)) Q:IEN'>0  D
"RTN","PSUCP2",100,0)
 ...S LOC=MAP(IEN,.01)
"RTN","PSUCP2",101,0)
 ...M DAPH(LOC)=MAP(IEN)
"RTN","PSUCP2",102,0)
 ..S LOC1=0
"RTN","PSUCP2",103,0)
 ..F  S LOC1=$O(DAPH(LOC1)) Q:LOC1=""  D
"RTN","PSUCP2",104,0)
 ...S TXT1=DAPH(LOC1,.01)
"RTN","PSUCP2",105,0)
 ...S TXT2=$G(DAPH(LOC1,4)) I TXT2'="" S TXT2="   **INACTIVE**"
"RTN","PSUCP2",106,0)
 ...S TXT=TXT1_TXT2 D TXT
"RTN","PSUCP2",107,0)
 .;
"RTN","PSUCP2",108,0)
 .I '$D(^XTMP(PSUARSUB,"DAPH")),$D(PSUMOD(5)) D
"RTN","PSUCP2",109,0)
 .. F TXT=" ","DA Pharmacy Locations:" D TXT
"RTN","PSUCP2",110,0)
 ..S TXT="There are no unmapped DA Pharmacy Locations for the dates of this extract" D TXT
"RTN","PSUCP2",111,0)
 ;
"RTN","PSUCP2",112,0)
MSGNOMAP ; send MM 
"RTN","PSUCP2",113,0)
 ;
"RTN","PSUCP2",114,0)
 S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y
"RTN","PSUCP2",115,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y
"RTN","PSUCP2",116,0)
 S XMSUB="PBM Unmapped Locations for "_PSUDTS_" to "_PSUDTE_" from "_PSUSNDR_" "_PSUNAME
"RTN","PSUCP2",117,0)
 S XMTEXT="TXT("
"RTN","PSUCP2",118,0)
 S XMY("G.PSU PBM")=""
"RTN","PSUCP2",119,0)
 S XMY(DUZ)=""
"RTN","PSUCP2",120,0)
 I $D(PSUARSUB) D ^XMD
"RTN","PSUCP2",121,0)
 Q
"RTN","PSUCP2",122,0)
 ;
"RTN","PSUCP2",123,0)
TXT S TLC=TLC+1,TXT(TLC)=TXT
"RTN","PSUCP2",124,0)
 Q
"RTN","PSUCP3")
0^16^B410303
"RTN","PSUCP3",1,0)
PSUCP3 ;BIR/REG - PBM UTILITY TO PURGE ^XTMP and ^XTMP ;25 AUG 1998 
"RTN","PSUCP3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCP3",3,0)
EN ;
"RTN","PSUCP3",4,0)
 N PSUI,PSUPDT,PSUCDT,PSUI1,PSUI2
"RTN","PSUCP3",5,0)
 D NOW^%DTC
"RTN","PSUCP3",6,0)
 S PSUCDT=X
"RTN","PSUCP3",7,0)
 S PSUI="PSU"
"RTN","PSUCP3",8,0)
 F  S PSUI=$O(^XTMP(PSUI)) Q:$E(PSUI,1,3)'="PSU"  D
"RTN","PSUCP3",9,0)
 .K ^XTMP(PSUI) Q
"RTN","PSUCP3",10,0)
 .S PSUPDT=$P($G(^XTMP(PSUI,0)),"^",1)
"RTN","PSUCP3",11,0)
 .I PSUPDT="" K ^XTMP(PSUI) Q
"RTN","PSUCP3",12,0)
 .I PSUPDT<PSUCDT K ^XTMP(PSUI) Q
"RTN","PSUCP3",13,0)
 ;
"RTN","PSUCP3",14,0)
 Q   ;ALL PURGED
"RTN","PSUCS0")
0^17^B1492272
"RTN","PSUCS0",1,0)
PSUCS0 ;BIR/DJE,DJM - PBM CONTROLLED SUBSTANCE (CONTROL POINT) ;25 AUG 1998
"RTN","PSUCS0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS0",3,0)
EN ;EN(PSUMSGT)  ; Entry point
"RTN","PSUCS0",4,0)
 I '$D(PSUJOB) S PSUJOB=$J
"RTN","PSUCS0",5,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,ZTIO,PSUSNDR,PSUOPTS"
"RTN","PSUCS0",6,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P(^XTMP("PSU_"_PSUJOB,1),U,I)
"RTN","PSUCS0",7,0)
 S PSUDUZ=$G(PSUDUZ,DUZ) ;
"RTN","PSUCS0",8,0)
 D EN^PSUCS1 ; Collect all data
"RTN","PSUCS0",9,0)
 D EN^PSUCSR0(.PSUMSGT) ; Mail reports
"RTN","PSUCS0",10,0)
 D EN^PSUCSR2           ; Generate and Mail AMIS summary report
"RTN","PSUCS0",11,0)
 K CSAM,AMISC
"RTN","PSUCS0",12,0)
 Q
"RTN","PSUCS0",13,0)
PRINT ;EP - FOR HARD COPY REPORTING
"RTN","PSUCS0",14,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D
"RTN","PSUCS0",15,0)
 .D GENREP^PSUCSR1(.PSUMSGT)  ;CS AMIS SUMMARY
"RTN","PSUCS0",16,0)
 I $D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D
"RTN","PSUCS0",17,0)
 .D COMBO^PSUCSR1(.PSUMSGT)   ;Combo AMIS summary reports
"RTN","PSUCS0",18,0)
 Q
"RTN","PSUCS1")
0^18^B6704460
"RTN","PSUCS1",1,0)
PSUCS1 ;BIR/DJE - PBM CONTROLLED SUBSTANCE GENERATE RECORDS ;20 OCT 1999
"RTN","PSUCS1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS1",3,0)
 ;
"RTN","PSUCS1",4,0)
 ;DBIA(s)
"RTN","PSUCS1",5,0)
 ; Reference to file #58.81 supported by DBIA 2520
"RTN","PSUCS1",6,0)
 ;
"RTN","PSUCS1",7,0)
 ;3.2.5.1.  Functional Requirement 1
"RTN","PSUCS1",8,0)
 ;3.2.5.2.  Functional Requirement 2
"RTN","PSUCS1",9,0)
 ; DTTM=DATE/TIME
"RTN","PSUCS1",10,0)
 ; PSULOC=PSULOCATION
"RTN","PSUCS1",11,0)
 ; PSUTYP=DISPENSING TYPE
"RTN","PSUCS1",12,0)
 ; PSUIENDA=TRANSACTION
"RTN","PSUCS1",13,0)
INIT ;
"RTN","PSUCS1",14,0)
 S PSUCSJB=$G(PSUCSJB,"PSUCS_"_PSUJOB)
"RTN","PSUCS1",15,0)
 ;*** THE DEFAULT RECORD INDICATOR IS 'H' AND 
"RTN","PSUCS1",16,0)
 ;
"RTN","PSUCS1",17,0)
 K ^XTMP(PSUCSJB)
"RTN","PSUCS1",18,0)
 I '$D(^XTMP(PSUCSJB)) D
"RTN","PSUCS1",19,0)
 . S X1=DT,X2=6 D C^%DTC
"RTN","PSUCS1",20,0)
 . S ^XTMP(PSUCSJB,0)=X_"^"_DT_"^ Controlled Substance Extraction"
"RTN","PSUCS1",21,0)
 S FACILITY=PSUSNDR
"RTN","PSUCS1",22,0)
 S PSUSDT=$G(PSUSDT,"")
"RTN","PSUCS1",23,0)
 S PSUEDT=$G(PSUEDT,"")
"RTN","PSUCS1",24,0)
 S PSUEDT=PSUEDT\1+.24
"RTN","PSUCS1",25,0)
 ;S PSURI="H"   DAM TEST
"RTN","PSUCS1",26,0)
 S PSUMCHK=0
"RTN","PSUCS1",27,0)
 Q
"RTN","PSUCS1",28,0)
 ;
"RTN","PSUCS1",29,0)
EN ;ENTRY POINT
"RTN","PSUCS1",30,0)
 D INIT
"RTN","PSUCS1",31,0)
 S DTTM=PSUSDT
"RTN","PSUCS1",32,0)
 F  S DTTM=$O(^PSD(58.81,"AF",DTTM)) Q:(DTTM="")!(DTTM'<PSUEDT)  D
"RTN","PSUCS1",33,0)
 .S PSULOC=""
"RTN","PSUCS1",34,0)
 .F  S PSULOC=$O(^PSD(58.81,"AF",DTTM,PSULOC)) Q:PSULOC=""  D
"RTN","PSUCS1",35,0)
 .. S PSUTYP=""
"RTN","PSUCS1",36,0)
 .. F  S PSUTYP=$O(^PSD(58.81,"AF",DTTM,PSULOC,PSUTYP)) Q:PSUTYP=""  D
"RTN","PSUCS1",37,0)
 ... ;3.2.5.3.  Functional Requirement 3
"RTN","PSUCS1",38,0)
 ... ;'2'-Dispensed from Pharmacy or '17'- Logged for Patient.
"RTN","PSUCS1",39,0)
 ... Q:(PSUTYP'=17)&(PSUTYP'=2) 
"RTN","PSUCS1",40,0)
 ... ; section 3.2.5.10.
"RTN","PSUCS1",41,0)
 ... ; Check for type 17
"RTN","PSUCS1",42,0)
 ... S PSUIENDA=""
"RTN","PSUCS1",43,0)
 ... F  S PSUIENDA=$O(^PSD(58.81,"AF",DTTM,PSULOC,PSUTYP,PSUIENDA)) Q:PSUIENDA=""  D
"RTN","PSUCS1",44,0)
 .... ; patient IEN
"RTN","PSUCS1",45,0)
 .... S PSUPIEN(73)=$$VALI^PSUTL(58.81,PSUIENDA,"73")
"RTN","PSUCS1",46,0)
 .... ;
"RTN","PSUCS1",47,0)
 .... ; Screen out test patients
"RTN","PSUCS1",48,0)
 .... Q:$$TESTPAT^PSUTL1(PSUPIEN(73))
"RTN","PSUCS1",49,0)
 .... ; Field # 58.81,3 [DATE/TIME]Field to be extracted***
"RTN","PSUCS1",50,0)
 .... S PSUDTM(3)=$$VALI^PSUTL(58.81,PSUIENDA,"3")
"RTN","PSUCS1",51,0)
 .... ;S PSURI="H" S SENDER=PSUSNDR ;DUZ    DAM TEST
"RTN","PSUCS1",52,0)
 .... I PSUTYP=2 D TYP2^PSUCS2 D:'$G(PSUQUIT) BUILDREC^PSUCS5 K PSUSSN,PSUPLC,PSUQUIT ;**9
"RTN","PSUCS1",53,0)
 .... I PSUTYP=17,PSUPIEN(73)'="" D TYP17^PSUCS3 K PSUPLC
"RTN","PSUCS1",54,0)
 .... ;     type 17s to be processed after all are gathered
"RTN","PSUCS1",55,0)
 .... ;     into ^XTMP(,"MC",LOC,PAT,DRG)
"RTN","PSUCS1",56,0)
 ....;3.2.5.5.  Functional Requirement 5
"RTN","PSUCS1",57,0)
 D EN^PSUCS17 ; process type 17s that have been gathered
"RTN","PSUCS1",58,0)
 Q
"RTN","PSUCS17")
0^19^B3906297
"RTN","PSUCS17",1,0)
PSUCS17 ;BIR/DJE,DJM - GENERATE PSU CS RECORDS (TYPE 17) ;25 AUG 1998
"RTN","PSUCS17",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS17",3,0)
 ;
"RTN","PSUCS17",4,0)
 ;DBIA'S
"RTN","PSUCS17",5,0)
 ; Reference to file #58.81 supported by DBIA 2520
"RTN","PSUCS17",6,0)
 ; Reference to file #50    supported by DBIA 221
"RTN","PSUCS17",7,0)
 ;
"RTN","PSUCS17",8,0)
 ; ***
"RTN","PSUCS17",9,0)
 ; TYPE 17 - "Logged for patient"
"RTN","PSUCS17",10,0)
 ; ***
"RTN","PSUCS17",11,0)
EN ;EP  scan the ^XTMP(job,"MC",loc,pat,drug,qt)=PSUIENDA
"RTN","PSUCS17",12,0)
 ;  where type 17 were stored combining multiples for a patient
"RTN","PSUCS17",13,0)
 S PSULOC="",PSUMCHK=0,PSUTYP=17
"RTN","PSUCS17",14,0)
 F  S PSULOC=$O(^XTMP(PSUCSJB,"MC",PSULOC)) Q:PSULOC=""  D
"RTN","PSUCS17",15,0)
 . S DFN=0
"RTN","PSUCS17",16,0)
 . F  S DFN=$O(^XTMP(PSUCSJB,"MC",PSULOC,DFN)) Q:DFN'>0  D DRUG
"RTN","PSUCS17",17,0)
 Q
"RTN","PSUCS17",18,0)
DRUG ;EP loop drugs within patient
"RTN","PSUCS17",19,0)
 S Z=0
"RTN","PSUCS17",20,0)
 F  S Z=$O(^XTMP(PSUCSJB,"MC",PSULOC,DFN,Z)) Q:Z=""  S X=^(Z) D
"RTN","PSUCS17",21,0)
 . S PSUPIEN(73)=DFN
"RTN","PSUCS17",22,0)
 . S PSUIENDA=X,PSUDRG=Z
"RTN","PSUCS17",23,0)
 . S PSUDTM(3)=$$VALI^PSUTL(58.81,PSUIENDA,3),SENDER=PSUSNDR
"RTN","PSUCS17",24,0)
 . ;S PSURI="H"   DAM TEST
"RTN","PSUCS17",25,0)
 . N Z
"RTN","PSUCS17",26,0)
 . D TYP17
"RTN","PSUCS17",27,0)
 . I 'PSUTQY(5) Q  ; do not send if QTY=0
"RTN","PSUCS17",28,0)
 . D BUILDREC^PSUCS5
"RTN","PSUCS17",29,0)
 . K PSUSSN,PSUPLC
"RTN","PSUCS17",30,0)
 Q
"RTN","PSUCS17",31,0)
 ;     
"RTN","PSUCS17",32,0)
TYP17 ; Processing the transaction for dispensing type 17 
"RTN","PSUCS17",33,0)
 ;('logged for patient'). If the dispensing type=17 and a patient IEN 
"RTN","PSUCS17",34,0)
 ;is identified, one can use this information one find the ward location
"RTN","PSUCS17",35,0)
 ;if the patient is still an inpatient when the extract is done.
"RTN","PSUCS17",36,0)
 D FACILTY
"RTN","PSUCS17",37,0)
 ;     
"RTN","PSUCS17",38,0)
 ; (type 17 specific call)
"RTN","PSUCS17",39,0)
 ; Patient SSN
"RTN","PSUCS17",40,0)
 D SSN
"RTN","PSUCS17",41,0)
 ;
"RTN","PSUCS17",42,0)
 ; Generic name, Location type.
"RTN","PSUCS17",43,0)
 D GNAME^PSUCS4,LOCTYP^PSUCS4
"RTN","PSUCS17",44,0)
 ; Requirement 3.2.5.7
"RTN","PSUCS17",45,0)
 Q:"N"'[PSULTP(1)
"RTN","PSUCS17",46,0)
 ;
"RTN","PSUCS17",47,0)
 ;
"RTN","PSUCS17",48,0)
 ;VA Drug class, Formulary/Non-formulary, National formulary Indicator.
"RTN","PSUCS17",49,0)
 D NDC^PSUCS4,FORMIND^PSUCS4,NFIND^PSUCS4
"RTN","PSUCS17",50,0)
 ;
"RTN","PSUCS17",51,0)
 ;(type 17 specific call)
"RTN","PSUCS17",52,0)
 ; Dispense unit, unit cost, Quantity
"RTN","PSUCS17",53,0)
 D DUNIT,UNITC,QTY17
"RTN","PSUCS17",54,0)
 ;
"RTN","PSUCS17",55,0)
 ; VA Product name, VA drug class, Packaging
"RTN","PSUCS17",56,0)
 D VPNAME^PSUCS4,VDC^PSUCS4
"RTN","PSUCS17",57,0)
 ;
"RTN","PSUCS17",58,0)
 Q 
"RTN","PSUCS17",59,0)
 ;
"RTN","PSUCS17",60,0)
 ;
"RTN","PSUCS17",61,0)
 ; 
"RTN","PSUCS17",62,0)
 ; Type 17 specific calls
"RTN","PSUCS17",63,0)
 ; 
"RTN","PSUCS17",64,0)
 ;
"RTN","PSUCS17",65,0)
 ;           
"RTN","PSUCS17",66,0)
FACILTY ;
"RTN","PSUCS17",67,0)
 D DIVISION^PSUCS2
"RTN","PSUCS17",68,0)
 Q
"RTN","PSUCS17",69,0)
 ;
"RTN","PSUCS17",70,0)
SSN ;Field # 58.81,73 [PATIENT]  Points to File # 2
"RTN","PSUCS17",71,0)
 ;Field # 2,.09 [SOCIAL SECURITY NUMBER]**Field to be extracted
"RTN","PSUCS17",72,0)
 Q:$G(PSUPIEN(73))=""
"RTN","PSUCS17",73,0)
 S DFN=PSUPIEN(73) D PID^VADPT
"RTN","PSUCS17",74,0)
 S PSUSSN(.09)=$TR(VA("PID"),"-","")
"RTN","PSUCS17",75,0)
 Q
"RTN","PSUCS17",76,0)
 ; 
"RTN","PSUCS17",77,0)
DUNIT ;Dispense Unit
"RTN","PSUCS17",78,0)
 ;Field # 50,14.5 [DISPENSE UNIT]**Field to be extracted
"RTN","PSUCS17",79,0)
 S PSUDUN(14.5)=$$VALI^PSUTL(50,PSUDRG(4),"14.5")
"RTN","PSUCS17",80,0)
 S UNIT=PSUDUN(14.5)
"RTN","PSUCS17",81,0)
 Q
"RTN","PSUCS17",82,0)
 ;
"RTN","PSUCS17",83,0)
UNITC ;Unit Cost
"RTN","PSUCS17",84,0)
 ;Field # 50,16 [PRICE PER DISPENSE UNIT]**Field to be extracted
"RTN","PSUCS17",85,0)
 S PSUPDU(16)=$$VALI^PSUTL(50,PSUDRG(4),"16")
"RTN","PSUCS17",86,0)
 Q
"RTN","PSUCS17",87,0)
 ;
"RTN","PSUCS17",88,0)
QTY17 ;For transactions with a dispensing type =17, total the number of doses
"RTN","PSUCS17",89,0)
 ;dispensed for the same drug (Field # 58.81,4), regardless of the date 
"RTN","PSUCS17",90,0)
 ;dispensed within the reporting month. The dispensed (transaction) date
"RTN","PSUCS17",91,0)
 ;will be the date the first dose was administered to the patient during
"RTN","PSUCS17",92,0)
 ;the reporting period. The data will be transmitted as a single data
"RTN","PSUCS17",93,0)
 ;record.
"RTN","PSUCS17",94,0)
 ;Sum of Values # 58.81,5 [TOTAL QUANTITY]**Field to be extracted
"RTN","PSUCS17",95,0)
 ;  Store in ^XTMP(job,"MC",loc,dfn,drg,qt)
"RTN","PSUCS17",96,0)
 S PSUTQY(5)=^XTMP(PSUCSJB,"MC",PSULOC,DFN,PSUDRG,"QT")
"RTN","PSUCS17",97,0)
 Q
"RTN","PSUCS2")
0^20^B7003780
"RTN","PSUCS2",1,0)
PSUCS2 ;BIR/DJE,DJM - Generate CS records (TYPE2) ;25 AUG 1998
"RTN","PSUCS2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS2",3,0)
 ;
"RTN","PSUCS2",4,0)
 ;DBIA's
"RTN","PSUCS2",5,0)
 ; Reference to File #58.81  supported by DBIA 2520
"RTN","PSUCS2",6,0)
 ; Reference to File #50     supported by DBIA 221
"RTN","PSUCS2",7,0)
 ; Reference to File #58.8   supported by DBIA 2519
"RTN","PSUCS2",8,0)
 ; Reference to File #59     supported by DBIA 2510
"RTN","PSUCS2",9,0)
 ;
"RTN","PSUCS2",10,0)
 ; *
"RTN","PSUCS2",11,0)
 ; TYPE 2 - "Dispensed from pharmacy"
"RTN","PSUCS2",12,0)
 ; *
"RTN","PSUCS2",13,0)
 ;
"RTN","PSUCS2",14,0)
TYP2 ; Processing the transaction for dispensing type 2 
"RTN","PSUCS2",15,0)
 ;('logged for patient'). If the  pharmacy location for transactions 
"RTN","PSUCS2",16,0)
 ;with a dispensing type = 2 is associated with either an Outpatient
"RTN","PSUCS2",17,0)
 ; Or Inpatient site, it may be possible to break down the sender by 
"RTN","PSUCS2",18,0)
 ;the outpatient clinic or inpatient division.
"RTN","PSUCS2",19,0)
 ;
"RTN","PSUCS2",20,0)
 K PSUQUIT
"RTN","PSUCS2",21,0)
 S PSUDRG(4)=$$VALI^PSUTL(58.81,PSUIENDA,4)
"RTN","PSUCS2",22,0)
 ;
"RTN","PSUCS2",23,0)
 ;(type 2 specific call)
"RTN","PSUCS2",24,0)
 D QTY2
"RTN","PSUCS2",25,0)
 I 'PSUTQY(5) S PSUQUIT=1 Q  ; do not send if QTY=0
"RTN","PSUCS2",26,0)
 ;
"RTN","PSUCS2",27,0)
 ;  Unit cost
"RTN","PSUCS2",28,0)
 S PSUPDU(16)=$$VALI^PSUTL(50,PSUDRG(4),16)
"RTN","PSUCS2",29,0)
 ;
"RTN","PSUCS2",30,0)
 ; DIVISION
"RTN","PSUCS2",31,0)
 D DIVISION
"RTN","PSUCS2",32,0)
 ;
"RTN","PSUCS2",33,0)
 ;(Type 2 specific call)
"RTN","PSUCS2",34,0)
 D NAOU
"RTN","PSUCS2",35,0)
 ;
"RTN","PSUCS2",36,0)
 ;        
"RTN","PSUCS2",37,0)
 ; Generic name, Location type.       
"RTN","PSUCS2",38,0)
 D GNAME^PSUCS4,LOCTYP^PSUCS4
"RTN","PSUCS2",39,0)
 ;Requirement 3.2.5.7
"RTN","PSUCS2",40,0)
 I "SM"'[PSULTP(1) S PSUQUIT=1 Q  ;**9
"RTN","PSUCS2",41,0)
 ;W PSULTP(1)
"RTN","PSUCS2",42,0)
 ;Requirement 3.2.5.8
"RTN","PSUCS2",43,0)
 I CPFLG="N" S PSUQUIT=1 Q  ;**9
"RTN","PSUCS2",44,0)
 ;
"RTN","PSUCS2",45,0)
 ;VA Drug class, Formulary/Non-formulary, National formulary Indicator
"RTN","PSUCS2",46,0)
 D NDC^PSUCS4,FORMIND^PSUCS4,NFIND^PSUCS4
"RTN","PSUCS2",47,0)
 ;
"RTN","PSUCS2",48,0)
 ;
"RTN","PSUCS2",49,0)
 ; VA Product name, VA drug class, Package details.
"RTN","PSUCS2",50,0)
 D VPNAME^PSUCS4,VDC^PSUCS4,PDT^PSUCS4
"RTN","PSUCS2",51,0)
 ;
"RTN","PSUCS2",52,0)
 Q
"RTN","PSUCS2",53,0)
 ;
"RTN","PSUCS2",54,0)
 ;
"RTN","PSUCS2",55,0)
 ; 
"RTN","PSUCS2",56,0)
 ; 
"RTN","PSUCS2",57,0)
 ;      
"RTN","PSUCS2",58,0)
DIVISION ;
"RTN","PSUCS2",59,0)
 ;Field # 58.81,2 [PHARMACY LOCATION]  Points to File # 58.8
"RTN","PSUCS2",60,0)
 S PSUPL(2)=$$VALI^PSUTL(58.81,PSUIENDA,"2")
"RTN","PSUCS2",61,0)
 S SENDER=""
"RTN","PSUCS2",62,0)
 N MAPLOCI
"RTN","PSUCS2",63,0)
 D GETM^PSUTL(59.7,1,"90.02*^.01;.02;.03","MAPLOCI","I")
"RTN","PSUCS2",64,0)
 D MOVEMI^PSUTL("MAPLOCI")
"RTN","PSUCS2",65,0)
 ;
"RTN","PSUCS2",66,0)
 I $G(MAPLOCI(PSUPL(2),.01)) D
"RTN","PSUCS2",67,0)
 .S X=$G(MAPLOCI(PSUPL(2),.02)) I X S SENDER=$$VALI^PSUTL(40.8,X,1)
"RTN","PSUCS2",68,0)
 .S X=$G(MAPLOCI(PSUPL(2),.03)) I X S SENDER=$$VALI^PSUTL(59,X,.06)
"RTN","PSUCS2",69,0)
 I '$G(MAPLOCI(PSUPL(2),.01)) D
"RTN","PSUCS2",70,0)
 .S SENDER=PSUSNDR,PSURI="H"
"RTN","PSUCS2",71,0)
 Q
"RTN","PSUCS2",72,0)
 ;
"RTN","PSUCS2",73,0)
NAOU ;3.2.5.6.   Functional Requirement 6
"RTN","PSUCS2",74,0)
 ;The product shall extract the NAOU if the dispensing type =2.
"RTN","PSUCS2",75,0)
 ;Field # 58.81,17 [NAOU]  Points to File # 58.8
"RTN","PSUCS2",76,0)
 S PSUNAOU(17)=$$VALI^PSUTL(58.81,PSUIENDA,"17")
"RTN","PSUCS2",77,0)
 S PSUNAOU=PSUNAOU(17)
"RTN","PSUCS2",78,0)
 ;
"RTN","PSUCS2",79,0)
 ;If the NAOU does not exist for that transaction,
"RTN","PSUCS2",80,0)
 ;extract the Pharmacy PSULOCation.
"RTN","PSUCS2",81,0)
 ;Field # 58.81,2 [PHARMACY PSULOCATION] Points to File # 58.8
"RTN","PSUCS2",82,0)
 I PSUNAOU="" D
"RTN","PSUCS2",83,0)
 .S PSUNAOU(2)=$$VALI^PSUTL(58.81,PSUIENDA,"2")
"RTN","PSUCS2",84,0)
 .S PSUNAOU=PSUNAOU(2)
"RTN","PSUCS2",85,0)
 ;
"RTN","PSUCS2",86,0)
 ;Field # 58.8,.01 [PHARMACY PSULOCATION]***Field to be extracted
"RTN","PSUCS2",87,0)
 S PSUPLC(.01)=$$VALI^PSUTL(58.8,PSUNAOU,".01")
"RTN","PSUCS2",88,0)
 Q
"RTN","PSUCS2",89,0)
 ;       
"RTN","PSUCS2",90,0)
QTY2 ;3.2.5.10.   Functional Requirement 10
"RTN","PSUCS2",91,0)
 ;The product shall extract the total quantity dispensed.  
"RTN","PSUCS2",92,0)
 ;For transactions with a dispensing type=2, check to see if 
"RTN","PSUCS2",93,0)
 ;the quantity was edited (Field # 58.81,48).
"RTN","PSUCS2",94,0)
 ;If so, use the edited (new quantity).
"RTN","PSUCS2",95,0)
 ; if there is a date present then use the NEW QUANTITY value.
"RTN","PSUCS2",96,0)
 ;Field # 58.81,50 [NEW QUANTITY]**Field to be extracted       
"RTN","PSUCS2",97,0)
 S PSUQED(48)=$$VALI^PSUTL(58.81,PSUIENDA,"48")
"RTN","PSUCS2",98,0)
 S PSUTQY(5)=$$VALI^PSUTL(58.81,PSUIENDA,5)
"RTN","PSUCS2",99,0)
 S:'PSUDRG(4) PSUDRG(4)=$$VALI^PSUTL(58.81,PSUIENDA,4)
"RTN","PSUCS2",100,0)
 ;
"RTN","PSUCS2",101,0)
 I PSUQED(48) S PSUTQY(5)=$$VALI^PSUTL(58.81,PSUIENDA,50)
"RTN","PSUCS2",102,0)
 S:PSUTQY(5) ^XTMP(PSUCSJB,"TQTY",PSULOC,PSUIENDA,PSUDRG(4))=PSUTQY(5)
"RTN","PSUCS2",103,0)
 Q
"RTN","PSUCS2",104,0)
 ;
"RTN","PSUCS3")
0^21^B7927852
"RTN","PSUCS3",1,0)
PSUCS3 ;BIR/DJE,DJM - GENERATE PSU CS RECORDS (TYPE 17) ;25 AUG 1998
"RTN","PSUCS3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS3",3,0)
 ;
"RTN","PSUCS3",4,0)
 ;DBIA'S
"RTN","PSUCS3",5,0)
 ; Reference to file #40.8   supported by DBIA 2438
"RTN","PSUCS3",6,0)
 ; Reference to file #58.81  supported by DBIA 2520
"RTN","PSUCS3",7,0)
 ; Reference to file #50     supported by DBIA 221
"RTN","PSUCS3",8,0)
 ; Reference to file #42     supported by DBIA 1848
"RTN","PSUCS3",9,0)
 ; Reference to file #2      supported by DBIA 10035
"RTN","PSUCS3",10,0)
 ; Reference to file #58.8   supported by DBIA 2519
"RTN","PSUCS3",11,0)
 ; ***
"RTN","PSUCS3",12,0)
 ; TYPE 17 - "Logged for patient"
"RTN","PSUCS3",13,0)
 ; ***
"RTN","PSUCS3",14,0)
 ;     
"RTN","PSUCS3",15,0)
TYP17 ; Processing the transaction for dispensing type 17 
"RTN","PSUCS3",16,0)
 ;('logged for patient'). If the dispensing type=17 and a patient IEN 
"RTN","PSUCS3",17,0)
 ;is identified, one can use this information one find the ward location
"RTN","PSUCS3",18,0)
 ;if the patient is still an inpatient when the extract is done.
"RTN","PSUCS3",19,0)
 D FACILTY
"RTN","PSUCS3",20,0)
 ;     
"RTN","PSUCS3",21,0)
 ; (type 17 specific call)
"RTN","PSUCS3",22,0)
 ; Patient SSN
"RTN","PSUCS3",23,0)
 D SSN
"RTN","PSUCS3",24,0)
 ;
"RTN","PSUCS3",25,0)
 ; Generic name, Location type.
"RTN","PSUCS3",26,0)
 D GNAME^PSUCS4,LOCTYP^PSUCS4
"RTN","PSUCS3",27,0)
 ; Requirement 3.2.5.7
"RTN","PSUCS3",28,0)
 Q:"N"'[PSULTP(1)
"RTN","PSUCS3",29,0)
 ;
"RTN","PSUCS3",30,0)
 ; check if drug administered multiple times for a patient
"RTN","PSUCS3",31,0)
 D MULTCHK
"RTN","PSUCS3",32,0)
 ;
"RTN","PSUCS3",33,0)
 ;VA Drug class, Formulary/Non-formulary, National formulary Indicator.
"RTN","PSUCS3",34,0)
 D NDC^PSUCS4,FORMIND^PSUCS4,NFIND^PSUCS4
"RTN","PSUCS3",35,0)
 ;
"RTN","PSUCS3",36,0)
 ;(type 17 specific call)
"RTN","PSUCS3",37,0)
 ; Dispense unit, unit cost, Quantity
"RTN","PSUCS3",38,0)
 D DUNIT,UNITC,QTY17
"RTN","PSUCS3",39,0)
 ;
"RTN","PSUCS3",40,0)
 ; VA Product name, VA drug class, Packaging
"RTN","PSUCS3",41,0)
 D VPNAME^PSUCS4,VDC^PSUCS4
"RTN","PSUCS3",42,0)
 ;
"RTN","PSUCS3",43,0)
 Q 
"RTN","PSUCS3",44,0)
 ;
"RTN","PSUCS3",45,0)
 ;
"RTN","PSUCS3",46,0)
 ; 
"RTN","PSUCS3",47,0)
 ; Type 17 specific calls
"RTN","PSUCS3",48,0)
 ; 
"RTN","PSUCS3",49,0)
 ;
"RTN","PSUCS3",50,0)
MULTCHK ; 
"RTN","PSUCS3",51,0)
 ; store in array (quit if already administered) 
"RTN","PSUCS3",52,0)
 S PSUMCHK=0
"RTN","PSUCS3",53,0)
 S PSUQT(5)=$$VALI^PSUTL(58.81,PSUIENDA,5)
"RTN","PSUCS3",54,0)
 ;  if patient,drug collection started increment QT
"RTN","PSUCS3",55,0)
 I $D(^XTMP(PSUCSJB,"MC",PSULOC,PSUPIEN(73),PSUDRG(4))) D  Q
"RTN","PSUCS3",56,0)
 . S X=^XTMP(PSUCSJB,"MC",PSULOC,PSUPIEN(73),PSUDRG(4),"QT")
"RTN","PSUCS3",57,0)
 . S ^("QT")=X+PSUQT(5)
"RTN","PSUCS3",58,0)
 ; Save the IEN of the first transaction for collection
"RTN","PSUCS3",59,0)
 ;S PSUMCIEN=PSUIENDA
"RTN","PSUCS3",60,0)
 ;  start patient drug collection
"RTN","PSUCS3",61,0)
 S ^XTMP(PSUCSJB,"MC",PSULOC,PSUPIEN(73),PSUDRG(4))=PSUIENDA
"RTN","PSUCS3",62,0)
 S ^XTMP(PSUCSJB,"MC",PSULOC,PSUPIEN(73),PSUDRG(4),"QT")=PSUQT(5)
"RTN","PSUCS3",63,0)
 Q
"RTN","PSUCS3",64,0)
 ;           
"RTN","PSUCS3",65,0)
FACILTY ;
"RTN","PSUCS3",66,0)
 ;Field # 2,.1[WARD LOCATION]
"RTN","PSUCS3",67,0)
 S PSUWLC(.01)=$$VALI^PSUTL(2,PSUPIEN(73),".01")
"RTN","PSUCS3",68,0)
 Q:PSUWLC(.01)=""
"RTN","PSUCS3",69,0)
 S PSUWLC(.01)=$O(^DIC(42,"B",PSUWLC(.01),""))
"RTN","PSUCS3",70,0)
 Q:PSUWLC(.01)=""
"RTN","PSUCS3",71,0)
 ;
"RTN","PSUCS3",72,0)
 ;Field # 58.842,.01 [WARD]  Points to File # 42
"RTN","PSUCS3",73,0)
 S PSUWARD(1)=$$VALI^PSUTL(58.842,PSUWLC(.01),"1")
"RTN","PSUCS3",74,0)
 ;D GETS^PSUTL(58.842,PSUWLC(.1),"1","PSUWARD","I")
"RTN","PSUCS3",75,0)
 ;D MOVEI^PSUTL("PSUWARD")
"RTN","PSUCS3",76,0)
 ;        
"RTN","PSUCS3",77,0)
 ;Field # 42,.015 [DIVISION]  Points to File # 40.8
"RTN","PSUCS3",78,0)
 S PSUDIV(.015)=$$VALI^PSUTL(42,PSUWARD(1),".015")
"RTN","PSUCS3",79,0)
 ;
"RTN","PSUCS3",80,0)
 ;Field # 40.8,1 [FACILITY NUMBER]**Field to be extracted
"RTN","PSUCS3",81,0)
 S PSUFCN(1)=$$VALI^PSUTL(40.8,PSUDIV(.015),"1")
"RTN","PSUCS3",82,0)
 S SENDER=PSUFCN(1)
"RTN","PSUCS3",83,0)
 S PSURI=""
"RTN","PSUCS3",84,0)
 Q
"RTN","PSUCS3",85,0)
 ;
"RTN","PSUCS3",86,0)
SSN ;Field # 58.81,73 [PATIENT]  Points to File # 2
"RTN","PSUCS3",87,0)
 ;Field # 2,.09 [SOCIAL SECURITY NUMBER]**Field to be extracted
"RTN","PSUCS3",88,0)
 Q:$G(PSUPIEN(73))=""
"RTN","PSUCS3",89,0)
 S DFN=PSUPIEN(73) D PID^VADPT
"RTN","PSUCS3",90,0)
 S PSUSSN(.09)=$TR(VA("PID"),"-","")
"RTN","PSUCS3",91,0)
 Q
"RTN","PSUCS3",92,0)
 ; 
"RTN","PSUCS3",93,0)
DUNIT ;Dispense Unit
"RTN","PSUCS3",94,0)
 ;Field # 50,14.5 [DISPENSE UNIT]**Field to be extracted
"RTN","PSUCS3",95,0)
 S PSUDUN(14.5)=$$VALI^PSUTL(50,PSUDRG(4),"14.5")
"RTN","PSUCS3",96,0)
 S UNIT=PSUDUN(14.5)
"RTN","PSUCS3",97,0)
 Q
"RTN","PSUCS3",98,0)
 ;
"RTN","PSUCS3",99,0)
UNITC ;Unit Cost
"RTN","PSUCS3",100,0)
 ;Field # 50,16 [PRICE PER DISPENSE UNIT]**Field to be extracted
"RTN","PSUCS3",101,0)
 S PSUPDU(16)=$$VALI^PSUTL(50,PSUDRG(4),"16")
"RTN","PSUCS3",102,0)
 Q
"RTN","PSUCS3",103,0)
 ;
"RTN","PSUCS3",104,0)
QTY17 ;For transactions with a dispensing type =17, total the number of doses
"RTN","PSUCS3",105,0)
 ;dispensed for the same drug (Field # 58.81,4), regardless of the date 
"RTN","PSUCS3",106,0)
 ;dispensed within the reporting month. The dispensed (transaction) date
"RTN","PSUCS3",107,0)
 ;will be the date the first dose was administered to the patient during
"RTN","PSUCS3",108,0)
 ;the reporting period. The data will be transmitted as a single data
"RTN","PSUCS3",109,0)
 ;record.
"RTN","PSUCS3",110,0)
 ;Sum of Values # 58.81,5 [TOTAL QUANTITY]**Field to be extracted
"RTN","PSUCS3",111,0)
 Q  ;this is handled in gathering into "MC"
"RTN","PSUCS3",112,0)
 S PSUTQ(5)=$$VALI^PSUTL(58.81,PSUIENDA,5)
"RTN","PSUCS3",113,0)
 S OLDXTMP=$G(^XTMP(PSUCSJB,"MC",PSULOC,PSUPIEN(73),PSUDRG(4)),"QT")
"RTN","PSUCS3",114,0)
 S ^XTMP(PSUCSJB,"MC",PSULOC,PSUPIEN(73),PSUDRG(4),"QT")=OLDXTMP+PSUTQ(5)
"RTN","PSUCS3",115,0)
 Q
"RTN","PSUCS4")
0^22^B9091422
"RTN","PSUCS4",1,0)
PSUCS4 ;BIR/DJE - PBM CS GENERATE RECORDS ;13 OCT 1999
"RTN","PSUCS4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS4",3,0)
 ; 
"RTN","PSUCS4",4,0)
 ; **
"RTN","PSUCS4",5,0)
 ; General Calls from type 2 & 17
"RTN","PSUCS4",6,0)
 ; **
"RTN","PSUCS4",7,0)
 ;DBIAs
"RTN","PSUCS4",8,0)
 ; Reference to file #50    supported by DBIA 221
"RTN","PSUCS4",9,0)
 ; Reference to file #58.8  supported by DBIA 2519
"RTN","PSUCS4",10,0)
 ; Reference to file #58.81 supported by DBIA 2520
"RTN","PSUCS4",11,0)
 ;
"RTN","PSUCS4",12,0)
GNAME ;3.2.5.11. Functional Requirement 11
"RTN","PSUCS4",13,0)
 ;Field   # 58.81,4 [DRUG] Points to File # 50
"RTN","PSUCS4",14,0)
 S PSUDRG(4)=$$VALI^PSUTL(58.81,PSUIENDA,"4")
"RTN","PSUCS4",15,0)
 ;
"RTN","PSUCS4",16,0)
 ;Generic Drug Name 
"RTN","PSUCS4",17,0)
 ;Field   # 50,.01 [GENERIC NAME]**Field to be extracted
"RTN","PSUCS4",18,0)
 S PSUGDN(.01)=$$VALI^PSUTL(50,PSUDRG(4),".01")
"RTN","PSUCS4",19,0)
 I $G(PSUGDN(.01))="" S PSUGDN(.01)="Unknown Generic Name"
"RTN","PSUCS4",20,0)
 Q 
"RTN","PSUCS4",21,0)
 ;  
"RTN","PSUCS4",22,0)
LOCTYP ;3.2.5.7.   Functional Requirement 7
"RTN","PSUCS4",23,0)
 ;Transactions with a dispensing type (field # 58.81,1) of '2' 
"RTN","PSUCS4",24,0)
 ; - Dispensed from Pharmacy must be associated with a location type 
"RTN","PSUCS4",25,0)
 ;(field # 58.8,1) of 'M' for Master or 'S' for Satellite.
"RTN","PSUCS4",26,0)
 ;Transactions with a dispensing type (field # 58.81,1) of '17' 
"RTN","PSUCS4",27,0)
 ;- Logged for Patient must  be associated with a location type 
"RTN","PSUCS4",28,0)
 ;(field # 58.8,1) of 'N' for narcotic location.
"RTN","PSUCS4",29,0)
 ;S PSULTP(1)=$$VALI^PSUTL(58.81,PSUIENDA,"1")
"RTN","PSUCS4",30,0)
 ;D MOVEI^PSUTL("PSULTP")
"RTN","PSUCS4",31,0)
 S PSULTP(1)=$$VALI^PSUTL(58.8,PSULOC,1)
"RTN","PSUCS4",32,0)
 Q:PSUTYP=17
"RTN","PSUCS4",33,0)
 ;
"RTN","PSUCS4",34,0)
 ;3.2.5.8.   Functional Requirement 8
"RTN","PSUCS4",35,0)
 ;Transactions with a dispensing type '2'-dispensed from pharmacy 
"RTN","PSUCS4",36,0)
 ;(field # 58.81,1) and a Location type of 'M' for 'S' (field # 58.8,1)
"RTN","PSUCS4",37,0)
 ;
"RTN","PSUCS4",38,0)
 ; Continue Processing Flag (CPFLG)
"RTN","PSUCS4",39,0)
 S CPFLG="Y"
"RTN","PSUCS4",40,0)
 ; but that have been cancelled (field # 58.81,55) will be excluded.
"RTN","PSUCS4",41,0)
 ; (ie.If there is a 'cancel verified order date' - PSUCDT)
"RTN","PSUCS4",42,0)
 S PSUCDT(55)=$$VALI^PSUTL(58.81,PSUIENDA,"55")
"RTN","PSUCS4",43,0)
 Q:$G(PSUCDT(55))=""
"RTN","PSUCS4",44,0)
 S CPFLG="N"
"RTN","PSUCS4",45,0)
 Q 
"RTN","PSUCS4",46,0)
 ;
"RTN","PSUCS4",47,0)
 ;3.2.5.9.   Functional Requirement 9
"RTN","PSUCS4",48,0)
 ;Dispensing transactions that meet the criteria in functional 
"RTN","PSUCS4",49,0)
 ;requirements 3.2.5.3., 3.2.5.7. and 3.2.5.8. will have the following 
"RTN","PSUCS4",50,0)
 ;additional data elements for the  drug extracted.
"RTN","PSUCS4",51,0)
 ;
"RTN","PSUCS4",52,0)
NDC ;NDC
"RTN","PSUCS4",53,0)
 ;Field # 50,31 [NDC]**Field to be extracted
"RTN","PSUCS4",54,0)
 ;If no data found, send "No NDC".
"RTN","PSUCS4",55,0)
 S PSUNDC(31)=$$VALI^PSUTL(50,PSUDRG(4),"31")
"RTN","PSUCS4",56,0)
 I $G(PSUNDC(31))="" S PSUNDC(31)="No NDC"
"RTN","PSUCS4",57,0)
 Q 
"RTN","PSUCS4",58,0)
 ; 
"RTN","PSUCS4",59,0)
 ;
"RTN","PSUCS4",60,0)
FORMIND ;Formulary/Non-Formulary Indicator
"RTN","PSUCS4",61,0)
 ;Field # 50,51 [NON-FORMULARY]**Field to be extracted
"RTN","PSUCS4",62,0)
 S PSUFID(51)=$$VALI^PSUTL(50,PSUDRG(4),"51")
"RTN","PSUCS4",63,0)
 Q
"RTN","PSUCS4",64,0)
 ;
"RTN","PSUCS4",65,0)
NFIND ;National Formulary Indicator
"RTN","PSUCS4",66,0)
 ;Product will need to check whether or not Vs 4.0 of 
"RTN","PSUCS4",67,0)
 ;National Drug File is installed. If not, this field will not exist.
"RTN","PSUCS4",68,0)
 ;Check for National Drug File
"RTN","PSUCS4",69,0)
 S (NFIND,NFRES)=""
"RTN","PSUCS4",70,0)
 S VERSION=$$VERSION^XPDUTL("PSN")
"RTN","PSUCS4",71,0)
 Q:VERSION<4.0
"RTN","PSUCS4",72,0)
 ;Field # 50.68,17 [NATIONAL FORMULARY INDICATOR]***Field to be extracted
"RTN","PSUCS4",73,0)
 ;If  National Drug File vs 4.0 is not installed
"RTN","PSUCS4",74,0)
 ;Transmission format: Send null
"RTN","PSUCS4",75,0)
 ;If National Drug File vs 4.0 is installed
"RTN","PSUCS4",76,0)
 S PSUDRG4=PSUDRG(4)
"RTN","PSUCS4",77,0)
 D GETS^PSUTL(50,PSUDRG4,"20;22;3;52","PSUDRG","I")
"RTN","PSUCS4",78,0)
 D MOVEI^PSUTL("PSUDRG")
"RTN","PSUCS4",79,0)
 S PSUDRG(4)=PSUDRG4
"RTN","PSUCS4",80,0)
 ;
"RTN","PSUCS4",81,0)
 S PSUNFI(17)=$$FORMI^PSNAPIS(PSUDRG(20),PSUDRG(22))
"RTN","PSUCS4",82,0)
 ;Transmission format: Internal value ('1' for Yes, '0' for  No)
"RTN","PSUCS4",83,0)
 ;National Formulary Restriction Indicator
"RTN","PSUCS4",84,0)
 ;Product shall check whether or not Vs 4.0 of National Drug File 
"RTN","PSUCS4",85,0)
 ;is installed. If not, this field will not exist.
"RTN","PSUCS4",86,0)
 ;Field #50.6818,.01[NATIONAL FORMULARY RESTRICTION]Field to be extracted
"RTN","PSUCS4",87,0)
 ;
"RTN","PSUCS4",88,0)
 S PSUNFR(.01)=$$FORMR^PSNAPIS(PSUDRG(20),PSUDRG(22))>0
"RTN","PSUCS4",89,0)
 S PSUNFR(.01)=$S($G(PSUNFR(.01))="":0,1:PSUNFR(.01))
"RTN","PSUCS4",90,0)
 ;
"RTN","PSUCS4",91,0)
 ;If  National Drug File vs 4.0 is not installed
"RTN","PSUCS4",92,0)
 ;Transmission format: Send null
"RTN","PSUCS4",93,0)
 ;If National Drug File vs 4.0 is installed 
"RTN","PSUCS4",94,0)
 ;Transmission format:  If no value is found send '0', 
"RTN","PSUCS4",95,0)
 ;if data exists sent '1'
"RTN","PSUCS4",96,0)
 Q
"RTN","PSUCS4",97,0)
 ;   
"RTN","PSUCS4",98,0)
VPNAME ;VA Product Name
"RTN","PSUCS4",99,0)
 ;Field # 50,21[VA PRODUCT NAME]**Field to be extracted
"RTN","PSUCS4",100,0)
 S PSUVPN(21)=$$VALI^PSUTL(50,PSUDRG(4),"21")
"RTN","PSUCS4",101,0)
 S PSUDRG4=PSUDRG(4) ;if no value found, send "Unknown VA Product Name"
"RTN","PSUCS4",102,0)
 I $G(PSUVPN(21))="" S PSUVPN(21)="Unknown VA Product Name"
"RTN","PSUCS4",103,0)
 D GETS^PSUTL(50,PSUDRG(4),"3;52","PSUDRG","I"),MOVEI^PSUTL("PSUDRG")
"RTN","PSUCS4",104,0)
 S PSUDRG(4)=PSUDRG4 ;DEA, NFI
"RTN","PSUCS4",105,0)
 Q 
"RTN","PSUCS4",106,0)
 ;
"RTN","PSUCS4",107,0)
VDC ; VA Drug Class
"RTN","PSUCS4",108,0)
 ;Field   # 50,2 [NATIONAL DRUG CLASS] Pointer to File # 50.605
"RTN","PSUCS4",109,0)
 ;used DRUG pointer from previous quantity check.
"RTN","PSUCS4",110,0)
 S PSUNAC(2)=$$VALI^PSUTL(50,PSUDRG(4),"2")
"RTN","PSUCS4",111,0)
 ;
"RTN","PSUCS4",112,0)
 ;Field   # 50.605,.01 [CODE]**Field to be extracted
"RTN","PSUCS4",113,0)
 S PSUFID(.01)=PSUNAC(2)
"RTN","PSUCS4",114,0)
 Q
"RTN","PSUCS4",115,0)
 ;Field   # 58.8001,.01 [DRUG] Pointer to File # 50
"RTN","PSUCS4",116,0)
 ;
"RTN","PSUCS4",117,0)
PDT ;Package details
"RTN","PSUCS4",118,0)
 ;Field   # 58.8001,7 [BREAKDOWN UNIT]**Field to be extracted
"RTN","PSUCS4",119,0)
 ;Field   # 58.8001,8 [PACKAGE SIZE]**Field to be extracted
"RTN","PSUCS4",120,0)
 S PSUSITE=0
"RTN","PSUCS4",121,0)
 S PSUSITE=$$VALI^PSUTL(58.8,PSUIENDA,20)
"RTN","PSUCS4",122,0)
 S:'PSUSITE PSUSITE=$$VALI^PSUTL(58.81,PSUIENDA,2)
"RTN","PSUCS4",123,0)
 D GETS^PSUTL(58.8001,"PSUSITE,PSUDRG(4)","7;8","PSUPDT","I")
"RTN","PSUCS4",124,0)
 D MOVEI^PSUTL("PSUPDT")
"RTN","PSUCS4",125,0)
 S UNIT=$G(PSUPDT(7),"NA")
"RTN","PSUCS4",126,0)
 Q
"RTN","PSUCS5")
0^23^B5037710
"RTN","PSUCS5",1,0)
PSUCS5 ;BIR/DJE,DJM - PBM CS ASSEMBLE RECORD ;10 JUL 1999
"RTN","PSUCS5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCS5",3,0)
 ;
"RTN","PSUCS5",4,0)
 ; DBIA(s)
"RTN","PSUCS5",5,0)
 ; none needed for this routine
"RTN","PSUCS5",6,0)
 ;
"RTN","PSUCS5",7,0)
 ; 
"RTN","PSUCS5",8,0)
 ; Build a reporting record(s)
"RTN","PSUCS5",9,0)
 ; 
"RTN","PSUCS5",10,0)
 ;
"RTN","PSUCS5",11,0)
 ;
"RTN","PSUCS5",12,0)
BUILDREC ; Assemble record
"RTN","PSUCS5",13,0)
 Q:'$G(PSUTQY(5))  ; quit if quantity = 0
"RTN","PSUCS5",14,0)
 K PSUR
"RTN","PSUCS5",15,0)
 I PSUTYP=2,$S(PSULTP(1)="M":0,PSULTP(1)="S":0,1:1) Q
"RTN","PSUCS5",16,0)
 I PSUTYP=17,$S(PSULTP(1)="N":0,1:1) Q
"RTN","PSUCS5",17,0)
 I PSUTYP=2 S PSUMCHK=0
"RTN","PSUCS5",18,0)
 S PSURIEN=$S(PSUMCHK:PSUMCIEN,1:PSUIENDA)
"RTN","PSUCS5",19,0)
 ;S DRUG=$S(PSUTYP=2:PSUDRG(4),1:PSUDSE(4))
"RTN","PSUCS5",20,0)
 S DRUG=PSUDRG(4)
"RTN","PSUCS5",21,0)
 ;S PSURDIV=$S(PSURI="H":"H",1:1)    DAM TEST
"RTN","PSUCS5",22,0)
 S PSUR(0)=PSUTYP
"RTN","PSUCS5",23,0)
 S PSUR(2)=$G(SENDER)
"RTN","PSUCS5",24,0)
 S PSUR(3)=$G(PSURI)
"RTN","PSUCS5",25,0)
 ;S PSUR(4)=$P($S(PSUTYP=2:PSUDTM(3),1:""),".",1) ; Just the data
"RTN","PSUCS5",26,0)
 S PSUR(4)=PSUDTM(3)\1
"RTN","PSUCS5",27,0)
 ;S PSUR(4)=SEE ^XTMP(PSUCSJB,"MC",PSURDIV,PSUIENDA,DRUG)=PSUDTM(3)
"RTN","PSUCS5",28,0)
 S PSUR(5)=$G(PSUPLC(.01))
"RTN","PSUCS5",29,0)
 S PSUR(6)=$G(PSUSSN(.09))
"RTN","PSUCS5",30,0)
 S PSUR(7)=$G(PSUVPN(21))
"RTN","PSUCS5",31,0)
 S PSUR(8)=$G(PSUFID(.01))
"RTN","PSUCS5",32,0)
 S PSUR(9)=$G(PSUGDN(.01))
"RTN","PSUCS5",33,0)
 S PSUR(10)=$G(PSUFID(51))
"RTN","PSUCS5",34,0)
 S PSUR(11)=$G(PSUNFI(17))
"RTN","PSUCS5",35,0)
 S PSUR(12)=$G(PSUNFR(.01))
"RTN","PSUCS5",36,0)
 S PSUR(13)=$G(PSUNDC(31))
"RTN","PSUCS5",37,0)
 S PSUR(14)=$G(UNIT)
"RTN","PSUCS5",38,0)
 I PSUTYP=2 S PSUR(15)=$G(PSUPDT(8))
"RTN","PSUCS5",39,0)
 S PSUR(16)=$G(PSUPDU(16))
"RTN","PSUCS5",40,0)
 S PSUR(17)=PSUTQY(5) ; both from type 2 & 17
"RTN","PSUCS5",41,0)
 S PSUR(18)=$S($G(PSUDRG(52)):"N/F",1:"")
"RTN","PSUCS5",42,0)
 S PSUR(19)=$G(PSUDRG(3))
"RTN","PSUCS5",43,0)
 I PSUR(6)'="" S PSUSSN=PSUR(6) D ICN^PSUV2 D
"RTN","PSUCS5",44,0)
 .;MVP OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUCS5",45,0)
 .S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUCS5",46,0)
 S PSUR(20)=$G(PSUPICN)
"RTN","PSUCS5",47,0)
 S PSUR=""
"RTN","PSUCS5",48,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S PSUR(I)=$TR(PSUR(I),"^","'")
"RTN","PSUCS5",49,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S $P(PSUR,"^",I)=PSUR(I)
"RTN","PSUCS5",50,0)
 S PSUR=PSUR_"^"
"RTN","PSUCS5",51,0)
 S PSURC=$G(PSURC,0)+1
"RTN","PSUCS5",52,0)
 S PSURDIV=SENDER
"RTN","PSUCS5",53,0)
 ;S PSURDIV=$S(PSURI="H":PSUSNDR,1:SENDER) ;PSUTYP=2:$S(PSUOS(20)="":PSUDIV(3.5),1:PSUOS(20)),1:PSUDIV(.015))    DAM TEST
"RTN","PSUCS5",54,0)
 I 'PSUMCHK D
"RTN","PSUCS5",55,0)
 . S ^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN)=PSURC
"RTN","PSUCS5",56,0)
 . M ^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN,PSURC)=PSUR
"RTN","PSUCS5",57,0)
 I PSUMCHK D
"RTN","PSUCS5",58,0)
 . S PSURRC=$G(^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN))
"RTN","PSUCS5",59,0)
 . S $P(^XTMP(PSUCSJB,"RECORDS",PSURDIV,PSURIEN,PSURRC),"^",17)=PSUR(17)
"RTN","PSUCS5",60,0)
 K PSUR
"RTN","PSUCS5",61,0)
 Q
"RTN","PSUCSR0")
0^24^B16382128
"RTN","PSUCSR0",1,0)
PSUCSR0 ;BIR/DJM,DJE - Extract records for CS ;25 AUG 1998
"RTN","PSUCSR0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCSR0",3,0)
 ;
"RTN","PSUCSR0",4,0)
 ; 3.2.11.34 Functional Requirement 34
"RTN","PSUCSR0",5,0)
 ;-------------------------------------
"RTN","PSUCSR0",6,0)
 ;
"RTN","PSUCSR0",7,0)
 ; 3.2.11.35 Functional Requirement 35
"RTN","PSUCSR0",8,0)
 ;-------------------------------------
"RTN","PSUCSR0",9,0)
 ;DBIA(S)
"RTN","PSUCSR0",10,0)
 ; Reference to file #4.3  supported by DBIA 2496
"RTN","PSUCSR0",11,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUCSR0",12,0)
 ;
"RTN","PSUCSR0",13,0)
 ; ----- SEE SPECS FOR DETAIL
"RTN","PSUCSR0",14,0)
 ;
"RTN","PSUCSR0",15,0)
EN(PSUMSG) ;Scan and process for Division(s)
"RTN","PSUCSR0",16,0)
 ; PSUMSGT ("M")= # MESSAGES  ("L")= # LINES
"RTN","PSUCSR0",17,0)
 ;
"RTN","PSUCSR0",18,0)
TEST S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUCSR0",19,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUCSR0",20,0)
 S PSUDUZ=$G(PSUDUZ,DUZ)
"RTN","PSUCSR0",21,0)
 S PSUDIV=0,Z=0
"RTN","PSUCSR0",22,0)
 S:'$D(PSUCSJB) PSUCSJB="PSUCS_"_PSUJOB
"RTN","PSUCSR0",23,0)
 S PSUMC=0 ; No messages set yet
"RTN","PSUCSR0",24,0)
 K ^XTMP(PSUCSJB,"MAIL")
"RTN","PSUCSR0",25,0)
 K ^XTMP(PSUCSJB,"REPORT")
"RTN","PSUCSR0",26,0)
 K ^XTMP(PSUCSJB,"CSFR-37")
"RTN","PSUCSR0",27,0)
 S PSUXMY(DUZ)="" ; *** TESTING
"RTN","PSUCSR0",28,0)
 I '$D(PSUXMY) S PSUXMY(PSUDUZ)="" ; THIS IS WHO WE MAIL TO
"RTN","PSUCSR0",29,0)
 N Z ; Z used to pass back "CONFIRM" numbers
"RTN","PSUCSR0",30,0)
 F  S PSUDIV=$O(^XTMP(PSUCSJB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUCSR0",31,0)
 . S PSUMSEQ=0
"RTN","PSUCSR0",32,0)
 . D DIV(.Z) ; Process a single divisions data extract
"RTN","PSUCSR0",33,0)
 . D SUMMRY^PSUCSR1(.Z) ; Send the summary report(s)
"RTN","PSUCSR0",34,0)
 ; PSUMC holding a variable
"RTN","PSUCSR0",35,0)
 I PSUMC=0 D  ; No data to send messages
"RTN","PSUCSR0",36,0)
 . S PSUMSEQ=0,PSUDIV=PSUSNDR
"RTN","PSUCSR0",37,0)
 . D DIV(.Z)
"RTN","PSUCSR0",38,0)
 . D SUMMRY^PSUCSR1(.Z)
"RTN","PSUCSR0",39,0)
 D VARS("MAIL",1,PSUMC)
"RTN","PSUCSR0",40,0)
 M ^XTMP("PSU_"_$G(PSUJOB,$J),"CONFIRM")=Z
"RTN","PSUCSR0",41,0)
 Q
"RTN","PSUCSR0",42,0)
 ; 3.2.11.36 Functional Requirement 36
"RTN","PSUCSR0",43,0)
 ;-------------------------------------
"RTN","PSUCSR0",44,0)
 ;
"RTN","PSUCSR0",45,0)
 ; 3.2.11.37 Functional Requirement 37
"RTN","PSUCSR0",46,0)
 ;-------------------------------------
"RTN","PSUCSR0",47,0)
 ;
"RTN","PSUCSR0",48,0)
 ;
"RTN","PSUCSR0",49,0)
DIV(PSUMSG) ;EP returns PSUMSG("M")= # MESSAGES ("L")= # LINES
"RTN","PSUCSR0",50,0)
 ; Scan TMP, split lines, transmit per MAX lines in Netmail
"RTN","PSUCSR0",51,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUCSR0",52,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUCSR0",53,0)
 ;
"RTN","PSUCSR0",54,0)
 ;   Split and store into ^XTMP(PSUCSJB,"MAIL",PSUMC,PSUMLC)
"RTN","PSUCSR0",55,0)
 S PSUOMC=PSUMC,PSUMC=PSUMC+1,PSUMSEQ=PSUMSEQ+1,PSUMLC=0
"RTN","PSUCSR0",56,0)
 K ^XTMP(PSUCSJB,"MAIL",PSUMC)
"RTN","PSUCSR0",57,0)
 S PSUTIEN="",PSULC=0,PSUTLC=0
"RTN","PSUCSR0",58,0)
 F  S PSUTIEN=$O(^XTMP(PSUCSJB,"RECORDS",PSUDIV,PSUTIEN)) Q:PSUTIEN=""  D
"RTN","PSUCSR0",59,0)
 . S PSULC=PSULC+1
"RTN","PSUCSR0",60,0)
 . S PSURC=$O(^XTMP(PSUCSJB,"RECORDS",PSUDIV,PSUTIEN,""))
"RTN","PSUCSR0",61,0)
 . S X=$G(^XTMP(PSUCSJB,"RECORDS",PSUDIV,PSUTIEN,PSURC))
"RTN","PSUCSR0",62,0)
 . D EN^PSUCSR1 ; Prepare data for next report (drug breakdown)
"RTN","PSUCSR0",63,0)
 . Q:$G(PSUSMRY)  ; Only do a summary
"RTN","PSUCSR0",64,0)
 . I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D  ; Detail to Hines,self,group
"RTN","PSUCSR0",65,0)
 .. S PSUMLC=PSUMLC+1,PSUTLC=PSUTLC+1
"RTN","PSUCSR0",66,0)
 .. I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC+1 Q  ; +  message
"RTN","PSUCSR0",67,0)
 .. I $L(X)<235 S ^XTMP(PSUCSJB,"MAIL",PSUMC,PSUMLC)=X Q
"RTN","PSUCSR0",68,0)
 .. F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUCSR0",69,0)
 .. S ^XTMP(PSUCSJB,"MAIL",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUCSR0",70,0)
 .. S PSUMLC=PSUMLC+1
"RTN","PSUCSR0",71,0)
 .. S ^XTMP(PSUCSJB,"MAIL",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUCSR0",72,0)
 ; Go mail the message now
"RTN","PSUCSR0",73,0)
 ;I '$G(PSUMASF) S PSUMC=PSUMC-1 Q  ; Do not update the master file, commented out to send detailed message to user DAM
"RTN","PSUCSR0",74,0)
 I PSUMLC=0 D
"RTN","PSUCSR0",75,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUCSR0",76,0)
 . S ^XTMP(PSUCSJB,"MAIL",PSUMC,PSUMLC)="No data to report"
"RTN","PSUCSR0",77,0)
 S ^XTMP(PSUCSJB,"MAIL",PSUMC)=PSUDIV
"RTN","PSUCSR0",78,0)
 S ^XTMP(PSUCSJB,"DETAIL",PSUMC)=PSUMSEQ_"/"_(PSUMC-PSUOMC)
"RTN","PSUCSR0",79,0)
 S PSUMSG(PSUDIV,6,"M")=$G(PSUMSG(PSUDIV,6,"M"))+(PSUMC-PSUOMC)
"RTN","PSUCSR0",80,0)
 S PSUMSG(PSUDIV,6,"L")=$G(PSUMSG(PSUDIV,6,"L"))+PSUMLC
"RTN","PSUCSR0",81,0)
 Q
"RTN","PSUCSR0",82,0)
 ;
"RTN","PSUCSR0",83,0)
VARS(PSUMMS,S,E) ; Setup variables for contents
"RTN","PSUCSR0",84,0)
 S PSUMC=0,PSUTLC=0
"RTN","PSUCSR0",85,0)
 S XMDUZ=PSUDUZ
"RTN","PSUCSR0",86,0)
 F PSUM=S:1:E D
"RTN","PSUCSR0",87,0)
 . Q:'$D(^XTMP(PSUCSJB,"MAIL",PSUM))
"RTN","PSUCSR0",88,0)
 . S PSUMC=PSUMC+1
"RTN","PSUCSR0",89,0)
 . S PSUMLC=$O(^XTMP(PSUCSJB,"MAIL",PSUM,""),-1),PSUTLC=PSUTLC+PSUMLC
"RTN","PSUCSR0",90,0)
 . S PSUDIV=^XTMP(PSUCSJB,"MAIL",PSUM)
"RTN","PSUCSR0",91,0)
 . I $D(^XTMP(PSUCSJB,"DETAIL",PSUM)) M XMY=PSUXMYH
"RTN","PSUCSR0",92,0)
 . I $D(^XTMP(PSUCSJB,"SUMMARY 1",PSUM)) M XMY=PSUXMYS1
"RTN","PSUCSR0",93,0)
 . I $D(^XTMP(PSUCSJB,"SUMMARY 2",PSUM)) M XMY=PSUXMYS2
"RTN","PSUCSR0",94,0)
 . S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUCSR0",95,0)
 . S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCSR0",96,0)
 . S PSUMSEQ=$G(^XTMP(PSUCSJB,"DETAIL",PSUM)) ; Get the mail sequence data
"RTN","PSUCSR0",97,0)
 . S PSUMSEQ=$S(PSUMSEQ="":" ",1:" "_PSUMSEQ_" ")
"RTN","PSUCSR0",98,0)
 . S XMSUB="V. 4.0 PBMCS "_PSUMON_PSUMSEQ_PSUDIV_" "_PSUDIVNM
"RTN","PSUCSR0",99,0)
 . S XMTEXT="^XTMP(PSUCSJB,PSUMMS,PSUM,"
"RTN","PSUCSR0",100,0)
 . S XMCHAN=1
"RTN","PSUCSR0",101,0)
 . D ^XMD
"RTN","PSUCSR0",102,0)
 ;
"RTN","PSUCSR0",103,0)
 Q
"RTN","PSUCSR1")
0^25^B33680851
"RTN","PSUCSR1",1,0)
PSUCSR1 ;BIR/DJM - Drug breakdown ;25 AUG 1998
"RTN","PSUCSR1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCSR1",3,0)
 ; DBIA(s)
"RTN","PSUCSR1",4,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUCSR1",5,0)
 ;
"RTN","PSUCSR1",6,0)
EN ;EP -- DRUG BREAKDOWN REPORT
"RTN","PSUCSR1",7,0)
 ;
"RTN","PSUCSR1",8,0)
 S RC="^XTMP(PSUCSJB,""RECORDS"",PSUDIV,PSUTIEN,PSURC)"
"RTN","PSUCSR1",9,0)
 I $G(@RC@(0))'=2 Q
"RTN","PSUCSR1",10,0)
 S PSUGNM=$G(@RC@(9))
"RTN","PSUCSR1",11,0)
 S PSUBU=$G(@RC@(14))
"RTN","PSUCSR1",12,0)
 S PSUBU=$S(PSUBU="":"N/A",1:PSUBU)
"RTN","PSUCSR1",13,0)
 S PSUPSZ=$G(@RC@(15))
"RTN","PSUCSR1",14,0)
 S PSUPSZ=$S(PSUPSZ="":"N/A",1:PSUPSZ)
"RTN","PSUCSR1",15,0)
 S PSUNFI=$G(@RC@(10))
"RTN","PSUCSR1",16,0)
 S PSUVFI=$G(@RC@(11))
"RTN","PSUCSR1",17,0)
 S PSUCST=$G(@RC@(16))
"RTN","PSUCSR1",18,0)
 S PSUQTY=$G(@RC@(17))
"RTN","PSUCSR1",19,0)
 S PSUCST=PSUCST*PSUQTY
"RTN","PSUCSR1",20,0)
 S PSUTCST=$G(PSUTCST)+PSUCST
"RTN","PSUCSR1",21,0)
 ; pull previous counters
"RTN","PSUCSR1",22,0)
 ; PSUGNM-drug name; PSUBU-break down unit/dispense unit
"RTN","PSUCSR1",23,0)
 ; PSUPSZ-package size
"RTN","PSUCSR1",24,0)
 S PSUX=$G(^XTMP(PSUCSJB,"CSFR-37",PSUDIV,PSUGNM,PSUBU,PSUPSZ))
"RTN","PSUCSR1",25,0)
 S PSUOQTY=$P(PSUX,U,3)
"RTN","PSUCSR1",26,0)
 S PSUOCST=$P(PSUX,U,4)
"RTN","PSUCSR1",27,0)
 S PSUOCNT=$P(PSUX,U,5)
"RTN","PSUCSR1",28,0)
 ; update/store counters
"RTN","PSUCSR1",29,0)
 S PSUTCST=PSUOCST+PSUCST
"RTN","PSUCSR1",30,0)
 S PSUTQTY=PSUOQTY+PSUQTY
"RTN","PSUCSR1",31,0)
 S PSUTCNT=PSUOCNT+1
"RTN","PSUCSR1",32,0)
 S PSUX=PSUNFI_U_PSUVFI_U_PSUTQTY_U_PSUTCST_U_PSUTCNT
"RTN","PSUCSR1",33,0)
 S ^XTMP(PSUCSJB,"CSFR-37",PSUDIV,PSUGNM,PSUBU,PSUPSZ)=PSUX
"RTN","PSUCSR1",34,0)
 Q
"RTN","PSUCSR1",35,0)
 ;
"RTN","PSUCSR1",36,0)
 ;
"RTN","PSUCSR1",37,0)
GENREP(PSUMSG) ;EP - Generate the report based on the collected information
"RTN","PSUCSR1",38,0)
 ;
"RTN","PSUCSR1",39,0)
 S PSUPGS("PG")=1
"RTN","PSUCSR1",40,0)
 D PGHDR1
"RTN","PSUCSR1",41,0)
 S PSUL=3
"RTN","PSUCSR1",42,0)
 F  S PSUL=$O(^XTMP("PSU_"_PSUJOB,"CSAMIS",PSUL)) Q:PSUL=""  D
"RTN","PSUCSR1",43,0)
 .I LNCNT+4>IOSL D PGHDR1
"RTN","PSUCSR1",44,0)
 .W !,^XTMP("PSU_"_PSUJOB,"CSAMIS",PSUL)
"RTN","PSUCSR1",45,0)
 .S LNCNT=LNCNT+1
"RTN","PSUCSR1",46,0)
 Q
"RTN","PSUCSR1",47,0)
COMBO(PSUMSG) ;EP - Generate the report based on the collected information
"RTN","PSUCSR1",48,0)
 ;
"RTN","PSUCSR1",49,0)
 S PSUPGS("PG")=1
"RTN","PSUCSR1",50,0)
 D PGHDR2
"RTN","PSUCSR1",51,0)
 S PSUL=3
"RTN","PSUCSR1",52,0)
 F  S PSUL=$O(^XTMP("PSU_"_PSUJOB,"COMBOAMIS",PSUL)) Q:PSUL=""  D
"RTN","PSUCSR1",53,0)
 .I LNCNT+4>IOSL D PGHDR2
"RTN","PSUCSR1",54,0)
 .W !,^XTMP("PSU_"_PSUJOB,"COMBOAMIS",PSUL)
"RTN","PSUCSR1",55,0)
 .S LNCNT=LNCNT+1
"RTN","PSUCSR1",56,0)
 Q
"RTN","PSUCSR1",57,0)
 ;
"RTN","PSUCSR1",58,0)
PGHDR1 ;AMIS PAGE HEADER
"RTN","PSUCSR1",59,0)
 U IO
"RTN","PSUCSR1",60,0)
 W @IOF
"RTN","PSUCSR1",61,0)
 W !,^XTMP("PSU_"_PSUJOB,"CSAMIS",1)
"RTN","PSUCSR1",62,0)
 W !!,?68,"Page: ",PSUPGS("PG")
"RTN","PSUCSR1",63,0)
 W !,$G(^XTMP("PSU_"_PSUJOB,"IVAMIS",2))
"RTN","PSUCSR1",64,0)
 S LNCNT=3
"RTN","PSUCSR1",65,0)
 Q
"RTN","PSUCSR1",66,0)
 ;
"RTN","PSUCSR1",67,0)
PGHDR2 ;COMBO AMIS PAGE HEADER
"RTN","PSUCSR1",68,0)
 U IO
"RTN","PSUCSR1",69,0)
 W @IOF
"RTN","PSUCSR1",70,0)
 W !,^XTMP("PSU_"_PSUJOB,"COMBOAMIS",1)
"RTN","PSUCSR1",71,0)
 W !!,?68,"Page: ",PSUPGS("PG")
"RTN","PSUCSR1",72,0)
 W !,$G(^XTMP("PSU_"_PSUJOB,"COMBOAMIS",2))
"RTN","PSUCSR1",73,0)
 S LNCNT=3
"RTN","PSUCSR1",74,0)
 Q
"RTN","PSUCSR1",75,0)
 ;
"RTN","PSUCSR1",76,0)
PG ;EP  Page controller
"RTN","PSUCSR1",77,0)
 S PSUQUIT=0
"RTN","PSUCSR1",78,0)
 I $Y<(IOSL-4) Q
"RTN","PSUCSR1",79,0)
 S:'$D(PSUPG("PG")) PSUPG("PG")=0
"RTN","PSUCSR1",80,0)
 S PSUPG("PG")=PSUPG("PG")+1
"RTN","PSUCSR1",81,0)
 I $E(IOST)="C" K DIR S DIR(0)="E" D ^DIR
"RTN","PSUCSR1",82,0)
 I $G(DIROUT)!$G(DUOUT)!$G(DTOUT)!$G(DIRUT) S PSUQUIT=1
"RTN","PSUCSR1",83,0)
 U IO W @IOF
"RTN","PSUCSR1",84,0)
 Q:$G(PSUQUIT)
"RTN","PSUCSR1",85,0)
 ;
"RTN","PSUCSR1",86,0)
PGHDR ;EP write header & page number
"RTN","PSUCSR1",87,0)
 F I=1,2 W !,^XTMP(PSUCSJB,"MAIL",PSUMC,I)
"RTN","PSUCSR1",88,0)
 W !,?60,"PAGE: ",PSUPG("PG")
"RTN","PSUCSR1",89,0)
 F I=4,5,6 I $D(^XTMP(PSUCSJB,"MAIL",PSUMC,I)) W !,^(I)
"RTN","PSUCSR1",90,0)
 Q
"RTN","PSUCSR1",91,0)
 ;
"RTN","PSUCSR1",92,0)
SUMMRY(PSUMSG,PSUMFL) ; Mail the drug summary report (by division)
"RTN","PSUCSR1",93,0)
 K PSUTCSO,PSUTCST
"RTN","PSUCSR1",94,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUCSR1",95,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCSR1",96,0)
 S PSUMFL=$G(PSUMFL,1)
"RTN","PSUCSR1",97,0)
 S PSUOMC=PSUMC,PSUMLC=0
"RTN","PSUCSR1",98,0)
 S PSUMC=PSUMC+1,PSULC=0,PSUTLC=0
"RTN","PSUCSR1",99,0)
 S PSUDRG="",PSUQDTL=0,PSUTCSO=0,PSUTCST=0
"RTN","PSUCSR1",100,0)
 S PSUDSHL=$$PAD("","-",76)
"RTN","PSUCSR1",101,0)
 S PSULC=PSULC+1
"RTN","PSUCSR1",102,0)
 S ML="^XTMP(PSUCSJB,""MAIL"",PSUMC)"
"RTN","PSUCSR1",103,0)
 S @ML@(1)=$$CTR("Controlled Substance Statistical Data"," ",75)
"RTN","PSUCSR1",104,0)
 S @ML@(2)="                   "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUCSR1",105,0)
 S @ML@(3)=" "
"RTN","PSUCSR1",106,0)
 S X=$$PAD(" "," ",45)_$$CTR("Breakdown"," ",10)_$$CTR("Package"," ",10)_"Quantity"
"RTN","PSUCSR1",107,0)
 S @ML@(4)=X
"RTN","PSUCSR1",108,0)
 S X=$$PAD("Drug Name"," ",45)_$$PAD("Unit"," ",10)_$$CTR("Size"," ",10)_"Dispensed"
"RTN","PSUCSR1",109,0)
 S @ML@(5)=X
"RTN","PSUCSR1",110,0)
 S @ML@(6)=PSUDSHL,PSULC=6
"RTN","PSUCSR1",111,0)
 ;
"RTN","PSUCSR1",112,0)
 F  S PSUDRG=$O(^XTMP(PSUCSJB,"CSFR-37",PSUDIV,PSUDRG)) Q:PSUDRG=""  D
"RTN","PSUCSR1",113,0)
 . S PSUBU=""
"RTN","PSUCSR1",114,0)
 . F  S PSUBU=$O(^XTMP(PSUCSJB,"CSFR-37",PSUDIV,PSUDRG,PSUBU)) Q:PSUBU=""  D
"RTN","PSUCSR1",115,0)
 .. S PSUSZ=""
"RTN","PSUCSR1",116,0)
 .. F  S PSUSZ=$O(^XTMP(PSUCSJB,"CSFR-37",PSUDIV,PSUDRG,PSUBU,PSUSZ)) Q:PSUSZ=""  D
"RTN","PSUCSR1",117,0)
 ... S X=$G(^XTMP(PSUCSJB,"CSFR-37",PSUDIV,PSUDRG,PSUBU,PSUSZ),"^^0")
"RTN","PSUCSR1",118,0)
 ... S PSUNFI=$P(X,U,1)
"RTN","PSUCSR1",119,0)
 ... S PSUVFI=$P(X,U,2)
"RTN","PSUCSR1",120,0)
 ... S PSUQTY=$P(X,U,3)
"RTN","PSUCSR1",121,0)
 ... S PSUCST=$P(X,U,4)
"RTN","PSUCSR1",122,0)
 ... S PSUTCST=PSUTCST+PSUCST
"RTN","PSUCSR1",123,0)
 ... S PSUCNT=$P(X,U,5),PSUTCSO=PSUTCSO+PSUCNT
"RTN","PSUCSR1",124,0)
 ... S X=PSUDRG_" "_$S(PSUVFI=0:"#",1:"")_$S(PSUNFI'="":"*",1:"")
"RTN","PSUCSR1",125,0)
 ... S X=$$PAD(X," ",45)
"RTN","PSUCSR1",126,0)
 ... S X=X_$$PAD(PSUBU," ",10)
"RTN","PSUCSR1",127,0)
 ... S X=X_$$PAD($J(PSUSZ,7)," ",12)
"RTN","PSUCSR1",128,0)
 ... S X=X_$$PAD($J(PSUQTY,7)," ",10)
"RTN","PSUCSR1",129,0)
 ... S PSUQDTL=PSUQDTL+PSUQTY ; Sum up the total quantity dispensed
"RTN","PSUCSR1",130,0)
 ... S PSULC=PSULC+1,PSUTLC=PSUTLC+1
"RTN","PSUCSR1",131,0)
 ... S @ML@(PSULC)=X
"RTN","PSUCSR1",132,0)
 S ^XTMP(PSUCSJB,"REPORT",PSUMC)="" ; trigger print report
"RTN","PSUCSR1",133,0)
 S ^XTMP(PSUCSJB,"SUMMARY 2",PSUMC)="" ;trigger mail & XMY group
"RTN","PSUCSR1",134,0)
 I $G(PSUTCSO)=0 D  ; No mail summary to send
"RTN","PSUCSR1",135,0)
 . K ^XTMP(PSUCSJB,"MAIL",PSUMC)
"RTN","PSUCSR1",136,0)
 . S ^XTMP(PSUCSJB,"MAIL",PSUMC)=PSUDIV
"RTN","PSUCSR1",137,0)
 . S ^XTMP(PSUCSJB,"REPORT",PSUMC)=""
"RTN","PSUCSR1",138,0)
 . S @ML@(1)=$$CTR("Controlled Substance Statistical Data"," ",75)
"RTN","PSUCSR1",139,0)
 . S @ML@(2)="                   "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUCSR1",140,0)
 . S @ML@(3)="  "
"RTN","PSUCSR1",141,0)
 . S @ML@(4)="No data to report"
"RTN","PSUCSR1",142,0)
 . S @ML@(5)=" "
"RTN","PSUCSR1",143,0)
 I $G(PSUSMRY,0) D
"RTN","PSUCSR1",144,0)
 . K ^XTMP(PSUCSJB,"MAIL",PSUMC),^XTMP(PSUCSJB,"REPORT",PSUMC)
"RTN","PSUCSR1",145,0)
 I '$G(PSUSMRY,0),PSUTLC D
"RTN","PSUCSR1",146,0)
 . S PSUTLC=PSUTLC+6 ; Adjust for the header
"RTN","PSUCSR1",147,0)
 . ; Set total line
"RTN","PSUCSR1",148,0)
 . S ^XTMP(PSUCSJB,"MAIL",PSUMC)=PSUDIV
"RTN","PSUCSR1",149,0)
 . S PSULC=PSULC+1,PSUTLC=PSUTLC+1
"RTN","PSUCSR1",150,0)
 . S @ML@(PSULC)=PSUDSHL ; dashes line
"RTN","PSUCSR1",151,0)
 . S PSULC=PSULC+1,PSUTLC=PSUTLC+1
"RTN","PSUCSR1",152,0)
 . S @ML@(PSULC)=$$PAD("Totals:"," ",64)_$J(PSUQDTL,10)
"RTN","PSUCSR1",153,0)
 . S PSULC=PSULC+1
"RTN","PSUCSR1",154,0)
 . S @ML@(PSULC)="   "
"RTN","PSUCSR1",155,0)
 . S PSULC=PSULC+1
"RTN","PSUCSR1",156,0)
 . S @ML@(PSULC)=" * Non-Formulary"
"RTN","PSUCSR1",157,0)
 . S PSULC=PSULC+1
"RTN","PSUCSR1",158,0)
 . S @ML@(PSULC)=" # Not on National Formulary"
"RTN","PSUCSR1",159,0)
 ;
"RTN","PSUCSR1",160,0)
 Q
"RTN","PSUCSR1",161,0)
 ;
"RTN","PSUCSR1",162,0)
EXIT1 S PSUMLC=0
"RTN","PSUCSR1",163,0)
 Q
"RTN","PSUCSR1",164,0)
PAD(S,P,L) ; Pad string S with P to length L
"RTN","PSUCSR1",165,0)
 S $P(P,P,L)=""
"RTN","PSUCSR1",166,0)
 Q $E(S_P,1,L)
"RTN","PSUCSR1",167,0)
CTR(S,P,L) ; Center string S left and right P in size L
"RTN","PSUCSR1",168,0)
 Q $$PAD($$PAD(P,P,L-$L(S)\2)_S,P,L)
"RTN","PSUCSR2")
0^26^B28406983
"RTN","PSUCSR2",1,0)
PSUCSR2 ;BIR/DAM - PBM CS AMIS SUMMARY;6 APR 2004
"RTN","PSUCSR2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUCSR2",3,0)
 ;
"RTN","PSUCSR2",4,0)
 ;Reference to file #40.8 supported by DBIA 2438
"RTN","PSUCSR2",5,0)
 ;
"RTN","PSUCSR2",6,0)
EN ;Entry point to create AMIS summary report
"RTN","PSUCSR2",7,0)
 ;Called from ^PSUCSR1
"RTN","PSUCSR2",8,0)
 ;
"RTN","PSUCSR2",9,0)
 N TYP
"RTN","PSUCSR2",10,0)
 K CSAM
"RTN","PSUCSR2",11,0)
 ;
"RTN","PSUCSR2",12,0)
 S PSUDV=0
"RTN","PSUCSR2",13,0)
 F  S PSUDV=$O(^XTMP(PSUCSJB,"RECORDS",PSUDV)) Q:PSUDV=""  D
"RTN","PSUCSR2",14,0)
 .S PSUA=0
"RTN","PSUCSR2",15,0)
 .F  S PSUA=$O(^XTMP(PSUCSJB,"RECORDS",PSUDV,PSUA)) Q:PSUA=""  D
"RTN","PSUCSR2",16,0)
 ..S PSUB=0
"RTN","PSUCSR2",17,0)
 ..F  S PSUB=$O(^XTMP(PSUCSJB,"RECORDS",PSUDV,PSUA,PSUB)) Q:PSUB=""  D
"RTN","PSUCSR2",18,0)
 ...S TYP=^XTMP(PSUCSJB,"RECORDS",PSUDV,PSUA,PSUB,0)
"RTN","PSUCSR2",19,0)
 ...I TYP=2 D
"RTN","PSUCSR2",20,0)
 ....D DISP
"RTN","PSUCSR2",21,0)
 ....D TCOST
"RTN","PSUCSR2",22,0)
 .Q:'$D(CSAM(PSUDV))
"RTN","PSUCSR2",23,0)
 .D AVE
"RTN","PSUCSR2",24,0)
 .D TRUNC
"RTN","PSUCSR2",25,0)
 ;
"RTN","PSUCSR2",26,0)
 D TOTAL
"RTN","PSUCSR2",27,0)
 D MSG
"RTN","PSUCSR2",28,0)
 D MAIL
"RTN","PSUCSR2",29,0)
 ;
"RTN","PSUCSR2",30,0)
 Q
"RTN","PSUCSR2",31,0)
 ;
"RTN","PSUCSR2",32,0)
DISP ;Calculate orders dispensed
"RTN","PSUCSR2",33,0)
 ;
"RTN","PSUCSR2",34,0)
 S $P(CSAM(PSUDV),U,1)=$P($G(CSAM(PSUDV)),U,1)+1
"RTN","PSUCSR2",35,0)
 ;
"RTN","PSUCSR2",36,0)
 Q
"RTN","PSUCSR2",37,0)
 ;
"RTN","PSUCSR2",38,0)
TCOST ;Calculate total cost of orders dispensed
"RTN","PSUCSR2",39,0)
 ;
"RTN","PSUCSR2",40,0)
 N QTY,PRC
"RTN","PSUCSR2",41,0)
 ;
"RTN","PSUCSR2",42,0)
 S QTY=^XTMP(PSUCSJB,"RECORDS",PSUDV,PSUA,PSUB,17)
"RTN","PSUCSR2",43,0)
 S PRC=^XTMP(PSUCSJB,"RECORDS",PSUDV,PSUA,PSUB,16)
"RTN","PSUCSR2",44,0)
 ;
"RTN","PSUCSR2",45,0)
 S $P(CSAM(PSUDV),U,2)=$P($G(CSAM(PSUDV)),U,2)+(QTY*PRC)
"RTN","PSUCSR2",46,0)
 ;
"RTN","PSUCSR2",47,0)
 Q
"RTN","PSUCSR2",48,0)
 ;
"RTN","PSUCSR2",49,0)
AVE ;Calculate average cost per order
"RTN","PSUCSR2",50,0)
 ;
"RTN","PSUCSR2",51,0)
 N TCST,DSP
"RTN","PSUCSR2",52,0)
 ;
"RTN","PSUCSR2",53,0)
 S DSP=$P(CSAM(PSUDV),U,1)
"RTN","PSUCSR2",54,0)
 S TCST=$P(CSAM(PSUDV),U,2)
"RTN","PSUCSR2",55,0)
 ;
"RTN","PSUCSR2",56,0)
 S $P(CSAM(PSUDV),U,3)=$P($G(CSAM(PSUDV)),U,3)+(TCST/DSP)
"RTN","PSUCSR2",57,0)
 ;
"RTN","PSUCSR2",58,0)
 Q
"RTN","PSUCSR2",59,0)
 ;
"RTN","PSUCSR2",60,0)
TRUNC ;Truncate pieces with dollar values to 2 decimal places
"RTN","PSUCSR2",61,0)
 ;
"RTN","PSUCSR2",62,0)
 F I=2:1:3 D
"RTN","PSUCSR2",63,0)
 .N A,B,C
"RTN","PSUCSR2",64,0)
 .;
"RTN","PSUCSR2",65,0)
 .I $P(CSAM(PSUDV),U,I)'["." D  Q
"RTN","PSUCSR2",66,0)
 ..S $P(CSAM(PSUDV),U,I)=$P(CSAM(PSUDV),U,I)_".00"
"RTN","PSUCSR2",67,0)
 .;
"RTN","PSUCSR2",68,0)
 .S A=$F($P(CSAM(PSUDV),U,I),".")  ;Find first position after decimal
"RTN","PSUCSR2",69,0)
 .;
"RTN","PSUCSR2",70,0)
 .S B=$E($P(CSAM(PSUDV),U,I),1,(A-1))  ;Extract dollars and decimal
"RTN","PSUCSR2",71,0)
 .;
"RTN","PSUCSR2",72,0)
 .S C=$E($P(CSAM(PSUDV),U,I),A,(A+1))  ;Extract cents after decimal
"RTN","PSUCSR2",73,0)
 .;
"RTN","PSUCSR2",74,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUCSR2",75,0)
 .;
"RTN","PSUCSR2",76,0)
 .S $P(CSAM(PSUDV),U,I)=B_C
"RTN","PSUCSR2",77,0)
 ;
"RTN","PSUCSR2",78,0)
 Q
"RTN","PSUCSR2",79,0)
TOTAL ;Add column totals
"RTN","PSUCSR2",80,0)
 ;
"RTN","PSUCSR2",81,0)
 N TDSP,TCST,TAVE
"RTN","PSUCSR2",82,0)
 ;
"RTN","PSUCSR2",83,0)
 S PSUDIV=0
"RTN","PSUCSR2",84,0)
 F  S PSUDIV=$O(CSAM(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUCSR2",85,0)
 .S TDSP=$G(TDSP)+$P(CSAM(PSUDIV),U,1)    ;Total orders dispensed
"RTN","PSUCSR2",86,0)
 .S TCST=$G(TCST)+$P(CSAM(PSUDIV),U,2)    ;Total of total costs
"RTN","PSUCSR2",87,0)
 .I $G(TDSP) S TAVE=$G(TCST)/TDSP D
"RTN","PSUCSR2",88,0)
 ..I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUCSR2",89,0)
 ..N A,B,C
"RTN","PSUCSR2",90,0)
 ..S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUCSR2",91,0)
 ..S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUCSR2",92,0)
 ..S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUCSR2",93,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUCSR2",94,0)
 ..S TAVE=B_C
"RTN","PSUCSR2",95,0)
 ;
"RTN","PSUCSR2",96,0)
 S TOTAL("TOT")=$G(TDSP)_U_$G(TCST)_U_$G(TAVE)
"RTN","PSUCSR2",97,0)
 ;
"RTN","PSUCSR2",98,0)
 Q
"RTN","PSUCSR2",99,0)
 ;
"RTN","PSUCSR2",100,0)
MSG ;Construct lines for the MailMan message
"RTN","PSUCSR2",101,0)
 ;
"RTN","PSUCSR2",102,0)
 S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUCSR2",103,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUCSR2",104,0)
 ;
"RTN","PSUCSR2",105,0)
 K AMISC      ;Array to hold message lines
"RTN","PSUCSR2",106,0)
 ;
"RTN","PSUCSR2",107,0)
 S AMISC(1)="Controlled AMIS Summary for "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUCSR2",108,0)
 ;
"RTN","PSUCSR2",109,0)
 S AMISC(2)=""                       ;Blank line
"RTN","PSUCSR2",110,0)
 ;
"RTN","PSUCSR2",111,0)
 I '$D(CSAM) D  Q
"RTN","PSUCSR2",112,0)
 .S AMISC(3)=" "
"RTN","PSUCSR2",113,0)
 .S AMISC(4)="No data to report"
"RTN","PSUCSR2",114,0)
 .S AMISC(5)=" "
"RTN","PSUCSR2",115,0)
 ;
"RTN","PSUCSR2",116,0)
 S ^XTMP(PSUCSJB,"MAIL",PSUMC)=PSUDIV
"RTN","PSUCSR2",117,0)
 ;
"RTN","PSUCSR2",118,0)
 S AMISC(3)="INPATIENT CONTROLLED SUBSTANCE ORDERS:"
"RTN","PSUCSR2",119,0)
 ;
"RTN","PSUCSR2",120,0)
 S AMISC(4)=""                       ;Blank line
"RTN","PSUCSR2",121,0)
 ;
"RTN","PSUCSR2",122,0)
 S AMISC(5)="                            ORDERS               TOTAL     AVE COST"
"RTN","PSUCSR2",123,0)
 S AMISC(6)="DIVISION                    DISPENSED            COST      PER ORDER"
"RTN","PSUCSR2",124,0)
 ;
"RTN","PSUCSR2",125,0)
 S $P(AMISC(7),"-",78)=""      ;Separator bar
"RTN","PSUCSR2",126,0)
 ;
"RTN","PSUCSR2",127,0)
 S PSULN=8
"RTN","PSUCSR2",128,0)
 ;
"RTN","PSUCSR2",129,0)
 S PSUDIV=0
"RTN","PSUCSR2",130,0)
 F  S PSUDIV=$O(CSAM(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUCSR2",131,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUCSR2",132,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCSR2",133,0)
 .S PSULINE=""
"RTN","PSUCSR2",134,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUCSR2",135,0)
 .S $E(PSULINE,18,35)=$J($P(CSAM(PSUDIV),U,1),18)
"RTN","PSUCSR2",136,0)
 .S $E(PSULINE,41,42)="$"
"RTN","PSUCSR2",137,0)
 .S $E(PSULINE,43,53)=$J($P(CSAM(PSUDIV),U,2),11)
"RTN","PSUCSR2",138,0)
 .S $E(PSULINE,60,61)="$"
"RTN","PSUCSR2",139,0)
 .S $E(PSULINE,62,67)=$J($P(CSAM(PSUDIV),U,3),6)
"RTN","PSUCSR2",140,0)
 .S AMISC(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUCSR2",141,0)
 ;
"RTN","PSUCSR2",142,0)
 S $P(AMISC(PSULN),"-",78)=""     ;Separator bar
"RTN","PSUCSR2",143,0)
 S PSULN=PSULN+1
"RTN","PSUCSR2",144,0)
 ;
"RTN","PSUCSR2",145,0)
 S PSULINE=""
"RTN","PSUCSR2",146,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUCSR2",147,0)
 S $E(PSULINE,18,35)=$J($P(TOTAL("TOT"),U,1),18)
"RTN","PSUCSR2",148,0)
 S $E(PSULINE,41,42)="$"
"RTN","PSUCSR2",149,0)
 S $E(PSULINE,43,53)=$J($P(TOTAL("TOT"),U,2),11)
"RTN","PSUCSR2",150,0)
 S $E(PSULINE,60,61)="$"
"RTN","PSUCSR2",151,0)
 S $E(PSULINE,62,67)=$J($P(TOTAL("TOT"),U,3),6)
"RTN","PSUCSR2",152,0)
 S AMISC(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUCSR2",153,0)
 ;
"RTN","PSUCSR2",154,0)
 F PSULN=PSULN:1:(PSULN+2) S AMISC(PSULN)=""     ;Blank lines
"RTN","PSUCSR2",155,0)
 Q
"RTN","PSUCSR2",156,0)
 ;
"RTN","PSUCSR2",157,0)
MAIL ;Mail CS AMIS summary report
"RTN","PSUCSR2",158,0)
 ;
"RTN","PSUCSR2",159,0)
 ;Do not send report if option selection includes 1,2,3,4,6
"RTN","PSUCSR2",160,0)
 ;Instead send the combined AMIS summary report
"RTN","PSUCSR2",161,0)
 I $D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D  Q
"RTN","PSUCSR2",162,0)
 .M ^XTMP("PSU_"_PSUJOB,"CSCOMBO")=AMISC
"RTN","PSUCSR2",163,0)
 .S ^XTMP("PSU_"_PSUJOB,"CSCOMBO",1)=""
"RTN","PSUCSR2",164,0)
 .D EN^PSUAMC
"RTN","PSUCSR2",165,0)
 ;
"RTN","PSUCSR2",166,0)
 M XMY=PSUXMYS2
"RTN","PSUCSR2",167,0)
 ;
"RTN","PSUCSR2",168,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUCSR2",169,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUCSR2",170,0)
 ;
"RTN","PSUCSR2",171,0)
 S XMSUB="V. 4.0 PBMCS "_PSUMON_" "_PSUSNDR_" "_PSUDIVNM
"RTN","PSUCSR2",172,0)
 S XMTEXT="AMISC("
"RTN","PSUCSR2",173,0)
 M ^XTMP("PSU_"_PSUJOB,"CSAMIS")=AMISC
"RTN","PSUCSR2",174,0)
 S XMCHAN=1
"RTN","PSUCSR2",175,0)
 D ^XMD
"RTN","PSUCSR2",176,0)
 ;
"RTN","PSUCSR2",177,0)
 Q
"RTN","PSUDBQUE")
0^27^B33491236
"RTN","PSUDBQUE",1,0)
PSUDBQUE ; IHS/ADC/GTH - DOUBLE QUEUING SHELL HANDLER; 04 NOV 1997
"RTN","PSUDBQUE",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDBQUE",3,0)
 ; XB*3*5 - IHS/ADC/GTH 10-31-97
"RTN","PSUDBQUE",4,0)
 ; Thanks to Paul Wesley, DSD, for the original routine.
"RTN","PSUDBQUE",5,0)
 ; ---------------------------------------------------------
"RTN","PSUDBQUE",6,0)
 ; Programmer documentation included at end of routine - PGMNOTE
"RTN","PSUDBQUE",7,0)
 ; ---------------------------------------------------------
"RTN","PSUDBQUE",8,0)
 ;
"RTN","PSUDBQUE",9,0)
START ;
"RTN","PSUDBQUE",10,0)
EN ;PEP for double queuing
"RTN","PSUDBQUE",11,0)
 NEW PSU ;     use a fresh array in case of nesting double queues
"RTN","PSUDBQUE",12,0)
 ;     insure IO array is set fully
"RTN","PSUDBQUE",13,0)
 I ($D(IO)'>10) S IOP="HOME" D ^%ZIS
"RTN","PSUDBQUE",14,0)
 I $D(ZTQUEUED) S PSUFQ=1 S:'$D(PSUDTH) PSUDTH="NOW" ;   insure auto-requeue if called from a queued
"RTN","PSUDBQUE",15,0)
 I '$D(PSURC),'$D(PSURP) Q  ;                            insure one of RC or RP exist
"RTN","PSUDBQUE",16,0)
 I $D(PSUTITLE) S PSU("TITLE")=PSUTITLE K PSUTITLE
"RTN","PSUDBQUE",17,0)
 I IO="" S ION="NULL",(IOST,IOM,IOSL)=0
"RTN","PSUDBQUE",18,0)
 S PSU("IOP1")=ION_";"_IOST_";"_IOM_";"_IOSL ;           store current IO params
"RTN","PSUDBQUE",19,0)
 I $G(IOPAR)]"" S PSU("IOPAR")=IOPAR ;                   store IOPAR
"RTN","PSUDBQUE",20,0)
 I $L($G(PSURC))=0 S PSURC="NORC^PSUDBQUE" ;             no compute identified
"RTN","PSUDBQUE",21,0)
 S PSU("RC")=PSURC,PSU("RP")=$G(PSURP),PSU("RX")=$G(PSURX)
"RTN","PSUDBQUE",22,0)
 ;                                                      load PSUNS="xx;yy;.." into PSU("NS",xx*) ...
"RTN","PSUDBQUE",23,0)
 S PSUNS=$TR("PSUNS",",",";") ;                         allow "," seperator
"RTN","PSUDBQUE",24,0)
 F PSUI=1:1 S PSUNSX=$P($G(PSUNS),";",PSUI) Q:PSUNSX=""  S:(PSUNSX'["*") PSUNSX=PSUNSX_"*" S PSU("NS",PSUNSX)=""
"RTN","PSUDBQUE",25,0)
 S PSU("NS","PSU*")=""
"RTN","PSUDBQUE",26,0)
 ;                                                     load PSUNS("xxx") array into PSU("NS","xxx")
"RTN","PSUDBQUE",27,0)
 S PSUNSX=""
"RTN","PSUDBQUE",28,0)
 F  S PSUNSX=$O(PSUNS(PSUNSX)) Q:PSUNSX=""  S PSU("NS",PSUNSX)=""
"RTN","PSUDBQUE",29,0)
 ; if this is a double queue with PSU("IOP") setup .. pull the parameters out
"RTN","PSUDBQUE",30,0)
 ; of a ^%ZIS call to set up the parameters without an open
"RTN","PSUDBQUE",31,0)
 S PSU("IOP")=$G(PSUIOP)
"RTN","PSUDBQUE",32,0)
 I $D(PSUIOP) S IOP=PSUIOP
"RTN","PSUDBQUE",33,0)
 ; PSU*3*5 - IHS/ADC/GTH 10-31-97 start block
"RTN","PSUDBQUE",34,0)
 I $G(PSU("IOPAR"))]"" S %ZIS("IOPAR")=PSU("IOPAR") D
"RTN","PSUDBQUE",35,0)
 . I PSU("IOPAR")'?1"(""".E1""":""".E1""")" Q  ;                skip HFS if not an HFS
"RTN","PSUDBQUE",36,0)
 . S PSUHFSNM=$P(PSU("IOPAR"),":"),PSUHFSNM=$TR(PSUHFSNM,"()""")
"RTN","PSUDBQUE",37,0)
 . S PSUHFSMD=$P(PSU("IOPAR"),":",2),PSUHFSMD=$TR(PSUHFSMD,"()""")
"RTN","PSUDBQUE",38,0)
 . S %ZIS("HFSNAME")=PSUHFSNM,%ZIS("HFSMODE")=PSUHFSMD
"RTN","PSUDBQUE",39,0)
 . ;this code drops through
"RTN","PSUDBQUE",40,0)
 ; PSU*3*5 - IHS/ADC/GTH 10-31-97 end block
"RTN","PSUDBQUE",41,0)
ZIS ;
"RTN","PSUDBQUE",42,0)
 KILL IO("Q")
"RTN","PSUDBQUE",43,0)
 I $G(PSURC)]"",$G(PSURP)="" G ZISQ
"RTN","PSUDBQUE",44,0)
 S %ZIS="PQM"
"RTN","PSUDBQUE",45,0)
 D ^%ZIS ;                 get parameters without an open
"RTN","PSUDBQUE",46,0)
 I POP W !,"REPORTING-ABORTED",*7 G END1
"RTN","PSUDBQUE",47,0)
 S PSU("IO")=IO,PSU("IOP")=ION_";"_IOST_";"_IOM_";"_IOSL,PSU("IOPAR")=$G(IOPAR),PSU("CPU")=$G(IOCPU),PSU("ION")=ION
"RTN","PSUDBQUE",48,0)
ZISQ ;
"RTN","PSUDBQUE",49,0)
 I '$D(IO("Q")),'$G(PSUFQ) D
"RTN","PSUDBQUE",50,0)
 . I $D(ZTQUEUED) S PSUFQ=1 Q
"RTN","PSUDBQUE",51,0)
 . I IO=IO(0),$G(PSURP)]"" Q
"RTN","PSUDBQUE",52,0)
 . KILL DIR
"RTN","PSUDBQUE",53,0)
 . S DIR(0)="Y",DIR("B")="Y",DIR("A")="Won't you queue this "
"RTN","PSUDBQUE",54,0)
 . D ^DIR
"RTN","PSUDBQUE",55,0)
 . KILL DIR
"RTN","PSUDBQUE",56,0)
 . I X["^" S PSUQUIT=1
"RTN","PSUDBQUE",57,0)
 . S:Y=1 IO("Q")=1
"RTN","PSUDBQUE",58,0)
 . Q
"RTN","PSUDBQUE",59,0)
 ;
"RTN","PSUDBQUE",60,0)
 KILL PSU("ZTSK")
"RTN","PSUDBQUE",61,0)
 I $D(ZTQUEUED),$G(ZTSK) S PSU("ZTSK")=ZTSK
"RTN","PSUDBQUE",62,0)
 KILL ZTSK
"RTN","PSUDBQUE",63,0)
 ;  quit if user says so
"RTN","PSUDBQUE",64,0)
 I $G(PSUQUIT) KILL DIR S DIR(0)="E",DIR("A")="Report Aborted .. <CR> to continue" D ^DIR KILL DIR G END1
"RTN","PSUDBQUE",65,0)
 ;
"RTN","PSUDBQUE",66,0)
QUE1 ;
"RTN","PSUDBQUE",67,0)
 I ($D(IO("Q"))!($G(PSUFQ))) D  K IO("Q") W:(($G(ZTSK))&('$D(PSU("ZTSK")))) !,"Tasked with ",ZTSK W:'$G(ZTSK) !,*7,"Que not successful ... REPORTING ABORTED" D:'$D(ZTQUEUED) ^%ZISC S IOP=PSU("IOP1") D:'$D(ZTQUEUED) ^%ZIS G END1 ;--->
"RTN","PSUDBQUE",68,0)
 . ;I '$D(ZTQUEUED),IO=IO(0),$G(PSURP)]"" W !,"Queing to slave printer not allowed ... Report Aborting" Q  ;---^
"RTN","PSUDBQUE",69,0)
 . I $D(PSU("TITLE")) S ZTDESC=PSU("TITLE")_" compute"
"RTN","PSUDBQUE",70,0)
 . E  S ZTDESC="Double Que COMPUTing  "_PSURC_"  "_$G(PSURP)
"RTN","PSUDBQUE",71,0)
 . S ZTIO="",ZTRTN="DEQUE1^PSUDBQUE"
"RTN","PSUDBQUE",72,0)
 . S:$D(PSUDTH) ZTDTH=PSUDTH
"RTN","PSUDBQUE",73,0)
 . S:$G(PSU("CPU"))]"" ZTCPU=PSU("CPU")
"RTN","PSUDBQUE",74,0)
 . S PSUNSX=""
"RTN","PSUDBQUE",75,0)
 . F  S PSUNSX=$O(PSU("NS",PSUNSX)) Q:PSUNSX=""  S ZTSAVE(PSUNSX)=""
"RTN","PSUDBQUE",76,0)
 . KILL PSURC,PSURP,PSURX,PSUNS,PSUFQ,PSUDTH,PSUIOP,PSUPAR,PSUDTH,PSUNSX,PSUI
"RTN","PSUDBQUE",77,0)
 . S ZTIO="" ;                               insure no device loaded
"RTN","PSUDBQUE",78,0)
 . D ^%ZTLOAD
"RTN","PSUDBQUE",79,0)
 . Q  ; these do .s branch to END1
"RTN","PSUDBQUE",80,0)
 ; (((if queued the above code branched to END)))
"RTN","PSUDBQUE",81,0)
 ;
"RTN","PSUDBQUE",82,0)
DEQUE1 ;> 1st deque
"RTN","PSUDBQUE",83,0)
 ;
"RTN","PSUDBQUE",84,0)
 KILL PSURC,PSURP,PSURX,PSUNS,PSUFQ,PSUDTH,PSUIOP,PSUPAR,PSUDTH
"RTN","PSUDBQUE",85,0)
 KILL PSU("ZTSK")
"RTN","PSUDBQUE",86,0)
 I $D(ZTQUEUED),$G(ZTSK) S PSU("ZTSK")=ZTSK
"RTN","PSUDBQUE",87,0)
 ;
"RTN","PSUDBQUE",88,0)
COMPUTE ;>do computing | routine
"RTN","PSUDBQUE",89,0)
 ;
"RTN","PSUDBQUE",90,0)
 D @(PSU("RC")) ;  >>>PERFORM THE COMPUTE ROUTINE<<< ;stuffed if not provided with NORC^PSUDBQUE
"RTN","PSUDBQUE",91,0)
 ;
"RTN","PSUDBQUE",92,0)
QUE2 ;
"RTN","PSUDBQUE",93,0)
 ;
"RTN","PSUDBQUE",94,0)
 I $D(ZTQUEUED) D  G ENDC ;===>    automatically requeue if queued
"RTN","PSUDBQUE",95,0)
 . Q:PSU("RP")=""
"RTN","PSUDBQUE",96,0)
 . I $D(PSU("TITLE")) S ZTDESC=PSU("TITLE")_" print"
"RTN","PSUDBQUE",97,0)
 . E  S ZTDESC="Double Que PRINT "_PSU("RC")_" "_PSU("RP")
"RTN","PSUDBQUE",98,0)
 . S ZTIO=PSU("IO"),ZTDTH=$H,ZTRTN="DEQUE2^PSUDBQUE"
"RTN","PSUDBQUE",99,0)
 . S PSUNSX=""
"RTN","PSUDBQUE",100,0)
 . F  S PSUNSX=$O(PSU("NS",PSUNSX)) Q:PSUNSX=""  S ZTSAVE(PSUNSX)=""
"RTN","PSUDBQUE",101,0)
 . D SETIOPN K ZTIO
"RTN","PSUDBQUE",102,0)
 . D ^%ZTLOAD
"RTN","PSUDBQUE",103,0)
 . I '$D(ZTSK) S PSUERR="SECOND QUE FAILED" D @^%ZOSF("ERRTN") Q
"RTN","PSUDBQUE",104,0)
 . S PSUDBQUE=1
"RTN","PSUDBQUE",105,0)
 . Q  ;                     ======>         this branches to ENDC
"RTN","PSUDBQUE",106,0)
 ;
"RTN","PSUDBQUE",107,0)
 ; device opened from the first que ask
"RTN","PSUDBQUE",108,0)
DEQUE2 ;>EP 2nd Deque | printing
"RTN","PSUDBQUE",109,0)
 KILL PSU("ZTSK")
"RTN","PSUDBQUE",110,0)
 I $D(ZTQUEUED),$G(ZTSK) S PSU("ZTSK")=ZTSK
"RTN","PSUDBQUE",111,0)
 ;open printer device for printing with all selected parameters
"RTN","PSUDBQUE",112,0)
 G:(PSU("RP")="") END ;---> exit if no print
"RTN","PSUDBQUE",113,0)
 ;
"RTN","PSUDBQUE",114,0)
 U IO
"RTN","PSUDBQUE",115,0)
 D @(PSU("RP")) ; >>>PERFORM PRINTING ROUTINE
"RTN","PSUDBQUE",116,0)
 ;
"RTN","PSUDBQUE",117,0)
 ;--------
"RTN","PSUDBQUE",118,0)
END ;>End | cleanup
"RTN","PSUDBQUE",119,0)
 ;
"RTN","PSUDBQUE",120,0)
 I $G(PSU("RX"))'="" D @(PSU("RX")) ;   >>>PERFORM CLEANUP ROUTINE<<<
"RTN","PSUDBQUE",121,0)
 ;
"RTN","PSUDBQUE",122,0)
END0 ;EP - from compute cycle when PSU("RP") EXISTS
"RTN","PSUDBQUE",123,0)
 I $D(PSU("ZTSK")) S PSUTZTSK=$G(ZTSK),ZTSK=PSU("ZTSK") D KILL^%ZTLOAD K ZTSK S:$G(PSUTZTSK) ZTSK=PSUTZTSK KILL PSUTZTSK
"RTN","PSUDBQUE",124,0)
END1 ;EP clean out PSU as passed in
"RTN","PSUDBQUE",125,0)
 D:'$D(ZTQUEUED) ^%ZISC
"RTN","PSUDBQUE",126,0)
 S IOP=PSU("IOP1") ; restore original IO parameters
"RTN","PSUDBQUE",127,0)
 D:'$D(ZTQUEUED) ^%ZIS
"RTN","PSUDBQUE",128,0)
 K IOPAR,IOUPAR,IOP
"RTN","PSUDBQUE",129,0)
 KILL PSU,PSURC,PSURP,PSURX,PSUNS,PSUFQ,PSUDTH,PSUIOP,PSUPAR,PSUDTH,PSUERR,PSUI,PSUNSX,PSUQUIT,PSUDBQUE
"RTN","PSUDBQUE",130,0)
 ;
"RTN","PSUDBQUE",131,0)
 Q
"RTN","PSUDBQUE",132,0)
ENDC ;EP - end computing cycle
"RTN","PSUDBQUE",133,0)
 I $G(PSU("RP"))="" G END
"RTN","PSUDBQUE",134,0)
 G END0
"RTN","PSUDBQUE",135,0)
 ;
"RTN","PSUDBQUE",136,0)
 ;----------------
"RTN","PSUDBQUE",137,0)
 ;----------------
"RTN","PSUDBQUE",138,0)
SUB ;>Subroutines
"RTN","PSUDBQUE",139,0)
 ;----------
"RTN","PSUDBQUE",140,0)
NORC ;used if no PSURC identified
"RTN","PSUDBQUE",141,0)
 Q
"RTN","PSUDBQUE",142,0)
 ;
"RTN","PSUDBQUE",143,0)
SETIOPN ;EP Set IOP parameters with (N)o open
"RTN","PSUDBQUE",144,0)
 Q:'$D(PSU("IOP"))
"RTN","PSUDBQUE",145,0)
 S IOP=PSU("IOP")
"RTN","PSUDBQUE",146,0)
 ; PSU*3*5 - IHS/ADC/GTH 10-31-97 start block
"RTN","PSUDBQUE",147,0)
 I $G(PSU("IOPAR"))]"" S %ZIS("IOPAR")=PSU("IOPAR") D
"RTN","PSUDBQUE",148,0)
 . I PSU("IOPAR")'?1"(""".E1""":""".E1""")" Q  ;                skip HFS if not an HFS
"RTN","PSUDBQUE",149,0)
 . S PSUHFSNM=$P(PSU("IOPAR"),":"),PSUHFSNM=$TR(PSUHFSNM,"()""")
"RTN","PSUDBQUE",150,0)
 . S PSUHFSMD=$P(PSU("IOPAR"),":",2),PSUHFSMD=$TR(PSUHFSMD,"()""")
"RTN","PSUDBQUE",151,0)
 . S %ZIS("HFSNAME")=PSUHFSNM,%ZIS("HFSMODE")=PSUHFSMD
"RTN","PSUDBQUE",152,0)
 . Q
"RTN","PSUDBQUE",153,0)
 ; PSU*3*5 - IHS/ADC/GTH 10-31-97 end block
"RTN","PSUDBQUE",154,0)
 S %ZIS="N"
"RTN","PSUDBQUE",155,0)
 S %H=299
"RTN","PSUDBQUE",156,0)
 D ^%ZIS
"RTN","PSUDBQUE",157,0)
 Q
"RTN","PSUDBQUE",158,0)
PGMNOTE ;
"RTN","PSUDBQUE",159,0)
 ;----------------------
"RTN","PSUDBQUE",160,0)
 ;NOTES FOR PROGRAMMERS|
"RTN","PSUDBQUE",161,0)
 ;----------------------
"RTN","PSUDBQUE",162,0)
 ; VARIABLES NEEDED FROM CALLING PROGRAM
"RTN","PSUDBQUE",163,0)
 ;
"RTN","PSUDBQUE",164,0)
 ;MANDATORY
"RTN","PSUDBQUE",165,0)
 ;  Either PSURC=Compute Routine or PSURP=Print Routine.
"RTN","PSUDBQUE",166,0)
 ;
"RTN","PSUDBQUE",167,0)
 ;OPTIONAL
"RTN","PSUDBQUE",168,0)
 ;  PSURC= [label]^routine for code that will collect/compute data
"RTN","PSUDBQUE",169,0)
 ;  PSURP= [label]^routine for code that will perform output
"RTN","PSUDBQUE",170,0)
 ;  PSURX= [label]^routine for exit processing (clean up variables, etc.) HIGHLY RECOMMENDED.
"RTN","PSUDBQUE",171,0)
 ;  PSUNS= namespace(s) of variables to be auto-loaded into ZTSAVE("namespace*")=""
"RTN","PSUDBQUE",172,0)
 ;       ="DG;AUPN;PS;..." ; (will add '*'if missing).
"RTN","PSUDBQUE",173,0)
 ;     or="DG,AUPN,PS,..." ; (may be semi-colon or comma delimited)
"RTN","PSUDBQUE",174,0)
 ;  PSUNS("xxx")="" - ZTSAVE variable arrays where xxx is as described for ZTSAVE("xxxx")="".
"RTN","PSUDBQUE",175,0)
 ;  PSUFQ= 1 Force Queueing, =0 Prompt for Queueing
"RTN","PSUDBQUE",176,0)
 ;  PSUDTH= Tasking date.time in FM format.
"RTN","PSUDBQUE",177,0)
 ;  PSUIOP= pre-selected print device constructed with  ION ; IOST ; IOSL ; IOM
"RTN","PSUDBQUE",178,0)
 ;         (mandatory if the calling routine is a queued routine).
"RTN","PSUDBQUE",179,0)
 ;  PSUPAR= %ZIS("IOPAR") values for host file with PSUIOP if needed.
"RTN","PSUDBQUE",180,0)
 ;
"RTN","PSUDBQUE",181,0)
 ;ACTIONS
"RTN","PSUDBQUE",182,0)
 ; %ZIS with "PQM" is called by PSUDBQUE if '$D(PSUIOP).
"RTN","PSUDBQUE",183,0)
 ;
"RTN","PSUDBQUE",184,0)
 ; The user will be asked to queue if queuing has not been
"RTN","PSUDBQUE",185,0)
 ; selected.
"RTN","PSUDBQUE",186,0)
 ;
"RTN","PSUDBQUE",187,0)
 ; IO variables for printing as necessary are automatically stored.
"RTN","PSUDBQUE",188,0)
 ;
"RTN","PSUDBQUE",189,0)
 ; PSUxx input variables are killed after loading into a PSU array.
"RTN","PSUDBQUE",190,0)
 ;
"RTN","PSUDBQUE",191,0)
 ; PSUDBQUE can be nested.
"RTN","PSUDBQUE",192,0)
 ;
"RTN","PSUDBQUE",193,0)
 ; The compute and print phases can call PSUDBQUE individually
"RTN","PSUDBQUE",194,0)
 ; (PSUIOP is required).
"RTN","PSUDBQUE",195,0)
 ;
"RTN","PSUDBQUE",196,0)
 ; The appropriate %ZTSK node is killed.
"RTN","PSUDBQUE",197,0)
 ;
"RTN","PSUDBQUE",198,0)
 ;EX:
"RTN","PSUDBQUE",199,0)
 ; S PSURC="C^AGTEST",PSURP="P^AGTEST",PSURX="END^AGTEST",PSUNS="AG"
"RTN","PSUDBQUE",200,0)
 ; D ^PSUDBQUE ;handles foreground and tasking
"RTN","PSUDBQUE",201,0)
 ; Q
"RTN","PSUDEM0")
0^28^B23741860
"RTN","PSUDEM0",1,0)
PSUDEM0 ;BIR/DAM - Patient Demographics Summary Print Routine ; 20 DEC 2001
"RTN","PSUDEM0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM0",3,0)
 ;
"RTN","PSUDEM0",4,0)
 ;
"RTN","PSUDEM0",5,0)
PRINT ;Print header for pt demographics
"RTN","PSUDEM0",6,0)
 Q
"RTN","PSUDEM0",7,0)
 ;
"RTN","PSUDEM0",8,0)
OPV ;EN   Outpatient Visit "No Data" message.  Called only when
"RTN","PSUDEM0",9,0)
 ; user answers 'yes'
"RTN","PSUDEM0",10,0)
 ;to "Do you want to receive this in a MailMan message?" AND when there
"RTN","PSUDEM0",11,0)
 ;is no data to report.
"RTN","PSUDEM0",12,0)
 ;
"RTN","PSUDEM0",13,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))
"RTN","PSUDEM0",14,0)
 Q:PSUSMRY        ;Don't print if user wants summary only
"RTN","PSUDEM0",15,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUOPV"))
"RTN","PSUDEM0",16,0)
 ;
"RTN","PSUDEM0",17,0)
 W @IOF
"RTN","PSUDEM0",18,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUDEM0",19,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUDEM0",20,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUDEM0",21,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUDEM0",22,0)
 ;
"RTN","PSUDEM0",23,0)
 S PSUOVSUB="PSUOPV_"_PSUJOB
"RTN","PSUDEM0",24,0)
 S ^XTMP(PSUOVSUB,"PSUOPV",PSUSNDR,1)="Outpatient Visits for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUDEM0",25,0)
 S ^XTMP(PSUOVSUB,"PSUOPV",PSUSNDR,2)=" "
"RTN","PSUDEM0",26,0)
 S ^XTMP(PSUOVSUB,"PSUOPV",PSUSNDR,3)="No data to report"
"RTN","PSUDEM0",27,0)
 ;
"RTN","PSUDEM0",28,0)
 U IO
"RTN","PSUDEM0",29,0)
 ;
"RTN","PSUDEM0",30,0)
 ;F I=1:1:3 W !
"RTN","PSUDEM0",31,0)
 S PSUL=0
"RTN","PSUDEM0",32,0)
 F  S PSUL=$O(^XTMP(PSUOVSUB,"PSUOPV",PSUSNDR,PSUL)) Q:PSUL=""  D
"RTN","PSUDEM0",33,0)
 .S X=^XTMP(PSUOVSUB,"PSUOPV",PSUSNDR,PSUL) W !,X
"RTN","PSUDEM0",34,0)
 .I PSUL=1 W " for ",$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2),!,?72,"PAGE:  1"
"RTN","PSUDEM0",35,0)
 ;
"RTN","PSUDEM0",36,0)
 Q
"RTN","PSUDEM0",37,0)
 ;
"RTN","PSUDEM0",38,0)
PTF ;EN  Inpatient Visit "No Data" message. 
"RTN","PSUDEM0",39,0)
 ;Called only when user answers 'YES'
"RTN","PSUDEM0",40,0)
 ;to "Do you want to receive this in a MailMan message?" AND when there
"RTN","PSUDEM0",41,0)
 ;is no data to report.
"RTN","PSUDEM0",42,0)
 ;
"RTN","PSUDEM0",43,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))
"RTN","PSUDEM0",44,0)
 Q:PSUSMRY      ;Don't print if user wants summary only
"RTN","PSUDEM0",45,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUIPV"))
"RTN","PSUDEM0",46,0)
 ;
"RTN","PSUDEM0",47,0)
 W @IOF
"RTN","PSUDEM0",48,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUDEM0",49,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUDEM0",50,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUDEM0",51,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUDEM0",52,0)
 ;
"RTN","PSUDEM0",53,0)
 S PSUIVSUB="PSUIPV_"_PSUJOB
"RTN","PSUDEM0",54,0)
 S ^XTMP(PSUIVSUB,"PSUIPV",PSUSNDR,1)="Inpatient PTF Records for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUDEM0",55,0)
 S ^XTMP(PSUIVSUB,"PSUIPV",PSUSNDR,2)=" "
"RTN","PSUDEM0",56,0)
 S ^XTMP(PSUIVSUB,"PSUIPV",PSUSNDR,3)="No data to report"
"RTN","PSUDEM0",57,0)
 ;
"RTN","PSUDEM0",58,0)
 U IO
"RTN","PSUDEM0",59,0)
 ;
"RTN","PSUDEM0",60,0)
 ;F I=1:1:3 W !
"RTN","PSUDEM0",61,0)
 S PSUL=0
"RTN","PSUDEM0",62,0)
 F  S PSUL=$O(^XTMP(PSUIVSUB,"PSUIPV",PSUSNDR,PSUL)) Q:PSUL=""  D
"RTN","PSUDEM0",63,0)
 .S X=^XTMP(PSUIVSUB,"PSUIPV",PSUSNDR,PSUL) W !,X
"RTN","PSUDEM0",64,0)
 .I PSUL=1 W " for ",$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2),!,?72,"PAGE:  1"
"RTN","PSUDEM0",65,0)
 ;
"RTN","PSUDEM0",66,0)
 Q
"RTN","PSUDEM0",67,0)
 ;
"RTN","PSUDEM0",68,0)
PRO ;EN   Provider information print routine. Prints summary report. 
"RTN","PSUDEM0",69,0)
 ;Called only when user answers 'NO'
"RTN","PSUDEM0",70,0)
 ;to "Do you want to receive this in a MailMan message?" 
"RTN","PSUDEM0",71,0)
 ;
"RTN","PSUDEM0",72,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUDEM0",73,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUDEM0",74,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUDEM0",75,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUDEM0",76,0)
 ;
"RTN","PSUDEM0",77,0)
 S PSUPGS("PG")=1
"RTN","PSUDEM0",78,0)
 ;
"RTN","PSUDEM0",79,0)
 S PSUPROSB="PSUPRO_"_PSUJOB
"RTN","PSUDEM0",80,0)
 D PGHDR
"RTN","PSUDEM0",81,0)
 ;
"RTN","PSUDEM0",82,0)
 S N=0,K=3
"RTN","PSUDEM0",83,0)
 F  S N=$O(^XTMP("PSU_"_PSUJOB,"PSUSUM",N)) Q:N=""  D
"RTN","PSUDEM0",84,0)
 .M ^XTMP(PSUPROSB,"PSUPRO",PSUSNDR,K)=^XTMP("PSU_"_PSUJOB,"PSUSUM",N)
"RTN","PSUDEM0",85,0)
 .S K=K+1                      ;Set Provider summary into XTMP global
"RTN","PSUDEM0",86,0)
 ;
"RTN","PSUDEM0",87,0)
 ;
"RTN","PSUDEM0",88,0)
 S PSUL=0
"RTN","PSUDEM0",89,0)
 F  S PSUL=$O(^XTMP(PSUPROSB,"PSUPRO",PSUSNDR,PSUL)) Q:PSUL=""  D
"RTN","PSUDEM0",90,0)
 .I LNCNT+4>IOSL D PGHDR
"RTN","PSUDEM0",91,0)
 .S X=^XTMP(PSUPROSB,"PSUPRO",PSUSNDR,PSUL) W !,X
"RTN","PSUDEM0",92,0)
 .S LNCNT=LNCNT+1
"RTN","PSUDEM0",93,0)
 ;
"RTN","PSUDEM0",94,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUSUM")
"RTN","PSUDEM0",95,0)
 Q
"RTN","PSUDEM0",96,0)
 ;
"RTN","PSUDEM0",97,0)
PGHDR ;Page header for Provider summary message
"RTN","PSUDEM0",98,0)
 ;VMP-IOFO BAY PINES;ELR;PSU*3.0*26 REMOVE FORM FEED
"RTN","PSUDEM0",99,0)
 ;U IO W @IOF
"RTN","PSUDEM0",100,0)
 W "Provider Data for "_PSURP("START")_" through "_PSURP("END")_" for "_$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM0",101,0)
 W !,?68,"PAGE: "_PSUPGS("PG")
"RTN","PSUDEM0",102,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUDEM0",103,0)
 F PSUH=9:1:12 W !,$G(^XTMP(PSUPROSB,"PSUPRO",PSUSNDR,PSUH))
"RTN","PSUDEM0",104,0)
 S LNCNT=5
"RTN","PSUDEM0",105,0)
 Q
"RTN","PSUDEM0",106,0)
 ;
"RTN","PSUDEM0",107,0)
IVSUM ;EN   Print routine for all Pt. Demographics Summary reports.  
"RTN","PSUDEM0",108,0)
 ;Prints NO Data
"RTN","PSUDEM0",109,0)
 ;and Summary report to screen if user answers 'N' to "Do you want a
"RTN","PSUDEM0",110,0)
 ;copy of this message sent to you in mailman?"
"RTN","PSUDEM0",111,0)
 ;
"RTN","PSUDEM0",112,0)
 D INST^PSUDEM1
"RTN","PSUDEM0",113,0)
 D COMM
"RTN","PSUDEM0",114,0)
 U IO
"RTN","PSUDEM0",115,0)
 W @IOF
"RTN","PSUDEM0",116,0)
 ;
"RTN","PSUDEM0",117,0)
 S PSUIVSUB="PSUPD_"_PSUJOB
"RTN","PSUDEM0",118,0)
 S ^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,1)="Patient Demographics Summary for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUDEM0",119,0)
 S ^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,2)=" "
"RTN","PSUDEM0",120,0)
 ;
"RTN","PSUDEM0",121,0)
 ;Do the following if there is no data to report
"RTN","PSUDEM0",122,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE")) D  Q
"RTN","PSUDEM0",123,0)
 .S ^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,3)="No data to report"
"RTN","PSUDEM0",124,0)
 .S PSUL=0
"RTN","PSUDEM0",125,0)
 .F  S PSUL=$O(^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,PSUL)) Q:PSUL=""  D
"RTN","PSUDEM0",126,0)
 ..S X=^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,PSUL) W !,X
"RTN","PSUDEM0",127,0)
 ..I PSUL=2 W " for ",$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2),!,?69,"Page:  1"
"RTN","PSUDEM0",128,0)
 ;
"RTN","PSUDEM0",129,0)
 ;Do the following if there is data to report in a summary
"RTN","PSUDEM0",130,0)
 S N=0,K=3
"RTN","PSUDEM0",131,0)
 F  S N=$O(^XTMP("PSU_"_PSUJOB,"PSUSUMA",N)) Q:N=""  D
"RTN","PSUDEM0",132,0)
 .M ^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,K)=^XTMP("PSU_"_PSUJOB,"PSUSUMA",N)
"RTN","PSUDEM0",133,0)
 .S K=K+1      ;Set Provider summary into XTMP global
"RTN","PSUDEM0",134,0)
 ;
"RTN","PSUDEM0",135,0)
 ;
"RTN","PSUDEM0",136,0)
 S PSUL=0
"RTN","PSUDEM0",137,0)
 F  S PSUL=$O(^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,PSUL)) Q:PSUL=""  D
"RTN","PSUDEM0",138,0)
 .S X=^XTMP(PSUIVSUB,"PSUPD",PSUSNDR,PSUL) W !,X
"RTN","PSUDEM0",139,0)
 .I PSUL=2 W " for ",$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2),!,?69,"Page:  1"
"RTN","PSUDEM0",140,0)
 ;
"RTN","PSUDEM0",141,0)
 Q
"RTN","PSUDEM0",142,0)
 ;
"RTN","PSUDEM0",143,0)
COMM ;Common variables among all print subroutines
"RTN","PSUDEM0",144,0)
 ;
"RTN","PSUDEM0",145,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUDEM0",146,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUDEM0",147,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUDEM0",148,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUDEM0",149,0)
 ;
"RTN","PSUDEM0",150,0)
 Q
"RTN","PSUDEM1")
0^29^B42786369
"RTN","PSUDEM1",1,0)
PSUDEM1 ;BIR/DAM - Patient Demographics Extract ; 20 DEC 2001
"RTN","PSUDEM1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM1",3,0)
 ;
"RTN","PSUDEM1",4,0)
 ;DBIA's
"RTN","PSUDEM1",5,0)
 ; Reference to file #27.11  supported by DBIA 2462
"RTN","PSUDEM1",6,0)
 ; Reference to file 2       supported by DBIA 10035, 3504
"RTN","PSUDEM1",7,0)
 ; Reference to file 200     supported by DBIA 10060
"RTN","PSUDEM1",8,0)
 ; Reference to file 55      supported by DBIA 3502
"RTN","PSUDEM1",9,0)
 ; Reference to file 4.3     supported by DBIA 2496, 10091
"RTN","PSUDEM1",10,0)
 ; Reference to file 4       supported by DBIA 10090
"RTN","PSUDEM1",11,0)
 ;
"RTN","PSUDEM1",12,0)
EN ;EN   Routine control module
"RTN","PSUDEM1",13,0)
 ;
"RTN","PSUDEM1",14,0)
 D DAT
"RTN","PSUDEM1",15,0)
 I $D(^XTMP("PSUMANL")) D DEM     ;Manual entry point  DAM
"RTN","PSUDEM1",16,0)
 I $G(^XTMP("PSU_"_PSUJOB,"PSUPSUMFLAG")) D HL7    ;Auto entry point DAM
"RTN","PSUDEM1",17,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D XMD
"RTN","PSUDEM1",18,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUXMD")
"RTN","PSUDEM1",19,0)
 ;
"RTN","PSUDEM1",20,0)
 I $G(^XTMP("PSU_"_PSUJOB,"PSUPSUMFLAG"))=1 D
"RTN","PSUDEM1",21,0)
 .S PSUOPTS="1,2,3,4,5,6,7,8,9,10,11"
"RTN","PSUDEM1",22,0)
 .S PSUAUTO=1
"RTN","PSUDEM1",23,0)
 ;
"RTN","PSUDEM1",24,0)
 ;
"RTN","PSUDEM1",25,0)
 D PULL^PSUCP
"RTN","PSUDEM1",26,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUDEM1",27,0)
 ;
"RTN","PSUDEM1",28,0)
 I $D(PSUMOD(10)) D PDSSN^PSUDEM4  ;pt. demographics provider msg
"RTN","PSUDEM1",29,0)
 ;
"RTN","PSUDEM1",30,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUPDFLAG")
"RTN","PSUDEM1",31,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUDM")
"RTN","PSUDEM1",32,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUDMX")
"RTN","PSUDEM1",33,0)
 K PSUDMDFN,PSURAC,PSURDT
"RTN","PSUDEM1",34,0)
 Q
"RTN","PSUDEM1",35,0)
 ;
"RTN","PSUDEM1",36,0)
HL7 ;This is the Patient Demographics extract that runs only when
"RTN","PSUDEM1",37,0)
 ;the PSU PBM [AUTO] option is executed.  It captures demographic
"RTN","PSUDEM1",38,0)
 ;information ONLY on new or updated patient.
"RTN","PSUDEM1",39,0)
 ;
"RTN","PSUDEM1",40,0)
 F  S PSUSDT=$O(^PSUDEM("B",PSUSDT)) Q:PSUSDT>PSUEDT  D
"RTN","PSUDEM1",41,0)
 . S I=""
"RTN","PSUDEM1",42,0)
 . S I=$O(^PSUDEM("B",PSUSDT,I)) Q:I=""
"RTN","PSUDEM1",43,0)
 . S DFN=$P(^PSUDEM(I,0),U,2)
"RTN","PSUDEM1",44,0)
 . S ^XTMP("PSU"_PSUJOB,"REXMT",DFN)=""
"RTN","PSUDEM1",45,0)
 K DFN
"RTN","PSUDEM1",46,0)
 ;
"RTN","PSUDEM1",47,0)
 S DFN=""
"RTN","PSUDEM1",48,0)
 F  S (DFN,PSUDMDFN)=$O(^XTMP("PSU"_PSUJOB,"REXMT",DFN)) Q:DFN=""  D DEM1
"RTN","PSUDEM1",49,0)
 ;
"RTN","PSUDEM1",50,0)
 Q
"RTN","PSUDEM1",51,0)
 ;
"RTN","PSUDEM1",52,0)
DAT ;Date Module
"RTN","PSUDEM1",53,0)
 ;
"RTN","PSUDEM1",54,0)
 ;Date extract was run
"RTN","PSUDEM1",55,0)
 S %H=$H
"RTN","PSUDEM1",56,0)
 D YMD^%DTC                   ;Converts $H to FileMan format
"RTN","PSUDEM1",57,0)
 ; ** S $P(^TMP("PSUDM",$J),U,3)=X    ;Set extract date in temp global
"RTN","PSUDEM1",58,0)
 S PSURDT=X
"RTN","PSUDEM1",59,0)
 ;
"RTN","PSUDEM1",60,0)
 Q
"RTN","PSUDEM1",61,0)
 ;
"RTN","PSUDEM1",62,0)
INST ;EN  Place institution code sending report into temp global.
"RTN","PSUDEM1",63,0)
 ;Institution Mailman info is in file 4.3 
"RTN","PSUDEM1",64,0)
 ;
"RTN","PSUDEM1",65,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSUDEM1",66,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)=PSUSNDR
"RTN","PSUDEM1",67,0)
 S PSUSIT=PSUSNDR
"RTN","PSUDEM1",68,0)
 ;
"RTN","PSUDEM1",69,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUDEM1",70,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUDEM1",71,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)=PSUDIVNM
"RTN","PSUDEM1",72,0)
 Q
"RTN","PSUDEM1",73,0)
 ;
"RTN","PSUDEM1",74,0)
DEM ;PULL PATIENT DEMOGRAPHICS. This is run only when user selects
"RTN","PSUDEM1",75,0)
 ;PSU PBM [MANUAL] option.  It gather patient demographic information
"RTN","PSUDEM1",76,0)
 ;for all patients in the PATIENT file #2.
"RTN","PSUDEM1",77,0)
 ;
"RTN","PSUDEM1",78,0)
 ;N PSUREC    ;DAM TEST NEW CODE
"RTN","PSUDEM1",79,0)
 N PSUREC
"RTN","PSUDEM1",80,0)
 K PSUREC1,PSUREC2,PSUREC3,PSUREC4,PSUREC5,PSUREC6,PSUREC7
"RTN","PSUDEM1",81,0)
 K PSUREC8,PSUREC9,PSUREC10,PSUREC11,PSUREC12,PSUREC13,PSUREC14
"RTN","PSUDEM1",82,0)
 K PSUREC15,PSUDOD,VAEL,VADM
"RTN","PSUDEM1",83,0)
 ;
"RTN","PSUDEM1",84,0)
 S PSUNAM=0
"RTN","PSUDEM1",85,0)
 F  S PSUNAM=$O(^DPT("B",PSUNAM)) Q:PSUNAM=""  D
"RTN","PSUDEM1",86,0)
 .S PSUDMDFN=0
"RTN","PSUDEM1",87,0)
 .F  S (DFN,PSUDMDFN)=$O(^DPT("B",PSUNAM,PSUDMDFN)) Q:PSUDMDFN=""  D DEM1
"RTN","PSUDEM1",88,0)
 Q
"RTN","PSUDEM1",89,0)
 ;
"RTN","PSUDEM1",90,0)
DEM1 ;
"RTN","PSUDEM1",91,0)
 K PSUREC,PSUREC1,PSUREC2,PSUREC3,PSUREC4,PSUREC5,PSUREC6,PSUREC7
"RTN","PSUDEM1",92,0)
 K PSUREC8,PSUREC9,PSUREC10,PSUREC11,PSUREC12,PSUREC13,PSUREC14
"RTN","PSUDEM1",93,0)
 K PSUREC15,PSUDOD,VAEL,VADM
"RTN","PSUDEM1",94,0)
 S PSUDOD=$P($G(^DPT(PSUDMDFN,.35)),U,1) I PSUDOD,PSUDOD<2980701 Q
"RTN","PSUDEM1",95,0)
 Q:'$D(^DPT(PSUDMDFN,0))  S PSUREC1=$G(^DPT(PSUDMDFN,0))
"RTN","PSUDEM1",96,0)
 I $P(PSUREC1,U,21)=1 Q
"RTN","PSUDEM1",97,0)
 I $E($P(PSUREC1,U,9),1,5)="00000" Q
"RTN","PSUDEM1",98,0)
 D DEM^VADPT
"RTN","PSUDEM1",99,0)
 D ELIG^VADPT
"RTN","PSUDEM1",100,0)
 ;RUN DATE
"RTN","PSUDEM1",101,0)
 S $P(PSUREC,U,3)=PSURDT
"RTN","PSUDEM1",102,0)
 ;Gender
"RTN","PSUDEM1",103,0)
 S PSUREC3=$TR($P(PSUREC1,U,2),"^","'"),$P(PSUREC,U,8)=PSUREC3
"RTN","PSUDEM1",104,0)
 ;SSN
"RTN","PSUDEM1",105,0)
 S PSUREC4=$TR($P(PSUREC1,U,9),"^","'"),$P(PSUREC,U,12)=PSUREC4
"RTN","PSUDEM1",106,0)
 ;DOB
"RTN","PSUDEM1",107,0)
 S PSUREC5=$TR($P(PSUREC1,U,3),"^","'"),$P(PSUREC,U,5)=PSUREC5
"RTN","PSUDEM1",108,0)
 ;DT PT ENTERED IN FILE
"RTN","PSUDEM1",109,0)
 S PSUREC6=$TR($P(PSUREC1,U,16),"^","'"),$P(PSUREC,U,16)=PSUREC6
"RTN","PSUDEM1",110,0)
 S PSUREC7=$G(^PS(55,PSUDMDFN,0)),$P(PSUREC,U,17)=$TR($P(PSUREC7,U,7),"^","'")
"RTN","PSUDEM1",111,0)
 ;Service Actual/Historical
"RTN","PSUDEM1",112,0)
 S $P(PSUREC,U,18)=$TR($P(PSUREC7,U,8),"^","'")
"RTN","PSUDEM1",113,0)
 ;PLACE "^" AT END OF RECORD
"RTN","PSUDEM1",114,0)
 S $P(PSUREC,U,30)=""
"RTN","PSUDEM1",115,0)
 ;SITE SENDING DATA
"RTN","PSUDEM1",116,0)
 S $P(PSUREC,U,2)=PSUSNDR
"RTN","PSUDEM1",117,0)
 ;RACE
"RTN","PSUDEM1",118,0)
 S PSUREC8=$P($G(VADM(8)),U,2),$P(PSUREC,U,7)=PSUREC8
"RTN","PSUDEM1",119,0)
 ;PRIMARY ELIG CODE
"RTN","PSUDEM1",120,0)
 S PSUREC9=$P($G(VAEL(1)),U,2),$P(PSUREC,U,9)=PSUREC9
"RTN","PSUDEM1",121,0)
 D PRIO
"RTN","PSUDEM1",122,0)
 ;MEANS TEST STATUS
"RTN","PSUDEM1",123,0)
 S PSUREC11=$P($G(VAEL(9)),U,2),$P(PSUREC,U,10)=PSUREC11
"RTN","PSUDEM1",124,0)
 D MISC
"RTN","PSUDEM1",125,0)
 ;FIND PATIENT ICN-VMP
"RTN","PSUDEM1",126,0)
 D ICN
"RTN","PSUDEM1",127,0)
 ;PATIENT CURRENT AGE
"RTN","PSUDEM1",128,0)
 S PSUREC12=$G(VADM(4)),$P(PSUREC,U,6)=PSUREC12
"RTN","PSUDEM1",129,0)
 D ETH
"RTN","PSUDEM1",130,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUDMX",PSUDMDFN)=$G(PSUREC)
"RTN","PSUDEM1",131,0)
 Q
"RTN","PSUDEM1",132,0)
 ;
"RTN","PSUDEM1",133,0)
PRIO ;Pull Enrollment Priority
"RTN","PSUDEM1",134,0)
 ;
"RTN","PSUDEM1",135,0)
 S PSUEC=0
"RTN","PSUDEM1",136,0)
 F  S PSUEC=$O(^DGEN(27.11,"C",PSUDMDFN,PSUEC)) Q:PSUEC=""  D
"RTN","PSUDEM1",137,0)
 .S PSUREC10=$TR($P($G(^DGEN(27.11,PSUEC,0)),U,7),"^","'")
"RTN","PSUDEM1",138,0)
 .I PSUREC10'="" S $P(PSUREC,U,11)=PSUREC10
"RTN","PSUDEM1",139,0)
 Q
"RTN","PSUDEM1",140,0)
 ;
"RTN","PSUDEM1",141,0)
MISC ;Pulls miscellaneous additional info via EN^DIQ1 call
"RTN","PSUDEM1",142,0)
 ;Pulls Date of Death, ICN, Primary Care Provider SSN,
"RTN","PSUDEM1",143,0)
 ;Date patient first provided pharmacy care
"RTN","PSUDEM1",144,0)
 ;
"RTN","PSUDEM1",145,0)
 N PSUDATMP,PSUDDTMP,PSUDTMPA
"RTN","PSUDEM1",146,0)
 ;
"RTN","PSUDEM1",147,0)
 S PSUDTMPA=$$OUTPTPR^SDUTL3(PSUDMDFN)   ;Prov IEN^EXTERNAL VALUE in temp variable
"RTN","PSUDEM1",148,0)
 S PSUDATMP=$P($G(PSUDTMPA),U)       ;Prov IEN
"RTN","PSUDEM1",149,0)
 S $P(PSUREC,U,15)=PSUDATMP
"RTN","PSUDEM1",150,0)
 I '$D(PSUDATMP)!PSUDATMP=0 S PSUDATMP=99999999999
"RTN","PSUDEM1",151,0)
 S $P(PSUREC,U,14)=$$GET1^DIQ(200,PSUDATMP,9,"I")   ;Prov SSN
"RTN","PSUDEM1",152,0)
 S $P(PSUREC,U,4)=$S(PSUDOD:PSUDOD\1,1:"")
"RTN","PSUDEM1",153,0)
 Q
"RTN","PSUDEM1",154,0)
 ;
"RTN","PSUDEM1",155,0)
ICN ;Find patient ICN
"RTN","PSUDEM1",156,0)
 ;VMP - OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUDEM1",157,0)
 ;
"RTN","PSUDEM1",158,0)
 N PSUICN,PSUICN1
"RTN","PSUDEM1",159,0)
 S PSUICN=$$GETICN^MPIF001(PSUDMDFN) D
"RTN","PSUDEM1",160,0)
 .I PSUICN'[-1 D
"RTN","PSUDEM1",161,0)
 ..S $P(PSUREC,U,13)=PSUICN    ;ICN
"RTN","PSUDEM1",162,0)
 Q
"RTN","PSUDEM1",163,0)
 ;
"RTN","PSUDEM1",164,0)
ETH ;Ethnicity and multiple race entries
"RTN","PSUDEM1",165,0)
 ;
"RTN","PSUDEM1",166,0)
 S PSUREC14=$P($G(VADM(11,1)),U,2),$P(PSUREC,U,19)=PSUREC14
"RTN","PSUDEM1",167,0)
 ;
"RTN","PSUDEM1",168,0)
 S PSURCE=0,C=20,$P(PSUREC,U,C)=""
"RTN","PSUDEM1",169,0)
 F  S PSURCE=$O(VADM(12,PSURCE)) Q:PSURCE=""  D       ;Race multiple
"RTN","PSUDEM1",170,0)
 .S PSURAC=$P($G(VADM(12,PSURCE)),U,2),$P(PSUREC,U,C)=PSURAC,C=C+1
"RTN","PSUDEM1",171,0)
 Q
"RTN","PSUDEM1",172,0)
 ;
"RTN","PSUDEM1",173,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM1",174,0)
 ;
"RTN","PSUDEM1",175,0)
 S PSUAB=0,PSUPL=1
"RTN","PSUDEM1",176,0)
 F  S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUDMX",PSUAB)) Q:PSUAB=""  D
"RTN","PSUDEM1",177,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSUDM",PSUPL)=^XTMP("PSU_"_PSUJOB,"PSUDMX",PSUAB)  ;Global numerical order
"RTN","PSUDEM1",178,0)
 .S PSUPL=PSUPL+1
"RTN","PSUDEM1",179,0)
 ;
"RTN","PSUDEM1",180,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM1",181,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM1",182,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM1",183,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM1",184,0)
 F PSULC=1:1 S X=$G(^XTMP("PSU_"_PSUJOB,"PSUDM",PSULC)) Q:X=""  D
"RTN","PSUDEM1",185,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM1",186,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM1",187,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM1",188,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM1",189,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM1",190,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM1",191,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM1",192,0)
 ;
"RTN","PSUDEM1",193,0)
 ;   Count Lines sent
"RTN","PSUDEM1",194,0)
 S PSUTLC=0
"RTN","PSUDEM1",195,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM1",196,0)
 ;
"RTN","PSUDEM1",197,0)
 F PSUM=1:1:PSUMC D PDMAIL^PSUDEM5
"RTN","PSUDEM1",198,0)
 D CONF
"RTN","PSUDEM1",199,0)
 Q
"RTN","PSUDEM1",200,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM1",201,0)
 ;
"RTN","PSUDEM1",202,0)
 N PSUDIVIS
"RTN","PSUDEM1",203,0)
 D INST
"RTN","PSUDEM1",204,0)
 S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM1",205,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM1",206,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,7,"M")=PSUMC
"RTN","PSUDEM1",207,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,7,"L")=PSUTLC
"RTN","PSUDEM1",208,0)
 Q
"RTN","PSUDEM1",209,0)
REC ;EN If "^" is contained in any record, replace it with "'"
"RTN","PSUDEM1",210,0)
 ;
"RTN","PSUDEM1",211,0)
 I PSUREC["^" S PSUREC=$TR(PSUREC,"^","'")
"RTN","PSUDEM1",212,0)
 Q
"RTN","PSUDEM2")
0^30^B20153453
"RTN","PSUDEM2",1,0)
PSUDEM2 ;BIR/DAM - Outpatient Visits Extract ;20 DEC 2001
"RTN","PSUDEM2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM2",3,0)
 ;
"RTN","PSUDEM2",4,0)
 ;DBIA's
"RTN","PSUDEM2",5,0)
 ; Reference to file 2            supported by DBIA 10035
"RTN","PSUDEM2",6,0)
 ; Reference to file 9000010.07   supported by DBIA 3094
"RTN","PSUDEM2",7,0)
 ; Reference to file 9000010      supported by DBIA 3512
"RTN","PSUDEM2",8,0)
 ; Reference to file 4.3          supported by DBIA 2496
"RTN","PSUDEM2",9,0)
 ; Reference to file 80           supported by DBIA 10082
"RTN","PSUDEM2",10,0)
 ; Reference to file 9000010.18   supported by DBIA 3560
"RTN","PSUDEM2",11,0)
 ; Reference to file 81           supported by DBIA 2815
"RTN","PSUDEM2",12,0)
EN ;EN Called from PSUCP
"RTN","PSUDEM2",13,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUOPV"),^XTMP("PSU_"_PSUJOB,"PSUTMP")
"RTN","PSUDEM2",14,0)
 K NONE
"RTN","PSUDEM2",15,0)
 NEW CPTDA,CPTNM,ICD9DA,ICD9NM,PSUICN,PSUSSN,PSUSUB,PSUTEDT
"RTN","PSUDEM2",16,0)
 NEW PSUVSTDT,PSUX,PSUY,PTSTAT,SEG,VCPTDA,XX,J
"RTN","PSUDEM2",17,0)
 D DAT1
"RTN","PSUDEM2",18,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUTMP")) D NODATA
"RTN","PSUDEM2",19,0)
 D XMD
"RTN","PSUDEM2",20,0)
EX K ^XTMP("PSU_"_PSUJOB,"PSUPDFLAG")
"RTN","PSUDEM2",21,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUOPV")
"RTN","PSUDEM2",22,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUXMD")
"RTN","PSUDEM2",23,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTMP")
"RTN","PSUDEM2",24,0)
 Q
"RTN","PSUDEM2",25,0)
 ;
"RTN","PSUDEM2",26,0)
 ;
"RTN","PSUDEM2",27,0)
DAT1 ;Find visits from V POV file that fall within the date range
"RTN","PSUDEM2",28,0)
 S PSUTEDT=PSUEDT
"RTN","PSUDEM2",29,0)
 S PSUDT=PSUSDT-1,PSUX=9999999-PSUDT,PSUY=9999999-PSUEDT N PSUEDT
"RTN","PSUDEM2",30,0)
 S PSUY=PSUSDT-.0001
"RTN","PSUDEM2",31,0)
 F  S PSUY=$O(^AUPNVSIT("B",PSUY)) Q:PSUY'>0  Q:((PSUY\1)>PSUTEDT)  D
"RTN","PSUDEM2",32,0)
 . S PSUVIEN=0 F  S PSUVIEN=$O(^AUPNVSIT("B",PSUY,PSUVIEN)) Q:$G(PSUVIEN)'>0  D
"RTN","PSUDEM2",33,0)
 .. S PSUPT=$$VALI^PSUTL(9000010,PSUVIEN,.05)
"RTN","PSUDEM2",34,0)
 .. D DAT2
"RTN","PSUDEM2",35,0)
 Q
"RTN","PSUDEM2",36,0)
DAT2 ;
"RTN","PSUDEM2",37,0)
 S PSUPOV=0 F  S PSUPOV=$O(^AUPNVPOV("AD",PSUVIEN,PSUPOV)) Q:PSUPOV'>0  D
"RTN","PSUDEM2",38,0)
 .N PSUVIEN
"RTN","PSUDEM2",39,0)
 .S PSUVIEN=$P($G(^AUPNVPOV(PSUPOV,0)),U,3)
"RTN","PSUDEM2",40,0)
 .Q:PSUVIEN=""
"RTN","PSUDEM2",41,0)
 .Q:$D(^XTMP("PSU"_PSUJOB,"PSUOPV",PSUVIEN))  ; quit if visit psuvien already stored
"RTN","PSUDEM2",42,0)
 . D POVS
"RTN","PSUDEM2",43,0)
 .S PSUVSTDT=$P($G(^AUPNVSIT(PSUVIEN,0)),U)\1
"RTN","PSUDEM2",44,0)
 .S PSUSSN=$P(^DPT(PSUPT,0),U,9)
"RTN","PSUDEM2",45,0)
 .S PSUICN=$$GETICN^MPIF001(PSUPT)
"RTN","PSUDEM2",46,0)
 .I PSUICN[-1 S PSUICN=""
"RTN","PSUDEM2",47,0)
 .S PTSTAT=$P(^AUPNVSIT(PSUVIEN,150),U,2),PTSTAT=$S(+PTSTAT:"I",1:"O")
"RTN","PSUDEM2",48,0)
 . D SET
"RTN","PSUDEM2",49,0)
 Q
"RTN","PSUDEM2",50,0)
POVS ;severl POVs can have same visit, work all when the first is found
"RTN","PSUDEM2",51,0)
 N PSUPOV
"RTN","PSUDEM2",52,0)
 S PSUPOV=0 F  S PSUPOV=$O(^AUPNVPOV("AD",PSUVIEN,PSUPOV)) Q:PSUPOV'>0  D
"RTN","PSUDEM2",53,0)
 . K ALLICD9,ALLCPT
"RTN","PSUDEM2",54,0)
 .;LOOP CPTs linked by visit 
"RTN","PSUDEM2",55,0)
 . S VCPTDA=0 F  S VCPTDA=$O(^AUPNVCPT("AD",PSUVIEN,VCPTDA)) Q:VCPTDA'>0  D
"RTN","PSUDEM2",56,0)
 .. ; get/gather cpts
"RTN","PSUDEM2",57,0)
 ..S CPTDA=$P($G(^AUPNVCPT(VCPTDA,0)),U),CPTNM=$P($G(^ICPT(CPTDA,0)),U) S:$L(CPTNM) ALLCPT(CPTNM)=""
"RTN","PSUDEM2",58,0)
 .. ;get/gather icd9s 
"RTN","PSUDEM2",59,0)
 ..S ICD9DA=$P($G(^AUPNVCPT(VCPTDA,0)),U,5) I ICD9DA S ICD9NM=$P($G(^ICD9(ICD9DA,0)),U) S:$L(ICD9NM) ALLICD9(ICD9NM)=""
"RTN","PSUDEM2",60,0)
 . ;get orig ICD9
"RTN","PSUDEM2",61,0)
 .S ICD9DA=$P($G(^AUPNVPOV(PSUPOV,0)),U) I ICD9DA S ICD9NM=$P($G(^ICD9(ICD9DA,0)),U) S:$L(ICD9NM) ALLICD9(ICD9NM)=""
"RTN","PSUDEM2",62,0)
 Q
"RTN","PSUDEM2",63,0)
SET ; Set segment
"RTN","PSUDEM2",64,0)
 I '$D(ALLICD9),'$D(ALLCPT) Q  ;insure visit has either CPT or ICD9
"RTN","PSUDEM2",65,0)
 ;assemble elements and set
"RTN","PSUDEM2",66,0)
 S SEG=U_PSUSNDR_U_PTSTAT_U_PSUVSTDT_U_PSUSSN_U_PSUICN_U
"RTN","PSUDEM2",67,0)
 I $D(ALLICD9) S ICD9NM="" F I=7:1:16 S ICD9NM=$O(ALLICD9(ICD9NM)) Q:ICD9NM=""  S $P(SEG,U,I)=ICD9NM
"RTN","PSUDEM2",68,0)
 I $D(ALLCPT) S CPTNM="" F J=17:1:26 S CPTNM=$O(ALLCPT(CPTNM)) Q:CPTNM=""  S $P(SEG,U,J)=CPTNM
"RTN","PSUDEM2",69,0)
 S $P(SEG,U,27)=""
"RTN","PSUDEM2",70,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUVIEN)=SEG
"RTN","PSUDEM2",71,0)
 Q
"RTN","PSUDEM2",72,0)
 ;
"RTN","PSUDEM2",73,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM2",74,0)
 S PSUAB=0
"RTN","PSUDEM2",75,0)
 F PSUPL=1:1 S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUAB)) Q:PSUAB'>0  S XX=^(PSUAB) D
"RTN","PSUDEM2",76,0)
 . S ^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUPL)=XX
"RTN","PSUDEM2",77,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM2",78,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM2",79,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM2",80,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM2",81,0)
 F PSULC=1:1 S X=$G(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSULC)) Q:X=""  D
"RTN","PSUDEM2",82,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM2",83,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM2",84,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM2",85,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM2",86,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM2",87,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM2",88,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM2",89,0)
 ;
"RTN","PSUDEM2",90,0)
TLC ;   Count Lines sent
"RTN","PSUDEM2",91,0)
 S PSUTLC=0
"RTN","PSUDEM2",92,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM2",93,0)
 ;
"RTN","PSUDEM2",94,0)
 F PSUM=1:1:PSUMC D OPV^PSUDEM5
"RTN","PSUDEM2",95,0)
 D CONF
"RTN","PSUDEM2",96,0)
 Q
"RTN","PSUDEM2",97,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM2",98,0)
 ;
"RTN","PSUDEM2",99,0)
 I $G(NONE) S PSUTLC=0
"RTN","PSUDEM2",100,0)
 N PSUDIVIS
"RTN","PSUDEM2",101,0)
 S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM2",102,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM2",103,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,8,"M")=PSUMC
"RTN","PSUDEM2",104,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,8,"L")=PSUTLC
"RTN","PSUDEM2",105,0)
 Q
"RTN","PSUDEM2",106,0)
 ;
"RTN","PSUDEM2",107,0)
NODATA ;Generate a 'No data' message if there is no data in the extract
"RTN","PSUDEM2",108,0)
 ;
"RTN","PSUDEM2",109,0)
 S NONE=1
"RTN","PSUDEM2",110,0)
 M PSUXMYH=PSUXMYS1
"RTN","PSUDEM2",111,0)
 S PSUM=1
"RTN","PSUDEM2",112,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,1)="No data to report"
"RTN","PSUDEM2",113,0)
 Q
"RTN","PSUDEM2",114,0)
REC ;EN If "^" is contained in any record, replace it with "'"
"RTN","PSUDEM2",115,0)
 ;
"RTN","PSUDEM2",116,0)
 I PSUREC["^" S PSUREC=$TR(PSUREC,"^","'")
"RTN","PSUDEM2",117,0)
 Q
"RTN","PSUDEM3")
0^32^B4556781
"RTN","PSUDEM3",1,0)
PSUDEM3 ;BIR/DAM - ICD9 codes for Outpatient Encounter Extract ; 20 DEC 2001
"RTN","PSUDEM3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM3",3,0)
 ;
"RTN","PSUDEM3",4,0)
 ;DBIA's
"RTN","PSUDEM3",5,0)
 ; Reference to file 80         supported by DBIA 10082
"RTN","PSUDEM3",6,0)
 ; Reference to file 9000010.18 supported by DBIA 3560
"RTN","PSUDEM3",7,0)
 ;
"RTN","PSUDEM3",8,0)
EN ;EN   Called from PSUDEM2
"RTN","PSUDEM3",9,0)
 D ICD
"RTN","PSUDEM3",10,0)
 D CLEAN
"RTN","PSUDEM3",11,0)
 Q
"RTN","PSUDEM3",12,0)
 ;
"RTN","PSUDEM3",13,0)
ICD ;Find all ICD9 pointers  associated with Patient pointer
"RTN","PSUDEM3",14,0)
 ;
"RTN","PSUDEM3",15,0)
 N PSUICD
"RTN","PSUDEM3",16,0)
 S PSUC1=0
"RTN","PSUDEM3",17,0)
 F  S PSUC1=$O(^AUPNVCPT("C",PSUPT,PSUC1)) Q:PSUC1=""  D    ;V CPT IEN
"RTN","PSUDEM3",18,0)
 .I $P($G(^AUPNVCPT(PSUC1,0)),U,3)=$G(PSUVIEN) D  ;V CPT IEN=Visit IEN
"RTN","PSUDEM3",19,0)
 ..S PSUICD=$P($G(^AUPNVCPT(PSUC1,0)),U,5) D ICD1           ;ICD9 Ptr
"RTN","PSUDEM3",20,0)
 ..S PSUCPT=$P($G(^AUPNVCPT(PSUC1,0)),U,1) D EN^PSUDEM6  ;grab CPT codes
"RTN","PSUDEM3",21,0)
 I '$D(^AUPNVCPT("C",PSUPT)) S PSUCPT="" D EN^PSUDEM6
"RTN","PSUDEM3",22,0)
 D FIN
"RTN","PSUDEM3",23,0)
 Q
"RTN","PSUDEM3",24,0)
 ;
"RTN","PSUDEM3",25,0)
ICD1 ;Find ICD9 codes from pointers and place in an array 
"RTN","PSUDEM3",26,0)
 ;
"RTN","PSUDEM3",27,0)
 ;
"RTN","PSUDEM3",28,0)
 N PSUID2
"RTN","PSUDEM3",29,0)
 I PSUICD S PSUID2=$P($G(^ICD9(PSUICD,0)),U) D
"RTN","PSUDEM3",30,0)
 .I $D(PSUID2) S ^XTMP("PSU_"_PSUJOB,"PSUTMP1",PSUVIEN,PSUID2)=""  ;ICD9 codes set into array 
"RTN","PSUDEM3",31,0)
 ;
"RTN","PSUDEM3",32,0)
 Q
"RTN","PSUDEM3",33,0)
 ;
"RTN","PSUDEM3",34,0)
FIN ;$O through array, and set codes into the Outpatient Visit
"RTN","PSUDEM3",35,0)
 ;Encounter global, ^XTMP("PSU_"_PSUJOB,"PSUOPV"
"RTN","PSUDEM3",36,0)
 ;
"RTN","PSUDEM3",37,0)
 ;
"RTN","PSUDEM3",38,0)
 S PSUIDF=0
"RTN","PSUDEM3",39,0)
 S I=8
"RTN","PSUDEM3",40,0)
 F  S PSUIDF=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP1",PSUVIEN,PSUIDF)) Q:'PSUIDF  Q:I=17  D
"RTN","PSUDEM3",41,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN),U,I)=PSUIDF
"RTN","PSUDEM3",42,0)
 .S I=I+1
"RTN","PSUDEM3",43,0)
 ;
"RTN","PSUDEM3",44,0)
 F N=8:1:16 I '$P($G(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN)),U,N) D
"RTN","PSUDEM3",45,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN),U,N)=""
"RTN","PSUDEM3",46,0)
 Q
"RTN","PSUDEM3",47,0)
 ;
"RTN","PSUDEM3",48,0)
CLEAN ;Delete all ^XTMP("PSU_"_PSUJOB,"PSUOPV" entries that do not have associated
"RTN","PSUDEM3",49,0)
 ;ICD9 or CPT codes.
"RTN","PSUDEM3",50,0)
 ;
"RTN","PSUDEM3",51,0)
 S PSUCL=0
"RTN","PSUDEM3",52,0)
 F  S PSUCL=$O(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUCL)) Q:'PSUCL  D
"RTN","PSUDEM3",53,0)
 .I $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUCL),U,7)="" D
"RTN","PSUDEM3",54,0)
 ..I $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUCL),U,17)="" K ^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUCL)
"RTN","PSUDEM3",55,0)
 Q
"RTN","PSUDEM4")
0^33^B51977123
"RTN","PSUDEM4",1,0)
PSUDEM4 ;BIR/DAM - Provider Extract ; 20 DEC 2001
"RTN","PSUDEM4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM4",3,0)
 ;
"RTN","PSUDEM4",4,0)
 ;DBIA'S
"RTN","PSUDEM4",5,0)
 ; Reference to file 200    supported by DBIA 10060
"RTN","PSUDEM4",6,0)
 ; Reference to file 7      supported by DBIA 2495
"RTN","PSUDEM4",7,0)
 ; Reference to file 49     supported by DBIA 432
"RTN","PSUDEM4",8,0)
 ; Reference to file 8932.1 supported by DBIA 2091
"RTN","PSUDEM4",9,0)
 ; Reference to file 4.2    supported by DBIA 2496
"RTN","PSUDEM4",10,0)
 ;
"RTN","PSUDEM4",11,0)
EN ;Entry point for gathering all provider information from IV, UD, Rx,
"RTN","PSUDEM4",12,0)
 ;and PD modules.
"RTN","PSUDEM4",13,0)
 ;
"RTN","PSUDEM4",14,0)
 N PSUREC
"RTN","PSUDEM4",15,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUFLAG")=""
"RTN","PSUDEM4",16,0)
 ;
"RTN","PSUDEM4",17,0)
 D PULL^PSUCP
"RTN","PSUDEM4",18,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUDEM4",19,0)
 ;
"RTN","PSUDEM4",20,0)
 I '$D(PSUMOD(7)) D EN^PSUDEM1
"RTN","PSUDEM4",21,0)
 I '$D(PSUMOD(1)) D EN^PSUV0
"RTN","PSUDEM4",22,0)
 I '$D(PSUMOD(2)) D EN^PSUUD0
"RTN","PSUDEM4",23,0)
 I '$D(PSUMOD(4)) D
"RTN","PSUDEM4",24,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUOPFLG")=""   ;Set flag
"RTN","PSUDEM4",25,0)
 .D EN^PSUOP0
"RTN","PSUDEM4",26,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUPROM")=^XTMP("PSU_"_PSUJOB,"PSUPROV")
"RTN","PSUDEM4",27,0)
 ;
"RTN","PSUDEM4",28,0)
 D XMD
"RTN","PSUDEM4",29,0)
 D EN^PSUSUM1      ;compose provider summary report and mail it.
"RTN","PSUDEM4",30,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG")
"RTN","PSUDEM4",31,0)
 Q
"RTN","PSUDEM4",32,0)
 ;
"RTN","PSUDEM4",33,0)
PDSSN ;EN  Called from PSUDEM1
"RTN","PSUDEM4",34,0)
 ;Find provider SSN and IEN present in the patient demographics
"RTN","PSUDEM4",35,0)
 ;extract.  Note that this is the primary care provider.
"RTN","PSUDEM4",36,0)
 ;
"RTN","PSUDEM4",37,0)
 S PSUT=0
"RTN","PSUDEM4",38,0)
 F  S PSUT=$O(^XTMP("PSU_"_PSUJOB,"PSUDM",PSUT)) Q:'PSUT  D
"RTN","PSUDEM4",39,0)
 .N PSUIEN,PSUSSN1
"RTN","PSUDEM4",40,0)
 .S PSUIEN=$P($G(^XTMP("PSU_"_PSUJOB,"PSUDM",PSUT)),U,15) I 'PSUIEN S PSUIEN="UNK"
"RTN","PSUDEM4",41,0)
 .D FAC
"RTN","PSUDEM4",42,0)
 .D PNAM
"RTN","PSUDEM4",43,0)
 .S PSUSSN1=$P($G(^XTMP("PSU_"_PSUJOB,"PSUDM",PSUT)),U,14) I 'PSUSSN1 S PSUSSN1=""
"RTN","PSUDEM4",44,0)
 .S PSUREC=PSUSSN1 D REC^PSUDEM2
"RTN","PSUDEM4",45,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,3)=PSUREC              ;Dem Prov SSN
"RTN","PSUDEM4",46,0)
 .S PSUREC=PSUIEN D REC^PSUDEM2
"RTN","PSUDEM4",47,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,4)=PSUREC D              ;Dem Prov ICN
"RTN","PSUDEM4",48,0)
 ..I PSUREC="UNK" K ^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN)
"RTN","PSUDEM4",49,0)
 Q
"RTN","PSUDEM4",50,0)
 ;
"RTN","PSUDEM4",51,0)
UDSSN ;EN  Called from PROV^PSUUD1. Find provider SSN and IEN in the unit 
"RTN","PSUDEM4",52,0)
 ;dose extract
"RTN","PSUDEM4",53,0)
 ;
"RTN","PSUDEM4",54,0)
 S PSUIEN=0,PSUVSSN1=0
"RTN","PSUDEM4",55,0)
 F  S PSUVSSN1=$O(^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUVSSN1)) Q:PSUVSSN1=""  D
"RTN","PSUDEM4",56,0)
 .F  S PSUIEN=$O(^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUVSSN1,PSUIEN)) Q:PSUIEN=""  D
"RTN","PSUDEM4",57,0)
 ..D FAC
"RTN","PSUDEM4",58,0)
 ..S PSUREC=PSUVSSN1 D REC^PSUDEM1 D
"RTN","PSUDEM4",59,0)
 ...I PSUREC=999999999 S PSUREC=""
"RTN","PSUDEM4",60,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,3)=PSUREC   ;UD Prov SSN
"RTN","PSUDEM4",61,0)
 ..S PSUREC=PSUIEN D REC^PSUDEM2
"RTN","PSUDEM4",62,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,4)=PSUREC    ;UD Prov IEN
"RTN","PSUDEM4",63,0)
 ..D PNAM
"RTN","PSUDEM4",64,0)
 Q
"RTN","PSUDEM4",65,0)
 ;
"RTN","PSUDEM4",66,0)
IVSSN ;EN Called from PSUIV1. Gives Provider within date range of extract
"RTN","PSUDEM4",67,0)
 ;
"RTN","PSUDEM4",68,0)
 D UDSSN
"RTN","PSUDEM4",69,0)
 Q
"RTN","PSUDEM4",70,0)
 ;
"RTN","PSUDEM4",71,0)
OPSSN ;EN Called from PSUOP0.  Gives prescription Provider
"RTN","PSUDEM4",72,0)
 ;
"RTN","PSUDEM4",73,0)
 D UDSSN
"RTN","PSUDEM4",74,0)
 Q 
"RTN","PSUDEM4",75,0)
FAC ;Find provider station number.  Places that info in each record.
"RTN","PSUDEM4",76,0)
 ;
"RTN","PSUDEM4",77,0)
 ;D INST^PSUDEM1
"RTN","PSUDEM4",78,0)
 S $P(^TMP("PSUPROV",$J),U,2)=PSUSNDR
"RTN","PSUDEM4",79,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN)=^TMP("PSUPROV",$J)
"RTN","PSUDEM4",80,0)
 Q
"RTN","PSUDEM4",81,0)
 ;
"RTN","PSUDEM4",82,0)
PNAM ;Find the provider's name.
"RTN","PSUDEM4",83,0)
 ;
"RTN","PSUDEM4",84,0)
 N PSUCLP,PSUSS,PSUSP
"RTN","PSUDEM4",85,0)
 ;
"RTN","PSUDEM4",86,0)
 ;Find provider name
"RTN","PSUDEM4",87,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,9)=$$GET1^DIQ(200,PSUIEN,.01,"I")
"RTN","PSUDEM4",88,0)
 ;
"RTN","PSUDEM4",89,0)
 S PSUCLP=$$GET1^DIQ(200,PSUIEN,53.5,"I") D CLASS  ;Provider pointer
"RTN","PSUDEM4",90,0)
 S PSUSS=$$GET1^DIQ(200,PSUIEN,29,"I") D SS        ;Service Sctn ptr
"RTN","PSUDEM4",91,0)
 ;
"RTN","PSUDEM4",92,0)
 S PSUD1=999
"RTN","PSUDEM4",93,0)
 S PSUD1=$O(^VA(200,PSUIEN,"USC1",PSUD1),-1)  ;Find last subscript
"RTN","PSUDEM4",94,0)
 I PSUD1'="" D
"RTN","PSUDEM4",95,0)
 .S PSUSP=$$GET1^DIQ(200.05,PSUD1_","_PSUIEN_",",.01,"I")  ;Specialty
"RTN","PSUDEM4",96,0)
 .D SPEC
"RTN","PSUDEM4",97,0)
 I PSUD1="" D
"RTN","PSUDEM4",98,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=""
"RTN","PSUDEM4",99,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=""
"RTN","PSUDEM4",100,0)
 Q
"RTN","PSUDEM4",101,0)
 ;
"RTN","PSUDEM4",102,0)
CLASS ;Find provider class
"RTN","PSUDEM4",103,0)
 ;
"RTN","PSUDEM4",104,0)
 I '$D(PSUCLP) S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,5)=""
"RTN","PSUDEM4",105,0)
 I PSUCLP="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,5)=""
"RTN","PSUDEM4",106,0)
 I PSUCLP'="" D
"RTN","PSUDEM4",107,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,5)=$P($G(^DIC(7,PSUCLP,0)),U,2)  ;Prov class
"RTN","PSUDEM4",108,0)
 Q
"RTN","PSUDEM4",109,0)
 ;
"RTN","PSUDEM4",110,0)
SS ;Find Provider Service/Section
"RTN","PSUDEM4",111,0)
 ;
"RTN","PSUDEM4",112,0)
 N PSUTMP
"RTN","PSUDEM4",113,0)
 ;
"RTN","PSUDEM4",114,0)
 I PSUSS="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,6)=""
"RTN","PSUDEM4",115,0)
 I PSUSS'="" D
"RTN","PSUDEM4",116,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["AMBU" PSUTMP="AMB"
"RTN","PSUDEM4",117,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["ANESTH" PSUTMP="ANES"
"RTN","PSUDEM4",118,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["CARDIO" PSUTMP="CV"
"RTN","PSUDEM4",119,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PHARM" PSUTMP="CPHAR"
"RTN","PSUDEM4",120,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["DENT" PSUTMP="DDS"
"RTN","PSUDEM4",121,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["MEDIC" PSUTMP="MED"
"RTN","PSUDEM4",122,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["INTERMED" PSUTMP="IM"
"RTN","PSUDEM4",123,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["NUCLEAR" PSUTMP="NUM"
"RTN","PSUDEM4",124,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["NURSING" PSUTMP="RN"
"RTN","PSUDEM4",125,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["ORTHOPED" PSUTMP="ORTHO"
"RTN","PSUDEM4",126,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PSYCHIA" PSUTMP="PSY"
"RTN","PSUDEM4",127,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["MENTAL" PSUTMP="PSY"
"RTN","PSUDEM4",128,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PRIMARY" PSUTMP="AMB"
"RTN","PSUDEM4",129,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["CBOC" PSUTMP="AMB"
"RTN","PSUDEM4",130,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["OPHTH" PSUTMP="OPH"
"RTN","PSUDEM4",131,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PULM" PSUTMP="PUL"
"RTN","PSUDEM4",132,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["RADIOL" PSUTMP="RAD"
"RTN","PSUDEM4",133,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["SURG" PSUTMP="SUR"
"RTN","PSUDEM4",134,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["UROLOG" PSUTMP="U"
"RTN","PSUDEM4",135,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["NEUROL" PSUTMP="NEUR"
"RTN","PSUDEM4",136,0)
 .S PSUREC=$G(PSUTMP) D REC^PSUDEM2
"RTN","PSUDEM4",137,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,6)=$G(PSUREC)       ;Prov Serv/Sec
"RTN","PSUDEM4",138,0)
 Q
"RTN","PSUDEM4",139,0)
 ;
"RTN","PSUDEM4",140,0)
SPEC ;Find provider specialty and sub-specialty
"RTN","PSUDEM4",141,0)
 ;
"RTN","PSUDEM4",142,0)
 I PSUSP="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=""
"RTN","PSUDEM4",143,0)
 I PSUSP="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=""
"RTN","PSUDEM4",144,0)
 I PSUSP'="" D
"RTN","PSUDEM4",145,0)
 .S PSUREC=$P($G(^USC(8932.1,PSUSP,0)),U,2) D REC^PSUDEM2
"RTN","PSUDEM4",146,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=PSUREC D     ;Speclty
"RTN","PSUDEM4",147,0)
 ..I $P(^USC(8932.1,PSUSP,0),U,2)="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=""
"RTN","PSUDEM4",148,0)
 .S PSUREC=$P($G(^USC(8932.1,PSUSP,0)),U,3) D REC^PSUDEM2
"RTN","PSUDEM4",149,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=PSUREC D      ;Subspecl
"RTN","PSUDEM4",150,0)
 ..I $P(^USC(8932.1,PSUSP,0),U,3)="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=""
"RTN","PSUDEM4",151,0)
 ;
"RTN","PSUDEM4",152,0)
 Q
"RTN","PSUDEM4",153,0)
 ;
"RTN","PSUDEM4",154,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM4",155,0)
 ;
"RTN","PSUDEM4",156,0)
 S PSUAA=0
"RTN","PSUDEM4",157,0)
 F  S PSUAA=$O(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAA)) Q:PSUAA=""  D
"RTN","PSUDEM4",158,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAA),U,9)=""      ;Remove provider name
"RTN","PSUDEM4",159,0)
 ;
"RTN","PSUDEM4",160,0)
 ;Remove space in piece 8
"RTN","PSUDEM4",161,0)
 S PSUAB=0
"RTN","PSUDEM4",162,0)
 F  S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAB)) Q:PSUAB=""  D
"RTN","PSUDEM4",163,0)
 .I $P(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAB),U,8)=" " D
"RTN","PSUDEM4",164,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAB),U,8)=""
"RTN","PSUDEM4",165,0)
 ;
"RTN","PSUDEM4",166,0)
 S PSUAC=0,PSUPL=1
"RTN","PSUDEM4",167,0)
 F  S PSUAC=$O(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAC)) Q:PSUAC=""  D
"RTN","PSUDEM4",168,0)
 .M ^TMP("PSUPROM",$J,PSUPL)=^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAC)  ;numerical order
"RTN","PSUDEM4",169,0)
 .S PSUPL=PSUPL+1
"RTN","PSUDEM4",170,0)
 ;
"RTN","PSUDEM4",171,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM4",172,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM4",173,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM4",174,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM4",175,0)
 F PSULC=1:1 S X=$G(^TMP("PSUPROM",$J,PSULC)) Q:X=""  D
"RTN","PSUDEM4",176,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM4",177,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM4",178,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM4",179,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM4",180,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM4",181,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM4",182,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM4",183,0)
 ;
"RTN","PSUDEM4",184,0)
 F PSUM=1:1:PSUMC D PROV^PSUDEM5
"RTN","PSUDEM4",185,0)
 D CONF
"RTN","PSUDEM4",186,0)
 Q
"RTN","PSUDEM4",187,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM4",188,0)
 ;
"RTN","PSUDEM4",189,0)
 ;   Count Lines sent
"RTN","PSUDEM4",190,0)
 S PSUTLC=0
"RTN","PSUDEM4",191,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM4",192,0)
 ;
"RTN","PSUDEM4",193,0)
 D INST^PSUDEM1
"RTN","PSUDEM4",194,0)
 N PSUDIVIS
"RTN","PSUDEM4",195,0)
 S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM4",196,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM4",197,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,10,"M")=PSUMC
"RTN","PSUDEM4",198,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,10,"L")=PSUTLC
"RTN","PSUDEM4",199,0)
 Q
"RTN","PSUDEM5")
0^34^B27210554
"RTN","PSUDEM5",1,0)
PSUDEM5 ;BIR/DAM - Patient Demographics Mail Messages ; 20 DEC 2001
"RTN","PSUDEM5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM5",3,0)
 ;
"RTN","PSUDEM5",4,0)
PDMAIL ;EN  Mail patient demographics message
"RTN","PSUDEM5",5,0)
 ;
"RTN","PSUDEM5",6,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;don't send a mailman message if flag is set
"RTN","PSUDEM5",7,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUMONTH")) D AUTO  ;Find month if auto extract
"RTN","PSUDEM5",8,0)
 ;
"RTN","PSUDEM5",9,0)
 D VAR
"RTN","PSUDEM5",10,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM5",11,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM5",12,0)
 S PSUMON=$P(^XTMP("PSU_"_PSUJOB,"PSUMONTH"),U,1)
"RTN","PSUDEM5",13,0)
 I $G(^XTMP("PSU_"_PSUJOB,"REXMIT"))="YES" S PSUMON=PSURMON
"RTN","PSUDEM5",14,0)
 S XMDUZ=DUZ
"RTN","PSUDEM5",15,0)
 S XMSUB="V. 4.0 PBMPD"_" "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUST_" "_PSUSTNM
"RTN","PSUDEM5",16,0)
 S XMCHAN=1
"RTN","PSUDEM5",17,0)
 ;S PSUPBMG=^XTMP("PSU_"_PSUJOB,"PSUPBMG")
"RTN","PSUDEM5",18,0)
 S XMTEXT="^XTMP(""PSU_""_PSUJOB,""PSUXMD"",PSUM,"
"RTN","PSUDEM5",19,0)
 I PSUMASF!PSUDUZ!PSUPBMG D
"RTN","PSUDEM5",20,0)
 .I 'PSUSMRY M XMY=PSUXMYH D   ;Detailed message to Hines and self
"RTN","PSUDEM5",21,0)
 .D ^XMD
"RTN","PSUDEM5",22,0)
 Q
"RTN","PSUDEM5",23,0)
 ;
"RTN","PSUDEM5",24,0)
AUTO ;Find month if auto extract is run
"RTN","PSUDEM5",25,0)
 ;
"RTN","PSUDEM5",26,0)
 D NOW^%DTC S PSUMON=$S('$D(DT):X,1:DT),PSUMON=$E(PSUMON,1,5)-1 ;Prior mt
"RTN","PSUDEM5",27,0)
 I $E(PSUMON,4,5)="00" S PSUMON=($E(PSUMON,1,3)-1)_"12"
"RTN","PSUDEM5",28,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUMONTH")=PSUMON
"RTN","PSUDEM5",29,0)
 Q
"RTN","PSUDEM5",30,0)
 ;
"RTN","PSUDEM5",31,0)
VAR ;Get variables common to all extract messages
"RTN","PSUDEM5",32,0)
 ;
"RTN","PSUDEM5",33,0)
 N PSUSTNM,PSUST,PSUMON
"RTN","PSUDEM5",34,0)
 D INST^PSUDEM1
"RTN","PSUDEM5",35,0)
 ;
"RTN","PSUDEM5",36,0)
 Q
"RTN","PSUDEM5",37,0)
 ;
"RTN","PSUDEM5",38,0)
PROV ;EN  Mail Provider message
"RTN","PSUDEM5",39,0)
 ;
"RTN","PSUDEM5",40,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;don't send a mailman message if flag is set
"RTN","PSUDEM5",41,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUMONTH")) D AUTO  ;Find month if auto
"RTN","PSUDEM5",42,0)
 D VAR
"RTN","PSUDEM5",43,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM5",44,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM5",45,0)
 S PSUMON=$P(^XTMP("PSU_"_PSUJOB,"PSUMONTH"),U,1)
"RTN","PSUDEM5",46,0)
 ;
"RTN","PSUDEM5",47,0)
 S XMCHAN=1
"RTN","PSUDEM5",48,0)
 S XMDUZ=DUZ
"RTN","PSUDEM5",49,0)
 S XMSUB="V. 4.0 PBMPRO"_" "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUST_" "_PSUSTNM
"RTN","PSUDEM5",50,0)
 S XMTEXT="^XTMP(""PSU_""_PSUJOB,""PSUXMD"",PSUM,"
"RTN","PSUDEM5",51,0)
 I PSUMASF!PSUDUZ!PSUPBMG D
"RTN","PSUDEM5",52,0)
 .I 'PSUSMRY M XMY=PSUXMYH D   ;Detailed message to Hines and self
"RTN","PSUDEM5",53,0)
 .D ^XMD
"RTN","PSUDEM5",54,0)
 Q
"RTN","PSUDEM5",55,0)
 ;
"RTN","PSUDEM5",56,0)
OPV ;EN  Outpatient encounter message
"RTN","PSUDEM5",57,0)
 ;
"RTN","PSUDEM5",58,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;don't send a mailman message if flag is set
"RTN","PSUDEM5",59,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUMONTH")) D AUTO  ;Find month if auto
"RTN","PSUDEM5",60,0)
 D VAR
"RTN","PSUDEM5",61,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM5",62,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM5",63,0)
 S PSUMON=$P(^XTMP("PSU_"_PSUJOB,"PSUMONTH"),U,1)
"RTN","PSUDEM5",64,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUOPV")) S PSUMC=1
"RTN","PSUDEM5",65,0)
 ;
"RTN","PSUDEM5",66,0)
 S XMDUZ=DUZ
"RTN","PSUDEM5",67,0)
 S XMSUB="V. 4.0 PBMOV"_" "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUST_" "_PSUSTNM
"RTN","PSUDEM5",68,0)
 S XMCHAN=1
"RTN","PSUDEM5",69,0)
 S XMTEXT="^XTMP(""PSU_""_PSUJOB,""PSUXMD"",PSUM,"
"RTN","PSUDEM5",70,0)
 I PSUMASF!PSUDUZ!PSUPBMG D
"RTN","PSUDEM5",71,0)
 .I 'PSUSMRY M XMY=PSUXMYH D   ;Detailed message to Hines and self
"RTN","PSUDEM5",72,0)
 .D ^XMD
"RTN","PSUDEM5",73,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUOPV")) M XMY=PSUXMYS1 D    ;NODATA  message
"RTN","PSUDEM5",74,0)
 .D ^XMD
"RTN","PSUDEM5",75,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUMONTH")
"RTN","PSUDEM5",76,0)
 Q
"RTN","PSUDEM5",77,0)
 ;
"RTN","PSUDEM5",78,0)
PTF ;EN  INPATIENT RECORD MESSAGE
"RTN","PSUDEM5",79,0)
 ;
"RTN","PSUDEM5",80,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;don't send a mailman message if flag is set
"RTN","PSUDEM5",81,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUMONTH")) D AUTO  ;Find month if auto
"RTN","PSUDEM5",82,0)
 D VAR
"RTN","PSUDEM5",83,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM5",84,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM5",85,0)
 S PSUMON=$P(^XTMP("PSU_"_PSUJOB,"PSUMONTH"),U,1)
"RTN","PSUDEM5",86,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUIPV")) S PSUMC=1
"RTN","PSUDEM5",87,0)
 ;
"RTN","PSUDEM5",88,0)
 S XMDUZ=DUZ
"RTN","PSUDEM5",89,0)
 S XMSUB="V. 4.0 PBMPTF"_" "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUST_" "_PSUSTNM
"RTN","PSUDEM5",90,0)
 S XMCHAN=1
"RTN","PSUDEM5",91,0)
 S XMTEXT="^XTMP(""PSU_""_PSUJOB,""PSUXMD"",PSUM,"
"RTN","PSUDEM5",92,0)
 I PSUMASF!PSUDUZ!PSUPBMG D
"RTN","PSUDEM5",93,0)
 .I 'PSUSMRY M XMY=PSUXMYH D   ;Detailed message to Hines and self
"RTN","PSUDEM5",94,0)
 .D ^XMD
"RTN","PSUDEM5",95,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUIPV")) M XMY=PSUXMYS1 D    ;NODATA  message
"RTN","PSUDEM5",96,0)
 .D ^XMD
"RTN","PSUDEM5",97,0)
 Q
"RTN","PSUDEM5",98,0)
 ;
"RTN","PSUDEM5",99,0)
PRSUM ;EN  Provider summary message
"RTN","PSUDEM5",100,0)
 ;
"RTN","PSUDEM5",101,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;don't send a mailman message if flag is set
"RTN","PSUDEM5",102,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUMONTH")) D AUTO  ;Find month if auto
"RTN","PSUDEM5",103,0)
 D VAR
"RTN","PSUDEM5",104,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM5",105,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM5",106,0)
 S PSUMON=$P(^XTMP("PSU_"_PSUJOB,"PSUMONTH"),U,1)
"RTN","PSUDEM5",107,0)
 ;
"RTN","PSUDEM5",108,0)
 S XMDUZ=DUZ
"RTN","PSUDEM5",109,0)
 S XMCHAN=1
"RTN","PSUDEM5",110,0)
 S XMSUB="V. 4.0 PBMPRO"_" "_PSUMON_" "_PSUST_" "_PSUSTNM
"RTN","PSUDEM5",111,0)
 S XMTEXT="^XTMP(""PSU_""_PSUJOB,""PSUSUM"","
"RTN","PSUDEM5",112,0)
 M XMY=PSUXMYS1
"RTN","PSUDEM5",113,0)
 I PSUSMRY=1 M XMY=PSUXMYS2     ;Summary only mailgroup
"RTN","PSUDEM5",114,0)
 D ^XMD
"RTN","PSUDEM5",115,0)
 Q
"RTN","PSUDEM5",116,0)
 ;
"RTN","PSUDEM5",117,0)
PDSUM ;EN  Pt. demographics summary message
"RTN","PSUDEM5",118,0)
 ;
"RTN","PSUDEM5",119,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3"))  ;don't send a mailman message if flag is set
"RTN","PSUDEM5",120,0)
 ;N PSUSTNM,PSUST
"RTN","PSUDEM5",121,0)
 D PULL^PSUCP
"RTN","PSUDEM5",122,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUMONTH")) D AUTO  ;Find month if auto
"RTN","PSUDEM5",123,0)
 D VAR
"RTN","PSUDEM5",124,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM5",125,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)
"RTN","PSUDEM5",126,0)
 S PSUMON=$P(^XTMP("PSU_"_PSUJOB,"PSUMONTH"),U,1)
"RTN","PSUDEM5",127,0)
 ;
"RTN","PSUDEM5",128,0)
 S XMDUZ=DUZ
"RTN","PSUDEM5",129,0)
 S XMCHAN=1
"RTN","PSUDEM5",130,0)
 S XMSUB="V. 4.0 PBMPD"_" "_PSUMON_" "_PSUST_" "_PSUSTNM
"RTN","PSUDEM5",131,0)
 S XMTEXT="^XTMP(""PSU_""_PSUJOB,""PSUSUMA"","
"RTN","PSUDEM5",132,0)
 I PSUSMRY=1 M XMY=PSUXMYS2     ;Summary only mailgroup
"RTN","PSUDEM5",133,0)
 M XMY=PSUXMYS1                 ;No Data mailgroup
"RTN","PSUDEM5",134,0)
 D ^XMD
"RTN","PSUDEM5",135,0)
 Q
"RTN","PSUDEM6")
0^35^B2342326
"RTN","PSUDEM6",1,0)
PSUDEM6 ;BIR/DAM - CPT Codes for Outpatient Visits Extract ; 20 DEC 2001
"RTN","PSUDEM6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM6",3,0)
 ;
"RTN","PSUDEM6",4,0)
 ;DBIA's
"RTN","PSUDEM6",5,0)
 ; Reference to file 81 supported by DBIA 2815
"RTN","PSUDEM6",6,0)
 ;
"RTN","PSUDEM6",7,0)
EN ;EN  Called from PSUDEM3
"RTN","PSUDEM6",8,0)
 D CPT
"RTN","PSUDEM6",9,0)
 D FIN
"RTN","PSUDEM6",10,0)
 ;
"RTN","PSUDEM6",11,0)
 Q
"RTN","PSUDEM6",12,0)
 ;
"RTN","PSUDEM6",13,0)
CPT ;Find CPT codes and place into temp global
"RTN","PSUDEM6",14,0)
 ;
"RTN","PSUDEM6",15,0)
 N PSUCPT1
"RTN","PSUDEM6",16,0)
 I $G(PSUCPT) S PSUCPT1=$P($G(^ICPT(PSUCPT,0)),U)
"RTN","PSUDEM6",17,0)
 I '$G(PSUCPT) S PSUCPT1="NULL"
"RTN","PSUDEM6",18,0)
 I (PSUVIEN'="")&(PSUCPT1'="") D
"RTN","PSUDEM6",19,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUTMP2",PSUVIEN,PSUCPT1)=""
"RTN","PSUDEM6",20,0)
 Q 
"RTN","PSUDEM6",21,0)
 ;
"RTN","PSUDEM6",22,0)
FIN ;$O through temp global, and set codes into the Outpatient Visit
"RTN","PSUDEM6",23,0)
 ;Encounter global, ^XTMP("PSU_"_PSUJOB,"PSUOPV"
"RTN","PSUDEM6",24,0)
 ;
"RTN","PSUDEM6",25,0)
 S PSUIDF=0
"RTN","PSUDEM6",26,0)
 S I=17
"RTN","PSUDEM6",27,0)
 F  S PSUIDF=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP2",PSUVIEN,PSUIDF)) Q:'PSUIDF  Q:I=27  D
"RTN","PSUDEM6",28,0)
 .I PSUIDF="NULL" S $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN),U,I)=""
"RTN","PSUDEM6",29,0)
 .I PSUIDF'="NULL" S $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN),U,I)=PSUIDF
"RTN","PSUDEM6",30,0)
 .S I=I+1
"RTN","PSUDEM6",31,0)
 ;
"RTN","PSUDEM6",32,0)
 F N=27:1:26 I $P($G(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN)),U,N)="" D
"RTN","PSUDEM6",33,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN),U,N)=""
"RTN","PSUDEM6",34,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUOPV",PSUVIEN),U,27)=""   ;set closing "^"
"RTN","PSUDEM6",35,0)
 Q
"RTN","PSUDEM7")
0^36^B14211015
"RTN","PSUDEM7",1,0)
PSUDEM7 ;BIR/DAM - Inpatient PTF Record Extract ;20 DEC 2001
"RTN","PSUDEM7",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM7",3,0)
 ;
"RTN","PSUDEM7",4,0)
 ;DBIA's
"RTN","PSUDEM7",5,0)
 ; Reference to file 2    supported by DBIA 10035
"RTN","PSUDEM7",6,0)
 ; Reference to file 4.3  supported by DBIA 2496
"RTN","PSUDEM7",7,0)
 ; Reference to file 45   supported by DBIA 3511
"RTN","PSUDEM7",8,0)
 ;
"RTN","PSUDEM7",9,0)
EN ;EN
"RTN","PSUDEM7",10,0)
 D DAT
"RTN","PSUDEM7",11,0)
 D EN^PSUDEM8    ;Gather ICD9 codes
"RTN","PSUDEM7",12,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUIPV")) D NODATA
"RTN","PSUDEM7",13,0)
 D XMD
"RTN","PSUDEM7",14,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIPV")
"RTN","PSUDEM7",15,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUXMD")
"RTN","PSUDEM7",16,0)
 Q
"RTN","PSUDEM7",17,0)
 ;
"RTN","PSUDEM7",18,0)
DAT ;Find discharge dates that fall within the extract date range
"RTN","PSUDEM7",19,0)
 ;as well as discharge dates within the 30 days prior to day 1 of
"RTN","PSUDEM7",20,0)
 ;of the extract date range.
"RTN","PSUDEM7",21,0)
 ;
"RTN","PSUDEM7",22,0)
 S PSUDD=0
"RTN","PSUDEM7",23,0)
 F  S PSUDD=$O(^DGPT("ADS",PSUDD)) Q:'PSUDD  D
"RTN","PSUDEM7",24,0)
 .S PSUDDT=$E(PSUDD,1,7)
"RTN","PSUDEM7",25,0)
 .S X1=PSUSDT
"RTN","PSUDEM7",26,0)
 .S X2=(-30)
"RTN","PSUDEM7",27,0)
 .D C^%DTC
"RTN","PSUDEM7",28,0)
 .S PSUSDT1=X              ;Date 30 days prior to start date
"RTN","PSUDEM7",29,0)
 .I (PSUDDT>PSUSDT1)!(PSUDDT=PSUSDT1)&(PSUDDT<PSUEDT)!(PSUDDT=PSUEDT) D
"RTN","PSUDEM7",30,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUDM",PSUDDT)=""
"RTN","PSUDEM7",31,0)
 ..S PSUIEN=0
"RTN","PSUDEM7",32,0)
 ..F  S PSUIEN=$O(^DGPT("ADS",PSUDD,PSUIEN)) Q:'PSUIEN  D
"RTN","PSUDEM7",33,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,5)=PSUDDT        ;Discharge Date
"RTN","PSUDEM7",34,0)
 ...N PSUDT
"RTN","PSUDEM7",35,0)
 ...S PSUDT=$P($G(^DGPT(PSUIEN,0)),U,2)
"RTN","PSUDEM7",36,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,4)=$E(PSUDT,1,7)  ;Admit date
"RTN","PSUDEM7",37,0)
 ...D INST^PSUDEM1
"RTN","PSUDEM7",38,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,2)=PSUSIT         ;SITE
"RTN","PSUDEM7",39,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,3)=PSUSIT_PSUIEN  ;Unique PTF ID
"RTN","PSUDEM7",40,0)
 ...D SSNICN
"RTN","PSUDEM7",41,0)
 Q
"RTN","PSUDEM7",42,0)
 ;
"RTN","PSUDEM7",43,0)
SSNICN ;Find patient Admission date, SSN and ICN for inpatient record
"RTN","PSUDEM7",44,0)
 ;VMP - OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUDEM7",45,0)
 ;
"RTN","PSUDEM7",46,0)
 N PSUPT,PSUICN,PSUICN1
"RTN","PSUDEM7",47,0)
 S PSUPT=$P($G(^DGPT(PSUIEN,0)),U)     ;Pointer to patient file
"RTN","PSUDEM7",48,0)
 ;
"RTN","PSUDEM7",49,0)
 N PSUREC
"RTN","PSUDEM7",50,0)
 I PSUPT D
"RTN","PSUDEM7",51,0)
 .S PSUREC=$P($G(^DPT(PSUPT,0)),U,9) D REC D
"RTN","PSUDEM7",52,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,6)=PSUREC     ;Pt SSN
"RTN","PSUDEM7",53,0)
 .S PSUICN=$$GETICN^MPIF001(PSUPT) D
"RTN","PSUDEM7",54,0)
 ..I PSUICN'[-1 D
"RTN","PSUDEM7",55,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUIEN),U,7)=PSUICN   ;ICN
"RTN","PSUDEM7",56,0)
 Q
"RTN","PSUDEM7",57,0)
 ;
"RTN","PSUDEM7",58,0)
REC ;If "^" is contained in any record, replace it with (')
"RTN","PSUDEM7",59,0)
 ;
"RTN","PSUDEM7",60,0)
 I PSUREC["^" S PSUREC=$TR(PSUREC,"^","'")
"RTN","PSUDEM7",61,0)
 Q
"RTN","PSUDEM7",62,0)
 ;
"RTN","PSUDEM7",63,0)
NODATA ;Generate a 'No Data' message if there is no data in the extract
"RTN","PSUDEM7",64,0)
 ;
"RTN","PSUDEM7",65,0)
 S NONE=1
"RTN","PSUDEM7",66,0)
 M PSUXMYH=PSUXMYS1
"RTN","PSUDEM7",67,0)
 S PSUM=1
"RTN","PSUDEM7",68,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,1)="No data to report"
"RTN","PSUDEM7",69,0)
 Q
"RTN","PSUDEM7",70,0)
 ;
"RTN","PSUDEM7",71,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM7",72,0)
 ;
"RTN","PSUDEM7",73,0)
 S PSUAB=0,PSUPL=1
"RTN","PSUDEM7",74,0)
 F  S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUAB)) Q:PSUAB=""  D
"RTN","PSUDEM7",75,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUPL)=^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUAB)  ;Global numerical order
"RTN","PSUDEM7",76,0)
 .S PSUPL=PSUPL+1
"RTN","PSUDEM7",77,0)
 ;
"RTN","PSUDEM7",78,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM7",79,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM7",80,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM7",81,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM7",82,0)
 F PSULC=1:1 S X=$G(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSULC)) Q:X=""  D
"RTN","PSUDEM7",83,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM7",84,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM7",85,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM7",86,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM7",87,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM7",88,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM7",89,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM7",90,0)
 ;
"RTN","PSUDEM7",91,0)
 ;   Count Lines sent
"RTN","PSUDEM7",92,0)
 S PSUTLC=0
"RTN","PSUDEM7",93,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM7",94,0)
 ;
"RTN","PSUDEM7",95,0)
 F PSUM=1:1:PSUMC D PTF^PSUDEM5
"RTN","PSUDEM7",96,0)
 D CONF
"RTN","PSUDEM7",97,0)
 Q
"RTN","PSUDEM7",98,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM7",99,0)
 ;
"RTN","PSUDEM7",100,0)
 ;D INST^PSUDEM1
"RTN","PSUDEM7",101,0)
 I $G(NONE) S PSUTLC=0
"RTN","PSUDEM7",102,0)
 N PSUDIVIS
"RTN","PSUDEM7",103,0)
 ;S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM7",104,0)
 S PSUDIVIS=PSUSNDR
"RTN","PSUDEM7",105,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM7",106,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,9,"M")=PSUMC
"RTN","PSUDEM7",107,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,9,"L")=PSUTLC
"RTN","PSUDEM7",108,0)
 Q
"RTN","PSUDEM8")
0^37^B17454400
"RTN","PSUDEM8",1,0)
PSUDEM8 ;BIR/DAM - ICD9 Codes for Inpatient PTF Record Extract ; 20 DEC 2001
"RTN","PSUDEM8",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM8",3,0)
 ;
"RTN","PSUDEM8",4,0)
 ;DBIA's
"RTN","PSUDEM8",5,0)
 ; Reference to file 45 supported by DBIA 3511
"RTN","PSUDEM8",6,0)
 ; Reference to file 80 supported by DBIA 10082
"RTN","PSUDEM8",7,0)
 ;
"RTN","PSUDEM8",8,0)
EN ;EN  CALLED FROM PSUDEM7
"RTN","PSUDEM8",9,0)
 D PTFIEN
"RTN","PSUDEM8",10,0)
 Q
"RTN","PSUDEM8",11,0)
 ;
"RTN","PSUDEM8",12,0)
PTFIEN ;$O through ^XTMP("PSU_"_PSUJOB,"PSUIPV" to get all the PTF IEN's
"RTN","PSUDEM8",13,0)
 ;
"RTN","PSUDEM8",14,0)
 S PSUC=0
"RTN","PSUDEM8",15,0)
 F  S PSUC=$O(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC)) Q:'PSUC  D
"RTN","PSUDEM8",16,0)
 .D PTF70     ;gather ICD9 data on ^DGPT(D0,70 node
"RTN","PSUDEM8",17,0)
 .D PTFM      ;gather ICD9 data on ^DGPT(D0,"M","AC" node
"RTN","PSUDEM8",18,0)
 .D FIN K ^XTMP("PSU_"_PSUJOB,"PSUTMP3")
"RTN","PSUDEM8",19,0)
 .D EN^PSUDEM9    ;gather CPT data on 2 separate ^DGPT nodes
"RTN","PSUDEM8",20,0)
 Q
"RTN","PSUDEM8",21,0)
 ;
"RTN","PSUDEM8",22,0)
PTF70 ;Find all ICD9 pointers present on ^DGPT(D0,70 node
"RTN","PSUDEM8",23,0)
 ;
"RTN","PSUDEM8",24,0)
 N PSU1,PSU2,PSU3,PSU4,PSU5,PSU6,PSU7,PSU8,PSU9,PSU10,PSU11
"RTN","PSUDEM8",25,0)
 S PSU1=$P($G(^DGPT(PSUC,70)),U,10) S:PSU1="" PSU1="NULL"  ;Ptr 1
"RTN","PSUDEM8",26,0)
 S PSU2=$P($G(^DGPT(PSUC,70)),U,16) S:PSU2="" PSU2="NULL"  ;Ptr 2
"RTN","PSUDEM8",27,0)
 S PSU3=$P($G(^DGPT(PSUC,70)),U,17) S:PSU3="" PSU3="NULL"  ;Ptr 3
"RTN","PSUDEM8",28,0)
 S PSU4=$P($G(^DGPT(PSUC,70)),U,18) S:PSU4="" PSU4="NULL"  ;Ptr 4
"RTN","PSUDEM8",29,0)
 S PSU5=$P($G(^DGPT(PSUC,70)),U,19) S:PSU5="" PSU5="NULL"  ;Ptr 5
"RTN","PSUDEM8",30,0)
 S PSU6=$P($G(^DGPT(PSUC,70)),U,20) S:PSU6="" PSU6="NULL"  ;Ptr 6
"RTN","PSUDEM8",31,0)
 S PSU7=$P($G(^DGPT(PSUC,70)),U,21) S:PSU7="" PSU7="NULL"  ;Ptr 7
"RTN","PSUDEM8",32,0)
 S PSU8=$P($G(^DGPT(PSUC,70)),U,22) S:PSU8="" PSU8="NULL"  ;Ptr 8
"RTN","PSUDEM8",33,0)
 S PSU9=$P($G(^DGPT(PSUC,70)),U,23) S:PSU9="" PSU9="NULL"  ;Ptr 9
"RTN","PSUDEM8",34,0)
 S PSU10=$P($G(^DGPT(PSUC,70)),U,24) S:PSU10="" PSU10="NULL"  ;Ptr 10
"RTN","PSUDEM8",35,0)
 S PSU11=$P($G(^DGPT(PSUC,70)),U,11) S:PSU11="" PSU11="NULL"  ;Ptr 11
"RTN","PSUDEM8",36,0)
 D ICD91
"RTN","PSUDEM8",37,0)
 Q
"RTN","PSUDEM8",38,0)
 ;
"RTN","PSUDEM8",39,0)
ICD91 ;Find ICD9 codes from pointer on ^DGPT(D0,70 node and place in
"RTN","PSUDEM8",40,0)
 ;an array
"RTN","PSUDEM8",41,0)
 ;
"RTN","PSUDEM8",42,0)
 N PSUID1,PSUID2,PSUID3,PSUID4,PSUID5,PSUID6,PSUID7,PSUID8,PSUID9
"RTN","PSUDEM8",43,0)
 N PSUID10,PSUID11
"RTN","PSUDEM8",44,0)
 S:PSU1'["N" PSUID1=$P($G(^ICD9(PSU1,0)),U) D
"RTN","PSUDEM8",45,0)
 .I $D(PSUID1) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,1,PSUID1)=""   ;1ST ICD9 CODE
"RTN","PSUDEM8",46,0)
 S:PSU2'["N" PSUID2=$P($G(^ICD9(PSU2,0)),U) D
"RTN","PSUDEM8",47,0)
 .I $D(PSUID2) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,2,PSUID2)=""   ;2ND ICD9 CODE
"RTN","PSUDEM8",48,0)
 S:PSU3'["N" PSUID3=$P($G(^ICD9(PSU3,0)),U) D
"RTN","PSUDEM8",49,0)
 .I $D(PSUID3) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,3,PSUID3)=""   ;3rd ICD9 CODE
"RTN","PSUDEM8",50,0)
 S:PSU4'["N" PSUID4=$P($G(^ICD9(PSU4,0)),U) D
"RTN","PSUDEM8",51,0)
 .I $D(PSUID4) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,4,PSUID4)=""   ;4th ICD9 CODE
"RTN","PSUDEM8",52,0)
 S:PSU5'["N" PSUID5=$P($G(^ICD9(PSU5,0)),U) D
"RTN","PSUDEM8",53,0)
 .I $D(PSUID5) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,5,PSUID5)=""   ;5th ICD9 CODE
"RTN","PSUDEM8",54,0)
 S:PSU6'["N" PSUID6=$P($G(^ICD9(PSU6,0)),U) D
"RTN","PSUDEM8",55,0)
 .I $D(PSUID6) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,6,PSUID6)=""   ;6th ICD9 CODE
"RTN","PSUDEM8",56,0)
 S:PSU7'["N" PSUID7=$P($G(^ICD9(PSU7,0)),U) D
"RTN","PSUDEM8",57,0)
 .I $D(PSUID7) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,7,PSUID7)=""   ;7th ICD9 CODE
"RTN","PSUDEM8",58,0)
 S:PSU8'["N" PSUID8=$P($G(^ICD9(PSU8,0)),U) D
"RTN","PSUDEM8",59,0)
 .I $D(PSUID8) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,8,PSUID8)=""    ;8th ICD9 CODE
"RTN","PSUDEM8",60,0)
 S:PSU9'["N" PSUID9=$P($G(^ICD9(PSU9,0)),U) D
"RTN","PSUDEM8",61,0)
 .I $D(PSUID9) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,9,PSUID9)=""   ;9th ICD9 CODE
"RTN","PSUDEM8",62,0)
 S:PSU10'["N" PSUID10=$P($G(^ICD9(PSU10,0)),U) D
"RTN","PSUDEM8",63,0)
 .I $D(PSUID10) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,10,PSUID10)=""  ;10th ICD9 CODE
"RTN","PSUDEM8",64,0)
 S:PSU11'["N" PSUID11=$P($G(^ICD9(PSU11,0)),U) D
"RTN","PSUDEM8",65,0)
 .I $D(PSUID11) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,11,PSUID11)=""  ;11th ICD9 CODE
"RTN","PSUDEM8",66,0)
 Q
"RTN","PSUDEM8",67,0)
 ;
"RTN","PSUDEM8",68,0)
PTFM ;
"RTN","PSUDEM8",69,0)
 S PSUCD=0
"RTN","PSUDEM8",70,0)
 S I=12
"RTN","PSUDEM8",71,0)
 F  S PSUCD=$O(^DGPT(PSUC,"M","AC",PSUCD)) Q:'PSUCD  D
"RTN","PSUDEM8",72,0)
 .I PSUCD="" S PSUCD="N"
"RTN","PSUDEM8",73,0)
 .N PSUIDT
"RTN","PSUDEM8",74,0)
 .S PSUIDT=$P($G(^ICD9(PSUCD,0)),U) D
"RTN","PSUDEM8",75,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUIDT)=""
"RTN","PSUDEM8",76,0)
 ..D DEL
"RTN","PSUDEM8",77,0)
 ..S I=I+1
"RTN","PSUDEM8",78,0)
 Q
"RTN","PSUDEM8",79,0)
 ;
"RTN","PSUDEM8",80,0)
DEL ;Delete duplicates
"RTN","PSUDEM8",81,0)
 ;
"RTN","PSUDEM8",82,0)
 F N=1:1:10 I $D(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,N,PSUIDT)) D
"RTN","PSUDEM8",83,0)
 .K ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUIDT)
"RTN","PSUDEM8",84,0)
 Q
"RTN","PSUDEM8",85,0)
 ;
"RTN","PSUDEM8",86,0)
FIN ;$O through array, and set codes into the Inpatient Record 
"RTN","PSUDEM8",87,0)
 ;global ^XTMP("PSU_"_PSUJOB,"PSUIPV"
"RTN","PSUDEM8",88,0)
 ;
"RTN","PSUDEM8",89,0)
 S T=0,N=8
"RTN","PSUDEM8",90,0)
 F  S T=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,T)) Q:'T  Q:N=29  D
"RTN","PSUDEM8",91,0)
 .S PSUIDF=0
"RTN","PSUDEM8",92,0)
 .F  S PSUIDF=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,T,PSUIDF)) Q:'PSUIDF  D
"RTN","PSUDEM8",93,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,N)=PSUIDF
"RTN","PSUDEM8",94,0)
 ..S N=N+1
"RTN","PSUDEM8",95,0)
 ;
"RTN","PSUDEM8",96,0)
 F N=8:1:28 I '$P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,N) D
"RTN","PSUDEM8",97,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,N)=""    ;Set unfilled pieces to null
"RTN","PSUDEM8",98,0)
 Q
"RTN","PSUDEM9")
0^38^B7601492
"RTN","PSUDEM9",1,0)
PSUDEM9 ;BIR/DAM - CPT Codes for Inpatient PTF Record Extract ; 20 DEC 2001
"RTN","PSUDEM9",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUDEM9",3,0)
 ;
"RTN","PSUDEM9",4,0)
 ;DBIA's
"RTN","PSUDEM9",5,0)
 ; Reference to file 45 supported by DBIA 3511
"RTN","PSUDEM9",6,0)
 ; Reference to file 80.1 supported by DBIA 10083
"RTN","PSUDEM9",7,0)
 ;
"RTN","PSUDEM9",8,0)
EN ;EN      Called from PSUDEM8
"RTN","PSUDEM9",9,0)
 D CPTP
"RTN","PSUDEM9",10,0)
 D P
"RTN","PSUDEM9",11,0)
 D AO
"RTN","PSUDEM9",12,0)
 D FIN
"RTN","PSUDEM9",13,0)
 ;
"RTN","PSUDEM9",14,0)
 Q
"RTN","PSUDEM9",15,0)
 ;
"RTN","PSUDEM9",16,0)
CPTP ;Find CPT pointers for the ^DGPT(D0,"401P" node by $ ordering
"RTN","PSUDEM9",17,0)
 ;through the ^DGPT(D0,"AP",Pointer) cross reference
"RTN","PSUDEM9",18,0)
 ;
"RTN","PSUDEM9",19,0)
 S I=17
"RTN","PSUDEM9",20,0)
 S PSUAP=0
"RTN","PSUDEM9",21,0)
 F  S PSUAP=$O(^DGPT(PSUC,"AP",PSUAP)) Q:'PSUAP  D
"RTN","PSUDEM9",22,0)
 .N PSUCPT
"RTN","PSUDEM9",23,0)
 .S PSUCPT=$P($G(^ICD0(PSUAP,0)),U)     ;CPT code
"RTN","PSUDEM9",24,0)
 .I $G(PSUCPT) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUCPT)=""    ;Set temp global
"RTN","PSUDEM9",25,0)
 .S I=I+1
"RTN","PSUDEM9",26,0)
 Q
"RTN","PSUDEM9",27,0)
 ;
"RTN","PSUDEM9",28,0)
P ;Find CPT pointers for the ^DGPT(D0,"P" node by $O through
"RTN","PSUDEM9",29,0)
 ;the ^DGPT(D0,"P","AP6",pointer,D1) cross reference
"RTN","PSUDEM9",30,0)
 ;
"RTN","PSUDEM9",31,0)
 S I=22
"RTN","PSUDEM9",32,0)
 S PSUP=0
"RTN","PSUDEM9",33,0)
 F  S PSUP=$O(^DGPT(PSUC,"P","AP6",PSUP)) Q:'PSUP  D
"RTN","PSUDEM9",34,0)
 .N PSUCPT
"RTN","PSUDEM9",35,0)
 .S PSUCPT=$P($G(^ICD0(PSUP,0)),U)      ;CPT code
"RTN","PSUDEM9",36,0)
 .I $G(PSUCPT) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUCPT)=""    ;Set temp global
"RTN","PSUDEM9",37,0)
 .D DEL
"RTN","PSUDEM9",38,0)
 .S I=I+1
"RTN","PSUDEM9",39,0)
 Q
"RTN","PSUDEM9",40,0)
 ;
"RTN","PSUDEM9",41,0)
DEL ;Delete duplicates
"RTN","PSUDEM9",42,0)
 ;
"RTN","PSUDEM9",43,0)
 F N=17:1:21 I $D(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,N,PSUCPT)) D
"RTN","PSUDEM9",44,0)
 .K ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUCPT)
"RTN","PSUDEM9",45,0)
 Q
"RTN","PSUDEM9",46,0)
 ;
"RTN","PSUDEM9",47,0)
AO ;Find CPT pointers for the ^DGPT(D0,"P" node by $O through
"RTN","PSUDEM9",48,0)
 ;the ^DGPT(D0,"S","AO",pointer,D1) cross reference.
"RTN","PSUDEM9",49,0)
 ;
"RTN","PSUDEM9",50,0)
 S I=27
"RTN","PSUDEM9",51,0)
 S PSUBP=0
"RTN","PSUDEM9",52,0)
 F  S PSUBP=$O(^DGPT(PSUC,"S","AO",PSUBP)) Q:'PSUBP  D
"RTN","PSUDEM9",53,0)
 .N PSUCPT
"RTN","PSUDEM9",54,0)
 .S PSUCPT=$P($G(^ICD0(PSUBP,0)),U)      ;CPT code
"RTN","PSUDEM9",55,0)
 .I $G(PSUCPT) S ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUCPT)=""    ;Set temp global
"RTN","PSUDEM9",56,0)
 .D DEL1
"RTN","PSUDEM9",57,0)
 .S I=I+1
"RTN","PSUDEM9",58,0)
 Q
"RTN","PSUDEM9",59,0)
 ;
"RTN","PSUDEM9",60,0)
DEL1 ;Delete duplicates
"RTN","PSUDEM9",61,0)
 ;
"RTN","PSUDEM9",62,0)
 F N=17:1:26 I $D(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,N,PSUCPT)) D
"RTN","PSUDEM9",63,0)
 .K ^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,I,PSUCPT)
"RTN","PSUDEM9",64,0)
 Q
"RTN","PSUDEM9",65,0)
 ;
"RTN","PSUDEM9",66,0)
FIN ;$O through temp global, and set codes into the Inpatient Record
"RTN","PSUDEM9",67,0)
 ;global, ^XTMP("PSU_"_PSUJOB,"PSUIPV"
"RTN","PSUDEM9",68,0)
 ;
"RTN","PSUDEM9",69,0)
 S T=0,N=29
"RTN","PSUDEM9",70,0)
 F  S T=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,T)) Q:'T  Q:N=44  D
"RTN","PSUDEM9",71,0)
 .S PSUIDF=0
"RTN","PSUDEM9",72,0)
 .F  S PSUIDF=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP3",PSUC,T,PSUIDF)) Q:'PSUIDF  D
"RTN","PSUDEM9",73,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,N)=PSUIDF
"RTN","PSUDEM9",74,0)
 ..S N=N+1
"RTN","PSUDEM9",75,0)
 ;
"RTN","PSUDEM9",76,0)
 F N=29:1:44 I '$P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,N) D
"RTN","PSUDEM9",77,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,N)=""    ;Set unfilled pieces to null
"RTN","PSUDEM9",78,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUIPV",PSUC),U,44)=""    ;Place "^" at end of record
"RTN","PSUDEM9",79,0)
 Q
"RTN","PSUENV")
0^39^B5797694
"RTN","PSUENV",1,0)
PSUENV ;BIR/PDW ; PBM V 3.0 ENVIRONMENTAL CHECK ROUTINE
"RTN","PSUENV",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUENV",3,0)
EN ; CHECK ENVIRONMENT
"RTN","PSUENV",4,0)
 ;
"RTN","PSUENV",5,0)
 ; 
"RTN","PSUENV",6,0)
 S (PSUPSJOK,PSUPSOOK,PSUOK,PSUNDFOK)=0
"RTN","PSUENV",7,0)
 K XPDQUIT
"RTN","PSUENV",8,0)
 ;   Check Pharmacy Benefits Managment installed
"RTN","PSUENV",9,0)
 S X=$$VERSION^XPDUTL("PSS")
"RTN","PSUENV",10,0)
 I +X'=1 D  G END
"RTN","PSUENV",11,0)
 . Q:$G(ZTQUEUED)
"RTN","PSUENV",12,0)
 . W !,"**INSTALLATION ABORTED** "
"RTN","PSUENV",13,0)
 . W "Pharmacy Data Managment Version 1 is REQUIRED for this install !!"
"RTN","PSUENV",14,0)
 ; 
"RTN","PSUENV",15,0)
 S X=$$PATCH^XPDUTL("PSS*1.0*13")
"RTN","PSUENV",16,0)
 I 'X D  G END
"RTN","PSUENV",17,0)
 . Q:$G(ZTQUEUED)
"RTN","PSUENV",18,0)
 . W !,"**INSTALLATION ABORTED** "
"RTN","PSUENV",19,0)
 . W "Patch PSS*1*13 is REQUIRED for this install !!"
"RTN","PSUENV",20,0)
 ;
"RTN","PSUENV",21,0)
 ;   Check In Patient version and Patch
"RTN","PSUENV",22,0)
 S X=$$VERSION^XPDUTL("PSJ")
"RTN","PSUENV",23,0)
 I +X=0 S PSUPSJOK=1 G OP ; IP not installed.. proceed to OP
"RTN","PSUENV",24,0)
 I +X=4.5 D
"RTN","PSUENV",25,0)
 . S Y=$$PATCH^XPDUTL("PSJ*4.5*61")
"RTN","PSUENV",26,0)
 . I Y S PSUPSJOK=1 Q
"RTN","PSUENV",27,0)
 . Q:$G(ZTQUEUED)
"RTN","PSUENV",28,0)
 . W !,"**INSTALLATION ABORTED** "
"RTN","PSUENV",29,0)
 . W "Patch PSJ*4.5*61 is REQUIRED for this install !!"
"RTN","PSUENV",30,0)
 ;
"RTN","PSUENV",31,0)
 I +X=5,PSUPSJOK=0 D
"RTN","PSUENV",32,0)
 . S Y=$$PATCH^XPDUTL("PSJ*5.0*13")
"RTN","PSUENV",33,0)
 . I Y S PSUPSJOK=1 Q
"RTN","PSUENV",34,0)
 . Q:$G(ZTQUEUED)
"RTN","PSUENV",35,0)
 . W !,"**INSTALLATION ABORTED** "
"RTN","PSUENV",36,0)
 . W "Patch PSJ*5.0*13 is REQUIRED for this install !!"
"RTN","PSUENV",37,0)
 ;
"RTN","PSUENV",38,0)
OP ;    Check Out Patient Version and Patch
"RTN","PSUENV",39,0)
 S X=$$VERSION^XPDUTL("PSO")
"RTN","PSUENV",40,0)
 I "6^7"'[$E(+X) D  G END
"RTN","PSUENV",41,0)
 . W !,"**INSTALLATION ABORTED** "
"RTN","PSUENV",42,0)
 . W "Version 6 or 7 of Outpatient Pharmacy is REQUIRED for this install !!"
"RTN","PSUENV",43,0)
 I +X=6 S PSUPSOOK=1
"RTN","PSUENV",44,0)
 I +X=7 D
"RTN","PSUENV",45,0)
 . S Y=$$PATCH^XPDUTL("PSO*7.0*11")
"RTN","PSUENV",46,0)
 . I Y S PSUPSOOK=1 Q
"RTN","PSUENV",47,0)
 . Q:$G(ZTQUEUED)
"RTN","PSUENV",48,0)
 . W !,"**INSTALLATION ABORTED** "
"RTN","PSUENV",49,0)
 . W "Patch PS0*7.0*11 is REQUIRED for this install !!"
"RTN","PSUENV",50,0)
 ;
"RTN","PSUENV",51,0)
 ;    Check if proper version of NDF is installed
"RTN","PSUENV",52,0)
 S X=$$VERSION^XPDUTL("PSN")
"RTN","PSUENV",53,0)
 I X'>3.17 D  G END
"RTN","PSUENV",54,0)
 . Q:$G(ZTQUEUED)
"RTN","PSUENV",55,0)
 . W !,"**INSTALLATION ABORTED** ",!
"RTN","PSUENV",56,0)
 . W "National Drug File Version 3.18 or higher is REQUIRED for this install !!"
"RTN","PSUENV",57,0)
 S PSUNDFOK=1
"RTN","PSUENV",58,0)
 ;
"RTN","PSUENV",59,0)
END ;EP
"RTN","PSUENV",60,0)
 I PSUPSJOK,PSUPSOOK,PSUNDFOK S PSUOK=1
"RTN","PSUENV",61,0)
 I 'PSUOK W:'$G(ZTQUEUED) !,"Installation Stopping",! S XPDQUIT=1
"RTN","PSUENV",62,0)
 Q
"RTN","PSUHL")
0^40^B6908275
"RTN","PSUHL",1,0)
PSUHL ;BIR/RDC - DYNAMIC CAPTURE OF PATIENT DEMOGRAPHICS ; 05 MAR 2004
"RTN","PSUHL",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUHL",3,0)
 ;
"RTN","PSUHL",4,0)
 ;DBIA's
"RTN","PSUHL",5,0)
 ; Reference to file 55      supported by DBIA 3502
"RTN","PSUHL",6,0)
 ; Reference to file 2       supported by DBIA 3344
"RTN","PSUHL",7,0)
 ;
"RTN","PSUHL",8,0)
CHNG ; THIS TAG WILL EXECUTE UPON ANY MODIFICATION TO THE PATIENT FILE #2
"RTN","PSUHL",9,0)
 ; CHANGES TO ANY FIELDS OTHER THAN THOSE INHERANT TO THE 
"RTN","PSUHL",10,0)
 ; PATIENT DEMOGRAPHIC EXTRACT (^PSUDEM1) WILL BE IGNORED
"RTN","PSUHL",11,0)
 ; SUCCESSFUL EXECUTION OF THIS TAG WILL RESULT IN THE DATE AND
"RTN","PSUHL",12,0)
 ; DFN BEING LOGGED IN THE PBM PATIENT DEMOGRAPHICS file #59.9
"RTN","PSUHL",13,0)
 ;
"RTN","PSUHL",14,0)
 Q:DGFILE'=2          ;The modified file is not the PATIENT file(#2)
"RTN","PSUHL",15,0)
 N FIELD,CHANGED
"RTN","PSUHL",16,0)
 S CHANGED=0
"RTN","PSUHL",17,0)
 ;                               ; ** loop thru pertinent fields **
"RTN","PSUHL",18,0)
 ;
"RTN","PSUHL",19,0)
 F FIELD=.351,.03,.06,.02,.361,.14,27.01,.09,991.01,.104,.097,2.02,2.06 I $G(DGFIELD)=FIELD S CHANGED=1 Q      ; flag if one of our fields changes
"RTN","PSUHL",20,0)
 ;
"RTN","PSUHL",21,0)
 Q:'CHANGED                      ; irrelevant field changed - quit
"RTN","PSUHL",22,0)
 D LOGDFN(DGDA)                  ; log demographic change in ^PSUDEM 
"RTN","PSUHL",23,0)
 Q
"RTN","PSUHL",24,0)
 ;
"RTN","PSUHL",25,0)
LOGDFN(DFN)            ; This tag will log the date & dfn to file #59.9
"RTN","PSUHL",26,0)
 ;
"RTN","PSUHL",27,0)
 Q:+$G(DFN)=0                    ; no patient pointer to log ***
"RTN","PSUHL",28,0)
 Q:$D(^PSUDEM("C",DFN,DT))       ; patient already logged for today
"RTN","PSUHL",29,0)
 S X=DT                          ; load date into .01 field
"RTN","PSUHL",30,0)
 S DIC("DR")=".02///"_DFN        ; stuff dfn into .02 field
"RTN","PSUHL",31,0)
 S DLAYGO=59.9                   ; override no new entry flag
"RTN","PSUHL",32,0)
 S DIC="^PSUDEM("                ; point to global for #59.9
"RTN","PSUHL",33,0)
 S DIC(0)="LF"                   ; set laygo & forget flags
"RTN","PSUHL",34,0)
 D FILE^DICN                     ; call Fileman to build file
"RTN","PSUHL",35,0)
 K DIC,DLAYGO,X,DFN
"RTN","PSUHL",36,0)
 Q
"RTN","PSUHL",37,0)
 ; 
"RTN","PSUHL",38,0)
PHARM ;
"RTN","PSUHL",39,0)
 ; THIS TAG IS TRIGGERED BY A CROSS REFERENCE ON THE 
"RTN","PSUHL",40,0)
 ; PHARMACY PATIENT FILE (#55); FIRST SERVICE DATE (#.07)
"RTN","PSUHL",41,0)
 ;
"RTN","PSUHL",42,0)
 D LOGDFN(DA)              ;log change of patient demographics
"RTN","PSUHL",43,0)
 Q
"RTN","PSUHL",44,0)
 ;
"RTN","PSUHL",45,0)
CLEANUP ;  THIS TAG CLEANS UP DATA IN ^PSUDEM >75 DAYS
"RTN","PSUHL",46,0)
 ;
"RTN","PSUHL",47,0)
 N MIN,DAY,DFN
"RTN","PSUHL",48,0)
 S X1=DT,X2=-75
"RTN","PSUHL",49,0)
 D C^%DTC S MIN=X                                      ;today-75 days
"RTN","PSUHL",50,0)
 S DIK="^PSUDEM("                                 ;file root to kill
"RTN","PSUHL",51,0)
 S DAY=""
"RTN","PSUHL",52,0)
 F  S DAY=$O(^PSUDEM("B",DAY)) Q:DAY>MIN  D       ;loop thru days
"RTN","PSUHL",53,0)
 . S DFN=""                                       ;older than 75 days
"RTN","PSUHL",54,0)
 . F  S DFN=$O(^PSUDEM("B",DAY,DFN)) Q:DFN=""  D  ;get the dfn
"RTN","PSUHL",55,0)
 .. S DA=DFN D ^DIK                     ; and have Fileman kill the dfn
"RTN","PSUHL",56,0)
 ;
"RTN","PSUHL",57,0)
 K DIK
"RTN","PSUHL",58,0)
 Q
"RTN","PSUHL",59,0)
 ;
"RTN","PSULR0")
0^54^B9269261
"RTN","PSULR0",1,0)
PSULR0 ;BIR/PDW - PBM LABORATORY EXTRACT ;25 AUG 1998
"RTN","PSULR0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR0",3,0)
 ;
"RTN","PSULR0",4,0)
EN ;EP  Tasking Entry Point for generating LAB mail messages, Summaries, & Prints
"RTN","PSULR0",5,0)
 ;
"RTN","PSULR0",6,0)
 ;   pull in fresh copy of variables
"RTN","PSULR0",7,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,ZTIO,PSUSNDR,PSUOPTS"
"RTN","PSULR0",8,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P(^XTMP("PSU_"_PSUJOB,1),U,I)
"RTN","PSULR0",9,0)
 ;   save off a copy of variables
"RTN","PSULR0",10,0)
 ;S X="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUSNDR,PSULRSUB,PSULRJOB,PSUJOB,PSUOPTN,PSURTN"
"RTN","PSULR0",11,0)
 ;F I=1:1 S Y=$P(X,",",I) Q:Y=""  I $D(@Y) S X(Y)=@Y
"RTN","PSULR0",12,0)
 ;M ^XTMP(PSULRSUB,"SAVE")=X
"RTN","PSULR0",13,0)
 K X
"RTN","PSULR0",14,0)
 ;
"RTN","PSULR0",15,0)
 ;   process Lab entries put into ^XTMP(PSULRSUB,"EVENTS") by IV, UD, OP
"RTN","PSULR0",16,0)
 ;
"RTN","PSULR0",17,0)
 D EN^PSULR1
"RTN","PSULR0",18,0)
 D EN^PSULR2 ; Gather patient test(s) 'CH' nodes and get test results
"RTN","PSULR0",19,0)
 D EN^PSULR3 ; Generate Records for detailed message and source for summary
"RTN","PSULR0",20,0)
 K PSUMSG
"RTN","PSULR0",21,0)
 D EN^PSULR4(.PSUMSG) ; Generate Detailed Mail Message
"RTN","PSULR0",22,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSULR0",23,0)
 I $D(^XTMP(PSUSUB)),PSUMASF M ^XTMP(PSUSUB,"CONFIRM")=PSUMSG
"RTN","PSULR0",24,0)
 I $D(^XTMP(PSUSUB)),PSUPBMG M ^XTMP(PSUSUB,"CONFIRM")=PSUMSG
"RTN","PSULR0",25,0)
 D EN^PSULR5 ; Summaries
"RTN","PSULR0",26,0)
 Q
"RTN","PSULR0",27,0)
 ;
"RTN","PSULR0",28,0)
PRINT ;EP  Tasking Entry Point for generating LAB printouts
"RTN","PSULR0",29,0)
 D EN^PSULR6
"RTN","PSULR0",30,0)
 Q
"RTN","PSULR0",31,0)
 ;
"RTN","PSULR0",32,0)
EXIT ;EP EXIT
"RTN","PSULR0",33,0)
 M Z=^XTMP(PSUARSUB,PSUARJOB,"SAVE")
"RTN","PSULR0",34,0)
 K ^XTMP(PSUARJOB)
"RTN","PSULR0",35,0)
 ; Kill PSU Variables
"RTN","PSULR0",36,0)
 D VARKILL^PSUTL
"RTN","PSULR0",37,0)
 ;      Restore Important Variables
"RTN","PSULR0",38,0)
 S Y="" F  S Y=$O(Z(Y)) Q:Y=""  S @Y=Z(Y)
"RTN","PSULR0",39,0)
 K Z
"RTN","PSULR0",40,0)
 Q
"RTN","PSULR0",41,0)
 ;
"RTN","PSULR0",42,0)
LAB(PSUPK,PSUDIV,PSUORD,PSUDFN,PSUDRGNM,PSUDRCD) ;EP pass by value into lab extract
"RTN","PSULR0",43,0)
 I PSUDRCD="" Q  ; No Drug Class Code passed
"RTN","PSULR0",44,0)
 ; PSUPK - Package "IV" "UD" "OP"
"RTN","PSULR0",45,0)
 ; PSUDIV - DIVISION   ( internal form )
"RTN","PSULR0",46,0)
 ; PSUORD - ORDER NUMBER (IV - order # , UD - order # , OP - Prescription Number)
"RTN","PSULR0",47,0)
 ; PSUDFN - Patient IEN
"RTN","PSULR0",48,0)
 ; PSUDRGN - Drug Generic Name ["FREE TEXT"]
"RTN","PSULR0",49,0)
 ; PSUDRCD - VA Drug Class Code
"RTN","PSULR0",50,0)
 ;
"RTN","PSULR0",51,0)
 ; Screen out test patients
"RTN","PSULR0",52,0)
 Q:$$TESTPAT^PSUTL1(PSUDFN)
"RTN","PSULR0",53,0)
 ;
"RTN","PSULR0",54,0)
 N PSULRDA
"RTN","PSULR0",55,0)
 ;       set basics
"RTN","PSULR0",56,0)
 I '$G(PSUJOB) S PSUJOB=$J
"RTN","PSULR0",57,0)
 I '$G(PSULRSUB) S PSULRSUB="PSULR_"_PSUJOB
"RTN","PSULR0",58,0)
 I '$G(PSULRJOB) S PSULRJOB=PSUJOB
"RTN","PSULR0",59,0)
 I '$D(^XTMP(PSULRSUB,PSULRJOB)) D
"RTN","PSULR0",60,0)
 . S X1=DT,X2=+0 D C^%DTC
"RTN","PSULR0",61,0)
 . S ^XTMP(PSULRSUB,PSULRJOB)=DT_U_X_U_" PBM LAB EXTRACT"
"RTN","PSULR0",62,0)
 ;
"RTN","PSULR0",63,0)
 ;   Setup XTMP for Lab
"RTN","PSULR0",64,0)
 S X1=DT,X2=6 D C^%DTC
"RTN","PSULR0",65,0)
 S ^XTMP(PSULRSUB,0)=X_U_DT_"^  PBM Extract - Laboratory Module"
"RTN","PSULR0",66,0)
 ;
"RTN","PSULR0",67,0)
 I '$D(^XTMP(PSULRSUB,"CODES")) D SETCODES
"RTN","PSULR0",68,0)
 ;
"RTN","PSULR0",69,0)
 ;      test to see if one of the select drug class codes
"RTN","PSULR0",70,0)
 I '$D(^XTMP(PSULRSUB,"CODES",PSUDRCD)) Q
"RTN","PSULR0",71,0)
 ;
"RTN","PSULR0",72,0)
 ;     store event
"RTN","PSULR0",73,0)
 S PSULRDA=$O(^XTMP(PSULRSUB,"EVENT",""),-1)+1
"RTN","PSULR0",74,0)
 S ^XTMP(PSULRSUB,"EVENT",PSULRDA)=PSUPK_U_PSUDIV_U_PSUDFN_U_PSUORD_U_PSUDRGNM_U_PSUDRCD
"RTN","PSULR0",75,0)
 Q
"RTN","PSULR0",76,0)
 ;
"RTN","PSULR0",77,0)
SETCODES ;EP TO SETUP CODES
"RTN","PSULR0",78,0)
 ;       set basics
"RTN","PSULR0",79,0)
 I '$G(PSUJOB) S PSUJOB=$J
"RTN","PSULR0",80,0)
 I '$G(PSULRSUB) S PSULRSUB="PSULR_"_PSUJOB
"RTN","PSULR0",81,0)
 I '$G(PSULRJOB) S PSULRJOB=PSUJOB
"RTN","PSULR0",82,0)
 I '$D(^XTMP(PSULRSUB,PSULRJOB)) D
"RTN","PSULR0",83,0)
 . S X1=DT,X2=+0 D C^%DTC
"RTN","PSULR0",84,0)
 . S ^XTMP(PSULRSUB,PSULRJOB)=DT_U_X_U_" PBM LAB EXTRACT"
"RTN","PSULR0",85,0)
 F X="AN500","CV200","CV350","CV800","GA301","HS502" S ^XTMP(PSULRSUB,"CODES",X)=""
"RTN","PSULR0",86,0)
 Q
"RTN","PSULR0",87,0)
 ;
"RTN","PSULR0",88,0)
CLEAR ;EP Clear PSULR out of XTMP
"RTN","PSULR0",89,0)
 S X="PSULR"
"RTN","PSULR0",90,0)
 F  S X=$O(^XTMP(X)) Q:$E(X,1,5)'="PSULR"  W !,X K ^XTMP(X)
"RTN","PSULR0",91,0)
 Q
"RTN","PSULR1")
0^55^B4534693
"RTN","PSULR1",1,0)
PSULR1 ;BIR/PDW - PBM LAB EXTRACT ;12 AUG 1999
"RTN","PSULR1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR1",3,0)
 ; Extract & setup crosswalk for drug codes and "CH" nodes
"RTN","PSULR1",4,0)
 ; Reference to File # 60  supported by DBIA 2523
"RTN","PSULR1",5,0)
 ; Reference to ^LAM       supported by DBIA 2522
"RTN","PSULR1",6,0)
EN ;EP  Tasking Entry Point for generating LAB mail messages, Summaries, & Prints
"RTN","PSULR1",7,0)
 ;
"RTN","PSULR1",8,0)
CODES ; Table for Building Class * Work Load codes * Lab Tests crosswalk
"RTN","PSULR1",9,0)
 D SETCODES^PSULR0
"RTN","PSULR1",10,0)
 ; Builds ^XTMP(PSULRSUB,"CODES",VA DRUG CLASS,LAB NODE LOCATION)=LAB TEST
"RTN","PSULR1",11,0)
 ; Builds PSUFLAG("BLOOD":"SERUM":"PLASMA") array
"RTN","PSULR1",12,0)
 S:'$D(PSUJOB) PSUJOB=$J
"RTN","PSULR1",13,0)
 S:'$D(PSULRJOB) PSULRJOB=PSUJOB
"RTN","PSULR1",14,0)
 S:'$D(PSULRSUB) PSULRSUB="PSULR_"_PSULRJOB
"RTN","PSULR1",15,0)
 ;    Initialize Flag type array
"RTN","PSULR1",16,0)
 F X="BLOOD","SERUM","PLASMA" S PSUFLAG(X)=""
"RTN","PSULR1",17,0)
 ;
"RTN","PSULR1",18,0)
 ;    Loop Drug Class Codes & WorkCodes    3.2.8.7
"RTN","PSULR1",19,0)
 S X="AN500" F Y=83405,81062 S PSULRX(X,Y)="" D GET
"RTN","PSULR1",20,0)
 S X="CV200" F Y=82565 S PSULRX(X,Y)="" D GET
"RTN","PSULR1",21,0)
 S X="CV350" F Y=83017,83013,84480,82466,84455,84465 S PSULRX(X,Y)="" D GET
"RTN","PSULR1",22,0)
 S X="CV800" F Y=82565,84140 S PSULRX(X,Y)="" D GET
"RTN","PSULR1",23,0)
 S X="GA301" F Y=82565 S PSULRX(X,Y)="" D GET
"RTN","PSULR1",24,0)
 S X="HS502" F Y=84330,85053,84455,84465,85052 S PSULRX(X,Y)="" D GET
"RTN","PSULR1",25,0)
 ;
"RTN","PSULR1",26,0)
 Q
"RTN","PSULR1",27,0)
 ;   Follow wrk code into tests 3.2.8.9
"RTN","PSULR1",28,0)
GET ;EP   Get the appropriate Work Load entry
"RTN","PSULR1",29,0)
 ;
"RTN","PSULR1",30,0)
 S PSUY=Y_".0000 " D WALK
"RTN","PSULR1",31,0)
 F  S PSUY=$O(^LAM("C",PSUY)) Q:(+PSUY\1'=+Y)  D WALK
"RTN","PSULR1",32,0)
 Q
"RTN","PSULR1",33,0)
WALK ;EP Do the crosswalk to get the tests associated with workload
"RTN","PSULR1",34,0)
 S Z=$O(^LAM("C",PSUY,0))
"RTN","PSULR1",35,0)
 ;    3.2.8.9
"RTN","PSULR1",36,0)
 I '$D(^LAM(Z,7,"B")) Q
"RTN","PSULR1",37,0)
 ;    3.2.8.10
"RTN","PSULR1",38,0)
 ;
"RTN","PSULR1",39,0)
 S PSUWKDA=Z
"RTN","PSULR1",40,0)
 ;    Loop Multiple & Work on over to file 60 & check site/specimen
"RTN","PSULR1",41,0)
 S Z="" F  S Z=$O(^LAM(PSUWKDA,7,"B",Z)) Q:Z=""  D
"RTN","PSULR1",42,0)
 . S PSULRDA=+Z
"RTN","PSULR1",43,0)
 . K PSUSPECM
"RTN","PSULR1",44,0)
 . D GETM^PSUTL(60,PSULRDA,"100*^.01;6","PSUSPECM")
"RTN","PSULR1",45,0)
 . S DA=0,PSUFLAG=0 F  S DA=$O(PSUSPECM(DA)) Q:DA'>0  S W=PSUSPECM(DA,.01) I $D(PSUFLAG(W)) S PSUFLAG=1 Q
"RTN","PSULR1",46,0)
 . Q:'PSUFLAG
"RTN","PSULR1",47,0)
 . ;  store DrugCode, WrkCode, Lab IEN = Location
"RTN","PSULR1",48,0)
 . S PSULOC=$$VAL^PSUTL(60,PSULRDA,5),PSULOC=$P(PSULOC,";",2)
"RTN","PSULR1",49,0)
 . ;S ^XTMP(PSULRSUB,"CODES",X,+Y,PSULRDA)=PSULOC ; Trace Construction
"RTN","PSULR1",50,0)
 . S ^XTMP(PSULRSUB,"CODES",X,PSULOC)=$$VAL^PSUTL(60,PSULRDA,.01)_U_PSUSPECM(DA,6)
"RTN","PSULR2")
0^56^B5463694
"RTN","PSULR2",1,0)
PSULR2 ;BIR/PDW - PBM LAB EXTRACT  PROCESS PATIENTS ;25 AUG 1998
"RTN","PSULR2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR2",3,0)
 ;
"RTN","PSULR2",4,0)
 ;DBIA'S
"RTN","PSULR2",5,0)
 ; Reference to file #2  supported by DBIA 10035
"RTN","PSULR2",6,0)
 ; Reference to file #63 supported by DBIA 2524
"RTN","PSULR2",7,0)
 ;
"RTN","PSULR2",8,0)
EN ;EP  SCAN AND SPLIT INTO DIVISION,RECORDS
"RTN","PSULR2",9,0)
 ;   Build ^XTMP(,,"RECORDS",PSUDIV,L)
"RTN","PSULR2",10,0)
 ;   Build ^XTMP(,,"PATIENT",DFN,TEST)=""  AND THEN
"RTN","PSULR2",11,0)
 ;                                   ,DATE)=RESULT^FLAG
"RTN","PSULR2",12,0)
 K ^XTMP(PSULRSUB,"RECORDS"),^("PATIENTS")
"RTN","PSULR2",13,0)
 ;   Gather the tests necessary for each patient
"RTN","PSULR2",14,0)
 S PSUDA="" F  S PSUDA=$O(^XTMP(PSULRSUB,"EVENT",PSUDA)) Q:PSUDA'>0  S X=^(PSUDA) D TESTS
"RTN","PSULR2",15,0)
 ;
"RTN","PSULR2",16,0)
 ;   with the tests gathered for each patient
"RTN","PSULR2",17,0)
 ;   now scan each patients daily lab results looking for the tests
"RTN","PSULR2",18,0)
 D PATIENT
"RTN","PSULR2",19,0)
 Q
"RTN","PSULR2",20,0)
TESTS ;EP Gather tests for a patient for the drug class
"RTN","PSULR2",21,0)
 ;      nodes used in ^XTMP sampler
"RTN","PSULR2",22,0)
 ;^XTMP("PSULR_541074170","CODES","CV800",6) = POTASSIUM
"RTN","PSULR2",23,0)
 ;^XTMP("PSULR_541074170","EVENT",1) = IV^599^13^12345^ASPRIN^CV800
"RTN","PSULR2",24,0)
 ;^XTMP("PSULR_541074170","PATIENT",13,4) = CREATININE
"RTN","PSULR2",25,0)
 ;^XTMP("PSULR_541074170","PATIENT",13,4,7029388.859632) = 1.0^^^50
"RTN","PSULR2",26,0)
 ;^XTMP("PSULR_541074170","PATIENT",13,6) = POTASSIUM
"RTN","PSULR2",27,0)
 ;^XTMP("PSULR_541074170","PATIENT",13,6,7029388.859632) = 5.0^^^50
"RTN","PSULR2",28,0)
 ;
"RTN","PSULR2",29,0)
 ; lab test "ch" node locations for each drug class were built in PSULR1 
"RTN","PSULR2",30,0)
 ; Setup "Patient",ch node)="" by codes and tests built in XTMP(,,"CODES",TEST node)=test name
"RTN","PSULR2",31,0)
 ;
"RTN","PSULR2",32,0)
 S PSUDRCD=$P(X,U,6),PSUDFN=$P(X,U,3)
"RTN","PSULR2",33,0)
 S PSULRND=0 F  S PSULRND=$O(^XTMP(PSULRSUB,"CODES",PSUDRCD,PSULRND)) Q:PSULRND'>0  S X=^(PSULRND) D
"RTN","PSULR2",34,0)
 . S ^XTMP(PSULRSUB,"PATIENT",PSUDFN,PSULRND)=X
"RTN","PSULR2",35,0)
 Q
"RTN","PSULR2",36,0)
 ;
"RTN","PSULR2",37,0)
PATIENT ;EP SCAN for each patient their tests needed
"RTN","PSULR2",38,0)
 ;Take   ^XTMP(,"PATIENT","CH TEST NODE")=TESTNAME
"RTN","PSULR2",39,0)
 ;scan the lab file
"RTN","PSULR2",40,0)
 ;and build
"RTN","PSULR2",41,0)
 ;       ^XTMP(,"PATIENT","CH TEST NODE",DATE)=RESULT^TESTFLAG
"RTN","PSULR2",42,0)
 ;
"RTN","PSULR2",43,0)
 S X1=PSUEDT,X2=-365 D C^%DTC
"RTN","PSULR2",44,0)
 ;S X1=PSUSDT,X2=-365 D C^%DTC
"RTN","PSULR2",45,0)
 S PSULREDT=9999999-X ; only go back one year
"RTN","PSULR2",46,0)
 S PSULRSDT=9999999-PSUSDT
"RTN","PSULR2",47,0)
 ;
"RTN","PSULR2",48,0)
 ;     gather needed test (nodes) from ^XTMP and put into the X to PSUNODE array
"RTN","PSULR2",49,0)
 ;
"RTN","PSULR2",50,0)
 S DFN=0 F  K X S DFN=$O(^XTMP(PSULRSUB,"PATIENT",DFN)) Q:DFN'>0  M X=^(DFN) D
"RTN","PSULR2",51,0)
 . N PSUNODE
"RTN","PSULR2",52,0)
 . ;   psunode("CH" NODE)=test name
"RTN","PSULR2",53,0)
 . M PSUNODE=X
"RTN","PSULR2",54,0)
 . I '$D(^DPT(DFN,"LR")) Q
"RTN","PSULR2",55,0)
 . S PSULRDFN=^DPT(DFN,"LR")
"RTN","PSULR2",56,0)
 . S DA=PSULRSDT F  S DA=$O(^LR(PSULRDFN,"CH",DA)) Q:DA'>0  Q:'$D(PSUNODE)  Q:DA>PSULREDT  D
"RTN","PSULR2",57,0)
 .. ;  check each date for each ch node in PSUNODE
"RTN","PSULR2",58,0)
 .. S Y=0 F  S Y=$O(PSUNODE(Y)) Q:Y'>0  I $D(^LR(PSULRDFN,"CH",DA,Y)) D
"RTN","PSULR2",59,0)
 ...  ;found a test, save result & quit testing for the node
"RTN","PSULR2",60,0)
 ... I '$P(^LR(PSULRDFN,"CH",DA,0),U,3) Q  ; results not verified
"RTN","PSULR2",61,0)
 ... S ^XTMP(PSULRSUB,"PATIENT",DFN,Y,DA)=^LR(PSULRDFN,"CH",DA,Y)
"RTN","PSULR2",62,0)
 ... K PSUNODE(Y)
"RTN","PSULR2",63,0)
 ;
"RTN","PSULR2",64,0)
 Q
"RTN","PSULR2",65,0)
 ;
"RTN","PSULR3")
0^57^B5904843
"RTN","PSULR3",1,0)
PSULR3 ;BIR/PDW - LAB extract assemble recs. for mail messg. ;25 AUG 1998
"RTN","PSULR3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR3",3,0)
EN ;EP
"RTN","PSULR3",4,0)
 ;
"RTN","PSULR3",5,0)
 ;
"RTN","PSULR3",6,0)
 ;     Samples of the XTMP records being used
"RTN","PSULR3",7,0)
 ;
"RTN","PSULR3",8,0)
 ;^XTMP("PSULR_541075670",541075670,"CODES","CV800",4) = CREATININE^mg/dL
"RTN","PSULR3",9,0)
 ;^XTMP("PSULR_541075670",541075670,"EVENT",1) = IV^599^13^12345^ASPRIN^CV800
"RTN","PSULR3",10,0)
 ;^XTMP("PSULR_541075670",541075670,"PATIENT",13,4) = CREATININE^mg/dL
"RTN","PSULR3",11,0)
 ;^XTMP("PSULR_541075670",541075670,"PATIENT",13,4,7029388.859632) = 1.0^^^50
"RTN","PSULR3",12,0)
 ;^XTMP("PSULR_541077558",541077558,"RECORDS",59,1) = ^59^^^^12345^^^^^^ASPRIN^^CREATININE^^^^1.0 mg/dL^^6/10/97^
"RTN","PSULR3",13,0)
 ;^XTMP("PSULR_541077558",541077558,"SUMMARY",599,13,"CV800",4) = CREATININE^1.0 mg/dL^6/10/97^
"RTN","PSULR3",14,0)
 ;
"RTN","PSULR3",15,0)
 ;  LOOP through the events and assemble records accordingly
"RTN","PSULR3",16,0)
 K ^XTMP(PSULRSUB,"RECORDS")
"RTN","PSULR3",17,0)
 K ^XTMP(PSULRSUB,"SUMMARY")
"RTN","PSULR3",18,0)
 S PSUEV=0 F  S PSUEV=$O(^XTMP(PSULRSUB,"EVENT",PSUEV)) Q:PSUEV'>0  S X=^(PSUEV) D
"RTN","PSULR3",19,0)
 . ;W !,X
"RTN","PSULR3",20,0)
 . S PSUPK=$P(X,U,1),PSUDIV=$P(X,U,2),DFN=$P(X,U,3)
"RTN","PSULR3",21,0)
 . S PSUORD=$P(X,U,4),PSUDRGN=$P(X,U,5),PSUDRCD=$P(X,U,6)
"RTN","PSULR3",22,0)
 . K PSUCD
"RTN","PSULR3",23,0)
 . M PSUCD=^XTMP(PSULRSUB,"CODES",PSUDRCD)
"RTN","PSULR3",24,0)
 . S PSUND=0 F  S PSUND=$O(PSUCD(PSUND)) Q:PSUND'>0  D
"RTN","PSULR3",25,0)
 .. S PSUDT=$O(^XTMP(PSULRSUB,"PATIENT",DFN,PSUND,0))
"RTN","PSULR3",26,0)
 .. I 'PSUDT Q  ; no test results found
"RTN","PSULR3",27,0)
 .. K VA D PID^VADPT
"RTN","PSULR3",28,0)
 .. S PSUX=$$RECORD()
"RTN","PSULR3",29,0)
 .. K VA
"RTN","PSULR3",30,0)
 .. S PSULC=$O(^XTMP(PSULRSUB,"RECORDS",PSUDIV,""),-1)+1
"RTN","PSULR3",31,0)
 .. S ^XTMP(PSULRSUB,"RECORDS",PSUDIV,PSULC)=PSUX
"RTN","PSULR3",32,0)
 ;
"RTN","PSULR3",33,0)
 Q
"RTN","PSULR3",34,0)
 ;
"RTN","PSULR3",35,0)
RECORD() ;EP  Construct mailing record
"RTN","PSULR3",36,0)
 ;3.2.11.42
"RTN","PSULR3",37,0)
 K PSUR
"RTN","PSULR3",38,0)
 S PSULRDT=9999999-PSUDT
"RTN","PSULR3",39,0)
 S X=^XTMP(PSULRSUB,"PATIENT",DFN,PSUND,PSUDT)
"RTN","PSULR3",40,0)
 S PSULRF=$S(X["^":$P(X,U,2),1:"") ; hi/low flag
"RTN","PSULR3",41,0)
 S PSULRR=$S(X["^":$P(X,U),1:X) ; test result
"RTN","PSULR3",42,0)
 S X=^XTMP(PSULRSUB,"PATIENT",DFN,PSUND)
"RTN","PSULR3",43,0)
 S PSULRT=$P(X,U) ; Lab Test name stored
"RTN","PSULR3",44,0)
 S PSULRU=$P(X,U,2) ; Units stored
"RTN","PSULR3",45,0)
 K PSUR
"RTN","PSULR3",46,0)
 S PSUR(2)=PSUDIV
"RTN","PSULR3",47,0)
 S PSUR(3)=$TR(VA("PID"),"-","")
"RTN","PSULR3",48,0)
 S X=$S(PSUPK="IV":4,PSUPK="UD":5,1:10)
"RTN","PSULR3",49,0)
 S PSUR(X)=PSUORD
"RTN","PSULR3",50,0)
 S PSUR(7)=PSUDRGN
"RTN","PSULR3",51,0)
 S PSUR(8)=$P(PSULRT,U)
"RTN","PSULR3",52,0)
 S PSUR(9)=PSULRR_" "_PSULRU
"RTN","PSULR3",53,0)
 S PSUR(10)=PSULRF
"RTN","PSULR3",54,0)
 S PSUR(11)=PSULRDT
"RTN","PSULR3",55,0)
 S PSUR=""
"RTN","PSULR3",56,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S PSUR(I)=$TR(PSUR(I),"^","'")
"RTN","PSULR3",57,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S $P(PSUR,U,I)=PSUR(I)
"RTN","PSULR3",58,0)
 S PSUR=PSUR_U
"RTN","PSULR3",59,0)
 ;  Store info for summary by patient
"RTN","PSULR3",60,0)
 S PSUTEST=PSULRT_U_PSUR(9)_U_PSULRDT_U_PSULRF ; test^result unit^date^flag
"RTN","PSULR3",61,0)
 S ^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN,PSUDRCD,PSUND)=PSUTEST
"RTN","PSULR3",62,0)
 Q PSUR
"RTN","PSULR4")
0^58^B11285075
"RTN","PSULR4",1,0)
PSULR4 ;BIR/PDW - PBMS LABORATORY EMAIL GENERATOR ;10 JUL 1999
"RTN","PSULR4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR4",3,0)
 ;
"RTN","PSULR4",4,0)
 ;DBIA(s)
"RTN","PSULR4",5,0)
 ; Reference to file  #4.3 supported by DBIA 2496,10091
"RTN","PSULR4",6,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSULR4",7,0)
 ;PSULC  = Line processing in ^tmp
"RTN","PSULR4",8,0)
 ;PSUTLC = Total Line count
"RTN","PSULR4",9,0)
 ;PSUMC  = Message counter
"RTN","PSULR4",10,0)
 ;PSUMLC = Message Line Counter
"RTN","PSULR4",11,0)
 ; RETURNS 
"RTN","PSULR4",12,0)
 ;PSUMSG("M") = # Messages
"RTN","PSULR4",13,0)
 ;PSUMSG("L") = # Lines
"RTN","PSULR4",14,0)
 ;
"RTN","PSULR4",15,0)
EN(PSUMSG) ;Scan and process for Division(s)
"RTN","PSULR4",16,0)
 ; PSUMSGT ("M")= # MESSAGES  ("L")= # LINES
"RTN","PSULR4",17,0)
 ;
"RTN","PSULR4",18,0)
 ;I '$G(PSUMASF) Q  ;Comment out so user can get detailed msg
"RTN","PSULR4",19,0)
 ;regardless of whether they send to Hines or not
"RTN","PSULR4",20,0)
 ;
"RTN","PSULR4",21,0)
 ;
"RTN","PSULR4",22,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSULR4",23,0)
 ; Scan TMP, split lines, transmit per MAX lines in Netmail
"RTN","PSULR4",24,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSULR4",25,0)
 S:PSUMAX'>0 PSUMAX=10000
"RTN","PSULR4",26,0)
 ;
"RTN","PSULR4",27,0)
 I '$D(^XTMP(PSULRSUB,"RECORDS")) G NODATA
"RTN","PSULR4",28,0)
DIV ;   Scan by division and send divisional messages
"RTN","PSULR4",29,0)
 ;
"RTN","PSULR4",30,0)
 S PSUDIV="" F  S PSUDIV=$O(^XTMP(PSULRSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D MSG
"RTN","PSULR4",31,0)
 Q
"RTN","PSULR4",32,0)
 ;
"RTN","PSULR4",33,0)
MSG ;EP Send divisional message
"RTN","PSULR4",34,0)
 ;   Split and store into ^XTMP(PSULRSUB,"MESSAGE",PSUMC,PSULC)
"RTN","PSULR4",35,0)
 K ^XTMP(PSULRSUB,"MESSAGE")
"RTN","PSULR4",36,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSULR4",37,0)
 F PSULC=1:1 S X=$G(^XTMP(PSULRSUB,"RECORDS",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSULR4",38,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSULR4",39,0)
 . I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSULR4",40,0)
 . I $L(X)<235 S ^XTMP(PSULRSUB,"MESSAGE",PSUMC,PSUMLC)=X Q
"RTN","PSULR4",41,0)
 . F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSULR4",42,0)
 . S ^XTMP(PSULRSUB,"MESSAGE",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSULR4",43,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSULR4",44,0)
 . S ^XTMP(PSULRSUB,"MESSAGE",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSULR4",45,0)
 ;
"RTN","PSULR4",46,0)
 ;   Count Lines sent
"RTN","PSULR4",47,0)
 S PSUTLC=0
"RTN","PSULR4",48,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSULRSUB,"MESSAGE",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSULR4",49,0)
 ;
"RTN","PSULR4",50,0)
 S PSUMSG(PSUDIV,13,"M")=+$G(PSUMSG(PSUDIV,13,"M"))+PSUMC
"RTN","PSULR4",51,0)
 S PSUMSG(PSUDIV,13,"L")=+$G(PSUMSG(PSUDIV,13,"L"))+PSUTLC
"RTN","PSULR4",52,0)
TRANS ;EP   Transmit Messages
"RTN","PSULR4",53,0)
VARS ; Setup variables for contents
"RTN","PSULR4",54,0)
 ;
"RTN","PSULR4",55,0)
 I $D(^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV)) D  Q
"RTN","PSULR4",56,0)
 .F PSUM=1:1:PSUMC D
"RTN","PSULR4",57,0)
 ..S PSUDIVNM=$P(^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV),U,1)
"RTN","PSULR4",58,0)
 ..S XMSUB="V. 4.0 PBMLR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR4",59,0)
 ..S XMDUZ=DUZ
"RTN","PSULR4",60,0)
 ..S XMTEXT="^XTMP(PSULRSUB,""MESSAGE"",PSUM,"
"RTN","PSULR4",61,0)
 ..M XMY=PSUXMYH
"RTN","PSULR4",62,0)
 ..S XMCHAN=1
"RTN","PSULR4",63,0)
 ..I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D
"RTN","PSULR4",64,0)
 ...I PSUSMRY'=1 D ^XMD
"RTN","PSULR4",65,0)
 ;
"RTN","PSULR4",66,0)
 ;    Loop through messages generated and transmit them
"RTN","PSULR4",67,0)
 F PSUM=1:1:PSUMC D
"RTN","PSULR4",68,0)
 . S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSULR4",69,0)
 . S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSULR4",70,0)
 . S XMSUB="V. 4.0 PBMLR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR4",71,0)
 . S XMDUZ=DUZ
"RTN","PSULR4",72,0)
 . S XMTEXT="^XTMP(PSULRSUB,""MESSAGE"",PSUM,"
"RTN","PSULR4",73,0)
 . M XMY=PSUXMYH
"RTN","PSULR4",74,0)
 . S XMCHAN=1
"RTN","PSULR4",75,0)
 . ;I $G(PSUMASF) D ^XMD
"RTN","PSULR4",76,0)
 . I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D
"RTN","PSULR4",77,0)
 ..I PSUSMRY'=1 D ^XMD
"RTN","PSULR4",78,0)
 ;
"RTN","PSULR4",79,0)
 Q
"RTN","PSULR4",80,0)
NODATA ;EP transmit NO DATA FOUND
"RTN","PSULR4",81,0)
 S X=$$VALI^PSUTL(4.3,1,217),PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSULR4",82,0)
 S PSUDIV=PSUSNDR
"RTN","PSULR4",83,0)
 S PSUMSG(PSUDIV,13,"M")=$G(PSUMASF),PSUMSG(PSUDIV,13,"L")=0
"RTN","PSULR4",84,0)
 S XMDUZ=DUZ
"RTN","PSULR4",85,0)
 M XMY=PSUXMYH
"RTN","PSULR4",86,0)
 S PSUM=1,PSUMC=1
"RTN","PSULR4",87,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSULR4",88,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSULR4",89,0)
 S XMSUB="V. 4.0 PBMLR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR4",90,0)
 S X(1)="No data to report"
"RTN","PSULR4",91,0)
 S XMTEXT="X("
"RTN","PSULR4",92,0)
 S XMCHAN=1
"RTN","PSULR4",93,0)
 I $G(PSUMASF)!$G(PSUPBMG)!$G(PSUDUZ) D ^XMD
"RTN","PSULR4",94,0)
 Q
"RTN","PSULR5")
0^59^B25893998
"RTN","PSULR5",1,0)
PSULR5 ;BIR/PDW - LAB extract summary message generator ;10 JUL 1999
"RTN","PSULR5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR5",3,0)
 ;DBIA(s)
"RTN","PSULR5",4,0)
 ; Reference to file 40.8 supported by DBIA 2438
"RTN","PSULR5",5,0)
 ;
"RTN","PSULR5",6,0)
EN ;EP generate Total & Cost summary
"RTN","PSULR5",7,0)
EN1 N PSUITT,PSUREC
"RTN","PSULR5",8,0)
 S:'$D(PSULRJOB) PSULRJOB=PSUJOB
"RTN","PSULR5",9,0)
 S:'$D(PSULRSUB) PSULRSUB="PSULR_"_PSULRJOB
"RTN","PSULR5",10,0)
 ;
"RTN","PSULR5",11,0)
 ;S PSUSDT=2970101
"RTN","PSULR5",12,0)
 ;S PSUEDT=2980501
"RTN","PSULR5",13,0)
 I '$D(^XTMP(PSULRSUB,"RECORDS")) G NODATA
"RTN","PSULR5",14,0)
DIV ;EP Loop by Division
"RTN","PSULR5",15,0)
 S PSUDIV="" F  S PSUDIV=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV)) Q:PSUDIV=""  D MESSAGE
"RTN","PSULR5",16,0)
 Q
"RTN","PSULR5",17,0)
 ;
"RTN","PSULR5",18,0)
MESSAGE ;EP Generate Summary Messages for a Division
"RTN","PSULR5",19,0)
 ;
"RTN","PSULR5",20,0)
 ;S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSULR5",21,0)
 ;S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSULR5",22,0)
MSG1 ;  Generate 1st summary message
"RTN","PSULR5",23,0)
 ;
"RTN","PSULR5",24,0)
 S PSUT=0,PSUP=0 ; test & patient counters
"RTN","PSULR5",25,0)
 ;   loop to get totals from records stored
"RTN","PSULR5",26,0)
 S DFN=0
"RTN","PSULR5",27,0)
 F  S DFN=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN)) Q:DFN'>0  S PSUP=PSUP+1 D
"RTN","PSULR5",28,0)
 . S PSUDC="" F  S PSUDC=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN,PSUDC)) Q:PSUDC=""  D
"RTN","PSULR5",29,0)
 .. S PSUND=0
"RTN","PSULR5",30,0)
 .. F  S PSUND=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN,PSUDC,PSUND)) Q:PSUND'>0  S PSUT=PSUT+1
"RTN","PSULR5",31,0)
 ;
"RTN","PSULR5",32,0)
 S XMDUZ=DUZ
"RTN","PSULR5",33,0)
 M XMY=PSUXMYS1
"RTN","PSULR5",34,0)
 ;
"RTN","PSULR5",35,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSULR5",36,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSULR5",37,0)
 N PSUMSG
"RTN","PSULR5",38,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSULR5",39,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSULR5",40,0)
 ;
"RTN","PSULR5",41,0)
 I $D(^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV)) D
"RTN","PSULR5",42,0)
 .;VMP OIFO BAY PINES;ELR;PSU*3.0*31
"RTN","PSULR5",43,0)
 .I '$L($P($G(^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV)),U,1)) Q
"RTN","PSULR5",44,0)
 .S PSUDIVNM=$P(^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV),U,1)
"RTN","PSULR5",45,0)
 ;
"RTN","PSULR5",46,0)
 S PSUMSG(1)="               Laboratory Statistical Summary"
"RTN","PSULR5",47,0)
 S PSUMSG(2)="               "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSULR5",48,0)
 S PSUMSG(3)="      "
"RTN","PSULR5",49,0)
 S PSUMSG(4)="Total Patients          "_PSUP
"RTN","PSULR5",50,0)
 S PSUMSG(5)="Total Laboratory Tests  "_PSUT
"RTN","PSULR5",51,0)
 S PSUMSG(6)="   "
"RTN","PSULR5",52,0)
 S XMSUB="V. 4.0 PBMLR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR5",53,0)
 S XMTEXT="PSUMSG("
"RTN","PSULR5",54,0)
 S XMCHAN=1
"RTN","PSULR5",55,0)
 D ^XMD
"RTN","PSULR5",56,0)
 M ^XTMP(PSULRSUB,"REPORT1",PSUDIV)=PSUMSG
"RTN","PSULR5",57,0)
 K PSUMSG
"RTN","PSULR5",58,0)
 ;
"RTN","PSULR5",59,0)
MSG2 ; SUMMARY BY PATIENT
"RTN","PSULR5",60,0)
 ;
"RTN","PSULR5",61,0)
 ;
"RTN","PSULR5",62,0)
 S PSUG="^XTMP(PSULRSUB,""REPORT2"",PSUDIV)"
"RTN","PSULR5",63,0)
 K @PSUG
"RTN","PSULR5",64,0)
 S @PSUG@(1)="               Laboratory Data Summary"
"RTN","PSULR5",65,0)
 S @PSUG@(2)="               "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSULR5",66,0)
 S @PSUG@(3)=" "
"RTN","PSULR5",67,0)
 S X="Patient SSN"
"RTN","PSULR5",68,0)
 S X=$$SETSTR^VALM1("VA CODE",X,15,7)
"RTN","PSULR5",69,0)
 S X=$$SETSTR^VALM1("Laboratory",X,24,10)
"RTN","PSULR5",70,0)
 S X=$$SETSTR^VALM1("Results",X,42,7)
"RTN","PSULR5",71,0)
 S X=$$SETSTR^VALM1("Flag",X,57,4)
"RTN","PSULR5",72,0)
 S X=$$SETSTR^VALM1("Date/Time Taken",X,63,15)
"RTN","PSULR5",73,0)
 S @PSUG@(4)=X
"RTN","PSULR5",74,0)
 S X="",$P(X,"-",79)=""
"RTN","PSULR5",75,0)
 S @PSUG@(5)=X
"RTN","PSULR5",76,0)
 S PSULC=5
"RTN","PSULR5",77,0)
 ;  loop records stored
"RTN","PSULR5",78,0)
 S DFN=0,DFN1="",PSUCD1=""
"RTN","PSULR5",79,0)
 F  S DFN=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN)) Q:DFN'>0  D  S DFN1=DFN
"RTN","PSULR5",80,0)
 . ;  loop drug codes
"RTN","PSULR5",81,0)
 . S PSUCD=""
"RTN","PSULR5",82,0)
 . F  S PSUCD=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN,PSUCD)) Q:PSUCD=""  D  S PSUCD1=PSUCD
"RTN","PSULR5",83,0)
 .. ; loop tests  
"RTN","PSULR5",84,0)
 .. S PSUND=0
"RTN","PSULR5",85,0)
 .. F  S PSUND=$O(^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN,PSUCD,PSUND)) Q:PSUND'>0  D SET
"RTN","PSULR5",86,0)
 ;
"RTN","PSULR5",87,0)
 S @PSUG@(PSULC+1)="   "
"RTN","PSULR5",88,0)
 S XMSUB="V. 4.0 PBMLR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR5",89,0)
 S XMTEXT="^XTMP(PSULRSUB,""REPORT2"",PSUDIV,"
"RTN","PSULR5",90,0)
 S XMCHAN=1
"RTN","PSULR5",91,0)
 M XMY=PSUXMYS2
"RTN","PSULR5",92,0)
 I '$G(PSUSMRY) D ^XMD
"RTN","PSULR5",93,0)
 Q
"RTN","PSULR5",94,0)
 ;
"RTN","PSULR5",95,0)
SET ;EP  Set data into message
"RTN","PSULR5",96,0)
 ;
"RTN","PSULR5",97,0)
 S X=^XTMP(PSULRSUB,"SUMMARY",PSUDIV,DFN,PSUCD,PSUND)
"RTN","PSULR5",98,0)
 S PSULRT=$P(X,U),PSULRR=$P(X,U,2)
"RTN","PSULR5",99,0)
 S PSULD=$P(X,U,3),PSULRF=$P(X,U,4)
"RTN","PSULR5",100,0)
 S PSULD0=$E(PSULD,4,5)_"/"_$E(PSULD,6,7)_"/"_$E(PSULD,2,3)
"RTN","PSULR5",101,0)
 S X=$P(PSULD,".",2),X=$E(X,1,4) F  Q:$L(X)=4  S X=X_0 ; fill time
"RTN","PSULR5",102,0)
 S PSULD=PSULD0_" "_X
"RTN","PSULR5",103,0)
 S X=""
"RTN","PSULR5",104,0)
 I DFN=DFN1
"RTN","PSULR5",105,0)
 E  D PID^VADPT S X=$TR(VA("PID"),"-",""),DFN1=DFN,PSUCD1="" K VA
"RTN","PSULR5",106,0)
 I PSUCD1=PSUCD
"RTN","PSULR5",107,0)
 E  S X=$$SETSTR^VALM1(PSUCD,X,15,5) S PSUCD1=PSUCD
"RTN","PSULR5",108,0)
 S X=$$SETSTR^VALM1(PSULRT,X,24,$L(PSULRT))
"RTN","PSULR5",109,0)
 S X=$$SETSTR^VALM1(PSULRR,X,42,$L(PSULRR))
"RTN","PSULR5",110,0)
 S X=$$SETSTR^VALM1(PSULRF,X,57,$L(PSULRF))
"RTN","PSULR5",111,0)
 S X=$$SETSTR^VALM1(PSULD,X,63,$L(PSULD))
"RTN","PSULR5",112,0)
 S PSULC=PSULC+1
"RTN","PSULR5",113,0)
 S @PSUG@(PSULC)=X
"RTN","PSULR5",114,0)
 ;
"RTN","PSULR5",115,0)
 Q
"RTN","PSULR5",116,0)
NODATA ;EP SEND NO DATA MESSAGE
"RTN","PSULR5",117,0)
 S XMDUZ=DUZ
"RTN","PSULR5",118,0)
 M XMY=PSUXMYS1
"RTN","PSULR5",119,0)
 ;
"RTN","PSULR5",120,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSULR5",121,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSULR5",122,0)
 S PSUDIV=PSUSNDR
"RTN","PSULR5",123,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSULR5",124,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSULR5",125,0)
 S XMSUB="V. 4.0 PBMLR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR5",126,0)
 S XMTEXT="^XTMP(PSULRSUB,""REPORT2"",PSUDIV,"
"RTN","PSULR5",127,0)
 S XMCHAN=1
"RTN","PSULR5",128,0)
 K X
"RTN","PSULR5",129,0)
 S X(1)="               Laboratory Statistical Summary"
"RTN","PSULR5",130,0)
 S X(2)="               "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSULR5",131,0)
 S X(3)="    "
"RTN","PSULR5",132,0)
 S X(4)="No data to report"
"RTN","PSULR5",133,0)
 S X(5)="     "
"RTN","PSULR5",134,0)
 S XMTEXT="X("
"RTN","PSULR5",135,0)
 S:$G(PSUDUZ) XMY(PSUDUZ)=""
"RTN","PSULR5",136,0)
 D ^XMD
"RTN","PSULR5",137,0)
 M ^XTMP(PSULRSUB,"REPORT1",PSUDIV)=X
"RTN","PSULR5",138,0)
 S XMSUB="V. 4.0 PBMPR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSULR5",139,0)
 S X(1)="               Laboratory Data Summary"
"RTN","PSULR5",140,0)
 M ^XTMP(PSULRSUB,"REPORT2",PSUDIV)=X ;store for print cycle
"RTN","PSULR5",141,0)
 Q
"RTN","PSULR6")
0^60^B2906488
"RTN","PSULR6",1,0)
PSULR6 ;BIR/PDW - PBM Laboratory Printer Controller ;25 AUG 1998
"RTN","PSULR6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSULR6",3,0)
EN ;EP for printing reports      
"RTN","PSULR6",4,0)
 S PSUPG=0
"RTN","PSULR6",5,0)
 S PSULRJOB=PSUJOB
"RTN","PSULR6",6,0)
 S PSULRSUB="PSULR_"_PSULRJOB
"RTN","PSULR6",7,0)
DIVISION ;EP loop by divisions
"RTN","PSULR6",8,0)
 S PSUDIV="" F  S PSUDIV=$O(^XTMP(PSULRSUB,"REPORT1",PSUDIV)) Q:PSUDIV=""  D REPORT
"RTN","PSULR6",9,0)
 Q
"RTN","PSULR6",10,0)
 ;
"RTN","PSULR6",11,0)
REPORT ;EP Perform Prints COUNTS & PATIENTS for Division
"RTN","PSULR6",12,0)
 ;
"RTN","PSULR6",13,0)
 ;
"RTN","PSULR6",14,0)
 ; Printing Device should be opened by PSUDBQUE by now & IO set
"RTN","PSULR6",15,0)
 I $Y>5 U IO W @IOF
"RTN","PSULR6",16,0)
 S L="" F  S L=$O(^XTMP(PSULRSUB,"REPORT1",PSUDIV,L)) Q:L=""  S X=^(L) U IO W !,X I L=2 W !,?60,"PAGE: 1"
"RTN","PSULR6",17,0)
 U IO W !!,@IOF
"RTN","PSULR6",18,0)
 ;
"RTN","PSULR6",19,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*32
"RTN","PSULR6",20,0)
 I (($E($G(IOST))="P")&($G(IOST)'["P-MESS")) Q
"RTN","PSULR6",21,0)
REPORT2 ; Print Report 2
"RTN","PSULR6",22,0)
 S PSUPG("PG")=1
"RTN","PSULR6",23,0)
 D PGHDR
"RTN","PSULR6",24,0)
 S L=5 F  S L=$O(^XTMP(PSULRSUB,"REPORT2",PSUDIV,L)) Q:L=""  S X=^(L) U IO W !,X I $Y+4>IOSL D PG Q:$G(PSUQUIT)
"RTN","PSULR6",25,0)
 W !!
"RTN","PSULR6",26,0)
 Q
"RTN","PSULR6",27,0)
PG ;EP  Page controller
"RTN","PSULR6",28,0)
 S PSUQUIT=0
"RTN","PSULR6",29,0)
 I $Y<(IOSL-4) Q
"RTN","PSULR6",30,0)
 S:'$D(PSUPG("PG")) PSUPG("PG")=0 S PSUPG("PG")=PSUPG("PG")+1
"RTN","PSULR6",31,0)
 I $E(IOST)="C" K DIR S DIR(0)="E" D ^DIR I ($G(DIROUT)!$G(DUOUT)!$G(DTOUT)!$G(DROUT)) S PSUQUIT=1
"RTN","PSULR6",32,0)
 U IO W @IOF
"RTN","PSULR6",33,0)
 ;
"RTN","PSULR6",34,0)
PGHDR ; Write Page Header (SUBJECT of MAILMESSAGE)
"RTN","PSULR6",35,0)
 F I=1,2 W !,^XTMP(PSULRSUB,"REPORT2",PSUDIV,I)
"RTN","PSULR6",36,0)
 W !,?60,"PAGE: ",PSUPG("PG")
"RTN","PSULR6",37,0)
 F I=3:1:5 I $D(^XTMP(PSULRSUB,"REPORT2",PSUDIV,I)) W !,^(I)
"RTN","PSULR6",38,0)
 Q
"RTN","PSUMAP0")
0^63^B34947359
"RTN","PSUMAP0",1,0)
PSUMAP0 ;BHM/PDW-MAP OAU,NAOU,DA LOCATION TO DIVISION/OUTPATIENT SITES ; 9SEP2003
"RTN","PSUMAP0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUMAP0",3,0)
 ;
"RTN","PSUMAP0",4,0)
 ;DBIA's
"RTN","PSUMAP0",5,0)
 ;Reference to file (#59.7) supported by DBIA 2854
"RTN","PSUMAP0",6,0)
 ;
"RTN","PSUMAP0",7,0)
EN ; select Editing or Report of Mapping
"RTN","PSUMAP0",8,0)
 W @IOF,!,?10,"MAPPING PHARMACY LOCATIONS FOR PBM EXTRACTS",!!
"RTN","PSUMAP0",9,0)
 ;
"RTN","PSUMAP0",10,0)
MODP ; module selection prompt
"RTN","PSUMAP0",11,0)
 W !!,?5,"This option allows the mapping of dispensing/procurement locations"
"RTN","PSUMAP0",12,0)
 W !,?5,"from the AR/WS, Controlled Substances, and Drug Accountability"
"RTN","PSUMAP0",13,0)
 W !,?5,"applications to either a Medical Center Division or an Outpatient Site."
"RTN","PSUMAP0",14,0)
 W !,?5,"Any dispensing/procurement data associated with an AR/WS AOU, CS NAOU"
"RTN","PSUMAP0",15,0)
 W !,?5,"or DA Pharmacy Location that has not been mapped will be attributed to"
"RTN","PSUMAP0",16,0)
 W !,?5,"to the facility at which the database resides.  Any unmapped locations"
"RTN","PSUMAP0",17,0)
 W !,?5,"will be displayed upon entering the option.",!
"RTN","PSUMAP0",18,0)
 ;
"RTN","PSUMAP0",19,0)
 D EN1^PSUMAPR ;scan and report unmapped locations
"RTN","PSUMAP0",20,0)
 W @IOF
"RTN","PSUMAP0",21,0)
 ;
"RTN","PSUMAP0",22,0)
MODULE ;
"RTN","PSUMAP0",23,0)
 W !!,"Select the dispensing/procurement location to map:",!
"RTN","PSUMAP0",24,0)
 S PSUA(1)="1.  AR/WS Area of Use (AOU)"
"RTN","PSUMAP0",25,0)
 S PSUA(2)="2.  Controlled Substances (CS) Narcotic Area of Use (NAOU)"
"RTN","PSUMAP0",26,0)
 S PSUA(3)="3.  Drug Accountability (DA) Pharmacy location"
"RTN","PSUMAP0",27,0)
 S PSUA(4)="4.  Print Report of Mapped/Unmapped Locations"
"RTN","PSUMAP0",28,0)
 F I=1:1:4 W !,?10,PSUA(I)
"RTN","PSUMAP0",29,0)
 W !!,?2,"You may select all by entering 'A' for ALL or by using '1:4'.",!
"RTN","PSUMAP0",30,0)
 W !,?2,"Select the dispensing/procurement location: "
"RTN","PSUMAP0",31,0)
 R X:DTIME E  W !!,"Nothing Selected - Exiting",! H 3 G EXIT
"RTN","PSUMAP0",32,0)
 I X["^" G EXIT:X="^"
"RTN","PSUMAP0",33,0)
 I X="" W "  <??>",$C(7) S X="?"
"RTN","PSUMAP0",34,0)
 ;
"RTN","PSUMAP0",35,0)
 S:"Aa"[$E(X) X="1:4"
"RTN","PSUMAP0",36,0)
MODHLP I X["?" D  G MODULE
"RTN","PSUMAP0",37,0)
 .W !!,"Enter:  A single number to edit (or print) that selection."
"RTN","PSUMAP0",38,0)
 .W !,?8,"A range of code numbers.  Example:  1:3"
"RTN","PSUMAP0",39,0)
 .W !,?8,"Multiple code numbers separated by commas.  Example:  1,3"
"RTN","PSUMAP0",40,0)
 .W !,?8,"The letter A to select ALL items."
"RTN","PSUMAP0",41,0)
 .W !,?8,"A single up-arrow ( ^ ) to exit now without any action."
"RTN","PSUMAP0",42,0)
 S X=$TR(X,"-;_><.A","::::::")
"RTN","PSUMAP0",43,0)
 K PSUMOD
"RTN","PSUMAP0",44,0)
 F PII=1:1:$L(X,",") D
"RTN","PSUMAP0",45,0)
 .S X1=$P(X,",",PII)
"RTN","PSUMAP0",46,0)
 .Q:X1=""
"RTN","PSUMAP0",47,0)
 .I X1[":" D  Q
"RTN","PSUMAP0",48,0)
 ..S XBEG=$P(X1,":",1),XEND=$P(X1,":",2)
"RTN","PSUMAP0",49,0)
 ..I (XBEG="")!(XEND="") Q
"RTN","PSUMAP0",50,0)
 ..F PJJ=XBEG:1:XEND S PSUMOD(PJJ)=""
"RTN","PSUMAP0",51,0)
 ..K PJJ,XBEG,XEND
"RTN","PSUMAP0",52,0)
 .S PSUMOD(X1)=""
"RTN","PSUMAP0",53,0)
 S (X,ERC)=0 F  S X=$O(PSUMOD(X)) Q:X=""  I '$D(PSUA(X)) S ERC=1 Q
"RTN","PSUMAP0",54,0)
 I ERC W !!,"<INVALID CHOICE - ",X,", TRY AGAIN>",$C(7) G MODP
"RTN","PSUMAP0",55,0)
 I '$D(PSUMOD) W !!,"No choices were made." K DIR S DIR(0)="E",DIR("A")="EXITING" D ^DIR G EXIT
"RTN","PSUMAP0",56,0)
 ;
"RTN","PSUMAP0",57,0)
 ;
"RTN","PSUMAP0",58,0)
 W !!,"You have selected: "
"RTN","PSUMAP0",59,0)
 S X="",PSUOPTS="" F  S X=$O(PSUMOD(X)) Q:X=""  W !,?10,PSUA(X)
"RTN","PSUMAP0",60,0)
 W ! K DIR S DIR(0)="E" D ^DIR G:'Y EXIT
"RTN","PSUMAP0",61,0)
 I $D(PSUMOD(4)) D REPORT K PSUA(4)
"RTN","PSUMAP0",62,0)
 I $D(PSUMOD(1)) D E9001
"RTN","PSUMAP0",63,0)
 I $D(PSUMOD(2)) D E9002
"RTN","PSUMAP0",64,0)
 I $D(PSUMOD(3)) D E9003
"RTN","PSUMAP0",65,0)
 Q
"RTN","PSUMAP0",66,0)
E9001 ;EDIT 90.01 AR/WS AOU MAPPING
"RTN","PSUMAP0",67,0)
 W @IOF,!!,?20,"EDITING Mapping of AR/WS AOUs",!!
"RTN","PSUMAP0",68,0)
 K DIC,DA,DIE
"RTN","PSUMAP0",69,0)
 K Z,ZZ,IENS
"RTN","PSUMAP0",70,0)
 S DA(1)=1
"RTN","PSUMAP0",71,0)
 S DIC="^PS(59.7,1,90.01,",DA(1)=1,DIC(0)="ACEQML"
"RTN","PSUMAP0",72,0)
 S DIC("W")="X XX1,XX2"
"RTN","PSUMAP0",73,0)
 S XX1="S IENS=+Y_"",""_DA(1) S Z=$$GET1^DIQ(59.79001,IENS,.02),ZZ=$$GET1^DIQ(59.79001,IENS,.03) W:$L(Z) ?35,""Div: "",Z W:$L(ZZ) ?35,""OP:  "",ZZ"
"RTN","PSUMAP0",74,0)
 S XX2="S ZZ=$$GET1^DIQ(58.1,+Y,3,""I"") W:ZZ ?65,""**INACTIVE**"""
"RTN","PSUMAP0",75,0)
 D ^DIC
"RTN","PSUMAP0",76,0)
 Q:Y'>0
"RTN","PSUMAP0",77,0)
 S DA=+Y,DIE=DIC
"RTN","PSUMAP0",78,0)
 S ZZ=^PS(59.7,1,90.01,DA,0),XX=$P(ZZ,U,2),YY=$P(ZZ,U,3)
"RTN","PSUMAP0",79,0)
 I YY S DR=".01;.03;S:X'="""" Y=0;.02" I 1
"RTN","PSUMAP0",80,0)
 E  S DR=".01;.02;S:X'="""" Y=0;.03"
"RTN","PSUMAP0",81,0)
 D ^DIE W !
"RTN","PSUMAP0",82,0)
 G E9001
"RTN","PSUMAP0",83,0)
 ;
"RTN","PSUMAP0",84,0)
CHK1 ;check that AOUs are mapped
"RTN","PSUMAP0",85,0)
 K IENS
"RTN","PSUMAP0",86,0)
 S DA=0,DA(1)=1 F  S DA=$O(^PS(59.7,1,90.01,DA)) Q:DA'>0  D
"RTN","PSUMAP0",87,0)
 . S Z=^PS(59.7,1,90.01,DA,0),X=$P(Z,U,2),Y=$P(Z,U,3)
"RTN","PSUMAP0",88,0)
 . I Y,'X Q
"RTN","PSUMAP0",89,0)
 . I 'Y,X Q
"RTN","PSUMAP0",90,0)
 . S IENS=DA_",1" W !,?3,"AR/WS AOU",?15,$$GET1^DIQ(59.79001,IENS,.01),?25," is not mapped."
"RTN","PSUMAP0",91,0)
 I $G(STOP),$G(IENS) K DIR S DIR(0)="E" D ^DIR I X="^" S PSUSTOP=1 I 1
"RTN","PSUMAP0",92,0)
 Q
"RTN","PSUMAP0",93,0)
 ;
"RTN","PSUMAP0",94,0)
E9002 ;EDIT 90.02 CS NAOU MAPPING
"RTN","PSUMAP0",95,0)
 W @IOF,!!,?20,"EDITING Mapping of CS NAOUs",!!
"RTN","PSUMAP0",96,0)
 K DIC,DA,DIE
"RTN","PSUMAP0",97,0)
 K Z,ZZ,IENS
"RTN","PSUMAP0",98,0)
 S DA(1)=1
"RTN","PSUMAP0",99,0)
 S DIC="^PS(59.7,DA(1),90.02,",DIC(0)="AEQMLCZ"
"RTN","PSUMAP0",100,0)
 S DIC("W")="X XX1,XX2"
"RTN","PSUMAP0",101,0)
 S XX1="S IENS=+Y_"",""_DA(1) S Z=$$GET1^DIQ(59.79002,IENS,.02),ZZ=$$GET1^DIQ(59.79002,IENS,.03) W:$L(Z) ?35,""Div: "",Z W:$L(ZZ) ?35,""OP:  "",ZZ"
"RTN","PSUMAP0",102,0)
 S XX2="S ZZ=$$GET1^DIQ(58.8,+Y,4,""I"") W:ZZ ?65,""**INACTIVE** """
"RTN","PSUMAP0",103,0)
 D ^DIC
"RTN","PSUMAP0",104,0)
 Q:Y'>0
"RTN","PSUMAP0",105,0)
 S DA=+Y,DIE=DIC
"RTN","PSUMAP0",106,0)
 S ZZ=^PS(59.7,1,90.02,DA,0),XX=$P(ZZ,U,2),YY=$P(ZZ,U,3)
"RTN","PSUMAP0",107,0)
 I YY S DR=".01;.03;S:X'="""" Y=0;.02" I 1
"RTN","PSUMAP0",108,0)
 E  S DR=".01;.02;S:X'="""" Y=0;.03"
"RTN","PSUMAP0",109,0)
 D ^DIE W !
"RTN","PSUMAP0",110,0)
 G E9002
"RTN","PSUMAP0",111,0)
 ;
"RTN","PSUMAP0",112,0)
CHK2 ;check that NAOUs are mapped
"RTN","PSUMAP0",113,0)
 K IENS
"RTN","PSUMAP0",114,0)
 S DA=0,DA(1)=1 F  S DA=$O(^PS(59.7,1,90.02,DA)) Q:DA'>0  D
"RTN","PSUMAP0",115,0)
 . S Z=^PS(59.7,1,90.02,DA,0),X=$P(Z,U,2),Y=$P(Z,U,3)
"RTN","PSUMAP0",116,0)
 . I Y,'X Q
"RTN","PSUMAP0",117,0)
 . I 'Y,X Q
"RTN","PSUMAP0",118,0)
 . S IENS=DA_",1" W !,?3,"CS NAOU",?15,$$GET1^DIQ(59.79002,IENS,.01),?25," is not mapped."
"RTN","PSUMAP0",119,0)
 Q
"RTN","PSUMAP0",120,0)
E9003 ;EDIT 90.03 DRUG ACCOUNTABILITY LOCATION MAPPING
"RTN","PSUMAP0",121,0)
 W @IOF,!!,?20,"EDITING Mapping of DA Pharmacy Locations",!!
"RTN","PSUMAP0",122,0)
 K DIC,DA,DIE
"RTN","PSUMAP0",123,0)
 K Z,ZZ,IENS
"RTN","PSUMAP0",124,0)
 S DA(1)=1
"RTN","PSUMAP0",125,0)
 S DIC="^PS(59.7,DA(1),90.03,",DIC(0)="AEQMLZ"
"RTN","PSUMAP0",126,0)
 S DIC("W")="X XX1,XX2"
"RTN","PSUMAP0",127,0)
 S XX1="S IENS=+Y_"",""_DA(1) S Z=$$GET1^DIQ(59.79003,IENS,.02),ZZ=$$GET1^DIQ(59.79003,IENS,.03) W:$L(Z) ?35,"" Div: "",Z W:$L(ZZ) ?35,""OP:  "",ZZ"
"RTN","PSUMAP0",128,0)
 S XX2="S ZZ=$$GET1^DIQ(58.8,+Y,4,""I"") W:ZZ ?65,""**INACTIVE** """
"RTN","PSUMAP0",129,0)
 D ^DIC
"RTN","PSUMAP0",130,0)
 Q:Y'>0
"RTN","PSUMAP0",131,0)
 S DA=+Y,DIE=DIC
"RTN","PSUMAP0",132,0)
 S ZZ=^PS(59.7,1,90.03,DA,0),XX=$P(ZZ,U,2),YY=$P(ZZ,U,3)
"RTN","PSUMAP0",133,0)
 I YY S DR=".01;.03;S:X'="""" Y=0;.02" I 1
"RTN","PSUMAP0",134,0)
 E  S DR=".01;.02;S:X'="""" Y=0;.03"
"RTN","PSUMAP0",135,0)
 D ^DIE W !
"RTN","PSUMAP0",136,0)
 G E9003
"RTN","PSUMAP0",137,0)
 ;
"RTN","PSUMAP0",138,0)
CHK3 ;check that DRUG ACCOUNTABILITY LOCATIONs are mapped
"RTN","PSUMAP0",139,0)
 K IENS
"RTN","PSUMAP0",140,0)
 S DA=0,DA(1)=1 F  S DA=$O(^PS(59.7,1,90.03,DA)) Q:DA'>0  D
"RTN","PSUMAP0",141,0)
 . S Z=^PS(59.7,1,90.03,DA,0),X=$P(Z,U,2),Y=$P(Z,U,3)
"RTN","PSUMAP0",142,0)
 . I Y,'X Q
"RTN","PSUMAP0",143,0)
 . I 'Y,X Q
"RTN","PSUMAP0",144,0)
 . S IENS=DA_",1" W !,?3,"DA Phar Loc",?15,$$GET1^DIQ(59.79003,IENS,.01),?25," is not mapped."
"RTN","PSUMAP0",145,0)
 I $G(STOP),$G(IENS) K DIR S DIR(0)="E" D ^DIR I X="^" S PSUSTOP=1 I 1
"RTN","PSUMAP0",146,0)
 Q
"RTN","PSUMAP0",147,0)
REPORT ;Print Mapping Report
"RTN","PSUMAP0",148,0)
 W @IOF,!,"Print Pharmacy Location PBM Extract Mapping Report",!
"RTN","PSUMAP0",149,0)
 S %ZIS="Q" D ^%ZIS
"RTN","PSUMAP0",150,0)
 Q:POP
"RTN","PSUMAP0",151,0)
 I $D(IO("Q")) D QUEUE Q
"RTN","PSUMAP0",152,0)
 D EN^PSUMAPR
"RTN","PSUMAP0",153,0)
 Q
"RTN","PSUMAP0",154,0)
QUEUE S ZTRTN="EN^PSUMAPR",ZTDESC="PRINT REPORT OF PBM EXTRACT MAPPING"
"RTN","PSUMAP0",155,0)
 S ZTREQ="@" D ^%ZTLOAD
"RTN","PSUMAP0",156,0)
 W !,"TASKED with ",$G(ZTSK) I '$G(ZTSK) W ">> DID NOT Task !!",! H 3
"RTN","PSUMAP0",157,0)
 Q
"RTN","PSUMAP0",158,0)
EXIT ;
"RTN","PSUMAP0",159,0)
 Q
"RTN","PSUMAPR")
0^64^B39514670
"RTN","PSUMAPR",1,0)
PSUMAPR ;BHM/PDW-REPORT OF MAP OAU,NAOU,DA LOCATION TO DIVISION/OUTPATIENT SITES ; 9SEP2003
"RTN","PSUMAPR",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUMAPR",3,0)
 ;
"RTN","PSUMAPR",4,0)
 ;DBIA's
"RTN","PSUMAPR",5,0)
 ; Reference to file (#58.1) supported by DBIA 2515
"RTN","PSUMAPR",6,0)
 ; Reference to file (#58.8) supported by DBIA 2519
"RTN","PSUMAPR",7,0)
 ; Reference to file (#59.7)  supported by DBIA 2854
"RTN","PSUMAPR",8,0)
 ;
"RTN","PSUMAPR",9,0)
EN ; select Editing or Report of Mapping
"RTN","PSUMAPR",10,0)
 N C
"RTN","PSUMAPR",11,0)
 K PG,LINE,LINE2
"RTN","PSUMAPR",12,0)
 S PSQUIT=0,HDR="",$P(LINE,"=",79)="",$P(LINE2,"-",15)=""
"RTN","PSUMAPR",13,0)
 D PGH
"RTN","PSUMAPR",14,0)
AOU S HDR="AR/WS AOU" D PGH1
"RTN","PSUMAPR",15,0)
 S C=0
"RTN","PSUMAPR",16,0)
 S PSNM="" F  S PSNM=$O(^PSI(58.1,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",17,0)
 . S PSDA=0 F  S PSDA=$O(^PSI(58.1,"B",PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",18,0)
 .. D BRK Q:PSQUIT
"RTN","PSUMAPR",19,0)
 .. S C=C+1
"RTN","PSUMAPR",20,0)
 .. W !,PSNM
"RTN","PSUMAPR",21,0)
 .. S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79001,IEN,.02),PSOP=$$GET1^DIQ(59.79001,IEN,.03) W:$L(PSDIV) ?30,"Div: ",PSDIV W:$L(PSOP) ?30,"Op:  ",PSOP
"RTN","PSUMAPR",22,0)
 .. S PSINADT=$$GET1^DIQ(58.1,PSDA,3,"I") I PSINADT W ?60,$$FMTE^XLFDT(PSINADT,"D")
"RTN","PSUMAPR",23,0)
 W !
"RTN","PSUMAPR",24,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",25,0)
 ;
"RTN","PSUMAPR",26,0)
NAOU ;CS NAOU  Drug Accountability 'Primary
"RTN","PSUMAPR",27,0)
 Q:PSQUIT
"RTN","PSUMAPR",28,0)
 S HDR="CS NAOU" D PGH1
"RTN","PSUMAPR",29,0)
 S C=0
"RTN","PSUMAPR",30,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",31,0)
 . S PSDA=0 F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:PSDA'>0  D
"RTN","PSUMAPR",32,0)
 .. S PSN0=^PSD(58.8,PSDA,0),PSTYP=$P(PSN0,U,2),PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",33,0)
 .. I PSTYP="P" Q
"RTN","PSUMAPR",34,0)
 .. D BRK Q:PSQUIT
"RTN","PSUMAPR",35,0)
 .. S C=C+1
"RTN","PSUMAPR",36,0)
 .. W !,PSNM
"RTN","PSUMAPR",37,0)
 .. S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79002,IEN,.02),PSOP=$$GET1^DIQ(59.79002,IEN,.03) W:$L(PSDIV) ?30,"Div: ",PSDIV W:$L(PSOP) ?30,"Op:  ",PSOP
"RTN","PSUMAPR",38,0)
 .. S PSINADT=$$GET1^DIQ(58.8,PSDA,4,"I")
"RTN","PSUMAPR",39,0)
 .. I PSINADT W ?60,$$FMTE^XLFDT(PSINADT,"D")
"RTN","PSUMAPR",40,0)
 W !
"RTN","PSUMAPR",41,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",42,0)
 ;
"RTN","PSUMAPR",43,0)
DRACC ;
"RTN","PSUMAPR",44,0)
 Q:PSQUIT
"RTN","PSUMAPR",45,0)
 S HDR="DRUG ACCOUNTABILITY"
"RTN","PSUMAPR",46,0)
 D PGH1
"RTN","PSUMAPR",47,0)
 S C=0
"RTN","PSUMAPR",48,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",49,0)
 . S PSDA=0 F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:'PSDA  D
"RTN","PSUMAPR",50,0)
 .. S PSN0=^PSD(58.8,PSDA,0),PSTYP=$P(PSN0,U,2)
"RTN","PSUMAPR",51,0)
 .. S PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",52,0)
 .. I PSTYP='"P" Q
"RTN","PSUMAPR",53,0)
 .. D BRK Q:PSQUIT
"RTN","PSUMAPR",54,0)
 .. S C=C+1
"RTN","PSUMAPR",55,0)
 .. W !,PSNM
"RTN","PSUMAPR",56,0)
 .. S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79002,IEN,.02),PSOP=$$GET1^DIQ(59.79002,IEN,.03) W:$L(PSDIV) ?30,"Div: ",PSDIV W:$L(PSOP) ?30,"Op:  ",PSOP
"RTN","PSUMAPR",57,0)
 .. S PSINADT=$$GET1^DIQ(58.8,PSDA,4,"I")
"RTN","PSUMAPR",58,0)
 .. I PSINADT W ?60,$$FMTE^XLFDT(PSINADT,"D")
"RTN","PSUMAPR",59,0)
 ;
"RTN","PSUMAPR",60,0)
 I $E(IOST)="C" W !! K DIR S DIR(0)="EA",DIR("A")="Report Finished <cr>" D ^DIR
"RTN","PSUMAPR",61,0)
 Q
"RTN","PSUMAPR",62,0)
EN1 ;Scan for unmapped locations
"RTN","PSUMAPR",63,0)
 ;Called from PSUOP0
"RTN","PSUMAPR",64,0)
 ;
"RTN","PSUMAPR",65,0)
 N PSULOC,PSULOC1,PSULOC2
"RTN","PSUMAPR",66,0)
 S PSQUIT=0
"RTN","PSUMAPR",67,0)
 D AOU1       ;Look for AR/WS AOU's
"RTN","PSUMAPR",68,0)
 D NAOU1      ;Look for CS NAOU's
"RTN","PSUMAPR",69,0)
 D DRACC1     ;Look for Drug Accountability Pharmacy Locations
"RTN","PSUMAPR",70,0)
 D UNMAPD
"RTN","PSUMAPR",71,0)
 D MAPD
"RTN","PSUMAPR",72,0)
 Q
"RTN","PSUMAPR",73,0)
 ; 
"RTN","PSUMAPR",74,0)
AOU1 ;Find AR/WS AOU's and set unmapped locations into AOU array
"RTN","PSUMAPR",75,0)
 ;
"RTN","PSUMAPR",76,0)
 S PSULOC=" AR/WS AOU's "
"RTN","PSUMAPR",77,0)
 ;
"RTN","PSUMAPR",78,0)
 K AOU
"RTN","PSUMAPR",79,0)
 S PSNM="" F  S PSNM=$O(^PSI(58.1,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",80,0)
 .S PSDA=0 F  S PSDA=$O(^PSI(58.1,"B",PSNM,PSDA)) Q:PSDA'>0  D
"RTN","PSUMAPR",81,0)
 ..S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79001,IEN,.02)
"RTN","PSUMAPR",82,0)
 ..S PSOP=$$GET1^DIQ(59.79001,IEN,.03)
"RTN","PSUMAPR",83,0)
 ..I '$L(PSDIV),'$L(PSOP) S AOU(PSNM,PSDA)=$$GET1^DIQ(58.1,PSDA,3)
"RTN","PSUMAPR",84,0)
 Q
"RTN","PSUMAPR",85,0)
 ;
"RTN","PSUMAPR",86,0)
NAOU1 ;Find Controlled Substances AOU's and set unmapped locations
"RTN","PSUMAPR",87,0)
 ;into NAOU array
"RTN","PSUMAPR",88,0)
 ;
"RTN","PSUMAPR",89,0)
 S PSULOC1=" CS NAOUs "
"RTN","PSUMAPR",90,0)
 ;
"RTN","PSUMAPR",91,0)
 K NAOU
"RTN","PSUMAPR",92,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",93,0)
 .S PSDA=0
"RTN","PSUMAPR",94,0)
 .F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:PSDA'>0  D
"RTN","PSUMAPR",95,0)
 ..S PSN0=^PSD(58.8,PSDA,0)
"RTN","PSUMAPR",96,0)
 ..S PSTYP=$P(PSN0,U,2)
"RTN","PSUMAPR",97,0)
 ..S PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",98,0)
 ..I PSTYP="P" Q
"RTN","PSUMAPR",99,0)
 ..S IEN=PSDA_",1"
"RTN","PSUMAPR",100,0)
 ..S PSDIV=$$GET1^DIQ(59.79002,IEN,.02)
"RTN","PSUMAPR",101,0)
 ..S PSOP=$$GET1^DIQ(59.79002,IEN,.03)
"RTN","PSUMAPR",102,0)
 ..I '$L(PSDIV),'$L(PSOP) S NAOU(PSNM,PSDA)=$$GET1^DIQ(58.8,PSDA,4)
"RTN","PSUMAPR",103,0)
 Q
"RTN","PSUMAPR",104,0)
 ;
"RTN","PSUMAPR",105,0)
DRACC1 ;Find DA Pharmacy Locations and set unmapped locations into DRAC array
"RTN","PSUMAPR",106,0)
 ;
"RTN","PSUMAPR",107,0)
 S PSULOC2=" DA Pharmacy Locations "
"RTN","PSUMAPR",108,0)
 ;
"RTN","PSUMAPR",109,0)
 K DRAC
"RTN","PSUMAPR",110,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",111,0)
 .S PSDA=0
"RTN","PSUMAPR",112,0)
 .F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:'PSDA  D
"RTN","PSUMAPR",113,0)
 ..S PSN0=^PSD(58.8,PSDA,0),PSTYP=$P(PSN0,U,2)
"RTN","PSUMAPR",114,0)
 ..S PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",115,0)
 ..I PSTYP='"P" Q
"RTN","PSUMAPR",116,0)
 ..S IEN=PSDA_",1"
"RTN","PSUMAPR",117,0)
 ..S PSDIV=$$GET1^DIQ(59.79002,IEN,.02)
"RTN","PSUMAPR",118,0)
 ..S PSOP=$$GET1^DIQ(59.79002,IEN,.03)
"RTN","PSUMAPR",119,0)
 ..I '$L(PSDIV),'$L(PSOP) S DRAC(PSNM,PSDA)=$$GET1^DIQ(58.8,PSDA,4)
"RTN","PSUMAPR",120,0)
 Q
"RTN","PSUMAPR",121,0)
 ;
"RTN","PSUMAPR",122,0)
MAPD ;Display this if all locations are mapped
"RTN","PSUMAPR",123,0)
 ;
"RTN","PSUMAPR",124,0)
 I '$D(AOU),'$D(NAOU),'$D(DRAC) D  Q
"RTN","PSUMAPR",125,0)
 . W !!,?3,"All pharmacy dispensing/procurement locations are mapped.",!
"RTN","PSUMAPR",126,0)
 Q
"RTN","PSUMAPR",127,0)
 ;
"RTN","PSUMAPR",128,0)
UNMAPD ;Display this if unmapped locations exist
"RTN","PSUMAPR",129,0)
 ;
"RTN","PSUMAPR",130,0)
 N C
"RTN","PSUMAPR",131,0)
 W !
"RTN","PSUMAPR",132,0)
 I $D(AOU) S PSNM="" D            ;Unmapped AR/WS AOU's
"RTN","PSUMAPR",133,0)
 .S C=0
"RTN","PSUMAPR",134,0)
 .W !,?5,"The following"_PSULOC_"are not mapped:"
"RTN","PSUMAPR",135,0)
 .W !
"RTN","PSUMAPR",136,0)
 .F  S PSNM=$O(AOU(PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",137,0)
 ..S PSDA=0
"RTN","PSUMAPR",138,0)
 ..F  S PSDA=$O(AOU(PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",139,0)
 ...W !,?10,PSNM
"RTN","PSUMAPR",140,0)
 ...I AOU(PSNM,PSDA)'=""  W ?40,"**Inactive**"
"RTN","PSUMAPR",141,0)
 ...D BRK Q:PSQUIT
"RTN","PSUMAPR",142,0)
 ...I C=(IOSL-5) S C=0
"RTN","PSUMAPR",143,0)
 ...S C=C+1
"RTN","PSUMAPR",144,0)
 W !
"RTN","PSUMAPR",145,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",146,0)
 ;
"RTN","PSUMAPR",147,0)
 I $D(NAOU) S PSNM="" D           ;Unmapped CS NAOUs
"RTN","PSUMAPR",148,0)
 .S C=0
"RTN","PSUMAPR",149,0)
 .W !,?5,"The following"_PSULOC1_"are not mapped:"
"RTN","PSUMAPR",150,0)
 .W !
"RTN","PSUMAPR",151,0)
 .F  S PSNM=$O(NAOU(PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",152,0)
 ..S PSDA=0
"RTN","PSUMAPR",153,0)
 ..F  S PSDA=$O(NAOU(PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",154,0)
 ...W !,?10,PSNM
"RTN","PSUMAPR",155,0)
 ...I NAOU(PSNM,PSDA)'="" W ?40,"**Inactive**"
"RTN","PSUMAPR",156,0)
 ...D BRK Q:PSQUIT
"RTN","PSUMAPR",157,0)
 ...I C=(IOSL-5) S C=0
"RTN","PSUMAPR",158,0)
 ...S C=C+1
"RTN","PSUMAPR",159,0)
 W !
"RTN","PSUMAPR",160,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",161,0)
 ;
"RTN","PSUMAPR",162,0)
 I $D(DRAC) S PSNM="" D          ;Unmapped DA Pharmacy Locations
"RTN","PSUMAPR",163,0)
 .S C=0
"RTN","PSUMAPR",164,0)
 .W !,?5,"The following"_PSULOC2_"are not mapped:"
"RTN","PSUMAPR",165,0)
 .W !
"RTN","PSUMAPR",166,0)
 .F  S PSNM=$O(DRAC(PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",167,0)
 ..S PSDA=0
"RTN","PSUMAPR",168,0)
 ..F  S PSDA=$O(DRAC(PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",169,0)
 ...W !,?10,PSNM
"RTN","PSUMAPR",170,0)
 ...I DRAC(PSNM,PSDA)'="" W ?40,"**Inactive**"
"RTN","PSUMAPR",171,0)
 ...D BRK Q:PSQUIT
"RTN","PSUMAPR",172,0)
 ...I C=(IOSL-5) S C=0
"RTN","PSUMAPR",173,0)
 ...S C=C+1
"RTN","PSUMAPR",174,0)
 W !
"RTN","PSUMAPR",175,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",176,0)
 Q
"RTN","PSUMAPR",177,0)
 ;
"RTN","PSUMAPR",178,0)
BRK ;Page break. Occurs in the middle of a list
"RTN","PSUMAPR",179,0)
 ;
"RTN","PSUMAPR",180,0)
 I C=(IOSL-5) D
"RTN","PSUMAPR",181,0)
 .W !
"RTN","PSUMAPR",182,0)
 .K DIR I $E(IOST)="C" S DIR(0)="E" D ^DIR
"RTN","PSUMAPR",183,0)
 .I Y=0 S PSQUIT=1 Q
"RTN","PSUMAPR",184,0)
 .S PG=$G(PG)+1
"RTN","PSUMAPR",185,0)
 .W @IOF
"RTN","PSUMAPR",186,0)
 ;Q:$E(IOST,1,2)'="C-"!($D(IO("S")))
"RTN","PSUMAPR",187,0)
 ;K DIR W !
"RTN","PSUMAPR",188,0)
 ;S DIR(0)="E" D ^DIR K DIR
"RTN","PSUMAPR",189,0)
 ;I 'Y S PSQUIT=1 Q
"RTN","PSUMAPR",190,0)
 Q
"RTN","PSUMAPR",191,0)
 ;
"RTN","PSUMAPR",192,0)
PG ;Page break between headers
"RTN","PSUMAPR",193,0)
 ;
"RTN","PSUMAPR",194,0)
 K DIR I $E(IOST)="C" S DIR(0)="E" D ^DIR I Y=0 S PSQUIT=1 Q
"RTN","PSUMAPR",195,0)
 S PG=$G(PG)+1
"RTN","PSUMAPR",196,0)
 W @IOF
"RTN","PSUMAPR",197,0)
 Q
"RTN","PSUMAPR",198,0)
 ;
"RTN","PSUMAPR",199,0)
PGH W @IOF
"RTN","PSUMAPR",200,0)
 W !,"MAPPED/UNMAPPED LOCATIONS"
"RTN","PSUMAPR",201,0)
 W ?30,$$FMTE^XLFDT(DT)
"RTN","PSUMAPR",202,0)
 S PG=$G(PG)+1 W ?60,"PAGE: ",PG,!,LINE,!,"NAME",?30,"DIVISION/OUTPATIENT SITE",?60,"INACTIVE DATE"
"RTN","PSUMAPR",203,0)
PGH1 I $L(HDR) W !!,$G(HDR),!,LINE2
"RTN","PSUMAPR",204,0)
 Q
"RTN","PSUMAPR",205,0)
PGB I $Y<(IOSL-4) S PSQUIT=1 Q
"RTN","PSUMAPR",206,0)
PGHB W @IOF
"RTN","PSUMAPR",207,0)
 W !,"UNMAPPED LOCATIONS"
"RTN","PSUMAPR",208,0)
 W ?30,$$FMTE^XLFDT(DT)
"RTN","PSUMAPR",209,0)
 S PG=$G(PG)+1 W ?60,"PAGE: ",PG,!,LINE,!,"NAME",?40,"INACTIVE DATE"
"RTN","PSUMAPR",210,0)
PGH1B I $L(HDR) W !!,$G(HDR),!,LINE2
"RTN","PSUMAPR",211,0)
 Q
"RTN","PSUOP0")
0^66^B6459337
"RTN","PSUOP0",1,0)
PSUOP0 ;BIR/CFL,TJH;PSU PBM Outpatient Pharmacy entry routine;08/25/1998
"RTN","PSUOP0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP0",3,0)
 ;
"RTN","PSUOP0",4,0)
 Q
"RTN","PSUOP0",5,0)
 ;
"RTN","PSUOP0",6,0)
EN ;Entry Point
"RTN","PSUOP0",7,0)
 S PSUOPSUB="PSUOP_"_PSUJOB
"RTN","PSUOP0",8,0)
 K ^XTMP(PSUOPSUB)
"RTN","PSUOP0",9,0)
 S X1=DT,X2=6 D C^%DTC
"RTN","PSUOP0",10,0)
 S ^XTMP(PSUOPSUB,0)=X_U_DT_U_"OUTPATIENT PHARMACY DATA COLLECTION"
"RTN","PSUOP0",11,0)
 S PSUOPVER=$$VERSION^XPDUTL("PSO")  ;outpatient software version
"RTN","PSUOP0",12,0)
 S PSUDFVER=$$VERSION^XPDUTL("PSN")  ;drug file version
"RTN","PSUOP0",13,0)
 D SECTN^PSUTL1 ;set up section:abbreviation array
"RTN","PSUOP0",14,0)
 ;
"RTN","PSUOP0",15,0)
 ;VERSION 6.0 software
"RTN","PSUOP0",16,0)
 I +PSUOPVER="6" D ^PSUOP1
"RTN","PSUOP0",17,0)
 ;
"RTN","PSUOP0",18,0)
 ;VERSION 7.0 software
"RTN","PSUOP0",19,0)
 I +PSUOPVER'<7 D ^PSUOP2
"RTN","PSUOP0",20,0)
 ;
"RTN","PSUOP0",21,0)
 ;Mail Man Call
"RTN","PSUOP0",22,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D
"RTN","PSUOP0",23,0)
 .D EN^PSUOP4    ;Single dose messages
"RTN","PSUOP0",24,0)
 .D EN^PSUOPMD   ;Multidose messages
"RTN","PSUOP0",25,0)
 ;
"RTN","PSUOP0",26,0)
 I $G(^XTMP("PSU_"_PSUJOB,"PSUPSUMFLAG"))=1 D
"RTN","PSUOP0",27,0)
 .S PSUOPTS="1,2,3,4,5,6,7,8,9,10,11"
"RTN","PSUOP0",28,0)
 .S PSUAUTO=1
"RTN","PSUOP0",29,0)
 ;
"RTN","PSUOP0",30,0)
 D PULL^PSUCP
"RTN","PSUOP0",31,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUOP0",32,0)
 I $D(PSUMOD(10)) D OPSSN^PSUDEM4    ;Provider extract
"RTN","PSUOP0",33,0)
 ;
"RTN","PSUOP0",34,0)
 ;Rx summary report
"RTN","PSUOP0",35,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D
"RTN","PSUOP0",36,0)
 .I '$D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG")) D EN^PSUSUM2
"RTN","PSUOP0",37,0)
 .;
"RTN","PSUOP0",38,0)
 .;IV/UD/RX summary report
"RTN","PSUOP0",39,0)
 .I $D(PSUMOD(2))&$D(PSUMOD(1))&$D(PSUMOD(4)) D
"RTN","PSUOP0",40,0)
 ..D EN^PSUSUM6
"RTN","PSUOP0",41,0)
 .;
"RTN","PSUOP0",42,0)
 .;IV/RX summary report
"RTN","PSUOP0",43,0)
 .I $D(PSUMOD(1))&'$D(PSUMOD(2))&$D(PSUMOD(4)) D
"RTN","PSUOP0",44,0)
 ..D EN^PSUSUM7
"RTN","PSUOP0",45,0)
 .;
"RTN","PSUOP0",46,0)
 .;UD/RX summary report
"RTN","PSUOP0",47,0)
 .I '$D(PSUMOD(1))&$D(PSUMOD(2))&$D(PSUMOD(4)) D
"RTN","PSUOP0",48,0)
 ..D EN^PSUSUM7
"RTN","PSUOP0",49,0)
 ;
"RTN","PSUOP0",50,0)
 D EN^PSUOP8   ;AMIS SUMMARY REPORT
"RTN","PSUOP0",51,0)
 ;
"RTN","PSUOP0",52,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")
"RTN","PSUOP0",53,0)
 ;
"RTN","PSUOP0",54,0)
 D CLEAN
"RTN","PSUOP0",55,0)
 Q
"RTN","PSUOP0",56,0)
 ;
"RTN","PSUOP0",57,0)
PRINT ;Call print routine
"RTN","PSUOP0",58,0)
 ;
"RTN","PSUOP0",59,0)
 D ^PSUOP6
"RTN","PSUOP0",60,0)
 ;
"RTN","PSUOP0",61,0)
 Q
"RTN","PSUOP0",62,0)
 ;
"RTN","PSUOP0",63,0)
CLEAN ; clean up local symbol table
"RTN","PSUOP0",64,0)
 S XPSUOPTN=PSUOPTN,XPSUJOB=PSUJOB M XPSUMOD=PSUMOD
"RTN","PSUOP0",65,0)
 D VARKILL^PSUTL ; kill all PSU namespace variables
"RTN","PSUOP0",66,0)
 S PSUOPTN=XPSUOPTN,PSUJOB=XPSUJOB M PSUMOD=XPSUMOD K XPSUOPTN,XPSUJOB,XPSUMOD
"RTN","PSUOP0",67,0)
 K DATA,DFN,PSUDFVER,ENDIT,EXTD,J,NODATA,NONE,PSUOPVER,PSECT,PSOPNFI,PSOPNFR,REC,REC1,REC2,X1,X2,Y,Z,AMIS
"RTN","PSUOP0",68,0)
 D PULL^PSUCP,OPTS^PSUCP
"RTN","PSUOP0",69,0)
CLEANQ Q
"RTN","PSUOP1")
0^67^B18820371
"RTN","PSUOP1",1,0)
PSUOP1 ;BIR/CFL - PSU PBM Outpatient Pharmacy Data Collection for Version 6.0 ;25 AUG 1998
"RTN","PSUOP1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP1",3,0)
 ;
"RTN","PSUOP1",4,0)
 ;DBIAs
"RTN","PSUOP1",5,0)
 ; Reference to ^PSRX( file #52 supported by DBIA(s) 465, 2512, 2513
"RTN","PSUOP1",6,0)
EN ;Entry to data collection
"RTN","PSUOP1",7,0)
 K ^TMP($J)
"RTN","PSUOP1",8,0)
 D CMOPARY,ADLOOP
"RTN","PSUOP1",9,0)
 Q
"RTN","PSUOP1",10,0)
ADLOOP ;Loop through the AD cross reference
"RTN","PSUOP1",11,0)
 S X1=PSUSDT,X2=-31
"RTN","PSUOP1",12,0)
 D C^%DTC K %,%H,%T
"RTN","PSUOP1",13,0)
 S PSUFDT=X
"RTN","PSUOP1",14,0)
 F  S PSUFDT=$O(^PSRX("AD",PSUFDT)) Q:PSUFDT=""!(PSUFDT\1>PSUEDT)  D
"RTN","PSUOP1",15,0)
 .S PSURXIEN=""
"RTN","PSUOP1",16,0)
 .F  S PSURXIEN=$O(^PSRX("AD",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP1",17,0)
 ..S PSUFIL=""
"RTN","PSUOP1",18,0)
 ..F  S PSUFIL=$O(^PSRX("AD",PSUFDT,PSURXIEN,PSUFIL)) Q:PSUFIL=""  D
"RTN","PSUOP1",19,0)
 ...Q:'$D(^PSRX(PSURXIEN,0))
"RTN","PSUOP1",20,0)
 ...K PSUTYP,PSUOP
"RTN","PSUOP1",21,0)
 ...S PSUFLN=PSUFIL
"RTN","PSUOP1",22,0)
 ...D COMVAR
"RTN","PSUOP1",23,0)
 ...S PSUCMOP="N"
"RTN","PSUOP1",24,0)
 ...;
"RTN","PSUOP1",25,0)
 ...; check for CMOP data
"RTN","PSUOP1",26,0)
 ...I $D(^PSRX(PSURXIEN,4,0)) D ARLOOP
"RTN","PSUOP1",27,0)
 ...I PSUCMOP="Y" Q  ; record filed in subroutine
"RTN","PSUOP1",28,0)
 ...I (PSUFDT\1<PSUSDT) Q
"RTN","PSUOP1",29,0)
 ...S PSUTYP=$S(PSUFLN=0:"N",1:"R")
"RTN","PSUOP1",30,0)
 ...D GETDATA
"RTN","PSUOP1",31,0)
 ...D SETREC^PSUOP3
"RTN","PSUOP1",32,0)
 ..I $D(^PSRX(PSURXIEN,"P",0)),'$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN)) D ADPLOOP
"RTN","PSUOP1",33,0)
 K ^TMP($J)
"RTN","PSUOP1",34,0)
 Q
"RTN","PSUOP1",35,0)
ARLOOP ;Check to see if CMOP Data exists for the reporting period
"RTN","PSUOP1",36,0)
 I $D(^TMP($J,PSURXIEN,PSUFLN)) D 
"RTN","PSUOP1",37,0)
 .S PSUCMOP="Y"
"RTN","PSUOP1",38,0)
 .S PSUTYP=$S(PSUFLN=0:"N",1:"R")
"RTN","PSUOP1",39,0)
 .D GETDATA
"RTN","PSUOP1",40,0)
 .I (PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDT) Q
"RTN","PSUOP1",41,0)
 .D SETREC^PSUOP3
"RTN","PSUOP1",42,0)
 Q
"RTN","PSUOP1",43,0)
ADPLOOP ;Get data for partial fills
"RTN","PSUOP1",44,0)
 S PSUPFN=0
"RTN","PSUOP1",45,0)
 F  S PSUPFN=$O(^PSRX(PSURXIEN,"P",PSUPFN)) Q:'PSUPFN  D
"RTN","PSUOP1",46,0)
 .S PSUCMOP="N"
"RTN","PSUOP1",47,0)
 .D COMVAR
"RTN","PSUOP1",48,0)
 .S PSUTYP="P"
"RTN","PSUOP1",49,0)
 .D GETPART
"RTN","PSUOP1",50,0)
 .Q:((PSUFD<PSUSDT)!(PSUFD>PSUEDT))
"RTN","PSUOP1",51,0)
 .D SETREC^PSUOP3
"RTN","PSUOP1",52,0)
 Q
"RTN","PSUOP1",53,0)
GETDATA ;Get the data for New Fills, Refills and Partial fills
"RTN","PSUOP1",54,0)
 I PSUTYP="N" D
"RTN","PSUOP1",55,0)
 .S PSUFD=PSUOP(22)
"RTN","PSUOP1",56,0)
 .S PSUDS=PSUOP(8)
"RTN","PSUOP1",57,0)
 .S PSUQTY=+PSUOP(7)
"RTN","PSUOP1",58,0)
 .S PSUDRCT=PSUOP(17)
"RTN","PSUOP1",59,0)
 .S PSURELDT=PSUOP(31)
"RTN","PSUOP1",60,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP1",61,0)
 .S PSUPRID=PSUOP(4)
"RTN","PSUOP1",62,0)
 .S PSUMW=PSUOP(11)
"RTN","PSUOP1",63,0)
 .S PSUDIVP=PSUOP(20)
"RTN","PSUOP1",64,0)
 .S PSUNDC=""
"RTN","PSUOP1",65,0)
 .I PSUCMOP="Y" D
"RTN","PSUOP1",66,0)
 ..S PSUNDC=$$VALI^PSUTL(52.01,"PSURXIEN,PSUFLN",4)
"RTN","PSUOP1",67,0)
 .S PSUNDC=$S(PSUNDC="":PSUOP(27),PSUNDC="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP1",68,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP1",69,0)
 ;Get data for Refills
"RTN","PSUOP1",70,0)
 I PSUTYP="R" D  K REC
"RTN","PSUOP1",71,0)
 .D GETS^PSUTL(52.1,"PSURXIEN,PSUFLN",".01;1;1.1;1.2;2;8;15;17","PSUREFIL","I")
"RTN","PSUOP1",72,0)
 .D MOVEI^PSUTL("PSUREFIL")
"RTN","PSUOP1",73,0)
 .S PSUFD=PSUREFIL(.01)
"RTN","PSUOP1",74,0)
 .S PSUPRID=PSUREFIL(15)
"RTN","PSUOP1",75,0)
 .S PSUMW=PSUREFIL(2)
"RTN","PSUOP1",76,0)
 .S PSUDIVP=PSUREFIL(8)
"RTN","PSUOP1",77,0)
 .S PSUDS=PSUREFIL(1.1)
"RTN","PSUOP1",78,0)
 .S PSUQTY=+PSUREFIL(1)
"RTN","PSUOP1",79,0)
 .S PSUDRCT=PSUREFIL(1.2)
"RTN","PSUOP1",80,0)
 .S PSURELDT=PSUREFIL(17)
"RTN","PSUOP1",81,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP1",82,0)
 .S PSURXP=PSUOP(3)
"RTN","PSUOP1",83,0)
 .S PSUDR=PSUOP(6)
"RTN","PSUOP1",84,0)
 .S PSUNDC=""
"RTN","PSUOP1",85,0)
 .I PSUCMOP="Y" D
"RTN","PSUOP1",86,0)
 ..S PSUNDC=$$VALI^PSUTL(52.01,"PSURXIEN,PSUFLN",4)
"RTN","PSUOP1",87,0)
 .I PSUNDC="" S PSUNDC=$$VALI^PSUTL(52.1,"PSURXIEN,PSUFLN",11)
"RTN","PSUOP1",88,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP1",89,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP1",90,0)
 Q
"RTN","PSUOP1",91,0)
GETPART ;Get data for Partial Fills
"RTN","PSUOP1",92,0)
 K PSUPART
"RTN","PSUOP1",93,0)
 D GETS^PSUTL(52.2,"PSURXIEN,PSUPFN",".01;.02;.04;.041;.042;.09;6;8","PSUPART","I")
"RTN","PSUOP1",94,0)
 D MOVEI^PSUTL("PSUPART")
"RTN","PSUOP1",95,0)
 S PSUFD=PSUPART(.01)
"RTN","PSUOP1",96,0)
 S PSUPRID=PSUPART(6)
"RTN","PSUOP1",97,0)
 S PSUMW=PSUPART(.02)
"RTN","PSUOP1",98,0)
 S PSUDIVP=PSUPART(.09)
"RTN","PSUOP1",99,0)
 S PSUDS=PSUPART(.041)
"RTN","PSUOP1",100,0)
 S PSUQTY=+PSUPART(.04)
"RTN","PSUOP1",101,0)
 S PSUDRCT=PSUPART(.042)
"RTN","PSUOP1",102,0)
 S PSURELDT=PSUPART(8)
"RTN","PSUOP1",103,0)
 I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP1",104,0)
 S PSUNDC=$$VALI^PSUTL(52.2,"PSURXIEN,PSUFLN",1)
"RTN","PSUOP1",105,0)
 I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP1",106,0)
 D PROVDR^PSUOP3  ;Get shared variables
"RTN","PSUOP1",107,0)
 Q
"RTN","PSUOP1",108,0)
COMVAR ;Get the common variables
"RTN","PSUOP1",109,0)
 D GETS^PSUTL(52,PSURXIEN,".01;2;3;4;6;7;8;11;17;20;22;27;31","PSUOP","I")
"RTN","PSUOP1",110,0)
 D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP1",111,0)
 S PSURXN=PSUOP(.01)
"RTN","PSUOP1",112,0)
 S DFN=PSUOP(2) D PID^VADPT
"RTN","PSUOP1",113,0)
 S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP1",114,0)
 S PSUWPC="" ;Patient counseling only exists for version 7.0
"RTN","PSUOP1",115,0)
 S PSUDR=PSUOP(6)
"RTN","PSUOP1",116,0)
 S PSURXP=PSUOP(3)
"RTN","PSUOP1",117,0)
 ;S PSUSIG=PSUOP(10)
"RTN","PSUOP1",118,0)
 D GETDRUG^PSUOP3
"RTN","PSUOP1",119,0)
 Q
"RTN","PSUOP1",120,0)
CMOPARY ;Loop through the "AR" cross reference and build CMOP array
"RTN","PSUOP1",121,0)
 S X1=PSUSDT,X2=-1
"RTN","PSUOP1",122,0)
 D C^%DTC K %,%H,%T
"RTN","PSUOP1",123,0)
 S PSUCDT=X
"RTN","PSUOP1",124,0)
 F  S PSUCDT=$O(^PSRX("AR",PSUCDT)) Q:'PSUCDT  D
"RTN","PSUOP1",125,0)
 .S PSUCRX=""
"RTN","PSUOP1",126,0)
 .F  S PSUCRX=$O(^PSRX("AR",PSUCDT,PSUCRX)) Q:PSUCRX=""  D
"RTN","PSUOP1",127,0)
 ..S PSUCLN=""
"RTN","PSUOP1",128,0)
 ..F  S PSUCLN=$O(^PSRX("AR",PSUCDT,PSUCRX,PSUCLN)) Q:PSUCLN=""  D
"RTN","PSUOP1",129,0)
 ...S ^TMP($J,PSUCRX,PSUCLN)=""
"RTN","PSUOP1",130,0)
 Q
"RTN","PSUOP2")
0^68^B42214911
"RTN","PSUOP2",1,0)
PSUOP2 ;BIR/CFL - PSU PBM Outpatient Pharmacy Data Collection for Version 7.0 ; 01 May 2001  10:57 AM
"RTN","PSUOP2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP2",3,0)
 ;
"RTN","PSUOP2",4,0)
 ;DBIAs
"RTN","PSUOP2",5,0)
 ; Reference to ^PSRX( file # 52 supported by DBIAs 465, 2512
"RTN","PSUOP2",6,0)
 ; Reference to EN^PSOORDER      supported by DBIA 1878
"RTN","PSUOP2",7,0)
 ; 
"RTN","PSUOP2",8,0)
 ;
"RTN","PSUOP2",9,0)
EN ;Entry to data collection
"RTN","PSUOP2",10,0)
 D ALLOOP,AMLOOP
"RTN","PSUOP2",11,0)
 K ^TMP("PSOR",$J)
"RTN","PSUOP2",12,0)
 Q
"RTN","PSUOP2",13,0)
ALLOOP ;Loop through the AL cross refererence
"RTN","PSUOP2",14,0)
 N PSUDOC1,PSUCAN,PSUCL,PSUCMP,PSUFP,PSUORDT,PSUCO
"RTN","PSUOP2",15,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",16,0)
 F  S PSUFDT=$O(^PSRX("AL",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",17,0)
 .S PSURXIEN=""
"RTN","PSUOP2",18,0)
 .F  S PSURXIEN=$O(^PSRX("AL",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",19,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",20,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",21,0)
 ..S PSUCAN=$$GET1^DIQ(52,PSURXIEN,26.1,"I")   ;Cancel date
"RTN","PSUOP2",22,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;21;27","PSUOP","I")
"RTN","PSUOP2",23,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",24,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",25,0)
 ..;
"RTN","PSUOP2",26,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",27,0)
 ..D PID^VADPT
"RTN","PSUOP2",28,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",29,0)
 ..N PSUPSO S PSUPSO=1   ;flag to avoid a PSO error when SIG is too long
"RTN","PSUOP2",30,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",31,0)
 ..Q:'$D(^TMP("PSOR",$J))
"RTN","PSUOP2",32,0)
 ..D EN^PSUOPAM      ;Gather AMIS data
"RTN","PSUOP2",33,0)
 ..D CMOPA ; set array of CMOP recs
"RTN","PSUOP2",34,0)
 ..D NEW ; check ^TMP to see if New Rx is in time frame, if so create record.
"RTN","PSUOP2",35,0)
 ..D REF ; check ^TMP to see if refills are in time frame, if so create records
"RTN","PSUOP2",36,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",37,0)
 Q
"RTN","PSUOP2",38,0)
 ;
"RTN","PSUOP2",39,0)
AMLOOP ; loop through "AM", partials, cross reference to see if any were missed
"RTN","PSUOP2",40,0)
 S X1=PSUSDT,X2=-1
"RTN","PSUOP2",41,0)
 D C^%DTC K %,%H,%T
"RTN","PSUOP2",42,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",43,0)
 F  S PSUFDT=$O(^PSRX("AM",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",44,0)
 .S PSURXIEN=""
"RTN","PSUOP2",45,0)
 .F  S PSURXIEN=$O(^PSRX("AM",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",46,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",47,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",48,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;27","PSUOP","I")
"RTN","PSUOP2",49,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",50,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",51,0)
 ..; SCREEN OUT TEST PATIENTS
"RTN","PSUOP2",52,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",53,0)
 ..D PID^VADPT
"RTN","PSUOP2",54,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",55,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",56,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",57,0)
 Q
"RTN","PSUOP2",58,0)
 ;
"RTN","PSUOP2",59,0)
NEW ; New Rx
"RTN","PSUOP2",60,0)
 S PSUFD=$P(^TMP("PSOR",$J,PSURXIEN,0),U,2)
"RTN","PSUOP2",61,0)
 D COMVAR
"RTN","PSUOP2",62,0)
 S PSUTYP="N"
"RTN","PSUOP2",63,0)
 S PSUCMOP=$S($D(PSUCMA(0)):"Y",1:"N")
"RTN","PSUOP2",64,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",65,0)
 S PSUORDT=$P(PSUR0,U,17)     ;AMIS Original Login Date
"RTN","PSUOP2",66,0)
 S PSUQTY=+$P(PSUR0,U,6)
"RTN","PSUOP2",67,0)
 ;
"RTN","PSUOP2",68,0)
 ;
"RTN","PSUOP2",69,0)
 S PSUDS=$P(PSUR0,U,7)
"RTN","PSUOP2",70,0)
 S PSUDRCT=$P(PSUR0,U,10)
"RTN","PSUOP2",71,0)
 S PSURELDT=$P($P(PSUR0,U,13),".",1)
"RTN","PSUOP2",72,0)
 Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",73,0)
 S PSUWPC=$E($P(PSUR0,U,15))
"RTN","PSUOP2",74,0)
NEWX1 ;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",75,0)
NEWX2 ;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",76,0)
 S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",77,0)
 S PSUCLN=$P($P(PSUR1,U,4),";",2)          ;AMIS data clinic
"RTN","PSUOP2",78,0)
 S PSUFP=$P($P(PSUR1,U,9),";",1)           ;AMIS finishing person
"RTN","PSUOP2",79,0)
 S PSUPRID=$P($P(PSUR1,U,1),";",1)
"RTN","PSUOP2",80,0)
 S PSURXP=$P($P(PSUR1,U,5),";",1)
"RTN","PSUOP2",81,0)
 S PSUMW=$P($P(PSUR1,U,6),";",1)
"RTN","PSUOP2",82,0)
 S PSUDIVP=$P(PSUR1,U,7)
"RTN","PSUOP2",83,0)
 ;
"RTN","PSUOP2",84,0)
 S PSUNDC=""
"RTN","PSUOP2",85,0)
 I PSUCMOP="Y" S PSUNDC=PSUCMA(0)
"RTN","PSUOP2",86,0)
 I PSUNDC="" S PSUNDC=$S($L(PSUOP(27)):PSUOP(27),$L(PSUDRUG(31)):PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",87,0)
 D PROVDR^PSUOP3
"RTN","PSUOP2",88,0)
 D SETREC^PSUOP3
"RTN","PSUOP2",89,0)
NEWQ Q
"RTN","PSUOP2",90,0)
 ;
"RTN","PSUOP2",91,0)
REF ; Refills
"RTN","PSUOP2",92,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"REF"))
"RTN","PSUOP2",93,0)
 D COMVAR
"RTN","PSUOP2",94,0)
 S PSUFLN=""
"RTN","PSUOP2",95,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",96,0)
 .S PSUTYP="R"
"RTN","PSUOP2",97,0)
 .S PSUCMOP=$S($D(PSUCMA(PSUFLN)):"Y",1:"N")
"RTN","PSUOP2",98,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN,0)
"RTN","PSUOP2",99,0)
 .S PSUWPC="N"
"RTN","PSUOP2",100,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",101,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",102,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",103,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",104,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",105,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",106,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",107,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",108,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",109,0)
 .S PSUREDT=$P(PSUR0,U,12)     ;AMIS Refill Login Date
"RTN","PSUOP2",110,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",111,0)
 .;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",112,0)
 .;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",113,0)
 .S PSUNDC=""
"RTN","PSUOP2",114,0)
 .I PSUCMOP="Y" S PSUNDC=PSUCMA(PSUFLN)
"RTN","PSUOP2",115,0)
 .I PSUNDC="" S PSUNDC=$$VALI^PSUTL(52.1,PSURXIEN,11)
"RTN","PSUOP2",116,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",117,0)
 .;
"RTN","PSUOP2",118,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",119,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",120,0)
REFQ Q
"RTN","PSUOP2",121,0)
 ;
"RTN","PSUOP2",122,0)
PAR ; Partials
"RTN","PSUOP2",123,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"RPAR"))
"RTN","PSUOP2",124,0)
 D COMVAR
"RTN","PSUOP2",125,0)
 S PSUFLN=""
"RTN","PSUOP2",126,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",127,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN,0)
"RTN","PSUOP2",128,0)
 .S PSUTYP="P"
"RTN","PSUOP2",129,0)
 .S PSUCMOP="N"
"RTN","PSUOP2",130,0)
 .S PSUWPC="N"
"RTN","PSUOP2",131,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",132,0)
 .;I (PSUFD<PSUSDT)!(PSUFD\1>PSUEDT) Q
"RTN","PSUOP2",133,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",134,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",135,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",136,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",137,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",138,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",139,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",140,0)
 .S PSUPDT=$P(PSUR0,U,12)       ;AMIS Partial Login Date
"RTN","PSUOP2",141,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",142,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",143,0)
 .S PSUNDC=$$VALI^PSUTL(52.2,PSURXIEN,1)
"RTN","PSUOP2",144,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",145,0)
 .;
"RTN","PSUOP2",146,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",147,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",148,0)
PARQ Q
"RTN","PSUOP2",149,0)
 ;
"RTN","PSUOP2",150,0)
COMVAR ; set variables that are common between all record types
"RTN","PSUOP2",151,0)
 S PSUDR=$P($P(^TMP("PSOR",$J,PSURXIEN,"DRUG",0),U,1),";",1)
"RTN","PSUOP2",152,0)
 ;S CMOPID=$P($G(^PSDRUG(PSUDR,"ND")),U,10)     ;AMIS CMOP ID
"RTN","PSUOP2",153,0)
 S PSUSIG=$P($G(^TMP("PSOR",$J,PSURXIEN,"SIG",1,0)),U,1)
"RTN","PSUOP2",154,0)
 S PSURXP=$P($P(^TMP("PSOR",$J,PSURXIEN,1),U,5),";",1)
"RTN","PSUOP2",155,0)
 S PSURXN=$P(^TMP("PSOR",$J,PSURXIEN,0),U,5)
"RTN","PSUOP2",156,0)
 D GETDRUG^PSUOP3 ; loads data from file #50 using PSUDR as ien
"RTN","PSUOP2",157,0)
COMVARQ Q
"RTN","PSUOP2",158,0)
 ;
"RTN","PSUOP2",159,0)
CMOPA ; set array of CMOP recs
"RTN","PSUOP2",160,0)
 K PSUCMA
"RTN","PSUOP2",161,0)
 N PSUR1,PSUX,PSUST,PSUFIL,PSUNDC
"RTN","PSUOP2",162,0)
 S PSUX=""
"RTN","PSUOP2",163,0)
 F  S PSUX=$O(^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX)) Q:PSUX=""  D
"RTN","PSUOP2",164,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX,0)
"RTN","PSUOP2",165,0)
 .F X="PSUFIL^3","PSUST^4","PSUNDC^6" D PIECE(X,PSUR1,U)
"RTN","PSUOP2",166,0)
 .S:+PSUST=1 PSUCMA(PSUFIL)=PSUNDC
"RTN","PSUOP2",167,0)
 .K:+PSUST=3 PSUCMA(PSUFIL)
"RTN","PSUOP2",168,0)
 .D:$D(PSUCMA(PSUFIL)) RTSTOCK
"RTN","PSUOP2",169,0)
CMOPAQ Q
"RTN","PSUOP2",170,0)
 ;
"RTN","PSUOP2",171,0)
RTSTOCK ; test for "AR" if none then unmark CMOP
"RTN","PSUOP2",172,0)
 ; needs PSURXIEN, PSUFIL, from CMOPA
"RTN","PSUOP2",173,0)
 N PSURELDT,PSUR0,PSURTSDT
"RTN","PSUOP2",174,0)
 I PSUFIL D  Q
"RTN","PSUOP2",175,0)
 . S PSUR0=$G(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFIL,0))
"RTN","PSUOP2",176,0)
 . F X="PSURELDT^8","PSURTSDT^9" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",177,0)
 . I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",178,0)
 . K PSUCMA(PSUFIL)
"RTN","PSUOP2",179,0)
 ;
"RTN","PSUOP2",180,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",181,0)
 F X="PSURELDT^13","PSURTSDT^14" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",182,0)
 I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",183,0)
 I $D(PSUCMA(PSUFIL)) K PSUCMA(PSUFIL)
"RTN","PSUOP2",184,0)
 Q
"RTN","PSUOP2",185,0)
PIECE(%,REC,DLM) ;Piece % from record REC using delimiter DLM
"RTN","PSUOP2",186,0)
 ; %="VARNAME^PIECE",REC=SOURCE,DLM=DELIMITER in REC
"RTN","PSUOP2",187,0)
 N Y,I S Y=$P(%,U,1),I=$P(%,U,2) S @Y=$P(REC,DLM,I)
"RTN","PSUOP2",188,0)
 Q
"RTN","PSUOP2",189,0)
 ;
"RTN","PSUOP3")
0^69^B76484061
"RTN","PSUOP3",1,0)
PSUOP3 ;BIR/CFL,TJH,PDW-PSU PBM Outpatient Pharmacy shared variables ;08/25/2003
"RTN","PSUOP3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP3",3,0)
 ;
"RTN","PSUOP3",4,0)
 ; Reference to file #7 supported by DBIA 2495
"RTN","PSUOP3",5,0)
 ; Reference to file #50 supported by DBIA 221
"RTN","PSUOP3",6,0)
 ; Reference to file #59 supported by DBIA 2510
"RTN","PSUOP3",7,0)
 ; Reference to file #200 supported by DBIA 10060
"RTN","PSUOP3",8,0)
 ; Reference to file #49  supported by DBIA 10093
"RTN","PSUOP3",9,0)
 ; Reference to file #52  supported by DBIA 2512
"RTN","PSUOP3",10,0)
 ;
"RTN","PSUOP3",11,0)
PROVDR ;Get provider data, site number and AMIS category
"RTN","PSUOP3",12,0)
 S PSUSITE=$S(PSUDIVP="":PSUSNDR,1:$$VALI^PSUTL(59,PSUDIVP,.06))
"RTN","PSUOP3",13,0)
 ;
"RTN","PSUOP3",14,0)
 ;Create storage global of division numbers and names for lab msgs.
"RTN","PSUOP3",15,0)
 S X=PSUSITE,DIC=59,DIC(0)="XM" D ^DIC
"RTN","PSUOP3",16,0)
 S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP3",17,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*31
"RTN","PSUOP3",18,0)
 I '$L(PSUDIVNM) S X=PSUSITE D DIVNM^PSUOP6
"RTN","PSUOP3",19,0)
 S ^XTMP("PSU_"_PSUJOB,"DIV",PSUSITE)=PSUDIVNM
"RTN","PSUOP3",20,0)
 ;
"RTN","PSUOP3",21,0)
GETVAR ;Get shared variables
"RTN","PSUOP3",22,0)
 ;Get AMIS workload category
"RTN","PSUOP3",23,0)
 S PSUPST=$$VALI^PSUTL(53,PSURXP,6)
"RTN","PSUOP3",24,0)
 S PSUSC=$S(PSUPST=1:"SC",PSUPST=2:"AA",PSUPST=3:"OT",PSUPST=4:"IP",1:"")
"RTN","PSUOP3",25,0)
 S:$$GET1^DIQ(52,PSURXIEN,201)="YES" PSUSC="NVA"
"RTN","PSUOP3",26,0)
 K PSUPROV
"RTN","PSUOP3",27,0)
 D GETS^PSUTL(200,PSUPRID,"9;29;53.5;53.6","PSUPROV","I")
"RTN","PSUOP3",28,0)
 I '$D(PSUPROV) D NOPROV Q
"RTN","PSUOP3",29,0)
 D MOVEI^PSUTL("PSUPROV")
"RTN","PSUOP3",30,0)
 S PSUPRSSN=PSUPROV(9)
"RTN","PSUOP3",31,0)
 I PSUPRSSN="" S PSUPRSSN=999999999
"RTN","PSUOP3",32,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUPRSSN,PSUPRID)=""
"RTN","PSUOP3",33,0)
 S PSUDOC(9)=PSUPRSSN
"RTN","PSUOP3",34,0)
 S PSUPTYP=$S(PSUPROV(53.6)=4:"F",1:"S")
"RTN","PSUOP3",35,0)
 S:$$GET1^DIQ(52,PSURXIEN,201)="YES" PSUPTYP="NVA"
"RTN","PSUOP3",36,0)
 S PSUPCLS="" I PSUPROV(53.5)'="" D
"RTN","PSUOP3",37,0)
 .S PSUPCLS=$$VALI^PSUTL(7,PSUPROV(53.5),1)
"RTN","PSUOP3",38,0)
 .I PSUPCLS="" S PSUPCLS=$$VALI^PSUTL(7,PSUPROV(53.5),.01)
"RTN","PSUOP3",39,0)
 S PSUPSV=$S($L(PSUPROV(29)):$$VAL^PSUTL(49,PSUPROV(29),.01),1:"")
"RTN","PSUOP3",40,0)
 S PSUPSV=$$UPPER^PSUTL(PSUPSV),PSUPSERV=""
"RTN","PSUOP3",41,0)
 I $L(PSUPSV),$D(PSECT(PSUPSV)) S PSUPSERV=PSECT(PSUPSV)
"RTN","PSUOP3",42,0)
 S PSUSPTY=$$GET^XUA4A72(PSUPRID,PSUFDT)
"RTN","PSUOP3",43,0)
 S PSUSP1=$P(PSUSPTY,U,3),PSUSP2=$P(PSUSPTY,U,4)
"RTN","PSUOP3",44,0)
 ;
"RTN","PSUOP3",45,0)
 Q
"RTN","PSUOP3",46,0)
 ;
"RTN","PSUOP3",47,0)
NOPROV ; set up PSUPROV array when provider isn't found in ^VA(200
"RTN","PSUOP3",48,0)
 F I=9,29,53.5,53.6 S PSUPROV(I)=""
"RTN","PSUOP3",49,0)
 S (PSUPRSSN,PSUPTYP,PSUPCLS,PSUPSERV,PSUSP1,PSUSP2)=""
"RTN","PSUOP3",50,0)
 Q
"RTN","PSUOP3",51,0)
GETDRUG ;Get drug data
"RTN","PSUOP3",52,0)
 K PSUDRUG
"RTN","PSUOP3",53,0)
 D GETS^PSUTL(50,PSUDR,".01;2;3;14.5;20;21;22;25;27;31;51;52","PSUDRUG","I")
"RTN","PSUOP3",54,0)
 D MOVEI^PSUTL("PSUDRUG")
"RTN","PSUOP3",55,0)
 I '$D(PSUDRUG) F I=.01,2,3,14.5,20,21,22,25,31,51,52 S PSUDRUG(I)=""
"RTN","PSUOP3",56,0)
 S PSUGNM=PSUDRUG(.01)
"RTN","PSUOP3",57,0)
 I PSUGNM="" S PSUGNM="Unknown Generic Name"
"RTN","PSUOP3",58,0)
 S PSUVANM=PSUDRUG(21)
"RTN","PSUOP3",59,0)
 I PSUVANM="" S PSUVANM="Unknown VA Product Name"
"RTN","PSUOP3",60,0)
 S PSUDEA=PSUDRUG(3)
"RTN","PSUOP3",61,0)
 S PSUNFI=$S(PSUDRUG(51)=1:"N/F",1:"")
"RTN","PSUOP3",62,0)
 S PSUDUN=PSUDRUG(14.5)
"RTN","PSUOP3",63,0)
 S PSUVACLS=PSUDRUG(2)
"RTN","PSUOP3",64,0)
 S PSUNDCL=PSUDRUG(22)
"RTN","PSUOP3",65,0)
 S PSUNAF=$S(PSUDRUG(52):"N/F",1:"")
"RTN","PSUOP3",66,0)
 S PSUNADR=PSUDRUG(20)
"RTN","PSUOP3",67,0)
 S PSUCMID=PSUDRUG(27)
"RTN","PSUOP3",68,0)
 ;Get the National Formulary Indicator and Restriction
"RTN","PSUOP3",69,0)
 S (PSOPNFI,PSOPNFR)=""
"RTN","PSUOP3",70,0)
 I $$VERSION^XPDUTL("PSN")'<4 D
"RTN","PSUOP3",71,0)
 .S PSOPNFI=$$FORMI^PSNAPIS(PSUNADR,PSUNDCL)
"RTN","PSUOP3",72,0)
 .S PSOPNFR=$$FORMR^PSNAPIS(PSUNADR,PSUNDCL)
"RTN","PSUOP3",73,0)
GETDRUGQ Q
"RTN","PSUOP3",74,0)
 ;
"RTN","PSUOP3",75,0)
SETREC ;Set the record into the ^XTMP global
"RTN","PSUOP3",76,0)
 S:PSUDIVP="" PSUDIVP=PSUSNDR
"RTN","PSUOP3",77,0)
 S REC1="^",REC2="*",PSU2U="^",REC3="*",REC4="*",REC5="*",REC6="*"
"RTN","PSUOP3",78,0)
 S REC1=REC1_$TR(PSUSITE,"^","'")_PSU2U_$TR(PSUFD,"^","'")_PSU2U
"RTN","PSUOP3",79,0)
 S REC1=REC1_$TR(PSURELDT,"^","'")_PSU2U_$TR(PSURXN,"^","'")_PSU2U
"RTN","PSUOP3",80,0)
 S REC1=REC1_$TR(PSUSC,"^","'")_PSU2U_PSUSSN_PSU2U_$TR(PSUVANM,"^","'")_PSU2U
"RTN","PSUOP3",81,0)
 S REC1=REC1_$TR(PSUVACLS,"^","'")_PSU2U_$TR(PSUGNM,"^","'")_PSU2U
"RTN","PSUOP3",82,0)
 S REC1=REC1_$TR(PSUNDC,"^","'")_PSU2U_$TR(PSUNFI,"^","'")_PSU2U
"RTN","PSUOP3",83,0)
 S REC1=REC1_$TR(PSOPNFI,"^","'")_PSU2U_$TR(PSOPNFR,"^","'")_PSU2U
"RTN","PSUOP3",84,0)
 S REC1=REC1_$TR(PSUDEA,"^","'")_PSU2U_$TR(PSUTYP,"^","'")_PSU2U
"RTN","PSUOP3",85,0)
 S REC1=REC1_$TR(PSUCMOP,"^","'")_PSU2U_$TR(PSUMW,"^","'")_PSU2U
"RTN","PSUOP3",86,0)
 S REC1=REC1_$TR(PSUPRSSN,"^","'")_PSU2U_$TR(PSUPTYP,"^","'")_PSU2U
"RTN","PSUOP3",87,0)
 S REC1=REC1_PSU2U_$TR(PSUWPC,"^","'")_PSU2U
"RTN","PSUOP3",88,0)
 S REC1=REC1_$TR(PSUDUN,"^","'")_PSU2U_$TR(PSUDRCT,"^","'")_PSU2U
"RTN","PSUOP3",89,0)
 S REC1=REC1_$TR(PSUDS,"^","'")_PSU2U_$TR(PSUQTY,"^","'")_PSU2U_PSUNAF_U
"RTN","PSUOP3",90,0)
 D ICN^PSUV2 S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUOP3",91,0)
 S REC1=REC1_$G(PSUPICN)_PSU2U_PSUPRID_PSU2U_$G(PSUCAN)_"^"
"RTN","PSUOP3",92,0)
 ;
"RTN","PSUOP3",93,0)
 ;
"RTN","PSUOP3",94,0)
 ;**Add AMIS data
"RTN","PSUOP3",95,0)
 ;
"RTN","PSUOP3",96,0)
 S REC2=REC2_$G(PSUCLN)_PSU2U             ;Clinic
"RTN","PSUOP3",97,0)
 ;
"RTN","PSUOP3",98,0)
 S REC2=REC2_$G(PSUCMID)_PSU2U            ;CMOP ID
"RTN","PSUOP3",99,0)
 ;
"RTN","PSUOP3",100,0)
 I $G(PSUFP) D
"RTN","PSUOP3",101,0)
 .S REC2=REC2_PSUSITE_$G(PSUFP)_PSU2U      ;Finishing person
"RTN","PSUOP3",102,0)
 I '$G(PSUFP) D
"RTN","PSUOP3",103,0)
 .S REC2=REC2_PSU2U
"RTN","PSUOP3",104,0)
 ;
"RTN","PSUOP3",105,0)
 ;Login dates for new orders, refills, and partials
"RTN","PSUOP3",106,0)
 I PSUTYP="N" S REC2=REC2_$G(PSUORDT)_PSU2U       ;New fills
"RTN","PSUOP3",107,0)
 I PSUTYP="R" S REC2=REC2_$G(PSUREDT)_PSU2U       ;Refills
"RTN","PSUOP3",108,0)
 I PSUTYP="P" S REC2=REC2_$G(PSUPDT)_PSU2U        ;Partials
"RTN","PSUOP3",109,0)
 ;
"RTN","PSUOP3",110,0)
 S REC2=REC2_$G(PSUCOPAY)_PSU2U           ;Copay status
"RTN","PSUOP3",111,0)
 S REC2=REC2_$E($G(PSUPI),1,80)_PSU2U     ;Expanded Instructions
"RTN","PSUOP3",112,0)
 S REC2=REC2_$G(PSUMDFLG)_PSU2U           ;Multidose Flag
"RTN","PSUOP3",113,0)
 ;
"RTN","PSUOP3",114,0)
 ;**Single dose date and first dose of multidose data
"RTN","PSUOP3",115,0)
 ;are in the following records**
"RTN","PSUOP3",116,0)
 ;
"RTN","PSUOP3",117,0)
 S REC2=REC2_$G(PSUDSG)_PSU2U             ;Dosage Ordered
"RTN","PSUOP3",118,0)
 S REC2=REC2_$G(PSUDISPU)_PSU2U           ;Dispense units
"RTN","PSUOP3",119,0)
 S REC2=REC2_$G(PSUNITS)_PSU2U            ;Units
"RTN","PSUOP3",120,0)
 S REC2=REC2_$G(PSUNOUN)_PSU2U            ;Noun
"RTN","PSUOP3",121,0)
 S REC2=REC2_$G(PSUDUR)_PSU2U             ;Duration
"RTN","PSUOP3",122,0)
 S REC2=REC2_$G(PSUCONJ)_PSU2U            ;Conjunction
"RTN","PSUOP3",123,0)
 S REC2=REC2_$G(PSUROUT)_PSU2U            ;Route
"RTN","PSUOP3",124,0)
 S REC2=REC2_$G(PSUSCHED)_PSU2U           ;Schedule
"RTN","PSUOP3",125,0)
 S REC2=REC2_$G(PSUVERB)_PSU2U            ;Verb
"RTN","PSUOP3",126,0)
 ;
"RTN","PSUOP3",127,0)
 ;**End of Single dose/First multidose data
"RTN","PSUOP3",128,0)
 ;
"RTN","PSUOP3",129,0)
 ;**The following are single dose globals for MailMan
"RTN","PSUOP3",130,0)
 ;
"RTN","PSUOP3",131,0)
 S PSURCT=1+$P($G(^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,0)),U,1)
"RTN","PSUOP3",132,0)
 S ^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,PSURCT,1)=REC1
"RTN","PSUOP3",133,0)
 S ^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,PSURCT,2)=REC2
"RTN","PSUOP3",134,0)
 S $P(^XTMP(PSUOPSUB,"DATA",PSUSITE,PSURXIEN,0),U,1)=PSURCT
"RTN","PSUOP3",135,0)
 I (($E(PSUOPVER)=6)&(PSUTYP="P"))!($E(PSUOPVER)>6) S ^XTMP(PSUOPSUB,"RXIEN",PSURXIEN)=""
"RTN","PSUOP3",136,0)
 ;**End of single dose globals for MailMan
"RTN","PSUOP3",137,0)
 ;
"RTN","PSUOP3",138,0)
 ;**Multidose records
"RTN","PSUOP3",139,0)
 ;
"RTN","PSUOP3",140,0)
 I $D(PSUMDFLG) D
"RTN","PSUOP3",141,0)
 .S PSUD1=1
"RTN","PSUOP3",142,0)
 .F  S PSUD1=$O(^TMP("PSOR",$J,PSURXIEN,"MI",PSUD1)) Q:PSUD1=""  D
"RTN","PSUOP3",143,0)
 ..S PSUAMMD=^TMP("PSOR",$J,PSURXIEN,"MI",PSUD1,0)
"RTN","PSUOP3",144,0)
 ..D MULTI^PSUOPAM                          ;Set multidose variables
"RTN","PSUOP3",145,0)
 ..I $L(REC3)>180 D REC4 Q
"RTN","PSUOP3",146,0)
 ..S REC3=REC3_$G(PSUDSGMD)_PSU2U           ;Dosage Ordered
"RTN","PSUOP3",147,0)
 ..S REC3=REC3_$G(PSUDSPMD)_PSU2U           ;Dispense units
"RTN","PSUOP3",148,0)
 ..S REC3=REC3_$G(PSUNITMD)_PSU2U           ;Units
"RTN","PSUOP3",149,0)
 ..S REC3=REC3_$G(PSUNMD)_PSU2U             ;Noun
"RTN","PSUOP3",150,0)
 ..S REC3=REC3_$G(PSUDURMD)_PSU2U           ;Duration
"RTN","PSUOP3",151,0)
 ..S REC3=REC3_$G(PSUCONMD)_PSU2U           ;Conjunction
"RTN","PSUOP3",152,0)
 ..S REC3=REC3_$G(PSURTMD)_PSU2U            ;Route
"RTN","PSUOP3",153,0)
 ..S REC3=REC3_$G(PSUSCHMD)_PSU2U           ;Schedule
"RTN","PSUOP3",154,0)
 ..S REC3=REC3_$G(PSUVRBMD)_PSU2U           ;Verb
"RTN","PSUOP3",155,0)
 ..;
"RTN","PSUOP3",156,0)
 ..;**End of Multidose data
"RTN","PSUOP3",157,0)
 ..;**End AMIS data
"RTN","PSUOP3",158,0)
 ..;
"RTN","PSUOP3",159,0)
 ..;
"RTN","PSUOP3",160,0)
 ..;global for multidose records for MailMan
"RTN","PSUOP3",161,0)
 I $D(PSUMDFLG) D
"RTN","PSUOP3",162,0)
 .S PSURCT=1+$P($G(^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,0)),U,1)
"RTN","PSUOP3",163,0)
 .S ^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,PSURCT,1)=REC1
"RTN","PSUOP3",164,0)
 .S ^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,PSURCT,2)=REC2
"RTN","PSUOP3",165,0)
 .S ^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,PSURCT,3)=REC3
"RTN","PSUOP3",166,0)
 .I $L(REC4)>1 S ^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,PSURCT,4)=REC4
"RTN","PSUOP3",167,0)
 .I $L(REC5)>1 S ^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,PSURCT,5)=REC5
"RTN","PSUOP3",168,0)
 .I $L(REC6)>1 S ^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,PSURCT,6)=REC6
"RTN","PSUOP3",169,0)
 .;
"RTN","PSUOP3",170,0)
 .S $P(^XTMP(PSUOPSUB,"DATAMD",PSUSITE,PSURXIEN,0),U,1)=PSURCT
"RTN","PSUOP3",171,0)
 ;
"RTN","PSUOP3",172,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUOPFLG")) D
"RTN","PSUOP3",173,0)
 .D LAB^PSULR0("OP",PSUSITE,PSURXIEN,DFN,PSUGNM,PSUVACLS)
"RTN","PSUOP3",174,0)
SUMDRUG ; total drug info for summary report
"RTN","PSUOP3",175,0)
 S PSUVARS="PSUTPART,PSUTFIL,PSUTRFIL,PSUTCST,PSUTQTY"
"RTN","PSUOP3",176,0)
 S PSUREC=$G(^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUGNM,PSUCMOP))
"RTN","PSUOP3",177,0)
 F I=1:1:5 S @$P(PSUVARS,",",I)=+$P(PSUREC,U,I)
"RTN","PSUOP3",178,0)
 I PSUTYP="P" S PSUTPART=PSUTPART+1
"RTN","PSUOP3",179,0)
 I PSUTYP="N" S PSUTFIL=PSUTFIL+1
"RTN","PSUOP3",180,0)
 I PSUTYP="R" S PSUTRFIL=PSUTRFIL+1
"RTN","PSUOP3",181,0)
 S PSUTQTY=PSUQTY+PSUTQTY
"RTN","PSUOP3",182,0)
 S PSUTCST=(PSUDRCT*PSUQTY)+PSUTCST
"RTN","PSUOP3",183,0)
 S REC=PSUTPART_U_PSUTFIL_U_PSUTRFIL_U_$J(PSUTCST,0,2)_U_$J(PSUTQTY,0,2)
"RTN","PSUOP3",184,0)
 S $P(REC,U,6)=$S(PSUNFI="N/F":"*",1:"")
"RTN","PSUOP3",185,0)
 S $P(REC,U,7)=$S(PSOPNFI="0":"#",1:"")
"RTN","PSUOP3",186,0)
 S ^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUGNM,PSUCMOP)=REC
"RTN","PSUOP3",187,0)
 Q
"RTN","PSUOP3",188,0)
 ;
"RTN","PSUOP3",189,0)
REC4 ;Multidose records greater than 200 characters in length
"RTN","PSUOP3",190,0)
 ;
"RTN","PSUOP3",191,0)
 I $L(REC4)>180 D REC5 Q
"RTN","PSUOP3",192,0)
 S REC4=REC4_$G(PSUDSGMD)_PSU2U           ;Dosage Ordered
"RTN","PSUOP3",193,0)
 S REC4=REC4_$G(PSUDSPMD)_PSU2U           ;Dispense units
"RTN","PSUOP3",194,0)
 S REC4=REC4_$G(PSUNITMD)_PSU2U           ;Units
"RTN","PSUOP3",195,0)
 S REC4=REC4_$G(PSUNMD)_PSU2U             ;Noun
"RTN","PSUOP3",196,0)
 S REC4=REC4_$G(PSUDURMD)_PSU2U           ;Duration
"RTN","PSUOP3",197,0)
 S REC4=REC4_$G(PSUCONMD)_PSU2U           ;Conjunction
"RTN","PSUOP3",198,0)
 S REC4=REC4_$G(PSURTMD)_PSU2U            ;Route
"RTN","PSUOP3",199,0)
 S REC4=REC4_$G(PSUSCHMD)_PSU2U           ;Schedule
"RTN","PSUOP3",200,0)
 S REC4=REC4_$G(PSUVRBMD)_PSU2U           ;Verb
"RTN","PSUOP3",201,0)
 Q
"RTN","PSUOP3",202,0)
REC5 ;
"RTN","PSUOP3",203,0)
 I $L(REC5)>180 D REC6 Q
"RTN","PSUOP3",204,0)
 S REC5=REC5_$G(PSUDSGMD)_PSU2U           ;Dosage Ordered
"RTN","PSUOP3",205,0)
 S REC5=REC5_$G(PSUDSPMD)_PSU2U           ;Dispense units
"RTN","PSUOP3",206,0)
 S REC5=REC5_$G(PSUNITMD)_PSU2U           ;Units
"RTN","PSUOP3",207,0)
 S REC5=REC5_$G(PSUNMD)_PSU2U             ;Noun
"RTN","PSUOP3",208,0)
 S REC5=REC5_$G(PSUDURMD)_PSU2U           ;Duration
"RTN","PSUOP3",209,0)
 S REC5=REC5_$G(PSUCONMD)_PSU2U           ;Conjunction
"RTN","PSUOP3",210,0)
 S REC5=REC5_$G(PSURTMD)_PSU2U            ;Route
"RTN","PSUOP3",211,0)
 S REC5=REC5_$G(PSUSCHMD)_PSU2U           ;Schedule
"RTN","PSUOP3",212,0)
 S REC5=REC5_$G(PSUVRBMD)_PSU2U           ;Verb
"RTN","PSUOP3",213,0)
 Q
"RTN","PSUOP3",214,0)
REC6 ;
"RTN","PSUOP3",215,0)
 S REC6=REC6_$G(PSUDSGMD)_PSU2U           ;Dosage Ordered
"RTN","PSUOP3",216,0)
 S REC6=REC6_$G(PSUDSPMD)_PSU2U           ;Dispense units
"RTN","PSUOP3",217,0)
 S REC6=REC6_$G(PSUNITMD)_PSU2U           ;Units
"RTN","PSUOP3",218,0)
 S REC6=REC6_$G(PSUNMD)_PSU2U             ;Noun
"RTN","PSUOP3",219,0)
 S REC6=REC6_$G(PSUDURMD)_PSU2U           ;Duration
"RTN","PSUOP3",220,0)
 S REC6=REC6_$G(PSUCONMD)_PSU2U           ;Conjunction
"RTN","PSUOP3",221,0)
 S REC6=REC6_$G(PSURTMD)_PSU2U            ;Route
"RTN","PSUOP3",222,0)
 S REC6=REC6_$G(PSUSCHMD)_PSU2U           ;Schedule
"RTN","PSUOP3",223,0)
 S REC6=REC6_$G(PSUVRBMD)_PSU2U           ;Verb
"RTN","PSUOP3",224,0)
 Q
"RTN","PSUOP4")
0^70^B18575142
"RTN","PSUOP4",1,0)
PSUOP4 ;BIR/CFL - PSU PBM Outpatient Pharmacy create mailman messages ;10 JUL 1999
"RTN","PSUOP4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP4",3,0)
 ;
"RTN","PSUOP4",4,0)
 ;DBIA(s)
"RTN","PSUOP4",5,0)
 ; Reference to file #4.3 supported by DBIA 2496
"RTN","PSUOP4",6,0)
 ; Reference to file #59  supported by DBIA 2510
"RTN","PSUOP4",7,0)
 ; Reference to file #4   supported by DBIA 10090
"RTN","PSUOP4",8,0)
 ;
"RTN","PSUOP4",9,0)
EN ;
"RTN","PSUOP4",10,0)
 ;
"RTN","PSUOP4",11,0)
 S $P(PSUDASH,"-",100)=""
"RTN","PSUOP4",12,0)
 S $P(PSUFILL," ",100)=""
"RTN","PSUOP4",13,0)
 ;Organize index of ^XTMP("DATA") global
"RTN","PSUOP4",14,0)
 S (PSUDV,PSUTMP)=""
"RTN","PSUOP4",15,0)
 F  S PSUDV=$O(^XTMP(PSUOPSUB,"DATA",PSUDV)) Q:PSUDV=""  D
"RTN","PSUOP4",16,0)
 .S PSULCT=0
"RTN","PSUOP4",17,0)
 .S PSURXIEN=""
"RTN","PSUOP4",18,0)
 .F  S PSURXIEN=$O(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP4",19,0)
 ..S PSURCT=0
"RTN","PSUOP4",20,0)
 ..F  S PSURCT=$O(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT)) Q:PSURCT=""  D
"RTN","PSUOP4",21,0)
 ...D DATA^PSUOP7       ;Gather data for AMIS summary report
"RTN","PSUOP4",22,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOP4",23,0)
 ...S ^XTMP(PSUOPSUB,"RECORDS",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1)
"RTN","PSUOP4",24,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOP4",25,0)
 ...S ^XTMP(PSUOPSUB,"RECORDS",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,2)
"RTN","PSUOP4",26,0)
 ...;S PSULCT=PSULCT+1
"RTN","PSUOP4",27,0)
 ...;S ^XTMP(PSUOPSUB,"RECORDS",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,3)
"RTN","PSUOP4",28,0)
 ;
"RTN","PSUOP4",29,0)
 ;
"RTN","PSUOP4",30,0)
 ;Create global for Patient Demographics summary message
"RTN","PSUOP4",31,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUDIVPT")=^XTMP(PSUOPSUB,"RECORDS")
"RTN","PSUOP4",32,0)
 S PSUST=0
"RTN","PSUOP4",33,0)
 F  S PSUST=$O(^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUST)) Q:PSUST=""  D
"RTN","PSUOP4",34,0)
 .S PSUST1=0
"RTN","PSUOP4",35,0)
 .F  S PSUST1=$O(^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUST,PSUST1)) Q:PSUST1=""  D
"RTN","PSUOP4",36,0)
 ..I $P(^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUST,PSUST1),U,1)["*" D
"RTN","PSUOP4",37,0)
 ...K ^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUST,PSUST1)
"RTN","PSUOP4",38,0)
 ;
"RTN","PSUOP4",39,0)
MSG ;Set up the number of lines and messages for mailman
"RTN","PSUOP4",40,0)
 ;
"RTN","PSUOP4",41,0)
 S PSUNOREC="",NONE=""
"RTN","PSUOP4",42,0)
 S PSUMSGT("M")=0,PSUMSGT("L")=0
"RTN","PSUOP4",43,0)
 I '$D(^XTMP(PSUOPSUB,"RECORDS")) D NODATA Q  ;Do not go any further if there is no data to report
"RTN","PSUOP4",44,0)
 S PSUDIV=0,Z=0
"RTN","PSUOP4",45,0)
 F  S PSUDIV=$O(^XTMP(PSUOPSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUOP4",46,0)
 .S X=PSUDIV,DIC=59,DIC(0)="XM" D ^DIC ;;1
"RTN","PSUOP4",47,0)
 .S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP4",48,0)
 .;VMP OIFO BAY PINES;ELR;PSU*3.0*31
"RTN","PSUOP4",49,0)
 .I '$L(PSUDIVNM) S X=PSUDIV D DIVNM^PSUOP6
"RTN","PSUOP4",50,0)
 .I PSUMASF!PSUDUZ!PSUPBMG D 
"RTN","PSUOP4",51,0)
 ..I 'PSUSMRY D XMD,SETCNT
"RTN","PSUOP4",52,0)
 .D RECLOOP^PSUOP5,RECSUM^PSUOP5 ; send statistical summary
"RTN","PSUOP4",53,0)
 .I 'PSUSMRY D DRUGSUM^PSUOP5 ; send drug summary on condition
"RTN","PSUOP4",54,0)
 Q
"RTN","PSUOP4",55,0)
XMD ;
"RTN","PSUOP4",56,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUOP4",57,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUOP4",58,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUOP4",59,0)
 K ^XTMP(PSUOPSUB,"XMD")
"RTN","PSUOP4",60,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUOP4",61,0)
 F PSULC=1:1 S X=$G(^XTMP(PSUOPSUB,"RECORDS",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSUOP4",62,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUOP4",63,0)
 .I PSUMLC>PSUMAX D
"RTN","PSUOP4",64,0)
 ..I $E(X,1)="*"  D
"RTN","PSUOP4",65,0)
 ...S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,1)=^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOP4",66,0)
 ...K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOP4",67,0)
 ...S PSUMC=PSUMC+1,PSUMLC=2
"RTN","PSUOP4",68,0)
 ..I $E(X,1)'="*" S PSUMC=PSUMC+1,PSUMLC=1               ; +  message
"RTN","PSUOP4",69,0)
 .I $L(X)<250 S ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC)=X Q
"RTN","PSUOP4",70,0)
 .F I=250:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUOP4",71,0)
 .S ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUOP4",72,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUOP4",73,0)
 .S ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUOP4",74,0)
 ;
"RTN","PSUOP4",75,0)
 ;   Count Lines sent
"RTN","PSUOP4",76,0)
 S PSUTLC=0
"RTN","PSUOP4",77,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSUOPSUB,"XMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUOP4",78,0)
 ;
"RTN","PSUOP4",79,0)
 ;   Transmit Messages
"RTN","PSUOP4",80,0)
VARS ; Setup variables for contents
"RTN","PSUOP4",81,0)
 F PSUM=1:1:PSUMC D
"RTN","PSUOP4",82,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUOP4",83,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUOP4",84,0)
 .S XMSUB="V. 4.0 PBMOP "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUOP4",85,0)
 .S XMTEXT="^XTMP(PSUOPSUB,""XMD"",PSUM,"
"RTN","PSUOP4",86,0)
 .S XMCHAN=1
"RTN","PSUOP4",87,0)
 .I PSUMASF!PSUDUZ!PSUPBMG D
"RTN","PSUOP4",88,0)
 ..M XMY=PSUXMYH
"RTN","PSUOP4",89,0)
 .I 'PSUMASF M XMY=PSUXMYS1
"RTN","PSUOP4",90,0)
 .D ^XMD
"RTN","PSUOP4",91,0)
 ;
"RTN","PSUOP4",92,0)
 S:NONE PSUTLC=0
"RTN","PSUOP4",93,0)
 S PSUMSG("M")=PSUMC
"RTN","PSUOP4",94,0)
 S PSUMSG("L")=PSUTLC
"RTN","PSUOP4",95,0)
 Q
"RTN","PSUOP4",96,0)
NODATA ;Send "No data to report" message
"RTN","PSUOP4",97,0)
 S ^XTMP(PSUOPSUB,"RECORDS",PSUSNDR,1)="No data to report"
"RTN","PSUOP4",98,0)
 S NONE=1,PSUDIV=PSUSNDR
"RTN","PSUOP4",99,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUNONE","RX")=""
"RTN","PSUOP4",100,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*31
"RTN","PSUOP4",101,0)
 S X=PSUDIV D DIVNM^PSUOP6
"RTN","PSUOP4",102,0)
 D XMD
"RTN","PSUOP4",103,0)
SETCNT ;Set message count and line count
"RTN","PSUOP4",104,0)
 S PSUMSGT(PSUDIV,"M")=$G(PSUMSGT(PSUDIV,"M"))+PSUMSG("M")
"RTN","PSUOP4",105,0)
 S PSUMSGT(PSUDIV,"L")=$G(PSUMSGT(PSUDIV,"L"))+PSUMSG("L")
"RTN","PSUOP4",106,0)
 S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUDIV,PSUOPTN,"M")=PSUMSGT(PSUDIV,"M")
"RTN","PSUOP4",107,0)
 S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUDIV,PSUOPTN,"L")=PSUMSGT(PSUDIV,"L")
"RTN","PSUOP4",108,0)
 Q
"RTN","PSUOP5")
0^71^B30961537
"RTN","PSUOP5",1,0)
PSUOP5 ;BIR/CFL,TJH;PSU PBM Outpatient Pharmacy summary statistical data; 08/25/1998
"RTN","PSUOP5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP5",3,0)
 ;
"RTN","PSUOP5",4,0)
RECLOOP ; loop through 'by-drug' totals to get grand totals
"RTN","PSUOP5",5,0)
 ;
"RTN","PSUOP5",6,0)
 ;
"RTN","PSUOP5",7,0)
 S PSUSITE=""
"RTN","PSUOP5",8,0)
 F  S PSUSITE=$O(^XTMP(PSUOPSUB,"DRUG",PSUSITE)) Q:PSUSITE=""  D
"RTN","PSUOP5",9,0)
 .F I=1:1:9 S PSUSUMT(I)=0
"RTN","PSUOP5",10,0)
 .S PSUDNM=""
"RTN","PSUOP5",11,0)
 .F  S PSUDNM=$O(^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUDNM)) Q:PSUDNM=""  D
"RTN","PSUOP5",12,0)
 ..S PSUNR=$G(^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUDNM,"N"))
"RTN","PSUOP5",13,0)
 ..S PSUYR=$G(^XTMP(PSUOPSUB,"DRUG",PSUSITE,PSUDNM,"Y"))
"RTN","PSUOP5",14,0)
 ..F I=1:1:4 S PSUSUMT(I)=PSUSUMT(I)+$P(PSUNR,U,I)
"RTN","PSUOP5",15,0)
 ..F I=5:1:7 S PSUSUMT(I)=PSUSUMT(I)+$P(PSUYR,U,I-3)
"RTN","PSUOP5",16,0)
 .S PSUDVD=(PSUSUMT(1)+PSUSUMT(2)+PSUSUMT(3))
"RTN","PSUOP5",17,0)
 .I PSUDVD S PSUSUMT(8)=PSUSUMT(4)/PSUDVD
"RTN","PSUOP5",18,0)
 .S PSUDVD=(PSUSUMT(5)+PSUSUMT(6))
"RTN","PSUOP5",19,0)
 .I PSUDVD S PSUSUMT(9)=PSUSUMT(7)/PSUDVD
"RTN","PSUOP5",20,0)
 .F I=1:1:9 S $P(PSUREC,U,I)=PSUSUMT(I)
"RTN","PSUOP5",21,0)
 .S ^XTMP(PSUOPSUB,"SUMMARY",PSUSITE)=PSUREC
"RTN","PSUOP5",22,0)
 Q
"RTN","PSUOP5",23,0)
 ;
"RTN","PSUOP5",24,0)
RECSUM ;Set up statistical summary data to be printed
"RTN","PSUOP5",25,0)
 I PSUNOREC Q
"RTN","PSUOP5",26,0)
 K PSULINE,J
"RTN","PSUOP5",27,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y
"RTN","PSUOP5",28,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y
"RTN","PSUOP5",29,0)
 F I=1:1:9 S J(I)=$P(^XTMP(PSUOPSUB,"SUMMARY",PSUDIV),"^",I)
"RTN","PSUOP5",30,0)
 S PSULINE(1)="Outpatient Statistical Data Summary for "_PSUDTS_" through "_PSUDTE
"RTN","PSUOP5",31,0)
 S PSULINE(2)=" "
"RTN","PSUOP5",32,0)
 S X="",X=$$SETSTR^VALM1("Consolidated Mail Out Pharmacy (CMOP)",X,43,37)
"RTN","PSUOP5",33,0)
 S PSULINE(3)=X
"RTN","PSUOP5",34,0)
 S PSULINE(4)=" "
"RTN","PSUOP5",35,0)
 S X="",X=$$SETSTR^VALM1("Total",X,34,5),X=$$SETSTR^VALM1("Total",X,69,5)
"RTN","PSUOP5",36,0)
 S PSULINE(5)=X
"RTN","PSUOP5",37,0)
 S X="",X="Partials",X=$$SETSTR^VALM1("Fills",X,13,5)
"RTN","PSUOP5",38,0)
 S X=$$SETSTR^VALM1("Refills",X,22,7),X=$$SETSTR^VALM1("Cost",X,35,4)
"RTN","PSUOP5",39,0)
 S X=$$SETSTR^VALM1("Fills",X,48,5),X=$$SETSTR^VALM1("Refills",X,57,7)
"RTN","PSUOP5",40,0)
 S X=$$SETSTR^VALM1("Cost",X,70,4)
"RTN","PSUOP5",41,0)
 S PSULINE(6)=X
"RTN","PSUOP5",42,0)
 S PSULINE(7)=$E(PSUDASH,1,79)
"RTN","PSUOP5",43,0)
 S X=$J(J(1),6)_$J(J(2),10)_$J(J(3),11)_$J(J(4),12,2)_$J(J(5),12)_$J(J(6),11)_$J(J(7),12,2)
"RTN","PSUOP5",44,0)
 S PSULINE(8)=X
"RTN","PSUOP5",45,0)
 S PSULINE(9)=" "
"RTN","PSUOP5",46,0)
 S X=$E("Avg. Cost/Fill = $"_$J(J(8),0,2)_PSUFILL,1,47)_"Avg. Cost/Fill = $"_$J(J(9),0,2)
"RTN","PSUOP5",47,0)
 S PSULINE(10)=X
"RTN","PSUOP5",48,0)
 S XMCHAN=1
"RTN","PSUOP5",49,0)
 S XMSUB="V. 4.0 PBMOP "_$G(PSUMON)_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUOP5",50,0)
 S XMTEXT="PSULINE("
"RTN","PSUOP5",51,0)
 M XMY=PSUXMYS1
"RTN","PSUOP5",52,0)
 D ^XMD
"RTN","PSUOP5",53,0)
 M ^XTMP(PSUOPSUB,"STATSUM",PSUDIV)=PSULINE
"RTN","PSUOP5",54,0)
 Q
"RTN","PSUOP5",55,0)
 ;
"RTN","PSUOP5",56,0)
DRUGSUM ; create the Drug Summary
"RTN","PSUOP5",57,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*32
"RTN","PSUOP5",58,0)
 K ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV)
"RTN","PSUOP5",59,0)
 S PSUHDR0="Outpatient Statistical Data for "_PSUDTS_" through "_PSUDTE
"RTN","PSUOP5",60,0)
 S PSUHDR1=$J("Total     Total Qty",96)
"RTN","PSUOP5",61,0)
 S PSUHDR2="Drug Name"_$J("Partials    Fills  Refills     Cost     Dispensed",87)
"RTN","PSUOP5",62,0)
 S PSUHDR3="Drug Name"_$J("Fills  Refills     Cost     Dispensed",87)
"RTN","PSUOP5",63,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,1)=PSUHDR0
"RTN","PSUOP5",64,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,2)=$J("Page: 1",89)
"RTN","PSUOP5",65,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,3)=" "
"RTN","PSUOP5",66,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,4)=PSUHDR1
"RTN","PSUOP5",67,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,5)=PSUHDR2
"RTN","PSUOP5",68,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,6)=$E(PSUDASH,1,96)
"RTN","PSUOP5",69,0)
 S PSUDN="",PSULN=6
"RTN","PSUOP5",70,0)
 F I=1:1:4 S PSUTOT(I)=0
"RTN","PSUOP5",71,0)
 F  S PSUDN=$O(^XTMP(PSUOPSUB,"DRUG",PSUDIV,PSUDN)) Q:PSUDN=""  D
"RTN","PSUOP5",72,0)
 .S PSUR=$G(^XTMP(PSUOPSUB,"DRUG",PSUDIV,PSUDN,"N"))
"RTN","PSUOP5",73,0)
 .Q:PSUR=""
"RTN","PSUOP5",74,0)
 .F I=1:1:7 S PSUF(I)=$P(PSUR,U,I) S:I<5 PSUTOT(I)=PSUTOT(I)+PSUF(I)
"RTN","PSUOP5",75,0)
 .S PSULINE=$E(PSUDN_" "_PSUF(6)_PSUF(7)_PSUFILL,1,43)_$J(PSUF(1),9)
"RTN","PSUOP5",76,0)
 .S PSULINE=PSULINE_$J(PSUF(2),9)_$J(PSUF(3),9)_$J(PSUF(4),13,2)_$J(PSUF(5),13,2)
"RTN","PSUOP5",77,0)
 .S PSULN=PSULN+1
"RTN","PSUOP5",78,0)
 .S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=PSULINE
"RTN","PSUOP5",79,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",80,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=$E(PSUDASH,1,96)
"RTN","PSUOP5",81,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",82,0)
 S PSULINE=$E("Totals:"_PSUFILL,1,43)_$J(PSUTOT(1),9)_$J(PSUTOT(2),9)_$J(PSUTOT(3),9)_$J(PSUTOT(4),13,2)
"RTN","PSUOP5",83,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=PSULINE
"RTN","PSUOP5",84,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",85,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=" "
"RTN","PSUOP5",86,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",87,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)="* Non-Formulary"
"RTN","PSUOP5",88,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",89,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)="# Not on National Formulary"
"RTN","PSUOP5",90,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",91,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=" "
"RTN","PSUOP5",92,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",93,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=$J("Consolidated Mail Out Pharmacy (CMOP)",66)
"RTN","PSUOP5",94,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",95,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=" "
"RTN","PSUOP5",96,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",97,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=PSUHDR1
"RTN","PSUOP5",98,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",99,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=PSUHDR3
"RTN","PSUOP5",100,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",101,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=$E(PSUDASH,1,96)
"RTN","PSUOP5",102,0)
 S PSUDN=""
"RTN","PSUOP5",103,0)
 F I=1:1:4 S PSUTOT(I)=0
"RTN","PSUOP5",104,0)
 F  S PSUDN=$O(^XTMP(PSUOPSUB,"DRUG",PSUDIV,PSUDN)) Q:PSUDN=""  D
"RTN","PSUOP5",105,0)
 .S PSUR=$G(^XTMP(PSUOPSUB,"DRUG",PSUDIV,PSUDN,"Y"))
"RTN","PSUOP5",106,0)
 .Q:PSUR=""
"RTN","PSUOP5",107,0)
 .F I=1:1:7 S PSUF(I)=$P(PSUR,U,I) S:I<5 PSUTOT(I)=PSUTOT(I)+PSUF(I)
"RTN","PSUOP5",108,0)
 .S PSULINE=$E(PSUDN_" "_PSUF(6)_PSUF(7)_PSUFILL,1,43)_$J("",9)
"RTN","PSUOP5",109,0)
 .S PSULINE=PSULINE_$J(PSUF(2),9)_$J(PSUF(3),9)_$J(PSUF(4),13,2)_$J(PSUF(5),13,2)
"RTN","PSUOP5",110,0)
 .S PSULN=PSULN+1
"RTN","PSUOP5",111,0)
 .S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=PSULINE
"RTN","PSUOP5",112,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",113,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=$E(PSUDASH,1,96)
"RTN","PSUOP5",114,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",115,0)
 S PSULINE=$E("Totals:"_PSUFILL,1,43)_$J("",9)_$J(PSUTOT(2),9)_$J(PSUTOT(3),9)_$J(PSUTOT(4),13,2)
"RTN","PSUOP5",116,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=PSULINE
"RTN","PSUOP5",117,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",118,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)=" "
"RTN","PSUOP5",119,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",120,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)="* Non-Formulary"
"RTN","PSUOP5",121,0)
 S PSULN=PSULN+1
"RTN","PSUOP5",122,0)
 S ^XTMP(PSUOPSUB,"DRUGSUM",PSUDIV,PSULN)="# Not on National Formulary"
"RTN","PSUOP5",123,0)
 S XMSUB="V. 4.0 PBMOP "_PSUMON_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUOP5",124,0)
 S XMTEXT="^XTMP(PSUOPSUB,""DRUGSUM"",PSUDIV,"
"RTN","PSUOP5",125,0)
 S XMCHAN=1
"RTN","PSUOP5",126,0)
 M XMY=PSUXMYS2
"RTN","PSUOP5",127,0)
 D ^XMD
"RTN","PSUOP5",128,0)
 Q
"RTN","PSUOP6")
0^72^B17769512
"RTN","PSUOP6",1,0)
PSUOP6 ;BIR/REG - PSU PBM Outpatient Pharmacy Printer Output ;10 JUL 1999
"RTN","PSUOP6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP6",3,0)
 ;
"RTN","PSUOP6",4,0)
 ;DBIA(s)
"RTN","PSUOP6",5,0)
 ; Reference to file #59 supported by DBIA 2510
"RTN","PSUOP6",6,0)
 ;
"RTN","PSUOP6",7,0)
 ;PRINT CYCLE CONTROLLER FOR OUTPATIENT PHARMACY SUMMARY REPORT
"RTN","PSUOP6",8,0)
 ;
"RTN","PSUOP6",9,0)
EP ;
"RTN","PSUOP6",10,0)
 NEW PSUI,PSUH,PSUL,PSUM,PSUPGS
"RTN","PSUOP6",11,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUOP6",12,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUOP6",13,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUOP6",14,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUOP6",15,0)
 U IO
"RTN","PSUOP6",16,0)
 ;
"RTN","PSUOP6",17,0)
PRTSUMS ;
"RTN","PSUOP6",18,0)
 ; Find first Division/Facility in the summary by division
"RTN","PSUOP6",19,0)
 ; then DO the PRTALL routine
"RTN","PSUOP6",20,0)
 S PSUOPSUB="PSUOP_"_PSUJOB
"RTN","PSUOP6",21,0)
 I '$D(^XTMP(PSUOPSUB,"STATSUM")) D
"RTN","PSUOP6",22,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUNONE2")=""
"RTN","PSUOP6",23,0)
 .S ^XTMP(PSUOPSUB,"STATSUM",PSUSNDR,1)="Outpatient Statistical Data Summary for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUOP6",24,0)
 .S ^XTMP(PSUOPSUB,"STATSUM",PSUSNDR,2)=" "
"RTN","PSUOP6",25,0)
 .S ^XTMP(PSUOPSUB,"STATSUM",PSUSNDR,3)="No data to report"
"RTN","PSUOP6",26,0)
 ;
"RTN","PSUOP6",27,0)
 S PSUFACN=""
"RTN","PSUOP6",28,0)
 ;VMP-IOFO BAY PINES;ELR;PSU*3.0*26
"RTN","PSUOP6",29,0)
 NEW PSUFIRST
"RTN","PSUOP6",30,0)
 F  S PSUFACN=$O(^XTMP(PSUOPSUB,"STATSUM",PSUFACN)) Q:PSUFACN=""  D PRTALL
"RTN","PSUOP6",31,0)
 ;
"RTN","PSUOP6",32,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D PRTAMIS  ;Print OPAMIS SUMMARY
"RTN","PSUOP6",33,0)
 ;
"RTN","PSUOP6",34,0)
 D PULL^PSUCP
"RTN","PSUOP6",35,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUOP6",36,0)
 ;
"RTN","PSUOP6",37,0)
 ;Call Pt. Demographics summary report/No data when user selects
"RTN","PSUOP6",38,0)
 ;(1)IV and (2)UD and (4)Rx
"RTN","PSUOP6",39,0)
 ;(1)IV and (4)Rx
"RTN","PSUOP6",40,0)
 ;(2)UD and (4)Rx
"RTN","PSUOP6",41,0)
 I $D(PSUMOD(1))!$D(PSUMOD(2)) D IVSUM^PSUDEM0
"RTN","PSUOP6",42,0)
 ;
"RTN","PSUOP6",43,0)
 ;Call Pt. Demographics summary report/No data when user selects
"RTN","PSUOP6",44,0)
 ;(4)IV alone.
"RTN","PSUOP6",45,0)
 I '$D(PSUMOD(1))&'$D(PSUMOD(2)) D IVSUM^PSUDEM0
"RTN","PSUOP6",46,0)
 ;
"RTN","PSUOP6",47,0)
 ; Find the first Division/Facility in the summary by drug by division
"RTN","PSUOP6",48,0)
 ; then DO the PRTDRUG routine
"RTN","PSUOP6",49,0)
 Q:PSUSMRY  ; 'summary only' was selected don't print 'by drug'
"RTN","PSUOP6",50,0)
 S PSUFACN=""
"RTN","PSUOP6",51,0)
 I '$D(^XTMP(PSUOPSUB,"DRUGSUM")) D
"RTN","PSUOP6",52,0)
 .S ^XTMP(PSUOPSUB,"DRUGSUM",PSUSNDR,1)="Outpatient Statistical Data for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUOP6",53,0)
 .S ^XTMP(PSUOPSUB,"DRUGSUM",PSUSNDR,2)="                                                                        Page"
"RTN","PSUOP6",54,0)
 .S ^XTMP(PSUOPSUB,"DRUGSUM",PSUSNDR,3)="No data to report"
"RTN","PSUOP6",55,0)
 F  S PSUFACN=$O(^XTMP(PSUOPSUB,"DRUGSUM",PSUFACN)) Q:PSUFACN=""  D PRTDRUG
"RTN","PSUOP6",56,0)
PRTSUMX ; EXIT PSUOP6
"RTN","PSUOP6",57,0)
 W @IOF
"RTN","PSUOP6",58,0)
 ;
"RTN","PSUOP6",59,0)
 Q 
"RTN","PSUOP6",60,0)
 ;
"RTN","PSUOP6",61,0)
PRTALL ; Print the Drug summary of all drugs by Division/Facility
"RTN","PSUOP6",62,0)
 S X=PSUFACN,DIC=59,DIC(0)="XM" D ^DIC ;**1
"RTN","PSUOP6",63,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP6",64,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*31
"RTN","PSUOP6",65,0)
 I '$L(PSUDIVNM) S X=PSUFACN D DIVNM
"RTN","PSUOP6",66,0)
 ;VMP-IOFO BAY PINES;ELR;PSU*3.0*26; REMOVE FORM FEED FIRST TIME THROUGH
"RTN","PSUOP6",67,0)
 I $G(PSUFIRST) W @IOF
"RTN","PSUOP6",68,0)
 S PSUFIRST=1
"RTN","PSUOP6",69,0)
 F I=1:1:3 W !
"RTN","PSUOP6",70,0)
 S PSUL=""
"RTN","PSUOP6",71,0)
 F  S PSUL=$O(^XTMP(PSUOPSUB,"STATSUM",PSUFACN,PSUL)) Q:PSUL=""  D
"RTN","PSUOP6",72,0)
 .W !,^XTMP(PSUOPSUB,"STATSUM",PSUFACN,PSUL)
"RTN","PSUOP6",73,0)
 .I PSUL=1 W " for ",PSUDIVNM,!,?72,"Page: 1" ; will only ever be one page
"RTN","PSUOP6",74,0)
 Q
"RTN","PSUOP6",75,0)
 ; 
"RTN","PSUOP6",76,0)
PRTDRUG ; Print the Drug summary by Drug by Division/Facility
"RTN","PSUOP6",77,0)
 ; Set page number to 0
"RTN","PSUOP6",78,0)
 S PSUPGS("PG")=0
"RTN","PSUOP6",79,0)
 S X=PSUFACN,DIC=59,DIC(0)="XM" D ^DIC
"RTN","PSUOP6",80,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP6",81,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*31
"RTN","PSUOP6",82,0)
 I '$L(PSUDIVNM) S X=PSUFACN D DIVNM
"RTN","PSUOP6",83,0)
 D PGHDR ; Perform 1st page heading
"RTN","PSUOP6",84,0)
 S PSUL=6 ; Report body starts at line 7
"RTN","PSUOP6",85,0)
 F  S PSUL=$O(^XTMP(PSUOPSUB,"DRUGSUM",PSUFACN,PSUL)) Q:PSUL=""  D
"RTN","PSUOP6",86,0)
 .I $Y+4>IOSL D PGHDR
"RTN","PSUOP6",87,0)
 .W !,^XTMP(PSUOPSUB,"DRUGSUM",PSUFACN,PSUL)
"RTN","PSUOP6",88,0)
 ;
"RTN","PSUOP6",89,0)
 Q
"RTN","PSUOP6",90,0)
 ;
"RTN","PSUOP6",91,0)
PRTAMIS ;Print Amis summary report
"RTN","PSUOP6",92,0)
 ;
"RTN","PSUOP6",93,0)
 U IO W @IOF
"RTN","PSUOP6",94,0)
 S PSUPGS("PG")=1
"RTN","PSUOP6",95,0)
 D PGHDR1
"RTN","PSUOP6",96,0)
 S PSUL=3
"RTN","PSUOP6",97,0)
 F  S PSUL=$O(^XTMP("PSU_"_PSUJOB,"OPAMIS",PSUL)) Q:PSUL=""  D
"RTN","PSUOP6",98,0)
 .I LNCNT+4>IOSL D PGHDR1
"RTN","PSUOP6",99,0)
 .W !,^XTMP("PSU_"_PSUJOB,"OPAMIS",PSUL)
"RTN","PSUOP6",100,0)
 .S LNCNT=LNCNT+1
"RTN","PSUOP6",101,0)
 Q
"RTN","PSUOP6",102,0)
 ;
"RTN","PSUOP6",103,0)
PGHDR1 ;AMIS HEADER
"RTN","PSUOP6",104,0)
 U IO W @IOF
"RTN","PSUOP6",105,0)
 F I=1:1:3 W !
"RTN","PSUOP6",106,0)
 F I=1:1:2 W ^XTMP("PSU_"_PSUJOB,"OPAMIS",I)
"RTN","PSUOP6",107,0)
 W !!,?68,"Page: ",PSUPGS("PG")
"RTN","PSUOP6",108,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUOP6",109,0)
 S LNCNT=3
"RTN","PSUOP6",110,0)
 Q
"RTN","PSUOP6",111,0)
 ;
"RTN","PSUOP6",112,0)
PGHDR ;Increment page number and Write Page Heading
"RTN","PSUOP6",113,0)
 ; Writes header lines 1 & 2, then page number, then lines 3 through 6
"RTN","PSUOP6",114,0)
 U IO W @IOF
"RTN","PSUOP6",115,0)
 F I=1:1:3 W !
"RTN","PSUOP6",116,0)
 W !,^XTMP(PSUOPSUB,"DRUGSUM",PSUFACN,1) ;Print 1st line
"RTN","PSUOP6",117,0)
 W " for ",PSUDIVNM ; add division name
"RTN","PSUOP6",118,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUOP6",119,0)
 W !,$P(^XTMP(PSUOPSUB,"DRUGSUM",PSUFACN,2),":",1),": ",PSUPGS("PG"),! ;Print page number
"RTN","PSUOP6",120,0)
 F PSUH=3:1:6 W !,$G(^XTMP(PSUOPSUB,"DRUGSUM",PSUFACN,PSUH)) ;Print next 5 lines  
"RTN","PSUOP6",121,0)
 Q
"RTN","PSUOP6",122,0)
 ;
"RTN","PSUOP6",123,0)
DIVNM ;S PSUDIVNM FROM FILE 40.8 IF NOT IN FILE 59
"RTN","PSUOP6",124,0)
 S DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUOP6",125,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUOP6",126,0)
 Q
"RTN","PSUOP7")
0^73^B17289883
"RTN","PSUOP7",1,0)
PSUOP7 ;BIR/DAM - Outpatient AMIS Summary Data;04 MAR 2004
"RTN","PSUOP7",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP7",3,0)
 ;
"RTN","PSUOP7",4,0)
 ;No DBIA's required
"RTN","PSUOP7",5,0)
 ;
"RTN","PSUOP7",6,0)
DATA ;Gather AMIS summary data from the detailed "DATA" global
"RTN","PSUOP7",7,0)
 ;Called from PSUOP4
"RTN","PSUOP7",8,0)
 ;
"RTN","PSUOP7",9,0)
 N QTY,PRICE,QUANT
"RTN","PSUOP7",10,0)
 ;
"RTN","PSUOP7",11,0)
 S QTY=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,25)
"RTN","PSUOP7",12,0)
 ;
"RTN","PSUOP7",13,0)
 ;
"RTN","PSUOP7",14,0)
 ;Find sum of 30-day fills for each division
"RTN","PSUOP7",15,0)
 I QTY'>30 D
"RTN","PSUOP7",16,0)
 .S ^TMP($J,"FILL",PSUDV,30)=$G(^TMP($J,"FILL",PSUDV,30))+1
"RTN","PSUOP7",17,0)
 I '$G(^TMP($J,"FILL",PSUDV,30)) S ^TMP($J,"FILL",PSUDV,30)=0
"RTN","PSUOP7",18,0)
 ;
"RTN","PSUOP7",19,0)
 ;
"RTN","PSUOP7",20,0)
 ;Find sum of 60-day fills for each division
"RTN","PSUOP7",21,0)
 I (QTY>30)&(QTY'>60) D
"RTN","PSUOP7",22,0)
 .S ^TMP($J,"FILL",PSUDV,60)=$G(^TMP($J,"FILL",PSUDV,60))+1
"RTN","PSUOP7",23,0)
 I '$G(^TMP($J,"FILL",PSUDV,60)) S ^TMP($J,"FILL",PSUDV,60)=0
"RTN","PSUOP7",24,0)
 ;
"RTN","PSUOP7",25,0)
 ;
"RTN","PSUOP7",26,0)
 ;Find sum of 90-day fills for each division
"RTN","PSUOP7",27,0)
 I QTY>60 D
"RTN","PSUOP7",28,0)
 .S ^TMP($J,"FILL",PSUDV,90)=$G(^TMP($J,"FILL",PSUDV,90))+1
"RTN","PSUOP7",29,0)
 I '$G(^TMP($J,"FILL",PSUDV,90)) S ^TMP($J,"FILL",PSUDV,90)=0
"RTN","PSUOP7",30,0)
 ;
"RTN","PSUOP7",31,0)
 ;
"RTN","PSUOP7",32,0)
 N FILL30,FILL60,FILL90
"RTN","PSUOP7",33,0)
 S FILL30=^TMP($J,"FILL",PSUDV,30)
"RTN","PSUOP7",34,0)
 S FILL60=^TMP($J,"FILL",PSUDV,60)
"RTN","PSUOP7",35,0)
 S FILL90=^TMP($J,"FILL",PSUDV,90)
"RTN","PSUOP7",36,0)
 ;
"RTN","PSUOP7",37,0)
 ;Calculate Unadjusted Total Fills
"RTN","PSUOP7",38,0)
 S ^TMP($J,"UNAD",PSUDV)=FILL30+FILL60+FILL90
"RTN","PSUOP7",39,0)
 ;
"RTN","PSUOP7",40,0)
 ;
"RTN","PSUOP7",41,0)
 ;Calculate 30-day Equivalent Fills
"RTN","PSUOP7",42,0)
 S ^TMP($J,"EQUIV",PSUDV)=FILL30+(2*FILL60)+(3*FILL90)
"RTN","PSUOP7",43,0)
 ;
"RTN","PSUOP7",44,0)
 ;
"RTN","PSUOP7",45,0)
 ;Calculate total cost for all fills
"RTN","PSUOP7",46,0)
 ;S PRICE=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,2),U,5)
"RTN","PSUOP7",47,0)
 S PRICE=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,24)
"RTN","PSUOP7",48,0)
 S QUANT=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,26)
"RTN","PSUOP7",49,0)
 S PSUCOST=PRICE*QUANT
"RTN","PSUOP7",50,0)
 S ^TMP($J,"COST",PSUDV,PSURXIEN)=$G(^TMP($J,"COST",PSUDV,PSURXIEN))+PSUCOST
"RTN","PSUOP7",51,0)
 ;
"RTN","PSUOP7",52,0)
 ;
"RTN","PSUOP7",53,0)
 ;Find number of "new", "refill", and "partial" prescriptions
"RTN","PSUOP7",54,0)
 S PSUTYPE=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,16)
"RTN","PSUOP7",55,0)
 ;
"RTN","PSUOP7",56,0)
 I PSUTYPE="N" D
"RTN","PSUOP7",57,0)
 .S ^TMP($J,"NEW",PSUDV)=$G(^TMP($J,"NEW",PSUDV))+1   ;New fills
"RTN","PSUOP7",58,0)
 I '$G(^TMP($J,"NEW",PSUDV)) S ^TMP($J,"NEW",PSUDV)=0
"RTN","PSUOP7",59,0)
 ;
"RTN","PSUOP7",60,0)
 ;
"RTN","PSUOP7",61,0)
 I PSUTYPE'="N" D
"RTN","PSUOP7",62,0)
 .S ^TMP($J,"REF",PSUDV)=$G(^TMP($J,"REF",PSUDV))+1   ;Refills + partial
"RTN","PSUOP7",63,0)
 I '$G(^TMP($J,"REF",PSUDV)) S ^TMP($J,"REF",PSUDV)=0
"RTN","PSUOP7",64,0)
 ;
"RTN","PSUOP7",65,0)
 ;Find total number of "Window CS" and "Mail CS" prescription fills
"RTN","PSUOP7",66,0)
 ;
"RTN","PSUOP7",67,0)
 S PSUWIN=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,18)
"RTN","PSUOP7",68,0)
 S PSUCMP=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,17)
"RTN","PSUOP7",69,0)
 S PSUCS=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,15)
"RTN","PSUOP7",70,0)
 ;
"RTN","PSUOP7",71,0)
 ;
"RTN","PSUOP7",72,0)
 I PSUWIN="W" S ^TMP($J,"WIN",PSUDV)=$G(^TMP($J,"WIN",PSUDV))+1 D
"RTN","PSUOP7",73,0)
 .I PSUCMP="N" D
"RTN","PSUOP7",74,0)
 ..I (PSUCS[2)!(PSUCS[3)!(PSUCS[4)!(PSUCS[5) D
"RTN","PSUOP7",75,0)
 ...S ^TMP($J,"WINCS",PSUDV)=$G(^TMP($J,"WINCS",PSUDV))+1  ;WIN CS fills
"RTN","PSUOP7",76,0)
 I '$G(^TMP($J,"WIN",PSUDV)) S ^TMP($J,"WIN",PSUDV)=0
"RTN","PSUOP7",77,0)
 I '$G(^TMP($J,"WINCS",PSUDV)) S ^TMP($J,"WINCS",PSUDV)=0
"RTN","PSUOP7",78,0)
 ;
"RTN","PSUOP7",79,0)
 ;
"RTN","PSUOP7",80,0)
 I PSUWIN="M" S ^TMP($J,"MAIL",PSUDV)=$G(^TMP($J,"MAIL",PSUDV))+1 D
"RTN","PSUOP7",81,0)
 .I PSUCMP="N" D
"RTN","PSUOP7",82,0)
 ..I (PSUCS[2)!(PSUCS[3)!(PSUCS[4)!(PSUCS[5) D
"RTN","PSUOP7",83,0)
 ...S ^TMP($J,"MAILCS",PSUDV)=$G(^TMP($J,"MAILCS",PSUDV))+1  ;Mail CS
"RTN","PSUOP7",84,0)
 I '$G(^TMP($J,"MAIL",PSUDV)) S ^TMP($J,"MAIL",PSUDV)=0
"RTN","PSUOP7",85,0)
 I '$G(^TMP($J,"MAILCS",PSUDV)) S ^TMP($J,"MAILCS",PSUDV)=0
"RTN","PSUOP7",86,0)
 ;
"RTN","PSUOP7",87,0)
 ;
"RTN","PSUOP7",88,0)
 I PSUCMP="Y" D
"RTN","PSUOP7",89,0)
 .S ^TMP($J,"CMOP",PSUDV)=$G(^TMP($J,"CMOP",PSUDV))+1   ;CMOP fills
"RTN","PSUOP7",90,0)
 I '$G(^TMP($J,"CMOP",PSUDV)) S ^TMP($J,"CMOP",PSUDV)=0
"RTN","PSUOP7",91,0)
 ;
"RTN","PSUOP7",92,0)
 ;
"RTN","PSUOP7",93,0)
 I PSUCMP="N" S ^TMP($J,"LOC",PSUDV)=$G(^TMP($J,"LOC",PSUDV))+1 D
"RTN","PSUOP7",94,0)
 .I (PSUCS[2)!(PSUCS[3)!(PSUCS[4)!(PSUCS[5) D
"RTN","PSUOP7",95,0)
 ..S ^TMP($J,"LOCS",PSUDV)=$G(^TMP($J,"LOCS",PSUDV))+1    ;Local CS fills
"RTN","PSUOP7",96,0)
 I '$G(^TMP($J,"LOC",PSUDV)) S ^TMP($J,"LOC",PSUDV)=0
"RTN","PSUOP7",97,0)
 I '$G(^TMP($J,"LOCS",PSUDV)) S ^TMP($J,"LOCS",PSUDV)=0
"RTN","PSUOP7",98,0)
 ;
"RTN","PSUOP7",99,0)
 S PSUSTF=$P(^XTMP(PSUOPSUB,"DATA",PSUDV,PSURXIEN,PSURCT,1),U,20)
"RTN","PSUOP7",100,0)
 ;
"RTN","PSUOP7",101,0)
 I PSUSTF="S" D
"RTN","PSUOP7",102,0)
 .S ^TMP($J,"STAFF",PSUDV)=$G(^TMP($J,"STAFF",PSUDV))+1  ;Staff fills
"RTN","PSUOP7",103,0)
 I '$G(^TMP($J,"STAFF",PSUDV)) S ^TMP($J,"STAFF",PSUDV)=0
"RTN","PSUOP7",104,0)
 ;
"RTN","PSUOP7",105,0)
 ;
"RTN","PSUOP7",106,0)
 I PSUSTF="F" D
"RTN","PSUOP7",107,0)
 .S ^TMP($J,"FEE",PSUDV)=$G(^TMP($J,"FEE",PSUDV))+1    ;Fee fills
"RTN","PSUOP7",108,0)
 I '$G(^TMP($J,"FEE",PSUDV)) S ^TMP($J,"FEE",PSUDV)=0
"RTN","PSUOP7",109,0)
 Q
"RTN","PSUOP8")
0^74^B94498709
"RTN","PSUOP8",1,0)
PSUOP8 ;BIR/DAM - Outpatient AMIS Summary Message;04 MAR 2004
"RTN","PSUOP8",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOP8",3,0)
 ;
"RTN","PSUOP8",4,0)
 ;Reference to file #59  supported by DBIA 2510
"RTN","PSUOP8",5,0)
 ;
"RTN","PSUOP8",6,0)
EN ;Entry point for MailMan message
"RTN","PSUOP8",7,0)
 ;Called from PSUOP0
"RTN","PSUOP8",8,0)
 ;
"RTN","PSUOP8",9,0)
 Q:$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG"))  ;Quit if Provider extract only
"RTN","PSUOP8",10,0)
 D MSG
"RTN","PSUOP8",11,0)
 D MAIL
"RTN","PSUOP8",12,0)
 Q
"RTN","PSUOP8",13,0)
 ;
"RTN","PSUOP8",14,0)
MSG ;Create the Rx AMIS summary mailman message
"RTN","PSUOP8",15,0)
 ;Called from PSUOP0
"RTN","PSUOP8",16,0)
 ;
"RTN","PSUOP8",17,0)
 S (PSU30,PSU60,PSU90,PSUNADJ,PSUEQ,PSUTCST,PSUNADC,PSUCFIL)=""
"RTN","PSUOP8",18,0)
 S (PSUNEW,PSUREF,PSUWN,PSUWNCS,PSUML,PSUMLCS,PSUMP,PSULC)=""
"RTN","PSUOP8",19,0)
 S (PSUSTF,PSUFEE,PSULOCS,PSUSTNM)=""
"RTN","PSUOP8",20,0)
 ;
"RTN","PSUOP8",21,0)
 S PSUST=$P($G(^XTMP("PSU_"_PSUJOB,"PSUSITE")),U,1)    ;Facility #
"RTN","PSUOP8",22,0)
 S PSUSTNM=$P($G(^XTMP("PSU_"_PSUJOB,"PSUSITE")),U,2)  ;Facility name
"RTN","PSUOP8",23,0)
 ;
"RTN","PSUOP8",24,0)
 D TCOST      ;Calculate total cost for all Rx fills
"RTN","PSUOP8",25,0)
 ;
"RTN","PSUOP8",26,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y
"RTN","PSUOP8",27,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y
"RTN","PSUOP8",28,0)
 S AMIS(1)="Outpatient AMIS Summary for "_PSUDTS_" through "_PSUDTE_" for "_PSUSTNM
"RTN","PSUOP8",29,0)
 ;
"RTN","PSUOP8",30,0)
 S AMIS(2)=""
"RTN","PSUOP8",31,0)
 ;
"RTN","PSUOP8",32,0)
 S AMIS(3)="                                                         Unadj     30Day                      Cost/          Cost/"
"RTN","PSUOP8",33,0)
 ;
"RTN","PSUOP8",34,0)
 S AMIS(4)="                      30Day        60Day      90Day      Total     Equiv        Total        Unadj          30Day"
"RTN","PSUOP8",35,0)
 ;
"RTN","PSUOP8",36,0)
 S AMIS(5)="Division              Fills        Fills      Fills      Fills     Fills        Cost          Fill           Fill"
"RTN","PSUOP8",37,0)
 ;
"RTN","PSUOP8",38,0)
 S $P(AMIS(6),"-",132)=""      ;Separator bar
"RTN","PSUOP8",39,0)
 ;
"RTN","PSUOP8",40,0)
 S PSULN=7
"RTN","PSUOP8",41,0)
 ;
"RTN","PSUOP8",42,0)
 S PSUDVN=0
"RTN","PSUOP8",43,0)
 F  S PSUDVN=$O(^TMP($J,"FILL",PSUDVN)) Q:PSUDVN=""  D
"RTN","PSUOP8",44,0)
 .S X=PSUDVN,DIC=59,DIC(0)="XM" D ^DIC     ;Find division name
"RTN","PSUOP8",45,0)
 .S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP8",46,0)
 .I '$G(PSUDIVNM) S X=PSUDVN,DIC=40.8,DIC(0)="X",D="C" D IX^DIC D
"RTN","PSUOP8",47,0)
 ..S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUOP8",48,0)
 .D VAR
"RTN","PSUOP8",49,0)
 .D UNADCST
"RTN","PSUOP8",50,0)
 .D FILL
"RTN","PSUOP8",51,0)
 .D TOTAL1
"RTN","PSUOP8",52,0)
 .;
"RTN","PSUOP8",53,0)
 .;Construct line with spacing
"RTN","PSUOP8",54,0)
 .S PSULINE=""
"RTN","PSUOP8",55,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUOP8",56,0)
 .S $E(PSULINE,18,28)=$J(FILL30,11)
"RTN","PSUOP8",57,0)
 .S $E(PSULINE,29,39)=$J(FILL60,11)
"RTN","PSUOP8",58,0)
 .S $E(PSULINE,40,50)=$J(FILL90,11)
"RTN","PSUOP8",59,0)
 .S $E(PSULINE,51,61)=$J(UNAD,11)
"RTN","PSUOP8",60,0)
 .S $E(PSULINE,62,72)=$J(EQUIV,11)
"RTN","PSUOP8",61,0)
 .S $E(PSULINE,74,75)="$"
"RTN","PSUOP8",62,0)
 .S $E(PSULINE,76,88)=$J(TCOST(PSUDVN),13)
"RTN","PSUOP8",63,0)
 .S $E(PSULINE,90,91)="$"
"RTN","PSUOP8",64,0)
 .S $E(PSULINE,92,102)=$J(UNADC(PSUDVN),11)
"RTN","PSUOP8",65,0)
 .S $E(PSULINE,104,105)="$"
"RTN","PSUOP8",66,0)
 .S $E(PSULINE,106,116)=$J(CFILL(PSUDVN),11)
"RTN","PSUOP8",67,0)
 .;End line
"RTN","PSUOP8",68,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUOP8",69,0)
 ;
"RTN","PSUOP8",70,0)
 S $P(AMIS(PSULN),"-",132)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUOP8",71,0)
 ;
"RTN","PSUOP8",72,0)
 ;Construct line with spacing
"RTN","PSUOP8",73,0)
 S PSULINE=""
"RTN","PSUOP8",74,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUOP8",75,0)
 S $E(PSULINE,18,28)=$J(PSU30,11)
"RTN","PSUOP8",76,0)
 S $E(PSULINE,29,39)=$J(PSU60,11)
"RTN","PSUOP8",77,0)
 S $E(PSULINE,40,50)=$J(PSU90,11)
"RTN","PSUOP8",78,0)
 S $E(PSULINE,51,61)=$J(PSUNADJ,11)
"RTN","PSUOP8",79,0)
 S $E(PSULINE,62,72)=$J(PSUEQ,11)
"RTN","PSUOP8",80,0)
 S $E(PSULINE,74,75)="$"
"RTN","PSUOP8",81,0)
 S $E(PSULINE,76,88)=$J(PSUTCST,13)
"RTN","PSUOP8",82,0)
 S $E(PSULINE,90,91)="$"
"RTN","PSUOP8",83,0)
 S $E(PSULINE,92,102)=$J(PSUNADC,11)
"RTN","PSUOP8",84,0)
 S $E(PSULINE,104,105)="$"
"RTN","PSUOP8",85,0)
 S $E(PSULINE,106,116)=$J(PSUCFIL,11)
"RTN","PSUOP8",86,0)
 ;End line construction
"RTN","PSUOP8",87,0)
 ;
"RTN","PSUOP8",88,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUOP8",89,0)
 ;
"RTN","PSUOP8",90,0)
 F PSULN=PSULN:1:(PSULN+2) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUOP8",91,0)
 S PSULN=PSULN+1
"RTN","PSUOP8",92,0)
 ;
"RTN","PSUOP8",93,0)
 S AMIS(PSULN)="Unadjusted             New       Ref          Win           Mail               CMOP         Local           Staff         Fee" S PSULN=PSULN+1
"RTN","PSUOP8",94,0)
 ;
"RTN","PSUOP8",95,0)
 S AMIS(PSULN)="Division                Rx        Rx         Rx(CS)        Rx(CS)               Rx          Rx(CS)            Rx           Rx" S PSULN=PSULN+1
"RTN","PSUOP8",96,0)
 ;
"RTN","PSUOP8",97,0)
 S $P(AMIS(PSULN),"-",132)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUOP8",98,0)
 ;
"RTN","PSUOP8",99,0)
 S PSUDVN=0
"RTN","PSUOP8",100,0)
 F  S PSUDVN=$O(^TMP($J,"NEW",PSUDVN)) Q:PSUDVN=""  D
"RTN","PSUOP8",101,0)
 .S X=PSUDVN,DIC=59,DIC(0)="XM" D ^DIC     ;Find division name
"RTN","PSUOP8",102,0)
 .S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOP8",103,0)
 .I '$G(PSUDIVNM) S X=PSUDVN,DIC=40.8,DIC(0)="X",D="C" D IX^DIC D
"RTN","PSUOP8",104,0)
 ..S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUOP8",105,0)
 .D VAR2
"RTN","PSUOP8",106,0)
 .D TOTAL2
"RTN","PSUOP8",107,0)
 .;Construct line with spacing
"RTN","PSUOP8",108,0)
 .S PSULINE=""
"RTN","PSUOP8",109,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUOP8",110,0)
 .S $E(PSULINE,18,27)=$J(PSUN,10)
"RTN","PSUOP8",111,0)
 .S $E(PSULINE,28,37)=$J(PSUR,10)
"RTN","PSUOP8",112,0)
 .S $E(PSULINE,38,47)=$J(PSUW,10)
"RTN","PSUOP8",113,0)
 .S $E(PSULINE,48,57)="("_PSUWCS_")"
"RTN","PSUOP8",114,0)
 .S $E(PSULINE,58,67)=$J(PSUM,10)
"RTN","PSUOP8",115,0)
 .S $E(PSULINE,68,77)="("_PSUMCS_")"
"RTN","PSUOP8",116,0)
 .S $E(PSULINE,78,87)=$J(PSUMOP,10)
"RTN","PSUOP8",117,0)
 .S $E(PSULINE,88,97)=$J(PSULOC,10)
"RTN","PSUOP8",118,0)
 .S $E(PSULINE,98,107)="("_PSULCS_")"
"RTN","PSUOP8",119,0)
 .S $E(PSULINE,108,117)=$J(PSUTF,10)
"RTN","PSUOP8",120,0)
 .S $E(PSULINE,118,127)=$J(PSUFE,10)
"RTN","PSUOP8",121,0)
 .;End construction of line
"RTN","PSUOP8",122,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUOP8",123,0)
 ;
"RTN","PSUOP8",124,0)
 S $P(AMIS(PSULN),"-",132)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUOP8",125,0)
 ;
"RTN","PSUOP8",126,0)
 ;Construct line with spacing
"RTN","PSUOP8",127,0)
 S PSULINE=""
"RTN","PSUOP8",128,0)
 S $E(PSULINE,1,15)="Total"
"RTN","PSUOP8",129,0)
 S $E(PSULINE,18,27)=$J(PSUNEW,10)
"RTN","PSUOP8",130,0)
 S $E(PSULINE,28,37)=$J(PSUREF,10)
"RTN","PSUOP8",131,0)
 S $E(PSULINE,38,47)=$J(PSUWN,10)
"RTN","PSUOP8",132,0)
 S $E(PSULINE,48,57)="("_PSUWNCS_")"
"RTN","PSUOP8",133,0)
 S $E(PSULINE,58,67)=$J(PSUML,10)
"RTN","PSUOP8",134,0)
 S $E(PSULINE,68,77)="("_PSUMLCS_")"
"RTN","PSUOP8",135,0)
 S $E(PSULINE,78,87)=$J(PSUMP,10)
"RTN","PSUOP8",136,0)
 S $E(PSULINE,88,97)=$J(PSULC,10)
"RTN","PSUOP8",137,0)
 S $E(PSULINE,98,107)="("_PSULOCS_")"
"RTN","PSUOP8",138,0)
 S $E(PSULINE,108,117)=$J(PSUSTF,10)
"RTN","PSUOP8",139,0)
 S $E(PSULINE,118,127)=$J(PSUFEE,10)
"RTN","PSUOP8",140,0)
 ;End construction of line
"RTN","PSUOP8",141,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUOP8",142,0)
 ;
"RTN","PSUOP8",143,0)
 Q
"RTN","PSUOP8",144,0)
 ;
"RTN","PSUOP8",145,0)
VAR ;Set contents of ^TMP global into VARIABLES
"RTN","PSUOP8",146,0)
 ;
"RTN","PSUOP8",147,0)
 S (FILL30,FILL60,FILL90,UNAD,EQUIV)=""
"RTN","PSUOP8",148,0)
 ;
"RTN","PSUOP8",149,0)
 S FILL30=^TMP($J,"FILL",PSUDVN,30)      ;30 DAY FILLS
"RTN","PSUOP8",150,0)
 ;
"RTN","PSUOP8",151,0)
 S FILL60=^TMP($J,"FILL",PSUDVN,60)      ;60 DAY FILLS
"RTN","PSUOP8",152,0)
 ;
"RTN","PSUOP8",153,0)
 S FILL90=^TMP($J,"FILL",PSUDVN,90)      ;90 DAY FILLS
"RTN","PSUOP8",154,0)
 ;
"RTN","PSUOP8",155,0)
 S UNAD=^TMP($J,"UNAD",PSUDVN)           ;UNADJUSTED TOTAL FILLS
"RTN","PSUOP8",156,0)
 ;
"RTN","PSUOP8",157,0)
 S EQUIV=^TMP($J,"EQUIV",PSUDVN)         ;30 DAY EQUIV FILLS
"RTN","PSUOP8",158,0)
 ;
"RTN","PSUOP8",159,0)
 Q
"RTN","PSUOP8",160,0)
 ;
"RTN","PSUOP8",161,0)
TCOST ;Calculate total cost for prescription fills 
"RTN","PSUOP8",162,0)
 ;
"RTN","PSUOP8",163,0)
 S PSUTC="",PSUTCOST=""
"RTN","PSUOP8",164,0)
 ;
"RTN","PSUOP8",165,0)
 S PSUDIVN=0
"RTN","PSUOP8",166,0)
 F  S PSUDIVN=$O(^TMP($J,"COST",PSUDIVN)) Q:PSUDIVN=""  D
"RTN","PSUOP8",167,0)
 .S PSURXIEN=0
"RTN","PSUOP8",168,0)
 .F  S PSURXIEN=$O(^TMP($J,"COST",PSUDIVN,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP8",169,0)
 ..S PSUTCOST=^TMP($J,"COST",PSUDIVN,PSURXIEN)
"RTN","PSUOP8",170,0)
 ..S TCOST(PSUDIVN)=$G(TCOST(PSUDIVN))+PSUTCOST
"RTN","PSUOP8",171,0)
 ..I TCOST(PSUDIVN)'["." S TCOST(PSUDIVN)=TCOST(PSUDIVN)_".00" Q
"RTN","PSUOP8",172,0)
 ..N A,B,C
"RTN","PSUOP8",173,0)
 ..S A=$F(TCOST(PSUDIVN),".")  ;Find 1st position after decimal
"RTN","PSUOP8",174,0)
 ..S B=$E(TCOST(PSUDIVN),1,(A-1))   ;Extract dollars and decimal
"RTN","PSUOP8",175,0)
 ..S C=$E(TCOST(PSUDIVN),A,(A+1))   ;Extract cents after decimal
"RTN","PSUOP8",176,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUOP8",177,0)
 ..S TCOST(PSUDIVN)=B_C
"RTN","PSUOP8",178,0)
 ;
"RTN","PSUOP8",179,0)
 Q
"RTN","PSUOP8",180,0)
 ;
"RTN","PSUOP8",181,0)
UNADCST ;Calculate Cost Per Unadjusted Fill
"RTN","PSUOP8",182,0)
 ;
"RTN","PSUOP8",183,0)
 N A,B,C
"RTN","PSUOP8",184,0)
 S UNADC(PSUDVN)=TCOST(PSUDVN)/UNAD
"RTN","PSUOP8",185,0)
 ;
"RTN","PSUOP8",186,0)
 I UNADC(PSUDVN)'["." S UNADC(PSUDVN)=UNADC(PSUDVN)_".00" Q
"RTN","PSUOP8",187,0)
 ;
"RTN","PSUOP8",188,0)
 S A=$F(UNADC(PSUDVN),".")    ;Find position of 1st # after decimal
"RTN","PSUOP8",189,0)
 ;
"RTN","PSUOP8",190,0)
 S B=$E(UNADC(PSUDVN),1,(A-1)) ;Extract "dollars" up to decimal
"RTN","PSUOP8",191,0)
 ;
"RTN","PSUOP8",192,0)
 S C=$E(UNADC(PSUDVN),A,(A+1)) ;Extract "cents" after decimal
"RTN","PSUOP8",193,0)
 ;
"RTN","PSUOP8",194,0)
 S UNADC(PSUDVN)=B_C
"RTN","PSUOP8",195,0)
 Q
"RTN","PSUOP8",196,0)
 ;
"RTN","PSUOP8",197,0)
FILL ;Calculate Cost Per 30-day Fill
"RTN","PSUOP8",198,0)
 ;
"RTN","PSUOP8",199,0)
 N A,B,C
"RTN","PSUOP8",200,0)
 S CFILL(PSUDVN)=TCOST(PSUDVN)/EQUIV
"RTN","PSUOP8",201,0)
 ;
"RTN","PSUOP8",202,0)
 I CFILL(PSUDVN)'["." S CFILL(PSUDVN)=CFILL(PSUDVN)_".00" Q
"RTN","PSUOP8",203,0)
 ;
"RTN","PSUOP8",204,0)
 S A=$F(CFILL(PSUDVN),".")    ;Find position of 1st # after decimal
"RTN","PSUOP8",205,0)
 ;
"RTN","PSUOP8",206,0)
 S B=$E(CFILL(PSUDVN),1,(A-1)) ;Extract "dollars" up to decimal
"RTN","PSUOP8",207,0)
 ;
"RTN","PSUOP8",208,0)
 S C=$E(CFILL(PSUDVN),A,(A+1)) ;Extract "cents" after decimal
"RTN","PSUOP8",209,0)
 ;
"RTN","PSUOP8",210,0)
 S CFILL(PSUDVN)=B_C
"RTN","PSUOP8",211,0)
 ;
"RTN","PSUOP8",212,0)
 Q
"RTN","PSUOP8",213,0)
 ;
"RTN","PSUOP8",214,0)
VAR2 ;Set contents of ^TMP globals into variables
"RTN","PSUOP8",215,0)
 ;
"RTN","PSUOP8",216,0)
 S (PSUN,PSUR,PSUW,PSUWCS,PSUM,PSUMCS)=""
"RTN","PSUOP8",217,0)
 S (PSUMOP,PSULOC,PSULCS,PSUTF,PSUFE)=""
"RTN","PSUOP8",218,0)
 ;
"RTN","PSUOP8",219,0)
 S PSUN=^TMP($J,"NEW",PSUDVN)           ;NEW FILLS
"RTN","PSUOP8",220,0)
 ;
"RTN","PSUOP8",221,0)
 S PSUR=^TMP($J,"REF",PSUDVN)           ;REFILLS
"RTN","PSUOP8",222,0)
 ;
"RTN","PSUOP8",223,0)
 S PSUW=^TMP($J,"WIN",PSUDVN)           ;WINDOW FILLS
"RTN","PSUOP8",224,0)
 ;
"RTN","PSUOP8",225,0)
 S PSUWCS=^TMP($J,"WINCS",PSUDVN)       ;WINDOW CS
"RTN","PSUOP8",226,0)
 ;
"RTN","PSUOP8",227,0)
 S PSUM=^TMP($J,"MAIL",PSUDVN)          ;MAIL FILLS
"RTN","PSUOP8",228,0)
 ;
"RTN","PSUOP8",229,0)
 S PSUMCS=^TMP($J,"MAILCS",PSUDVN)      ;MAIL CS
"RTN","PSUOP8",230,0)
 ;
"RTN","PSUOP8",231,0)
 S PSUMOP=^TMP($J,"CMOP",PSUDVN)        ;CMOP FILLS
"RTN","PSUOP8",232,0)
 ;
"RTN","PSUOP8",233,0)
 S PSULOC=^TMP($J,"LOC",PSUDVN)         ;LOCAL FILLS
"RTN","PSUOP8",234,0)
 ;
"RTN","PSUOP8",235,0)
 S PSULCS=^TMP($J,"LOCS",PSUDVN)        ;LOCAL CS
"RTN","PSUOP8",236,0)
 ;
"RTN","PSUOP8",237,0)
 S PSUTF=^TMP($J,"STAFF",PSUDVN)        ;STAFF FILLS
"RTN","PSUOP8",238,0)
 ;
"RTN","PSUOP8",239,0)
 S PSUFE=^TMP($J,"FEE",PSUDVN)          ;FEE FILLS
"RTN","PSUOP8",240,0)
 ;
"RTN","PSUOP8",241,0)
 Q
"RTN","PSUOP8",242,0)
 ;
"RTN","PSUOP8",243,0)
TOTAL1 ;Add each column to get totals for all divisions
"RTN","PSUOP8",244,0)
 ;
"RTN","PSUOP8",245,0)
 ;
"RTN","PSUOP8",246,0)
 S PSU30=$G(PSU30)+FILL30               ;Total 30 day fills
"RTN","PSUOP8",247,0)
 ;
"RTN","PSUOP8",248,0)
 S PSU60=$G(PSU60)+FILL60               ;Total 60 day fills
"RTN","PSUOP8",249,0)
 ;
"RTN","PSUOP8",250,0)
 S PSU90=$G(PSU90)+FILL90               ;Total 90 day fills
"RTN","PSUOP8",251,0)
 ;
"RTN","PSUOP8",252,0)
 S PSUNADJ=$G(PSUNADJ)+UNAD             ;Total unadjusted fills
"RTN","PSUOP8",253,0)
 ;
"RTN","PSUOP8",254,0)
 S PSUEQ=$G(PSUEQ)+EQUIV                ;Total 30 day equiv fills
"RTN","PSUOP8",255,0)
 ;
"RTN","PSUOP8",256,0)
 S PSUTCST=$G(PSUTCST)+TCOST(PSUDVN)    ;Total of Total Cost
"RTN","PSUOP8",257,0)
 ;
"RTN","PSUOP8",258,0)
 ;S PSUNADC=$G(PSUNADC)+UNADC(PSUDVN)    ;Total of Cost/Unadj fill
"RTN","PSUOP8",259,0)
 I $G(PSUNADJ) S PSUNADC=$G(PSUTCST)/PSUNADJ D
"RTN","PSUOP8",260,0)
 .I PSUNADC'["." S PSUNADC=PSUNADC_".00" Q
"RTN","PSUOP8",261,0)
 .N A,B,C
"RTN","PSUOP8",262,0)
 .S A=$F(PSUNADC,".")  ;Find 1st position after decimal
"RTN","PSUOP8",263,0)
 .S B=$E(PSUNADC,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUOP8",264,0)
 .S C=$E(PSUNADC,A,(A+1))   ;Extract cents after decimal
"RTN","PSUOP8",265,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUOP8",266,0)
 .S PSUNADC=B_C
"RTN","PSUOP8",267,0)
 ;
"RTN","PSUOP8",268,0)
 ;S PSUCFIL=$G(PSUCFIL)+CFILL(PSUDVN)    ;Total of Cost/30day fill
"RTN","PSUOP8",269,0)
 I $G(PSUEQ) S PSUCFIL=$G(PSUTCST)/PSUEQ D
"RTN","PSUOP8",270,0)
 .I PSUCFIL'["." S PSUCFIL=PSUCFIL_".00" Q
"RTN","PSUOP8",271,0)
 .N A,B,C
"RTN","PSUOP8",272,0)
 .S A=$F(PSUCFIL,".")  ;Find 1st position after decimal
"RTN","PSUOP8",273,0)
 .S B=$E(PSUCFIL,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUOP8",274,0)
 .S C=$E(PSUCFIL,A,(A+1))   ;Extract cents after decimal
"RTN","PSUOP8",275,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUOP8",276,0)
 .S PSUCFIL=B_C
"RTN","PSUOP8",277,0)
 ;
"RTN","PSUOP8",278,0)
 Q
"RTN","PSUOP8",279,0)
 ;
"RTN","PSUOP8",280,0)
TOTAL2 ;Add each column to get totals for all divisions
"RTN","PSUOP8",281,0)
 ;
"RTN","PSUOP8",282,0)
 S PSUNEW=$G(PSUNEW)+^TMP($J,"NEW",PSUDVN)
"RTN","PSUOP8",283,0)
 ;
"RTN","PSUOP8",284,0)
 S PSUREF=$G(PSUREF)+^TMP($J,"REF",PSUDVN)
"RTN","PSUOP8",285,0)
 ;
"RTN","PSUOP8",286,0)
 S PSUWN=$G(PSUWN)+^TMP($J,"WIN",PSUDVN)
"RTN","PSUOP8",287,0)
 ;
"RTN","PSUOP8",288,0)
 S PSUWNCS=$G(PSUWNCS)+^TMP($J,"WINCS",PSUDVN)
"RTN","PSUOP8",289,0)
 ;
"RTN","PSUOP8",290,0)
 S PSUML=$G(PSUML)+^TMP($J,"MAIL",PSUDVN)
"RTN","PSUOP8",291,0)
 ;
"RTN","PSUOP8",292,0)
 S PSUMLCS=$G(PSUMLCS)+^TMP($J,"MAILCS",PSUDVN)
"RTN","PSUOP8",293,0)
 ;
"RTN","PSUOP8",294,0)
 S PSUMP=$G(PSUMP)+^TMP($J,"CMOP",PSUDVN)
"RTN","PSUOP8",295,0)
 ;
"RTN","PSUOP8",296,0)
 S PSULC=$G(PSULC)+^TMP($J,"LOC",PSUDVN)
"RTN","PSUOP8",297,0)
 ;
"RTN","PSUOP8",298,0)
 S PSULOCS=$G(PSULOCS)+^TMP($J,"LOCS",PSUDVN)
"RTN","PSUOP8",299,0)
 ;
"RTN","PSUOP8",300,0)
 S PSUSTF=$G(PSUSTF)+^TMP($J,"STAFF",PSUDVN)
"RTN","PSUOP8",301,0)
 ;
"RTN","PSUOP8",302,0)
 S PSUFEE=$G(PSUFEE)+^TMP($J,"FEE",PSUDVN)
"RTN","PSUOP8",303,0)
 ;
"RTN","PSUOP8",304,0)
 Q
"RTN","PSUOP8",305,0)
 ;
"RTN","PSUOP8",306,0)
MAIL ;Send AMIS summary mailman message
"RTN","PSUOP8",307,0)
 ;
"RTN","PSUOP8",308,0)
 ;Do not send report if option selection includes 1,2,3,4,6
"RTN","PSUOP8",309,0)
 I $D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D  Q
"RTN","PSUOP8",310,0)
 .M ^XTMP("PSU_"_PSUJOB,"OPCOMBO")=AMIS
"RTN","PSUOP8",311,0)
 .S ^XTMP("PSU_"_PSUJOB,"OPCOMBO",1)="OUTPATIENT:"
"RTN","PSUOP8",312,0)
 ;
"RTN","PSUOP8",313,0)
 S XMSUB="V. 4.0 PBMOP "_PSUMON_" "_PSUST_" "_PSUSTNM
"RTN","PSUOP8",314,0)
 S XMTEXT="AMIS("
"RTN","PSUOP8",315,0)
 M ^XTMP("PSU_"_PSUJOB,"OPAMIS")=AMIS
"RTN","PSUOP8",316,0)
 S XMCHAN=1
"RTN","PSUOP8",317,0)
 M XMY=PSUXMYS2
"RTN","PSUOP8",318,0)
 D ^XMD
"RTN","PSUOP8",319,0)
 ;
"RTN","PSUOP8",320,0)
 Q
"RTN","PSUOPAM")
0^75^B8835160
"RTN","PSUOPAM",1,0)
PSUOPAM ;BIR/DAM - PSU PBM Outpatient AMIS Pharmacy Data Collection; March 2004
"RTN","PSUOPAM",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOPAM",3,0)
 ;
"RTN","PSUOPAM",4,0)
 ;DBIA's
"RTN","PSUOPAM",5,0)
 ;Reference to File (#52)     supported by DBIA 1878
"RTN","PSUOPAM",6,0)
 ;
"RTN","PSUOPAM",7,0)
EN ;entry point to gather additional AMIS data.  Called from PSUOP2
"RTN","PSUOPAM",8,0)
 ;
"RTN","PSUOPAM",9,0)
 K PSUAM      ;Array to hold single dose Medication Instructions
"RTN","PSUOPAM",10,0)
 K PSUAMMD    ;Array to hold multidose medication instructions
"RTN","PSUOPAM",11,0)
 K PSUMDFLG   ;Multidose flag
"RTN","PSUOPAM",12,0)
 S (PSUPI,PSUCO,PSUEXP,PSUAM,PSUDSG,PSUDIPU,PSUNITS,PSUNOUN)=""
"RTN","PSUOPAM",13,0)
 S (PSUDUR,PSUCONJ,PSUROUT,PSUSCHED,PSUVERB)=""
"RTN","PSUOPAM",14,0)
 D CO
"RTN","PSUOPAM",15,0)
 D EXP
"RTN","PSUOPAM",16,0)
 D DOSG
"RTN","PSUOPAM",17,0)
 Q
"RTN","PSUOPAM",18,0)
 ;
"RTN","PSUOPAM",19,0)
 ;
"RTN","PSUOPAM",20,0)
CO ;Copay status: found in file (#52), field (#105)
"RTN","PSUOPAM",21,0)
 ;
"RTN","PSUOPAM",22,0)
 S PSUCO=$P($G(^TMP("PSOR",$J,PSURXIEN,"IB",0)),U,1)
"RTN","PSUOPAM",23,0)
 I $G(PSUCO) S PSUCOPAY="Y"
"RTN","PSUOPAM",24,0)
 I '$G(PSUCO) S PSUCOPAY="N"
"RTN","PSUOPAM",25,0)
 Q
"RTN","PSUOPAM",26,0)
 ;
"RTN","PSUOPAM",27,0)
EXP ;Expanded instructions: found in file (#52), multiple (#113),
"RTN","PSUOPAM",28,0)
 ;sub-field (#.01)
"RTN","PSUOPAM",29,0)
 ;
"RTN","PSUOPAM",30,0)
 S PSUD1=0
"RTN","PSUOPAM",31,0)
 F  S PSUD1=$O(^TMP("PSOR",$J,PSURXIEN,"PI",PSUD1)) Q:PSUD1=""  D
"RTN","PSUOPAM",32,0)
 .I PSUD1=1 S PSUEXP=$E(^TMP("PSOR",$J,PSURXIEN,"PI",PSUD1,0),1,80) D
"RTN","PSUOPAM",33,0)
 ..S PSUPI=$G(PSUEXP)
"RTN","PSUOPAM",34,0)
 .I (PSUD1'=1),($L(PSUEXP)<80) D
"RTN","PSUOPAM",35,0)
 ..S PSUEXP=$E(PSUEXP_" "_^TMP("PSOR",$J,PSURXIEN,"PI",PSUD1,0),1,80)
"RTN","PSUOPAM",36,0)
 ..S PSUPI=$G(PSUEXP)
"RTN","PSUOPAM",37,0)
 ;
"RTN","PSUOPAM",38,0)
 Q
"RTN","PSUOPAM",39,0)
 ;
"RTN","PSUOPAM",40,0)
DOSG ;Dosage data: found in file (#52), multiple (#113).  There are 
"RTN","PSUOPAM",41,0)
 ;nine sub-fields to be pulled: #.01 through #8
"RTN","PSUOPAM",42,0)
 ;
"RTN","PSUOPAM",43,0)
 S PSUD1=0
"RTN","PSUOPAM",44,0)
 F  S PSUD1=$O(^TMP("PSOR",$J,PSURXIEN,"MI",PSUD1)) Q:PSUD1=""  D
"RTN","PSUOPAM",45,0)
 .I PSUD1'=1 S PSUMDFLG="M"       ;Multidose flag
"RTN","PSUOPAM",46,0)
 .I PSUD1=1 D                     ;Single dose/first Multidose data
"RTN","PSUOPAM",47,0)
 ..S PSUAM=^TMP("PSOR",$J,PSURXIEN,"MI",PSUD1,0)
"RTN","PSUOPAM",48,0)
 ..S PSUDSG=$P(PSUAM,U,1)             ;Dosage Ordered
"RTN","PSUOPAM",49,0)
 ..S PSUDISPU=$P(PSUAM,U,2)           ;Dispense Units per Dose
"RTN","PSUOPAM",50,0)
 ..S PSUNITS=$P($P(PSUAM,U,3),";",2)  ;Units
"RTN","PSUOPAM",51,0)
 ..S PSUNOUN=$P(PSUAM,U,4)            ;Noun
"RTN","PSUOPAM",52,0)
 ..S PSUDUR=$P(PSUAM,U,5)             ;Duration
"RTN","PSUOPAM",53,0)
 ..S PSUCONJ=$P(PSUAM,U,6)            ;Conjunction
"RTN","PSUOPAM",54,0)
 ..S PSUROUT=$P($P(PSUAM,U,7),";",2)  ;Route
"RTN","PSUOPAM",55,0)
 ..S PSUSCHED=$P(PSUAM,U,8)           ;Schedule
"RTN","PSUOPAM",56,0)
 ..S PSUVERB=$P(PSUAM,U,9)            ;Verb
"RTN","PSUOPAM",57,0)
 ;
"RTN","PSUOPAM",58,0)
 Q
"RTN","PSUOPAM",59,0)
 ;
"RTN","PSUOPAM",60,0)
MULTI ;Set variables for Multidose Medication Instructions
"RTN","PSUOPAM",61,0)
 ;Called from PSUOP3
"RTN","PSUOPAM",62,0)
 ;
"RTN","PSUOPAM",63,0)
 S (PSUDSGMD,PSUDSPMD,PSUNITMD,PSUNMD)=""
"RTN","PSUOPAM",64,0)
 S (PSURTMD,PSUSCHMD,PSUVRBMD)=""
"RTN","PSUOPAM",65,0)
 ;
"RTN","PSUOPAM",66,0)
 S PSUDSGMD=$P(PSUAMMD,U,1)            ;Dosage Ordered
"RTN","PSUOPAM",67,0)
 S PSUDSPMD=$P(PSUAMMD,U,2)            ;Dispense Units per Dose
"RTN","PSUOPAM",68,0)
 S PSUNITMD=$P($P(PSUAMMD,U,3),";",2)  ;Units
"RTN","PSUOPAM",69,0)
 S PSUNMD=$P(PSUAMMD,U,4)              ;Noun
"RTN","PSUOPAM",70,0)
 S PSUDURMD=$P(PSUAMMD,U,5)            ;Duration
"RTN","PSUOPAM",71,0)
 S PSUCONMD=$P(PSUAMMD,U,6)            ;Conjunction
"RTN","PSUOPAM",72,0)
 S PSURTMD=$P($P(PSUAMMD,U,7),";",2)   ;Route
"RTN","PSUOPAM",73,0)
 S PSUSCHMD=$P(PSUAMMD,U,8)            ;Schedule
"RTN","PSUOPAM",74,0)
 S PSUVRBMD=$P(PSUAMMD,U,9)            ;Verb
"RTN","PSUOPAM",75,0)
 ;
"RTN","PSUOPAM",76,0)
 Q
"RTN","PSUOPMD")
0^76^B35176456
"RTN","PSUOPMD",1,0)
PSUOPMD ;BIR/CFL,DAM - PSU PBM Multidose Outpatient Pharmacy create mailman messages ;17 NOV 2004
"RTN","PSUOPMD",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUOPMD",3,0)
 ;
"RTN","PSUOPMD",4,0)
 ;DBIA(s)
"RTN","PSUOPMD",5,0)
 ; Reference to file #4.3 supported by DBIA 2496
"RTN","PSUOPMD",6,0)
 ; Reference to file #59  supported by DBIA 2510
"RTN","PSUOPMD",7,0)
 ; Reference to file #4   supported by DBIA 10090
"RTN","PSUOPMD",8,0)
 ;
"RTN","PSUOPMD",9,0)
EN ;
"RTN","PSUOPMD",10,0)
 ;
"RTN","PSUOPMD",11,0)
 S $P(PSUDASH,"-",100)=""
"RTN","PSUOPMD",12,0)
 S $P(PSUFILL," ",100)=""
"RTN","PSUOPMD",13,0)
 ;Organize index of ^XTMP("DATAMD") global
"RTN","PSUOPMD",14,0)
 S (PSUDV,PSUTMP)=""
"RTN","PSUOPMD",15,0)
 F  S PSUDV=$O(^XTMP(PSUOPSUB,"DATAMD",PSUDV)) Q:PSUDV=""  D
"RTN","PSUOPMD",16,0)
 .S PSULCT=0
"RTN","PSUOPMD",17,0)
 .S PSURXIEN=""
"RTN","PSUOPMD",18,0)
 .F  S PSURXIEN=$O(^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOPMD",19,0)
 ..S PSURCT=0
"RTN","PSUOPMD",20,0)
 ..F  S PSURCT=$O(^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT)) Q:PSURCT=""  D
"RTN","PSUOPMD",21,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOPMD",22,0)
 ...S ^XTMP(PSUOPSUB,"RECMD",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,1)
"RTN","PSUOPMD",23,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOPMD",24,0)
 ...S ^XTMP(PSUOPSUB,"RECMD",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,2)
"RTN","PSUOPMD",25,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOPMD",26,0)
 ...S ^XTMP(PSUOPSUB,"RECMD",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,3)
"RTN","PSUOPMD",27,0)
 ...Q:'$D(^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,4))
"RTN","PSUOPMD",28,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOPMD",29,0)
 ...S ^XTMP(PSUOPSUB,"RECMD",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,4)
"RTN","PSUOPMD",30,0)
 ...Q:'$D(^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,5))
"RTN","PSUOPMD",31,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOPMD",32,0)
 ...S ^XTMP(PSUOPSUB,"RECMD",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,5)
"RTN","PSUOPMD",33,0)
 ...Q:'$D(^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,6))
"RTN","PSUOPMD",34,0)
 ...S PSULCT=PSULCT+1
"RTN","PSUOPMD",35,0)
 ...S ^XTMP(PSUOPSUB,"RECMD",PSUDV,PSULCT)=^XTMP(PSUOPSUB,"DATAMD",PSUDV,PSURXIEN,PSURCT,6)
"RTN","PSUOPMD",36,0)
 ;
"RTN","PSUOPMD",37,0)
 ;
"RTN","PSUOPMD",38,0)
MSG ;Set up the number of lines and messages for mailman
"RTN","PSUOPMD",39,0)
 ;
"RTN","PSUOPMD",40,0)
 S PSUNOREC="",NONE=""
"RTN","PSUOPMD",41,0)
 S PSUMSGT("M")=0,PSUMSGT("L")=0
"RTN","PSUOPMD",42,0)
 I '$D(^XTMP(PSUOPSUB,"RECMD")) D NODATA Q  ;Do not go any further if there is no data to report
"RTN","PSUOPMD",43,0)
 S PSUDIV=0,Z=0
"RTN","PSUOPMD",44,0)
 F  S PSUDIV=$O(^XTMP(PSUOPSUB,"RECMD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUOPMD",45,0)
 .S X=PSUDIV,DIC=59,DIC(0)="XM" D ^DIC ;**1
"RTN","PSUOPMD",46,0)
 .S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUOPMD",47,0)
 .I PSUMASF!PSUDUZ!PSUPBMG D 
"RTN","PSUOPMD",48,0)
 ..D XMD,SETCNT
"RTN","PSUOPMD",49,0)
 Q
"RTN","PSUOPMD",50,0)
XMD ;
"RTN","PSUOPMD",51,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC,PSUOLD1,PSUOLD2,PSUOLD3
"RTN","PSUOPMD",52,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUOPMD",53,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUOPMD",54,0)
 K ^XTMP(PSUOPSUB,"XMD")
"RTN","PSUOPMD",55,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUOPMD",56,0)
 F PSULC=1:1 S X=$G(^XTMP(PSUOPSUB,"RECMD",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSUOPMD",57,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUOPMD",58,0)
 .I PSUMLC>PSUMAX D
"RTN","PSUOPMD",59,0)
 ..I $E(X,1)'="*" S PSUMLC=1
"RTN","PSUOPMD",60,0)
 ..I $E(X,1)="*" D OLD
"RTN","PSUOPMD",61,0)
 .I $L(X)<254 S ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC)=X Q
"RTN","PSUOPMD",62,0)
 .F I=254:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUOPMD",63,0)
 .S ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUOPMD",64,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUOPMD",65,0)
 .S ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUOPMD",66,0)
 ;
"RTN","PSUOPMD",67,0)
 ;   Count Lines sent
"RTN","PSUOPMD",68,0)
 S PSUTLC=0
"RTN","PSUOPMD",69,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSUOPSUB,"XMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUOPMD",70,0)
 D VARS
"RTN","PSUOPMD",71,0)
 Q
"RTN","PSUOPMD",72,0)
 ;
"RTN","PSUOPMD",73,0)
OLD ; THIS SUBROUTINE STOPS MULTI-LINED MESSAGES FORM SPANNING MAILMAN MSG
"RTN","PSUOPMD",74,0)
 S PSUOLD1=^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1) I $E(PSUOLD1,1)="*" D
"RTN","PSUOPMD",75,0)
 .S PSUOLD2=^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-2) I $E(PSUOLD2,1)="*" D
"RTN","PSUOPMD",76,0)
 ..S PSUOLD3=^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-3) I $E(PSUOLD3,1)="*" D
"RTN","PSUOPMD",77,0)
 ...S PSUOLD4=^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-4) I $E(PSUOLD4,1)="*" D
"RTN","PSUOPMD",78,0)
 ....S PSUOLD5=^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-5)
"RTN","PSUOPMD",79,0)
 D:$D(PSUOLD5) OLD5 Q
"RTN","PSUOPMD",80,0)
 D:$D(PSUOLD4) OLD4 Q
"RTN","PSUOPMD",81,0)
 D:$D(PSUOLD3) OLD3 Q
"RTN","PSUOPMD",82,0)
 D:$D(PSUOLD2) OLD2 Q
"RTN","PSUOPMD",83,0)
 D:$D(PSUOLD1) OLD1
"RTN","PSUOPMD",84,0)
 Q
"RTN","PSUOPMD",85,0)
 ;
"RTN","PSUOPMD",86,0)
OLD5 ; * IF A RECORD EXCEEDS THE 10,000 CHARACTER 5 TIMES
"RTN","PSUOPMD",87,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,1)=PSUOLD5
"RTN","PSUOPMD",88,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-5)
"RTN","PSUOPMD",89,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,2)=PSUOLD4
"RTN","PSUOPMD",90,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-4)
"RTN","PSUOPMD",91,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,3)=PSUOLD3
"RTN","PSUOPMD",92,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-3)
"RTN","PSUOPMD",93,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,4)=PSUOLD2
"RTN","PSUOPMD",94,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-2)
"RTN","PSUOPMD",95,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,5)=PSUOLD1
"RTN","PSUOPMD",96,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOPMD",97,0)
 S PSUMLC=6
"RTN","PSUOPMD",98,0)
 K PSUOLD5,PSUOLD4,PSUOLD3,PSUOLD2,PSUOLD1
"RTN","PSUOPMD",99,0)
 Q
"RTN","PSUOPMD",100,0)
 ;
"RTN","PSUOPMD",101,0)
OLD4 ; * IF A RECORD EXCEEDS THE 10,000 CHARACTER 4 TIMES
"RTN","PSUOPMD",102,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,1)=PSUOLD4
"RTN","PSUOPMD",103,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-4)
"RTN","PSUOPMD",104,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,2)=PSUOLD3
"RTN","PSUOPMD",105,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-3)
"RTN","PSUOPMD",106,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,3)=PSUOLD2
"RTN","PSUOPMD",107,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-2)
"RTN","PSUOPMD",108,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,4)=PSUOLD1
"RTN","PSUOPMD",109,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOPMD",110,0)
 S PSUMLC=5
"RTN","PSUOPMD",111,0)
 K PSUOLD4,PSUOLD3,PSUOLD2,PSUOLD1
"RTN","PSUOPMD",112,0)
 Q
"RTN","PSUOPMD",113,0)
 ;
"RTN","PSUOPMD",114,0)
OLD3 ;
"RTN","PSUOPMD",115,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,1)=PSUOLD3
"RTN","PSUOPMD",116,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-3)
"RTN","PSUOPMD",117,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,2)=PSUOLD2
"RTN","PSUOPMD",118,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-2)
"RTN","PSUOPMD",119,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,3)=PSUOLD1
"RTN","PSUOPMD",120,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOPMD",121,0)
 S PSUMLC=4
"RTN","PSUOPMD",122,0)
 K PSUOLD3,PSUOLD2,PSUOLD1
"RTN","PSUOPMD",123,0)
 Q
"RTN","PSUOPMD",124,0)
 ;
"RTN","PSUOPMD",125,0)
OLD2 ;
"RTN","PSUOPMD",126,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,1)=PSUOLD2
"RTN","PSUOPMD",127,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-2)
"RTN","PSUOPMD",128,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,2)=PSUOLD1
"RTN","PSUOPMD",129,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOPMD",130,0)
 S PSUMLC=3
"RTN","PSUOPMD",131,0)
 K PSUOLD2,PSUOLD1
"RTN","PSUOPMD",132,0)
 Q
"RTN","PSUOPMD",133,0)
 ;
"RTN","PSUOPMD",134,0)
OLD1 ;
"RTN","PSUOPMD",135,0)
 S ^XTMP(PSUOPSUB,"XMD",PSUMC+1,1)=PSUOLD1
"RTN","PSUOPMD",136,0)
 K ^XTMP(PSUOPSUB,"XMD",PSUMC,PSUMLC-1)
"RTN","PSUOPMD",137,0)
 S PSUMLC=2
"RTN","PSUOPMD",138,0)
 K PSUOLD1
"RTN","PSUOPMD",139,0)
 Q
"RTN","PSUOPMD",140,0)
 ;
"RTN","PSUOPMD",141,0)
 ;   Transmit Messages
"RTN","PSUOPMD",142,0)
VARS ; Setup variables for contents
"RTN","PSUOPMD",143,0)
 F PSUM=1:1:PSUMC D
"RTN","PSUOPMD",144,0)
 .S XMSUB="V. 4.0 PBMOP(MULTIDOSE) "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUOPMD",145,0)
 .S XMTEXT="^XTMP(PSUOPSUB,""XMD"",PSUM,"
"RTN","PSUOPMD",146,0)
 .S XMCHAN=1
"RTN","PSUOPMD",147,0)
 .I PSUMASF!PSUDUZ!PSUPBMG D
"RTN","PSUOPMD",148,0)
 ..M XMY=PSUXMYH
"RTN","PSUOPMD",149,0)
 .I 'PSUMASF M XMY=PSUXMYS1
"RTN","PSUOPMD",150,0)
 .I '$G(PSUSMRY) D ^XMD
"RTN","PSUOPMD",151,0)
 ;
"RTN","PSUOPMD",152,0)
 S:NONE PSUTLC=0
"RTN","PSUOPMD",153,0)
 S PSUMSG("M")=PSUMC
"RTN","PSUOPMD",154,0)
 S PSUMSG("L")=PSUTLC
"RTN","PSUOPMD",155,0)
 Q
"RTN","PSUOPMD",156,0)
NODATA ;Send "No data to report" message
"RTN","PSUOPMD",157,0)
 S ^XTMP(PSUOPSUB,"RECMD",PSUSNDR,1)="No data to report"
"RTN","PSUOPMD",158,0)
 S NONE=1,PSUDIV=PSUSNDR
"RTN","PSUOPMD",159,0)
 ;S ^XTMP("PSU_"_PSUJOB,"PSUNONE","RX")=""
"RTN","PSUOPMD",160,0)
 S X=PSUDIV,DIC=4,DIC(0)="XM" D ^DIC ;**1
"RTN","PSUOPMD",161,0)
 S X=+Y,PSUDIVNM=$$VAL^PSUTL(4,X,.01)
"RTN","PSUOPMD",162,0)
 D XMD
"RTN","PSUOPMD",163,0)
SETCNT ;Set message count and line count
"RTN","PSUOPMD",164,0)
 S PSUMSGT(PSUDIV,"MD","M")=$G(PSUMSGT(PSUDIV,"MD","M"))+PSUMSG("M")
"RTN","PSUOPMD",165,0)
 S PSUMSGT(PSUDIV,"MD","L")=$G(PSUMSGT(PSUDIV,"MD","L"))+PSUMSG("L")
"RTN","PSUOPMD",166,0)
 S ^XTMP("PSU_"_PSUJOB,"CONFIRMD",PSUDIV,PSUOPTN,"M")=PSUMSGT(PSUDIV,"MD","M")
"RTN","PSUOPMD",167,0)
 S ^XTMP("PSU_"_PSUJOB,"CONFIRMD",PSUDIV,PSUOPTN,"L")=PSUMSGT(PSUDIV,"MD","L")
"RTN","PSUOPMD",168,0)
 Q
"RTN","PSUPR0")
0^77^B12872882
"RTN","PSUPR0",1,0)
PSUPR0 ;BIR/PDW -  PROCUREMENT EXTRACT ENTRY ROUTINE ;25 AUG 1998
"RTN","PSUPR0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR0",3,0)
 ;
"RTN","PSUPR0",4,0)
 ;DBIA's
"RTN","PSUPR0",5,0)
 ; Reference to file 4.3 supported by DBIA 10091
"RTN","PSUPR0",6,0)
 ; Reference to file 4   supported by DBIA 10090
"RTN","PSUPR0",7,0)
 ;
"RTN","PSUPR0",8,0)
EN ;EP from PSUCP
"RTN","PSUPR0",9,0)
 ;
"RTN","PSUPR0",10,0)
 ; pull variables from ^XTMP
"RTN","PSUPR0",11,0)
 ; PSUJOB must exist and must be the job number used to store the data desired for this session.
"RTN","PSUPR0",12,0)
 I '$D(PSUJOB) S PSUJOB=$J
"RTN","PSUPR0",13,0)
 S PSUVARS="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,ZTIO,PSUSNDR,PSUOPTS"
"RTN","PSUPR0",14,0)
 F I=1:1:$L(PSUVARS,",") S @$P(PSUVARS,",",I)=$P(^XTMP("PSU_"_PSUJOB,1),U,I)
"RTN","PSUPR0",15,0)
PULLQ ;Q
"RTN","PSUPR0",16,0)
 S PSUPRJOB=PSUJOB
"RTN","PSUPR0",17,0)
 S PSUPRSUB="PSUPR_"_PSUPRJOB
"RTN","PSUPR0",18,0)
 ;     Setup ^XTMP
"RTN","PSUPR0",19,0)
 S X1=DT,X2=6 D C^%DTC
"RTN","PSUPR0",20,0)
 K ^XTMP(PSUPRSUB)
"RTN","PSUPR0",21,0)
 S ^XTMP(PSUPRSUB,0)=X_U_DT_"^  PBM Extract - Procurement Module "
"RTN","PSUPR0",22,0)
 ;
"RTN","PSUPR0",23,0)
 ;     Store Important variables
"RTN","PSUPR0",24,0)
 K X
"RTN","PSUPR0",25,0)
 S X="PSUSDT,PSUEDT,PSUMON,PSUDUZ,PSUMASF,PSUPBMG,PSUSMRY,PSUSNDR,PSUPRSUB,PSUJOB,PSURTN,PSUOPTN"
"RTN","PSUPR0",26,0)
 F I=1:1 S Y=$P(X,",",I) Q:Y=""  I $D(@Y) S X(Y)=@Y
"RTN","PSUPR0",27,0)
 M ^XTMP(PSUPRSUB,"SAVE")=X
"RTN","PSUPR0",28,0)
 K X
"RTN","PSUPR0",29,0)
 ;    Process the Procurement Files
"RTN","PSUPR0",30,0)
 ; Code for CoreFLS  *  NOTE: This will be commented out as of 7/1/04
"RTN","PSUPR0",31,0)
 ;until such time as CoreFLS code is released.
"RTN","PSUPR0",32,0)
 ;S X="PSAFLS" X ^%ZOSF("TEST")
"RTN","PSUPR0",33,0)
 ;I $T D
"RTN","PSUPR0",34,0)
 ;.S PSUPRSUB="PSUPR_"_$J
"RTN","PSUPR0",35,0)
 ;.S PSUFLSFG=""    ;FLAG TO SIGNAL COREFLS IN EFFECT
"RTN","PSUPR0",36,0)
 ;.D EN^PSUPR2
"RTN","PSUPR0",37,0)
 ;.D EN^PSUPR3
"RTN","PSUPR0",38,0)
 ;.K PSUFLSFG
"RTN","PSUPR0",39,0)
 ;I '$T D          ;CoreFLS code. Commented out. When CoreFLS code is
"RTN","PSUPR0",40,0)
 ;released put the next 3 lines inside a dot structure.
"RTN","PSUPR0",41,0)
 D EN^PSUPR1 ; file 442
"RTN","PSUPR0",42,0)
 D EN^PSUPR2 ; file 58.811
"RTN","PSUPR0",43,0)
 D EN^PSUPR3 ; file 58.81
"RTN","PSUPR0",44,0)
 K PSUMSG
"RTN","PSUPR0",45,0)
 D EN^PSUPR4(.PSUMSG) ; detailed mail message to Hines
"RTN","PSUPR0",46,0)
 D EN^PSUPR5    ;Summary Mail Routines
"RTN","PSUPR0",47,0)
 ;
"RTN","PSUPR0",48,0)
 ;   return counters to master routine
"RTN","PSUPR0",49,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUPR0",50,0)
 I $D(^XTMP(PSUSUB)),PSUDUZ,PSUPBMG M ^XTMP(PSUSUB,"CONFIRM")=PSUMSG
"RTN","PSUPR0",51,0)
 ;D EN^PSUPR5 ;  Summary Mail Routines
"RTN","PSUPR0",52,0)
 Q
"RTN","PSUPR0",53,0)
PRINT ;EP Tasking Entry Point for PRINT REPORT
"RTN","PSUPR0",54,0)
 D EN^PSUPR6
"RTN","PSUPR0",55,0)
 Q
"RTN","PSUPR0",56,0)
EXIT ;EP Tasking Entry Point for Cleaning out XTMP  and Variables
"RTN","PSUPR0",57,0)
 ;    Restore Important Variables
"RTN","PSUPR0",58,0)
 K X
"RTN","PSUPR0",59,0)
 M X=^XTMP(PSUPRSUB,"SAVE")
"RTN","PSUPR0",60,0)
 K ^XTMP(PSUPRSUB)
"RTN","PSUPR0",61,0)
 D VARKILL^PSUTL
"RTN","PSUPR0",62,0)
 ;     Restore Important Variables CONTINUED
"RTN","PSUPR0",63,0)
 S Y="" F  S Y=$O(X(Y)) Q:Y=""  S @Y=X(Y)
"RTN","PSUPR0",64,0)
 K X
"RTN","PSUPR0",65,0)
 Q
"RTN","PSUPR0",66,0)
 ;
"RTN","PSUPR0",67,0)
CLEAR ;EP clear ^XTMP of PSUPR nodes
"RTN","PSUPR0",68,0)
 S X="PSUPR"
"RTN","PSUPR0",69,0)
 F  S X=$O(^XTMP(X)) Q:X=""  Q:$E(X,1,5)'="PSUPR"  W !,X K ^XTMP(X)
"RTN","PSUPR0",70,0)
 Q
"RTN","PSUPR0",71,0)
MANUAL ;EP   Manual entry point for Running Procurement Module to
"RTN","PSUPR0",72,0)
 ; exercise detailed message, summary messages, & Reports
"RTN","PSUPR0",73,0)
 ; Some startup code borrowed from PSUCP for dates
"RTN","PSUPR0",74,0)
 W !,"Mail messages are sent to the user only at this time",!
"RTN","PSUPR0",75,0)
 S PSUMON=$E(DT,1,5),(PSUSMRY,PSUMASF,PSUPBMG)=1,PSUDUZ=DUZ
"RTN","PSUPR0",76,0)
 S X=$P($G(^XMB(1,1,"XUS")),U,17),PSUSNDR=+$P(^DIC(4,X,99),U)
"RTN","PSUPR0",77,0)
 K %DT
"RTN","PSUPR0",78,0)
 S %DT="AEX",%DT(0)="-NOW",%DT("A")="STARTING Procurement Extract Date or ""^"" to quit : " D ^%DT
"RTN","PSUPR0",79,0)
 I X["^" Q
"RTN","PSUPR0",80,0)
 I 'Y Q
"RTN","PSUPR0",81,0)
 S PSUSDT=+Y
"RTN","PSUPR0",82,0)
 K %DT W !
"RTN","PSUPR0",83,0)
 S %DT="AEX",%DT(0)=PSUSDT,%DT("A")="ENDING Procurement Extract Date or ""^"" to restart: " D ^%DT
"RTN","PSUPR0",84,0)
 I X["^" G MANUAL
"RTN","PSUPR0",85,0)
 I 'Y G MANUAL
"RTN","PSUPR0",86,0)
 S PSUEDT=+Y
"RTN","PSUPR0",87,0)
 W !
"RTN","PSUPR0",88,0)
 S Y=PSUSDT D DD^%DT W !,"Starting Procurement Date",?30,Y
"RTN","PSUPR0",89,0)
 S Y=PSUEDT D DD^%DT W !,"Ending Procurement Date:",?30,Y
"RTN","PSUPR0",90,0)
 K DIR W !
"RTN","PSUPR0",91,0)
 S DIR(0)="Y",DIR("A")="Correct ? ",DIR("B")="YES" D ^DIR
"RTN","PSUPR0",92,0)
 I 'Y G MANUAL
"RTN","PSUPR0",93,0)
 K DIR W !
"RTN","PSUPR0",94,0)
 W !,"You can not queue to your terminal",!
"RTN","PSUPR0",95,0)
 W !,"You can queue to a host file",!
"RTN","PSUPR0",96,0)
 S DIR(0)="Y",DIR("A")="Do yo want reports printed ? ",DIR("B")="YES" D ^DIR
"RTN","PSUPR0",97,0)
 K DIR W !
"RTN","PSUPR0",98,0)
 S PSURP=+Y
"RTN","PSUPR0",99,0)
 S PSURC="COMPUTE^PSUPR0"
"RTN","PSUPR0",100,0)
 I PSURP S PSURP="PRINT^PSUPR0" K PSUIOP
"RTN","PSUPR0",101,0)
 E  K PSURP S PSUIOP="" ; MAIL MESSAGES ONLY
"RTN","PSUPR0",102,0)
 S PSURX="EXIT^PSUPR0"
"RTN","PSUPR0",103,0)
 S PSUNS="PSUPR*,PSUSDT,PSUEDT,PSU*"
"RTN","PSUPR0",104,0)
 D EN^PSUDBQUE
"RTN","PSUPR0",105,0)
 Q
"RTN","PSUPR1")
0^78^B16749174
"RTN","PSUPR1",1,0)
PSUPR1 ;BIR/PDW - Data Gathering for PBMS PR file 442 ;12 AUG 1999
"RTN","PSUPR1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR1",3,0)
 ;DBIAs
"RTN","PSUPR1",4,0)
 ; Reference to file #442    supported by DBIA 1020
"RTN","PSUPR1",5,0)
 ; Reference to file #445.01 supported by DBIA 1021
"RTN","PSUPR1",6,0)
 ; Reference to file #420.5  supported by DBIA 1022
"RTN","PSUPR1",7,0)
 ; Reference to file #410    supported by DBIA 2345,2409
"RTN","PSUPR1",8,0)
 ; Reference to file #440    supported by DBIA 2606
"RTN","PSUPR1",9,0)
 ; Reference to file #4.3    supported by DBIA 10091
"RTN","PSUPR1",10,0)
 ; Reference to file #50     supported by DBIA 221
"RTN","PSUPR1",11,0)
 ;
"RTN","PSUPR1",12,0)
EN ;EP Entry Point
"RTN","PSUPR1",13,0)
 S PSUEDT=PSUEDT\1+.24
"RTN","PSUPR1",14,0)
 S PSUPRSDT=PSUSDT
"RTN","PSUPR1",15,0)
 S PSUPREDT=PSUEDT
"RTN","PSUPR1",16,0)
 ;   setup ^XTMP node
"RTN","PSUPR1",17,0)
 S:'$D(PSUPRJOB) PSUPRJOB=$J
"RTN","PSUPR1",18,0)
 S:'$D(PSUPRSUB) PSUPRSUB="PSUPR_"_PSUPRJOB
"RTN","PSUPR1",19,0)
 I '$D(^XTMP(PSUPRSUB)) D
"RTN","PSUPR1",20,0)
 . S ^XTMP(PSUPRSUB,"RECORDS",0)=""
"RTN","PSUPR1",21,0)
 . S X1=DT,X2=6 D C^%DTC
"RTN","PSUPR1",22,0)
 . S ^XTMP(PSUPRSUB,0)=X_"^"_DT_"^ PBMS Procurement Extraction"
"RTN","PSUPR1",23,0)
START ;EP
"RTN","PSUPR1",24,0)
 N PSUDT,PSUDA
"RTN","PSUPR1",25,0)
 S PSURC=0 ;   record counter
"RTN","PSUPR1",26,0)
 S PSUDT=PSUPRSDT
"RTN","PSUPR1",27,0)
 F  S PSUDT=$O(^PRC(442,"AB",PSUDT)) Q:PSUDT'>0  Q:PSUDT>PSUPREDT  D PODATE
"RTN","PSUPR1",28,0)
 Q
"RTN","PSUPR1",29,0)
 ;
"RTN","PSUPR1",30,0)
PODATE ;EP Process a PO DATE
"RTN","PSUPR1",31,0)
 N PSUPODA
"RTN","PSUPR1",32,0)
 ;    File 442 can not be linked to division so div=sender
"RTN","PSUPR1",33,0)
 ;    and indicator = "H"
"RTN","PSUPR1",34,0)
 S X=$P($G(^XMB(1,1,"XUS")),U,17)
"RTN","PSUPR1",35,0)
 S PSUDIV=PSUSNDR,PSUDIVI="H"
"RTN","PSUPR1",36,0)
 ;    Loop POs within date
"RTN","PSUPR1",37,0)
 S PSUPODA=0
"RTN","PSUPR1",38,0)
 F  S PSUPODA=$O(^PRC(442,"AB",PSUDT,PSUPODA)) Q:'PSUPODA  D PO
"RTN","PSUPR1",39,0)
 Q
"RTN","PSUPR1",40,0)
 ;
"RTN","PSUPR1",41,0)
PO ;EP Process a PO
"RTN","PSUPR1",42,0)
 N PSUPO,PSUCC
"RTN","PSUPR1",43,0)
 S PSUCC=$$VALI^PSUTL(442,PSUPODA,2) ;   cost center
"RTN","PSUPR1",44,0)
 I PSUCC'=822400,PSUCC'=828100 Q  ; not pharmacy related
"RTN","PSUPR1",45,0)
 S PSUSS=$$VALI^PSUTL(442,PSUPODA,.5) ;  supply status
"RTN","PSUPR1",46,0)
 I PSUSS>14,PSUSS<45
"RTN","PSUPR1",47,0)
 E  Q  ; not within status range
"RTN","PSUPR1",48,0)
 ;      load po information
"RTN","PSUPR1",49,0)
 D GETS^PSUTL(442,PSUPODA,".01;.1;1;2;5","PSUPO","I")
"RTN","PSUPR1",50,0)
 D MOVEI^PSUTL("PSUPO")
"RTN","PSUPR1",51,0)
 ;
"RTN","PSUPR1",52,0)
 ;      further process po information
"RTN","PSUPR1",53,0)
 S PSUPO(5)=$$VALI^PSUTL(440,PSUPO(5),.01) ; Vendor name
"RTN","PSUPR1",54,0)
 ;
"RTN","PSUPR1",55,0)
 ;      load item information
"RTN","PSUPR1",56,0)
 K ^TMP($J,"PSUMIT")
"RTN","PSUPR1",57,0)
 D GETM^PSUTL(442,PSUPODA,"40*^1;1.5;3;3.1;5;9.3;10;11","^TMP($J,""PSUMIT"")","IN")
"RTN","PSUPR1",58,0)
 D MOVEMI^PSUTL("^TMP($J,""PSUMIT"")")
"RTN","PSUPR1",59,0)
 ;
"RTN","PSUPR1",60,0)
 ;      loop items
"RTN","PSUPR1",61,0)
 S PSUITDA=0
"RTN","PSUPR1",62,0)
 F  S PSUITDA=$O(^TMP($J,"PSUMIT",PSUITDA)) Q:PSUITDA'>0  D ITEM
"RTN","PSUPR1",63,0)
 Q
"RTN","PSUPR1",64,0)
 ;
"RTN","PSUPR1",65,0)
ITEM ;EP    Process one item
"RTN","PSUPR1",66,0)
 N PSUIT,PSUDRDA
"RTN","PSUPR1",67,0)
 M PSUIT=^TMP($J,"PSUMIT",PSUITDA)
"RTN","PSUPR1",68,0)
 ;
"RTN","PSUPR1",69,0)
 ;       Get Drug
"RTN","PSUPR1",70,0)
 S PSUIT(1.5)=+$G(PSUIT(1.5))
"RTN","PSUPR1",71,0)
 S PSUDRDA=$O(^PSDRUG("AB",PSUIT(1.5),0))
"RTN","PSUPR1",72,0)
 N PSUARSUB,PSUARJOB S PSUARSUB=PSUPRSUB,PSUARJOB=PSUPRJOB
"RTN","PSUPR1",73,0)
 I PSUDRDA D DRUG^PSUAR2(PSUDRDA) ;  setup drug profile
"RTN","PSUPR1",74,0)
 ;
"RTN","PSUPR1",75,0)
 ;      process dispense unit 445 & conversion factor   3.2.6.1.5
"RTN","PSUPR1",76,0)
 S X=+$G(PSUIT(10)),X=+$$VALI^PSUTL(410,X,4)
"RTN","PSUPR1",77,0)
 ;      disp unit
"RTN","PSUPR1",78,0)
 S PSUIT("DU")=$$VALI^PSUTL(445.01,"X,PSUIT(1.5)",50)
"RTN","PSUPR1",79,0)
 ;      disp unit conver factor
"RTN","PSUPR1",80,0)
 S PSUIT("DUCV")=$$VALI^PSUTL(445.01,"X,PSUIT(1.5)",51)
"RTN","PSUPR1",81,0)
 ;      unit of purchase
"RTN","PSUPR1",82,0)
 S PSUIT("UOP")=$$VALI^PSUTL(420.5,+$G(PSUIT(3)),.01)
"RTN","PSUPR1",83,0)
 ;
"RTN","PSUPR1",84,0)
 ;      further process fields
"RTN","PSUPR1",85,0)
 S:'$L($G(PSUIT(9.3))) PSUIT(9.3)="No NDC"
"RTN","PSUPR1",86,0)
 ;
"RTN","PSUPR1",87,0)
 ;
"RTN","PSUPR1",88,0)
REC ;EP Assemble record
"RTN","PSUPR1",89,0)
 K PSUR
"RTN","PSUPR1",90,0)
 S PSUG="^XTMP(PSUPRSUB,""PSUDRUG_DET"",PSUDRDA)" ; drug reference
"RTN","PSUPR1",91,0)
 S PSUR(2)=$G(PSUDIV)
"RTN","PSUPR1",92,0)
 S PSUR(3)=$G(PSUDIVI)
"RTN","PSUPR1",93,0)
 S PSUR(4)=$G(PSUPO(.1))
"RTN","PSUPR1",94,0)
 I PSUDRDA D
"RTN","PSUPR1",95,0)
 . S PSUR(5)=@PSUG@(21)
"RTN","PSUPR1",96,0)
 . S PSUR(7)=@PSUG@(.01)
"RTN","PSUPR1",97,0)
 . S PSUR(12)=@PSUG@(14.5)
"RTN","PSUPR1",98,0)
 . S PSUR(6)=@PSUG@(2)
"RTN","PSUPR1",99,0)
 I 'PSUDRDA D
"RTN","PSUPR1",100,0)
 . S PSUR(5)="Unknown VA Product Name"
"RTN","PSUPR1",101,0)
 . S PSUR(7)="Unknown Generic Name"
"RTN","PSUPR1",102,0)
 S PSUR(8)=$G(PSUIT(1,1))_$G(PSUIT(1,2)) S:'$L(PSUR(8)) PSUR(8)="No description listed"
"RTN","PSUPR1",103,0)
 F  S X=$E(PSUR(8)) Q:X'=" "  S PSUR(8)=$E(PSUR(8),2,999)
"RTN","PSUPR1",104,0)
 S PSUR(8)=$E(PSUR(8),1,50)
"RTN","PSUPR1",105,0)
 S PSUR(9)=$G(PSUIT(9.3))
"RTN","PSUPR1",106,0)
 S PSUR(12)=$G(PSUIT("DU"))
"RTN","PSUPR1",107,0)
 S PSUR(13)=$G(PSUIT("UOP"))
"RTN","PSUPR1",108,0)
 S PSUR(14)=$G(PSUIT(3.1))
"RTN","PSUPR1",109,0)
 S PSUR(15)=PSUIT("DU")
"RTN","PSUPR1",110,0)
 S PSUR(16)=PSUIT("DUCV")
"RTN","PSUPR1",111,0)
 S PSUR(17)=$G(PSUIT(11))
"RTN","PSUPR1",112,0)
 S PSUR(18)=$G(PSUIT(5))
"RTN","PSUPR1",113,0)
 S PSUR(19)=$G(PSUIT(11))*$G(PSUIT(5))
"RTN","PSUPR1",114,0)
 S PSUR(20)=PSUPO(5)
"RTN","PSUPR1",115,0)
 S PSUR(22)=PSUPO(1)
"RTN","PSUPR1",116,0)
 S PSUR=""
"RTN","PSUPR1",117,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S PSUR(I)=$TR(PSUR(I),"^","'")
"RTN","PSUPR1",118,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S $P(PSUR,"^",I)=PSUR(I)
"RTN","PSUPR1",119,0)
 S PSUR=PSUR_"^"
"RTN","PSUPR1",120,0)
 ;   Store Records under PSUSNDR default division
"RTN","PSUPR1",121,0)
 S PSURC=PSURC+1,^XTMP(PSUPRSUB,"RECORDS",PSUSNDR,PSURC)=$E(PSUR,1,240) I $L(PSUR)>240 S ^(PSURC,1)=$E(PSUR,241,999)
"RTN","PSUPR1",122,0)
 Q
"RTN","PSUPR2")
0^79^B61724094
"RTN","PSUPR2",1,0)
PSUPR2 ;BIR/PDW - Procurement extract from file 58.811 ;20 AUG 1999
"RTN","PSUPR2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR2",3,0)
 ;DBIAs
"RTN","PSUPR2",4,0)
 ; Reference to file #58.811 supported by DBIA 2521
"RTN","PSUPR2",5,0)
 ; Reference to file #51.5   supported by DBIA 1931
"RTN","PSUPR2",6,0)
 ; Reference to file #50     supported by DBIA 221
"RTN","PSUPR2",7,0)
 ; Reference to file #58.8   supported by DBIA 2519
"RTN","PSUPR2",8,0)
 ; Reference to file #42     supported by DBIA 2440
"RTN","PSUPR2",9,0)
 ; Reference to file #40.8   supported by DBIA 2438
"RTN","PSUPR2",10,0)
 ; Reference to file #59.5   supported by DBIA 2499
"RTN","PSUPR2",11,0)
 ; Reference to file #59     supported by DBIA 2510
"RTN","PSUPR2",12,0)
 ;
"RTN","PSUPR2",13,0)
EN ;
"RTN","PSUPR2",14,0)
 S PSUEND=PSUEDT
"RTN","PSUPR2",15,0)
 S PSUEDT=PSUEDT\1+.24
"RTN","PSUPR2",16,0)
 S:'$D(PSUPRJOB) PSUPRJOB=$J
"RTN","PSUPR2",17,0)
 S:'$D(PSUPRSUB) PSUPRSUB="PSUPR_"_$J
"RTN","PSUPR2",18,0)
 I '$D(^XTMP(PSUPRSUB)) D
"RTN","PSUPR2",19,0)
 . S ^XTMP(PSUPRSUB,"RECORDS",0)=""
"RTN","PSUPR2",20,0)
 . S X1=DT,X2=6 D C^%DTC
"RTN","PSUPR2",21,0)
 . S ^XTMP(PSUPRSUB,0)=X_"^"_DT_"^ PBMS Procurement Extraction"
"RTN","PSUPR2",22,0)
 ;
"RTN","PSUPR2",23,0)
 S PSUARJOB=PSUPRJOB,PSUARSUB="PSUAR_"_PSUARJOB
"RTN","PSUPR2",24,0)
 D MAP
"RTN","PSUPR2",25,0)
 ;
"RTN","PSUPR2",26,0)
 ;   check for Drug Accountability
"RTN","PSUPR2",27,0)
 S X=$$VERSION^XPDUTL("DRUG ACCOUNTABILITY")
"RTN","PSUPR2",28,0)
 I 'X Q  ; not installed
"RTN","PSUPR2",29,0)
 ;
"RTN","PSUPR2",30,0)
 S X1=PSUSDT,X2=-45 ;backup by 45 days per revision
"RTN","PSUPR2",31,0)
 D C^%DTC
"RTN","PSUPR2",32,0)
 S PSUDT=X
"RTN","PSUPR2",33,0)
 ;    loop thru invoice date field xref
"RTN","PSUPR2",34,0)
 F  S PSUDT=$O(^PSD(58.811,"ADATE",PSUDT)) Q:PSUDT>PSUEDT  Q:PSUDT'>0  D
"RTN","PSUPR2",35,0)
 .  S PSUORDA=0 F  S PSUORDA=$O(^PSD(58.811,"ADATE",PSUDT,PSUORDA)) Q:PSUORDA'>0  D
"RTN","PSUPR2",36,0)
 .. S PSUINVDA=0 F  S PSUINVDA=$O(^PSD(58.811,"ADATE",PSUDT,PSUORDA,PSUINVDA)) Q:PSUINVDA'>0  D INVOICE
"RTN","PSUPR2",37,0)
 Q
"RTN","PSUPR2",38,0)
 ;
"RTN","PSUPR2",39,0)
INVOICE ;EP process an invoice within an order
"RTN","PSUPR2",40,0)
 N PSUSTAT
"RTN","PSUPR2",41,0)
 S PSUSTAT=$$VALI^PSUTL(58.8112,"PSUORDA,PSUINVDA",2)
"RTN","PSUPR2",42,0)
 I PSUSTAT'="C" Q  ;     3.2.6.1
"RTN","PSUPR2",43,0)
 N PSUORD
"RTN","PSUPR2",44,0)
 D GETS^PSUTL(58.811,PSUORDA,".01;1","PSUORD")
"RTN","PSUPR2",45,0)
 ;
"RTN","PSUPR2",46,0)
 S PSUINV=""
"RTN","PSUPR2",47,0)
 N PSURDT,PSUIVNUM
"RTN","PSUPR2",48,0)
 D GETS^PSUTL(58.8112,"PSUORDA,PSUINVDA",".01;1;2;3;4;7;8;13","PSUINV","I")
"RTN","PSUPR2",49,0)
 D MOVEI^PSUTL("PSUINV")
"RTN","PSUPR2",50,0)
 S PSURDT=PSUINV(8)
"RTN","PSUPR2",51,0)
 S PSUIVNUM=PSUINV(.01)
"RTN","PSUPR2",52,0)
 ;
"RTN","PSUPR2",53,0)
 I $G(PSUINV(4)) D DIV
"RTN","PSUPR2",54,0)
 I $L(PSUDIV) S PSUDIVI=""
"RTN","PSUPR2",55,0)
 E  S PSUDIV=PSUSNDR,PSUDIVI="H"
"RTN","PSUPR2",56,0)
 ;
"RTN","PSUPR2",57,0)
 ;
"RTN","PSUPR2",58,0)
 K ^TMP($J,"PSUMIT") ;   array for multiple items
"RTN","PSUPR2",59,0)
 D GETM^PSUTL(58.8112,"PSUORDA,PSUINVDA","5*^1;2;3;4;7;13;14;15","^TMP($J,""PSUMIT"")","I")
"RTN","PSUPR2",60,0)
 I '$D(^TMP($J,"PSUMIT")) Q  ;
"RTN","PSUPR2",61,0)
 D MOVEMI^PSUTL("^TMP($J,""PSUMIT"")")
"RTN","PSUPR2",62,0)
 ;
"RTN","PSUPR2",63,0)
 S PSUITDA=0 F  S PSUITDA=$O(^TMP($J,"PSUMIT",PSUITDA)) Q:PSUITDA'>0  D ITEM
"RTN","PSUPR2",64,0)
 Q
"RTN","PSUPR2",65,0)
ITEM ;EP  process one item within the invoice
"RTN","PSUPR2",66,0)
 N PSUIT ;  array for one item
"RTN","PSUPR2",67,0)
 M PSUIT=^TMP($J,"PSUMIT",PSUITDA)
"RTN","PSUPR2",68,0)
 ;
"RTN","PSUPR2",69,0)
 I (PSUIT(7)<PSUSDT) Q
"RTN","PSUPR2",70,0)
 I (PSUIT(7)>PSUEDT) Q
"RTN","PSUPR2",71,0)
 ;     pull adjustments   3.2.6.2.8
"RTN","PSUPR2",72,0)
 N PSUMADJ
"RTN","PSUPR2",73,0)
 D GETM^PSUTL(58.81125,"PSUORDA,PSUINVDA,PSUITDA","9*^.01;5","PSUMADJ","I")
"RTN","PSUPR2",74,0)
 I $D(PSUMADJ) D MOVEMI^PSUTL("PSUMADJ")
"RTN","PSUPR2",75,0)
 ;
"RTN","PSUPR2",76,0)
 ;
"RTN","PSUPR2",77,0)
 ;      Review/Process Adjustments
"RTN","PSUPR2",78,0)
 I $D(PSUMADJ) S PSUADJDA=0 F  S PSUADJDA=$O(PSUMADJ(PSUADJDA)) Q:PSUADJDA'>0  D
"RTN","PSUPR2",79,0)
 . N PSUADJ
"RTN","PSUPR2",80,0)
 . M PSUADJ=PSUMADJ(PSUADJDA)
"RTN","PSUPR2",81,0)
 . ;
"RTN","PSUPR2",82,0)
 . I PSUADJ(.01)="D" S PSUIT(1)=PSUADJ(5)  ; 3.2.6.2.8    Drug or Supply 
"RTN","PSUPR2",83,0)
 . I PSUADJ(.01)="O" S PSUIT(3)=PSUADJ(5)  ; 3.2.6.2.11   OrderUnits
"RTN","PSUPR2",84,0)
 . I PSUADJ(.01)="P" S PSUIT(4)=PSUADJ(5)  ; 3.2.6.2.12   Price
"RTN","PSUPR2",85,0)
 . I PSUADJ(.01)="Q" S PSUIT(2)=PSUIT(2)+PSUADJ(5) ; 3.2.6.2.10 Quantity
"RTN","PSUPR2",86,0)
 . Q
"RTN","PSUPR2",87,0)
 ;
"RTN","PSUPR2",88,0)
 I 'PSUIT(2) Q  ; per Lina 10/7/98  if qty = 0 don't send record
"RTN","PSUPR2",89,0)
 ;    work on the order unit PSUIT(3)
"RTN","PSUPR2",90,0)
 I '$D(PSUADJ),+PSUIT(3)=0 S PSUIT(3)="" ; per Lina
"RTN","PSUPR2",91,0)
 I PSUIT(3) S PSUIT(3)=$$VAL^PSUTL(51.5,PSUIT(3),.01) ; 3.2.6.2.11
"RTN","PSUPR2",92,0)
 ;
"RTN","PSUPR2",93,0)
 ;    further process item fields  3.2.6.2.9 +
"RTN","PSUPR2",94,0)
 ;
"RTN","PSUPR2",95,0)
 ;    look for/ construct Dispense Units per Order Unit
"RTN","PSUPR2",96,0)
 ;    Store in PSUIT(9999)  3.2.6.2.13
"RTN","PSUPR2",97,0)
 ;  Get Related Drug Fields 3.2.6.2.9
"RTN","PSUPR2",98,0)
 ;
"RTN","PSUPR2",99,0)
 N PSUDRUG
"RTN","PSUPR2",100,0)
 S PSUDRDA=0
"RTN","PSUPR2",101,0)
 ;  if PSUIT(1) is a supply item the following will not be computed
"RTN","PSUPR2",102,0)
 I PSUIT(1)=+PSUIT(1) D
"RTN","PSUPR2",103,0)
 . S PSUDRDA=PSUIT(1)
"RTN","PSUPR2",104,0)
 . ;S PSUARJOB=PSUPRJOB,PSUARSUB="PSUAR_"_PSUARJOB
"RTN","PSUPR2",105,0)
 . D GETS^PSUTL(50,PSUDRDA,".01;2;13;25;14.5;21;31","PSUDRUG","I")
"RTN","PSUPR2",106,0)
 . D MOVEI^PSUTL("PSUDRUG")
"RTN","PSUPR2",107,0)
 . S PSUIT(1)=PSUDRUG(.01)                          ; Generic Name
"RTN","PSUPR2",108,0)
 . S:PSUDRUG(21)="" PSUDRUG(21)="Unknown VA Product Name"
"RTN","PSUPR2",109,0)
 . S:PSUDRUG(31)="" PSUDRUG(31)="No NDC"
"RTN","PSUPR2",110,0)
 ;   further process fields
"RTN","PSUPR2",111,0)
 ;   fill in drug fields for supply items
"RTN","PSUPR2",112,0)
 I 'PSUDRDA D
"RTN","PSUPR2",113,0)
 . S PSUDRUG(.01)="Unknown Generic Name"
"RTN","PSUPR2",114,0)
 . S PSUDRUG(21)="Unknown VA Product Name"
"RTN","PSUPR2",115,0)
 . S PSUDRUG(31)="No NDC"
"RTN","PSUPR2",116,0)
 ;
"RTN","PSUPR2",117,0)
 ; NDC
"RTN","PSUPR2",118,0)
 I PSUIT(13)="" S PSUIT(13)=$G(PSUDRUG(31)) S:PSUIT(13)="" PSUIT(13)="No NDC"
"RTN","PSUPR2",119,0)
 ;
"RTN","PSUPR2",120,0)
 ;      dispense units per order unit 3.2.6.2.13
"RTN","PSUPR2",121,0)
 ;
"RTN","PSUPR2",122,0)
 S PSUIT(9999)=0
"RTN","PSUPR2",123,0)
 I $L(PSUIT(13)),$G(PSUDRDA) D
"RTN","PSUPR2",124,0)
 . S X=$O(^PSDRUG("C",PSUIT(13),PSUDRDA,""))
"RTN","PSUPR2",125,0)
 . I X S PSUIT(9999)=$$VALI^PSUTL(50.1,"PSUDRDA,X","403")
"RTN","PSUPR2",126,0)
 ;
"RTN","PSUPR2",127,0)
 I '$D(PSUADJ),'PSUIT(9999) S PSUIT(9999)="" ; per Lina
"RTN","PSUPR2",128,0)
 ;
"RTN","PSUPR2",129,0)
 ;Create "RECORDS" global for CoreFLS data
"RTN","PSUPR2",130,0)
 I $D(PSUFLSFG) S PSUA="" D
"RTN","PSUPR2",131,0)
 .F  S PSUA=$O(^XTMP(PSUPRSUB,"PSUFLS",PSUA)) Q:PSUA=""  D SIMPL^PSUPR7
"RTN","PSUPR2",132,0)
 ;
"RTN","PSUPR2",133,0)
 ;   Construct record and store into ^XTMP(PSUPRSUB,"RECORDS",PSUDIV,LC)
"RTN","PSUPR2",134,0)
 S PSUR=$$RECORD()
"RTN","PSUPR2",135,0)
 ;   Store Records by Division
"RTN","PSUPR2",136,0)
 S PSULC=+$O(^XTMP(PSUPRSUB,"RECORDS",PSUDIV,""),-1)
"RTN","PSUPR2",137,0)
 S PSULC=PSULC+1
"RTN","PSUPR2",138,0)
 S ^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSULC)=PSUR
"RTN","PSUPR2",139,0)
 Q
"RTN","PSUPR2",140,0)
 ;
"RTN","PSUPR2",141,0)
RECORD() ;EP Assemble record
"RTN","PSUPR2",142,0)
 N PSUR
"RTN","PSUPR2",143,0)
 S PSUR(2)=$G(PSUDIV)
"RTN","PSUPR2",144,0)
 S PSUR(3)=$G(PSUDIVI)
"RTN","PSUPR2",145,0)
 S PSUR(4)=PSUIT(7)\1      ; 3.2.6.2.2
"RTN","PSUPR2",146,0)
 S PSUR(5)=$G(PSUDRUG(21)) ; 3.2.6.2.9
"RTN","PSUPR2",147,0)
 S PSUR(6)=$G(PSUDRUG(2))  ;  ""
"RTN","PSUPR2",148,0)
 S PSUR(7)=PSUIT(1)     ; 3.2.6.2.8
"RTN","PSUPR2",149,0)
 S PSUR(9)=PSUIT(13)    ; 3.2.6.2.9
"RTN","PSUPR2",150,0)
 S PSUR(10)=PSUIT(14)    ;    ""
"RTN","PSUPR2",151,0)
 S PSUR(11)=PSUIT(15)    ;    ""
"RTN","PSUPR2",152,0)
 S PSUR(12)=$G(PSUDRUG(14.5)) ; ""
"RTN","PSUPR2",153,0)
 S PSUR(13)=PSUIT(3)     ; 3.2.6.2.11
"RTN","PSUPR2",154,0)
 S PSUR(16)=PSUIT(9999)  ; 3.2.6.2.13
"RTN","PSUPR2",155,0)
 S PSUR(17)=PSUIT(2)     ; 3.2.6.2.10
"RTN","PSUPR2",156,0)
 S PSUR(18)=PSUIT(4)     ; 3.2.6.2.12
"RTN","PSUPR2",157,0)
 S PSUR(19)=PSUR(17)*PSUR(18) ; 3.2.6.2.14
"RTN","PSUPR2",158,0)
 S PSUR(20)=PSUORD(1)    ; 3.2.6.2.5
"RTN","PSUPR2",159,0)
 S PSUR(21)=PSUINV(.01)  ; 3.2.6.2.6
"RTN","PSUPR2",160,0)
 S PSUR(22)=""
"RTN","PSUPR2",161,0)
 S PSUR=""
"RTN","PSUPR2",162,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S PSUR(I)=$TR(PSUR(I),"^","'")
"RTN","PSUPR2",163,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S $P(PSUR,U,I)=PSUR(I)
"RTN","PSUPR2",164,0)
 S PSUR=PSUR_U
"RTN","PSUPR2",165,0)
 Q PSUR
"RTN","PSUPR2",166,0)
 ;
"RTN","PSUPR2",167,0)
DIV ;Find division or outpatient site
"RTN","PSUPR2",168,0)
 ;
"RTN","PSUPR2",169,0)
 S PSUDIV=""
"RTN","PSUPR2",170,0)
 N MAPLOCI
"RTN","PSUPR2",171,0)
 D GETM^PSUTL(59.7,1,"90.03*^.01;.02;.03","MAPLOCI","I")
"RTN","PSUPR2",172,0)
 D MOVEMI^PSUTL("MAPLOCI")
"RTN","PSUPR2",173,0)
 ;
"RTN","PSUPR2",174,0)
 I $G(MAPLOCI(PSUINV(4),.01)) D
"RTN","PSUPR2",175,0)
 .S X=$G(MAPLOCI(PSUINV(4),.02)) I X S PSUDIV=$$VALI^PSUTL(40.8,X,1)
"RTN","PSUPR2",176,0)
 .S X=$G(MAPLOCI(PSUINV(4),.03)) I X S PSUDIV=$$VALI^PSUTL(59,X,.06)
"RTN","PSUPR2",177,0)
 I '$G(MAPLOCI(PSUINV(4),.01)) D
"RTN","PSUPR2",178,0)
 .S PSUDIV=PSUSNDR
"RTN","PSUPR2",179,0)
 .S PSUDIVI="H"
"RTN","PSUPR2",180,0)
 Q
"RTN","PSUPR2",181,0)
 ;
"RTN","PSUPR2",182,0)
 ;
"RTN","PSUPR2",183,0)
MAP ;Find out whether a Narcotics Area of Use (NAOU) or a DA Pharmacy
"RTN","PSUPR2",184,0)
 ;Location is mapped to a division or outpatient site.  If it is not
"RTN","PSUPR2",185,0)
 ;mapped, store the NAME and INACTIVATION DAT (if applicable) in a
"RTN","PSUPR2",186,0)
 ;global to be mailed to the user.
"RTN","PSUPR2",187,0)
 ;
"RTN","PSUPR2",188,0)
 K NAOU,DAPH
"RTN","PSUPR2",189,0)
 K MAPLOCI,MAPLOC
"RTN","PSUPR2",190,0)
 S PSUNAM=0            ;This is the name of the NAOU or DA PHARMACY
"RTN","PSUPR2",191,0)
 ;
"RTN","PSUPR2",192,0)
 F  S PSUNAM=$O(^PSD(58.8,"B",PSUNAM)) Q:PSUNAM=""  D
"RTN","PSUPR2",193,0)
 .S IEN=0
"RTN","PSUPR2",194,0)
 .F  S IEN=$O(^PSD(58.8,"B",PSUNAM,IEN)) Q:IEN=""  D
"RTN","PSUPR2",195,0)
 ..D GETS^PSUTL(58.8,IEN,".01;1;4","NAOU(IEN)")
"RTN","PSUPR2",196,0)
 ..I NAOU(IEN,1)="PRIMARY" M DAPH(IEN)=NAOU(IEN) K NAOU(IEN)
"RTN","PSUPR2",197,0)
 ..D MAP1
"RTN","PSUPR2",198,0)
 ;
"RTN","PSUPR2",199,0)
 Q
"RTN","PSUPR2",200,0)
 ;
"RTN","PSUPR2",201,0)
MAP1 ;MAP continued. This subroutine takes the IEN from file 58.8 and looks
"RTN","PSUPR2",202,0)
 ;to see if it is in file 59.7, field 90.02 or 90.03.
"RTN","PSUPR2",203,0)
 ;
"RTN","PSUPR2",204,0)
 ;If it is in 90.02, and field 4 from 58.8 is NOT "P", and there is
"RTN","PSUPR2",205,0)
 ;no value in subfield .02 or .03, then an NAOU has not been mapped.
"RTN","PSUPR2",206,0)
 ;
"RTN","PSUPR2",207,0)
 ;If it is in 90.03, and field 4 from 58.8 IS a "P", and there is
"RTN","PSUPR2",208,0)
 ;no value in subfield .02 or .03, then a DA PHARMACY location has not
"RTN","PSUPR2",209,0)
 ;been mapped.
"RTN","PSUPR2",210,0)
 ;
"RTN","PSUPR2",211,0)
 ;Keep only the entries that are NOT mapped
"RTN","PSUPR2",212,0)
 ;
"RTN","PSUPR2",213,0)
 N PSUDA
"RTN","PSUPR2",214,0)
 ;
"RTN","PSUPR2",215,0)
 ;Look for unmapped NAOU's
"RTN","PSUPR2",216,0)
 ;I $G(NAOU(IEN),1) D
"RTN","PSUPR2",217,0)
 I $G(^PS(59.7,1,90.02,IEN,0)) D
"RTN","PSUPR2",218,0)
 .D GETM^PSUTL(59.7,1,"90.02*^.01;.02;.03","MAPLOCI")
"RTN","PSUPR2",219,0)
 .S PSUDA=0
"RTN","PSUPR2",220,0)
 .F  S PSUDA=$O(MAPLOCI(PSUDA)) Q:PSUDA=""  D
"RTN","PSUPR2",221,0)
 ..I MAPLOCI(PSUDA,.02)'="" K NAOU(PSUDA)
"RTN","PSUPR2",222,0)
 ..I MAPLOCI(PSUDA,.03)'="" K NAOU(PSUDA)
"RTN","PSUPR2",223,0)
 M ^XTMP(PSUARSUB,"NAOU")=NAOU          ;only unmapped NAOU locations.
"RTN","PSUPR2",224,0)
 ;
"RTN","PSUPR2",225,0)
 ;
"RTN","PSUPR2",226,0)
 ;Look for unmapped DA PHARM
"RTN","PSUPR2",227,0)
 I $G(^PS(59.7,1,90.03,IEN,0)) D
"RTN","PSUPR2",228,0)
 .D GETM^PSUTL(59.7,1,"90.03*^.01;.02;.03","MAPLOC")
"RTN","PSUPR2",229,0)
 .S PSUDA=0
"RTN","PSUPR2",230,0)
 .F  S PSUDA=$O(MAPLOC(PSUDA)) Q:PSUDA=""  D
"RTN","PSUPR2",231,0)
 ..I $G(MAPLOC(PSUDA,.02))'="" K NAOU(PSUDA)
"RTN","PSUPR2",232,0)
 ..I $G(MAPLOC(PSUDA,.03))'="" K NAOU(PSUDA)
"RTN","PSUPR2",233,0)
 M ^XTMP(PSUARSUB,"DAPH")=DAPH      ;only unmapped DA PHARM locations.
"RTN","PSUPR2",234,0)
 Q
"RTN","PSUPR2",235,0)
 ;
"RTN","PSUPR2",236,0)
WRD() ;EP    Process for ward;
"RTN","PSUPR2",237,0)
 N PSUWD,PSUWDDA,PSUDIV
"RTN","PSUPR2",238,0)
 S PSUDIV=""
"RTN","PSUPR2",239,0)
 D GETM^PSUTL(58.8,PSULOC,"21*^.01","PSUWD","I")
"RTN","PSUPR2",240,0)
 D MOVEMI^PSUTL("PSUWD")
"RTN","PSUPR2",241,0)
 ; loop ward pointers
"RTN","PSUPR2",242,0)
 S PSUWDDA=0
"RTN","PSUPR2",243,0)
 F  S PSUWDDA=$O(PSUWD(PSUWDDA)) Q:PSUWDDA'>0  D  Q:$L(PSUDIV)
"RTN","PSUPR2",244,0)
 . S X=$$VALI^PSUTL(42,PSUWDDA,.015)
"RTN","PSUPR2",245,0)
 . Q:'X
"RTN","PSUPR2",246,0)
 . S X=$$VALI^PSUTL(40.8,X,1)
"RTN","PSUPR2",247,0)
 . I $L(X) S PSUDIV=X
"RTN","PSUPR2",248,0)
 ; return value of PSUDIV "" or = facility number
"RTN","PSUPR2",249,0)
 Q PSUDIV
"RTN","PSUPR2",250,0)
 ;
"RTN","PSUPR2",251,0)
INP() ;EP  Process for Inpatient
"RTN","PSUPR2",252,0)
 ; within package call to AR/WS that pulls/builds Inpatient AOU Site
"RTN","PSUPR2",253,0)
 ; uses IEN Value to AOU STATs file 58.5
"RTN","PSUPR2",254,0)
 N PSUARSUB,PSUARJOB
"RTN","PSUPR2",255,0)
 S PSULOCA=$$VALI^PSUTL(58.8,PSULOC,2)
"RTN","PSUPR2",256,0)
 N PSULOC
"RTN","PSUPR2",257,0)
 S PSUARSUB=PSUPRSUB,PSUARJOB=PSUPRJOB
"RTN","PSUPR2",258,0)
 S X=$$DIV^PSUAR1(PSULOCA,PSUDT) ;returns "NULL" if none found
"RTN","PSUPR2",259,0)
 S:X="NULL" X=""
"RTN","PSUPR2",260,0)
 Q X
"RTN","PSUPR2",261,0)
 ;
"RTN","PSUPR2",262,0)
IV() ;EP  Process,PSUIVDA for IV
"RTN","PSUPR2",263,0)
 ; PSULOC IEN  pharmacy location in file 58.8 (DRUG ACCOUNTABILITY)
"RTN","PSUPR2",264,0)
 N PSUIV,PSUDIV
"RTN","PSUPR2",265,0)
 S PSUDIV=""
"RTN","PSUPR2",266,0)
 D GETM^PSUTL(58.8,PSULOC,"31*^.01","PSUIV","I")
"RTN","PSUPR2",267,0)
 D MOVEMI^PSUTL("PSUIV")
"RTN","PSUPR2",268,0)
 S PSUIVDA=0
"RTN","PSUPR2",269,0)
 F  S PSUIVDA=$O(PSUIV(PSUIVDA)) Q:PSUIVDA'>0  D  Q:$L(PSUDIV)
"RTN","PSUPR2",270,0)
 . S X=$$VALI^PSUTL(59.5,PSUIVDA,.02)
"RTN","PSUPR2",271,0)
 . I X S X=$$VALI^PSUTL(40.8,X,1)
"RTN","PSUPR2",272,0)
 . I $L(X) S PSUDIV=X
"RTN","PSUPR2",273,0)
 ;
"RTN","PSUPR2",274,0)
 Q PSUDIV
"RTN","PSUPR2",275,0)
 ;
"RTN","PSUPR2",276,0)
OUT() ;EP  Process for Outpatient
"RTN","PSUPR2",277,0)
 S X=$$VALI^PSUTL(58.8,PSULOC,20)
"RTN","PSUPR2",278,0)
 I X S X=$$VALI^PSUTL(59,X,.06)
"RTN","PSUPR2",279,0)
 Q X
"RTN","PSUPR2",280,0)
 ;
"RTN","PSUPR3")
0^80^B12518601
"RTN","PSUPR3",1,0)
PSUPR3 ;BIR/PDW - EXTRACTION FROM FILE 58.81 ;12 AUG 1999
"RTN","PSUPR3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR3",3,0)
 ;DBIAs
"RTN","PSUPR3",4,0)
 ; Reference to file #58.81 supported by DBIA 2520
"RTN","PSUPR3",5,0)
 ; Reference to file #50    supported by DBIA 221
"RTN","PSUPR3",6,0)
 ; Reference to file #51.5  supported by DBIA 1931
"RTN","PSUPR3",7,0)
 ; Reference to file #58.8  supported by DBIA 2519
"RTN","PSUPR3",8,0)
 ; Reference to file #59    supported by DBIA 2510
"RTN","PSUPR3",9,0)
 ; Reference to file #42    supported by DBIA 2440
"RTN","PSUPR3",10,0)
 ; Reference to file #40.8  supported by DBIA 2438
"RTN","PSUPR3",11,0)
 ; Reference to file #59.5  supported by DBIA 2499
"RTN","PSUPR3",12,0)
 ;
"RTN","PSUPR3",13,0)
EN ;EP from PSUPR0
"RTN","PSUPR3",14,0)
 S PSUEDT=PSUEDT\1+.24
"RTN","PSUPR3",15,0)
 ;   setup ^XTMP node
"RTN","PSUPR3",16,0)
 S:'$D(PSUPRJOB) PSUPRJOB=$J
"RTN","PSUPR3",17,0)
 S:'$D(PSUPRSUB) PSUPRSUB="PSUPR_"_PSUPRJOB
"RTN","PSUPR3",18,0)
 I '$D(^XTMP(PSUPRSUB)) D
"RTN","PSUPR3",19,0)
 . S ^XTMP(PSUPRSUB,0)=""
"RTN","PSUPR3",20,0)
 . S X1=DT,X2=6 D C^%DTC
"RTN","PSUPR3",21,0)
 . S ^XTMP(PSUPRSUB,0)=X_"^"_DT_"^"_" PBMS Procurement Extraction3"
"RTN","PSUPR3",22,0)
SCANDT ;   3.2.6.31  scan Transaction date time
"RTN","PSUPR3",23,0)
 S PSUDT=PSUSDT
"RTN","PSUPR3",24,0)
 ;  going after ^PSD(58.81,"AF",PSUDT,PSULOC,PSUTYP,PSUTRDA)
"RTN","PSUPR3",25,0)
 ;
"RTN","PSUPR3",26,0)
 F  S PSUDT=$O(^PSD(58.81,"AF",PSUDT)) Q:PSUDT'>0  Q:PSUDT>PSUEDT  D LOC
"RTN","PSUPR3",27,0)
 Q
"RTN","PSUPR3",28,0)
 ;
"RTN","PSUPR3",29,0)
LOC ;EP scan thru locations
"RTN","PSUPR3",30,0)
 ;
"RTN","PSUPR3",31,0)
 S PSULOC="" F  S PSULOC=$O(^PSD(58.81,"AF",PSUDT,PSULOC)) Q:PSULOC=""  D TYPE
"RTN","PSUPR3",32,0)
 Q
"RTN","PSUPR3",33,0)
 ;
"RTN","PSUPR3",34,0)
TYPE ;EP Scan Thru Types
"RTN","PSUPR3",35,0)
 ;
"RTN","PSUPR3",36,0)
 S PSUTYP="" F  S PSUTYP=$O(^PSD(58.81,"AF",PSUDT,PSULOC,PSUTYP)) Q:PSUTYP=""  D TRAN
"RTN","PSUPR3",37,0)
 Q
"RTN","PSUPR3",38,0)
 ;
"RTN","PSUPR3",39,0)
TRAN ;EP Scan Thru Transactions
"RTN","PSUPR3",40,0)
 ;
"RTN","PSUPR3",41,0)
 S PSUTRDA=0 F  S PSUTRDA=$O(^PSD(58.81,"AF",PSUDT,PSULOC,PSUTYP,PSUTRDA)) Q:PSUTRDA'>0  D TRANDA
"RTN","PSUPR3",42,0)
 Q
"RTN","PSUPR3",43,0)
 ;
"RTN","PSUPR3",44,0)
TRANDA ;EP work a transaction
"RTN","PSUPR3",45,0)
 ;
"RTN","PSUPR3",46,0)
 N PSUTR
"RTN","PSUPR3",47,0)
 D GETS^PSUTL(58.81,PSUTRDA,".01;1;2;3;4;5;8;12;71;106;107","PSUTR","I")
"RTN","PSUPR3",48,0)
 D MOVEI^PSUTL("PSUTR")
"RTN","PSUPR3",49,0)
 S PSUDTDA=PSUTR(3)
"RTN","PSUPR3",50,0)
 ; 3.2.6.3.2-3.4
"RTN","PSUPR3",51,0)
 Q:(PSUTR(1)'=1)
"RTN","PSUPR3",52,0)
 I '$D(PSUFLSFG) D
"RTN","PSUPR3",53,0)
 .I $L(PSUTR(8)),'$L($G(PSUTR(71))) Q
"RTN","PSUPR3",54,0)
 I $D(PSUFLSFG) D
"RTN","PSUPR3",55,0)
 .I PSUTR(107)'="" Q
"RTN","PSUPR3",56,0)
 Q:$L(PSUTR(106))
"RTN","PSUPR3",57,0)
 ;
"RTN","PSUPR3",58,0)
 ;     setup file 50 fields
"RTN","PSUPR3",59,0)
 S PSUDRDA=PSUTR(4)
"RTN","PSUPR3",60,0)
 N PSUDRUG
"RTN","PSUPR3",61,0)
 D GETS^PSUTL(50,PSUDRDA,".01;2;12;13;14.5;15;20;21;22;25;31","PSUDRUG","I")
"RTN","PSUPR3",62,0)
 D MOVEI^PSUTL("PSUDRUG")
"RTN","PSUPR3",63,0)
 ;
"RTN","PSUPR3",64,0)
 ;    further process file 50 fields
"RTN","PSUPR3",65,0)
 S:'$L(PSUDRUG(.01)) PSUDRUG(.01)="Unknown Generic Name" ;    Generic Name
"RTN","PSUPR3",66,0)
 S:'$L(PSUDRUG(21)) PSUDRUG(21)="Unknown VA Product Name" ;   VA Product Name
"RTN","PSUPR3",67,0)
 S:'$L(PSUDRUG(31)) PSUDRUG(31)="No NDC" ;                   NDC
"RTN","PSUPR3",68,0)
 S PSUDRUG(12)=$$VALI^PSUTL(51.5,PSUDRUG(12),.01) ;            Order Unit
"RTN","PSUPR3",69,0)
 ;
"RTN","PSUPR3",70,0)
 ;    setup division  3.2.3.6.3.5
"RTN","PSUPR3",71,0)
 N PSULOC
"RTN","PSUPR3",72,0)
 S PSULOC=PSUTR(2)
"RTN","PSUPR3",73,0)
 ;   Get division from file 58.8, file  59.7 fileds 90.02,90.03
"RTN","PSUPR3",74,0)
 S PSUDIV="",PSUDIVI="H"
"RTN","PSUPR3",75,0)
 S PSUINV="",PSUINV(4)=PSULOC
"RTN","PSUPR3",76,0)
 D DIV^PSUPR2
"RTN","PSUPR3",77,0)
CONT ;
"RTN","PSUPR3",78,0)
 I $L(PSUDIV) S PSUDIVI=""
"RTN","PSUPR3",79,0)
 E  S PSUDIV=PSUSNDR
"RTN","PSUPR3",80,0)
 ;
"RTN","PSUPR3",81,0)
 ;    Assemble Record
"RTN","PSUPR3",82,0)
 S PSUREC=$$RECORD()
"RTN","PSUPR3",83,0)
 ;    Store Record
"RTN","PSUPR3",84,0)
 S PSULC=+$O(^XTMP(PSUPRSUB,"RECORDS",PSUDIV,""),-1)
"RTN","PSUPR3",85,0)
 S PSULC=PSULC+1
"RTN","PSUPR3",86,0)
 S ^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSULC)=PSUREC
"RTN","PSUPR3",87,0)
 Q
"RTN","PSUPR3",88,0)
 ;
"RTN","PSUPR3",89,0)
 ;    assemble record
"RTN","PSUPR3",90,0)
RECORD() ;EP Assemble record for storage
"RTN","PSUPR3",91,0)
 ; 3.2.11.38
"RTN","PSUPR3",92,0)
 N PSUR
"RTN","PSUPR3",93,0)
 S PSUR(2)=PSUDIV
"RTN","PSUPR3",94,0)
 S PSUR(3)=PSUDIVI
"RTN","PSUPR3",95,0)
 S PSUR(4)=PSUDTDA\1
"RTN","PSUPR3",96,0)
 S PSUR(5)=PSUDRUG(21)
"RTN","PSUPR3",97,0)
 S PSUR(6)=PSUDRUG(2)
"RTN","PSUPR3",98,0)
 S PSUR(7)=PSUDRUG(.01)
"RTN","PSUPR3",99,0)
 S PSUR(9)=PSUDRUG(31)
"RTN","PSUPR3",100,0)
 S PSUR(12)=PSUDRUG(14.5)
"RTN","PSUPR3",101,0)
 S PSUR(13)=$$VAL^PSUTL(50,PSUDRDA,12)
"RTN","PSUPR3",102,0)
 S PSUR(16)=PSUDRUG(15)
"RTN","PSUPR3",103,0)
 S PSUR(17)=PSUTR(5)
"RTN","PSUPR3",104,0)
 S PSUR(18)=PSUDRUG(13)
"RTN","PSUPR3",105,0)
 I PSUDRUG(15) S PSUR(360)=PSUDRUG(13)*(PSUTR(5)/PSUDRUG(15))
"RTN","PSUPR3",106,0)
 E  S PSUR(360)=""
"RTN","PSUPR3",107,0)
 S PSUR(19)=$J(PSUR(360),12,2)
"RTN","PSUPR3",108,0)
 K PSUR(360)
"RTN","PSUPR3",109,0)
 S PSUR(20)=PSUTR(12)
"RTN","PSUPR3",110,0)
 S PSUR(21)=PSUTR(71)
"RTN","PSUPR3",111,0)
 S PSUR(22)=""
"RTN","PSUPR3",112,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S PSUR(I)=$TR(PSUR(I),"^","'")
"RTN","PSUPR3",113,0)
 S I=0 F  S I=$O(PSUR(I)) Q:I'>0  S $P(PSUR,"^",I)=PSUR(I)
"RTN","PSUPR3",114,0)
 S PSUR=PSUR_"^"
"RTN","PSUPR3",115,0)
 Q PSUR
"RTN","PSUPR4")
0^81^B9638068
"RTN","PSUPR4",1,0)
PSUPR4 ;BIR/PDW - PBMS PROCUREMENT EMAIL GENERATOR ;10 JUL 1999
"RTN","PSUPR4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR4",3,0)
 ;DBIA(s)
"RTN","PSUPR4",4,0)
 ; Reference to file  #4.3 supported by DBIA 2496
"RTN","PSUPR4",5,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUPR4",6,0)
 ;PSULC  = Line processing in ^tmp
"RTN","PSUPR4",7,0)
 ;PSUTLC = Total Line count
"RTN","PSUPR4",8,0)
 ;PSUMC  = Message counter
"RTN","PSUPR4",9,0)
 ;PSUMLC = Message Line Counter
"RTN","PSUPR4",10,0)
 ; RETURNS 
"RTN","PSUPR4",11,0)
 ;PSUMSG("M") = # Messages
"RTN","PSUPR4",12,0)
 ;PSUMSG("L") = # Lines
"RTN","PSUPR4",13,0)
 ;
"RTN","PSUPR4",14,0)
EN(PSUMSG) ;Scan and process for Division(s)
"RTN","PSUPR4",15,0)
 ; PSUMSGT ("M")= # MESSAGES  ("L")= # LINES
"RTN","PSUPR4",16,0)
 ;
"RTN","PSUPR4",17,0)
 I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D
"RTN","PSUPR4",18,0)
 .NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUPR4",19,0)
 .; Scan TMP, split lines, transmit per MAX lines in Netmail
"RTN","PSUPR4",20,0)
 .S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUPR4",21,0)
 .S:PSUMAX'>0 PSUMAX=10000
"RTN","PSUPR4",22,0)
 .;
"RTN","PSUPR4",23,0)
 .I '$D(^XTMP(PSUPRSUB,"RECORDS")) D NODATA Q
"RTN","PSUPR4",24,0)
DIV .;   Scan by division and send divisional messages
"RTN","PSUPR4",25,0)
 .;
"RTN","PSUPR4",26,0)
 .S PSUDIV="" F  S PSUDIV=$O(^XTMP(PSUPRSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D MSG
"RTN","PSUPR4",27,0)
 Q
"RTN","PSUPR4",28,0)
 ;
"RTN","PSUPR4",29,0)
MSG ;EP Send divisional message
"RTN","PSUPR4",30,0)
 ;   Split and store into ^XTMP(PSUPRSUB,"MESSAGE",PSUMC,PSULC)
"RTN","PSUPR4",31,0)
 K ^XTMP(PSUPRSUB,"MESSAGE")
"RTN","PSUPR4",32,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUPR4",33,0)
 F PSULC=1:1 S X=$G(^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSUPR4",34,0)
 . I $D(^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSULC,1)) S X=X_^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSULC,1)
"RTN","PSUPR4",35,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUPR4",36,0)
 . I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC+1 Q  ; +  message
"RTN","PSUPR4",37,0)
 . I $L(X)<235 S ^XTMP(PSUPRSUB,"MESSAGE",PSUMC,PSUMLC)=X Q
"RTN","PSUPR4",38,0)
 . F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUPR4",39,0)
 . S Z=$E(X,1,I),X=$E(X,I+1,999)
"RTN","PSUPR4",40,0)
 . S ^XTMP(PSUPRSUB,"MESSAGE",PSUMC,PSUMLC)=Z
"RTN","PSUPR4",41,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUPR4",42,0)
 . F  Q:X=""  D
"RTN","PSUPR4",43,0)
 .. F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUPR4",44,0)
 .. S Z=$E(X,1,I),X=$E(X,I+1,999)
"RTN","PSUPR4",45,0)
 .. S ^XTMP(PSUPRSUB,"MESSAGE",PSUMC,PSUMLC)="*"_Z
"RTN","PSUPR4",46,0)
 .. S PSUMLC=PSUMLC+1
"RTN","PSUPR4",47,0)
 ;
"RTN","PSUPR4",48,0)
 ;   Count Lines sent
"RTN","PSUPR4",49,0)
 S PSUTLC=0
"RTN","PSUPR4",50,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSUPRSUB,"MESSAGE",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUPR4",51,0)
 ;
"RTN","PSUPR4",52,0)
 S PSUMSG(PSUDIV,5,"M")=$G(PSUMSG(PSUDIV,5,"M"))+PSUMC
"RTN","PSUPR4",53,0)
 S PSUMSG(PSUDIV,5,"L")=$G(PSUMSG(PSUDIV,5,"L"))+PSUTLC
"RTN","PSUPR4",54,0)
 ;   Transmit Messages
"RTN","PSUPR4",55,0)
VARS ; Setup variables for contents
"RTN","PSUPR4",56,0)
 ;
"RTN","PSUPR4",57,0)
 ;    Loop through messages generated and transmit them
"RTN","PSUPR4",58,0)
 F PSUM=1:1:PSUMC D
"RTN","PSUPR4",59,0)
 . S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUPR4",60,0)
 . S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUPR4",61,0)
 . S XMSUB="V. 4.0 PBMPR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUPR4",62,0)
 . S XMTEXT="^XTMP(PSUPRSUB,""MESSAGE"",PSUM,"
"RTN","PSUPR4",63,0)
 . S XMDUZ=DUZ
"RTN","PSUPR4",64,0)
 . M XMY=PSUXMYH
"RTN","PSUPR4",65,0)
 . S XMCHAN=1
"RTN","PSUPR4",66,0)
 . I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D
"RTN","PSUPR4",67,0)
 ..I '$G(PSUSMRY) D ^XMD
"RTN","PSUPR4",68,0)
 ;
"RTN","PSUPR4",69,0)
 Q
"RTN","PSUPR4",70,0)
NODATA ;EP transmit NO DATA FOUND
"RTN","PSUPR4",71,0)
 S XMDUZ=DUZ
"RTN","PSUPR4",72,0)
 M XMY=PSUXMYH
"RTN","PSUPR4",73,0)
 S PSUM=1,PSUMC=1
"RTN","PSUPR4",74,0)
 S PSUDIV=PSUSNDR
"RTN","PSUPR4",75,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUPR4",76,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUPR4",77,0)
 S XMSUB="V. 4.0 PBMPR "_$G(PSUMON)_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUPR4",78,0)
 S X(1)="No data to report"
"RTN","PSUPR4",79,0)
 S XMTEXT="X("
"RTN","PSUPR4",80,0)
 S XMCHAN=1
"RTN","PSUPR4",81,0)
 I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D ^XMD
"RTN","PSUPR4",82,0)
 S PSUMSG(PSUDIV,5,"M")=1,PSUMSG(PSUDIV,5,"L")=0
"RTN","PSUPR4",83,0)
 Q
"RTN","PSUPR5")
0^82^B27289546
"RTN","PSUPR5",1,0)
PSUPR5 ;BIR/PDW - PROCUREMENT EXTRACT SUMMARY MESSAGE GENERATOR ;10 JUL 1999
"RTN","PSUPR5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR5",3,0)
 ;DBIA(s)
"RTN","PSUPR5",4,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUPR5",5,0)
 ;
"RTN","PSUPR5",6,0)
EN ;EP generate Total & Cost summary
"RTN","PSUPR5",7,0)
 ;
"RTN","PSUPR5",8,0)
EN1 N PSUITT,PSUREC,PSUTC
"RTN","PSUPR5",9,0)
 ;PSUITT - TOTAL ITEMS
"RTN","PSUPR5",10,0)
 ;PSUTC - TOTAL COST
"RTN","PSUPR5",11,0)
 S:'$D(PSUPRJOB) PSUPRJOB=PSUJOB
"RTN","PSUPR5",12,0)
 S:'$D(PSUPRSUB) PSUPRSUB="PSUPR_"_PSUPRJOB
"RTN","PSUPR5",13,0)
 ;
"RTN","PSUPR5",14,0)
 I '$D(^XTMP(PSUPRSUB,"RECORDS")) G NODATA
"RTN","PSUPR5",15,0)
DIV ;EP Loop by Division
"RTN","PSUPR5",16,0)
 S PSUDIV="" F  S PSUDIV=$O(^XTMP(PSUPRSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D MESSAGE
"RTN","PSUPR5",17,0)
 Q
"RTN","PSUPR5",18,0)
 ;
"RTN","PSUPR5",19,0)
MESSAGE ;EP Generate Summary Messages for a Division
"RTN","PSUPR5",20,0)
 ;
"RTN","PSUPR5",21,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUPR5",22,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUPR5",23,0)
MSG1 ;  Generate 1st summary message
"RTN","PSUPR5",24,0)
 ;
"RTN","PSUPR5",25,0)
 S PSUITT=0,PSUTC=0
"RTN","PSUPR5",26,0)
 ;
"RTN","PSUPR5",27,0)
 ;   loop to get totals from records stored
"RTN","PSUPR5",28,0)
 S PSUREC=0
"RTN","PSUPR5",29,0)
 K ^TMP($J,"PSUITNM") ;
"RTN","PSUPR5",30,0)
 F  S PSUREC=$O(^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSUREC)) Q:PSUREC'>0  S X=^(PSUREC),PSUTC=PSUTC+$P(X,U,19) S PSUIT=$P(X,U,8) S:PSUIT="" PSUIT=$P(X,U,7) S:PSUIT'="" ^TMP($J,"PSUITNM",PSUIT)=""
"RTN","PSUPR5",31,0)
 ;  get number of unique items stored in PSUITNM
"RTN","PSUPR5",32,0)
 S X="" F PSUITT=0:1 S X=$O(^TMP($J,"PSUITNM",X)) Q:X=""
"RTN","PSUPR5",33,0)
 K ^TMP($J,"PSUITNM")
"RTN","PSUPR5",34,0)
 S XMDUZ=DUZ
"RTN","PSUPR5",35,0)
 M XMY=PSUXMYS1
"RTN","PSUPR5",36,0)
 ;
"RTN","PSUPR5",37,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUPR5",38,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUPR5",39,0)
 N PSUMSG
"RTN","PSUPR5",40,0)
 S PSUMSG(1)="               Procurement Statistical Summary"
"RTN","PSUPR5",41,0)
 S PSUMSG(2)="               "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUPR5",42,0)
 S PSUMSG(3)="      "
"RTN","PSUPR5",43,0)
 S PSUMSG(4)="Total of Drug/Supply Items:   "_PSUITT
"RTN","PSUPR5",44,0)
 S PSUMSG(5)="Total Cost:                 $ "_PSUTC
"RTN","PSUPR5",45,0)
 S PSUMSG(6)="     "
"RTN","PSUPR5",46,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUPR5",47,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUPR5",48,0)
 S XMSUB="V. 4.0 PBMPR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSUPR5",49,0)
 Q:PSUDIV=0   ;Eliminate empty CoreFLS messages
"RTN","PSUPR5",50,0)
 S XMTEXT="PSUMSG("
"RTN","PSUPR5",51,0)
 S XMCHAN=1
"RTN","PSUPR5",52,0)
 M ^XTMP(PSUPRSUB,"REPORT1",PSUDIV)=PSUMSG
"RTN","PSUPR5",53,0)
 D ^XMD
"RTN","PSUPR5",54,0)
 K PSUMSG
"RTN","PSUPR5",55,0)
 ;
"RTN","PSUPR5",56,0)
MSG2 ; SUMMARY BY DRUG
"RTN","PSUPR5",57,0)
 ;  loop records stored
"RTN","PSUPR5",58,0)
 ;  psunm - name, psudisp - disp unit, psutq - total quantity, psutc - total cost
"RTN","PSUPR5",59,0)
 S PSUREC=0,PSUDRNM=""
"RTN","PSUPR5",60,0)
 K ^XTMP(PSUPRSUB,"DRUG")
"RTN","PSUPR5",61,0)
 F  S PSUREC=$O(^XTMP(PSUPRSUB,"RECORDS",PSUDIV,PSUREC)) Q:PSUREC'>0  S X=^(PSUREC) D
"RTN","PSUPR5",62,0)
 . S PSUNM=$P(X,U,8),PSUTQ=$P(X,U,17),PSUTC=$P(X,U,19),PSUDISP=$P(X,U,12)
"RTN","PSUPR5",63,0)
 . S:PSUNM="" PSUNM=$P(X,U,7)
"RTN","PSUPR5",64,0)
 . S PSUNM=$E(PSUNM,1,30)
"RTN","PSUPR5",65,0)
 . I '$L(PSUNM) Q
"RTN","PSUPR5",66,0)
 . S ^XTMP(PSUPRSUB,"DRUG",PSUNM)=""
"RTN","PSUPR5",67,0)
 . S ^XTMP(PSUPRSUB,"DRUG",PSUNM,"TQ")=$G(^XTMP(PSUPRSUB,"DRUG",PSUNM,"TQ"))+PSUTQ
"RTN","PSUPR5",68,0)
 . S ^XTMP(PSUPRSUB,"DRUG",PSUNM,"TC")=$G(^XTMP(PSUPRSUB,"DRUG",PSUNM,"TC"))+PSUTC
"RTN","PSUPR5",69,0)
 . S ^XTMP(PSUPRSUB,"DRUG",PSUNM,"DISP")=PSUDISP
"RTN","PSUPR5",70,0)
 ;
"RTN","PSUPR5",71,0)
 ;
"RTN","PSUPR5",72,0)
 S PSUG="^XTMP(PSUPRSUB,""REPORT2"",PSUDIV)"
"RTN","PSUPR5",73,0)
 K @PSUG
"RTN","PSUPR5",74,0)
 S @PSUG@(1)="               Procurement Data Summary"
"RTN","PSUPR5",75,0)
 S @PSUG@(2)="               "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUPR5",76,0)
 S @PSUG@(3)=" "
"RTN","PSUPR5",77,0)
 S X="",X=$$SETSTR^VALM1("Dispense",X,53,8),X=$$SETSTR^VALM1("Total",X,63,5),X=$$SETSTR^VALM1("Total",X,73,5)
"RTN","PSUPR5",78,0)
 S @PSUG@(4)=X
"RTN","PSUPR5",79,0)
 S X="Drug/Supply Name",X=$$SETSTR^VALM1("Unit",X,53,4),X=$$SETSTR^VALM1("Qty",X,63,3),X=$$SETSTR^VALM1("Cost",X,73,4)
"RTN","PSUPR5",80,0)
 S @PSUG@(5)=X
"RTN","PSUPR5",81,0)
 S X="",$P(X,"-",79)=""
"RTN","PSUPR5",82,0)
 S @PSUG@(6)=X
"RTN","PSUPR5",83,0)
 S PSULC=6
"RTN","PSUPR5",84,0)
 N PSUNM,PSUDISP,PSUTQ,PSUTC,PSUTQT,PSUTCT
"RTN","PSUPR5",85,0)
 S (PSUTQT,PSUDISP,PSUTQ,PSUTC,PSUTCT)=0
"RTN","PSUPR5",86,0)
 ;    loop drug names
"RTN","PSUPR5",87,0)
 S PSUNM=""
"RTN","PSUPR5",88,0)
 F  S PSUNM=$O(^XTMP(PSUPRSUB,"DRUG",PSUNM)) Q:PSUNM=""  S PSUTQ=^XTMP(PSUPRSUB,"DRUG",PSUNM,"TQ"),PSUTC=^("TC"),PSUDISP=^("DISP") D
"RTN","PSUPR5",89,0)
 . S PSULC=PSULC+1
"RTN","PSUPR5",90,0)
 . S PSUTQT=$G(PSUTQT)+PSUTQ,PSUTCT=$G(PSUTCT)+PSUTC
"RTN","PSUPR5",91,0)
 . S X=$E(PSUNM,1,50)
"RTN","PSUPR5",92,0)
 . S X=$$SETSTR^VALM1(PSUDISP,X,53,$L(PSUDISP))
"RTN","PSUPR5",93,0)
 . S X=$$SETSTR^VALM1($J(PSUTQ,6,0),X,62,6)
"RTN","PSUPR5",94,0)
 . S X=$$SETSTR^VALM1($J(PSUTC,8,2),X,70,8)
"RTN","PSUPR5",95,0)
 . S @PSUG@(PSULC)=X
"RTN","PSUPR5",96,0)
 ;
"RTN","PSUPR5",97,0)
 S X="",$P(X,"-",79)=""
"RTN","PSUPR5",98,0)
 S PSULC=PSULC+1
"RTN","PSUPR5",99,0)
 S @PSUG@(PSULC)=X
"RTN","PSUPR5",100,0)
 S X="Total",X=$$SETSTR^VALM1($J(PSUTQT,6,0),X,62,6),X=$$SETSTR^VALM1($J(PSUTCT,8,2),X,70,8)
"RTN","PSUPR5",101,0)
 S PSULC=PSULC+1
"RTN","PSUPR5",102,0)
 S @PSUG@(PSULC)=X
"RTN","PSUPR5",103,0)
 S @PSUG@(PSULC+1)="    "
"RTN","PSUPR5",104,0)
 S XMSUB="V. 4.0 PBMPR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSUPR5",105,0)
 S XMTEXT="^XTMP(PSUPRSUB,""REPORT2"",PSUDIV,"
"RTN","PSUPR5",106,0)
 S XMCHAN=1
"RTN","PSUPR5",107,0)
 M XMY=PSUXMYS2
"RTN","PSUPR5",108,0)
 I '$G(PSUSMRY) D ^XMD
"RTN","PSUPR5",109,0)
 Q
"RTN","PSUPR5",110,0)
NODATA ;EP SEND NO DATA MESSAGE
"RTN","PSUPR5",111,0)
 S XMDUZ=DUZ
"RTN","PSUPR5",112,0)
 M XMY=PSUXMYS1
"RTN","PSUPR5",113,0)
 ;
"RTN","PSUPR5",114,0)
 S PSUDIV=PSUSNDR
"RTN","PSUPR5",115,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUPR5",116,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUPR5",117,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUPR5",118,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUPR5",119,0)
 S XMSUB="V. 4.0 PBMPR "_$G(PSUMON)_"  "_PSUDIV_" "_PSUDIVNM
"RTN","PSUPR5",120,0)
 S XMTEXT="^XTMP(PSUPRSUB,""REPORT2"",PSUDIV,"
"RTN","PSUPR5",121,0)
 S XMCHAN=1
"RTN","PSUPR5",122,0)
 K X
"RTN","PSUPR5",123,0)
 S X(1)="            Procurement Statistical Summary"
"RTN","PSUPR5",124,0)
 S X(2)="            "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUPR5",125,0)
 S X(3)="   "
"RTN","PSUPR5",126,0)
 S X(4)="No data to report"
"RTN","PSUPR5",127,0)
 S X(5)="   "
"RTN","PSUPR5",128,0)
 M ^XTMP(PSUPRSUB,"REPORT1",PSUDIV)=X
"RTN","PSUPR5",129,0)
 S XMTEXT="X("
"RTN","PSUPR5",130,0)
 S:$G(PSUDUZ) XMY(PSUDUZ)=""
"RTN","PSUPR5",131,0)
 D ^XMD
"RTN","PSUPR5",132,0)
 S X(1)="            Procurement Data Summary"
"RTN","PSUPR5",133,0)
 M ^XTMP(PSUPRSUB,"REPORT2",PSUDIV)=X ;store for print cycle
"RTN","PSUPR5",134,0)
 Q
"RTN","PSUPR6")
0^83^B3096100
"RTN","PSUPR6",1,0)
PSUPR6 ;BIR/PDW - PBM Procurement Printer Controller ;25 AUG 1998
"RTN","PSUPR6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUPR6",3,0)
EN ;EP for printing reports
"RTN","PSUPR6",4,0)
 N PSUQUIT
"RTN","PSUPR6",5,0)
 S PSUPG=0
"RTN","PSUPR6",6,0)
 S PSUPRJOB=PSUJOB
"RTN","PSUPR6",7,0)
 S PSUPRSUB="PSUPR_"_PSUPRJOB
"RTN","PSUPR6",8,0)
DIVISION ;EP loop by divisions
"RTN","PSUPR6",9,0)
 S PSUDIV="" F  S PSUDIV=$O(^XTMP(PSUPRSUB,"REPORT1",PSUDIV)) Q:PSUDIV=""  D REPORT
"RTN","PSUPR6",10,0)
 Q
"RTN","PSUPR6",11,0)
 ;
"RTN","PSUPR6",12,0)
REPORT ;EP Perform Prints Category & Drug for Division
"RTN","PSUPR6",13,0)
 ;
"RTN","PSUPR6",14,0)
CATRPT ;
"RTN","PSUPR6",15,0)
 ; Printing Device should be opened by PSUDBQUE by now & IO set
"RTN","PSUPR6",16,0)
 I $Y>5 U IO W @IOF
"RTN","PSUPR6",17,0)
 S L="" F  S L=$O(^XTMP(PSUPRSUB,"REPORT1",PSUDIV,L)) Q:L=""  S X=^(L) U IO W !,X I L=2 W !,?60,"PAGE: 1"
"RTN","PSUPR6",18,0)
 U IO W !!,@IOF
"RTN","PSUPR6",19,0)
 ;
"RTN","PSUPR6",20,0)
DRUGRPT ; Print Drug Summary
"RTN","PSUPR6",21,0)
 I '$D(^XTMP(PSUPRSUB,"REPORT2",PSUDIV)) Q
"RTN","PSUPR6",22,0)
 S PSUPG("PG")=1 D PGHDR
"RTN","PSUPR6",23,0)
 S L=6 F  S L=$O(^XTMP(PSUPRSUB,"REPORT2",PSUDIV,L)) Q:L=""  S X=^(L) U IO W !,X I $Y+4>IOSL D PG Q:$G(PSUQUIT)
"RTN","PSUPR6",24,0)
 W @IOF
"RTN","PSUPR6",25,0)
 Q
"RTN","PSUPR6",26,0)
PG ;EP  Page controller
"RTN","PSUPR6",27,0)
 S PSUQUIT=0
"RTN","PSUPR6",28,0)
 I $Y<(IOSL-4) Q
"RTN","PSUPR6",29,0)
 S:'$D(PSUPG("PG")) PSUPG("PG")=0 S PSUPG("PG")=PSUPG("PG")+1
"RTN","PSUPR6",30,0)
 I $E(IOST)="C" K DIR S DIR(0)="E" D ^DIR I ($G(DIROUT)!$G(DUOUT)!$G(DTOUT)!$G(DROUT)) S PSUQUIT=1
"RTN","PSUPR6",31,0)
 U IO W @IOF
"RTN","PSUPR6",32,0)
 ;
"RTN","PSUPR6",33,0)
PGHDR ; Write Page Header (SUBJECT of MAILMESSAGE)
"RTN","PSUPR6",34,0)
 I '$D(^XTMP(PSUPRSUB,"REPORT2",PSUDIV)) Q
"RTN","PSUPR6",35,0)
 F I=1,2 W !,^XTMP(PSUPRSUB,"REPORT2",PSUDIV,I)
"RTN","PSUPR6",36,0)
 W !,?60,"PAGE: ",PSUPG("PG")
"RTN","PSUPR6",37,0)
 F I=3:1:6 I $D(^XTMP(PSUPRSUB,"REPORT2",PSUDIV,I)) W !,^(I)
"RTN","PSUPR6",38,0)
 Q
"RTN","PSURT1")
0^86^B23572846
"RTN","PSURT1",1,0)
PSURT1 ;BIR/RDC - PATIENT DEMOGRAPHIC RETRANSMITION; 31 MAR 2004
"RTN","PSURT1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSURT1",3,0)
 ;
"RTN","PSURT1",4,0)
 ; THIS PROGRAM WILL ALLOW THE RETRANSMITION OF THE PATIENT
"RTN","PSURT1",5,0)
 ; DEMOGRAPHIC DATA FOR THE PBM EXTRACT USING THE DATA
"RTN","PSURT1",6,0)
 ; FROM ^PSUDEM (59.9) FOR RUN TIME OPTIMIZATION
"RTN","PSURT1",7,0)
 ;
"RTN","PSURT1",8,0)
EN ; ENTRY POINT
"RTN","PSURT1",9,0)
 NEW P,SDT,EDT,WHEN,NOGOOD,TMON,RMONTH,PMON,SMON,EMON,RTYPE,SRANGE,ERANGE
"RTN","PSURT1",10,0)
 S P=""
"RTN","PSURT1",11,0)
 D CLEANUP^PSUHL
"RTN","PSURT1",12,0)
 S SDT=$O(^PSUDEM("B",P))
"RTN","PSURT1",13,0)
 I 'SDT W !,"NO DATA AVAILABLE - NOTIFY YOUR SUPERVISOR" Q
"RTN","PSURT1",14,0)
 S EDT=$O(^PSUDEM("B",P),-1)
"RTN","PSURT1",15,0)
 S Y=SDT X ^DD("DD") S START=Y
"RTN","PSURT1",16,0)
 S Y=EDT-1 X ^DD("DD") S STOP=Y
"RTN","PSURT1",17,0)
 W !,"This option will allow the retransmission of Patient Demographic and Outpatient Visit data stored in the PBM PATIENT DEMOGRAPHICS FILE. Statistical data starting from "
"RTN","PSURT1",18,0)
 W START
"RTN","PSURT1",19,0)
 W " through "
"RTN","PSURT1",20,0)
 W STOP
"RTN","PSURT1",21,0)
 W " is available for retransmission."
"RTN","PSURT1",22,0)
 W !
"RTN","PSURT1",23,0)
 ;
"RTN","PSURT1",24,0)
 ; let fileman get response
"RTN","PSURT1",25,0)
 S DIR("A")="Is this a monthly report",DIR(0)="YO"
"RTN","PSURT1",26,0)
 D ^DIR K DIR
"RTN","PSURT1",27,0)
 ;
"RTN","PSURT1",28,0)
 S NOGOOD=1
"RTN","PSURT1",29,0)
 I Y=1 S NOGOOD=0 D MONTH
"RTN","PSURT1",30,0)
 I Y=0 S NOGOOD=0 D RANGE
"RTN","PSURT1",31,0)
 Q:NOGOOD
"RTN","PSURT1",32,0)
 D PROCESS        ; *** process the extract ***
"RTN","PSURT1",33,0)
 Q
"RTN","PSURT1",34,0)
 ;
"RTN","PSURT1",35,0)
MONTH ;      *** allow only whole months to be processed ***
"RTN","PSURT1",36,0)
 W !
"RTN","PSURT1",37,0)
 S TMON=$E(DT,4,5)
"RTN","PSURT1",38,0)
 S DIR("A")="Select Month/Year",DIR(0)="F" D ^DIR
"RTN","PSURT1",39,0)
 K DIR,DIR("A")
"RTN","PSURT1",40,0)
 I $D(DIRUT) S NOGOOD=1 Q
"RTN","PSURT1",41,0)
 S %DT="MP" D ^%DT K %DT
"RTN","PSURT1",42,0)
 I Y=-1 W !!,"Invalid Month/Year.  Please Reenter a month and year." G MONTH
"RTN","PSURT1",43,0)
 S RMONTH=$$FMTE^XLFDT(Y) W " ("_RMONTH_")"
"RTN","PSURT1",44,0)
 ; S %DT(0)=SDT,%DT="MP"
"RTN","PSURT1",45,0)
 ; S X=Y
"RTN","PSURT1",46,0)
 ; D ^%DT K %DT
"RTN","PSURT1",47,0)
 I $E(Y,4,5)=TMON S Y=-1
"RTN","PSURT1",48,0)
 I Y=-1 W !!,"Data for the entire month of "_RMONTH_" is not available.  Please reenter a month/year." G MONTH
"RTN","PSURT1",49,0)
 I Y>DT W !!,"You may not select a date from the future.  Please reenter a month/year within the valid parameters." G MONTH
"RTN","PSURT1",50,0)
 ;
"RTN","PSURT1",51,0)
 S PSURMON=Y
"RTN","PSURT1",52,0)
 S SMON=$E(PSURMON,1,5)_"00"
"RTN","PSURT1",53,0)
 S EMON=$E(PSURMON,1,5)_"99"
"RTN","PSURT1",54,0)
 S RTYPE="M"
"RTN","PSURT1",55,0)
 Q
"RTN","PSURT1",56,0)
 ;
"RTN","PSURT1",57,0)
RANGE ;             *** process a range of dates from within file #59.9 ***
"RTN","PSURT1",58,0)
 S %DT(0)=SDT
"RTN","PSURT1",59,0)
 ;
"RTN","PSURT1",60,0)
BGNRNG ;
"RTN","PSURT1",61,0)
 W !
"RTN","PSURT1",62,0)
 S %DT="PAE",%DT("A")="Select start date: " D ^%DT K %DT,%DT("A")
"RTN","PSURT1",63,0)
 I X="^"!($G(DTOUT)) S NOGOOD=1 Q
"RTN","PSURT1",64,0)
 I Y=-1 W !!,"Invalid date.  Please reenter a start date." G BGNRNG
"RTN","PSURT1",65,0)
 I Y=DT W !!,"Today is not a valid start date.  Please reenter a start date." G BGNRNG
"RTN","PSURT1",66,0)
 ;
"RTN","PSURT1",67,0)
 I Y>DT W !!,"You may not select a date in the future.  Please reenter a start date." G BGNRNG
"RTN","PSURT1",68,0)
 ;
"RTN","PSURT1",69,0)
 S SRANGE=Y          ;  *  start with this date  ***
"RTN","PSURT1",70,0)
 ;
"RTN","PSURT1",71,0)
ENDRNG ;
"RTN","PSURT1",72,0)
 W !
"RTN","PSURT1",73,0)
 S %DT="PAE",%DT("A")="Select stop date: " D ^%DT K %DT,%DT("A")
"RTN","PSURT1",74,0)
 I X="^"!($G(DTOUT)) S NOGOOD=1 Q
"RTN","PSURT1",75,0)
 I Y=-1 W !!,"Invalid date.  Please reenter a stop date." G ENDRNG
"RTN","PSURT1",76,0)
 I Y=DT W !!,"Statistical data has not been compiled for current date.  Please reenter a stop date." G ENDRNG
"RTN","PSURT1",77,0)
 ;
"RTN","PSURT1",78,0)
 I Y<SRANGE W !!,"You need to select a stop date greater than your start date.  Please reenter your start/stop dates." G BGNRNG
"RTN","PSURT1",79,0)
 ;
"RTN","PSURT1",80,0)
 I Y>DT W !!,"You may not select a date in the future.  Please reenter a stop date." G ENDRNG
"RTN","PSURT1",81,0)
 ;
"RTN","PSURT1",82,0)
 S ERANGE=Y                ; *  end at this date  ***
"RTN","PSURT1",83,0)
 ;
"RTN","PSURT1",84,0)
 S RTYPE="R"
"RTN","PSURT1",85,0)
 K %DT(0)
"RTN","PSURT1",86,0)
 ;
"RTN","PSURT1",87,0)
 Q
"RTN","PSURT1",88,0)
PROCESS ;
"RTN","PSURT1",89,0)
 I RTYPE="R" S (START,PSUSRNG)=SRANGE,(LAST,PSUERNG)=ERANGE
"RTN","PSURT1",90,0)
 I RTYPE="M" S START=SMON,LAST=EMON
"RTN","PSURT1",91,0)
 ;
"RTN","PSURT1",92,0)
 S PSUSMRY=0
"RTN","PSURT1",93,0)
 W !!
"RTN","PSURT1",94,0)
 S DIR("A")="Do you want a copy of this report sent to you in a MailMan message?"
"RTN","PSURT1",95,0)
 S DIR(0)="YO"
"RTN","PSURT1",96,0)
 S DIR("B")="NO"
"RTN","PSURT1",97,0)
 D ^DIR K DIR,DIR(0)
"RTN","PSURT1",98,0)
 I Y="^" Q
"RTN","PSURT1",99,0)
 I Y=1 S PSUMME=1,PSUDUZ=DUZ
"RTN","PSURT1",100,0)
 ;
"RTN","PSURT1",101,0)
 I RTYPE="M" D
"RTN","PSURT1",102,0)
 . W !!
"RTN","PSURT1",103,0)
 . S DIR("A")="Send this to the PBM section for addition to the master file?"
"RTN","PSURT1",104,0)
 . S DIR(0)="YO"
"RTN","PSURT1",105,0)
 . S DIR("B")="NO"
"RTN","PSURT1",106,0)
 . D ^DIR K DIR,DIR(0)
"RTN","PSURT1",107,0)
 . I Y=1 S PSUMSTR=1
"RTN","PSURT1",108,0)
 ;
"RTN","PSURT1",109,0)
 I Y="^" Q
"RTN","PSURT1",110,0)
 S PSUSTART=START,PSULAST=LAST
"RTN","PSURT1",111,0)
 K %DT,PSUWHEN
"RTN","PSURT1",112,0)
 D NOW^%DTC S %DT="REAX",%DT(0)="A",%DT("B")="NOW",%DT("A")="Queue to run at what time: " D ^%DT
"RTN","PSURT1",113,0)
 S PSUWHEN=Y
"RTN","PSURT1",114,0)
 S ZTRTN="EN^PSURT2",ZTIO="",ZTDESC="RETRASMISSION OF PT DEMOGRAPHICS",ZTDTH=PSUWHEN
"RTN","PSURT1",115,0)
 S ZTSAVE("PSUSTART")=""
"RTN","PSURT1",116,0)
 S ZTSAVE("PSULAST")=""
"RTN","PSURT1",117,0)
 S ZTSAVE("PSUMME")=""
"RTN","PSURT1",118,0)
 S ZTSAVE("PSUMSTR")=""
"RTN","PSURT1",119,0)
 S ZTSAVE("PSURMON")=""
"RTN","PSURT1",120,0)
 S ZTSAVE("PSUSRNG")=""
"RTN","PSURT1",121,0)
 S ZTSAVE("PSUERNG")=""
"RTN","PSURT1",122,0)
 S ZTSAVE("PSUDUZ")=""
"RTN","PSURT1",123,0)
 S ZTSAVE("PSUSMRY")=""
"RTN","PSURT1",124,0)
 ;
"RTN","PSURT1",125,0)
 ; D ^PSURT2
"RTN","PSURT1",126,0)
 ; Q
"RTN","PSURT1",127,0)
 ;
"RTN","PSURT1",128,0)
 D ^%ZTLOAD
"RTN","PSURT1",129,0)
 Q
"RTN","PSURT1",130,0)
 ;
"RTN","PSURT2")
0^87^B8605956
"RTN","PSURT2",1,0)
PSURT2 ; BIR/RDC - DYNAMIC REPORT OF PATIENT DEMOGRAPHIC DATA; 12 APR 2004
"RTN","PSURT2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSURT2",3,0)
 ;
"RTN","PSURT2",4,0)
 ; THIS PROGRAM IS CALLED TO EXTRACT DATES FROM ^PSUDEM AND 
"RTN","PSURT2",5,0)
 ; CALLS ^PSUDEM1 TO EXTRACT PMB PATIENT DEMOGRAPHIC DATA
"RTN","PSURT2",6,0)
 ;
"RTN","PSURT2",7,0)
EN ;
"RTN","PSURT2",8,0)
 D INITZ
"RTN","PSURT2",9,0)
 D LODXTMP
"RTN","PSURT2",10,0)
 D MAILIT
"RTN","PSURT2",11,0)
 K ^XTMP("PSU"_PSUJOB,"REXMT")
"RTN","PSURT2",12,0)
 Q
"RTN","PSURT2",13,0)
 ;
"RTN","PSURT2",14,0)
INITZ ;
"RTN","PSURT2",15,0)
 S START=PSUSTART,LAST=PSULAST
"RTN","PSURT2",16,0)
 I $D(PSURMON) S PSURMON=$E(PSURMON,1,5)
"RTN","PSURT2",17,0)
 I '$D(PSURMON) S PSURMON=PSUSRNG_" through "_PSUERNG
"RTN","PSURT2",18,0)
 S PSUJOB=$J_"_"_$P($H,",",2)
"RTN","PSURT2",19,0)
 S PSUMASF=$G(PSUMASF)
"RTN","PSURT2",20,0)
 S PSUDUZ=$G(PSUDUZ)
"RTN","PSURT2",21,0)
 S PSUPBMG=$G(PSUPBMG)
"RTN","PSURT2",22,0)
 N PSURXMT
"RTN","PSURT2",23,0)
 S PSURXMT=1
"RTN","PSURT2",24,0)
 ;
"RTN","PSURT2",25,0)
 S X=$$VALI^PSUTL(4.3,1,217)
"RTN","PSURT2",26,0)
 S PSUSNDR=+$$VAL^PSUTL(4,X,99)
"RTN","PSURT2",27,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC  ; ** set facility
"RTN","PSURT2",28,0)
 S X=+Y S PSUVDIV=$$VAL^PSUTL(40.8,X,.01)        ; ** set division
"RTN","PSURT2",29,0)
 ;
"RTN","PSURT2",30,0)
 Q
"RTN","PSURT2",31,0)
 ;
"RTN","PSURT2",32,0)
LODXTMP ;
"RTN","PSURT2",33,0)
 ;
"RTN","PSURT2",34,0)
 S START=START-1
"RTN","PSURT2",35,0)
 F  S START=$O(^PSUDEM("B",START)) Q:START>LAST!(START="")  D
"RTN","PSURT2",36,0)
 . S I=""
"RTN","PSURT2",37,0)
 . S I=$O(^PSUDEM("B",START,I))
"RTN","PSURT2",38,0)
 . S DFN=$P(^PSUDEM(I,0),U,2)
"RTN","PSURT2",39,0)
 . S ^XTMP("PSU"_PSUJOB,"REXMT",DFN)=""
"RTN","PSURT2",40,0)
 ;
"RTN","PSURT2",41,0)
 ; ** ^XTMP SHOULD NOW HOLD ONE NODE PER PATIENT FOR THIS TIME FRAME **
"RTN","PSURT2",42,0)
 Q
"RTN","PSURT2",43,0)
 ;
"RTN","PSURT2",44,0)
MAILIT ;
"RTN","PSURT2",45,0)
 S ^XTMP("PSU_"_PSUJOB,"REXMIT")="YES"
"RTN","PSURT2",46,0)
 S XMCHAN=1
"RTN","PSURT2",47,0)
 S XMDUZ=DUZ
"RTN","PSURT2",48,0)
 I $G(PSUMSTR) S PSUXMYH("G.PSU PBM@CMOP-NAT.MED.VA.GOV")=""
"RTN","PSURT2",49,0)
 I $G(PSUMME) S PSUXMYH(DUZ)="",PSUXMYH("G.PSU PBM")=""
"RTN","PSURT2",50,0)
 M XMY=PSUXMYH
"RTN","PSURT2",51,0)
 ; MAILGROUPS ARE SET INTO XMY
"RTN","PSURT2",52,0)
 S DFN=""
"RTN","PSURT2",53,0)
 F  S (DFN,PSUDMDFN)=$O(^XTMP("PSU"_PSUJOB,"REXMT",DFN)) Q:PSUDMDFN=""  D
"RTN","PSURT2",54,0)
 . D DAT^PSUDEM1
"RTN","PSURT2",55,0)
 . D DEM1^PSUDEM1
"RTN","PSURT2",56,0)
 D XMD^PSUDEM1
"RTN","PSURT2",57,0)
 D CONFIRM
"RTN","PSURT2",58,0)
 ;
"RTN","PSURT2",59,0)
 Q
"RTN","PSURT2",60,0)
CONFIRM ;
"RTN","PSURT2",61,0)
 I $G(PSUMSTR) S PSUXMYH("G.PSU PBM@CMOP-NAT.MED.VA.GOV")=""
"RTN","PSURT2",62,0)
 I $G(PSUMME) S PSUXMYH(DUZ)="",PSUXMYH("G.PSU PBM")=""
"RTN","PSURT2",63,0)
 M XMY=PSUXMYH
"RTN","PSURT2",64,0)
 F I=1:1:79 S $E(ZZ,I)="-"
"RTN","PSURT2",65,0)
 S PSUPKG="Patient Demographics"
"RTN","PSURT2",66,0)
 S PSUCONF(1)="The chart below shows the package(s) whose dispensing statistics were extracted"
"RTN","PSURT2",67,0)
 S PSUCONF(2)="by the PBM Pharmacy Statistics Retransmission option."
"RTN","PSURT2",68,0)
 S PSUCONF(3)=" "
"RTN","PSURT2",69,0)
 S PSUCONF(4)="PACKAGE"_$J("# Line items",35)_$J("# MailMan msgs",19)
"RTN","PSURT2",70,0)
 S PSUCONF(5)=ZZ
"RTN","PSURT2",71,0)
 K ^XTMP(PSUSUB,"XMD")
"RTN","PSURT2",72,0)
 M ^XTMP(PSUSUB,"XMD")=PSUCONF
"RTN","PSURT2",73,0)
 S ^XTMP(PSUSUB,"XMD",6)=PSUPKG_$J(PSUMLC,37-$L(PSUPKG))_$J(PSUM,12)
"RTN","PSURT2",74,0)
 S XMSUB="V. 4.0 PBMRXMT "_PSURMON_" "_PSUSIT_" "_PSUDIVNM
"RTN","PSURT2",75,0)
 S XMDUZ=DUZ
"RTN","PSURT2",76,0)
 S XMCHAN=1
"RTN","PSURT2",77,0)
 S XMTEXT="^XTMP(PSUSUB,""XMD"","
"RTN","PSURT2",78,0)
 D ^XMD
"RTN","PSURT2",79,0)
 ;
"RTN","PSURT2",80,0)
 Q
"RTN","PSURTQ")
0^88^B394637
"RTN","PSURTQ",1,0)
PSURTQ ;BIR/RDC - PATIENT DEMOGRAPHIC QUEUE RETRANSMITION; 12 APR 2004
"RTN","PSURTQ",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSURTQ",3,0)
 ;
"RTN","PSURTQ",4,0)
EN ; ENTRY POINT TO QUEUE RETRANSMITION OF PATIENT
"RTN","PSURTQ",5,0)
 ; DEMOGRAPHICS FOR PBM EXTRACT
"RTN","PSURTQ",6,0)
 ;
"RTN","PSURTQ",7,0)
 S ZTDTH=PSUWHEN
"RTN","PSURTQ",8,0)
 S ZTRTN="QUEUE^PSURT2"
"RTN","PSURTQ",9,0)
 S ZTDESC="RETRANSMITION OF PATIENT DEMOGRAPHICS DATA FOR PBM"
"RTN","PSURTQ",10,0)
 S ZTIO=""
"RTN","PSURTQ",11,0)
 S ZTSAVE("PSUSTART")=""
"RTN","PSURTQ",12,0)
 S ZTSAVE("PSULAST")=""
"RTN","PSURTQ",13,0)
 S ZTSAVE("PSUMME")=""
"RTN","PSURTQ",14,0)
 S ZTSAVE("PSUMMSTR")=""
"RTN","PSURTQ",15,0)
 D ^%ZTLOAD
"RTN","PSURTQ",16,0)
 Q
"RTN","PSURTQ",17,0)
 ;
"RTN","PSUSUM1")
0^89^B18204899
"RTN","PSUSUM1",1,0)
PSUSUM1 ;BIR/DAM - Summary Report for Provider Extract ; 20 DEC 2001
"RTN","PSUSUM1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM1",3,0)
 ;
"RTN","PSUSUM1",4,0)
 ; No DBIA's required.
"RTN","PSUSUM1",5,0)
 ;
"RTN","PSUSUM1",6,0)
EN ;EN CALLED FROM ^PSUDEM4
"RTN","PSUSUM1",7,0)
 ;
"RTN","PSUSUM1",8,0)
 D PULL^PSUCP
"RTN","PSUSUM1",9,0)
 D DATE
"RTN","PSUSUM1",10,0)
 D PRSUM^PSUDEM5     ;Mail message
"RTN","PSUSUM1",11,0)
 Q
"RTN","PSUSUM1",12,0)
 ;
"RTN","PSUSUM1",13,0)
DATE ;Convert dates to external format
"RTN","PSUSUM1",14,0)
 ;
"RTN","PSUSUM1",15,0)
 S %H=$E($H,1,5)      ;today's date
"RTN","PSUSUM1",16,0)
 D YX^%DTC
"RTN","PSUSUM1",17,0)
 N PSUD S PSUD=Y
"RTN","PSUSUM1",18,0)
 ;
"RTN","PSUSUM1",19,0)
 S Y=PSUSDT           ;Start date of extract
"RTN","PSUSUM1",20,0)
 D DD^%DT
"RTN","PSUSUM1",21,0)
 N PSUS S PSUS=Y
"RTN","PSUSUM1",22,0)
 ;
"RTN","PSUSUM1",23,0)
 S Y=PSUEDT           ;End date of extract
"RTN","PSUSUM1",24,0)
 D DD^%DT
"RTN","PSUSUM1",25,0)
 N PSUE S PSUE=Y
"RTN","PSUSUM1",26,0)
 ;
"RTN","PSUSUM1",27,0)
 D SUMM
"RTN","PSUSUM1",28,0)
 Q
"RTN","PSUSUM1",29,0)
 ;
"RTN","PSUSUM1",30,0)
SUMM ;Compose summary mail message by placing all text into a 
"RTN","PSUSUM1",31,0)
 ;temporary global, designated ^XTMP("PSU_"_PSUJOB,"PSUSUM",
"RTN","PSUSUM1",32,0)
 ;
"RTN","PSUSUM1",33,0)
 ;
"RTN","PSUSUM1",34,0)
 ;Report header
"RTN","PSUSUM1",35,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUPROV")) D  Q
"RTN","PSUSUM1",36,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUM",1)="No data to report"
"RTN","PSUSUM1",37,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",1)="Provider Summary Report                                         "_PSUD
"RTN","PSUSUM1",38,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",2)=""                          ;Blank line
"RTN","PSUSUM1",39,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",3)="                 "_PSUS_"  through  "_PSUE
"RTN","PSUSUM1",40,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",4)=""
"RTN","PSUSUM1",41,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUM",5),"-",80)=""              ;Separator Bar
"RTN","PSUSUM1",42,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUM",7),"-",80)=""
"RTN","PSUSUM1",43,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",8)=""
"RTN","PSUSUM1",44,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",9)="IEN        Provider Name (SSN)                        Missing Data"
"RTN","PSUSUM1",45,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUM",10),"-",80)=""
"RTN","PSUSUM1",46,0)
 D PROV
"RTN","PSUSUM1",47,0)
 ;
"RTN","PSUSUM1",48,0)
 Q
"RTN","PSUSUM1",49,0)
 ;
"RTN","PSUSUM1",50,0)
PROV ;Gather missing provider data for summary report
"RTN","PSUSUM1",51,0)
 ;
"RTN","PSUSUM1",52,0)
 N PSUSSN3,PSUMIS,PSUCL,PSUSS,PSUSP,PSUSUB,PSULN,PSUM
"RTN","PSUSUM1",53,0)
 S PSUM=0
"RTN","PSUSUM1",54,0)
 S PSULN=11
"RTN","PSUSUM1",55,0)
 S PSUIP=0
"RTN","PSUSUM1",56,0)
 F  S PSUIP=$O(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)) Q:PSUIP=""  Q:PSUIP["U"  D
"RTN","PSUSUM1",57,0)
 .S PSUSSN3=$E($P($G(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)),U,3),6,9)
"RTN","PSUSUM1",58,0)
 .I PSUSSN3="" S PSUSSN3="????",PSUMIS="SSN" D NAM             ;No SSN
"RTN","PSUSUM1",59,0)
 .S PSUCL=$P($G(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)),U,5)
"RTN","PSUSUM1",60,0)
 .I PSUCL="" S PSUMIS="PROVIDER CLASS" D NAM   ;No Class
"RTN","PSUSUM1",61,0)
 .S PSUSS=$P($G(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)),U,6)
"RTN","PSUSUM1",62,0)
 .I PSUSS="" S PSUMIS="SERVICE/SECTION" D NAM  ;No Ser/Sec
"RTN","PSUSUM1",63,0)
 .S PSUSP=$P($G(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)),U,7)
"RTN","PSUSUM1",64,0)
 .I PSUSP="" S PSUMIS="SPECIALTY" D NAM        ;No Spec
"RTN","PSUSUM1",65,0)
 .Q:PSUSP["Intern"    ;Omit interns from missing subspec. on report
"RTN","PSUSUM1",66,0)
 .Q:PSUSP["Resident"   ;Omit residents from missing subspc. on report
"RTN","PSUSUM1",67,0)
 .S PSUSUB=$P($G(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)),U,8)
"RTN","PSUSUM1",68,0)
 .I PSUSUB="" S PSUMIS="SUBSPECIALTY" D NAM    ;No Subsp
"RTN","PSUSUM1",69,0)
 Q
"RTN","PSUSUM1",70,0)
 ;
"RTN","PSUSUM1",71,0)
NAM ;Get Provider name and create entry line in summary report
"RTN","PSUSUM1",72,0)
 ;
"RTN","PSUSUM1",73,0)
 N PSUNAM,PSUT1,PSUT2,PSUT3,PSUT4,S1,S2,S3
"RTN","PSUSUM1",74,0)
 N PSUT5,PSUT6,PSUT7,PSUT8,PSUT9,PSUT10
"RTN","PSUSUM1",75,0)
 ;
"RTN","PSUSUM1",76,0)
 S PSUT4=" "
"RTN","PSUSUM1",77,0)
 S PSUT1=11
"RTN","PSUSUM1",78,0)
 S PSUT2=PSUT1-$L(PSUIP)
"RTN","PSUSUM1",79,0)
 F S1=1:1:(PSUT2-1) S PSUT3(S1)=" " D
"RTN","PSUSUM1",80,0)
 .S PSUT4=PSUT4_PSUT3(S1)       ;First tab position
"RTN","PSUSUM1",81,0)
 ;
"RTN","PSUSUM1",82,0)
 S PSUNAM=$P($G(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIP)),U,9)
"RTN","PSUSUM1",83,0)
 ;
"RTN","PSUSUM1",84,0)
 S PSUT5=" "
"RTN","PSUSUM1",85,0)
 S PSUT6=54
"RTN","PSUSUM1",86,0)
 S PSUT7=(PSUT6-$L(PSUNAM)-7-$L(PSUT4)-$L(PSUIP))
"RTN","PSUSUM1",87,0)
 F S2=1:1:(PSUT7-1) S PSUT8(S2)=" " D
"RTN","PSUSUM1",88,0)
 .S PSUT5=PSUT5_PSUT8(S2)        ;Second tab position
"RTN","PSUSUM1",89,0)
 ;
"RTN","PSUSUM1",90,0)
 S PSUT10=" "
"RTN","PSUSUM1",91,0)
 F S3=1:1:(PSUT6-1) S PSUT9(S3)=" " D
"RTN","PSUSUM1",92,0)
 .S PSUT10=PSUT10_PSUT9(S3)      ;Third tab position
"RTN","PSUSUM1",93,0)
 ;
"RTN","PSUSUM1",94,0)
 ;
"RTN","PSUSUM1",95,0)
 ;I '$D(^XTMP("PSU_"_PSUJOB,"PSUSUM",PSULN)) D
"RTN","PSUSUM1",96,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUM",PSULN)=PSUIP_PSUT4_PSUNAM_" ("_PSUSSN3_")"_PSUT5_PSUMIS
"RTN","PSUSUM1",97,0)
 F I=1:1:5 I $P($G(^XTMP("PSU_"_PSUJOB,"PSUSUM",PSULN-I)),U,1)[PSUNAM D
"RTN","PSUSUM1",98,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUM",PSULN)=PSUT10_PSUMIS
"RTN","PSUSUM1",99,0)
 ;
"RTN","PSUSUM1",100,0)
 I $P($G(^XTMP("PSU_"_PSUJOB,"PSUSUM",PSULN)),U,1)[PSUNAM D
"RTN","PSUSUM1",101,0)
 .S PSUM=PSUM+1       ;Set a counter for number of patients accessed
"RTN","PSUSUM1",102,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUM",6)="Total Number of Incomplete Provider Records Extracted: "_PSUM
"RTN","PSUSUM1",103,0)
 S PSULN=PSULN+1
"RTN","PSUSUM1",104,0)
 ;
"RTN","PSUSUM1",105,0)
 Q
"RTN","PSUSUM2")
0^90^B50864698
"RTN","PSUSUM2",1,0)
PSUSUM2 ;BIR/DAM - Patient Demographics Summary for OP Extract ; 20 DEC 2001
"RTN","PSUSUM2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM2",3,0)
 ;
"RTN","PSUSUM2",4,0)
 ;DBIA'S
"RTN","PSUSUM2",5,0)
 ;  Reference to File #59 supported by DBIA 1876
"RTN","PSUSUM2",6,0)
 ;
"RTN","PSUSUM2",7,0)
EN ;EN  CALLED FROM PSUOP0
"RTN","PSUSUM2",8,0)
 ;Q:$D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG"))   ;Do not run if auto extract
"RTN","PSUSUM2",9,0)
 ;
"RTN","PSUSUM2",10,0)
 D PULL^PSUCP
"RTN","PSUSUM2",11,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUSUM2",12,0)
 ;
"RTN","PSUSUM2",13,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","RX")) D  Q    ;Summary report if there is no data
"RTN","PSUSUM2",14,0)
 .I '$D(PSUMOD(1))&'$D(PSUMOD(2)) D
"RTN","PSUSUM2",15,0)
 ..D NODATA
"RTN","PSUSUM2",16,0)
 ..I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2")) K ^XTMP("PSU_"_PSUJOB,"PSUNONE")
"RTN","PSUSUM2",17,0)
 ;
"RTN","PSUSUM2",18,0)
 D DATE
"RTN","PSUSUM2",19,0)
 D DIVNUM
"RTN","PSUSUM2",20,0)
 D TOTAL
"RTN","PSUSUM2",21,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="                                                            ---------" S I=I+1
"RTN","PSUSUM2",22,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="" S I=I+1
"RTN","PSUSUM2",23,0)
 D TAB1
"RTN","PSUSUM2",24,0)
 I $D(PSUMOD(1))!$D(PSUMOD(2)) D
"RTN","PSUSUM2",25,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSURXCTA")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM2",26,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")=^XTMP("PSU_"_PSUJOB,"PSUTOTAL")
"RTN","PSUSUM2",27,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSURXUNIQUE")=M-1
"RTN","PSUSUM2",28,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSURXSSN")=^XTMP("PSU_"_PSUJOB,"PSUSSN")
"RTN","PSUSUM2",29,0)
 ;
"RTN","PSUSUM2",30,0)
 I '$D(PSUMOD(1))&'$D(PSUMOD(2)) D
"RTN","PSUSUM2",31,0)
 .D PDSUM^PSUDEM5      ;Mail message
"RTN","PSUSUM2",32,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")
"RTN","PSUSUM2",33,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUSSN")
"RTN","PSUSUM2",34,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM2",35,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM2",36,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURX")
"RTN","PSUSUM2",37,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM2",38,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")
"RTN","PSUSUM2",39,0)
 Q
"RTN","PSUSUM2",40,0)
 ;
"RTN","PSUSUM2",41,0)
DATE ;Convert date range of extract to external format
"RTN","PSUSUM2",42,0)
 ;
"RTN","PSUSUM2",43,0)
 S %H=$E($H,1,5)    ;today's date
"RTN","PSUSUM2",44,0)
 D YX^%DTC
"RTN","PSUSUM2",45,0)
 N PSUD S PSUD=Y
"RTN","PSUSUM2",46,0)
 ;
"RTN","PSUSUM2",47,0)
 S Y=PSUSDT         ;Start date of extract
"RTN","PSUSUM2",48,0)
 D DD^%DT
"RTN","PSUSUM2",49,0)
 N PSUS S PSUS=Y
"RTN","PSUSUM2",50,0)
 ;
"RTN","PSUSUM2",51,0)
 S Y=PSUEDT         ;End date of extract
"RTN","PSUSUM2",52,0)
 D DD^%DT
"RTN","PSUSUM2",53,0)
 N PSUE S PSUE=Y
"RTN","PSUSUM2",54,0)
 ;
"RTN","PSUSUM2",55,0)
 D RXSUM
"RTN","PSUSUM2",56,0)
 Q
"RTN","PSUSUM2",57,0)
 ;
"RTN","PSUSUM2",58,0)
RXSUM ;Summary report to be run if Rx (Outpatient) extract is  run
"RTN","PSUSUM2",59,0)
 ;
"RTN","PSUSUM2",60,0)
 D UNIQUE
"RTN","PSUSUM2",61,0)
 ;Report header
"RTN","PSUSUM2",62,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY OUTPATIENT UNIQUE PATIENTS REPORT                     "_PSUD
"RTN","PSUSUM2",63,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",2),"-",80)=""                ;Separator bar
"RTN","PSUSUM2",64,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="                 "_PSUS_"  through  "_PSUE
"RTN","PSUSUM2",65,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",4),"=",80)=""
"RTN","PSUSUM2",66,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",5)="                                                             UNIQUE"
"RTN","PSUSUM2",67,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",6),"-",70)=""
"RTN","PSUSUM2",68,0)
 D TAB2
"RTN","PSUSUM2",69,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",8),"-",70)=""
"RTN","PSUSUM2",70,0)
 S I=9
"RTN","PSUSUM2",71,0)
 ;
"RTN","PSUSUM2",72,0)
 Q
"RTN","PSUSUM2",73,0)
 ;
"RTN","PSUSUM2",74,0)
TAB2 ;Tab spacing for line 7.  Set line into global
"RTN","PSUSUM2",75,0)
 ;
"RTN","PSUSUM2",76,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM2",77,0)
 ;
"RTN","PSUSUM2",78,0)
 S PSUTB3=" "
"RTN","PSUSUM2",79,0)
 S PSUTB4="TOTAL Pharmacy patients across all divisions:"
"RTN","PSUSUM2",80,0)
 S PSUTB5=(67-$L(PSUTB4))-$L($P(^XTMP("PSU_"_PSUJOB,"PSUUNIQUE"),U,1))
"RTN","PSUSUM2",81,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM2",82,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)
"RTN","PSUSUM2",83,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",7)=PSUTB4_PSUTB3_$P(^XTMP("PSU_"_PSUJOB,"PSUUNIQUE"),U,1)
"RTN","PSUSUM2",84,0)
 Q
"RTN","PSUSUM2",85,0)
 ;
"RTN","PSUSUM2",86,0)
UNIQUE ;Find UNIQUE patients across all divisions
"RTN","PSUSUM2",87,0)
 ;
"RTN","PSUSUM2",88,0)
 N PSUSIT,PSUTOTAL,PSUSOC1,PSUNIQUE,PSURX2,PSURX5
"RTN","PSUSUM2",89,0)
 M ^XTMP("PSU_"_PSUJOB,"PSURX")=^XTMP(PSUOPSUB)
"RTN","PSUSUM2",90,0)
 ;
"RTN","PSUSUM2",91,0)
 S M=0
"RTN","PSUSUM2",92,0)
 S N=1
"RTN","PSUSUM2",93,0)
 S PSUSIT=0
"RTN","PSUSUM2",94,0)
 S PSURX1=0
"RTN","PSUSUM2",95,0)
 F  S PSUSIT=$O(^XTMP("PSU_"_PSUJOB,"PSURX","RECORDS",PSUSIT)) Q:'PSUSIT  D
"RTN","PSUSUM2",96,0)
 .F  S PSURX1=$O(^XTMP("PSU_"_PSUJOB,"PSURX","RECORDS",PSUSIT,PSURX1)) Q:'PSURX1  D
"RTN","PSUSUM2",97,0)
 ..I $P($G(^XTMP("PSU_"_PSUJOB,"PSURX","RECORDS",PSUSIT,PSURX1)),U,7)?9.10E D
"RTN","PSUSUM2",98,0)
 ...;S PSUTOTAL=N
"RTN","PSUSUM2",99,0)
 ...S PSUSOC1=$P($G(^XTMP("PSU_"_PSUJOB,"PSURX","RECORDS",PSUSIT,PSURX1)),U,7)
"RTN","PSUSUM2",100,0)
 ...I $G(PSUSOC1) S ^XTMP("PSU_"_PSUJOB,"PSUSSN",PSUSOC1)=""
"RTN","PSUSUM2",101,0)
 ...S N=N+1
"RTN","PSUSUM2",102,0)
 D ELIM
"RTN","PSUSUM2",103,0)
 Q
"RTN","PSUSUM2",104,0)
 ;
"RTN","PSUSUM2",105,0)
ELIM ;Eliminate duplicate patient entries to get number of unique pts
"RTN","PSUSUM2",106,0)
 ;
"RTN","PSUSUM2",107,0)
 S PSUADM=0
"RTN","PSUSUM2",108,0)
 F  S PSUADM=$O(^XTMP("PSU_"_PSUJOB,"PSUSSN",PSUADM)) Q:'PSUADM  D
"RTN","PSUSUM2",109,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUUNIQUE"),U,1)=M
"RTN","PSUSUM2",110,0)
 .S M=M+1
"RTN","PSUSUM2",111,0)
 Q
"RTN","PSUSUM2",112,0)
 ;
"RTN","PSUSUM2",113,0)
DIVNUM ;Set number of patients per division into summary message
"RTN","PSUSUM2",114,0)
 ;
"RTN","PSUSUM2",115,0)
 ;Find patient SSN's in the following global and place with the division
"RTN","PSUSUM2",116,0)
 ;number
"RTN","PSUSUM2",117,0)
 N PSUPTID,PSUPL
"RTN","PSUSUM2",118,0)
 S PSUDNUM=0
"RTN","PSUSUM2",119,0)
 S C=1
"RTN","PSUSUM2",120,0)
 F  S PSUDNUM=$O(^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUDNUM)) Q:PSUDNUM=""  D
"RTN","PSUSUM2",121,0)
 .S PSUPL=0
"RTN","PSUSUM2",122,0)
 .F  S PSUPL=$O(^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUDNUM,PSUPL)) Q:PSUPL=""  D
"RTN","PSUSUM2",123,0)
 ..S PSUPTID=$P(^XTMP("PSU_"_PSUJOB,"PSUDIVPT",PSUDNUM,PSUPL),U,7)
"RTN","PSUSUM2",124,0)
 ..Q:PSUPTID=""
"RTN","PSUSUM2",125,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUCT0",PSUDNUM,PSUPTID)=""
"RTN","PSUSUM2",126,0)
 ;
"RTN","PSUSUM2",127,0)
 ;Get patient count for each division
"RTN","PSUSUM2",128,0)
 S PSUDNUM1=0
"RTN","PSUSUM2",129,0)
 F  S PSUDNUM1=$O(^XTMP("PSU_"_PSUJOB,"PSUCT0",PSUDNUM1)) Q:PSUDNUM1=""  D
"RTN","PSUSUM2",130,0)
 .S PSUID=0
"RTN","PSUSUM2",131,0)
 .F  S PSUID=$O(^XTMP("PSU_"_PSUJOB,"PSUCT0",PSUDNUM1,PSUID)) Q:PSUID=""  D
"RTN","PSUSUM2",132,0)
 ..I $D(^XTMP("PSU_"_PSUJOB,"PSUCT1",PSUDNUM1)) D
"RTN","PSUSUM2",133,0)
 ...S C=C+1
"RTN","PSUSUM2",134,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUCT1",PSUDNUM1)=C
"RTN","PSUSUM2",135,0)
 ..I '$D(^XTMP("PSU_"_PSUJOB,"PSUCT1",PSUDNUM1)) D
"RTN","PSUSUM2",136,0)
 ...S C=1 S ^XTMP("PSU_"_PSUJOB,"PSUCT1",PSUDNUM1)=C
"RTN","PSUSUM2",137,0)
 ;
"RTN","PSUSUM2",138,0)
 ;Get division name
"RTN","PSUSUM2",139,0)
 S PSUDIV=0
"RTN","PSUSUM2",140,0)
 N PSUNBR
"RTN","PSUSUM2",141,0)
 F  S PSUDIV=$O(^XTMP("PSU_"_PSUJOB,"PSUCT1",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUSUM2",142,0)
 .S PSUNBR=$P(^XTMP("PSU_"_PSUJOB,"PSUCT1",PSUDIV),U,1)
"RTN","PSUSUM2",143,0)
 .S X=PSUDIV,DIC=59,DIC(0)="XM" D ^DIC ;**1
"RTN","PSUSUM2",144,0)
 .S X=+Y,PSUDIVNM=$$VAL^PSUTL(59,X,.01)
"RTN","PSUSUM2",145,0)
 .I PSUDIVNM'="" S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVNM)=PSUNBR
"RTN","PSUSUM2",146,0)
 .I PSUDIVNM="" S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIV)=PSUNBR
"RTN","PSUSUM2",147,0)
 ;
"RTN","PSUSUM2",148,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM2",149,0)
 ;
"RTN","PSUSUM2",150,0)
 N PSUCT2
"RTN","PSUSUM2",151,0)
 S PSUDIVA1=0
"RTN","PSUSUM2",152,0)
 F  S PSUDIVA1=$O(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVA1)) Q:PSUDIVA1=""  D
"RTN","PSUSUM2",153,0)
 .S PSUCT2=$P(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVA1),U,1)
"RTN","PSUSUM2",154,0)
 .D TAB
"RTN","PSUSUM2",155,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSUDIVA1_" Division:"_PSUTB1_PSUCT2
"RTN","PSUSUM2",156,0)
 .S I=I+1
"RTN","PSUSUM2",157,0)
 Q
"RTN","PSUSUM2",158,0)
 ;
"RTN","PSUSUM2",159,0)
TAB ;Calculate tab spacing
"RTN","PSUSUM2",160,0)
 ;
"RTN","PSUSUM2",161,0)
 S PSUTB1=" "
"RTN","PSUSUM2",162,0)
 S PSUTB2=(62-$L(PSUCT2))-$L(PSUDIVA1)-10
"RTN","PSUSUM2",163,0)
 F S2=1:1:(PSUTB2-1) S PSUTB(S2)=" " D
"RTN","PSUSUM2",164,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)                ;Tab position
"RTN","PSUSUM2",165,0)
 Q
"RTN","PSUSUM2",166,0)
 ;
"RTN","PSUSUM2",167,0)
TOTAL ;Calculate Outpatient Total of all Divisions
"RTN","PSUSUM2",168,0)
 ;
"RTN","PSUSUM2",169,0)
 S PSUOPTOT=0
"RTN","PSUSUM2",170,0)
 S PSUTOCT1=0
"RTN","PSUSUM2",171,0)
 F  S PSUOPTOT=$O(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUOPTOT)) Q:PSUOPTOT=""  D
"RTN","PSUSUM2",172,0)
 .S PSUTOCT=$P(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUOPTOT),U,1)
"RTN","PSUSUM2",173,0)
 .S PSUTOCT1=PSUTOCT1+PSUTOCT
"RTN","PSUSUM2",174,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUTOTAL"),U,1)=PSUTOCT1
"RTN","PSUSUM2",175,0)
 Q
"RTN","PSUSUM2",176,0)
 ;
"RTN","PSUSUM2",177,0)
TAB1 ;Calculate tab spacing for 'Outpatient Total of all Divisions' line.
"RTN","PSUSUM2",178,0)
 ;and set the last lines of message  into the summary global.
"RTN","PSUSUM2",179,0)
 ;
"RTN","PSUSUM2",180,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM2",181,0)
 ;
"RTN","PSUSUM2",182,0)
 S PSUTB3=" "
"RTN","PSUSUM2",183,0)
 S PSUTB4="     Outpatient Total of all Divisions:"
"RTN","PSUSUM2",184,0)
 S PSUTB5=(67-$L(PSUTB4))-$L($P(^XTMP("PSU_"_PSUJOB,"PSUTOTAL"),U,1))
"RTN","PSUSUM2",185,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM2",186,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)                ;Tab position
"RTN","PSUSUM2",187,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1) S I=I+1
"RTN","PSUSUM2",188,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="" S I=I+1
"RTN","PSUSUM2",189,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="**PLEASE NOTE: Final TOTAL may not match sum of all SUBTOTALS. A patient may" S I=I+1
"RTN","PSUSUM2",190,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="have been provided pharmacy services at more than one outpatient and/or" S I=I+1
"RTN","PSUSUM2",191,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="inpatient division."
"RTN","PSUSUM2",192,0)
 Q
"RTN","PSUSUM2",193,0)
 ;
"RTN","PSUSUM2",194,0)
NODATA ;Summary report line to be sent if there is no data
"RTN","PSUSUM2",195,0)
 ;
"RTN","PSUSUM2",196,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY OUTPATIENT UNIQUE PATIENTS REPORT"
"RTN","PSUSUM2",197,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",2)=" "
"RTN","PSUSUM2",198,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="No data to report"
"RTN","PSUSUM2",199,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM2",200,0)
 Q
"RTN","PSUSUM3")
0^91^B53686214
"RTN","PSUSUM3",1,0)
PSUSUM3 ;BIR/DAM - Patient Demographics Summary for UD Extract ; 20 DEC 2001
"RTN","PSUSUM3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM3",3,0)
 ;
"RTN","PSUSUM3",4,0)
 ;DBIA's
"RTN","PSUSUM3",5,0)
 ; Reference to file #55 supported by DBIA 3502
"RTN","PSUSUM3",6,0)
 ; Reference to file #42 supported by DBIA 1848
"RTN","PSUSUM3",7,0)
 ; Reference to file #40.8 supported by DBIA 1576
"RTN","PSUSUM3",8,0)
 ;
"RTN","PSUSUM3",9,0)
EN ;EN CALLED FROM PSUUD0
"RTN","PSUSUM3",10,0)
 ;Q:$D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG"))   ;Do not run if auto extract
"RTN","PSUSUM3",11,0)
 ;
"RTN","PSUSUM3",12,0)
 D PULL^PSUCP
"RTN","PSUSUM3",13,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUSUM3",14,0)
 ;
"RTN","PSUSUM3",15,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","UD")) D  Q    ;report if there is no data
"RTN","PSUSUM3",16,0)
 .I $D(PSUMOD(2))&'$D(PSUMOD(1)) D
"RTN","PSUSUM3",17,0)
 ..I '$D(PSUMOD(4)) D
"RTN","PSUSUM3",18,0)
 ...D NODATA D
"RTN","PSUSUM3",19,0)
 ....I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1")) K ^XTMP("PSU_"_PSUJOB,"PSUNONE")
"RTN","PSUSUM3",20,0)
 ....K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM3",21,0)
 D EN1
"RTN","PSUSUM3",22,0)
 Q
"RTN","PSUSUM3",23,0)
 ;
"RTN","PSUSUM3",24,0)
EN1 ;Entry point to collect data
"RTN","PSUSUM3",25,0)
 D DATE
"RTN","PSUSUM3",26,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUUD")=^XTMP(PSUUDSUB)
"RTN","PSUSUM3",27,0)
 D RE
"RTN","PSUSUM3",28,0)
 D UNIQUE
"RTN","PSUSUM3",29,0)
 S I=9        ;Line counter for division data in summary report
"RTN","PSUSUM3",30,0)
 D DIVNUM
"RTN","PSUSUM3",31,0)
 D TOTAL
"RTN","PSUSUM3",32,0)
 D TAB1
"RTN","PSUSUM3",33,0)
 ;
"RTN","PSUSUM3",34,0)
 I $D(PSUMOD(1))&$D(PSUMOD(2)) D
"RTN","PSUSUM3",35,0)
 .I $D(PSUMOD(4)) D
"RTN","PSUSUM3",36,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUUDDIV")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM3",37,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUUDSSN")=^XTMP("PSU_"_PSUJOB,"PSUIPT")
"RTN","PSUSUM3",38,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUDIVUD")=^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM3",39,0)
 ;
"RTN","PSUSUM3",40,0)
 I '$D(PSUMOD(1))&$D(PSUMOD(2)) D
"RTN","PSUSUM3",41,0)
 .I $D(PSUMOD(4)) D
"RTN","PSUSUM3",42,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUUDDIV")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM3",43,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUUDSSN")=^XTMP("PSU_"_PSUJOB,"PSUIPT")
"RTN","PSUSUM3",44,0)
 ;
"RTN","PSUSUM3",45,0)
 I $D(PSUMOD(1))&$D(PSUMOD(2)) D
"RTN","PSUSUM3",46,0)
 .I '$D(PSUMOD(4)) D
"RTN","PSUSUM3",47,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUUDDIV")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM3",48,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUUDIN")=^XTMP("PSU_"_PSUJOB,"PSUIPT")
"RTN","PSUSUM3",49,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUDIVUD")=^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM3",50,0)
 ;
"RTN","PSUSUM3",51,0)
 I '$D(PSUMOD(1))&'$D(PSUMOD(4)) D
"RTN","PSUSUM3",52,0)
 .D PDSUM^PSUDEM5     ;Mail message
"RTN","PSUSUM3",53,0)
 .K ^XTMP("PSU_"_PSUJOB,"PSUUDDIV")
"RTN","PSUSUM3",54,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUUD")
"RTN","PSUSUM3",55,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM3",56,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")
"RTN","PSUSUM3",57,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")
"RTN","PSUSUM3",58,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM3",59,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXCTA")
"RTN","PSUSUM3",60,0)
 Q
"RTN","PSUSUM3",61,0)
 ;
"RTN","PSUSUM3",62,0)
RE ;Rearrange the ^XTMP("PSU_"_PSUJOB,"PSUUD","DETAIL" global so information in PATDIV
"RTN","PSUSUM3",63,0)
 ;can be accessed quickly.
"RTN","PSUSUM3",64,0)
 ;
"RTN","PSUSUM3",65,0)
 N PSUSIT
"RTN","PSUSUM3",66,0)
 S PSUSIT=PSUSNDR
"RTN","PSUSUM3",67,0)
 ;D INST^PSUDEM1 S PSUSIT=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUSUM3",68,0)
 ;
"RTN","PSUSUM3",69,0)
 N PSUSSNA,PSUUDA
"RTN","PSUSUM3",70,0)
 S PSUPN1=0,PSUSIT1=0
"RTN","PSUSUM3",71,0)
 F  S PSUSIT1=$O(^XTMP("PSU_"_PSUJOB,"PSUUD","DETAIL",PSUSIT1)) Q:PSUSIT1=""  D
"RTN","PSUSUM3",72,0)
 .F  S PSUPN1=$O(^XTMP("PSU_"_PSUJOB,"PSUUD","DETAIL",PSUSIT1,PSUPN1)) Q:PSUPN1=""  D
"RTN","PSUSUM3",73,0)
 ..S PSUUDA=$P($G(^XTMP("PSU_"_PSUJOB,"PSUUD","DETAIL",PSUSIT1,PSUPN1)),U,4)
"RTN","PSUSUM3",74,0)
 ..S PSUSSNA=$P($G(^XTMP("PSU_"_PSUJOB,"PSUUD","DETAIL",PSUSIT1,PSUPN1)),U,5) D
"RTN","PSUSUM3",75,0)
 ...S PSUDFN=0
"RTN","PSUSUM3",76,0)
 ...F  S PSUDFN=$O(^XTMP("PSU_"_PSUJOB,"PSUTDFN",PSUDFN)) Q:PSUDFN=""  D
"RTN","PSUSUM3",77,0)
 ....S PSUSN=0
"RTN","PSUSUM3",78,0)
 ....F  S PSUSN=$O(^XTMP("PSU_"_PSUJOB,"PSUTDFN",PSUDFN,PSUSN)) Q:PSUSN=""  D
"RTN","PSUSUM3",79,0)
 .....I PSUSN=PSUSSNA S ^XTMP("PSU_"_PSUJOB,"PSUORSN1",PSUDFN,PSUUDA)=PSUSN
"RTN","PSUSUM3",80,0)
 .....;S ^XTMP("PSU_"_PSUJOB,"PSUORSN",PSUUDA)=PSUSSNA
"RTN","PSUSUM3",81,0)
 Q
"RTN","PSUSUM3",82,0)
 ;
"RTN","PSUSUM3",83,0)
DATE ;Convert date range of extract to external format
"RTN","PSUSUM3",84,0)
 ;
"RTN","PSUSUM3",85,0)
 S %H=$E($H,1,5)    ;today's date
"RTN","PSUSUM3",86,0)
 D YX^%DTC
"RTN","PSUSUM3",87,0)
 N PSUD S PSUD=Y
"RTN","PSUSUM3",88,0)
 ;
"RTN","PSUSUM3",89,0)
 S Y=PSUSDT         ;Start date of extract
"RTN","PSUSUM3",90,0)
 D DD^%DT
"RTN","PSUSUM3",91,0)
 N PSUS S PSUS=Y
"RTN","PSUSUM3",92,0)
 ;
"RTN","PSUSUM3",93,0)
 S Y=PSUEDT         ;End date of extract
"RTN","PSUSUM3",94,0)
 D DD^%DT
"RTN","PSUSUM3",95,0)
 N PSUE S PSUE=Y
"RTN","PSUSUM3",96,0)
 ;
"RTN","PSUSUM3",97,0)
 D UDSUM
"RTN","PSUSUM3",98,0)
 Q
"RTN","PSUSUM3",99,0)
 ;
"RTN","PSUSUM3",100,0)
UDSUM ;Summary report header to be run if UD (Inpatient) extract is  run
"RTN","PSUSUM3",101,0)
 ;
"RTN","PSUSUM3",102,0)
 ;Report header
"RTN","PSUSUM3",103,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY INPATIENT (UD) UNIQUE PATIENTS REPORT               "_PSUD
"RTN","PSUSUM3",104,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",2),"-",80)=""                ;Separator bar
"RTN","PSUSUM3",105,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="                 "_PSUS_"  through  "_PSUE
"RTN","PSUSUM3",106,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",4),"=",80)=""
"RTN","PSUSUM3",107,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",5)="                                                           UNIQUE"
"RTN","PSUSUM3",108,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",6),"-",70)=""
"RTN","PSUSUM3",109,0)
 Q
"RTN","PSUSUM3",110,0)
 ;
"RTN","PSUSUM3",111,0)
UNIQUE ;Find number of unique patients across all divisions
"RTN","PSUSUM3",112,0)
 ;
"RTN","PSUSUM3",113,0)
 S PSUUDS=0
"RTN","PSUSUM3",114,0)
 N PSUUDS3
"RTN","PSUSUM3",115,0)
 F  S PSUUDS=$O(^XTMP("PSU_"_PSUJOB,"PSUORSN1",PSUUDS)) Q:PSUUDS=""  D
"RTN","PSUSUM3",116,0)
 .S PSUUDS1=0
"RTN","PSUSUM3",117,0)
 .S PSUUDS1=$O(^XTMP("PSU_"_PSUJOB,"PSUORSN1",PSUUDS,PSUUDS1)) Q:PSUUDS1=""  D
"RTN","PSUSUM3",118,0)
 ..S PSUUDS3=$P($G(^XTMP("PSU_"_PSUJOB,"PSUORSN1",PSUUDS,PSUUDS1)),U,1)
"RTN","PSUSUM3",119,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUIPT",PSUUDS3)=""     ;Set up global for unique SSNs
"RTN","PSUSUM3",120,0)
 .;S PSUUDS1=$P(^XTMP("PSU_"_PSUJOB,"PSUORSN",PSUUDS),U)
"RTN","PSUSUM3",121,0)
 .;S ^XTMP("PSU_"_PSUJOB,"PSUIPT",PSUUDS1)=""     ;Set up global for unique SSNs
"RTN","PSUSUM3",122,0)
 ;
"RTN","PSUSUM3",123,0)
 S B=1
"RTN","PSUSUM3",124,0)
 S PSUUDS2=0
"RTN","PSUSUM3",125,0)
 F  S PSUUDS2=$O(^XTMP("PSU_"_PSUJOB,"PSUIPT",PSUUDS2)) Q:PSUUDS2=""  D
"RTN","PSUSUM3",126,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUIPT")=B,B=B+1       ;B=total count unique patients
"RTN","PSUSUM3",127,0)
 .D TAB2
"RTN","PSUSUM3",128,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",8),"-",70)=""
"RTN","PSUSUM3",129,0)
 Q
"RTN","PSUSUM3",130,0)
 ;
"RTN","PSUSUM3",131,0)
TAB2 ;Tab spacing for line 7.  Set line into global
"RTN","PSUSUM3",132,0)
 ;
"RTN","PSUSUM3",133,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM3",134,0)
 ;
"RTN","PSUSUM3",135,0)
 S PSUTB3=" "
"RTN","PSUSUM3",136,0)
 S PSUTB4="TOTAL patients across all divisions:"
"RTN","PSUSUM3",137,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUIPT")),U,1))
"RTN","PSUSUM3",138,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM3",139,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)
"RTN","PSUSUM3",140,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",7)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUIPT")),U,1)
"RTN","PSUSUM3",141,0)
 Q
"RTN","PSUSUM3",142,0)
 ;
"RTN","PSUSUM3",143,0)
DIVNUM ;Set number of patients per division into summary message
"RTN","PSUSUM3",144,0)
 ;
"RTN","PSUSUM3",145,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM3",146,0)
 ;
"RTN","PSUSUM3",147,0)
 N PSUCT3
"RTN","PSUSUM3",148,0)
 S PSUDIVA2=0
"RTN","PSUSUM3",149,0)
 F  S PSUDIVA2=$O(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVA2)) Q:PSUDIVA2=""  D
"RTN","PSUSUM3",150,0)
 .S PSUCT3=$P($G(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVA2)),U,1)
"RTN","PSUSUM3",151,0)
 .D TAB
"RTN","PSUSUM3",152,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSUDIVA2_" Division:"_PSUTB1_PSUCT3
"RTN","PSUSUM3",153,0)
 .S I=I+1
"RTN","PSUSUM3",154,0)
 Q
"RTN","PSUSUM3",155,0)
 ;
"RTN","PSUSUM3",156,0)
TAB ;Calculate tab spacing
"RTN","PSUSUM3",157,0)
 ;
"RTN","PSUSUM3",158,0)
 S PSUTB1=" "
"RTN","PSUSUM3",159,0)
 S PSUTB2=(59-$L(PSUCT3))-$L(PSUDIVA2)-10
"RTN","PSUSUM3",160,0)
 F S2=1:1:(PSUTB2-1) S PSUTB(S2)=" " D
"RTN","PSUSUM3",161,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)                  ;Tab position
"RTN","PSUSUM3",162,0)
 Q
"RTN","PSUSUM3",163,0)
 ;
"RTN","PSUSUM3",164,0)
TOTAL ;EN   Calculate Inpatient total of all divisions
"RTN","PSUSUM3",165,0)
 ;
"RTN","PSUSUM3",166,0)
 N PSUIPCT
"RTN","PSUSUM3",167,0)
 S PSUIPTOT=0
"RTN","PSUSUM3",168,0)
 S PSUTOCT1=0
"RTN","PSUSUM3",169,0)
 F  S PSUIPTOT=$O(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUIPTOT)) Q:PSUIPTOT=""  D
"RTN","PSUSUM3",170,0)
 .S PSUIPCT=$P($G(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUIPTOT)),U,1)
"RTN","PSUSUM3",171,0)
 .S PSUTOCT1=PSUTOCT1+PSUIPCT
"RTN","PSUSUM3",172,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUTOTAL"),U,1)=PSUTOCT1
"RTN","PSUSUM3",173,0)
 Q
"RTN","PSUSUM3",174,0)
 ;
"RTN","PSUSUM3",175,0)
TAB1 ;EN  Calculate tab spacing for 'Outpatient Total of all Divisions' line.
"RTN","PSUSUM3",176,0)
 ;and set the last lines of message into the summary global.
"RTN","PSUSUM3",177,0)
 ;
"RTN","PSUSUM3",178,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM3",179,0)
 ;
"RTN","PSUSUM3",180,0)
 I '$G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")) D
"RTN","PSUSUM3",181,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=0
"RTN","PSUSUM3",182,0)
 S PSUTB3=" "
"RTN","PSUSUM3",183,0)
 S PSUTB4="     Inpatient Total of all Divisions:"
"RTN","PSUSUM3",184,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1))
"RTN","PSUSUM3",185,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM3",186,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)                ;Tab position
"RTN","PSUSUM3",187,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="                                                           ----------" S I=I+1
"RTN","PSUSUM3",188,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1) S I=I+1
"RTN","PSUSUM3",189,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="" S I=I+1
"RTN","PSUSUM3",190,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="**PLEASE NOTE: Final TOTAL may not match sum of all SUBTOTALS.  A patient may" S I=I+1
"RTN","PSUSUM3",191,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="have been provided pharmacy services at more than one outpatient and/or" S I=I+1
"RTN","PSUSUM3",192,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="inpatient division."
"RTN","PSUSUM3",193,0)
 Q
"RTN","PSUSUM3",194,0)
 ;
"RTN","PSUSUM3",195,0)
NODATA ;Summary report line to be sent if there is no data
"RTN","PSUSUM3",196,0)
 ;
"RTN","PSUSUM3",197,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY INPATIENT (UD) UNIQUE PATIENTS REPORT"
"RTN","PSUSUM3",198,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",2)=" "
"RTN","PSUSUM3",199,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="No data to report"
"RTN","PSUSUM3",200,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM3",201,0)
 Q
"RTN","PSUSUM4")
0^92^B62321362
"RTN","PSUSUM4",1,0)
PSUSUM4 ;BIR/DAM - Patient Demographics Summary for IV Extract ; 20 DEC 2001
"RTN","PSUSUM4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM4",3,0)
 ;
"RTN","PSUSUM4",4,0)
 ;DBIA's
"RTN","PSUSUM4",5,0)
 ; Reference to file #55 supported by DBIA 3502
"RTN","PSUSUM4",6,0)
 ; Reference to file #42 supported by DBIA 2440
"RTN","PSUSUM4",7,0)
 ;
"RTN","PSUSUM4",8,0)
EN ;EN CALLED FROM PSUIV0
"RTN","PSUSUM4",9,0)
 ;Q:$D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG"))   ;Do not run if auto extract
"RTN","PSUSUM4",10,0)
 ;
"RTN","PSUSUM4",11,0)
 D PULL^PSUCP
"RTN","PSUSUM4",12,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUSUM4",13,0)
 ;
"RTN","PSUSUM4",14,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM4",15,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","IV")) D  Q    ;Summary report if there is no data
"RTN","PSUSUM4",16,0)
 .I '$D(PSUMOD(2))&$D(PSUMOD(1)) D
"RTN","PSUSUM4",17,0)
 ..I '$D(PSUMOD(4)) D
"RTN","PSUSUM4",18,0)
 ...D NODATA
"RTN","PSUSUM4",19,0)
 ...I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2")) K ^XTMP("PSU_"_PSUJOB,"PSUNONE")
"RTN","PSUSUM4",20,0)
 D EN1
"RTN","PSUSUM4",21,0)
 Q
"RTN","PSUSUM4",22,0)
 ;
"RTN","PSUSUM4",23,0)
EN1 ;Entry point to collect data
"RTN","PSUSUM4",24,0)
 ;
"RTN","PSUSUM4",25,0)
 D DATE
"RTN","PSUSUM4",26,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUIV")=^XTMP(PSUIVSUB)
"RTN","PSUSUM4",27,0)
 S I=7             ;Line counter for message
"RTN","PSUSUM4",28,0)
 D UNIQUE
"RTN","PSUSUM4",29,0)
 N PSUTB2,PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM4",30,0)
 D TAB
"RTN","PSUSUM4",31,0)
 D TOTUN
"RTN","PSUSUM4",32,0)
 S I=10            ;Reset line counter for message
"RTN","PSUSUM4",33,0)
 D PATNUM
"RTN","PSUSUM4",34,0)
 D TAB1
"RTN","PSUSUM4",35,0)
 ;
"RTN","PSUSUM4",36,0)
 I $D(PSUMOD(2))&$D(PSUMOD(1)) D
"RTN","PSUSUM4",37,0)
 .I $D(PSUMOD(4)) D
"RTN","PSUSUM4",38,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVINDIV")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM4",39,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVIN")=^XTMP("PSU_"_PSUJOB,"PSUINP")
"RTN","PSUSUM4",40,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVOUT")=^XTMP("PSU_"_PSUJOB,"PSUOUTP")
"RTN","PSUSUM4",41,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVSSN")=^XTMP("PSU_"_PSUJOB,"PSUIV","PAT")
"RTN","PSUSUM4",42,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUDIV1")=^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM4",43,0)
 ;
"RTN","PSUSUM4",44,0)
 I '$D(PSUMOD(2))&$D(PSUMOD(1)) D
"RTN","PSUSUM4",45,0)
 .I $D(PSUMOD(4)) D
"RTN","PSUSUM4",46,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVINDIV")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM4",47,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVIN")=^XTMP("PSU_"_PSUJOB,"PSUINP")
"RTN","PSUSUM4",48,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVOUT")=^XTMP("PSU_"_PSUJOB,"PSUOUTP")
"RTN","PSUSUM4",49,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVSSN")=^XTMP("PSU_"_PSUJOB,"PSUIV","PAT")
"RTN","PSUSUM4",50,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIN1")=^XTMP("PSU_"_PSUJOB,"PSUIN")
"RTN","PSUSUM4",51,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUDIV1")=^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM4",52,0)
 ;
"RTN","PSUSUM4",53,0)
 I $D(PSUMOD(2))&$D(PSUMOD(1)) D
"RTN","PSUSUM4",54,0)
 .I '$D(PSUMOD(4)) D
"RTN","PSUSUM4",55,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVINDIV")=^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM4",56,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVIN")=^XTMP("PSU_"_PSUJOB,"PSUINP")
"RTN","PSUSUM4",57,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUIVOUT")=^XTMP("PSU_"_PSUJOB,"PSUOUTP")
"RTN","PSUSUM4",58,0)
 ..M ^XTMP("PSU_"_PSUJOB,"PSUDIV1")=^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM4",59,0)
 ;
"RTN","PSUSUM4",60,0)
 I '$D(PSUMOD(2))&'$D(PSUMOD(4)) D
"RTN","PSUSUM4",61,0)
 .I '$G(^XTMP("PSU_"_PSUJOB,"PSUFLAG1")) D
"RTN","PSUSUM4",62,0)
 ..D PDSUM^PSUDEM5     ;Mail message
"RTN","PSUSUM4",63,0)
 ..K ^XTMP("PSU_"_PSUJOB,"PSUIVOUT")
"RTN","PSUSUM4",64,0)
 ..K ^XTMP("PSU_"_PSUJOB,"PSUIVINDIV")
"RTN","PSUSUM4",65,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIV")
"RTN","PSUSUM4",66,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUIVSSN")
"RTN","PSUSUM4",67,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUINP")
"RTN","PSUSUM4",68,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUIN")
"RTN","PSUSUM4",69,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUOUT")
"RTN","PSUSUM4",70,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM4",71,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG"))
"RTN","PSUSUM4",72,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")
"RTN","PSUSUM4",73,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUOUTP")
"RTN","PSUSUM4",74,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUINP")
"RTN","PSUSUM4",75,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUDIV")
"RTN","PSUSUM4",76,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUCT")
"RTN","PSUSUM4",77,0)
 ;K ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")
"RTN","PSUSUM4",78,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXCTA")
"RTN","PSUSUM4",79,0)
 Q
"RTN","PSUSUM4",80,0)
 ;
"RTN","PSUSUM4",81,0)
DATE ;Convert date range of extract to external format
"RTN","PSUSUM4",82,0)
 ;
"RTN","PSUSUM4",83,0)
 S %H=$E($H,1,5)    ;today's date
"RTN","PSUSUM4",84,0)
 D YX^%DTC
"RTN","PSUSUM4",85,0)
 N PSUD S PSUD=Y
"RTN","PSUSUM4",86,0)
 ;
"RTN","PSUSUM4",87,0)
 S Y=PSUSDT
"RTN","PSUSUM4",88,0)
 D DD^%DT
"RTN","PSUSUM4",89,0)
 N PSUS S PSUS=Y
"RTN","PSUSUM4",90,0)
 ;
"RTN","PSUSUM4",91,0)
 S Y=PSUEDT
"RTN","PSUSUM4",92,0)
 D DD^%DT
"RTN","PSUSUM4",93,0)
 N PSUE S PSUE=Y
"RTN","PSUSUM4",94,0)
 ;
"RTN","PSUSUM4",95,0)
 D IVSUM
"RTN","PSUSUM4",96,0)
 Q
"RTN","PSUSUM4",97,0)
 ;
"RTN","PSUSUM4",98,0)
IVSUM ;Summary report header to be run if IV  extract is  run
"RTN","PSUSUM4",99,0)
 ;
"RTN","PSUSUM4",100,0)
 ;Report header
"RTN","PSUSUM4",101,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY INPATIENT (IV) UNIQUE PATIENTS REPORT             "_PSUD
"RTN","PSUSUM4",102,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",2),"-",80)=""                ;Separator bar
"RTN","PSUSUM4",103,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="                 "_PSUS_"  through  "_PSUE
"RTN","PSUSUM4",104,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",4),"=",80)=""
"RTN","PSUSUM4",105,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",5)="                                                           UNIQUE"
"RTN","PSUSUM4",106,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",6),"-",70)=""
"RTN","PSUSUM4",107,0)
 Q
"RTN","PSUSUM4",108,0)
 ;
"RTN","PSUSUM4",109,0)
UNIQUE ;Find number of unique patients across all divisions
"RTN","PSUSUM4",110,0)
 ;
"RTN","PSUSUM4",111,0)
 N PSUSIT
"RTN","PSUSUM4",112,0)
 S PSUSIT=PSUSNDR
"RTN","PSUSUM4",113,0)
 ;
"RTN","PSUSUM4",114,0)
 N PSUWD,PSUSN
"RTN","PSUSUM4",115,0)
 S PSUOPCT=1
"RTN","PSUSUM4",116,0)
 S PSUIPCT=1
"RTN","PSUSUM4",117,0)
 S PSUNUM=0,PSUSIT1=0
"RTN","PSUSUM4",118,0)
 F  S PSUSIT1=$O(^XTMP("PSU_"_PSUJOB,"PSUIV","RECORDS",PSUSIT1)) Q:PSUSIT1=""  D
"RTN","PSUSUM4",119,0)
 .F  S PSUNUM=$O(^XTMP("PSU_"_PSUJOB,"PSUIV","RECORDS",PSUSIT1,PSUNUM)) Q:PSUNUM=""  D
"RTN","PSUSUM4",120,0)
 ..S PSUWD=$P($G(^XTMP("PSU_"_PSUJOB,"PSUIV","RECORDS",PSUSIT1,PSUNUM)),U,7)
"RTN","PSUSUM4",121,0)
 ..S PSUSN=$P($G(^XTMP("PSU_"_PSUJOB,"PSUIV","RECORDS",PSUSIT1,PSUNUM)),U,8)
"RTN","PSUSUM4",122,0)
 ..I PSUWD'="" D
"RTN","PSUSUM4",123,0)
 ...I PSUWD="Y" S ^XTMP("PSU_"_PSUJOB,"PSUOUT",PSUSN)=""
"RTN","PSUSUM4",124,0)
 ...I PSUWD="N" S ^XTMP("PSU_"_PSUJOB,"PSUIN",PSUSN)=""
"RTN","PSUSUM4",125,0)
 D WARD
"RTN","PSUSUM4",126,0)
 Q
"RTN","PSUSUM4",127,0)
 ;
"RTN","PSUSUM4",128,0)
WARD ;Find unique number of patients that are OP and IP
"RTN","PSUSUM4",129,0)
 ;
"RTN","PSUSUM4",130,0)
 ;Find unique number of outpatients
"RTN","PSUSUM4",131,0)
 S PSUD1A=0
"RTN","PSUSUM4",132,0)
 F  S PSUD1A=$O(^XTMP("PSU_"_PSUJOB,"PSUOUT",PSUD1A)) Q:PSUD1A=""  D
"RTN","PSUSUM4",133,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUOUTP")=PSUOPCT S PSUOPCT=PSUOPCT+1
"RTN","PSUSUM4",134,0)
 ;
"RTN","PSUSUM4",135,0)
 ;Find unique number in inpatients
"RTN","PSUSUM4",136,0)
 S PSUD1B=0
"RTN","PSUSUM4",137,0)
 F  S PSUD1B=$O(^XTMP("PSU_"_PSUJOB,"PSUIN",PSUD1B)) Q:PSUD1B=""  D
"RTN","PSUSUM4",138,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUINP")=PSUIPCT S PSUIPCT=PSUIPCT+1
"RTN","PSUSUM4",139,0)
 Q
"RTN","PSUSUM4",140,0)
 ;
"RTN","PSUSUM4",141,0)
TAB ;Calculate tab spacing
"RTN","PSUSUM4",142,0)
 ;
"RTN","PSUSUM4",143,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUINP")) S ^XTMP("PSU_"_PSUJOB,"PSUINP")=0
"RTN","PSUSUM4",144,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUOUTP")) S ^XTMP("PSU_"_PSUJOB,"PSUOUTP")=0
"RTN","PSUSUM4",145,0)
 ;
"RTN","PSUSUM4",146,0)
 S PSUTB1=" "
"RTN","PSUSUM4",147,0)
 S PSUTB2="Total unique Inpatients across all divisions:"
"RTN","PSUSUM4",148,0)
 S PSUTB3=(64-$L(^XTMP("PSU_"_PSUJOB,"PSUINP")))-$L(PSUTB2)
"RTN","PSUSUM4",149,0)
 F S2=1:1:(PSUTB3-1) S PSUTB(S2)=" " D
"RTN","PSUSUM4",150,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)
"RTN","PSUSUM4",151,0)
 ;
"RTN","PSUSUM4",152,0)
 S PSUTB6=" "
"RTN","PSUSUM4",153,0)
 S PSUTB4="Total unique Outpatients across all divisions:"
"RTN","PSUSUM4",154,0)
 S PSUTB5=(64-$L(^XTMP("PSU_"_PSUJOB,"PSUOUTP")))-$L(PSUTB4)
"RTN","PSUSUM4",155,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM4",156,0)
 .S PSUTB6=PSUTB6_PSUTB(S3)
"RTN","PSUSUM4",157,0)
 Q
"RTN","PSUSUM4",158,0)
 ;
"RTN","PSUSUM4",159,0)
TOTUN ;Set total number of unique in-patients and out-patients into
"RTN","PSUSUM4",160,0)
 ;summary message
"RTN","PSUSUM4",161,0)
 ; 
"RTN","PSUSUM4",162,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB2_PSUTB1_^XTMP("PSU_"_PSUJOB,"PSUINP") S I=I+1
"RTN","PSUSUM4",163,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB6_^XTMP("PSU_"_PSUJOB,"PSUOUTP") S I=I+1
"RTN","PSUSUM4",164,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)=""
"RTN","PSUSUM4",165,0)
 Q
"RTN","PSUSUM4",166,0)
 ;
"RTN","PSUSUM4",167,0)
PATNUM ;Place division names and patient totals into summary message
"RTN","PSUSUM4",168,0)
 ;
"RTN","PSUSUM4",169,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM4",170,0)
 N PSUCT3
"RTN","PSUSUM4",171,0)
 S PSUTOTAL=0
"RTN","PSUSUM4",172,0)
 S PSUDIVNM=0
"RTN","PSUSUM4",173,0)
 F  S PSUDIVNM=$O(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVNM)) Q:PSUDIVNM=""  D
"RTN","PSUSUM4",174,0)
 .S PSUCT3=$P($G(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVNM)),U,1)
"RTN","PSUSUM4",175,0)
 .S PSUTOTAL=PSUTOTAL+PSUCT3
"RTN","PSUSUM4",176,0)
 .D SPACE
"RTN","PSUSUM4",177,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSUDIVNM_" Division:"_PSUTB1_PSUCT3
"RTN","PSUSUM4",178,0)
 .S I=I+1
"RTN","PSUSUM4",179,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=PSUTOTAL   ;Total of all divisions
"RTN","PSUSUM4",180,0)
 Q
"RTN","PSUSUM4",181,0)
 ;
"RTN","PSUSUM4",182,0)
SPACE ;S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=PSUTOTAL   ;Total of all divisions
"RTN","PSUSUM4",183,0)
 ;
"RTN","PSUSUM4",184,0)
 S PSUTB1=" "
"RTN","PSUSUM4",185,0)
 S PSUTB2=(59-$L(PSUCT3))-$L(PSUDIVNM)-10
"RTN","PSUSUM4",186,0)
 F S2=1:1:(PSUTB2-1) S PSUTB(S2)=" " D
"RTN","PSUSUM4",187,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)                  ;Tab position
"RTN","PSUSUM4",188,0)
 Q
"RTN","PSUSUM4",189,0)
 ;
"RTN","PSUSUM4",190,0)
TAB1 ;EN  Calculate tab spacing for 'Total of all Divisions' line,
"RTN","PSUSUM4",191,0)
 ;and set the last lines of message into the summary global.
"RTN","PSUSUM4",192,0)
 ;
"RTN","PSUSUM4",193,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM4",194,0)
 ;
"RTN","PSUSUM4",195,0)
 S PSUTB3=" "
"RTN","PSUSUM4",196,0)
 S PSUTB4="     Total of all Divisions:          "
"RTN","PSUSUM4",197,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P(^XTMP("PSU_"_PSUJOB,"PSUTOTAL"),U,1))
"RTN","PSUSUM4",198,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM4",199,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)                ;Tab position
"RTN","PSUSUM4",200,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="                                                         ------------" S I=I+1
"RTN","PSUSUM4",201,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P(^XTMP("PSU_"_PSUJOB,"PSUTOTAL"),U,1) S I=I+1
"RTN","PSUSUM4",202,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="" S I=I+1
"RTN","PSUSUM4",203,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="* This report includes Outpatients receiving IV orders." S I=I+1
"RTN","PSUSUM4",204,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="" S I=I+1
"RTN","PSUSUM4",205,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="**PLEASE NOTE: Final TOTAL may not match sum of all SUBTOTALS.  A patient may" S I=I+1
"RTN","PSUSUM4",206,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="have been provided pharmacy services at more than one outpatient and/or" S I=I+1
"RTN","PSUSUM4",207,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="inpatient division."
"RTN","PSUSUM4",208,0)
 Q
"RTN","PSUSUM4",209,0)
 ;
"RTN","PSUSUM4",210,0)
NODATA ;Summary report line to be sent if there is no data
"RTN","PSUSUM4",211,0)
 ;
"RTN","PSUSUM4",212,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY INPATIENT (IV) UNIQUE PATIENTS REPORT"
"RTN","PSUSUM4",213,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",2)=" "
"RTN","PSUSUM4",214,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="No data to report"
"RTN","PSUSUM4",215,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM4",216,0)
 Q
"RTN","PSUSUM5")
0^93^B34135480
"RTN","PSUSUM5",1,0)
PSUSUM5 ;BIR/DAM - Patient Demographics Summary for IV/UD ; 20 DEC 2001
"RTN","PSUSUM5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM5",3,0)
 ;
"RTN","PSUSUM5",4,0)
EN ;EN CALLED FROM PSUUD0
"RTN","PSUSUM5",5,0)
 ;
"RTN","PSUSUM5",6,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM5",7,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","IV"))&$D(^XTMP("PSU_"_PSUJOB,"PSUNONE","UD")) D  Q    ;Summary report if there is no data
"RTN","PSUSUM5",8,0)
 .D NODATA
"RTN","PSUSUM5",9,0)
 .I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2")) K ^XTMP("PSU_"_PSUJOB,"PSUNONE")
"RTN","PSUSUM5",10,0)
 ;
"RTN","PSUSUM5",11,0)
 D DATE
"RTN","PSUSUM5",12,0)
 S I=7         ;Line Counter
"RTN","PSUSUM5",13,0)
 D UNIQUE
"RTN","PSUSUM5",14,0)
 D DIV
"RTN","PSUSUM5",15,0)
 D TOTAL
"RTN","PSUSUM5",16,0)
 D TAB1^PSUSUM4
"RTN","PSUSUM5",17,0)
 D PDSUM^PSUDEM5      ;Mail message
"RTN","PSUSUM5",18,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVOUT")
"RTN","PSUSUM5",19,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUUDIN")
"RTN","PSUSUM5",20,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM5",21,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFIN")
"RTN","PSUSUM5",22,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVSSN")
"RTN","PSUSUM5",23,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVDIV")
"RTN","PSUSUM5",24,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUNEW")
"RTN","PSUSUM5",25,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")
"RTN","PSUSUM5",26,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG2")
"RTN","PSUSUM5",27,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG3")
"RTN","PSUSUM5",28,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUUDDIV")
"RTN","PSUSUM5",29,0)
 ;
"RTN","PSUSUM5",30,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXCTA")
"RTN","PSUSUM5",31,0)
 Q
"RTN","PSUSUM5",32,0)
 ;
"RTN","PSUSUM5",33,0)
DATE ;Convert date range of extract to external format
"RTN","PSUSUM5",34,0)
 ;
"RTN","PSUSUM5",35,0)
 D PULL^PSUCP
"RTN","PSUSUM5",36,0)
 S %H=$E($H,1,5)    ;today's date
"RTN","PSUSUM5",37,0)
 D YX^%DTC
"RTN","PSUSUM5",38,0)
 N PSUD S PSUD=Y
"RTN","PSUSUM5",39,0)
 ;
"RTN","PSUSUM5",40,0)
 S Y=PSUSDT
"RTN","PSUSUM5",41,0)
 D DD^%DT
"RTN","PSUSUM5",42,0)
 N PSUS S PSUS=Y
"RTN","PSUSUM5",43,0)
 ;
"RTN","PSUSUM5",44,0)
 S Y=PSUEDT
"RTN","PSUSUM5",45,0)
 D DD^%DT
"RTN","PSUSUM5",46,0)
 N PSUE S PSUE=Y
"RTN","PSUSUM5",47,0)
 ;
"RTN","PSUSUM5",48,0)
 D IVUDSUM
"RTN","PSUSUM5",49,0)
 Q
"RTN","PSUSUM5",50,0)
 ;
"RTN","PSUSUM5",51,0)
IVUDSUM ;Summary report header
"RTN","PSUSUM5",52,0)
 ;
"RTN","PSUSUM5",53,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY INPATIENT (UD & IV) UNIQUE PATIENTS REPORT          "_PSUD
"RTN","PSUSUM5",54,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",2),"-",80)=""                ;Separator bar
"RTN","PSUSUM5",55,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="                 "_PSUS_"  through  "_PSUE
"RTN","PSUSUM5",56,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",4),"=",80)=""
"RTN","PSUSUM5",57,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",5)="                                                           UNIQUE"
"RTN","PSUSUM5",58,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",6),"-",70)=""
"RTN","PSUSUM5",59,0)
 Q
"RTN","PSUSUM5",60,0)
 ;
"RTN","PSUSUM5",61,0)
UNIQUE ;Find Total unique patient number across all divisions
"RTN","PSUSUM5",62,0)
 ;
"RTN","PSUSUM5",63,0)
 N PSUSIT
"RTN","PSUSUM5",64,0)
 S PSUSIT=PSUSNDR
"RTN","PSUSUM5",65,0)
 ;
"RTN","PSUSUM5",66,0)
 N PSUIPSUM,PSUOPSUM
"RTN","PSUSUM5",67,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUIVIN")) S $P(^XTMP("PSU_"_PSUJOB,"PSUIVIN"),U,1)=0
"RTN","PSUSUM5",68,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUUDIN")) S $P(^XTMP("PSU_"_PSUJOB,"PSUUDIN"),U,1)=0
"RTN","PSUSUM5",69,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUIVOUT")) S $P(^XTMP("PSU_"_PSUJOB,"PSUIVOUT"),U,1)=0
"RTN","PSUSUM5",70,0)
 ;
"RTN","PSUSUM5",71,0)
 ;Create IP unique global.  Screen out duplicates
"RTN","PSUSUM5",72,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUIPSUM")=^XTMP("PSU_"_PSUJOB,"PSUUDIN")
"RTN","PSUSUM5",73,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUIPSUM")=^XTMP("PSU_"_PSUJOB,"PSUIN")
"RTN","PSUSUM5",74,0)
 ;
"RTN","PSUSUM5",75,0)
 S N=1
"RTN","PSUSUM5",76,0)
 S PSUSUM=0
"RTN","PSUSUM5",77,0)
 F  S PSUSUM=$O(^XTMP("PSU_"_PSUJOB,"PSUIPSUM",PSUSUM))  Q:PSUSUM=""  D
"RTN","PSUSUM5",78,0)
 .S PSUIPSUM=N S N=N+1
"RTN","PSUSUM5",79,0)
 ;
"RTN","PSUSUM5",80,0)
 S PSUOPSUM=$P($G(^XTMP("PSU_"_PSUJOB,"PSUIVOUT")),U,1)
"RTN","PSUSUM5",81,0)
 D TAB
"RTN","PSUSUM5",82,0)
 Q
"RTN","PSUSUM5",83,0)
 ;
"RTN","PSUSUM5",84,0)
TAB ;Calculate tab spacing
"RTN","PSUSUM5",85,0)
 ;
"RTN","PSUSUM5",86,0)
 N PSUTB2,PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM5",87,0)
 ;
"RTN","PSUSUM5",88,0)
 S PSUTB1=" "
"RTN","PSUSUM5",89,0)
 S PSUTB2="Total Inpatients across all divisions:"
"RTN","PSUSUM5",90,0)
 S PSUTB3=(64-$L(PSUIPSUM))-$L(PSUTB2)
"RTN","PSUSUM5",91,0)
 F S2=1:1:(PSUTB3-1) S PSUTB(S2)=" " D
"RTN","PSUSUM5",92,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)
"RTN","PSUSUM5",93,0)
 ;
"RTN","PSUSUM5",94,0)
 S PSUTB6=" "
"RTN","PSUSUM5",95,0)
 S PSUTB4="Total Outpatients across all divisions:"
"RTN","PSUSUM5",96,0)
 S PSUTB5=(64-$L(PSUOPSUM))-$L(PSUTB4)
"RTN","PSUSUM5",97,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM5",98,0)
 .S PSUTB6=PSUTB6_PSUTB(S3)
"RTN","PSUSUM5",99,0)
 D TOT
"RTN","PSUSUM5",100,0)
 Q
"RTN","PSUSUM5",101,0)
 ;
"RTN","PSUSUM5",102,0)
TOT ;Set total number of unique in-patients and out-patients into
"RTN","PSUSUM5",103,0)
 ;summary message
"RTN","PSUSUM5",104,0)
 ;
"RTN","PSUSUM5",105,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB2_PSUTB1_(PSUIPSUM) S I=I+1
"RTN","PSUSUM5",106,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB6_(PSUOPSUM) S I=I+1
"RTN","PSUSUM5",107,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM5",108,0)
 Q
"RTN","PSUSUM5",109,0)
 ;
"RTN","PSUSUM5",110,0)
DIV ;Set all divisions from both IV and UD extracts into one global
"RTN","PSUSUM5",111,0)
 ;
"RTN","PSUSUM5",112,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUFIN")=^XTMP("PSU_"_PSUJOB,"PSUDIV1")    ;IP division name/SSN
"RTN","PSUSUM5",113,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUFIN")=^XTMP("PSU_"_PSUJOB,"PSUDIVUD")   ;UD division name/SSN
"RTN","PSUSUM5",114,0)
 Q
"RTN","PSUSUM5",115,0)
 S E=1        ;Counter for new global
"RTN","PSUSUM5",116,0)
 S PSUZ=0
"RTN","PSUSUM5",117,0)
 F  S PSUZ=$O(^XTMP("PSU_"_PSUJOB,"PSUIVINDIV",PSUZ)) Q:PSUZ=""  D
"RTN","PSUSUM5",118,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUNEW",PSUZ,E)=$P($G(^XTMP("PSU_"_PSUJOB,"PSUIVINDIV",PSUZ)),U,1)   ;IV
"RTN","PSUSUM5",119,0)
 .S E=E+1
"RTN","PSUSUM5",120,0)
 ;
"RTN","PSUSUM5",121,0)
 S PSUZ1=0
"RTN","PSUSUM5",122,0)
 F  S PSUZ1=$O(^XTMP("PSU_"_PSUJOB,"PSUUDDIV",PSUZ1)) Q:PSUZ1=""  D
"RTN","PSUSUM5",123,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUNEW",PSUZ1,E)=$P($G(^XTMP("PSU_"_PSUJOB,"PSUUDDIV",PSUZ1)),U,1)
"RTN","PSUSUM5",124,0)
 .S E=E+1
"RTN","PSUSUM5",125,0)
 Q
"RTN","PSUSUM5",126,0)
 ;
"RTN","PSUSUM5",127,0)
 ;
"RTN","PSUSUM5",128,0)
TOTAL ;Calculate sum of all divisions and set individual division lines
"RTN","PSUSUM5",129,0)
 ;into summary message
"RTN","PSUSUM5",130,0)
 ;
"RTN","PSUSUM5",131,0)
 S T=1
"RTN","PSUSUM5",132,0)
 S PSUDNAM=0
"RTN","PSUSUM5",133,0)
 F  S PSUDNAM=$O(^XTMP("PSU_"_PSUJOB,"PSUFIN",PSUDNAM)) Q:PSUDNAM=""  D
"RTN","PSUSUM5",134,0)
 .S PSUNUM1=0
"RTN","PSUSUM5",135,0)
 .F  S PSUNUM1=$O(^XTMP("PSU_"_PSUJOB,"PSUFIN",PSUDNAM,PSUNUM1)) Q:PSUNUM1=""  D
"RTN","PSUSUM5",136,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=T S T=T+1     ;Set total count
"RTN","PSUSUM5",137,0)
 ..I $D(^XTMP("PSU_"_PSUJOB,"PSUTOT",PSUDNAM)) D
"RTN","PSUSUM5",138,0)
 ...S C=C+1
"RTN","PSUSUM5",139,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUTOT",PSUDNAM)=C
"RTN","PSUSUM5",140,0)
 ..I '$D(^XTMP("PSU_"_PSUJOB,"PSUTOT",PSUDNAM)) D
"RTN","PSUSUM5",141,0)
 ...S C=1
"RTN","PSUSUM5",142,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUTOT",PSUDNAM)=C
"RTN","PSUSUM5",143,0)
 ;
"RTN","PSUSUM5",144,0)
 S PSUDNAM1=0
"RTN","PSUSUM5",145,0)
 N PSUSNUM
"RTN","PSUSUM5",146,0)
 F  S PSUDNAM1=$O(^XTMP("PSU_"_PSUJOB,"PSUTOT",PSUDNAM1)) Q:PSUDNAM1=""  D
"RTN","PSUSUM5",147,0)
 .S PSUNUM=$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOT",PSUDNAM1)),U,1)
"RTN","PSUSUM5",148,0)
 .D TAB1
"RTN","PSUSUM5",149,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSUDNAM1_" Division:"_PSUTB6_PSUNUM
"RTN","PSUSUM5",150,0)
 .S I=I+1
"RTN","PSUSUM5",151,0)
 ;
"RTN","PSUSUM5",152,0)
 Q
"RTN","PSUSUM5",153,0)
 ;
"RTN","PSUSUM5",154,0)
TAB1 ;Calculate tab spacing
"RTN","PSUSUM5",155,0)
 ;
"RTN","PSUSUM5",156,0)
 S PSUTB6=" "
"RTN","PSUSUM5",157,0)
 S PSUTB7=(59-$L(PSUNUM))-$L(PSUDNAM1)-10
"RTN","PSUSUM5",158,0)
 F S2=1:1:(PSUTB7-1) S PSUTB(S2)=" " D
"RTN","PSUSUM5",159,0)
 .S PSUTB6=PSUTB6_PSUTB(S2)                  ;Tab position
"RTN","PSUSUM5",160,0)
 Q
"RTN","PSUSUM5",161,0)
 ;
"RTN","PSUSUM5",162,0)
NODATA ;Summary report line to be sent if there is no data
"RTN","PSUSUM5",163,0)
 ;
"RTN","PSUSUM5",164,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY INPATIENT (UD & IV) UNIQUE PATIENTS REPORT"
"RTN","PSUSUM5",165,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",2)=" "
"RTN","PSUSUM5",166,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="No data to report"
"RTN","PSUSUM5",167,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM5",168,0)
 Q
"RTN","PSUSUM6")
0^94^B79961216
"RTN","PSUSUM6",1,0)
PSUSUM6 ;BIR/DAM - Patient Demographics Summary for IV/UD/RX ; 20 DEC 2001
"RTN","PSUSUM6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM6",3,0)
 ;
"RTN","PSUSUM6",4,0)
EN ;EN CALLED FROM PSUOP0
"RTN","PSUSUM6",5,0)
 ;
"RTN","PSUSUM6",6,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")   ;DAM  Trying to make auto run
"RTN","PSUSUM6",7,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG3")) D
"RTN","PSUSUM6",8,0)
 .K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM6",9,0)
 ;
"RTN","PSUSUM6",10,0)
 N PSURX,PSUIV,PSUUD
"RTN","PSUSUM6",11,0)
 S PSURX=$G(^XTMP("PSU_"_PSUJOB,"PSUNONE","RX"))
"RTN","PSUSUM6",12,0)
 S PSUIV=$G(^XTMP("PSU_"_PSUJOB,"PSUNONE","IV"))
"RTN","PSUSUM6",13,0)
 S PSUUD=$G(^XTMP("PSU_"_PSUJOB,"PSUNONE","UD"))
"RTN","PSUSUM6",14,0)
 I $G(PSURX)&$G(PSUIV)&$G(PSUUD) D  Q
"RTN","PSUSUM6",15,0)
 .D NODATA D
"RTN","PSUSUM6",16,0)
 ..I $D(^XTMP("PSU_"_PSUJOB,"PSUFLAG1"))!$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG2")) K ^XTMP("PSU_"_PSUJOB,"PSUNONE")
"RTN","PSUSUM6",17,0)
 D EN1
"RTN","PSUSUM6",18,0)
 Q
"RTN","PSUSUM6",19,0)
 ;
"RTN","PSUSUM6",20,0)
EN1 ;Gather summary data for UD/IV/RX report
"RTN","PSUSUM6",21,0)
 D PULL^PSUCP
"RTN","PSUSUM6",22,0)
 D DATE
"RTN","PSUSUM6",23,0)
 S I=7
"RTN","PSUSUM6",24,0)
 D UNIQUE
"RTN","PSUSUM6",25,0)
 D TOP
"RTN","PSUSUM6",26,0)
 D OPDIV
"RTN","PSUSUM6",27,0)
 D DIVTOT
"RTN","PSUSUM6",28,0)
 D TUDIV
"RTN","PSUSUM6",29,0)
 D IPDIV
"RTN","PSUSUM6",30,0)
 D IPDIV1
"RTN","PSUSUM6",31,0)
 D TAB3
"RTN","PSUSUM6",32,0)
 D TAB4
"RTN","PSUSUM6",33,0)
 D PDSUM^PSUDEM5       ;Mail message
"RTN","PSUSUM6",34,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTMP")
"RTN","PSUSUM6",35,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")
"RTN","PSUSUM6",36,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXUNIQUE")
"RTN","PSUSUM6",37,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")
"RTN","PSUSUM6",38,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXCTA")
"RTN","PSUSUM6",39,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXSSN")
"RTN","PSUSUM6",40,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUCOMBO")
"RTN","PSUSUM6",41,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVSSN")
"RTN","PSUSUM6",42,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUUDSSN")
"RTN","PSUSUM6",43,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVDIV")
"RTN","PSUSUM6",44,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVOUT")
"RTN","PSUSUM6",45,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUUDDIV")
"RTN","PSUSUM6",46,0)
 Q
"RTN","PSUSUM6",47,0)
 ;
"RTN","PSUSUM6",48,0)
DATE ;EN  Convert date range of extract to external format
"RTN","PSUSUM6",49,0)
 ;
"RTN","PSUSUM6",50,0)
 S %H=$E($H,1,5)    ;today's date
"RTN","PSUSUM6",51,0)
 D YX^%DTC
"RTN","PSUSUM6",52,0)
 N PSUD S PSUD=Y
"RTN","PSUSUM6",53,0)
 ;
"RTN","PSUSUM6",54,0)
 S Y=PSUSDT
"RTN","PSUSUM6",55,0)
 D DD^%DT
"RTN","PSUSUM6",56,0)
 N PSUS S PSUS=Y
"RTN","PSUSUM6",57,0)
 ;
"RTN","PSUSUM6",58,0)
 S Y=PSUEDT
"RTN","PSUSUM6",59,0)
 D DD^%DT
"RTN","PSUSUM6",60,0)
 N PSUE S PSUE=Y
"RTN","PSUSUM6",61,0)
 ;
"RTN","PSUSUM6",62,0)
 D COMSUM
"RTN","PSUSUM6",63,0)
 Q
"RTN","PSUSUM6",64,0)
 ;
"RTN","PSUSUM6",65,0)
COMSUM ;Summary report header to be run for combination Rx/IV/UD report
"RTN","PSUSUM6",66,0)
 ;
"RTN","PSUSUM6",67,0)
 ;Report header
"RTN","PSUSUM6",68,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY UNIQUE PATIENTS REPORT                          "_PSUD
"RTN","PSUSUM6",69,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",2),"-",80)=""                ;Separator bar
"RTN","PSUSUM6",70,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="                 "_PSUS_"  through  "_PSUE
"RTN","PSUSUM6",71,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",4),"=",80)=""
"RTN","PSUSUM6",72,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",5)="                                                          UNIQUE"
"RTN","PSUSUM6",73,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",6),"-",70)=""
"RTN","PSUSUM6",74,0)
 Q
"RTN","PSUSUM6",75,0)
 ;
"RTN","PSUSUM6",76,0)
UNIQUE ;Find total unique pharmacy patients across all divisions
"RTN","PSUSUM6",77,0)
 ;
"RTN","PSUSUM6",78,0)
 S PSURXN=0,PSUIVN=0,PSUUDN1=0
"RTN","PSUSUM6",79,0)
 ;
"RTN","PSUSUM6",80,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUTMP")=^XTMP("PSU_"_PSUJOB,"PSURXSSN")
"RTN","PSUSUM6",81,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUTMP")=^XTMP("PSU_"_PSUJOB,"PSUIVSSN")
"RTN","PSUSUM6",82,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUTMP")=^XTMP("PSU_"_PSUJOB,"PSUUDSSN")
"RTN","PSUSUM6",83,0)
 ;
"RTN","PSUSUM6",84,0)
 ;
"RTN","PSUSUM6",85,0)
 S N=1
"RTN","PSUSUM6",86,0)
 S PSUTTL=0
"RTN","PSUSUM6",87,0)
 F  S PSUTTL=$O(^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUTTL)) Q:PSUTTL=""  D
"RTN","PSUSUM6",88,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=N S N=N+1
"RTN","PSUSUM6",89,0)
 D TAB2
"RTN","PSUSUM6",90,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM6",91,0)
 Q
"RTN","PSUSUM6",92,0)
 ;
"RTN","PSUSUM6",93,0)
TAB2 ;Tab spacing for line 7.  Set line into global
"RTN","PSUSUM6",94,0)
 ;
"RTN","PSUSUM6",95,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM6",96,0)
 ;
"RTN","PSUSUM6",97,0)
 S PSUTB3=" "
"RTN","PSUSUM6",98,0)
 S PSUTB4="TOTAL Pharmacy patients across all divisions:"
"RTN","PSUSUM6",99,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1))
"RTN","PSUSUM6",100,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM6",101,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)
"RTN","PSUSUM6",102,0)
 I '$G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")) D
"RTN","PSUSUM6",103,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=0
"RTN","PSUSUM6",104,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1)
"RTN","PSUSUM6",105,0)
 S I=I+1
"RTN","PSUSUM6",106,0)
 Q
"RTN","PSUSUM6",107,0)
 ;
"RTN","PSUSUM6",108,0)
TOP ;EN  Find Total Outpatients
"RTN","PSUSUM6",109,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM6",110,0)
 ;
"RTN","PSUSUM6",111,0)
 N PSUTOP,PSULBL
"RTN","PSUSUM6",112,0)
 S PSUTOP=$G(^XTMP("PSU_"_PSUJOB,"PSURXUNIQUE"))
"RTN","PSUSUM6",113,0)
 I '$G(PSUTOP) S PSUTOP=0,PSUTOPF=1
"RTN","PSUSUM6",114,0)
 S PSULBL="   Total OUTPATIENT:"
"RTN","PSUSUM6",115,0)
 D TAB
"RTN","PSUSUM6",116,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSULBL_PSUTB1_PSUTOP S I=I+1
"RTN","PSUSUM6",117,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM6",118,0)
 Q
"RTN","PSUSUM6",119,0)
 ;
"RTN","PSUSUM6",120,0)
TAB ;Calculate tab spacing
"RTN","PSUSUM6",121,0)
 ;
"RTN","PSUSUM6",122,0)
 S PSUTB1=" "
"RTN","PSUSUM6",123,0)
 S PSUTB2=(64-$L(PSUTOP))-$L(PSULBL)
"RTN","PSUSUM6",124,0)
 F S2=1:1:(PSUTB2-1) S PSUTB(S2)=" " D
"RTN","PSUSUM6",125,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)
"RTN","PSUSUM6",126,0)
 Q
"RTN","PSUSUM6",127,0)
 ;
"RTN","PSUSUM6",128,0)
OPDIV ;EN   Find outpatients per division
"RTN","PSUSUM6",129,0)
 ;
"RTN","PSUSUM6",130,0)
 Q:$G(PSUTOPF)
"RTN","PSUSUM6",131,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM6",132,0)
 ;
"RTN","PSUSUM6",133,0)
 N PSUTTL
"RTN","PSUSUM6",134,0)
 S PSULBL=0
"RTN","PSUSUM6",135,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSURXCTA")) D
"RTN","PSUSUM6",136,0)
 .F  S PSULBL=$O(^XTMP("PSU_"_PSUJOB,"PSURXCTA",PSULBL)) Q:PSULBL=""  D
"RTN","PSUSUM6",137,0)
 ..Q:PSULBL=0
"RTN","PSUSUM6",138,0)
 ..S PSUTTL=$P($G(^XTMP("PSU_"_PSUJOB,"PSURXCTA",PSULBL)),U,1)
"RTN","PSUSUM6",139,0)
 ..D TAB1
"RTN","PSUSUM6",140,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSULBL_" Division:"_PSUTB1_PSUTTL
"RTN","PSUSUM6",141,0)
 ..S I=I+1
"RTN","PSUSUM6",142,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSURXCTA")) D
"RTN","PSUSUM6",143,0)
 .S PSUTTL=0
"RTN","PSUSUM6",144,0)
 .D TAB1
"RTN","PSUSUM6",145,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSULBL_" Division:"_PSUTB1_PSUTTL
"RTN","PSUSUM6",146,0)
 .S I=I+1
"RTN","PSUSUM6",147,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="                                                          ----------" S I=I+1
"RTN","PSUSUM6",148,0)
 Q
"RTN","PSUSUM6",149,0)
 ;
"RTN","PSUSUM6",150,0)
TAB1 ;EN   Calculate division tab spacing
"RTN","PSUSUM6",151,0)
 ;
"RTN","PSUSUM6",152,0)
 S PSUTB1=" "
"RTN","PSUSUM6",153,0)
 S PSUTB2=(59-$L(PSUTTL))-$L(PSULBL)-10
"RTN","PSUSUM6",154,0)
 F S2=1:1:(PSUTB2-1) S PSUTB(S2)=" " D
"RTN","PSUSUM6",155,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)
"RTN","PSUSUM6",156,0)
 Q
"RTN","PSUSUM6",157,0)
 ;
"RTN","PSUSUM6",158,0)
DIVTOT ;EN  Calculate tab spacing for 'Outpatient total of all divisions'
"RTN","PSUSUM6",159,0)
 ;line and set line into message global
"RTN","PSUSUM6",160,0)
 ;
"RTN","PSUSUM6",161,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM6",162,0)
 ;
"RTN","PSUSUM6",163,0)
 I '$G(^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")) D
"RTN","PSUSUM6",164,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")=0
"RTN","PSUSUM6",165,0)
 S PSUTB3=" "
"RTN","PSUSUM6",166,0)
 S PSUTB4="     Outpatient Total of all Divisions:"
"RTN","PSUSUM6",167,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")),U,1))
"RTN","PSUSUM6",168,0)
 F S3=1:1:(PSUTB5-1) S PSUTB3(S3)=" " D
"RTN","PSUSUM6",169,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)
"RTN","PSUSUM6",170,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")),U,1) S I=I+1
"RTN","PSUSUM6",171,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM6",172,0)
 Q
"RTN","PSUSUM6",173,0)
 ;
"RTN","PSUSUM6",174,0)
TUDIV ;Calculate tab spacing for 'Total INPATIENT' line and
"RTN","PSUSUM6",175,0)
 ;set line into message global
"RTN","PSUSUM6",176,0)
 ;
"RTN","PSUSUM6",177,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM6",178,0)
 ;
"RTN","PSUSUM6",179,0)
 ;Create global with total number of unique UD + IV inpatients
"RTN","PSUSUM6",180,0)
 ;using patient SSN to ID unique patient
"RTN","PSUSUM6",181,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUUDIVT")=^XTMP("PSU_"_PSUJOB,"PSUDIV1")
"RTN","PSUSUM6",182,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUUDIVT")=^XTMP("PSU_"_PSUJOB,"PSUDIVUD")
"RTN","PSUSUM6",183,0)
 ;
"RTN","PSUSUM6",184,0)
 ;Loop through division global and create global with unique SSN
"RTN","PSUSUM6",185,0)
 S G=1
"RTN","PSUSUM6",186,0)
 S PSUD2=0
"RTN","PSUSUM6",187,0)
 F  S PSUD2=$O(^XTMP("PSU_"_PSUJOB,"PSUUDIVT",PSUD2)) Q:PSUD2=""  D
"RTN","PSUSUM6",188,0)
 .S PSUD8=0
"RTN","PSUSUM6",189,0)
 .F  S PSUD8=$O(^XTMP("PSU_"_PSUJOB,"PSUUDIVT",PSUD2,PSUD8)) Q:PSUD8=""  D
"RTN","PSUSUM6",190,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUUDIVT1",PSUD8)=""   ;Unique SSN's
"RTN","PSUSUM6",191,0)
 ;
"RTN","PSUSUM6",192,0)
 ;Find number of unique SSN's. This is number of unique patients
"RTN","PSUSUM6",193,0)
 S PSUD9=0
"RTN","PSUSUM6",194,0)
 F  S PSUD9=$O(^XTMP("PSU_"_PSUJOB,"PSUUDIVT1",PSUD9)) Q:PSUD9=""  D
"RTN","PSUSUM6",195,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")=G,G=G+1
"RTN","PSUSUM6",196,0)
 ;
"RTN","PSUSUM6",197,0)
 ;Calculate tab spacing
"RTN","PSUSUM6",198,0)
 S PSUTB3=" "
"RTN","PSUSUM6",199,0)
 S PSUTB4="   Total INPATIENT:"
"RTN","PSUSUM6",200,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")),U,1))
"RTN","PSUSUM6",201,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM6",202,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)             ;Tab position
"RTN","PSUSUM6",203,0)
 ;
"RTN","PSUSUM6",204,0)
 ;Set line into message global
"RTN","PSUSUM6",205,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")),U,1) S I=I+1
"RTN","PSUSUM6",206,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM6",207,0)
 Q
"RTN","PSUSUM6",208,0)
 ;
"RTN","PSUSUM6",209,0)
IPDIV ;EN   Find inpatients  by division (includes UD patients and IV
"RTN","PSUSUM6",210,0)
 ;patients with ward location NOT set to 0.5
"RTN","PSUSUM6",211,0)
 ;
"RTN","PSUSUM6",212,0)
 ;If no Unit Dose data exists, do the following to get IV data:
"RTN","PSUSUM6",213,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","UD")) D  Q
"RTN","PSUSUM6",214,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSUINPT")=^XTMP("PSU_"_PSUJOB,"PSUDIV1")
"RTN","PSUSUM6",215,0)
 ;
"RTN","PSUSUM6",216,0)
 ;If no IV data exists, do the following to get UD data:
"RTN","PSUSUM6",217,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","IV")) D  Q
"RTN","PSUSUM6",218,0)
 .M ^XTMP("PSU_"_PSUJOB,"PSUINPT")=^XTMP("PSU_"_PSUJOB,"PSUDIVUD")
"RTN","PSUSUM6",219,0)
 ;
"RTN","PSUSUM6",220,0)
 ;Construct a storage global containing unique inpatients
"RTN","PSUSUM6",221,0)
 ;per division when there is both UD and IV data
"RTN","PSUSUM6",222,0)
 S PSUDV1=0
"RTN","PSUSUM6",223,0)
 F  S PSUDV1=$O(^XTMP("PSU_"_PSUJOB,"PSUDIV1",PSUDV1)) Q:PSUDV1=""  D
"RTN","PSUSUM6",224,0)
 .S PSUDVUD=0
"RTN","PSUSUM6",225,0)
 .F  S PSUDVUD=$O(^XTMP("PSU_"_PSUJOB,"PSUDIVUD",PSUDVUD)) Q:PSUDVUD=""  D
"RTN","PSUSUM6",226,0)
 ..I PSUDVUD=PSUDV1 D
"RTN","PSUSUM6",227,0)
 ...S PSUPT=0
"RTN","PSUSUM6",228,0)
 ...F  S PSUPT=$O(^XTMP("PSU_"_PSUJOB,"PSUDIV1",PSUDV1,PSUPT)) Q:PSUPT=""  D
"RTN","PSUSUM6",229,0)
 ....S ^XTMP("PSU_"_PSUJOB,"PSUINPT",PSUDV1,PSUPT)=""
"RTN","PSUSUM6",230,0)
 ....S PSUPT1=0
"RTN","PSUSUM6",231,0)
 ....F  S PSUPT1=$O(^XTMP("PSU_"_PSUJOB,"PSUDIVUD",PSUDVUD,PSUPT1)) Q:PSUPT1=""  D
"RTN","PSUSUM6",232,0)
 .....S ^XTMP("PSU_"_PSUJOB,"PSUINPT",PSUDVUD,PSUPT1)=""
"RTN","PSUSUM6",233,0)
 ..I PSUDVUD'=PSUDV1 D
"RTN","PSUSUM6",234,0)
 ...M ^XTMP("PSU_"_PSUJOB,"PSUINPT")=^XTMP("PSU_"_PSUJOB,"PSUDIVUD")
"RTN","PSUSUM6",235,0)
 Q
"RTN","PSUSUM6",236,0)
 ;
"RTN","PSUSUM6",237,0)
IPDIV1 ;Calculate inpatient totals
"RTN","PSUSUM6",238,0)
 ;
"RTN","PSUSUM6",239,0)
 S PSUSIT=0,PSUSIT1=0,T=1
"RTN","PSUSUM6",240,0)
 ;
"RTN","PSUSUM6",241,0)
 F  S PSUSIT=$O(^XTMP("PSU_"_PSUJOB,"PSUINPT",PSUSIT)) Q:PSUSIT=""  D
"RTN","PSUSUM6",242,0)
 .F  S PSUSIT1=$O(^XTMP("PSU_"_PSUJOB,"PSUINPT",PSUSIT,PSUSIT1)) Q:PSUSIT1=""  D
"RTN","PSUSUM6",243,0)
 ..I $D(^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSUSIT)) D
"RTN","PSUSUM6",244,0)
 ...S C=C+1
"RTN","PSUSUM6",245,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSUSIT)=C
"RTN","PSUSUM6",246,0)
 ..I '$D(^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSUSIT)) D
"RTN","PSUSUM6",247,0)
 ...S C=1
"RTN","PSUSUM6",248,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSUSIT)=C
"RTN","PSUSUM6",249,0)
 Q
"RTN","PSUSUM6",250,0)
 ;
"RTN","PSUSUM6",251,0)
TAB3 ;Place inpatient division totals into summary message
"RTN","PSUSUM6",252,0)
 ;
"RTN","PSUSUM6",253,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM6",254,0)
 ;
"RTN","PSUSUM6",255,0)
 N PSUTTL
"RTN","PSUSUM6",256,0)
 S PSULBL=0
"RTN","PSUSUM6",257,0)
 F  S PSULBL=$O(^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSULBL)) Q:PSULBL=""  D
"RTN","PSUSUM6",258,0)
 .S PSUTTL=$P($G(^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSULBL)),U,1)
"RTN","PSUSUM6",259,0)
 .I '$G(PSUTTL) S PSUTTL=0
"RTN","PSUSUM6",260,0)
 .D TAB1
"RTN","PSUSUM6",261,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSULBL_" Division:"_PSUTB1_PSUTTL
"RTN","PSUSUM6",262,0)
 .S I=I+1
"RTN","PSUSUM6",263,0)
 Q
"RTN","PSUSUM6",264,0)
 ;
"RTN","PSUSUM6",265,0)
TAB4 ;Calculate inpatient totals of all divisions and place in summary
"RTN","PSUSUM6",266,0)
 ;message
"RTN","PSUSUM6",267,0)
 ;
"RTN","PSUSUM6",268,0)
 S N=0,PSUMKER=0
"RTN","PSUSUM6",269,0)
 F  S PSUMKER=$O(^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSUMKER)) Q:PSUMKER=""  D
"RTN","PSUSUM6",270,0)
 .S N=$P(^XTMP("PSU_"_PSUJOB,"PSUCOMBO",PSUMKER),U)+N
"RTN","PSUSUM6",271,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=N                 ;Sum of all inpatients
"RTN","PSUSUM6",272,0)
 ;
"RTN","PSUSUM6",273,0)
 D TAB1^PSUSUM3
"RTN","PSUSUM6",274,0)
 Q
"RTN","PSUSUM6",275,0)
 ;
"RTN","PSUSUM6",276,0)
NODATA ;Summary report line to be sent if there is no data
"RTN","PSUSUM6",277,0)
 ;
"RTN","PSUSUM6",278,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY UNIQUE PATIENTS REPORT"
"RTN","PSUSUM6",279,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",2)=" "
"RTN","PSUSUM6",280,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="No data to report"
"RTN","PSUSUM6",281,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM6",282,0)
 Q
"RTN","PSUSUM7")
0^95^B60953912
"RTN","PSUSUM7",1,0)
PSUSUM7 ;BIR/DAM - Pt. Demographics Summary for IV/RX or UD/RX ; 20 DEC 2001
"RTN","PSUSUM7",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUSUM7",3,0)
 ;
"RTN","PSUSUM7",4,0)
EN ;EN CALLED FROM PSUOP0
"RTN","PSUSUM7",5,0)
 ;Q:$D(^XTMP("PSU_"_PSUJOB,"PSU_"_PSUJOB,"PSUMFLAG"))   ;Do not run if auto extract
"RTN","PSUSUM7",6,0)
 ;
"RTN","PSUSUM7",7,0)
 D PULL^PSUCP
"RTN","PSUSUM7",8,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUSUM7",9,0)
 ;
"RTN","PSUSUM7",10,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM7",11,0)
 I $G(^XTMP("PSU_"_PSUJOB,"PSUFLAG2"))!$G(^XTMP("PSU_"_PSUJOB,"PSUFLAG3")) K ^XTMP("PSU_"_PSUJOB,"PSUSUMA")
"RTN","PSUSUM7",12,0)
 I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","RX")) D  Q
"RTN","PSUSUM7",13,0)
 .I $D(^XTMP("PSU_"_PSUJOB,"PSUNONE","IV"))!$D(^XTMP("PSU_"_PSUJOB,"PSUNONE","UD")) D
"RTN","PSUSUM7",14,0)
 ..D NODATA
"RTN","PSUSUM7",15,0)
 ..I $G(^XTMP("PSU_"_PSUJOB,"PSUFLAG1"))!$G(^XTMP("PSU_"_PSUJOB,"PSUFLAG2")) K ^XTMP("PSU_"_PSUJOB,"PSUNONE")
"RTN","PSUSUM7",16,0)
 ;
"RTN","PSUSUM7",17,0)
 D EN1
"RTN","PSUSUM7",18,0)
 Q
"RTN","PSUSUM7",19,0)
 ;
"RTN","PSUSUM7",20,0)
EN1 ;Gather summary data
"RTN","PSUSUM7",21,0)
 D DATE^PSUSUM6
"RTN","PSUSUM7",22,0)
 S I=7
"RTN","PSUSUM7",23,0)
 I $D(PSUMOD(1)) D UNIQUE1
"RTN","PSUSUM7",24,0)
 I '$D(PSUMOD(1)) D UNIQUE
"RTN","PSUSUM7",25,0)
 D TOP^PSUSUM6
"RTN","PSUSUM7",26,0)
 D OPDIV^PSUSUM6
"RTN","PSUSUM7",27,0)
 D DIVTOT^PSUSUM6
"RTN","PSUSUM7",28,0)
 D TUDIV
"RTN","PSUSUM7",29,0)
 I $D(PSUMOD(1)) D
"RTN","PSUSUM7",30,0)
 .D IPDIV2
"RTN","PSUSUM7",31,0)
 I $D(PSUMOD(2)) D
"RTN","PSUSUM7",32,0)
 .D IPDIV^PSUSUM6
"RTN","PSUSUM7",33,0)
 .D IPDIV1
"RTN","PSUSUM7",34,0)
 .D TAB4
"RTN","PSUSUM7",35,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM7",36,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUTMP"),^XTMP("PSU_"_PSUJOB,"PSUTOTAL"),^XTMP("PSU_"_PSUJOB,"PSURXUNIQUE")
"RTN","PSUSUM7",37,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXTOTAL")
"RTN","PSUSUM7",38,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXCTA"),^XTMP("PSU_"_PSUJOB,"PSUIVINDIV")
"RTN","PSUSUM7",39,0)
 K ^XTMP("PSU_"_PSUJOB,"PSURXSSN"),^XTMP("PSU_"_PSUJOB,"PSUIVDIV"),^XTMP("PSU_"_PSUJOB,"PSUFLAG2")
"RTN","PSUSUM7",40,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG3")
"RTN","PSUSUM7",41,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUIVOUT"),^XTMP("PSU_"_PSUJOB,"PSUIVSSN"),^XTMP("PSU_"_PSUJOB,"PSUUDDIV")
"RTN","PSUSUM7",42,0)
 Q
"RTN","PSUSUM7",43,0)
 ;
"RTN","PSUSUM7",44,0)
UNIQUE ;Find total unique pharmacy patients across all divisions when
"RTN","PSUSUM7",45,0)
 ;UD and RX extracts are run together
"RTN","PSUSUM7",46,0)
 ;
"RTN","PSUSUM7",47,0)
 S PSURXN=0,PSUUDN1=0,PSUUDN2=0
"RTN","PSUSUM7",48,0)
 ;
"RTN","PSUSUM7",49,0)
 S N=1
"RTN","PSUSUM7",50,0)
 F  S PSURXN=$O(^XTMP("PSU_"_PSUJOB,"PSURXSSN",PSURXN)) Q:PSURXN=""  D
"RTN","PSUSUM7",51,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUTMP",PSURXN)=N S N=N+1
"RTN","PSUSUM7",52,0)
 .F  S PSUUDN1=$O(^XTMP("PSU_"_PSUJOB,"PSUUDSSN",PSUUDN1)) Q:PSUUDN1=""  D
"RTN","PSUSUM7",53,0)
 ..I '$D(^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUUDN1)) S ^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUUDN1)=N S N=N+1
"RTN","PSUSUM7",54,0)
 ;
"RTN","PSUSUM7",55,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=N-1
"RTN","PSUSUM7",56,0)
 D TAB2
"RTN","PSUSUM7",57,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM7",58,0)
 Q
"RTN","PSUSUM7",59,0)
 ;
"RTN","PSUSUM7",60,0)
TAB2 ;Tab spacing for line 7.  Set line into global
"RTN","PSUSUM7",61,0)
 ;
"RTN","PSUSUM7",62,0)
 S PSUTB3=" "
"RTN","PSUSUM7",63,0)
 S PSUTB4="TOTAL Pharmacy patients across all divisions:"
"RTN","PSUSUM7",64,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1))
"RTN","PSUSUM7",65,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM7",66,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)
"RTN","PSUSUM7",67,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1)
"RTN","PSUSUM7",68,0)
 S I=I+1
"RTN","PSUSUM7",69,0)
 Q
"RTN","PSUSUM7",70,0)
 ;
"RTN","PSUSUM7",71,0)
UNIQUE1 ;Find total unique pharmacy patients across all divisions when
"RTN","PSUSUM7",72,0)
 ;IV and RX extracts are run together
"RTN","PSUSUM7",73,0)
 ;
"RTN","PSUSUM7",74,0)
 S PSURXN=0,PSUIVN=0
"RTN","PSUSUM7",75,0)
 ;
"RTN","PSUSUM7",76,0)
 S N=1
"RTN","PSUSUM7",77,0)
 ;
"RTN","PSUSUM7",78,0)
 F  S PSURXN=$O(^XTMP("PSU_"_PSUJOB,"PSURXSSN",PSURXN)) Q:PSURXN=""  D
"RTN","PSUSUM7",79,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUTMP",PSURXN)=N S N=N+1
"RTN","PSUSUM7",80,0)
 .F  S PSUIVN=$O(^XTMP("PSU_"_PSUJOB,"PSUIVSSN",PSUIVN)) Q:PSUIVN=""  D
"RTN","PSUSUM7",81,0)
 ..I '$D(^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUIVN)) S ^XTMP("PSU_"_PSUJOB,"PSUTMP",PSUIVN)=N S N=N+1
"RTN","PSUSUM7",82,0)
 ;
"RTN","PSUSUM7",83,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL")=N-1
"RTN","PSUSUM7",84,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="TOTAL Pharmacy patients across all divisions:               "_$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL")),U,1) S I=I+1
"RTN","PSUSUM7",85,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM7",86,0)
 Q
"RTN","PSUSUM7",87,0)
 ;
"RTN","PSUSUM7",88,0)
TUDIV ;Calculate total inpatient count and tab spacing for 'Total
"RTN","PSUSUM7",89,0)
 ;INPATIENT (UD or IV)' line and set into message global
"RTN","PSUSUM7",90,0)
 ;
"RTN","PSUSUM7",91,0)
 N PSUTB3,PSUTB4,PSUTB5,PSUDT
"RTN","PSUSUM7",92,0)
 ;
"RTN","PSUSUM7",93,0)
 I '$D(PSUMOD(1)) D
"RTN","PSUSUM7",94,0)
 .S PSUDT=$P($G(^XTMP("PSU_"_PSUJOB,"PSUUDSSN")),U) D
"RTN","PSUSUM7",95,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")=PSUDT                 ;Total UD inpatient count
"RTN","PSUSUM7",96,0)
 ;
"RTN","PSUSUM7",97,0)
 I '$D(PSUMOD(2)) D
"RTN","PSUSUM7",98,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")=$P($G(^XTMP("PSU_"_PSUJOB,"PSUIVIN")),U,1)-1   ;Total IV inpatient count
"RTN","PSUSUM7",99,0)
 ;
"RTN","PSUSUM7",100,0)
 I '$G(^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")) S ^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")=0
"RTN","PSUSUM7",101,0)
 S PSUTB3=" "
"RTN","PSUSUM7",102,0)
 S PSUTB4="   Total INPATIENT (UD or IV):"
"RTN","PSUSUM7",103,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")),U,1))
"RTN","PSUSUM7",104,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM7",105,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)                ;Tab position
"RTN","PSUSUM7",106,0)
 ;
"RTN","PSUSUM7",107,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUUDIVTOT")),U,1) S I=I+1
"RTN","PSUSUM7",108,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUSUMA",I),"-",70)="" S I=I+1
"RTN","PSUSUM7",109,0)
 Q
"RTN","PSUSUM7",110,0)
 ;
"RTN","PSUSUM7",111,0)
IPDIV1 ;Find UD inpatient division totals
"RTN","PSUSUM7",112,0)
 ;
"RTN","PSUSUM7",113,0)
 S PSULBL=0
"RTN","PSUSUM7",114,0)
 N PSUTTL
"RTN","PSUSUM7",115,0)
 ;
"RTN","PSUSUM7",116,0)
 I $D(PSUMOD(2)) D           ;UD inpatients
"RTN","PSUSUM7",117,0)
 .F  S PSULBL=$O(^XTMP("PSU_"_PSUJOB,"PSUUDDIV",PSULBL)) Q:PSULBL=""  D
"RTN","PSUSUM7",118,0)
 ..S PSUTTL=$P($G(^XTMP("PSU_"_PSUJOB,"PSUUDDIV",PSULBL)),U,1)
"RTN","PSUSUM7",119,0)
 ..D TAB1^PSUSUM6
"RTN","PSUSUM7",120,0)
 ..D IPMSG
"RTN","PSUSUM7",121,0)
 Q
"RTN","PSUSUM7",122,0)
 ;
"RTN","PSUSUM7",123,0)
IPMSG ;Set UD inpatient division totals into message global
"RTN","PSUSUM7",124,0)
 ;
"RTN","PSUSUM7",125,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSULBL_" Division:"_PSUTB1_PSUTTL
"RTN","PSUSUM7",126,0)
 S I=I+1
"RTN","PSUSUM7",127,0)
 Q
"RTN","PSUSUM7",128,0)
 ;
"RTN","PSUSUM7",129,0)
IPDIV2 ;Calculate inpatient totals for IV divisions
"RTN","PSUSUM7",130,0)
 ;
"RTN","PSUSUM7",131,0)
 ;
"RTN","PSUSUM7",132,0)
 ;Construct a storage global containing unique IV inpatients
"RTN","PSUSUM7",133,0)
 ;per division 
"RTN","PSUSUM7",134,0)
 S PSUDV=0
"RTN","PSUSUM7",135,0)
 F  S PSUDV=$O(^XTMP("PSU_"_PSUJOB,"PSUDIV1",PSUDV)) Q:PSUDV=""  D
"RTN","PSUSUM7",136,0)
 .S PSUPT=0
"RTN","PSUSUM7",137,0)
 .F  S PSUPT=$O(^XTMP("PSU_"_PSUJOB,"PSUDIV1",PSUDV,PSUPT)) Q:PSUPT=""  D
"RTN","PSUSUM7",138,0)
 ..S PSUPT1=0
"RTN","PSUSUM7",139,0)
 ..F  S PSUPT1=$O(^XTMP("PSU_"_PSUJOB,"PSUIN1",PSUPT1)) Q:PSUPT1=""  D
"RTN","PSUSUM7",140,0)
 ...I PSUPT1=PSUPT S ^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUDV,PSUPT1)=""
"RTN","PSUSUM7",141,0)
 D IPDIV3
"RTN","PSUSUM7",142,0)
 Q
"RTN","PSUSUM7",143,0)
 ;
"RTN","PSUSUM7",144,0)
IPDIV3 ;Find unique inpatient count for each division
"RTN","PSUSUM7",145,0)
 S PSUCT1=0,PSUCT2=0,T=1
"RTN","PSUSUM7",146,0)
 ;
"RTN","PSUSUM7",147,0)
 F  S PSUCT1=$O(^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUCT1)) Q:PSUCT1=""  D
"RTN","PSUSUM7",148,0)
 .F  S PSUCT2=$O(^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUCT1,PSUCT2)) Q:PSUCT2=""  D
"RTN","PSUSUM7",149,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL1")=T S T=T+1    ;Total count
"RTN","PSUSUM7",150,0)
 ..I $D(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUCT1)) D
"RTN","PSUSUM7",151,0)
 ...S C=C+1
"RTN","PSUSUM7",152,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUCT1)=C
"RTN","PSUSUM7",153,0)
 ..I '$D(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUCT1)) D
"RTN","PSUSUM7",154,0)
 ...S C=1
"RTN","PSUSUM7",155,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUCT1)=C
"RTN","PSUSUM7",156,0)
 D DIVNUM
"RTN","PSUSUM7",157,0)
 D MSG
"RTN","PSUSUM7",158,0)
 Q
"RTN","PSUSUM7",159,0)
 ;
"RTN","PSUSUM7",160,0)
DIVNUM ;Set number of inpatients per division into summary message
"RTN","PSUSUM7",161,0)
 ;
"RTN","PSUSUM7",162,0)
 N PSUTB1,PSUTB2
"RTN","PSUSUM7",163,0)
 S N=1
"RTN","PSUSUM7",164,0)
 ;
"RTN","PSUSUM7",165,0)
 N PSUCT2
"RTN","PSUSUM7",166,0)
 S PSUDIVA1=0
"RTN","PSUSUM7",167,0)
 F  S PSUDIVA1=$O(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVA1)) Q:PSUDIVA1=""  D
"RTN","PSUSUM7",168,0)
 .S PSUCT2=$P($G(^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVA1)),U,1)
"RTN","PSUSUM7",169,0)
 .D TAB5
"RTN","PSUSUM7",170,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="     "_PSUDIVA1_" Division:"_PSUTB1_PSUCT2
"RTN","PSUSUM7",171,0)
 .S I=I+1
"RTN","PSUSUM7",172,0)
 Q
"RTN","PSUSUM7",173,0)
 ;
"RTN","PSUSUM7",174,0)
TAB5 ;Calculate tab spacing
"RTN","PSUSUM7",175,0)
 ;
"RTN","PSUSUM7",176,0)
 S PSUTB1=" "
"RTN","PSUSUM7",177,0)
 S PSUTB2=(59-$L(PSUCT2))-$L(PSUDIVA1)-10
"RTN","PSUSUM7",178,0)
 F S2=1:1:(PSUTB2-1) S PSUTB(S2)=" " D
"RTN","PSUSUM7",179,0)
 .S PSUTB1=PSUTB1_PSUTB(S2)                ;Tab position
"RTN","PSUSUM7",180,0)
 Q
"RTN","PSUSUM7",181,0)
 ;
"RTN","PSUSUM7",182,0)
TAB4 ;Calculate UD totals of all divisions and place in summary
"RTN","PSUSUM7",183,0)
 ;message
"RTN","PSUSUM7",184,0)
 ;
"RTN","PSUSUM7",185,0)
 S N=0,PSUMKER=0,R=1
"RTN","PSUSUM7",186,0)
 ;
"RTN","PSUSUM7",187,0)
 I $D(PSUMOD(2)) D
"RTN","PSUSUM7",188,0)
 .F  S PSUMKER=$O(^XTMP("PSU_"_PSUJOB,"PSUUDDIV",PSUMKER)) Q:PSUMKER=""  D
"RTN","PSUSUM7",189,0)
 ..S N=$P(^XTMP("PSU_"_PSUJOB,"PSUUDDIV",PSUMKER),U)+N
"RTN","PSUSUM7",190,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL1")=N                   ;Sum of all UD inpatients
"RTN","PSUSUM7",191,0)
 ;
"RTN","PSUSUM7",192,0)
 D MSG
"RTN","PSUSUM7",193,0)
 Q
"RTN","PSUSUM7",194,0)
 ;
"RTN","PSUSUM7",195,0)
MSG ;Final lines of message
"RTN","PSUSUM7",196,0)
 ;
"RTN","PSUSUM7",197,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUTOTAL1")) S ^XTMP("PSU_"_PSUJOB,"PSUTOTAL1")=0
"RTN","PSUSUM7",198,0)
 ;
"RTN","PSUSUM7",199,0)
 N PSUTB3,PSUTB4,PSUTB5
"RTN","PSUSUM7",200,0)
 ;
"RTN","PSUSUM7",201,0)
 S PSUTB3=" "
"RTN","PSUSUM7",202,0)
 S PSUTB4="     Inpatient Total of all Divisions:"
"RTN","PSUSUM7",203,0)
 S PSUTB5=(64-$L(PSUTB4))-$L($P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL1")),U,1))
"RTN","PSUSUM7",204,0)
 F S3=1:1:(PSUTB5-1) S PSUTB(S3)=" " D
"RTN","PSUSUM7",205,0)
 .S PSUTB3=PSUTB3_PSUTB(S3)                ;Tab position
"RTN","PSUSUM7",206,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="                                                          ----------" S I=I+1
"RTN","PSUSUM7",207,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)=PSUTB4_PSUTB3_$P($G(^XTMP("PSU_"_PSUJOB,"PSUTOTAL1")),U,1) S I=I+1
"RTN","PSUSUM7",208,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="" S I=I+1
"RTN","PSUSUM7",209,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="**PLEASE NOTE: Final TOTAL may not match sum of all SUBTOTALS.  A patient may" S I=I+1
"RTN","PSUSUM7",210,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="have been provided pharmacy services at more than one outpatient and/or" S I=I+1
"RTN","PSUSUM7",211,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",I)="inpatient division."
"RTN","PSUSUM7",212,0)
 Q
"RTN","PSUSUM7",213,0)
 ;
"RTN","PSUSUM7",214,0)
NODATA ;Summary report line to be sent if there is no data
"RTN","PSUSUM7",215,0)
 ;
"RTN","PSUSUM7",216,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",1)="PHARMACY UNIQUE PATIENTS REPORT"
"RTN","PSUSUM7",217,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",2)=" "
"RTN","PSUSUM7",218,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUSUMA",3)="No data to report"
"RTN","PSUSUM7",219,0)
 D PDSUM^PSUDEM5
"RTN","PSUSUM7",220,0)
 Q
"RTN","PSUTL")
0^96^B20235539
"RTN","PSUTL",1,0)
PSUTL ;BIR/PDW - Utilities for AR/WS extracts ;12 AUG 1999
"RTN","PSUTL",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUTL",3,0)
 ;
"RTN","PSUTL",4,0)
 ; Reference to DOLRO^%ZOSV supported by DBIA 2500
"RTN","PSUTL",5,0)
 ;
"RTN","PSUTL",6,0)
 ; Entry Points
"RTN","PSUTL",7,0)
 ;
"RTN","PSUTL",8,0)
 ; D GETS^PSUTL(,,,,)
"RTN","PSUTL",9,0)
 ; D GETM^PSUTL(,,,,)
"RTN","PSUTL",10,0)
 ; $$VAL^PSUTL(,,)
"RTN","PSUTL",11,0)
 ; $$VALI^PSUTL(,,)
"RTN","PSUTL",12,0)
 ; ---------------------
"RTN","PSUTL",13,0)
 ; D MOVEI^PSUTL("ref")    Moves @ref@(Fld,"I") Value to (Fld) node
"RTN","PSUTL",14,0)
 ; D MOVEMI^PSUTL("ref")   Moves @ref@(da,Fld,"I") value to (da,Fld) node
"RTN","PSUTL",15,0)
 ; ---------------------
"RTN","PSUTL",16,0)
 ; ---------------------
"RTN","PSUTL",17,0)
 ; Details & Parameters
"RTN","PSUTL",18,0)
 ; D GETS^PSUTL(,,,,)       Returns @root@(Field Number(s))    = Value(s)
"RTN","PSUTL",19,0)
 ;   Multiples NO
"RTN","PSUTL",20,0)
 ;
"RTN","PSUTL",21,0)
 ; D GETM^PSUTL(,,,,)       Returns @root@(DA,Field Number(s)) = Value(s)
"RTN","PSUTL",22,0)
 ;   Multiples YES & ONLY
"RTN","PSUTL",23,0)
 ;
"RTN","PSUTL",24,0)
 ; S X=$$VAL^PSUTL(,,)      X = External Value
"RTN","PSUTL",25,0)
 ; S X=$$VALI^PSUTL(,,)    X = Interanl Value
"RTN","PSUTL",26,0)
 ;
"RTN","PSUTL",27,0)
 ; [ Variables for Parameter Passing ]
"RTN","PSUTL",28,0)
 ; PSUFILE = file number or subfile number    as described in GETS^DIQ()
"RTN","PSUTL",29,0)
 ; PSUDA   = List or array of IENS        NOT as described in GETS^DIQ()
"RTN","PSUTL",30,0)
 ;
"RTN","PSUTL",31,0)
 ;   A .DA array or a list of IENS left to right as they are in the
"RTN","PSUTL",32,0)
 ;   global data arrays D0,D1,D2 as within a FM Global map
"RTN","PSUTL",33,0)
 ;   This Iens list can be constructed with variables.
"RTN","PSUTL",34,0)
 ;   Example: as reaching into file 200 division subfile 200.02
"RTN","PSUTL",35,0)
 ;            "DUZ,SITE"
"RTN","PSUTL",36,0)
 ;
"RTN","PSUTL",37,0)
 ; PSUDR   = DR string                         as described in GETS^DIQ()
"RTN","PSUTL",38,0)
 ; PSUROOT = closed array                      as described in GETS^DIQ()
"RTN","PSUTL",39,0)
 ; PSUFORM = format control                    as described in GETS^DIQ()
"RTN","PSUTL",40,0)
 ;
"RTN","PSUTL",41,0)
GETS(PSUFILE,PSUDA,PSUDR,PSUROOT,PSUFORM) ;
"RTN","PSUTL",42,0)
 ; Example S PSUSITE=6025
"RTN","PSUTL",43,0)
 ; D GETS^PSUTL(200.02,"DUZ,PSUSITE",".01","DIV")
"RTN","PSUTL",44,0)
 ; returns
"RTN","PSUTL",45,0)
 ; DIV(.01)="HINES DEVELOPMENT"
"RTN","PSUTL",46,0)
 ;
"RTN","PSUTL",47,0)
 N PSUIEN,DA
"RTN","PSUTL",48,0)
 I $D(PSUFILE),$D(PSUDA),$D(PSUDR),$D(PSUROOT)
"RTN","PSUTL",49,0)
 E  Q
"RTN","PSUTL",50,0)
 I '$D(PSUFORM) S PSUFORM=""
"RTN","PSUTL",51,0)
 D PARSE(PSUDA)
"RTN","PSUTL",52,0)
 S PSUIEN=$$IENS^DILF(.DA)
"RTN","PSUTL",53,0)
 K ^TMP("PSUDIQ",$J)
"RTN","PSUTL",54,0)
 D GETS^DIQ(PSUFILE,PSUIEN,PSUDR,PSUFORM,"^TMP(""PSUDIQ"",$J)")
"RTN","PSUTL",55,0)
 ;
"RTN","PSUTL",56,0)
 I $G(PSUMTUL) Q
"RTN","PSUTL",57,0)
 ;
"RTN","PSUTL",58,0)
 M @PSUROOT=^TMP("PSUDIQ",$J,PSUFILE,PSUIEN)
"RTN","PSUTL",59,0)
 K ^TMP("PSUDIQ",$J)
"RTN","PSUTL",60,0)
 Q
"RTN","PSUTL",61,0)
 ;
"RTN","PSUTL",62,0)
VAL(PSUFILE,PSUDA,PSUFLD) ; Returns External Value
"RTN","PSUTL",63,0)
 N PSUTMP
"RTN","PSUTL",64,0)
 I $D(PSUFILE),$D(PSUDA),$D(PSUFLD)
"RTN","PSUTL",65,0)
 E  Q ""
"RTN","PSUTL",66,0)
 D GETS(PSUFILE,PSUDA,PSUFLD,"PSUTMP")
"RTN","PSUTL",67,0)
 Q $G(PSUTMP(PSUFLD))
"RTN","PSUTL",68,0)
VALI(PSUFILE,PSUDA,PSUFLD) ; Returns Internal Value
"RTN","PSUTL",69,0)
 N PSUTMP
"RTN","PSUTL",70,0)
 I $D(PSUFILE),$D(PSUDA),$D(PSUFLD)
"RTN","PSUTL",71,0)
 E  Q ""
"RTN","PSUTL",72,0)
 D GETS(PSUFILE,PSUDA,PSUFLD,"PSUTMP","I")
"RTN","PSUTL",73,0)
 Q $G(PSUTMP(PSUFLD,"I"))
"RTN","PSUTL",74,0)
 ;
"RTN","PSUTL",75,0)
GETM(PSUFILE,PSUDA,PSUFLD,PSUROOT,PSUFORM) ;EP RETURN MULTIPLES
"RTN","PSUTL",76,0)
 ; PSUFILE is the immediate upper level file number of the one desired
"RTN","PSUTL",77,0)
 ; PSUDA is the "DO,D1,Dx .." IENS to get to the immediate upper level
"RTN","PSUTL",78,0)
 ; PSUFLD is the field notation for the multiple at the upper level
"RTN","PSUTL",79,0)
 ;   "3*"
"RTN","PSUTL",80,0)
 ;   appended with "^" and the list of fields ".01;.02;9.3;..."
"RTN","PSUTL",81,0)
 ;   resulting in "3*^.01;.02;9.3;..."
"RTN","PSUTL",82,0)
 ; PSUROOT is the target closed array reference
"RTN","PSUTL",83,0)
 ; PSUFORM is the format as in GET^DIQ
"RTN","PSUTL",84,0)
 ; return form is @PSUROOT@(da,fld)=VALUE
"RTN","PSUTL",85,0)
 ;
"RTN","PSUTL",86,0)
 ; example: pulls multiple divisions from file 200
"RTN","PSUTL",87,0)
 ; D GETM^PSUTL(200,DUZ,"16*^.01","DIV")
"RTN","PSUTL",88,0)
 ; Returns  DIV(578,.01) ="HINES, IL"
"RTN","PSUTL",89,0)
 ;          DIV(6020,.01)="HINES ISC"
"RTN","PSUTL",90,0)
 ;          DIV(6025,.01)="HINES DEVELOPMENT"
"RTN","PSUTL",91,0)
 ;        
"RTN","PSUTL",92,0)
 N PSUMTUL,PSUSUB,PSUDID
"RTN","PSUTL",93,0)
 I $D(PSUFILE),$D(PSUDA),$D(PSUFLD),$D(PSUROOT)
"RTN","PSUTL",94,0)
 E  Q
"RTN","PSUTL",95,0)
 S PSUMTUL=1
"RTN","PSUTL",96,0)
 I '$D(PSUFORM) S PSUFORM=""
"RTN","PSUTL",97,0)
 I PSUFLD'["^" Q
"RTN","PSUTL",98,0)
 K PSUFLDL
"RTN","PSUTL",99,0)
 S PSUFLDL=$P(PSUFLD,U,2),PSUFLD=$P(PSUFLD,U)
"RTN","PSUTL",100,0)
 I +PSUFLDL,+PSUFLD
"RTN","PSUTL",101,0)
 E  Q
"RTN","PSUTL",102,0)
 D FIELD^DID(PSUFILE,+PSUFLD,"","SPECIFIER","PSUDID")
"RTN","PSUTL",103,0)
 S PSUSUB=+PSUDID("SPECIFIER")
"RTN","PSUTL",104,0)
 D GETS(PSUFILE,PSUDA,PSUFLD,PSUROOT,PSUFORM)
"RTN","PSUTL",105,0)
 ; load multiple into target array
"RTN","PSUTL",106,0)
 S PSUIEN=0 F  S PSUIEN=$O(^TMP("PSUDIQ",$J,PSUSUB,PSUIEN))  Q:+PSUIEN'>0  M @PSUROOT@(+PSUIEN)=^TMP("PSUDIQ",$J,PSUSUB,PSUIEN)
"RTN","PSUTL",107,0)
 K ^TMP("PSUDIQ",$J)
"RTN","PSUTL",108,0)
 Q:'$D(PSUFLDL)
"RTN","PSUTL",109,0)
 ;
"RTN","PSUTL",110,0)
 ; process individual fields
"RTN","PSUTL",111,0)
 N I,FLD
"RTN","PSUTL",112,0)
 S FLD=+PSUFLDL,PSUFLDL(FLD)=0
"RTN","PSUTL",113,0)
 F I=2:1 S FLD=$P(PSUFLDL,";",I) Q:FLD'>0  S PSUFLDL(FLD)=""
"RTN","PSUTL",114,0)
 S PSUIEN=0 F  S PSUIEN=$O(@PSUROOT@(PSUIEN)) Q:PSUIEN'>0  D
"RTN","PSUTL",115,0)
 . S FLD=0
"RTN","PSUTL",116,0)
 . F  S FLD=$O(@PSUROOT@(PSUIEN,FLD)) Q:FLD'>0  I '$D(PSUFLDL(FLD)) K @PSUROOT@(PSUIEN,FLD)
"RTN","PSUTL",117,0)
 K PSUFLDL
"RTN","PSUTL",118,0)
 Q
"RTN","PSUTL",119,0)
PARSE(XBDA) ;PEP - parse DA literal into da array
"RTN","PSUTL",120,0)
 I XBDA="",$D(XBDA)=1 S DA=0 Q
"RTN","PSUTL",121,0)
 NEW D,I,J
"RTN","PSUTL",122,0)
 F I=1:1 S D(I)=$P(XBDA,",",I) Q:D(I)=""
"RTN","PSUTL",123,0)
 S I=I-1
"RTN","PSUTL",124,0)
 F J=0:1:I-1 S DA(J)=D(I-J)
"RTN","PSUTL",125,0)
 F J=0:1:I-1 F  Q:(DA(J)=+DA(J))  S DA(J)=@(DA(J)) S:DA(J)="" DA(J)=0
"RTN","PSUTL",126,0)
 S DA=DA(0)
"RTN","PSUTL",127,0)
 KILL DA(0)
"RTN","PSUTL",128,0)
 Q
"RTN","PSUTL",129,0)
MOVEI(PSUREF) ;EP Move @PSUREF@(Fld,"I") values to @PSUREF@(Fld)
"RTN","PSUTL",130,0)
 N PSUFLD
"RTN","PSUTL",131,0)
 S PSUFLD=0 F  S PSUFLD=$O(@PSUREF@(PSUFLD)) Q:PSUFLD'>0  S @PSUREF@(PSUFLD)=$G(@PSUREF@(PSUFLD,"I")) K @PSUREF@(PSUFLD,"I")
"RTN","PSUTL",132,0)
 Q
"RTN","PSUTL",133,0)
 ;
"RTN","PSUTL",134,0)
MOVEMI(PSUREF) ;EP Move @PSUREF@(da,Fld,"I") values to @PSUREF@(da,Fld)
"RTN","PSUTL",135,0)
 N PSUDA,PSUFLD
"RTN","PSUTL",136,0)
 S PSUDA=0 F  S PSUDA=$O(@PSUREF@(PSUDA)) Q:PSUDA'>0  D
"RTN","PSUTL",137,0)
 . S PSUFLD=0 F  S PSUFLD=$O(@PSUREF@(PSUDA,PSUFLD)) Q:PSUFLD'>0  S @PSUREF@(PSUDA,PSUFLD)=@PSUREF@(PSUDA,PSUFLD,"I") K @PSUREF@(PSUDA,PSUFLD,"I")
"RTN","PSUTL",138,0)
 Q
"RTN","PSUTL",139,0)
 ;
"RTN","PSUTL",140,0)
UPPER(PSUX) ;Convert lower case to upper case
"RTN","PSUTL",141,0)
 Q $TR(PSUX,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSUTL",142,0)
 ;
"RTN","PSUTL",143,0)
VARKILL ;PEP Kill variable PSU* namespace 
"RTN","PSUTL",144,0)
 ;Kills off all PSU Variables
"RTN","PSUTL",145,0)
 S X="^TMP(""PSUVAR"",$J,"
"RTN","PSUTL",146,0)
 D DOLRO^%ZOSV ; load symbols into ^TMP(,,var)=..
"RTN","PSUTL",147,0)
 ;   (preserve PSU,PSUXMY*)
"RTN","PSUTL",148,0)
 S X="" F  S X=$O(^TMP("PSUVAR",$J,X)) Q:X=""  I $E(X,1,3)="PSU",X'="PSU",($E(X,1,6)'="PSUXMY"),X'="PSUJOB" K @X
"RTN","PSUTL",149,0)
 K ^TMP("PSUVAR",$J)
"RTN","PSUTL",150,0)
 ;
"RTN","PSUTL",151,0)
 ;
"RTN","PSUTL1")
0^98^B3357438
"RTN","PSUTL1",1,0)
PSUTL1 ;BIR/CFL - Subroutines for PBMS Modules ;25 AUG 1998
"RTN","PSUTL1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUTL1",3,0)
 ;Reference to file #2 supported by DBIA #3301
"RTN","PSUTL1",4,0)
SECTN ;Service/Sections Array
"RTN","PSUTL1",5,0)
 S PSECT("AMBULATORY CARE")="AMB"
"RTN","PSUTL1",6,0)
 S PSECT("ANESTHESIOLOGY")="ANES"
"RTN","PSUTL1",7,0)
 S PSECT("CARDIOLOGY")="CV"
"RTN","PSUTL1",8,0)
 S PSECT("CLINICAL PHARMACY")="CPHAR"
"RTN","PSUTL1",9,0)
 S PSECT("DENTAL")="DDS"
"RTN","PSUTL1",10,0)
 S PSECT("INTERMEDIATE MEDICINE")="IM"
"RTN","PSUTL1",11,0)
 S PSECT("MEDICINE")="MED"
"RTN","PSUTL1",12,0)
 S PSECT("NEUROLOGY")="NEUR"
"RTN","PSUTL1",13,0)
 S PSECT("NUCLEAR MEDICINE")="NUM"
"RTN","PSUTL1",14,0)
 S PSECT("NURSING")="RN"
"RTN","PSUTL1",15,0)
 S PSECT("ORTHOPEDICS")="ORTHO"
"RTN","PSUTL1",16,0)
 S PSECT("PSYCHIATRY")="PSY"
"RTN","PSUTL1",17,0)
 S PSECT("RADIOLOGY")="RAD"
"RTN","PSUTL1",18,0)
 S PSECT("SURGERY")="SUR"
"RTN","PSUTL1",19,0)
 S PSECT("UROLOGY")="U"
"RTN","PSUTL1",20,0)
SECTNQ Q
"RTN","PSUTL1",21,0)
 ;
"RTN","PSUTL1",22,0)
PURGE ; remove outdated PSU namespace entries in ^XTMP
"RTN","PSUTL1",23,0)
 N PSUI,PSUPDT,PSUCDT
"RTN","PSUTL1",24,0)
 D NOW^%DTC
"RTN","PSUTL1",25,0)
 S PSUCDT=X
"RTN","PSUTL1",26,0)
 S PSUI="PSU"
"RTN","PSUTL1",27,0)
 F  S PSUI=$O(^XTMP(PSUI)) Q:$E(PSUI,1,3)'="PSU"  D
"RTN","PSUTL1",28,0)
 .S PSUPDT=$P($G(^XTMP(PSUI,0)),"^",1)
"RTN","PSUTL1",29,0)
 .I PSUPDT="" K ^XTMP(PSUI) Q
"RTN","PSUTL1",30,0)
 .I PSUPDT<PSUCDT K ^XTMP(PSUI) Q
"RTN","PSUTL1",31,0)
PURGEQ Q  ; purge complete
"RTN","PSUTL1",32,0)
 ;
"RTN","PSUTL1",33,0)
XMY ;EP Setup Mail Groups
"RTN","PSUTL1",34,0)
 ; PSUXMYH()  Mail Group for Hines Message and message to self/PBM group
"RTN","PSUTL1",35,0)
 ; PSUXMYS1() Mail Group for Summary 1 & No Data Messages
"RTN","PSUTL1",36,0)
 ; PSUXMYS2() Mail Group for Summary 2 Messages
"RTN","PSUTL1",37,0)
 ;S PSUPBMG=^XTMP("PSU_"_PSUJOB,"PSUPBMG")
"RTN","PSUTL1",38,0)
 ;
"RTN","PSUTL1",39,0)
 Q:$D(^XTMP("PSU_"_$G(PSUJOB),"PSUFLAG3"))
"RTN","PSUTL1",40,0)
 ;
"RTN","PSUTL1",41,0)
 ; Hines Group
"RTN","PSUTL1",42,0)
 I $G(PSUMASF) D
"RTN","PSUTL1",43,0)
 .S PSUXMYH("G.PSU PBM@CMOP-NAT.MED.VA.GOV")=""
"RTN","PSUTL1",44,0)
 I $G(PSUPBMG) S PSUXMYH("G.PSU PBM")=""   ;local PBM mail group
"RTN","PSUTL1",45,0)
 I $G(PSUDUZ) S PSUXMYH(PSUDUZ)=""         ;self
"RTN","PSUTL1",46,0)
 ;
"RTN","PSUTL1",47,0)
 ; Summary 1 Group and NO DATA message
"RTN","PSUTL1",48,0)
 S PSUXMYS1("G.PSU PBM")=""
"RTN","PSUTL1",49,0)
 I $G(PSUDUZ) S PSUXMYS1(PSUDUZ)=""
"RTN","PSUTL1",50,0)
 ;
"RTN","PSUTL1",51,0)
 ; Summary 2 Group
"RTN","PSUTL1",52,0)
 S PSUXMYS2("G.PSU PBM")=""
"RTN","PSUTL1",53,0)
 I $G(PSUDUZ) S PSUXMYS2(PSUDUZ)=""
"RTN","PSUTL1",54,0)
XMYQ Q
"RTN","PSUTL1",55,0)
 ;EXIT
"RTN","PSUTL1",56,0)
TESTPAT(DFN) ;EP SCREEN AGAINST TEST PATIENTS (RETURN=1 IF TEST)
"RTN","PSUTL1",57,0)
 Q:'DFN 0
"RTN","PSUTL1",58,0)
 D PID^VADPT
"RTN","PSUTL1",59,0)
 I VA("PID")["000-00" Q 1
"RTN","PSUTL1",60,0)
 Q $$VALI^PSUTL(2,DFN,.6)
"RTN","PSUTL1",61,0)
 ;
"RTN","PSUUD0")
0^99^B3192501
"RTN","PSUUD0",1,0)
PSUUD0 ;BIR/TJH,PDW;PBM UNIT DOSE CONTROL POINT;07/08/1998
"RTN","PSUUD0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD0",3,0)
EN ; Entry point for processing
"RTN","PSUUD0",4,0)
 ;
"RTN","PSUUD0",5,0)
 ;
"RTN","PSUUD0",6,0)
 D ^PSUUD1 ; Collect all data
"RTN","PSUUD0",7,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D
"RTN","PSUUD0",8,0)
 .D ^PSUUD3        ; Mail reports
"RTN","PSUUD0",9,0)
 .D EN^PSUUD7      ; Mail AMIS summary reports
"RTN","PSUUD0",10,0)
 ;
"RTN","PSUUD0",11,0)
 ;pt. demographics summary reports
"RTN","PSUUD0",12,0)
 D PULL^PSUCP
"RTN","PSUUD0",13,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUUD0",14,0)
 ;
"RTN","PSUUD0",15,0)
 I $D(PSUMOD(10)) D UDSSN^PSUDEM4   ;Provider extract
"RTN","PSUUD0",16,0)
 ;
"RTN","PSUUD0",17,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D
"RTN","PSUUD0",18,0)
 .I '$D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG")) D
"RTN","PSUUD0",19,0)
 ..D EN^PSUSUM3     ;UD PD summary
"RTN","PSUUD0",20,0)
 ..;
"RTN","PSUUD0",21,0)
 ..;IV/UD summary report
"RTN","PSUUD0",22,0)
 ..I $D(PSUMOD(2))&$D(PSUMOD(1))&'$D(PSUMOD(4)) D
"RTN","PSUUD0",23,0)
 ...D EN^PSUSUM5
"RTN","PSUUD0",24,0)
 ;
"RTN","PSUUD0",25,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")
"RTN","PSUUD0",26,0)
 D CLEAN
"RTN","PSUUD0",27,0)
 K UDAM,SPEC,AMIS,DOSE,DOSTOT,DIVTOT,GTOT
"RTN","PSUUD0",28,0)
 Q
"RTN","PSUUD0",29,0)
PRINT ; Entry point for printing function
"RTN","PSUUD0",30,0)
 D ^PSUUD5 ; Print summary reports
"RTN","PSUUD0",31,0)
 D CLEAN
"RTN","PSUUD0",32,0)
 Q
"RTN","PSUUD0",33,0)
 ;
"RTN","PSUUD0",34,0)
CLEAN ; clean up local symbol table
"RTN","PSUUD0",35,0)
 S XPSUOPTN=PSUOPTN,XPSUJOB=PSUJOB M XPSUMOD=PSUMOD
"RTN","PSUUD0",36,0)
 D VARKILL^PSUTL ; kill all PSU namespace variables
"RTN","PSUUD0",37,0)
 S PSUOPTN=XPSUOPTN,PSUJOB=XPSUJOB M PSUMOD=XPSUMOD K XPSUOPTN,XPSUJOB,XPSUMOD
"RTN","PSUUD0",38,0)
 K DADATE,DADRUG,DAHOW,DAMT,DASH,DFN,DIC,DLM,ENDIT,EXTD
"RTN","PSUUD0",39,0)
 K PSDATE,PSDOSE,PSECT,PSPAT,REC1,REC2,SPACES,X1,X2,Y,Z
"RTN","PSUUD0",40,0)
 D PULL^PSUCP,OPTS^PSUCP
"RTN","PSUUD0",41,0)
CLEANQ Q
"RTN","PSUUD1")
0^100^B18098577
"RTN","PSUUD1",1,0)
PSUUD1 ;BIR/TJH - PBM UNIT DOSE MODULE ;12 AUG 1999
"RTN","PSUUD1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD1",3,0)
 ;DBIA(s)
"RTN","PSUUD1",4,0)
 ; Reference to file #55  supported by DBIA 2497
"RTN","PSUUD1",5,0)
 ; Reference to file #7   supported by DBIA 2495
"RTN","PSUUD1",6,0)
 ; Reference to file #50  supported by DBIA 221
"RTN","PSUUD1",7,0)
 ; Reference to file #42  supported by DBIA 2440
"RTN","PSUUD1",8,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUUD1",9,0)
 ; Reference to file #200  supported by DBIA 10060
"RTN","PSUUD1",10,0)
 ; Reference to XUA4A72    supported by DBIA 1625
"RTN","PSUUD1",11,0)
 ;
"RTN","PSUUD1",12,0)
EN ; Entry point
"RTN","PSUUD1",13,0)
 ;
"RTN","PSUUD1",14,0)
 N PSUDOC1,PSUUDST
"RTN","PSUUD1",15,0)
 D SETUP^PSUUD2 ; set up various arrays, variables needed for processing
"RTN","PSUUD1",16,0)
 ;
"RTN","PSUUD1",17,0)
 ; loop thru AUD 'stop date' index
"RTN","PSUUD1",18,0)
 ; *34 |==>
"RTN","PSUUD1",19,0)
 S PSDATE=PSUSDT\1-.0001 ;use 1st date of scan for 'stop date'
"RTN","PSUUD1",20,0)
L1 S PSDATE=$O(^PS(55,"AUD",PSDATE))
"RTN","PSUUD1",21,0)
 I (PSDATE="") G STEP2
"RTN","PSUUD1",22,0)
 S PSPAT=0,PSUTEDT=PSUEDT\1+.2359
"RTN","PSUUD1",23,0)
L2 ; loop thru patient within date
"RTN","PSUUD1",24,0)
 S PSPAT=$O(^PS(55,"AUD",PSDATE,PSPAT))
"RTN","PSUUD1",25,0)
 ; <==| *34
"RTN","PSUUD1",26,0)
 G:PSPAT'?1.N L1
"RTN","PSUUD1",27,0)
 ; SCREEN OUT TEST PATIENTS
"RTN","PSUUD1",28,0)
 G:$$TESTPAT^PSUTL1(PSPAT) L2
"RTN","PSUUD1",29,0)
 S PSDOSE=0
"RTN","PSUUD1",30,0)
L3 ; loop thru unit dose entries within patient
"RTN","PSUUD1",31,0)
 S PSDOSE=$O(^PS(55,"AUD",PSDATE,PSPAT,PSDOSE))
"RTN","PSUUD1",32,0)
 G:PSDOSE'?1.N L2
"RTN","PSUUD1",33,0)
 I '$D(^PS(55,PSPAT,5,PSDOSE,11)) G L3 ;*34
"RTN","PSUUD1",34,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUHLD",PSDOSE)=""
"RTN","PSUUD1",35,0)
 K PSUDOSE
"RTN","PSUUD1",36,0)
 S XX=$$VALI^PSUTL(55.06,"PSPAT,PSDOSE",10) ;*34
"RTN","PSUUD1",37,0)
 I (XX\1)>PSUTEDT G L3  ;*34
"RTN","PSUUD1",38,0)
 ;
"RTN","PSUUD1",39,0)
 D GETS^PSUTL(55.06,"PSPAT,PSDOSE",".01;.5;1;9;10;26;34;68","PSUDOSE","I")
"RTN","PSUUD1",40,0)
 D MOVEI^PSUTL("PSUDOSE")
"RTN","PSUUD1",41,0)
 ;.01=order number, .5=patient ptr, 1=provider ptr, 9=original ward
"RTN","PSUUD1",42,0)
 ;10=start date/time, 26=schedule, 34=stop date/time, 68=last ward
"RTN","PSUUD1",43,0)
 S PSUUDST=PSUDOSE(34)\1
"RTN","PSUUD1",44,0)
 S PSUDOSE(10)=$P(PSUDOSE(10),".",1)
"RTN","PSUUD1",45,0)
 S DFN=PSUDOSE(.5) D PID^VADPT
"RTN","PSUUD1",46,0)
 S PSUSSN=$TR(VA("PID"),"^-","'")
"RTN","PSUUD1",47,0)
 I $G(PSUSSN) S ^XTMP("PSU_"_PSUJOB,"PSUTDFN",DFN,PSUSSN)=""
"RTN","PSUUD1",48,0)
 S PSUFACN=PSUSNDR,PSUX=$S($L(PSUDOSE(9)):PSUDOSE(9),1:PSUDOSE(68))
"RTN","PSUUD1",49,0)
 I $L(PSUX) D
"RTN","PSUUD1",50,0)
 .S PSUX1=$$VALI^PSUTL(42,PSUX,.015)
"RTN","PSUUD1",51,0)
 .I PSUX1'="" S PSUFACN=$$VALI^PSUTL(40.8,PSUX1,1)
"RTN","PSUUD1",52,0)
PROV ; collect provider data
"RTN","PSUUD1",53,0)
 S (PSUVCL,PSUVS1,PSUVS2)=""
"RTN","PSUUD1",54,0)
 S PSUVSSN=$$VALI^PSUTL(200,PSUDOSE(1),9)
"RTN","PSUUD1",55,0)
 I PSUVSSN="" S PSUVSSN=999999999
"RTN","PSUUD1",56,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUVSSN,PSUDOSE(1))=""
"RTN","PSUUD1",57,0)
 S PSUDOC(9)=PSUVSSN
"RTN","PSUUD1",58,0)
 ;
"RTN","PSUUD1",59,0)
 S PSUVCP=$$VALI^PSUTL(200,PSUDOSE(1),53.5) ; class pointer
"RTN","PSUUD1",60,0)
 I PSUVCP'="" D
"RTN","PSUUD1",61,0)
 .S PSUVCL=$$VALI^PSUTL(7,PSUVCP,1)
"RTN","PSUUD1",62,0)
 .I PSUVCL="" S PSUVCL=$$VALI^PSUTL(7,PSUVCP,.01)
"RTN","PSUUD1",63,0)
 S PSUVSV=$$VAL^PSUTL(200,PSUDOSE(1),29) ; points to # 49,.01
"RTN","PSUUD1",64,0)
 S PSUVSVX=$$UPPER^PSUTL(PSUVSV),PSUVSV=""
"RTN","PSUUD1",65,0)
 I $L(PSUVSVX),$D(PSECT(PSUVSVX)) S PSUVSV=PSECT(PSUVSVX) ; convert to abbrev. if found in list.
"RTN","PSUUD1",66,0)
 S PSUSPSTR=$$GET^XUA4A72(PSUDOSE(1),PSDATE)
"RTN","PSUUD1",67,0)
 S PSUVS1=$P(PSUSPSTR,U,3),PSUVS2=$P(PSUSPSTR,U,4)
"RTN","PSUUD1",68,0)
 K PSUDAS D DISAMT^PSUUD2 ; set up dispensed amount summary array PSUDAS ;*34
"RTN","PSUUD1",69,0)
 D TMPUD^PSUUD2 ; store Unit Dose info in REC1
"RTN","PSUUD1",70,0)
DISD ; Dispense Drug 55.06,2 Mult --> 55.07 ^PS(55,PAT,5,DOSE,1,DISP,0)
"RTN","PSUUD1",71,0)
 S PSUDDX=0
"RTN","PSUUD1",72,0)
DISDL1 S PSUDDX=$O(^PS(55,PSPAT,5,PSDOSE,1,PSUDDX)) G:PSUDDX'?1.N DISDX
"RTN","PSUUD1",73,0)
 ;
"RTN","PSUUD1",74,0)
 D GETS^PSUTL(55.07,"PSPAT,PSDOSE,PSUDDX",".01;.02;.03","PSUDISD","I")
"RTN","PSUUD1",75,0)
 ; .01 = drug pointer, .02 = units per dose, .03 = inactive date
"RTN","PSUUD1",76,0)
 D MOVEI^PSUTL("PSUDISD")
"RTN","PSUUD1",77,0)
 I $G(PSUDISD(.01))="" G DISDL1 ; missing data, go back and try another
"RTN","PSUUD1",78,0)
 I $L(PSUDISD(.03)),PSUDISD(.03)<PSUSDT G DISDL1
"RTN","PSUUD1",79,0)
 ;
"RTN","PSUUD1",80,0)
 ;
"RTN","PSUUD1",81,0)
 S:PSUDISD(.02)="" PSUDISD(.02)=1 ; default to 1 if not filled per Lina B.
"RTN","PSUUD1",82,0)
 D GETS^PSUTL(50,PSUDISD(.01),".01;2;14.5;16;20;21;22;25;31;51;52;3","PSUDRUG","I")
"RTN","PSUUD1",83,0)
 I '$D(PSUDRUG) F I=.01,2,14.5,16,20,21,22,25,31,51,52,3 S PSUDRUG(I,"I")=""
"RTN","PSUUD1",84,0)
 D MOVEI^PSUTL("PSUDRUG")
"RTN","PSUUD1",85,0)
 I PSUDRUG(.01)="" S PSUDRUG(.01)="Unknown Generic Name"
"RTN","PSUUD1",86,0)
 I PSUDRUG(21)="" S PSUDRUG(21)="Unknown VA Product Name"
"RTN","PSUUD1",87,0)
 I PSUDRUG(31)="" S PSUDRUG(31)="No NDC"
"RTN","PSUUD1",88,0)
 I PSUDRUG(51)=1 S PSUDRUG(51)="N/F"
"RTN","PSUUD1",89,0)
 I PSUDRUG(52) S PSUDRUG(52)="N/F"
"RTN","PSUUD1",90,0)
 S PSUDNFI="",PSUDNFR="" ; National Formulary Indicator & Restriction
"RTN","PSUUD1",91,0)
 I $$VERSION^XPDUTL("PSN")'<4 D  ; check for v.4 or greater of NDF
"RTN","PSUUD1",92,0)
 .S PSUDNFI=$$FORMI^PSNAPIS(PSUDRUG(20),PSUDRUG(22))
"RTN","PSUUD1",93,0)
 .S PSUDNFR=$$FORMR^PSNAPIS(PSUDRUG(20),PSUDRUG(22))
"RTN","PSUUD1",94,0)
 D TMPDD^PSUUD2 ; store dispense drug data in ^XTMP global
"RTN","PSUUD1",95,0)
 D LAB^PSULR0("UD",PSUFACN,PSUDOSE(.01),PSUDOSE(.5),PSUDRUG(.01),PSUDRUG(2))
"RTN","PSUUD1",96,0)
 G DISDL1
"RTN","PSUUD1",97,0)
DISDX ; end of dispense drug, go back for next one.
"RTN","PSUUD1",98,0)
 G L3
"RTN","PSUUD1",99,0)
 ;
"RTN","PSUUD1",100,0)
STEP2 ; done with data collection, go back to ^PSUUD0
"RTN","PSUUD1",101,0)
 Q
"RTN","PSUUD2")
0^101^B20903599
"RTN","PSUUD2",1,0)
PSUUD2 ;BIR/TJH - PBM UNIT DOSE SUBROUTINES & FUNCTIONS ;24 DEC 2003
"RTN","PSUUD2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD2",3,0)
 ;DBIA(s)
"RTN","PSUUD2",4,0)
 ; Reference to file #55  supported by DBIA 2497
"RTN","PSUUD2",5,0)
 ;
"RTN","PSUUD2",6,0)
DISAMT ; precompute dispensed amounts by drug
"RTN","PSUUD2",7,0)
 N DADATE,DADRUG,DAMT,DAHOW
"RTN","PSUUD2",8,0)
 K PSUDAS ; initialize Dispensed Amount Summary array
"RTN","PSUUD2",9,0)
 ;*34 |=>
"RTN","PSUUD2",10,0)
 S PSUXX=PSUSDT\1-.0001
"RTN","PSUUD2",11,0)
DAL134 S PSUXX=$O(^PS(55,PSPAT,5,PSDOSE,11,"B",PSUXX))
"RTN","PSUUD2",12,0)
 G:'PSUXX DISAMTQ
"RTN","PSUUD2",13,0)
 I PSUXX>PSUTEDT G DISAMTQ
"RTN","PSUUD2",14,0)
 S DISPDA=0
"RTN","PSUUD2",15,0)
 F  S DISPDA=$O(^PS(55,PSPAT,5,PSDOSE,11,"B",PSUXX,DISPDA)) Q:DISPDA'>0  D
"RTN","PSUUD2",16,0)
 . K DISPI
"RTN","PSUUD2",17,0)
 . D GETS^PSUTL(55.0611,"PSPAT,PSDOSE,DISPDA",".01;.02;.03;.05","DISPI","I")
"RTN","PSUUD2",18,0)
 . D MOVEI^PSUTL("DISPI")
"RTN","PSUUD2",19,0)
 . S DADATE=DISPI(.01)
"RTN","PSUUD2",20,0)
 . S DADRUG=$G(DISPI(.02)) G:DADRUG="" DAL134
"RTN","PSUUD2",21,0)
 . S DAMT=$G(DISPI(.03))
"RTN","PSUUD2",22,0)
 . S DAHOW=$G(DISPI(.05))
"RTN","PSUUD2",23,0)
 . S PSUDAS(DADRUG)=$G(PSUDAS(DADRUG))+$S(DAHOW=4:DAMT*-1,1:DAMT)  ;net
"RTN","PSUUD2",24,0)
 . I DAHOW'=4 D
"RTN","PSUUD2",25,0)
 ..S PSUDAS("DISP",DADRUG)=$G(PSUDAS("DISP",DADRUG))+$G(DAMT)   ;Dispense
"RTN","PSUUD2",26,0)
 . I DAHOW=4 D
"RTN","PSUUD2",27,0)
 ..S PSUDAS("RET",DADRUG)=$G(PSUDAS("RET",DADRUG))+$G(DAMT)   ;Return
"RTN","PSUUD2",28,0)
 . S PSUDAS("NET",DADRUG)=$G(PSUDAS("DISP",DADRUG))-$G(PSUDAS("RET",DADRUG))   ;Net dispensed
"RTN","PSUUD2",29,0)
 .;
"RTN","PSUUD2",30,0)
 . K DISPI
"RTN","PSUUD2",31,0)
 G DAL134
"RTN","PSUUD2",32,0)
 ;*34 <=|
"RTN","PSUUD2",33,0)
DISAMTQ K ^TMP($J,"PSUTA") Q  ; exit point from DISAMT subroutine
"RTN","PSUUD2",34,0)
 ;
"RTN","PSUUD2",35,0)
SETUP ; set up some variables required later
"RTN","PSUUD2",36,0)
 D SECTN^PSUTL1
"RTN","PSUUD2",37,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUUD2",38,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUUD2",39,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUUD2",40,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUUD2",41,0)
 S X1=PSUSDT,X2=-101
"RTN","PSUUD2",42,0)
 D C^%DTC K %,%H,%T
"RTN","PSUUD2",43,0)
 S PSDATE=X
"RTN","PSUUD2",44,0)
 S PSUEDTIM=PSUEDT+.2400
"RTN","PSUUD2",45,0)
 S PSUJOB=$G(PSUJOB,$J),PSUUDSUB="PSUUD_"_PSUJOB
"RTN","PSUUD2",46,0)
 K ^XTMP(PSUUDSUB)
"RTN","PSUUD2",47,0)
 K PSUDTLRN
"RTN","PSUUD2",48,0)
 S X1=DT,X2=3 D C^%DTC
"RTN","PSUUD2",49,0)
 S ^XTMP(PSUUDSUB,0)=X_U_DT_U_"PSU PBM UNIT DOSE STATISTICAL DATA"
"RTN","PSUUD2",50,0)
SETUPQ Q  ; exit from SETUP
"RTN","PSUUD2",51,0)
 ;
"RTN","PSUUD2",52,0)
TMPUD ; store Unit Dose data in first half of record, pieces 2-7
"RTN","PSUUD2",53,0)
 S DLM="^",REC1="^"
"RTN","PSUUD2",54,0)
 S REC1=REC1_$TR(PSUFACN,"^","'")_DLM_$TR(PSUDOSE(10),"^","'")_DLM_$TR(PSUDOSE(.01),"^","'")
"RTN","PSUUD2",55,0)
 S REC1=REC1_DLM_PSUSSN_DLM_$TR(PSUDOSE(26),"^","'")_DLM_PSUVSSN   ;_DLM_$TR(PSUVCL,"^","'")
"RTN","PSUUD2",56,0)
 ;S REC1=REC1_DLM_$TR(PSUVSV,"^","'")_DLM_$TR(PSUVS1,"^","'")_DLM_$TR(PSUVS2,"^","'")
"RTN","PSUUD2",57,0)
TMPUDQ Q  ; exit from TMPUD
"RTN","PSUUD2",58,0)
 ;
"RTN","PSUUD2",59,0)
TMPDD ; create Dispense Drug record and store in ^XTMP
"RTN","PSUUD2",60,0)
 N PSUDAMT S PSUDAMT=$G(PSUDAS(PSUDISD(.01)))
"RTN","PSUUD2",61,0)
 Q:'PSUDAMT  ; per Lina B., do not store if dispensed amount=0
"RTN","PSUUD2",62,0)
 S DLM="^",REC2="",PSUDTLRN(PSUFACN)=+$G(PSUDTLRN(PSUFACN))+1
"RTN","PSUUD2",63,0)
 S REC2=REC1_DLM_$TR(PSUDRUG(21),"^","'")_DLM_$TR(PSUDRUG(2),"^","'")_DLM
"RTN","PSUUD2",64,0)
 S REC2=REC2_$TR(PSUDRUG(.01),"^","'")_DLM_$TR(PSUDRUG(31),"^","'")_DLM
"RTN","PSUUD2",65,0)
 S REC2=REC2_PSUDRUG(51)_DLM_PSUDNFI_DLM_PSUDNFR_DLM
"RTN","PSUUD2",66,0)
 S REC2=REC2_$TR(PSUDISD(.02),"^","'")_DLM_$TR(PSUDRUG(14.5),"^","'")_DLM
"RTN","PSUUD2",67,0)
 S REC2=REC2_$TR(PSUDRUG(16),"^","'")_DLM_PSUDAMT_DLM_PSUDRUG(52)_DLM_PSUDRUG(3)_"^"
"RTN","PSUUD2",68,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUUD2",69,0)
 D ICN^PSUV1 S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUUD2",70,0)
 S REC2=REC2_$G(PSUPICN)_DLM_$G(PSUDOSE(1))_DLM_PSUUDST_DLM
"RTN","PSUUD2",71,0)
 ;
"RTN","PSUUD2",72,0)
 ;ADD AMIS DATA
"RTN","PSUUD2",73,0)
 N PSUDSP,PSURET
"RTN","PSUUD2",74,0)
 S PSUDSP=$G(PSUDAS("DISP",PSUDISD(.01)))
"RTN","PSUUD2",75,0)
 S ^XTMP(PSUUDSUB,"DISP",PSUFACN)=PSUDSP+$G(^XTMP(PSUUDSUB,"DISP",PSUFACN))
"RTN","PSUUD2",76,0)
 S PSURET=$G(PSUDAS("RET",PSUDISD(.01)))
"RTN","PSUUD2",77,0)
 S ^XTMP(PSUUDSUB,"RET",PSUFACN)=PSURET+$G(^XTMP(PSUUDSUB,"RET",PSUFACN))
"RTN","PSUUD2",78,0)
 S:'$G(PSURET) PSURET=0
"RTN","PSUUD2",79,0)
 S REC2=REC2_PSUDSP_DLM_PSURET_DLM
"RTN","PSUUD2",80,0)
 ;END AMIS DATA
"RTN","PSUUD2",81,0)
 ;
"RTN","PSUUD2",82,0)
 S ^XTMP(PSUUDSUB,"DETAIL",PSUFACN,PSUDTLRN(PSUFACN))=REC2
"RTN","PSUUD2",83,0)
 ; increase Unit Dose and Patient counts if not already counted
"RTN","PSUUD2",84,0)
 I '$D(^XTMP(PSUUDSUB,"ORD",PSUFACN,PSUDOSE(.01))) D
"RTN","PSUUD2",85,0)
 .S ^XTMP(PSUUDSUB,"ORD",PSUFACN,PSUDOSE(.01))=""
"RTN","PSUUD2",86,0)
 .S ^XTMP(PSUUDSUB,"ORD",PSUFACN)=1+$G(^XTMP(PSUUDSUB,"ORD",PSUFACN))
"RTN","PSUUD2",87,0)
 I '$D(^XTMP(PSUUDSUB,"SSN",PSUFACN,PSUSSN)) D
"RTN","PSUUD2",88,0)
 .S ^XTMP(PSUUDSUB,"SSN",PSUFACN,PSUSSN)=""
"RTN","PSUUD2",89,0)
 .S ^XTMP(PSUUDSUB,"SSN",PSUFACN)=1+$G(^XTMP(PSUUDSUB,"SSN",PSUFACN))
"RTN","PSUUD2",90,0)
 S PSUDIV=PSUFACN D GETDIV^PSUV3 I PSUDIVNM'="" D
"RTN","PSUUD2",91,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUDIVNM,PSUSSN)=""
"RTN","PSUUD2",92,0)
 I PSUDIVNM="" S ^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUDIV,PSUSSN)=""
"RTN","PSUUD2",93,0)
 ; and store totals by drug in ^TMP("PSUUD DRUG",$J,PSUFACN
"RTN","PSUUD2",94,0)
 I '$D(^XTMP(PSUUDSUB,"DRUG",PSUFACN,PSUDRUG(.01))) D
"RTN","PSUUD2",95,0)
 .S ^XTMP(PSUUDSUB,"DRUG",PSUFACN,PSUDRUG(.01))=0_U_PSUDRUG(16)_U_PSUDRUG(51)_U_PSUDNFI
"RTN","PSUUD2",96,0)
 S $P(^XTMP(PSUUDSUB,"DRUG",PSUFACN,PSUDRUG(.01)),U,1)=$P(^XTMP(PSUUDSUB,"DRUG",PSUFACN,PSUDRUG(.01)),U,1)+PSUDAMT
"RTN","PSUUD2",97,0)
 ; and store Summary totals
"RTN","PSUUD2",98,0)
 S ^XTMP(PSUUDSUB,"DIS",PSUFACN)=PSUDAMT+$G(^XTMP(PSUUDSUB,"DIS",PSUFACN))
"RTN","PSUUD2",99,0)
 S ^XTMP(PSUUDSUB,"CST",PSUFACN)=(PSUDRUG(16)*PSUDAMT)+$G(^XTMP(PSUUDSUB,"CST",PSUFACN))
"RTN","PSUUD2",100,0)
TMPDDQ Q  ; exit from TMPDD
"RTN","PSUUD3")
0^102^B14814763
"RTN","PSUUD3",1,0)
PSUUD3 ;BIR/TJH/,PDW - PBM UNIT DOSE OUTPUT ;25 AUG 1998
"RTN","PSUUD3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD3",3,0)
EN ;
"RTN","PSUUD3",4,0)
 ;
"RTN","PSUUD3",5,0)
NONE ; send "no data" message if nothing collected
"RTN","PSUUD3",6,0)
 I '$D(^XTMP(PSUUDSUB,"DETAIL")) D  Q
"RTN","PSUUD3",7,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUNONE","UD")=""
"RTN","PSUUD3",8,0)
 .S NONE=1
"RTN","PSUUD3",9,0)
 .K PSUXMY,^XTMP(PSUUDSUB,"RECORDS")
"RTN","PSUUD3",10,0)
 .M PSUXMY=PSUXMYS1
"RTN","PSUUD3",11,0)
 .I PSUMASF!PSUPBMG M PSUXMY=PSUXMYH
"RTN","PSUUD3",12,0)
 .S ^XTMP(PSUUDSUB,"RECORDS",PSUSNDR,1)="No data to report"
"RTN","PSUUD3",13,0)
 .D EN^PSUUD4(.PSUMSGT)
"RTN","PSUUD3",14,0)
 .S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUSNDR,PSUOPTN,"L")=0
"RTN","PSUUD3",15,0)
 .S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUSNDR,PSUOPTN,"M")=1
"RTN","PSUUD3",16,0)
NONEQ ; routine does not pass this point if "no data" due to Quit at NONE+1
"RTN","PSUUD3",17,0)
 ;
"RTN","PSUUD3",18,0)
MMFULL ; send full detail to Hines if Master File update was selected
"RTN","PSUUD3",19,0)
 K PSUXMY,^XTMP(PSUUDSUB,"RECORDS")
"RTN","PSUUD3",20,0)
 M PSUXMY=PSUXMYH
"RTN","PSUUD3",21,0)
 M ^XTMP(PSUUDSUB,"RECORDS")=^XTMP(PSUUDSUB,"DETAIL")
"RTN","PSUUD3",22,0)
 D EN^PSUUD6    ;AMIS Summary report
"RTN","PSUUD3",23,0)
 I 'PSUSMRY D
"RTN","PSUUD3",24,0)
 .D EN^PSUUD4(.PSUMSGT)
"RTN","PSUUD3",25,0)
 .M ^XTMP("PSU_"_PSUJOB,"CONFIRM")=PSUMSGT
"RTN","PSUUD3",26,0)
 ;
"RTN","PSUUD3",27,0)
 ;
"RTN","PSUUD3",28,0)
MMSSUM ; statistical summary
"RTN","PSUUD3",29,0)
 N PSUUDFLG S PSUUDFLG=1         ;Flag for summary reports
"RTN","PSUUD3",30,0)
 S $P(SPACES," ",81)="",$P(DASH,"-",81)=""
"RTN","PSUUD3",31,0)
 K PSUXMY,^XTMP(PSUUDSUB,"RECORDS"),^XTMP(PSUUDSUB,"STATSUM")
"RTN","PSUUD3",32,0)
 M PSUXMY=PSUXMYS1
"RTN","PSUUD3",33,0)
 S PSUFACN=""
"RTN","PSUUD3",34,0)
 F  S PSUFACN=$O(^XTMP(PSUUDSUB,"DIS",PSUFACN)) Q:PSUFACN=""  D
"RTN","PSUUD3",35,0)
 .S PSUF2=$G(^XTMP(PSUUDSUB,"SSN",PSUFACN)) ; Total patients
"RTN","PSUUD3",36,0)
 .S PSUDIV=PSUFACN D GETDIV^PSUV3 I PSUDIVNM'="" D
"RTN","PSUUD3",37,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVNM)=PSUF2
"RTN","PSUUD3",38,0)
 .I PSUDIVNM="" S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIV)=PSUF2
"RTN","PSUUD3",39,0)
 ;
"RTN","PSUUD3",40,0)
MMDRUG ; summary by drug
"RTN","PSUUD3",41,0)
 K ^XTMP(PSUUDSUB,"RECORDS"),^XTMP(PSUUDSUB,"DRUGSUM")
"RTN","PSUUD3",42,0)
 Q:PSUSMRY        ;Don't print if user wants summary only
"RTN","PSUUD3",43,0)
 ;
"RTN","PSUUD3",44,0)
 K PSUXMY
"RTN","PSUUD3",45,0)
 M PSUXMY=PSUXMYS2
"RTN","PSUUD3",46,0)
 S PSUFACN=""
"RTN","PSUUD3",47,0)
 F  S PSUFACN=$O(^XTMP(PSUUDSUB,"DRUG",PSUFACN)) Q:PSUFACN=""  D
"RTN","PSUUD3",48,0)
 .S X="Unit Dose Statistical Data for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUUD3",49,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,1)=X
"RTN","PSUUD3",50,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,2)=" "
"RTN","PSUUD3",51,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,3)=" "
"RTN","PSUUD3",52,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,4)=$E(SPACES,1,50)_"Total"_$E(SPACES,1,11)_"Total"
"RTN","PSUUD3",53,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,5)=$E(SPACES,1,50)_"Dispensed"_$E(SPACES,1,7)_"Dispensed"
"RTN","PSUUD3",54,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,6)="Drug Name"_$E(SPACES,1,41)_"Units"_$E(SPACES,1,11)_"Cost"
"RTN","PSUUD3",55,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,7)=$E(DASH,1,75)
"RTN","PSUUD3",56,0)
 .S PSUX="",PSULN=7,PSUGTC=0,PSUGTU=0
"RTN","PSUUD3",57,0)
 .F  S PSUX=$O(^XTMP(PSUUDSUB,"DRUG",PSUFACN,PSUX)) Q:PSUX=""  D
"RTN","PSUUD3",58,0)
 ..S PSUR=^XTMP(PSUUDSUB,"DRUG",PSUFACN,PSUX)
"RTN","PSUUD3",59,0)
 ..S PSUTU=$P(PSUR,U,1),PSUPPU=$P(PSUR,U,2),PSUNON=$P(PSUR,U,3),PSUNFI=$P(PSUR,U,4)
"RTN","PSUUD3",60,0)
 ..S PSUTC=PSUTU*PSUPPU,PSUGTC=PSUGTC+PSUTC,PSUGTU=PSUGTU+PSUTU
"RTN","PSUUD3",61,0)
 ..S PSUDN=$E(PSUX,1,40)_" "_$S(PSUNON="N/F":"*",1:"")_$S(PSUNFI=0:"#",1:"")
"RTN","PSUUD3",62,0)
 ..S PSULN=PSULN+1
"RTN","PSUUD3",63,0)
 ..S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSULN)=$E(PSUDN_SPACES,1,45)_$J(PSUTU,12,2)_"    "_$J(PSUTC,12,2)
"RTN","PSUUD3",64,0)
 .S PSULN=PSULN+1
"RTN","PSUUD3",65,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSULN)=$E(DASH,1,75)
"RTN","PSUUD3",66,0)
 .S PSULN=PSULN+1
"RTN","PSUUD3",67,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSULN)="Totals:"_$E(SPACES,1,38)_$J(PSUGTU,12,2)_"    "_$J(PSUGTC,12,2)
"RTN","PSUUD3",68,0)
 .S PSULN=PSULN+1
"RTN","PSUUD3",69,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSULN)=" "
"RTN","PSUUD3",70,0)
 .S PSULN=PSULN+1
"RTN","PSUUD3",71,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSULN)="* Non-Formulary"
"RTN","PSUUD3",72,0)
 .S PSULN=PSULN+1
"RTN","PSUUD3",73,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSULN)="# Not on National Formulary"
"RTN","PSUUD3",74,0)
 M ^XTMP(PSUUDSUB,"RECORDS")=^XTMP(PSUUDSUB,"DRUGSUM")
"RTN","PSUUD3",75,0)
 D EN^PSUUD4(.PSUMSGT)
"RTN","PSUUD3",76,0)
 K ^XTMP(PSUUDSUB,"RECORDS")
"RTN","PSUUD3",77,0)
 ;
"RTN","PSUUD3",78,0)
 Q
"RTN","PSUUD4")
0^103^B6212281
"RTN","PSUUD4",1,0)
PSUUD4 ;BIR/TJH - PBM UNIT DOSE EMAIL GENERATOR ;10 JUL 1999
"RTN","PSUUD4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD4",3,0)
 ;DBIA(s)
"RTN","PSUUD4",4,0)
 ; Reference to file #4.3  supported by DBIA 2496,2596
"RTN","PSUUD4",5,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUUD4",6,0)
 ;
"RTN","PSUUD4",7,0)
 ;PSULC  = Line processing in ^tmp
"RTN","PSUUD4",8,0)
 ;PSUTLC = Total Line count
"RTN","PSUUD4",9,0)
 ;PSUMC  = Message counter
"RTN","PSUUD4",10,0)
 ;PSUMLC = Message Line Counter
"RTN","PSUUD4",11,0)
 ; RETURNS 
"RTN","PSUUD4",12,0)
 ;PSUMSG("M") = # Messages
"RTN","PSUUD4",13,0)
 ;PSUMSG("L") = # Lines
"RTN","PSUUD4",14,0)
 ;
"RTN","PSUUD4",15,0)
EN(PSUMSGT) ;Scan and process for Division(s)
"RTN","PSUUD4",16,0)
 ; PSUMSGT ("M")= # MESSAGES  ("L")= # LINES
"RTN","PSUUD4",17,0)
 ;
"RTN","PSUUD4",18,0)
 S PSUDIV=0,Z=0,PSUUDSUB="PSUUD_"_PSUJOB
"RTN","PSUUD4",19,0)
 F  S PSUDIV=$O(^XTMP(PSUUDSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUUD4",20,0)
 . D XMD^PSUUD4(.Z) ; ==> process one division
"RTN","PSUUD4",21,0)
 . S PSUMSGT(PSUDIV,PSUOPTN,"M")=$G(PSUMSGT(PSUDIV,PSUOPTN,"M"))+Z("M")
"RTN","PSUUD4",22,0)
 . S PSUMSGT(PSUDIV,PSUOPTN,"L")=$G(PSUMSGT(PSUDIV,PSUOPTN,"L"))+Z("L")
"RTN","PSUUD4",23,0)
 Q
"RTN","PSUUD4",24,0)
XMD(PSUMSG) ;EP returns PSUMSG("M")= # MESSAGES ("L")= # LINES
"RTN","PSUUD4",25,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUUD4",26,0)
 ; Scan TMP, split lines, transmit per MAX lines in Netmail
"RTN","PSUUD4",27,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUUD4",28,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUUD4",29,0)
 ;
"RTN","PSUUD4",30,0)
 ;   Split and store into ^XTMP(PSUUDSUB,"XMD",PSUMC,PSUMLC)
"RTN","PSUUD4",31,0)
 K ^XTMP(PSUUDSUB,"XMD")
"RTN","PSUUD4",32,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUUD4",33,0)
 F PSULC=1:1 S X=$G(^XTMP(PSUUDSUB,"RECORDS",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSUUD4",34,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUUD4",35,0)
 . I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUUD4",36,0)
 . I $L(X)<235 S ^XTMP(PSUUDSUB,"XMD",PSUMC,PSUMLC)=X Q
"RTN","PSUUD4",37,0)
 . F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUUD4",38,0)
 . S ^XTMP(PSUUDSUB,"XMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUUD4",39,0)
 . S PSUMLC=PSUMLC+1
"RTN","PSUUD4",40,0)
 . S ^XTMP(PSUUDSUB,"XMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUUD4",41,0)
 ;   Count Lines sent
"RTN","PSUUD4",42,0)
 S PSUTLC=0
"RTN","PSUUD4",43,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSUUDSUB,"XMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUUD4",44,0)
 ;   Transmit Messages
"RTN","PSUUD4",45,0)
VARS ; Setup variables for contents
"RTN","PSUUD4",46,0)
 ;
"RTN","PSUUD4",47,0)
 F PSUM=1:1:PSUMC D
"RTN","PSUUD4",48,0)
 . S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUUD4",49,0)
 . S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD4",50,0)
 . S ^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV)=PSUDIVNM
"RTN","PSUUD4",51,0)
 . I '$D(PSUUDFLG) S XMSUB="V. 4.0 PBMUD "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUUD4",52,0)
 . I $D(PSUUDFLG) S XMSUB="V. 4.0 PBMUD "_PSUMON_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUUD4",53,0)
 . S XMTEXT="^XTMP(PSUUDSUB,""XMD"",PSUM,"
"RTN","PSUUD4",54,0)
 . S XMDUZ=DUZ
"RTN","PSUUD4",55,0)
 . M XMY=PSUXMY
"RTN","PSUUD4",56,0)
 . S XMCHAN=1
"RTN","PSUUD4",57,0)
 . M XMY=PSUXMY
"RTN","PSUUD4",58,0)
 . I PSUMASF!PSUDUZ!PSUPBMG D ^XMD
"RTN","PSUUD4",59,0)
 ;
"RTN","PSUUD4",60,0)
 S PSUMSG("M")=PSUMC
"RTN","PSUUD4",61,0)
 S PSUMSG("L")=PSUTLC
"RTN","PSUUD4",62,0)
 Q
"RTN","PSUUD4",63,0)
 ;
"RTN","PSUUD5")
0^104^B14277220
"RTN","PSUUD5",1,0)
PSUUD5 ;BIR/REG - UNIT DOSE PRINTER MODULE ;10 JUL 1999
"RTN","PSUUD5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD5",3,0)
 ;DBIA(s)
"RTN","PSUUD5",4,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUUD5",5,0)
 ;
"RTN","PSUUD5",6,0)
 ;PRINT CYCLE CONTROLLER FOR UNIT DOSE SUMMARY REPORT
"RTN","PSUUD5",7,0)
 ;
"RTN","PSUUD5",8,0)
EP ;Print Unit Dose Statistical Report by Drug and Summary Report
"RTN","PSUUD5",9,0)
 ;Printing Device should be opened by PSUDBQUE by new & IO set
"RTN","PSUUD5",10,0)
 ;The ^XTMP global contains print lines by drug by division
"RTN","PSUUD5",11,0)
 ;Lines 1 through 7 are page heading lines for the summary by drug by
"RTN","PSUUD5",12,0)
 ;division; The Summary Report by division only is only 6 lines
"RTN","PSUUD5",13,0)
 ;Package variables are set by calling routine prior to call.
"RTN","PSUUD5",14,0)
 NEW PSUI,PSUH,PSUL,PSUM,PSUPGS,PSUUDFLG
"RTN","PSUUD5",15,0)
 S PSUUDFLG=1       ;Flag for summary reports
"RTN","PSUUD5",16,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUUD5",17,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUUD5",18,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUUD5",19,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUUD5",20,0)
 U IO
"RTN","PSUUD5",21,0)
 ;
"RTN","PSUUD5",22,0)
PRTSUMS ;
"RTN","PSUUD5",23,0)
 ; Find first Division/Facility in the summary by division
"RTN","PSUUD5",24,0)
 ; then DO the PRTALL routine
"RTN","PSUUD5",25,0)
 S PSUUDSUB="PSUUD_"_PSUJOB
"RTN","PSUUD5",26,0)
 ;
"RTN","PSUUD5",27,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D PRTAMIS  ;Print UD AMIS SUMMARY
"RTN","PSUUD5",28,0)
 ;
"RTN","PSUUD5",29,0)
 ; Find the first Division/Facility in the summary by drug by division
"RTN","PSUUD5",30,0)
 ; then DO the PRTDRUG routine
"RTN","PSUUD5",31,0)
 Q:PSUSMRY  ; 'summary only' was selected don't print 'by drug'
"RTN","PSUUD5",32,0)
 S PSUFACN=""
"RTN","PSUUD5",33,0)
 I '$D(^XTMP(PSUUDSUB,"DRUGSUM")) D
"RTN","PSUUD5",34,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUNONE1")=""
"RTN","PSUUD5",35,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUSNDR,1)="Unit Dose Statistical Data for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUUD5",36,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUSNDR,2)=" "
"RTN","PSUUD5",37,0)
 .S ^XTMP(PSUUDSUB,"DRUGSUM",PSUSNDR,3)="No data to report"
"RTN","PSUUD5",38,0)
 F  S PSUFACN=$O(^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN)) Q:PSUFACN=""  D PRTDRUG
"RTN","PSUUD5",39,0)
 ;
"RTN","PSUUD5",40,0)
 ;
"RTN","PSUUD5",41,0)
 D PULL^PSUCP
"RTN","PSUUD5",42,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUUD5",43,0)
 ;Print routine for Pt. demographics summary/No data when user selects
"RTN","PSUUD5",44,0)
 ;(1)IV and (2)UD
"RTN","PSUUD5",45,0)
 I $D(PSUMOD(1))&$D(PSUMOD(2)) D
"RTN","PSUUD5",46,0)
 .I '$D(PSUMOD(4)) D
"RTN","PSUUD5",47,0)
 ..D IVSUM^PSUDEM0
"RTN","PSUUD5",48,0)
 ;
"RTN","PSUUD5",49,0)
 ;Print routine for Pt. demographics summary/No data when user selects
"RTN","PSUUD5",50,0)
 ;(2)UD only
"RTN","PSUUD5",51,0)
 I $D(PSUMOD(2))&'$D(PSUMOD(1)) D
"RTN","PSUUD5",52,0)
 .I '$D(PSUMOD(4)) D
"RTN","PSUUD5",53,0)
 ..D IVSUM^PSUDEM0
"RTN","PSUUD5",54,0)
 ;
"RTN","PSUUD5",55,0)
PRTSUMX ; EXIT PSUUD5
"RTN","PSUUD5",56,0)
 ;W @IOF
"RTN","PSUUD5",57,0)
 Q 
"RTN","PSUUD5",58,0)
 ;
"RTN","PSUUD5",59,0)
PRTALL ; Print the Drug summary of all drugs by Division/Facility
"RTN","PSUUD5",60,0)
 S X=PSUFACN,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUUD5",61,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD5",62,0)
 W @IOF
"RTN","PSUUD5",63,0)
 F I=1:1:3 W !
"RTN","PSUUD5",64,0)
 S PSUL=""
"RTN","PSUUD5",65,0)
 F  S PSUL=$O(^XTMP(PSUUDSUB,"STATSUM",PSUFACN,PSUL)) Q:PSUL=""  D
"RTN","PSUUD5",66,0)
 .S X=^XTMP(PSUUDSUB,"STATSUM",PSUFACN,PSUL) W !,X
"RTN","PSUUD5",67,0)
 .I PSUL=1 W " for ",PSUDIVNM,!,?72,"PAGE:  1" ; will only ever be one page
"RTN","PSUUD5",68,0)
 Q
"RTN","PSUUD5",69,0)
 ;
"RTN","PSUUD5",70,0)
PRTAMIS ;Print UD AMIS summary
"RTN","PSUUD5",71,0)
 ;
"RTN","PSUUD5",72,0)
 S PSUPGS("PG")=0
"RTN","PSUUD5",73,0)
 D PGHDR1
"RTN","PSUUD5",74,0)
 S PSUL=3
"RTN","PSUUD5",75,0)
 F  S PSUL=$O(^XTMP("PSU_"_PSUJOB,"UDAMIS",PSUL)) Q:PSUL=""  D
"RTN","PSUUD5",76,0)
 .I LNCNT+4>IOSL D PGHDR1   ; leave a margin at the bottom
"RTN","PSUUD5",77,0)
 .W !,^XTMP("PSU_"_PSUJOB,"UDAMIS",PSUL)
"RTN","PSUUD5",78,0)
 .S LNCNT=LNCNT+1
"RTN","PSUUD5",79,0)
 ;
"RTN","PSUUD5",80,0)
 Q
"RTN","PSUUD5",81,0)
 ; 
"RTN","PSUUD5",82,0)
PRTDRUG ; Print the Drug summary by Drug by Division/Facility
"RTN","PSUUD5",83,0)
 ; Set page number to 0
"RTN","PSUUD5",84,0)
 S PSUPGS("PG")=0
"RTN","PSUUD5",85,0)
 S X=PSUFACN,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUUD5",86,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD5",87,0)
 D PGHDR ; Perform 1st page heading
"RTN","PSUUD5",88,0)
 S PSUL=7 ; Report body starts at line 8
"RTN","PSUUD5",89,0)
 F  S PSUL=$O(^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSUL)) Q:PSUL=""  D
"RTN","PSUUD5",90,0)
 .I $Y+4>IOSL D PGHDR ; leave a margin at the bottom
"RTN","PSUUD5",91,0)
 .W !,^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSUL)
"RTN","PSUUD5",92,0)
 ;
"RTN","PSUUD5",93,0)
 Q
"RTN","PSUUD5",94,0)
 ;
"RTN","PSUUD5",95,0)
PGHDR ;Increment page number and Write Page Heading
"RTN","PSUUD5",96,0)
 ; Writes header lines 1 & 2, then page number, then lines 3 through 7
"RTN","PSUUD5",97,0)
 U IO W @IOF
"RTN","PSUUD5",98,0)
 F I=1:1:3 W !
"RTN","PSUUD5",99,0)
 W !,^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,1) ;Print 1st line
"RTN","PSUUD5",100,0)
 W " for ",PSUDIVNM ; add division name
"RTN","PSUUD5",101,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUUD5",102,0)
 W !,^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,2),?72,"PAGE: ",PSUPGS("PG")
"RTN","PSUUD5",103,0)
 F PSUH=3:1:7 W !,$G(^XTMP(PSUUDSUB,"DRUGSUM",PSUFACN,PSUH))  ;Print next 5 lines  
"RTN","PSUUD5",104,0)
 Q
"RTN","PSUUD5",105,0)
 ;
"RTN","PSUUD5",106,0)
PGHDR1 ;Page headers for AMIS summary report
"RTN","PSUUD5",107,0)
 ;
"RTN","PSUUD5",108,0)
 U IO
"RTN","PSUUD5",109,0)
 W @IOF
"RTN","PSUUD5",110,0)
 W !,^XTMP("PSU_"_PSUJOB,"UDAMIS",1)
"RTN","PSUUD5",111,0)
 W !!,?68,"Page: ",PSUPGS("PG")
"RTN","PSUUD5",112,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUUD5",113,0)
 W !,$G(^XTMP("PSU_"_PSUJOB,"UDAMIS",2))
"RTN","PSUUD5",114,0)
 S LNCNT=3
"RTN","PSUUD5",115,0)
 Q
"RTN","PSUUD6")
0^105^B44396334
"RTN","PSUUD6",1,0)
PSUUD6 ;BIR/DAM - UD AMIS Summary Message I;23 MAR 2004
"RTN","PSUUD6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD6",3,0)
 ;
"RTN","PSUUD6",4,0)
 ;Reference to file #42.6 supported by DBIA 4597
"RTN","PSUUD6",5,0)
 ;Reference to file #42.7 supported by DBIA 4598
"RTN","PSUUD6",6,0)
 ;Reference to file #40.8 supported by DBIA 2438
"RTN","PSUUD6",7,0)
 ;
"RTN","PSUUD6",8,0)
EN ;Entry point to construct globals for AMIS summary message
"RTN","PSUUD6",9,0)
 ;Called from PSUUD3
"RTN","PSUUD6",10,0)
 ;
"RTN","PSUUD6",11,0)
 K UDAM      ;array to hold tabulated data
"RTN","PSUUD6",12,0)
 K SPEC      ;array to hold specialty data
"RTN","PSUUD6",13,0)
 ;
"RTN","PSUUD6",14,0)
 S PSUDV=0
"RTN","PSUUD6",15,0)
 F  S PSUDV=$O(^XTMP(PSUUDSUB,"DIS",PSUDV)) Q:PSUDV=""  D
"RTN","PSUUD6",16,0)
 .D DISP
"RTN","PSUUD6",17,0)
 .D RET
"RTN","PSUUD6",18,0)
 .D TCOST
"RTN","PSUUD6",19,0)
 .D NET
"RTN","PSUUD6",20,0)
 .D AVG
"RTN","PSUUD6",21,0)
 .D TRUNC
"RTN","PSUUD6",22,0)
 .D SPEC
"RTN","PSUUD6",23,0)
 .D DIVT
"RTN","PSUUD6",24,0)
 .D GRAND
"RTN","PSUUD6",25,0)
 ;
"RTN","PSUUD6",26,0)
 D TOTAL
"RTN","PSUUD6",27,0)
 ;
"RTN","PSUUD6",28,0)
 Q
"RTN","PSUUD6",29,0)
 ;
"RTN","PSUUD6",30,0)
DISP ;Add doses dispensed of all drugs for each division
"RTN","PSUUD6",31,0)
 ;
"RTN","PSUUD6",32,0)
 N DSP,A
"RTN","PSUUD6",33,0)
 S DSP=^XTMP(PSUUDSUB,"DISP",PSUDV)
"RTN","PSUUD6",34,0)
 S $P(UDAM(PSUDV),U,1)=DSP
"RTN","PSUUD6",35,0)
 ;
"RTN","PSUUD6",36,0)
 I $P(UDAM(PSUDV),U,1)["." D
"RTN","PSUUD6",37,0)
 .S A=$F($P(UDAM(PSUDV),U,1),".")  ;Find 1st position after decimal
"RTN","PSUUD6",38,0)
 .S $P(UDAM(PSUDV),U,1)=$E($P(UDAM(PSUDV),U,1),1,(A-2))  ;Truncate
"RTN","PSUUD6",39,0)
 ;
"RTN","PSUUD6",40,0)
 Q
"RTN","PSUUD6",41,0)
 ;
"RTN","PSUUD6",42,0)
RET ;Add doses returned of all drugs for each division
"RTN","PSUUD6",43,0)
 ;
"RTN","PSUUD6",44,0)
 N RET,A
"RTN","PSUUD6",45,0)
 S RET=^XTMP(PSUUDSUB,"RET",PSUDV)
"RTN","PSUUD6",46,0)
 S $P(UDAM(PSUDV),U,2)=RET
"RTN","PSUUD6",47,0)
 ;
"RTN","PSUUD6",48,0)
 I $P(UDAM(PSUDV),U,2)["." D
"RTN","PSUUD6",49,0)
 .S A=$F($P(UDAM(PSUDV),U,2),".")  ;Find 1st position after decimal
"RTN","PSUUD6",50,0)
 .S $P(UDAM(PSUDV),U,2)=$E($P(UDAM(PSUDV),U,2),1,(A-2))  ;Truncate
"RTN","PSUUD6",51,0)
 Q
"RTN","PSUUD6",52,0)
 ;
"RTN","PSUUD6",53,0)
NET ;Calculate Net doses dispensed of all drugs
"RTN","PSUUD6",54,0)
 ;
"RTN","PSUUD6",55,0)
 S $P(UDAM(PSUDV),U,3)=$P(UDAM(PSUDV),U,1)-$P(UDAM(PSUDV),U,2)
"RTN","PSUUD6",56,0)
 ;
"RTN","PSUUD6",57,0)
 Q
"RTN","PSUUD6",58,0)
 ;
"RTN","PSUUD6",59,0)
TCOST ;Find total cost per drug
"RTN","PSUUD6",60,0)
 ;
"RTN","PSUUD6",61,0)
 N CST,DP,RT,NT
"RTN","PSUUD6",62,0)
 ;
"RTN","PSUUD6",63,0)
 S CST=^XTMP(PSUUDSUB,"CST",PSUDV)    ;Price per dispensed unit
"RTN","PSUUD6",64,0)
 ;
"RTN","PSUUD6",65,0)
 S $P(UDAM(PSUDV),U,4)=CST
"RTN","PSUUD6",66,0)
 ;
"RTN","PSUUD6",67,0)
 Q
"RTN","PSUUD6",68,0)
 ;
"RTN","PSUUD6",69,0)
AVG ;Calculate average cost per dose
"RTN","PSUUD6",70,0)
 ;
"RTN","PSUUD6",71,0)
 N TCST,NET
"RTN","PSUUD6",72,0)
 ;
"RTN","PSUUD6",73,0)
 S NET=$P(UDAM(PSUDV),U,3)         ;Net doses dispensed
"RTN","PSUUD6",74,0)
 ;
"RTN","PSUUD6",75,0)
 I $G(NET)'>0 S NET=1
"RTN","PSUUD6",76,0)
 ;
"RTN","PSUUD6",77,0)
 S TCST=$P(UDAM(PSUDV),U,4)        ;Total cost
"RTN","PSUUD6",78,0)
 ;
"RTN","PSUUD6",79,0)
 S $P(UDAM(PSUDV),U,5)=$P($G(UDAM(PSUDV)),U,5)+(TCST/NET)
"RTN","PSUUD6",80,0)
 ;
"RTN","PSUUD6",81,0)
 Q
"RTN","PSUUD6",82,0)
 ;
"RTN","PSUUD6",83,0)
TRUNC ;Truncate pieces with dollar values to 2 decimal places
"RTN","PSUUD6",84,0)
 ;
"RTN","PSUUD6",85,0)
 F I=4:1:5 D
"RTN","PSUUD6",86,0)
 .N A,B,C
"RTN","PSUUD6",87,0)
 .;
"RTN","PSUUD6",88,0)
 .I $P(UDAM(PSUDV),U,I)'["." D  Q
"RTN","PSUUD6",89,0)
 ..S $P(UDAM(PSUDV),U,I)=$P(UDAM(PSUDV),U,4)_".00"
"RTN","PSUUD6",90,0)
 .;
"RTN","PSUUD6",91,0)
 .S A=$F($P(UDAM(PSUDV),U,I),".")  ;Find 1st position after decimal
"RTN","PSUUD6",92,0)
 .;
"RTN","PSUUD6",93,0)
 .S B=$E($P(UDAM(PSUDV),U,I),1,(A-1))  ;Extract dollars and decimal
"RTN","PSUUD6",94,0)
 .;
"RTN","PSUUD6",95,0)
 .S C=$E($P(UDAM(PSUDV),U,I),A,(A+1))  ;Extract cents after decimal
"RTN","PSUUD6",96,0)
 .;
"RTN","PSUUD6",97,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUUD6",98,0)
 .;
"RTN","PSUUD6",99,0)
 .S $P(UDAM(PSUDV),U,I)=B_C
"RTN","PSUUD6",100,0)
 ;
"RTN","PSUUD6",101,0)
 M ^XTMP(PSUUDSUB,"DOSES",PSUDV)=UDAM(PSUDV)
"RTN","PSUUD6",102,0)
 Q
"RTN","PSUUD6",103,0)
 ;
"RTN","PSUUD6",104,0)
TOTAL ;Add dose totals of all divisions
"RTN","PSUUD6",105,0)
 ;
"RTN","PSUUD6",106,0)
 N DTOT,RTOT,NETOT,TCST,ACST
"RTN","PSUUD6",107,0)
 ;
"RTN","PSUUD6",108,0)
 S PSUD=0
"RTN","PSUUD6",109,0)
 F  S PSUD=$O(UDAM(PSUD)) Q:PSUD=""  D
"RTN","PSUUD6",110,0)
 .S DTOT=$G(DTOT)+$P(UDAM(PSUD),U,1)       ;Total of doses dispensed
"RTN","PSUUD6",111,0)
 .S RTOT=$G(RTOT)+$P(UDAM(PSUD),U,2)       ;Total of returned doses
"RTN","PSUUD6",112,0)
 .S NETOT=$G(NETOT)+$P(UDAM(PSUD),U,3)     ;Total of net doses disp
"RTN","PSUUD6",113,0)
 .S TCST=$G(TCST)+$P(UDAM(PSUD),U,4)       ;Total of total cost
"RTN","PSUUD6",114,0)
 .;S ACST=$G(ACST)+$P(UDAM(PSUD),U,5)       ;Total of average cost
"RTN","PSUUD6",115,0)
 .I $G(NETOT) S ACST=$G(TCST)/$G(NETOT) D
"RTN","PSUUD6",116,0)
 ..I ACST'["." S ACST=ACST_".00" Q
"RTN","PSUUD6",117,0)
 ..N A,B,C
"RTN","PSUUD6",118,0)
 ..S A=$F(ACST,".")  ;Find 1st position after decimal
"RTN","PSUUD6",119,0)
 ..S B=$E(ACST,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUUD6",120,0)
 ..S C=$E(ACST,A,(A+1))   ;Extract cents after decimal
"RTN","PSUUD6",121,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUUD6",122,0)
 ..S ACST=B_C
"RTN","PSUUD6",123,0)
 ;
"RTN","PSUUD6",124,0)
 S ^XTMP(PSUUDSUB,"DOSTOT")=DTOT_U_RTOT_U_NETOT_U_TCST_U_ACST
"RTN","PSUUD6",125,0)
 ;
"RTN","PSUUD6",126,0)
 Q
"RTN","PSUUD6",127,0)
 ;
"RTN","PSUUD6",128,0)
SPEC ;Find out if a monthly extract is being run
"RTN","PSUUD6",129,0)
 ;
"RTN","PSUUD6",130,0)
 N PSUMT,PSUMTH
"RTN","PSUUD6",131,0)
 I $D(PSUMON) D
"RTN","PSUUD6",132,0)
 .S PSUMT=PSUMON_"00"
"RTN","PSUUD6",133,0)
 .I $D(^DGAM(334,"B",PSUMT)) D SPEC1
"RTN","PSUUD6",134,0)
 .;
"RTN","PSUUD6",135,0)
 .S PSUMTH=PSUMT
"RTN","PSUUD6",136,0)
 .I $D(^DGAM(345,"B",PSUMTH)) D SPEC2
"RTN","PSUUD6",137,0)
 ;
"RTN","PSUUD6",138,0)
 Q
"RTN","PSUUD6",139,0)
 ;
"RTN","PSUUD6",140,0)
SPEC1 ;Find division names from File (#42.6) records within
"RTN","PSUUD6",141,0)
 ;the month of the extract
"RTN","PSUUD6",142,0)
 ;
"RTN","PSUUD6",143,0)
 N PSUDNM
"RTN","PSUUD6",144,0)
 ;
"RTN","PSUUD6",145,0)
 M SPEC(334,PSUMT)=^DGAM(334,PSUMT)    ;set node into array
"RTN","PSUUD6",146,0)
 ;
"RTN","PSUUD6",147,0)
 S PSUD1=0
"RTN","PSUUD6",148,0)
 F  S PSUD1=$O(SPEC(334,PSUMT,"SE",PSUD1)) Q:PSUD1=""  D
"RTN","PSUUD6",149,0)
 .S PSUD2=0
"RTN","PSUUD6",150,0)
 .F  S PSUD2=$O(SPEC(334,PSUMT,"SE",PSUD1,"D",PSUD2)) Q:PSUD2=""  D
"RTN","PSUUD6",151,0)
 ..;find division and match to DIVNM
"RTN","PSUUD6",152,0)
 ..S X=PSUD2
"RTN","PSUUD6",153,0)
 ..S PSUNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD6",154,0)
 ..S X=PSUDV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUUD6",155,0)
 ..S X=+Y S PSUDNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD6",156,0)
 ..I PSUNM=PSUDNM D REC1
"RTN","PSUUD6",157,0)
 Q
"RTN","PSUUD6",158,0)
 ;
"RTN","PSUUD6",159,0)
REC1 ;Create a record of specialties and days of patient care for File #42.6
"RTN","PSUUD6",160,0)
 ;for each division within the month of the extract
"RTN","PSUUD6",161,0)
 ;
"RTN","PSUUD6",162,0)
 N SPC,DAYA,DAYB,SPCE
"RTN","PSUUD6",163,0)
 ;
"RTN","PSUUD6",164,0)
 S SPC=$P(SPEC(334,PSUMT,"SE",PSUD1,0),U,1)   ;Specialty code
"RTN","PSUUD6",165,0)
 ;
"RTN","PSUUD6",166,0)
 S DAYA=$P(SPEC(334,PSUMT,"SE",PSUD1,"D",PSUD2,0),U,12) ;Days of care
"RTN","PSUUD6",167,0)
 ;
"RTN","PSUUD6",168,0)
 S DAYB=$P(SPEC(334,PSUMT,"SE",PSUD1,"D",PSUD2,0),U,24) ;Days of care >45
"RTN","PSUUD6",169,0)
 ;
"RTN","PSUUD6",170,0)
 ;
"RTN","PSUUD6",171,0)
 ;Find external form of specialty
"RTN","PSUUD6",172,0)
 S:SPC=334 SPCE="PSYCHIATRY"
"RTN","PSUUD6",173,0)
 S:SPC=335 SPCE="INTERMEDIATE"
"RTN","PSUUD6",174,0)
 S:SPC=336 SPCE="MEDICINE"
"RTN","PSUUD6",175,0)
 S:SPC=337 SPCE="NEUROLOGY"
"RTN","PSUUD6",176,0)
 S:SPC=338 SPCE="REHAB MEDICINE"
"RTN","PSUUD6",177,0)
 S:SPC=339 SPCE="BLIND REHAB"
"RTN","PSUUD6",178,0)
 S:SPC=340 SPCE="SPINAL CORD INJURY"
"RTN","PSUUD6",179,0)
 S:SPC=341 SPCE="SURGERY"
"RTN","PSUUD6",180,0)
 ;
"RTN","PSUUD6",181,0)
 S ^XTMP(PSUUDSUB,"SPEC",PSUDV,SPC)=SPCE_U_(DAYA+DAYB)   ;Record created
"RTN","PSUUD6",182,0)
 ;
"RTN","PSUUD6",183,0)
 Q
"RTN","PSUUD6",184,0)
 ;
"RTN","PSUUD6",185,0)
SPEC2 ;Find division names from File (#42.7) records within
"RTN","PSUUD6",186,0)
 ;the month of the extract
"RTN","PSUUD6",187,0)
 ;
"RTN","PSUUD6",188,0)
 N PSUDNAM
"RTN","PSUUD6",189,0)
 M SPEC(345,PSUMTH)=^DGAM(345,PSUMTH)    ;set node into array
"RTN","PSUUD6",190,0)
 ;
"RTN","PSUUD6",191,0)
 S PSUD1=0
"RTN","PSUUD6",192,0)
 F  S PSUD1=$O(SPEC(345,PSUMTH,"SE",PSUD1)) Q:PSUD1=""  D
"RTN","PSUUD6",193,0)
 .S PSUD2=0
"RTN","PSUUD6",194,0)
 .F  S PSUD2=$O(SPEC(345,PSUMTH,"SE",PSUD1,"D",PSUD2)) Q:PSUD2=""  D
"RTN","PSUUD6",195,0)
 ..;find division and match to DIVNM
"RTN","PSUUD6",196,0)
 ..S X=PSUD2
"RTN","PSUUD6",197,0)
 ..S PSUNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD6",198,0)
 ..S X=PSUDV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUUD6",199,0)
 ..S X=+Y S PSUDNAM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD6",200,0)
 ..I PSUNM=PSUDNAM D REC2
"RTN","PSUUD6",201,0)
 ;
"RTN","PSUUD6",202,0)
 Q
"RTN","PSUUD6",203,0)
 ;
"RTN","PSUUD6",204,0)
REC2 ;Create a record of specialties and days of patient care for File #42.7
"RTN","PSUUD6",205,0)
 ;for each division within the month of the extract
"RTN","PSUUD6",206,0)
 ;
"RTN","PSUUD6",207,0)
 N SPC,DAY,SPCE
"RTN","PSUUD6",208,0)
 ;
"RTN","PSUUD6",209,0)
 S SPC=$P($G(SPEC(345,PSUMTH,"SE",PSUD1,0)),U,1)   ;Specialty code
"RTN","PSUUD6",210,0)
 ;
"RTN","PSUUD6",211,0)
 S DAY=$P($G(SPEC(345,PSUMTH,"SE",PSUD1,"D",PSUD2,0)),U,16) ;Days of care
"RTN","PSUUD6",212,0)
 ;
"RTN","PSUUD6",213,0)
 ;Find external form of specialty
"RTN","PSUUD6",214,0)
 S:SPC=345 SPCE="VA NURSING HOME"
"RTN","PSUUD6",215,0)
 ;
"RTN","PSUUD6",216,0)
 I $D(SPCE) D
"RTN","PSUUD6",217,0)
 .S ^XTMP(PSUUDSUB,"SPEC",PSUDV,SPC)=SPCE_U_DAY      ;Record created
"RTN","PSUUD6",218,0)
 Q
"RTN","PSUUD6",219,0)
 ;
"RTN","PSUUD6",220,0)
DIVT ;Calculate division totals
"RTN","PSUUD6",221,0)
 ;
"RTN","PSUUD6",222,0)
 N TOT
"RTN","PSUUD6",223,0)
 S PSUSP=0
"RTN","PSUUD6",224,0)
 F  S PSUSP=$O(^XTMP(PSUUDSUB,"SPEC",PSUDV,PSUSP)) Q:PSUSP=""  D
"RTN","PSUUD6",225,0)
 .S TOT=$G(TOT)+$P(^XTMP(PSUUDSUB,"SPEC",PSUDV,PSUSP),U,2)
"RTN","PSUUD6",226,0)
 .S ^XTMP(PSUUDSUB,"DIVTOT",PSUDV)=TOT
"RTN","PSUUD6",227,0)
 Q
"RTN","PSUUD6",228,0)
 ;
"RTN","PSUUD6",229,0)
GRAND ;Calculate grand total of all divisions
"RTN","PSUUD6",230,0)
 ;
"RTN","PSUUD6",231,0)
 ;
"RTN","PSUUD6",232,0)
 S ^XTMP(PSUUDSUB,"GTOT")=$G(^XTMP(PSUUDSUB,"GTOT"))+$G(^XTMP(PSUUDSUB,"DIVTOT",PSUDV))
"RTN","PSUUD6",233,0)
 ;
"RTN","PSUUD6",234,0)
 Q
"RTN","PSUUD7")
0^106^B23116886
"RTN","PSUUD7",1,0)
PSUUD7 ;BIR/DAM - UD AMIS Summary Message II;23 MAR 2004
"RTN","PSUUD7",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUUD7",3,0)
 ;
"RTN","PSUUD7",4,0)
 ;Reference to file #40.8 supported by DBIA 2438
"RTN","PSUUD7",5,0)
 ;
"RTN","PSUUD7",6,0)
EN ;Entry point for MailMan message
"RTN","PSUUD7",7,0)
 ;Called from PSUUD0
"RTN","PSUUD7",8,0)
 ;
"RTN","PSUUD7",9,0)
 K AMIS,DOSE,DOSTOT,SPEC,DIVTOT,GTOT    ;Kill arrays to hold data
"RTN","PSUUD7",10,0)
 ;
"RTN","PSUUD7",11,0)
 D MSG
"RTN","PSUUD7",12,0)
 F PSULN=PSULN:1:(PSULN+3) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUUD7",13,0)
 M ^XTMP("PSU_"_PSUJOB,"UDAMIS")=AMIS
"RTN","PSUUD7",14,0)
 D MAIL
"RTN","PSUUD7",15,0)
 ;
"RTN","PSUUD7",16,0)
 Q
"RTN","PSUUD7",17,0)
 ;
"RTN","PSUUD7",18,0)
MSG ;Set up lines in message
"RTN","PSUUD7",19,0)
 ;
"RTN","PSUUD7",20,0)
 S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUUD7",21,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUUD7",22,0)
 ;
"RTN","PSUUD7",23,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUUD7",24,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD7",25,0)
 S AMIS(1)="UD AMIS Summary for "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUUD7",26,0)
 ;
"RTN","PSUUD7",27,0)
 S AMIS(2)=""       ;Blank line
"RTN","PSUUD7",28,0)
 ;
"RTN","PSUUD7",29,0)
 S AMIS(3)="                                      NET"
"RTN","PSUUD7",30,0)
 ;
"RTN","PSUUD7",31,0)
 S AMIS(4)="                    DOSES   DOSES     DOSES     TOTAL     AVG COST"
"RTN","PSUUD7",32,0)
 ;
"RTN","PSUUD7",33,0)
 S AMIS(5)="DIVISION            DISP    RET       DISP      COST      PER DOSE"
"RTN","PSUUD7",34,0)
 ;
"RTN","PSUUD7",35,0)
 S $P(AMIS(6),"-",78)=""      ;Separator bar
"RTN","PSUUD7",36,0)
 ;
"RTN","PSUUD7",37,0)
 S PSULN=7
"RTN","PSUUD7",38,0)
 ;
"RTN","PSUUD7",39,0)
 D DOSE
"RTN","PSUUD7",40,0)
 ;
"RTN","PSUUD7",41,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUUD7",42,0)
 ;
"RTN","PSUUD7",43,0)
 D DOST
"RTN","PSUUD7",44,0)
 ;
"RTN","PSUUD7",45,0)
 F PSULN=PSULN:1:(PSULN+2) S AMIS(PSULN)=""       ;Blank lines
"RTN","PSUUD7",46,0)
 S PULN=PSULN+1
"RTN","PSUUD7",47,0)
 ;
"RTN","PSUUD7",48,0)
 S AMIS(PSULN)="Division                Specialty             Total Patient Days of Care"
"RTN","PSUUD7",49,0)
 ;
"RTN","PSUUD7",50,0)
 S PSULN=PSULN+1
"RTN","PSUUD7",51,0)
 ;
"RTN","PSUUD7",52,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUUD7",53,0)
 ;
"RTN","PSUUD7",54,0)
 D DIV      ;Calculate division data
"RTN","PSUUD7",55,0)
 D GTOT     ;Calculate grand totals
"RTN","PSUUD7",56,0)
 Q
"RTN","PSUUD7",57,0)
 ;
"RTN","PSUUD7",58,0)
DOSE ;Set doses into array and set data into message
"RTN","PSUUD7",59,0)
 ;
"RTN","PSUUD7",60,0)
 M DOSE=^XTMP(PSUUDSUB,"DOSES")
"RTN","PSUUD7",61,0)
 ;
"RTN","PSUUD7",62,0)
 S PSUDIV=0
"RTN","PSUUD7",63,0)
 F  S PSUDIV=$O(DOSE(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUUD7",64,0)
 .S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUUD7",65,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD7",66,0)
 .S PSULINE=""
"RTN","PSUUD7",67,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUUD7",68,0)
 .S $E(PSULINE,18,24)=$J($P(DOSE(PSUDIV),U,1),7)
"RTN","PSUUD7",69,0)
 .S $E(PSULINE,25,32)=$J($P(DOSE(PSUDIV),U,2),8)
"RTN","PSUUD7",70,0)
 .S $E(PSULINE,33,42)=$J($P(DOSE(PSUDIV),U,3),10)
"RTN","PSUUD7",71,0)
 .S $E(PSULINE,44,45)="$"
"RTN","PSUUD7",72,0)
 .S $E(PSULINE,46,53)=$J($P(DOSE(PSUDIV),U,4),8)
"RTN","PSUUD7",73,0)
 .S $E(PSULINE,57,58)="$"
"RTN","PSUUD7",74,0)
 .S $E(PSULINE,59,64)=$J($P(DOSE(PSUDIV),U,5),6)
"RTN","PSUUD7",75,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUUD7",76,0)
 Q
"RTN","PSUUD7",77,0)
 ;
"RTN","PSUUD7",78,0)
DOST ;Set dose totals into array and set into message
"RTN","PSUUD7",79,0)
 ;
"RTN","PSUUD7",80,0)
 M DOSTOT=^XTMP(PSUUDSUB,"DOSTOT")
"RTN","PSUUD7",81,0)
 I '$G(DOSTOT) S DOSTOT="0^0^0^0^0"
"RTN","PSUUD7",82,0)
 ;
"RTN","PSUUD7",83,0)
 S PSULINE=""
"RTN","PSUUD7",84,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUUD7",85,0)
 S $E(PSULINE,18,24)=$J($P(DOSTOT,U,1),7)
"RTN","PSUUD7",86,0)
 S $E(PSULINE,25,32)=$J($P(DOSTOT,U,2),8)
"RTN","PSUUD7",87,0)
 S $E(PSULINE,33,42)=$J($P(DOSTOT,U,3),10)
"RTN","PSUUD7",88,0)
 S $E(PSULINE,44,45)="$"
"RTN","PSUUD7",89,0)
 S $E(PSULINE,46,53)=$J($P(DOSTOT,U,4),8)
"RTN","PSUUD7",90,0)
 S $E(PSULINE,57,58)="$"
"RTN","PSUUD7",91,0)
 S $E(PSULINE,59,64)=$J($P(DOSTOT,U,5),6)
"RTN","PSUUD7",92,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUUD7",93,0)
 Q
"RTN","PSUUD7",94,0)
 ;
"RTN","PSUUD7",95,0)
DIV ;Set division data into array and create message
"RTN","PSUUD7",96,0)
 ;
"RTN","PSUUD7",97,0)
 M SPEC=^XTMP(PSUUDSUB,"SPEC")
"RTN","PSUUD7",98,0)
 ;
"RTN","PSUUD7",99,0)
 ;
"RTN","PSUUD7",100,0)
 S PSUDV=0
"RTN","PSUUD7",101,0)
 F  S PSUDV=$O(SPEC(PSUDV)) Q:PSUDV=""  D
"RTN","PSUUD7",102,0)
 .S X=PSUDV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUUD7",103,0)
 .S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD7",104,0)
 .S PSUSPC=0
"RTN","PSUUD7",105,0)
 .N C
"RTN","PSUUD7",106,0)
 .F  S PSUSPC=$O(SPEC(PSUDV,PSUSPC)) Q:PSUSPC=""  D
"RTN","PSUUD7",107,0)
 ..S PSULINE=""
"RTN","PSUUD7",108,0)
 ..I '$D(C) S $E(PSULINE,1,17)=PSUDIVNM S C=""
"RTN","PSUUD7",109,0)
 ..S $E(PSULINE,25,49)=$P(SPEC(PSUDV,PSUSPC),U,1)
"RTN","PSUUD7",110,0)
 ..S $E(PSULINE,50,59)=$J($P(SPEC(PSUDV,PSUSPC),U,2),10)
"RTN","PSUUD7",111,0)
 ..S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUUD7",112,0)
 .D DIVTOT
"RTN","PSUUD7",113,0)
 Q
"RTN","PSUUD7",114,0)
 ;
"RTN","PSUUD7",115,0)
DIVTOT ;Create message lines for division totals
"RTN","PSUUD7",116,0)
 ;
"RTN","PSUUD7",117,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar 
"RTN","PSUUD7",118,0)
 ;
"RTN","PSUUD7",119,0)
 S PSULINE=""
"RTN","PSUUD7",120,0)
 S $E(PSULINE,1,40)=PSUDIVNM_" Total"
"RTN","PSUUD7",121,0)
 S $E(PSULINE,50,59)=$J(^XTMP(PSUUDSUB,"DIVTOT",PSUDV),10)
"RTN","PSUUD7",122,0)
 S AMIS(PSULN)=PSULINE
"RTN","PSUUD7",123,0)
 ;
"RTN","PSUUD7",124,0)
 S PSULN=PSULN+1
"RTN","PSUUD7",125,0)
 ;
"RTN","PSUUD7",126,0)
 F PSULN=PSULN:1:(PSULN+2) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUUD7",127,0)
 S PSULN=PSULN+1
"RTN","PSUUD7",128,0)
 Q
"RTN","PSUUD7",129,0)
 ;
"RTN","PSUUD7",130,0)
GTOT ;Calculate grand total patient days of care for all divisions
"RTN","PSUUD7",131,0)
 ;
"RTN","PSUUD7",132,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUUD7",133,0)
 ;
"RTN","PSUUD7",134,0)
 S PSULINE=""
"RTN","PSUUD7",135,0)
 S $E(PSULINE,1,40)="Grand Total"
"RTN","PSUUD7",136,0)
 S $E(PSULINE,50,59)=$J($G(^XTMP(PSUUDSUB,"GTOT")),10)
"RTN","PSUUD7",137,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUUD7",138,0)
 ;
"RTN","PSUUD7",139,0)
 ;
"RTN","PSUUD7",140,0)
 Q
"RTN","PSUUD7",141,0)
 ;
"RTN","PSUUD7",142,0)
MAIL ;Send mailman message
"RTN","PSUUD7",143,0)
 ;
"RTN","PSUUD7",144,0)
 ;Do not send report if option selection includes 1,2,3,4,6
"RTN","PSUUD7",145,0)
 I $D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D  Q
"RTN","PSUUD7",146,0)
 .M ^XTMP("PSU_"_PSUJOB,"UDCOMBO")=AMIS
"RTN","PSUUD7",147,0)
 .S ^XTMP("PSU_"_PSUJOB,"UDCOMBO",1)="INPATIENT:"
"RTN","PSUUD7",148,0)
 ;
"RTN","PSUUD7",149,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUUD7",150,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUUD7",151,0)
 ;
"RTN","PSUUD7",152,0)
 S XMSUB="V. 4.0 PBMUD "_PSUMON_" "_PSUSNDR_" "_PSUDIVNM
"RTN","PSUUD7",153,0)
 S XMTEXT="AMIS("
"RTN","PSUUD7",154,0)
 S XMDUZ=DUZ
"RTN","PSUUD7",155,0)
 M XMY=PSUXMY
"RTN","PSUUD7",156,0)
 S XMCHAN=1
"RTN","PSUUD7",157,0)
 I PSUMASF!PSUDUZ!PSUPBMG D ^XMD
"RTN","PSUUD7",158,0)
 ;
"RTN","PSUUD7",159,0)
 Q
"RTN","PSUV0")
0^114^B3912066
"RTN","PSUV0",1,0)
PSUV0 ;BIR/CFL - Master Routine for PBMS IV Module; 09/09/1998
"RTN","PSUV0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV0",3,0)
EN S PSUJOB=$G(PSUJOB,$J),PSUIVSUB="PSUIV_"_PSUJOB
"RTN","PSUV0",4,0)
 S X1=PSUSDT,X2=-31
"RTN","PSUV0",5,0)
 D C^%DTC K %,%H,%T
"RTN","PSUV0",6,0)
 S PSUIVDT=X
"RTN","PSUV0",7,0)
 K ^XTMP(PSUIVSUB)
"RTN","PSUV0",8,0)
 S X1=DT,X2=6 D C^%DTC K %,%H,%T
"RTN","PSUV0",9,0)
 S ^XTMP(PSUIVSUB,0)=X_U_DT_U_"PSU PBM 'IV' STATISTICAL DATA"
"RTN","PSUV0",10,0)
 D SECTN^PSUTL1
"RTN","PSUV0",11,0)
 D ^PSUV1
"RTN","PSUV0",12,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D EN^PSUV3(.PSUARM)
"RTN","PSUV0",13,0)
 ;
"RTN","PSUV0",14,0)
 D PULL^PSUCP
"RTN","PSUV0",15,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUV0",16,0)
 ;
"RTN","PSUV0",17,0)
 I $D(PSUMOD(10)) D IVSSN^PSUDEM4   ;Provider extract
"RTN","PSUV0",18,0)
 ;
"RTN","PSUV0",19,0)
 ;Patient demographics IV summary report
"RTN","PSUV0",20,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D
"RTN","PSUV0",21,0)
 .I '$D(^XTMP("PSU_"_PSUJOB,"PSUMFLAG")) D EN^PSUSUM4
"RTN","PSUV0",22,0)
 ;
"RTN","PSUV0",23,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG1")
"RTN","PSUV0",24,0)
 ;
"RTN","PSUV0",25,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D EN^PSUV11
"RTN","PSUV0",26,0)
 D CLEAN
"RTN","PSUV0",27,0)
 Q
"RTN","PSUV0",28,0)
PRINT ;Print hard copies of summary reports
"RTN","PSUV0",29,0)
 S PSUIVSUB="PSUIV_"_PSUJOB
"RTN","PSUV0",30,0)
 D EN^PSUV5
"RTN","PSUV0",31,0)
 D CLEAN
"RTN","PSUV0",32,0)
 Q
"RTN","PSUV0",33,0)
 ;
"RTN","PSUV0",34,0)
CLEAN ; clean up local symbol table
"RTN","PSUV0",35,0)
 S XPSUOPTN=PSUOPTN,XPSUJOB=PSUJOB M XPSUMOD=PSUMOD
"RTN","PSUV0",36,0)
 D VARKILL^PSUTL ; kill all PSU namespace variables
"RTN","PSUV0",37,0)
 S PSUOPTN=XPSUOPTN,PSUJOB=XPSUJOB M PSUMOD=XPSUMOD K XPSUOPTN,XPSUJOB,XPSUMOD
"RTN","PSUV0",38,0)
 K ADTIV,COUNT,DASH,DATA,DFN,DIC,DLM,ENDIT,EXTD,GENRIC,I,INDEX,J,LINE,LNCNT,NONE,OCC
"RTN","PSUV0",39,0)
 K PSBAGS,PSDISP,PSECT,PSIVNFI,PSIVNFR,PSLN,PSNAME,REC,RECIND,RECTYP
"RTN","PSUV0",40,0)
 K SOLDA,SOLDRUG,SPECPTR,TYPE,VOLUME,X,X1,X2,Y,Z
"RTN","PSUV0",41,0)
 D PULL^PSUCP,OPTS^PSUCP
"RTN","PSUV0",42,0)
 K PSUIVA,PSUAMIS,LVP,PB,TPN,CH,SYR,AMIS
"RTN","PSUV0",43,0)
CLEANQ Q
"RTN","PSUV1")
0^115^B78186878
"RTN","PSUV1",1,0)
PSUV1 ;BIR/CFL - Extract Data of PBM IV Module ;25 AUG 1998
"RTN","PSUV1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV1",3,0)
 ;DBIAs
"RTN","PSUV1",4,0)
 ; Reference to file #55   supported by DBIA 2497
"RTN","PSUV1",5,0)
 ; Reference to file #59.5 supported by DBIA 2499
"RTN","PSUV1",6,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUV1",7,0)
 ; Reference to file #7    supported by DBIA 2495
"RTN","PSUV1",8,0)
 ; Reference to file #49   supported by DBIA 10093
"RTN","PSUV1",9,0)
 ; Reference to file #52.6 supported by DBIA 436
"RTN","PSUV1",10,0)
 ; Reference to file #50   supported by DBIA 221
"RTN","PSUV1",11,0)
 ; Reference to file #52.7 supported by DBIA 437
"RTN","PSUV1",12,0)
 ; Reference to file #2    supported by DBIA 10035 and 2701
"RTN","PSUV1",13,0)
 ; Reference to file #200  supported by DBIA 10060
"RTN","PSUV1",14,0)
 ;
"RTN","PSUV1",15,0)
IVDATA ;Loop through IV data
"RTN","PSUV1",16,0)
 N PSUDOC1
"RTN","PSUV1",17,0)
 K PSUSSNA,PSUORDA
"RTN","PSUV1",18,0)
 ; *34 |==>
"RTN","PSUV1",19,0)
 S PSUIVDT=PSUSDT\1-.0001 ;use 1st day of extract for 'stop date' scan
"RTN","PSUV1",20,0)
 S PSUTEDT=PSUEDT\1+.2359
"RTN","PSUV1",21,0)
 F  S PSUIVDT=$O(^PS(55,"AIV",PSUIVDT)) Q:'PSUIVDT  D
"RTN","PSUV1",22,0)
 .S PSUPDA=""
"RTN","PSUV1",23,0)
 .F  S PSUPDA=$O(^PS(55,"AIV",PSUIVDT,PSUPDA)) Q:'PSUPDA  D
"RTN","PSUV1",24,0)
 ..S PSUODA=""
"RTN","PSUV1",25,0)
 ..F  S PSUODA=$O(^PS(55,"AIV",PSUIVDT,PSUPDA,PSUODA)) Q:'PSUODA  D
"RTN","PSUV1",26,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUHLD",PSUODA)=""   ;should be the D0's for file 55.01 ; <==| *34
"RTN","PSUV1",27,0)
 ...S COUNT=0
"RTN","PSUV1",28,0)
 ...S PSUDIV=""
"RTN","PSUV1",29,0)
 ...K PSUIV
"RTN","PSUV1",30,0)
 ...; screen test patients
"RTN","PSUV1",31,0)
 ...Q:$$TESTPAT^PSUTL1(PSUPDA)
"RTN","PSUV1",32,0)
 ...S XX=$$VALI^PSUTL(55.01,"PSUPDA,PSUODA",.02) Q:XX>PSUTEDT  ;*34
"RTN","PSUV1",33,0)
 ...K PSUIV ;*34
"RTN","PSUV1",34,0)
 ...D GETS^PSUTL(55.01,"PSUPDA,PSUODA",".01;.02;.03;.04;.06;.08;.09;.22;104;106;108","PSUIV","I")
"RTN","PSUV1",35,0)
 ...;.01-Order num;.02-Start Dt;.03-Stop Dt;.04-Type;.06-Provider
"RTN","PSUV1",36,0)
 ...;104-Ward;106-Chemotherapy Type;108-Intermittent Syringe
"RTN","PSUV1",37,0)
 ...Q:'$D(PSUIV)
"RTN","PSUV1",38,0)
 ...;VMP OIFO BAY PINES;ELR;PSU*3*35 ADDED NEXT LINE
"RTN","PSUV1",39,0)
 ...Q:$G(PSUIV(.06,"I"))'>0
"RTN","PSUV1",40,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUPIEN",PSUPDA)=""     ;Patient IEN's ;*34
"RTN","PSUV1",41,0)
 ...D MOVEI^PSUTL("PSUIV")
"RTN","PSUV1",42,0)
 ...S PSUIV(.02)=PSUIV(.02)\1
"RTN","PSUV1",43,0)
 ...S PSUIV(.03)=PSUIV(.03)\1
"RTN","PSUV1",44,0)
 ...I PSUIV(.22)'="" S PSUDIV=$$VALI^PSUTL(59.5,PSUIV(.22),.02)
"RTN","PSUV1",45,0)
 ...S PSUFAC=$$VALI^PSUTL(40.8,PSUDIV,1) S:PSUFAC="" PSUFAC=PSUSNDR
"RTN","PSUV1",46,0)
 ...S PSUFAC(PSUFAC)=""
"RTN","PSUV1",47,0)
 ...S PSUOUTP=$S(PSUIV(104)=.5:"Y",1:"N")
"RTN","PSUV1",48,0)
 ...S DFN=PSUPDA D PID^VADPT
"RTN","PSUV1",49,0)
 ...S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUV1",50,0)
 ...D ICN
"RTN","PSUV1",51,0)
 ...K PSUDOC
"RTN","PSUV1",52,0)
 ...D GETS^PSUTL(200,"PSUIV(.06)","9;29;53.5","PSUDOC","I")
"RTN","PSUV1",53,0)
 ...D MOVEI^PSUTL("PSUDOC")
"RTN","PSUV1",54,0)
 ...I $G(PSUDOC(9))="" S PSUVSSN1=999999999
"RTN","PSUV1",55,0)
 ...I $G(PSUDOC(9))'="" S PSUVSSN1=PSUDOC(9)
"RTN","PSUV1",56,0)
 ...S ^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUVSSN1,PSUIV(.06))=""
"RTN","PSUV1",57,0)
 ...S (PSUPCLS,PSUSP1,PSUSP2)=""
"RTN","PSUV1",58,0)
 ...I $D(PSUDOC(53.5)),PSUDOC(53.5)'="" D
"RTN","PSUV1",59,0)
 ....S PSUPCLS=$$VALI^PSUTL(7,PSUDOC(53.5),1)
"RTN","PSUV1",60,0)
 ....I PSUPCLS="" S PSUPCLS=$$VALI^PSUTL(7,PSUDOC(53.5),.01)
"RTN","PSUV1",61,0)
 ...S PSUPSV=$S($L($G(PSUDOC(29))):$$VAL^PSUTL(49,PSUDOC(29),.01),1:"")
"RTN","PSUV1",62,0)
 ...S PSUPSV=$$UPPER^PSUTL(PSUPSV),PSUSERV=""
"RTN","PSUV1",63,0)
 ...I $L(PSUPSV),$D(PSECT(PSUPSV)) S PSUSERV=PSECT(PSUPSV)
"RTN","PSUV1",64,0)
 ...S SPECPTR=$$GET^XUA4A72(PSUIV(.06),PSUIVDT)
"RTN","PSUV1",65,0)
 ...S PSUSP1=$P($G(SPECPTR),U,3),PSUSP2=$P($G(SPECPTR),U,4)
"RTN","PSUV1",66,0)
 ...D OCCAMT
"RTN","PSUV1",67,0)
 ...I PSUFND D
"RTN","PSUV1",68,0)
 ....D GETRATE^PSUV2(PSUIV(.04))
"RTN","PSUV1",69,0)
 ....D SETTOT
"RTN","PSUV1",70,0)
 ....S RECTYP=""
"RTN","PSUV1",71,0)
 ....D ADDTIV
"RTN","PSUV1",72,0)
 ....D SOLUTN
"RTN","PSUV1",73,0)
 I $D(^XTMP(PSUIVSUB,"RECORDS")) D SETSUM^PSUV2
"RTN","PSUV1",74,0)
 Q
"RTN","PSUV1",75,0)
 ;
"RTN","PSUV1",76,0)
ICN ;Find patient ICN 
"RTN","PSUV1",77,0)
 ;
"RTN","PSUV1",78,0)
 N PSUPICN,PSUPICN1,PSUICN
"RTN","PSUV1",79,0)
 S PSUPTN=0
"RTN","PSUV1",80,0)
 I $G(PSUSSN),PSUSSN'="" D
"RTN","PSUV1",81,0)
 .F  S PSUPTN=$O(^DPT("SSN",PSUSSN,PSUPTN)) Q:PSUPTN=""  D
"RTN","PSUV1",82,0)
 ..S PSUPICN1=$$GETICN^MPIF001(PSUPTN) D
"RTN","PSUV1",83,0)
 ...I PSUPICN1'[-1 D
"RTN","PSUV1",84,0)
 ....S ^XTMP("PSU_"_PSUJOB,"PSUPICN")=PSUPICN1
"RTN","PSUV1",85,0)
 ...I PSUPICN1[-1 S ^XTMP("PSU_"_PSUJOB,"PSUPICN")=""
"RTN","PSUV1",86,0)
 Q
"RTN","PSUV1",87,0)
 ;
"RTN","PSUV1",88,0)
 ;
"RTN","PSUV1",89,0)
OCCAMT ;Calculate the number of dispensing occurrences
"RTN","PSUV1",90,0)
 S (PSUFND,PSUDISP,PSUPULL,OCC,PSUDISPT,PSURECT,PSUDEST,PSUCAN)=0
"RTN","PSUV1",91,0)
 F  S OCC=$O(^PS(55,PSUPDA,"IV",PSUODA,"LAB",OCC)) Q:'OCC  D
"RTN","PSUV1",92,0)
 .K PSUOCC
"RTN","PSUV1",93,0)
 .D GETS^PSUTL(55.1111,"PSUPDA,PSUODA,OCC","1;2;4;6","PSUOCC","I")
"RTN","PSUV1",94,0)
 .D MOVEI^PSUTL("PSUOCC")
"RTN","PSUV1",95,0)
 .S PSUOCC(1)=PSUOCC(1)\1
"RTN","PSUV1",96,0)
 .I PSUOCC(1)<PSUSDT!(PSUOCC(1)>PSUTEDT) Q  ;*34
"RTN","PSUV1",97,0)
 .S PSUFND=1
"RTN","PSUV1",98,0)
 .I $G(PSUOCC(6))=1,$G(PSUOCC(2))=1 D
"RTN","PSUV1",99,0)
 ..S PSUDISP=PSUDISP+$G(PSUOCC(4))
"RTN","PSUV1",100,0)
 ..S PSUDISPT=PSUDISP                        ;Total IV dispensed
"RTN","PSUV1",101,0)
 ..S PSUPULL=PSUPULL+$G(PSUOCC(4))
"RTN","PSUV1",102,0)
 ..S ^XTMP(PSUIVSUB,"TYPE_"_PSUIV(.04),PSUFAC)=PSUOCC(4)+$G(^XTMP(PSUIVSUB,"TYPE_"_PSUIV(.04),PSUFAC))
"RTN","PSUV1",103,0)
 ..I PSUOUTP="Y" D  ; Total outpatient IV's dispensed
"RTN","PSUV1",104,0)
 ...S ^XTMP(PSUIVSUB,"ODISP",PSUFAC)=$G(^XTMP(PSUIVSUB,"ODISP",PSUFAC))+PSUOCC(4)
"RTN","PSUV1",105,0)
 .;I PSUOCC(2)=2!(PSUOCC(2)=4) S PSUDISP=PSUDISP-PSUOCC(4)
"RTN","PSUV1",106,0)
 .I PSUOCC(6)=1,PSUOCC(2)=2 D
"RTN","PSUV1",107,0)
 ..S PSURECT=$G(PSURECT)+PSUOCC(4)               ;Total IV Recycled
"RTN","PSUV1",108,0)
 .I PSUOCC(6)=1,PSUOCC(2)=3 D
"RTN","PSUV1",109,0)
 ..S PSUDEST=$G(PSUDEST)+PSUOCC(4)               ;Total IV Destroyed
"RTN","PSUV1",110,0)
 .I PSUOCC(6)=1,PSUOCC(2)=4 D
"RTN","PSUV1",111,0)
 ..S PSUCAN=$G(PSUCAN)+PSUOCC(4)                 ;Total IV Cancelled
"RTN","PSUV1",112,0)
 .I PSUOCC(6)=1 D
"RTN","PSUV1",113,0)
 ..I (PSUOCC(2)=2)!(PSUOCC(2)=4) S PSUDISP=PSUDISP-PSUOCC(4) ;Net disp
"RTN","PSUV1",114,0)
 Q
"RTN","PSUV1",115,0)
SETTOT ;Set totals
"RTN","PSUV1",116,0)
 ; Total number of IV's ordered
"RTN","PSUV1",117,0)
 S ^XTMP(PSUIVSUB,"ORD",PSUFAC)=$G(^XTMP(PSUIVSUB,"ORD",PSUFAC))+1
"RTN","PSUV1",118,0)
 ; Total number of IV patients
"RTN","PSUV1",119,0)
 I '$D(^XTMP(PSUIVSUB,"PAT",PSUSSN,PSUFAC)) D
"RTN","PSUV1",120,0)
 .S ^XTMP(PSUIVSUB,"SSN",PSUFAC)=$G(^XTMP(PSUIVSUB,"SSN",PSUFAC))+1
"RTN","PSUV1",121,0)
 .S ^XTMP(PSUIVSUB,"PAT",PSUSSN,PSUFAC)=""
"RTN","PSUV1",122,0)
 .S PSUDIV=PSUFAC D GETDIV^PSUV3 I PSUDIVNM'="" D
"RTN","PSUV1",123,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUDIVNM,PSUSSN)=""  ;Pt demo summary
"RTN","PSUV1",124,0)
 .I PSUDIVNM="" S ^XTMP("PSU_"_PSUJOB,"PSUDIV",PSUDIV,PSUSSN)=""
"RTN","PSUV1",125,0)
 I PSUOUTP="Y" D
"RTN","PSUV1",126,0)
 .; Total outpatient IV's ordered
"RTN","PSUV1",127,0)
 .S ^XTMP(PSUIVSUB,"OORD",PSUFAC)=$G(^XTMP(PSUIVSUB,"OORD",PSUFAC))+1
"RTN","PSUV1",128,0)
 Q
"RTN","PSUV1",129,0)
ADDTIV ;Loop through each additive
"RTN","PSUV1",130,0)
 S (PSUNITS,ADTIV)=0
"RTN","PSUV1",131,0)
 F  S ADTIV=$O(^PS(55,PSUPDA,"IV",PSUODA,"AD",ADTIV)) Q:'ADTIV  D
"RTN","PSUV1",132,0)
 .K PSUADDTV,PSUGNRIC,PSUADD
"RTN","PSUV1",133,0)
 .D GETS^PSUTL(55.02,"PSUPDA,PSUODA,ADTIV",".01;.02","PSUADDTV","I")
"RTN","PSUV1",134,0)
 .D MOVEI^PSUTL("PSUADDTV")
"RTN","PSUV1",135,0)
 .D GETS^PSUTL(52.6,"PSUADDTV(.01)",".01;1;7","PSUGNRIC","I")
"RTN","PSUV1",136,0)
 .D MOVEI^PSUTL("PSUGNRIC")
"RTN","PSUV1",137,0)
 .S PSUPNAM=PSUGNRIC(.01)
"RTN","PSUV1",138,0)
 .S PSUDGU=$$VAL^PSUTL(52.6,PSUADDTV(.01),2)
"RTN","PSUV1",139,0)
 .S PSUDGDA=PSUGNRIC(1)
"RTN","PSUV1",140,0)
 .D GETS^PSUTL(50,"PSUDGDA",".01;2;20;21;22;25;31;51;52;3","PSUADD","I")
"RTN","PSUV1",141,0)
 .D MOVEI^PSUTL("PSUADD")
"RTN","PSUV1",142,0)
 .S PSUGNM=PSUADD(.01)
"RTN","PSUV1",143,0)
 .S PSUDCLS=PSUADD(2)
"RTN","PSUV1",144,0)
 .S PSUPRNM=PSUADD(21)
"RTN","PSUV1",145,0)
 .S PSUNDC=PSUADD(31)
"RTN","PSUV1",146,0)
 .S PSUNFI=PSUADD(51)
"RTN","PSUV1",147,0)
 .S PSUNADR=PSUADD(20)
"RTN","PSUV1",148,0)
 .S PSUNDCL=PSUADD(22)
"RTN","PSUV1",149,0)
 .S PSUDEA=PSUADD(3)
"RTN","PSUV1",150,0)
 .S PSUNAF=$S(PSUADD(52):"N/F",1:"")
"RTN","PSUV1",151,0)
 .D SETVAR
"RTN","PSUV1",152,0)
 .S PSUSTRN=+PSUADDTV(.02)
"RTN","PSUV1",153,0)
 .;
"RTN","PSUV1",154,0)
 .;DAM  Add AMIS Additive data
"RTN","PSUV1",155,0)
 .N PSUTDSP1
"RTN","PSUV1",156,0)
 .S PSUTDSP1=$G(PSUDISPT)*PSUSTRN       ;Total Additive units dispens
"RTN","PSUV1",157,0)
 .;
"RTN","PSUV1",158,0)
 .N PSURCY1
"RTN","PSUV1",159,0)
 .S PSURCY1=$G(PSURECT)*PSUSTRN         ;Total Additive units recycled
"RTN","PSUV1",160,0)
 .;
"RTN","PSUV1",161,0)
 .N PSUDES1
"RTN","PSUV1",162,0)
 .S PSUDES1=$G(PSUDEST)*PSUSTRN      ;Total Additive units destroyed
"RTN","PSUV1",163,0)
 .;
"RTN","PSUV1",164,0)
 .N PSUCAN1
"RTN","PSUV1",165,0)
 .S PSUCAN1=$G(PSUCAN)*PSUSTRN         ;Total Additive units cancelled
"RTN","PSUV1",166,0)
 .;END DAM
"RTN","PSUV1",167,0)
 .S PSUNITS=PSUDISP*PSUSTRN
"RTN","PSUV1",168,0)
 .S PSUBAGS=PSUPULL*PSUSTRN
"RTN","PSUV1",169,0)
 .S PSUDCST=PSUGNRIC(7)
"RTN","PSUV1",170,0)
 .S RECIND="A"
"RTN","PSUV1",171,0)
 .D CALC
"RTN","PSUV1",172,0)
 .D SETREC^PSUV2
"RTN","PSUV1",173,0)
 .D SETDRUG^PSUV2
"RTN","PSUV1",174,0)
 Q
"RTN","PSUV1",175,0)
SOLUTN ;Loop through each solution
"RTN","PSUV1",176,0)
 S (PSUNITS,SOLDA)=0 F  S SOLDA=$O(^PS(55,PSUPDA,"IV",PSUODA,"SOL",SOLDA)) Q:'SOLDA  D
"RTN","PSUV1",177,0)
 .K PSUSOL,GENRIC,SOLDRUG
"RTN","PSUV1",178,0)
 .D GETS^PSUTL(55.11,"PSUPDA,PSUODA,SOLDA",".01;1","PSUSOL","I")
"RTN","PSUV1",179,0)
 .D MOVEI^PSUTL("PSUSOL")
"RTN","PSUV1",180,0)
 .D GETS^PSUTL(52.7,"PSUSOL(.01)",".01;1;7","GENRIC","I")
"RTN","PSUV1",181,0)
 .D MOVEI^PSUTL("GENRIC")
"RTN","PSUV1",182,0)
 .S PSUPNAM=GENRIC(.01)
"RTN","PSUV1",183,0)
 .S PSUDGU="ML"
"RTN","PSUV1",184,0)
 .S PSUDGDA=GENRIC(1)
"RTN","PSUV1",185,0)
 .D GETS^PSUTL(50,"PSUDGDA",".01;2;20;21;22;25;31;51;52;3","SOLDRUG","I")
"RTN","PSUV1",186,0)
 .D MOVEI^PSUTL("SOLDRUG")
"RTN","PSUV1",187,0)
 .S PSUGNM=SOLDRUG(.01)
"RTN","PSUV1",188,0)
 .S PSUDCLS=SOLDRUG(2)
"RTN","PSUV1",189,0)
 .S PSUPRNM=SOLDRUG(21)
"RTN","PSUV1",190,0)
 .S PSUNDC=SOLDRUG(31)
"RTN","PSUV1",191,0)
 .S PSUNFI=SOLDRUG(51)
"RTN","PSUV1",192,0)
 .S PSUNADR=SOLDRUG(20)
"RTN","PSUV1",193,0)
 .S PSUNDCL=SOLDRUG(22)
"RTN","PSUV1",194,0)
 .S PSUDEA=SOLDRUG(3)
"RTN","PSUV1",195,0)
 .S PSUNAF=$S(SOLDRUG(52):"N/F",1:"")
"RTN","PSUV1",196,0)
 .D SETVAR
"RTN","PSUV1",197,0)
 .S VOLUME=+PSUSOL(1)
"RTN","PSUV1",198,0)
 .;
"RTN","PSUV1",199,0)
 .;DAM ADD AMIS SOLUTION DATA
"RTN","PSUV1",200,0)
 .N PSUTSOL1
"RTN","PSUV1",201,0)
 .S PSUTSOL1=$G(PSUDISPT)*VOLUME    ;Total Solution units dispense
"RTN","PSUV1",202,0)
 .;
"RTN","PSUV1",203,0)
 .N PSUTRS1
"RTN","PSUV1",204,0)
 .S PSUTRS1=$G(PSURECT)*VOLUME       ;Total Solution units recycl
"RTN","PSUV1",205,0)
 .;
"RTN","PSUV1",206,0)
 .N PSUTDS1
"RTN","PSUV1",207,0)
 .S PSUTDS1=$G(PSUDEST)*VOLUME     ;Total Solution units destroyed
"RTN","PSUV1",208,0)
 .;
"RTN","PSUV1",209,0)
 .N PSUTCS1
"RTN","PSUV1",210,0)
 .S PSUTCS1=$G(PSUCAN)*VOLUME        ;Total Solution units cancelled
"RTN","PSUV1",211,0)
 .;END DAM
"RTN","PSUV1",212,0)
 .S PSUNITS=PSUDISP*VOLUME
"RTN","PSUV1",213,0)
 .S PSUBAGS=PSUPULL*VOLUME
"RTN","PSUV1",214,0)
 .S PSUDCST=GENRIC(7)
"RTN","PSUV1",215,0)
 .S RECIND="S"
"RTN","PSUV1",216,0)
 .D CALC
"RTN","PSUV1",217,0)
 .D SETREC^PSUV2
"RTN","PSUV1",218,0)
 .D SETDRUG^PSUV2
"RTN","PSUV1",219,0)
 Q
"RTN","PSUV1",220,0)
SETVAR ;Setup common variables for IV Additives and Solutions
"RTN","PSUV1",221,0)
 I PSUGNM="" S PSUGNM="UNKNOWN GENERIC NAME"
"RTN","PSUV1",222,0)
 I PSUPRNM="" S PSUPRNM="UNKNOWN VA PRODUCT NAME"
"RTN","PSUV1",223,0)
 I PSUNDC="" S PSUNDC="No NDC"
"RTN","PSUV1",224,0)
 I PSUNFI=1 S PSUNFI="N/F"
"RTN","PSUV1",225,0)
 S (PSIVNFI,PSIVNFR)=""
"RTN","PSUV1",226,0)
 I $$VERSION^XPDUTL("PSN")'<4 D
"RTN","PSUV1",227,0)
 .S PSIVNFI=$$FORMI^PSNAPIS(PSUNADR,PSUNDCL)
"RTN","PSUV1",228,0)
 .S PSIVNFR=$$FORMR^PSNAPIS(PSUNADR,PSUNDCL)>0
"RTN","PSUV1",229,0)
 Q
"RTN","PSUV1",230,0)
CALC ;Do calculations for additives and solutions
"RTN","PSUV1",231,0)
 S ^XTMP(PSUIVSUB,"CST",PSUFAC)=(PSUNITS*PSUDCST)+$G(^XTMP(PSUIVSUB,"CST",PSUFAC))
"RTN","PSUV1",232,0)
 S RECTYP=""
"RTN","PSUV1",233,0)
 S COUNT=COUNT+1
"RTN","PSUV1",234,0)
 S:COUNT=1 RECTYP="P"
"RTN","PSUV1",235,0)
 I PSUOUTP="Y" D
"RTN","PSUV1",236,0)
 .S ^XTMP(PSUIVSUB,"OCST",PSUFAC)=(PSUDCST*PSUBAGS)+$G(^XTMP(PSUIVSUB,"OCST",PSUFAC))
"RTN","PSUV1",237,0)
 I PSUIV(.04)="P" D
"RTN","PSUV1",238,0)
 .S ^XTMP(PSUIVSUB,"SPIG",PSUFAC)=(PSUDCST*PSUBAGS)+$G(^XTMP(PSUIVSUB,"SPIG",PSUFAC))
"RTN","PSUV1",239,0)
 I PSUIV(.04)="A" D
"RTN","PSUV1",240,0)
 .S ^XTMP(PSUIVSUB,"SADM",PSUFAC)=(PSUDCST*PSUBAGS)+$G(^XTMP(PSUIVSUB,"SADM",PSUFAC))
"RTN","PSUV1",241,0)
 I PSUIV(.04)="H" D
"RTN","PSUV1",242,0)
 .S ^XTMP(PSUIVSUB,"SHYP",PSUFAC)=(PSUDCST*PSUBAGS)+$G(^XTMP(PSUIVSUB,"SHYP",PSUFAC))
"RTN","PSUV1",243,0)
 I PSUIV(.04)="S" D
"RTN","PSUV1",244,0)
 .S ^XTMP(PSUIVSUB,"SSYR",PSUFAC)=(PSUDCST*PSUBAGS)+$G(^XTMP(PSUIVSUB,"SSYR",PSUFAC))
"RTN","PSUV1",245,0)
 I PSUIV(.04)="C" D
"RTN","PSUV1",246,0)
 .S ^XTMP(PSUIVSUB,"SCHEM",PSUFAC)=(PSUDCST*PSUBAGS)+$G(^XTMP(PSUIVSUB,"SCHEM",PSUFAC))
"RTN","PSUV1",247,0)
 Q
"RTN","PSUV10")
0^124^B32981791
"RTN","PSUV10",1,0)
PSUV10 ;BIR/DAM - IV SYRINGE AMIS Summary Data;11 March 2004
"RTN","PSUV10",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV10",3,0)
 ;
"RTN","PSUV10",4,0)
 ;This routine gathers IV SYRINGE AMIS summary data
"RTN","PSUV10",5,0)
 ;No DBIA's needed
"RTN","PSUV10",6,0)
 ;
"RTN","PSUV10",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUIV3
"RTN","PSUV10",8,0)
 ;
"RTN","PSUV10",9,0)
 K PSUIVA      ;Array to hold temporary data
"RTN","PSUV10",10,0)
 ;
"RTN","PSUV10",11,0)
 ;Initialize variables for column totals
"RTN","PSUV10",12,0)
 ;
"RTN","PSUV10",13,0)
 ;
"RTN","PSUV10",14,0)
 S PSUDIV=0
"RTN","PSUV10",15,0)
 S PSUCT=0
"RTN","PSUV10",16,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D EN1
"RTN","PSUV10",17,0)
 Q
"RTN","PSUV10",18,0)
 ;
"RTN","PSUV10",19,0)
EN1 ;EN CONTINUED
"RTN","PSUV10",20,0)
 ;
"RTN","PSUV10",21,0)
 S PSUOR=""
"RTN","PSUV10",22,0)
 N LDSP,LREC,LDES,CLAN,NDSP,LTOT,CNDSP
"RTN","PSUV10",23,0)
 F  S PSUCT=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUV10",24,0)
 .K PSUAMIS
"RTN","PSUV10",25,0)
 .M PSUAMIS(PSUDIV,PSUCT)=^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)
"RTN","PSUV10",26,0)
 .;
"RTN","PSUV10",27,0)
 .S PSUP=""
"RTN","PSUV10",28,0)
 .S PSUP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,5)      ;parent record
"RTN","PSUV10",29,0)
 .;
"RTN","PSUV10",30,0)
 .S PSUTYP=""
"RTN","PSUV10",31,0)
 .S PSUTYP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,6)    ;IV TYPE
"RTN","PSUV10",32,0)
 .;
"RTN","PSUV10",33,0)
 .I PSUTYP="S" S PSUOR=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,4)    ;IV order #
"RTN","PSUV10",34,0)
 .;
"RTN","PSUV10",35,0)
 .D LVPDSP
"RTN","PSUV10",36,0)
 .D LVPREC
"RTN","PSUV10",37,0)
 .D LVPDES
"RTN","PSUV10",38,0)
 .D LVPCAN
"RTN","PSUV10",39,0)
 .D LVPNET
"RTN","PSUV10",40,0)
 .D LVPTOT
"RTN","PSUV10",41,0)
 .D CNET
"RTN","PSUV10",42,0)
 .D REC
"RTN","PSUV10",43,0)
 D TOTAL
"RTN","PSUV10",44,0)
 ;
"RTN","PSUV10",45,0)
 Q
"RTN","PSUV10",46,0)
 ;
"RTN","PSUV10",47,0)
LVPDSP ;Gather SYR Dispensed data
"RTN","PSUV10",48,0)
 ;
"RTN","PSUV10",49,0)
 I PSUTYP="S",PSUP="P" D                         ;SYRs Dispensed
"RTN","PSUV10",50,0)
 .N DSP
"RTN","PSUV10",51,0)
 .S DSP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,29)
"RTN","PSUV10",52,0)
 .S $P(PSUIVA(PSUDIV),U,1)=$P($G(PSUIVA(PSUDIV)),U,1)+DSP
"RTN","PSUV10",53,0)
 ;
"RTN","PSUV10",54,0)
 Q
"RTN","PSUV10",55,0)
 ;
"RTN","PSUV10",56,0)
LVPREC ;Gather SYR Recycled data
"RTN","PSUV10",57,0)
 ;
"RTN","PSUV10",58,0)
 I PSUTYP="S",PSUP="P" D                         ;SYR's recycled
"RTN","PSUV10",59,0)
 .N REC
"RTN","PSUV10",60,0)
 .S REC=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,30)
"RTN","PSUV10",61,0)
 .S $P(PSUIVA(PSUDIV),U,2)=$P($G(PSUIVA(PSUDIV)),U,2)+REC
"RTN","PSUV10",62,0)
 ;
"RTN","PSUV10",63,0)
 Q
"RTN","PSUV10",64,0)
 ;
"RTN","PSUV10",65,0)
LVPDES ;Gather SYR Destroyed data
"RTN","PSUV10",66,0)
 ;
"RTN","PSUV10",67,0)
 I PSUTYP="S",PSUP="P" D                        ;SYR's destroyed
"RTN","PSUV10",68,0)
 .N DES
"RTN","PSUV10",69,0)
 .S DES=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,31)
"RTN","PSUV10",70,0)
 .S $P(PSUIVA(PSUDIV),U,3)=$P($G(PSUIVA(PSUDIV)),U,3)+DES
"RTN","PSUV10",71,0)
 ;
"RTN","PSUV10",72,0)
 Q
"RTN","PSUV10",73,0)
 ;
"RTN","PSUV10",74,0)
LVPCAN ;Gather SYR Cancelled data
"RTN","PSUV10",75,0)
 ;
"RTN","PSUV10",76,0)
 I PSUTYP="S",PSUP="P" D                         ;SYR's cancelled
"RTN","PSUV10",77,0)
 .N CAN
"RTN","PSUV10",78,0)
 .S CAN=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,32)
"RTN","PSUV10",79,0)
 .S $P(PSUIVA(PSUDIV),U,4)=$P($G(PSUIVA(PSUDIV)),U,4)+CAN
"RTN","PSUV10",80,0)
 ;
"RTN","PSUV10",81,0)
 Q
"RTN","PSUV10",82,0)
 ;
"RTN","PSUV10",83,0)
LVPNET ;Calculate net amount of SYR's Dispensed
"RTN","PSUV10",84,0)
 ;
"RTN","PSUV10",85,0)
 ;
"RTN","PSUV10",86,0)
 I PSUTYP="S",PSUP="P" D
"RTN","PSUV10",87,0)
 .N NET
"RTN","PSUV10",88,0)
 .S NET=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,11)
"RTN","PSUV10",89,0)
 .S $P(PSUIVA(PSUDIV),U,5)=$P($G(PSUIVA(PSUDIV)),U,5)+NET
"RTN","PSUV10",90,0)
 Q
"RTN","PSUV10",91,0)
 ;
"RTN","PSUV10",92,0)
LVPTOT ;Calculate Total cost
"RTN","PSUV10",93,0)
 ;
"RTN","PSUV10",94,0)
 N NDIS,COST,PSUOR1
"RTN","PSUV10",95,0)
 S PSUCTA=0
"RTN","PSUV10",96,0)
 F  S PSUCTA=$O(PSUAMIS(PSUDIV,PSUCTA)) Q:PSUCTA=""  D
"RTN","PSUV10",97,0)
 .S PSUOR1=$P(PSUAMIS(PSUDIV,PSUCTA),U,4)
"RTN","PSUV10",98,0)
 .Q:(PSUOR1'=PSUOR)
"RTN","PSUV10",99,0)
 .S NDIS=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,33)
"RTN","PSUV10",100,0)
 .S COST=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,22)
"RTN","PSUV10",101,0)
 .S $P(PSUIVA(PSUDIV),U,6)=$P($G(PSUIVA(PSUDIV)),U,6)+(NDIS*$G(COST))
"RTN","PSUV10",102,0)
 .;
"RTN","PSUV10",103,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV10",104,0)
 .N A,B,C
"RTN","PSUV10",105,0)
 .;
"RTN","PSUV10",106,0)
 .I $P(PSUIVA(PSUDIV),U,6)'["." D  Q
"RTN","PSUV10",107,0)
 ..S $P(PSUIVA(PSUDIV),U,6)=$P(PSUIVA(PSUDIV),U,6)_".00"
"RTN","PSUV10",108,0)
 .;
"RTN","PSUV10",109,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,6),".")  ;Find 1st position after decimal
"RTN","PSUV10",110,0)
 .;
"RTN","PSUV10",111,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,6),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV10",112,0)
 .;
"RTN","PSUV10",113,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,6),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV10",114,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV10",115,0)
 .;
"RTN","PSUV10",116,0)
 .S $P(PSUIVA(PSUDIV),U,6)=B_C
"RTN","PSUV10",117,0)
 Q
"RTN","PSUV10",118,0)
 ;
"RTN","PSUV10",119,0)
CNET ;Calculate Cost per Net SYR's dispensed
"RTN","PSUV10",120,0)
 ;
"RTN","PSUV10",121,0)
 N CNET,TCOST
"RTN","PSUV10",122,0)
 ;
"RTN","PSUV10",123,0)
 S CNET=$P($G(PSUIVA(PSUDIV)),U,5)
"RTN","PSUV10",124,0)
 S TCOST=$P($G(PSUIVA(PSUDIV)),U,6)
"RTN","PSUV10",125,0)
 ;
"RTN","PSUV10",126,0)
 I CNET'="",CNET'=0,TCOST'="" D
"RTN","PSUV10",127,0)
 .S $P(PSUIVA(PSUDIV),U,7)=TCOST/CNET
"RTN","PSUV10",128,0)
 .;
"RTN","PSUV10",129,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV10",130,0)
 .N A,B,C
"RTN","PSUV10",131,0)
 .;
"RTN","PSUV10",132,0)
 .I $P(PSUIVA(PSUDIV),U,7)'["." D  Q
"RTN","PSUV10",133,0)
 ..S $P(PSUIVA(PSUDIV),U,7)=$P(PSUIVA(PSUDIV),U,7)_".00"
"RTN","PSUV10",134,0)
 .;
"RTN","PSUV10",135,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,7),".")  ;Find 1st position after decimal
"RTN","PSUV10",136,0)
 .;
"RTN","PSUV10",137,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,7),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV10",138,0)
 .;
"RTN","PSUV10",139,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,7),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV10",140,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV10",141,0)
 .;
"RTN","PSUV10",142,0)
 .S $P(PSUIVA(PSUDIV),U,7)=B_C
"RTN","PSUV10",143,0)
 ;
"RTN","PSUV10",144,0)
 Q
"RTN","PSUV10",145,0)
 ;
"RTN","PSUV10",146,0)
TOTAL ;Add up column totals and place into ^XTMP global
"RTN","PSUV10",147,0)
 ;
"RTN","PSUV10",148,0)
 S PSUDI=0
"RTN","PSUV10",149,0)
 F  S PSUDI=$O(PSUIVA(PSUDI)) Q:PSUDI=""  D
"RTN","PSUV10",150,0)
 .S LDSP=$G(LDSP)+$P(PSUIVA(PSUDI),U,1)   ;Total SYR's dispensed
"RTN","PSUV10",151,0)
 .;
"RTN","PSUV10",152,0)
 .S LREC=$G(LREC)+$P(PSUIVA(PSUDI),U,2)   ;Total SYR's recycled
"RTN","PSUV10",153,0)
 .;
"RTN","PSUV10",154,0)
 .S LDES=$G(LDES)+$P(PSUIVA(PSUDI),U,3)   ;Total SYR's destroyed
"RTN","PSUV10",155,0)
 .;
"RTN","PSUV10",156,0)
 .S CLAN=$G(CLAN)+$P(PSUIVA(PSUDI),U,4)   ;Total SYR's cancelled
"RTN","PSUV10",157,0)
 .;
"RTN","PSUV10",158,0)
 .S NDSP=$G(NDSP)+$P(PSUIVA(PSUDI),U,5)   ;Total Net SYR's dispensed
"RTN","PSUV10",159,0)
 .;
"RTN","PSUV10",160,0)
 .S LTOT=$G(LTOT)+$P(PSUIVA(PSUDI),U,6)   ;Total of Total cost
"RTN","PSUV10",161,0)
 .;
"RTN","PSUV10",162,0)
 .;S CNDSP=$G(CNDSP)+$P(PSUIVA(PSUDI),U,7) ;Total of cost/net column
"RTN","PSUV10",163,0)
 .I $G(NDSP) S CNDSP=$G(LTOT)/NDSP D
"RTN","PSUV10",164,0)
 ..I CNDSP'["." S CNDSP=CNDSP_".00" Q
"RTN","PSUV10",165,0)
 ..N A,B,C
"RTN","PSUV10",166,0)
 ..S A=$F(CNDSP,".")  ;Find 1st position after decimal
"RTN","PSUV10",167,0)
 ..S B=$E(CNDSP,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUV10",168,0)
 ..S C=$E(CNDSP,A,(A+1))   ;Extract cents after decimal
"RTN","PSUV10",169,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV10",170,0)
 ..S CNDSP=B_C
"RTN","PSUV10",171,0)
 ;
"RTN","PSUV10",172,0)
 S ^XTMP(PSUIVSUB,"SYRTOT")=$G(LDSP)_U_$G(LREC)_U_$G(LDES)_U_$G(CLAN)_U_$G(NDSP)_U_$G(LTOT)_U_$G(CNDSP)
"RTN","PSUV10",173,0)
 ;
"RTN","PSUV10",174,0)
 Q
"RTN","PSUV10",175,0)
 ;
"RTN","PSUV10",176,0)
REC ;Place contents of arrays into ^XTMP globals
"RTN","PSUV10",177,0)
 ;
"RTN","PSUV10",178,0)
 M ^XTMP(PSUIVSUB,"SYR",PSUDIV)=PSUIVA(PSUDIV)   ;SYR RECORDS
"RTN","PSUV10",179,0)
 ;
"RTN","PSUV10",180,0)
 Q
"RTN","PSUV11")
0^125^B3575024
"RTN","PSUV11",1,0)
PSUV11 ;BIR/DAM - IV AMIS Summary Message I;04 MAR 2004
"RTN","PSUV11",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV11",3,0)
 ;
"RTN","PSUV11",4,0)
 ;No DBIA's required
"RTN","PSUV11",5,0)
 ;
"RTN","PSUV11",6,0)
EN ;Entry point for MailMan message
"RTN","PSUV11",7,0)
 ;Called from PSUIV0
"RTN","PSUV11",8,0)
 ;
"RTN","PSUV11",9,0)
 D SITE
"RTN","PSUV11",10,0)
 D EN^PSUV12
"RTN","PSUV11",11,0)
 D MAIL
"RTN","PSUV11",12,0)
 Q
"RTN","PSUV11",13,0)
 ;
"RTN","PSUV11",14,0)
SITE ;Create the IV AMIS summary mailman message
"RTN","PSUV11",15,0)
 ;
"RTN","PSUV11",16,0)
 ;
"RTN","PSUV11",17,0)
 K LVP,PB,TPN,CH,SYR     ;KILL ARRAYS
"RTN","PSUV11",18,0)
 ;
"RTN","PSUV11",19,0)
 ;PSUDIV is the division number
"RTN","PSUV11",20,0)
 ;PSUDIVNM is the division name
"RTN","PSUV11",21,0)
 ;
"RTN","PSUV11",22,0)
 S PSUDIV=0
"RTN","PSUV11",23,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV11",24,0)
 .D GETDIV^PSUV3
"RTN","PSUV11",25,0)
 .D LVP
"RTN","PSUV11",26,0)
 .D IVP
"RTN","PSUV11",27,0)
 .D TPN
"RTN","PSUV11",28,0)
 .D CHEM
"RTN","PSUV11",29,0)
 .D SYR
"RTN","PSUV11",30,0)
 Q
"RTN","PSUV11",31,0)
 ;
"RTN","PSUV11",32,0)
LVP ;Set contents of LVP ^XTMP global into local array
"RTN","PSUV11",33,0)
 ;
"RTN","PSUV11",34,0)
 M LVP(PSUDIV)=^XTMP(PSUIVSUB,"LVP",PSUDIV)   ;Data array
"RTN","PSUV11",35,0)
 ;
"RTN","PSUV11",36,0)
 ;
"RTN","PSUV11",37,0)
 Q
"RTN","PSUV11",38,0)
 ;
"RTN","PSUV11",39,0)
IVP ;Set contents of IVPB ^XTMP global into local array
"RTN","PSUV11",40,0)
 ;
"RTN","PSUV11",41,0)
 M PB(PSUDIV)=^XTMP(PSUIVSUB,"PB",PSUDIV)     ;Data array
"RTN","PSUV11",42,0)
 ;
"RTN","PSUV11",43,0)
 Q
"RTN","PSUV11",44,0)
 ;
"RTN","PSUV11",45,0)
TPN ;Set contents of TPN ^XTMP global into local array
"RTN","PSUV11",46,0)
 ;
"RTN","PSUV11",47,0)
 M TPN(PSUDIV)=^XTMP(PSUIVSUB,"TPN",PSUDIV)
"RTN","PSUV11",48,0)
 ;
"RTN","PSUV11",49,0)
 Q
"RTN","PSUV11",50,0)
 ;
"RTN","PSUV11",51,0)
CHEM ;Set contents of CHEMO ^XTMP global into local array
"RTN","PSUV11",52,0)
 ;
"RTN","PSUV11",53,0)
 M CH(PSUDIV)=^XTMP(PSUIVSUB,"CH",PSUDIV)
"RTN","PSUV11",54,0)
 ;
"RTN","PSUV11",55,0)
 Q
"RTN","PSUV11",56,0)
 ;
"RTN","PSUV11",57,0)
SYR ;Set contents of SYR ^XTMP global into local array
"RTN","PSUV11",58,0)
 ;
"RTN","PSUV11",59,0)
 M SYR(PSUDIV)=^XTMP(PSUIVSUB,"SYR",PSUDIV)
"RTN","PSUV11",60,0)
 ;
"RTN","PSUV11",61,0)
 Q
"RTN","PSUV11",62,0)
 ;
"RTN","PSUV11",63,0)
MAIL ;Send AMIS summary mailman message
"RTN","PSUV11",64,0)
 ;
"RTN","PSUV11",65,0)
 ;Do not send message if option selection includes 1,2,3,4,6
"RTN","PSUV11",66,0)
 I $D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D  Q
"RTN","PSUV11",67,0)
 .M ^XTMP("PSU_"_PSUJOB,"IVCOMBO")=AMIS
"RTN","PSUV11",68,0)
 .S ^XTMP("PSU_"_PSUJOB,"IVCOMBO",1)=""
"RTN","PSUV11",69,0)
 ;
"RTN","PSUV11",70,0)
 S PSUDIV=PSUSNDR D GETDIV^PSUV3
"RTN","PSUV11",71,0)
 S XMSUB="V. 4.0 PBMIV "_PSUMON_" "_PSUSNDR_" "_PSUDIVNM
"RTN","PSUV11",72,0)
 S XMTEXT="AMIS("
"RTN","PSUV11",73,0)
 M ^XTMP("PSU_"_PSUJOB,"IVAMIS")=AMIS
"RTN","PSUV11",74,0)
 S XMCHAN=1
"RTN","PSUV11",75,0)
 M XMY=PSUXMYS2
"RTN","PSUV11",76,0)
 D ^XMD
"RTN","PSUV11",77,0)
 ;
"RTN","PSUV11",78,0)
 Q
"RTN","PSUV12")
0^126^B80238409
"RTN","PSUV12",1,0)
PSUV12 ;BIR/DAM - IV AMIS Summary Message II;04 MAR 2004
"RTN","PSUV12",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV12",3,0)
 ;
"RTN","PSUV12",4,0)
 ;No DBIA's required
"RTN","PSUV12",5,0)
 ;
"RTN","PSUV12",6,0)
EN ;Entry point for MailMan message
"RTN","PSUV12",7,0)
 ;Called from PSUIV11
"RTN","PSUV12",8,0)
 ;
"RTN","PSUV12",9,0)
 ;Construct IV AMIS summary message
"RTN","PSUV12",10,0)
 ;
"RTN","PSUV12",11,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y
"RTN","PSUV12",12,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y
"RTN","PSUV12",13,0)
 S PSUDIV=PSUSNDR D GETDIV^PSUV3
"RTN","PSUV12",14,0)
 S AMIS(1)="IV AMIS Summary for "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUV12",15,0)
 ;
"RTN","PSUV12",16,0)
 S AMIS(2)=""     ;Blank line
"RTN","PSUV12",17,0)
 ;
"RTN","PSUV12",18,0)
 S AMIS(3)="                                                NET                 Cost/"
"RTN","PSUV12",19,0)
 ;
"RTN","PSUV12",20,0)
 S AMIS(4)="                    LVPs    LVPs   LVPs   LVPs  LVPs       Total    NET LVPs"
"RTN","PSUV12",21,0)
 ;
"RTN","PSUV12",22,0)
 S AMIS(5)="Division            DISP    RET    DES    CAN   DISP       Cost     DISP"
"RTN","PSUV12",23,0)
 ;
"RTN","PSUV12",24,0)
 S $P(AMIS(6),"-",78)=""      ;Separator bar
"RTN","PSUV12",25,0)
 ;
"RTN","PSUV12",26,0)
 S PSULN=7
"RTN","PSUV12",27,0)
 ;
"RTN","PSUV12",28,0)
 ;Construct LVP DATA lines with spacing
"RTN","PSUV12",29,0)
 S PSUDIV=0
"RTN","PSUV12",30,0)
 F  S PSUDIV=$O(LVP(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV12",31,0)
 .D GETDIV^PSUV3
"RTN","PSUV12",32,0)
 .S PSULINE=""
"RTN","PSUV12",33,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUV12",34,0)
 .S $E(PSULINE,18,24)=$J($P(LVP(PSUDIV),U,1),7)
"RTN","PSUV12",35,0)
 .S $E(PSULINE,25,31)=$J($P(LVP(PSUDIV),U,2),7)
"RTN","PSUV12",36,0)
 .S $E(PSULINE,32,38)=$J($P(LVP(PSUDIV),U,3),7)
"RTN","PSUV12",37,0)
 .S $E(PSULINE,39,45)=$J($P(LVP(PSUDIV),U,4),7)
"RTN","PSUV12",38,0)
 .S $E(PSULINE,46,52)=$J($P(LVP(PSUDIV),U,5),7)
"RTN","PSUV12",39,0)
 .S $E(PSULINE,54,55)="$"
"RTN","PSUV12",40,0)
 .S $E(PSULINE,56,64)=$J($P(LVP(PSUDIV),U,6),9)
"RTN","PSUV12",41,0)
 .S $E(PSULINE,66,67)="$"
"RTN","PSUV12",42,0)
 .S $E(PSULINE,68,75)=$J($P(LVP(PSUDIV),U,7),8)
"RTN","PSUV12",43,0)
 .;End line
"RTN","PSUV12",44,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",45,0)
 ;
"RTN","PSUV12",46,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",47,0)
 ;
"RTN","PSUV12",48,0)
 M LVP("TOT")=^XTMP(PSUIVSUB,"LVPTOT")        ;LVP Totals array
"RTN","PSUV12",49,0)
 ;Construct LVP Totals line
"RTN","PSUV12",50,0)
 S PSULINE=""
"RTN","PSUV12",51,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUV12",52,0)
 S $E(PSULINE,18,24)=$J($P(LVP("TOT"),U,1),7)
"RTN","PSUV12",53,0)
 S $E(PSULINE,25,31)=$J($P(LVP("TOT"),U,2),7)
"RTN","PSUV12",54,0)
 S $E(PSULINE,32,38)=$J($P(LVP("TOT"),U,3),7)
"RTN","PSUV12",55,0)
 S $E(PSULINE,39,45)=$J($P(LVP("TOT"),U,4),7)
"RTN","PSUV12",56,0)
 S $E(PSULINE,46,52)=$J($P(LVP("TOT"),U,5),7)
"RTN","PSUV12",57,0)
 S $E(PSULINE,54,55)="$"
"RTN","PSUV12",58,0)
 S $E(PSULINE,56,64)=$J($P(LVP("TOT"),U,6),9)
"RTN","PSUV12",59,0)
 S $E(PSULINE,66,67)="$"
"RTN","PSUV12",60,0)
 S $E(PSULINE,68,75)=$J($P(LVP("TOT"),U,7),8)
"RTN","PSUV12",61,0)
 ;End line
"RTN","PSUV12",62,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",63,0)
 ;
"RTN","PSUV12",64,0)
 F PSULN=PSULN:1:(PSULN+4) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUV12",65,0)
 S PSULN=PSULN+1
"RTN","PSUV12",66,0)
 ;
"RTN","PSUV12",67,0)
 ;
"RTN","PSUV12",68,0)
 S AMIS(PSULN)="                                                NET               Cost/"
"RTN","PSUV12",69,0)
 S PSULN=PSULN+1
"RTN","PSUV12",70,0)
 ;
"RTN","PSUV12",71,0)
 S AMIS(PSULN)="                    IVPBs   IVPBs  IVPBs  IVPBs IVPBs    Total    NET IVPBs"
"RTN","PSUV12",72,0)
 ;
"RTN","PSUV12",73,0)
 S PSULN=PSULN+1
"RTN","PSUV12",74,0)
 S AMIS(PSULN)="Division            DISP    RET    DES    CAN   DISP     Cost     DISP"
"RTN","PSUV12",75,0)
 ;
"RTN","PSUV12",76,0)
 S PSULN=PSULN+1
"RTN","PSUV12",77,0)
 ;
"RTN","PSUV12",78,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",79,0)
 ;
"RTN","PSUV12",80,0)
 ;Construct IVPB DATA lines with spacing
"RTN","PSUV12",81,0)
 S PSUDIV=0
"RTN","PSUV12",82,0)
 F  S PSUDIV=$O(PB(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV12",83,0)
 .D GETDIV^PSUV3
"RTN","PSUV12",84,0)
 .S PSULINE=""
"RTN","PSUV12",85,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUV12",86,0)
 .S $E(PSULINE,18,24)=$J($P(PB(PSUDIV),U,1),7)
"RTN","PSUV12",87,0)
 .S $E(PSULINE,25,31)=$J($P(PB(PSUDIV),U,2),7)
"RTN","PSUV12",88,0)
 .S $E(PSULINE,32,38)=$J($P(PB(PSUDIV),U,3),7)
"RTN","PSUV12",89,0)
 .S $E(PSULINE,39,45)=$J($P(PB(PSUDIV),U,4),7)
"RTN","PSUV12",90,0)
 .S $E(PSULINE,46,52)=$J($P(PB(PSUDIV),U,5),7)
"RTN","PSUV12",91,0)
 .S $E(PSULINE,54,55)="$"
"RTN","PSUV12",92,0)
 .S $E(PSULINE,56,64)=$J($P(PB(PSUDIV),U,6),9)
"RTN","PSUV12",93,0)
 .S $E(PSULINE,66,67)="$"
"RTN","PSUV12",94,0)
 .S $E(PSULINE,68,75)=$J($P(PB(PSUDIV),U,7),8)
"RTN","PSUV12",95,0)
 .;End line
"RTN","PSUV12",96,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",97,0)
 ;
"RTN","PSUV12",98,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",99,0)
 ;
"RTN","PSUV12",100,0)
 M PB("TOT")=^XTMP(PSUIVSUB,"PBTOT")        ;IVPB Totals array
"RTN","PSUV12",101,0)
 ;Construct PB Totals line
"RTN","PSUV12",102,0)
 S PSULINE=""
"RTN","PSUV12",103,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUV12",104,0)
 S $E(PSULINE,18,24)=$J($P(PB("TOT"),U,1),7)
"RTN","PSUV12",105,0)
 S $E(PSULINE,25,31)=$J($P(PB("TOT"),U,2),7)
"RTN","PSUV12",106,0)
 S $E(PSULINE,32,38)=$J($P(PB("TOT"),U,3),7)
"RTN","PSUV12",107,0)
 S $E(PSULINE,39,45)=$J($P(PB("TOT"),U,4),7)
"RTN","PSUV12",108,0)
 S $E(PSULINE,46,52)=$J($P(PB("TOT"),U,5),7)
"RTN","PSUV12",109,0)
 S $E(PSULINE,54,55)="$"
"RTN","PSUV12",110,0)
 S $E(PSULINE,56,64)=$J($P(PB("TOT"),U,6),9)
"RTN","PSUV12",111,0)
 S $E(PSULINE,66,67)="$"
"RTN","PSUV12",112,0)
 S $E(PSULINE,68,75)=$J($P(PB("TOT"),U,7),8)
"RTN","PSUV12",113,0)
 ;End line
"RTN","PSUV12",114,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",115,0)
 ;
"RTN","PSUV12",116,0)
 F PSULN=PSULN:1:(PSULN+4) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUV12",117,0)
 S PSULN=PSULN+1
"RTN","PSUV12",118,0)
 ;
"RTN","PSUV12",119,0)
 S AMIS(PSULN)="                                                NET               Cost/"
"RTN","PSUV12",120,0)
 S PSULN=PSULN+1
"RTN","PSUV12",121,0)
 ;
"RTN","PSUV12",122,0)
 S AMIS(PSULN)="                   TPNs    TPNs    TPNs   TPNs  TPNs     Total    NET TPNs"
"RTN","PSUV12",123,0)
 ;
"RTN","PSUV12",124,0)
 S PSULN=PSULN+1
"RTN","PSUV12",125,0)
 S AMIS(PSULN)="Division           DISP    RET     DES    CAN   DISP     Cost     DISP"
"RTN","PSUV12",126,0)
 ;
"RTN","PSUV12",127,0)
 S PSULN=PSULN+1
"RTN","PSUV12",128,0)
 ;
"RTN","PSUV12",129,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",130,0)
 ;
"RTN","PSUV12",131,0)
 ;Construct TPN DATA lines with spacing
"RTN","PSUV12",132,0)
 S PSUDIV=0
"RTN","PSUV12",133,0)
 F  S PSUDIV=$O(TPN(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV12",134,0)
 .D GETDIV^PSUV3
"RTN","PSUV12",135,0)
 .S PSULINE=""
"RTN","PSUV12",136,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUV12",137,0)
 .S $E(PSULINE,18,24)=$J($P(TPN(PSUDIV),U,1),7)
"RTN","PSUV12",138,0)
 .S $E(PSULINE,25,31)=$J($P(TPN(PSUDIV),U,2),7)
"RTN","PSUV12",139,0)
 .S $E(PSULINE,32,38)=$J($P(TPN(PSUDIV),U,3),7)
"RTN","PSUV12",140,0)
 .S $E(PSULINE,39,45)=$J($P(TPN(PSUDIV),U,4),7)
"RTN","PSUV12",141,0)
 .S $E(PSULINE,46,52)=$J($P(TPN(PSUDIV),U,5),7)
"RTN","PSUV12",142,0)
 .S $E(PSULINE,54,55)="$"
"RTN","PSUV12",143,0)
 .S $E(PSULINE,56,64)=$J($P(TPN(PSUDIV),U,6),9)
"RTN","PSUV12",144,0)
 .S $E(PSULINE,66,67)="$"
"RTN","PSUV12",145,0)
 .S $E(PSULINE,68,75)=$J($P(TPN(PSUDIV),U,7),8)
"RTN","PSUV12",146,0)
 .;End line
"RTN","PSUV12",147,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",148,0)
 ;
"RTN","PSUV12",149,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",150,0)
 ;
"RTN","PSUV12",151,0)
 M TPN("TOT")=^XTMP(PSUIVSUB,"TPNTOT")        ;TPN Totals array
"RTN","PSUV12",152,0)
 ;Construct TPN Totals line
"RTN","PSUV12",153,0)
 S PSULINE=""
"RTN","PSUV12",154,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUV12",155,0)
 S $E(PSULINE,18,24)=$J($P(TPN("TOT"),U,1),7)
"RTN","PSUV12",156,0)
 S $E(PSULINE,25,31)=$J($P(TPN("TOT"),U,2),7)
"RTN","PSUV12",157,0)
 S $E(PSULINE,32,38)=$J($P(TPN("TOT"),U,3),7)
"RTN","PSUV12",158,0)
 S $E(PSULINE,39,45)=$J($P(TPN("TOT"),U,4),7)
"RTN","PSUV12",159,0)
 S $E(PSULINE,46,52)=$J($P(TPN("TOT"),U,5),7)
"RTN","PSUV12",160,0)
 S $E(PSULINE,54,55)="$"
"RTN","PSUV12",161,0)
 S $E(PSULINE,56,64)=$J($P(TPN("TOT"),U,6),9)
"RTN","PSUV12",162,0)
 S $E(PSULINE,66,67)="$"
"RTN","PSUV12",163,0)
 S $E(PSULINE,68,75)=$J($P(TPN("TOT"),U,7),8)
"RTN","PSUV12",164,0)
 ;End line
"RTN","PSUV12",165,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",166,0)
 ;
"RTN","PSUV12",167,0)
 F PSULN=PSULN:1:(PSULN+4) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUV12",168,0)
 S PSULN=PSULN+1
"RTN","PSUV12",169,0)
 ;
"RTN","PSUV12",170,0)
 S AMIS(PSULN)="                                                NET               Cost/"
"RTN","PSUV12",171,0)
 S PSULN=PSULN+1
"RTN","PSUV12",172,0)
 ;
"RTN","PSUV12",173,0)
 S AMIS(PSULN)="                    CHEMO   CHEMO  CHEMO  CHEMO CHEMO     Total   NET CHEMOs"
"RTN","PSUV12",174,0)
 ;
"RTN","PSUV12",175,0)
 S PSULN=PSULN+1
"RTN","PSUV12",176,0)
 S AMIS(PSULN)="Division            DISP    RET    DES    CAN   DISP      Cost    DISP"
"RTN","PSUV12",177,0)
 ;
"RTN","PSUV12",178,0)
 S PSULN=PSULN+1
"RTN","PSUV12",179,0)
 ;
"RTN","PSUV12",180,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",181,0)
 ;
"RTN","PSUV12",182,0)
 ;Construct CHEMO DATA lines with spacing
"RTN","PSUV12",183,0)
 S PSUDIV=0
"RTN","PSUV12",184,0)
 F  S PSUDIV=$O(CH(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV12",185,0)
 .D GETDIV^PSUV3
"RTN","PSUV12",186,0)
 .S PSULINE=""
"RTN","PSUV12",187,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUV12",188,0)
 .S $E(PSULINE,18,24)=$J($P(CH(PSUDIV),U,1),7)
"RTN","PSUV12",189,0)
 .S $E(PSULINE,25,31)=$J($P(CH(PSUDIV),U,2),7)
"RTN","PSUV12",190,0)
 .S $E(PSULINE,32,38)=$J($P(CH(PSUDIV),U,3),7)
"RTN","PSUV12",191,0)
 .S $E(PSULINE,39,45)=$J($P(CH(PSUDIV),U,4),7)
"RTN","PSUV12",192,0)
 .S $E(PSULINE,46,52)=$J($P(CH(PSUDIV),U,5),7)
"RTN","PSUV12",193,0)
 .S $E(PSULINE,54,55)="$"
"RTN","PSUV12",194,0)
 .S $E(PSULINE,56,64)=$J($P(CH(PSUDIV),U,6),9)
"RTN","PSUV12",195,0)
 .S $E(PSULINE,66,67)="$"
"RTN","PSUV12",196,0)
 .S $E(PSULINE,68,75)=$J($P(CH(PSUDIV),U,7),8)
"RTN","PSUV12",197,0)
 .;End line
"RTN","PSUV12",198,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",199,0)
 ;
"RTN","PSUV12",200,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",201,0)
 ;
"RTN","PSUV12",202,0)
 M CH("TOT")=^XTMP(PSUIVSUB,"CHTOT")        ;CHEMO Totals array
"RTN","PSUV12",203,0)
 ;Construct CHEMO Totals line
"RTN","PSUV12",204,0)
 S PSULINE=""
"RTN","PSUV12",205,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUV12",206,0)
 S $E(PSULINE,18,24)=$J($P(CH("TOT"),U,1),7)
"RTN","PSUV12",207,0)
 S $E(PSULINE,25,31)=$J($P(CH("TOT"),U,2),7)
"RTN","PSUV12",208,0)
 S $E(PSULINE,32,38)=$J($P(CH("TOT"),U,3),7)
"RTN","PSUV12",209,0)
 S $E(PSULINE,39,45)=$J($P(CH("TOT"),U,4),7)
"RTN","PSUV12",210,0)
 S $E(PSULINE,46,52)=$J($P(CH("TOT"),U,5),7)
"RTN","PSUV12",211,0)
 S $E(PSULINE,54,55)="$"
"RTN","PSUV12",212,0)
 S $E(PSULINE,56,64)=$J($P(CH("TOT"),U,6),9)
"RTN","PSUV12",213,0)
 S $E(PSULINE,66,67)="$"
"RTN","PSUV12",214,0)
 S $E(PSULINE,68,75)=$J($P(CH("TOT"),U,7),8)
"RTN","PSUV12",215,0)
 ;End line
"RTN","PSUV12",216,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",217,0)
 ;
"RTN","PSUV12",218,0)
 F PSULN=PSULN:1:(PSULN+4) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUV12",219,0)
 S PSULN=PSULN+1
"RTN","PSUV12",220,0)
 ;
"RTN","PSUV12",221,0)
 ;
"RTN","PSUV12",222,0)
 S AMIS(PSULN)="                                                NET               Cost/"
"RTN","PSUV12",223,0)
 S PSULN=PSULN+1
"RTN","PSUV12",224,0)
 ;
"RTN","PSUV12",225,0)
 S AMIS(PSULN)="                   SYRs    SYRs   SYRs   SYRs   SYRs     Total    NET SYRs"
"RTN","PSUV12",226,0)
 ;
"RTN","PSUV12",227,0)
 S PSULN=PSULN+1
"RTN","PSUV12",228,0)
 S AMIS(PSULN)="Division           DISP    RET    DES    CAN    DISP     Cost     DISP"
"RTN","PSUV12",229,0)
 ;
"RTN","PSUV12",230,0)
 S PSULN=PSULN+1
"RTN","PSUV12",231,0)
 ;
"RTN","PSUV12",232,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",233,0)
 ;
"RTN","PSUV12",234,0)
 ;Construct SYRINGE DATA lines with spacing
"RTN","PSUV12",235,0)
 S PSUDIV=0
"RTN","PSUV12",236,0)
 F  S PSUDIV=$O(SYR(PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV12",237,0)
 .D GETDIV^PSUV3
"RTN","PSUV12",238,0)
 .S PSULINE=""
"RTN","PSUV12",239,0)
 .S $E(PSULINE,1,17)=PSUDIVNM
"RTN","PSUV12",240,0)
 .S $E(PSULINE,18,24)=$J($P(SYR(PSUDIV),U,1),7)
"RTN","PSUV12",241,0)
 .S $E(PSULINE,25,31)=$J($P(SYR(PSUDIV),U,2),7)
"RTN","PSUV12",242,0)
 .S $E(PSULINE,32,38)=$J($P(SYR(PSUDIV),U,3),7)
"RTN","PSUV12",243,0)
 .S $E(PSULINE,39,45)=$J($P(SYR(PSUDIV),U,4),7)
"RTN","PSUV12",244,0)
 .S $E(PSULINE,46,52)=$J($P(SYR(PSUDIV),U,5),7)
"RTN","PSUV12",245,0)
 .S $E(PSULINE,54,55)="$"
"RTN","PSUV12",246,0)
 .S $E(PSULINE,56,64)=$J($P(SYR(PSUDIV),U,6),9)
"RTN","PSUV12",247,0)
 .S $E(PSULINE,66,67)="$"
"RTN","PSUV12",248,0)
 .S $E(PSULINE,68,75)=$J($P(SYR(PSUDIV),U,7),8)
"RTN","PSUV12",249,0)
 .;End line
"RTN","PSUV12",250,0)
 .S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",251,0)
 ;
"RTN","PSUV12",252,0)
 S $P(AMIS(PSULN),"-",78)="" S PSULN=PSULN+1      ;Separator bar
"RTN","PSUV12",253,0)
 ;
"RTN","PSUV12",254,0)
 M SYR("TOT")=^XTMP(PSUIVSUB,"SYRTOT")        ;SYRINGE Totals array
"RTN","PSUV12",255,0)
 ;Construct SYRINGE Totals line
"RTN","PSUV12",256,0)
 S PSULINE=""
"RTN","PSUV12",257,0)
 S $E(PSULINE,1,17)="Total"
"RTN","PSUV12",258,0)
 S $E(PSULINE,18,24)=$J($P(SYR("TOT"),U,1),7)
"RTN","PSUV12",259,0)
 S $E(PSULINE,25,31)=$J($P(SYR("TOT"),U,2),7)
"RTN","PSUV12",260,0)
 S $E(PSULINE,32,38)=$J($P(SYR("TOT"),U,3),7)
"RTN","PSUV12",261,0)
 S $E(PSULINE,39,45)=$J($P(SYR("TOT"),U,4),7)
"RTN","PSUV12",262,0)
 S $E(PSULINE,46,52)=$J($P(SYR("TOT"),U,5),7)
"RTN","PSUV12",263,0)
 S $E(PSULINE,54,55)="$"
"RTN","PSUV12",264,0)
 S $E(PSULINE,56,64)=$J($P(SYR("TOT"),U,6),9)
"RTN","PSUV12",265,0)
 S $E(PSULINE,66,67)="$"
"RTN","PSUV12",266,0)
 S $E(PSULINE,68,75)=$J($P(SYR("TOT"),U,7),8)
"RTN","PSUV12",267,0)
 ;End line
"RTN","PSUV12",268,0)
 S AMIS(PSULN)=PSULINE S PSULN=PSULN+1
"RTN","PSUV12",269,0)
 ;
"RTN","PSUV12",270,0)
 F PSULN=PSULN:1:(PSULN+4) S AMIS(PSULN)=""     ;Blank lines
"RTN","PSUV12",271,0)
 S PSULN=PSULN+1
"RTN","PSUV12",272,0)
 Q
"RTN","PSUV2")
0^116^B59687439
"RTN","PSUV2",1,0)
PSUV2 ;BIR/CFL - IV functions and subroutines ;25 AUG 1998
"RTN","PSUV2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV2",3,0)
 ;
"RTN","PSUV2",4,0)
 ;DBIA'S
"RTN","PSUV2",5,0)
 ;Reference to file #2    supported by DBIA 10035 and 2701
"RTN","PSUV2",6,0)
 ;
"RTN","PSUV2",7,0)
GETRATE(TYPE) ;Determine if the IV type is schedule or infusion rate and calculate the subtotal of each type
"RTN","PSUV2",8,0)
 S PSURATE=""
"RTN","PSUV2",9,0)
 I TYPE="P" D
"RTN","PSUV2",10,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUV2",11,0)
 .S ^XTMP(PSUIVSUB,"TPIG",PSUFAC)=$G(^XTMP(PSUIVSUB,"TPIG",PSUFAC))+PSUDISP
"RTN","PSUV2",12,0)
 I TYPE="A" D
"RTN","PSUV2",13,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUV2",14,0)
 .S ^XTMP(PSUIVSUB,"TADM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TADM",PSUFAC))+PSUDISP
"RTN","PSUV2",15,0)
 I TYPE="H" D
"RTN","PSUV2",16,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUV2",17,0)
 .S ^XTMP(PSUIVSUB,"THYP",PSUFAC)=$G(^XTMP(PSUIVSUB,"THYP",PSUFAC))+PSUDISP
"RTN","PSUV2",18,0)
 I TYPE="S"&(PSUIV(108)=1) D
"RTN","PSUV2",19,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUV2",20,0)
 .S ^XTMP(PSUIVSUB,"TSYR",PSUFAC)=$G(^XTMP(PSUIVSUB,"TSYR",PSUFAC))+PSUDISP
"RTN","PSUV2",21,0)
 I TYPE="S"&(PSUIV(108)=0) D
"RTN","PSUV2",22,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUV2",23,0)
 .S ^XTMP(PSUIVSUB,"TSYR",PSUFAC)=$G(^XTMP(PSUIVSUB,"TSYR",PSUFAC))+PSUDISP
"RTN","PSUV2",24,0)
 I TYPE="C"&(PSUIV(106)="P") D
"RTN","PSUV2",25,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUV2",26,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUV2",27,0)
 I TYPE="C"&(PSUIV(106)="A") D
"RTN","PSUV2",28,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUV2",29,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUV2",30,0)
 I TYPE="C"&(PSUIV(106)="S")&(PSUIV(108)=1) D
"RTN","PSUV2",31,0)
 .S PSURATE=PSUIV(.09)
"RTN","PSUV2",32,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUV2",33,0)
 I TYPE="C"&(PSUIV(106)="S")&(PSUIV(108)=0) D
"RTN","PSUV2",34,0)
 .S PSURATE=PSUIV(.08)
"RTN","PSUV2",35,0)
 .S ^XTMP(PSUIVSUB,"TCHEM",PSUFAC)=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC))+PSUDISP
"RTN","PSUV2",36,0)
 Q
"RTN","PSUV2",37,0)
SETREC ;Set the ^XTMP global for IV Additives and Solutions
"RTN","PSUV2",38,0)
 S REC="^",DLM="^",INDEX=""
"RTN","PSUV2",39,0)
 I RECTYP="P" D     ;Record type of "P" indicates parent record.
"RTN","PSUV2",40,0)
 .S REC=REC_$TR(PSUFAC,"^","'")_DLM_$TR(PSUIV(.02),"^","'")_DLM_PSUIV(.01)_DLM
"RTN","PSUV2",41,0)
 .S REC=REC_RECTYP_DLM_$TR(PSUIV(.04),"^","'")_DLM_PSUOUTP_DLM_PSUSSN_DLM
"RTN","PSUV2",42,0)
 .S REC=REC_$G(PSURATE)_DLM_$TR(PSUDOC(9),"^","'")_DLM  ;_$TR(PSUPCLS,"^","'")_DLM
"RTN","PSUV2",43,0)
 .S REC=REC_$TR(PSUDISP,"^","'")_DLM_$TR(PSUPRNM,"^","'")_DLM
"RTN","PSUV2",44,0)
 .S REC=REC_$TR(PSUDCLS,"^","'")_DLM_$TR(PSUNDC,"^","'")_DLM
"RTN","PSUV2",45,0)
 .S REC=REC_$TR(PSUNFI,"^","'")_DLM_$TR(PSIVNFI,"^","'")_DLM
"RTN","PSUV2",46,0)
 .S REC=REC_$TR(PSIVNFR,"^","'")_DLM_$TR(PSUPNAM,"^","'")_DLM
"RTN","PSUV2",47,0)
 .S REC=REC_RECIND_DLM_$TR(PSUGNM,"^","'")_DLM_$TR(PSUDGU,"^","'")_DLM
"RTN","PSUV2",48,0)
 .S REC=REC_PSUDCST_DLM_PSUNITS_DLM_PSUNAF_DLM_PSUDEA_DLM
"RTN","PSUV2",49,0)
 .D ICN
"RTN","PSUV2",50,0)
 .;VMP - OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUV2",51,0)
 .S PSUPICN=$G(^XTMP("PSU_"_PSUJOB,"PSUPICN"))
"RTN","PSUV2",52,0)
 .S REC=REC_$G(PSUPICN)_DLM_$G(PSUIV(.06))_DLM_$G(PSUIV(.03))_U
"RTN","PSUV2",53,0)
 .;
"RTN","PSUV2",54,0)
 .;DAM..ADD PHASE II NEW PIECES HERE
"RTN","PSUV2",55,0)
 .I $G(PSUDISPT) S REC=REC_PSUDISPT_U    ;#IV bags dispensed
"RTN","PSUV2",56,0)
 .I '$G(PSUDISPT) S REC=REC_0_U
"RTN","PSUV2",57,0)
 .;
"RTN","PSUV2",58,0)
 .I $G(PSURECT) S REC=REC_PSURECT_U       ;#IV bags recycled
"RTN","PSUV2",59,0)
 .I '$G(PSURECT) S REC=REC_0_U
"RTN","PSUV2",60,0)
 .;
"RTN","PSUV2",61,0)
 .I $G(PSUDEST) S REC=REC_PSUDEST_U       ;#IV bags destroyed
"RTN","PSUV2",62,0)
 .I '$G(PSUDEST) S REC=REC_0_U
"RTN","PSUV2",63,0)
 .;
"RTN","PSUV2",64,0)
 .I $G(PSUCAN) S REC=REC_PSUCAN_U       ;#IV bags cancelled
"RTN","PSUV2",65,0)
 .I '$G(PSUCAN) S REC=REC_0_U
"RTN","PSUV2",66,0)
 .;
"RTN","PSUV2",67,0)
 .I $G(PSUTDSP1) S REC=REC_PSUTDSP1_U       ;Total units dispensed
"RTN","PSUV2",68,0)
 .I '$G(PSUTDSP1) S REC=REC_0_U
"RTN","PSUV2",69,0)
 .I $G(PSURCY1) S REC=REC_PSURCY1_U         ;Total units recycled
"RTN","PSUV2",70,0)
 .I '$G(PSURCY1) S REC=REC_0_U
"RTN","PSUV2",71,0)
 .I $G(PSUDES1) S REC=REC_PSUDES1_U         ;Total units destroyed
"RTN","PSUV2",72,0)
 .I '$G(PSUDES1) S REC=REC_0_U
"RTN","PSUV2",73,0)
 .I $G(PSUCAN1) S REC=REC_PSUCAN1_U         ;Total units cancelled
"RTN","PSUV2",74,0)
 .I '$G(PSUCAN1) S REC=REC_0_U
"RTN","PSUV2",75,0)
 .;END DAM
"RTN","PSUV2",76,0)
 .;
"RTN","PSUV2",77,0)
 .S INDEX=$O(^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX),-1)
"RTN","PSUV2",78,0)
 .S INDEX=INDEX+1
"RTN","PSUV2",79,0)
 .S ^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX)=REC
"RTN","PSUV2",80,0)
 I RECTYP'="P" D
"RTN","PSUV2",81,0)
 .S REC=REC_$TR(PSUFAC,"^","'")_DLM_$TR(PSUIV(.02),"^","'")_DLM_PSUIV(.01)_DLM
"RTN","PSUV2",82,0)
 .S REC=REC_DLM_DLM_DLM_PSUSSN_DLM
"RTN","PSUV2",83,0)
 .S REC=REC_$G(PSURATE)_DLM_$TR(PSUDOC(9),"^","'")_DLM   ;_$TR(PSUPCLS,"^","'")_DLM
"RTN","PSUV2",84,0)
 .;S REC=REC_$TR(PSUSERV,"^","'")_DLM_$TR(PSUSP1,"^","'")_DLM_$TR(PSUSP2,"^","'")_DLM
"RTN","PSUV2",85,0)
 .S REC=REC_DLM_$TR(PSUPRNM,"^","'")_DLM
"RTN","PSUV2",86,0)
 .S REC=REC_$TR(PSUDCLS,"^","'")_DLM_$TR(PSUNDC,"^","'")_DLM
"RTN","PSUV2",87,0)
 .S REC=REC_$TR(PSUNFI,"^","'")_DLM_$TR(PSIVNFI,"^","'")_DLM
"RTN","PSUV2",88,0)
 .S REC=REC_$TR(PSIVNFR,"^","'")_DLM_$TR(PSUPNAM,"^","'")_DLM
"RTN","PSUV2",89,0)
 .S REC=REC_RECIND_DLM_$TR(PSUGNM,"^","'")_DLM_$TR(PSUDGU,"^","'")_DLM
"RTN","PSUV2",90,0)
 .S REC=REC_PSUDCST_DLM_PSUNITS_DLM_PSUNAF_DLM_PSUDEA_DLM
"RTN","PSUV2",91,0)
 .S REC=REC_$G(PSUPICN)_DLM_$G(PSUDIEN)_DLM_$G(PSUIV(.03))_U
"RTN","PSUV2",92,0)
 .;
"RTN","PSUV2",93,0)
 .;New AMIS Additive/Solution code set here              DAM
"RTN","PSUV2",94,0)
 .S REC=REC_U_U_U_U     ;sets pieces 29 through 32 to null
"RTN","PSUV2",95,0)
 .I RECIND="A" D                             ;Additives
"RTN","PSUV2",96,0)
 ..I $G(PSUTDSP1) S REC=REC_PSUTDSP1_U       ;Total units dispensed
"RTN","PSUV2",97,0)
 ..I '$G(PSUTDSP1) S REC=REC_0_U
"RTN","PSUV2",98,0)
 ..I $G(PSURCY1) S REC=REC_PSURCY1_U         ;Total units recycled
"RTN","PSUV2",99,0)
 ..I '$G(PSURCY1) S REC=REC_0_U
"RTN","PSUV2",100,0)
 ..I $G(PSUDES1) S REC=REC_PSUDES1_U         ;Total units destroyed
"RTN","PSUV2",101,0)
 ..I '$G(PSUDES1) S REC=REC_0_U
"RTN","PSUV2",102,0)
 ..I $G(PSUCAN1) S REC=REC_PSUCAN1_U         ;Total units cancelled
"RTN","PSUV2",103,0)
 ..I '$G(PSUCAN1) S REC=REC_0_U
"RTN","PSUV2",104,0)
 .;
"RTN","PSUV2",105,0)
 .I RECIND="S" D                              ;Solutions
"RTN","PSUV2",106,0)
 ..I $G(PSUTSOL1) S REC=REC_PSUTSOL1_U        ;Total units dispensed
"RTN","PSUV2",107,0)
 ..I '$G(PSUTSOL1) S REC=REC_0_U
"RTN","PSUV2",108,0)
 ..I $G(PSUTRS1) S REC=REC_PSUTRS1_U          ;Total units recycled
"RTN","PSUV2",109,0)
 ..I '$G(PSUTRS1) S REC=REC_0_U
"RTN","PSUV2",110,0)
 ..I $G(PSUTDS1) S REC=REC_PSUTDS1_U          ;Total units destroyed
"RTN","PSUV2",111,0)
 ..I '$G(PSUTDS1) S REC=REC_0_U
"RTN","PSUV2",112,0)
 ..I $G(PSUTCS1) S REC=REC_PSUTCS1_U          ;Total units cancelled
"RTN","PSUV2",113,0)
 ..I '$G(PSUTCS1) S REC=REC_0_U
"RTN","PSUV2",114,0)
 .;End DAM
"RTN","PSUV2",115,0)
 .;
"RTN","PSUV2",116,0)
 .I '$D(^XTMP(PSUIVSUB,"RECORDS",PSUFAC)) S INDEX=0
"RTN","PSUV2",117,0)
 .S INDEX=$O(^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX),-1)
"RTN","PSUV2",118,0)
 .S INDEX=INDEX+1
"RTN","PSUV2",119,0)
 .S ^XTMP(PSUIVSUB,"RECORDS",PSUFAC,INDEX)=REC
"RTN","PSUV2",120,0)
 D LAB^PSULR0("IV",PSUFAC,PSUODA,PSUPDA,PSUGNM,PSUDCLS)
"RTN","PSUV2",121,0)
 Q
"RTN","PSUV2",122,0)
SETDRUG ;Set the ^XTMP global for the drug distribution report
"RTN","PSUV2",123,0)
 S REC=""
"RTN","PSUV2",124,0)
 I '$D(^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)) S ^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)=""
"RTN","PSUV2",125,0)
 S DATA=^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)
"RTN","PSUV2",126,0)
 S REC=PSUDGU_U_(PSUNITS+$P(DATA,"^",2))
"RTN","PSUV2",127,0)
 S REC=REC_U_(PSUDISP+$P(DATA,"^",3))_U_PSUNFI_U_PSIVNFI
"RTN","PSUV2",128,0)
 S ^XTMP(PSUIVSUB,"DRUG",PSUFAC,PSUGNM)=REC
"RTN","PSUV2",129,0)
 Q
"RTN","PSUV2",130,0)
SETSUM ;Set the ^XTMP global for the summary information
"RTN","PSUV2",131,0)
 S PSUFAC=""
"RTN","PSUV2",132,0)
 F  S PSUFAC=$O(PSUFAC(PSUFAC)) Q:PSUFAC=""  D
"RTN","PSUV2",133,0)
 .S PSUTORD=$G(^XTMP(PSUIVSUB,"ORD",PSUFAC),0)
"RTN","PSUV2",134,0)
 .S PSUTPAT=$G(^XTMP(PSUIVSUB,"SSN",PSUFAC),0)
"RTN","PSUV2",135,0)
 .S PSUTCST=$G(^XTMP(PSUIVSUB,"CST",PSUFAC),0)
"RTN","PSUV2",136,0)
 .S PSUTOP=$G(^XTMP(PSUIVSUB,"OORD",PSUFAC),0)
"RTN","PSUV2",137,0)
 .S PSUODSP=$G(^XTMP(PSUIVSUB,"ODISP",PSUFAC),0)
"RTN","PSUV2",138,0)
 .S PSUOCST=$G(^XTMP(PSUIVSUB,"OCST",PSUFAC),0)
"RTN","PSUV2",139,0)
 .S PSUTPIG=$G(^XTMP(PSUIVSUB,"TPIG",PSUFAC),0)
"RTN","PSUV2",140,0)
 .S PSUTSYR=$G(^XTMP(PSUIVSUB,"TSYR",PSUFAC),0)
"RTN","PSUV2",141,0)
 .S PSUTHYP=$G(^XTMP(PSUIVSUB,"THYP",PSUFAC),0)
"RTN","PSUV2",142,0)
 .S PSUTADM=$G(^XTMP(PSUIVSUB,"TADM",PSUFAC),0)
"RTN","PSUV2",143,0)
 .S PSUTCHEM=$G(^XTMP(PSUIVSUB,"TCHEM",PSUFAC),0)
"RTN","PSUV2",144,0)
 .S PSUSPIG=$G(^XTMP(PSUIVSUB,"SPIG",PSUFAC),0)
"RTN","PSUV2",145,0)
 .S PSUSSYR=$G(^XTMP(PSUIVSUB,"SSYR",PSUFAC),0)
"RTN","PSUV2",146,0)
 .S PSUSHYP=$G(^XTMP(PSUIVSUB,"SHYP",PSUFAC),0)
"RTN","PSUV2",147,0)
 .S PSUSADM=$G(^XTMP(PSUIVSUB,"SADM",PSUFAC),0)
"RTN","PSUV2",148,0)
 .S PSUSCHEM=$G(^XTMP(PSUIVSUB,"SCHEM",PSUFAC),0)
"RTN","PSUV2",149,0)
 .S PSUBPIG=$G(^XTMP(PSUIVSUB,"TYPE_P",PSUFAC),0)
"RTN","PSUV2",150,0)
 .S PSUBSYR=$G(^XTMP(PSUIVSUB,"TYPE_S",PSUFAC),0)
"RTN","PSUV2",151,0)
 .S PSUBHYP=$G(^XTMP(PSUIVSUB,"TYPE_H",PSUFAC),0)
"RTN","PSUV2",152,0)
 .S PSUBADM=$G(^XTMP(PSUIVSUB,"TYPE_A",PSUFAC),0)
"RTN","PSUV2",153,0)
 .S PSUBCHEM=$G(^XTMP(PSUIVSUB,"TYPE_C",PSUFAC),0)
"RTN","PSUV2",154,0)
 .S PSUAPIG=$S(PSUBPIG:PSUSPIG/PSUBPIG,1:"")
"RTN","PSUV2",155,0)
 .S PSUASYR=$S(PSUBSYR:PSUSSYR/PSUBSYR,1:"")
"RTN","PSUV2",156,0)
 .S PSUAHYP=$S(PSUBHYP:PSUSHYP/PSUBHYP,1:"")
"RTN","PSUV2",157,0)
 .S PSUAADM=$S(PSUBADM:PSUSADM/PSUBADM,1:"")
"RTN","PSUV2",158,0)
 .S PSUACHEM=$S(PSUBCHEM:PSUSCHEM/PSUBCHEM,1:"")
"RTN","PSUV2",159,0)
 .S PSUTBAGS=PSUBPIG+PSUBSYR+PSUBHYP+PSUBADM+PSUBCHEM
"RTN","PSUV2",160,0)
 .S REC=PSUTORD_U_PSUTPAT_U_PSUTBAGS_U_$J(PSUTCST,0,2)_U_PSUTOP_U
"RTN","PSUV2",161,0)
 .S REC=REC_PSUODSP_U_$J(PSUOCST,0,2)_U_PSUBPIG_U_$J(PSUAPIG,0,2)
"RTN","PSUV2",162,0)
 .S REC=REC_U_PSUBHYP_U_$J(PSUAHYP,0,2)_U_PSUBADM_U_$J(PSUAADM,0,2)
"RTN","PSUV2",163,0)
 .S REC=REC_U_PSUBCHEM_U_$J(PSUACHEM,0,2)_U_PSUBSYR_U_$J(PSUASYR,0,2)
"RTN","PSUV2",164,0)
 .S ^XTMP(PSUIVSUB,"SUMMARY",PSUFAC,0)=REC
"RTN","PSUV2",165,0)
 .S PSUDIV=PSUFAC D GETDIV^PSUV3 I PSUDIVNM'="" D
"RTN","PSUV2",166,0)
 ..S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIVNM)=PSUTPAT
"RTN","PSUV2",167,0)
 .I PSUDIVNM="" S ^XTMP("PSU_"_PSUJOB,"PSUCT",PSUDIV)=PSUTPAT
"RTN","PSUV2",168,0)
 Q
"RTN","PSUV2",169,0)
 ;
"RTN","PSUV2",170,0)
ICN ;Find patient ICN
"RTN","PSUV2",171,0)
 ;VMP OIFO BAY PINES;ELR;PSU*3.0*24
"RTN","PSUV2",172,0)
 ;
"RTN","PSUV2",173,0)
 N PSUPICN,PSUPICN1,PSUICN
"RTN","PSUV2",174,0)
 I $G(PSUSSN),PSUSSN'="" D
"RTN","PSUV2",175,0)
 .S PSUPTN=0
"RTN","PSUV2",176,0)
 .F  S PSUPTN=$O(^DPT("SSN",PSUSSN,PSUPTN)) Q:PSUPTN=""  D
"RTN","PSUV2",177,0)
 ..S PSUPICN1=$$GETICN^MPIF001(PSUPTN) D
"RTN","PSUV2",178,0)
 ...I PSUPICN1'[-1 D
"RTN","PSUV2",179,0)
 ....S ^XTMP("PSU_"_PSUJOB,"PSUPICN")=PSUPICN1
"RTN","PSUV2",180,0)
 ...I PSUPICN1[-1 S ^XTMP("PSU_"_PSUJOB,"PSUPICN")=""
"RTN","PSUV2",181,0)
 Q
"RTN","PSUV3")
0^117^B9610138
"RTN","PSUV3",1,0)
PSUV3 ;BIR/CFL - Create mailman messages ;10 JUL 1999
"RTN","PSUV3",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV3",3,0)
 ;DBIAs
"RTN","PSUV3",4,0)
 ; Reference to file #4.3  supported by DBIA 2496
"RTN","PSUV3",5,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUV3",6,0)
 ;
"RTN","PSUV3",7,0)
EN(PSUMSGT) ;
"RTN","PSUV3",8,0)
 ;
"RTN","PSUV3",9,0)
 S PSUNOREC="",NONE=""
"RTN","PSUV3",10,0)
 S PSUMSGT("M")=0,PSUMSGT("L")=0
"RTN","PSUV3",11,0)
 I '$D(^XTMP(PSUIVSUB,"RECORDS")) D NODATA Q  ;Do not go any further if there is no data to report
"RTN","PSUV3",12,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"PSUFLAG")) D AMIS
"RTN","PSUV3",13,0)
 S PSUDIV=0,Z=0
"RTN","PSUV3",14,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUV3",15,0)
 .I PSUSMRY=1 D GETDIV Q  ;Print only the summary report
"RTN","PSUV3",16,0)
 .I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) D XMD,SETCNT
"RTN","PSUV3",17,0)
 .D GETDIV
"RTN","PSUV3",18,0)
 .D DRUGSUM^PSUV4
"RTN","PSUV3",19,0)
 Q
"RTN","PSUV3",20,0)
 ;
"RTN","PSUV3",21,0)
AMIS ;AMIS SUMMARY
"RTN","PSUV3",22,0)
 D EN^PSUV6    ;LVP AMIS Summary Data
"RTN","PSUV3",23,0)
 D EN^PSUV7    ;PB AMIS Summary Data
"RTN","PSUV3",24,0)
 D EN^PSUV8    ;TPN AMIS Summary Data
"RTN","PSUV3",25,0)
 D EN^PSUV9    ;CHEMO AMIS Summary Data
"RTN","PSUV3",26,0)
 D EN^PSUV10   ;SYRINGE AMIS Summary Data
"RTN","PSUV3",27,0)
 Q
"RTN","PSUV3",28,0)
XMD ;
"RTN","PSUV3",29,0)
 ;
"RTN","PSUV3",30,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUV3",31,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUV3",32,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUV3",33,0)
 K ^XTMP(PSUIVSUB,"XMD")
"RTN","PSUV3",34,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUV3",35,0)
 F PSULC=1:1 S X=$G(^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSULC)) Q:X=""  D
"RTN","PSUV3",36,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUV3",37,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUV3",38,0)
 .I $L(X)<235 S ^XTMP(PSUIVSUB,"XMD",PSUMC,PSUMLC)=X Q
"RTN","PSUV3",39,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUV3",40,0)
 .S ^XTMP(PSUIVSUB,"XMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUV3",41,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUV3",42,0)
 .S ^XTMP(PSUIVSUB,"XMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUV3",43,0)
 ;
"RTN","PSUV3",44,0)
 ;   Count Lines sent
"RTN","PSUV3",45,0)
 S PSUTLC=0
"RTN","PSUV3",46,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP(PSUIVSUB,"XMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUV3",47,0)
 ;
"RTN","PSUV3",48,0)
 ;   Transmit Messages
"RTN","PSUV3",49,0)
VARS ; Setup variables for contents
"RTN","PSUV3",50,0)
 F PSUM=1:1:PSUMC D
"RTN","PSUV3",51,0)
 .D GETDIV
"RTN","PSUV3",52,0)
 .S XMSUB="V. 4.0 PBMIV "_PSUMON_" "_PSUM_"/"_PSUMC_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUV3",53,0)
 .S XMTEXT="^XTMP(PSUIVSUB,""XMD"",PSUM,"
"RTN","PSUV3",54,0)
 .S XMCHAN=1
"RTN","PSUV3",55,0)
 .S XMDUZ=DUZ
"RTN","PSUV3",56,0)
 .M XMY=PSUXMYH
"RTN","PSUV3",57,0)
 .D ^XMD
"RTN","PSUV3",58,0)
 ;
"RTN","PSUV3",59,0)
 I NONE S PSUTLC=0
"RTN","PSUV3",60,0)
 S PSUMSG("M")=PSUMC
"RTN","PSUV3",61,0)
 S PSUMSG("L")=PSUTLC
"RTN","PSUV3",62,0)
 Q
"RTN","PSUV3",63,0)
NODATA ;Send "No data to report" message
"RTN","PSUV3",64,0)
 S PSUDIV=PSUSNDR
"RTN","PSUV3",65,0)
 S ^XTMP(PSUIVSUB,"RECORDS",PSUDIV,1)="No data to report"
"RTN","PSUV3",66,0)
 S NONE=1
"RTN","PSUV3",67,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUNONE","IV")=""
"RTN","PSUV3",68,0)
 M PSUXMYH=PSUXMYS1
"RTN","PSUV3",69,0)
 D XMD
"RTN","PSUV3",70,0)
SETCNT ;Set message count and line count
"RTN","PSUV3",71,0)
 S PSUMSGT(PSUDIV,"M")=$G(PSUMSGT(PSUDIV,"M"))+PSUMSG("M")
"RTN","PSUV3",72,0)
 S PSUMSGT(PSUDIV,"L")=$G(PSUMSGT(PSUDIV,"L"))+PSUMSG("L")
"RTN","PSUV3",73,0)
 S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUDIV,PSUOPTN,"M")=PSUMSGT(PSUDIV,"M")
"RTN","PSUV3",74,0)
 S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUDIV,PSUOPTN,"L")=PSUMSGT(PSUDIV,"L")
"RTN","PSUV3",75,0)
 Q
"RTN","PSUV3",76,0)
GETDIV ;get division name
"RTN","PSUV3",77,0)
 S X=PSUDIV,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUV3",78,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUV3",79,0)
 S ^XTMP("PSU_"_PSUJOB,"DIV",PSUDIV)=PSUDIVNM
"RTN","PSUV3",80,0)
 Q
"RTN","PSUV4")
0^118^B16755702
"RTN","PSUV4",1,0)
PSUV4 ;BIR/CFL - Drug Summary & Record Summary Print Setup ;25 SEP 1998
"RTN","PSUV4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV4",3,0)
RECSUM ;EP Generate statistical summary
"RTN","PSUV4",4,0)
 I PSUNOREC Q
"RTN","PSUV4",5,0)
 K PSULINE,J
"RTN","PSUV4",6,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y
"RTN","PSUV4",7,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y
"RTN","PSUV4",8,0)
 F I=1:1:17 S J(I)=$P(^XTMP(PSUIVSUB,"SUMMARY",PSUDIV,0),"^",I)
"RTN","PSUV4",9,0)
 S PSULINE(1)="IV Statistical Data Summary for "_PSUDTS_" through "_PSUDTE
"RTN","PSUV4",10,0)
 S PSULINE(2)=" "
"RTN","PSUV4",11,0)
 S X="Total IV orders:",X=$$SETSTR^VALM1(J(1),X,19,$L(J(1))),X=$$SETSTR^VALM1("Total Patients:",X,39,15)
"RTN","PSUV4",12,0)
 S X=$$SETSTR^VALM1(J(2),X,57,$L(J(2)))
"RTN","PSUV4",13,0)
 S PSULINE(3)=X
"RTN","PSUV4",14,0)
 S X="Total IV bags dispensed:",X=$$SETSTR^VALM1(J(3),X,26,$L(J(3)))
"RTN","PSUV4",15,0)
 S X=$$SETSTR^VALM1("Total Cost: $",X,39,13),X=$$SETSTR^VALM1(J(4),X,52,$L(J(4)))
"RTN","PSUV4",16,0)
 S PSULINE(4)=X
"RTN","PSUV4",17,0)
 S PSULINE(5)=" "
"RTN","PSUV4",18,0)
 S PSULINE(6)="Breakdown of IV orders:"
"RTN","PSUV4",19,0)
 S PSULINE(7)=" "
"RTN","PSUV4",20,0)
 S X="Total Outpatient IV orders:",X=$$SETSTR^VALM1(J(5),X,29,$L(J(5)))
"RTN","PSUV4",21,0)
 S X=$$SETSTR^VALM1("Total Outpatient IV bags dispensed:",X,39,35),X=$$SETSTR^VALM1(J(6),X,75,$L(J(6)))
"RTN","PSUV4",22,0)
 S PSULINE(8)=X
"RTN","PSUV4",23,0)
 S X="Total Outpatient Cost: $",X=$$SETSTR^VALM1(J(7),X,25,$L(J(7)))
"RTN","PSUV4",24,0)
 S PSULINE(9)=X
"RTN","PSUV4",25,0)
 S PSULINE(10)=" "
"RTN","PSUV4",26,0)
 S X="Total Piggybacks:",X=$$SETSTR^VALM1(J(8),X,20,$L(J(8)))
"RTN","PSUV4",27,0)
 S X=$$SETSTR^VALM1("Avg. cost per Piggyback: $",X,39,26),X=$$SETSTR^VALM1(J(9),X,65,$L(J(9)))
"RTN","PSUV4",28,0)
 S PSULINE(11)=X
"RTN","PSUV4",29,0)
 S X="Total Hyperals:",X=$$SETSTR^VALM1(J(10),X,17,$L(J(10)))
"RTN","PSUV4",30,0)
 S X=$$SETSTR^VALM1("Avg. cost per Hyperal: $",X,39,24),X=$$SETSTR^VALM1(J(11),X,63,$L(J(11)))
"RTN","PSUV4",31,0)
 S PSULINE(12)=X
"RTN","PSUV4",32,0)
 S X="Total Admixtures:",X=$$SETSTR^VALM1(J(12),X,19,$L(J(12)))
"RTN","PSUV4",33,0)
 S X=$$SETSTR^VALM1("Avg. cost per Admixture: $",X,39,26),X=$$SETSTR^VALM1(J(13),X,65,$L(J(13)))
"RTN","PSUV4",34,0)
 S PSULINE(13)=X
"RTN","PSUV4",35,0)
 S X="Total Chemotherapy:",X=$$SETSTR^VALM1(J(14),X,21,$L(J(14)))
"RTN","PSUV4",36,0)
 S X=$$SETSTR^VALM1("Avg. cost per Chemotherapy: $",X,39,29),X=$$SETSTR^VALM1(J(15),X,68,$L(J(15)))
"RTN","PSUV4",37,0)
 S PSULINE(14)=X
"RTN","PSUV4",38,0)
 S X="Total Syringes:",X=$$SETSTR^VALM1(J(16),X,17,$L(J(16)))
"RTN","PSUV4",39,0)
 S X=$$SETSTR^VALM1("Avg. cost per Syringe: $",X,39,24)
"RTN","PSUV4",40,0)
 S X=$$SETSTR^VALM1(J(17),X,63,$L(J(17)))
"RTN","PSUV4",41,0)
 S PSULINE(15)=X
"RTN","PSUV4",42,0)
 S XMCHAN=1
"RTN","PSUV4",43,0)
 S XMSUB="V. 4.0 PBMIV "_$G(PSUMON)_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUV4",44,0)
 S XMTEXT="PSULINE("
"RTN","PSUV4",45,0)
 M XMY=PSUXMYS1
"RTN","PSUV4",46,0)
 D ^XMD
"RTN","PSUV4",47,0)
 M ^XTMP(PSUIVSUB,"STATSUM",PSUDIV)=PSULINE
"RTN","PSUV4",48,0)
 Q
"RTN","PSUV4",49,0)
DRUGSUM ; EP generate drug summary
"RTN","PSUV4",50,0)
 S Y=PSUSDT X ^DD("DD") S PSUDTS=Y
"RTN","PSUV4",51,0)
 S Y=PSUEDT X ^DD("DD") S PSUDTE=Y
"RTN","PSUV4",52,0)
 S $P(DASH,"-",79)=""
"RTN","PSUV4",53,0)
 S PSUDRG=""
"RTN","PSUV4",54,0)
 K PSULINE
"RTN","PSUV4",55,0)
 S PSULINE(1)="IV Statistical Data for "_PSUDTS_" through "_PSUDTE
"RTN","PSUV4",56,0)
 S PSULINE(2)=" "
"RTN","PSUV4",57,0)
 S X="",X=$$SETSTR^VALM1("Drug",X,42,4),X=$$SETSTR^VALM1("Total",X,54,5),X=$$SETSTR^VALM1("Number",X,67,6)
"RTN","PSUV4",58,0)
 S PSULINE(3)=X
"RTN","PSUV4",59,0)
 S X="Drug Name",X=$$SETSTR^VALM1("Strength",X,42,8),X=$$SETSTR^VALM1("Dispensed",X,54,9)
"RTN","PSUV4",60,0)
 S X=$$SETSTR^VALM1("of bags",X,67,7)
"RTN","PSUV4",61,0)
 S PSULINE(4)=X
"RTN","PSUV4",62,0)
 S PSULINE(5)=DASH
"RTN","PSUV4",63,0)
 S PSNAME="",PSLN=6,PSUGTD=0,PSUGTB=0
"RTN","PSUV4",64,0)
 F  S PSNAME=$O(^XTMP(PSUIVSUB,"DRUG",PSUDIV,PSNAME)) Q:PSNAME=""  D
"RTN","PSUV4",65,0)
 .S DATA=^XTMP(PSUIVSUB,"DRUG",PSUDIV,PSNAME)
"RTN","PSUV4",66,0)
 .S PSUNIT=$P(DATA,U),PSDISP=$P(DATA,U,2),PSBAGS=$P(DATA,U,3)
"RTN","PSUV4",67,0)
 .S PSUNON=$P(DATA,U,4),PSUNFI=$P(DATA,U,5)
"RTN","PSUV4",68,0)
 .S PSNAME=PSNAME_" "_$S(PSUNON="N/F":"*",1:"")_$S(PSUNFI=0:"#",1:"")
"RTN","PSUV4",69,0)
 .S LINE=""
"RTN","PSUV4",70,0)
 .S $E(LINE,1,41)=PSNAME
"RTN","PSUV4",71,0)
 .S $E(LINE,42,50)=PSUNIT
"RTN","PSUV4",72,0)
 .S $E(LINE,51,66)=$J(PSDISP,12,2)
"RTN","PSUV4",73,0)
 .S $E(LINE,67,80)=$J(PSBAGS,5,0)
"RTN","PSUV4",74,0)
 .S PSULINE(PSLN)=LINE
"RTN","PSUV4",75,0)
 .S PSLN=PSLN+1,PSUGTD=PSUGTD+PSDISP,PSUGTB=PSUGTB+PSBAGS
"RTN","PSUV4",76,0)
 S PSULINE(PSLN)=DASH
"RTN","PSUV4",77,0)
 S PSLN=PSLN+1
"RTN","PSUV4",78,0)
 S LINE=""
"RTN","PSUV4",79,0)
 S $E(LINE,1,41)="Totals:"
"RTN","PSUV4",80,0)
 S $E(LINE,51,66)=$J(PSUGTD,12,2)
"RTN","PSUV4",81,0)
 S $E(LINE,67,80)=$J(PSUGTB,5,0)
"RTN","PSUV4",82,0)
 S PSULINE(PSLN)=LINE
"RTN","PSUV4",83,0)
 S PSLN=PSLN+1
"RTN","PSUV4",84,0)
 S PSULINE(PSLN)=""
"RTN","PSUV4",85,0)
 S PSLN=PSLN+1
"RTN","PSUV4",86,0)
 S PSULINE(PSLN)="* Non Formulary"
"RTN","PSUV4",87,0)
 S PSLN=PSLN+1
"RTN","PSUV4",88,0)
 S PSULINE(PSLN)="# Not on National Formulary"
"RTN","PSUV4",89,0)
 S XMCHAN=1
"RTN","PSUV4",90,0)
 S XMSUB="V. 4.0 PBMIV "_$G(PSUMON)_" "_PSUDIV_" "_PSUDIVNM
"RTN","PSUV4",91,0)
 M XMY=PSUXMYS2
"RTN","PSUV4",92,0)
 S XMTEXT="PSULINE("
"RTN","PSUV4",93,0)
 D ^XMD
"RTN","PSUV4",94,0)
 M ^XTMP(PSUIVSUB,"DRUGSUM",PSUDIV)=PSULINE
"RTN","PSUV4",95,0)
 Q
"RTN","PSUV5")
0^119^B12199979
"RTN","PSUV5",1,0)
PSUV5 ;BIR/PDW - Pharmacy Benefits Mgt IV Printer Output ;10 JUL 1999
"RTN","PSUV5",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV5",3,0)
 ;DBIA(s)
"RTN","PSUV5",4,0)
 ; Reference to file #40.8 supported by DBIA 2438
"RTN","PSUV5",5,0)
 ;
"RTN","PSUV5",6,0)
EN ;EP entry for IV statistical output
"RTN","PSUV5",7,0)
 NEW PSUI,PSUH,PSUL,PSUM,PSUPGS,ENDIT
"RTN","PSUV5",8,0)
 D DT^DILF("E",PSUSDT,.EXTD)
"RTN","PSUV5",9,0)
 S PSURP("START")=EXTD(0)
"RTN","PSUV5",10,0)
 D DT^DILF("E",PSUEDT,.EXTD)
"RTN","PSUV5",11,0)
 S PSURP("END")=EXTD(0)
"RTN","PSUV5",12,0)
 ;I '$D(^XTMP(PSUIVSUB,"STATSUM")) D NOSUM
"RTN","PSUV5",13,0)
 S PSUFACN=""
"RTN","PSUV5",14,0)
 F  S PSUFACN=$O(^XTMP(PSUIVSUB,"STATSUM",PSUFACN)) Q:PSUFACN=""  D
"RTN","PSUV5",15,0)
 .;D PRTSUM  ;Eliminate this report with Phase II 7-19-04
"RTN","PSUV5",16,0)
 .I PSUSMRY Q  ;Quit if user requests the summary report only
"RTN","PSUV5",17,0)
 .D PRTDRUG
"RTN","PSUV5",18,0)
 ;
"RTN","PSUV5",19,0)
 I '$D(^XTMP("PSU_"_PSUJOB,"CBAMIS")) D PRTAMIS  ;Print IV AMIS summary
"RTN","PSUV5",20,0)
 ;
"RTN","PSUV5",21,0)
 D PULL^PSUCP
"RTN","PSUV5",22,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUV5",23,0)
 ;
"RTN","PSUV5",24,0)
 I $D(PSUMOD(1))&'$D(PSUMOD(2)) D
"RTN","PSUV5",25,0)
 .I '$D(PSUMOD(4)) D
"RTN","PSUV5",26,0)
 ..D IVSUM^PSUDEM0
"RTN","PSUV5",27,0)
 ;
"RTN","PSUV5",28,0)
 Q
"RTN","PSUV5",29,0)
PRTSUM ;Print the statistical summary report
"RTN","PSUV5",30,0)
 U IO
"RTN","PSUV5",31,0)
 ;VMP-IOFO BAY PINES;ELR;PSU*3.0*26 REMOVED FORM FEED
"RTN","PSUV5",32,0)
 ;W @IOF
"RTN","PSUV5",33,0)
 D GETNAME
"RTN","PSUV5",34,0)
 S X=^XTMP(PSUIVSUB,"STATSUM",PSUFACN,1)
"RTN","PSUV5",35,0)
 W !,X_" for "_PSUDIVNM
"RTN","PSUV5",36,0)
 W !!,?68,"Page: 1"  ;Statistical summary will always be 1 page only
"RTN","PSUV5",37,0)
 S PSUL=1
"RTN","PSUV5",38,0)
 F  S PSUL=$O(^XTMP(PSUIVSUB,"STATSUM",PSUFACN,PSUL)) Q:PSUL=""  D
"RTN","PSUV5",39,0)
 .W !,^XTMP(PSUIVSUB,"STATSUM",PSUFACN,PSUL)
"RTN","PSUV5",40,0)
 ;
"RTN","PSUV5",41,0)
 Q
"RTN","PSUV5",42,0)
 ;
"RTN","PSUV5",43,0)
PRTAMIS ;Print the IV AMIS Summary report
"RTN","PSUV5",44,0)
 ;
"RTN","PSUV5",45,0)
 S PSUPGS("PG")=1
"RTN","PSUV5",46,0)
 D PGHDR1
"RTN","PSUV5",47,0)
 S PSUL=3
"RTN","PSUV5",48,0)
 F  S PSUL=$O(^XTMP("PSU_"_PSUJOB,"IVAMIS",PSUL)) Q:PSUL=""  D
"RTN","PSUV5",49,0)
 .I LNCNT+4>IOSL D PGHDR1
"RTN","PSUV5",50,0)
 .W !,^XTMP("PSU_"_PSUJOB,"IVAMIS",PSUL)
"RTN","PSUV5",51,0)
 .S LNCNT=LNCNT+1
"RTN","PSUV5",52,0)
 ;
"RTN","PSUV5",53,0)
 Q
"RTN","PSUV5",54,0)
 ;
"RTN","PSUV5",55,0)
PRTDRUG ;Print the Statistical Drug Report
"RTN","PSUV5",56,0)
 I '$D(^XTMP(PSUIVSUB,"DRUGSUM")) D NODRUG
"RTN","PSUV5",57,0)
 S PSUPGS("PG")=1
"RTN","PSUV5",58,0)
 D PGHDR
"RTN","PSUV5",59,0)
 S PSUL=5
"RTN","PSUV5",60,0)
 F  S PSUL=$O(^XTMP(PSUIVSUB,"DRUGSUM",PSUFACN,PSUL)) Q:PSUL=""  D
"RTN","PSUV5",61,0)
 .I LNCNT+4>IOSL D PGHDR
"RTN","PSUV5",62,0)
 .W !,^XTMP(PSUIVSUB,"DRUGSUM",PSUFACN,PSUL)
"RTN","PSUV5",63,0)
 .S LNCNT=LNCNT+1
"RTN","PSUV5",64,0)
 ;
"RTN","PSUV5",65,0)
 Q
"RTN","PSUV5",66,0)
PGHDR ;
"RTN","PSUV5",67,0)
 U IO W @IOF
"RTN","PSUV5",68,0)
 W !,^XTMP(PSUIVSUB,"DRUGSUM",PSUFACN,1)
"RTN","PSUV5",69,0)
 W " for ",PSUDIVNM
"RTN","PSUV5",70,0)
 W !!,?68,"Page: ",PSUPGS("PG")
"RTN","PSUV5",71,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUV5",72,0)
 F PSUH=2:1:5 W !,$G(^XTMP(PSUIVSUB,"DRUGSUM",PSUFACN,PSUH))
"RTN","PSUV5",73,0)
 S LNCNT=5
"RTN","PSUV5",74,0)
 Q
"RTN","PSUV5",75,0)
PGHDR1 ;Print headings for statistical report
"RTN","PSUV5",76,0)
 U IO
"RTN","PSUV5",77,0)
 W @IOF
"RTN","PSUV5",78,0)
 W !,^XTMP("PSU_"_PSUJOB,"IVAMIS",1)
"RTN","PSUV5",79,0)
 W !!,?68,"Page: ",PSUPGS("PG")
"RTN","PSUV5",80,0)
 S PSUPGS("PG")=PSUPGS("PG")+1
"RTN","PSUV5",81,0)
 W !,$G(^XTMP("PSU_"_PSUJOB,"IVAMIS",2))
"RTN","PSUV5",82,0)
 S LNCNT=3
"RTN","PSUV5",83,0)
 Q
"RTN","PSUV5",84,0)
NOSUM ;Set up no data to report global if there is no statistical data
"RTN","PSUV5",85,0)
 S ^XTMP(PSUIVSUB,"STATSUM",PSUSNDR,1)="IV Statistical Data Summary for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUV5",86,0)
 S ^XTMP(PSUIVSUB,"STATSUM",PSUSNDR,2)=""
"RTN","PSUV5",87,0)
 S ^XTMP(PSUIVSUB,"STATSUM",PSUSNDR,3)="No data to report"
"RTN","PSUV5",88,0)
 S PSUFACN=PSUSNDR
"RTN","PSUV5",89,0)
 Q
"RTN","PSUV5",90,0)
NODRUG ;Set up the no data to report temp global if there is no drug data
"RTN","PSUV5",91,0)
 S ^XTMP(PSUIVSUB,"DRUGSUM",PSUSNDR,1)="IV Statistical Data for "_PSURP("START")_" through "_PSURP("END")
"RTN","PSUV5",92,0)
 S ^XTMP(PSUIVSUB,"DRUGSUM",PSUSNDR,2)=""
"RTN","PSUV5",93,0)
 S ^XTMP(PSUIVSUB,"DRUGSUM",PSUSNDR,3)="No data to report"
"RTN","PSUV5",94,0)
 S PSUFACN=PSUSNDR
"RTN","PSUV5",95,0)
GETNAME ;Get the facility name
"RTN","PSUV5",96,0)
 S X=PSUFACN,DIC=40.8,DIC(0)="X",D="C" D IX^DIC ;**1
"RTN","PSUV5",97,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUV5",98,0)
 Q
"RTN","PSUV6")
0^120^B32261873
"RTN","PSUV6",1,0)
PSUV6 ;BIR/DAM - IV LVP AMIS Summary Data;11 March 2004
"RTN","PSUV6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV6",3,0)
 ;
"RTN","PSUV6",4,0)
 ;This routine gathers IV LVP AMIS Summary data
"RTN","PSUV6",5,0)
 ;No DBIA's needed
"RTN","PSUV6",6,0)
 ;
"RTN","PSUV6",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUIV3
"RTN","PSUV6",8,0)
 ;
"RTN","PSUV6",9,0)
 K PSUIVA      ;Array to hold temporary data
"RTN","PSUV6",10,0)
 ;Initialize variables for column totals
"RTN","PSUV6",11,0)
 ;
"RTN","PSUV6",12,0)
 ;
"RTN","PSUV6",13,0)
 S PSUDIV=0
"RTN","PSUV6",14,0)
 S PSUCT=0
"RTN","PSUV6",15,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D EN1
"RTN","PSUV6",16,0)
 Q
"RTN","PSUV6",17,0)
 ;
"RTN","PSUV6",18,0)
EN1 ;EN CONTINUED
"RTN","PSUV6",19,0)
 ;
"RTN","PSUV6",20,0)
 S PSUOR=""
"RTN","PSUV6",21,0)
 N LDSP,LREC,LDES,CLAN,NDSP,LTOT,CNDSP
"RTN","PSUV6",22,0)
 F  S PSUCT=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUV6",23,0)
 .K PSUAMIS
"RTN","PSUV6",24,0)
 .M PSUAMIS(PSUDIV,PSUCT)=^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)
"RTN","PSUV6",25,0)
 .;
"RTN","PSUV6",26,0)
 .S PSUP=""
"RTN","PSUV6",27,0)
 .S PSUP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,5)      ;Parent record
"RTN","PSUV6",28,0)
 .;
"RTN","PSUV6",29,0)
 .S PSUTYP=""
"RTN","PSUV6",30,0)
 .S PSUTYP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,6)    ;IV TYPE
"RTN","PSUV6",31,0)
 .;
"RTN","PSUV6",32,0)
 .I PSUTYP="A" S PSUOR=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,4)    ;IV order
"RTN","PSUV6",33,0)
 .D LVPDSP
"RTN","PSUV6",34,0)
 .D LVPREC
"RTN","PSUV6",35,0)
 .D LVPDES
"RTN","PSUV6",36,0)
 .D LVPCAN
"RTN","PSUV6",37,0)
 .D LVPNET
"RTN","PSUV6",38,0)
 .D LVPTOT
"RTN","PSUV6",39,0)
 .D CNET
"RTN","PSUV6",40,0)
 .D REC
"RTN","PSUV6",41,0)
 D TOTAL
"RTN","PSUV6",42,0)
 ;
"RTN","PSUV6",43,0)
 Q
"RTN","PSUV6",44,0)
 ;
"RTN","PSUV6",45,0)
LVPDSP ;Gather LVP Dispensed data
"RTN","PSUV6",46,0)
 ;
"RTN","PSUV6",47,0)
 I PSUTYP="A",PSUP="P" D                         ;LVPs Dispensed
"RTN","PSUV6",48,0)
 .N DSP
"RTN","PSUV6",49,0)
 .S DSP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,29)
"RTN","PSUV6",50,0)
 .S $P(PSUIVA(PSUDIV),U,1)=$P($G(PSUIVA(PSUDIV)),U,1)+DSP
"RTN","PSUV6",51,0)
 ;
"RTN","PSUV6",52,0)
 Q
"RTN","PSUV6",53,0)
 ;
"RTN","PSUV6",54,0)
LVPREC ;Gather LVP Recycled data
"RTN","PSUV6",55,0)
 ;
"RTN","PSUV6",56,0)
 I PSUTYP="A",PSUP="P" D                         ;LVP's recycled
"RTN","PSUV6",57,0)
 .N REC
"RTN","PSUV6",58,0)
 .S REC=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,30)
"RTN","PSUV6",59,0)
 .S $P(PSUIVA(PSUDIV),U,2)=$P($G(PSUIVA(PSUDIV)),U,2)+REC
"RTN","PSUV6",60,0)
 ;
"RTN","PSUV6",61,0)
 Q
"RTN","PSUV6",62,0)
 ;
"RTN","PSUV6",63,0)
LVPDES ;Gather LVP Destroyed data
"RTN","PSUV6",64,0)
 ;
"RTN","PSUV6",65,0)
 I PSUTYP="A",PSUP="P" D                        ;LVP's destroyed
"RTN","PSUV6",66,0)
 .N DES
"RTN","PSUV6",67,0)
 .S DES=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,31)
"RTN","PSUV6",68,0)
 .S $P(PSUIVA(PSUDIV),U,3)=$P($G(PSUIVA(PSUDIV)),U,3)+DES
"RTN","PSUV6",69,0)
 ;
"RTN","PSUV6",70,0)
 Q
"RTN","PSUV6",71,0)
 ;
"RTN","PSUV6",72,0)
LVPCAN ;Gather LvP Cancelled data
"RTN","PSUV6",73,0)
 ;
"RTN","PSUV6",74,0)
 I PSUTYP="A",PSUP="P" D                         ;LVP's cancelled
"RTN","PSUV6",75,0)
 .N CAN
"RTN","PSUV6",76,0)
 .S CAN=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,32)
"RTN","PSUV6",77,0)
 .S $P(PSUIVA(PSUDIV),U,4)=$P($G(PSUIVA(PSUDIV)),U,4)+CAN
"RTN","PSUV6",78,0)
 ;
"RTN","PSUV6",79,0)
 Q
"RTN","PSUV6",80,0)
 ;
"RTN","PSUV6",81,0)
LVPNET ;Calculate net amount of LVP's Dispensed
"RTN","PSUV6",82,0)
 ;
"RTN","PSUV6",83,0)
 ;
"RTN","PSUV6",84,0)
 I PSUTYP="A",PSUP="P" D
"RTN","PSUV6",85,0)
 .N NET
"RTN","PSUV6",86,0)
 .S NET=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,11)
"RTN","PSUV6",87,0)
 .S $P(PSUIVA(PSUDIV),U,5)=$P($G(PSUIVA(PSUDIV)),U,5)+NET
"RTN","PSUV6",88,0)
 ;
"RTN","PSUV6",89,0)
 Q
"RTN","PSUV6",90,0)
 ;
"RTN","PSUV6",91,0)
LVPTOT ;Calculate Total cost
"RTN","PSUV6",92,0)
 ;
"RTN","PSUV6",93,0)
 N NDIS,COST,PSUOR1
"RTN","PSUV6",94,0)
 S PSUCTA=0
"RTN","PSUV6",95,0)
 F  S PSUCTA=$O(PSUAMIS(PSUDIV,PSUCTA)) Q:PSUCTA=""  D
"RTN","PSUV6",96,0)
 .S PSUOR1=$P(PSUAMIS(PSUDIV,PSUCTA),U,4)
"RTN","PSUV6",97,0)
 .Q:(PSUOR1'=PSUOR)
"RTN","PSUV6",98,0)
 .S NDIS=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,33)
"RTN","PSUV6",99,0)
 .S COST=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,22)
"RTN","PSUV6",100,0)
 .S $P(PSUIVA(PSUDIV),U,6)=$P($G(PSUIVA(PSUDIV)),U,6)+(NDIS*$G(COST))
"RTN","PSUV6",101,0)
 .;
"RTN","PSUV6",102,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV6",103,0)
 .N A,B,C
"RTN","PSUV6",104,0)
 .;
"RTN","PSUV6",105,0)
 .I $P(PSUIVA(PSUDIV),U,6)'["." D  Q
"RTN","PSUV6",106,0)
 ..S $P(PSUIVA(PSUDIV),U,6)=$P(PSUIVA(PSUDIV),U,6)_".00"
"RTN","PSUV6",107,0)
 .;
"RTN","PSUV6",108,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,6),".")  ;Find 1st position after decimal
"RTN","PSUV6",109,0)
 .;
"RTN","PSUV6",110,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,6),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV6",111,0)
 .;
"RTN","PSUV6",112,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,6),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV6",113,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV6",114,0)
 .;
"RTN","PSUV6",115,0)
 .S $P(PSUIVA(PSUDIV),U,6)=B_C
"RTN","PSUV6",116,0)
 Q
"RTN","PSUV6",117,0)
 ;
"RTN","PSUV6",118,0)
CNET ;Calculate Cost per Net LVP's dispensed
"RTN","PSUV6",119,0)
 ;
"RTN","PSUV6",120,0)
 N CNET,TCOST
"RTN","PSUV6",121,0)
 ;
"RTN","PSUV6",122,0)
 S CNET=$P($G(PSUIVA(PSUDIV)),U,5)
"RTN","PSUV6",123,0)
 S TCOST=$P($G(PSUIVA(PSUDIV)),U,6)
"RTN","PSUV6",124,0)
 ;
"RTN","PSUV6",125,0)
 I CNET'="",CNET'=0,TCOST'="" D
"RTN","PSUV6",126,0)
 .S $P(PSUIVA(PSUDIV),U,7)=TCOST/CNET
"RTN","PSUV6",127,0)
 .;
"RTN","PSUV6",128,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV6",129,0)
 .N A,B,C
"RTN","PSUV6",130,0)
 .;
"RTN","PSUV6",131,0)
 .I $P(PSUIVA(PSUDIV),U,7)'["." D  Q
"RTN","PSUV6",132,0)
 ..S $P(PSUIVA(PSUDIV),U,7)=$P(PSUIVA(PSUDIV),U,7)_".00"
"RTN","PSUV6",133,0)
 .;
"RTN","PSUV6",134,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,7),".")  ;Find 1st position after decimal
"RTN","PSUV6",135,0)
 .;
"RTN","PSUV6",136,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,7),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV6",137,0)
 .;
"RTN","PSUV6",138,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,7),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV6",139,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV6",140,0)
 .;
"RTN","PSUV6",141,0)
 .S $P(PSUIVA(PSUDIV),U,7)=B_C
"RTN","PSUV6",142,0)
 ;
"RTN","PSUV6",143,0)
 Q
"RTN","PSUV6",144,0)
 ;
"RTN","PSUV6",145,0)
TOTAL ;Add up column totals and place into ^XTMP global
"RTN","PSUV6",146,0)
 ;
"RTN","PSUV6",147,0)
 S PSUDI=0
"RTN","PSUV6",148,0)
 F  S PSUDI=$O(PSUIVA(PSUDI)) Q:PSUDI=""  D
"RTN","PSUV6",149,0)
 .S LDSP=$G(LDSP)+$P(PSUIVA(PSUDI),U,1)   ;Total LVP's dispensed
"RTN","PSUV6",150,0)
 .;
"RTN","PSUV6",151,0)
 .S LREC=$G(LREC)+$P(PSUIVA(PSUDI),U,2)   ;Total LVP's recycled
"RTN","PSUV6",152,0)
 .;
"RTN","PSUV6",153,0)
 .S LDES=$G(LDES)+$P(PSUIVA(PSUDI),U,3)   ;Total LVP's destroyed
"RTN","PSUV6",154,0)
 .;
"RTN","PSUV6",155,0)
 .S CLAN=$G(CLAN)+$P(PSUIVA(PSUDI),U,4)   ;Total LVP's cancelled
"RTN","PSUV6",156,0)
 .;
"RTN","PSUV6",157,0)
 .S NDSP=$G(NDSP)+$P(PSUIVA(PSUDI),U,5)   ;Total Net LVP's dispensed
"RTN","PSUV6",158,0)
 .;
"RTN","PSUV6",159,0)
 .S LTOT=$G(LTOT)+$P(PSUIVA(PSUDI),U,6)   ;Total of Total cost
"RTN","PSUV6",160,0)
 .;
"RTN","PSUV6",161,0)
 .;S CNDSP=$G(CNDSP)+$P(PSUIVA(PSUDI),U,7) ;Total of cost/net column
"RTN","PSUV6",162,0)
 .I $G(NDSP) S CNDSP=$G(LTOT)/NDSP D
"RTN","PSUV6",163,0)
 ..I CNDSP'["." S CNDSP=CNDSP_".00" Q
"RTN","PSUV6",164,0)
 ..N A,B,C
"RTN","PSUV6",165,0)
 ..S A=$F(CNDSP,".")  ;Find 1st position after decimal
"RTN","PSUV6",166,0)
 ..S B=$E(CNDSP,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUV6",167,0)
 ..S C=$E(CNDSP,A,(A+1))   ;Extract cents after decimal
"RTN","PSUV6",168,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV6",169,0)
 ..S CNDSP=B_C
"RTN","PSUV6",170,0)
 ;
"RTN","PSUV6",171,0)
 S ^XTMP(PSUIVSUB,"LVPTOT")=LDSP_U_LREC_U_LDES_U_CLAN_U_NDSP_U_LTOT_U_CNDSP
"RTN","PSUV6",172,0)
 ;
"RTN","PSUV6",173,0)
 Q
"RTN","PSUV6",174,0)
 ;
"RTN","PSUV6",175,0)
REC ;Place contents of arrays into ^XTMP globals
"RTN","PSUV6",176,0)
 ;
"RTN","PSUV6",177,0)
 M ^XTMP(PSUIVSUB,"LVP",PSUDIV)=PSUIVA(PSUDIV)   ;LVP RECORDS
"RTN","PSUV6",178,0)
 ;
"RTN","PSUV6",179,0)
 Q
"RTN","PSUV7")
0^121^B32354720
"RTN","PSUV7",1,0)
PSUV7 ;BIR/DAM - IV PB AMIS Summary Data;11 March 2004
"RTN","PSUV7",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV7",3,0)
 ;
"RTN","PSUV7",4,0)
 ;This routine gathers IV Piggyback AMIS summary data
"RTN","PSUV7",5,0)
 ;No DBIA's needed
"RTN","PSUV7",6,0)
 ;
"RTN","PSUV7",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUIV3
"RTN","PSUV7",8,0)
 ;
"RTN","PSUV7",9,0)
 K PSUIVA      ;Array to hold temporary data
"RTN","PSUV7",10,0)
 ;
"RTN","PSUV7",11,0)
 ;Initialize variables for column totals
"RTN","PSUV7",12,0)
 ;
"RTN","PSUV7",13,0)
 ;
"RTN","PSUV7",14,0)
 S PSUDIV=0
"RTN","PSUV7",15,0)
 S PSUCT=0
"RTN","PSUV7",16,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D EN1
"RTN","PSUV7",17,0)
 Q
"RTN","PSUV7",18,0)
 ;
"RTN","PSUV7",19,0)
EN1 ;EN CONTINUED
"RTN","PSUV7",20,0)
 ;
"RTN","PSUV7",21,0)
 S PSUOR=""
"RTN","PSUV7",22,0)
 N LDSP,LREC,LDES,CLAN,NDSP,LTOT,CNDSP
"RTN","PSUV7",23,0)
 F  S PSUCT=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUV7",24,0)
 .K PSUAMIS
"RTN","PSUV7",25,0)
 .M PSUAMIS(PSUDIV,PSUCT)=^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)
"RTN","PSUV7",26,0)
 .;
"RTN","PSUV7",27,0)
 .S PSUP=""
"RTN","PSUV7",28,0)
 .S PSUP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,5)      ;parent record
"RTN","PSUV7",29,0)
 .;
"RTN","PSUV7",30,0)
 .S PSUTYP=""
"RTN","PSUV7",31,0)
 .S PSUTYP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,6)    ;IV TYPE
"RTN","PSUV7",32,0)
 .;
"RTN","PSUV7",33,0)
 .I PSUTYP="P" S PSUOR=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,4) ;IV order #
"RTN","PSUV7",34,0)
 .;
"RTN","PSUV7",35,0)
 .D LVPDSP
"RTN","PSUV7",36,0)
 .D LVPREC
"RTN","PSUV7",37,0)
 .D LVPDES
"RTN","PSUV7",38,0)
 .D LVPCAN
"RTN","PSUV7",39,0)
 .D LVPNET
"RTN","PSUV7",40,0)
 .D LVPTOT
"RTN","PSUV7",41,0)
 .D CNET
"RTN","PSUV7",42,0)
 .D REC
"RTN","PSUV7",43,0)
 D TOTAL
"RTN","PSUV7",44,0)
 ;
"RTN","PSUV7",45,0)
 Q
"RTN","PSUV7",46,0)
 ;
"RTN","PSUV7",47,0)
LVPDSP ;Gather PB Dispensed data
"RTN","PSUV7",48,0)
 ;
"RTN","PSUV7",49,0)
 I PSUTYP="P",PSUP="P" D                         ;PBs Dispensed
"RTN","PSUV7",50,0)
 .N DSP
"RTN","PSUV7",51,0)
 .S DSP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,29)
"RTN","PSUV7",52,0)
 .S $P(PSUIVA(PSUDIV),U,1)=$P($G(PSUIVA(PSUDIV)),U,1)+DSP
"RTN","PSUV7",53,0)
 ;
"RTN","PSUV7",54,0)
 Q
"RTN","PSUV7",55,0)
 ;
"RTN","PSUV7",56,0)
LVPREC ;Gather PB Recycled data
"RTN","PSUV7",57,0)
 ;
"RTN","PSUV7",58,0)
 I PSUTYP="P",PSUP="P" D                         ;PB's recycled
"RTN","PSUV7",59,0)
 .N REC
"RTN","PSUV7",60,0)
 .S REC=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,30)
"RTN","PSUV7",61,0)
 .S $P(PSUIVA(PSUDIV),U,2)=$P($G(PSUIVA(PSUDIV)),U,2)+REC
"RTN","PSUV7",62,0)
 ;
"RTN","PSUV7",63,0)
 Q
"RTN","PSUV7",64,0)
 ;
"RTN","PSUV7",65,0)
LVPDES ;Gather PB Destroyed data
"RTN","PSUV7",66,0)
 ;
"RTN","PSUV7",67,0)
 I PSUTYP="P",PSUP="P" D                        ;PB's destroyed
"RTN","PSUV7",68,0)
 .N DES
"RTN","PSUV7",69,0)
 .S DES=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,31)
"RTN","PSUV7",70,0)
 .S $P(PSUIVA(PSUDIV),U,3)=$P($G(PSUIVA(PSUDIV)),U,3)+DES
"RTN","PSUV7",71,0)
 ;
"RTN","PSUV7",72,0)
 Q
"RTN","PSUV7",73,0)
 ;
"RTN","PSUV7",74,0)
LVPCAN ;Gather PB Cancelled data
"RTN","PSUV7",75,0)
 ;
"RTN","PSUV7",76,0)
 I PSUTYP="P",PSUP="P" D                         ;PB's cancelled
"RTN","PSUV7",77,0)
 .N CAN
"RTN","PSUV7",78,0)
 .S CAN=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,32)
"RTN","PSUV7",79,0)
 .S $P(PSUIVA(PSUDIV),U,4)=$P($G(PSUIVA(PSUDIV)),U,4)+CAN
"RTN","PSUV7",80,0)
 ;
"RTN","PSUV7",81,0)
 Q
"RTN","PSUV7",82,0)
 ;
"RTN","PSUV7",83,0)
LVPNET ;Calculate net amount of PB's Dispensed
"RTN","PSUV7",84,0)
 ;
"RTN","PSUV7",85,0)
 ;
"RTN","PSUV7",86,0)
 I PSUTYP="P",PSUP="P" D
"RTN","PSUV7",87,0)
 .N NET
"RTN","PSUV7",88,0)
 .S NET=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,11)
"RTN","PSUV7",89,0)
 .S $P(PSUIVA(PSUDIV),U,5)=$P($G(PSUIVA(PSUDIV)),U,5)+NET
"RTN","PSUV7",90,0)
 Q
"RTN","PSUV7",91,0)
 ;
"RTN","PSUV7",92,0)
LVPTOT ;Calculate Total cost
"RTN","PSUV7",93,0)
 ;
"RTN","PSUV7",94,0)
 N NDIS,COST,PSUOR1
"RTN","PSUV7",95,0)
 S PSUCTA=0
"RTN","PSUV7",96,0)
 F  S PSUCTA=$O(PSUAMIS(PSUDIV,PSUCTA)) Q:PSUCTA=""  D
"RTN","PSUV7",97,0)
 .S PSUOR1=$P(PSUAMIS(PSUDIV,PSUCTA),U,4)
"RTN","PSUV7",98,0)
 .Q:(PSUOR1'=PSUOR)
"RTN","PSUV7",99,0)
 .S NDIS=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,33)
"RTN","PSUV7",100,0)
 .S COST=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,22)
"RTN","PSUV7",101,0)
 .S $P(PSUIVA(PSUDIV),U,6)=$P($G(PSUIVA(PSUDIV)),U,6)+(NDIS*$G(COST))
"RTN","PSUV7",102,0)
 .;
"RTN","PSUV7",103,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV7",104,0)
 .N A,B,C
"RTN","PSUV7",105,0)
 .;
"RTN","PSUV7",106,0)
 .I $P(PSUIVA(PSUDIV),U,6)'["." D  Q
"RTN","PSUV7",107,0)
 ..S $P(PSUIVA(PSUDIV),U,6)=$P(PSUIVA(PSUDIV),U,6)_".00"
"RTN","PSUV7",108,0)
 .;
"RTN","PSUV7",109,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,6),".")  ;Find 1st position after decimal
"RTN","PSUV7",110,0)
 .;
"RTN","PSUV7",111,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,6),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV7",112,0)
 .;
"RTN","PSUV7",113,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,6),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV7",114,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV7",115,0)
 .;
"RTN","PSUV7",116,0)
 .S $P(PSUIVA(PSUDIV),U,6)=B_C
"RTN","PSUV7",117,0)
 Q
"RTN","PSUV7",118,0)
 ;
"RTN","PSUV7",119,0)
CNET ;Calculate Cost per Net PB's dispensed
"RTN","PSUV7",120,0)
 ;
"RTN","PSUV7",121,0)
 N CNET,TCOST
"RTN","PSUV7",122,0)
 ;
"RTN","PSUV7",123,0)
 S CNET=$P($G(PSUIVA(PSUDIV)),U,5)
"RTN","PSUV7",124,0)
 S TCOST=$P($G(PSUIVA(PSUDIV)),U,6)
"RTN","PSUV7",125,0)
 ;
"RTN","PSUV7",126,0)
 I CNET'="",CNET'=0,TCOST'="" D
"RTN","PSUV7",127,0)
 .S $P(PSUIVA(PSUDIV),U,7)=TCOST/CNET
"RTN","PSUV7",128,0)
 .;
"RTN","PSUV7",129,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV7",130,0)
 .N A,B,C
"RTN","PSUV7",131,0)
 .;
"RTN","PSUV7",132,0)
 .I $P(PSUIVA(PSUDIV),U,7)'["." D  Q
"RTN","PSUV7",133,0)
 ..S $P(PSUIVA(PSUDIV),U,7)=$P(PSUIVA(PSUDIV),U,7)_".00"
"RTN","PSUV7",134,0)
 .;
"RTN","PSUV7",135,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,7),".")  ;Find 1st position after decimal
"RTN","PSUV7",136,0)
 .;
"RTN","PSUV7",137,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,7),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV7",138,0)
 .;
"RTN","PSUV7",139,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,7),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV7",140,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV7",141,0)
 .;
"RTN","PSUV7",142,0)
 .S $P(PSUIVA(PSUDIV),U,7)=B_C
"RTN","PSUV7",143,0)
 ;
"RTN","PSUV7",144,0)
 Q
"RTN","PSUV7",145,0)
 ;
"RTN","PSUV7",146,0)
TOTAL ;Add up column totals and place into ^XTMP global
"RTN","PSUV7",147,0)
 ;
"RTN","PSUV7",148,0)
 S PSUDI=0
"RTN","PSUV7",149,0)
 F  S PSUDI=$O(PSUIVA(PSUDI)) Q:PSUDI=""  D
"RTN","PSUV7",150,0)
 .S LDSP=$G(LDSP)+$P(PSUIVA(PSUDI),U,1)   ;Total PB's dispensed
"RTN","PSUV7",151,0)
 .;
"RTN","PSUV7",152,0)
 .S LREC=$G(LREC)+$P(PSUIVA(PSUDI),U,2)   ;Total PB's recycled
"RTN","PSUV7",153,0)
 .;
"RTN","PSUV7",154,0)
 .S LDES=$G(LDES)+$P(PSUIVA(PSUDI),U,3)   ;Total PB's destroyed
"RTN","PSUV7",155,0)
 .;
"RTN","PSUV7",156,0)
 .S CLAN=$G(CLAN)+$P(PSUIVA(PSUDI),U,4)   ;Total PB's cancelled
"RTN","PSUV7",157,0)
 .;
"RTN","PSUV7",158,0)
 .S NDSP=$G(NDSP)+$P(PSUIVA(PSUDI),U,5)   ;Total Net PB's dispensed
"RTN","PSUV7",159,0)
 .;
"RTN","PSUV7",160,0)
 .S LTOT=$G(LTOT)+$P(PSUIVA(PSUDI),U,6)   ;Total of Total cost
"RTN","PSUV7",161,0)
 .;
"RTN","PSUV7",162,0)
 .;S CNDSP=$G(CNDSP)+$P(PSUIVA(PSUDI),U,7) ;Total of cost/net column
"RTN","PSUV7",163,0)
 .I $G(NDSP) S CNDSP=$G(LTOT)/NDSP D
"RTN","PSUV7",164,0)
 ..I CNDSP'["." S CNDSP=CNDSP_".00" Q
"RTN","PSUV7",165,0)
 ..N A,B,C
"RTN","PSUV7",166,0)
 ..S A=$F(CNDSP,".")  ;Find 1st position after decimal
"RTN","PSUV7",167,0)
 ..S B=$E(CNDSP,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUV7",168,0)
 ..S C=$E(CNDSP,A,(A+1))   ;Extract cents after decimal
"RTN","PSUV7",169,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV7",170,0)
 ..S CNDSP=B_C
"RTN","PSUV7",171,0)
 ;
"RTN","PSUV7",172,0)
 S ^XTMP(PSUIVSUB,"PBTOT")=LDSP_U_LREC_U_LDES_U_CLAN_U_NDSP_U_LTOT_U_CNDSP
"RTN","PSUV7",173,0)
 ;
"RTN","PSUV7",174,0)
 Q
"RTN","PSUV7",175,0)
 ;
"RTN","PSUV7",176,0)
REC ;Place contents of arrays into ^XTMP globals
"RTN","PSUV7",177,0)
 ;
"RTN","PSUV7",178,0)
 M ^XTMP(PSUIVSUB,"PB",PSUDIV)=PSUIVA(PSUDIV)   ;PB RECORDS
"RTN","PSUV7",179,0)
 ;
"RTN","PSUV7",180,0)
 Q
"RTN","PSUV8")
0^122^B32732574
"RTN","PSUV8",1,0)
PSUV8 ;BIR/DAM - IV TPN AMIS Summary Data;11 March 2004
"RTN","PSUV8",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV8",3,0)
 ;
"RTN","PSUV8",4,0)
 ;This routine gathers IV TPN AMIS summary data
"RTN","PSUV8",5,0)
 ;No DBIA's needed
"RTN","PSUV8",6,0)
 ;
"RTN","PSUV8",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUIV3
"RTN","PSUV8",8,0)
 ;
"RTN","PSUV8",9,0)
 K PSUIVA      ;Array to hold temporary data
"RTN","PSUV8",10,0)
 ;
"RTN","PSUV8",11,0)
 ;Initialize variables for column totals
"RTN","PSUV8",12,0)
 ;
"RTN","PSUV8",13,0)
 ;
"RTN","PSUV8",14,0)
 S PSUDIV=0
"RTN","PSUV8",15,0)
 S PSUCT=0
"RTN","PSUV8",16,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D EN1
"RTN","PSUV8",17,0)
 Q
"RTN","PSUV8",18,0)
 ;
"RTN","PSUV8",19,0)
EN1 ;EN CONTINUED
"RTN","PSUV8",20,0)
 ;
"RTN","PSUV8",21,0)
 S PSUOR=""
"RTN","PSUV8",22,0)
 N LDSP,LREC,LDES,CLAN,NDSP,LTOT,CNDSP
"RTN","PSUV8",23,0)
 F  S PSUCT=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUV8",24,0)
 .K PSUAMIS
"RTN","PSUV8",25,0)
 .M PSUAMIS(PSUDIV,PSUCT)=^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)
"RTN","PSUV8",26,0)
 .;
"RTN","PSUV8",27,0)
 .S PSUP=""
"RTN","PSUV8",28,0)
 .S PSUP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,5)      ;parent record
"RTN","PSUV8",29,0)
 .;
"RTN","PSUV8",30,0)
 .S PSUTYP=""
"RTN","PSUV8",31,0)
 .S PSUTYP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,6)    ;IV TYPE
"RTN","PSUV8",32,0)
 .;
"RTN","PSUV8",33,0)
 .I PSUTYP="H" S PSUOR=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,4)    ;IV order #
"RTN","PSUV8",34,0)
 .D LVPDSP
"RTN","PSUV8",35,0)
 .D LVPREC
"RTN","PSUV8",36,0)
 .D LVPDES
"RTN","PSUV8",37,0)
 .D LVPCAN
"RTN","PSUV8",38,0)
 .D LVPNET
"RTN","PSUV8",39,0)
 .D LVPTOT
"RTN","PSUV8",40,0)
 .D CNET
"RTN","PSUV8",41,0)
 .D REC
"RTN","PSUV8",42,0)
 D TOTAL
"RTN","PSUV8",43,0)
 ;
"RTN","PSUV8",44,0)
 Q
"RTN","PSUV8",45,0)
 ;
"RTN","PSUV8",46,0)
LVPDSP ;Gather TPN Dispensed data
"RTN","PSUV8",47,0)
 ;
"RTN","PSUV8",48,0)
 I PSUTYP="H",PSUP="P" D                         ;TPNs Dispensed
"RTN","PSUV8",49,0)
 .N DSP
"RTN","PSUV8",50,0)
 .S DSP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,29)
"RTN","PSUV8",51,0)
 .S $P(PSUIVA(PSUDIV),U,1)=$P($G(PSUIVA(PSUDIV)),U,1)+DSP
"RTN","PSUV8",52,0)
 ;
"RTN","PSUV8",53,0)
 Q
"RTN","PSUV8",54,0)
 ;
"RTN","PSUV8",55,0)
LVPREC ;Gather TPN Recycled data
"RTN","PSUV8",56,0)
 ;
"RTN","PSUV8",57,0)
 I PSUTYP="H",PSUP="P" D                         ;TPN's recycled
"RTN","PSUV8",58,0)
 .N REC
"RTN","PSUV8",59,0)
 .S REC=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,30)
"RTN","PSUV8",60,0)
 .S $P(PSUIVA(PSUDIV),U,2)=$P($G(PSUIVA(PSUDIV)),U,2)+REC
"RTN","PSUV8",61,0)
 ;
"RTN","PSUV8",62,0)
 Q
"RTN","PSUV8",63,0)
 ;
"RTN","PSUV8",64,0)
LVPDES ;Gather TPN Destroyed data
"RTN","PSUV8",65,0)
 ;
"RTN","PSUV8",66,0)
 I PSUTYP="H",PSUP="P" D                        ;TPN's destroyed
"RTN","PSUV8",67,0)
 .N DES
"RTN","PSUV8",68,0)
 .S DES=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,31)
"RTN","PSUV8",69,0)
 .S $P(PSUIVA(PSUDIV),U,3)=$P($G(PSUIVA(PSUDIV)),U,3)+DES
"RTN","PSUV8",70,0)
 ;
"RTN","PSUV8",71,0)
 Q
"RTN","PSUV8",72,0)
 ;
"RTN","PSUV8",73,0)
LVPCAN ;Gather TPN Cancelled data
"RTN","PSUV8",74,0)
 ;
"RTN","PSUV8",75,0)
 I PSUTYP="H",PSUP="P" D                         ;TPN's cancelled
"RTN","PSUV8",76,0)
 .N CAN
"RTN","PSUV8",77,0)
 .S CAN=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,32)
"RTN","PSUV8",78,0)
 .S $P(PSUIVA(PSUDIV),U,4)=$P($G(PSUIVA(PSUDIV)),U,4)+CAN
"RTN","PSUV8",79,0)
 ;
"RTN","PSUV8",80,0)
 Q
"RTN","PSUV8",81,0)
 ;
"RTN","PSUV8",82,0)
LVPNET ;Calculate net amount of TPN's Dispensed
"RTN","PSUV8",83,0)
 ;
"RTN","PSUV8",84,0)
 ;
"RTN","PSUV8",85,0)
 I PSUTYP="H",PSUP="P" D
"RTN","PSUV8",86,0)
 .N NET
"RTN","PSUV8",87,0)
 .S NET=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,11)
"RTN","PSUV8",88,0)
 .S $P(PSUIVA(PSUDIV),U,5)=$P($G(PSUIVA(PSUDIV)),U,5)+NET
"RTN","PSUV8",89,0)
 Q
"RTN","PSUV8",90,0)
 ;
"RTN","PSUV8",91,0)
LVPTOT ;Calculate Total cost
"RTN","PSUV8",92,0)
 ;
"RTN","PSUV8",93,0)
 N NDIS,COST,PSUOR1
"RTN","PSUV8",94,0)
 S PSUCTA=0
"RTN","PSUV8",95,0)
 F  S PSUCTA=$O(PSUAMIS(PSUDIV,PSUCTA)) Q:PSUCTA=""  D
"RTN","PSUV8",96,0)
 .S PSUOR1=$P(PSUAMIS(PSUDIV,PSUCTA),U,4)
"RTN","PSUV8",97,0)
 .Q:(PSUOR1'=PSUOR)
"RTN","PSUV8",98,0)
 .S NDIS=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,33)
"RTN","PSUV8",99,0)
 .S COST=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,22)
"RTN","PSUV8",100,0)
 .S $P(PSUIVA(PSUDIV),U,6)=$P($G(PSUIVA(PSUDIV)),U,6)+(NDIS*$G(COST))
"RTN","PSUV8",101,0)
 .;
"RTN","PSUV8",102,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV8",103,0)
 .N A,B,C
"RTN","PSUV8",104,0)
 .;
"RTN","PSUV8",105,0)
 .I $P(PSUIVA(PSUDIV),U,6)'["." D  Q
"RTN","PSUV8",106,0)
 ..S $P(PSUIVA(PSUDIV),U,6)=$P(PSUIVA(PSUDIV),U,6)_".00"
"RTN","PSUV8",107,0)
 .;
"RTN","PSUV8",108,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,6),".")  ;Find 1st position after decimal
"RTN","PSUV8",109,0)
 .;
"RTN","PSUV8",110,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,6),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV8",111,0)
 .;
"RTN","PSUV8",112,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,6),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV8",113,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV8",114,0)
 .;
"RTN","PSUV8",115,0)
 .S $P(PSUIVA(PSUDIV),U,6)=B_C
"RTN","PSUV8",116,0)
 Q
"RTN","PSUV8",117,0)
 ;
"RTN","PSUV8",118,0)
CNET ;Calculate Cost per Net TPN's dispensed
"RTN","PSUV8",119,0)
 ;
"RTN","PSUV8",120,0)
 N CNET,TCOST
"RTN","PSUV8",121,0)
 ;
"RTN","PSUV8",122,0)
 S CNET=$P($G(PSUIVA(PSUDIV)),U,5)
"RTN","PSUV8",123,0)
 S TCOST=$P($G(PSUIVA(PSUDIV)),U,6)
"RTN","PSUV8",124,0)
 ;
"RTN","PSUV8",125,0)
 I CNET'="",CNET'=0,TCOST'="" D
"RTN","PSUV8",126,0)
 .S $P(PSUIVA(PSUDIV),U,7)=TCOST/CNET
"RTN","PSUV8",127,0)
 .;
"RTN","PSUV8",128,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV8",129,0)
 .N A,B,C
"RTN","PSUV8",130,0)
 .;
"RTN","PSUV8",131,0)
 .I $P(PSUIVA(PSUDIV),U,7)'["." D  Q
"RTN","PSUV8",132,0)
 ..S $P(PSUIVA(PSUDIV),U,7)=$P(PSUIVA(PSUDIV),U,7)_".00"
"RTN","PSUV8",133,0)
 .;
"RTN","PSUV8",134,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,7),".")  ;Find 1st position after decimal
"RTN","PSUV8",135,0)
 .;
"RTN","PSUV8",136,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,7),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV8",137,0)
 .;
"RTN","PSUV8",138,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,7),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV8",139,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV8",140,0)
 .;
"RTN","PSUV8",141,0)
 .S $P(PSUIVA(PSUDIV),U,7)=B_C
"RTN","PSUV8",142,0)
 ;
"RTN","PSUV8",143,0)
 Q
"RTN","PSUV8",144,0)
 ;
"RTN","PSUV8",145,0)
TOTAL ;Add up column totals and place into ^XTMP global
"RTN","PSUV8",146,0)
 ;
"RTN","PSUV8",147,0)
 S PSUDI=0
"RTN","PSUV8",148,0)
 F  S PSUDI=$O(PSUIVA(PSUDI)) Q:PSUDI=""  D
"RTN","PSUV8",149,0)
 .S LDSP=$G(LDSP)+$P(PSUIVA(PSUDI),U,1)   ;Total TPN's dispensed
"RTN","PSUV8",150,0)
 .;
"RTN","PSUV8",151,0)
 .S LREC=$G(LREC)+$P(PSUIVA(PSUDI),U,2)   ;Total TPN's recycled
"RTN","PSUV8",152,0)
 .;
"RTN","PSUV8",153,0)
 .S LDES=$G(LDES)+$P(PSUIVA(PSUDI),U,3)   ;Total TPN's destroyed
"RTN","PSUV8",154,0)
 .;
"RTN","PSUV8",155,0)
 .S CLAN=$G(CLAN)+$P(PSUIVA(PSUDI),U,4)   ;Total TPN's cancelled
"RTN","PSUV8",156,0)
 .;
"RTN","PSUV8",157,0)
 .S NDSP=$G(NDSP)+$P(PSUIVA(PSUDI),U,5)   ;Total Net TPN's dispensed
"RTN","PSUV8",158,0)
 .;
"RTN","PSUV8",159,0)
 .S LTOT=$G(LTOT)+$P(PSUIVA(PSUDI),U,6)   ;Total of Total cost
"RTN","PSUV8",160,0)
 .;
"RTN","PSUV8",161,0)
 .;S CNDSP=$G(CNDSP)+$P(PSUIVA(PSUDI),U,7) ;Total of cost/net column
"RTN","PSUV8",162,0)
 .I $G(NDSP) S CNDSP=$G(LTOT)/NDSP D
"RTN","PSUV8",163,0)
 ..I CNDSP'["." S CNDSP=CNDSP_".00" Q
"RTN","PSUV8",164,0)
 ..N A,B,C
"RTN","PSUV8",165,0)
 ..S A=$F(CNDSP,".")  ;Find 1st position after decimal
"RTN","PSUV8",166,0)
 ..S B=$E(CNDSP,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUV8",167,0)
 ..S C=$E(CNDSP,A,(A+1))   ;Extract cents after decimal
"RTN","PSUV8",168,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV8",169,0)
 ..S CNDSP=B_C
"RTN","PSUV8",170,0)
 ;
"RTN","PSUV8",171,0)
 S ^XTMP(PSUIVSUB,"TPNTOT")=$G(LDSP)_U_$G(LREC)_U_$G(LDES)_U_$G(CLAN)_U_$G(NDSP)_U_$G(LTOT)_U_$G(CNDSP)
"RTN","PSUV8",172,0)
 ;
"RTN","PSUV8",173,0)
 Q
"RTN","PSUV8",174,0)
 ;
"RTN","PSUV8",175,0)
REC ;Place contents of arrays into ^XTMP globals
"RTN","PSUV8",176,0)
 ;
"RTN","PSUV8",177,0)
 M ^XTMP(PSUIVSUB,"TPN",PSUDIV)=PSUIVA(PSUDIV)   ;TPN RECORDS
"RTN","PSUV8",178,0)
 ;
"RTN","PSUV8",179,0)
 Q
"RTN","PSUV9")
0^123^B33134679
"RTN","PSUV9",1,0)
PSUV9 ;BIR/DAM - IV Chemotherapy AMIS Summary Data;11 March 2004
"RTN","PSUV9",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUV9",3,0)
 ;
"RTN","PSUV9",4,0)
 ;This routine gathers IV CHEMO AMIS summary data
"RTN","PSUV9",5,0)
 ;No DBIA's needed
"RTN","PSUV9",6,0)
 ;
"RTN","PSUV9",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUIV3
"RTN","PSUV9",8,0)
 ;
"RTN","PSUV9",9,0)
 K PSUIVA      ;Array to hold temporary data
"RTN","PSUV9",10,0)
 ;
"RTN","PSUV9",11,0)
 ;Initialize variables for column totals
"RTN","PSUV9",12,0)
 ;
"RTN","PSUV9",13,0)
 ;
"RTN","PSUV9",14,0)
 S PSUDIV=0
"RTN","PSUV9",15,0)
 S PSUCT=0
"RTN","PSUV9",16,0)
 F  S PSUDIV=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV)) Q:PSUDIV=""  D EN1
"RTN","PSUV9",17,0)
 Q
"RTN","PSUV9",18,0)
 ;
"RTN","PSUV9",19,0)
EN1 ;EN CONTINUED
"RTN","PSUV9",20,0)
 ;
"RTN","PSUV9",21,0)
 S PSUOR=""
"RTN","PSUV9",22,0)
 N LDSP,LREC,LDES,CLAN,NDSP,LTOT,CNDSP
"RTN","PSUV9",23,0)
 F  S PSUCT=$O(^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUV9",24,0)
 .K PSUAMIS
"RTN","PSUV9",25,0)
 .M PSUAMIS(PSUDIV,PSUCT)=^XTMP(PSUIVSUB,"RECORDS",PSUDIV,PSUCT)
"RTN","PSUV9",26,0)
 .;
"RTN","PSUV9",27,0)
 .S PSUP=""
"RTN","PSUV9",28,0)
 .S PSUP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,5)      ;parent record
"RTN","PSUV9",29,0)
 .;
"RTN","PSUV9",30,0)
 .S PSUTYP=""
"RTN","PSUV9",31,0)
 .S PSUTYP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,6)    ;IV TYPE
"RTN","PSUV9",32,0)
 .;
"RTN","PSUV9",33,0)
 .I PSUTYP="C" S PSUOR=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,4)    ;IV order #
"RTN","PSUV9",34,0)
 .;
"RTN","PSUV9",35,0)
 .D LVPDSP
"RTN","PSUV9",36,0)
 .D LVPREC
"RTN","PSUV9",37,0)
 .D LVPDES
"RTN","PSUV9",38,0)
 .D LVPCAN
"RTN","PSUV9",39,0)
 .D LVPNET
"RTN","PSUV9",40,0)
 .D LVPTOT
"RTN","PSUV9",41,0)
 .D CNET
"RTN","PSUV9",42,0)
 .D REC
"RTN","PSUV9",43,0)
 D TOTAL
"RTN","PSUV9",44,0)
 ;
"RTN","PSUV9",45,0)
 Q
"RTN","PSUV9",46,0)
 ;
"RTN","PSUV9",47,0)
LVPDSP ;Gather CHEMO Dispensed data
"RTN","PSUV9",48,0)
 ;
"RTN","PSUV9",49,0)
 I PSUTYP="C",PSUP="P" D                         ;CHEMOs Dispensed
"RTN","PSUV9",50,0)
 .N DSP
"RTN","PSUV9",51,0)
 .S DSP=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,29)
"RTN","PSUV9",52,0)
 .S $P(PSUIVA(PSUDIV),U,1)=$P($G(PSUIVA(PSUDIV)),U,1)+DSP
"RTN","PSUV9",53,0)
 ;
"RTN","PSUV9",54,0)
 Q
"RTN","PSUV9",55,0)
 ;
"RTN","PSUV9",56,0)
LVPREC ;Gather CHEMO Recycled data
"RTN","PSUV9",57,0)
 ;
"RTN","PSUV9",58,0)
 I PSUTYP="C",PSUP="P" D                         ;CHEMO's recycled
"RTN","PSUV9",59,0)
 .N REC
"RTN","PSUV9",60,0)
 .S REC=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,30)
"RTN","PSUV9",61,0)
 .S $P(PSUIVA(PSUDIV),U,2)=$P($G(PSUIVA(PSUDIV)),U,2)+REC
"RTN","PSUV9",62,0)
 ;
"RTN","PSUV9",63,0)
 Q
"RTN","PSUV9",64,0)
 ;
"RTN","PSUV9",65,0)
LVPDES ;Gather CHEMO Destroyed data
"RTN","PSUV9",66,0)
 ;
"RTN","PSUV9",67,0)
 I PSUTYP="C",PSUP="P" D                        ;CHEMO's destroyed
"RTN","PSUV9",68,0)
 .N DES
"RTN","PSUV9",69,0)
 .S DES=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,31)
"RTN","PSUV9",70,0)
 .S $P(PSUIVA(PSUDIV),U,3)=$P($G(PSUIVA(PSUDIV)),U,3)+DES
"RTN","PSUV9",71,0)
 ;
"RTN","PSUV9",72,0)
 Q
"RTN","PSUV9",73,0)
 ;
"RTN","PSUV9",74,0)
LVPCAN ;Gather CHEMO Cancelled data
"RTN","PSUV9",75,0)
 ;
"RTN","PSUV9",76,0)
 I PSUTYP="C",PSUP="P" D                         ;CHEMO's cancelled
"RTN","PSUV9",77,0)
 .N CAN
"RTN","PSUV9",78,0)
 .S CAN=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,32)
"RTN","PSUV9",79,0)
 .S $P(PSUIVA(PSUDIV),U,4)=$P($G(PSUIVA(PSUDIV)),U,4)+CAN
"RTN","PSUV9",80,0)
 ;
"RTN","PSUV9",81,0)
 Q
"RTN","PSUV9",82,0)
 ;
"RTN","PSUV9",83,0)
LVPNET ;Calculate net amount of CHEMO's Dispensed
"RTN","PSUV9",84,0)
 ;
"RTN","PSUV9",85,0)
 ;
"RTN","PSUV9",86,0)
 I PSUTYP="C",PSUP="P" D
"RTN","PSUV9",87,0)
 .N NET
"RTN","PSUV9",88,0)
 .S NET=$P($G(PSUAMIS(PSUDIV,PSUCT)),U,11)
"RTN","PSUV9",89,0)
 .S $P(PSUIVA(PSUDIV),U,5)=$P($G(PSUIVA(PSUDIV)),U,5)+NET
"RTN","PSUV9",90,0)
 Q
"RTN","PSUV9",91,0)
 ;
"RTN","PSUV9",92,0)
LVPTOT ;Calculate Total cost
"RTN","PSUV9",93,0)
 ;
"RTN","PSUV9",94,0)
 N NDIS,COST,PSUOR1
"RTN","PSUV9",95,0)
 S PSUCTA=0
"RTN","PSUV9",96,0)
 F  S PSUCTA=$O(PSUAMIS(PSUDIV,PSUCTA)) Q:PSUCTA=""  D
"RTN","PSUV9",97,0)
 .S PSUOR1=$P(PSUAMIS(PSUDIV,PSUCTA),U,4)
"RTN","PSUV9",98,0)
 .Q:(PSUOR1'=PSUOR)
"RTN","PSUV9",99,0)
 .S NDIS=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,33)
"RTN","PSUV9",100,0)
 .S COST=$P($G(PSUAMIS(PSUDIV,PSUCTA)),U,22)
"RTN","PSUV9",101,0)
 .S $P(PSUIVA(PSUDIV),U,6)=$P($G(PSUIVA(PSUDIV)),U,6)+(NDIS*$G(COST))
"RTN","PSUV9",102,0)
 .;
"RTN","PSUV9",103,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV9",104,0)
 .N A,B,C
"RTN","PSUV9",105,0)
 .;
"RTN","PSUV9",106,0)
 .I $P(PSUIVA(PSUDIV),U,6)'["." D  Q
"RTN","PSUV9",107,0)
 ..S $P(PSUIVA(PSUDIV),U,6)=$P(PSUIVA(PSUDIV),U,6)_".00"
"RTN","PSUV9",108,0)
 .;
"RTN","PSUV9",109,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,6),".")  ;Find 1st position after decimal
"RTN","PSUV9",110,0)
 .;
"RTN","PSUV9",111,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,6),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV9",112,0)
 .;
"RTN","PSUV9",113,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,6),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV9",114,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV9",115,0)
 .;
"RTN","PSUV9",116,0)
 .S $P(PSUIVA(PSUDIV),U,6)=B_C
"RTN","PSUV9",117,0)
 Q
"RTN","PSUV9",118,0)
 ;
"RTN","PSUV9",119,0)
CNET ;Calculate Cost per Net CHEMO's dispensed
"RTN","PSUV9",120,0)
 ;
"RTN","PSUV9",121,0)
 N CNET,TCOST
"RTN","PSUV9",122,0)
 ;
"RTN","PSUV9",123,0)
 S CNET=$P($G(PSUIVA(PSUDIV)),U,5)
"RTN","PSUV9",124,0)
 S TCOST=$P($G(PSUIVA(PSUDIV)),U,6)
"RTN","PSUV9",125,0)
 ;
"RTN","PSUV9",126,0)
 I CNET'="",CNET'=0,TCOST'="" D
"RTN","PSUV9",127,0)
 .S $P(PSUIVA(PSUDIV),U,7)=TCOST/CNET
"RTN","PSUV9",128,0)
 .;
"RTN","PSUV9",129,0)
 .;Truncate cost to 2 decimal places
"RTN","PSUV9",130,0)
 .N A,B,C
"RTN","PSUV9",131,0)
 .;
"RTN","PSUV9",132,0)
 .I $P(PSUIVA(PSUDIV),U,7)'["." D  Q
"RTN","PSUV9",133,0)
 ..S $P(PSUIVA(PSUDIV),U,7)=$P(PSUIVA(PSUDIV),U,7)_".00"
"RTN","PSUV9",134,0)
 .;
"RTN","PSUV9",135,0)
 .S A=$F($P(PSUIVA(PSUDIV),U,7),".")  ;Find 1st position after decimal
"RTN","PSUV9",136,0)
 .;
"RTN","PSUV9",137,0)
 .S B=$E($P(PSUIVA(PSUDIV),U,7),1,(A-1)) ;Extract dollars and decimal
"RTN","PSUV9",138,0)
 .;
"RTN","PSUV9",139,0)
 .S C=$E($P(PSUIVA(PSUDIV),U,7),A,(A+1)) ;Extract cents after decimal
"RTN","PSUV9",140,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV9",141,0)
 .;
"RTN","PSUV9",142,0)
 .S $P(PSUIVA(PSUDIV),U,7)=B_C
"RTN","PSUV9",143,0)
 ;
"RTN","PSUV9",144,0)
 Q
"RTN","PSUV9",145,0)
 ;
"RTN","PSUV9",146,0)
TOTAL ;Add up column totals and place into ^XTMP global
"RTN","PSUV9",147,0)
 ;
"RTN","PSUV9",148,0)
 S PSUDI=0
"RTN","PSUV9",149,0)
 F  S PSUDI=$O(PSUIVA(PSUDI)) Q:PSUDI=""  D
"RTN","PSUV9",150,0)
 .S LDSP=$G(LDSP)+$P(PSUIVA(PSUDI),U,1)   ;Total CHEMO's dispensed
"RTN","PSUV9",151,0)
 .;
"RTN","PSUV9",152,0)
 .S LREC=$G(LREC)+$P(PSUIVA(PSUDI),U,2)   ;Total CHEMO's recycled
"RTN","PSUV9",153,0)
 .;
"RTN","PSUV9",154,0)
 .S LDES=$G(LDES)+$P(PSUIVA(PSUDI),U,3)   ;Total CHEMO's destroyed
"RTN","PSUV9",155,0)
 .;
"RTN","PSUV9",156,0)
 .S CLAN=$G(CLAN)+$P(PSUIVA(PSUDI),U,4)   ;Total CHEMO's cancelled
"RTN","PSUV9",157,0)
 .;
"RTN","PSUV9",158,0)
 .S NDSP=$G(NDSP)+$P(PSUIVA(PSUDI),U,5)   ;Total Net CHEMO's dispensed
"RTN","PSUV9",159,0)
 .;
"RTN","PSUV9",160,0)
 .S LTOT=$G(LTOT)+$P(PSUIVA(PSUDI),U,6)   ;Total of Total cost
"RTN","PSUV9",161,0)
 .;
"RTN","PSUV9",162,0)
 .;S CNDSP=$G(CNDSP)+$P(PSUIVA(PSUDI),U,7) ;Total of cost/net column
"RTN","PSUV9",163,0)
 .I $G(NDSP) S CNDSP=$G(LTOT)/NDSP D
"RTN","PSUV9",164,0)
 ..I CNDSP'["." S CNDSP=CNDSP_".00" Q
"RTN","PSUV9",165,0)
 ..N A,B,C
"RTN","PSUV9",166,0)
 ..S A=$F(CNDSP,".")  ;Find 1st position after decimal
"RTN","PSUV9",167,0)
 ..S B=$E(CNDSP,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUV9",168,0)
 ..S C=$E(CNDSP,A,(A+1))   ;Extract cents after decimal
"RTN","PSUV9",169,0)
 ..I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUV9",170,0)
 ..S CNDSP=B_C
"RTN","PSUV9",171,0)
 ;
"RTN","PSUV9",172,0)
 S ^XTMP(PSUIVSUB,"CHTOT")=$G(LDSP)_U_$G(LREC)_U_$G(LDES)_U_$G(CLAN)_U_$G(NDSP)_U_$G(LTOT)_U_$G(CNDSP)
"RTN","PSUV9",173,0)
 ;
"RTN","PSUV9",174,0)
 Q
"RTN","PSUV9",175,0)
 ;
"RTN","PSUV9",176,0)
REC ;Place contents of arrays into ^XTMP globals
"RTN","PSUV9",177,0)
 ;
"RTN","PSUV9",178,0)
 M ^XTMP(PSUIVSUB,"CH",PSUDIV)=PSUIVA(PSUDIV)   ;CHEMO RECORDS
"RTN","PSUV9",179,0)
 ;
"RTN","PSUV9",180,0)
 Q
"RTN","PSUVIT")
0^108^B2205
"RTN","PSUVIT",1,0)
PSUVIT ;BIR/DAM - Vital/Immunization Extract ; 1 MAY 2003
"RTN","PSUVIT",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUVIT0")
0^109^B4647
"RTN","PSUVIT0",1,0)
PSUVIT0 ;BIR/RDC VITALS & IMMUNIZATION PRINTED REPORTS; 01 FEB 2004
"RTN","PSUVIT0",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUVIT0",3,0)
 ;
"RTN","PSUVIT0",4,0)
 ; NO SUMMARY AVAILABLE FOR THIS OPTION
"RTN","PSUVIT0",5,0)
EN ;  *** ENtry point for Vitals/Immunization printed reports
"RTN","PSUVIT0",6,0)
 ;
"RTN","PSUVIT0",7,0)
 ; ** Allow NO printjobs whatsoever **
"RTN","PSUVIT0",8,0)
 Q
"RTN","PSUVIT0",9,0)
 ;
"RTN","PSUVIT1")
0^110^B50144002
"RTN","PSUVIT1",1,0)
PSUVIT1 ;BIR/RDC - VITALS & IMMUNIZATION EXTRACT; 24 DEC 2003
"RTN","PSUVIT1",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUVIT1",3,0)
 ;
"RTN","PSUVIT1",4,0)
 ;DBIA's
"RTN","PSUVIT1",5,0)
 ;References to file #4       - the INSTITUTION file
"RTN","PSUVIT1",6,0)
 ;  DBIA 10090 for: the STATION field  - #99
"RTN","PSUVIT1",7,0)
 ;
"RTN","PSUVIT1",8,0)
 ;References to file #120.5    - the GMRV VITAL MEASUREMENT file
"RTN","PSUVIT1",9,0)
 ;  DBIA 1381 for:   the DATE/TIME VITALS TAKEN field - #.01
"RTN","PSUVIT1",10,0)
 ;                   the VITAL TYPE field #.03
"RTN","PSUVIT1",11,0)
 ;                   the RATE field #1.2
"RTN","PSUVIT1",12,0)
 ;                   the QUALIFIER field #5
"RTN","PSUVIT1",13,0)
 ;
"RTN","PSUVIT1",14,0)
 ;References to file #120.51- the GMRV VITAL TYPE file
"RTN","PSUVIT1",15,0)
 ;       DBIA 1382 for: the NAME field - #.01
"RTN","PSUVIT1",16,0)
 ;
"RTN","PSUVIT1",17,0)
 ;References to file #120.52 - the GMRV VITAL QUALIFIER file
"RTN","PSUVIT1",18,0)
 ;       DBIA 4504 for: the QUALIFIER field #.01
"RTN","PSUVIT1",19,0)
 ;
"RTN","PSUVIT1",20,0)
 ;References to file #9000010.11 - the V IMMUNIZATION file
"RTN","PSUVIT1",21,0)
 ;       DBIA 4567 for: the EVENT DATE AND TIME field #1202
"RTN","PSUVIT1",22,0)
 ;                      the IMMUNIZATION field #.01
"RTN","PSUVIT1",23,0)
 ;
"RTN","PSUVIT1",24,0)
 ;References to file #2   - the PATIENT file
"RTN","PSUVIT1",25,0)
 ;       DBIA 10035 for:  the SOCIAL SECURITY NUMBER field #.09
"RTN","PSUVIT1",26,0)
 ;       DBIA 3504 for: the TEST PATIENT INDICATOR field #.6
"RTN","PSUVIT1",27,0)
 ;
"RTN","PSUVIT1",28,0)
 ;References to file #9999999.14 - the IMMUNIZATION file
"RTN","PSUVIT1",29,0)
 ;       DBIA 2454 for: the NAME field #.01
"RTN","PSUVIT1",30,0)
 ;
"RTN","PSUVIT1",31,0)
EN ;ENtry POINT - Routine control module
"RTN","PSUVIT1",32,0)
 ;
"RTN","PSUVIT1",33,0)
 N SDATE,EDATE,PSUFAC,PSUIDATE,PSUQCNT,PSUQNUM
"RTN","PSUVIT1",34,0)
 N MAXLINE,LINECNT,MSGCNT,I,J,K,Z,LINETOT
"RTN","PSUVIT1",35,0)
 S PSUVTMP(0)="TEMP ARRAY FOR PSUVIT1 PROCESSING"
"RTN","PSUVIT1",36,0)
 D SETUP
"RTN","PSUVIT1",37,0)
 D VITALS
"RTN","PSUVIT1",38,0)
 D VITALS2
"RTN","PSUVIT1",39,0)
 D IMMUNS
"RTN","PSUVIT1",40,0)
 D MAILIT
"RTN","PSUVIT1",41,0)
 Q          ;  **  end of routine control module **
"RTN","PSUVIT1",42,0)
 ; 
"RTN","PSUVIT1",43,0)
SETUP ; SET UP PARTITION FOR VITALS/IMMUNIZATION EXTRACT
"RTN","PSUVIT1",44,0)
 ;
"RTN","PSUVIT1",45,0)
 S LINEMAX=$$VAL^PSUTL(4.3,1,8.3)       ; ** get maximum line length **
"RTN","PSUVIT1",46,0)
 S:LINEMAX=""!(LINEMAX>10000) LINEMAX=10000
"RTN","PSUVIT1",47,0)
 ;
"RTN","PSUVIT1",48,0)
 ; SET EXTRACT DATE
"RTN","PSUVIT1",49,0)
 S %H=$H
"RTN","PSUVIT1",50,0)
 D YMD^%DTC
"RTN","PSUVIT1",51,0)
 S $P(^TMP("PSUVI",$J),U,3)=X
"RTN","PSUVIT1",52,0)
 ;
"RTN","PSUVIT1",53,0)
 ; GET TIME WINDOW
"RTN","PSUVIT1",54,0)
 S SDATE=PSUSDT\1-.0001
"RTN","PSUVIT1",55,0)
 S EDATE=PSUEDT\1+.2359
"RTN","PSUVIT1",56,0)
 ;
"RTN","PSUVIT1",57,0)
 ; GET FACILITY
"RTN","PSUVIT1",58,0)
 S PSUFAC=PSUSNDR
"RTN","PSUVIT1",59,0)
 ; 
"RTN","PSUVIT1",60,0)
 ; SET VARIABLES
"RTN","PSUVIT1",61,0)
 I $G(^XTMP("PSU_"_PSUJOB,"PSUPSUFLAG"))=1 D  ;AUTOJOBED
"RTN","PSUVIT1",62,0)
 . S PSUOPTS="1,2,3,4,5,6,7,8,9,10,11,12,13"
"RTN","PSUVIT1",63,0)
 . S PSUAUTO=1
"RTN","PSUVIT1",64,0)
 S LINECNT=999999
"RTN","PSUVIT1",65,0)
 S LINETOT=0
"RTN","PSUVIT1",66,0)
 ;
"RTN","PSUVIT1",67,0)
 Q                         ;  ** end of SETUP  **
"RTN","PSUVIT1",68,0)
 ;
"RTN","PSUVIT1",69,0)
VITALS ; EXTRACT VITAL DATA
"RTN","PSUVIT1",70,0)
 ; 
"RTN","PSUVIT1",71,0)
 N PSUDATE,PSUV,PSUQ,PSUVREC,PSUPTREC,PSUPTPTR,PSUVPTR,PSUQPTR
"RTN","PSUVIT1",72,0)
 N PSURTYPE,PSUSSN,PSUICN,PSUVTYPE,PSUVRATE,PSUVUNIT
"RTN","PSUVIT1",73,0)
 N Z,QQ,PSUVQ1,PSUVQ2,PSUVQ3,PSUVQ4,PSUVLIST,PSUVMSG
"RTN","PSUVIT1",74,0)
 ;
"RTN","PSUVIT1",75,0)
 S PSUVLIST="""BLOOD PRESSURE"",""HEIGHT"",""WEIGHT"",""PAIN"",""PULSE"",""PULSE OXIMETRY"""
"RTN","PSUVIT1",76,0)
 ;
"RTN","PSUVIT1",77,0)
 ;                          ** Loop through date index for valid dates **
"RTN","PSUVIT1",78,0)
 S PSUDATE=SDATE
"RTN","PSUVIT1",79,0)
 F  S PSUDATE=$O(^GMR(120.5,"B",PSUDATE)) Q:PSUDATE>EDATE!('PSUDATE)  D
"RTN","PSUVIT1",80,0)
 . S PSUV=""                      ; ** loop thru vitals for each date **
"RTN","PSUVIT1",81,0)
 . F  S PSUV=$O(^GMR(120.5,"B",PSUDATE,PSUV)) Q:PSUV=""  D
"RTN","PSUVIT1",82,0)
 .. Q:$P($D(^GMR(120.5,PSUV,2)),U)  ;** quit if vital entered in error **
"RTN","PSUVIT1",83,0)
 .. S PSUVREC=$G(^GMR(120.5,PSUV,0)) Q:'PSUVREC
"RTN","PSUVIT1",84,0)
 .. S PSUPTPTR=$P(PSUVREC,U,2)    ; ** point to PATIENT **
"RTN","PSUVIT1",85,0)
 .. Q:$G(^DPT(PSUPTPTR,0))=""     ; ** quit if no patient record **
"RTN","PSUVIT1",86,0)
 .. S PSUPTREC=^DPT(PSUPTPTR,0)   ; ** get patient record **
"RTN","PSUVIT1",87,0)
 .. S PSUSSN=$P(PSUPTREC,U,9)     ; ** get SSN
"RTN","PSUVIT1",88,0)
 .. Q:$E(PSUSSN,1,5)="00000"      ; ** quit if invalid patient **
"RTN","PSUVIT1",89,0)
 .. Q:$P(PSUPTREC,U,21)=1
"RTN","PSUVIT1",90,0)
 .. Q:$P(PSUVREC,U,3)=""          ; ** quit if no pointer **
"RTN","PSUVIT1",91,0)
 .. S PSUVPTR=$P(PSUVREC,U,3)     ; ** point to VITAL  **
"RTN","PSUVIT1",92,0)
 .. S PSUVTYPE=$P(^GMRD(120.51,PSUVPTR,0),U)  ; ** get VITAL TYPE **
"RTN","PSUVIT1",93,0)
 .. Q:PSUVLIST'[PSUVTYPE         ; ** screen out invalid vital types **
"RTN","PSUVIT1",94,0)
 .. S PSURTYPE="V"                ; ** set record type **
"RTN","PSUVIT1",95,0)
 .. S PSUICN=$$GETICN^MPIF001(PSUPTPTR)  ; ** get ICN **
"RTN","PSUVIT1",96,0)
 .. I $P(PSUICN,U)="-1" S PSUICN=""
"RTN","PSUVIT1",97,0)
 .. S PSUVRATE=$P(PSUVREC,U,8)
"RTN","PSUVIT1",98,0)
 .. S PSUVUNIT=""                 ; ** set vital unit rate **
"RTN","PSUVIT1",99,0)
 .. S:PSUVTYPE="PULSE OXIMETRY" PSUVUNIT="%"
"RTN","PSUVIT1",100,0)
 .. S:PSUVTYPE="WEIGHT" PSUVUNIT="LBS"
"RTN","PSUVIT1",101,0)
 .. S:PSUVTYPE="HEIGHT" PSUVUNIT="IN"
"RTN","PSUVIT1",102,0)
 .. S (PSUVQ1,PSUVQ2,PSUVQ3,PSUVQ4)=""
"RTN","PSUVIT1",103,0)
 .. D:$D(^GMR(120.5,PSUV,5,0))    ; ** get qualifiers **
"RTN","PSUVIT1",104,0)
 ... S (PSUQNUM,PSUQCNT)=0
"RTN","PSUVIT1",105,0)
 ... F  S PSUQNUM=$O(^GMR(120.5,PSUV,5,PSUQNUM)) Q:'+PSUQNUM  D
"RTN","PSUVIT1",106,0)
 .... S PSUQPTR=^GMR(120.5,PSUV,5,PSUQNUM,0)
"RTN","PSUVIT1",107,0)
 .... S PSUQCNT=PSUQCNT+1
"RTN","PSUVIT1",108,0)
 .... S QQ="PSUVQ"_PSUQCNT
"RTN","PSUVIT1",109,0)
 .... S @QQ=$P(^GMRD(120.52,PSUQPTR,0),U)
"RTN","PSUVIT1",110,0)
 .. S Z="$"
"RTN","PSUVIT1",111,0)
 .. S PSUVMSG=Z_PSUFAC_Z_PSUDATE_Z_PSURTYPE_Z_PSUSSN_Z_PSUICN_Z_""_Z_PSUVTYPE_Z_PSUVRATE_Z_PSUVUNIT_Z_PSUVQ1_Z_PSUVQ2_Z_PSUVQ3_Z_PSUVQ4_Z
"RTN","PSUVIT1",112,0)
 .. S PSUVMSG=$TR(PSUVMSG,"^","'")
"RTN","PSUVIT1",113,0)
 .. S PSUVMSG=$TR(PSUVMSG,Z,U)
"RTN","PSUVIT1",114,0)
 .. ; ** S PSUVTMP(PSUSSN,PSUVTYPE)=PSUVMSG
"RTN","PSUVIT1",115,0)
 .. S ^XTMP("PSU_"_PSUJOB,"PSUVI","TMP",PSUSSN,PSUVTYPE)=PSUVMSG
"RTN","PSUVIT1",116,0)
 Q
"RTN","PSUVIT1",117,0)
 ;               ** end of vital extract **
"RTN","PSUVIT1",118,0)
VITALS2 ; LOAD SORTED ARRAY INTO ^XTMP
"RTN","PSUVIT1",119,0)
 ;
"RTN","PSUVIT1",120,0)
 N VPT,VPTV
"RTN","PSUVIT1",121,0)
 S VPT=""
"RTN","PSUVIT1",122,0)
 ; ** F  S VPT=$O(PSUVTMP(VPT)) Q:VPT=""  D
"RTN","PSUVIT1",123,0)
 F  S VPT=$O(^XTMP("PSU_"_PSUJOB,"PSUVI","TMP",VPT)) Q:VPT=""  D
"RTN","PSUVIT1",124,0)
 . S VPTV=""
"RTN","PSUVIT1",125,0)
 . ; **F  S VPTV=$O(PSUVTMP(VPT,VPTV)) Q:VPTV=""  D
"RTN","PSUVIT1",126,0)
 . F  S VPTV=$O(^XTMP("PSU_"_PSUJOB,"PSUVI","TMP",VPT,VPTV)) Q:VPTV=""  D
"RTN","PSUVIT1",127,0)
 .. ; ** S X=PSUVTMP(VPT,VPT                     ; * LOAD VITAL RECORD
"RTN","PSUVIT1",128,0)
 .. S X=^XTMP("PSU_"_PSUJOB,"PSUVI","TMP",VPT,VPTV)
"RTN","PSUVIT1",129,0)
 .. S LINECNT=LINECNT+1
"RTN","PSUVIT1",130,0)
 .. S LINETOT=LINETOT+1
"RTN","PSUVIT1",131,0)
 .. I LINECNT>LINEMAX S MSGCNT=$G(MSGCNT)+1,LINECNT=1
"RTN","PSUVIT1",132,0)
 .. I $L(X)<254 S ^XTMP("PSU_"_PSUJOB,"PSUVI",MSGCNT,LINECNT)=X Q  ; load
"RTN","PSUVIT1",133,0)
 .. F J=254:-1 Q:$E(X,J)="^"
"RTN","PSUVIT1",134,0)
 .. S ^XTMP("PSU_"_PSUJOB,"PSUVI",MSGCNT,LINECNT)=$E(X,1,J)
"RTN","PSUVIT1",135,0)
 .. S LINECNT=LINECNT+1
"RTN","PSUVIT1",136,0)
 .. S LINETOT=LINETOT+1
"RTN","PSUVIT1",137,0)
 .. S ^XTMP("PSU_"_PSUJOB,"PSUVI",MSGCNT,LINECNT)="*"_$E(X,J,J+253)
"RTN","PSUVIT1",138,0)
 Q
"RTN","PSUVIT1",139,0)
 ;
"RTN","PSUVIT1",140,0)
IMMUNS ;
"RTN","PSUVIT1",141,0)
 N PSUDATE,ICNT,PSUINUM,PSUIREC,PSUPTPTR,PSUPTREC,PSUSSN,PSUIMPTR
"RTN","PSUVIT1",142,0)
 N PSUIMM,PSUICN,PSURTYPE,PSUIMSG
"RTN","PSUVIT1",143,0)
 ;
"RTN","PSUVIT1",144,0)
 S (PSUMCNT,PSUINUM)=0
"RTN","PSUVIT1",145,0)
 F  S PSUINUM=$O(^AUPNVIMM(PSUINUM)) Q:'PSUINUM  D
"RTN","PSUVIT1",146,0)
 . S PSUIDATE=$P($G(^AUPNVIMM(PSUINUM,12)),"U")  ; ** get IMM date **
"RTN","PSUVIT1",147,0)
 . Q:$P(PSUIDATE,U)=""               ; ** quit if date is null **
"RTN","PSUVIT1",148,0)
 . Q:PSUIDATE<SDATE!(PSUIDATE>EDATE)  ; ** quit if date out of range **
"RTN","PSUVIT1",149,0)
 . S PSUIREC=^AUPNVIMM(PSUINUM,0)    ; ** get IMM record **
"RTN","PSUVIT1",150,0)
 . S PSUPTPTR=$P(PSUIREC,U,2)        ; ** pointer to PAT file **
"RTN","PSUVIT1",151,0)
 . S PSUPTREC=^DPT(PSUPTPTR,0)       ; ** get patient record **
"RTN","PSUVIT1",152,0)
 . S PSUSSN=$P(PSUPTREC,U,9)
"RTN","PSUVIT1",153,0)
 . Q:$E(PSUSSN,1,5)="00000"          ; ** quit if invalid patient **
"RTN","PSUVIT1",154,0)
 . I $P(PSUPTREC,U,21)=1 Q
"RTN","PSUVIT1",155,0)
 . S PSUIMPTR=$P(PSUIREC,U)         ; ** point to IMM file **
"RTN","PSUVIT1",156,0)
 . S PSUIMM=$P(^AUTTIMM(PSUIMPTR,0),U)  ; ** get IMM name **
"RTN","PSUVIT1",157,0)
 . S PSUICN=$$GETICN^MPIF001(PSUPTPTR)  ; ** set ICN **
"RTN","PSUVIT1",158,0)
 . I $P(PSUICN,U)="-1" S PSUICN=""
"RTN","PSUVIT1",159,0)
 . S PSURTYPE="I"                    ; ** set record type **
"RTN","PSUVIT1",160,0)
 . S Z="$"
"RTN","PSUVIT1",161,0)
 . S PSUIMSG=Z_PSUFAC_Z_PSUIDATE_Z_PSURTYPE_Z_PSUSSN_Z_PSUICN_Z_PSUIMM_Z_""_Z_""_Z_""_Z_""_Z_""_Z_""_Z_""_Z_""_Z
"RTN","PSUVIT1",162,0)
 . S PSUIMSG=$TR(PSUIMSG,"^","'")
"RTN","PSUVIT1",163,0)
 . S X=$TR(PSUIMSG,Z,U)
"RTN","PSUVIT1",164,0)
 . ;   *** load ^XTMP  ***
"RTN","PSUVIT1",165,0)
 . S LINECNT=LINECNT+1
"RTN","PSUVIT1",166,0)
 . S LINETOT=LINETOT+1
"RTN","PSUVIT1",167,0)
 . I LINECNT>LINEMAX S MSGCNT=$G(MSGCNT)+1,LINECNT=1
"RTN","PSUVIT1",168,0)
 . I $L(X)<254 S ^XTMP("PSU_"_PSUJOB,"PSUVI",MSGCNT,LINECNT)=X Q  ; load
"RTN","PSUVIT1",169,0)
 . F K=254:-1 Q:$E(X,K)="^"
"RTN","PSUVIT1",170,0)
 . S ^XTMP("PSU_"_PSUJOB,"PSUVI",MSGCNT,LINECNT)=$E(X,1,K)
"RTN","PSUVIT1",171,0)
 . S LINECNT=LINECNT+1
"RTN","PSUVIT1",172,0)
 . S LINETOT=LINETOT+1
"RTN","PSUVIT1",173,0)
 . S ^XTMP("PSU_"_PSUJOB,"PSUVI",MSGCNT,LINECNT)="*"_$E(X,K,K+253)
"RTN","PSUVIT1",174,0)
 ;                                           *** save message count  ***
"RTN","PSUVIT1",175,0)
 S:$G(MSGCNT) ^XTMP("PSU_"_PSUJOB,"PSUVI","MSGTCNT")=MSGCNT
"RTN","PSUVIT1",176,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUVI","LINECNT")=LINETOT
"RTN","PSUVIT1",177,0)
 Q                                                ; ** quit IMMUNS **
"RTN","PSUVIT1",178,0)
 ;
"RTN","PSUVIT1",179,0)
MAILIT ; MAIL VITAL & IMMUNIZATION EXTRACT MESSAGES
"RTN","PSUVIT1",180,0)
 ;
"RTN","PSUVIT1",181,0)
 D ^PSUVIT2
"RTN","PSUVIT1",182,0)
 Q                         ;  **  quit for MAILIT  **
"RTN","PSUVIT1",183,0)
 ;
"RTN","PSUVIT2")
0^111^B3903887
"RTN","PSUVIT2",1,0)
PSUVIT2 ;BIR/RDC - Vitals/Immunizations Mail Messages; 24 DEC 2003
"RTN","PSUVIT2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;;MARCH, 2005
"RTN","PSUVIT2",3,0)
 ;
"RTN","PSUVIT2",4,0)
 ;DBIAs
"RTN","PSUVIT2",5,0)
 ;
"RTN","PSUVIT2",6,0)
VIMAIL ;ENtry point for Vitals/Immunizations Mail Message
"RTN","PSUVIT2",7,0)
 ;
"RTN","PSUVIT2",8,0)
 S DOMSG=""
"RTN","PSUVIT2",9,0)
 S XMCHAN=1
"RTN","PSUVIT2",10,0)
 S XMDUZ=DUZ
"RTN","PSUVIT2",11,0)
 S MSGTOT=$G(^XTMP("PSU_"_PSUJOB,"PSUVI","MSGTCNT"))
"RTN","PSUVIT2",12,0)
 S:MSGTOT="" MSGTOT=1
"RTN","PSUVIT2",13,0)
 S LINECNT=$G(^XTMP("PSU_"_PSUJOB,"PSUVI","LINECNT"))
"RTN","PSUVIT2",14,0)
 S:LINECNT=0 LINECNT=1
"RTN","PSUVIT2",15,0)
 ;                                 ** SET THE HEADER DATA
"RTN","PSUVIT2",16,0)
 S X=$$VALI^PSUTL(4.3,1,217)
"RTN","PSUVIT2",17,0)
 S PSUVFAC=+$$VAL^PSUTL(4,X,99)
"RTN","PSUVIT2",18,0)
 ;
"RTN","PSUVIT2",19,0)
 S X=PSUVFAC,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUVIT2",20,0)
 S X=+Y S PSUVDIV=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUVIT2",21,0)
 ;
"RTN","PSUVIT2",22,0)
 I $G(PSUMASF)!$G(PSUDUZ)!$G(PSUPBMG) S DOMSG=1 D
"RTN","PSUVIT2",23,0)
 . I '$D(^XTMP("PSU_"_PSUJOB,"PSUVI","MSGTCNT")) D  Q  ; quit - no data 
"RTN","PSUVIT2",24,0)
 .. S CURMSG=1
"RTN","PSUVIT2",25,0)
 .. S XMSUB="V. 4.0 PBMVI"_" "_PSUMON_" "_CURMSG_"/"_MSGTOT_" "_PSUVFAC_" "_PSUVDIV
"RTN","PSUVIT2",26,0)
 .. S ^XTMP("PSU_"_PSUJOB,"PSUVI","ERR",1)="No data to report"
"RTN","PSUVIT2",27,0)
 .. S XMTEXT="^XTMP(""PSU_"_PSUJOB_""",""PSUVI"",""ERR"","
"RTN","PSUVIT2",28,0)
 .. M XMY=PSUXMYS1
"RTN","PSUVIT2",29,0)
 .. D ^XMD
"RTN","PSUVIT2",30,0)
 . ;                    **  there are messages - send them **
"RTN","PSUVIT2",31,0)
 . F CURMSG=1:1:MSGTOT D
"RTN","PSUVIT2",32,0)
 .. S XMSUB="V. 4.0 PBMVI"_" "_PSUMON_" "_CURMSG_"/"_MSGTOT_" "_PSUVFAC_" "_PSUVDIV
"RTN","PSUVIT2",33,0)
 .. S XMTEXT="^XTMP(""PSU_"_PSUJOB_""",""PSUVI"","_CURMSG_","
"RTN","PSUVIT2",34,0)
 .. M XMY=PSUXMYH
"RTN","PSUVIT2",35,0)
 .. D ^XMD
"RTN","PSUVIT2",36,0)
 I DOMSG D  ;                        ** CONFIRMATION MESSAGE **
"RTN","PSUVIT2",37,0)
 . S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUVFAC,12,"L")=LINECNT
"RTN","PSUVIT2",38,0)
 . S ^XTMP("PSU_"_PSUJOB,"CONFIRM",PSUVFAC,12,"M")=MSGTOT
"RTN","PSUVIT2",39,0)
 ;
"RTN","PSUVIT2",40,0)
 Q
"RTN","PSUVIT2",41,0)
 ;
"SEC","^DIC",59.9,59.9,0,"AUDIT")
@
"SEC","^DIC",59.9,59.9,0,"DD")
@
"SEC","^DIC",59.9,59.9,0,"DEL")
@
"SEC","^DIC",59.9,59.9,0,"LAYGO")
@
"SEC","^DIC",59.9,59.9,0,"RD")
@
"SEC","^DIC",59.9,59.9,0,"WR")
@
"UP",59.7,59.79001,-1)
59.7^90.01
"UP",59.7,59.79001,0)
59.79001
"UP",59.7,59.79002,-1)
59.7^90.02
"UP",59.7,59.79002,0)
59.79002
"UP",59.7,59.79003,-1)
59.7^90.03
"UP",59.7,59.79003,0)
59.79003
"VER")
8.0^22.0
"^DD",59.7,59.7,90.01,0)
PBM AR/WS AOU MAPPINGS^59.79001P^^90.01;0
"^DD",59.7,59.7,90.01,21,0)
^.001^8^8^3040224^^^^
"^DD",59.7,59.7,90.01,21,1,0)
The mapping between an Automatic Replenishment/Ward Stock (AR/WS) Area of 
"^DD",59.7,59.7,90.01,21,2,0)
Use (AOU) and either a Medical Center Division or Outpatient Site is 
"^DD",59.7,59.7,90.01,21,3,0)
stored in this multiple. This mapping shall be used by the Pharmacy 
"^DD",59.7,59.7,90.01,21,4,0)
Benefit Management (PBM) application when extracting dispensing 
"^DD",59.7,59.7,90.01,21,5,0)
information from the AR/WS application to assign workload to the 
"^DD",59.7,59.7,90.01,21,6,0)
appropriate division or outpatient site. If an AOU is not mapped to a 
"^DD",59.7,59.7,90.01,21,7,0)
Medical Center Division or Outpatient site, the dispensing data will be 
"^DD",59.7,59.7,90.01,21,8,0)
extracted under the facility at which the database resides.
"^DD",59.7,59.7,90.01,"DT")
3030922
"^DD",59.7,59.7,90.02,0)
PBM CS NAOU MAPPINGS^59.79002P^^90.02;0
"^DD",59.7,59.7,90.02,21,0)
^^8^8^3031119^
"^DD",59.7,59.7,90.02,21,1,0)
The mapping between a Controlled Substance (CS) Narcotic Area of Use 
"^DD",59.7,59.7,90.02,21,2,0)
(NAOU) and either a Medical Center division or Outpatient site is stored 
"^DD",59.7,59.7,90.02,21,3,0)
in this multiple. This mapping shall be used by the Pharmacy Benefit 
"^DD",59.7,59.7,90.02,21,4,0)
Management (PBM) application when extracting dispensing information from 
"^DD",59.7,59.7,90.02,21,5,0)
the CS application to assign workload to the appropriate division or 
"^DD",59.7,59.7,90.02,21,6,0)
outpatient site. If a CS NAOU is not mapped to a Medical Center division
"^DD",59.7,59.7,90.02,21,7,0)
or Outpatient site, the dispensing data will be extracted under the
"^DD",59.7,59.7,90.02,21,8,0)
facility at which the database resides.
"^DD",59.7,59.7,90.02,"DT")
3030922
"^DD",59.7,59.7,90.03,0)
PBM DA PHARM LOC MAPPINGS^59.79003P^^90.03;0
"^DD",59.7,59.7,90.03,21,0)
^^8^8^3031119^
"^DD",59.7,59.7,90.03,21,1,0)
The mapping between a Drug Accountability (DA) Pharmacy location and
"^DD",59.7,59.7,90.03,21,2,0)
either a Medical Center division or Outpatient site is stored in this
"^DD",59.7,59.7,90.03,21,3,0)
multiple. This mapping shall be used by the Pharmacy Benefit Management
"^DD",59.7,59.7,90.03,21,4,0)
(PBM) application when extracting purchasing information from the DA
"^DD",59.7,59.7,90.03,21,5,0)
application to assign procurement data to the appropriate division or
"^DD",59.7,59.7,90.03,21,6,0)
Outpatient site. If a DA Pharmacy location is not mapped to a Medical
"^DD",59.7,59.7,90.03,21,7,0)
Center division or Outpatient site, the procurement data will be extracted
"^DD",59.7,59.7,90.03,21,8,0)
under the facility at which the database resides.
"^DD",59.7,59.7,90.03,"DT")
3030922
"^DD",59.7,59.79001,0)
PBM AR/WS AOU MAPPINGS SUB-FIELD^^.03^3
"^DD",59.7,59.79001,0,"DT")
3040224
"^DD",59.7,59.79001,0,"IX","B",59.79001,.01)

"^DD",59.7,59.79001,0,"NM","PBM AR/WS AOU MAPPINGS")

"^DD",59.7,59.79001,0,"UP")
59.7
"^DD",59.7,59.79001,.01,0)
AR/WS AOU ^MP58.1'X^PSI(58.1,^0;1^S DINUM=X
"^DD",59.7,59.79001,.01,1,0)
^.1
"^DD",59.7,59.79001,.01,1,1,0)
59.79001^B
"^DD",59.7,59.79001,.01,1,1,1)
S ^PS(59.7,DA(1),90.01,"B",$E(X,1,30),DA)=""
"^DD",59.7,59.79001,.01,1,1,2)
K ^PS(59.7,DA(1),90.01,"B",$E(X,1,30),DA)
"^DD",59.7,59.79001,.01,21,0)
^.001^4^4^3040224^^^
"^DD",59.7,59.79001,.01,21,1,0)
An AR/WS AOU is selectable from entries in the PHARMACY AOU STOCK (#58.1)
"^DD",59.7,59.79001,.01,21,2,0)
file. An AR/WS AOU MUST be mapped to either a Medical Center division or
"^DD",59.7,59.79001,.01,21,3,0)
an Outpatient site for dispensing data to be attributed to the appropriate
"^DD",59.7,59.79001,.01,21,4,0)
division or Outpatient site.
"^DD",59.7,59.79001,.01,"DT")
3031119
"^DD",59.7,59.79001,.02,0)
DIVISION^*P40.8'^DG(40.8,^0;2^S DIC("S")="I '$P(^PS(59.7,1,90.01,DA,0),U,3)" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",59.7,59.79001,.02,12)
An AR/WS AOU CANNOT be mapped to BOTH a division and an Outpatient site.
"^DD",59.7,59.79001,.02,12.1)
S DIC("S")="I '$P(^PS(59.7,1,90.01,DA,0),U,3)"
"^DD",59.7,59.79001,.02,21,0)
^.001^5^5^3040224^^
"^DD",59.7,59.79001,.02,21,1,0)
The Medical Center division to which the AR/WS AOU is to be mapped to, in
"^DD",59.7,59.79001,.02,21,2,0)
order for dispensing data from the AR/WS application to be assigned to the
"^DD",59.7,59.79001,.02,21,3,0)
correct division when extracted by the PBM application.
"^DD",59.7,59.79001,.02,21,4,0)
 
"^DD",59.7,59.79001,.02,21,5,0)
An AR/WS AOU CANNOT be mapped to BOTH a division and an Outpatient site.
"^DD",59.7,59.79001,.02,"DT")
3040224
"^DD",59.7,59.79001,.03,0)
OUTPATIENT SITE^*P59'X^PS(59,^0;3^S DIC("S")="I '$P(^PS(59.7,1,90.01,DA,0),U,2)" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",59.7,59.79001,.03,12)
An AR/WS AOU CANNOT be mapped to BOTH a division and an outpatient site
"^DD",59.7,59.79001,.03,12.1)
S DIC("S")="I '$P(^PS(59.7,1,90.01,DA,0),U,2)"
"^DD",59.7,59.79001,.03,21,0)
^.001^6^6^3040224^^
"^DD",59.7,59.79001,.03,21,1,0)
An Outpatient pharmacy site to which the AR/WS AOU is to be mapped to, 
"^DD",59.7,59.79001,.03,21,2,0)
in order for dispensing data from the AR/WS application to be 
"^DD",59.7,59.79001,.03,21,3,0)
assigned to the correct Outpatient site when extracted by the PBM
"^DD",59.7,59.79001,.03,21,4,0)
application.
"^DD",59.7,59.79001,.03,21,5,0)
 
"^DD",59.7,59.79001,.03,21,6,0)
An AR/WS AOU CANNOT be mapped to BOTH a division and an Outpatient site.
"^DD",59.7,59.79001,.03,"DT")
3031119
"^DD",59.7,59.79002,0)
PBM CS NAOU MAPPINGS SUB-FIELD^^.03^3
"^DD",59.7,59.79002,0,"DT")
3030918
"^DD",59.7,59.79002,0,"IX","B",59.79002,.01)

"^DD",59.7,59.79002,0,"NM","PBM CS NAOU MAPPINGS")

"^DD",59.7,59.79002,0,"UP")
59.7
"^DD",59.7,59.79002,.01,0)
CS NAOU^M*P58.8'X^PSD(58.8,^0;1^S DIC("S")="I $P(^(0),U,2)'=""P""" D ^DIC K DIC S DIC=DIE,X=+Y,DINUM=X K:Y<0 X,DINUM
"^DD",59.7,59.79002,.01,1,0)
^.1
"^DD",59.7,59.79002,.01,1,1,0)
59.79002^B
"^DD",59.7,59.79002,.01,1,1,1)
S ^PS(59.7,DA(1),90.02,"B",$E(X,1,30),DA)=""
"^DD",59.7,59.79002,.01,1,1,2)
K ^PS(59.7,DA(1),90.02,"B",$E(X,1,30),DA)
"^DD",59.7,59.79002,.01,3)
Can not be a 'P'rimary location.
"^DD",59.7,59.79002,.01,12)
A CS NAOU CANNOT be assigned a PRIMARY location type in order to be selectable.
"^DD",59.7,59.79002,.01,12.1)
S DIC("S")="I $P(^(0),U,2)'=""P"""
"^DD",59.7,59.79002,.01,21,0)
^^5^5^3031119^
"^DD",59.7,59.79002,.01,21,1,0)
A CS NAOU MUST be mapped to either a Medical Center division or an
"^DD",59.7,59.79002,.01,21,2,0)
Outpatient site for dispensing data to be attributed to the appropriate
"^DD",59.7,59.79002,.01,21,3,0)
division or Outpatient site when extracted by the PBM application.
"^DD",59.7,59.79002,.01,21,4,0)
 
"^DD",59.7,59.79002,.01,21,5,0)
A CS NAOU CANNOT be mapped to BOTH a division and an Outpatient site.
"^DD",59.7,59.79002,.01,"DT")
3031119
"^DD",59.7,59.79002,.02,0)
DIVISION^*P40.8'^DG(40.8,^0;2^S DIC("S")="I '$P(^PS(59.7,1,90.02,DA,0),U,3)" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",59.7,59.79002,.02,12)
A CS NAOU CANNOT be mapped to BOTH a division and an outpatient site.
"^DD",59.7,59.79002,.02,12.1)
S DIC("S")="I '$P(^PS(59.7,1,90.02,DA,0),U,3)"
"^DD",59.7,59.79002,.02,21,0)
^^5^5^3031119^
"^DD",59.7,59.79002,.02,21,1,0)
The Medical Center division to which the CS NAOU is to be mapped to, in
"^DD",59.7,59.79002,.02,21,2,0)
order for dispensing data from the CS application to be assigned to the
"^DD",59.7,59.79002,.02,21,3,0)
correct division when extracted by the PBM application.
"^DD",59.7,59.79002,.02,21,4,0)
 
"^DD",59.7,59.79002,.02,21,5,0)
A CS NAOU CANNOT be mapped to BOTH a division and an Outpatient site.
"^DD",59.7,59.79002,.02,"DT")
3031119
"^DD",59.7,59.79002,.03,0)
OUTPATIENT SITE^*P59'^PS(59,^0;3^S DIC("S")="I '$P(^PS(59.7,1,90.02,DA,0),U,2)" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",59.7,59.79002,.03,12)
A CS NAOU CANNOT be mapped to BOTH a division and an outpatient site.
"^DD",59.7,59.79002,.03,12.1)
S DIC("S")="I '$P(^PS(59.7,1,90.02,DA,0),U,2)"
"^DD",59.7,59.79002,.03,21,0)
^^6^6^3031119^
"^DD",59.7,59.79002,.03,21,1,0)
An outpatient pharmacy site to which the CS NAOU is to be mapped to, in
"^DD",59.7,59.79002,.03,21,2,0)
order for dispensing data from the CN NAOU application to be assigned to
"^DD",59.7,59.79002,.03,21,3,0)
the correct Outpatient site when extracted by the PBM application.
"^DD",59.7,59.79002,.03,21,4,0)
 
"^DD",59.7,59.79002,.03,21,5,0)
 
"^DD",59.7,59.79002,.03,21,6,0)
A CS NAOU CANNOT be mapped to BOTH a division and an Outpatient site.
"^DD",59.7,59.79002,.03,"DT")
3031119
"^DD",59.7,59.79003,0)
PBM DA PHARM LOC MAPPINGS SUB-FIELD^^.03^3
"^DD",59.7,59.79003,0,"DT")
3030918
"^DD",59.7,59.79003,0,"IX","B",59.79003,.01)

"^DD",59.7,59.79003,0,"NM","PBM DA PHARM LOC MAPPINGS")

"^DD",59.7,59.79003,0,"UP")
59.7
"^DD",59.7,59.79003,.01,0)
DA PHARMACY LOCATION^M*P58.8'X^PSD(58.8,^0;1^S DIC("S")="I $P(^(0),U,2)=""P""" D ^DIC K DIC S DIC=DIE,X=+Y,DINUM=X K:Y<0 X,DINUM
"^DD",59.7,59.79003,.01,1,0)
^.1
"^DD",59.7,59.79003,.01,1,1,0)
59.79003^B
"^DD",59.7,59.79003,.01,1,1,1)
S ^PS(59.7,DA(1),90.03,"B",$E(X,1,30),DA)=""
"^DD",59.7,59.79003,.01,1,1,2)
K ^PS(59.7,DA(1),90.03,"B",$E(X,1,30),DA)
"^DD",59.7,59.79003,.01,3)
Must be 'P'rimary to be selectable.
"^DD",59.7,59.79003,.01,4)

"^DD",59.7,59.79003,.01,12)
A Drug Accountability Location must be active and 'P'rimary in file #58.8.
"^DD",59.7,59.79003,.01,12.1)
S DIC("S")="I $P(^(0),U,2)=""P"""
"^DD",59.7,59.79003,.01,21,0)
^^8^8^3031119^
"^DD",59.7,59.79003,.01,21,1,0)
The DA PHARMACY LOCATIONS are selectable from the DRUG ACCOUNTABILITY 
"^DD",59.7,59.79003,.01,21,2,0)
STATS file (#58.8). Only DA Pharmacy Locations that have a 'P' for 
"^DD",59.7,59.79003,.01,21,3,0)
'Primary' in the LOCATION TYPE field (#.01) can be selected. 
"^DD",59.7,59.79003,.01,21,4,0)
 
"^DD",59.7,59.79003,.01,21,5,0)
A DA Pharmacy Location MUST be mapped to either a medical center division
"^DD",59.7,59.79003,.01,21,6,0)
or an outpatient site for procurement data to be attributed to the
"^DD",59.7,59.79003,.01,21,7,0)
appropriate division or outpatient site when extracted by the PBM
"^DD",59.7,59.79003,.01,21,8,0)
application.
"^DD",59.7,59.79003,.01,"DT")
3031119
"^DD",59.7,59.79003,.02,0)
DIVISION^*P40.8'^DG(40.8,^0;2^S DIC("S")="I '$P(^PS(59.7,1,90.03,DA,0),U,3)" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",59.7,59.79003,.02,12)
A DA Pharmacy Location CANNOT be mapped to both a division and an outpatient site.
"^DD",59.7,59.79003,.02,12.1)
S DIC("S")="I '$P(^PS(59.7,1,90.03,DA,0),U,3)"
"^DD",59.7,59.79003,.02,21,0)
^^6^6^3031119^
"^DD",59.7,59.79003,.02,21,1,0)
The Medical Center division to which the DA Pharmacy Location is to be
"^DD",59.7,59.79003,.02,21,2,0)
mapped to, in order for procurement data from the DA application to be
"^DD",59.7,59.79003,.02,21,3,0)
assigned to the correct division when extracted by the PBM application.
"^DD",59.7,59.79003,.02,21,4,0)
 
"^DD",59.7,59.79003,.02,21,5,0)
A DA Pharmacy Location CANNOT be mapped to both a division and an 
"^DD",59.7,59.79003,.02,21,6,0)
Outpatient site.
"^DD",59.7,59.79003,.02,"DT")
3031119
"^DD",59.7,59.79003,.03,0)
OUTPATIENT SITE^*P59'^PS(59,^0;3^S DIC("S")="I '$P(^PS(59.7,1,90.03,DA,0),U,2)" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",59.7,59.79003,.03,12)
A DA Pharmacy Location CANNOT be mapped to both a division and an outpatient site.
"^DD",59.7,59.79003,.03,12.1)
S DIC("S")="I '$P(^PS(59.7,1,90.03,DA,0),U,2)"
"^DD",59.7,59.79003,.03,21,0)
^^7^7^3031119^
"^DD",59.7,59.79003,.03,21,1,0)
An outpatient pharmacy site to which the DA Pharm Location is to be mapped
"^DD",59.7,59.79003,.03,21,2,0)
to, in order for procurement data from the DA Pharmacy Location
"^DD",59.7,59.79003,.03,21,3,0)
application to be attributed to the current Outpatient site when extracted
"^DD",59.7,59.79003,.03,21,4,0)
by the PBM application.
"^DD",59.7,59.79003,.03,21,5,0)
 
"^DD",59.7,59.79003,.03,21,6,0)
A DA Pharm Location CANNOT be mapped to BOTH a division and an 
"^DD",59.7,59.79003,.03,21,7,0)
Outpatient site.
"^DD",59.7,59.79003,.03,"DT")
3031119
"^DD",59.9,59.9,0)
FIELD^^.02^2
"^DD",59.9,59.9,0,"DDA")
N
"^DD",59.9,59.9,0,"DT")
3030619
"^DD",59.9,59.9,0,"IX","B",59.9,.01)

"^DD",59.9,59.9,0,"NM","PBM PATIENT DEMOGRAPHICS")

"^DD",59.9,59.9,0,"VRPK")
PSU
"^DD",59.9,59.9,.01,0)
EVENT DATE/TIME^RD^^0;1^S %DT="ETR" D ^%DT S X=Y K:Y<1 X
"^DD",59.9,59.9,.01,1,0)
^.1^^-1
"^DD",59.9,59.9,.01,1,1,0)
59.9^B
"^DD",59.9,59.9,.01,1,1,1)
S ^PSUDEM("B",$E(X,1,30),DA)=""
"^DD",59.9,59.9,.01,1,1,2)
K ^PSUDEM("B",$E(X,1,30),DA)
"^DD",59.9,59.9,.01,3)

"^DD",59.9,59.9,.01,21,0)
^.001^5^5^3050427^^
"^DD",59.9,59.9,.01,21,1,0)
This field records the date and time when any change occurs in the 
"^DD",59.9,59.9,.01,21,2,0)
PATIENT file (#2) on any field captured in the PBM Patient 
"^DD",59.9,59.9,.01,21,3,0)
Demographics Extract. These changes are captured by the DG Field 
"^DD",59.9,59.9,.01,21,4,0)
Monitor. The data in this field is purged monthly for all data older 
"^DD",59.9,59.9,.01,21,5,0)
than 75 days.
"^DD",59.9,59.9,.01,"DT")
3050427
"^DD",59.9,59.9,.02,0)
PATIENT^P2'^DPT(^0;2^Q
"^DD",59.9,59.9,.02,1,0)
^.1^^0
"^DD",59.9,59.9,.02,21,0)
^^5^5^3050426^
"^DD",59.9,59.9,.02,21,1,0)
This field records the PATIENT DFN when any change occurs in the PATIENT 
"^DD",59.9,59.9,.02,21,2,0)
file (#2) on any field captured in the PBM Patient Demographics Extract.
"^DD",59.9,59.9,.02,21,3,0)
When the monthly patient demographic extract runs, it will harvest data 
"^DD",59.9,59.9,.02,21,4,0)
from the PATIENT file (#2) for the DFNs stored in this field and all data 
"^DD",59.9,59.9,.02,21,5,0)
older than 75 days will be purged from this file. 
"^DD",59.9,59.9,.02,"DT")
3030619
"^DIC",59.9,59.9,0)
PBM PATIENT DEMOGRAPHICS^59.9
"^DIC",59.9,59.9,0,"GL")
^PSUDEM(
"^DIC",59.9,59.9,"%",0)
^1.005^^
"^DIC",59.9,59.9,"%D",0)
^^4^4^3050426^
"^DIC",59.9,59.9,"%D",1,0)
This file captures the date, time, and PATIENT DFN when any change occurs 
"^DIC",59.9,59.9,"%D",2,0)
in the PATIENT file (#2) on any field captured in the PBM Patient 
"^DIC",59.9,59.9,"%D",3,0)
Demographics Extract. Data in this file will be purged monthly for data 
"^DIC",59.9,59.9,"%D",4,0)
older than 75 days.
"^DIC",59.9,"B","PBM PATIENT DEMOGRAPHICS",59.9)

**INSTALL NAME**
PSO*7.0*165
"BLD",4725,0)
PSO*7.0*165^OUTPATIENT PHARMACY^0^3050622^y
"BLD",4725,1,0)
^^16^16^3050121^
"BLD",4725,1,1,0)
The routine PSOORDER, which supported DBIA #1878 has been updated to 
"BLD",4725,1,2,0)
include new data elements at the request of Pharmacy Benefit Management 
"BLD",4725,1,3,0)
(PBM).  See DBIA #1878 for complete details.
"BLD",4725,1,4,0)
 
"BLD",4725,1,5,0)
 
"BLD",4725,1,6,0)
 
"BLD",4725,1,7,0)
 
"BLD",4725,1,8,0)
The following data elements from the Prescription file (#52) were added.
"BLD",4725,1,9,0)
 NDC (original, refill, partial)
"BLD",4725,1,10,0)
 LOGIN DATE (original, refill, partial)
"BLD",4725,1,11,0)
 TPB RX
"BLD",4725,1,12,0)
 EXPANDED PATIENT INSTRUCTIONS 
"BLD",4725,1,13,0)
 FINISHING PERSON
"BLD",4725,1,14,0)
 MEDICATION INSTRUCTION sub-file fields:
"BLD",4725,1,15,0)
 DOSAGE INSTRUCTION, DISPENSE UNITS PER DOSE, UNITS, NOUN, 
"BLD",4725,1,16,0)
 DURATION, CONJUNCTION, ROUTE, SCHEDULE, VERB
"BLD",4725,4,0)
^9.64PA^^
"BLD",4725,"KRN",0)
^9.67PA^8989.52^19
"BLD",4725,"KRN",.4,0)
.4
"BLD",4725,"KRN",.401,0)
.401
"BLD",4725,"KRN",.402,0)
.402
"BLD",4725,"KRN",.403,0)
.403
"BLD",4725,"KRN",.5,0)
.5
"BLD",4725,"KRN",.84,0)
.84
"BLD",4725,"KRN",3.6,0)
3.6
"BLD",4725,"KRN",3.8,0)
3.8
"BLD",4725,"KRN",9.2,0)
9.2
"BLD",4725,"KRN",9.8,0)
9.8
"BLD",4725,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",4725,"KRN",9.8,"NM",1,0)
PSOORDER^^0^B68319447
"BLD",4725,"KRN",9.8,"NM","B","PSOORDER",1)

"BLD",4725,"KRN",19,0)
19
"BLD",4725,"KRN",19.1,0)
19.1
"BLD",4725,"KRN",101,0)
101
"BLD",4725,"KRN",409.61,0)
409.61
"BLD",4725,"KRN",771,0)
771
"BLD",4725,"KRN",870,0)
870
"BLD",4725,"KRN",8989.51,0)
8989.51
"BLD",4725,"KRN",8989.52,0)
8989.52
"BLD",4725,"KRN",8994,0)
8994
"BLD",4725,"KRN","B",.4,.4)

"BLD",4725,"KRN","B",.401,.401)

"BLD",4725,"KRN","B",.402,.402)

"BLD",4725,"KRN","B",.403,.403)

"BLD",4725,"KRN","B",.5,.5)

"BLD",4725,"KRN","B",.84,.84)

"BLD",4725,"KRN","B",3.6,3.6)

"BLD",4725,"KRN","B",3.8,3.8)

"BLD",4725,"KRN","B",9.2,9.2)

"BLD",4725,"KRN","B",9.8,9.8)

"BLD",4725,"KRN","B",19,19)

"BLD",4725,"KRN","B",19.1,19.1)

"BLD",4725,"KRN","B",101,101)

"BLD",4725,"KRN","B",409.61,409.61)

"BLD",4725,"KRN","B",771,771)

"BLD",4725,"KRN","B",870,870)

"BLD",4725,"KRN","B",8989.51,8989.51)

"BLD",4725,"KRN","B",8989.52,8989.52)

"BLD",4725,"KRN","B",8994,8994)

"BLD",4725,"QUES",0)
^9.62^^
"BLD",4725,"REQB",0)
^9.611^1^1
"BLD",4725,"REQB",1,0)
PSO*7.0*103^2
"BLD",4725,"REQB","B","PSO*7.0*103",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
165^3050622^10000000012
"PKG",141,22,1,"PAH",1,1,0)
^^16^16^3050622
"PKG",141,22,1,"PAH",1,1,1,0)
The routine PSOORDER, which supported DBIA #1878 has been updated to 
"PKG",141,22,1,"PAH",1,1,2,0)
include new data elements at the request of Pharmacy Benefit Management 
"PKG",141,22,1,"PAH",1,1,3,0)
(PBM).  See DBIA #1878 for complete details.
"PKG",141,22,1,"PAH",1,1,4,0)
 
"PKG",141,22,1,"PAH",1,1,5,0)
 
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
 
"PKG",141,22,1,"PAH",1,1,8,0)
The following data elements from the Prescription file (#52) were added.
"PKG",141,22,1,"PAH",1,1,9,0)
 NDC (original, refill, partial)
"PKG",141,22,1,"PAH",1,1,10,0)
 LOGIN DATE (original, refill, partial)
"PKG",141,22,1,"PAH",1,1,11,0)
 TPB RX
"PKG",141,22,1,"PAH",1,1,12,0)
 EXPANDED PATIENT INSTRUCTIONS 
"PKG",141,22,1,"PAH",1,1,13,0)
 FINISHING PERSON
"PKG",141,22,1,"PAH",1,1,14,0)
 MEDICATION INSTRUCTION sub-file fields:
"PKG",141,22,1,"PAH",1,1,15,0)
 DOSAGE INSTRUCTION, DISPENSE UNITS PER DOSE, UNITS, NOUN, 
"PKG",141,22,1,"PAH",1,1,16,0)
 DURATION, CONJUNCTION, ROUTE, SCHEDULE, VERB
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSOORDER")
0^1^B68319447
"RTN","PSOORDER",1,0)
PSOORDER ;BHAM ISC/SAB- utility routine to return Rx data ; 04/09/96 10:30 am
"RTN","PSOORDER",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,20,9,46,103,165**;DEC 1997
"RTN","PSOORDER",3,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOORDER",4,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOORDER",5,0)
 ;^VA(200 supported by DBIA 10060
"RTN","PSOORDER",6,0)
 ;^SC supported by DBIA 10040
"RTN","PSOORDER",7,0)
 ;^DPT supported by DBIA 10035
"RTN","PSOORDER",8,0)
 ;^PSNAPIS supported by DBIA 2531
"RTN","PSOORDER",9,0)
 ;^PSNDF supported by DBIA 2195
"RTN","PSOORDER",10,0)
 ;^PS(50.7 supported by DBIA 2223
"RTN","PSOORDER",11,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOORDER",12,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOORDER",13,0)
 ;^PS(50.607 supported by DBIA 2221
"RTN","PSOORDER",14,0)
 ;
"RTN","PSOORDER",15,0)
 ;for full break down of data returned see DBIA #1878
"RTN","PSOORDER",16,0)
 ;
"RTN","PSOORDER",17,0)
EN(DFN,RX) ;
"RTN","PSOORDER",18,0)
 K ^TMP("PSOR",$J)
"RTN","PSOORDER",19,0)
 N SIG,SG,IEN,CMOP,CMIN,CMIND,HDST,I,LSFD,PSO2,PSOCF,PSOCST,PSODR,PSODT,PSOLFD,PSOFD,PSOID,PSOJ,PSOPR,PSOPLCL,PSOPLPR,PSOREF,PSORF,PSORFCL,PSORFPR,PSOST,PSOX,RX0,RX0,RX1,RX3,RX3,RXH,RXP,ST0,SUS,FPN
"RTN","PSOORDER",20,0)
 Q:'$D(^PSRX(RX,0))!('$D(^PSRX(RX,2)))!('$D(^PSRX(RX,3)))!($G(^PSRX(RX,"STA"))=13)
"RTN","PSOORDER",21,0)
 I $G(DFN)'="",$P($G(^PSRX(RX,0)),"^",2)'=$G(DFN) Q
"RTN","PSOORDER",22,0)
 I '$G(DFN) S DFN=+$P($G(^PSRX(RX,0)),"^",2)
"RTN","PSOORDER",23,0)
 K PSOLOUD D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOORDER",24,0)
 S:$G(^PSRX(RX,"IB"))]"" ^TMP("PSOR",$J,RX,"IB")=$P(^PSRX(RX,"IB"),"^",1,2)
"RTN","PSOORDER",25,0)
 S RX0=^PSRX(RX,0),RX2=^(2),RX3=^(3),RXH=$G(^("H")),PSORF=$P(RX0,"^",9),LSFD=$P(RX2,"^",2),ST0=$P($G(^("STA")),"^"),OERR=$G(^("OR1")) D
"RTN","PSOORDER",26,0)
 .F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  I $D(^PSRX(RX,1,I,0)) S RX1(I)=^PSRX(RX,1,I,0),PSORF=PSORF-1,LSFD=+RX1(I),PSOCST=$P(RX1(I),"^",4)*+$P(RX1(I),"^",11) D
"RTN","PSOORDER",27,0)
 ..S PSORFPR=$P(RX0,"^",4) I PSORFPR S PSORFPR=PSORFPR_";"_$P($G(^VA(200,PSORFPR,0)),"^")
"RTN","PSOORDER",28,0)
 ..S PSORFCL=$P(RX1(I),"^",7) I PSORFCL S PSORFCL=PSORFCL_";"_$P($G(^VA(200,PSORFCL,0)),"^")
"RTN","PSOORDER",29,0)
 ..S ^TMP("PSOR",$J,RX,"REF",I,0)=+RX1(I)_"^"_$G(PSORFPR)_"^"_$G(PSORFCL)_"^"_$P(RX1(I),"^",4)_"^"_+$P(RX1(I),"^",10)_"^"_+$P(RX1(I),"^",11)_"^"
"RTN","PSOORDER",30,0)
 ..S ^TMP("PSOR",$J,RX,"REF",I,0)=^TMP("PSOR",$J,RX,"REF",I,0)_PSOCST_"^"_$P(RX1(I),"^",18)_"^"_$P(RX1(I),"^",16)_"^"
"RTN","PSOORDER",31,0)
 ..S ^TMP("PSOR",$J,RX,"REF",I,0)=^TMP("PSOR",$J,RX,"REF",I,0)_$S($P(RX1(I),"^",2)="M":"M;MAIL",1:"W;WINDOW")_"^"_$P(RX1(I),"^",9)_"^"_$P(RX1(I),"^",8)_"^"_$P($G(^PSRX(RX,1,I,1)),"^",3)
"RTN","PSOORDER",32,0)
 .F I=0:0 S I=$O(^PSRX(RX,"P",I)) Q:'I  I $D(^PSRX(RX,"P",I,0)) S RXP(I)=^PSRX(RX,"P",I,0) D
"RTN","PSOORDER",33,0)
 ..S PSOCST=$P(RXP(I),"^",4)*+$P(RXP(I),"^",11)
"RTN","PSOORDER",34,0)
 ..S PSOPLPR=$P(RX0,"^",4) I PSOPLPR S PSOPLPR=PSOPLPR_";"_$P($G(^VA(200,PSOPLPR,0)),"^")
"RTN","PSOORDER",35,0)
 ..S PSOPLCL=$P(RXP(I),"^",7) I PSOPLCL S PSOPLCL=PSOPLCL_";"_$P($G(^VA(200,PSOPLCL,0)),"^")
"RTN","PSOORDER",36,0)
 ..S ^TMP("PSOR",$J,RX,"RPAR",I,0)=+RXP(I)_"^"_$G(PSOPLPR)_"^"_$G(PSOPLCL)_"^"_$P(RXP(I),"^",4)_"^"_+$P(RXP(I),"^",10)_"^"
"RTN","PSOORDER",37,0)
 ..S ^TMP("PSOR",$J,RX,"RPAR",I,0)=^TMP("PSOR",$J,RX,"RPAR",I,0)_+$P(RXP(I),"^",11)_"^"_PSOCST_"^"_$P(RXP(I),"^",19)_"^"_$P(RXP(I),"^",16)_"^"
"RTN","PSOORDER",38,0)
 ..S ^TMP("PSOR",$J,RX,"RPAR",I,0)=^TMP("PSOR",$J,RX,"RPAR",I,0)_$S($P(RXP(I),"^",2)="M":"M;MAIL",1:"W;WINDOW")_"^"_$P(RXP(I),"^",9)_"^"_$P(RXP(I),"^",8)_"^"_$P(RXP(I),"^",12)
"RTN","PSOORDER",39,0)
 .S MI=0 F I=0:0 S I=$O(^PSRX(RX,6,I)) Q:'I  S RP(I)=^PSRX(RX,6,I,0) D
"RTN","PSOORDER",40,0)
 ..S UN=$P(RP(I),"^",3) I UN S PSOX=$G(^PS(50.607,UN,0)) S UN=UN_";"_$P(PSOX,"^")
"RTN","PSOORDER",41,0)
 ..S RT=$P(RP(I),"^",7) I RT S PSOX=$G(^PS(51.2,RT,0)) S RT=RT_";"_$P(PSOX,"^")
"RTN","PSOORDER",42,0)
 ..S MI=MI+1,^TMP("PSOR",$J,RX,"MI",MI,0)=$P(RP(I),"^")_"^"_$P(RP(I),"^",2)_"^"_UN_"^"_$P(RP(I),"^",4)_"^"_$P(RP(I),"^",5)_"^"_$P(RP(I),"^",6)_"^"_RT_"^"_$P(RP(I),"^",8)_"^"_$P(RP(I),"^",9)
"RTN","PSOORDER",43,0)
 .F I=0:0 S I=$O(^PSRX(RX,"INS1",I)) Q:'I  S ^TMP("PSOR",$J,RX,"PI",I,0)=^PSRX(RX,"INS1",I,0)
"RTN","PSOORDER",44,0)
 K MI,RP,PSOX,UN,RT
"RTN","PSOORDER",45,0)
 S PSOLFD=+$G(RX3),PSODR=+$P(RX0,"^",6),PSOPR=$P(RX0,"^",4),PSOREF=$P(RX0,"^",9),PSOID=$P(RX0,"^",13),PSOST=$P($G(^PSRX(RX,"STA")),"^"),PSODT=$P(RX2,"^",6)
"RTN","PSOORDER",46,0)
 D ODT S PSOFD=$P(RX2,"^",2),PSOX=$S($D(^PSDRUG(PSODR,0)):$P(^(0),"^"),1:"NOT ON FILE"),PSODR=PSODR_";"_PSOX
"RTN","PSOORDER",47,0)
 S PSOPR=$P(RX0,"^",4) I PSOPR S PSOX=$G(^VA(200,PSOPR,0)) S PSOPR=PSOPR_";"_$P(PSOX,"^")
"RTN","PSOORDER",48,0)
 S CLK=$P(RX0,"^",16) I CLK S PSOX=$G(^VA(200,CLK,0)) S CLK=CLK_";"_$P(PSOX,"^")
"RTN","PSOORDER",49,0)
 S VPR=$P(RX2,"^",10) I VPR S PSOX=$G(^VA(200,VPR,0)) S VPR=VPR_";"_$P(PSOX,"^")
"RTN","PSOORDER",50,0)
 S FPN=$P(OERR,"^",5) I FPN S PSOX=$G(^VA(200,FPN,0)) S FPN=FPN_";"_$P(PSOX,"^")
"RTN","PSOORDER",51,0)
 S CLN=$P(RX0,"^",5) I CLN S PSOX=$G(^SC(CLN,0)) S CLN=CLN_";"_$P(PSOX,"^")
"RTN","PSOORDER",52,0)
 S RXP=$P(RX0,"^",3)_";"_$P($G(^PS(53,+$P(RX0,"^",3),0)),"^")
"RTN","PSOORDER",53,0)
 S MW=$S($P(RX0,"^",11)="W":"W;WINDOW",1:"M;MAIL")
"RTN","PSOORDER",54,0)
 S PSOX="A;ACTIVE" S:$D(^PS(52.4,RX,0)) PSOX="N;NON-VERIFIED" S:$O(^PS(52.5,"B",RX,0))&($G(^PS(52.5,+$O(^PS(52.5,"B",RX,0)),"P"))'=1) PSOX="S;SUSPENDED"
"RTN","PSOORDER",55,0)
 I ST0<12,$P(RX2,"^",6)<DT S ST0=11
"RTN","PSOORDER",56,0)
 S PSOX=$P("Error^A;Active^N;Non-Verified^R;Refill^H;Hold^N;Non-Verified^S;Suspended^^^^^D;Done^E;Expired^DC;Discontinued^D;Deleted^DC;Discontinued^DC;Discontinued (Edit)^H;Provider Hold^","^",ST0+2)
"RTN","PSOORDER",57,0)
 D:PSOX="H;Hold"
"RTN","PSOORDER",58,0)
 .S RXH=$G(^PSRX(RX,"H"))
"RTN","PSOORDER",59,0)
 .S HDST=$S(+RXH=1:"Insufficient QTY in Stock",+RXH=2:"Drug Interaction",+RXH=3:"Patient Reaction",+RXH=4:"Physician to be Contacted",+RXH=5:"Allergy Reactions",+RXH=6:"Drug Reaction",1:"Other--See Comments")
"RTN","PSOORDER",60,0)
 .S ^TMP("PSOR",$J,RX,"HOLD",0)=HDST_"^"_$P(RXH,"^",2)_"^"_$P(RXH,"^",3)
"RTN","PSOORDER",61,0)
 S PSOCF=+$P(RX0,"^",17)*(+$P(RX0,"^",7)) ;cost of original fill;
"RTN","PSOORDER",62,0)
 S ^TMP("PSOR",$J,RX,0)=PSOID_"^"_PSOFD_"^"_PSOLFD_"^"_$G(PSOX)_"^"_$P(RX0,"^")_"^"_$P(RX0,"^",7)_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",9)_"^"_$G(PSORF)_"^"_+$P(RX0,"^",17)_"^"_$G(PSOCF)_"^"_$G(PSODT)_"^"_$P(RX2,"^",13)_"^"_$P(RX2,"^",15)
"RTN","PSOORDER",63,0)
 S ^TMP("PSOR",$J,RX,0)=^TMP("PSOR",$J,RX,0)_"^"_$S($P($G(^PSRX(RX,"PC")),"^"):"Yes",1:"No")_"^"_$G(DFN)_";"_$P($G(^DPT(+$G(DFN),0)),"^")_"^"_$P(RX2,"^")
"RTN","PSOORDER",64,0)
 S ^TMP("PSOR",$J,RX,1)=PSOPR_"^"_CLK_"^"_VPR_"^"_CLN_"^"_RXP_"^"_MW_"^"_$P(RX2,"^",9)_"^"_$P(OERR,"^",2)_"^"_FPN_"^"_$P(RX2,"^",7)_"^"_$P($G(^PSRX(RX,"TPB")),"^")
"RTN","PSOORDER",65,0)
 S ^TMP("PSOR",$J,RX,"DRUG",0)=$G(PSODR)
"RTN","PSOORDER",66,0)
 I +$G(^PSDRUG(+$P(RX0,"^",6),"ND")),+$P($G(^("ND")),"^",3) D
"RTN","PSOORDER",67,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$PROD2^PSNAPIS($P(^PSDRUG(+$P(RX0,"^",6),"ND"),"^"),$P(^PSDRUG(+$P(RX0,"^",6),"ND"),"^",3)) S ^TMP("PSOR",$J,RX,"DRUG",0)=^TMP("PSOR",$J,RX,"DRUG",0)_"^"_$P($G(PSOXN),"^")_"^"_$P($G(PSOXN),"^",2) D  Q
"RTN","PSOORDER",68,0)
 ..S ^TMP("PSOR",$J,RX,"DRUG",0)=^TMP("PSOR",$J,RX,"DRUG",0)_"^"_$P(^PSDRUG(+$P(RX0,"^",6),0),"^",2) K PSOXN
"RTN","PSOORDER",69,0)
 .S ^TMP("PSOR",$J,RX,"DRUG",0)=^TMP("PSOR",$J,RX,"DRUG",0)_"^"_$P($G(^PSNDF($P(^PSDRUG(+$P(RX0,"^",6),"ND"),"^"),5,+$P(^PSDRUG(+$P(RX0,"^",6),"ND"),"^",3),2)),"^")_"^"_$P($G(^(2)),"^",2)_"^"_$P(^PSDRUG(+$P(RX0,"^",6),0),"^",2)
"RTN","PSOORDER",70,0)
 S ^TMP("PSOR",$J,RX,"DRUGOI",0)=$S(+$P(OERR,"^"):$P(OERR,"^")_";"_$P($G(^PS(50.7,+$P(OERR,"^"),0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^"),1:"Not Matched to an Orderable Item")
"RTN","PSOORDER",71,0)
 ;returns activity log
"RTN","PSOORDER",72,0)
 F I=0:0 S I=$O(^PSRX(RX,"A",I)) Q:'I  D
"RTN","PSOORDER",73,0)
 .S ZR=$P(^PSRX(RX,"A",I,0),"^",2),RF=+$P(^(0),"^",4)
"RTN","PSOORDER",74,0)
 .S RFT=$S(RF>0&(RF<6):"REFILL "_RF,RF=6:"PARTIAL",RF>6:"REFILL "_(RF-1),1:"ORIGINAL") D
"RTN","PSOORDER",75,0)
 ..S REA=$S(ZR="H":"HOLD",ZR="U":"UNHOLD",ZR="C":"DISCONTINUED",ZR="E":"EDIT",ZR="L":"RENEWED",ZR="P":"PARTIAL",ZR="R":"REINSTATE",ZR="W":"REPRINT REQUEST",ZR="S":"SUSPENDED",ZR="I":"RETURNED TO STOCK",ZR="V":"INTERVENTION",1:0) I REA'=0 Q
"RTN","PSOORDER",76,0)
 ..S REA=$S(ZR="D":"DELETED",ZR="A":"PENDING/DRUG INTERACTION",ZR="B":"PROCESSED",ZR="X":"X-INTERFACE",1:"EDIT")
"RTN","PSOORDER",77,0)
 .S ^TMP("PSOR",$J,RX,"ACT",I,0)=$P(^PSRX(RX,"A",I,0),"^")_"^"_REA_"^"_$S($P(^(0),"^",3):$P(^(0),"^",3)_";"_$P($G(^VA(200,$P(^(0),"^",3),0)),"^"),1:"Unknown")_"^"_RFT_"^"_$P(^PSRX(RX,"A",I,0),"^",5) K REA,ZR,RFT,RF
"RTN","PSOORDER",78,0)
 S SUS=$O(^PS(52.5,"B",RX,0)) I SUS D
"RTN","PSOORDER",79,0)
 .S ^TMP("PSOR",$J,RX,"SUS",0)=$S(+$G(^PS(52.5,SUS,"P")):"Printed",1:"Not Printed")
"RTN","PSOORDER",80,0)
 .I $P($G(^PS(52.5,SUS,0)),"^",7)]"" S CMIN=$P(^PS(52.5,SUS,0),"^",7) D
"RTN","PSOORDER",81,0)
 ..S CMIND=$S(CMIN="Q":"Queued for Transmission",CMIN="X":"Transmission Completed",CMIN="L":"Loading Transmission",1:"Printed Locally"),^TMP("PSOR",$J,RX,"SUS",0)=^TMP("PSOR",$J,RX,"SUS",0)_"^"_CMIND
"RTN","PSOORDER",82,0)
 I '$P($G(^PSRX(RX,"SIG")),"^",2) S ^TMP("PSOR",$J,RX,"SIG",1,0)=$P($G(^PSRX(RX,"SIG")),"^") D  G CMOP
"RTN","PSOORDER",83,0)
 .;expands and save SIG
"RTN","PSOORDER",84,0)
 .S IEN=1,(SIG,X)=$P($G(^PSRX(RX,"SIG")),"^") D:'$G(PSUPSO) SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORDER",85,0)
 .F SG=1:1:$L(SIG) S:$L($G(^TMP("PSOR",$J,RX,"SIG1",IEN,0)))>75 IEN=IEN+1 S:$P(SIG," ",SG)'="" ^TMP("PSOR",$J,RX,"SIG1",IEN,0)=$G(^TMP("PSOR",$J,RX,"SIG1",IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORDER",86,0)
 E  F I=0:0 S I=$O(^PSRX(RX,"SIG1",I)) Q:'I  S ^TMP("PSOR",$J,RX,"SIG",I,0)=$G(^PSRX(RX,"SIG1",I,0)),^TMP("PSOR",$J,RX,"SIG1",I,0)=$G(^(0))
"RTN","PSOORDER",87,0)
CMOP F I=0:0 S I=$O(^PSRX(RX,4,I)) Q:'I  I $D(^PSRX(RX,4,I,0)) S CMOP=^PSRX(RX,4,I,0) D
"RTN","PSOORDER",88,0)
 .S ^TMP("PSOR",$J,RX,"CMOP",I,0)=$P(CMOP,"^")_"^"_$P(CMOP,"^",2)_"^"_$P(CMOP,"^",3)_"^"_$S($P(CMOP,"^",4)=1:"1;Dispensed",$P(CMOP,"^",4)=2:"2;Retransmitted",$P(CMOP,"^",4)=3:"3;Not Dispensed",1:"0;Transmitted")_"^"_$P(CMOP,"^",5)
"RTN","PSOORDER",89,0)
 .S ^TMP("PSOR",$J,RX,"CMOP",I,0)=^TMP("PSOR",$J,RX,"CMOP",I,0)_"^"_$P(CMOP,"^",8)
"RTN","PSOORDER",90,0)
 .S:$P(CMOP,"^",4)=3 ^TMP("PSOR",$J,RX,"CMOP",1,1,0)=$G(^PSRX(RX,4,I,1,0))
"RTN","PSOORDER",91,0)
 K SIG,SG,IEN,CMOP,CMIN,CMIND,HDST,I,LSFD,PSO2,PSOCF,PSOCST,PSODR,PSODT,PSOLFD,PSOFD,PSOID,PSOJ,PSOPR,PSOPLCL,PSOPLPR,PSOREF,PSORF,PSORFCL,PSORFPR,PSOST,PSOX,RX,RX0,RX0,RX1,RX3,RX3,RXH,RXP,ST0,SUS,FPN
"RTN","PSOORDER",92,0)
 Q
"RTN","PSOORDER",93,0)
ODT ;canceled or expiration date
"RTN","PSOORDER",94,0)
 I +PSOST=12!(+PSOST=14)!(+PSOST=15) D
"RTN","PSOORDER",95,0)
 .I $P(^PSRX(RX,3),"^",5) S PSODT=$P(^PSRX(RX,3),"^",5) Q
"RTN","PSOORDER",96,0)
 .F PSOJ=0:0 S PSOJ=$O(^PSRX(RX,"A",PSOJ)) Q:PSOJ'>0  I $P($G(^PSRX(RX,"A",PSOJ,0)),"^")<PSODT,+$P($G(^(0)),"^",2)="C" S PSODT=+$P($G(^(0)),"^")
"RTN","PSOORDER",97,0)
 Q
"VER")
8.0^22.0
**END**
**END**
