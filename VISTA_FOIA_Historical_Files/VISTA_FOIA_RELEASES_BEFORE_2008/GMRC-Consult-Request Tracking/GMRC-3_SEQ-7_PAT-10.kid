Released GMRC*3*10 SEQ #7
Extracted from mail message
**KIDS**:GMRC*3.0*10^

**INSTALL NAME**
GMRC*3.0*10
"BLD",1803,0)
GMRC*3.0*10^CONSULT/REQUEST TRACKING^0^2991202^y
"BLD",1803,1,0)
^^1^1^2990708^
"BLD",1803,1,1,0)
See National Patch Module for detailed explanation of enhancements.
"BLD",1803,4,0)
^9.64PA^^
"BLD",1803,"ABPKG")
n
"BLD",1803,"KRN",0)
^9.67PA^19^18
"BLD",1803,"KRN",.4,0)
.4
"BLD",1803,"KRN",.401,0)
.401
"BLD",1803,"KRN",.402,0)
.402
"BLD",1803,"KRN",.403,0)
.403
"BLD",1803,"KRN",.5,0)
.5
"BLD",1803,"KRN",.84,0)
.84
"BLD",1803,"KRN",3.6,0)
3.6
"BLD",1803,"KRN",3.8,0)
3.8
"BLD",1803,"KRN",9.2,0)
9.2
"BLD",1803,"KRN",9.8,0)
9.8
"BLD",1803,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",1803,"KRN",9.8,"NM",1,0)
GMRCA1^^0^B19560811
"BLD",1803,"KRN",9.8,"NM",2,0)
GMRCADC^^0^B10025159
"BLD",1803,"KRN",9.8,"NM",3,0)
GMRCASF^^0^B11916526
"BLD",1803,"KRN",9.8,"NM",4,0)
GMRCEDIT^^0^B10551219
"BLD",1803,"KRN",9.8,"NM",5,0)
GMRCAFRD^^0^B31061058
"BLD",1803,"KRN",9.8,"NM",6,0)
GMRCTIUE^^0^B30284600
"BLD",1803,"KRN",9.8,"NM",7,0)
GMRCSLM1^^0^B44345674
"BLD",1803,"KRN",9.8,"NM","B","GMRCA1",1)

"BLD",1803,"KRN",9.8,"NM","B","GMRCADC",2)

"BLD",1803,"KRN",9.8,"NM","B","GMRCAFRD",5)

"BLD",1803,"KRN",9.8,"NM","B","GMRCASF",3)

"BLD",1803,"KRN",9.8,"NM","B","GMRCEDIT",4)

"BLD",1803,"KRN",9.8,"NM","B","GMRCSLM1",7)

"BLD",1803,"KRN",9.8,"NM","B","GMRCTIUE",6)

"BLD",1803,"KRN",19,0)
19
"BLD",1803,"KRN",19.1,0)
19.1
"BLD",1803,"KRN",101,0)
101
"BLD",1803,"KRN",409.61,0)
409.61
"BLD",1803,"KRN",771,0)
771
"BLD",1803,"KRN",869.2,0)
869.2
"BLD",1803,"KRN",870,0)
870
"BLD",1803,"KRN",8994,0)
8994
"BLD",1803,"KRN","B",.4,.4)

"BLD",1803,"KRN","B",.401,.401)

"BLD",1803,"KRN","B",.402,.402)

"BLD",1803,"KRN","B",.403,.403)

"BLD",1803,"KRN","B",.5,.5)

"BLD",1803,"KRN","B",.84,.84)

"BLD",1803,"KRN","B",3.6,3.6)

"BLD",1803,"KRN","B",3.8,3.8)

"BLD",1803,"KRN","B",9.2,9.2)

"BLD",1803,"KRN","B",9.8,9.8)

"BLD",1803,"KRN","B",19,19)

"BLD",1803,"KRN","B",19.1,19.1)

"BLD",1803,"KRN","B",101,101)

"BLD",1803,"KRN","B",409.61,409.61)

"BLD",1803,"KRN","B",771,771)

"BLD",1803,"KRN","B",869.2,869.2)

"BLD",1803,"KRN","B",870,870)

"BLD",1803,"KRN","B",8994,8994)

"BLD",1803,"QUES",0)
^9.62^^
"BLD",1803,"REQB",0)
^9.611^1^1
"BLD",1803,"REQB",1,0)
OR*3.0*48^2
"BLD",1803,"REQB","B","OR*3.0*48",1)

"MBREQ")
0
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
10^2991202
"PKG",128,22,1,"PAH",1,1,0)
^^1^1^2991202
"PKG",128,22,1,"PAH",1,1,1,0)
See National Patch Module for detailed explanation of enhancements.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","GMRCA1")
0^1^B19560811
"RTN","GMRCA1",1,0)
GMRCA1 ;SLC/DLT,DCM - Actions taken from Review Screens ;6/29/98  23:50
"RTN","GMRCA1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10**;DEC 27, 1997
"RTN","GMRCA1",3,0)
DC(GMRCO,GMRCA) ;Discontinue/Cancel(Deny) logic
"RTN","GMRCA1",4,0)
 ;GMRCO = File 123 IEN of consult
"RTN","GMRCA1",5,0)
 ;GMRCA = Action to take: 6=DISCONTINUED, 19=CANCELLED
"RTN","GMRCA1",6,0)
 ;GMRCOM=comments array
"RTN","GMRCA1",7,0)
 I '$G(GMRCA) S GMRCMSG="This Action not defined!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCA1",8,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",9,0)
 D DC^GMRCADC(GMRCO,GMRCA)
"RTN","GMRCA1",10,0)
 D END
"RTN","GMRCA1",11,0)
 Q
"RTN","GMRCA1",12,0)
 ;
"RTN","GMRCA1",13,0)
COMMENT(GMRCO) ;Add a comment without changing the status
"RTN","GMRCA1",14,0)
 N GMRCA,GMRCLCK
"RTN","GMRCA1",15,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",16,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",17,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",18,0)
 I '$$LOCK(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",19,0)
 S GMRCLCK=1 ;JFR
"RTN","GMRCA1",20,0)
 D COMMENT^GMRCACMT(+GMRCO)
"RTN","GMRCA1",21,0)
 D END
"RTN","GMRCA1",22,0)
 Q
"RTN","GMRCA1",23,0)
 ;
"RTN","GMRCA1",24,0)
RC(GMRCO) ;Service tracking request has been received.
"RTN","GMRCA1",25,0)
 K GMRCQUT,GMRCQIT,GMRCSEL,GMRCAGN
"RTN","GMRCA1",26,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",27,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",28,0)
 I '$$LOCK(GMRCO) D END S GMRCQUT=1 Q  ;JFR
"RTN","GMRCA1",29,0)
 ;
"RTN","GMRCA1",30,0)
 N GMRCDA,GMRCIFN,GMRCLCK
"RTN","GMRCA1",31,0)
 S GMRCLCK=1 ;JFR
"RTN","GMRCA1",32,0)
 S GMRC(0)=^GMR(123,GMRCO,0)
"RTN","GMRCA1",33,0)
 S DFN=$P(GMRC(0),"^",2)
"RTN","GMRCA1",34,0)
 I $S($P(GMRC(0),"^",12)=2:1,$P(^(0),"^",12)=1:1,$P(^(0),"^",12)=13:1,1:0) D  S GMRCQUT=1 D END Q
"RTN","GMRCA1",35,0)
 .S GMRCMSG="This consult has already been "_$S($P(GMRC(0),"^",12)=2:"Completed",$P(^(0),"^",12)=13:"Cancelled",1:"Discontinued")_"."
"RTN","GMRCA1",36,0)
 .S GMRCMSG(1)=" No Receive action may be taken now."
"RTN","GMRCA1",37,0)
 .D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCA1",38,0)
 .K GMRCMSG
"RTN","GMRCA1",39,0)
 .Q
"RTN","GMRCA1",40,0)
 I $P(^GMR(123.5,$P(GMRC(0),"^",5),0),"^",2)=9 S GMRCMSG=$P(^(0),"^",1)_" is an INACTIVE service. No Receive action is possible",GMRCMSG(1)="for this consult on this Service!" D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCA1",41,0)
 I $P(GMRC(0),"^",12)'=5 S GMRCMSG="The receive action may only be taken when the consult has a pending status."  D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCA1",42,0)
 ;
"RTN","GMRCA1",43,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCA1",44,0)
 S GETPROV="Who received it?" D GETPROV^GMRCAU K GETPROV I $D(GMRCQIT) D END S GMRCQIT="Q",GMRCQUT=1 Q
"RTN","GMRCA1",45,0)
 S GETDT="Date/Time Actually Received" D GETDT^GMRCAU K GETDT I $D(GMRCQIT) W !!,$C(7),"Consult not updated with Received action.",!,"Press <ENTER> To Exit: " R X:DTIME D END S GMRCQUT=1 Q
"RTN","GMRCA1",46,0)
 ;The activity date is stored in GMRCAD
"RTN","GMRCA1",47,0)
 S GMRCA=21 ;for "Received"
"RTN","GMRCA1",48,0)
 I $P(GMRC(0),"^",12)=5 S GMRCSTS=6,$P(GMRC(0),"^",12)=GMRCSTS
"RTN","GMRCA1",49,0)
 E  S GMRCSTS=$P(GMRC(0),"^",12)
"RTN","GMRCA1",50,0)
 D STATUS^GMRCP
"RTN","GMRCA1",51,0)
 D AUDIT^GMRCP
"RTN","GMRCA1",52,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCWARD),"SC",GMRCORNP,$G(GMRCVSIT),.GMRCOM)
"RTN","GMRCA1",53,0)
 D END
"RTN","GMRCA1",54,0)
 Q
"RTN","GMRCA1",55,0)
 ;
"RTN","GMRCA1",56,0)
RT(GMRCO) ;Results Display logic
"RTN","GMRCA1",57,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",58,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",59,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",60,0)
 D RT^GMRCART(GMRCO)
"RTN","GMRCA1",61,0)
 D END
"RTN","GMRCA1",62,0)
 Q
"RTN","GMRCA1",63,0)
 ;
"RTN","GMRCA1",64,0)
PS(GMRCO) ;Print Service Copy (CPRS entry point)
"RTN","GMRCA1",65,0)
 K GMRCQUT,GMRCQIT,GMRCSEL
"RTN","GMRCA1",66,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",67,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",68,0)
 S GMRC(0)=^GMR(123,GMRCO,0)
"RTN","GMRCA1",69,0)
 D EN^GMRCP5(GMRCO)
"RTN","GMRCA1",70,0)
 D END
"RTN","GMRCA1",71,0)
 Q
"RTN","GMRCA1",72,0)
 ;
"RTN","GMRCA1",73,0)
END ;kill off variables and exit
"RTN","GMRCA1",74,0)
 I $G(GMRCLCK) D UNLOCK(GMRCO) ;JFR
"RTN","GMRCA1",75,0)
 I '$D(GMRC("NMBR")) K GMRCSEL,GMRCO
"RTN","GMRCA1",76,0)
 K GMRC(0),GMRCA,GMRCACTM,GMRCAGN,GMRCDFN,GMRCENTR,GMRCFL,GMRCIEN,GMRCMSG,GMRCOM,GMRCO,GMRCORFN,GMRCORN,GMRCORTX,GMRCRTFL,GMRCSEL,GMRCSTS,GMRCTRLC,GMRCEND,GMRCSA,GMRCSR,GMRCBM,GMRCTM,GMRCADUZ,ORIFN,OREND,SF,STS
"RTN","GMRCA1",77,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCA1",78,0)
 K DTOUT,DIROUT,DUOUT
"RTN","GMRCA1",79,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCA1",80,0)
 Q
"RTN","GMRCA1",81,0)
LOCK(GMRCIFN) ;;lock a consult record using OE/RR order number ;JFR
"RTN","GMRCA1",82,0)
 N GMRCORD,GMRCLOCK
"RTN","GMRCA1",83,0)
 S GMRCORD=$P($G(^GMR(123,GMRCIFN,0)),U,3) Q:'GMRCORD 1
"RTN","GMRCA1",84,0)
 S GMRCLOCK=$$LOCK1^ORX2(GMRCORD) I +GMRCLOCK Q 1
"RTN","GMRCA1",85,0)
 ;Q:$G(GMRCGUI) ;JFR
"RTN","GMRCA1",86,0)
 D EXAC^GMRCADC($P(GMRCLOCK,U,2))
"RTN","GMRCA1",87,0)
 Q 0
"RTN","GMRCA1",88,0)
UNLOCK(GMRCIFN) ;unlock a consult record using OE/RR order number ;JFR
"RTN","GMRCA1",89,0)
 N GMRCORD
"RTN","GMRCA1",90,0)
 S GMRCORD=$P($G(^GMR(123,GMRCIFN,0)),U,3) Q:'GMRCORD
"RTN","GMRCA1",91,0)
 D UNLK1^ORX2(GMRCORD)
"RTN","GMRCA1",92,0)
 Q
"RTN","GMRCADC")
0^2^B10025159
"RTN","GMRCADC",1,0)
GMRCADC ;SLC/DLT/DCM - Discontinue Action taken from List Manager ;6/17/98  10:22
"RTN","GMRCADC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,10**;DEC 27, 1997
"RTN","GMRCADC",3,0)
EXAC(MSG) ;Exit message asking for user to press <ENTER>; EXAC=Exit Action
"RTN","GMRCADC",4,0)
 N ND
"RTN","GMRCADC",5,0)
 W $C(7),!,MSG I $O(MSG(0)) S ND=0 F  S ND=$O(MSG(ND)) Q:ND=""  W !,MSG(ND)
"RTN","GMRCADC",6,0)
 W !,"Press <RETURN> to continue: " R X:DTIME W !!
"RTN","GMRCADC",7,0)
 Q
"RTN","GMRCADC",8,0)
DC(GMRCO,GMRCA) ;Discontinue a consult logic from DC^GMRCA1
"RTN","GMRCADC",9,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCADC",10,0)
 N GMRCDA,GMRCACTM,GMRCADUZ,GMRCSERV
"RTN","GMRCADC",11,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCADC",12,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) Q
"RTN","GMRCADC",13,0)
 I '+$G(GMRCO) S GMRCQUT=1 Q
"RTN","GMRCADC",14,0)
 I '$$LOCK^GMRCA1(GMRCO) S GMRCQUT=1 Q  ;JFR
"RTN","GMRCADC",15,0)
 ;
"RTN","GMRCADC",16,0)
 S GMRC(0)=^GMR(123,GMRCO,0),GMRCDA=GMRCO
"RTN","GMRCADC",17,0)
 S (GMRCDFN,DFN)=$P(GMRC(0),"^",2)
"RTN","GMRCADC",18,0)
 I $D(GMRCA),+GMRCA S GMRCACTM=$S(GMRCA=6:"Discontinued",GMRCA=19:"Cancelled",1:$P($G(GMR(123.1,+GMRCA,0)),"^",1))
"RTN","GMRCADC",19,0)
 ;
"RTN","GMRCADC",20,0)
 D PROC I $D(GMRCQUT) D UNLOCK^GMRCA1(GMRCO) S GMRCQUT=1 Q  ;JFR
"RTN","GMRCADC",21,0)
 ;send 513 back to service printer if request DC'd or Cancelled
"RTN","GMRCADC",22,0)
 I GMRCA=6,+$P(GMRC(0),U,5) D PRNT^GMRCUTL1(+$P(GMRC(0),U,5),+GMRCO)
"RTN","GMRCADC",23,0)
 S GMRCTRLC=$S(GMRCA=19:"OC",1:"OD")
"RTN","GMRCADC",24,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),GMRCTRLC,GMRCORNP,$G(GMRCVSIT),.GMRCOM)
"RTN","GMRCADC",25,0)
 D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCADC",26,0)
 Q
"RTN","GMRCADC",27,0)
 ;
"RTN","GMRCADC",28,0)
PROC ;Check validity of action and if valid process the discontinue action
"RTN","GMRCADC",29,0)
 I $P(GMRC(0),"^",12)=1 S GMRCMSG="This consult has already been discontinued!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",30,0)
 I $P(GMRC(0),"^",12)=2 S GMRCMSG="This consult has already been completed!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",31,0)
 I $P(GMRC(0),"^",12)=9 S GMRCMSG="Action invalid. This consult has partial results!",GMRCMSG(1)="Remove the associated results and then discontinue." D EXAC(.GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",32,0)
 I $P(GMRC(0),"^",12)=13 S GMRCMSG="This consult has already been cancelled!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",33,0)
 ;
"RTN","GMRCADC",34,0)
 S GMRCORVP=GMRCDFN_";DPT("
"RTN","GMRCADC",35,0)
 N GETPROV D GETPROV^GMRCAU I $D(DIROUT)!$D(DTOUT)!$D(DUOUT) S GMRCQUT=1 Q
"RTN","GMRCADC",36,0)
 N GETDT D GETDT^GMRCAU I $D(DIROUT)!$D(DTOUT)!$D(DUOUT) S GMRCQUT=1 Q  ;Returns GMRCAD as the entered date.
"RTN","GMRCADC",37,0)
 S GMRCSTS=$S(GMRCA=6:1,1:13),$P(GMRC(0),"^",12)=GMRCSTS
"RTN","GMRCADC",38,0)
 S GMRCOM=1
"RTN","GMRCADC",39,0)
 D STATUS^GMRCP
"RTN","GMRCADC",40,0)
 D AUDIT^GMRCP
"RTN","GMRCADC",41,0)
 ;
"RTN","GMRCADC",42,0)
 S GMRCORTX=$S($L($G(GMRCACTM)):GMRCACTM,+GMRCA:$P(^GMR(123.1,GMRCA,0),U,1),1:"ACTION UNKNOWN FOR")_" consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCADC",43,0)
 S GMRCADUZ="",GMRCFL=0
"RTN","GMRCADC",44,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14),+$P(^(0),"^",14)'=DUZ S GMRCADUZ($P(^(0),"^",14))=""
"RTN","GMRCADC",45,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14)=DUZ S GMRCFL=1
"RTN","GMRCADC",46,0)
 ;send notification info to routine to be sent to OERR
"RTN","GMRCADC",47,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(GMRCA=6:23,1:30),.GMRCADUZ,GMRCFL)
"RTN","GMRCADC",48,0)
 Q
"RTN","GMRCAFRD")
0^5^B31061058
"RTN","GMRCAFRD",1,0)
GMRCAFRD ;SLC/DLT,DCM - Forward Req (FR) Action from Review Screen ;7/16/98  01:48
"RTN","GMRCAFRD",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10**;DEC 27, 1997
"RTN","GMRCAFRD",3,0)
FR(GMRCO) ;Forward Request to a new service
"RTN","GMRCAFRD",4,0)
 N ORVP,GMRCLCK
"RTN","GMRCAFRD",5,0)
 W !!,"Forward Request To Another Service For Action."
"RTN","GMRCAFRD",6,0)
 W !,"Select the service to send the consult to.",!
"RTN","GMRCAFRD",7,0)
 S:$D(GMRCSS) GMRCSSS=GMRCSS
"RTN","GMRCAFRD",8,0)
 N GMRCPL,GMRCPR,GMRCURG,GMRCDG,GMRCFF,GMRCORNP,GMRCAD,GMRCTO,GMRCADUZ
"RTN","GMRCAFRD",9,0)
 K GMRCQUT,GMRCSEL
"RTN","GMRCAFRD",10,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCAFRD",11,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",12,0)
 I '$$LOCK^GMRCA1(GMRCO) D END S GMRCQUT=1 Q  ;JFR
"RTN","GMRCAFRD",13,0)
 S GMRCLCK=1
"RTN","GMRCAFRD",14,0)
 ;
"RTN","GMRCAFRD",15,0)
 I $P(^GMR(123,GMRCO,0),"^",12)<3 S GMRCMSG="NO ACTION POSSIBLE. This Consult Has Already Been Completed Or Discontinued." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",16,0)
 I $P(^GMR(123,GMRCO,0),"^",12)=13 S GMRCMSG="NO ACTION POSSIBLE. This Consult Has Already Been Cancelled." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",17,0)
 I $P(^GMR(123,GMRCO,0),"^",12)=9 D  Q:+$G(GMRCQUT)
"RTN","GMRCAFRD",18,0)
 .S GMRCMSG="Invalid action. This consult has partial results."
"RTN","GMRCAFRD",19,0)
 .S GMRCMSG(1)="Remove the associated results before forwarding."
"RTN","GMRCAFRD",20,0)
 .D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",21,0)
 ;
"RTN","GMRCAFRD",22,0)
 I $D(IOBM),$D(IOTM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCAFRD",23,0)
 I $P(^GMR(123,GMRCO,0),"^",16) W !!,"This is a SERVICE ENTERED order stub.  Please send the written consult to the",!,"Service, in addition to the automated forwarding!"
"RTN","GMRCAFRD",24,0)
 S DFN=+$P(^GMR(123,GMRCO,0),"^",2)
"RTN","GMRCAFRD",25,0)
 S GMRCTO=1,GMRCASV="Forward Consult To Which Service/Specialty: "
"RTN","GMRCAFRD",26,0)
 D ASRV^GMRCASV K GMRCASV I $S($D(DTOUT):1,$D(DIROUT):1,$D(GMRCQUT):1,1:0) D END Q
"RTN","GMRCAFRD",27,0)
 I 'GMRCDG S GMRCMSG="No Service Was Selected. Consult Was Not Forwarded To Any Service!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",28,0)
 S GMRCFF=$P(^GMR(123,GMRCO,0),"^",5) I GMRCFF=+GMRCDG S GMRCMSG="The Forwarding Service Cannot Forward A Consult To Itself!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",29,0)
 S GETPROV="Who is responsible for Forwarding the Consult?"
"RTN","GMRCAFRD",30,0)
 D GETPROV^GMRCAU I '$D(GMRCORNP) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",31,0)
 N GMRCSS,GMRCSSNM,GMRCA,GMRCMSG
"RTN","GMRCAFRD",32,0)
 D DEFAULT
"RTN","GMRCAFRD",33,0)
 S GMRCSS=+GMRCDG
"RTN","GMRCAFRD",34,0)
 I +GMRCSS,'$D(^GMR(123.5,+GMRCSS,0)) S GMRCMSG="Error in Service Chosen - SERVICE Does Not Exist!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",35,0)
 S GMRCSSNM=$S($L($G(^GMR(123.5,+GMRCSS,.1))):^(.1),1:$P($G(^GMR(123.5,+GMRCSS,0)),U,1))
"RTN","GMRCAFRD",36,0)
 D URG I $D(GMRCEND),GMRCEND D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",37,0)
 S GMRCA=17,DIE="^GMR(123,",DA=GMRCO,ORSTS=5
"RTN","GMRCAFRD",38,0)
 S DR="1////^S X=GMRCSS;5////^S X=GMRCURGI;8////^S X=ORSTS;9////^S X=GMRCA;.1///@"
"RTN","GMRCAFRD",39,0)
 L +^GMR(123,GMRCO):2 I '$T K DIE,DA,DR S GMRCMSG="Another User Is Accessing This Record. UPDATE WAS UNSUCCESSFUL.",GMRCMSG(1)="Try Again Later." D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",40,0)
 D ^DIE L -^GMR(123,GMRCO) K DIE,DA,DR
"RTN","GMRCAFRD",41,0)
 S GMRCOM=1 D AUDIT^GMRCP ;GMRCORNP is the responsible provider here
"RTN","GMRCAFRD",42,0)
 ;
"RTN","GMRCAFRD",43,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;unlk before FWD changes order #
"RTN","GMRCAFRD",44,0)
 ;
"RTN","GMRCAFRD",45,0)
FRMSG ; Common logic used by GUI and List Manager to process the HL7 message
"RTN","GMRCAFRD",46,0)
 ; to update the order in OE/RR and then forward an alert to recipients
"RTN","GMRCAFRD",47,0)
 ; is passed in as the DUZ instead of the responsible provider
"RTN","GMRCAFRD",48,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),"XX",$G(DUZ),$G(VISIT),.GMRCOM)
"RTN","GMRCAFRD",49,0)
 S GMRCADUZ=""
"RTN","GMRCAFRD",50,0)
 S GMRCORNP=$P(^GMR(123,GMRCO,0),"^",14) ;This is the original provider that ordered the consult
"RTN","GMRCAFRD",51,0)
 I +$G(GMRCORNP) S GMRCADUZ(+GMRCORNP)="" ;alert original provider of forward
"RTN","GMRCAFRD",52,0)
 S GMRCORTX="Forwarded consult "_$$ORTX^GMRCAU(+GMRCO)_" ("_GMRCURG_")"
"RTN","GMRCAFRD",53,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,27,.GMRCADUZ,1) ;GMRCO=IEN of consult from file 123; 27 is notification entry from file ORD(100.9
"RTN","GMRCAFRD",54,0)
 K GMRCOM
"RTN","GMRCAFRD",55,0)
 S GMRCDEV=$P($G(^GMR(123.5,GMRCSS,123)),"^",9)
"RTN","GMRCAFRD",56,0)
 I GMRCDEV D PRNT^GMRCUTL1(GMRCSS,+GMRCO)
"RTN","GMRCAFRD",57,0)
 D END
"RTN","GMRCAFRD",58,0)
 Q
"RTN","GMRCAFRD",59,0)
URG ;Get the default urgency
"RTN","GMRCAFRD",60,0)
 N X,Y,XQORM,DIROUT,DTOUT,DIRUT,DUOUT
"RTN","GMRCAFRD",61,0)
 I $P(^GMR(123,+GMRCO,0),"^",18)["I" D
"RTN","GMRCAFRD",62,0)
 .I GMRCTYPE="GMRCOR CONSULT" S X="GMRCURGENCYM CSLT - INPATIENT"
"RTN","GMRCAFRD",63,0)
 .S X="GMRCURGENCYM REQ - INPATIENT"
"RTN","GMRCAFRD",64,0)
 E  S X="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCAFRD",65,0)
 I '$D(GMRCURG) S GMRCURGI=$O(^ORD(101,"B","GMRCURGENCY - ROUTINE","")) S:+GMRCURGI GMRCURG=$P($G(^ORD(101,+GMRCURGI,0)),"^",2)
"RTN","GMRCAFRD",66,0)
 S Y=$O(^ORD(101,"B",X,""))
"RTN","GMRCAFRD",67,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: ",XQORM("NO^^")=""
"RTN","GMRCAFRD",68,0)
 S:$L(GMRCURG) XQORM("B")=GMRCURG D EN^XQORM I X="^"!($D(DIROUT)) K XQORM S GMRCEND=1 Q
"RTN","GMRCAFRD",69,0)
 K XQORM(0),XQORM("A"),XQORM("B"),XQORM("NO^^") S XQORM=""
"RTN","GMRCAFRD",70,0)
 I '$D(Y) S GMRCEND=1 Q
"RTN","GMRCAFRD",71,0)
 I $D(Y(1)) S GMRCURG=$P(Y(1),"^",3),GMRCURGI=$P(Y(1),"^",2)
"RTN","GMRCAFRD",72,0)
 Q
"RTN","GMRCAFRD",73,0)
DEFAULT ;Set up defaults for editing to be equal to the existing data.
"RTN","GMRCAFRD",74,0)
 D DEM^GMRCU
"RTN","GMRCAFRD",75,0)
 N GMRC,GMRCDIC,GMRCPLI,GMRCPRI
"RTN","GMRCAFRD",76,0)
 Q:'$D(GMRCO)  S (GMRCSS,GMRCSSNM,GMRCPL,GMRCPR,GMRCPRI,GMRCURG)=""
"RTN","GMRCAFRD",77,0)
 S GMRCOM=0,GMRC(0)=$S($D(^GMR(123,+GMRCO,0)):^(0),1:"")
"RTN","GMRCAFRD",78,0)
 S GMRCSS=$P(GMRC(0),"^",5) I +GMRCSS,$D(^GMR(123.5,+GMRCSS,0)) S GMRCSSNM=$S($L($P($G(^GMR(123.5,+GMRCSS,0)),U,1)):$P(^(0),U,1),1:"")
"RTN","GMRCAFRD",79,0)
 S GMRCPLI=$P(GMRC(0),"^",10) I GMRCPLI S GMRCPL=$P($G(^ORD(101,GMRCPLI,0)),"^",2)
"RTN","GMRCAFRD",80,0)
 S GMRCURGI=$P(GMRC(0),"^",9) I GMRCURGI S GMRCURG=$P($G(^ORD(101,GMRCURGI,0)),"^",2)
"RTN","GMRCAFRD",81,0)
 S GMRCPRI=$P(GMRC(0),"^",8),GMRCDIC=$P(GMRCPRI,";",2) I $L(GMRCDIC) S GMRCDIC="^"_GMRCDIC_$P(GMRCPRI,";")_",0)",GMRCPR=$S($D(@(GMRCDIC)):$P(^(0),"^",2),1:"")
"RTN","GMRCAFRD",82,0)
TYPE ;This entry point is used when the only default needed is the GMRCTYPE
"RTN","GMRCAFRD",83,0)
 ;Called by GMRCGUIA to get variables ready for FRMSG call.
"RTN","GMRCAFRD",84,0)
 S GMRCTYPE=$P($G(^GMR(123,+GMRCO,0)),"^",17),GMRCTYPE=$S('GMRCTYPE:"GMRCOR CONSULT",1:$P($G(^ORD(101,GMRCTYPE,0)),"^"))
"RTN","GMRCAFRD",85,0)
 Q
"RTN","GMRCAFRD",86,0)
END ;Kill off variables and exit
"RTN","GMRCAFRD",87,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCAFRD",88,0)
 K GETPROV,GMRCDG,GMRCDEV,GMRCEND,GMRCFF,GMRCOM,GMRCIFN,GMRCO,GMRCORNP
"RTN","GMRCAFRD",89,0)
 K GMRCTYPE,GMRCORTX,GMRCPL,GMRCPR,GMRCSEL,GMRCURG,GMRCADUZ,Y
"RTN","GMRCAFRD",90,0)
 K DTOUT,DIROUT,DUOUT
"RTN","GMRCAFRD",91,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCAFRD",92,0)
 Q
"RTN","GMRCASF")
0^3^B11916526
"RTN","GMRCASF",1,0)
GMRCASF ;SLC/DLT - Significant Findings Action ;9/8/98  03:40
"RTN","GMRCASF",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10**;DEC 27, 1997
"RTN","GMRCASF",3,0)
SF(GMRCO) ;Evaluate Significant Findings and update accordingly
"RTN","GMRCASF",4,0)
 ;GMRCO is the selected consult
"RTN","GMRCASF",5,0)
 N GMRCQIT,GMRCLCK
"RTN","GMRCASF",6,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)  I $D(GMRCQUT) D END Q
"RTN","GMRCASF",7,0)
 I '+($G(GMRCO)) D END Q
"RTN","GMRCASF",8,0)
 I '$$LOCK^GMRCA1(GMRCO) D END Q  ;JFR
"RTN","GMRCASF",9,0)
 S GMRCLCK=1
"RTN","GMRCASF",10,0)
 ;
"RTN","GMRCASF",11,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCASF",12,0)
 N GMRC,GMRCSTS,GMRCSF,GMRCSFO,GMRCORTX,GMRCDR
"RTN","GMRCASF",13,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:GMRC(0)=""
"RTN","GMRCASF",14,0)
 ;
"RTN","GMRCASF",15,0)
 S GMRCSFO=$P(GMRC(0),"^",19)
"RTN","GMRCASF",16,0)
 W !!,"Current Significant Findings = "_$S(GMRCSFO="U":"Unknown",GMRCSFO="Y":"Yes",GMRCSFO="N":"No",1:"not entered yet"),!!
"RTN","GMRCASF",17,0)
 S GMRCSF=$$GETSIGF(GMRCSFO)
"RTN","GMRCASF",18,0)
 I GMRCSF=0 D END Q
"RTN","GMRCASF",19,0)
 ; If no change in old and new value ask if should continue
"RTN","GMRCASF",20,0)
 I GMRCSF=GMRCSFO D  I 'Y D END Q
"RTN","GMRCASF",21,0)
 . W !,"The old and new Significant Findings are the same."
"RTN","GMRCASF",22,0)
 . N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",23,0)
 . S DIR("A")="Do you want to proceed with this action"
"RTN","GMRCASF",24,0)
 . S DIR(0)="Y"
"RTN","GMRCASF",25,0)
 . S DIR("B")="NO"
"RTN","GMRCASF",26,0)
 . D ^DIR
"RTN","GMRCASF",27,0)
 . I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) S Y=0 Q
"RTN","GMRCASF",28,0)
 . I Y=0 Q
"RTN","GMRCASF",29,0)
 ;
"RTN","GMRCASF",30,0)
 ;Update last action and sig findings but don't change the status
"RTN","GMRCASF",31,0)
 S GMRCSTS=$P(GMRC(0),"^",12),GMRCA=4
"RTN","GMRCASF",32,0)
 S GMRCDR="8////^S X=GMRCSTS;9////^S X=GMRCA;15////^S X=GMRCSF"
"RTN","GMRCASF",33,0)
 D STATUS^GMRCP
"RTN","GMRCASF",34,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",35,0)
 ;
"RTN","GMRCASF",36,0)
 S GMRCOM=1 D AUDIT^GMRCP
"RTN","GMRCASF",37,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",38,0)
 ;
"RTN","GMRCASF",39,0)
 ;GMRCOM=1 tells AUDIT^GMRCP to do the word-processing logic
"RTN","GMRCASF",40,0)
 ;If an actual comment is added, $P(GMRCOM,"^",2)=1 (send alert),
"RTN","GMRCASF",41,0)
 ; if not GMRCOM=1 and no '^' exists (do not send alert)
"RTN","GMRCASF",42,0)
 D SETORTX
"RTN","GMRCASF",43,0)
 I GMRCSTS=2 D SENDALRT(GMRCORTX) Q
"RTN","GMRCASF",44,0)
 I +$P(GMRCOM,"^",2) D
"RTN","GMRCASF",45,0)
 . W !,"An alert with the following text will be sent if recipients are selected: "
"RTN","GMRCASF",46,0)
 . W !,"     "_GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCASF",47,0)
 . W !
"RTN","GMRCASF",48,0)
 . I GMRCSTS'=2 W !,"or the alert will be sent when the order is completed.",!
"RTN","GMRCASF",49,0)
 . D PROCALRT^GMRCACMT(GMRCORTX,1,4)
"RTN","GMRCASF",50,0)
 . ;For consults not completed, the original provider may be deleted from
"RTN","GMRCASF",51,0)
 . ;the recipient list for the alert.
"RTN","GMRCASF",52,0)
 D END
"RTN","GMRCASF",53,0)
 Q
"RTN","GMRCASF",54,0)
 ;
"RTN","GMRCASF",55,0)
SETORTX ;Set prefix text for the alert
"RTN","GMRCASF",56,0)
 S GMRCORTX=$S(GMRCSF="N":"No ",GMRCSF="Y":"",1:"Unknown ")
"RTN","GMRCASF",57,0)
 S GMRCORTX=GMRCORTX_"Sig Findings for "_$P($G(^ORD(100.01,+GMRCSTS,0)),"^",2)_" consult " Q
"RTN","GMRCASF",58,0)
 Q
"RTN","GMRCASF",59,0)
 ;
"RTN","GMRCASF",60,0)
SENDALRT(GMRCORTX) ;Send to the requesting provider
"RTN","GMRCASF",61,0)
 N GMRCRP,GMRCADUZ,GMRCDELR
"RTN","GMRCASF",62,0)
 S GMRCRP=$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting clinician
"RTN","GMRCASF",63,0)
 I +GMRCRP S GMRCADUZ(+GMRCRP)=""
"RTN","GMRCASF",64,0)
 W !,"Alert will be sent to Requesting Provider: "_$P($G(^VA(200,+GMRCRP,0)),U,1)
"RTN","GMRCASF",65,0)
 S GMRCDELR=0
"RTN","GMRCASF",66,0)
 D ANDTO^GMRCACMT
"RTN","GMRCASF",67,0)
 D SENDMSG^GMRCACMT(23,+GMRCO)
"RTN","GMRCASF",68,0)
 ;Sig Findings uses the CONSULT/REQUEST RESOLUTION (23) notification
"RTN","GMRCASF",69,0)
 Q
"RTN","GMRCASF",70,0)
 ;
"RTN","GMRCASF",71,0)
GETSIGF(GMRCSFO) ;Get the significant findings
"RTN","GMRCASF",72,0)
 ;GMRCSFO is the old significant findings value
"RTN","GMRCASF",73,0)
 N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",74,0)
 S DIR(0)="123,15"
"RTN","GMRCASF",75,0)
 S DIR("B")=GMRCSFO
"RTN","GMRCASF",76,0)
 S:DIR("B")="" DIR("B")="unknown"
"RTN","GMRCASF",77,0)
 S DIR("A")="Are there significant findings? (Y/N/U)"
"RTN","GMRCASF",78,0)
 D ^DIR
"RTN","GMRCASF",79,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q 0
"RTN","GMRCASF",80,0)
 Q Y
"RTN","GMRCASF",81,0)
 ;
"RTN","GMRCASF",82,0)
END ;cleanup variables
"RTN","GMRCASF",83,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCASF",84,0)
 K GMRCO,GMRCA,GMRCMSG,GMRCOM,GMRCSEL,GMRCERR,GMRCERMS
"RTN","GMRCASF",85,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCASF",86,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCASF",87,0)
 Q
"RTN","GMRCEDIT")
0^4^B10551219
"RTN","GMRCEDIT",1,0)
GMRCEDIT ;SLC/DCM,JFR - EDIT CANCELLED CONSULT-MAIN DRIVER ;1/3/99 22:10
"RTN","GMRCEDIT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,10**;DEC 27, 1997
"RTN","GMRCEDIT",3,0)
EN(XQCON,XQDFN) ; -- main entry point for GMRCEDIT
"RTN","GMRCEDIT",4,0)
 ;XQDFN=XQAID   XQCON=XQADATA from CPRS alerts
"RTN","GMRCEDIT",5,0)
 N GMRCNOTF,GMRCCORY,GMRCDA
"RTN","GMRCEDIT",6,0)
 S DFN=$P(XQDFN,",",2),GMRCDA=$S(XQCON=+XQCON:+XQCON,+$P($P(XQCON,",",2),";",2):+$P($P(XQCON,",",2),";",2),XQCON?1N.N1",GMRC".E:+XQCON,1:$P($P(XQCON,";",3),",",1))
"RTN","GMRCEDIT",7,0)
 S GMRCNOTF=+$P(XQDFN,",",3)
"RTN","GMRCEDIT",8,0)
 I '+GMRCDA S XQAKILL=$$XQAKILL^ORB3F1(GMRCNOTF) D DEL^ORB3FUP1(.GMRCCORY,XQDFN),END Q
"RTN","GMRCEDIT",9,0)
 S GMRCDAP=GMRCDA
"RTN","GMRCEDIT",10,0)
 I '$$LOCK^GMRCA1(+GMRCDAP) D END Q
"RTN","GMRCEDIT",11,0)
 N GMRCLCK S GMRCLCK=1 ;JFR
"RTN","GMRCEDIT",12,0)
 ;S GMRCDAP=GMRCDA I +$P(^GMR(123,+GMRCDA,0),"^",5)
"RTN","GMRCEDIT",13,0)
 S GMRCOK=$P(^ORD(100.01,$P(^GMR(123,+GMRCDA,0),"^",12),0),"^",1),GMRCOK=$S(GMRCOK["CANCELLED":1,1:0)
"RTN","GMRCEDIT",14,0)
 I '$D(GMRCOK) S XQAKILL=$$XQAKILL^ORB3F1(GMRCNOTF) D DEL^ORB3FUP1(.GMRCCORY,XQDFN),END Q
"RTN","GMRCEDIT",15,0)
 S GMRCPNM=$P(^DPT(DFN,0),"^",1),GMRCPROV=$P(^GMR(123,GMRCDA,0),"^",14) I +GMRCPROV S GMRCPROV=$P(^VA(200,GMRCPROV,0),"^",1)
"RTN","GMRCEDIT",16,0)
 D EN^VALM("GMRC EDIT CONSULT")  ;********* CALL TO LIST MANAGER
"RTN","GMRCEDIT",17,0)
 I $S($O(GMRCED(0)):1,$D(^TMP("GMRCED",$J)):1,1:0),'$D(GMRCRSUB) D
"RTN","GMRCEDIT",18,0)
 . N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRCEDIT",19,0)
 . W !,$C(7),"This Consult Has Not Been Resubmitted!!"
"RTN","GMRCEDIT",20,0)
 . W !,"Resubmit Or All Edits Will Be Lost!!",!!
"RTN","GMRCEDIT",21,0)
 . S DIR(0)="Y",DIR("A")="Do you wish to resubmit now? ",DIR("B")="YES"
"RTN","GMRCEDIT",22,0)
 . D ^DIR I $D(DUOUT)!($D(DTOUT))!(Y<1) W !!,"No changes made!" Q
"RTN","GMRCEDIT",23,0)
 . D EN^GMRCEDT2(GMRCDAP)
"RTN","GMRCEDIT",24,0)
 . Q
"RTN","GMRCEDIT",25,0)
 S XQAKILL=$$XQAKILL^ORB3F1(GMRCNOTF) D DEL^ORB3FUP1(.GMRCCORY,XQDFN)
"RTN","GMRCEDIT",26,0)
 D END
"RTN","GMRCEDIT",27,0)
 Q
"RTN","GMRCEDIT",28,0)
 ;
"RTN","GMRCEDIT",29,0)
HDR ; -- header code
"RTN","GMRCEDIT",30,0)
 S VALMHDR(1)="Edit Consult for Patient "_GMRCPNM_"  Consult Number: "_GMRCDA
"RTN","GMRCEDIT",31,0)
 S VALMHDR(2)="Sending Provider: "_GMRCPROV
"RTN","GMRCEDIT",32,0)
 Q
"RTN","GMRCEDIT",33,0)
 ;
"RTN","GMRCEDIT",34,0)
INIT ; -- init variables and list array
"RTN","GMRCEDIT",35,0)
 K ^TMP("GMRCR",$J,"EDLIST")
"RTN","GMRCEDIT",36,0)
 S DSPLINE=0,DATA="",VALMAR="^TMP(""GMRCR"",$J,""EDLIST"")"
"RTN","GMRCEDIT",37,0)
 F LINE=1:1:GMRCLNO S DSPLINE=$O(^TMP("GMRCR",$J,"ED",DSPLINE)) Q:DSPLINE=""!(DSPLINE?1A.E)  S DATA=^(DSPLINE,0) D SET^VALM10(LINE,DATA)
"RTN","GMRCEDIT",38,0)
 S VALMCNT=GMRCLNO,VALMPGE=1,XQORM("A")="Select Action: "
"RTN","GMRCEDIT",39,0)
 K DSPLINE,DATA,LINE
"RTN","GMRCEDIT",40,0)
 Q
"RTN","GMRCEDIT",41,0)
 ;
"RTN","GMRCEDIT",42,0)
HELP ; -- help code
"RTN","GMRCEDIT",43,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCEDIT",44,0)
 Q
"RTN","GMRCEDIT",45,0)
 ;
"RTN","GMRCEDIT",46,0)
EXIT ;
"RTN","GMRCEDIT",47,0)
 ;Don't kill anything here
"RTN","GMRCEDIT",48,0)
 Q
"RTN","GMRCEDIT",49,0)
END ; -- exit code
"RTN","GMRCEDIT",50,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(+GMRCDAP) ;JFR
"RTN","GMRCEDIT",51,0)
 K ^TMP("GMRCR",$J,"EDLIST"),^TMP("GMRCR",$J,"ED")
"RTN","GMRCEDIT",52,0)
 K ^TMP("GMRCED",$J),^TMP("GMRCSUB",$J),^TMP("GMRCFLD20",$J)
"RTN","GMRCEDIT",53,0)
 K CMDA,DFN,DIC,DIE,DR,DA,FLDA,FLDNM,GMRCA,GMRCATN,GMRCD,GMRCDD,GMRCANS,GMRCDIAG,GMRCED,GMRCEDCM,GMRCIND,GMRCINO,GMRCKEEP,GMRCLNO,GMRCND,GMRCND1,GMRCO,GMRCOK,GMRCPC,GMRCPL,GMRCPR,GMRCPNM,GMRCPROC,GMRCPROV,GMRCREQ,GMRCRQT
"RTN","GMRCEDIT",54,0)
 K GMRCFLD,GMRCOUNT,GMRCRSUB,GMRCSS,GMRCURG,GMRCDA,GMRCDAP,GMRCDA1,ND,TRKDA,XQAKILL
"RTN","GMRCEDIT",55,0)
 Q
"RTN","GMRCEDIT",56,0)
 ;
"RTN","GMRCEDIT",57,0)
EXPND ; -- expand code
"RTN","GMRCEDIT",58,0)
 Q
"RTN","GMRCEDIT",59,0)
 ;
"RTN","GMRCSLM1")
0^7^B44345674
"RTN","GMRCSLM1",1,0)
GMRCSLM1 ;SLC/DCM - Gather data and format ^TMP global for consult tracking Silent call for use by List Manager and GUI ;9/8/98  03:37
"RTN","GMRCSLM1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10**;DEC 27, 1997
"RTN","GMRCSLM1",3,0)
 ;USING LIST MANAGER.
"RTN","GMRCSLM1",4,0)
 G AD
"RTN","GMRCSLM1",5,0)
SVC(NODE) ;Check for a valid service
"RTN","GMRCSLM1",6,0)
 K GMRCDEAV
"RTN","GMRCSLM1",7,0)
 I '$D(^GMR(123,NODE,0)) Q 0
"RTN","GMRCSLM1",8,0)
 I '+$P(^GMR(123,NODE,0),"^",5) Q 0
"RTN","GMRCSLM1",9,0)
 I '$D(^TMP("GMRCS",$J,$P(^GMR(123,NODE,0),"^",5))) Q 0
"RTN","GMRCSLM1",10,0)
 Q 1
"RTN","GMRCSLM1",11,0)
AD ;Main entry point. Loop through AD x-ref in file 123; Find consults that have been released to requested service
"RTN","GMRCSLM1",12,0)
 ;;DFN and GMRCSSNM must be defined when this entry point is called
"RTN","GMRCSLM1",13,0)
 ;;DFN=Internal File Number of Patient in ^DPT
"RTN","GMRCSLM1",14,0)
 ;;GMRCSSNM=Service Name of a Hospital Service from file ^GMR(123.5
"RTN","GMRCSLM1",15,0)
 ;;If GMRCSSNM is not defined or is null, then no records will be found.
"RTN","GMRCSLM1",16,0)
 ;;GMRCOER must be passed so that proper formatting for GUI or List Manager can be performed.  GMRCOER is passed as 0 for List Manager, 1 for GUI.
"RTN","GMRCSLM1",17,0)
 ;;GMRCDT1 and GMRCDT2 are passed in as start and stop dates for the lookup. If GMRCDT1="" or GMRCDT1="ALL", then all dates are searched.
"RTN","GMRCSLM1",18,0)
 ;;  ***********************************************************
"RTN","GMRCSLM1",19,0)
 K ^TMP("GMRCR",$J,"CS"),GMRCNUL
"RTN","GMRCSLM1",20,0)
 I $D(GMRCSSS) S (GMRCDG,GMRCSS)=GMRCSSS,GMRCSSNM=($P($G(^GMR(123.5,+GMRCSS,0)),"^",1)) D SERV1^GMRCASV K GMRCSSS ;reset after forward
"RTN","GMRCSLM1",21,0)
 S TAB="",$P(TAB," ",41)="",BLK=0,LNCT=1 S:'$D(GMRCOER) GMRCOER=0
"RTN","GMRCSLM1",22,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,"AD",DFN,GMRCD)) Q:'GMRCD  S GMRCDA=0 F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCD,GMRCDA)) Q:'GMRCDA  I $$SVC(GMRCDA) D SET
"RTN","GMRCSLM1",23,0)
 D END Q
"RTN","GMRCSLM1",24,0)
SET ;;Format entries into a word processing 'TMP("GMRCR",$J,"CS",' global that List Manager can display
"RTN","GMRCSLM1",25,0)
 ;;GMRCOER is a variable that signals that data is being formatted for the OE/RR GUI; this data is formatted differently than the data for List Manager.
"RTN","GMRCSLM1",26,0)
 ;;GMRCOER=0 : Data is List Manager formatted.
"RTN","GMRCSLM1",27,0)
 ;;GMRCOER=1 : Data is OE/RR GUI formatted.
"RTN","GMRCSLM1",28,0)
 S:'$D(TAB) TAB="",$P(TAB," ",30)=""
"RTN","GMRCSLM1",29,0)
 S GMRCIFN=$G(GMRCDA) I '$L(GMRCIFN),$D(XQADATA) S (GMRCDA,GMRCIFN)=+XQADATA
"RTN","GMRCSLM1",30,0)
 S GMRCSEX=$S($P(^DPT(DFN,0),"^",2)="M":"MALE",1:"FEMALE")
"RTN","GMRCSLM1",31,0)
 I '$D(^GMR(123,+GMRCIFN,0)) S GMRCQUT=1 Q
"RTN","GMRCSLM1",32,0)
 S PROC="",GMRC(0)=^GMR(123,GMRCIFN,0)
"RTN","GMRCSLM1",33,0)
 I $D(GMRCSTCK),GMRCSTCK'="" N STATUS,TITLE D  Q:'STATUS
"RTN","GMRCSLM1",34,0)
 . N I
"RTN","GMRCSLM1",35,0)
 . F I=1:1 S STATUS=$P(GMRCSTCK,",",I) Q:STATUS=$P(GMRC(0),"^",12)  Q:'STATUS
"RTN","GMRCSLM1",36,0)
 . Q
"RTN","GMRCSLM1",37,0)
 I $D(GMRCVP),GMRCVP'=$P(GMRC(0),"^",8) Q
"RTN","GMRCSLM1",38,0)
 S (GMRCFMDT,X)=$P(GMRC(0),"^",7) I GMRCDT1'="ALL",$P(X,".",1)<GMRCDT1!($P(X,".",1)>GMRCDT2) Q
"RTN","GMRCSLM1",39,0)
 S BLK=BLK+1,^TMP("GMRCR",$J,"CS","AD",BLK,LNCT,GMRCDA)=""
"RTN","GMRCSLM1",40,0)
 D REGDTM^GMRCU S CDT=$P(X," ")
"RTN","GMRCSLM1",41,0)
 S PROC=$S($$GET1^DIQ(101,+$P(GMRC(0),U,17),.01)["CONS":"Consult",1:"")
"RTN","GMRCSLM1",42,0)
 I PROC'="Consult" S PROC=$$GET1^DIQ(101,+$P(GMRC(0),"^",8),1)
"RTN","GMRCSLM1",43,0)
 S:PROC="" PROC="Consult"
"RTN","GMRCSLM1",44,0)
 S TO=+$P(GMRC(0),"^",5)
"RTN","GMRCSLM1",45,0)
 I +TO S TOD=$S($P($G(^GMR(123.5,+TO,0)),"^",2)=9:1,1:0)
"RTN","GMRCSLM1",46,0)
 I '$D(TOD) S TOD=0
"RTN","GMRCSLM1",47,0)
 S TO=$S(+TO:$P($G(^GMR(123.5,+TO,0)),"^",1),1:"")
"RTN","GMRCSLM1",48,0)
 S TO=$S(TOD:"<",1:"")_TO
"RTN","GMRCSLM1",49,0)
 S TO=$S(GMRCOER:TO,1:$E(TO,1,40))_$S(TOD:">",1:"")
"RTN","GMRCSLM1",50,0)
 I '$L(TO) S TO="**Unknown Service**"
"RTN","GMRCSLM1",51,0)
 S STS=$P(GMRC(0),"^",12) I +STS,$D(^ORD(100.01,+STS,0)) S:'+GMRCOER STS=$P(^ORD(100.01,+STS,.1),"^",1) I +GMRCOER S STS=$S(GMRCOER=1:$P(^ORD(100.01,+STS,0),"^",1),1:$P(^ORD(100.01,+STS,.1),"^",1))
"RTN","GMRCSLM1",52,0)
 I $S(STS="":1,'$D(^ORD(100.01,+$P(GMRC(0),"^",12),0)):1,1:0) S STS=99,$P(GMRC(0),"^",12)=STS,STS=$S(GMRCOER=1:$P(^ORD(100.01,5,0),"^",1),1:$P(^ORD(100.01,+STS,.1),"^",1))
"RTN","GMRCSLM1",53,0)
 D SERVPROC
"RTN","GMRCSLM1",54,0)
 I 'GMRCOER S ^TMP("GMRCR",$J,"CS",LNCT,0)=BLK_$E(TAB,1,(4-$L(BLK)))_CDT_"  "_$E(STS,1,3)_$S(STS?1A:"  ",STS?2A:" ",1:"")_" "_$J(GMRCDA,7)_" "_$S($P(GMRC(0),"^",19)="Y":"*",1:" ")_TITLE,LNCT=LNCT+1 Q
"RTN","GMRCSLM1",55,0)
 I GMRCOER D
"RTN","GMRCSLM1",56,0)
 . S ^TMP("GMRCR",$J,"CS",LNCT,0)=GMRCDA_U_GMRCFMDT_U_STS_U_TO_U_PROC_U_$S($P(GMRC(0),U,19)="Y":"*",1:"")_U_TITLE_U_$P(GMRC(0),U,3)
"RTN","GMRCSLM1",57,0)
 . ;pass ORIFN to CPRS with array
"RTN","GMRCSLM1",58,0)
 . S LNCT=LNCT+1
"RTN","GMRCSLM1",59,0)
 . K STSOER Q
"RTN","GMRCSLM1",60,0)
 Q
"RTN","GMRCSLM1",61,0)
END I LNCT<2 S (BLK,LNCT,GMRCNUL)=1,GMRCNPM="< PATIENT DOES NOT HAVE ANY CONSULTS/REQUESTS "_$S($D(GMRCPRNM):"FOR "_GMRCPRNM,1:"")_" ON FILE. >",GMRCNPM=$E(TAB,1,(80-$L(GMRCNPM))\80)_GMRCNPM,^TMP("GMRCR",$J,"CS",LNCT,0)=GMRCNPM D
"RTN","GMRCSLM1",62,0)
 .I GMRCDT1'="ALL",$D(GMRCDT1)&($D(GMRCDT2)) S LNCT=LNCT+1,^TMP("GMRCR",$J,"CS",LNCT,0)="Between Dates: "_$$FMTE^XLFDT(GMRCDT1)_" and "_$$FMTE^XLFDT(GMRCDT2)
"RTN","GMRCSLM1",63,0)
 .I $D(GMRCSTCK),$L(GMRCSTCK) S LNCT=LNCT+1,^TMP("GMRCR",$J,"CS",LNCT,0)="With Status: " S STS="" F I=1:1 S STS=$P(GMRCSTCK,",",I) Q:STS=""  S ^TMP("GMRCR",$J,"CS",LNCT,0)=^(0)_$P($G(^ORD(100.01,+STS,0)),"^",1)_" "
"RTN","GMRCSLM1",64,0)
 .Q
"RTN","GMRCSLM1",65,0)
 E  S (BLK,LNCT)=LNCT-1,^TMP("GMRCR",$J,"CS",0)="^^^"_LNCT
"RTN","GMRCSLM1",66,0)
 I $D(GMRCALFL) S (BLK,LNCT)=1
"RTN","GMRCSLM1",67,0)
 K TO,TOD,END,FLG,GMRC(0),GMRCD,GMRCDG,GMRCIFN,GMRCFMDT,GMRCNPM,GMRCWARD,I,PROC,STS,URG
"RTN","GMRCSLM1",68,0)
 Q
"RTN","GMRCSLM1",69,0)
OER(DFN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTCK,GMRCOER) ;;GUI interface for CPRS
"RTN","GMRCSLM1",70,0)
 ;;DFN=Patient internal file number
"RTN","GMRCSLM1",71,0)
 ;;GMRCDG:  Internal file number of consult service (from file ^GMR(123.5,)
"RTN","GMRCSLM1",72,0)
 ;;GMRCDT1:  Beginning date for lookup
"RTN","GMRCSLM1",73,0)
 ;;GMRCDT2:  Ending date for lookup
"RTN","GMRCSLM1",74,0)
 ;;GMRCSTCK: IEN from OER Status File [^OER(100.01)] to screen results
"RTN","GMRCSLM1",75,0)
 ;;     so that only consults with a desired status are displayed
"RTN","GMRCSLM1",76,0)
 ;;     Can be sent as a set of statuses: i.e., 6,5,2
"RTN","GMRCSLM1",77,0)
 ;;      (GMRCSTCK=GMRC STATUS CHECK)
"RTN","GMRCSLM1",78,0)
 ;;GMRCOER=0 if request is from CONSULTS; GMRCOER=1 if request is for CPRS List Manager, 2 if for CPRS GUI
"RTN","GMRCSLM1",79,0)
 I GMRCDT1="" S GMRCDT1="ALL"
"RTN","GMRCSLM1",80,0)
 I GMRCDG="" S GMRCDG=$O(^GMR(123.5,"B","ALL SERVICES",0))
"RTN","GMRCSLM1",81,0)
 S:'$D(GMRCOER) GMRCOER=1
"RTN","GMRCSLM1",82,0)
 D SERV1^GMRCASV,AD
"RTN","GMRCSLM1",83,0)
 K ^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J)
"RTN","GMRCSLM1",84,0)
 Q
"RTN","GMRCSLM1",85,0)
SERVPROC ; Build contents of SERV/PROC field for List Manager
"RTN","GMRCSLM1",86,0)
 S TITLE=""
"RTN","GMRCSLM1",87,0)
 S TYPE=""
"RTN","GMRCSLM1",88,0)
 S OTXT=$P($G(^GMR(123,GMRCDA,1.11)),"^")
"RTN","GMRCSLM1",89,0)
 I OTXT="" D BUILD2
"RTN","GMRCSLM1",90,0)
 I OTXT'="" D BUILD1
"RTN","GMRCSLM1",91,0)
 Q
"RTN","GMRCSLM1",92,0)
BUILD1 ;OTXT does contain information
"RTN","GMRCSLM1",93,0)
 N FLG,BADFLG,TPROC,TTO
"RTN","GMRCSLM1",94,0)
 S TPROC=$$UP^XLFSTR(PROC),TTO=$$UP^XLFSTR(TO)
"RTN","GMRCSLM1",95,0)
 S TITLE=OTXT,OTXT=$$UP^XLFSTR(OTXT)
"RTN","GMRCSLM1",96,0)
 S BADFLG=0
"RTN","GMRCSLM1",97,0)
 I PROC="Consult" S FLG=1,TYPE="Cons"
"RTN","GMRCSLM1",98,0)
 I PROC'="Consult" S FLG=0,TYPE="Proc"
"RTN","GMRCSLM1",99,0)
 S LEN=$L(TITLE)
"RTN","GMRCSLM1",100,0)
 I TO="" S TO="No Service"
"RTN","GMRCSLM1",101,0)
 I LEN<30,FLG=1,OTXT'=TTO S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",102,0)
 I LEN<30,FLG=1,OTXT=TTO S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",103,0)
 I TO["<" S BADFLG=1
"RTN","GMRCSLM1",104,0)
 S ABBRS=$$SVC^GMRCAU(GMRCDA),ABBRP=$$PROC^GMRCAU(GMRCDA)
"RTN","GMRCSLM1",105,0)
 I LEN<30,FLG=0,TPROC'=OTXT,TTO'=TPROC S TITLE=TITLE_" "_PROC_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",106,0)
 I LEN<30,FLG=0,TPROC=OTXT,TTO'=TPROC S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",107,0)
 I LEN<30,FLG=0,TPROC=OTXT,TTO=TPROC S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",108,0)
 I LEN>30,FLG=1,TTO'=OTXT S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",109,0)
 I LEN>30,FLG=1,TTO=OTXT S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",110,0)
 I LEN>30,FLG=0,TPROC'=OTXT,TTO'=TPROC S TITLE=TITLE_" "_ABBRP_" "_TYPE Q
"RTN","GMRCSLM1",111,0)
 I LEN>30,FLG=0,TTO'=OTXT,BADFLG=0 S TITLE=TITLE_" "_ABBRS_" "_TYPE Q
"RTN","GMRCSLM1",112,0)
 I LEN>30,FLG=0,TTO'=OTXT,BADFLG=1 S TITLE=TITLE_" "_"<"_ABBRS_">"_TYPE Q
"RTN","GMRCSLM1",113,0)
 Q
"RTN","GMRCSLM1",114,0)
BUILD2 ;OTXT contains no information
"RTN","GMRCSLM1",115,0)
 N FLG,TPROC,TTO
"RTN","GMRCSLM1",116,0)
 S TPROC=$$UP^XLFSTR(PROC),TTO=$$UP^XLFSTR(TO)
"RTN","GMRCSLM1",117,0)
 I PROC="Consult" S TITLE=TO,LEN=$L(TITLE),FLG=1,TYPE="Cons"
"RTN","GMRCSLM1",118,0)
 I PROC'="Consult" S TITLE=PROC,LEN=$L(TITLE),FLG=0,TYPE="Proc"
"RTN","GMRCSLM1",119,0)
 I FLG=1 S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",120,0)
 I FLG=0,TTO=TPROC S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",121,0)
 I FLG=0,TTO'=TPROC S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",122,0)
 Q
"RTN","GMRCTIUE")
0^6^B30284600
"RTN","GMRCTIUE",1,0)
GMRCTIUE ;SLC/DCM,DLT - Complete/Update TIU notes ;7/16/98  02:10
"RTN","GMRCTIUE",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10**;DEC 27, 1997
"RTN","GMRCTIUE",3,0)
ENTER(GMRCO) ; Enter a note in TIU for the consult result
"RTN","GMRCTIUE",4,0)
 ;If consult from list is defined in GMRCO, than use it.
"RTN","GMRCTIUE",5,0)
 K GMRCQUT N TIUDA,TIUCLASS,GMRCLCK
"RTN","GMRCTIUE",6,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",7,0)
 Q:$D(GMRCQUT)!'$L($G(GMRCO))
"RTN","GMRCTIUE",8,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q  ;JFR
"RTN","GMRCTIUE",9,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",10,0)
 D CHKSTS I $G(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",11,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCTIUE",12,0)
 ;
"RTN","GMRCTIUE",13,0)
 ;If service administrative user, then use administrative complete logic
"RTN","GMRCTIUE",14,0)
 I $$VALID^GMRCAU($P(^GMR(123,GMRCO,0),U,5))=3 D  Q
"RTN","GMRCTIUE",15,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",16,0)
 . D EDEX
"RTN","GMRCTIUE",17,0)
 ;
"RTN","GMRCTIUE",18,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",19,0)
 ;Get list of notes If no new notes, add new then quit
"RTN","GMRCTIUE",20,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",21,0)
 I '$$GETLIST(GMRCDFN,GMRCO,.GMRCTIUC) D NEW,EDEX Q
"RTN","GMRCTIUE",22,0)
 ;
"RTN","GMRCTIUE",23,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",24,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",25,0)
 I GMRCTIUC(GMRCVF)=1 D  Q
"RTN","GMRCTIUE",26,0)
 . S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",27,0)
 . I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",28,0)
 . D EDEX
"RTN","GMRCTIUE",29,0)
 . Q
"RTN","GMRCTIUE",30,0)
 ;
"RTN","GMRCTIUE",31,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",32,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",33,0)
 ;
"RTN","GMRCTIUE",34,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",35,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",36,0)
 I $D(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",37,0)
 I '+(GMRCSELR) D  D EDEX Q
"RTN","GMRCTIUE",38,0)
 . ;didn't select existing note, allow a new entry
"RTN","GMRCTIUE",39,0)
 . N DIR,X,Y
"RTN","GMRCTIUE",40,0)
 . S DIR(0)="Y",DIR("A")="Would you like to enter a new note"
"RTN","GMRCTIUE",41,0)
 . S DIR("B")="N" D ^DIR
"RTN","GMRCTIUE",42,0)
 . I Y<1 K DTOUT,DUOUT,X,Y Q
"RTN","GMRCTIUE",43,0)
 . D NEW
"RTN","GMRCTIUE",44,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",45,0)
 ;
"RTN","GMRCTIUE",46,0)
 I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",47,0)
 ;
"RTN","GMRCTIUE",48,0)
 D EDEX
"RTN","GMRCTIUE",49,0)
 Q
"RTN","GMRCTIUE",50,0)
 ;
"RTN","GMRCTIUE",51,0)
SAUSER() ; admin user?
"RTN","GMRCTIUE",52,0)
 N GMRCSS,GMRCADUS
"RTN","GMRCTIUE",53,0)
 S GMRCSS=+$P($G(^GMR(123,+GMRCO,0)),"^",5) Q:'+GMRCSS 0
"RTN","GMRCTIUE",54,0)
 I $D(^GMR(123.5,+$P($G(^GMR(123,+GMRCO,0)),"^",5),123.33,"B",DUZ)) Q 1
"RTN","GMRCTIUE",55,0)
 I '$L($TEXT(VALIDU^GMRCAU)) Q 0
"RTN","GMRCTIUE",56,0)
 S GMRCADUS=0
"RTN","GMRCTIUE",57,0)
 I $L($TEXT(VALIDU^GMRCAU)) D TEAM^GMRCAU(.GMRCADUS,123.34,DUZ)
"RTN","GMRCTIUE",58,0)
 Q +GMRCADUS
"RTN","GMRCTIUE",59,0)
 ;
"RTN","GMRCTIUE",60,0)
CHKSTS ;Check the order status before allowing entry of a note
"RTN","GMRCTIUE",61,0)
 N STATUS S STATUS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCTIUE",62,0)
 I $S(STATUS=1:1,STATUS=13:1,1:0) D
"RTN","GMRCTIUE",63,0)
 . W !,"This order has been "
"RTN","GMRCTIUE",64,0)
 . W $S(STATUS=1:"DISCONTINUED",1:"CANCELLED")
"RTN","GMRCTIUE",65,0)
 . W ".  A note cannot be entered."
"RTN","GMRCTIUE",66,0)
 . D PAUSE S GMRCQUT=1
"RTN","GMRCTIUE",67,0)
 Q
"RTN","GMRCTIUE",68,0)
 ;
"RTN","GMRCTIUE",69,0)
EDITNOTE(GMRCTUFN) ;use TIU LM for an existing note
"RTN","GMRCTIUE",70,0)
 I +$D(^TIU(8925,+GMRCTUFN,0)) D  Q
"RTN","GMRCTIUE",71,0)
 . D EXSTNOTE^TIUBR1(+GMRCDFN,+GMRCTUFN)
"RTN","GMRCTIUE",72,0)
 ;
"RTN","GMRCTIUE",73,0)
 ; link is missing
"RTN","GMRCTIUE",74,0)
 W !,"A note #"_+GMRCTUFN_" is linked to the consult,"
"RTN","GMRCTIUE",75,0)
 W !,"  but the note is no longer in TIU!"
"RTN","GMRCTIUE",76,0)
 D PAUSE
"RTN","GMRCTIUE",77,0)
 Q
"RTN","GMRCTIUE",78,0)
 ;
"RTN","GMRCTIUE",79,0)
SINGLE(GMRCVF) ;Get the single result entry from the list for the file type
"RTN","GMRCTIUE",80,0)
 N RSLT,GMRCVP
"RTN","GMRCTIUE",81,0)
 S RSLT="",GMRCVP=0
"RTN","GMRCTIUE",82,0)
 F  S RSLT=$O(^TMP("GMRC50",$J,RSLT)) Q:RSLT=""  D  Q:+GMRCVP
"RTN","GMRCTIUE",83,0)
 . I $P(RSLT,";",2)=GMRCVF S GMRCVP=RSLT
"RTN","GMRCTIUE",84,0)
 Q +GMRCVP
"RTN","GMRCTIUE",85,0)
 ;
"RTN","GMRCTIUE",86,0)
GETTUFN(GMRCSELR) ;Get the result entry from the selected entry
"RTN","GMRCTIUE",87,0)
 N RSLT
"RTN","GMRCTIUE",88,0)
 S RSLT=$O(^TMP("GMRC50R",$J,GMRCSELR,""))
"RTN","GMRCTIUE",89,0)
 Q RSLT
"RTN","GMRCTIUE",90,0)
 ;
"RTN","GMRCTIUE",91,0)
NEW ;Enter a new result through TIU if implemented or old Completion logic
"RTN","GMRCTIUE",92,0)
 S TIUCLASS=+$$CLASS
"RTN","GMRCTIUE",93,0)
 I TIUCLASS'>0 D  Q
"RTN","GMRCTIUE",94,0)
 . W !!,$C(7),"Consult Resulting through TIU is not yet implemented."
"RTN","GMRCTIUE",95,0)
 . W !,"Proceeding with Administrative Complete."
"RTN","GMRCTIUE",96,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",97,0)
 ;
"RTN","GMRCTIUE",98,0)
 D MAIN^TIUEDIT(TIUCLASS,.GMRCTIDA,GMRCDFN,"","","","",1)
"RTN","GMRCTIUE",99,0)
 ;
"RTN","GMRCTIUE",100,0)
 ;If TIU returns TIUDA, than update file 123
"RTN","GMRCTIUE",101,0)
 ;I +$G(TIUDA),$D(^TIU(8925,+$G(TIUDA),0)) D ADD^GMRCTIUA(+TIUDA,GMRCO)
"RTN","GMRCTIUE",102,0)
 Q
"RTN","GMRCTIUE",103,0)
 ;
"RTN","GMRCTIUE",104,0)
CLASS() ; What is the TIU Class (or Document Class) for CONSULTS
"RTN","GMRCTIUE",105,0)
 N GMRCY
"RTN","GMRCTIUE",106,0)
 S GMRCY=+$O(^TIU(8925.1,"B","CONSULTS",0))
"RTN","GMRCTIUE",107,0)
 I +GMRCY>0,$S($P($G(^TIU(8925.1,+GMRCY,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S GMRCY=0
"RTN","GMRCTIUE",108,0)
 Q GMRCY
"RTN","GMRCTIUE",109,0)
 ;
"RTN","GMRCTIUE",110,0)
GETLIST(GMRCDFN,GMRCO,GMRCLIST) ;
"RTN","GMRCTIUE",111,0)
 ;
"RTN","GMRCTIUE",112,0)
 N GMRCVF
"RTN","GMRCTIUE",113,0)
 ;
"RTN","GMRCTIUE",114,0)
 D GETLIST^GMRCTIUL(GMRCO,2,1,.GMRCTIUC)
"RTN","GMRCTIUE",115,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",116,0)
 Q +$G(GMRCTIUC(GMRCVF))
"RTN","GMRCTIUE",117,0)
 ;
"RTN","GMRCTIUE",118,0)
ADDEND(GMRCO) ; Make an addendum action for a selected consult
"RTN","GMRCTIUE",119,0)
 N TIUDA,GMRCTX,GMRCDFN,GMRCADUZ,RSLTINFO,GMRCACT,GMRCTIUC,GMRCLCK
"RTN","GMRCTIUE",120,0)
 K GMRCQUT
"RTN","GMRCTIUE",121,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",122,0)
 Q:$D(GMRCQUT)!'+($G(GMRCO))
"RTN","GMRCTIUE",123,0)
 ;
"RTN","GMRCTIUE",124,0)
 ;If service administrative user, then QUIT.
"RTN","GMRCTIUE",125,0)
 I $$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5))=3 D  Q
"RTN","GMRCTIUE",126,0)
 . D EXAC^GMRCADC("You do not have the ability to edit this note.")
"RTN","GMRCTIUE",127,0)
 ;
"RTN","GMRCTIUE",128,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",129,0)
 ;
"RTN","GMRCTIUE",130,0)
 ;Get list of notes for this consult. if no notes, then quit.
"RTN","GMRCTIUE",131,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",132,0)
 I '$$GETLIST(GMRCDFN,+GMRCO,.GMRCTIUC) D  Q
"RTN","GMRCTIUE",133,0)
 . W !,"This consult does not yet have an associated note."
"RTN","GMRCTIUE",134,0)
 . W !,"  Use the Complete action to enter a new note."
"RTN","GMRCTIUE",135,0)
 . D PAUSE,EDEX
"RTN","GMRCTIUE",136,0)
 ;
"RTN","GMRCTIUE",137,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q  ;JFR
"RTN","GMRCTIUE",138,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",139,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",140,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",141,0)
 I GMRCTIUC(GMRCVF)=1 D  D EDEX Q
"RTN","GMRCTIUE",142,0)
 . S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",143,0)
 . Q:'+GMRCTUFN
"RTN","GMRCTIUE",144,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",145,0)
 . N GMRCVP,RSLTINFO,AUTHOR
"RTN","GMRCTIUE",146,0)
 . S GMRCVP=+GMRCTUFN_";"_GMRCVF
"RTN","GMRCTIUE",147,0)
 . S RSLTIEN=$O(^TMP("GMRC50",$J,GMRCVP,0))
"RTN","GMRCTIUE",148,0)
 . S RSLTINFO=$G(^TMP("GMRC50",$J,GMRCVP,RSLTIEN))
"RTN","GMRCTIUE",149,0)
 . I $P(RSLTINFO,"^",6)="completed" D ADDEND1(+GMRCTUFN) Q
"RTN","GMRCTIUE",150,0)
 . I (DUZ=+$P(RSLTINFO,"^",4)) D EDITNOTE(+GMRCTUFN) Q
"RTN","GMRCTIUE",151,0)
 . W !,"You may not addend to the incomplete associated note."
"RTN","GMRCTIUE",152,0)
 . W !,"You are not the author of the existing note."
"RTN","GMRCTIUE",153,0)
 . I $$READ^GMRCACMT("Y","Do you want to add a new note ","YES") D NEW
"RTN","GMRCTIUE",154,0)
 . Q
"RTN","GMRCTIUE",155,0)
 ;
"RTN","GMRCTIUE",156,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",157,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",158,0)
 ;
"RTN","GMRCTIUE",159,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",160,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",161,0)
 I $D(GMRCQUT)!'+(GMRCSELR) D EDEX Q
"RTN","GMRCTIUE",162,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",163,0)
 ;
"RTN","GMRCTIUE",164,0)
 I +GMRCTUFN D ADDEND1(+GMRCTUFN),EDEX Q  ;JFR
"RTN","GMRCTIUE",165,0)
 ;
"RTN","GMRCTIUE",166,0)
 D EDEX
"RTN","GMRCTIUE",167,0)
 Q
"RTN","GMRCTIUE",168,0)
ADDEND1(TIUDA) ;Add an addendum
"RTN","GMRCTIUE",169,0)
 ;
"RTN","GMRCTIUE",170,0)
 D FULL^VALM1,ADDEND1^TIURA1
"RTN","GMRCTIUE",171,0)
 Q
"RTN","GMRCTIUE",172,0)
 ;
"RTN","GMRCTIUE",173,0)
EDEX ;
"RTN","GMRCTIUE",174,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCTIUE",175,0)
 K GMRCDFN,GMRCO,GMRCQUT,GMRCTUFN,GMRCSEL
"RTN","GMRCTIUE",176,0)
 Q
"RTN","GMRCTIUE",177,0)
 ;
"RTN","GMRCTIUE",178,0)
PAUSE ; Pause for user
"RTN","GMRCTIUE",179,0)
 ;
"RTN","GMRCTIUE",180,0)
 N X W !,"Press <RETURN> to continue: " R X:DTIME E  W " (timeout)"
"RTN","GMRCTIUE",181,0)
 Q
"RTN","GMRCTIUE",182,0)
 ;
"VER")
8.0^22.0
**END**
**END**
