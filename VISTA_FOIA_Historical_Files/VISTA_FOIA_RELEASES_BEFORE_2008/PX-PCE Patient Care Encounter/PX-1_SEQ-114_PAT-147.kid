Released PX*1*147 SEQ #114
Extracted from mail message
**KIDS**:PX*1.0*147^

**INSTALL NAME**
PX*1.0*147
"BLD",5575,0)
PX*1.0*147^PCE PATIENT CARE ENCOUNTER^0^3040826^y
"BLD",5575,1,0)
^9.61A^6^6^3040603^^
"BLD",5575,1,1,0)
Date of death display warning. Addresses the selecting of deceased 
"BLD",5575,1,2,0)
patients, within PCE, that currently does not check and display for date 
"BLD",5575,1,3,0)
of death.
"BLD",5575,1,4,0)
 
"BLD",5575,1,5,0)
Also, addresses [PXRR PROVIDER ENCOUNTER COUNTS] where the prompt for 
"BLD",5575,1,6,0)
selection by Person Class was limited to 30 characters.
"BLD",5575,4,0)
^9.64PA^^
"BLD",5575,"KRN",0)
^9.67PA^8989.52^19
"BLD",5575,"KRN",.4,0)
.4
"BLD",5575,"KRN",.401,0)
.401
"BLD",5575,"KRN",.402,0)
.402
"BLD",5575,"KRN",.403,0)
.403
"BLD",5575,"KRN",.5,0)
.5
"BLD",5575,"KRN",.84,0)
.84
"BLD",5575,"KRN",3.6,0)
3.6
"BLD",5575,"KRN",3.8,0)
3.8
"BLD",5575,"KRN",9.2,0)
9.2
"BLD",5575,"KRN",9.8,0)
9.8
"BLD",5575,"KRN",9.8,"NM",0)
^9.68A^16^10
"BLD",5575,"KRN",9.8,"NM",2,0)
PXRRPECS^^0^B38623626
"BLD",5575,"KRN",9.8,"NM",4,0)
PXAPIEED^^0^B5500727
"BLD",5575,"KRN",9.8,"NM",5,0)
PXBAPI21^^0^B12380612
"BLD",5575,"KRN",9.8,"NM",10,0)
PXBAPI1^^0^B47529522
"BLD",5575,"KRN",9.8,"NM",11,0)
PXCE^^0^B61867490
"BLD",5575,"KRN",9.8,"NM",12,0)
PXCEPAT^^0^B26711062
"BLD",5575,"KRN",9.8,"NM",13,0)
PXCESDAM^^0^B29606794
"BLD",5575,"KRN",9.8,"NM",14,0)
PXCEVSIT^^0^B25028869
"BLD",5575,"KRN",9.8,"NM",15,0)
PXCEAE^^0^B30145919
"BLD",5575,"KRN",9.8,"NM",16,0)
PXCEVFIL^^0^B38064195
"BLD",5575,"KRN",9.8,"NM","B","PXAPIEED",4)

"BLD",5575,"KRN",9.8,"NM","B","PXBAPI1",10)

"BLD",5575,"KRN",9.8,"NM","B","PXBAPI21",5)

"BLD",5575,"KRN",9.8,"NM","B","PXCE",11)

"BLD",5575,"KRN",9.8,"NM","B","PXCEAE",15)

"BLD",5575,"KRN",9.8,"NM","B","PXCEPAT",12)

"BLD",5575,"KRN",9.8,"NM","B","PXCESDAM",13)

"BLD",5575,"KRN",9.8,"NM","B","PXCEVFIL",16)

"BLD",5575,"KRN",9.8,"NM","B","PXCEVSIT",14)

"BLD",5575,"KRN",9.8,"NM","B","PXRRPECS",2)

"BLD",5575,"KRN",19,0)
19
"BLD",5575,"KRN",19,"NM",0)
^9.68A^^
"BLD",5575,"KRN",19.1,0)
19.1
"BLD",5575,"KRN",101,0)
101
"BLD",5575,"KRN",409.61,0)
409.61
"BLD",5575,"KRN",771,0)
771
"BLD",5575,"KRN",870,0)
870
"BLD",5575,"KRN",8989.51,0)
8989.51
"BLD",5575,"KRN",8989.52,0)
8989.52
"BLD",5575,"KRN",8994,0)
8994
"BLD",5575,"KRN","B",.4,.4)

"BLD",5575,"KRN","B",.401,.401)

"BLD",5575,"KRN","B",.402,.402)

"BLD",5575,"KRN","B",.403,.403)

"BLD",5575,"KRN","B",.5,.5)

"BLD",5575,"KRN","B",.84,.84)

"BLD",5575,"KRN","B",3.6,3.6)

"BLD",5575,"KRN","B",3.8,3.8)

"BLD",5575,"KRN","B",9.2,9.2)

"BLD",5575,"KRN","B",9.8,9.8)

"BLD",5575,"KRN","B",19,19)

"BLD",5575,"KRN","B",19.1,19.1)

"BLD",5575,"KRN","B",101,101)

"BLD",5575,"KRN","B",409.61,409.61)

"BLD",5575,"KRN","B",771,771)

"BLD",5575,"KRN","B",870,870)

"BLD",5575,"KRN","B",8989.51,8989.51)

"BLD",5575,"KRN","B",8989.52,8989.52)

"BLD",5575,"KRN","B",8994,8994)

"BLD",5575,"QUES",0)
^9.62^^
"BLD",5575,"REQB",0)
^9.611^13^9
"BLD",5575,"REQB",2,0)
PX*1.0*116^2
"BLD",5575,"REQB",3,0)
PX*1.0*104^2
"BLD",5575,"REQB",4,0)
PX*1.0*99^2
"BLD",5575,"REQB",6,0)
PX*1.0*78^2
"BLD",5575,"REQB",8,0)
PX*1.0*34^2
"BLD",5575,"REQB",9,0)
PX*1.0*70^2
"BLD",5575,"REQB",11,0)
PX*1.0*12^2
"BLD",5575,"REQB",12,0)
PX*1.0*122^2
"BLD",5575,"REQB",13,0)
PX*1.0*130^2
"BLD",5575,"REQB","B","PX*1.0*104",3)

"BLD",5575,"REQB","B","PX*1.0*116",2)

"BLD",5575,"REQB","B","PX*1.0*12",11)

"BLD",5575,"REQB","B","PX*1.0*122",12)

"BLD",5575,"REQB","B","PX*1.0*130",13)

"BLD",5575,"REQB","B","PX*1.0*34",8)

"BLD",5575,"REQB","B","PX*1.0*70",9)

"BLD",5575,"REQB","B","PX*1.0*78",6)

"BLD",5575,"REQB","B","PX*1.0*99",4)

"MBREQ")
0
"PKG",413,-1)
1^1
"PKG",413,0)
PCE PATIENT CARE ENCOUNTER^PX^Patient Care Encounter (VA Parent package)^
"PKG",413,20,0)
^9.402P^^
"PKG",413,22,0)
^9.49I^1^1
"PKG",413,22,1,0)
1.0^2960812^2960913^12537
"PKG",413,22,1,"PAH",1,0)
147^3040826
"PKG",413,22,1,"PAH",1,1,0)
^^6^6^3040826
"PKG",413,22,1,"PAH",1,1,1,0)
Date of death display warning. Addresses the selecting of deceased 
"PKG",413,22,1,"PAH",1,1,2,0)
patients, within PCE, that currently does not check and display for date 
"PKG",413,22,1,"PAH",1,1,3,0)
of death.
"PKG",413,22,1,"PAH",1,1,4,0)
 
"PKG",413,22,1,"PAH",1,1,5,0)
Also, addresses [PXRR PROVIDER ENCOUNTER COUNTS] where the prompt for 
"PKG",413,22,1,"PAH",1,1,6,0)
selection by Person Class was limited to 30 characters.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","PXAPIEED")
0^4^B5500727
"RTN","PXAPIEED",1,0)
PXAPIEED ;ISL/dee - PCE's API to ask standalone encounter or add then edit it or to delete a standalone ; 8/14/00 2:47pm
"RTN","PXAPIEED",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**1,147**;Aug 12, 1996
"RTN","PXAPIEED",3,0)
 Q
"RTN","PXAPIEED",4,0)
 ;
"RTN","PXAPIEED",5,0)
ENCEDIT(WHAT,PACKAGE,SOURCE,DFN,BEGINDT,ENDDT,HLOC,SCREEN,APPOINT,PROMPT,COSTATUS) ;--Ask for encounter the edit it of delete it
"RTN","PXAPIEED",6,0)
 ;
"RTN","PXAPIEED",7,0)
 ; >0           = VISIT IEN
"RTN","PXAPIEED",8,0)
 ; D^Visit IEN  = User selected to delete and the visit ien that was deleted
"RTN","PXAPIEED",9,0)
 ; -1           = nothing was done (user did not select visit or ^-out)
"RTN","PXAPIEED",10,0)
 ; -2^text      = error of some kind^simple text message
"RTN","PXAPIEED",11,0)
 ; -3^text      = error in deleting^simple text message
"RTN","PXAPIEED",12,0)
 ;
"RTN","PXAPIEED",13,0)
 N VISITIEN,PXRESULT,PXRETURN,PXVISIT,PXBEGDT,PXX
"RTN","PXAPIEED",14,0)
 I $G(DFN)<1 S DFN=$$ASKPAT^PXBAPI1()
"RTN","PXAPIEED",15,0)
 Q:DFN<1 -1
"RTN","PXAPIEED",16,0)
 D 2^VADPT I +VADM(6) D  Q:$D(DUOUT)!$D(DIRUT) -1
"RTN","PXAPIEED",17,0)
 . S DIR(0)="E",DIR("A")="Enter RETURN to continue or '^' to exit"
"RTN","PXAPIEED",18,0)
 . S DIR("A",2)="WARNING "_VADM(7) D ^DIR
"RTN","PXAPIEED",19,0)
 S PXBEGDT=$S($$SWITCHD^PXAPI>BEGINDT:$$SWITCHD^PXAPI,1:BEGINDT)
"RTN","PXAPIEED",20,0)
 S VISITIEN=$$VISITLST^PXAPI(DFN,PXBEGDT,ENDDT,HLOC,SCREEN,APPOINT,PROMPT,COSTATUS)
"RTN","PXAPIEED",21,0)
 I $P(VISITIEN,"^",1)="D" D
"RTN","PXAPIEED",22,0)
 . S PXRESULT=$$DELVFILE^PXAPI("ALL",$P(VISITIEN,"^",2),"","",1,1)
"RTN","PXAPIEED",23,0)
 . I PXRESULT=1 S PXRETURN=VISITIEN
"RTN","PXAPIEED",24,0)
 . E  I PXRESULT=0 S PXRETURN="-3^ONLY PARTLY DELETED"
"RTN","PXAPIEED",25,0)
 . E  I PXRESULT=-1 S PXRETURN=-1
"RTN","PXAPIEED",26,0)
 . E  I PXRESULT<-1 S PXRETURN="-3^ERROR IN TRYING TO DELETE"
"RTN","PXAPIEED",27,0)
 E  I VISITIEN>0!(VISITIEN="A") D
"RTN","PXAPIEED",28,0)
 . S PXVISIT=$S(VISITIEN>0:VISITIEN,1:"")
"RTN","PXAPIEED",29,0)
 . S PXRESULT=$$INTV^PXAPI(WHAT,PACKAGE,SOURCE,VISITIEN,$S(VISITIEN="A":HLOC,1:""),DFN,"",$$SWITCHD^PXAPI)
"RTN","PXAPIEED",30,0)
 . I PXRESULT'<0 S PXRETURN=PXVISIT
"RTN","PXAPIEED",31,0)
 . E  I PXRESULT=-1 S PXRETURN=-1
"RTN","PXAPIEED",32,0)
 . E  I PXRESULT<-1 S PXRETURN="-2^ERROR IN TRYING TO DO INTERVIEW"
"RTN","PXAPIEED",33,0)
 E  S PXRETURN=VISITIEN
"RTN","PXAPIEED",34,0)
 Q PXRETURN
"RTN","PXAPIEED",35,0)
 ;
"RTN","PXAPIEED",36,0)
LOPENCED(WHAT,PACKAGE,SOURCE,DFN,BEGINDT,ENDDT,HLOC,SCREEN,APPOINT,PROMPT,COSTATUS) ;
"RTN","PXAPIEED",37,0)
 ;
"RTN","PXAPIEED",38,0)
 ; Returns:
"RTN","PXAPIEED",39,0)
 ;  0           = all oky doky
"RTN","PXAPIEED",40,0)
 ; -1           = nothing was done (user did not select visit or ^-out)
"RTN","PXAPIEED",41,0)
 ; -2^text      = error of some kind^simple text message
"RTN","PXAPIEED",42,0)
 ; -3^text      = error in deleting^simple text message
"RTN","PXAPIEED",43,0)
 ;
"RTN","PXAPIEED",44,0)
 N PXRETURN,PXRESULT
"RTN","PXAPIEED",45,0)
 S PXRESULT=-1
"RTN","PXAPIEED",46,0)
 F  D  Q:PXRETURN<0
"RTN","PXAPIEED",47,0)
 . S PXRETURN=$$ENCEDIT(WHAT,PACKAGE,SOURCE,DFN,BEGINDT,ENDDT,HLOC,SCREEN,APPOINT,PROMPT,COSTATUS)
"RTN","PXAPIEED",48,0)
 . I PXRETURN'<0 S PXRESULT=0
"RTN","PXAPIEED",49,0)
 Q $S(PXRETURN<-1:PXRETURN,1:PXRESULT)
"RTN","PXAPIEED",50,0)
 ;
"RTN","PXBAPI1")
0^10^B47529522
"RTN","PXBAPI1",1,0)
PXBAPI1 ;ISL/JVS,dee - PCE's API - interview questions ;10/15/96
"RTN","PXBAPI1",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**1,9,23,56,104,111,113,122,116,130,147**;Aug 12, 1996
"RTN","PXBAPI1",3,0)
 ;;
"RTN","PXBAPI1",4,0)
 Q
"RTN","PXBAPI1",5,0)
 ;
"RTN","PXBAPI1",6,0)
PROCESS(PXBEXIT) ;
"RTN","PXBAPI1",7,0)
 I WHAT="INTV" D
"RTN","PXBAPI1",8,0)
 . ;-- Interview is all of the questions
"RTN","PXBAPI1",9,0)
 . D ADQ(.PXBEXIT) I PXBEXIT<1 Q 
"RTN","PXBAPI1",10,0)
1 . D PRV(.PXBEXIT) I PXBEXIT<1 Q
"RTN","PXBAPI1",11,0)
3 . D POV(.PXBEXIT) I PXBEXIT<1 Q
"RTN","PXBAPI1",12,0)
2 . D CPT(.PXBEXIT) I PXBEXIT<1 Q
"RTN","PXBAPI1",13,0)
 . I $P($G(^AUPNVSIT($G(PXBVST),150)),"^",3)="O" S PXBEXIT=0 Q
"RTN","PXBAPI1",14,0)
 . I '$$DISPOSIT^PXUTL1($G(PXBPAT),$P($G(^AUPNVSIT(PXBVST,0)),"^",1),$G(PXBVST)) D STP(.PXBEXIT) I PXBEXIT<1 Q
"RTN","PXBAPI1",15,0)
 E  I WHAT="ADDEDIT" D
"RTN","PXBAPI1",16,0)
 . D ADDEDIT
"RTN","PXBAPI1",17,0)
 E  I WHAT="ADQ" D
"RTN","PXBAPI1",18,0)
 . ;-- Adminstrative questions
"RTN","PXBAPI1",19,0)
 . D ADQ(.PXBEXIT)
"RTN","PXBAPI1",20,0)
 E  I WHAT="CODT" D
"RTN","PXBAPI1",21,0)
 . ;-- Check out Date/Time
"RTN","PXBAPI1",22,0)
 . D CODT(.PXBEXIT)
"RTN","PXBAPI1",23,0)
 . Q:PXBEXIT<1
"RTN","PXBAPI1",24,0)
 . D VISIT(.PXBEXIT)
"RTN","PXBAPI1",25,0)
 . I PXBVST'>0 S PXBEXIT=-2 Q
"RTN","PXBAPI1",26,0)
 E  I WHAT="SCC" D
"RTN","PXBAPI1",27,0)
 . ;-- Service connected conditions
"RTN","PXBAPI1",28,0)
 . D SCC(.PXBEXIT)
"RTN","PXBAPI1",29,0)
 . Q:PXBEXIT<1
"RTN","PXBAPI1",30,0)
 . D VISIT(.PXBEXIT)
"RTN","PXBAPI1",31,0)
 . I PXBVST'>0 S PXBEXIT=-2 Q
"RTN","PXBAPI1",32,0)
 E  I WHAT="PRV" D
"RTN","PXBAPI1",33,0)
 . ;-- Providers
"RTN","PXBAPI1",34,0)
 . D PRV(.PXBEXIT)
"RTN","PXBAPI1",35,0)
 E  I WHAT="CPT" D
"RTN","PXBAPI1",36,0)
 . ;-- Providers and CPT codes
"RTN","PXBAPI1",37,0)
 . D CPT(.PXBEXIT)
"RTN","PXBAPI1",38,0)
 E  I WHAT="POV" D
"RTN","PXBAPI1",39,0)
 . ;-- Diagnoses
"RTN","PXBAPI1",40,0)
 . D POV(.PXBEXIT)
"RTN","PXBAPI1",41,0)
 E  I WHAT="STP" D
"RTN","PXBAPI1",42,0)
 . ;-- Stop Codes
"RTN","PXBAPI1",43,0)
 . D STP(.PXBEXIT)
"RTN","PXBAPI1",44,0)
 E  S PXBEXIT=-3 W !,"Procedure ""INTV^PXAPI"" was called incorrectly, contact IRM."
"RTN","PXBAPI1",45,0)
 Q
"RTN","PXBAPI1",46,0)
 ;
"RTN","PXBAPI1",47,0)
ADDEDIT ;
"RTN","PXBAPI1",48,0)
 N ANS
"RTN","PXBAPI1",49,0)
ADDEDIT1 ;
"RTN","PXBAPI1",50,0)
 D ADQ(.PXBEXIT)
"RTN","PXBAPI1",51,0)
 G:PXBEXIT<1 ADDEDIT2
"RTN","PXBAPI1",52,0)
 D PRV(.PXBEXIT)
"RTN","PXBAPI1",53,0)
 G:PXBEXIT<1 ADDEDIT2
"RTN","PXBAPI1",54,0)
 D POV(.PXBEXIT)
"RTN","PXBAPI1",55,0)
 G:PXBEXIT<1 ADDEDIT2
"RTN","PXBAPI1",56,0)
 ;
"RTN","PXBAPI1",57,0)
 ;Call to CPT is not determined by a credit stop code any more
"RTN","PXBAPI1",58,0)
 ;
"RTN","PXBAPI1",59,0)
 D CPT(.PXBEXIT)
"RTN","PXBAPI1",60,0)
 G:PXBEXIT<1 ADDEDIT2
"RTN","PXBAPI1",61,0)
ADDEDIT2 ;
"RTN","PXBAPI1",62,0)
 I PXBVST>0,'$D(^AUPNVCPT("AD",PXBVST)),'$D(^AUPNVSIT("AD",PXBVST)) D  I ANS'=1 S PXBEXIT=1 G ADDEDIT1
"RTN","PXBAPI1",63,0)
 . N DIR,X,Y
"RTN","PXBAPI1",64,0)
 . W !!
"RTN","PXBAPI1",65,0)
 . S DIR(0)="Y"
"RTN","PXBAPI1",66,0)
 . S DIR("A",1)="Must have a STOP CODE or a PROCEDURE to complete this action."
"RTN","PXBAPI1",67,0)
 . S DIR("A")="Do you want to delete this encounter"
"RTN","PXBAPI1",68,0)
 . S DIR("B")="NO"
"RTN","PXBAPI1",69,0)
 . D ^DIR
"RTN","PXBAPI1",70,0)
 . S ANS=Y
"RTN","PXBAPI1",71,0)
 . Q:ANS'=1
"RTN","PXBAPI1",72,0)
 . I $$DELVFILE^PXAPIDEL("ALL",PXBVST,"","","","","")=1 S PXBEXIT=-1
"RTN","PXBAPI1",73,0)
 I PXBVST>0,'$D(^AUPNVSIT(PXBVST,0)) S PXBVST=""
"RTN","PXBAPI1",74,0)
 Q
"RTN","PXBAPI1",75,0)
 ;
"RTN","PXBAPI1",76,0)
ADQ(PXBEXIT) ;Ask the Administration questions
"RTN","PXBAPI1",77,0)
 I PXBVST'>0 D
"RTN","PXBAPI1",78,0)
 . ;This is only done for new visits
"RTN","PXBAPI1",79,0)
 . I PXBPAT'>0 S PXBPAT=$$ASKPAT I PXBPAT'>0 S PXBEXIT=-1 Q
"RTN","PXBAPI1",80,0)
 . S DFN=PXBPAT
"RTN","PXBAPI1",81,0)
 . I PXBHLOC'>0 S PXBHLOC=$$ASKHL I PXBHLOC'>0 S PXBEXIT=-1 Q
"RTN","PXBAPI1",82,0)
 . S PXBVSTDT=$S(PXBAPPT>0:PXBAPPT,1:$$ASKDT) I PXBVSTDT'>0 S PXBEXIT=-1 Q
"RTN","PXBAPI1",83,0)
 . I PXBAPPT'>0&PXBHLOC'=+$G(^DPT(PXBPAT,"S",PXBVSTDT,0)) D
"RTN","PXBAPI1",84,0)
 .. ;This is only done if there is no appointment.
"RTN","PXBAPI1",85,0)
 .. S PXELAP=$$ELAP^SDPCE(PXBPAT,PXBHLOC)
"RTN","PXBAPI1",86,0)
 I PXBEXIT'<1,PXBHLOC'>0 S PXBHLOC=$$ASKHL I PXBHLOC'>0 S PXBEXIT=-1 Q
"RTN","PXBAPI1",87,0)
 I PXBEXIT'<1 D CODT(.PXBEXIT)
"RTN","PXBAPI1",88,0)
 I PXBEXIT'<1 D SCC(.PXBEXIT)
"RTN","PXBAPI1",89,0)
 I PXBEXIT'<1 D
"RTN","PXBAPI1",90,0)
 . D VISIT(.PXBEXIT)
"RTN","PXBAPI1",91,0)
 . I PXBVST'>0 S PXBEXIT=-2 Q
"RTN","PXBAPI1",92,0)
 Q
"RTN","PXBAPI1",93,0)
 ;
"RTN","PXBAPI1",94,0)
ASKPAT() ;Ask user for a patient
"RTN","PXBAPI1",95,0)
 ;DIC on file 9000001
"RTN","PXBAPI1",96,0)
 N DIR,DIC,Y,X,DA
"RTN","PXBAPI1",97,0)
 S DIR(0)="P^9000001:AEMQ"
"RTN","PXBAPI1",98,0)
 S DIR("A")="Patient Name"
"RTN","PXBAPI1",99,0)
 D ^DIR
"RTN","PXBAPI1",100,0)
 Q $S(+Y>0:+Y,1:-1)
"RTN","PXBAPI1",101,0)
 ;
"RTN","PXBAPI1",102,0)
ASKHL() ;Ask user for a Hospital Location
"RTN","PXBAPI1",103,0)
ASKHL2 ;DIC on file 44
"RTN","PXBAPI1",104,0)
 N DIR,DIC,Y,X,DA
"RTN","PXBAPI1",105,0)
 S DIR(0)="PA^44:AEMQ"
"RTN","PXBAPI1",106,0)
 S DIR("A")="Clinic: "
"RTN","PXBAPI1",107,0)
 ; not occasion of service and not dispositioning
"RTN","PXBAPI1",108,0)
 ;I PXALHLOC S DIR("S")="I '+$G(^(""OOS""))&'$O(^PX(815,1,""DHL"",""B"",Y,0))"
"RTN","PXBAPI1",109,0)
 ; not occasion of service only   ;PX*1.0*116
"RTN","PXBAPI1",110,0)
 I PXALHLOC S DIR("S")="I '+$G(^(""OOS""))"   ;PX*1.0*116
"RTN","PXBAPI1",111,0)
 ; only clinic that are not occasion of service and not dispositioning
"RTN","PXBAPI1",112,0)
 ;E  S DIR("S")="I $P(^(0),U,3)=""C""&'+$G(^(""OOS""))&'$O(^PX(815,1,""DHL"",""B"",Y,0))"
"RTN","PXBAPI1",113,0)
 E  S DIR("S")="I $P(^(0),U,3)=""C""&'+$G(^(""OOS""))"   ;PX*1.0*116
"RTN","PXBAPI1",114,0)
 D ^DIR
"RTN","PXBAPI1",115,0)
 ;enable to select a disposition clinic   ;PX*1.0*116
"RTN","PXBAPI1",116,0)
 ;I $D(^PX(815,1,"DHL","B",+Y)) D HELPDISP^PXCEVSIT W !,$C(7) G ASKHL2
"RTN","PXBAPI1",117,0)
 Q $S(+Y>0:+Y,1:-1)
"RTN","PXBAPI1",118,0)
 ;
"RTN","PXBAPI1",119,0)
ASKDT() ;Ask user for the encounter Date/Time
"RTN","PXBAPI1",120,0)
 N DIR,Y,X,DA
"RTN","PXBAPI1",121,0)
 S DIR(0)="D^"_$S(PXLIMDT>2960000:PXLIMDT,1:"")_":"_(DT+.24)_":AEPRSX"
"RTN","PXBAPI1",122,0)
 S DIR("A")="Encounter Date and Time"
"RTN","PXBAPI1",123,0)
 S DIR("?")="Enter the Date and Time of this encounter"
"RTN","PXBAPI1",124,0)
 D ^DIR
"RTN","PXBAPI1",125,0)
 Q $S(+Y>0:+Y,1:-1)
"RTN","PXBAPI1",126,0)
 ;
"RTN","PXBAPI1",127,0)
CODT(PXBEXIT) ;Ask the user the Check out Date/Time
"RTN","PXBAPI1",128,0)
 N PXCHKOUT
"RTN","PXBAPI1",129,0)
 D CHIKOUT^PXBAPI2("",PXBPAT,PXBHLOC,PXBVSTDT)
"RTN","PXBAPI1",130,0)
 S PXBCODT=PXCHKOUT
"RTN","PXBAPI1",131,0)
 S:PXCHKOUT=-1 PXBCODT=""
"RTN","PXBAPI1",132,0)
 ;; PX*1*113 - Change for EAS*1*3 Appointment processing removed
"RTN","PXBAPI1",133,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T D  Q:PXBEXIT<1
"RTN","PXBAPI1",134,0)
 ;. S:$G(EASACT)'="W" EASACT="C"
"RTN","PXBAPI1",135,0)
 ;. I $$MT^EASMTCHK(PXBPAT,"",EASACT,PXBVSTDT) D  S PXBEXIT=-1
"RTN","PXBAPI1",136,0)
 ;. . D PAUSE^VALM1
"RTN","PXBAPI1",137,0)
 I WHAT'["ADDEDIT",PXCHKOUT=-1 S PXBEXIT=-1
"RTN","PXBAPI1",138,0)
 I $G(PXBVST),$$DISPOSIT^PXUTL1(DFN,$P($G(^AUPNVSIT(PXBVST,0)),"^",1),PXBVST) S PXBEXIT=1
"RTN","PXBAPI1",139,0)
 Q
"RTN","PXBAPI1",140,0)
 ;
"RTN","PXBAPI1",141,0)
SCC(PXBEXIT) ;Ask the user the Service connected conditions
"RTN","PXBAPI1",142,0)
 N PXBDATA,PXBCLASS,PXBOUTEN,PXDOD
"RTN","PXBAPI1",143,0)
 S (PXBOUTEN,PXDOD)=""
"RTN","PXBAPI1",144,0)
 ;I $$APPOINT^PXUTL1(PXBPAT,PXBVSTDT,PXBHLOC) D
"RTN","PXBAPI1",145,0)
 ;. S PXBOUTEN=$P($G(^DPT(+PXBPAT,"S",+PXBVSTDT,0)),"^",20)
"RTN","PXBAPI1",146,0)
 ;E  I $$DISPOSIT^PXUTL1(PXBPAT,PXBVSTDT,PXBVST) D
"RTN","PXBAPI1",147,0)
 ;. S PXBOUTEN=+$P($G(^DPT(+PXBPAT,"DIS",9999999-PXBVSTDT,0)),"^",18)
"RTN","PXBAPI1",148,0)
 ;I 'PXBOUTEN,$G(PXBVST)>0 S PXBOUTEN=$O(^SCE("AVSIT",PXBVST,0))
"RTN","PXBAPI1",149,0)
 ;D CLASS^PXBAPI21(PXBOUTEN,PXBPAT,PXBVSTDT,PXBHLOC)
"RTN","PXBAPI1",150,0)
 D CLASS^PXBAPI21(PXBOUTEN,PXBPAT,PXBVSTDT,PXBHLOC,PXBVST)
"RTN","PXBAPI1",151,0)
 ;PX*1*111 - Add HNC
"RTN","PXBAPI1",152,0)
 F PXBCLASS=1:1:7 I $G(PXBDATA("ERR",PXBCLASS))=4 S PXBEXIT=-1 Q  ; changed 6/17/98 for MST enhancement
"RTN","PXBAPI1",153,0)
 Q:PXBEXIT<1
"RTN","PXBAPI1",154,0)
 I $G(PXDOD) S PXBEXIT=-1 Q
"RTN","PXBAPI1",155,0)
 S PXB800(1)=$P($G(PXBDATA(3)),"^",2)
"RTN","PXBAPI1",156,0)
 S PXB800(2)=$P($G(PXBDATA(1)),"^",2)
"RTN","PXBAPI1",157,0)
 S PXB800(3)=$P($G(PXBDATA(2)),"^",2)
"RTN","PXBAPI1",158,0)
 S PXB800(4)=$P($G(PXBDATA(4)),"^",2)
"RTN","PXBAPI1",159,0)
 S PXB800(5)=$P($G(PXBDATA(5)),"^",2) ;added 6/17/98 for MST enhancement
"RTN","PXBAPI1",160,0)
 ;PX*1*111 - Add HNC
"RTN","PXBAPI1",161,0)
 S PXB800(6)=$P($G(PXBDATA(6)),"^",2)
"RTN","PXBAPI1",162,0)
 S PXB800(7)=$P($G(PXBDATA(7)),"^",2)
"RTN","PXBAPI1",163,0)
 Q
"RTN","PXBAPI1",164,0)
 ;
"RTN","PXBAPI1",165,0)
VISIT(PXBEXIT) ;Creat or edit the Visit
"RTN","PXBAPI1",166,0)
 ;Set up ^TMP("PXK",$J and call PXK
"RTN","PXBAPI1",167,0)
 I PXBVST>0 L +^AUPNVSIT(PXBVST):10 E  W !!,$C(7),"Cannot edit at this time, try again later." D WAIT^PXCEHELP S PXBEXIT=-2 Q
"RTN","PXBAPI1",168,0)
 K ^TMP("PXK",$J)
"RTN","PXBAPI1",169,0)
 N PXBNODE,PXBAFTER,PXKERROR
"RTN","PXBAPI1",170,0)
 F PXBNODE=0,21,150,800,811,812 D
"RTN","PXBAPI1",171,0)
 . S PXBAFTER(PXBNODE)=$S(PXBVST>0:$G(^AUPNVSIT(PXBVST,PXBNODE)),1:"")
"RTN","PXBAPI1",172,0)
 . S ^TMP("PXK",$J,"VST",1,PXBNODE,"BEFORE")=PXBAFTER(PXBNODE)
"RTN","PXBAPI1",173,0)
 I PXBVST'>0 D
"RTN","PXBAPI1",174,0)
 . S $P(PXBAFTER(0),"^",1)=PXBVSTDT
"RTN","PXBAPI1",175,0)
 . S $P(PXBAFTER(0),"^",5)=PXBPAT
"RTN","PXBAPI1",176,0)
 . S $P(PXBAFTER(0),"^",8)=$P(^SC(PXBHLOC,0),"^",7)
"RTN","PXBAPI1",177,0)
 . S:PXBAPPT>0 $P(PXBAFTER(0),"^",16)="A"
"RTN","PXBAPI1",178,0)
 . S $P(PXBAFTER(150),"^",3)="P"
"RTN","PXBAPI1",179,0)
 . S $P(PXBAFTER(812),"^",2)=PXBPKG
"RTN","PXBAPI1",180,0)
 . S $P(PXBAFTER(812),"^",3)=PXBSOURC
"RTN","PXBAPI1",181,0)
 S $P(PXBAFTER(0),"^",18)=$G(PXBCODT)
"RTN","PXBAPI1",182,0)
 S:$P(PXBAFTER(0),"^",22)="" $P(PXBAFTER(0),"^",22)=PXBHLOC
"RTN","PXBAPI1",183,0)
 S $P(PXBAFTER(800),"^",1)=$G(PXB800(1))
"RTN","PXBAPI1",184,0)
 S $P(PXBAFTER(800),"^",2)=$G(PXB800(2))
"RTN","PXBAPI1",185,0)
 S $P(PXBAFTER(800),"^",3)=$G(PXB800(3))
"RTN","PXBAPI1",186,0)
 S $P(PXBAFTER(800),"^",4)=$G(PXB800(4))
"RTN","PXBAPI1",187,0)
 S $P(PXBAFTER(800),"^",5)=$G(PXB800(5)) ;added 6/17/98 for MST emhancement
"RTN","PXBAPI1",188,0)
 ;PX*1*111 - Add HNC
"RTN","PXBAPI1",189,0)
 S $P(PXBAFTER(800),"^",6)=$G(PXB800(6))
"RTN","PXBAPI1",190,0)
 S $P(PXBAFTER(800),"^",7)=$G(PXB800(7))
"RTN","PXBAPI1",191,0)
 I $D(PXELAP)#2 D
"RTN","PXBAPI1",192,0)
 . S $P(PXBAFTER(0),"^",21)=+PXELAP
"RTN","PXBAPI1",193,0)
 F PXBNODE=0,21,150,800,811,812 D
"RTN","PXBAPI1",194,0)
 . S ^TMP("PXK",$J,"VST",1,PXBNODE,"AFTER")=PXBAFTER(PXBNODE)
"RTN","PXBAPI1",195,0)
 S ^TMP("PXK",$J,"VST",1,"IEN")=$S(PXBVST>0:PXBVST,1:"")
"RTN","PXBAPI1",196,0)
 S ^TMP("PXK",$J,"SOR")=PXBSOURC
"RTN","PXBAPI1",197,0)
 D EN1^PXKMAIN
"RTN","PXBAPI1",198,0)
 I PXBVST>0 L -^AUPNVSIT(PXBVST):5
"RTN","PXBAPI1",199,0)
 S PXBVST=$G(^TMP("PXK",$J,"VST",1,"IEN"))
"RTN","PXBAPI1",200,0)
 Q
"RTN","PXBAPI1",201,0)
 ;
"RTN","PXBAPI1",202,0)
CPT(PXBEXIT) ;Ask the user Providers and CTPs
"RTN","PXBAPI1",203,0)
 D CPT^PXBMCPT(PXBVST) K PRVDR
"RTN","PXBAPI1",204,0)
 Q
"RTN","PXBAPI1",205,0)
 ;
"RTN","PXBAPI1",206,0)
POV(PXBEXIT) ;Ask the user Diagnoses
"RTN","PXBAPI1",207,0)
 D POV^PXBMPOV(PXBVST) K PRVDR
"RTN","PXBAPI1",208,0)
 Q
"RTN","PXBAPI1",209,0)
 ;
"RTN","PXBAPI1",210,0)
PRV(PXBEXIT) ;Ask the user Providers
"RTN","PXBAPI1",211,0)
 D PRV^PXBMPRV(PXBVST,"PRV") K PRVDR
"RTN","PXBAPI1",212,0)
 Q
"RTN","PXBAPI1",213,0)
 ;
"RTN","PXBAPI1",214,0)
STP(PXBEXIT) ;Ask the user Stop Codes
"RTN","PXBAPI1",215,0)
 I $L($T(DATE^SCDXUTL)),$$DATE^SCDXUTL(+$G(^AUPNVSIT(PXBVST,0))) Q
"RTN","PXBAPI1",216,0)
 D STP^PXBMSTP(PXBVST) K PRVDR
"RTN","PXBAPI1",217,0)
 Q
"RTN","PXBAPI1",218,0)
 ;
"RTN","PXBAPI21")
0^5^B12380612
"RTN","PXBAPI21",1,0)
PXBAPI21 ;ISL/DCM - API for Classification check out ;7/25/96  15:04
"RTN","PXBAPI21",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**130,147**;Aug 12, 1996
"RTN","PXBAPI21",3,0)
CLASS(ENCOWNTR,DFN,APTDT,LOC,VISIT) ;Edit classification fields
"RTN","PXBAPI21",4,0)
 ; Input  - ENCOWNTR - ien of ^SCE(ien (409.68 Outpatient Encounter file)
"RTN","PXBAPI21",5,0)
 ;          ENCOWNTR optional if DFN,LOC,APTDT params used
"RTN","PXBAPI21",6,0)
 ;          DFN - ien of ^DPT(DFN, (only used if no ENCOWNTR)
"RTN","PXBAPI21",7,0)
 ;          LOC - ien of ^SC(LOC,  (only used if no ENCOWNTR)
"RTN","PXBAPI21",8,0)
 ;          APTDT - Appointment Date/time (only used if no ENCOWNTR)
"RTN","PXBAPI21",9,0)
 ;          VISIT - optional if no ENCOWNTR look for main encounter that
"RTN","PXBAPI21",10,0)
 ;                  points to this visit
"RTN","PXBAPI21",11,0)
 ; Output - PXBDATA(Classification type)=OutPT Class ien^Value
"RTN","PXBAPI21",12,0)
 ;          PXBDATA("ERR",Class type)=1 Bad ptr to 409.41
"RTN","PXBAPI21",13,0)
 ;                                    =2 DATA entry not applicable
"RTN","PXBAPI21",14,0)
 ;                                    =3 DATA entry uneditable
"RTN","PXBAPI21",15,0)
 ;                                    =4 User ^ out of prompt
"RTN","PXBAPI21",16,0)
 ;            Classification type 1 - Agent Orange
"RTN","PXBAPI21",17,0)
 ;                                2 - Ionizing Radiation
"RTN","PXBAPI21",18,0)
 ;                                3 - Service Connected
"RTN","PXBAPI21",19,0)
 ;                                4 - Environmental Contaminants
"RTN","PXBAPI21",20,0)
 ;                                5 - Military Sexual Trauma
"RTN","PXBAPI21",21,0)
 ;                                6 - Head and/or Neck Cancer
"RTN","PXBAPI21",22,0)
 ;                                7 - Combat Veteran
"RTN","PXBAPI21",23,0)
 ;                                
"RTN","PXBAPI21",24,0)
 ; Ext References: ^SCE(DA,0)              INP^SDAM2
"RTN","PXBAPI21",25,0)
 ;                 REQ^SDM1A               CLINIC^SDAMU
"RTN","PXBAPI21",26,0)
 ;                 EXOE^SDCOU2             CLOE^SDCO21
"RTN","PXBAPI21",27,0)
 ;                 SEQ^SDCO21              CL^SDCO21
"RTN","PXBAPI21",28,0)
 ;   In ^PXBAPI22
"RTN","PXBAPI21",29,0)
 ;                 ^DG(43,1,"SCLR")  piece 24
"RTN","PXBAPI21",30,0)
 ;                 ^SD(409.41,DA,0)        ^SD(409.41,DA,2)
"RTN","PXBAPI21",31,0)
 ;                 VAL^SDCODD              SC^SDCO23
"RTN","PXBAPI21",32,0)
 I $G(ENCOWNTR)'>0,$G(VISIT)>0 D
"RTN","PXBAPI21",33,0)
 . S ENCOWNTR=$O(^SCE("AVSIT",VISIT,0))
"RTN","PXBAPI21",34,0)
 . I ENCOWNTR,$P(^SCE(ENCOWNTR,0),"^",6) S ENCOWNTR=$P(^SCE(ENCOWNTR,0),"^",6)
"RTN","PXBAPI21",35,0)
 N IEN,IFN,SDCLOEY,ORG,END,DA,X,SQUIT
"RTN","PXBAPI21",36,0)
 I $G(ENCOWNTR) Q:'$D(^SCE(+ENCOWNTR,0))  N APTDT,DFN,LOC S END=0,X0=^(0) D ENCHK(ENCOWNTR,X0) Q:END  G ON
"RTN","PXBAPI21",37,0)
 Q:'$G(DFN)!'$G(LOC)!'$G(APTDT)
"RTN","PXBAPI21",38,0)
 S X=$G(^DPT(DFN,"S",APTDT,0))
"RTN","PXBAPI21",39,0)
 I +X,+X=LOC,$P(X,"^",20),$D(^SCE($P(X,"^",20),0)) S ENCOWNTR=$P(X,"^",20),END=0,X0=^(0) D ENCHK(ENCOWNTR,X0) Q:END  G ON
"RTN","PXBAPI21",40,0)
ON D ASKCL($G(ENCOWNTR),.SDCLOEY,DFN,APTDT)
"RTN","PXBAPI21",41,0)
 I '$D(SDCLOEY) Q
"RTN","PXBAPI21",42,0)
 I $D(SDCLOEY) D ASK($G(ENCOWNTR),.SDCLOEY,.SQUIT) Q:$D(SQUIT)
"RTN","PXBAPI21",43,0)
 Q
"RTN","PXBAPI21",44,0)
ASKCL(ENCOWNTR,SDCLOEY,DFN,APTDT) ;Ask classifications on check out
"RTN","PXBAPI21",45,0)
 I $G(ENCOWNTR) D CLOE^SDCO21(ENCOWNTR,.SDCLOEY) Q
"RTN","PXBAPI21",46,0)
 D CL^SDCO21(DFN,APTDT,"",.SDCLOEY)
"RTN","PXBAPI21",47,0)
 Q
"RTN","PXBAPI21",48,0)
ASK(ENCOWNTR,SDCLOEY,SQUIT) ;Ask classifications
"RTN","PXBAPI21",49,0)
 N I,IOINHI,IOINORM,TYPI,TYPSEQ,CTS,X
"RTN","PXBAPI21",50,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PXBAPI21",51,0)
 I '$D(SDCLOEY) Q
"RTN","PXBAPI21",52,0)
 W !!,"--- ",IOINHI,"Classification",IOINORM," --- [",IOINHI,"Required",IOINORM,"]"
"RTN","PXBAPI21",53,0)
 W ! S TYPSEQ=$$SEQ^SDCO21 ;Get classification type sequence (3,1,2,4)
"RTN","PXBAPI21",54,0)
 F CTS=1:1 S TYPI=+$P(TYPSEQ,",",CTS) Q:'TYPI!($D(SQUIT))  D
"RTN","PXBAPI21",55,0)
 .I $D(SDCLOEY(TYPI)) D
"RTN","PXBAPI21",56,0)
 ..D ONE^PXBAPI22(TYPI,SDCLOEY(TYPI),ENCOWNTR,.SQUIT)
"RTN","PXBAPI21",57,0)
 ..I TYPI=3 F I=1,2,4 S:$D(SDCLOEY(I))&($P($G(PXBDATA(3)),"^",2)=1) $P(SDCLOEY(I),"^",3)=1 S:$P($G(PXBDATA(3)),"^",2)=0&('$D(SDCLOEY(I))) SDCLOEY(I)=""
"RTN","PXBAPI21",58,0)
 Q
"RTN","PXBAPI21",59,0)
ENCHK(ENCOWNTR,X0) ;Do outpatient encounter checks
"RTN","PXBAPI21",60,0)
 S APTDT=+X0,DFN=$P(X0,"^",2),LOC=$P(X0,"^",4),ORG=$P(X0,"^",8),DA=$P(X0,"^",9)
"RTN","PXBAPI21",61,0)
 I +$G(VADM(6)),+$G(VADM(6))<APTDT D  K DIR I $D(DIRUT) S (PXDOD,END)=1 Q
"RTN","PXBAPI21",62,0)
 . S DIR(0)="E",DIR("A")="Enter RETURN to continue or '^' to Quit"
"RTN","PXBAPI21",63,0)
 . S DIR("A",2)="WARNING "_VADM(7),DIR("A",1)=" ",DIR("A",3)=" " D ^DIR
"RTN","PXBAPI21",64,0)
 I $$REQ^SDM1A(+X0)'="CO" S END=1 Q  ;Check MAS Check out date parameter
"RTN","PXBAPI21",65,0)
 I ORG=1,'$$CLINIC^SDAMU(+LOC) S END=1 Q  ;Screen for valid clinic
"RTN","PXBAPI21",66,0)
 I "^1^2^"[("^"_ORG_"^"),$$INP^SDAM2(+DFN,+X0)="I" S END=1 Q  ;Inpat chk
"RTN","PXBAPI21",67,0)
 I $$EXOE^SDCOU2(ENCOWNTR) S END=1 Q  ;Chk exempt Outpt classifications
"RTN","PXBAPI21",68,0)
 Q
"RTN","PXBAPI21",69,0)
TEST ;Test call to CLASS
"RTN","PXBAPI21",70,0)
 N PXIFN S PXIFN=63
"RTN","PXBAPI21",71,0)
 F  S PXIFN=$O(^SCE(PXIFN)) Q:PXIFN<1  S DFN=$P(^(PXIFN,0),"^",2) K PXBDATA W !!,PXIFN_"   "_$P(^DPT(DFN,0),"^") D  S %=1 W !,"Continue " D YN^DICN Q:%'=1
"RTN","PXBAPI21",72,0)
 . D CLASS(PXIFN)
"RTN","PXBAPI21",73,0)
 . ;W ! ZW PXBDATA
"RTN","PXBAPI21",74,0)
 Q
"RTN","PXCE")
0^11^B61867490
"RTN","PXCE",1,0)
PXCE ;ISL/dee - Main routine for PCE's user interface ; 3/27/01 12:17pm
"RTN","PXCE",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**25,47,52,64,75,78,147**;Aug 12, 1996
"RTN","PXCE",3,0)
 ;
"RTN","PXCE",4,0)
 ;PXCEKEYS is a set of letters that enable the user
"RTN","PXCE",5,0)
 ;  to enter certain fields
"RTN","PXCE",6,0)
 ;  "P" is included if the user holds the AK.PROVIDER key.
"RTN","PXCE",7,0)
 ;  "C" should be included by the option if the user should be
"RTN","PXCE",8,0)
 ;    asked for the Provider Narrative Categories on V CPT, V POV,
"RTN","PXCE",9,0)
 ;    and V TREATMENT files.  As well as for  other fields that are
"RTN","PXCE",10,0)
 ;    not ask of the normal user.
"RTN","PXCE",11,0)
 ;  "S" is for the superviser.  If they have "S" then they will be 
"RTN","PXCE",12,0)
 ;    given "C" and "D" by the program.
"RTN","PXCE",13,0)
 ;  "V" is for view only
"RTN","PXCE",14,0)
 ; And if it:
"RTN","PXCE",15,0)
 ;  includes "D" to delete any V-File
"RTN","PXCE",16,0)
 ;  includes "d" to only delete V-File entries this user created
"RTN","PXCE",17,0)
 ;
"RTN","PXCE",18,0)
 I '$D(PXCEKEYS)#2 N PXCEKEYS S PXCEKEYS=""
"RTN","PXCE",19,0)
 S:PXCEKEYS'["D" PXCEKEYS=PXCEKEYS_"D"
"RTN","PXCE",20,0)
 G START
"RTN","PXCE",21,0)
 ; -- main entry point for PCE's user interface
"RTN","PXCE",22,0)
EN1(PXCEKEYS) ;Does not checks for provider
"RTN","PXCE",23,0)
 G START1
"RTN","PXCE",24,0)
EN(PXCEKEYS) ;Checks for provider
"RTN","PXCE",25,0)
 ;
"RTN","PXCE",26,0)
START ;
"RTN","PXCE",27,0)
 ;Key for provider (P)
"RTN","PXCE",28,0)
 I PXCEKEYS'["P",$O(^VA(200,"AK.PROVIDER",$P(^VA(200,DUZ,0),"^"),""))=DUZ S PXCEKEYS=PXCEKEYS_"P"
"RTN","PXCE",29,0)
START1 ;
"RTN","PXCE",30,0)
 ;If they have the Key for superviser (S) make sure that they also
"RTN","PXCE",31,0)
 ;  have C and D.
"RTN","PXCE",32,0)
 I PXCEKEYS["S" S:PXCEKEYS'["C" PXCEKEYS=PXCEKEYS_"C" S:PXCEKEYS'["D" PXCEKEYS=PXCEKEYS_"D"
"RTN","PXCE",33,0)
 ;
"RTN","PXCE",34,0)
 K I,X,SDB,XQORNOD,SDFN,SDCLN,DA,DR,DIE,DNM,DQ,%B
"RTN","PXCE",35,0)
 N PXCEVIEW,SDAMTYP
"RTN","PXCE",36,0)
 N PXCEPAT,PXCEHLOC
"RTN","PXCE",37,0)
 N PXCEDBEG,PXCEDEND,PXCE9BEG,PXCE9END,SDBEG,SDEND
"RTN","PXCE",38,0)
 N PXCEDBP,PXCEDBHL,PXCEDEP,PXCEDEHL
"RTN","PXCE",39,0)
 N PXCECONT
"RTN","PXCE",40,0)
 N PXCESOR,PXCEPKG
"RTN","PXCE",41,0)
 I $G(DFN)'>0 N DFN
"RTN","PXCE",42,0)
 ;
"RTN","PXCE",43,0)
 S PXCEVIEW="^"_$S("~V~A~"["~"_$P(^PX(815,1,"LM"),"^",2)_"~":$P(^PX(815,1,"LM"),"^",2),1:"V")_"^"
"RTN","PXCE",44,0)
 S PXCESOR=$$SOURCE^PXAPIUTL("PXCE DATA ENTRY")
"RTN","PXCE",45,0)
 S PXCEPKG=$$PKG2IEN^VSIT("PX")
"RTN","PXCE",46,0)
 ;
"RTN","PXCE",47,0)
 K DIRUT
"RTN","PXCE",48,0)
 D SETUP Q:$D(DIRUT)
"RTN","PXCE",49,0)
 ;
"RTN","PXCE",50,0)
 F  D  Q:$D(PXCEVIEW)'=1!'$D(PXCECONT)
"RTN","PXCE",51,0)
 . K PXCECONT
"RTN","PXCE",52,0)
 . I PXCEKEYS["V" D
"RTN","PXCE",53,0)
 .. I PXCEVIEW["A" D
"RTN","PXCE",54,0)
 ... D EN^VALM("PXCE SDAM VIEW ONLY")
"RTN","PXCE",55,0)
 .. E  D EN^VALM("PXCE VIEW ONLY")
"RTN","PXCE",56,0)
 . E  I PXCEVIEW["A" D
"RTN","PXCE",57,0)
 .. D EN^VALM("PXCE SDAM MENU")
"RTN","PXCE",58,0)
 . E  D EN^VALM("PXCE MAIN MENU")
"RTN","PXCE",59,0)
 D FULL^VALM1
"RTN","PXCE",60,0)
 D EXITALL
"RTN","PXCE",61,0)
 Q
"RTN","PXCE",62,0)
 ;
"RTN","PXCE",63,0)
SETUP ;
"RTN","PXCE",64,0)
 N DIR,DA,X,Y
"RTN","PXCE",65,0)
 N PXCEUSEL,X1,X2
"RTN","PXCE",66,0)
 I $G(DFN)>0 S PXCEUSEL=DFN_"^DPT("
"RTN","PXCE",67,0)
 E  S DIR(0)="815,201",DIR("A")="Select Patient or Clinic name" D ^DIR K DIR,DA Q:$D(DIRUT)  S PXCEUSEL=Y
"RTN","PXCE",68,0)
 S X1=DT,X2=$S($P(^PX(815,1,"LM"),"^",3)]"":$P(^PX(815,1,"LM"),"^",3),1:-30) D C^%DTC
"RTN","PXCE",69,0)
 S PXCEDBP=X
"RTN","PXCE",70,0)
 S X1=DT,X2=$S($P(^PX(815,1,"LM"),"^",4)]"":$P(^PX(815,1,"LM"),"^",4),1:0) D C^%DTC
"RTN","PXCE",71,0)
 S PXCEDEP=X
"RTN","PXCE",72,0)
 S X1=DT,X2=$S($P(^PX(815,1,"LM"),"^",5)]"":$P(^PX(815,1,"LM"),"^",5),1:-7) D C^%DTC
"RTN","PXCE",73,0)
 S PXCEDBHL=X
"RTN","PXCE",74,0)
 S X1=DT,X2=$S($P(^PX(815,1,"LM"),"^",6)]"":$P(^PX(815,1,"LM"),"^",6),1:0) D C^%DTC
"RTN","PXCE",75,0)
 S PXCEDEHL=X
"RTN","PXCE",76,0)
 I PXCEUSEL["DPT(" S $P(PXCEVIEW,"^",1)="P" S SDAMTYP="P"
"RTN","PXCE",77,0)
 I PXCEUSEL["SC(" S $P(PXCEVIEW,"^",1)="H" S SDAMTYP="C"
"RTN","PXCE",78,0)
 D SETDATES
"RTN","PXCE",79,0)
 I PXCEUSEL["DPT(" S PXCEPAT=+PXCEUSEL D NEWPAT1^PXCEPAT G:$D(DIRUT) SETUP
"RTN","PXCE",80,0)
 I PXCEUSEL["SC(" S PXCEHLOC=+PXCEUSEL D NEWHOSL1^PXCENEW
"RTN","PXCE",81,0)
 Q
"RTN","PXCE",82,0)
 ;
"RTN","PXCE",83,0)
SETDATES ;
"RTN","PXCE",84,0)
 I PXCEVIEW["H" D
"RTN","PXCE",85,0)
 . S PXCEDBEG=PXCEDBHL
"RTN","PXCE",86,0)
 . S PXCEDEND=PXCEDEHL
"RTN","PXCE",87,0)
 E  D
"RTN","PXCE",88,0)
 . S PXCEDBEG=PXCEDBP
"RTN","PXCE",89,0)
 . S PXCEDEND=PXCEDEP
"RTN","PXCE",90,0)
 D DATE9S^PXCEDATE
"RTN","PXCE",91,0)
 Q
"RTN","PXCE",92,0)
 ;
"RTN","PXCE",93,0)
HDR ; -- header code
"RTN","PXCE",94,0)
 K VALMHDR,PXLNX,PXPCP
"RTN","PXCE",95,0)
 S PXLNX=1,PXPCP=""
"RTN","PXCE",96,0)
 ;
"RTN","PXCE",97,0)
 ;PATIENT
"RTN","PXCE",98,0)
 I PXCEVIEW["P" D
"RTN","PXCE",99,0)
 . S PXPCP=$$PCLINE^SDPPTEM(PXCEPAT,DT)
"RTN","PXCE",100,0)
 . S VALMHDR(PXLNX)=$E(PXCEPAT("NAME"),1,26)
"RTN","PXCE",101,0)
 . S VALMHDR(PXLNX)=$E(VALMHDR(PXLNX)_$E("    ",1,(27-$L(VALMHDR(PXLNX))))_PXCEPAT("SSN")_"                                           ",1,40)
"RTN","PXCE",102,0)
 E  S VALMHDR(PXLNX)="                                        "
"RTN","PXCE",103,0)
 ;LOCATION
"RTN","PXCE",104,0)
 S VALMHDR(PXLNX)=VALMHDR(PXLNX)_"Clinic:  "_$S($G(PXCEHLOC)&(PXCEVIEW'["P^A"):$P(^SC(PXCEHLOC,0),"^"),1:"All")
"RTN","PXCE",105,0)
 S PXLNX=PXLNX+1
"RTN","PXCE",106,0)
 I $L(PXPCP) S VALMHDR(PXLNX)=PXPCP,PXLNX=PXLNX+1
"RTN","PXCE",107,0)
 ;
"RTN","PXCE",108,0)
 ;DATE
"RTN","PXCE",109,0)
 S VALMHDR(PXLNX)=$E("Date range:  "_$$FMTE^XLFDT(PXCEDBEG,5)_" to "_$$FMTE^XLFDT(PXCEDEND,5)_$J("",40),1,40)
"RTN","PXCE",110,0)
 ;
"RTN","PXCE",111,0)
 ;Credit Stop
"RTN","PXCE",112,0)
 S:PXCEVIEW["A" VALMHDR(PXLNX)=VALMHDR(PXLNX)_$P($G(SDAMLIST),"^",2)
"RTN","PXCE",113,0)
 S PXLNX=PXLNX+1
"RTN","PXCE",114,0)
 ;
"RTN","PXCE",115,0)
 ;CHECK IF GAF NEEDED
"RTN","PXCE",116,0)
 I PXCEVIEW'["P",$$MHCLIN^SDUTL2(PXCEHLOC) S VALMHDR(PXLNX)=$$SETSTR^VALM1("* - New GAF Score Required","",25,80)
"RTN","PXCE",117,0)
 I PXCEVIEW["P" D
"RTN","PXCE",118,0)
 .S VALMHDR(PXLNX)=$$SETSTR^VALM1("* - New GAF Score Required","",25,80)
"RTN","PXCE",119,0)
 .N PXCEHLC,PXCESTA
"RTN","PXCE",120,0)
 .K PXCEHIT
"RTN","PXCE",121,0)
 .S PXCESTA=$$ELSTAT^SDUTL2(PXCEPAT)
"RTN","PXCE",122,0)
 .S PXCEZZ=0
"RTN","PXCE",123,0)
 .F  S PXCEZZ=$O(^TMP("PXCEIDX",$J,PXCEZZ)) Q:PXCEZZ'>0  D  Q:$D(PXCEHIT)
"RTN","PXCE",124,0)
 ..S PXCEHLC=+$P($G(^AUPNVSIT(^TMP("PXCEIDX",$J,PXCEZZ),0)),"^",22)
"RTN","PXCE",125,0)
 ..I $$MHCLIN^SDUTL2(PXCEHLC),'$$COLLAT^SDUTL2(PXCESTA) D
"RTN","PXCE",126,0)
 ...S PXCEGAF=$$NEWGAF^SDUTL2($S($D(SDFN):SDFN,$D(PXCEPAT):PXCEPAT,1:""))
"RTN","PXCE",127,0)
 ...S PXCEGST=$P(PXCEGAF,"^")
"RTN","PXCE",128,0)
 ...I PXCEGST D
"RTN","PXCE",129,0)
 ....S PXCEGDT=$$FMTE^XLFDT($P(PXCEGAF,"^",3),"5M"),PXCEGSC=$P(PXCEGAF,"^",2),PXCEGPR=$P(PXCEGAF,"^",4)
"RTN","PXCE",130,0)
 ....S VALMHDR(PXLNX)="GAF Date: "_PXCEGDT_"  GAF Score:"_PXCEGSC_"   NEW REQ",PXCEHIT=1
"RTN","PXCE",131,0)
 ;
"RTN","PXCE",132,0)
 S VALMSG="+ Next Screen   - Prev Screen   ?? More Actions"
"RTN","PXCE",133,0)
 Q
"RTN","PXCE",134,0)
 ;
"RTN","PXCE",135,0)
INIT ; -- init variables and list array
"RTN","PXCE",136,0)
 D MAKELIST^PXCENEW
"RTN","PXCE",137,0)
 Q
"RTN","PXCE",138,0)
 ;
"RTN","PXCE",139,0)
EXIT ; -- exit code
"RTN","PXCE",140,0)
 D FULL^VALM1
"RTN","PXCE",141,0)
 D CLEAN^VALM10
"RTN","PXCE",142,0)
 K ^TMP("PXCE",$J)
"RTN","PXCE",143,0)
 K ^TMP("PXCEIDX",$J)
"RTN","PXCE",144,0)
 D FNL^PXCESDAM
"RTN","PXCE",145,0)
 Q
"RTN","PXCE",146,0)
 ;
"RTN","PXCE",147,0)
EXITALL ; Exit of whole program
"RTN","PXCE",148,0)
 D PATKILL^PXCEPAT
"RTN","PXCE",149,0)
 D KVA^VADPT
"RTN","PXCE",150,0)
 Q
"RTN","PXCE",151,0)
 ;
"RTN","PXCE",152,0)
DONE ; -- exit action for protocol
"RTN","PXCE",153,0)
 S:'$D(VALMBCK) VALMBCK="R"
"RTN","PXCE",154,0)
 S VALMSG="+ Next Screen   - Prev Screen   ?? More Actions"
"RTN","PXCE",155,0)
 Q
"RTN","PXCE",156,0)
 ;
"RTN","PXCE",157,0)
EXPND ; -- expand code
"RTN","PXCE",158,0)
 D EN^PXCEEXP
"RTN","PXCE",159,0)
 Q
"RTN","PXCE",160,0)
 ;
"RTN","PXCE",161,0)
SEL1(HELP,PXCEADD) ; Select 1 visit
"RTN","PXCE",162,0)
 ; If the $GET(PXCEADD) is non zero then will 
"RTN","PXCE",163,0)
 ;   add to the prompt "add a new encounter"
"RTN","PXCE",164,0)
 N X,Y,MAX
"RTN","PXCE",165,0)
 S MAX=+$G(^TMP("PXCEIDX",$J,0)) I MAX'>0 Q "^"
"RTN","PXCE",166,0)
 S Y=$P($P(XQORNOD(0),"^",4),"=",2)
"RTN","PXCE",167,0)
 I Y]"" D
"RTN","PXCE",168,0)
 . I (+Y'=Y)!(+Y>MAX)!(+Y<1)!(Y#1'=0) D
"RTN","PXCE",169,0)
 .. W !,$C(7),"Selection '",Y,"' is not a valid choice."
"RTN","PXCE",170,0)
 .. D PAUSE^PXCEHELP
"RTN","PXCE",171,0)
 .. S Y="^"
"RTN","PXCE",172,0)
 E  I '$G(PXCEADD) D
"RTN","PXCE",173,0)
 . N DIR,DA
"RTN","PXCE",174,0)
 . S DIR(0)="NAO^1:"_MAX_":0",DIR("A")="Select Encounter"
"RTN","PXCE",175,0)
 . S:MAX>1 DIR("A")=DIR("A")_" (1-"_MAX_"): "
"RTN","PXCE",176,0)
 . S:MAX'>1 DIR("A")=DIR("A")_": ",DIR("B")=1
"RTN","PXCE",177,0)
 . S DIR("?")="Enter the number of the Encounter you wish to "
"RTN","PXCE",178,0)
 . S DIR("?")=DIR("?")_$S($L(HELP):HELP,1:"act on")
"RTN","PXCE",179,0)
 . D ^DIR I $D(DTOUT)!(X="") S Y="^"
"RTN","PXCE",180,0)
 E  D
"RTN","PXCE",181,0)
 . N DIR,DA
"RTN","PXCE",182,0)
ASKLOOP . S DIR(0)="FAO^1:"_$L(MAX)
"RTN","PXCE",183,0)
 . S DIR("A")="Enter 1-"_MAX_" to Edit, or 'A' to Add: "
"RTN","PXCE",184,0)
 . S DIR("?")="Enter the number of the Encounter you wish "
"RTN","PXCE",185,0)
 . S DIR("?")=DIR("?")_$S($L(HELP):HELP,1:"act on")_" or A to "
"RTN","PXCE",186,0)
 . S DIR("?")=DIR("?")_$S($L(HELP):HELP,1:"act on")_" add a new Encounter"
"RTN","PXCE",187,0)
 . D ^DIR
"RTN","PXCE",188,0)
 . K DIR,DA
"RTN","PXCE",189,0)
 . I $D(DIRUT)!(X="") S Y="^" Q
"RTN","PXCE",190,0)
 . I "Aa"[Y S Y="A" Q
"RTN","PXCE",191,0)
 . G:Y<1!(Y>MAX) ASKLOOP
"RTN","PXCE",192,0)
 Q Y
"RTN","PXCE",193,0)
 ;
"RTN","PXCE",194,0)
GAF ;;
"RTN","PXCE",195,0)
 N PXCEVIEN,PXDFN,PXDSS,PXELIG,PXDATA
"RTN","PXCE",196,0)
 I $G(PXCEHLOC),'$$MHCLIN^SDUTL2(PXCEHLOC) D  G SKIP
"RTN","PXCE",197,0)
 . S DIR(0)="FOA"
"RTN","PXCE",198,0)
 . S DIR("A",1)=" This is not a Mental Health Clinic, a GAF Score may not be entered."
"RTN","PXCE",199,0)
 . S DIR("A")=" Press any key to continue: "
"RTN","PXCE",200,0)
 . D ^DIR K DIR
"RTN","PXCE",201,0)
 ;
"RTN","PXCE",202,0)
 I $D(^TMP("PXCEIDX",$J)) D GETVIEN^PXCEAE
"RTN","PXCE",203,0)
 I $D(^TMP("SDAMIDX",$J)) S PXCEVIEN=$$SELAPPM^PXCESDAM
"RTN","PXCE",204,0)
 I '($G(PXCEVIEN)]"")!($G(PXCEVIEN)=-1) D  S VALMBCK="R" Q
"RTN","PXCE",205,0)
 . S DIR(0)="FAO"
"RTN","PXCE",206,0)
 . I '($G(PXCEVIEN)]"") S DIR("A",1)="Nothing to select."
"RTN","PXCE",207,0)
 . I $G(PXCEVIEN)=-1 S DIR("A",1)="No selections made."
"RTN","PXCE",208,0)
 . S DIR("A")="Press any key to continue."
"RTN","PXCE",209,0)
 . D ^DIR K DIR
"RTN","PXCE",210,0)
 S PXDFN=$P($G(^AUPNVSIT(PXCEVIEN,0)),"^",5)
"RTN","PXCE",211,0)
 S PXDSS=$P($G(^AUPNVSIT(PXCEVIEN,0)),"^",8)
"RTN","PXCE",212,0)
 S PXDATA=$G(^DPT(PXDFN,"S",$P(^AUPNVSIT(PXCEVIEN,0),U),0))
"RTN","PXCE",213,0)
 S PXELIG=$$ELSTAT^SDUTL2(PXDFN)
"RTN","PXCE",214,0)
 I $$MHCLIN^SDUTL2("",PXDSS),'($$COLLAT^SDUTL2(PXELIG)!$P(PXDATA,U,11)) D
"RTN","PXCE",215,0)
 . S PXGAF=$$NEWGAF^SDUTL2(PXDFN)
"RTN","PXCE",216,0)
 . D FULL^VALM1
"RTN","PXCE",217,0)
 . W !
"RTN","PXCE",218,0)
 . I +$P(PXGAF,U,5)>0 W !,"Warning: Patient is deceased."
"RTN","PXCE",219,0)
 . W !,"Current GAF: "_+$P(PXGAF,U,2)
"RTN","PXCE",220,0)
 . W $S($P(PXGAF,U,3)>0:", from "_$$FMTE^XLFDT($P(PXGAF,U,3),"D"),1:", Date Unavailable")
"RTN","PXCE",221,0)
 . D EN^SDGAF(PXDFN)
"RTN","PXCE",222,0)
 E  D
"RTN","PXCE",223,0)
 . S DIR(0)="FOA"
"RTN","PXCE",224,0)
 . S DIR("A",1)="A GAF Score is not required for this appointment!"
"RTN","PXCE",225,0)
 . S DIR("A")="Press any key to continue: "
"RTN","PXCE",226,0)
 . D ^DIR K DIR
"RTN","PXCE",227,0)
 ;
"RTN","PXCE",228,0)
SKIP S VALMBCK="R"
"RTN","PXCE",229,0)
GAFQ Q
"RTN","PXCE",230,0)
 ;
"RTN","PXCEAE")
0^15^B30145919
"RTN","PXCEAE",1,0)
PXCEAE ;ISL/dee,ISA/KWP - Main routine for the List Manager display of a visit and related v-files ;04/26/99
"RTN","PXCEAE",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**37,67,99,147**;Aug 12, 1996
"RTN","PXCEAE",3,0)
 ;; ;
"RTN","PXCEAE",4,0)
 Q
"RTN","PXCEAE",5,0)
EN ;+ -- main entry point for PXCE DISPLAY VISIT
"RTN","PXCEAE",6,0)
 Q:$G(PXCEVIEN)'>0
"RTN","PXCEAE",7,0)
 ;The selection list for the AICS' package interface used in help messages
"RTN","PXCEAE",8,0)
 N PXCEHLST
"RTN","PXCEAE",9,0)
 ;
"RTN","PXCEAE",10,0)
 N PXCEAEVW S PXCEAEVW="B"
"RTN","PXCEAE",11,0)
 N PXCEVDEL S PXCEVDEL=0
"RTN","PXCEAE",12,0)
 ;
"RTN","PXCEAE",13,0)
 I '$D(PXCEPAT) N PXCEPAT D
"RTN","PXCEAE",14,0)
 . S PXCEPAT=$P($G(^AUPNVSIT(PXCEVIEN,0)),"^",5)
"RTN","PXCEAE",15,0)
 S PXCECAT="AEP" D PATINFO^PXCEPAT(.PXCEPAT) K PXCECAT
"RTN","PXCEAE",16,0)
 ;
"RTN","PXCEAE",17,0)
 I '$D(PXCEHLOC) N PXCEHLOC S PXCEHLOC=$P($G(^AUPNVSIT(PXCEVIEN,0)),"^",22)
"RTN","PXCEAE",18,0)
 ;+If not called from encounter viewer lock ^PXLCKUSR
"RTN","PXCEAE",19,0)
 ;+and create ^XTMP("PXLCKUSR",VISIEN)=DUZ
"RTN","PXCEAE",20,0)
 I PXCEKEYS'["V" D
"RTN","PXCEAE",21,0)
 .N PXRESVAL,PXVISIEN,PXMSG,PXUSR
"RTN","PXCEAE",22,0)
 .S PXMSG="",PXVISIEN=PXCEVIEN
"RTN","PXCEAE",23,0)
 .I $D(^XTMP("PXLCKUSR",PXVISIEN)) S PXUSR=$G(^VA(200,^XTMP("PXLCKUSR",PXVISIEN),0)),PXUSR=$S(PXUSR="":"Unknown",1:$P(PXUSR,"^")),PXMSG="Encounter Locked by "_PXUSR
"RTN","PXCEAE",24,0)
 .S PXRESVAL=$$LOCK^PXUALOCK("^PXLCKUSR("_PXVISIEN_")",5,0,PXMSG,0)
"RTN","PXCEAE",25,0)
 .I 'PXRESVAL Q
"RTN","PXCEAE",26,0)
 .S PXRESVAL=$$CREATE^PXUAXTMP("PXLCKUSR",PXVISIEN,365,"PCE Encounter Lock",DUZ)
"RTN","PXCEAE",27,0)
 .I 'PXRESVAL D UNLOCK^PXUALOCK("^PXLCKUSR("_PXVISIEN_")") Q
"RTN","PXCEAE",28,0)
 .D EN^VALM("PXCE ADD/EDIT MENU")
"RTN","PXCEAE",29,0)
 .D UNLOCK^PXUALOCK("^PXLCKUSR("_PXVISIEN_")"),DELETE^PXUAXTMP("PXLCKUSR",PXVISIEN)
"RTN","PXCEAE",30,0)
 I PXCEKEYS["V",$D(^TMP("VALM DATA",$J,VALMEVL,"EXP")),^("EXP")]"" X ^("EXP")
"RTN","PXCEAE",31,0)
 Q
"RTN","PXCEAE",32,0)
 ;
"RTN","PXCEAE",33,0)
GETVIEN ;Ask the user which visit.
"RTN","PXCEAE",34,0)
 N PXCEVIDX
"RTN","PXCEAE",35,0)
 S PXCEVIDX=+$P(XQORNOD(0),"^",3)
"RTN","PXCEAE",36,0)
 S:PXCEVIDX'>0 PXCEVIDX=$$SEL1^PXCE("")
"RTN","PXCEAE",37,0)
 Q:PXCEVIDX'>0
"RTN","PXCEAE",38,0)
 S PXCEVIEN=$G(^TMP("PXCEIDX",$J,PXCEVIDX))
"RTN","PXCEAE",39,0)
 ;Check that it is not related to a no show or canceled apppointment
"RTN","PXCEAE",40,0)
 D APPCHECK^PXCESDAM(.PXCEVIEN)
"RTN","PXCEAE",41,0)
 Q:'$D(PXCEVIEN)
"RTN","PXCEAE",42,0)
 ;Cannot edit future visits
"RTN","PXCEAE",43,0)
 I $P(+^AUPNVSIT(PXCEVIEN,0),".")>DT D  Q
"RTN","PXCEAE",44,0)
 . W !!,$C(7),"Can not update future encounters."
"RTN","PXCEAE",45,0)
 . D WAIT^PXCEHELP
"RTN","PXCEAE",46,0)
 . K PXCEVIEN
"RTN","PXCEAE",47,0)
 ;Check if the visit can be associated with an appointment.
"RTN","PXCEAE",48,0)
 S PXCEAPPM=$G(^DPT($P(^AUPNVSIT(PXCEVIEN,0),"^",5),"S",+^AUPNVSIT(PXCEVIEN,0),0))
"RTN","PXCEAE",49,0)
 I $P(PXCEVIEN,"^",7)="E" D  I 'Y K PXCEVIEN Q
"RTN","PXCEAE",50,0)
 . W !!,"This is a historical encounter for documenting a clinical encounter only"
"RTN","PXCEAE",51,0)
 . W !,"and will not be used by Scheduling, Billing or Workload credit."
"RTN","PXCEAE",52,0)
 . D PAUSE^PXCEHELP
"RTN","PXCEAE",53,0)
 Q
"RTN","PXCEAE",54,0)
 ;
"RTN","PXCEAE",55,0)
HDR ; -- header code
"RTN","PXCEAE",56,0)
 I '$D(^AUPNVSIT(PXCEVIEN,0)) S VALMQUIT=1 Q
"RTN","PXCEAE",57,0)
 K VALMHDR
"RTN","PXCEAE",58,0)
 N VISIT0
"RTN","PXCEAE",59,0)
 ;
"RTN","PXCEAE",60,0)
 ;PATIENT
"RTN","PXCEAE",61,0)
 S VISIT0=^AUPNVSIT(PXCEVIEN,0)
"RTN","PXCEAE",62,0)
 S VALMHDR(1)=$E(PXCEPAT("NAME"),1,26)
"RTN","PXCEAE",63,0)
 S VALMHDR(1)=$E(VALMHDR(1)_$E("    ",1,(27-$L(VALMHDR(1))))_PXCEPAT("SSN")_"                                           ",1,40)
"RTN","PXCEAE",64,0)
 S VALMHDR(1)=VALMHDR(1)_"Clinic:  "_$S($P(VISIT0,"^",22)>0:$P(^SC($P(VISIT0,"^",22),0),"^"),1:"")
"RTN","PXCEAE",65,0)
 ;
"RTN","PXCEAE",66,0)
 ;DATE
"RTN","PXCEAE",67,0)
 S VALMHDR(2)=$E("Encounter Date  "_$S($P(VISIT0,"^",1)>0:$$DATE^PXCEDATE($P(VISIT0,"^",1)),1:"")_"                                           ",1,40)
"RTN","PXCEAE",68,0)
 S VALMHDR(2)=VALMHDR(2)_"Clinic Stop:  "_$S($P(VISIT0,"^",8)>0:$$DISPLY08^PXCECSTP($P(VISIT0,"^",8)),1:"")
"RTN","PXCEAE",69,0)
 ;
"RTN","PXCEAE",70,0)
 S VALMSG="+ Next Screen   - Prev Screen   ?? More Actions"
"RTN","PXCEAE",71,0)
 ;
"RTN","PXCEAE",72,0)
 Q
"RTN","PXCEAE",73,0)
 ;
"RTN","PXCEAE",74,0)
KEYS(PXCEPROT,PXCEEND) ;Set up ^XQORM("KEY") array so that can edit an item by having its 
"RTN","PXCEAE",75,0)
 ;  number be and action to edit it.
"RTN","PXCEAE",76,0)
 N PXCEPIEN,PXCEINDX
"RTN","PXCEAE",77,0)
 S PXCEPIEN=$O(^ORD(101,"B",PXCEPROT,0))_"^1"
"RTN","PXCEAE",78,0)
 F PXCEINDX=1:1:PXCEEND S XQORM("KEY",PXCEINDX)=PXCEPIEN
"RTN","PXCEAE",79,0)
 ;
"RTN","PXCEAE",80,0)
 Q
"RTN","PXCEAE",81,0)
 ;
"RTN","PXCEAE",82,0)
INIT ; -- init variables and list array
"RTN","PXCEAE",83,0)
 D BUILD^PXCEAE1(PXCEVIEN,PXCEAEVW,"^TMP(""PXCEAE"",$J)","^TMP(""PXCEAEIX"",$J)")
"RTN","PXCEAE",84,0)
 I '$D(VALMBCK) K VALMHDR S VALMBCK="R"
"RTN","PXCEAE",85,0)
 Q
"RTN","PXCEAE",86,0)
 ;
"RTN","PXCEAE",87,0)
HELP ; -- help code
"RTN","PXCEAE",88,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PXCEAE",89,0)
 Q
"RTN","PXCEAE",90,0)
 ;
"RTN","PXCEAE",91,0)
EXIT ; -- exit code
"RTN","PXCEAE",92,0)
 ;
"RTN","PXCEAE",93,0)
 ;Check for incomplete ENCOUNTER if not already removed.
"RTN","PXCEAE",94,0)
 N PXQUIT
"RTN","PXCEAE",95,0)
 S PXQUIT=1
"RTN","PXCEAE",96,0)
 D:'$G(PXCEEXIT) CHECK^PXCEVFI5
"RTN","PXCEAE",97,0)
 ;
"RTN","PXCEAE",98,0)
 D CLEAN^VALM10
"RTN","PXCEAE",99,0)
 K ^TMP("PXCEAE",$J),^TMP("PXCEAEIX",$J)
"RTN","PXCEAE",100,0)
 D EVENT^PXKMAIN
"RTN","PXCEAE",101,0)
 K PXCEVIEN,PXCEAPPM
"RTN","PXCEAE",102,0)
 Q
"RTN","PXCEAE",103,0)
 ;
"RTN","PXCEAE",104,0)
EXPND ; -- expand code
"RTN","PXCEAE",105,0)
 S PXCEAEVW=$S(PXCEAEVW="B":"D",1:"B")
"RTN","PXCEAE",106,0)
 D BUILD^PXCEAE1(PXCEVIEN,PXCEAEVW,"^TMP(""PXCEAE"",$J)","^TMP(""PXCEAEIX"",$J)")
"RTN","PXCEAE",107,0)
 D DONE^PXCE
"RTN","PXCEAE",108,0)
 Q
"RTN","PXCEAE",109,0)
 ;
"RTN","PXCEAE",110,0)
EDIT ; -- edit a V-File entry
"RTN","PXCEAE",111,0)
 N PXCEFIDX
"RTN","PXCEAE",112,0)
 S PXCEFIDX=+$P(XQORNOD(0),"^",3)
"RTN","PXCEAE",113,0)
 D DOMANY(PXCEFIDX,"E","EN^PXCEVFIL(PXCECAT)")
"RTN","PXCEAE",114,0)
 Q
"RTN","PXCEAE",115,0)
 ;
"RTN","PXCEAE",116,0)
DEL ; -- delete a V-File entries
"RTN","PXCEAE",117,0)
 I PXCEKEYS'["D",PXCEKEYS'["d" W !!!,$C(7),"Error: You do not have delete access." D WAIT^PXCEHELP Q
"RTN","PXCEAE",118,0)
 D DOMANY(0,"D","DEL^PXCEVFI2(PXCECAT)")
"RTN","PXCEAE",119,0)
 Q
"RTN","PXCEAE",120,0)
 ;
"RTN","PXCEAE",121,0)
DOMANY(PXCEFIDX,WHATDO,WHATTODO) ;Process one or more V-File entries
"RTN","PXCEAE",122,0)
 ;WHATDO is E for edit and D for delete
"RTN","PXCEAE",123,0)
 ;WHATTODO is the routine to call
"RTN","PXCEAE",124,0)
 ;
"RTN","PXCEAE",125,0)
 I WHATDO="D" N PXCEDELV S PXCEDELV=0
"RTN","PXCEAE",126,0)
 D FULL^VALM1
"RTN","PXCEAE",127,0)
 I WHATDO="E" D
"RTN","PXCEAE",128,0)
 . S:PXCEFIDX'>0 PXCEFIDX=$$SEL^PXCEAE2("Edit",1)
"RTN","PXCEAE",129,0)
 E  I WHATDO="D" D
"RTN","PXCEAE",130,0)
 . S:PXCEFIDX'>0 PXCEFIDX=$$SEL^PXCEAE2("Delete",1)
"RTN","PXCEAE",131,0)
 E  W "??",$C(7) Q
"RTN","PXCEAE",132,0)
 Q:+PXCEFIDX'>0
"RTN","PXCEAE",133,0)
 N PXCEINDX,PXCEFIX1,PXCEFIX2
"RTN","PXCEAE",134,0)
 F PXCEINDX=1:1 S PXCEFIX1=$P(PXCEFIDX,",",PXCEINDX) Q:PXCEFIX1']""  D
"RTN","PXCEAE",135,0)
 . I $L(PXCEFIX1,"-")=1 D
"RTN","PXCEAE",136,0)
 .. I WHATDO="D",PXCEFIX1=1 S PXCEDELV=1
"RTN","PXCEAE",137,0)
 .. E  D DO1(PXCEFIX1,WHATDO,WHATTODO)
"RTN","PXCEAE",138,0)
 . E  F PXCEFIX2=$P(PXCEFIX1,"-",1):1:$P(PXCEFIX1,"-",2) D
"RTN","PXCEAE",139,0)
 .. I WHATDO="D",PXCEFIX2=1 S PXCEDELV=1
"RTN","PXCEAE",140,0)
 .. E  D DO1(PXCEFIX2,WHATDO,WHATTODO)
"RTN","PXCEAE",141,0)
 I WHATDO="D",PXCEDELV D DO1(1,WHATDO,WHATTODO)
"RTN","PXCEAE",142,0)
 D INIT
"RTN","PXCEAE",143,0)
 Q
"RTN","PXCEAE",144,0)
 ;
"RTN","PXCEAE",145,0)
DO1(PXCEFIDX,WHATDO,WHATTODO) ;Process one V-File entry
"RTN","PXCEAE",146,0)
 ;PXCEFIDX is and index into ^TMP("PXCEAEIX",$J, which tells the V-File
"RTN","PXCEAE",147,0)
 ;  and the IEN to process
"RTN","PXCEAE",148,0)
 ;WHATDO is E for edit and D for delete
"RTN","PXCEAE",149,0)
 ;WHATTODO is the routine to call
"RTN","PXCEAE",150,0)
 ;
"RTN","PXCEAE",151,0)
 N PXCEONE,PXCECAT,PXCEFIEN
"RTN","PXCEAE",152,0)
 S PXCEONE=$G(^TMP("PXCEAEIX",$J,PXCEFIDX))
"RTN","PXCEAE",153,0)
 S PXCEFIEN=+PXCEONE
"RTN","PXCEAE",154,0)
 S PXCECAT=$P(PXCEONE,"^",2)
"RTN","PXCEAE",155,0)
 I PXCECAT="CSTP",WHATDO="E" W !!!,$C(7),"You cannot edit stop codes." S PXCENOER=1 D WAIT^PXCEHELP Q
"RTN","PXCEAE",156,0)
 I PXCECAT="VST",$P(^AUPNVSIT(PXCEFIEN,0),"^",7)="E" S PXCECAT="HIST"
"RTN","PXCEAE",157,0)
 D @$S("~VST~HIST~CSTP~CPT~IMM~PED~POV~PRV~SK~TRT~HF~XAM~"[("~"_PXCECAT_"~"):WHATTODO,1:"QUIT")
"RTN","PXCEAE",158,0)
 Q
"RTN","PXCEAE",159,0)
 ;
"RTN","PXCEAE",160,0)
QUIT Q
"RTN","PXCEAE",161,0)
 ;
"RTN","PXCEPAT")
0^12^B26711062
"RTN","PXCEPAT",1,0)
PXCEPAT ;ISL/dee,ISA/KWP - Creates the List Manager display of visit for a patient ; 6/3/03 10:47am
"RTN","PXCEPAT",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**1,5,14,30,70,147**;Aug 12, 1996
"RTN","PXCEPAT",3,0)
 Q
"RTN","PXCEPAT",4,0)
 ;
"RTN","PXCEPAT",5,0)
NEWPAT2 ;Entry point of changing patient from Update Encounter
"RTN","PXCEPAT",6,0)
 N PXCENEWP
"RTN","PXCEPAT",7,0)
 D PATIENT(.PXCENEWP)
"RTN","PXCEPAT",8,0)
 Q:PXCENEWP'>0
"RTN","PXCEPAT",9,0)
 D PATKILL
"RTN","PXCEPAT",10,0)
 S PXCEPAT=+PXCENEWP
"RTN","PXCEPAT",11,0)
NEWPAT1 ;Entry point for initial selection of patient
"RTN","PXCEPAT",12,0)
 D PATINFO(.PXCEPAT) Q:$D(DIRUT)
"RTN","PXCEPAT",13,0)
 I $P(PXCEVIEW,"^",1)'="P" D
"RTN","PXCEPAT",14,0)
 . S $P(PXCEVIEW,"^",1)="P"
"RTN","PXCEPAT",15,0)
 . D SETDATES^PXCE
"RTN","PXCEPAT",16,0)
 S SDAMTYP="P"
"RTN","PXCEPAT",17,0)
 I PXCEVIEW["A" K PXCEHLOC
"RTN","PXCEPAT",18,0)
 Q
"RTN","PXCEPAT",19,0)
 ;
"RTN","PXCEPAT",20,0)
NEWPAT ; -- init variables and list array
"RTN","PXCEPAT",21,0)
 N PXCENEWP
"RTN","PXCEPAT",22,0)
 D PATIENT(.PXCENEWP)
"RTN","PXCEPAT",23,0)
 I PXCENEWP'>0,("~H~P~"'[("~"_$P(PXCEVIEW,"^")_"~")) S VALMQUIT=1 Q
"RTN","PXCEPAT",24,0)
 I PXCENEWP'>0 Q
"RTN","PXCEPAT",25,0)
 D PATKILL
"RTN","PXCEPAT",26,0)
 S PXCEPAT=+PXCENEWP
"RTN","PXCEPAT",27,0)
 D NEWPAT1 Q:$D(DIRUT)
"RTN","PXCEPAT",28,0)
 D MAKELIST^PXCENEW
"RTN","PXCEPAT",29,0)
 Q
"RTN","PXCEPAT",30,0)
 ;
"RTN","PXCEPAT",31,0)
MAKELIST ;
"RTN","PXCEPAT",32,0)
 N PXCEDATE,PXCELOC,PXCESTAT,PXCEDT,PXCEIEN,PXCEVSIT,PXCEPRIM
"RTN","PXCEPAT",33,0)
 D CHGCAP^VALM("LOCATION","Clinic")
"RTN","PXCEPAT",34,0)
 K VALMHDR S VALMBCK="R"
"RTN","PXCEPAT",35,0)
 S PXCEDT=PXCE9END
"RTN","PXCEPAT",36,0)
 D CLEAN^VALM10
"RTN","PXCEPAT",37,0)
 K ^TMP("PXCEIDX",$J)
"RTN","PXCEPAT",38,0)
 S VALMBG=1
"RTN","PXCEPAT",39,0)
 S VALMCNT=0
"RTN","PXCEPAT",40,0)
 F  S PXCEDT=$O(^AUPNVSIT("AA",PXCEPAT,PXCEDT)) Q:PXCEDT'>0!(PXCEDT>PXCE9BEG)  D
"RTN","PXCEPAT",41,0)
 . S PXCEIEN=""
"RTN","PXCEPAT",42,0)
 . F  S PXCEIEN=$O(^AUPNVSIT("AA",PXCEPAT,PXCEDT,PXCEIEN)) Q:PXCEIEN'>0  D
"RTN","PXCEPAT",43,0)
 .. S PXCEVSIT=^AUPNVSIT(PXCEIEN,0)
"RTN","PXCEPAT",44,0)
 .. I $D(PXCEHLOC),$P(PXCEVSIT,"^",22)'=PXCEHLOC Q
"RTN","PXCEPAT",45,0)
 .. S PXCEPRIM=$P($G(^AUPNVSIT(PXCEIEN,150)),"^",3)
"RTN","PXCEPAT",46,0)
 .. ;+do not show encounter if the encounter type is S,C or null
"RTN","PXCEPAT",47,0)
 .. Q:"SC"[PXCEPRIM
"RTN","PXCEPAT",48,0)
 .. I PXCEKEYS'["S",PXCEKEYS'["V","A"=PXCEPRIM Q  ;+let supervisor and viewer see ancillary encounters
"RTN","PXCEPAT",49,0)
 .. I PXCEKEYS'["V",$$DISPOSIT^PXUTL1(PXCEPAT,+PXCEVSIT,PXCEIEN) Q  ;+let viewer see disposition
"RTN","PXCEPAT",50,0)
 .. S VALMCNT=VALMCNT+1
"RTN","PXCEPAT",51,0)
 .. S Y=$P(PXCEVSIT,"^",1)
"RTN","PXCEPAT",52,0)
 .. S PXCEDATE=$$DATE^PXCEDATE($P(PXCEVSIT,"^",1))
"RTN","PXCEPAT",53,0)
 .. S PXCEDATE=$E(PXCEDATE,1,18)_$J("",(19-$L(PXCEDATE)))
"RTN","PXCEPAT",54,0)
 .. I $P(PXCEVSIT,"^",7)="E" D
"RTN","PXCEPAT",55,0)
 ... S PXCELOC="  Historical Encounter at "
"RTN","PXCEPAT",56,0)
 ... I $P(PXCEVSIT,"^",6)]"" D
"RTN","PXCEPAT",57,0)
 .... N PXCEDELF
"RTN","PXCEPAT",58,0)
 .... S PXCESTAT=$E($$EXTERNAL^DILFD(9000010,.06,"",$P(PXCEVSIT,"^",6),"PXCEDILF"),1,30)
"RTN","PXCEPAT",59,0)
 ... E  S PXCESTAT=$E($P($G(^AUPNVSIT(PXCEIEN,21)),"^"),1,30)
"RTN","PXCEPAT",60,0)
 .. E  D
"RTN","PXCEPAT",61,0)
 ... S PXCELOC=$S($P(PXCEVSIT,"^",22)>0:$P(^SC($P(PXCEVSIT,"^",22),0),"^"),$P(PXCEVSIT,"^",7)="E":"   Historical",1:"")
"RTN","PXCEPAT",62,0)
 ... S PXCELOC=$E(PXCELOC,1,26)_$J("",(28-$L(PXCELOC)))
"RTN","PXCEPAT",63,0)
 ... S PXCESTAT=$P($$STATUS^SDPCE(PXCEIEN),"^",2)
"RTN","PXCEPAT",64,0)
 .. S ^TMP("PXCE",$J,VALMCNT,0)=$J(VALMCNT,4)_" "_PXCEDATE_PXCELOC_PXCESTAT
"RTN","PXCEPAT",65,0)
 .. S ^TMP("PXCEIDX",$J,VALMCNT)=PXCEIEN
"RTN","PXCEPAT",66,0)
 S ^TMP("PXCEIDX",$J,0)=VALMCNT
"RTN","PXCEPAT",67,0)
 I VALMCNT'>0 D
"RTN","PXCEPAT",68,0)
 . S ^TMP("PXCE",$J,1,0)=" "
"RTN","PXCEPAT",69,0)
 . S ^TMP("PXCE",$J,2,0)="    No encounter found that satisfy the above criteria."
"RTN","PXCEPAT",70,0)
 . S VALMCNT=2
"RTN","PXCEPAT",71,0)
 Q
"RTN","PXCEPAT",72,0)
 ;
"RTN","PXCEPAT",73,0)
SDSALONE ;Get the patient for standalone from the appointment/hospital
"RTN","PXCEPAT",74,0)
 ;location screen
"RTN","PXCEPAT",75,0)
 Q:$G(PXCEPAT)>0
"RTN","PXCEPAT",76,0)
 D PATIENT(.PXCEPAT)
"RTN","PXCEPAT",77,0)
 I PXCEPAT>0 D PATINFO(.PXCEPAT) S PXCEJPAT=1
"RTN","PXCEPAT",78,0)
 Q
"RTN","PXCEPAT",79,0)
 ;
"RTN","PXCEPAT",80,0)
SDKALONE ;Kill the patient info if it was created above
"RTN","PXCEPAT",81,0)
 Q:'$D(PXCEJPAT)
"RTN","PXCEPAT",82,0)
 D PATKILL
"RTN","PXCEPAT",83,0)
 K PXCEJPAT
"RTN","PXCEPAT",84,0)
 Q
"RTN","PXCEPAT",85,0)
 ;
"RTN","PXCEPAT",86,0)
JUSTDFN ;Just set DFN for other packages.
"RTN","PXCEPAT",87,0)
 Q
"RTN","PXCEPAT",88,0)
 Q:$G(DFN)>0
"RTN","PXCEPAT",89,0)
 N X,Y,DIC,DA
"RTN","PXCEPAT",90,0)
 S DIC=2,DIC(0)="AEMQ"
"RTN","PXCEPAT",91,0)
 D ^DIC
"RTN","PXCEPAT",92,0)
 I +Y>0 S DFN=+Y,PXCEJDFN=1
"RTN","PXCEPAT",93,0)
 Q
"RTN","PXCEPAT",94,0)
 ;
"RTN","PXCEPAT",95,0)
JUSTDFNK ;Kill DFN if it was set above
"RTN","PXCEPAT",96,0)
 I $G(PXCEJDFN) K DFN,PXCEJDFN
"RTN","PXCEPAT",97,0)
 I $G(PXCEPAT)>0 S DFN=PXCEPAT
"RTN","PXCEPAT",98,0)
 Q
"RTN","PXCEPAT",99,0)
 ;
"RTN","PXCEPAT",100,0)
PATIENT(PXCEDATA) ; Select a patient
"RTN","PXCEPAT",101,0)
 N X,Y,DIC,DA
"RTN","PXCEPAT",102,0)
 D FULL^VALM1
"RTN","PXCEPAT",103,0)
 S DIC=2,DIC(0)="AEMQ"
"RTN","PXCEPAT",104,0)
 D ^DIC
"RTN","PXCEPAT",105,0)
 S PXCEDATA=+Y
"RTN","PXCEPAT",106,0)
 ;S DFN=PXCEDATA D 2^VADPT I +VADM(6) D
"RTN","PXCEPAT",107,0)
 ;. S DIR(0)="E",DIR("A")="Enter RETURN to continue or '^' to exit"
"RTN","PXCEPAT",108,0)
 ;. S DIR("A",1)="WARNING "_VADM(7) D ^DIR
"RTN","PXCEPAT",109,0)
 Q
"RTN","PXCEPAT",110,0)
 ;
"RTN","PXCEPAT",111,0)
PATINFO(PXCEDATA) ;
"RTN","PXCEPAT",112,0)
 Q:$G(PXCEDATA)'>0
"RTN","PXCEPAT",113,0)
 S (DFN,SDFN,ORVP)=PXCEDATA
"RTN","PXCEPAT",114,0)
 D 2^VADPT I +VADM(6) D  K DIR I $D(DIRUT) D:$G(PXCECAT)'="SIT"&($G(PXCECAT)'="HIST")&($G(PXCECAT)'="AEP") PATKILL Q
"RTN","PXCEPAT",115,0)
 . S DIR(0)="E",DIR("A")="Enter RETURN to continue or '^' to Quit"
"RTN","PXCEPAT",116,0)
 . S DIR("A",2)="WARNING "_VADM(7),DIR("A",1)=" ",DIR("A",3)=" " D ^DIR
"RTN","PXCEPAT",117,0)
 N Y
"RTN","PXCEPAT",118,0)
 S Y=PXCEDATA
"RTN","PXCEPAT",119,0)
 ;Set IHS patient variables
"RTN","PXCEPAT",120,0)
 D START^AUPNPAT
"RTN","PXCEPAT",121,0)
 D PATNAME(.PXCEDATA)
"RTN","PXCEPAT",122,0)
 N VAERR,VAROOT,PXCEVA,PXCEINDX
"RTN","PXCEPAT",123,0)
 S VAROOT="PXCEVA"
"RTN","PXCEPAT",124,0)
 D ELIG^VADPT
"RTN","PXCEPAT",125,0)
 S PXCEDATA("ELIG")=$P($G(PXCEVA(1)),"^",1,99)
"RTN","PXCEPAT",126,0)
 S PXCEINDX=""
"RTN","PXCEPAT",127,0)
 F  S PXCEINDX=$O(PXCEVA(1,PXCEINDX)) Q:'PXCEINDX  S PXCEDATA("ELIG",PXCEINDX)=$P(PXCEVA(1,PXCEINDX),"^",1,99)
"RTN","PXCEPAT",128,0)
 Q
"RTN","PXCEPAT",129,0)
 ;
"RTN","PXCEPAT",130,0)
PATNAME(PXCEDATA) ;
"RTN","PXCEPAT",131,0)
 S PXCEDATA("NAME")=$P($G(^DPT(+PXCEDATA,0)),"^",1)
"RTN","PXCEPAT",132,0)
 N VAPTYP,VA,VAERR,DFN
"RTN","PXCEPAT",133,0)
 S DFN=+PXCEDATA
"RTN","PXCEPAT",134,0)
 D PID^VADPT6
"RTN","PXCEPAT",135,0)
 I 'VAERR S PXCEDATA("SSN")=VA("PID"),PXCEDATA("SSN_BRIEF")=VA("BID")
"RTN","PXCEPAT",136,0)
 E  S (PXCEDATA("SSN"),PXCEDATA("SSN_BRIEF"))=""
"RTN","PXCEPAT",137,0)
 Q
"RTN","PXCEPAT",138,0)
 ;
"RTN","PXCEPAT",139,0)
PATKILL ;
"RTN","PXCEPAT",140,0)
 K PXCEPAT,DFN,SDFN,ORVP
"RTN","PXCEPAT",141,0)
 ; Kill IHS patient variables
"RTN","PXCEPAT",142,0)
 D KILL^AUPNPAT
"RTN","PXCEPAT",143,0)
 Q
"RTN","PXCEPAT",144,0)
 ;
"RTN","PXCEPAT",145,0)
APPOINT(DFN,DATETIME,HOSLOC) ;See if there is an appointment.
"RTN","PXCEPAT",146,0)
 ;Input:
"RTN","PXCEPAT",147,0)
 ;  DFN       ien of the patient
"RTN","PXCEPAT",148,0)
 ;  DATETIME  the date and time of the appointment
"RTN","PXCEPAT",149,0)
 ;  HOSLOC    optional, is the Hospital Location (#44)
"RTN","PXCEPAT",150,0)
 ;Returns the clinic ien or -1 if no appointement.
"RTN","PXCEPAT",151,0)
 ;
"RTN","PXCEPAT",152,0)
 N VASD,HL,INDEX,VAERR
"RTN","PXCEPAT",153,0)
 K ^UTILITY("VASD",$J)
"RTN","PXCEPAT",154,0)
 S VASD("T")=DATETIME
"RTN","PXCEPAT",155,0)
 S VASD("F")=DATETIME-.00000001
"RTN","PXCEPAT",156,0)
 S VASD("W")=129 ;1)Active/Kept 2)Inpatient appts. only 9)No action taken
"RTN","PXCEPAT",157,0)
 S:$G(HOSLOC) VASD("C",HOSLOC)=""
"RTN","PXCEPAT",158,0)
 D SDA^VADPT
"RTN","PXCEPAT",159,0)
 I VAERR S HL=-1 G QAPPOINT
"RTN","PXCEPAT",160,0)
 S INDEX=$O(^UTILITY("VASD",$J,0))
"RTN","PXCEPAT",161,0)
 I INDEX>0 S HL=$P(^UTILITY("VASD",$J,INDEX,"I"),"^",2)
"RTN","PXCEPAT",162,0)
 E  S HL=-1
"RTN","PXCEPAT",163,0)
QAPPOINT K ^UTILITY("VASD",$J)
"RTN","PXCEPAT",164,0)
 Q HL
"RTN","PXCEPAT",165,0)
 ;
"RTN","PXCESDAM")
0^13^B29606794
"RTN","PXCESDAM",1,0)
PXCESDAM ;ISL/dee,ALB/Zoltan - PCE List Manager display of appointments ;11/20/98
"RTN","PXCESDAM",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**1,34,147**;Aug 12, 1996
"RTN","PXCESDAM",3,0)
 ;
"RTN","PXCESDAM",4,0)
 ;Originally Developed using code from:
"RTN","PXCESDAM",5,0)
SDAM ;MJK/ALB - Appt Mgt ; 12/1/91
"RTN","PXCESDAM",6,0)
 ;;5.3;Scheduling;;Aug 13, 1993
"RTN","PXCESDAM",7,0)
 Q
"RTN","PXCESDAM",8,0)
 ;
"RTN","PXCESDAM",9,0)
 ; -- kill off handle data
"RTN","PXCESDAM",10,0)
EN ; -- main entry point
"RTN","PXCESDAM",11,0)
 D FULL^VALM1
"RTN","PXCESDAM",12,0)
 D EN^VALM("PXCE SDAM MENU")
"RTN","PXCESDAM",13,0)
 D MAKELIST^PXCENEW
"RTN","PXCESDAM",14,0)
 Q
"RTN","PXCESDAM",15,0)
 ;
"RTN","PXCESDAM",16,0)
INIT ; -- set up appt man vars
"RTN","PXCESDAM",17,0)
 K I,X,SDB,XQORNOD,SDFN,SDCLN,DA,DR,DIE,DNM,DQ,%B
"RTN","PXCESDAM",18,0)
 S $P(PXCEVIEW,"^",2)="A"
"RTN","PXCESDAM",19,0)
 I PXCEVIEW["P" D INTSDAM1^PXCESDA1
"RTN","PXCESDAM",20,0)
 I PXCEVIEW["H" D INTSDAM3^PXCESDA3
"RTN","PXCESDAM",21,0)
 Q
"RTN","PXCESDAM",22,0)
 ;
"RTN","PXCESDAM",23,0)
FNL ; -- what to do after action
"RTN","PXCESDAM",24,0)
 D CLEAN^VALM10
"RTN","PXCESDAM",25,0)
 K ^TMP("SDAM",$J),^TMP("SDAMIDX",$J),^TMP("VALMIDX",$J)
"RTN","PXCESDAM",26,0)
 K SDAMCNT,SDFLDD,SDACNT,VALMHCNT,SDPRD,SDFN,SDCLN,SDAMLIST,SDT,SDATA,SDY,X,SDCL,Y,SDDA,VALMY
"RTN","PXCESDAM",27,0)
 Q
"RTN","PXCESDAM",28,0)
 ;
"RTN","PXCESDAM",29,0)
EXIT ; -- exit action for protocol
"RTN","PXCESDAM",30,0)
 D:PXCEVIEW'["P" PATKILL^PXCEPAT
"RTN","PXCESDAM",31,0)
 Q
"RTN","PXCESDAM",32,0)
 ;
"RTN","PXCESDAM",33,0)
EXPND ; -- expand code
"RTN","PXCESDAM",34,0)
 D EN^PXCEEXP
"RTN","PXCESDAM",35,0)
 Q
"RTN","PXCESDAM",36,0)
 ;
"RTN","PXCESDAM",37,0)
SEL ;
"RTN","PXCESDAM",38,0)
 N PXCEVIEN
"RTN","PXCESDAM",39,0)
 N PXCEAPDT S PXCEAPDT=""
"RTN","PXCESDAM",40,0)
 I '$D(PXCEPAT) N PXCEPAT S PXCEPAT=""
"RTN","PXCESDAM",41,0)
 I '$D(PXCEHLOC) N PXCEHLOC S PXCEHLOC=""
"RTN","PXCESDAM",42,0)
 S PXCEVIEN=$$SELAPPM
"RTN","PXCESDAM",43,0)
 I PXCEVIEN=-1 G SELQ
"RTN","PXCESDAM",44,0)
 ;
"RTN","PXCESDAM",45,0)
 D APPCHECK(.PXCEVIEN,PXCEHLOC,PXCEAPDT,PXCEPAT)
"RTN","PXCESDAM",46,0)
 I '$D(PXCEVIEN) G SELQ
"RTN","PXCESDAM",47,0)
 D:PXCEVIEN="" EN^PXCEVFIL("APPM")
"RTN","PXCESDAM",48,0)
 D:PXCEVIEN>0 EN^PXCEAE
"RTN","PXCESDAM",49,0)
SELQ K ^UTILITY("VASD",$J)
"RTN","PXCESDAM",50,0)
 Q
"RTN","PXCESDAM",51,0)
 ;
"RTN","PXCESDAM",52,0)
SELAPPM() ;
"RTN","PXCESDAM",53,0)
 N SDW,SDERR
"RTN","PXCESDAM",54,0)
 S SDW=+$P(XQORNOD(0),"^",3)
"RTN","PXCESDAM",55,0)
 I SDW'>0 K SDW D SELSDAM I '$D(SDW)!SDERR Q -1
"RTN","PXCESDAM",56,0)
 I $P($P(^TMP("SDAMIDX",$J,SDW),"^",3),".",1)>DT D  Q -1
"RTN","PXCESDAM",57,0)
 . W !!,$C(7),"Can not update future encounters."
"RTN","PXCESDAM",58,0)
 . D WAIT^PXCEHELP
"RTN","PXCESDAM",59,0)
 D FULL^VALM1
"RTN","PXCESDAM",60,0)
 N PXCEVIEN,PXCEINDX
"RTN","PXCESDAM",61,0)
 I '$D(PXCEAPDT) N PXCEAPDT
"RTN","PXCESDAM",62,0)
 I '$D(PXCEPAT) N PXCEPAT
"RTN","PXCESDAM",63,0)
 I '$D(PXCEHLOC) N PXCEHLOC
"RTN","PXCESDAM",64,0)
 S PXCEAPDT=$P(^TMP("SDAMIDX",$J,SDW),"^",3)
"RTN","PXCESDAM",65,0)
 I $G(PXCEPAT)="" S PXCEPAT=$P(^TMP("SDAMIDX",$J,SDW),"^",2) D PATINFO^PXCEPAT(.PXCEPAT) I $D(DIRUT) Q -1
"RTN","PXCESDAM",66,0)
 I $G(PXCEHLOC)="" S PXCEHLOC=$P(^TMP("SDAMIDX",$J,SDW),"^",4)
"RTN","PXCESDAM",67,0)
 ;
"RTN","PXCESDAM",68,0)
 ;Look for visits for this patient at the appointment date and time.
"RTN","PXCESDAM",69,0)
 S PXCEVIEN=$$APPT2VST^PXUTL1(PXCEPAT,PXCEAPDT,PXCEHLOC)
"RTN","PXCESDAM",70,0)
 Q $S(PXCEVIEN>0:PXCEVIEN,1:"")
"RTN","PXCESDAM",71,0)
 ;
"RTN","PXCESDAM",72,0)
SELSDAM ; -- select processing
"RTN","PXCESDAM",73,0)
 N BG,LST,Y
"RTN","PXCESDAM",74,0)
 N DIRUT,DTOUT,DUOUT,DIROUT,DIR,DA
"RTN","PXCESDAM",75,0)
 S BG=1
"RTN","PXCESDAM",76,0)
 S LST=+$O(@VALMAR@("IDX",VALMCNT,0))
"RTN","PXCESDAM",77,0)
 I LST=BG S SDERR=0,SDW=BG Q
"RTN","PXCESDAM",78,0)
 I 'LST W !!,$C(7),"There are no '",VALM("ENTITY"),"s' to select.",! D WAIT^PXCEHELP S SDERR=1 Q
"RTN","PXCESDAM",79,0)
 S Y=+$P($P(XQORNOD(0),U,4),"=",2)
"RTN","PXCESDAM",80,0)
 I 'Y S DIR(0)="N^"_BG_":"_LST,DIR("A")="Select "_VALM("ENTITY") D ^DIR I $D(DIRUT) S SDERR=1 Q
"RTN","PXCESDAM",81,0)
 ;
"RTN","PXCESDAM",82,0)
 ; -- check was valid entries
"RTN","PXCESDAM",83,0)
 S SDERR=0,SDW=Y
"RTN","PXCESDAM",84,0)
 I SDW<BG!(SDW>LST) D
"RTN","PXCESDAM",85,0)
 .W !,$C(7),"Selection '",SDW,"' is not a valid choice."
"RTN","PXCESDAM",86,0)
 .S SDERR=1
"RTN","PXCESDAM",87,0)
 .D WAIT^PXCEHELP
"RTN","PXCESDAM",88,0)
 Q
"RTN","PXCESDAM",89,0)
 ;
"RTN","PXCESDAM",90,0)
APPCHECK(PXCEVIEN,PXCEHLOC,PXCEAPDT,PXCEPAT) ; Pass in PXCEVIEN and kills it if should not be selected.
"RTN","PXCESDAM",91,0)
 I PXCEVIEN="" D  Q
"RTN","PXCESDAM",92,0)
 . I $$CANCEL($G(PXCEHLOC),$G(PXCEAPDT),$G(PXCEPAT)) K PXCEVIEN
"RTN","PXCESDAM",93,0)
 N VASD,VAERR
"RTN","PXCESDAM",94,0)
 S VASD("W")=345678
"RTN","PXCESDAM",95,0)
 S VASD("F")=+^AUPNVSIT(PXCEVIEN,0)-.0000001
"RTN","PXCESDAM",96,0)
 S VASD("T")=VASD("F")+.0000002
"RTN","PXCESDAM",97,0)
 S VASD("C",+$P(^AUPNVSIT(PXCEVIEN,0),"^",22))=""
"RTN","PXCESDAM",98,0)
 D SDA^VADPT
"RTN","PXCESDAM",99,0)
 I $D(^UTILITY("VASD",$J)) D
"RTN","PXCESDAM",100,0)
 . I 'PXCEVIEN D
"RTN","PXCESDAM",101,0)
 .. W !,$C(7),"PCE has no data related to this appointment."
"RTN","PXCESDAM",102,0)
 .. W !,"You cannot add data for an appointment that has a status of ",$P(^UTILITY("VASD",$J,1,"E"),"^",3)
"RTN","PXCESDAM",103,0)
 .. K PXCEVIEN
"RTN","PXCESDAM",104,0)
 .. D WAIT^PXCEHELP
"RTN","PXCESDAM",105,0)
 . E  I PXCEKEYS["S" D
"RTN","PXCESDAM",106,0)
 .. N DIR,DA
"RTN","PXCESDAM",107,0)
 .. W !,$C(7),"Appointment has a status of ",$P(^UTILITY("VASD",$J,1,"E"),"^",3)
"RTN","PXCESDAM",108,0)
 .. S DIR("A",1)="WARNING: Data stored in PCE related to this appointment"
"RTN","PXCESDAM",109,0)
 .. S DIR("A",2)="  will NOT be used for Workload or Billing.  This is a bad encounter"
"RTN","PXCESDAM",110,0)
 .. S DIR("A")="Do you want to continue with this encounter"
"RTN","PXCESDAM",111,0)
 .. S DIR("B")="NO"
"RTN","PXCESDAM",112,0)
 .. S DIR(0)="Y"
"RTN","PXCESDAM",113,0)
 .. D ^DIR
"RTN","PXCESDAM",114,0)
 .. I Y'=1 K PXCEVIEN
"RTN","PXCESDAM",115,0)
 . E  D
"RTN","PXCESDAM",116,0)
 .. W !,$C(7),"Appointment has a status of ",$P(^UTILITY("VASD",$J,1,"E"),"^",3)
"RTN","PXCESDAM",117,0)
 .. W !,"WARNING: Data stored in PCE related to this appointment"
"RTN","PXCESDAM",118,0)
 .. W !,"  will NOT be used for Workload or Billing.  This is a bad encounter"
"RTN","PXCESDAM",119,0)
 .. W !,"You must use a PCE Superviser option to access the encounter."
"RTN","PXCESDAM",120,0)
 .. K PXCEVIEN
"RTN","PXCESDAM",121,0)
 .. D WAIT^PXCEHELP
"RTN","PXCESDAM",122,0)
 ;
"RTN","PXCESDAM",123,0)
 ; Exit if we already know it should not be selected.
"RTN","PXCESDAM",124,0)
 I $D(PXCEVIEN)["0" Q
"RTN","PXCESDAM",125,0)
 ;
"RTN","PXCESDAM",126,0)
 ;If Supervisor then ask if want to edit ancillary package data
"RTN","PXCESDAM",127,0)
 I PXCEKEYS["S",$P($G(^AUPNVSIT(PXCEVIEN,150)),"^",3)="A" D
"RTN","PXCESDAM",128,0)
 . N DIR,DA
"RTN","PXCESDAM",129,0)
 . W $C(7)
"RTN","PXCESDAM",130,0)
 . S DIR("A",1)="WARNING: Data stored in PCE came from another package and should"
"RTN","PXCESDAM",131,0)
 . S DIR("A",2)="  only be changed in that package.  If it is changed by PCE it will"
"RTN","PXCESDAM",132,0)
 . S DIR("A",3)="  not agree with what is in the originating package."
"RTN","PXCESDAM",133,0)
 . S DIR("A")="Do you want to continue with this encounter"
"RTN","PXCESDAM",134,0)
 . S DIR("B")="NO"
"RTN","PXCESDAM",135,0)
 . S DIR(0)="Y"
"RTN","PXCESDAM",136,0)
 . D ^DIR
"RTN","PXCESDAM",137,0)
 . I Y'=1 K PXCEVIEN
"RTN","PXCESDAM",138,0)
 Q
"RTN","PXCESDAM",139,0)
 ;
"RTN","PXCESDAM",140,0)
CANCEL(PXHL,PXDT,PXDFN) ; True if the appointment is cancelled or no-showed.
"RTN","PXCESDAM",141,0)
 N STATUS,CANC
"RTN","PXCESDAM",142,0)
 S CANC=0
"RTN","PXCESDAM",143,0)
 I PXHL,PXDT,PXDFN,PXHL=+$G(^DPT(PXDFN,"S",PXDT,0)) D
"RTN","PXCESDAM",144,0)
 . S STATUS=$P(^DPT(PXDFN,"S",PXDT,0),U,2)
"RTN","PXCESDAM",145,0)
 . I STATUS["N"!(STATUS["C") S CANC=1
"RTN","PXCESDAM",146,0)
 Q CANC
"RTN","PXCEVFIL")
0^16^B38064195
"RTN","PXCEVFIL",1,0)
PXCEVFIL ;ISL/dee - Main routine to edit a visit or v-file entry ;3/28/97
"RTN","PXCEVFIL",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**9,30,22,73,88,89,104,147**;Aug 12, 1996
"RTN","PXCEVFIL",3,0)
 ;
"RTN","PXCEVFIL",4,0)
 Q
"RTN","PXCEVFIL",5,0)
EN(PXCECAT) ; -- main entry point for PXCE pxcecat EDIT
"RTN","PXCEVFIL",6,0)
 I PXCECAT="SIT"!(PXCECAT="HIST") D PATINFO^PXCEPAT(.PXCEPAT) Q:$D(DIRUT)
"RTN","PXCEVFIL",7,0)
 I PXCECAT'="SIT",PXCECAT'="APPM",PXCECAT'="HIST" Q:'$D(PXCEFIEN)!'$D(PXCEVIEN)!'$D(PXCEPAT)
"RTN","PXCEVFIL",8,0)
 E  Q:(PXCEVIEW["P"&'$D(PXCEPAT))!(PXCEVIEW["H"&'$D(PXCEHLOC))!("~H~P~"'[("~"_$P(PXCEVIEW,"^")_"~"))
"RTN","PXCEVFIL",9,0)
 I PXCECAT="CSTP",$L($T(DATE^SCDXUTL)),$$DATE^SCDXUTL(+$G(^AUPNVSIT(PXCEVIEN,0))) W !!,$C(7),"Stop Codes can not be added to encounters after "_$$FMDATE^SCDXUTL Q
"RTN","PXCEVFIL",10,0)
 N PXCEQUIT
"RTN","PXCEVFIL",11,0)
 I "~CPT~CSTP~"[PXCECAT D  Q:PXCEQUIT
"RTN","PXCEVFIL",12,0)
 . S PXCEQUIT=0
"RTN","PXCEVFIL",13,0)
 . I $P($G(^AUPNVSIT(PXCEVIEN,0)),"^",7)="E" D  Q:$G(PXCEQUIT)
"RTN","PXCEVFIL",14,0)
 .. I PXCECAT="CSTP" W !!,$C(7),"Historical Encounters cannot have Stop Codes." D WAIT^PXCEHELP S PXCEQUIT=1 Q
"RTN","PXCEVFIL",15,0)
 K PXCEQUIT
"RTN","PXCEVFIL",16,0)
 D FULL^VALM1
"RTN","PXCEVFIL",17,0)
 ;
"RTN","PXCEVFIL",18,0)
 N PXCEVFIL,PXCELOOP,PXCENOER
"RTN","PXCEVFIL",19,0)
 N PXCECODE,PXCEAUPN,PXCECATS,PXCECATT,PXCEFILE
"RTN","PXCEVFIL",20,0)
 N PXCEPSCC
"RTN","PXCEVFIL",21,0)
 S PXCECATS=$S(PXCECAT="SIT":"VST",PXCECAT="APPM":"VST",PXCECAT="HIST":"VST",PXCECAT="CSTP":"VST",1:PXCECAT)
"RTN","PXCEVFIL",22,0)
 S PXCECODE="PXCE"_$S(PXCECAT="IMM":"VIMM",1:PXCECAT)
"RTN","PXCEVFIL",23,0)
 S PXCEAUPN=$P($T(FORMAT^@PXCECODE),"~",5)
"RTN","PXCEVFIL",24,0)
 S PXCECATT=$P($P($T(FORMAT^@PXCECODE),";;",2),"~",1)
"RTN","PXCEVFIL",25,0)
 S PXCEFILE=$P($T(FORMAT^@PXCECODE),"~",2)
"RTN","PXCEVFIL",26,0)
 S PXCEQUIT=0
"RTN","PXCEVFIL",27,0)
 I '$D(PXCAAFTR),PXCECAT'="SIT",PXCECAT'="APPM",PXCECAT'="HIST",PXCEFIEN'>0 D ASK^PXCEVFI2(PXCEVIEN,.PXCEFIEN,PXCEAUPN,PXCECATT,PXCECODE)
"RTN","PXCEVFIL",28,0)
 Q:PXCEQUIT
"RTN","PXCEVFIL",29,0)
 I PXCECAT'="SIT",PXCECAT'="APPM",PXCECAT'="HIST" S PXCELOOP=+PXCEFIEN
"RTN","PXCEVFIL",30,0)
 E  S PXCELOOP=1,PXCEFIEN=PXCEVIEN
"RTN","PXCEVFIL",31,0)
 I PXCECAT="CSTP" D
"RTN","PXCEVFIL",32,0)
 . I $$VSTAPPT^PXUTL1(PXCEPAT,+^AUPNVSIT(PXCEVIEN,0),PXCEHLOC,PXCEVIEN) S PXCELOOP=0
"RTN","PXCEVFIL",33,0)
 . E  S PXCELOOP=1
"RTN","PXCEVFIL",34,0)
 I $D(PXCAAFTR) S PXCELOOP=1
"RTN","PXCEVFIL",35,0)
 F  D DOONE Q:PXCELOOP
"RTN","PXCEVFIL",36,0)
 K PXCEFIEN
"RTN","PXCEVFIL",37,0)
 Q
"RTN","PXCEVFIL",38,0)
 ;
"RTN","PXCEVFIL",39,0)
DOONE ;
"RTN","PXCEVFIL",40,0)
 N PXCEUP,PXELAP
"RTN","PXCEVFIL",41,0)
 N PXCEAFTR
"RTN","PXCEVFIL",42,0)
 D INIT
"RTN","PXCEVFIL",43,0)
 Q:PXCEQUIT
"RTN","PXCEVFIL",44,0)
DOONE2 ;
"RTN","PXCEVFIL",45,0)
 K PXKERROR
"RTN","PXCEVFIL",46,0)
 S PXCENOER=0
"RTN","PXCEVFIL",47,0)
 D EDIT^PXCEVFI1
"RTN","PXCEVFIL",48,0)
 I ($P(PXCEAFTR(0),"^")]"") D
"RTN","PXCEVFIL",49,0)
 . I PXCEQUIT D
"RTN","PXCEVFIL",50,0)
 .. I 'PXCEFIEN,PXCECAT="CPT" D
"RTN","PXCEVFIL",51,0)
 ... D REMOVE(^TMP("PXK",$J,PXCECAT,1,"IEN"))
"RTN","PXCEVFIL",52,0)
 .. I 'PXCENOER D
"RTN","PXCEVFIL",53,0)
 ... I PXCEFIEN>0 D
"RTN","PXCEVFIL",54,0)
 .... D:PXCECAT="CPT" MODUPD
"RTN","PXCEVFIL",55,0)
 .... W !,$C(7),"The last entry did not have all of the required data and NOTHING was CHANGED."
"RTN","PXCEVFIL",56,0)
 ... E  W !,$C(7),"The last entry did not have all of the required data and NOTHING was STORED."
"RTN","PXCEVFIL",57,0)
 ... D WAIT^PXCEHELP
"RTN","PXCEVFIL",58,0)
 . E  D SAVE^PXCEVFI2
"RTN","PXCEVFIL",59,0)
 D EXIT
"RTN","PXCEVFIL",60,0)
 Q
"RTN","PXCEVFIL",61,0)
 ;
"RTN","PXCEVFIL",62,0)
INIT ; -- init variables and list array
"RTN","PXCEVFIL",63,0)
 N PXCENODS,PXCEFOR,PXCENODE
"RTN","PXCEVFIL",64,0)
 K ^TMP("PXK",$J),PXCEAFTR
"RTN","PXCEVFIL",65,0)
 S ^TMP("PXK",$J,"SOR")=PXCESOR
"RTN","PXCEVFIL",66,0)
 S ^TMP("PXK",$J,"VST",1,"IEN")=PXCEVIEN
"RTN","PXCEVFIL",67,0)
 I PXCECAT="SIT"!(PXCECAT="APPM")!(PXCECAT="HIST") D
"RTN","PXCEVFIL",68,0)
 . I PXCEVIEN>0 L +@(PXCEAUPN_"(PXCEVIEN)"):5 E  W !!,$C(7),"Cannot edit at this time, try again later." D PAUSE^PXCEHELP S PXCEQUIT=1 Q
"RTN","PXCEVFIL",69,0)
 . F PXCENODE=0,21,150,800,811,812 D
"RTN","PXCEVFIL",70,0)
 .. S PXCEAFTR(PXCENODE)=$S(PXCEVIEN>0:$G(^AUPNVSIT(PXCEVIEN,PXCENODE)),1:"")
"RTN","PXCEVFIL",71,0)
 .. S ^TMP("PXK",$J,"VST",1,PXCENODE,"BEFORE")=PXCEAFTR(PXCENODE)
"RTN","PXCEVFIL",72,0)
 E  D
"RTN","PXCEVFIL",73,0)
 . I PXCEFIEN>0 L +@(PXCEAUPN_"(PXCEFIEN)"):5 E  W !!,$C(7),"Cannot edit at this time, try again later." D PAUSE^PXCEHELP S PXCEQUIT=1 Q
"RTN","PXCEVFIL",74,0)
 . F PXCENODE=0,21,150,800,811,812 D
"RTN","PXCEVFIL",75,0)
 .. S ^TMP("PXK",$J,"VST",1,PXCENODE,"BEFORE")=$G(^AUPNVSIT(+PXCEVIEN,PXCENODE))
"RTN","PXCEVFIL",76,0)
 .. S ^TMP("PXK",$J,"VST",1,PXCENODE,"AFTER")=^TMP("PXK",$J,"VST",1,PXCENODE,"BEFORE")
"RTN","PXCEVFIL",77,0)
 . ;
"RTN","PXCEVFIL",78,0)
 . S ^TMP("PXK",$J,PXCECATS,1,"IEN")=PXCEFIEN
"RTN","PXCEVFIL",79,0)
 . S PXCENODS=$P($T(FORMAT^@PXCECODE),"~",3)
"RTN","PXCEVFIL",80,0)
 . F PXCEFOR=1:1 S PXCENODE=$P(PXCENODS,",",PXCEFOR) Q:PXCENODE']""  D
"RTN","PXCEVFIL",81,0)
 .. I PXCEFIEN>0 D
"RTN","PXCEVFIL",82,0)
 ... I PXCECAT="CPT",PXCENODE=1 D
"RTN","PXCEVFIL",83,0)
 .... ;Retrieve CPT Modifiers from multiple field
"RTN","PXCEVFIL",84,0)
 .... S PXCESEQ=0
"RTN","PXCEVFIL",85,0)
 .... F  S PXCESEQ=$O(@(PXCEAUPN_"(PXCEFIEN,PXCENODE,PXCESEQ)")) Q:'PXCESEQ  D
"RTN","PXCEVFIL",86,0)
 ..... S ^TMP("PXK",$J,PXCECATS,1,PXCENODE,PXCESEQ,"BEFORE")=$G(@(PXCEAUPN_"(PXCEFIEN,PXCENODE,PXCESEQ,0)"))
"RTN","PXCEVFIL",87,0)
 ..... S PXCEAFTR(PXCENODE,PXCESEQ)=^TMP("PXK",$J,PXCECATS,1,PXCENODE,PXCESEQ,"BEFORE")
"RTN","PXCEVFIL",88,0)
 ... E  D
"RTN","PXCEVFIL",89,0)
 .... S ^TMP("PXK",$J,PXCECATS,1,PXCENODE,"BEFORE")=$G(@(PXCEAUPN_"(PXCEFIEN,PXCENODE)"))
"RTN","PXCEVFIL",90,0)
 .... S PXCEAFTR(PXCENODE)=^TMP("PXK",$J,PXCECATS,1,PXCENODE,"BEFORE")
"RTN","PXCEVFIL",91,0)
 .. E  D
"RTN","PXCEVFIL",92,0)
 ... I PXCECAT="CPT",PXCENODE=1 D  Q
"RTN","PXCEVFIL",93,0)
 .... S ^TMP("PXK",$J,PXCECATS,1,PXCENODE,1,"BEFORE")=""
"RTN","PXCEVFIL",94,0)
 ... S ^TMP("PXK",$J,PXCECATS,1,PXCENODE,"BEFORE")=""
"RTN","PXCEVFIL",95,0)
 ... S PXCEAFTR(PXCENODE)=^TMP("PXK",$J,PXCECATS,1,PXCENODE,"BEFORE")
"RTN","PXCEVFIL",96,0)
 Q:PXCEQUIT
"RTN","PXCEVFIL",97,0)
 ;
"RTN","PXCEVFIL",98,0)
 I PXCEAUPN'="^AUPNVSIT" D
"RTN","PXCEVFIL",99,0)
 . ;Set the Patient and Visit pointers in the V-File.
"RTN","PXCEVFIL",100,0)
 . S:'$P(PXCEAFTR(0),"^",2) $P(PXCEAFTR(0),"^",2)=PXCEPAT
"RTN","PXCEVFIL",101,0)
 . S:'$P(PXCEAFTR(0),"^",3) $P(PXCEAFTR(0),"^",3)=PXCEVIEN
"RTN","PXCEVFIL",102,0)
 . I $P(PXCEAFTR(0),"^",1)="" D
"RTN","PXCEVFIL",103,0)
 .. S:'$P(PXCEAFTR(812),"^",2) $P(PXCEAFTR(812),"^",2)=PXCEPKG
"RTN","PXCEVFIL",104,0)
 .. S:'$P(PXCEAFTR(812),"^",3) $P(PXCEAFTR(812),"^",3)=PXCESOR
"RTN","PXCEVFIL",105,0)
 E  D
"RTN","PXCEVFIL",106,0)
 . ;If new visit set package and source.
"RTN","PXCEVFIL",107,0)
 . I $P(PXCEAFTR(0),"^",1)="" D
"RTN","PXCEVFIL",108,0)
 .. S:'$P(PXCEAFTR(812),"^",2) $P(PXCEAFTR(812),"^",2)=PXCEPKG
"RTN","PXCEVFIL",109,0)
 .. S:'$P(PXCEAFTR(812),"^",3) $P(PXCEAFTR(812),"^",3)=PXCESOR
"RTN","PXCEVFIL",110,0)
 . ;Set the Patient in the Visit for new visit.
"RTN","PXCEVFIL",111,0)
 . I $G(PXCEAPDT)>0 D
"RTN","PXCEVFIL",112,0)
 .. S:'$P(PXCEAFTR(0),"^",1) $P(PXCEAFTR(0),"^",1)=PXCEAPDT
"RTN","PXCEVFIL",113,0)
 .. I '$P(PXCEAFTR(0),"^",21) D
"RTN","PXCEVFIL",114,0)
 ... ;Get the ELIGIBILITY for the appointment
"RTN","PXCEVFIL",115,0)
 ... N PXCEELIG
"RTN","PXCEVFIL",116,0)
 ... S PXCEELIG=$$ELIGIBIL^PXCEVSIT(PXCEPAT,PXCEHLOC,PXCEAPDT)
"RTN","PXCEVFIL",117,0)
 ... S:PXCEELIG>0 $P(PXCEAFTR(0),"^",21)=PXCEELIG
"RTN","PXCEVFIL",118,0)
 . S:'$P(PXCEAFTR(0),"^",5)&($G(PXCEPAT)>0) $P(PXCEAFTR(0),"^",5)=PXCEPAT
"RTN","PXCEVFIL",119,0)
 . S:'$P(PXCEAFTR(0),"^",22)&($G(PXCEHLOC)>0) $P(PXCEAFTR(0),"^",22)=PXCEHLOC
"RTN","PXCEVFIL",120,0)
 Q
"RTN","PXCEVFIL",121,0)
 ;
"RTN","PXCEVFIL",122,0)
EXIT ; -- exit code
"RTN","PXCEVFIL",123,0)
 I PXCECAT="SIT"!(PXCECAT="APPM")!(PXCECAT="HIST") L:PXCEVIEN>0 -@(PXCEAUPN_"(PXCEVIEN)"):30
"RTN","PXCEVFIL",124,0)
 E  L:PXCEFIEN>0 -@(PXCEAUPN_"(PXCEFIEN)"):30
"RTN","PXCEVFIL",125,0)
 S PXCEFIEN=""
"RTN","PXCEVFIL",126,0)
 K ^TMP("PXK",$J)
"RTN","PXCEVFIL",127,0)
 K PXCEAFTR
"RTN","PXCEVFIL",128,0)
 S PXCEQUIT=0
"RTN","PXCEVFIL",129,0)
 Q
"RTN","PXCEVFIL",130,0)
 ;
"RTN","PXCEVFIL",131,0)
MODUPD ;Update the MODIFIER list for the currently edited CPT code when all
"RTN","PXCEVFIL",132,0)
 ;the reqired data is not entered.
"RTN","PXCEVFIL",133,0)
 ;
"RTN","PXCEVFIL",134,0)
 N SQ,DA,DIC,DIK,X
"RTN","PXCEVFIL",135,0)
 S SQ=""
"RTN","PXCEVFIL",136,0)
 F  S SQ=$O(PXCEAFTR(1,SQ)) Q:'SQ  D
"RTN","PXCEVFIL",137,0)
 .S DA(1)=PXCEFIEN,DA=SQ
"RTN","PXCEVFIL",138,0)
 .S DIK="^AUPNVCPT("_DA(1)_","_1_","
"RTN","PXCEVFIL",139,0)
 .D ^DIK
"RTN","PXCEVFIL",140,0)
 F  S SQ=$O(^TMP("PXK",$J,"CPT",1,1,SQ)) Q:'SQ  D
"RTN","PXCEVFIL",141,0)
 .S X=^TMP("PXK",$J,"CPT",1,1,SQ,"BEFORE")
"RTN","PXCEVFIL",142,0)
 .Q:X']""
"RTN","PXCEVFIL",143,0)
 .K DD,DO
"RTN","PXCEVFIL",144,0)
 .S DA(1)=PXCEFIEN
"RTN","PXCEVFIL",145,0)
 .S DIC="^AUPNVCPT("_DA(1)_","_1_","
"RTN","PXCEVFIL",146,0)
 .S DIC(0)="L",DIC("P")=$P(^DD(9000010.18,1,0),"^",2)
"RTN","PXCEVFIL",147,0)
 .D FILE^DICN
"RTN","PXCEVFIL",148,0)
 Q
"RTN","PXCEVFIL",149,0)
 ;
"RTN","PXCEVFIL",150,0)
REMOVE(DA) ;REMOVE INCOMPLETE CPT ENTRY
"RTN","PXCEVFIL",151,0)
 N DIK
"RTN","PXCEVFIL",152,0)
 S DIK="^AUPNVCPT("
"RTN","PXCEVFIL",153,0)
 I $G(DA) D ^DIK ;PX*1*124
"RTN","PXCEVFIL",154,0)
 Q
"RTN","PXCEVSIT")
0^14^B25028869
"RTN","PXCEVSIT",1,0)
PXCEVSIT ;slc/dee,ISA/KWP-Used in editing a visit ; 1/7/02 11:36am
"RTN","PXCEVSIT",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**9,23,70,116,147**;Aug 12, 1996
"RTN","PXCEVSIT",3,0)
 Q
"RTN","PXCEVSIT",4,0)
 ;
"RTN","PXCEVSIT",5,0)
 ;********************************
"RTN","PXCEVSIT",6,0)
 ;
"RTN","PXCEVSIT",7,0)
 ;Functions
"RTN","PXCEVSIT",8,0)
 ;
"RTN","PXCEVSIT",9,0)
ELIGIBIL(PATIENT,HOSPLOC,DATETIME) ;+Eligibility from appointment if there is one.
"RTN","PXCEVSIT",10,0)
 Q:$G(PATIENT)'>0 -1
"RTN","PXCEVSIT",11,0)
 Q:$G(HOSPLOC)'>0 -1
"RTN","PXCEVSIT",12,0)
 Q:$G(DATETIME)'>1600000 -1
"RTN","PXCEVSIT",13,0)
 Q:'($D(^SC(HOSPLOC,"S",DATETIME,1))\10) -1
"RTN","PXCEVSIT",14,0)
 N PXCEELIG,PXCEINDX
"RTN","PXCEVSIT",15,0)
 S PXCEELIG=-1
"RTN","PXCEVSIT",16,0)
 S PXCEINDX=0
"RTN","PXCEVSIT",17,0)
 F  S PXCEINDX=$O(^SC(HOSPLOC,"S",DATETIME,1,PXCEINDX)) Q:PXCEINDX=""  I $P($G(^SC(HOSPLOC,"S",DATETIME,1,PXCEINDX,0)),"^",1)=PATIENT S PXCEELIG=$S($P(^(0),"^",10)>0:$P(^(0),"^",10),1:-1) Q
"RTN","PXCEVSIT",18,0)
 Q PXCEELIG
"RTN","PXCEVSIT",19,0)
 ;
"RTN","PXCEVSIT",20,0)
 ;********************************
"RTN","PXCEVSIT",21,0)
 ;Special cases for edit of the visit.
"RTN","PXCEVSIT",22,0)
 ;
"RTN","PXCEVSIT",23,0)
EVISITDT(REQTIME,DEFAULT) ;
"RTN","PXCEVSIT",24,0)
 ;+REQTIME is 1 if time is required,
"RTN","PXCEVSIT",25,0)
 ;+           0 if time is optional
"RTN","PXCEVSIT",26,0)
 ;+          -1 if the date can be imprecise
"RTN","PXCEVSIT",27,0)
 ;+DEFAULT is the default date/time is there is not one in the file.
"RTN","PXCEVSIT",28,0)
 ;+        If it is -1 then NOW will be used as the default.
"RTN","PXCEVSIT",29,0)
 ;+        If it is 0 then TODAY will be used as the default.
"RTN","PXCEVSIT",30,0)
 N PXLIMDT
"RTN","PXCEVSIT",31,0)
 S PXLIMDT=$S(PXCECAT="HIST":0,1:$$SWITCHD^PXAPI)
"RTN","PXCEVSIT",32,0)
 S DIR(0)="DO^"_$S(PXLIMDT>2960000:PXLIMDT,1:"")_":"_(DT+.24)_":ESP"
"RTN","PXCEVSIT",33,0)
 I $G(REQTIME)=1 S DIR(0)=DIR(0)_"RX"
"RTN","PXCEVSIT",34,0)
 E  I $G(REQTIME)=-1 S DIR(0)=DIR(0)_"T"
"RTN","PXCEVSIT",35,0)
 E  S DIR(0)=DIR(0)_"TX"
"RTN","PXCEVSIT",36,0)
 I $P(PXCEAFTR($P(PXCETEXT,"~",1)),"^",$P(PXCETEXT,"~",2))'="" S DIR("B")=$P(PXCEAFTR($P(PXCETEXT,"~",1)),"^",$P(PXCETEXT,"~",2))
"RTN","PXCEVSIT",37,0)
 E  I ($D(DEFAULT)#2) D
"RTN","PXCEVSIT",38,0)
 . N %H,%I,%
"RTN","PXCEVSIT",39,0)
 . I DEFAULT>0 S DIR("B")=DEFAULT
"RTN","PXCEVSIT",40,0)
 . E  I DEFAULT=0 S DIR("B")=DT
"RTN","PXCEVSIT",41,0)
 . E  I DEFAULT=-1 D NOW^%DTC S DIR("B")=%
"RTN","PXCEVSIT",42,0)
 I $D(DIR("B"))#2 S Y=DIR("B") D DD^%DT S DIR("B")=Y
"RTN","PXCEVSIT",43,0)
 S DIR("A")=$P(PXCETEXT,"~",4)
"RTN","PXCEVSIT",44,0)
 S:$P(PXCETEXT,"~",8)]"" DIR("?")=$P(PXCETEXT,"~",8)
"RTN","PXCEVSIT",45,0)
 D ^DIR
"RTN","PXCEVSIT",46,0)
 I '$D(DIRUT),'$D(DUOUT),+VADM(6),$P(Y,".")>+VADM(6) S (DIRUT,DUOUT)=1 W VADM(7) R Y:10
"RTN","PXCEVSIT",47,0)
 K DIR,DA
"RTN","PXCEVSIT",48,0)
 Q
"RTN","PXCEVSIT",49,0)
 ;
"RTN","PXCEVSIT",50,0)
 ;
"RTN","PXCEVSIT",51,0)
EHOSPLOC ;
"RTN","PXCEVSIT",52,0)
 N HLOC
"RTN","PXCEVSIT",53,0)
 I $P(PXCEAFTR(0),"^",22)'="" D
"RTN","PXCEVSIT",54,0)
 . N DIERR,PXCEDILF,PXCEINT,PXCEEXT
"RTN","PXCEVSIT",55,0)
 . S PXCEINT=$P(PXCEAFTR($P(PXCETEXT,"~",1)),"^",$P(PXCETEXT,"~",2))
"RTN","PXCEVSIT",56,0)
 . S PXCEEXT=$$EXTERNAL^DILFD(PXCEFILE,$P(PXCETEXT,"~",3),"",PXCEINT,"PXCEDILF")
"RTN","PXCEVSIT",57,0)
 . S DIR("B")=$S('$D(DIERR):PXCEEXT,1:PXCEINT)
"RTN","PXCEVSIT",58,0)
 S DIR(0)="PA^44:AEMQ"
"RTN","PXCEVSIT",59,0)
 S DIR("A")=$P(PXCETEXT,"~",4)
"RTN","PXCEVSIT",60,0)
 I $P(PXCETEXT,"~",8)]"" S DIR("?")=$P(PXCETEXT,"~",8)
"RTN","PXCEVSIT",61,0)
 ;Only clinics that are not occasion of service 
"RTN","PXCEVSIT",62,0)
 ; and are not dispositioning clinics
"RTN","PXCEVSIT",63,0)
 ;S DIR("S")="I $P(^(0),U,3)=""C""&'+$G(^(""OOS""))&'$O(^PX(815,1,""DHL"",""B"",Y,0))"
"RTN","PXCEVSIT",64,0)
 ;Only hospital locations that are not dispositioning clinics
"RTN","PXCEVSIT",65,0)
 ;
"RTN","PXCEVSIT",66,0)
 ;not occasion of service and not dispositioning clinics
"RTN","PXCEVSIT",67,0)
 ;S DIR("S")="I '+$G(^(""OOS""))&'$O(^PX(815,1,""DHL"",""B"",Y,0))"
"RTN","PXCEVSIT",68,0)
 ;Exclude disposition clinics from the above listed condition.
"RTN","PXCEVSIT",69,0)
 S DIR("S")="I '+$G(^(""OOS""))" ;PX*1*116
"RTN","PXCEVSIT",70,0)
 D ^DIR
"RTN","PXCEVSIT",71,0)
 K DIR,DA
"RTN","PXCEVSIT",72,0)
 I $D(DTOUT)!$D(DUOUT) S (PXCEEND,PXCEQUIT)=1 Q
"RTN","PXCEVSIT",73,0)
 I +Y'>0,PXCECAT'="HIST" D HELPHLOC W !,$C(7) G EHOSPLOC
"RTN","PXCEVSIT",74,0)
 S HLOC=$S(+Y>0:+Y,1:"")
"RTN","PXCEVSIT",75,0)
 S $P(PXCEAFTR(0),"^",22)=HLOC
"RTN","PXCEVSIT",76,0)
 ;
"RTN","PXCEVSIT",77,0)
 ;Get the eligibility and appointment type
"RTN","PXCEVSIT",78,0)
 ;  if there is not already an appointment.
"RTN","PXCEVSIT",79,0)
 ;  Creating a new visit or will lookup and find an old visit.
"RTN","PXCEVSIT",80,0)
 I '$$APPOINT^PXUTL1(PXCEPAT,+PXCEAFTR(0),HLOC) D
"RTN","PXCEVSIT",81,0)
 . S PXELAP=$$ELAP^SDPCE($P(PXCEAFTR(0),"^",5),$P(PXCEAFTR(0),"^",22))
"RTN","PXCEVSIT",82,0)
 E  I HLOC>0 D
"RTN","PXCEVSIT",83,0)
 . ;Get the ELIGIBILITY for the appointment if there is one.
"RTN","PXCEVSIT",84,0)
 . N PXCEELIG
"RTN","PXCEVSIT",85,0)
 . S PXCEELIG=$$ELIGIBIL(PXCEPAT,HLOC,$P(PXCEAFTR(0),"^",1))
"RTN","PXCEVSIT",86,0)
 . S:PXCEELIG>0 $P(PXCEAFTR(0),"^",21)=PXCEELIG
"RTN","PXCEVSIT",87,0)
 Q
"RTN","PXCEVSIT",88,0)
 ;
"RTN","PXCEVSIT",89,0)
HELPDISP ;
"RTN","PXCEVSIT",90,0)
 W !,"You can not select a Dispositioning Clinic."
"RTN","PXCEVSIT",91,0)
 Q
"RTN","PXCEVSIT",92,0)
 ;
"RTN","PXCEVSIT",93,0)
HELPHLOC ;
"RTN","PXCEVSIT",94,0)
 W !!,"Enter the name of the Clinic for this Encounter."
"RTN","PXCEVSIT",95,0)
 W !,"Hospital Location is required."
"RTN","PXCEVSIT",96,0)
 Q
"RTN","PXCEVSIT",97,0)
 ;
"RTN","PXCEVSIT",98,0)
EWORKLOD(ASK) ;
"RTN","PXCEVSIT",99,0)
 ;+If ASK=0 do not ask default to the one for the Hospital Location
"RTN","PXCEVSIT",100,0)
 N DIC,DA
"RTN","PXCEVSIT",101,0)
EWORKLD2 ;
"RTN","PXCEVSIT",102,0)
 K DTOUT,DUOUT,DIC,DA
"RTN","PXCEVSIT",103,0)
 I $P(PXCEAFTR(0),"^",8)+$P(PXCEAFTR(0),"^",22) D
"RTN","PXCEVSIT",104,0)
 . N DIERR,PXCEDILF,PXCEINT,PXCEEXT
"RTN","PXCEVSIT",105,0)
 . I $P(PXCEAFTR(0),"^",8)'="" S PXCEINT=$P(PXCEAFTR(0),"^",8)
"RTN","PXCEVSIT",106,0)
 . E  S PXCEINT=$P(^SC($P(PXCEAFTR(0),"^",22),0),"^",7)
"RTN","PXCEVSIT",107,0)
 . S Y=+PXCEINT
"RTN","PXCEVSIT",108,0)
 . S PXCEEXT=$$EXTERNAL^DILFD(PXCEFILE,$P(PXCETEXT,"~",3),"",PXCEINT,"PXCEDILF")
"RTN","PXCEVSIT",109,0)
 . S DIC("B")=$S('$D(DIERR):PXCEEXT,1:$P(PXCEAFTR(0),"^",8))
"RTN","PXCEVSIT",110,0)
 S DIC="^DIC(40.7,"
"RTN","PXCEVSIT",111,0)
 S DIC(0)="AEM"
"RTN","PXCEVSIT",112,0)
 S DIC("S")="I $P(^(0),U,3)=""""!($P(^(0),U,3)'<$P(PXCEAFTR(0),U))"
"RTN","PXCEVSIT",113,0)
 S DIC("A")=$P(PXCETEXT,"~",4)
"RTN","PXCEVSIT",114,0)
 I Y'>0!ASK D
"RTN","PXCEVSIT",115,0)
 . D ^DIC
"RTN","PXCEVSIT",116,0)
 K DIR,DA
"RTN","PXCEVSIT",117,0)
 I $D(DTOUT)!$D(DUOUT) S (PXCEEND,PXCEQUIT)=1 Q
"RTN","PXCEVSIT",118,0)
 I +Y'>0,PXCECAT'="HIST" G EWORKLD2
"RTN","PXCEVSIT",119,0)
 ;+set the stop code into the visit file
"RTN","PXCEVSIT",120,0)
 S $P(PXCEAFTR(0),"^",8)=$S(+Y>0:+Y,1:"")
"RTN","PXCEVSIT",121,0)
 N PXHLOC,PXSC
"RTN","PXCEVSIT",122,0)
 S PXHLOC=$P(PXCEAFTR(0),"^",22)
"RTN","PXCEVSIT",123,0)
 S PXSC=$P($G(^SC(+PXHLOC,0)),"^",7)
"RTN","PXCEVSIT",124,0)
 ;+if the hospital location is a ward then set the encounter type to a P for primary
"RTN","PXCEVSIT",125,0)
 I $P($G(^SC(+PXHLOC,0)),"^",3)["W" S $P(PXCEAFTR(150),"^",3)="P" Q
"RTN","PXCEVSIT",126,0)
 ;+if the stop code on file for the hospital location is the stop code entered or if the stop code in the hospital location file is null then set the encounter type to P for primary
"RTN","PXCEVSIT",127,0)
 I PXSC=+Y!(PXSC=""&PXHLOC) S $P(PXCEAFTR(150),"^",3)="P"
"RTN","PXCEVSIT",128,0)
 Q
"RTN","PXCEVSIT",129,0)
 ;
"RTN","PXCEVSIT",130,0)
ECODT ;Check out date time
"RTN","PXCEVSIT",131,0)
 N PXCHKOUT
"RTN","PXCEVSIT",132,0)
 D CHIKOUT^PXBAPI2("",PXCEPAT,+$P(PXCEAFTR(0),"^",22),$P(PXCEAFTR(0),"^",1))
"RTN","PXCEVSIT",133,0)
 S:PXCHKOUT>0 $P(PXCEAFTR($P(PXCETEXT,"~",1)),"^",$P(PXCETEXT,"~",2))=PXCHKOUT
"RTN","PXCEVSIT",134,0)
 Q
"RTN","PXCEVSIT",135,0)
 ;
"RTN","PXCEVSIT",136,0)
EPAT ;
"RTN","PXCEVSIT",137,0)
 I $P(PXCEAFTR(0),"^",5)'="" Q
"RTN","PXCEVSIT",138,0)
 S DIR(0)="9000010,.05A"
"RTN","PXCEVSIT",139,0)
 S DIR("A")=$P(PXCETEXT,"~",4)
"RTN","PXCEVSIT",140,0)
 S:$P(PXCETEXT,"~",8)]"" DIR("?")=$P(PXCETEXT,"~",8)
"RTN","PXCEVSIT",141,0)
 D ^DIR
"RTN","PXCEVSIT",142,0)
 K DIR,DA
"RTN","PXCEVSIT",143,0)
 I X="@" S Y="@"
"RTN","PXCEVSIT",144,0)
 E  I $D(DTOUT)!$D(DUOUT) S (PXCEEND,PXCEQUIT)=1 Q  ;for visit
"RTN","PXCEVSIT",145,0)
 S $P(PXCEAFTR(0),"^",5)=$P(Y,"^")
"RTN","PXCEVSIT",146,0)
 S PXCEPAT=$P(Y,"^") D PATINFO^PXCEPAT(.PXCEPAT) I $D(DTOUT)!$D(DUOUT) S (PXCEEND,PXCEQUIT)=1  ;PX*1*147
"RTN","PXCEVSIT",147,0)
 Q
"RTN","PXCEVSIT",148,0)
 ;
"RTN","PXCEVSIT",149,0)
SKIP ;Just returns used when need a edit routine that does nothing.
"RTN","PXCEVSIT",150,0)
 Q
"RTN","PXCEVSIT",151,0)
 ;
"RTN","PXRRPECS")
0^2^B38623626
"RTN","PXRRPECS",1,0)
PXRRPECS ;ISL/PKR - Build a list of Person Class entries. ;12/11/96
"RTN","PXRRPECS",2,0)
 ;;1.0;PCE PATIENT CARE ENCOUNTER;**12,147**;Aug 12, 1996
"RTN","PXRRPECS",3,0)
 ;
"RTN","PXRRPECS",4,0)
 ;=======================================================================
"RTN","PXRRPECS",5,0)
PCLASS ;Build a list of person classes.
"RTN","PXRRPECS",6,0)
 N BELL,IC,INDENT,JC,NOCC,NS,NSPEC,NSUB,OCC,OCCIEN,PCLASS
"RTN","PXRRPECS",7,0)
 N SELECT,SOCC,SOCCW,SPEC,SPECIEN,SSPEC,SSPECW,SUB,SSUB,TEMP,WC,X,Y
"RTN","PXRRPECS",8,0)
 ;We will need a DBIA for reading the Person Class file.
"RTN","PXRRPECS",9,0)
 ;Build a list of the OCCUPATION entries in the Person Class file.
"RTN","PXRRPECS",10,0)
 S IC=0
"RTN","PXRRPECS",11,0)
 F  S IC=$O(^USC(8932.1,IC)) Q:+IC=0  D
"RTN","PXRRPECS",12,0)
 . S TEMP=$P(^USC(8932.1,IC,0),U,1)
"RTN","PXRRPECS",13,0)
 . I $L(TEMP)>0 S OCC($$UPPRCASE^PXRRPECU(TEMP))=TEMP
"RTN","PXRRPECS",14,0)
 ;
"RTN","PXRRPECS",15,0)
 ;Count the number of Occupation entries.
"RTN","PXRRPECS",16,0)
 S NOCC=0
"RTN","PXRRPECS",17,0)
 S IC=""
"RTN","PXRRPECS",18,0)
 F  S IC=$O(OCC(IC)) Q:IC=""  D
"RTN","PXRRPECS",19,0)
 . S NOCC=NOCC+1
"RTN","PXRRPECS",20,0)
 ;
"RTN","PXRRPECS",21,0)
 S BELL=$C(7)
"RTN","PXRRPECS",22,0)
 ;Set the wildcard to be *.
"RTN","PXRRPECS",23,0)
 S WC="*"
"RTN","PXRRPECS",24,0)
 ;NS is NOT SPECIFIED.
"RTN","PXRRPECS",25,0)
 S NS="NOT SPECIFIED"
"RTN","PXRRPECS",26,0)
 S INDENT=3
"RTN","PXRRPECS",27,0)
 S NCL=0
"RTN","PXRRPECS",28,0)
 K PXRRPECL
"RTN","PXRRPECS",29,0)
MPROMPT W !,"Select PERSON CLASS (OCCUPATION, SPECIALTY, SUBSPECIALTY)"
"RTN","PXRRPECS",30,0)
 K DTOUT,DUOUT
"RTN","PXRRPECS",31,0)
 W !
"RTN","PXRRPECS",32,0)
NPCLASS ;
"RTN","PXRRPECS",33,0)
 I NCL'<1 W !!,"Select another PERSON CLASS OCCUPATION"
"RTN","PXRRPECS",34,0)
 ;Select an occupation.
"RTN","PXRRPECS",35,0)
NOCC S DIR(0)="FAOU^1:60"
"RTN","PXRRPECS",36,0)
 S DIR("?")="^D OCCHLP^PXRRPECS"
"RTN","PXRRPECS",37,0)
 S DIR("??")="^D LISTA^PXRRPECU(.OCC)"
"RTN","PXRRPECS",38,0)
 S DIR("A")=" Select OCCUPATION (enter "_WC_" for all, return to end selection): "
"RTN","PXRRPECS",39,0)
 W !
"RTN","PXRRPECS",40,0)
 D ^DIR
"RTN","PXRRPECS",41,0)
 K DIR
"RTN","PXRRPECS",42,0)
 I $D(DIROUT) S DTOUT=1
"RTN","PXRRPECS",43,0)
 I $D(DTOUT)!$D(DUOUT) Q
"RTN","PXRRPECS",44,0)
 S SOCC=$$FDME^PXRRPECU(Y,.OCC)
"RTN","PXRRPECS",45,0)
 I SOCC=-1 W " ??",BELL G NOCC
"RTN","PXRRPECS",46,0)
 I ($P(SOCC,U,1)="")&(NCL=0) D  G MPROMPT
"RTN","PXRRPECS",47,0)
 . W !,"You must select a person class!"
"RTN","PXRRPECS",48,0)
 I $P(SOCC,U,1)="" Q
"RTN","PXRRPECS",49,0)
 I $P(SOCC,U,1)=WC S SOCCW=1
"RTN","PXRRPECS",50,0)
 E  S SOCCW=0
"RTN","PXRRPECS",51,0)
 ;
"RTN","PXRRPECS",52,0)
 ;Build a list of iens for SOCC (Selected OCCupation).
"RTN","PXRRPECS",53,0)
 K OCCIEN
"RTN","PXRRPECS",54,0)
 K SPEC
"RTN","PXRRPECS",55,0)
 I ('SOCCW) D
"RTN","PXRRPECS",56,0)
 . S TEMP=$E($P(SOCC,U,2),1,62)
"RTN","PXRRPECS",57,0)
 . S IC=0
"RTN","PXRRPECS",58,0)
 . F  S IC=$O(^USC(8932.1,"B",TEMP,IC)) Q:+IC=0  D
"RTN","PXRRPECS",59,0)
 .. S OCCIEN(IC)=""
"RTN","PXRRPECS",60,0)
 ;
"RTN","PXRRPECS",61,0)
 ;Build a list of specialties valid for SOCC.
"RTN","PXRRPECS",62,0)
 S IC=0
"RTN","PXRRPECS",63,0)
 F  S IC=$O(OCCIEN(IC)) Q:+IC=0  D
"RTN","PXRRPECS",64,0)
 . S TEMP=$P(^USC(8932.1,IC,0),U,2)
"RTN","PXRRPECS",65,0)
 . I TEMP="" S TEMP=NS
"RTN","PXRRPECS",66,0)
 . S SPEC($$UPPRCASE^PXRRPECU(TEMP))=TEMP
"RTN","PXRRPECS",67,0)
 ;
"RTN","PXRRPECS",68,0)
 ;Special case for Occupation selected as wildcard.
"RTN","PXRRPECS",69,0)
 I SOCCW D
"RTN","PXRRPECS",70,0)
 . S IC=0
"RTN","PXRRPECS",71,0)
 . F  S IC=$O(^USC(8932.1,IC)) Q:+IC=0  D
"RTN","PXRRPECS",72,0)
 .. S TEMP=$P(^USC(8932.1,IC,0),U,2)
"RTN","PXRRPECS",73,0)
 .. I TEMP="" S TEMP=NS
"RTN","PXRRPECS",74,0)
 .. S SPEC($$UPPRCASE^PXRRPECU(TEMP))=TEMP
"RTN","PXRRPECS",75,0)
 ;
"RTN","PXRRPECS",76,0)
 ;Count the number of Specialty entries compatible with the selected
"RTN","PXRRPECS",77,0)
 ;Occupation.
"RTN","PXRRPECS",78,0)
 S NSPEC=0
"RTN","PXRRPECS",79,0)
 S IC=0
"RTN","PXRRPECS",80,0)
 F  S IC=$O(SPEC(IC)) Q:IC=""  D
"RTN","PXRRPECS",81,0)
 . S NSPEC=NSPEC+1
"RTN","PXRRPECS",82,0)
 ;
"RTN","PXRRPECS",83,0)
 I NSPEC=0 D  G NPCLASS
"RTN","PXRRPECS",84,0)
 . W !,"There are no specialties for:"
"RTN","PXRRPECS",85,0)
 . W !,?INDENT,"OCCUPATION: ",$P(SOCC,U,1)
"RTN","PXRRPECS",86,0)
 . S NCL=NCL+1
"RTN","PXRRPECS",87,0)
 . S PXRRPECL(NCL)=$P(SOCC,U,2)_U_NS_U_NS
"RTN","PXRRPECS",88,0)
 ;
"RTN","PXRRPECS",89,0)
 ;Select a specialty.
"RTN","PXRRPECS",90,0)
 S SSPEC=""
"RTN","PXRRPECS",91,0)
NSPEC I (NCL>0)&($L(SSPEC)>0) D VERIFY^PXRRPECU
"RTN","PXRRPECS",92,0)
 S DIR(0)="FAOU^1:50"
"RTN","PXRRPECS",93,0)
 S DIR("?")="^D SPECHLP^PXRRPECS"
"RTN","PXRRPECS",94,0)
 S DIR("??")="^D LISTA^PXRRPECU(.SPEC)"
"RTN","PXRRPECS",95,0)
 S DIR("A")=" Select SPECIALTY (enter "_WC_" for all, return to change OCCUPATION): "
"RTN","PXRRPECS",96,0)
 W !!,"The currently selected OCCUPATION is:"
"RTN","PXRRPECS",97,0)
 W !," ",$P(SOCC,U,2)
"RTN","PXRRPECS",98,0)
 D ^DIR K DIR
"RTN","PXRRPECS",99,0)
 I $D(DIROUT) S DTOUT=1
"RTN","PXRRPECS",100,0)
 I $D(DTOUT) Q
"RTN","PXRRPECS",101,0)
 I $D(DUOUT) G NOCC
"RTN","PXRRPECS",102,0)
 I $L(Y)=0 G NPCLASS
"RTN","PXRRPECS",103,0)
 S SSPEC=$$FDME^PXRRPECU(Y,.SPEC)
"RTN","PXRRPECS",104,0)
 I $P(SSPEC,U,1)="" G NPCLASS
"RTN","PXRRPECS",105,0)
 I SSPEC=-1 W " ??",BELL G NSPEC
"RTN","PXRRPECS",106,0)
 I $P(SSPEC,U,1)=WC S SSPECW=1
"RTN","PXRRPECS",107,0)
 E  S SSPECW=0
"RTN","PXRRPECS",108,0)
 ;
"RTN","PXRRPECS",109,0)
 ;Build a list of iens for SSPEC (Selected SPECialty).  Trim the OCCIEN
"RTN","PXRRPECS",110,0)
 ;list so it only contains entries valid for SOCC and SSPEC.
"RTN","PXRRPECS",111,0)
 K SPECIEN
"RTN","PXRRPECS",112,0)
 K SUB
"RTN","PXRRPECS",113,0)
 S IC=0
"RTN","PXRRPECS",114,0)
 F  S IC=$O(OCCIEN(IC)) Q:+IC=0  D
"RTN","PXRRPECS",115,0)
 . S SPECIEN(IC)=OCCIEN(IC)
"RTN","PXRRPECS",116,0)
 ;
"RTN","PXRRPECS",117,0)
 ;If SSPEC was selected as the wildcard then we don't need to do
"RTN","PXRRPECS",118,0)
 ;anything.
"RTN","PXRRPECS",119,0)
 I ('SSPECW)&('SOCCW) D
"RTN","PXRRPECS",120,0)
 . S TEMP=$P(SSPEC,U,2)
"RTN","PXRRPECS",121,0)
 . S IC=0
"RTN","PXRRPECS",122,0)
 . F  S IC=$O(SPECIEN(IC)) Q:+IC=0  D
"RTN","PXRRPECS",123,0)
 .. I $P(^USC(8932.1,IC,0),U,2)'=TEMP K SPECIEN(IC)
"RTN","PXRRPECS",124,0)
 ;
"RTN","PXRRPECS",125,0)
 ;Special case with SOCC=WC and SSPEC'=WC
"RTN","PXRRPECS",126,0)
 I ('SSPECW)&(SOCCW) D
"RTN","PXRRPECS",127,0)
 . S TEMP=$P(SSPEC,U,2)
"RTN","PXRRPECS",128,0)
 . S IC=0
"RTN","PXRRPECS",129,0)
 . F  S IC=$O(^USC(8932.1,IC)) Q:+IC=0  D
"RTN","PXRRPECS",130,0)
 .. I $P(^USC(8932.1,IC,0),U,2)=TEMP S SPECIEN(IC)=""
"RTN","PXRRPECS",131,0)
 ;
"RTN","PXRRPECS",132,0)
 ;Build a list of subspecialties valid for SOCC and SSPEC.
"RTN","PXRRPECS",133,0)
  S IC=0
"RTN","PXRRPECS",134,0)
  F  S IC=$O(SPECIEN(IC)) Q:+IC=0  D
"RTN","PXRRPECS",135,0)
 . S TEMP=$P(^USC(8932.1,IC,0),U,3)
"RTN","PXRRPECS",136,0)
 . I TEMP="" S TEMP=NS
"RTN","PXRRPECS",137,0)
 . S SUB($$UPPRCASE^PXRRPECU(TEMP))=TEMP
"RTN","PXRRPECS",138,0)
 ;
"RTN","PXRRPECS",139,0)
 ;Special case SOCC and SSPEC are wild.
"RTN","PXRRPECS",140,0)
 I (SSPECW)&(SOCCW) D
"RTN","PXRRPECS",141,0)
 . S IC=0
"RTN","PXRRPECS",142,0)
 . F  S IC=$O(^USC(8932.1,IC)) Q:+IC=0  D
"RTN","PXRRPECS",143,0)
 .. S TEMP=$P(^USC(8932.1,IC,0),U,3)
"RTN","PXRRPECS",144,0)
 .. I TEMP="" S TEMP=NS
"RTN","PXRRPECS",145,0)
 .. S SUB($$UPPRCASE^PXRRPECU(TEMP))=TEMP
"RTN","PXRRPECS",146,0)
 ;
"RTN","PXRRPECS",147,0)
 ;Count the number of entries.
"RTN","PXRRPECS",148,0)
 S NSUB=0
"RTN","PXRRPECS",149,0)
 S IC=""
"RTN","PXRRPECS",150,0)
 F  S IC=$O(SUB(IC)) Q:IC=""  D
"RTN","PXRRPECS",151,0)
 . S NSUB=NSUB+1
"RTN","PXRRPECS",152,0)
 ;
"RTN","PXRRPECS",153,0)
 I (NSUB=0)!((NSUB=1)&($D(SUB(NS)))) D  G NSPEC
"RTN","PXRRPECS",154,0)
 . W !,"There are no subspecialties for:"
"RTN","PXRRPECS",155,0)
 . W !,?INDENT,"OCCUPATION: ",$P(SOCC,U,1)
"RTN","PXRRPECS",156,0)
 . W !,?INDENT,"SPECIALTY:  ",$P(SSPEC,U,1)
"RTN","PXRRPECS",157,0)
 . S NCL=NCL+1
"RTN","PXRRPECS",158,0)
 . S PXRRPECL(NCL)=$P(SOCC,U,2)_U_$P(SSPEC,U,2)_U_NS
"RTN","PXRRPECS",159,0)
 ;
"RTN","PXRRPECS",160,0)
 ;Select a subspecialty.
"RTN","PXRRPECS",161,0)
NSUB S DIR(0)="FAOU^1:50"
"RTN","PXRRPECS",162,0)
 S DIR("?")="^D SUBHLP^PXRRPECS"
"RTN","PXRRPECS",163,0)
 S DIR("??")="^D LISTA^PXRRPECU(.SUB)"
"RTN","PXRRPECS",164,0)
 S DIR("A")=" Select SUBSPECIALTY (enter "_WC_" for all): "
"RTN","PXRRPECS",165,0)
 D ^DIR K DIR
"RTN","PXRRPECS",166,0)
 I $D(DIROUT) S DTOUT=1
"RTN","PXRRPECS",167,0)
 I $D(DTOUT) Q
"RTN","PXRRPECS",168,0)
 I $D(DUOUT) G NSPEC
"RTN","PXRRPECS",169,0)
 I $L(Y)=0 S SSUB=NS_U_NS
"RTN","PXRRPECS",170,0)
 E  S SSUB=$$FDME^PXRRPECU(Y,.SUB)
"RTN","PXRRPECS",171,0)
 I SSUB=-1 W " ??",BELL G NSUB
"RTN","PXRRPECS",172,0)
 ;
"RTN","PXRRPECS",173,0)
 ;Save the selections.
"RTN","PXRRPECS",174,0)
 S TEMP=$L($P(SOCC,U,1))+$L($P(SSPEC,U,1))+$L($P(SSUB,U,1))
"RTN","PXRRPECS",175,0)
 I TEMP=0 Q
"RTN","PXRRPECS",176,0)
 I TEMP>0 D
"RTN","PXRRPECS",177,0)
 . S NCL=NCL+1
"RTN","PXRRPECS",178,0)
 . S PXRRPECL(NCL)=$P(SOCC,U,2)_U_$P(SSPEC,U,2)_U_$P(SSUB,U,2)
"RTN","PXRRPECS",179,0)
 I $D(DUOUT) G PCLASS
"RTN","PXRRPECS",180,0)
 I (NCL=0)&($D(DIRUT)!$D(DUOUT)) Q
"RTN","PXRRPECS",181,0)
 I (NCL=0) W !,"You must select a PERSON CLASS!" G PCLASS
"RTN","PXRRPECS",182,0)
 G NSPEC
"RTN","PXRRPECS",183,0)
 ;
"RTN","PXRRPECS",184,0)
 ;=======================================================================
"RTN","PXRRPECS",185,0)
OCCHLP ;Help for occupation input.
"RTN","PXRRPECS",186,0)
 N PROMPT
"RTN","PXRRPECS",187,0)
 W !!,"Answer with an OCCUPATION, note ",WC," matches all OCCUPATIONS"
"RTN","PXRRPECS",188,0)
 S PROMPT="Do you want the entire "_NOCC_"-entry occupation list? "
"RTN","PXRRPECS",189,0)
 I $$GETYORN^PXRRPECU(PROMPT) D LISTA^PXRRPECU(.OCC)
"RTN","PXRRPECS",190,0)
 Q
"RTN","PXRRPECS",191,0)
 ;
"RTN","PXRRPECS",192,0)
 ;=======================================================================
"RTN","PXRRPECS",193,0)
SPECHLP ;Help for specialty input.
"RTN","PXRRPECS",194,0)
 N PROMPT
"RTN","PXRRPECS",195,0)
 W !!,"Answer with a SPECIALTY, note ",WC," matches all SPECIALTIES"
"RTN","PXRRPECS",196,0)
 S PROMPT="Do you want the entire "_NSPEC_"-entry specialty list? "
"RTN","PXRRPECS",197,0)
 I $$GETYORN^PXRRPECU(PROMPT) D LISTA^PXRRPECU(.SPEC)
"RTN","PXRRPECS",198,0)
 Q
"RTN","PXRRPECS",199,0)
 ;
"RTN","PXRRPECS",200,0)
 ;=======================================================================
"RTN","PXRRPECS",201,0)
SUBHLP ;Help for subspecialty input.
"RTN","PXRRPECS",202,0)
 N PROMPT
"RTN","PXRRPECS",203,0)
 W !!,"Answer with a SUBSPECIALTY, note ",WC," matches all SUBSPECIALTIES"
"RTN","PXRRPECS",204,0)
 S PROMPT="Do you want the entire "_NSUB_"-entry subspecialty list? "
"RTN","PXRRPECS",205,0)
 I $$GETYORN^PXRRPECU(PROMPT) D LISTA^PXRRPECU(.SUB)
"RTN","PXRRPECS",206,0)
 Q
"RTN","PXRRPECS",207,0)
 ;
"VER")
8.0^22
**END**
**END**
