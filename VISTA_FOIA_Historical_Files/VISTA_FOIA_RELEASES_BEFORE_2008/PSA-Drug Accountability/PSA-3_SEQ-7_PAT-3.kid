Released PSA*3*3 SEQ #7
Extracted from mail message
**KIDS**:PSA*3.0*3^

**INSTALL NAME**
PSA*3.0*3
"BLD",438,0)
PSA*3.0*3^DRUG ACCOUNTABILITY^0^2981119^y
"BLD",438,1,0)
^^1^1^2981119^^^^
"BLD",438,1,1,0)
This patch is a combination of patches 3,4,5,7,8,9,10,11,12,13.
"BLD",438,4,0)
^9.64PA^^
"BLD",438,"INIT")
PSAFIX
"BLD",438,"KRN",0)
^9.67PA^19^18
"BLD",438,"KRN",.4,0)
.4
"BLD",438,"KRN",.401,0)
.401
"BLD",438,"KRN",.402,0)
.402
"BLD",438,"KRN",.403,0)
.403
"BLD",438,"KRN",.5,0)
.5
"BLD",438,"KRN",.84,0)
.84
"BLD",438,"KRN",3.6,0)
3.6
"BLD",438,"KRN",3.8,0)
3.8
"BLD",438,"KRN",9.2,0)
9.2
"BLD",438,"KRN",9.8,0)
9.8
"BLD",438,"KRN",9.8,"NM",0)
^9.68A^40^34
"BLD",438,"KRN",9.8,"NM",1,0)
PSAUP5^^0^B49555466
"BLD",438,"KRN",9.8,"NM",2,0)
PSAPROC^^0^B58623180
"BLD",438,"KRN",9.8,"NM",3,0)
PSAHIS^^0^B23035600
"BLD",438,"KRN",9.8,"NM",4,0)
PSAHIS1^^0^B38528696
"BLD",438,"KRN",9.8,"NM",5,0)
PSAVER6^^0^B33177107
"BLD",438,"KRN",9.8,"NM",6,0)
PSACREDR^^0^B30767974
"BLD",438,"KRN",9.8,"NM",7,0)
PSAPROC7^^0^B33007966
"BLD",438,"KRN",9.8,"NM",8,0)
PSARWS^^0^B16948588
"BLD",438,"KRN",9.8,"NM",9,0)
PSAREORD^^0^B29973014
"BLD",438,"KRN",9.8,"NM",10,0)
PSAUP1^^0^B32900847
"BLD",438,"KRN",9.8,"NM",11,0)
PSAVER2^^0^B44719783
"BLD",438,"KRN",9.8,"NM",12,0)
PSAVER3^^0^B66247490
"BLD",438,"KRN",9.8,"NM",13,0)
PSAUDP^^0^B10115428
"BLD",438,"KRN",9.8,"NM",14,0)
PSAOP^^0^B34810777
"BLD",438,"KRN",9.8,"NM",15,0)
PSAOP2^^0^B32264389
"BLD",438,"KRN",9.8,"NM",16,0)
PSAOP4^^0^B6478536
"BLD",438,"KRN",9.8,"NM",17,0)
PSACOST^^0^B29213657
"BLD",438,"KRN",9.8,"NM",18,0)
PSACREDO^^0^B70062126
"BLD",438,"KRN",9.8,"NM",19,0)
PSADJ^^0^B43445805
"BLD",438,"KRN",9.8,"NM",21,0)
PSAORDP1^^0^B71007671
"BLD",438,"KRN",9.8,"NM",22,0)
PSAPROC3^^0^B51547340
"BLD",438,"KRN",9.8,"NM",24,0)
PSAUP4^^0^B69716239
"BLD",438,"KRN",9.8,"NM",25,0)
PSAUTL1^^0^B35221116
"BLD",438,"KRN",9.8,"NM",26,0)
PSAUTL4^^0^B23488821
"BLD",438,"KRN",9.8,"NM",27,0)
PSAPROC6^^0^B70844716
"BLD",438,"KRN",9.8,"NM",31,0)
PSADRUGP^^0^B20287476
"BLD",438,"KRN",9.8,"NM",32,0)
PSAPROC8^^0^B42292090
"BLD",438,"KRN",9.8,"NM",33,0)
PSAPROC4^^0^B48056626
"BLD",438,"KRN",9.8,"NM",34,0)
PSAPROC5^^0^B44077866
"BLD",438,"KRN",9.8,"NM",36,0)
PSAUP6^^0^B8138399
"BLD",438,"KRN",9.8,"NM",37,0)
PSAPSI^^0^B33420061
"BLD",438,"KRN",9.8,"NM",38,0)
PSAPSI4^^0^B2992805
"BLD",438,"KRN",9.8,"NM",39,0)
PSAPSI2^^0^B25063127
"BLD",438,"KRN",9.8,"NM",40,0)
PSAFIX^^0^B2452315
"BLD",438,"KRN",9.8,"NM","B","PSACOST",17)

"BLD",438,"KRN",9.8,"NM","B","PSACREDO",18)

"BLD",438,"KRN",9.8,"NM","B","PSACREDR",6)

"BLD",438,"KRN",9.8,"NM","B","PSADJ",19)

"BLD",438,"KRN",9.8,"NM","B","PSADRUGP",31)

"BLD",438,"KRN",9.8,"NM","B","PSAFIX",40)

"BLD",438,"KRN",9.8,"NM","B","PSAHIS",3)

"BLD",438,"KRN",9.8,"NM","B","PSAHIS1",4)

"BLD",438,"KRN",9.8,"NM","B","PSAOP",14)

"BLD",438,"KRN",9.8,"NM","B","PSAOP2",15)

"BLD",438,"KRN",9.8,"NM","B","PSAOP4",16)

"BLD",438,"KRN",9.8,"NM","B","PSAORDP1",21)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC",2)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC3",22)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC4",33)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC5",34)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC6",27)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC7",7)

"BLD",438,"KRN",9.8,"NM","B","PSAPROC8",32)

"BLD",438,"KRN",9.8,"NM","B","PSAPSI",37)

"BLD",438,"KRN",9.8,"NM","B","PSAPSI2",39)

"BLD",438,"KRN",9.8,"NM","B","PSAPSI4",38)

"BLD",438,"KRN",9.8,"NM","B","PSAREORD",9)

"BLD",438,"KRN",9.8,"NM","B","PSARWS",8)

"BLD",438,"KRN",9.8,"NM","B","PSAUDP",13)

"BLD",438,"KRN",9.8,"NM","B","PSAUP1",10)

"BLD",438,"KRN",9.8,"NM","B","PSAUP4",24)

"BLD",438,"KRN",9.8,"NM","B","PSAUP5",1)

"BLD",438,"KRN",9.8,"NM","B","PSAUP6",36)

"BLD",438,"KRN",9.8,"NM","B","PSAUTL1",25)

"BLD",438,"KRN",9.8,"NM","B","PSAUTL4",26)

"BLD",438,"KRN",9.8,"NM","B","PSAVER2",11)

"BLD",438,"KRN",9.8,"NM","B","PSAVER3",12)

"BLD",438,"KRN",9.8,"NM","B","PSAVER6",5)

"BLD",438,"KRN",19,0)
19
"BLD",438,"KRN",19.1,0)
19.1
"BLD",438,"KRN",101,0)
101
"BLD",438,"KRN",409.61,0)
409.61
"BLD",438,"KRN",771,0)
771
"BLD",438,"KRN",869.2,0)
869.2
"BLD",438,"KRN",870,0)
870
"BLD",438,"KRN",8994,0)
8994
"BLD",438,"KRN",8994,"NM",0)
^9.68A^^
"BLD",438,"KRN","B",.4,.4)

"BLD",438,"KRN","B",.401,.401)

"BLD",438,"KRN","B",.402,.402)

"BLD",438,"KRN","B",.403,.403)

"BLD",438,"KRN","B",.5,.5)

"BLD",438,"KRN","B",.84,.84)

"BLD",438,"KRN","B",3.6,3.6)

"BLD",438,"KRN","B",3.8,3.8)

"BLD",438,"KRN","B",9.2,9.2)

"BLD",438,"KRN","B",9.8,9.8)

"BLD",438,"KRN","B",19,19)

"BLD",438,"KRN","B",19.1,19.1)

"BLD",438,"KRN","B",101,101)

"BLD",438,"KRN","B",409.61,409.61)

"BLD",438,"KRN","B",771,771)

"BLD",438,"KRN","B",869.2,869.2)

"BLD",438,"KRN","B",870,870)

"BLD",438,"KRN","B",8994,8994)

"BLD",438,"QUES",0)
^9.62^^
"BLD",438,"REQB",0)
^9.611^1^1
"BLD",438,"REQB",1,0)
PSA*3.0*1^1
"BLD",438,"REQB","B","PSA*3.0*1",1)

"INIT")
PSAFIX
"PKG",182,-1)
1^1
"PKG",182,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability/Inventory Interface^
"PKG",182,20,0)
^9.402P^^0
"PKG",182,22,0)
^9.49I^1^1
"PKG",182,22,1,0)
3.0^2971024^2970912^531
"PKG",182,22,1,"PAH",1,0)
3^2981119
"PKG",182,22,1,"PAH",1,1,0)
^^1^1^2981230
"PKG",182,22,1,"PAH",1,1,1,0)
This patch is a combination of patches 3,4,5,7,8,9,10,11,12,13.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
34
"RTN","PSACOST")
0^17^B29213657
"RTN","PSACOST",1,0)
PSACOST ;BIR/JMB-Invoice Cost Summary ;7/23/97
"RTN","PSACOST",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSACOST",3,0)
 ;This routine prints the order number, invoice number, invoice date,
"RTN","PSACOST",4,0)
 ;total invoice cost, total adjusted cost, and cost difference for a
"RTN","PSACOST",5,0)
 ;specified invoice date range.
"RTN","PSACOST",6,0)
 ;
"RTN","PSACOST",7,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACOST",8,0)
 I '$O(^PSD(58.811,"ADATE",0)) W !,"There are no invoices." G EXIT
"RTN","PSACOST",9,0)
 S PSAOUT=0 D BDATE^PSAPV G:PSAOUT EXIT
"RTN","PSACOST",10,0)
DEVICE ;Asks device & queueing info
"RTN","PSACOST",11,0)
 K IO("Q"),%ZIS,IOP,POP S %ZIS="0Q",%ZIS("B")=""
"RTN","PSACOST",12,0)
 W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSACOST",13,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSACOST",14,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSACOST",15,0)
 .S ZTRTN="COMPILE^PSACOST",ZTDESC="Drug Acct. - Invoice Cost Summary Report"
"RTN","PSACOST",16,0)
 .S:$D(PSABEG) ZTSAVE("PSABEG")="" S:$D(PSAEND) ZTSAVE("PSAEND")=""
"RTN","PSACOST",17,0)
 .D ^%ZTLOAD
"RTN","PSACOST",18,0)
 ;
"RTN","PSACOST",19,0)
COMPILE ;Compiles the data into ^TMP("PSACOST",$J)
"RTN","PSACOST",20,0)
 S PSAOUT=0,PSADATE=PSABEG
"RTN","PSACOST",21,0)
 F  S PSADATE=+$O(^PSD(58.811,"ADATE",PSADATE)) Q:'PSADATE!(PSADATE>PSAEND)!(PSAOUT)  D
"RTN","PSACOST",22,0)
 .S PSAIEN=0 F  S PSAIEN=+$O(^PSD(58.811,"ADATE",PSADATE,PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSACOST",23,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),(PSAIEN1,PSAOECST)=0
"RTN","PSACOST",24,0)
 ..F  S PSAIEN1=+$O(^PSD(58.811,"ADATE",PSADATE,PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSACOST",25,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSACOST",26,0)
 ...S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^"),PSAINVDT=$E(PSADATE,4,5)_"/"_$E(PSADATE,6,7)_"/"_$E(PSADATE,2,3)
"RTN","PSACOST",27,0)
 ...S (PSAAECST,PSAIECST)=0
"RTN","PSACOST",28,0)
 ...S PSALINE=0 F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSACOST",29,0)
 ....Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSACOST",30,0)
 ....S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D LINE
"RTN","PSACOST",31,0)
 ...S PSADIFF=PSAIECST-PSAAECST,PSAOECST=PSAOECST+PSAAECST
"RTN","PSACOST",32,0)
 ...S ^TMP("PSACOST",$J,PSAORD,PSAINV)=PSAINVDT_"^"_$J(PSAIECST,$L(PSAIECST),2)_"^"_$J(PSAAECST,$L($P(PSAAECST,".")),2)_"^"_$J(PSADIFF,$L(PSADIFF),2)
"RTN","PSACOST",33,0)
 ;
"RTN","PSACOST",34,0)
ORDER S PSAORD="" F  S PSAORD=$O(^TMP("PSACOST",$J,PSAORD)) Q:PSAORD=""  D
"RTN","PSACOST",35,0)
 .S (PSAACOST,PSADIFF,PSAICOST)=0,PSAINV=""
"RTN","PSACOST",36,0)
 .F  S PSAINV=$O(^TMP("PSACOST",$J,PSAORD,PSAINV)) Q:PSAINV=""  D
"RTN","PSACOST",37,0)
 ..S PSAICOST=PSAICOST+$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^",2),PSAACOST=PSAACOST+$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^",3),PSADIFF=PSADIFF+$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^",4)
"RTN","PSACOST",38,0)
 .S ^TMP("PSACOST",$J,PSAORD)=$J(PSAICOST,$L(PSAICOST),2)_"^"_$J(PSAACOST,$L($P(PSAACOST,".")),2)_"^"_$J(PSADIFF,$L(PSADIFF),2)
"RTN","PSACOST",39,0)
 ;
"RTN","PSACOST",40,0)
PRINT ;Prints invoices' totals
"RTN","PSACOST",41,0)
 S Y=PSAEND D DD^%DT S PSAENDX=Y K X,Y,%DT
"RTN","PSACOST",42,0)
 S Y=PSABEG D DD^%DT S PSABEGX=Y K X,Y,%DT
"RTN","PSACOST",43,0)
 D NOW^%DTC S PSARUN=%,PSARUN=$E(PSARUN,4,5)_"/"_$E(PSARUN,6,7)_"/"_$E(PSARUN,2,3)_"@"_$E($P(PSARUN,".",2),1,2)_":"_$E($P(PSARUN,".",2),3,4)
"RTN","PSACOST",44,0)
 S PSAPG=0,PSASLN="",$P(PSASLN,"-",80)="" K Y D HDR
"RTN","PSACOST",45,0)
 S PSAORD=$O(^TMP("PSACOST",$J,"")) I PSAORD="" W !!,"There is no invoice data in the file for the selected date range.",! D END^PSAPROC G EXIT
"RTN","PSACOST",46,0)
 S PSAORD="" F  S PSAORD=$O(^TMP("PSACOST",$J,PSAORD)) Q:PSAORD=""!(PSAOUT)  D
"RTN","PSACOST",47,0)
 .S PSAODIFF=$P(^TMP("PSACOST",$J,PSAORD),"^",2)
"RTN","PSACOST",48,0)
 .I $Y+5>IOSL D HDR Q:PSAOUT
"RTN","PSACOST",49,0)
 .W !,"ORDER#: "_PSAORD
"RTN","PSACOST",50,0)
 .S PSAINV="" F  S PSAINV=$O(^TMP("PSACOST",$J,PSAORD,PSAINV)) Q:PSAINV=""!(PSAOUT)  D
"RTN","PSACOST",51,0)
 ..S PSAINVDT=$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^"),PSAICOST=$P(^(PSAINV),"^",2),PSAACOST=$P(^(PSAINV),"^",3),PSADIFF=$P(^(PSAINV),"^",4)
"RTN","PSACOST",52,0)
 ..I $Y+4>IOSL D HDR Q:PSAOUT
"RTN","PSACOST",53,0)
 ..W !,PSAINV,?27,PSAINVDT,?39,$J(PSAICOST,9,2),?55,$J(PSAACOST,9,2),?71,$J(PSADIFF,7,2)
"RTN","PSACOST",54,0)
 .I $Y+4>IOSL D HDR Q:PSAOUT
"RTN","PSACOST",55,0)
 .S PSAOCOST=$P(^TMP("PSACOST",$J,PSAORD),"^"),PSAOACST=$P(^(PSAORD),"^",2),PSAODIFF=$P(^(PSAORD),"^",3)
"RTN","PSACOST",56,0)
 .I PSAICOST'=PSAOCOST!(PSAACOST'=PSAOACST) W !,"ORDER TOTAL" W ?39,$J(PSAOCOST,9,2),?55,$J(PSAOACST,9,2),?69 W $J(PSAODIFF,9,2),!
"RTN","PSACOST",57,0)
 .E  W !
"RTN","PSACOST",58,0)
 I $E(IOST,1,2)="C-" Q:PSAOUT  D END^PSAPROC
"RTN","PSACOST",59,0)
 E  W @IOF
"RTN","PSACOST",60,0)
 ;
"RTN","PSACOST",61,0)
EXIT D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q"),^TMP("PSACOST",$J)
"RTN","PSACOST",62,0)
 K %,%DT,%ZIS,PSAACOST,PSAAECST,PSABEG,PSABEGX,PSADATA,PSADATE,PSADIFF,PSADJ,PSADJP,PSADJQ,PSAEND,PSAENDX,PSAICOST,PSAIECST,PSAIEN
"RTN","PSACOST",63,0)
 K PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALCOST,PSALINE,PSANODE,PSAOACST,PSAOCOST,PSAODIFF,PSAOECST,PSAORD,PSAOUT,PSAPG,PSAPRICE,PSARUN,PSASLN,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSACOST",64,0)
 Q
"RTN","PSACOST",65,0)
 ;
"RTN","PSACOST",66,0)
LINE ;Get line item data
"RTN","PSACOST",67,0)
 S PSALCOST=$P(PSADATA,"^",3)*$P(PSADATA,"^",5),PSAIECST=PSAIECST+PSALCOST
"RTN","PSACOST",68,0)
PRICE S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSACOST",69,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSAPRICE=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2)),PSADJP=PSAPRICE
"RTN","PSACOST",70,0)
 I '$G(PSADJ) S PSAPRICE=$P(PSADATA,"^",5)
"RTN","PSACOST",71,0)
QTY S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSACOST",72,0)
 I $G(PSADJ) D
"RTN","PSACOST",73,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSACOST",74,0)
 .S PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSACOST",75,0)
 .S PSAACOST=PSADJQ*PSAPRICE,PSAAECST=PSAAECST+PSAACOST
"RTN","PSACOST",76,0)
 I '$G(PSADJQ) S PSAACOST=$P(PSADATA,"^",3)*PSAPRICE,PSAAECST=PSAAECST+PSAACOST
"RTN","PSACOST",77,0)
 Q
"RTN","PSACOST",78,0)
 ;
"RTN","PSACOST",79,0)
HDR ;Report header
"RTN","PSACOST",80,0)
 I $E(IOST,1,2)="C-" W:'PSAPG @IOF D:+PSAPG END^PSAPROC Q:PSAOUT
"RTN","PSACOST",81,0)
 I $E(IOST)'="C",+PSAPG W @IOF
"RTN","PSACOST",82,0)
 S PSAPG=PSAPG+1
"RTN","PSACOST",83,0)
 W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",?72,"PAGE "_PSAPG
"RTN","PSACOST",84,0)
 W !?27,"INVOICE COST SUMMARY REPORT"
"RTN","PSACOST",85,0)
 I $E(IOST)'="C" W !,"RUN: "_PSARUN,?27,PSABEGX_" - "_PSAENDX
"RTN","PSACOST",86,0)
 E  W !,?27,PSABEGX_" - "_PSAENDX
"RTN","PSACOST",87,0)
 W !!?28,"INVOICE",?41,"INVOICE",?56,"ADJUSTED"
"RTN","PSACOST",88,0)
 W !,"INVOICE#",?31,"DATE",?44,"COST",?60,"COST",?68,"DIFFERENCE",!,PSASLN
"RTN","PSACOST",89,0)
 Q
"RTN","PSACREDO")
0^18^B70062126
"RTN","PSACREDO",1,0)
PSACREDO ;BIR/JMB-Outstanding Credits ;7/23/97
"RTN","PSACREDO",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSACREDO",3,0)
 ;This routine prints detailed or summary outstanding credits report.
"RTN","PSACREDO",4,0)
 ;
"RTN","PSACREDO",5,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACREDO",6,0)
 I '$O(^PSD(58.811,"AC",1,0)) W !!,"There are no outstanding credit memos." Q
"RTN","PSACREDO",7,0)
 S DIR(0)="S^D:Detailed Report;S:Summary Report",DIR("A")="Print a detailed or summary report",DIR("??")="^D RPT^PSACREDO" D ^DIR K DIR I $G(DIRUT) G EXIT
"RTN","PSACREDO",8,0)
 S PSARPT=Y W:PSARPT="D" !!,"The report must be sent to a 132 column printer."
"RTN","PSACREDO",9,0)
DEVICE W ! S %ZIS="Q" D ^%ZIS G:POP EXIT
"RTN","PSACREDO",10,0)
 ;I PSARPT="D",$E(IOST,1,2)="C-" W !!,"The report must be sent to a 132 column printer." G DEVICE
"RTN","PSACREDO",11,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSACREDO",12,0)
 .S ZTDESC="Drug Acct. - Print Outstanding Credits",ZTRTN="DQ^PSACREDO"
"RTN","PSACREDO",13,0)
 .S ZTSAVE("PSARPT")="" D ^%ZTLOAD
"RTN","PSACREDO",14,0)
DQ S PSASLN="",$P(PSASLN,"-",80)="",PSALSLN="",$P(PSALSLN,"-",132)=""
"RTN","PSACREDO",15,0)
 S (PSAGDF,PSA,PSAOUT,PSAPG)=0
"RTN","PSACREDO",16,0)
 F  S PSA=+$O(^PSD(58.811,"AC",1,PSA)) Q:'PSA  D  Q:PSAOUT
"RTN","PSACREDO",17,0)
 .Q:'$D(^PSD(58.811,PSA,0))
"RTN","PSACREDO",18,0)
 .S PSAORD=$P(^PSD(58.811,PSA,0),"^"),(PSA1,PSAOECST,PSAODF)=0
"RTN","PSACREDO",19,0)
 .F  S PSA1=+$O(^PSD(58.811,"AC",1,PSA,PSA1)) Q:'PSA1  D  Q:PSAOUT
"RTN","PSACREDO",20,0)
 ..Q:'$D(^PSD(58.811,PSA,1,PSA1,0))
"RTN","PSACREDO",21,0)
 ..S PSAINV=$P(^PSD(58.811,PSA,1,PSA1,0),"^"),(PSACRED,PSAAECST,PSAIECST)=0
"RTN","PSACREDO",22,0)
 ..S PSA2=0 F  S PSA2=+$O(^PSD(58.811,PSA,1,PSA1,1,PSA2)) Q:'PSA2!(PSAOUT)  D  Q:PSAOUT
"RTN","PSACREDO",23,0)
 ...Q:'$D(^PSD(58.811,PSA,1,PSA1,1,PSA2,0))
"RTN","PSACREDO",24,0)
 ...S PSADATA=^PSD(58.811,PSA,1,PSA1,1,PSA2,0)
"RTN","PSACREDO",25,0)
 ...D LINE
"RTN","PSACREDO",26,0)
 ..D CREDITS S PSAODF=PSAODF+$G(PSADF),PSAOECST=PSAOECST+PSAAECST
"RTN","PSACREDO",27,0)
 .S PSA(PSAORD)=$J(PSAOECST,$L($P(PSAOECST,".")),2)_"^"_$J(PSAODF,$L($P(PSAODF,".")),2)
"RTN","PSACREDO",28,0)
 .S PSAGDF=PSAGDF+PSAODF
"RTN","PSACREDO",29,0)
 ;
"RTN","PSACREDO",30,0)
 S PSAORD="" F  S PSAORD=$O(PSA(PSAORD)) Q:PSAORD=""  S PSAINV="" F  S PSAINV=$O(^PSD(58.811,"AORD",PSAORD,PSAINV)) Q:PSAINV=""  D
"RTN","PSACREDO",31,0)
 .Q:$D(PSA(PSAORD,PSAINV))  S (PSA,PSAAECST,PSAIECST)=0
"RTN","PSACREDO",32,0)
 .F  S PSA=$O(^PSD(58.811,"AORD",PSAORD,PSAINV,PSA)) Q:'PSA  S PSA1=0 F  S PSA1=$O(^PSD(58.811,"AORD",PSAORD,PSAINV,PSA,PSA1)) Q:'PSA1  D
"RTN","PSACREDO",33,0)
 ..D GETLINE
"RTN","PSACREDO",34,0)
 ..I 'PSAAECST&(+PSAIECST) S $P(PSA(PSAORD),"^")=+$P(PSA(PSAORD),"^")+PSAIECST,$P(PSA(PSAORD),"^")=$J($P(PSA(PSAORD),"^"),$L($P($P(PSA(PSAORD),"^"),".")),2)
"RTN","PSACREDO",35,0)
 ..I PSAAECST S $P(PSA(PSAORD),"^")=+$P(PSA(PSAORD),"^")+PSAAECST,$P(PSA(PSAORD),"^")=$J($P(PSA(PSAORD),"^"),$L($P($P(PSA(PSAORD),"^"),".")),2)
"RTN","PSACREDO",36,0)
 D PRINT
"RTN","PSACREDO",37,0)
 ;
"RTN","PSACREDO",38,0)
EXIT D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSACREDO",39,0)
 K %ZIS,DIR,DIRUT,PSA,PSA1,PSA2,PSAACST,PSAAECST,PSAAVAL,PSAC,PSACRED,PSADATA,PSADF,PSADJ,PSADJD,PSADJP,PSADJQ,PSADRG,PSADT,PSAFLD,PSAGDF,PSAICST
"RTN","PSACREDO",40,0)
 K PSAIDF,PSAIECST,PSAINV,PSAINVDT,PSAIVAL,PSAKK,PSALN,PSALSLN,PSAN,PSAODF,PSAOECST,PSAORD,PSAOUT,PSAPFLD,PSAPG,PSAPRC,PSAPRT,PSAQFLD,PSAREA,PSARPDT,PSARPT,PSASLN,PSASS,Y,ZTDESC,ZTRTN,ZTSAVE
"RTN","PSACREDO",41,0)
 Q
"RTN","PSACREDO",42,0)
 ;
"RTN","PSACREDO",43,0)
LINE ;Get line item data
"RTN","PSACREDO",44,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,".")
"RTN","PSACREDO",45,0)
 S PSARPDT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)_"@"_$P(PSARPDT,".",2)
"RTN","PSACREDO",46,0)
 S (PSADJQ,PSADJP,PSADJD,PSAPFLD,PSAQFLD,PSAREA)="",(PSADRG,PSAACST,PSAICST)=0
"RTN","PSACREDO",47,0)
 S PSADJ=+$O(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,"B","D",0))
"RTN","PSACREDO",48,0)
 I $G(PSADJ) D
"RTN","PSACREDO",49,0)
 .S PSAN=$G(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,PSADJ,0))
"RTN","PSACREDO",50,0)
 .S PSADJD=$S($P(PSAN,"^",6)'="":$P(PSAN,"^",6),1:$P(PSAN,"^",2)),PSADRG=PSADJD
"RTN","PSACREDO",51,0)
 .Q:$G(PSADJD)&($L(PSADJD)=+$L(PSADJD))
"RTN","PSACREDO",52,0)
 E  S PSADRG=$P(PSADATA,"^",2)
"RTN","PSACREDO",53,0)
 S PSAICST=$P(PSADATA,"^",3)*$P(PSADATA,"^",5),PSAIECST=PSAIECST+PSAICST
"RTN","PSACREDO",54,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,"B","P",0))
"RTN","PSACREDO",55,0)
 I $G(PSADJ) D
"RTN","PSACREDO",56,0)
 .S PSAN=$G(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,PSADJ,0)),PSAPRC=$S($P(PSAN,"^",6)'="":$P(PSAN,"^",6),1:+$P(PSAN,"^",2)),PSADJP=PSAPRC
"RTN","PSACREDO",57,0)
 .S PSAPFLD="P"
"RTN","PSACREDO",58,0)
 I '$G(PSADJ) S PSAPRC=$P(PSADATA,"^",5)
"RTN","PSACREDO",59,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,"B","Q",0))
"RTN","PSACREDO",60,0)
 I $G(PSADJ) D
"RTN","PSACREDO",61,0)
 .S PSAN=$G(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,PSADJ,0))
"RTN","PSACREDO",62,0)
 .S PSADJQ=$S($P(PSAN,"^",6)'="":+$P(PSAN,"^",6),1:+$P(PSAN,"^",2))
"RTN","PSACREDO",63,0)
 .S PSAREA=$S($P(PSAN,"^",7)'="":$P(PSAN,"^",7),1:$P(PSAN,"^",3)),PSAQFLD="Q"
"RTN","PSACREDO",64,0)
 I $G(PSADJQ) S PSAACST=PSADJQ*PSAPRC,PSAAECST=PSAAECST+PSAACST
"RTN","PSACREDO",65,0)
 I '$G(PSADJQ) S PSAACST=$P(PSADATA,"^",3)*PSAPRC,PSAAECST=PSAAECST+PSAACST
"RTN","PSACREDO",66,0)
 I PSAICST'=PSAACST D
"RTN","PSACREDO",67,0)
 .S PSALN=$P(PSADATA,"^")
"RTN","PSACREDO",68,0)
 .S PSADRG=$S(+PSADRG&($P($G(^PSDRUG(PSADRG,0)),"^")'=""):$P(^PSDRUG(PSADRG,0),"^"),'PSADRG:PSADRG,1:"UNKNOWN DRUG")
"RTN","PSACREDO",69,0)
 .I PSAPFLD="P" S PSA(PSAORD,PSAINV,PSALN,PSAPFLD)=PSADRG_"^^"_$J($P(PSADATA,"^",5),$L($P(PSADATA,"^",5)),2)_"^"_$J(PSADJP,$L(PSADJP),2)
"RTN","PSACREDO",70,0)
 .I PSAQFLD="Q" S PSA(PSAORD,PSAINV,PSALN,PSAQFLD)=PSADRG_"^"_$S(PSAREA'="":PSAREA,1:"UNK")_"^"_$P(PSADATA,"^",3)_"^"_PSADJQ
"RTN","PSACREDO",71,0)
 Q
"RTN","PSACREDO",72,0)
 ;
"RTN","PSACREDO",73,0)
GETLINE ;Gets invoice cost from line items
"RTN","PSACREDO",74,0)
 S PSA2=0 F  S PSA2=$O(^PSD(58.811,PSA,1,PSA1,1,PSA2)) Q:'PSA2  D
"RTN","PSACREDO",75,0)
 .Q:'$D(^PSD(58.811,PSA,1,PSA1,1,PSA2,0))
"RTN","PSACREDO",76,0)
 .S PSADATA=^PSD(58.811,PSA,1,PSA1,1,PSA2,0),PSAIECST=PSAIECST+($P(PSADATA,"^",3)*$P(PSADATA,"^",5))
"RTN","PSACREDO",77,0)
 .S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,"B","P",0))
"RTN","PSACREDO",78,0)
 .I +PSADJ S PSAN=$G(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,PSADJ,0)),PSAPRC=$S($P(PSAN,"^",6)'="":$P(PSAN,"^",6),1:+$P(PSAN,"^",2)),PSADJP=PSAPRC
"RTN","PSACREDO",79,0)
 .S:'+PSADJ PSAPRC=$P(PSADATA,"^",5)
"RTN","PSACREDO",80,0)
 .;
"RTN","PSACREDO",81,0)
 .S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,"B","Q",0))
"RTN","PSACREDO",82,0)
 .S:+PSADJ PSAN=$G(^PSD(58.811,PSA,1,PSA1,1,PSA2,1,PSADJ,0)),PSADJQ=$S($P(PSAN,"^",6)'="":+$P(PSAN,"^",6),1:+$P(PSAN,"^",2))
"RTN","PSACREDO",83,0)
 .S:PSADJQ PSAAECST=PSAAECST+(PSADJQ*PSAPRC)
"RTN","PSACREDO",84,0)
 .S:'+PSADJQ PSAAECST=PSAAECST+($P(PSADATA,"^",3)*PSAPRC)
"RTN","PSACREDO",85,0)
 Q
"RTN","PSACREDO",86,0)
 ;
"RTN","PSACREDO",87,0)
CREDITS ;Adds existing credits to adjusted extended cost.
"RTN","PSACREDO",88,0)
 S PSAC=0 F  S PSAC=$O(^PSD(58.811,PSA,1,PSA1,2,PSAC)) Q:'PSAC  D
"RTN","PSACREDO",89,0)
 .Q:'$D(^PSD(58.811,PSA,1,PSA1,2,PSAC,0))
"RTN","PSACREDO",90,0)
 .S PSACRED=PSACRED+$P(^PSD(58.811,PSA,1,PSA1,2,PSAC,0),"^",3)
"RTN","PSACREDO",91,0)
 I PSAAECST'=PSAIECST D
"RTN","PSACREDO",92,0)
 .S PSADF=PSAIECST-(PSAAECST+PSACRED)
"RTN","PSACREDO",93,0)
 .S PSA(PSAORD,PSAINV)=$J(PSAIECST,$L(PSAIECST),2)_"^"_$J(PSAAECST,$L($P(PSAAECST,".")),2)_"^"_$J(PSACRED,$L(PSACRED),2)_"^"_$J(PSADF,$L(PSADF),2)_"^"_+$P($G(^PSD(58.811,PSA,1,PSA1,0)),"^",2)
"RTN","PSACREDO",94,0)
 Q
"RTN","PSACREDO",95,0)
 ;
"RTN","PSACREDO",96,0)
PRINT ;Displays the invoices with outstanding credits
"RTN","PSACREDO",97,0)
 D:PSARPT="S" HDRSUM D:PSARPT="D" HDRDET
"RTN","PSACREDO",98,0)
 S PSAORD="" F  S PSAORD=$O(PSA(PSAORD)) Q:PSAORD=""!(PSAOUT)  D
"RTN","PSACREDO",99,0)
 .S PSAODF=$P(PSA(PSAORD),"^",2)
"RTN","PSACREDO",100,0)
 .I $Y+4>IOSL D:PSARPT="S" HDRSUM D:PSARPT="D" HDRDET Q:PSAOUT
"RTN","PSACREDO",101,0)
 .W:PSARPT="S" ! W:PSARPT="D" !,PSALSLN W !,"ORDER#: "_PSAORD_" ($"_$P(PSA(PSAORD),"^")_")"
"RTN","PSACREDO",102,0)
 .S PSAINV="" F  S PSAINV=$O(PSA(PSAORD,PSAINV)) Q:PSAINV=""  D
"RTN","PSACREDO",103,0)
 ..S PSAIECST=$P(PSA(PSAORD,PSAINV),"^"),PSAAECST=$P(PSA(PSAORD,PSAINV),"^",2),PSACRED=$P(PSA(PSAORD,PSAINV),"^",3),PSAIDF=$P(PSA(PSAORD,PSAINV),"^",4)
"RTN","PSACREDO",104,0)
 ..S PSAINVDT=$P(PSA(PSAORD,PSAINV),"^",5),PSAINVDT=$E(PSAINVDT,4,5)_"/"_$E(PSAINVDT,6,7)_"/"_$E(PSAINVDT,2,3)
"RTN","PSACREDO",105,0)
 ..S PSAPRT=0,PSALN="" F  S PSALN=$O(PSA(PSAORD,PSAINV,PSALN)) Q:PSALN=""  D
"RTN","PSACREDO",106,0)
 ...S PSAFLD="" F  S PSAFLD=$O(PSA(PSAORD,PSAINV,PSALN,PSAFLD)) Q:PSAFLD=""  D
"RTN","PSACREDO",107,0)
 ....S PSADATA=PSA(PSAORD,PSAINV,PSALN,PSAFLD),PSADRG=$P(PSADATA,"^"),PSAREA=$P(PSADATA,"^",2),PSAIVAL=$P(PSADATA,"^",3),PSAAVAL=$P(PSADATA,"^",4),PSAPRT=PSAPRT+1
"RTN","PSACREDO",108,0)
 ....I PSARPT="D",$Y+5>IOSL D HDRDET Q:PSAOUT
"RTN","PSACREDO",109,0)
 ....I PSARPT="D" D:PSAPRT=1 PRTDLINE D:PSAPRT>1 PRTDLIN1
"RTN","PSACREDO",110,0)
 ..I PSARPT="S",$Y+5>IOSL D HDRSUM Q:PSAOUT
"RTN","PSACREDO",111,0)
 ..D:PSARPT="S" PRTSLINE
"RTN","PSACREDO",112,0)
 .I $Y+4>IOSL D:PSARPT="S" HDRSUM D:PSARPT="D" HDRDET Q:PSAOUT
"RTN","PSACREDO",113,0)
 .I PSAODF'=PSADF W !,"ORDER TOTAL" W:PSARPT="D" ?65 W:PSARPT="S" ?69 W $J(PSAODF,9,2)
"RTN","PSACREDO",114,0)
 I $Y+4>IOSL D:PSARPT="S" HDRSUM D:PSARPT="D" HDRDET Q:PSAOUT
"RTN","PSACREDO",115,0)
 W ! W:PSARPT="S" PSASLN W:PSARPT="D" PSALSLN
"RTN","PSACREDO",116,0)
 W !,"GRAND TOTAL" W:PSARPT="D" ?65 W:PSARPT="S" ?69 W $J(PSAGDF,9,2),!
"RTN","PSACREDO",117,0)
 I $E(IOST,1,2)="C-" D END^PSAPROC
"RTN","PSACREDO",118,0)
 E  W @IOF
"RTN","PSACREDO",119,0)
 Q
"RTN","PSACREDO",120,0)
 ;
"RTN","PSACREDO",121,0)
HDRDET ;Header for detail report
"RTN","PSACREDO",122,0)
 I $E(IOST,1,2)="C-" W:'PSAPG @IOF D:+PSAPG END^PSAPROC Q:PSAOUT
"RTN","PSACREDO",123,0)
 I $E(IOST)'="C",+PSAPG W @IOF
"RTN","PSACREDO",124,0)
 S PSAPG=PSAPG+1
"RTN","PSACREDO",125,0)
 W ! W:$E(IOST)'="C" "RUN DATE: "_PSARPDT
"RTN","PSACREDO",126,0)
 W ?46,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE"
"RTN","PSACREDO",127,0)
 W !?53,"OUTSTANDING CREDITS REPORT",!?124,"PAGE "_PSAPG
"RTN","PSACREDO",128,0)
 W !!?36,"INVOICE",?46,"ADJUSTED",?58,"RECEIVED",?68,"OUTST.",?84,"DRUG &"
"RTN","PSACREDO",129,0)
 W !,"INVOICE#",?28,"DATE",?39,"COST",?50,"COST",?59,"CREDITS",?68,"CREDIT",?77,"LINE#",?84,"ADJUSTMENT REASON",?117,"INVOICE",?129,"ADJ",!
"RTN","PSACREDO",130,0)
 W:PSAPG'=1 PSALSLN
"RTN","PSACREDO",131,0)
 Q
"RTN","PSACREDO",132,0)
 ;
"RTN","PSACREDO",133,0)
PRTDLINE ;Prints a line of data on the detailed report
"RTN","PSACREDO",134,0)
 W !,PSAINV,?26,PSAINVDT,?30,$J(PSAIECST,9,2),?45,$J(PSAAECST,9,2),?57,$J(PSACRED,9,2),?67,$J(PSAIDF,7,2),?74,$J(PSALN,8,0),?84,$E(PSADRG,1,33),?117,$J(PSAIVAL,7),?125,$J(PSAAVAL,7)
"RTN","PSACREDO",135,0)
 W !?84,$S(PSAFLD="P":"ORDER UNIT PRICE CHANGED ",PSAFLD="Q":"QTY: "_PSAREA,1:"")
"RTN","PSACREDO",136,0)
 Q
"RTN","PSACREDO",137,0)
 ;
"RTN","PSACREDO",138,0)
PRTDLIN1 ;Prints a line of data on the detailed report
"RTN","PSACREDO",139,0)
 W !?74,$J(PSALN,8,0),?84,PSADRG,?117,$J(PSAIVAL,7),?125,$J(PSAAVAL,7)
"RTN","PSACREDO",140,0)
 W !?84,$S(PSAFLD="P":"ORDER UNIT PRICE CHANGED ",PSAFLD="Q":"QTY: "_PSAREA,1:"")
"RTN","PSACREDO",141,0)
 Q
"RTN","PSACREDO",142,0)
 ;
"RTN","PSACREDO",143,0)
HDRSUM ;Header for summary report
"RTN","PSACREDO",144,0)
 I $E(IOST,1,2)="C-" W:'PSAPG @IOF D:+PSAPG END^PSAPROC Q:PSAOUT
"RTN","PSACREDO",145,0)
 I $E(IOST)'="C",+PSAPG W @IOF
"RTN","PSACREDO",146,0)
 S PSAPG=PSAPG+1
"RTN","PSACREDO",147,0)
 W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE"
"RTN","PSACREDO",148,0)
 W !?27,"OUTSTANDING CREDITS REPORT",!?72,"PAGE "_PSAPG
"RTN","PSACREDO",149,0)
 W ! W:$E(IOST)'="C" "RUN DATE: "_PSARPDT
"RTN","PSACREDO",150,0)
 W !?36,"INVOICE",?46,"ADJUSTED",?58,"RECEIVED",?72,"OUTST."
"RTN","PSACREDO",151,0)
 W !,"INVOICE#",?28,"DATE",?39,"COST",?50,"COST",?59,"CREDITS",?72,"CREDIT",!,PSASLN
"RTN","PSACREDO",152,0)
 Q
"RTN","PSACREDO",153,0)
 ;
"RTN","PSACREDO",154,0)
PRTSLINE ;Prints a line of data on the summary report
"RTN","PSACREDO",155,0)
 W !,PSAINV,?26,PSAINVDT,?30,$J(PSAIECST,9,2),?45,$J(PSAAECST,9,2),?57,$J(PSACRED,9,2),?71,$J(PSAIDF,7,2)
"RTN","PSACREDO",156,0)
 Q
"RTN","PSACREDO",157,0)
 ;
"RTN","PSACREDO",158,0)
RPT ;Extended help for "Print a detailed or summary report"
"RTN","PSACREDO",159,0)
 W !?5,"Select DETAILED to print the order number, invoice number, invoice date,",!?5,"total invoice cost, adjusted cost, received credits, and Derence."
"RTN","PSACREDO",160,0)
 W !!?5,"Select SUMMARY to print all of the data on the detailed report plus the",!?5,"line item data that created the need for a credit. The line item data is"
"RTN","PSACREDO",161,0)
 W !?5,"the line item number, drug name, quantity invoiced, quantity received,",!?5,"reason for credit."
"RTN","PSACREDO",162,0)
 Q
"RTN","PSACREDR")
0^6^B30767974
"RTN","PSACREDR",1,0)
PSACREDR ;BIR/JMB-Credit Resolution ;7/23/97
"RTN","PSACREDR",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSACREDR",3,0)
 ;This routine allows the user to apply credit memos to invoices.
"RTN","PSACREDR",4,0)
 ;
"RTN","PSACREDR",5,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACREDR",6,0)
 I '$D(^XUSEC("PSAMGR",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACREDR",7,0)
 I '$O(^PSD(58.811,"AC",1,0)) W !!,"There are no outstanding credit memos." Q
"RTN","PSACREDR",8,0)
 S PSASLN="",$P(PSASLN,"-",80)=""
"RTN","PSACREDR",9,0)
START W ! S DIC="^PSD(58.811,",DIC(0)="AEQM",DIC("S")="I $D(^PSD(58.811,""AC"",1,+Y))" D ^DIC K DIE G:Y<0 EXIT
"RTN","PSACREDR",10,0)
 G:'$D(^PSD(58.811,+Y,0)) START
"RTN","PSACREDR",11,0)
 S PSAIEN=+Y,(PSAIEN1,PSAOUT)=0
"RTN","PSACREDR",12,0)
 F  S PSAIEN1=$O(^PSD(58.811,"AC",1,PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSACREDR",13,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSACREDR",14,0)
 .S (PSACRED,PSAAECST,PSAIECST)=0
"RTN","PSACREDR",15,0)
 .S PSAIEN2=0 F  S PSAIEN2=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2)) Q:'PSAIEN2!(PSAOUT)  D LINE Q:PSAOUT
"RTN","PSACREDR",16,0)
 .D CREDITS
"RTN","PSACREDR",17,0)
 D LIST
"RTN","PSACREDR",18,0)
 G:PSAOUT EXIT G START
"RTN","PSACREDR",19,0)
 ;
"RTN","PSACREDR",20,0)
EXIT ;Kills printing variables only
"RTN","PSACREDR",21,0)
 K DA,DIC,DIE,DIR,DIRUT,DR,PSA,PSAAECST,PSACIEN,PSACNT,PSACRED,PSADATA,PSADIF,PSADJ,PSADJD,PSADJDA,PSADJP,PSADJQ,PSADJSUP
"RTN","PSACREDR",22,0)
 K PSAIECST,PSAIEN,PSAIEN1,PSAIEN2,PSAINV,PSALEN,PSAMENU,PSANODE,PSAOUT,PSAPC,PSAPRICE,PSASEL,PSASLN,Y
"RTN","PSACREDR",23,0)
 Q
"RTN","PSACREDR",24,0)
 ;
"RTN","PSACREDR",25,0)
LINE ;Get line item data
"RTN","PSACREDR",26,0)
 Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,0))
"RTN","PSACREDR",27,0)
 K PSADJQ,PSADJP,PSADJD
"RTN","PSACREDR",28,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,0),PSADJSUP=0
"RTN","PSACREDR",29,0)
 ;Next line added 4dec97 to bypass checking drug name change
"RTN","PSACREDR",30,0)
 G DAVE
"RTN","PSACREDR",31,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,"B","D",0))
"RTN","PSACREDR",32,0)
 I $G(PSADJ) D  Q:'PSADJSUP
"RTN","PSACREDR",33,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,PSADJ,0))
"RTN","PSACREDR",34,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSACREDR",35,0)
 .Q:$G(PSADJD)&($L(PSADJD)=+$L(PSADJD))
"RTN","PSACREDR",36,0)
 .S PSADJSUP=1
"RTN","PSACREDR",37,0)
DAVE S PSAIECST=PSAIECST+($P(PSADATA,"^",3)*$P(PSADATA,"^",5))
"RTN","PSACREDR",38,0)
PRICE S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,"B","P",0))
"RTN","PSACREDR",39,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,PSADJ,0)),PSAPRICE=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSACREDR",40,0)
 I '+PSADJ S PSAPRICE=$P(PSADATA,"^",5)
"RTN","PSACREDR",41,0)
QTY S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,"B","Q",0))
"RTN","PSACREDR",42,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSACREDR",43,0)
 I $G(PSADJQ) S PSAAECST=PSAAECST+(PSADJQ*PSAPRICE)
"RTN","PSACREDR",44,0)
 I '$G(PSADJQ) S PSAAECST=PSAAECST+($P(PSADATA,"^",3)*PSAPRICE)
"RTN","PSACREDR",45,0)
 Q
"RTN","PSACREDR",46,0)
 ;
"RTN","PSACREDR",47,0)
CREDITS ;Adds existing credits to adjusted extended cost.
"RTN","PSACREDR",48,0)
 S PSACIEN=0 F  S PSACIEN=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,2,PSACIEN)) Q:'PSACIEN  D
"RTN","PSACREDR",49,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,2,PSACIEN,0))
"RTN","PSACREDR",50,0)
 .S PSACRED=PSACRED+$P(^PSD(58.811,PSAIEN,1,PSAIEN1,2,PSACIEN,0),"^",3)
"RTN","PSACREDR",51,0)
 S:PSAAECST'=PSAIECST PSA(PSAIEN1)=PSAIECST_"^"_$J(PSAAECST,$L($P(PSAAECST,".")),2)_"^"_PSACRED
"RTN","PSACREDR",52,0)
 Q
"RTN","PSACREDR",53,0)
 ;
"RTN","PSACREDR",54,0)
LIST ;Displays the invoices with outstanding credits
"RTN","PSACREDR",55,0)
 W @IOF,!,"Order#: "_$P($G(^PSD(58.811,PSAIEN,0)),"^")
"RTN","PSACREDR",56,0)
 W !?28,"Invoice",?42,"Adjusted",?56,"Received",!?4,"Invoice#",?31,"Cost",?46,"Cost",?57,"Credits",?69,"Difference",!,PSASLN
"RTN","PSACREDR",57,0)
 S (PSACNT,PSAIEN1)=0 F  S PSAIEN1=+$O(PSA(PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSACREDR",58,0)
 .S PSAIECST=+$P(PSA(PSAIEN1),"^"),PSAAECST=+$P(PSA(PSAIEN1),"^",2),PSACRED=+$P(PSA(PSAIEN1),"^",3)
"RTN","PSACREDR",59,0)
 .S PSACNT=PSACNT+1,PSAMENU(PSACNT,PSAIEN1)=PSA(PSAIEN1)
"RTN","PSACREDR",60,0)
 .W !,($J(PSACNT,2)),".",?4,$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,0)),"^"),?26,$J(PSAIECST,9,2),?41,$J(PSAAECST,9,2)
"RTN","PSACREDR",61,0)
 .W ?55,$J(PSACRED,9,2)
"RTN","PSACREDR",62,0)
 .S PSADIF=PSAIECST-(PSAAECST+PSACRED)
"RTN","PSACREDR",63,0)
 .W ?70,$J(PSADIF,9,2)
"RTN","PSACREDR",64,0)
 I PSACNT'>0 W !!!,?10,"NO INVOICES ON THIS ORDER # FOR CREDITING PURPOSES",! Q  ;Dave Blocker 3Dec97
"RTN","PSACREDR",65,0)
 W ! K DIR S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices",DIR("?")="Select the invoices to which you want to apply credit memos.",DIR("??")="^D CREDHELP^PSACREDR"
"RTN","PSACREDR",66,0)
 D ^DIR K DIR Q:Y=""  I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSACREDR",67,0)
 S PSASEL=Y
"RTN","PSACREDR",68,0)
 ;
"RTN","PSACREDR",69,0)
SELECT ;Selects invoices for credit memos
"RTN","PSACREDR",70,0)
 F PSAPC=1:1 S PSACNT=+$P(PSASEL,",",PSAPC) Q:'PSACNT  D  Q:PSAOUT
"RTN","PSACREDR",71,0)
 .S PSAINV=$O(PSAMENU(PSACNT,0)),PSAIECST=$P(PSAMENU(PSACNT,PSAINV),"^"),PSAAECST=$P(PSAMENU(PSACNT,PSAINV),"^",2),PSACRED=$P(PSAMENU(PSACNT,PSAINV),"^",3)
"RTN","PSACREDR",72,0)
 .W !!,"Invoice: "_$P($G(^PSD(58.811,PSAIEN,1,PSAINV,0)),"^"),!
"RTN","PSACREDR",73,0)
 .S DA(2)=PSAIEN,DA(1)=PSAINV,DA=PSAIEN2
"RTN","PSACREDR",74,0)
 .S:'$D(^PSD(58.811,PSAIEN,1,PSAINV,2,0)) DIC("P")=$P(^DD(58.8112,6,0),"^",2)
"RTN","PSACREDR",75,0)
 .S DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",2,",DIC(0)="AEMQL",DIC("A")="CREDIT MEMO: ",DR=.01,DLAYGO=58.811
"RTN","PSACREDR",76,0)
 .F  L +^PSD(58.811,PSAIEN,1,PSAINV,2,0):0 I  Q
"RTN","PSACREDR",77,0)
 .D ^DIC K DLAYGO I Y<0 S PSAOUT=1 K DIC Q
"RTN","PSACREDR",78,0)
 .S DIE=DIC,DR="1;2;3",(PSADJDA,DA)=+Y D ^DIE K DA,DIE,DIC L -^PSD(58.811,PSAIEN,1,PSAINV,2,0)
"RTN","PSACREDR",79,0)
 .S PSACRED=PSACRED+$P($G(^PSD(58.811,PSAIEN,1,PSAINV,2,PSADJDA,0)),"^",3)
"RTN","PSACREDR",80,0)
 .I PSAIECST=$J((PSAAECST+PSACRED),2) S DA(1)=PSAIEN,DA=PSAINV,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10////0" D ^DIE K DIE
"RTN","PSACREDR",81,0)
 .W !!,"Invoice: "_$P($G(^PSD(58.811,PSAIEN,1,PSAINV,0)),"^") S PSALEN=$L($P($G(^PSD(58.811,PSAIEN,1,PSAINV,0)),"^"))+11
"RTN","PSACREDR",82,0)
 .W ?PSALEN,"Total Invoiced Cost: "_$J(PSAIECST,9,2),!?PSALEN,"Total Adjusted Cost: "_$J(PSAAECST,9,2)
"RTN","PSACREDR",83,0)
 .W !?PSALEN,"Total Credits      : "_$J(PSACRED,9,2)
"RTN","PSACREDR",84,0)
 .W !?PSALEN,"Difference         : "_$J((PSAIECST-(PSAAECST+PSACRED)),9,2),!
"RTN","PSACREDR",85,0)
 Q
"RTN","PSACREDR",86,0)
 ;
"RTN","PSACREDR",87,0)
CREDHELP ;Extended help to 'Select invoices'
"RTN","PSACREDR",88,0)
 W !?5,"Enter the numbers to the left of the invoices for which you want to",!?5,"enter credit memos. To select more than one invoice number, enter"
"RTN","PSACREDR",89,0)
 W !?5,"the numbers to the left of the invoices separated by a comma or a dash.",!!?5,"For example: Enter 1,2,3,5 or 1-3,5"
"RTN","PSACREDR",90,0)
 Q
"RTN","PSADJ")
0^19^B43445805
"RTN","PSADJ",1,0)
PSADJ ;BIR/LTL,JMB-Balance Adjustments ;8/21/97
"RTN","PSADJ",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSADJ",3,0)
 ;This routine allows the user to review the drug history then enter
"RTN","PSADJ",4,0)
 ;adjustments.
"RTN","PSADJ",5,0)
 ;
"RTN","PSADJ",6,0)
 S DIR(0)="Y",DIR("A")="Review drug adjustment history",DIR("B")="No",DIR("?",1)="Enter yes to display all adjustments within a selected date range.",DIR("?")="Enter no to enter the adjustment."
"RTN","PSADJ",7,0)
 S DIR("??")="^D ADJ^PSADJ" D ^DIR K DIR G:$D(DIRUT) EXIT D:Y=1 ^PSADJR G:$G(DTOUT)!($G(DUOUT)) EXIT
"RTN","PSADJ",8,0)
 D SIG^XUSESIG G:X1="" EXIT
"RTN","PSADJ",9,0)
LOC ;Gets locations to have adjustments
"RTN","PSADJ",10,0)
 S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT
"RTN","PSADJ",11,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSADJ",12,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT
"RTN","PSADJ",13,0)
 S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  S PSALOC=0 F  S PSALOC=+$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC  D  Q:PSAOUT
"RTN","PSADJ",14,0)
 .D SITES^PSAUTL1,DRUG
"RTN","PSADJ",15,0)
 .I PSAOUT S PSAX=$O(PSALOC(PSALOCN)) I PSAX'="" S PSAOUT=0
"RTN","PSADJ",16,0)
 .K PSAX
"RTN","PSADJ",17,0)
 ;
"RTN","PSADJ",18,0)
EXIT ;Kills all variables
"RTN","PSADJ",19,0)
 K %,%DT,%ZIS,D0,D1,DA,DD,DIC,DIE,DINUM,DIR,DIRUT,DO,DR,DTOUT,DUOUT,PSA,PSACHK,PSACNT,PSACOMB,PSADJDT,PSADRUG,PSADRUGN,PSADT,PSAIEN,PSAISIT,PSAISITN
"RTN","PSADJ",20,0)
 K PSALOC,PSALOCA,PSALOCN,PSAOUT,PSAQ,PSAR,PSAREC,PSASEL,PSAT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSADJ",21,0)
 Q
"RTN","PSADJ",22,0)
 ;
"RTN","PSADJ",23,0)
DRUG ;Selects location's drug and processes adjustment
"RTN","PSADJ",24,0)
 F  S DIC="^PSD(58.8,PSALOC,1,",DIC(0)="AEMQZ",DIC("A")="Select drug to adjust: " D  Q:PSAOUT
"RTN","PSADJ",25,0)
 .S DIC("S")="I $S($P($G(^(0)),""^"",14):$P($G(^(0)),""^"",14)>DT,1:1)",DA(1)=PSALOC
"RTN","PSADJ",26,0)
 .W !!,PSALOCN D ^DIC K DIC I (Y<0&(X="")!(X="^"))!($G(DTOUT))!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSADJ",27,0)
 .Q:Y<0&(X'="")
"RTN","PSADJ",28,0)
 .S PSADRUG=+Y,PSADRUGN=$P($G(^PSDRUG(PSADRUG,0)),"^")
"RTN","PSADJ",29,0)
 .S PSAQ=$P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),"^",4)
"RTN","PSADJ",30,0)
 .W !!,"Current Balance: ",$G(PSAQ),!
"RTN","PSADJ",31,0)
 .S DIR(0)="NO^-999999:999999:2" S DIR("A")="Adjustment quantity"
"RTN","PSADJ",32,0)
 .S DIR("?",1)="Enter the amount of the adjustment. If it is a negative",DIR("?")="number, enter a minus sign '-' before the number.",DIR("??")="^D QTY^PSADJ"
"RTN","PSADJ",33,0)
 .D ^DIR K DIR Q:Y=0!(Y="")!($G(DUOUT))  I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSADJ",34,0)
 .S PSAREC=Y
"RTN","PSADJ",35,0)
 .S DIR(0)="F^1:45",DIR("A")="Adjustment reason",DIR("?")="Enter the reason why the adjustment was made",DIR("??")="^D REASON^PSADJ" D ^DIR K DIR
"RTN","PSADJ",36,0)
 .Q:$G(DUOUT)!(Y=" ")  I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSADJ",37,0)
 .S PSAR=Y,Y=DT D DD^%DT S PSADJDT=Y
"RTN","PSADJ",38,0)
 .S DIR(0)="D^:"_DT_":EX",DIR("A")="Adjustment date",DIR("B")=PSADJDT,DIR("?")="Enter the date that the adjustment applies",DIR("??")="^D ADJDATE^PSADJ"
"RTN","PSADJ",39,0)
 .D ^DIR K DIR Q:$G(DUOUT)  I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSADJ",40,0)
 .S PSADJDT=Y
"RTN","PSADJ",41,0)
POST .;Post adjustment if yes.
"RTN","PSADJ",42,0)
 .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?",1)="Enter yes to add or subtract the adjustment quantity from the current",DIR("?")="balance and record this transaction. Enter no to cancel this transaction."
"RTN","PSADJ",43,0)
 .S DIR("??")="^D OK^PSADJ" D ^DIR K DIR
"RTN","PSADJ",44,0)
 .I 'Y!($G(DIRUT)) S:$G(DTOUT) PSAOUT=1 W ! Q
"RTN","PSADJ",45,0)
 .D:Y=1  K PSADRUG Q
"RTN","PSADJ",46,0)
 ..W !,"There were ",$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),"^",4):$P($G(^(0)),"^",4),1:0)," on hand.  There are now ",$P($G(^(0)),"^",4)+$G(PSAREC)," on hand."
"RTN","PSADJ",47,0)
 ..W !,"Updating files. Please wait."
"RTN","PSADJ",48,0)
 ..F  L +^PSD(58.8,PSALOC,1,PSADRUG,0):0 I  Q
"RTN","PSADJ",49,0)
 ..D NOW^%DTC S PSADT=+$E(%,1,12)
"RTN","PSADJ",50,0)
 ..S PSAQ=$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),"^",4):$P($G(^(0)),"^",4),1:0)
"RTN","PSADJ",51,0)
 ..S $P(^PSD(58.8,PSALOC,1,PSADRUG,0),"^",4)=PSAREC+PSAQ
"RTN","PSADJ",52,0)
 ..L -^PSD(58.8,PSALOC,1,PSADRUG,0) W "."
"RTN","PSADJ",53,0)
MON ..S:'$D(^PSD(58.8,PSALOC,1,PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSADJ",54,0)
 ..I '$D(^PSD(58.8,PSALOC,1,PSADRUG,5,$E(PSADJDT,1,5)*100,0)) D
"RTN","PSADJ",55,0)
 ...K DD,DO S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",DIC("DR")="1////^S X=PSAQ",(X,DINUM)=$E(PSADJDT,1,5)*100
"RTN","PSADJ",56,0)
 ...S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO,DD,DO
"RTN","PSADJ",57,0)
 ...S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSADJ",58,0)
 ...S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG,DR="3////^S X=PSAQ" D ^DIE K DIE
"RTN","PSADJ",59,0)
 ..S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG,DA=$E(PSADJDT,1,5)*100
"RTN","PSADJ",60,0)
 ..S DR="7////^S X="_($P($G(^PSD(58.8,PSALOC,1,PSADRUG,5,DA,0)),"^",5)+PSAREC)_";3////^S X="_($P($G(^(0)),"^",4)+PSAREC)
"RTN","PSADJ",61,0)
 ..D ^DIE W "."
"RTN","PSADJ",62,0)
TR ..F  L +^PSD(58.81,0):0 I  Q
"RTN","PSADJ",63,0)
FIND ..S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT,0)) S $P(^(0),"^",3)=$P(^(0),"^",3)+1 G FIND
"RTN","PSADJ",64,0)
 ..L -^PSD(58.81,0) K DD,DIC,DO W "."
"RTN","PSADJ",65,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,X=PSAT D ^DIC K DIC,DLAYGO W "."
"RTN","PSADJ",66,0)
 ..S DR="1////9;2////^S X=PSALOC;3////^S X="_$S(PSADJDT=$E(PSADT,1,7):PSADT,1:PSADJDT)_";4////^S X=PSADRUG;5////^S X=PSAREC;6////^S X=DUZ;9////^S X=PSAQ;15////^S X=PSAR"_$S(PSADJDT'=$E(PSADT,1,7):";22////^S X="_PSADT,1:"")
"RTN","PSADJ",67,0)
 ..S DIE="^PSD(58.81,",DA=PSAT D ^DIE K DIE,DD,DO W "."
"RTN","PSADJ",68,0)
 ..S:'$D(^PSD(58.8,PSALOC,1,PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSADJ",69,0)
 ..S DIC="^PSD(58.8,PSALOC,1,PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSADJ",70,0)
 ..S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO,DA,PSADRUG W ".",!
"RTN","PSADJ",71,0)
 Q
"RTN","PSADJ",72,0)
 ;
"RTN","PSADJ",73,0)
ADJ ;Extended help for "Review drug adjustment history" at PSADJ+2
"RTN","PSADJ",74,0)
 W !,"Enter yes to print all adjustments for this drug on the screen",!,"or printer. You can enter an adjustment after the report prints."
"RTN","PSADJ",75,0)
 W !!,"Enter no to bypass the report and make an adjustment."
"RTN","PSADJ",76,0)
 Q
"RTN","PSADJ",77,0)
ADJDATE ;Extended help for "Adjustment date"
"RTN","PSADJ",78,0)
 W !,"If the adjustment pertains today, press the Return key.",!!,"If the adjustment is for a previous date, enter that date."
"RTN","PSADJ",79,0)
 W !,"Today's date will be recorded as the date the adjustment was made."
"RTN","PSADJ",80,0)
 Q
"RTN","PSADJ",81,0)
OK    ;Extended help for "OK to post?"
"RTN","PSADJ",82,0)
 W !,"Enter yes to record this adjustment. The adjustment quantity will be subtracted",!,"from or added to the drug's current balance. The transaction will be recorded"
"RTN","PSADJ",83,0)
 W !,"in the activity log and the monthly balance will be adjusted.",!!,"Enter no to abort the adjustment process and return to the menu."
"RTN","PSADJ",84,0)
 Q
"RTN","PSADJ",85,0)
QTY ;Extended help for "Adjustment quantity"
"RTN","PSADJ",86,0)
 W !,"Enter the quantity to be added or subtracted from the current balance.",!,"If the quantity should be subtracted from the balance, enter a minus"
"RTN","PSADJ",87,0)
 W !,"sign '-' before the quantity.",!!,"For example: -10 or -150 will be subtracted from the balance.",!?14,"10 or 150 will be added to the balance."
"RTN","PSADJ",88,0)
 Q
"RTN","PSADJ",89,0)
REASON ;Extended help for "Adjustment reason"
"RTN","PSADJ",90,0)
 W !,"Enter the reason you are changing the current balance."
"RTN","PSADJ",91,0)
 Q
"RTN","PSADRUGP")
0^31^B20287476
"RTN","PSADRUGP",1,0)
PSADRUGP ;BIR/LTL,JMB-Enter/Edit a Drug ;7/23/97
"RTN","PSADRUGP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSADRUGP",3,0)
 ;
"RTN","PSADRUGP",4,0)
LOC G:+$G(PSAOUT)&($G(PSACNT)=1) EXIT
"RTN","PSADRUGP",5,0)
 S (PSADD,PSACNT,PSAOUT)=0,PSASLN="",$P(PSASLN,"-",80)=""
"RTN","PSADRUGP",6,0)
 D ^PSAUTL3 G:PSAOUT EXIT S PSACHK=$O(PSALOC(""))
"RTN","PSADRUGP",7,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT
"RTN","PSADRUGP",8,0)
 I $O(PSALOC(PSACHK))="" W !,PSALOCN
"RTN","PSADRUGP",9,0)
 ;
"RTN","PSADRUGP",10,0)
GETDRUG S PSAQTY=0
"RTN","PSADRUGP",11,0)
 S:'$D(^PSD(58.8,PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSADRUGP",12,0)
 S DA(1)=PSALOC,DIC="^PSD(58.8,"_PSALOC_",1,",DIC(0)="AEMQL",DIC("W")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)'>DT,1:0) W $C(7),""   *** INACTIVE ***""",DLAYGO=58.8 W ! D ^DIC K DIC,DLAYGO
"RTN","PSADRUGP",13,0)
 I Y<0!($G(DTOUT))!($G(DUOUT)) S PSAOUT=1 G LOC
"RTN","PSADRUGP",14,0)
 S PSADRG=+Y,PSADRGN=$P($G(^PSDRUG(PSADRG,0)),"^")
"RTN","PSADRUGP",15,0)
 I $D(^PSD(58.8,PSALOC,1,PSADRG,0)),+$P(^(0),"^",14),$P(^(0),"^",14)'>DT W !,$C(7),"   *** INACTIVE ***" G GETDRUG
"RTN","PSADRUGP",16,0)
 S PSA660=$G(^PSDRUG(PSADRG,660))
"RTN","PSADRUGP",17,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) G NOINV
"RTN","PSADRUGP",18,0)
 I $D(^PSD(58.8,PSALOC,1,PSADRG,0)),$P(^(0),"^",4)="" G DRUG
"RTN","PSADRUGP",19,0)
 G DISP
"RTN","PSADRUGP",20,0)
 ;
"RTN","PSADRUGP",21,0)
NOINV I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSADRUGP",22,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSADRUGP",23,0)
 .K DA,DD,DO S DIC="^PSD(58.8,"_PSALOC_",1,",DIC(0)="LM",DA(1)=PSALOC,(X,DINUM)=PSADRG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSADRUGP",24,0)
DRUG S DIE="^PSD(58.8,"_PSALOC_",1,",DA(1)=PSALOC,DA=PSADRG,DR="3Enter total "_$P(PSA660,"^",8)_" currently on hand: "
"RTN","PSADRUGP",25,0)
 W @IOF,!,$G(PSALOCN),!,"DRUG: "_PSADRGN
"RTN","PSADRUGP",26,0)
 D:+$P(PSA660,"^",2)
"RTN","PSADRUGP",27,0)
 .W !!?30,"DRUG FILE info:",!
"RTN","PSADRUGP",28,0)
 .W ?20,"Order unit: "_$P(^DIC(51.5,$P(PSA660,"^",2),0),"^",2),!?20,"Dispense units per order unit: "_$P(PSA660,"^",5),!?20,"Dispense unit: "_$P(PSA660,"^",8)
"RTN","PSADRUGP",29,0)
 .W !!,"Current Inventory from the DRUG file = "_$P($G(^PSDRUG(PSADRG,660.1)),"^")
"RTN","PSADRUGP",30,0)
 I '$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4) D
"RTN","PSADRUGP",31,0)
 .W !!,"Once an initial quantity is entered, it can only be updated by receiving,",!,"dispensing, adjusting, or transferring."
"RTN","PSADRUGP",32,0)
 .W:+$P(PSA660,"^",2) " The Current Inventory from the",!,"DRUG file is only offered as an initial balance and and is NOT updated."
"RTN","PSADRUGP",33,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSADRUGP",34,0)
 W ! D ^DIE L -^PSD(58.8,PSALOC,1,PSADRG,0) K DA,DIE G:$D(Y) LOC
"RTN","PSADRUGP",35,0)
 S PSAQTY=X
"RTN","PSADRUGP",36,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSADRUGP",37,0)
 .S DIE="^PSD(58.8,"_PSALOC_",1,",DA(1)=PSALOC,DA=PSADRG,DR="2Stock Level: ;4Reorder Level: "
"RTN","PSADRUGP",38,0)
 .F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSADRUGP",39,0)
 .D ^DIE L -^PSD(58.8,PSALOC,1,PSADRG,0) K DA,DIE
"RTN","PSADRUGP",40,0)
DISP W !!,"Current balance:  "_+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)," ",$P(PSA660,"^",8)
"RTN","PSADRUGP",41,0)
 S PSAIT=PSADRG,PSAIT(2)=PSADRGN,PSAIT(4)=$G(^PSDRUG(PSAIT,660)) D:$O(^PS(52.6,"AC",PSADRG,0))!($O(^PS(52.7,"AC",PSADRG,0))) ^PSAPSI4
"RTN","PSADRUGP",42,0)
 G:'$G(PSAQTY) GETDRUG
"RTN","PSADRUGP",43,0)
 D NOW^%DTC S PSADT=+$E(%,1,12)
"RTN","PSADRUGP",44,0)
MON S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) ^PSD(58.8,PSALOC,1,PSADRG,5,0)="^58.801A^^"
"RTN","PSADRUGP",45,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,+($E(DT,1,5)*100),0)) S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="LM",(X,DINUM)=($E(DT,1,5)*100),DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSADRUGP",46,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DA(2)=PSALOC,DA(1)=PSADRG,DA=($E(DT,1,5)*100),DR="1////^S X=PSAQTY;7////^S X=PSAQTY" D ^DIE K DA,DIE
"RTN","PSADRUGP",47,0)
 W !!,"Updating beginning balance and transaction history."
"RTN","PSADRUGP",48,0)
 F  L +^PSD(58.81,0):0 I  Q
"RTN","PSADRUGP",49,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSADRUGP",50,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC
"RTN","PSADRUGP",51,0)
 L -^PSD(58.81,0) K DIC,DLAYGO
"RTN","PSADRUGP",52,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////11;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSAQTY;6////^S X=DUZ;9////0" D ^DIE K DIE,DA
"RTN","PSADRUGP",53,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,4,0)) ^PSD(58.8,PSALOC,1,PSADRG,4,0)="^58.800119PA^^"
"RTN","PSADRUGP",54,0)
 S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",4,",DIC(0)="LM",(X,DINUM)=PSAT
"RTN","PSADRUGP",55,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSADRUGP",56,0)
 G GETDRUG
"RTN","PSADRUGP",57,0)
EXIT K %,DA,DIC,DIE,DINUM,DR,DTOUT,DUOUT,PSA660,PSACHK,PSACNT,PSADD,PSADRG,PSADRGN,PSADT,PSALOC,PSALOCA,PSALOCN,PSAOUT,PSAQTY,PSASLN,PSAT,X,Y
"RTN","PSADRUGP",58,0)
 Q
"RTN","PSAFIX")
0^40^B2452315
"RTN","PSAFIX",1,0)
PSAFIX ;BHM/DB - FIX INACTIVE DRUGS IN 58.8;10/3/97
"RTN","PSAFIX",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAFIX",3,0)
 D NOW^%DTC W @IOF K PSALOC,PSACNT
"RTN","PSAFIX",4,0)
 W !!,"Correcting erroneous Drug entries in file 58.8.",!
"RTN","PSAFIX",5,0)
BGN ;begin the loop
"RTN","PSAFIX",6,0)
 S PSALOC=$S('$D(PSALOC):$O(^PSD(58.8,0)),1:$O(^PSD(58.8,PSALOC))) G DONE:PSALOC'>0
"RTN","PSAFIX",7,0)
 ;
"RTN","PSAFIX",8,0)
 K DRUG
"RTN","PSAFIX",9,0)
DRUG S DRUG=$S('$D(DRUG):$O(^PSD(58.8,PSALOC,1,0)),1:$O(^PSD(58.8,PSALOC,1,DRUG))) G BGN:DRUG'>0 G DRUG:'$D(^PSD(58.8,PSALOC,1,DRUG,0)) S DATA=^PSD(58.8,PSALOC,1,DRUG,0) I $P(DATA,"^",1)'="" G DRUG
"RTN","PSAFIX",10,0)
 S $P(^PSD(58.8,PSALOC,1,DRUG,0),"^",1)=DRUG,^PSD(58.8,PSALOC,1,"B",DRUG,DRUG)="",PSACNT=$G(PSACNT)+1
"RTN","PSAFIX",11,0)
 G DRUG
"RTN","PSAFIX",12,0)
DONE W !!,"Patch PSA*3*3 has finished, and corrected ",$G(PSACNT)," bad entries.",!
"RTN","PSAFIX",13,0)
Q Q
"RTN","PSAHIS")
0^3^B23035600
"RTN","PSAHIS",1,0)
PSAHIS ;BIR/LTL,JMB-Drug Transaction History ;7/23/97
"RTN","PSAHIS",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAHIS",3,0)
 ;This routine prints a report of all or specific drugs in a pharmacy
"RTN","PSAHIS",4,0)
 ;location for a user-specified number of days.
"RTN","PSAHIS",5,0)
 ;
"RTN","PSAHIS",6,0)
LOC ;Gets locations & drugs to print
"RTN","PSAHIS",7,0)
 S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT1
"RTN","PSAHIS",8,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSAHIS",9,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT1
"RTN","PSAHIS",10,0)
 W ! S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""!(PSAOUT)  S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC!(PSAOUT)  D
"RTN","PSAHIS",11,0)
 .W @IOF W:$L(PSALOCN)>79 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<80 !,PSALOCN
"RTN","PSAHIS",12,0)
 .D DRUG Q:PSAOUT  Q:X["^A"
"RTN","PSAHIS",13,0)
 G:PSAOUT EXIT G DAYS
"RTN","PSAHIS",14,0)
DRUG ;Gets drugs to print
"RTN","PSAHIS",15,0)
 W !!,"You may select one, several, or ^ALL drugs."
"RTN","PSAHIS",16,0)
 F  S DIC="^PSD(58.8,"_+PSALOC_",1,",DIC(0)="AEMQ",DIC("A")="Select Drug: " D  Q:PSAOUT!(Y<0)!(X["^A")
"RTN","PSAHIS",17,0)
 .D ^DIC K DIC I X'["^A"&(Y<1)&('PSACNT) S PSAOUT=1 Q
"RTN","PSAHIS",18,0)
 .I X["^A" D ALL^PSAHIS1 Q
"RTN","PSAHIS",19,0)
 .Q:Y<0  I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAHIS",20,0)
 .S ^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(+Y,0)),"^"),+Y)="" S PSACNT=PSACNT+1
"RTN","PSAHIS",21,0)
 .I PSACNT=1,'$O(^PSD(58.81,"F",+$O(^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(+Y,0)),"^"),0)),0)) W !!,"There have been no transactions for this drug.",!
"RTN","PSAHIS",22,0)
 I '$D(PSALOC) W !!,"There are no drugs in all the selected location(s)." G EXIT
"RTN","PSAHIS",23,0)
 Q
"RTN","PSAHIS",24,0)
 ;
"RTN","PSAHIS",25,0)
DAYS G:$O(^TMP("PSADRG",$J,""))="" EXIT
"RTN","PSAHIS",26,0)
 S DIR(0)="D:AEP",DIR("A")="How many days back do you want to search for the drug: ",DIR("B")="T-6M",DIR("?")="I will list transactions for your selected drug(s) within the last six months if you press return" W ! D ^DIR K DIR
"RTN","PSAHIS",27,0)
 S PSABDT=Y G:$G(DIRUT) EXIT
"RTN","PSAHIS",28,0)
 ;
"RTN","PSAHIS",29,0)
DEV ;Asks device & queueing info
"RTN","PSAHIS",30,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="0Q" W !
"RTN","PSAHIS",31,0)
 D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAHIS",32,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSAHIS",33,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSAHIS",34,0)
 .S ZTRTN="START^PSAHIS",ZTDESC="Drug Acct.-Drug Transaction History"
"RTN","PSAHIS",35,0)
 .S ZTSAVE("PSALOC(")="",ZTSAVE("PSABDT")="",ZTSAVE("^TMP(""PSADRG"",$J,")="" D ^%ZTLOAD
"RTN","PSAHIS",36,0)
 ;
"RTN","PSAHIS",37,0)
START ;Compiles & prints output data
"RTN","PSAHIS",38,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,"."),PSATM=$P(PSARPDT,".",2)
"RTN","PSAHIS",39,0)
 S PSARPDT=$E(PSADT,4,5)_"-"_$E(PSADT,6,7)_"-"_$E(PSADT,2,3),PSARUN=PSARPDT_"@"_PSATM
"RTN","PSAHIS",40,0)
 S PSADLN="=====================================|==========|=====|=====|==========|========"
"RTN","PSAHIS",41,0)
 S PSABDTR=$E(PSABDT,4,5)_"-"_$E(PSABDT,6,7)_"-"_$E(PSABDT,2,3),PSAOUT=0
"RTN","PSAHIS",42,0)
 S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  D  G:PSAOUT EXIT
"RTN","PSAHIS",43,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC  D SITES^PSAUTL1,FIND Q:PSAOUT
"RTN","PSAHIS",44,0)
 ;
"RTN","PSAHIS",45,0)
EXIT W:$E(IOST,1,2)="C-" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAHIS",46,0)
 K IO("Q"),^TMP("PSA",$J),^TMP("PSADRG",$J),^TMP("PSAHIS",$J),PSALOC,PSALOCA,PSALOCN
"RTN","PSAHIS",47,0)
 ;G:'PSAOUT LOC
"RTN","PSAHIS",48,0)
EXIT1 K %ZIS,DIC,DIR,DIRUT,DTOUT,DUOUT,PSA50,PSABAD,PSABAD1,PSABAL,PSABDT,PSABDTR,PSACHK,PSACNT,PSACOMB,PSADJT,PSADJDT,PSADLN,PSADRG,PSADRUG,PSADT
"RTN","PSAHIS",49,0)
 K PSAFIRST,PSAHOLD,PSAHOLDN,PSAIPT,PSAISIT,PSAISITN,PSALN,PSALOC,PSALOCA,PSALOCN,PSANONE,PSAOPT,PSAOSIT,PSAOSITN,PSAOUT,PSAPC,PSAPC1,PSAPCS,PSAPG
"RTN","PSAHIS",50,0)
 K PSAREA,PSARECT,PSARPDT,PSARPDT,PSARUN,PSAS,PSASEL,PSASITES,PSASS,PSATM,PSATR,PSATR0,PSATRANL,PSATRCNT,PSAWRT,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSAHIS",51,0)
 Q
"RTN","PSAHIS",52,0)
FIND ;Finds drugs & puts in alpha order in ^TMP("PSAHIS",$J)
"RTN","PSAHIS",53,0)
 K ^TMP("PSAHIS",$J),^TMP("PSA",$J),PSAFIRST
"RTN","PSAHIS",54,0)
 S (PSACNT,PSAPG)=0,PSADRG=""
"RTN","PSAHIS",55,0)
 F  S PSADRG=$O(^TMP("PSADRG",$J,PSALOC,PSADRG)) Q:PSADRG=""  S (PSABAD,PSA50)=0 F  S PSA50=$O(^TMP("PSADRG",$J,PSALOC,PSADRG,PSA50)) Q:'PSA50  D
"RTN","PSAHIS",56,0)
 .;I '$G(PSATR),$O(^TMP("PSADRG",$J,PSALOC,PSADRG,0)) S PSA50=$O(^TMP("PSADRG",$J,PSALOC,PSADRG,0))
"RTN","PSAHIS",57,0)
 .S (PSAFIRST,PSATR)=0 F  S PSATR=+$O(^PSD(58.81,"F",PSA50,PSATR)) Q:'PSATR!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAHIS",58,0)
 ..S PSATR0=$G(^PSD(58.81,PSATR,0)) Q:$P(PSATR0,"^",3)'=PSALOC
"RTN","PSAHIS",59,0)
 ..I $P(PSATR0,"^",4)'<PSABDT S ^TMP("PSAHIS",$J,PSADRG,$E($P(PSATR0,"^",4),1,7),PSATR)="" S:'PSAFIRST PSAFIRST=PSATR,^TMP("PSA",$J,PSADRG)=PSATR Q
"RTN","PSAHIS",60,0)
 ..I PSAFIRST,PSATR>PSAFIRST S PSABAD1=$S($P(PSATR0,"^",2)=2!($P(PSATR0,"^",2)=15)!($P(PSATR0,"^",2)=6):-$P(PSATR0,"^",6),1:$P(PSATR0,"^",6)) S PSABAD(PSADRG)=$G(PSABAD(PSADRG))+PSABAD1
"RTN","PSAHIS",61,0)
 I $D(^TMP("PSAHIS",$J)) D ^PSAHIS1 Q
"RTN","PSAHIS",62,0)
 I '$D(^TMP("PSAHIS",$J)) W !!,"No transactions were found for the pharmacy location." H 1
"RTN","PSAHIS",63,0)
 Q
"RTN","PSAHIS1")
0^4^B38528696
"RTN","PSAHIS1",1,0)
PSAHIS1 ;BIR/LTL,JMB-Drug Transaction History - CONT'D ;7/23/97
"RTN","PSAHIS1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAHIS1",3,0)
 ;Prints the Show Drug Transaction History report in pharmacy location
"RTN","PSAHIS1",4,0)
 ;then date order. It is called by PSAHIS.
"RTN","PSAHIS1",5,0)
 ;
"RTN","PSAHIS1",6,0)
PRINT D HEADER S PSADRG="",PSACNT=0
"RTN","PSAHIS1",7,0)
 F  S PSADRG=$O(^TMP("PSAHIS",$J,PSADRG)) Q:PSADRG=""!(PSAOUT)  D:$Y+6>IOSL HEADER Q:PSAOUT  K PSABAL,PSATRCNT S PSADT=0 D  Q:PSAOUT
"RTN","PSAHIS1",8,0)
 .F  S PSADT=+$O(^TMP("PSAHIS",$J,PSADRG,PSADT)) Q:'PSADT!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAHIS1",9,0)
 ..S PSATR=0 F  S PSATR=+$O(^TMP("PSAHIS",$J,PSADRG,PSADT,PSATR)) Q:'PSATR!(PSAOUT)  D:$Y+6>IOSL HEADER Q:PSAOUT  D TRANS
"RTN","PSAHIS1",10,0)
 .Q:PSAOUT  D:$Y+6>IOSL HEADER Q:PSAOUT  D TOTALS
"RTN","PSAHIS1",11,0)
 I 'PSACNT W !!,"No transactions were found for the pharmacy location."
"RTN","PSAHIS1",12,0)
 Q:PSAOUT
"RTN","PSAHIS1",13,0)
 ;
"RTN","PSAHIS1",14,0)
DONE ;Holds screen or ejects paper if sent to printer
"RTN","PSAHIS1",15,0)
 I $E(IOST,1,2)="C-" D
"RTN","PSAHIS1",16,0)
 .S PSAS=21-$Y F PSASS=1:1:PSAS W !
"RTN","PSAHIS1",17,0)
 .S DIR(0)="EA",DIR("A")="End of pharmacy location's display! Enter RETURN to continue or '^' to exit:" D ^DIR K DIR S:$G(DIRUT) PSAOUT=1
"RTN","PSAHIS1",18,0)
 I $E(IOST)'="C" W !!!,"REPORT RUN: ",PSARUN W @IOF
"RTN","PSAHIS1",19,0)
 Q
"RTN","PSAHIS1",20,0)
 ;
"RTN","PSAHIS1",21,0)
TRANS S PSATR0=$G(^PSD(58.81,PSATR,0)),PSACNT=1,PSATRCNT=$G(PSATRCNT)+1
"RTN","PSAHIS1",22,0)
 ;If it is first transaction for drug, print drug name & beg balance.
"RTN","PSAHIS1",23,0)
 ;Beg balance = 1st transaction + (receipts(+), adjs(+/-), &
"RTN","PSAHIS1",24,0)
 ;dispensing(-) made prior to beg date & fell within rpt date range)
"RTN","PSAHIS1",25,0)
 I PSATRCNT=1 D
"RTN","PSAHIS1",26,0)
 .W !,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" D WRAPDRUG
"RTN","PSAHIS1",27,0)
 .S PSABAL=$P($G(^PSD(58.81,+^TMP("PSA",$J,PSADRG),0)),"^",10)+$G(PSABAD(PSADRG)) W ?72,$J(PSABAL,7)
"RTN","PSAHIS1",28,0)
 ;
"RTN","PSAHIS1",29,0)
 ;Print transaction date & +/- qty from balance
"RTN","PSAHIS1",30,0)
 W !,$E(PSADT,4,5)_"-"_$E(PSADT,6,7)_"-"_$E(PSADT,2,3),?10,$E($P($G(^VA(200,+$P(PSATR0,"^",7),0)),"^"),1,28)
"RTN","PSAHIS1",31,0)
 I $P(PSATR0,"^",2)'=24 S PSABAL=$S(119[$P(PSATR0,"^",2):PSABAL+$P(PSATR0,"^",6),1:PSABAL-$P(PSATR0,"^",6))
"RTN","PSAHIS1",32,0)
 I $P(PSATR0,"^",2)=24 S PSABAL=PSABAL+$P(PSATR0,"^",6)
"RTN","PSAHIS1",33,0)
 ;Receipts
"RTN","PSAHIS1",34,0)
 I $P(PSATR0,"^",2)=1 S PSAWRT=0 W ?37,"|",?41,$J($P(PSATR0,"^",6),6),?48,"|",?54,"|",?60,"|",?71,"|",?72,$J(PSABAL,7),! S PSARECT=$G(PSARECT)+$P(PSATR0,"^",6) D  Q
"RTN","PSAHIS1",35,0)
 .I $P($G(^PRC(442,+$P(PSATR0,"^",9),0)),"^") W ?11,"PO# ",$P($G(^(0)),"^"),?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSALN=$G(PSALN)+1 S PSAWRT=1
"RTN","PSAHIS1",36,0)
 .I $P($G(^PRCS(410,+$P(PSATR0,"^",8),0)),"^") W:PSAWRT ! W ?11,"TR# ",$P($G(^(0)),"^"),?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSALN=$G(PSALN)+1,PSAWRT=1
"RTN","PSAHIS1",37,0)
 .I $P($G(^PSD(58.81,PSATR,8)),"^",2)'="" W:PSAWRT ! W ?11,"ORD# ",$P($G(^(8)),"^",2),?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSALN=$G(PSALN)+1,PSAWRT=1
"RTN","PSAHIS1",38,0)
 .I $P($G(^PSD(58.81,PSATR,8)),"^")'="" W:PSAWRT ! W ?11,"INV# ",$P($G(^(8)),"^"),?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSALN=$G(PSALN)+1,PSAWRT=1
"RTN","PSAHIS1",39,0)
 .W:$G(PSAW) !?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" K PSAW
"RTN","PSAHIS1",40,0)
 ;Adjusted or transferred
"RTN","PSAHIS1",41,0)
 I $P(PSATR0,"^",2)=9!($P(PSATR0,"^",2)=11)!($P(PSATR0,"^",2)=24) D  Q
"RTN","PSAHIS1",42,0)
 .W ?37,"|",?48,"|",?54,"|",?60,"|",?64,$J($P(PSATR0,"^",6),6),?71,"|",?72,$J(PSABAL,7)
"RTN","PSAHIS1",43,0)
 .I +$P(PSATR0,"^",19) S PSADJDT=$P(PSATR0,"^",19) W !?11,"DATE ENTERED: "_$E(PSADJDT,4,5)_"-"_$E(PSADJDT,6,7)_"-"_$E(PSADJDT,2,3),?37,"|",?48,"|",?54,"|",?60,"|",?71,"|"
"RTN","PSAHIS1",44,0)
 .I $P(PSATR0,"^",2)=9!($P(PSATR0,"^",2)=11),$P(PSATR0,"^",16)'="" D REASON
"RTN","PSAHIS1",45,0)
 .D:$P(PSATR0,"^",2)=24 TRANSFER S PSADJT=$G(PSADJT)+$P(PSATR0,"^",6)
"RTN","PSAHIS1",46,0)
 ;Dispensed by IP (2 means Unit Dose or Ward Stock 15 means IV)
"RTN","PSAHIS1",47,0)
 I $P(PSATR0,"^",2)=2!($P(PSATR0,"^",2)=15) W ?10,"NIGHTLY BACKGROUND JOB",?37,"|",?48,"|",?49,$J($P(PSATR0,"^",6),5),?54,"|",?60,"|",?71,"|",?72,$J(PSABAL,7) S PSAIPT=$G(PSAIPT)+$P(PSATR0,"^",6) Q
"RTN","PSAHIS1",48,0)
 ;Dispensed by OP
"RTN","PSAHIS1",49,0)
 I $P(PSATR0,"^",2)=6 W ?10,"NIGHTLY BACKGROUND JOB",?37,"|",?48,"|",?54,"|",?55,$J($P(PSATR0,"^",6),5),?60,"|",?71,"|",?72,$J(PSABAL,7) S PSAOPT=$G(PSAOPT)+$P(PSATR0,"^",6)
"RTN","PSAHIS1",50,0)
 Q
"RTN","PSAHIS1",51,0)
 ;
"RTN","PSAHIS1",52,0)
HEADER ;Prints header info
"RTN","PSAHIS1",53,0)
 S PSAPG=PSAPG+1 I PSAPG=1,$E(IOST,1,2)="C-" W @IOF
"RTN","PSAHIS1",54,0)
 I $E(IOST,1,2)="C-",PSAPG>1 D  Q:PSAOUT
"RTN","PSAHIS1",55,0)
 .S PSAS=21-$Y F PSASS=1:1:PSAS W !
"RTN","PSAHIS1",56,0)
 .S DIR(0)="E" D ^DIR K DIR W:'$G(DIRUT) @IOF S:$G(DIRUT) PSAOUT=1
"RTN","PSAHIS1",57,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),"^"),"." S PSAOUT=1 Q
"RTN","PSAHIS1",58,0)
 I PSAPG>1,$E(IOST)'="C" W @IOF
"RTN","PSAHIS1",59,0)
 W !?22,"D R U G   A C C O U N T A B I L I T Y",?71,"Page ",$J(PSAPG,2)
"RTN","PSAHIS1",60,0)
 W !?((42-$L(PSABDTR)-$L(PSARPDT))/2),"HISTORY OF DRUG TRANSACTIONS FROM ",PSABDTR," TO ",PSARPDT
"RTN","PSAHIS1",61,0)
 W !?((80-$L(PSALOCN))/2),PSALOCN
"RTN","PSAHIS1",62,0)
 W !!?37,"|",?48,"| DISPENSED |",?71,"|"
"RTN","PSAHIS1",63,0)
 W !,"DATE",?10,"INITIATOR",?37,"| RECEIVED |  IP |  OP | ADJUSTED | BALANCE"
"RTN","PSAHIS1",64,0)
 W !,PSADLN
"RTN","PSAHIS1",65,0)
 I $G(PSADRG)'=""&($G(PSATRCNT)) D WRAPDRUG W ?72,$J(PSABAL,7)
"RTN","PSAHIS1",66,0)
 Q
"RTN","PSAHIS1",67,0)
 ;
"RTN","PSAHIS1",68,0)
ALL ;Creates drug array with all drugs in location
"RTN","PSAHIS1",69,0)
 S PSA50=0 F  S PSA50=+$O(^PSD(58.8,PSALOC,1,PSA50)) Q:'PSA50  S:$P($G(^PSDRUG(PSA50,0)),"^")'="" ^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(PSA50,0)),"^"),PSA50)="",PSACNT=PSACNT+1
"RTN","PSAHIS1",70,0)
 Q
"RTN","PSAHIS1",71,0)
 ;
"RTN","PSAHIS1",72,0)
WRAPDRUG ;Prints drug name w/o spliting words
"RTN","PSAHIS1",73,0)
 I $L(PSADRG)<36 W !,"* ",PSADRG,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" Q
"RTN","PSAHIS1",74,0)
 S PSAPC1="" F PSAPCS=1:1 S PSAPC=$P(PSADRG," ",PSAPCS) Q:PSAPC=""  D
"RTN","PSAHIS1",75,0)
 .I $L(PSAPC1)+$L(PSAPC)+1<36 S PSAPC1=PSAPC1_PSAPC_" " Q
"RTN","PSAHIS1",76,0)
 .I $L(PSAPC1)+$L(PSAPC)+1>35 W !,"* "_PSAPC1,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSAPC1=PSAPC_" "
"RTN","PSAHIS1",77,0)
 W:$L(PSAPC1) !?4,PSAPC1,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|"
"RTN","PSAHIS1",78,0)
 Q
"RTN","PSAHIS1",79,0)
 ;
"RTN","PSAHIS1",80,0)
REASON ;Prints transaction reason w/o spliting words
"RTN","PSAHIS1",81,0)
 S PSAREA=$P(PSATR0,"^",16)
"RTN","PSAHIS1",82,0)
 I $L(PSAREA)<27 W !?11,PSAREA,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" Q
"RTN","PSAHIS1",83,0)
 S PSAPC1="" F PSAPCS=1:1 S PSAPC=$P(PSAREA," ",PSAPCS) Q:PSAPC=""  D
"RTN","PSAHIS1",84,0)
 .I $L(PSAPC1)+$L(PSAPC)+1<27 S PSAPC1=PSAPC1_PSAPC_" " Q
"RTN","PSAHIS1",85,0)
 .I $L(PSAPC1)+$L(PSAPC)+1>26 W !?11,PSAPC1,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSAPC1=PSAPC_" "
"RTN","PSAHIS1",86,0)
 W:$L(PSAPC1) !?11,PSAPC1,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|"
"RTN","PSAHIS1",87,0)
 Q
"RTN","PSAHIS1",88,0)
 ;
"RTN","PSAHIS1",89,0)
TRANSFER ;Prints transfer pharm loc that rec'd or sent drugs
"RTN","PSAHIS1",90,0)
 S PSATRANL=$P($G(^PSD(58.81,+$P(PSATR0,"^",17),0)),"^",3),PSAHOLD=PSALOC,PSAHOLDN=PSALOCN,PSALOC=PSATRANL
"RTN","PSAHIS1",91,0)
 I PSALOC="" S PSAREA="TRANSFER DATA MISSING" S PSALOC=PSAHOLD,PSALOCN=PSAHOLDN Q
"RTN","PSAHIS1",92,0)
 D SITES^PSAUTL1 S PSALOCN=$P(^PSD(58.8,PSALOC,0),"^")_PSACOMB
"RTN","PSAHIS1",93,0)
 S PSAREA="TRANSFER "_$S($P(PSATR0,"^",6)<0:"TO ",1:"FROM ") D TRAN
"RTN","PSAHIS1",94,0)
 S PSALOC=PSAHOLD,PSALOCN=PSAHOLDN
"RTN","PSAHIS1",95,0)
 S PSAPC1="" F PSAPCS=1:1 S PSAPC=$P(PSAREA," ",PSAPCS) Q:PSAPC=""  D
"RTN","PSAHIS1",96,0)
 .I $L(PSAPC1)+$L(PSAPC)+1<27 S PSAPC1=PSAPC1_PSAPC_" " Q
"RTN","PSAHIS1",97,0)
 .I $L(PSAPC1)+$L(PSAPC)+1>26 W !?11,PSAPC1,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|" S PSAPC1=PSAPC_" "
"RTN","PSAHIS1",98,0)
 W:$L(PSAPC1) !?11,PSAPC1,?37,"|",?48,"|",?54,"|",?60,"|",?71,"|"
"RTN","PSAHIS1",99,0)
 Q
"RTN","PSAHIS1",100,0)
 ;
"RTN","PSAHIS1",101,0)
TRAN ;Prints transferred location w/o spliting words
"RTN","PSAHIS1",102,0)
 I $E(PSALOCN)="I" S PSAREA=PSAREA_"INPATIENT:"_$P($P(PSALOCN,":",2),"(IP)")
"RTN","PSAHIS1",103,0)
 I $E(PSALOCN)="O" S PSAREA=PSAREA_"OUTPATIENT:"_$P($P(PSALOCN,":",2),"(OP)")
"RTN","PSAHIS1",104,0)
 I $E(PSALOCN)="C" S PSAREA=PSAREA_"COMBINED:"_$P($P(PSALOCN,":",2),"(IP)")_"(IP)"_$P($P(PSALOCN,":",2),"(IP)",2)
"RTN","PSAHIS1",105,0)
 W !?11,$P(PSAREA,":")_":",?37,"|",?48,"|",?54,"|",?60,"|",?71,"|"
"RTN","PSAHIS1",106,0)
 S PSAREA=$P(PSAREA,": ",2)
"RTN","PSAHIS1",107,0)
 Q
"RTN","PSAHIS1",108,0)
 ;
"RTN","PSAHIS1",109,0)
TOTALS ;Prints totals
"RTN","PSAHIS1",110,0)
 W !?37,"|----------|-----|-----|----------|--------"
"RTN","PSAHIS1",111,0)
 W !?25,"DRUG TOTALS",?37,"|",?41,$J($G(PSARECT),6),?48,"|",$J($G(PSAIPT),5),?54,"|",$J($G(PSAOPT),5),?60,"|",?64,$J($G(PSADJT),6),?71,"|",!,PSADLN
"RTN","PSAHIS1",112,0)
 K PSADJT,PSAIPT,PSAOPT,PSARECT
"RTN","PSAHIS1",113,0)
 Q
"RTN","PSAOP")
0^14^B34810777
"RTN","PSAOP",1,0)
PSAOP ;BIR/LTL-Outpatient Dispensing (Single Drug) ;7/23/97
"RTN","PSAOP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAOP",3,0)
 ;This routine is the gathers OP dispensing for a date range.
"RTN","PSAOP",4,0)
 D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAOP",5,0)
 ;
"RTN","PSAOP",6,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSADR,PSADREC,PSADT,PSAPG,PSAS,PSA,PSAOUT,PSARELDT,PSADT,DA,PSADRUG,PSADRUGN,PSALN,PSAP,PSAN,PSAQ,PSAR,X,X2,Y
"RTN","PSAOP",7,0)
LOOK D:'$G(PSALOC) OP^PSADA
"RTN","PSAOP",8,0)
 I $G(PSALOC)<0 K PSALOC G QUIT
"RTN","PSAOP",9,0)
 S:'$G(PSALOCN) PSALOCN=$P($G(^PSD(58.8,+PSALOC,0)),U)
"RTN","PSAOP",10,0)
 S DIR(0)="Y",DIR("A")="OK",DIR("B")="Yes",DIR("?")="No allows you to change Location." D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) QUIT I Y=0 K PSALOC D OP^PSADA G:'$G(PSALOC) QUIT
"RTN","PSAOP",11,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN G QUIT
"RTN","PSAOP",12,0)
 D NOW^%DTC S PSADT=X,X="T-60" D ^%DT S PSADT(1)=Y
"RTN","PSAOP",13,0)
 S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="AEQ",DIC("A")="Please select "_PSALOCN_"'S drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)"
"RTN","PSAOP",14,0)
 S PSAS=$P($G(^PSD(58.8,+PSALOC,0)),U,10),PSADT(3)=0
"RTN","PSAOP",15,0)
 F  W ! S DA(1)=PSALOC D ^DIC G:Y<0 QUIT S PSADRUG=+Y D  G:$G(PSAOUT) QUIT G:$G(PSA(5)) TR D DEV Q:$G(PSAOUT)
"RTN","PSAOP",16,0)
 .D:'$G(^PSD(58.8,+PSALOC,1,+PSADRUG,6))  Q:$G(PSAOUT)
"RTN","PSAOP",17,0)
 ..W !!,"Dispensing has never been collected for this drug.",!!
"RTN","PSAOP",18,0)
 ..S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-60"  D ^DIR K DIR S (PSADT(2),PSADT(4),PSAR,PSAP,PSAN)=Y,(PSADT(3),PSAR(1),PSAP(1),PSAN(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAOP",19,0)
 .S PSAG=$G(^PSD(58.8,+PSALOC,1,+PSADRUG,6))
"RTN","PSAOP",20,0)
 .S:'$G(PSADT(2)) PSADT(2)=$P(PSAG,U),PSA(7)=1
"RTN","PSAOP",21,0)
 .W !!,"Checking dispensing"
"RTN","PSAOP",22,0)
 .S:'$G(PSAR) PSAR=$P(PSAG,U,2) S:'$G(PSAP) PSAP=$P(PSAG,U,7)
"RTN","PSAOP",23,0)
 .S:'$G(PSAN) PSAN=$P(PSAG,U,9) S (PSAR(1),PSAP(1),PSAN(1))=0
"RTN","PSAOP",24,0)
 .F  S PSADT(2)=$O(^PSRX("AL",PSADT(2))) Q:'PSADT(2)  F  S PSADT(3)=$O(^PSRX("AL",+PSADT(2),PSADT(3))) Q:'PSADT(3)  W:'(PSADT(3)#10) "." D:$P($G(^PSRX(+PSADT(3),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSADT(3),2)),U,9)=PSAS)
"RTN","PSAOP",25,0)
 ..S PSADT(4)="" F  S PSADT(4)=$O(^PSRX("AL",+PSADT(2),+PSADT(3),PSADT(4))) Q:PSADT(4)=""  D
"RTN","PSAOP",26,0)
 ...;
"RTN","PSAOP",27,0)
 ...;DAVE B (PSA*3*3)
"RTN","PSAOP",28,0)
 ...Q:$D(^PSRX("AR",+PSADT(2),+PSADT(3),PSADT(4)))  ;Released to CMOP, do not count
"RTN","PSAOP",29,0)
 ...S ^TMP("PSA",$J,+PSADRUG,$E(PSADT(2),1,7))=($P($G(^TMP("PSA",$J,+PSADRUG,$E(PSADT(2),1,7))),U)+$S(PSADT(4):$P($G(^PSRX(+PSADT(3),1,+PSADT(4),0)),U,4),1:$P($G(^PSRX(+PSADT(3),0)),U,7)))_U_PSADT(2)_U_PSADT(3),PSA(9)=PSADT(3)
"RTN","PSAOP",30,0)
 .W !!,"Checking refills"
"RTN","PSAOP",31,0)
 .D:$O(^PSRX("AJ",PSAR))
"RTN","PSAOP",32,0)
 ..F  S PSAR=$O(^PSRX("AJ",PSAR)) Q:'PSAR  F  S PSAR(1)=$O(^PSRX("AJ",+PSAR,+PSAR(1))) Q:'PSAR(1)  W "." D:$P($G(^PSRX(+PSAR(1),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSAR(1),2)),U,9)=PSAS)
"RTN","PSAOP",33,0)
 ...S PSAR(3)="" F  S PSAR(3)=$O(^PSRX("AJ",+PSAR,+PSAR(1),PSAR(3))) Q:PSAR(3)=""  D
"RTN","PSAOP",34,0)
 ....S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAR,1,7)),U)=($P($G(^TMP("PSA",$J,+PSADRUG,$E(PSAR,1,7))),U)-$S(PSAR(3):$P($G(^PSRX(+PSAR(1),1,+PSAR(3),0)),U,4),1:$P($G(^PSRX(+PSAR(1),0)),U,7)))
"RTN","PSAOP",35,0)
 ....S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAR,1,7)),U,4)=PSAR,$P(^($E(PSAR,1,7)),U,5)=PSAR(1),PSAR(2)=PSAR(1)
"RTN","PSAOP",36,0)
 .D:$O(^PSRX("AM",+PSAP))!($O(^PSRX("AN",+PSAN))) AM^PSAOP4
"RTN","PSAOP",37,0)
 .I '$D(^TMP("PSA",$J,+PSADRUG)) W !!,"Sorry, no dispensing for this drug has occurred since " S Y=$S($P(PSAG,U):$P(PSAG,U),1:$G(PSADT(4))) X ^DD("DD") W Y,".",! S PSAOUT=1 Q
"RTN","PSAOP",38,0)
 .S DIR(0)="Y",DIR("A")="Would you like a report of dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 S:Y'=1 PSA(5)=1
"RTN","PSAOP",39,0)
 ;
"RTN","PSAOP",40,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="0Q" I Y=1 W ! D ^%ZIS
"RTN","PSAOP",41,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G QUIT
"RTN","PSAOP",42,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAOP",ZTDESC="Drug Acct-OP Dispensing Log",(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS G QUIT
"RTN","PSAOP",43,0)
LUP S (PSAPG,PSAOUT)=0,PSADRUG(1)=$P($G(^PSDRUG(+PSADRUG,660)),U,6),PSADRUG(2)=$P($G(^(660)),U,8)
"RTN","PSAOP",44,0)
 S X=PSADRUG(1),X2="3$" D COMMA^%DTC S PSADRUG(3)=X
"RTN","PSAOP",45,0)
 D HEADER
"RTN","PSAOP",46,0)
 S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,+PSADRUG,PSA(4))) Q:'PSA(4)  S PSA(6)=PSA(6)+1,Y=PSA(4) X ^DD("DD") D
"RTN","PSAOP",47,0)
 .W !!,Y S X=$P($G(^TMP("PSA",$J,+PSADRUG,PSA(4))),U),X2=0 D COMMA^%DTC W ?14,X,PSADRUG(2),?40,PSADRUG(3),"/",PSADRUG(2),?63
"RTN","PSAOP",48,0)
 .S PSADRUG(4)=$G(PSADRUG(4))+$P($G(^TMP("PSA",$J,+PSADRUG,PSA(4))),U)
"RTN","PSAOP",49,0)
 .S X=$P($G(^TMP("PSA",$J,+PSADRUG,PSA(4))),U)*PSADRUG(1),PSADRUG(5)=$G(PSADRUG(5))+X,X2="2$" D COMMA^%DTC W ?40,X
"RTN","PSAOP",50,0)
 W !,PSALN,!,PSA(6)," DAY TOTALS: " S X=PSADRUG(4),X2=0 D COMMA^%DTC W ?5,X,PSADRUG(2)
"RTN","PSAOP",51,0)
 S X=PSADRUG(5),X2="2$" D COMMA^%DTC W ?63,X
"RTN","PSAOP",52,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAOP",53,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSAOP",54,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAOP",55,0)
 W !!,"Updating history and dispensing totals."
"RTN","PSAOP",56,0)
TR S ZTIO="",ZTRTN="LOOP^PSAOP",ZTDESC="Drug Acct-Dispensing Totals",ZTDTH=$H,(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAOP",57,0)
 K ^TMP("PSA",$J,+PSADRUG),PSA,PSADRUG
"RTN","PSAOP",58,0)
QUIT Q
"RTN","PSAOP",59,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAOP",60,0)
 I $$S^%ZTLOAD S PSAOUT=1 Q
"RTN","PSAOP",61,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,?2,"DAILY DISPENSING TOTALS FOR ",$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAOP",62,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!
"RTN","PSAOP",63,0)
 W "DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAOP",64,0)
 Q
"RTN","PSAOP",65,0)
LOOP S PSA(2)=0 F  S PSA(2)=$O(^TMP("PSA",$J,+PSADRUG,PSA(2))) Q:'PSA(2)  S PSA(3)=$P(^TMP("PSA",$J,+PSADRUG,PSA(2)),"^") D
"RTN","PSAOP",66,0)
 .S PSA=^TMP("PSA",$J,+PSADRUG,PSA(2)),PSAOP=+$P($G(^PSD(58.8,PSALOC,0)),"^",10),PSARELDT=+$P(PSA(2),".")
"RTN","PSAOP",67,0)
 .K:$D(^XTMP("PSA",PSAOP,PSADRUG,PSARELDT)) ^XTMP("PSA",PSAOP,PSADRUG,PSARELDT)
"RTN","PSAOP",68,0)
 .D ^PSAOP1
"RTN","PSAOP",69,0)
 .S DIE="^PSD(58.8,"_+PSALOC_",1,",DA(1)=PSALOC,DA=PSADRUG
"RTN","PSAOP",70,0)
 .S DR="22////"_$P(PSA,U,2)_";22.1////"_$P(PSA,U,3)_";23////"_$P(PSA,U,4)_";23.1////"_$P(PSA,U,5)_";22.2////"_$P(PSA,U,6)_";22.3////"_$P(PSA,U,7)_";23.2////"_$P(PSA,U,8)_";23.3////"_$P(PSA,U,9)
"RTN","PSAOP",71,0)
 .D ^DIE K DA,DIE,DR
"RTN","PSAOP",72,0)
 Q
"RTN","PSAOP2")
0^15^B32264389
"RTN","PSAOP2",1,0)
PSAOP2 ;BIR/LTL-Outpatient Dispensing (All Drugs) ;7/23/97
"RTN","PSAOP2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAOP2",3,0)
 ;This routine gathers outpatient dispensing for all drugs in a location
"RTN","PSAOP2",4,0)
 ;from the PRESCRIPTION file. If present, the last outpatient dispensing
"RTN","PSAOP2",5,0)
 ;date is used as a starting point. Otherwise the user selected date is
"RTN","PSAOP2",6,0)
 ;used.
"RTN","PSAOP2",7,0)
 ;
"RTN","PSAOP2",8,0)
 D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAOP2",9,0)
 D Q
"RTN","PSAOP2",10,0)
 S $P(PSALN,"-",79)="-"
"RTN","PSAOP2",11,0)
LOOK D OP^PSADA
"RTN","PSAOP2",12,0)
 G:'$G(PSALOC) Q W !,$G(PSALOCN)
"RTN","PSAOP2",13,0)
 S DIR(0)="Y",DIR("A")="OK",DIR("B")="Yes",DIR("?")="Answering no will allow you to change Location." D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) Q I Y=0 K PSALOC D OP^PSADA G:'$G(PSALOC) Q
"RTN","PSAOP2",14,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G Q
"RTN","PSAOP2",15,0)
 D NOW^%DTC S PSADT=X,X="T-60" D ^%DT S PSADT(1)=Y,(PSAPG,PSAOUT,PSADRUG)=0
"RTN","PSAOP2",16,0)
 S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-60"  D ^DIR K DIR S (PSADT(2),PSADT(22),PSAR,PSAP,PSAN)=Y,(PSADT(3),PSAR(1),PSAP(1),PSAN(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAOP2",17,0)
 S (PSAOP,PSAS)=$P($G(^PSD(58.8,+PSALOC,0)),U,10)
"RTN","PSAOP2",18,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) STOP
"RTN","PSAOP2",19,0)
 I Y=1 S PSADAILY=1
"RTN","PSAOP2",20,0)
DEV K IO("Q") K %ZIS,IOP,POP S %ZIS="0Q" I Y=1 W ! D ^%ZIS
"RTN","PSAOP2",21,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G Q
"RTN","PSAOP2",22,0)
 I $D(IO("Q")) K ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAOP2",ZTDESC="Drug Acct-Daily Drug Dispensing Log",ZTSAVE("PSA*")="" D ^%ZTLOAD G Q
"RTN","PSAOP2",23,0)
 ;
"RTN","PSAOP2",24,0)
LUP ;Starting point
"RTN","PSAOP2",25,0)
 S PSADRUG=0 W @IOF
"RTN","PSAOP2",26,0)
PROCESS F PSAHOW="AL","AJ","AM","AN" S PSADT=PSADT(22)-.00001 D LOOP
"RTN","PSAOP2",27,0)
 G DONE
"RTN","PSAOP2",28,0)
 ;
"RTN","PSAOP2",29,0)
LOOP ;
"RTN","PSAOP2",30,0)
 I $E(IOST)="C" W !,"Processing ",$S(PSAHOW="AL":"dispensing",PSAHOW="AJ":"returns",PSAHOW="AM":"partials",1:"returns")
"RTN","PSAOP2",31,0)
 ;
"RTN","PSAOP2",32,0)
1 S PSADT=$O(^PSRX(PSAHOW,PSADT)) Q:PSADT'>0  K PSAIEN
"RTN","PSAOP2",33,0)
2 S PSAIEN=$S('$D(PSAIEN):$O(^PSRX(PSAHOW,PSADT,0)),1:$O(^PSRX(PSAHOW,PSADT,PSAIEN))) G 1:PSAIEN'>0 K PSARX
"RTN","PSAOP2",34,0)
3 S PSARX=$S('$D(PSARX):$O(^PSRX(PSAHOW,PSADT,PSAIEN,"")),1:$O(^PSRX(PSAHOW,PSADT,PSAIEN,PSARX))) G 2:PSARX="" W "."
"RTN","PSAOP2",35,0)
 I $D(^PSRX("AR",PSADT,PSAIEN,PSARX)) G 3
"RTN","PSAOP2",36,0)
 S PSADRUG=$P($G(^PSRX(PSAIEN,0)),"^",6) I $G(PSADRUG)="" G 3
"RTN","PSAOP2",37,0)
 S PSADRUGN=$P($G(^PSDRUG(PSADRUG,0)),"^")
"RTN","PSAOP2",38,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRUG)) G 3
"RTN","PSAOP2",39,0)
 I $P($G(^PSRX(PSAIEN,2)),"^",9)'=PSAS G 3
"RTN","PSAOP2",40,0)
 ;
"RTN","PSAOP2",41,0)
 S PSAQTY=$S(+PSARX:$P($G(^PSRX(PSAIEN,1,PSARX,0)),"^",4),1:$P($G(^PSRX(PSAIEN,0)),"^",7)) ;either refill or fill
"RTN","PSAOP2",42,0)
 ;
"RTN","PSAOP2",43,0)
 I '$D(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))) S ^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))=""
"RTN","PSAOP2",44,0)
 S DATA=^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))
"RTN","PSAOP2",45,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",1)=$S(PSAHOW="AL":$P(DATA,"^")+PSAQTY,PSAHOW="AJ":$P(DATA,"^")-PSAQTY,PSAHOW="AM":$P(DATA,"^")+$P($G(^PSRX(PSAIEN,"P",PSARX,0)),"^",4),1:$P(DATA,"^")-$P($G(^PSRX(PSAIEN,"P",PSARX,0)),"^",4))
"RTN","PSAOP2",46,0)
 ;
"RTN","PSAOP2",47,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",$S(PSAHOW="AL":2,PSAHOW="AJ":4,PSAHOW="AM":6,1:8))=PSAIEN
"RTN","PSAOP2",48,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",$S(PSAHOW="AL":3,PSAHOW="AJ":5,PSAHOW="AM":7,1:9))=PSARX
"RTN","PSAOP2",49,0)
 G 3
"RTN","PSAOP2",50,0)
 ;
"RTN","PSAOP2",51,0)
DONE ;All dispensing data retrieved, print it.
"RTN","PSAOP2",52,0)
 D HEADER
"RTN","PSAOP2",53,0)
 S XX=0 F  S XX=$O(^PSD(58.88,PSALOC,1,XX)) Q:XX'>0  S XXX=$P($G(^PSDRUG,XX),"^") I '$D(^TMP("PSA",$J,XXX)) S ^TMP("PSA",$J,XXX)=0
"RTN","PSAOP2",54,0)
 S PSADRUGN=0
"RTN","PSAOP2",55,0)
4 S PSADRUGN=$O(^TMP("PSA",$J,PSADRUGN)) G STOP:PSADRUGN=""
"RTN","PSAOP2",56,0)
 S PSADRUG=$O(^PSDRUG("B",PSADRUGN,0))
"RTN","PSAOP2",57,0)
 I $Y>(IOSL+4) D HEADER G Q:$G(PSAOUT)=1
"RTN","PSAOP2",58,0)
 I '$D(^TMP("PSA",$J,PSADRUGN)) W !,PSADRUGN,?36,"has not been dispensed since: " S Y=$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,6)),"^"):$P(^PSD(58.8,PSALOC,1,PSADRUG,6),"^"),1:PSADT(22)) X ^DD("DD") W Y,"." G 4
"RTN","PSAOP2",59,0)
 W !,PSADRUGN
"RTN","PSAOP2",60,0)
 K PNTDATA,PSADATE,PSATTLP,DAYS
"RTN","PSAOP2",61,0)
5 S PSADATE=$S('$D(PSADATE):$O(^TMP("PSA",$J,PSADRUGN,0)),1:$O(^TMP("PSA",$J,PSADRUGN,PSADATE))) G PNTQ:PSADATE'>0 S DATA=^TMP("PSA",$J,PSADRUGN,PSADATE) S DAYS=$G(DAYS)+1
"RTN","PSAOP2",62,0)
 S Y=PSADATE X ^DD("DD") S PRINTDT=Y
"RTN","PSAOP2",63,0)
 S PSAQTY=$P(DATA,"^")
"RTN","PSAOP2",64,0)
 ;
"RTN","PSAOP2",65,0)
 S PSAPRICE=$P($G(^PSDRUG(PSADRUG,660)),"^",6) ;Price per dispense Unit
"RTN","PSAOP2",66,0)
 S PSADISPU=$P($G(^PSDRUG(PSADRUG,660)),"^",8) ;Dispense Unit
"RTN","PSAOP2",67,0)
 ;
"RTN","PSAOP2",68,0)
 S Y=PSAQTY,X2=0 D COMMA^%DTC S PNTQTY=Y
"RTN","PSAOP2",69,0)
 S TTLQTY=$G(TTLQTY)+PSAQTY ;total quantity
"RTN","PSAOP2",70,0)
 S PSAPRICE(2)=$G(PSAPRICE(2))+(PSAPRICE*PSAQTY) ;Total Cost
"RTN","PSAOP2",71,0)
 S Y=PSAPRICE,X2="3$" D COMMA^%DTC S PNTPRICE=Y
"RTN","PSAOP2",72,0)
 S Y=PSAPRICE*PSAQTY,X2="3$" D COMMA^%DTC S PSAQP=Y
"RTN","PSAOP2",73,0)
 I $D(PSADAILY) W !,$G(DAYS),?3,PRINTDT,?23,PNTQTY,?40,PNTPRICE,"/",PSADISPU,?63,PSAQP K PSAQP G 5
"RTN","PSAOP2",74,0)
 G 5
"RTN","PSAOP2",75,0)
 ;
"RTN","PSAOP2",76,0)
PNTQ W !,PSALN,!,DAYS," DAY TOTALS: " S Y=TTLQTY,X2="2$" D COMMA^%DTC W Y S Y=PSAPRICE(2),X2="2$" D COMMA^%DTC W ?63,Y
"RTN","PSAOP2",77,0)
 K TTLQTY,PSAPRICE,PSAQTY,PNTQTY
"RTN","PSAOP2",78,0)
 G 4
"RTN","PSAOP2",79,0)
 ;
"RTN","PSAOP2",80,0)
HEADER I $E(IOST,1,2)'="P-",$G(PSAPG) S DIR(0)="E" D ^DIR K DIR I '+Y S PSAOUT=1 Q
"RTN","PSAOP2",81,0)
 I $$S^%ZTLOAD S PSAOUT=1 Q
"RTN","PSAOP2",82,0)
 W:$Y @IOF S PSAPG=$G(PSAPG)+1 W ?2,"DAILY DISPENSING TOTALS FOR ",$E($G(PSALOCN),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAOP2",83,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!," DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAOP2",84,0)
 Q
"RTN","PSAOP2",85,0)
Q D ^%ZISC K PNTDATA,PNTDATE,PNTPRICE,PNTQTY,POP,PRINTDT,PSA,PSADAILY,PSADATE,PDADISPU,PSADR,PSADREC,PSADRUG,PSACNT,PSAPG,PSAOSIT
"RTN","PSAOP2",86,0)
 K PSADRUGN,PSADT,PSAG,PSAHOW,PSAIEN,PSALN,PSALOC,PSALOCN,PSAN,PSAOP,PSAOUT,PSAP,PSAPRICE,PSAQ,PSAQTY,PSAR,PSAREC,PSARELDT,PSARX,PSAS,PSAT,PSATTLP,TTLQTY,^TMP("PSA",$J),^TMP($J)
"RTN","PSAOP2",87,0)
 Q
"RTN","PSAOP2",88,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAOP2",89,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAOP2",90,0)
 I $O(^TMP("PSA",$J,0)) D ^PSAOP4
"RTN","PSAOP2",91,0)
 G Q
"RTN","PSAOP4")
0^16^B6478536
"RTN","PSAOP4",1,0)
PSAOP4 ;BIR/LTL-Outpatient Dispensing (Single Drug) & (All Drugs) - CONT'D ;7/23/97
"RTN","PSAOP4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAOP4",3,0)
 ;This routine gathers outpatient dispensing and is called by PSAOP2.
"RTN","PSAOP4",4,0)
 ;
"RTN","PSAOP4",5,0)
 N PSADRUGN S PSADRUGN=0
"RTN","PSAOP4",6,0)
 F  S PSADRUGN=$O(^TMP("PSA",$J,PSADRUGN)),PSADRUG=$O(^PSDRUG("B",PSADRUGN,0)) Q:'PSADRUGN  D
"RTN","PSAOP4",7,0)
 .S PSA(2)=0 F  S PSA(2)=$O(^TMP("PSA",$J,PSADRUGN,PSA(2))) Q:'PSA(2)  D
"RTN","PSAOP4",8,0)
 ..S PSA(3)=+^TMP("PSA",$J,PSADRUGN,PSA(2)) D TMP^PSAOP1
"RTN","PSAOP4",9,0)
 ..K:$D(^XTMP("PSA",PSAS,PSADRUGN)) ^XTMP("PSA",PSAS,PSADRUGN)
"RTN","PSAOP4",10,0)
QUIT K ^TMP("PSA",$J) S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAOP4",11,0)
 Q
"RTN","PSAOP4",12,0)
 ;
"RTN","PSAOP4",13,0)
AM ;Collects partial fills released & returned to stock.
"RTN","PSAOP4",14,0)
 F  S PSAP=$O(^PSRX("AM",PSAP)) Q:'PSAP  F  S PSAP(1)=$O(^PSRX("AM",+PSAP,PSAP(1))) Q:'PSAP(1)  D:$P($G(^PSRX(+PSAP(1),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSAP(1),2)),U,9)=PSAS)
"RTN","PSAOP4",15,0)
 .S PSAP(2)="" F  S PSAP(2)=$O(^PSRX("AM",+PSAP,+PSAP(1),PSAP(2))) Q:'PSAP(2)  S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAP,1,7)),U)=$P($G(^TMP("PSA",$J,+PSADRUG,$E(PSAP,1,7))),U)+$P($G(^PSRX(+PSAP(1),"P",+PSAP(2),0)),U,4) D
"RTN","PSAOP4",16,0)
 ..S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAP,1,7)),U,6)=PSAP,$P(^($E(PSAP,1,7)),U,7)=PSAP(1)
"RTN","PSAOP4",17,0)
 F  S PSAN=$O(^PSRX("AN",PSAN)) Q:'PSAN  F  S PSAN(1)=$O(^PSRX("AN",+PSAN,PSAN(1))) Q:'PSAN(1)  D:$P($G(^PSRX(+PSAN(1),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSAN(1),2)),U,0)=PSAS)
"RTN","PSAOP4",18,0)
 .S PSAN(2)="" F  S PSAN(2)=$O(^PSRX("AN",+PSAN,+PSAN(1),PSAN(2))) Q:'PSAN(2)  S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAN,1,7)),U)=$P($G(^($E(PSAN,1,7))),U)-$P($G(^PSRX(+PSAN(1),"P",+PSAN(2),0)),U,4) D
"RTN","PSAOP4",19,0)
 ..S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAN,1,7)),U,8)=PSAN,$P(^($E(PSAN,1,7)),U,9)=PSAN(1)
"RTN","PSAOP4",20,0)
 Q
"RTN","PSAORDP1")
0^21^B71007671
"RTN","PSAORDP1",1,0)
PSAORDP1 ;BIR/JMB-Print Orders - CONT'D ;9/19/97
"RTN","PSAORDP1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAORDP1",3,0)
 ;This routine prints invoices.
"RTN","PSAORDP1",4,0)
 ;
"RTN","PSAORDP1",5,0)
DQ S IOM=80 D NOW^%DTC S Y=% D DD^%DT S PSARUN=$E(Y,1,18),PSAPAGE=1,$P(PSASLN,"-",80)="",$P(PSADLN,"=",80)="",(PSADJDRG,PSAOUT)=0,PSAFPG=1
"RTN","PSAORDP1",6,0)
 S PSAEND=0,PSAORDER=$P(^PSD(58.811,PSAORD,0),"^") D HEADER^PSAORDP2
"RTN","PSAORDP1",7,0)
 S PSAIN=$G(^PSD(58.811,PSAORD,1,PSAINV,0)),PSAINVN=$P(PSAIN,"^"),PSASTA=$P(PSAIN,"^",3),PSADEL=+$P(PSAIN,"^",6),PSAREC=+$P(PSAIN,"^",7)
"RTN","PSAORDP1",8,0)
START W !,"PRIME VENDOR : ",$S($P($G(^PSD(58.811,PSAORD,0)),"^",2)'="":$P($G(^(0)),"^",2),1:"UNKNOWN")
"RTN","PSAORDP1",9,0)
 W !!,"ORDER#  : "_PSAORDER,?40,"ORDER DATE   : "_$$DATE($P(PSAIN,"^",4))
"RTN","PSAORDP1",10,0)
 W !,"INVOICE#: "_PSAINVN,?40,"INVOICE DATE : "_$$DATE($P(PSAIN,"^",2))
"RTN","PSAORDP1",11,0)
 W !,"STATUS  : "_$S(PSASTA="P":"PROCESSED",PSASTA="V":"VERIFIED",PSASTA="C":"COMPLETED",1:"UNKNOWN")_$S(+$P(PSAIN,"^",13):" (SUPPLY INVOICE)",1:"")
"RTN","PSAORDP1",12,0)
 W ?40,"DELIVERY DATE: "_$S(PSADEL:$$DATE(PSADEL),1:"UNKNOWN")
"RTN","PSAORDP1",13,0)
 W !?40,"DATE RECEIVED: "_$S(PSAREC:$$DATE(PSAREC),PSADEL:$$DATE(PSADEL),1:"UNKNOWN"),!
"RTN","PSAORDP1",14,0)
 S PSADJDRG=0 S (PSAIECST,PSAAECST)=0 D LINE
"RTN","PSAORDP1",15,0)
 ;
"RTN","PSAORDP1",16,0)
EXIT ;Kills 
"RTN","PSAORDP1",17,0)
 K %,DIR,DIRUT,PSAAECST,PSACIEN,PSADATA,PSADATE,PSADEC,PSADEL,PSADJ,PSADJD,PSADJDP,PSADJDRG,PSADJSUP,PSADJDV,PSADPDT,PSADPDUZ,PSADVDT,PSADVDUZ,PSADJO,PSADJOP,PSADJOV
"RTN","PSAORDP1",18,0)
 K PSADJP,PSADJPP,PSADJPV,PSADJQ,PSADJQP,PSADJQV,PSADLN,PSADRG,PSAECOST,PSAEND,PSAFPG,PSAICOST,PSAIECST,PSAIN,PSAINVN
"RTN","PSAORDP1",19,0)
 K PSALN,PSAMORE,PSANDC,PSANODE,PSAOPDT,PSAOPDUZ,PSAORDER,PSAOU,PSAOVDT,PSAOVDUZ,PSAPAGE,PSAPPDT,PSAPPDUZ,PSAPRICE
"RTN","PSAORDP1",20,0)
 K PSAPVDT,PSAPVDUZ,PSAQPDT,PSAQPDUZ,PSAQPREA,PSAQVDT,PSAQVDUZ,PSAQVREA,PSAREC,PSARUN,PSAS,PSASLN,PSASS,PSASTA,PSATOT,Y
"RTN","PSAORDP1",21,0)
 Q
"RTN","PSAORDP1",22,0)
 ;
"RTN","PSAORDP1",23,0)
DATE(PSADATE)         ;convert date
"RTN","PSAORDP1",24,0)
 S %=$E(PSADATE,4,5)_"/"_$E(PSADATE,6,7)_"/"_$E(PSADATE,2,3)
"RTN","PSAORDP1",25,0)
 I $TR(%,"/")="" S %="UNKNOWN"
"RTN","PSAORDP1",26,0)
 Q %
"RTN","PSAORDP1",27,0)
 ;
"RTN","PSAORDP1",28,0)
LINE ;print line items
"RTN","PSAORDP1",29,0)
 D LINEHDR^PSAORDP2 S (PSAICOST,PSALN,PSATOT)=0
"RTN","PSAORDP1",30,0)
 F  S PSALN=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN)) Q:'PSALN!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAORDP1",31,0)
 .Q:'$D(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,0))
"RTN","PSAORDP1",32,0)
 .S PSADATA=^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,0)
"RTN","PSAORDP1",33,0)
 .K PSADJQP,PSAQPDUZ,PSAQPDT,PSAQPREA,PSADJQV,PSAQVDUZ,PSAQVDT,PSAQVREA
"RTN","PSAORDP1",34,0)
 .K PSADJOP,PSAOPDUZ,PSAOPDT,PSADJOV,PSAOVDUZ,PSAOVDT
"RTN","PSAORDP1",35,0)
 .K PSADJPP,PSAPPDUZ,PSAPPDT,PSADJPV,PSAPVDUZ,PSAPVDT
"RTN","PSAORDP1",36,0)
 .K PSADJDP,PSADPDUZ,PSADPDT,PSADJDV,PSADVDUZ,PSADVDT
"RTN","PSAORDP1",37,0)
 .S PSADJSUP=0
"RTN","PSAORDP1",38,0)
 .I $D(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)) S PSAMORE=4 D
"RTN","PSAORDP1",39,0)
 ..S:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^") PSAMORE=5
"RTN","PSAORDP1",40,0)
 ..S:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",2) PSAMORE=PSAMORE+1
"RTN","PSAORDP1",41,0)
 .E  S PSAMORE=4
"RTN","PSAORDP1",42,0)
 .I ($Y+PSAMORE)>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2,LINEHDR^PSAORDP2
"RTN","PSAORDP1",43,0)
 .W !,$P(PSADATA,"^")
"RTN","PSAORDP1",44,0)
DRUG .S PSADRG=0,PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","D",0))
"RTN","PSAORDP1",45,0)
 .I $G(PSADJ) D
"RTN","PSAORDP1",46,0)
 ..S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0))
"RTN","PSAORDP1",47,0)
 ..S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAORDP1",48,0)
 ..I $G(PSADJD),$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" D  Q
"RTN","PSAORDP1",49,0)
 ...W ?8,"*"_$P($G(^PSDRUG(+PSADJD,0)),"^") S PSADJDRG=1,PSADRG=PSADJD
"RTN","PSAORDP1",50,0)
 ...I $P(PSANODE,"^",6)'="" S PSADJDV=$P(PSANODE,"^",6),PSADVDT=$P(PSANODE,"^",8),PSADVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",51,0)
 ...I $P(PSANODE,"^",2)'="" S PSADJDP=$P(PSANODE,"^",2),PSADPDT=$P(PSANODE,"^",4),PSADPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",52,0)
 ..I $G(PSADJD),$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S PSADJ=0 Q
"RTN","PSAORDP1",53,0)
 ..W ?7,"**"_PSADJD S PSADJSUP=1,PSADRG=0
"RTN","PSAORDP1",54,0)
 ..I $P(PSANODE,"^",6)'="" S PSADJDV=$P(PSANODE,"^",6),PSADVDT=$P(PSANODE,"^",8),PSADVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",55,0)
 ..I $P(PSANODE,"^",2)'="" S PSADJDP=$P(PSANODE,"^",2),PSADPDT=$P(PSANODE,"^",4),PSADPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",56,0)
 .I '$G(PSADJ) D
"RTN","PSAORDP1",57,0)
 ..S PSADRG=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAORDP1",58,0)
 ..W ?9,$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):$P(^PSDRUG(+$P(PSADATA,"^",2),0),"^"),1:"DRUG UNKNOWN")
"RTN","PSAORDP1",59,0)
CS .I +$P(PSADATA,"^",10) W " (CONTROLLED SUBS)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !?5,"*** INACTIVE IN MASTER VAULT ***"
"RTN","PSAORDP1",60,0)
 .E  I PSADRG,$P($G(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !?5,"*** INACTIVE IN PHARMACY LOCATION ***"
"RTN","PSAORDP1",61,0)
 .I PSADRG,$D(^PSDRUG(+PSADRG,"I")) W !?5,"*** INACTIVE IN DRUG FILE ***"
"RTN","PSAORDP1",62,0)
 .;
"RTN","PSAORDP1",63,0)
UPC .W:$P(PSADATA,"^",13)'="" !?9,"UPC: "_$P(PSADATA,"^",13)
"RTN","PSAORDP1",64,0)
NDC .S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAORDP1",65,0)
 .I $E(PSANDC)'="S" W !?9,$S(PSANDC'=""&(PSANDC?12N):$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12),1:"NDC UNKNOWN")
"RTN","PSAORDP1",66,0)
 .S PSASUB=$S(+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^",3):+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^",3),+$O(^PSDRUG("C",PSANDC,+PSADRG,0)):+$O(^PSDRUG("C",PSANDC,+PSADRG,0)),1:0)
"RTN","PSAORDP1",67,0)
 .;
"RTN","PSAORDP1",68,0)
VSN .W ?25,$S($P(PSADATA,"^",12)'="":$P(PSADATA,"^",12),1:"VSN UNKNOWN")
"RTN","PSAORDP1",69,0)
 .;
"RTN","PSAORDP1",70,0)
QTY .;No Adj. Qty
"RTN","PSAORDP1",71,0)
 .S PSAIECST=PSAIECST+($P(PSADATA,"^",3)*$P(PSADATA,"^",5))
"RTN","PSAORDP1",72,0)
 .S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","P",0))
"RTN","PSAORDP1",73,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSAPRICE=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAORDP1",74,0)
 .I '$G(PSADJ) S PSAPRICE=$P(PSADATA,"^",5)
"RTN","PSAORDP1",75,0)
 .S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","Q",0))
"RTN","PSAORDP1",76,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAORDP1",77,0)
 .;Adj. Qty
"RTN","PSAORDP1",78,0)
 .I $G(PSADJQ) D
"RTN","PSAORDP1",79,0)
 ..I $P(PSANODE,"^",6)'="" S PSADJQV=$P(PSANODE,"^",6),PSAQVREA=$P(PSANODE,"^",7),PSAQVDT=$P(PSANODE,"^",8),PSAQVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",80,0)
 ..I $P(PSANODE,"^",2)'="" S PSADJQP=$P(PSANODE,"^",2),PSAQPREA=$P(PSANODE,"^",3),PSAQPDT=$P(PSANODE,"^",4),PSAQPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",81,0)
 ..S PSAECOST=PSADJQ*PSAPRICE,PSAAECST=PSAAECST+PSAECOST
"RTN","PSAORDP1",82,0)
 ..W ?40,$S($G(PSADJQV)'="":$J(PSADJQV,6),1:$J(PSADJQP,6))_"("_$P(PSADATA,"^",3)_")"
"RTN","PSAORDP1",83,0)
 .I '$G(PSADJQ) W ?40,$J($P(PSADATA,"^",3),6) S PSAECOST=$P(PSADATA,"^",3)*PSAPRICE,PSAAECST=PSAAECST+PSAECOST
"RTN","PSAORDP1",84,0)
 .;
"RTN","PSAORDP1",85,0)
OU .;Order Unit
"RTN","PSAORDP1",86,0)
 .S PSAOU=$S(+$P(PSADATA,"^",4):$P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^"),+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",5)):$P($G(^DIC(51.5,+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",5),0)),"^"),1:"")
"RTN","PSAORDP1",87,0)
 .S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","O",0))
"RTN","PSAORDP1",88,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAORDP1",89,0)
 .;Adj. Order Unit
"RTN","PSAORDP1",90,0)
 .I PSADJO'="" D
"RTN","PSAORDP1",91,0)
 ..I $P(PSANODE,"^",6)'="" S PSADJOV=$P(PSANODE,"^",6),PSAOVDT=$P(PSANODE,"^",8),PSAOVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",92,0)
 ..I $P(PSANODE,"^",2)'="" S PSADJOP=$P(PSANODE,"^",2),PSAOPDT=$P(PSANODE,"^",4),PSAOPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",93,0)
 ..W ?53,$S(+PSADJO:$P($G(^DIC(51.5,+PSADJO,0)),"^"),1:"UNKNOWN")_" ("_$S(PSAOU'="":PSAOU,1:"")_")"
"RTN","PSAORDP1",94,0)
 .I PSADJO="" W ?53,$S(PSAOU'="":PSAOU,1:"()")
"RTN","PSAORDP1",95,0)
 .;
"RTN","PSAORDP1",96,0)
PRICE .;Unit price
"RTN","PSAORDP1",97,0)
 .S PSADEC=$S($L($P($P(PSADATA,"^",5),".",2))>1:$L($P($P(PSADATA,"^",5),".",2)),1:2)
"RTN","PSAORDP1",98,0)
 .S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","P",0))
"RTN","PSAORDP1",99,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAORDP1",100,0)
 .;Adj. Unit Price
"RTN","PSAORDP1",101,0)
 .I $G(PSADJP) D
"RTN","PSAORDP1",102,0)
 ..I +$P(PSANODE,"^",6) S PSADJPV=$P(PSANODE,"^",6),PSAPVDT=$P(PSANODE,"^",8),PSAPVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",103,0)
 ..I +$P(PSANODE,"^",2) S PSADJPP=$P(PSANODE,"^",2),PSAPPDT=$P(PSANODE,"^",4),PSAPPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",104,0)
 ..W ?60,$J(PSADJP,7,2)_" ("_$S(+$P(PSADATA,"^",5):$P(PSADATA,"^",5),$P(PSADATA,"^",5)=0:0,1:"")_")"
"RTN","PSAORDP1",105,0)
 .I '$G(PSADJP) D
"RTN","PSAORDP1",106,0)
 ..I +$P(PSADATA,"^",5)!($P(PSADATA,"^",5)=0) W ?60,$S(+$P(PSADATA,"^",5):$J($P(PSADATA,"^",5),7,PSADEC),1:0) Q
"RTN","PSAORDP1",107,0)
 ..W ?65,"(Blank)"
"RTN","PSAORDP1",108,0)
 .;
"RTN","PSAORDP1",109,0)
XCOST .;Extended cost
"RTN","PSAORDP1",110,0)
 .W:PSADJP ?67,$J(PSAECOST,7,2) W:'PSADJP ?70,$J(PSAECOST,9,2)
"RTN","PSAORDP1",111,0)
 .;
"RTN","PSAORDP1",112,0)
LEVELS .;DAVE B (PSA*3*3)
"RTN","PSAORDP1",113,0)
 .S OU=$P($G(^PSDRUG(+PSADRG,660)),"^",2) I OU'="" S OU=$P($G(^DIC(51.5,OU,0)),"^",1)
"RTN","PSAORDP1",114,0)
 .S DUOU=$P($G(^PSDRUG(+PSADRG,660)),"^",5)
"RTN","PSAORDP1",115,0)
 .W !?9,"Drug File - Dispense Unit Per Order Unit/Order Unit : "_DUOU_"/"_OU K DUOU,OU
"RTN","PSAORDP1",116,0)
 .W !?9,"Invoiced  - Dispense Unit Per Order Unit/Order Unit : ",$S($P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^")'="":$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^"),1:"same")_"/"
"RTN","PSAORDP1",117,0)
 .S OU=$S($G(PSADJO)'="":"Adjusted: "_$P($G(^DIC(51.5,PSADJO,0)),"^",1),1:$G(PSAOU)) W OU
"RTN","PSAORDP1",118,0)
 .K OU
"RTN","PSAORDP1",119,0)
 .I PSASTA="P",$D(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)) D
"RTN","PSAORDP1",120,0)
 ..W:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^") !?9,"DISPENSE UNITS PER ORDER UNIT: "_$FN(+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^"),",")
"RTN","PSAORDP1",121,0)
 ..W:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",4) !?9,"STOCK LEVEL  : "_$FN(+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",4),",")
"RTN","PSAORDP1",122,0)
 ..W:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",2) !?9,"REORDER LEVEL: "_$FN(+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",2),",")
"RTN","PSAORDP1",123,0)
 .;
"RTN","PSAORDP1",124,0)
 .I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2 D LINEHDR^PSAORDP2
"RTN","PSAORDP1",125,0)
 .D ^PSAORDP2 Q:PSAOUT
"RTN","PSAORDP1",126,0)
 .W !
"RTN","PSAORDP1",127,0)
 Q:PSAOUT
"RTN","PSAORDP1",128,0)
 I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2
"RTN","PSAORDP1",129,0)
 W !,PSASLN
"RTN","PSAORDP1",130,0)
 ;
"RTN","PSAORDP1",131,0)
 ;DAVE B (PSA*3*4)
"RTN","PSAORDP1",132,0)
 S PSADJSUP=$S($P($G(^PSD(58.811,PSAORD,1,PSAINV,0)),"^",13)=1:1,1:0)
"RTN","PSAORDP1",133,0)
 I $G(PSAAECST)'=$G(PSAIECST) D
"RTN","PSAORDP1",134,0)
 .W !?47,"TOTAL ADJUSTED COST",?67,$J(PSAAECST,12,2),!
"RTN","PSAORDP1",135,0)
 .I +$O(^PSD(58.811,PSAORD,1,PSAINV,2,0)) D
"RTN","PSAORDP1",136,0)
 ..S PSACIEN=0 F  S PSACIEN=+$O(^PSD(58.811,PSAORD,1,PSAINV,2,PSACIEN)) Q:'PSACIEN  D
"RTN","PSAORDP1",137,0)
 ...Q:'$D(^PSD(58.811,PSAORD,1,PSAINV,2,PSACIEN,0))
"RTN","PSAORDP1",138,0)
 ...I $Y+3>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2
"RTN","PSAORDP1",139,0)
 ...W:+$P(^PSD(58.811,PSAORD,1,PSAINV,2,PSACIEN,0),"^",3) ?55,"CREDIT MEMO "_$J($P(^(0),"^",3),12,2),!
"RTN","PSAORDP1",140,0)
 W !?47,"TOTAL INVOICED COST",?67,$J(PSAIECST,12,2)
"RTN","PSAORDP1",141,0)
 S PSAEND=1
"RTN","PSAORDP1",142,0)
 I $E(IOST)'="C" D
"RTN","PSAORDP1",143,0)
 .I PSADJDRG D:$Y+4>IOSL HEADER^PSAORDP2 W !!," * THE DRUG WAS MATCHED TO THE DRUG FILE.",!
"RTN","PSAORDP1",144,0)
 .I PSADJSUP D:$Y+4>IOSL HEADER^PSAORDP2 W !,"** THE ITEM IS A SUPPLY ITEM.",!
"RTN","PSAORDP1",145,0)
 D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2
"RTN","PSAORDP1",146,0)
 W !
"RTN","PSAORDP1",147,0)
 Q
"RTN","PSAPROC")
0^2^B58623180
"RTN","PSAPROC",1,0)
PSAPROC ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data ;10/9/97
"RTN","PSAPROC",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC",3,0)
 ;This routine assigns a pharmacy location or master vault to all invoices.
"RTN","PSAPROC",4,0)
 ;
"RTN","PSAPROC",5,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSAPROC",6,0)
ESIG D SIG^XUSESIG I X1="" S PSAOUT=1 G EXIT
"RTN","PSAPROC",7,0)
 S PSASLN="",$P(PSASLN,"-",80)="",PSADLN="",$P(PSADLN,"=",80)="",(PSACNT,PSACTRL,PSAOUT)=0
"RTN","PSAPROC",8,0)
 ;
"RTN","PSAPROC",9,0)
CNT ;Count invoices that need a pharm location or master vault assigned.
"RTN","PSAPROC",10,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC",11,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",12,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC",13,0)
 .I $P(PSAIN,"^",10)="ALL CS",$P(PSAIN,"^",12)="" S PSACNT=PSACNT+1,PSACS(PSACTRL)="" Q
"RTN","PSAPROC",14,0)
 .I $P(PSAIN,"^",10)'="ALL CS" D
"RTN","PSAPROC",15,0)
 ..I $P(PSAIN,"^",9)="CS" S:$P(PSAIN,"^",7)="" PSANCS(PSACTRL)="" S:$P(PSAIN,"^",12)="" PSACS(PSACTRL)="" S:$P(PSAIN,"^",7)=""!($P(PSAIN,"^",12)="") PSACNT=PSACNT+1 Q
"RTN","PSAPROC",16,0)
 ..I $P(PSAIN,"^",9)="",$P(PSAIN,"^",7)="" S PSACNT=PSACNT+1,PSANCS(PSACTRL)=""
"RTN","PSAPROC",17,0)
 I 'PSACNT D ^PSAPROC1 G EXIT
"RTN","PSAPROC",18,0)
 ;
"RTN","PSAPROC",19,0)
 ;Gets pharmacy locations
"RTN","PSAPROC",20,0)
 S (PSALOC,PSANUM)=0 F  S PSALOC=+$O(^PSD(58.8,"ADISP","P",PSALOC)) Q:'PSALOC  D
"RTN","PSAPROC",21,0)
 .Q:'$D(^PSD(58.8,PSALOC,0))!($P($G(^PSD(58.8,PSALOC,0)),"^")="")
"RTN","PSAPROC",22,0)
 .I +$G(^PSD(58.8,PSALOC,"I")),+^PSD(58.8,PSALOC,"I")'>DT Q
"RTN","PSAPROC",23,0)
 .S PSANUM=PSANUM+1,PSAONE=PSALOC,PSAISIT=+$P(^PSD(58.8,PSALOC,0),"^",3),PSAOSIT=+$P(^(0),"^",10)
"RTN","PSAPROC",24,0)
 .D SITES^PSAUTL1 S PSACOMB=$S('$D(PSACOMB):"NO COMBINED IP/OP",1:PSACOMB),PSALOCA($P(^PSD(58.8,PSALOC,0),"^")_PSACOMB,PSALOC)=PSAISIT_"^"_PSAOSIT
"RTN","PSAPROC",25,0)
 ;
"RTN","PSAPROC",26,0)
 ;Gets master vaults
"RTN","PSAPROC",27,0)
 S (PSAMVN,PSAMV)=0 F  S PSAMV=+$O(^PSD(58.8,"ADISP","M",PSAMV)) Q:'PSAMV  D
"RTN","PSAPROC",28,0)
 .Q:'$D(^PSD(58.8,PSAMV,0))!($P($G(^PSD(58.8,PSAMV,0)),"^")="")
"RTN","PSAPROC",29,0)
 .I +$G(^PSD(58.8,PSAMV,"I")),+^PSD(58.8,PSAMV,"I")'>DT Q
"RTN","PSAPROC",30,0)
 .S PSAMVN=PSAMVN+1,PSAONEMV=PSAMV,PSAMV($P(^PSD(58.8,PSAMV,0),"^"),PSAMV)=""
"RTN","PSAPROC",31,0)
 I 'PSANUM D NONE G EXIT
"RTN","PSAPROC",32,0)
 I PSANUM=1 D ONE Q:PSAOUT
"RTN","PSAPROC",33,0)
 I PSANUM>1 D MANY Q:PSAOUT
"RTN","PSAPROC",34,0)
 D ^PSAPROC1 G EXIT
"RTN","PSAPROC",35,0)
 ;
"RTN","PSAPROC",36,0)
NONE ;No DA pharmacy locations
"RTN","PSAPROC",37,0)
 W !!,"There are no Drug Accountability pharmacy locations.",!!,"Use the Set Up/Edit a Pharmacy Location option on Pharmacy Location Maintenance"
"RTN","PSAPROC",38,0)
 W !,"Menu to setup one or more pharmacy locations. Then select the Process Uploaded",!,"Prime Vendor Invoice Data option to process the invoices."
"RTN","PSAPROC",39,0)
 D END S PSA=$O(PSACS("")) D:PSA'="" MASTER,END
"RTN","PSAPROC",40,0)
 Q
"RTN","PSAPROC",41,0)
 ;
"RTN","PSAPROC",42,0)
ONE ;Only one location
"RTN","PSAPROC",43,0)
 S PSACNT=0,PSALOC=PSAONE,PSALOCN=$O(PSALOCA(""))
"RTN","PSAPROC",44,0)
 W !!,"The invoices are being assigned to the pharmacy location. Please wait."
"RTN","PSAPROC",45,0)
 S PSACTRL="" F  S PSACTRL=$O(PSANCS(PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC",46,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",47,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=PSALOC,PSACNT=1 W "."
"RTN","PSAPROC",48,0)
 H 1 S PSA=$O(PSACS("")) D:PSA'="" MASTER
"RTN","PSAPROC",49,0)
 Q
"RTN","PSAPROC",50,0)
 ;
"RTN","PSAPROC",51,0)
MANY ;If more than one pharmacy location, display invoices.
"RTN","PSAPROC",52,0)
 S PSACTRL="" F  S PSACTRL=$O(PSANCS(PSACTRL)) Q:PSACTRL=""  D  Q:PSAOUT
"RTN","PSAPROC",53,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",54,0)
 .S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")),PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2)
"RTN","PSAPROC",55,0)
 .D DISPLOC
"RTN","PSAPROC",56,0)
 .W !,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN)
"RTN","PSAPROC",57,0)
 .W:$D(PSACS(PSACTRL)) !,"Some controlled substances" D SELECT
"RTN","PSAPROC",58,0)
 S PSA=$O(PSACS("")) D:PSA'="" MASTER,END K PSAMENU,PSALOCA
"RTN","PSAPROC",59,0)
 Q
"RTN","PSAPROC",60,0)
 ;
"RTN","PSAPROC",61,0)
DISPLOC ;Displays the active pharmacy locations.
"RTN","PSAPROC",62,0)
 W @IOF,!?19,"<<< ASSIGN A PHARMACY LOCATION SCREEN >>>",!,PSASLN
"RTN","PSAPROC",63,0)
 S (PSACNT,PSASTOP)=0,PSALOCN=""
"RTN","PSAPROC",64,0)
 F  S PSALOCN=$O(PSALOCA(PSALOCN)) Q:PSALOCN=""!(PSASTOP)  D
"RTN","PSAPROC",65,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOCA(PSALOCN,PSALOC)) Q:'PSALOC!(PSASTOP)  D
"RTN","PSAPROC",66,0)
 ..S PSACNT=PSACNT+1,PSAMENU(PSACNT,PSALOCN,PSALOC)=PSALOC
"RTN","PSAPROC",67,0)
 ..I $Y+3>IOSL D HDR I PSAOUT S PSAOUT=0,PSASTOP=1 Q
"RTN","PSAPROC",68,0)
 ..W !,$J(PSACNT,2)_"." W:$L(PSALOCN)>72 ?4,$P(PSALOCN,"(IP)",1)_"(IP)",!?21,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<73 ?4,PSALOCN
"RTN","PSAPROC",69,0)
 W ! K PSASTOP
"RTN","PSAPROC",70,0)
 Q
"RTN","PSAPROC",71,0)
 ;
"RTN","PSAPROC",72,0)
HDR D END
"RTN","PSAPROC",73,0)
 W @IOF,!?19,"<<< ASSIGN A PHARMACY LOCATION SCREEN >>>",!,PSASLN
"RTN","PSAPROC",74,0)
 Q
"RTN","PSAPROC",75,0)
 ;
"RTN","PSAPROC",76,0)
SELECT ;Select the Pharmacy Location to be assigned to the order.
"RTN","PSAPROC",77,0)
 W ! K DIR S DIR(0)="NO^1:"_PSACNT,DIR("A")="Pharmacy Location",DIR("?")="Select the pharmacy location that received the invoice's drugs"
"RTN","PSAPROC",78,0)
 S DIR("??")="^D PHARM^PSAPROC" D ^DIR K DIR Q:Y=""
"RTN","PSAPROC",79,0)
 I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC",80,0)
 S PSASEL=Y,PSALOCN=""
"RTN","PSAPROC",81,0)
 F  S PSALOCN=$O(PSAMENU(PSASEL,PSALOCN)) Q:PSALOCN=""  D
"RTN","PSAPROC",82,0)
 .S PSALOC=0 F  S PSALOC=+$O(PSAMENU(PSASEL,PSALOCN,PSALOC)) Q:'PSALOC  D
"RTN","PSAPROC",83,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=PSALOC
"RTN","PSAPROC",84,0)
 Q
"RTN","PSAPROC",85,0)
 ;
"RTN","PSAPROC",86,0)
MASTER ;Assigns invoice to Master Vault
"RTN","PSAPROC",87,0)
 I 'PSAMVN W !!,"No master vaults are set up. You must set up a master vault then",!,"select the Process Uploaded Prime Vendor Invoices Data option." S PSAOUT=1 Q
"RTN","PSAPROC",88,0)
 ;
"RTN","PSAPROC",89,0)
 I PSAMVN=1 D  H 1 Q
"RTN","PSAPROC",90,0)
 .S PSACTRL=$O(PSACS(""))
"RTN","PSAPROC",91,0)
 .W !!,"The invoices are being assigned to the master vault. Please wait."
"RTN","PSAPROC",92,0)
 .S PSACTRL="" F  S PSACTRL=$O(PSACS(PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC",93,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",94,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=PSAONEMV W "."
"RTN","PSAPROC",95,0)
 ;
"RTN","PSAPROC",96,0)
 I PSAMVN>1 D
"RTN","PSAPROC",97,0)
 .S PSACTRL="" F  S PSACTRL=$O(PSACS(PSACTRL)) Q:PSACTRL=""  D  Q:PSAOUT
"RTN","PSAPROC",98,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",99,0)
 ..S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2)
"RTN","PSAPROC",100,0)
 ..D DISPMV W !,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN)
"RTN","PSAPROC",101,0)
 ..W:$P(PSAIN,"^",10)="ALL CS" !,"** All controlled substances"
"RTN","PSAPROC",102,0)
 ..W:$P(PSAIN,"^",10)'="ALL CS" !,"** Some controlled substances"
"RTN","PSAPROC",103,0)
 ..D SELMV
"RTN","PSAPROC",104,0)
 Q
"RTN","PSAPROC",105,0)
 ;
"RTN","PSAPROC",106,0)
DISPMV ;Displays active master vaults
"RTN","PSAPROC",107,0)
 W @IOF,!?22,"<<< ASSIGN A MASTER VAULT SCREEN >>>",!,PSASLN
"RTN","PSAPROC",108,0)
 S PSA=0,PSAMVA="" F  S PSAMVA=$O(PSAMV(PSAMVA)) Q:PSAMVA=""  D
"RTN","PSAPROC",109,0)
 .S PSAMVIEN=0 F  S PSAMVIEN=$O(PSAMV(PSAMVA,PSAMVIEN)) Q:'PSAMVIEN  D
"RTN","PSAPROC",110,0)
 ..S PSA=PSA+1,PSAVAULT(PSA,PSAMVA,PSAMVIEN)=""
"RTN","PSAPROC",111,0)
 ..W !,$J(PSA,2)_".",?4,PSAMVA
"RTN","PSAPROC",112,0)
 W !
"RTN","PSAPROC",113,0)
 Q
"RTN","PSAPROC",114,0)
 ;
"RTN","PSAPROC",115,0)
SELMV ;Select displayed master vaults
"RTN","PSAPROC",116,0)
 W ! S DIR(0)="NO^1:"_PSA,DIR("A")="Select Master Vault",DIR("?")="Select the Master Vault that received the invoice's drugs"
"RTN","PSAPROC",117,0)
 S DIR("??")="^D MV^PSAPROC" D ^DIR K DIR Q:Y=""  I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC",118,0)
 S PSASEL=Y
"RTN","PSAPROC",119,0)
 S PSAMVA=$O(PSAVAULT(PSASEL,"")) Q:PSAMVA=""  S PSAMVIEN=+$O(PSAVAULT(PSASEL,PSAMVA,0)) Q:'PSAMVIEN  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=PSAMVIEN
"RTN","PSAPROC",120,0)
 Q
"RTN","PSAPROC",121,0)
 ;
"RTN","PSAPROC",122,0)
END ;Holds screen
"RTN","PSAPROC",123,0)
 S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC",124,0)
 S DIR(0)="E" D ^DIR K DIR S:$G(DIRUT) PSAOUT=1 W @IOF
"RTN","PSAPROC",125,0)
 Q
"RTN","PSAPROC",126,0)
 ;
"RTN","PSAPROC",127,0)
EXIT ;Kills processing variables
"RTN","PSAPROC",128,0)
 D:$G(PSAENTRY) PRINT2^PSAUP
"RTN","PSAPROC",129,0)
 D:'$G(PSAOUT) ^PSAPROC7
"RTN","PSAPROC",130,0)
 K DA,DIC,DIE,DIK,DIR,DIRUT,DR,DTOUT,DUOUT,PSA,PSABEFOR,PSACHG,PSACHO,PSACNT,PSACNT1,PSACNTER,PSACNTOK,PSACOMB,PSACONT,PSACS,PSACTRL,PSAREA,PSAFLD
"RTN","PSAPROC",131,0)
 K PSAD0,PSAD1,PSAD2,PSAD3,PSAD4,PSAD5,PSAD6,PSADATA,PSADIFF,PSADISP,PSADJQTY,PSADLN,PSADONE,PSADU,PSAENTRY,PSAERR,PSAFLDS,PSAFND,PSAFPR,PSAGET,PSAHDR
"RTN","PSAPROC",132,0)
 K PSAIEN,PSAIEN3,PSAIEN50,PSAIN,PSAINV,PSAIPR,PSAISIT,PSAISITN,PSAJUST,PSAKK,PSALINE,PSALINES,PSALLSUP,PSALN,PSALNCNT,PSALNSU,PSALOC,PSALOCA,PSALOCN,PSALOCN
"RTN","PSAPROC",133,0)
 K PSAMENU,PSAMV,PSAMVA,PSAMVIEN,PSAMVN,PSANCS,PSANDC,PSANEXT,PSANODE,PSANUM,PSAOK,PSAONE,PSAONEMV,PSAORD,PSAOSIT,PSAOSITN,PSAOUT,PSAPASS,PSAPC,PSAPCF,PSAPCL,PSAPHARM,PSAPICK,PSAPRICE,PSAPTR
"RTN","PSAPROC",134,0)
 K PSARECD,PSAREORD,PSASAME,PSASEL,PSASEL1,PSASKIP,PSASLN,PSASNODE,PSASS,PSASSUB,PSASTOCK,PSASUB,PSASUP,PSASUPP,PSASYN,PSAVAPN,PSAVAULT,PSAVSN,X1,Y,ZTDTH,ZTIO
"RTN","PSAPROC",135,0)
 Q
"RTN","PSAPROC",136,0)
 ;
"RTN","PSAPROC",137,0)
MV ;Extended help for the select "Master Vault" prompt
"RTN","PSAPROC",138,0)
 W !?5,"Enter the number of the master vault for which you want to assign",!?5,"the order. The invoiced drugs in the assigned master vault will be"
"RTN","PSAPROC",139,0)
 W !?5,"incremented with the quantity received after the order is verified."
"RTN","PSAPROC",140,0)
 Q
"RTN","PSAPROC",141,0)
PHARM ;Extended help for the select "Pharmacy Location" prompt
"RTN","PSAPROC",142,0)
 W !?5,"Enter the number of the pharmacy location for which you want to assign",!?5,"the order. The invoiced drugs in the assigned pharmacy location will be"
"RTN","PSAPROC",143,0)
 W !?5,"incremented with the quantity received after the order is verified."
"RTN","PSAPROC",144,0)
 Q
"RTN","PSAPROC3")
0^22^B51547340
"RTN","PSAPROC3",1,0)
PSAPROC3 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC3",3,0)
 ;This routine allows the user to edit invoices with errors or missing
"RTN","PSAPROC3",4,0)
 ;data.
"RTN","PSAPROC3",5,0)
 ;
"RTN","PSAPROC3",6,0)
DUOU ;Gets & stores dispense unit per order unit in XTMP
"RTN","PSAPROC3",7,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)
"RTN","PSAPROC3",8,0)
 S PSADU=1
"RTN","PSAPROC3",9,0)
 ;
"RTN","PSAPROC3",10,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAPROC3",11,0)
 S DIR(0)="NO^::2",DIR("A")="DISPENSE UNIT PER ORDER UNIT",DIR("?")="Enter the number of dispense units contained in one order unit.",DIR("??")="^D DUOUHELP^PSAPROC3"
"RTN","PSAPROC3",12,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC3",13,0)
 I +Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",20)=+Y,PSADATA=^(PSALINE) Q
"RTN","PSAPROC3",14,0)
 ;
"RTN","PSAPROC3",15,0)
 W !,"The dispense units per order unit must be entered",!,"to change the status of the invoice to Processed."
"RTN","PSAPROC3",16,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the data now"
"RTN","PSAPROC3",17,0)
 S DIR("?",1)="Enter Yes to return to the DISPENSE UNIT PER ORDER UNIT prompt.",DIR("?")="Enter No to bypass entering the dispense units now."
"RTN","PSAPROC3",18,0)
 S DIR("??")="^D DUOUYN^PSAPROC8" D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC3",19,0)
 Q:Y=""  G:+Y DUOU Q
"RTN","PSAPROC3",20,0)
 ;
"RTN","PSAPROC3",21,0)
GETOU ;Get the Order Unit if it is blank or if it is not in the ORDER UNIT file.
"RTN","PSAPROC3",22,0)
 S DIR(0)="P^51.5:EMZ",DIR("A")="ORDER UNIT",DIR("?")="Enter the unit of order.",DIR("??")="^D OUHELP^PSAPROC3"
"RTN","PSAPROC3",23,0)
 S DIR("B")=$S(+$P($P(PSADATA,"^",2),"~",2):$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",2),0)),"^"),+$P($G(^PSDRUG(PSAIEN,660)),"^",2):$P($G(^DIC(51.5,+$P($G(^PSDRUG(PSAIEN,660)),"^",2),0)),"^"),1:"")
"RTN","PSAPROC3",24,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC3",25,0)
 ;
"RTN","PSAPROC3",26,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAPROC3",27,0)
 ;Q:+$P($P(PSADATA,"^",2),"~",2)=+Y
"RTN","PSAPROC3",28,0)
 I +Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",12)=+Y,$P(^(PSALINE),"^",13)=DUZ,$P(^(PSALINE),"^",14)=DT,PSADATA=^(PSALINE) Q
"RTN","PSAPROC3",29,0)
 ;
"RTN","PSAPROC3",30,0)
 W !,"The order unit must be entered to change",!,"the status of the invoice to Processed.",!
"RTN","PSAPROC3",31,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the data now"
"RTN","PSAPROC3",32,0)
 S DIR("?",1)="Enter Yes to return to the ORDER UNIT prompt.",DIR("?")="Enter No to bypass entering the order units now.",DIR("??")="^D OUYN^PSAPROC3"
"RTN","PSAPROC3",33,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC3",34,0)
 Q:Y=""
"RTN","PSAPROC3",35,0)
 G:+Y GETOU
"RTN","PSAPROC3",36,0)
 Q
"RTN","PSAPROC3",37,0)
 ;
"RTN","PSAPROC3",38,0)
PRICE ;If price per order unit is blank or 0, get price from user.
"RTN","PSAPROC3",39,0)
 S DIR(0)="NO^0:9999:4",DIR("A")="PRICE PER ORDER UNIT",DIR("B")=0
"RTN","PSAPROC3",40,0)
 S DIR("?",1)="If the price per order unit is not zero (0), enter",DIR("?",2)="the correct price. If the price per order unit is",DIR("?")="zero, press return to verify that the price is correct."
"RTN","PSAPROC3",41,0)
 S DIR("??")="^D PRICEHLP^PSAPROC3" D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC3",42,0)
 I +$P(PSADATA,"^",3),+$P(PSADATA,"^",3)=+Y Q
"RTN","PSAPROC3",43,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",23)=+Y,$P(^(PSALINE),"^",24)=DUZ,$P(^(PSALINE),"^",25)=DT,PSADATA=^(PSALINE)
"RTN","PSAPROC3",44,0)
 Q
"RTN","PSAPROC3",45,0)
 ;
"RTN","PSAPROC3",46,0)
QTY ;If qty is blank, prompt for it.
"RTN","PSAPROC3",47,0)
 S DIR(0)="N",DIR("A")="QUANTITY RECEIVED",DIR("B")=$S(+$P(PSADATA,"^",8):+$P(PSADATA,"^",8),+PSADATA:+PSADATA,1:0)
"RTN","PSAPROC3",48,0)
 S DIR("?",1)="If the quantity received is different than the",DIR("?")="quantity invoiced, enter the correct quantity received.",DIR("??")="^D QTYHELP^PSAPROC3"
"RTN","PSAPROC3",49,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC3",50,0)
 Q:+PSADATA=+Y  S PSADJQTY=+Y
"RTN","PSAPROC3",51,0)
 S DIR(0)="F^1:30",DIR("A")="ADJUSTMENT REASON",DIR("?")="Enter the reason you adjusted the quantity received.",DIR("??")="^D ADJREA^PSAPROC3"
"RTN","PSAPROC3",52,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC3",53,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",8)=PSADJQTY,$P(^(PSALINE),"^",9)=DUZ,$P(^(PSALINE),"^",10)=DT,$P(^(PSALINE),"^",11)=Y,PSADATA=^(PSALINE)
"RTN","PSAPROC3",54,0)
 Q
"RTN","PSAPROC3",55,0)
 ;
"RTN","PSAPROC3",56,0)
RECD ;Enter the date the invoiced drugs were received.
"RTN","PSAPROC3",57,0)
 S DIR(0)="D",DIR("A")="Date received",DIR("?")="Enter the date the drugs were received.",DIR("??")="^D RECHELP^PSAPROC3" S:PSARECD DIR("B")=$$FMTE^XLFDT(PSARECD)
"RTN","PSAPROC3",58,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC3",59,0)
 S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",6)'=+Y $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",11)=+Y S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC3",60,0)
 Q
"RTN","PSAPROC3",61,0)
 ;
"RTN","PSAPROC3",62,0)
SETLINE ;Set line as process if all data is present.
"RTN","PSAPROC3",63,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC3",64,0)
 I $D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")) S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P",PSALINES=PSALINES+1,PSALLSUP=PSALLSUP+1 Q
"RTN","PSAPROC3",65,0)
 S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),+$P(PSADATA,"^",6):+$P(PSADATA,"^",6),1:0),PSASUB=+$P(PSADATA,"^",7)
"RTN","PSAPROC3",66,0)
 I PSAIEN,$P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS"
"RTN","PSAPROC3",67,0)
 E  S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)=""
"RTN","PSAPROC3",68,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSALOC=$S($P(PSADATA,"^",19)'="CS":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAPROC3",69,0)
 I +$P(PSADATA,"^",6)!(+$P(PSADATA,"^",15)),$P(PSADATA,"^")'=""!($P(PSADATA,"^",8)'=""),$P($G(^PSDRUG(PSAIEN,660)),"^",8)'="" D
"RTN","PSAPROC3",70,0)
 .I +$P($G(^PSDRUG(PSAIEN,1,+$G(PSASUB),0)),"^",7)!(+$P(PSADATA,"^",20)),+$P($P(PSADATA,"^",2),"~",2)!(+$P(PSADATA,"^",12))!(+$P($G(^PSDRUG(PSAIEN,1,+$G(PSASUB),0)),"^",5)) D
"RTN","PSAPROC3",71,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P",PSALINES=PSALINES+1,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="",PSAIN=^("IN")
"RTN","PSAPROC3",72,0)
 Q
"RTN","PSAPROC3",73,0)
 ;
"RTN","PSAPROC3",74,0)
ADJREA ;Extended help for 'qty adjustment reason'
"RTN","PSAPROC3",75,0)
 W !?5,"Enter why you changed the quantity.",!?5,"For example: 2 bottles were broken.",!?5,"             Package contained only 11 tubes."
"RTN","PSAPROC3",76,0)
 Q
"RTN","PSAPROC3",77,0)
DUOUHELP ;Extended help for entering dispense units per order unit
"RTN","PSAPROC3",78,0)
 W !?5,"Enter the number of dispense units contained in the order unit.",!!?5,"For example: Dispense Units: TAB",!?18,"Order Unit    : CS"
"RTN","PSAPROC3",79,0)
 W !!?18,"The case contains 12 bottles of 1,000 tablets",!?18,"12 x 1,000 = 12,000",!?18,"DISPENSE UNITS PER ORDER UNIT: 12,000"
"RTN","PSAPROC3",80,0)
 Q
"RTN","PSAPROC3",81,0)
NDCHELP ;Extended help for selecting invoiced drug
"RTN","PSAPROC3",82,0)
 W !?5,"Enter the number to the left of the invoiced drug. If you select  a drug",!?5,"from the list, the invoiced drug will be matched to that drug. If you"
"RTN","PSAPROC3",83,0)
 W !?5,"choose to select another drug, you can select the invoiced drug from the",!?5,"DRUG file or flag this item as a supply item."
"RTN","PSAPROC3",84,0)
 Q
"RTN","PSAPROC3",85,0)
OUHELP ;Extended help for selecting the Order Unit
"RTN","PSAPROC3",86,0)
 W !?5,"Enter the packaging unit for which the drug was ordered."
"RTN","PSAPROC3",87,0)
 Q
"RTN","PSAPROC3",88,0)
OUYN ;Extended help for returning to the 'ORDER UNIT' prompt.
"RTN","PSAPROC3",89,0)
 W !?5,"Enter Yes if you want to enter the order unit now.",!?5,"Enter No to bypass entering the order unit."
"RTN","PSAPROC3",90,0)
 W !!?5,"The invoice will not be placed in a Processed",!?5,"status if the order units are not entered."
"RTN","PSAPROC3",91,0)
 Q
"RTN","PSAPROC3",92,0)
PRICEHLP ;Extended help for price per order unit
"RTN","PSAPROC3",93,0)
 W !?5,"If the price per order unit is not zero, enter the correct price. ",!?5,"The total cost for the item will be adjusted. If it is zero, press ",!?5,"the return key to verify that zero is the correct price."
"RTN","PSAPROC3",94,0)
 Q
"RTN","PSAPROC3",95,0)
QTYHELP ;Extended help for quantity delivered
"RTN","PSAPROC3",96,0)
 W !?5,"If the quantity received is different than the quantity",!?5,"displayed, enter the correct quantity you received. The",!?5,"total cost for the item will be adjusted."
"RTN","PSAPROC3",97,0)
 Q
"RTN","PSAPROC3",98,0)
RECHELP ;Extended help to 'Date Received'
"RTN","PSAPROC3",99,0)
 W !?5,"Enter the date the drugs were received. The date the prime vendor",!?5,"said the drugs were delivered and the date you say the drugs were",!?5,"received will be retained."
"RTN","PSAPROC3",100,0)
 Q
"RTN","PSAPROC4")
0^33^B48056626
"RTN","PSAPROC4",1,0)
PSAPROC4 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC4",3,0)
 ;This routine allows the user to edit invoices with errors or missing
"RTN","PSAPROC4",4,0)
 ;data.
"RTN","PSAPROC4",5,0)
 ;
"RTN","PSAPROC4",6,0)
MANYNDCS ;List drug synonym data & ask user which on to use
"RTN","PSAPROC4",7,0)
 K PSADIFF,PSASAME S (PSACNT,PSAFND,PSAIEN50)=0,PSANDC=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4),"~")
"RTN","PSAPROC4",8,0)
 F  S PSAIEN50=$O(^PSDRUG("C",PSANDC,PSAIEN50)) Q:'PSAIEN50  S PSASYN=0 D
"RTN","PSAPROC4",9,0)
 .F  S PSASYN=$O(^PSDRUG("C",PSANDC,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSAPROC4",10,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC4",11,0)
 ..;DAVE B (PSA*3*3)
"RTN","PSAPROC4",12,0)
 ..Q:$D(^PSDRUG(PSAIEN50,"I"))
"RTN","PSAPROC4",13,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)=PSAVSN S PSAFND=PSAFND+1,PSASAME(PSAFND)=PSAIEN50_"^"_PSASYN
"RTN","PSAPROC4",14,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)'=PSAVSN S PSACNT=PSACNT+1,PSADIFF(PSACNT)=PSAIEN50_"^"_PSASYN
"RTN","PSAPROC4",15,0)
 G:PSAFND SAME G:PSACNT DIFF
"RTN","PSAPROC4",16,0)
 Q
"RTN","PSAPROC4",17,0)
 ;
"RTN","PSAPROC4",18,0)
SAME ;If more than one drug with same VSN, assign to correct drug.
"RTN","PSAPROC4",19,0)
 W !,"There is more than one item in the DRUG file",!,"with the same NDC and Vendor Stock Number.",!
"RTN","PSAPROC4",20,0)
 S (PSACNT,PSAMENU)=0 F  S PSACNT=$O(PSASAME(PSACNT)) Q:'PSACNT  D
"RTN","PSAPROC4",21,0)
 .S PSAIEN50=$P(PSASAME(PSACNT),"^"),PSASYN=$P(PSASAME(PSACNT),"^",2),PSANODE=^PSDRUG(PSAIEN50,1,PSASYN,0) S PSAMENU=PSAMENU+1
"RTN","PSAPROC4",22,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC4",23,0)
 .D LIST Q:PSAOUT
"RTN","PSAPROC4",24,0)
 D CHOOSE Q:PSAOUT!(Y="")
"RTN","PSAPROC4",25,0)
 I PSAPICK=PSAMENU D ASKDRUG^PSANDF G KILL
"RTN","PSAPROC4",26,0)
 I PSAPICK<PSAMENU D
"RTN","PSAPROC4",27,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,$P(^(PSALINE),"^",7)=$P(PSASAME(PSAPICK),"^",2),$P(^(PSALINE),"^",5)=$P($P(^(PSALINE),"^",5),"~"),PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC4",28,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)'=$P(PSASAME(PSAPICK),"^") D
"RTN","PSAPROC4",29,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=$P(PSASAME(PSAPICK),"^"),$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT,PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC4",30,0)
 ..I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP" S $P(^("IN"),"^",13)="",PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC4",31,0)
 ..D HDR^PSAPROC6,EDIT1^PSAUTL1
"RTN","PSAPROC4",32,0)
 G KILL
"RTN","PSAPROC4",33,0)
 ;
"RTN","PSAPROC4",34,0)
DIFF ;If more than one drug with different VSN, assign to correct drug.
"RTN","PSAPROC4",35,0)
 W !,"There is more than one item in the DRUG file with the same NDC.",!
"RTN","PSAPROC4",36,0)
 S (PSACNT,PSAMENU)=0 F  S PSACNT=$O(PSADIFF(PSACNT)) Q:'PSACNT  D
"RTN","PSAPROC4",37,0)
 .S PSAIEN50=$P(PSADIFF(PSACNT),"^"),PSASYN=$P(PSADIFF(PSACNT),"^",2),PSANODE=^PSDRUG(PSAIEN50,1,PSASYN,0),PSAMENU=PSAMENU+1
"RTN","PSAPROC4",38,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC4",39,0)
 .D LIST Q:PSAOUT
"RTN","PSAPROC4",40,0)
 D CHOOSE Q:PSAOUT!(Y="")
"RTN","PSAPROC4",41,0)
 I PSAPICK=PSAMENU D ASKDRUG^PSANDF G KILL
"RTN","PSAPROC4",42,0)
 I PSAPICK<PSAMENU D
"RTN","PSAPROC4",43,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,$P(^(PSALINE),"^",7)=$P(PSADIFF(PSAPICK),"^",2),PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC4",44,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)'=$P(PSADIFF(PSAPICK),"^") D
"RTN","PSAPROC4",45,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=$P(PSADIFF(PSAPICK),"^"),$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT,PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC4",46,0)
 ..I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP" S $P(^("IN"),"^",13)="",PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC4",47,0)
 ..D HDR^PSAPROC6,EDIT1^PSAUTL1
"RTN","PSAPROC4",48,0)
KILL K PSASAME,PSAFND
"RTN","PSAPROC4",49,0)
 Q
"RTN","PSAPROC4",50,0)
 ;
"RTN","PSAPROC4",51,0)
LIST Q:PSANODE=""!($P($G(^PSDRUG(PSAIEN50,0)),"^")="")
"RTN","PSAPROC4",52,0)
 W !?1,PSAMENU_".",?4,$P($G(^PSDRUG(PSAIEN50,0)),"^") I $D(^PSDRUG(PSAIEN50,"I")) W ?60,"(INACTIVE)"
"RTN","PSAPROC4",53,0)
 I +$P(PSANODE,"^",5),$P($G(^DIC(51.5,+$P(PSANODE,"^",5),0)),"^")'="" W !?4,"Order Unit: "_$P(^DIC(51.5,+$P(PSANODE,"^",5),0),"^"),?45,"Price Per Order Unit   : $"_$S(+$P(PSANODE,"^",6):$P(PSANODE,"^",6),1:"(Blank)")
"RTN","PSAPROC4",54,0)
 E  I +$P(PSANODE,"^",6) W !?4,"Price Per Order Unit: $"_$P(PSANODE,"^",6)
"RTN","PSAPROC4",55,0)
 I $P(PSANODE,"^",9)'="" W !?4,"Vendor: "_$P(PSANODE,"^",9),?45,"VSN: "_$S($P(PSANODE,"^",4)'="":$P(PSANODE,"^",4),1:"(Blank)")
"RTN","PSAPROC4",56,0)
 E  I $P(PSANODE,"^",4)'="" W !?4,"VSN: "_$S($P(PSANODE,"^",4)'="":$P(PSANODE,"^",4),1:"(Blank)")
"RTN","PSAPROC4",57,0)
 Q
"RTN","PSAPROC4",58,0)
 ;
"RTN","PSAPROC4",59,0)
CHOOSE S PSAMENU=PSAMENU+1
"RTN","PSAPROC4",60,0)
 W !?1,PSAMENU,".",?4,"Select another drug."
"RTN","PSAPROC4",61,0)
 W ! S DIR(0)="N^1:"_PSAMENU,DIR("A")="Select the invoiced drug",DIR("?")="Select the drug from the list for which you were invoiced.",DIR("??")="^D NDCHELP^PSAPROC4"
"RTN","PSAPROC4",62,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC4",63,0)
 S PSAPICK=+Y
"RTN","PSAPROC4",64,0)
 Q
"RTN","PSAPROC4",65,0)
 ;
"RTN","PSAPROC4",66,0)
MANYVSNS ;List drug synonym data & ask user which on to use
"RTN","PSAPROC4",67,0)
 K PSADIFF,PSASAME S (PSACNT,PSAFND,PSAIEN50)=0,PSAVSN=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5),"~")
"RTN","PSAPROC4",68,0)
 F  S PSAIEN50=$O(^PSDRUG("AVSN",PSAVSN,PSAIEN50)) Q:'PSAIEN50  S PSASYN=0 D
"RTN","PSAPROC4",69,0)
 .F  S PSASYN=$O(^PSDRUG("AVSN",PSAVSN,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSAPROC4",70,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC4",71,0)
 ..;DAVE B (PSA*3*3)
"RTN","PSAPROC4",72,0)
 ..Q:$D(^PSDRUG(PSAIEN50,"I"))
"RTN","PSAPROC4",73,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^")=PSANDC S PSAFND=PSAFND+1,PSASAME(PSAFND)=PSAIEN50_"^"_PSASYN
"RTN","PSAPROC4",74,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^")'=PSANDC S PSACNT=PSACNT+1,PSADIFF(PSACNT)=PSAIEN50_"^"_PSASYN
"RTN","PSAPROC4",75,0)
 G:PSAFND SAMEV G:PSACNT DIFFV
"RTN","PSAPROC4",76,0)
 Q
"RTN","PSAPROC4",77,0)
 ;
"RTN","PSAPROC4",78,0)
SAMEV ;If more than one drug with same NDC, assign to correct drug.
"RTN","PSAPROC4",79,0)
 W !,"There is more than one item in the DRUG file",!,"with the same NDC and Vendor Stock Number.",!
"RTN","PSAPROC4",80,0)
 S (PSACNT,PSAMENU)=0 F  S PSACNT=$O(PSASAME(PSACNT)) Q:'PSACNT  D
"RTN","PSAPROC4",81,0)
 .S PSAIEN50=$P(PSASAME(PSACNT),"^"),PSASYN=$P(PSASAME(PSACNT),"^",2),PSANODE=^PSDRUG(PSAIEN50,1,PSASYN,0),PSAMENU=PSAMENU+1
"RTN","PSAPROC4",82,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC4",83,0)
 .D LIST Q:PSAOUT
"RTN","PSAPROC4",84,0)
 D CHOOSE Q:PSAOUT!(Y="")
"RTN","PSAPROC4",85,0)
 I PSAPICK=PSAMENU D ASKDRUG^PSANDF G KILL
"RTN","PSAPROC4",86,0)
 I PSAPICK<PSAMENU D
"RTN","PSAPROC4",87,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN,$P(^(PSALINE),"^",7)=$P(PSASAME(PSAPICK),"^",2),PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC4",88,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)'=$P(PSASAME(PSAPICK),"^") D
"RTN","PSAPROC4",89,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=$P(PSASAME(PSAPICK),"^"),$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT,PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC4",90,0)
 ..I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP" S $P(^("IN"),"^",13)="",PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC4",91,0)
 ..D HDR^PSAPROC6,EDIT1^PSAUTL1
"RTN","PSAPROC4",92,0)
 G KILL
"RTN","PSAPROC4",93,0)
 ;
"RTN","PSAPROC4",94,0)
DIFFV ;If more than one drug with different VSN, assign to correct drug.
"RTN","PSAPROC4",95,0)
 W !,"There is more than one item in the DRUG file with the same VSN.",!
"RTN","PSAPROC4",96,0)
 S (PSACNT,PSAMENU)=0 F  S PSACNT=$O(PSADIFF(PSACNT)) Q:'PSACNT  D
"RTN","PSAPROC4",97,0)
 .S PSAIEN50=$P(PSADIFF(PSACNT),"^"),PSASYN=$P(PSADIFF(PSACNT),"^",2),PSANODE=$G(^PSDRUG(PSAIEN50,1,PSASYN,0)),PSAMENU=PSAMENU+1
"RTN","PSAPROC4",98,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC4",99,0)
 .D LIST Q:PSAOUT
"RTN","PSAPROC4",100,0)
 D CHOOSE Q:PSAOUT!(Y="")
"RTN","PSAPROC4",101,0)
 I PSAPICK=PSAMENU D ASKDRUG^PSANDF G KILL
"RTN","PSAPROC4",102,0)
 I PSAPICK<PSAMENU D
"RTN","PSAPROC4",103,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN,$P(^(PSALINE),"^",7)=$P(PSADIFF(PSAPICK),"^",2),PSANEXT=1
"RTN","PSAPROC4",104,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)'=$P(PSADIFF(PSAPICK),"^") D
"RTN","PSAPROC4",105,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=$P(PSADIFF(PSAPICK),"^"),$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT,PSADATA=^(PSALINE)
"RTN","PSAPROC4",106,0)
 ..S PSANDC=$P($G(^PSDRUG(+$P(PSADIFF(PSAPICK),"^"),1,+$P(PSADIFF(PSAPICK),"^",2),0)),"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC
"RTN","PSAPROC4",107,0)
 ..I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP" S $P(^("IN"),"^",13)="",PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC4",108,0)
 ..D HDR^PSAPROC6,EDIT1^PSAUTL1
"RTN","PSAPROC4",109,0)
 G KILL
"RTN","PSAPROC4",110,0)
 ;
"RTN","PSAPROC4",111,0)
NDCHELP ;Extended help for selecting invoiced drug
"RTN","PSAPROC4",112,0)
 W !?5,"Enter the number to the left of the invoiced drug. If you select a drug",!?5,"from the list, the invoiced drug will be matched to that drug. If you"
"RTN","PSAPROC4",113,0)
 W !?5,"choose to select another drug, you can select the invoiced drug from the",!?5,"DRUG file or flag this item as a supply item."
"RTN","PSAPROC4",114,0)
 Q
"RTN","PSAPROC5")
0^34^B44077866
"RTN","PSAPROC5",1,0)
PSAPROC5 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC5",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC5",3,0)
 ;This routine allows the user to edit invoices with errors or missing
"RTN","PSAPROC5",4,0)
 ;data.
"RTN","PSAPROC5",5,0)
 ;
"RTN","PSAPROC5",6,0)
MANYUPCS ;List supply synonym data & ask user which on to use
"RTN","PSAPROC5",7,0)
 K PSADIFF,PSASAME
"RTN","PSAPROC5",8,0)
 S (PSACNT,PSAFND,PSAIEN50)=0,PSASUP=$P($P(PSADATA,"^",26),"~"),PSANDC="S"_PSASUP
"RTN","PSAPROC5",9,0)
 F  S PSAIEN50=$O(^PSDRUG("C",PSANDC,PSAIEN50)) Q:'PSAIEN50  S PSASYN=0 D
"RTN","PSAPROC5",10,0)
 .F  S PSASYN=$O(^PSDRUG("C",PSANDC,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSAPROC5",11,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC5",12,0)
 ..;DAVE B (PSA*3*3)
"RTN","PSAPROC5",13,0)
 ..Q:$D(^PSDRUG(PSAIEN50,"I"))
"RTN","PSAPROC5",14,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)=PSAVSN S PSAFND=PSAFND+1,PSASAME(PSAFND)=PSAIEN50_"^"_PSASYN
"RTN","PSAPROC5",15,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)'=PSAVSN S PSACNT=PSACNT+1,PSADIFF(PSACNT)=PSAIEN50_"^"_PSASYN
"RTN","PSAPROC5",16,0)
 G:PSAFND SAMEU G:PSACNT DIFFU
"RTN","PSAPROC5",17,0)
 Q
"RTN","PSAPROC5",18,0)
 ;
"RTN","PSAPROC5",19,0)
SAMEU ;If more than one drug with same VSN, assign to correct drug.
"RTN","PSAPROC5",20,0)
 W !!,"There is more than one supply in the DRUG file",!,"with the same UPC and Vendor Stock Number.",!
"RTN","PSAPROC5",21,0)
 S (PSACNT,PSAMENU)=0
"RTN","PSAPROC5",22,0)
 F  S PSACNT=$O(PSASAME(PSACNT)) Q:'PSACNT  D
"RTN","PSAPROC5",23,0)
 .S PSAIEN50=$P(PSASAME(PSACNT),"^"),PSASYN=$P(PSASAME(PSACNT),"^",2),PSANODE=$G(^PSDRUG(PSAIEN50,1,PSASYN,0)),PSAMENU=PSAMENU+1
"RTN","PSAPROC5",24,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC5",25,0)
 .D LIST^PSAPROC4 Q:PSAOUT
"RTN","PSAPROC5",26,0)
 D CHOOSEU Q:PSAOUT
"RTN","PSAPROC5",27,0)
 I PSAPICK=PSAMENU D ASKDRUG^PSANDF G:PSAOUT KILL^PSAPROC4 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)=PSASUP,PSANEXT=1,PSADATA=^(PSALINE) G KILL^PSAPROC4
"RTN","PSAPROC5",28,0)
 I PSAPICK<PSAMENU D
"RTN","PSAPROC5",29,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,$P(^(PSALINE),"^",7)=$P(PSASAME(PSAPICK),"^",2),$P(^(PSALINE),"^",15)=$P(PSASAME(PSAPICK),"^"),$P(^(PSALINE),"^",26)=PSASUP,PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC5",30,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP" S $P(^("IN"),"^",13)="",PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC5",31,0)
 G KILL^PSAPROC4
"RTN","PSAPROC5",32,0)
 ;
"RTN","PSAPROC5",33,0)
DIFFU ;If more than one supply with different UPC, assign to correct drug.
"RTN","PSAPROC5",34,0)
 W !!,"There is more than one supply in the DRUG file with the same UPC.",!
"RTN","PSAPROC5",35,0)
 S (PSACNT,PSAMENU)=0 F  S PSACNT=$O(PSADIFF(PSACNT)) Q:'PSACNT  D
"RTN","PSAPROC5",36,0)
 .S PSAIEN50=$P(PSADIFF(PSACNT),"^"),PSASYN=$P(PSADIFF(PSACNT),"^",2),PSANODE=$G(^PSDRUG(PSAIEN50,1,PSASYN,0)),PSAMENU=PSAMENU+1
"RTN","PSAPROC5",37,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAPROC5",38,0)
 .D LIST^PSAPROC4 Q:PSAOUT
"RTN","PSAPROC5",39,0)
 D CHOOSEU Q:PSAOUT
"RTN","PSAPROC5",40,0)
 I PSAPICK=PSAMENU D ASKDRUG^PSANDF G:PSAOUT KILL^PSAPROC4 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)=PSASUP,PSANEXT=1,PSADATA=^(PSALINE) G KILL^PSAPROC4
"RTN","PSAPROC5",41,0)
 I PSAPICK<PSAMENU D
"RTN","PSAPROC5",42,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,$P(^(PSALINE),"^",7)=$P(PSADIFF(PSAPICK),"^",2),$P(^(PSALINE),"^",15)=$P(PSADIFF(PSAPICK),"^"),$P(^(PSALINE),"^",26)=PSASUP,PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC5",43,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP" S $P(^("IN"),"^",13)="",PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC5",44,0)
 G KILL^PSAPROC4
"RTN","PSAPROC5",45,0)
 ;
"RTN","PSAPROC5",46,0)
CHOOSEU S PSAMENU=PSAMENU+1
"RTN","PSAPROC5",47,0)
 W !?1,PSAMENU_".",?4,"Select another item."
"RTN","PSAPROC5",48,0)
 W ! S DIR(0)="NO^1:"_PSAMENU,DIR("A")="Select the invoiced item",DIR("?")="Select the item from the list for which you were invoiced.",DIR("??")="^D UPCHELP^PSAPROC5"
"RTN","PSAPROC5",49,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC5",50,0)
 S PSAPICK=+Y
"RTN","PSAPROC5",51,0)
 Q
"RTN","PSAPROC5",52,0)
 ;
"RTN","PSAPROC5",53,0)
NDCDIFF ;If New NDC is correct, remove "~" piece with questionable NDC in ^XTMP.
"RTN","PSAPROC5",54,0)
 ;If Old NDC is correct, remove "~" piece with questionable NDC & set
"RTN","PSAPROC5",55,0)
 ;old NDC in NDC piece in ^XTMP.
"RTN","PSAPROC5",56,0)
 W !!,"There is a change in Vendor Stock Number's NDC."
"RTN","PSAPROC5",57,0)
 W !,"New NDC: "_PSANDC_"  "
"RTN","PSAPROC5",58,0)
 W !,"Old NDC: "_$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5),"~",3),!
"RTN","PSAPROC5",59,0)
 S DIR(0)="Y",DIR("A")="Is the new NDC correct",DIR("B")="Y",DIR("?",1)="Enter Yes if the line item's NDC is correct.",DIR("?")="Enter No is the old NDC is correct."
"RTN","PSAPROC5",60,0)
 S DIR("??")="^D NEWOLDN^PSAPROC5" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC5",61,0)
 I +Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN_"~~~1",$P(^(PSALINE),"^",4)=PSANDC,PSADATA=^(PSALINE),PSANEXT=1 Q
"RTN","PSAPROC5",62,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5),"~",3),$P(^(PSALINE),"^",5)=PSAVSN,PSANEXT=1,PSADATA=^(PSALINE)
"RTN","PSAPROC5",63,0)
 Q
"RTN","PSAPROC5",64,0)
 ;
"RTN","PSAPROC5",65,0)
SUPDIFF ;If New UPC is correct, remove "~" piece with questionable UPC in ^XTMP.
"RTN","PSAPROC5",66,0)
 ;If Old UPC is correct, remove "~" piece with questionable UPC & set old UPC in VSN piece in ^XTMP.
"RTN","PSAPROC5",67,0)
 W !!,"There is a change in item's Universal Product Code (UPC)."
"RTN","PSAPROC5",68,0)
 W !,"New UPC: "_PSAUPC
"RTN","PSAPROC5",69,0)
 W !,"Old UPC: "_$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26),"~",3),!
"RTN","PSAPROC5",70,0)
 S DIR(0)="Y",DIR("A")="Is the new UPC correct",DIR("B")="Y",DIR("?",1)="Enter Yes if the line item's Universal Product Code is correct.",DIR("?")="Enter No is the old Universal Product Code is correct."
"RTN","PSAPROC5",71,0)
 S DIR("??")="^D NEWUPC^PSAPROC5" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC5",72,0)
 S PSANDC="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC5",73,0)
 I +Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,$P(^(PSALINE),"^",26)=PSAUPC,PSADATA=^(PSALINE),PSANEXT=1 Q
"RTN","PSAPROC5",74,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)=$P($P(^(PSALINE),"^",26),"~",3),$P(^(PSALINE),"^",4)=PSANDC,PSADATA=^(PSALINE),PSANEXT=1
"RTN","PSAPROC5",75,0)
 Q
"RTN","PSAPROC5",76,0)
 ;
"RTN","PSAPROC5",77,0)
VSNDIFF ;If New VSN is correct, remove "~" piece with questionable VSN in ^XTMP.
"RTN","PSAPROC5",78,0)
 ;If Old VSN is correct, remove "~" piece with questionable VSN & set old VSN in VSN piece in ^XTMP.
"RTN","PSAPROC5",79,0)
 W !!,"There is a change in the NDC's Vendor Stock Number (VSN)."
"RTN","PSAPROC5",80,0)
 W !,"New VSN: "_PSAVSN_"  "
"RTN","PSAPROC5",81,0)
 W !,"Old VSN: "_$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4),"~",3),!
"RTN","PSAPROC5",82,0)
 S DIR(0)="Y",DIR("A")="Is the new VSN correct",DIR("B")="Y",DIR("?",1)="Enter Yes if the line item's Vendor Stock Number is correct.",DIR("?")="Enter No is the old Vendor Stock Number is correct."
"RTN","PSAPROC5",83,0)
 S DIR("??")="^D NEWOLD^PSAPROC5" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC5",84,0)
 I +Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC_"~~~1",$P(^(PSALINE),"^",5)=PSAVSN,PSADATA=^(PSALINE),PSANEXT=1 Q
"RTN","PSAPROC5",85,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4),"~",3),$P(^(PSALINE),"^",4)=PSANDC,PSADATA=^(PSALINE),PSANEXT=1
"RTN","PSAPROC5",86,0)
 Q
"RTN","PSAPROC5",87,0)
 ;
"RTN","PSAPROC5",88,0)
NEWOLD ;Extended help to 'Is new VSN correct'
"RTN","PSAPROC5",89,0)
 W !?5,"Enter Yes to add another synonym for the NDC with the new VSN.",!?5,"Enter No to discard the new VSN."
"RTN","PSAPROC5",90,0)
 Q
"RTN","PSAPROC5",91,0)
NEWOLDN ;Extended help to 'Is new NDC correct'
"RTN","PSAPROC5",92,0)
 W !?5,"Enter Yes to add another synonym for the NDC with the new NDC.",!?5,"Enter No to discard the new NDC."
"RTN","PSAPROC5",93,0)
 Q
"RTN","PSAPROC5",94,0)
NEWUPC ;Extended help to 'Is new UPC correct'
"RTN","PSAPROC5",95,0)
 W !?5,"Enter Yes to add another synonym for the NDC with the new UPC.",!?5,"Enter No to discard the new UPC."
"RTN","PSAPROC5",96,0)
 Q
"RTN","PSAPROC5",97,0)
UPCHELP ;Extended help for selecting invoiced supply
"RTN","PSAPROC5",98,0)
 W !?5,"Enter the number of the invoiced item. If you select an item from the",!?5,"list, the invoice data will be added to that item. If you select to"
"RTN","PSAPROC5",99,0)
 W !?5,"add a new entry in the DRUG file for the invoiced item, a new",!?5,"synonym for the item will be added to the DRUG file."
"RTN","PSAPROC5",100,0)
 Q
"RTN","PSAPROC6")
0^27^B70844716
"RTN","PSAPROC6",1,0)
PSAPROC6 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;10/7/97
"RTN","PSAPROC6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC6",3,0)
 ;This routine allows the user to edit invoices by selecting the
"RTN","PSAPROC6",4,0)
 ;invoice's line item number.
"RTN","PSAPROC6",5,0)
 ;
"RTN","PSAPROC6",6,0)
SEL ;Loops thru selected invoices
"RTN","PSAPROC6",7,0)
 F PSAPC=1:1 S PSAMENU=$P(PSASEL,",",PSAPC) Q:'PSAMENU!(PSAOUT)  D CORR Q:PSAOUT
"RTN","PSAPROC6",8,0)
 ;
"RTN","PSAPROC6",9,0)
CHECK ;Looks to see if all line items are processed
"RTN","PSAPROC6",10,0)
 S (PSACS,PSAERR,PSALINE,PSALINES,PSALNCNT,PSALNSU,PSAOUT,PSASUP)=0
"RTN","PSAPROC6",11,0)
 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAPROC6",12,0)
 .S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSALNCNT=PSALNCNT+1
"RTN","PSAPROC6",13,0)
 .S:$P(PSADATA,"^",18)="P"!($P(PSADATA,"^",18)="OK") PSALINES=PSALINES+1
"RTN","PSAPROC6",14,0)
 .S:$P(PSADATA,"^",19)="CS" PSACS=PSACS+1
"RTN","PSAPROC6",15,0)
 I PSACS,PSALNCNT=PSACS D
"RTN","PSAPROC6",16,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS",$P(^("IN"),"^",9)="CS" W !,"All drugs on the invoice are marked as a controlled substance."
"RTN","PSAPROC6",17,0)
 .D:$P($G(^PSD(58.8,+$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12),0)),"^",2)'="M" MASTER^PSAPROC9
"RTN","PSAPROC6",18,0)
 E  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)=""
"RTN","PSAPROC6",19,0)
 I PSACS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAPROC6",20,0)
 I +PSALNCNT,PSALNCNT=PSALINES D CHG D END^PSAPROC Q
"RTN","PSAPROC6",21,0)
 E  W !!,"** The invoice has not been placed in a Processed status!"
"RTN","PSAPROC6",22,0)
 D END^PSAPROC
"RTN","PSAPROC6",23,0)
 Q
"RTN","PSAPROC6",24,0)
 ;
"RTN","PSAPROC6",25,0)
CHG ;Asks if invoice's status should be changed to verified. If so, status
"RTN","PSAPROC6",26,0)
 ;is changed & new drugs to location is listed.
"RTN","PSAPROC6",27,0)
 W ! S DIR(0)="Y",DIR("A")="Do you want to change the invoice's status to Processed",DIR("?",1)="Enter YES to change the invoice's status to Processed.",DIR("?")="Enter NO to keep the invoice's status as Uploaded."
"RTN","PSAPROC6",28,0)
 S DIR("??")="^D CHGYN^PSAPROC6" D ^DIR K DIR
"RTN","PSAPROC6",29,0)
 I 'Y!($G(DIRUT)) S PSACHG=0,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="" W !!,"** The invoice's status has not been changed to Processed." Q
"RTN","PSAPROC6",30,0)
 S PSACHG=+Y,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="P"
"RTN","PSAPROC6",31,0)
 W !!,"The invoice status has been changed to Processed!"
"RTN","PSAPROC6",32,0)
 Q
"RTN","PSAPROC6",33,0)
 ;
"RTN","PSAPROC6",34,0)
CORR S PSACTRL=$P(PSAERR(PSAMENU),"^",3),(PSALNCNT,PSALINES,PSACS)=0
"RTN","PSAPROC6",35,0)
 S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSARECD=$S(+$P(PSAIN,"^",11):+$P(PSAIN,"^",11),+$P(PSAIN,"^",6):+$P(PSAIN,"^",6),1:""),PSALOC=+$P(PSAIN,"^",7),PSAMV=+$P(PSAIN,"^",12)
"RTN","PSAPROC6",36,0)
 D HDR,RECD^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC6",37,0)
LOC I $P(PSAIN,"^",9)="CS" W !!,"MASTER VAULT: "_$P($G(^PSD(58.8,PSAMV,0)),"^") D MV Q:PSAOUT
"RTN","PSAPROC6",38,0)
 I $P(PSAIN,"^",10)="" D  Q:PSAOUT
"RTN","PSAPROC6",39,0)
 .D SITES^PSAUTL1 S PSALOCN=$P(^PSD(58.8,PSALOC,0),"^")_PSACOMB
"RTN","PSAPROC6",40,0)
 .W !!,"PHARMACY LOCATION: "
"RTN","PSAPROC6",41,0)
 .W:$L(PSALOCN)>76 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 !,PSALOCN D PHARM
"RTN","PSAPROC6",42,0)
LINES S PSADONE=0 F  W !!,"Line Item Numbers: " D  Q:PSAOUT!(PSADONE)
"RTN","PSAPROC6",43,0)
 .S PSALINE=0 S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  W ?19,PSALINE
"RTN","PSAPROC6",44,0)
 .F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAPROC6",45,0)
 ..I $X+$L(PSALINE)+2>79 W !,?19,PSALINE Q
"RTN","PSAPROC6",46,0)
 ..W ","_PSALINE
"RTN","PSAPROC6",47,0)
 .W ! S DIR(0)="LO",DIR("A")="Select Line Item Number",DIR("?")="Enter the line numbers to be edited",DIR("??")="^D LNHELP^PSAPROC6"
"RTN","PSAPROC6",48,0)
 .D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC6",49,0)
 .I X="" S PSADONE=1 Q
"RTN","PSAPROC6",50,0)
 .S PSALINE=X
"RTN","PSAPROC6",51,0)
 .I '$D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) W !,"Invalid line number." Q
"RTN","PSAPROC6",52,0)
 .S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC6",53,0)
 .S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),1:+$P(PSADATA,"^",6))
"RTN","PSAPROC6",54,0)
 .S PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSASUB=+$P(PSADATA,"^",7),PSASUP=0
"RTN","PSAPROC6",55,0)
 .S PSALOC=$S($P(PSADATA,"^",19)="CS":+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",7))
"RTN","PSAPROC6",56,0)
 .D EDITDISP^PSAUTL1 W !,PSASLN,!
"RTN","PSAPROC6",57,0)
 .W "1. Drug",!,"2. Quantity Received",!,"3. Order Unit",!,"4. Dispense Units per Order Unit" S PSACHO=4
"RTN","PSAPROC6",58,0)
 .I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) W !,"5. Stock Level",!,"6. Reorder Level" S PSACHO=6
"RTN","PSAPROC6",59,0)
 .W ! S DIR(0)="LO^1:"_PSACHO,DIR("A")="Edit fields",DIR("?")="Enter the number(s) of the data to be edited",DIR("??")="^D DQOR^PSAPROC6"
"RTN","PSAPROC6",60,0)
 .D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC6",61,0)
 .Q:Y=""  S PSAFLDS=Y,PSADU=0 D EDITDISP^PSAUTL1 W !,PSASLN
"RTN","PSAPROC6",62,0)
FIELDS .F PSAPCF=1:1 S PSAFLD=$P(PSAFLDS,",",PSAPCF) Q:'PSAFLD!(PSAOUT)  D
"RTN","PSAPROC6",63,0)
 ..I PSAFLD=1 D ASKDRUG^PSANDF Q
"RTN","PSAPROC6",64,0)
 ..I PSAFLD=2 D QTY^PSAPROC3 Q
"RTN","PSAPROC6",65,0)
 ..I PSAFLD=3 D GETOU^PSAPROC3 Q
"RTN","PSAPROC6",66,0)
 ..I PSAFLD=4,PSAIEN D:$P($G(^PSDRUG(PSAIEN,660)),"^",8)="" DU^PSAPROC8 D DUOU^PSAPROC3 Q
"RTN","PSAPROC6",67,0)
 ..I PSAFLD=5 D STOCK^PSAPROC8 Q
"RTN","PSAPROC6",68,0)
 ..I PSAFLD=6 D REORDER^PSAPROC8
"RTN","PSAPROC6",69,0)
 .D:'PSAOUT PROCESS
"RTN","PSAPROC6",70,0)
 Q
"RTN","PSAPROC6",71,0)
 ;
"RTN","PSAPROC6",72,0)
PROCESS ;Checks for & prompts for missing data.
"RTN","PSAPROC6",73,0)
 Q:$D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))
"RTN","PSAPROC6",74,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC6",75,0)
 S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),+$P(PSADATA,"^",6):+$P(PSADATA,"^",6),1:0),PSASUB=+$P(PSADATA,"^",7)
"RTN","PSAPROC6",76,0)
 ;If no order unit, store it.
"RTN","PSAPROC6",77,0)
 I '+$P($P(PSADATA,"^",2),"~",2),'$P(PSADATA,"^",12) D  Q:PSAOUT
"RTN","PSAPROC6",78,0)
 .I PSAIEN,PSASUB,'$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5) D GETOU^PSAPROC3 Q
"RTN","PSAPROC6",79,0)
 .I PSAIEN,'PSASUB D GETOU^PSAPROC3
"RTN","PSAPROC6",80,0)
 ;If synonym & doesn't have disp units/order unit, store it 50.
"RTN","PSAPROC6",81,0)
 I PSAIEN,PSASUB,'+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7),'+$P(PSADATA,"^",20) S PSADU=0 D DUOU^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",82,0)
 ;If no synonym & disp units/order unit, store it XTMP.
"RTN","PSAPROC6",83,0)
 I PSAIEN,'PSASUB,'$P(PSADATA,"^",20) D DUOU^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC6",84,0)
 I '+$P(PSADATA,"^",3) D PRICE^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC6",85,0)
 ;If not CS & maintains stock, prompt for stock & reorder levels
"RTN","PSAPROC6",86,0)
 I $P(PSADATA,"^",19)'="CS",+$P(PSAIN,"^",7),+$P($G(^PSD(58.8,+$P(PSAIN,"^",7),0)),"^",14) D
"RTN","PSAPROC6",87,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",3),'+$P(PSADATA,"^",27) S PSALOC=$P(PSAIN,"^",7) D STOCK^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",88,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",5),'+$P(PSADATA,"^",21) S PSALOC=$P(PSAIN,"^",7) D REORDER^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",89,0)
 ;If CS & maintains stock, prompt for stock & reorder level
"RTN","PSAPROC6",90,0)
 I $P(PSADATA,"^",19)="CS",+$P(PSAIN,"^",12),+$P($G(^PSD(58.8,+$P(PSAIN,"^",12),0)),"^",14) D
"RTN","PSAPROC6",91,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",3),'+$P(PSADATA,"^",27) S PSALOC=$P(PSAIN,"^",12) D STOCK^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",92,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",5),'+$P(PSADATA,"^",21) S PSALOC=$P(PSAIN,"^",12) D REORDER^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",93,0)
 Q:PSAOUT  D CHECK^PSANDF Q:PSAOUT  D SETLINE^PSAPROC3
"RTN","PSAPROC6",94,0)
 Q
"RTN","PSAPROC6",95,0)
 ;
"RTN","PSAPROC6",96,0)
MV ;Assigns master vault
"RTN","PSAPROC6",97,0)
 S DIC("A")="Select Master Vault: ",DIC="^PSD(58.8,",DIC(0)="QAEMZ" S:+PSAMV DIC("B")=$P($G(^PSD(58.8,+PSAMV,0)),"^")
"RTN","PSAPROC6",98,0)
 S DIC("S")="I $D(^PSD(58.8,""ADISP"",""M"",+Y)),'+$G(^PSD(58.8,+Y,""I""))!(+$G(^PSD(58.8,+Y,""I""))&(+$G(^PSD(58.8,+Y,""I""))'<DT))"
"RTN","PSAPROC6",99,0)
 D ^DIC K DIC I $G(DTOUT)!($G(DUOUT))!(Y<0) S PSAOUT=1 Q
"RTN","PSAPROC6",100,0)
 S PSAMV=+Y,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=+Y,PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC6",101,0)
 Q
"RTN","PSAPROC6",102,0)
 ;
"RTN","PSAPROC6",103,0)
PHARM ;Assigns pharmacy location
"RTN","PSAPROC6",104,0)
 S DIC("A")="Select Pharmacy Location: ",DIC="^PSD(58.8,",DIC(0)="QAEMZ" S:+PSALOC DIC("B")=$P($G(^PSD(58.8,+PSALOC,0)),"^")
"RTN","PSAPROC6",105,0)
 S DIC("S")="I $D(^PSD(58.8,""ADISP"",""P"",+Y)),'$G(^PSD(58.8,+Y,""I""))!(+$G(^PSD(58.8,+Y,""I""))&(+$G(^PSD(58.8,+Y,""I""))'<DT))"
"RTN","PSAPROC6",106,0)
 D ^DIC K DIC I $G(DTOUT)!($G(DUOUT))!(Y<0) S PSAOUT=1 Q
"RTN","PSAPROC6",107,0)
 S PSALOC=+Y,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=+Y,PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC6",108,0)
 Q
"RTN","PSAPROC6",109,0)
 ;
"RTN","PSAPROC6",110,0)
SUPPLY ;Asks if all items are supply items. If so, invoice is deleted from
"RTN","PSAPROC6",111,0)
 ;^XTMP global. If not, invoice is added to list of invoices to be edited.
"RTN","PSAPROC6",112,0)
 W ! S DIR(0)="Y",DIR("A")="Are all the items on the invoice supply items",DIR("B")="N"
"RTN","PSAPROC6",113,0)
 S DIR("?",1)="Enter YES if all line items are not drugs in the DRUG file.",DIR("?")="Enter NO if there is at least one line item that is in the DRUG file."
"RTN","PSAPROC6",114,0)
 S DIR("??")="^D ALLSUP^PSAPROC6" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC6",115,0)
 G:'Y NO
"RTN","PSAPROC6",116,0)
 W ! S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="Y",DIR("?",1)="Enter YES if all the line items on the invoice are supply items.",DIR("?")="Enter NO if there is at least one item on the invoice that is not a supply."
"RTN","PSAPROC6",117,0)
 S DIR("??")="^D ALLSUP^PSAPROC6" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC6",118,0)
NO I 'Y S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=PSAOK(PSA) K PSAOK(PSA) Q
"RTN","PSAPROC6",119,0)
 K PSAOK(PSA) S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="P",PSASUP=1,PSALINE=0
"RTN","PSAPROC6",120,0)
 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAPROC6",121,0)
 .S ^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")=DUZ_"^"_DT_"^"_"SUPPLY ITEM",$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P"
"RTN","PSAPROC6",122,0)
 Q
"RTN","PSAPROC6",123,0)
 ;
"RTN","PSAPROC6",124,0)
HDR ;Screen header
"RTN","PSAPROC6",125,0)
 W @IOF,!?26,"<<< EDIT INVOICE SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAPROC6",126,0)
 Q
"RTN","PSAPROC6",127,0)
 ;
"RTN","PSAPROC6",128,0)
CHGYN ;Extended help - 'Do you want to change the invoice's status to Processed'
"RTN","PSAPROC6",129,0)
 W !?5,"Enter YES if the invoice is completely correct. You will not be able",!?5,"to edit it again."
"RTN","PSAPROC6",130,0)
 W !!?5,"Enter NO if you need to edit the invoice again. You can edit it again",!?5,"by selecting the Process Orders option."
"RTN","PSAPROC6",131,0)
 Q
"RTN","PSAPROC6",132,0)
DQOR ;Extended help - 'Edit field'
"RTN","PSAPROC6",133,0)
 W !?5,"Enter the number or range of numbers of the field you want to edit."
"RTN","PSAPROC6",134,0)
 Q
"RTN","PSAPROC6",135,0)
LNHELP ;Extended help - 'Line Number"
"RTN","PSAPROC6",136,0)
 W !?5,"Enter the number of the item on the invoice you want to edit. You can",!?5,"enter a line item number then edit that line item. The ""Line Number""",!?5,"prompt will be displayed again. You can keep entering and editing line"
"RTN","PSAPROC6",137,0)
 W !?5,"items until you press the Return key at the ""Line Number"" prompt."
"RTN","PSAPROC6",138,0)
 Q
"RTN","PSAPROC6",139,0)
ALLSUP ;Extended help - "Are all the items on the invoice supply items" &
"RTN","PSAPROC6",140,0)
 ;"Are you sure?"
"RTN","PSAPROC6",141,0)
 W !!?5,"Enter YES if none of the line items on the invoice are",!?5,"in the DRUG file and will never be in the DRUG file.",!!?5,"Enter NO if there is at least one line item on the",!?5,"invoice that is in the DRUG file."
"RTN","PSAPROC6",142,0)
 Q
"RTN","PSAPROC7")
0^7^B33007966
"RTN","PSAPROC7",1,0)
PSAPROC7 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;9/6/97
"RTN","PSAPROC7",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC7",3,0)
 ;This routine takes the data in XTMP and moves it to DA ORDERS file.
"RTN","PSAPROC7",4,0)
 ;It deletes the data in XTMP after it is copies.
"RTN","PSAPROC7",5,0)
 ;
"RTN","PSAPROC7",6,0)
 G INVOICE
"RTN","PSAPROC7",7,0)
 ;
"RTN","PSAPROC7",8,0)
 S ZTDESC="Drug Acct. - Process Prime Vendor Invoices",ZTDTH=$H,ZTRTN="INVOICE^PSAPROC7",ZTIO="" S PSADUZ=DUZ,ZTSAVE("PSADUZ")=""
"RTN","PSAPROC7",9,0)
 D ^%ZTLOAD S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAPROC7",10,0)
 Q
"RTN","PSAPROC7",11,0)
 ;
"RTN","PSAPROC7",12,0)
INVOICE S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC7",13,0)
 .S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")) Q:PSAIN=""
"RTN","PSAPROC7",14,0)
 .Q:$P(PSAIN,"^",8)'="P"
"RTN","PSAPROC7",15,0)
 .S PSAORD=$P(PSAIN,"^",4),PSAIEN=+$O(^PSD(58.811,"B",PSAORD,0)),PSACRED=0
"RTN","PSAPROC7",16,0)
 .I 'PSAIEN D
"RTN","PSAPROC7",17,0)
 ..F  L +^PSD(58.811,0):0 I  Q
"RTN","PSAPROC7",18,0)
 ..S DIC="^PSD(58.811,",DIC(0)="XL",X=PSAORD,DLAYGO=58.811 D ^DIC K DIC,DLAYGO L -^PSD(58.811,0) S PSAIEN=+Y
"RTN","PSAPROC7",19,0)
 .F  L +^PSD(58.811,PSAIEN,0):10 I  Q
"RTN","PSAPROC7",20,0)
 .S:'$D(^PSD(58.811,PSAIEN,1,0)) DIC("P")=$P(^DD(58.811,2,0),"^",2)
"RTN","PSAPROC7",21,0)
 .S DA(1)=PSAIEN,DIC="^PSD(58.811,"_DA(1)_",1,",DIC(0)="L",X=$P(PSAIN,"^",2),DLAYGO=58.811 D ^DIC K DA,DLAYGO S PSAIEN1=+Y
"RTN","PSAPROC7",22,0)
 .S DA(1)=PSAIEN,DA=PSAIEN1,DIE=DIC K DIC
"RTN","PSAPROC7",23,0)
 .S PSALOCDR=$P($G(PSAIN),"^",7)
"RTN","PSAPROC7",24,0)
 .S PSADELDR=$P($G(PSAIN),"^",6)
"RTN","PSAPROC7",25,0)
 .S PSACSDR=$S($P(PSAIN,"^",10)="ALL CS":"A",$P(PSAIN,"^",9)="CS":"S",1:"N")
"RTN","PSAPROC7",26,0)
 .S PSARECD=$P($G(PSAIN),"^",11)
"RTN","PSAPROC7",27,0)
 .S PSAMV=$S(+$P(PSAIN,"^",12):$P(PSAIN,"^",12),1:"")
"RTN","PSAPROC7",28,0)
 .S PSASUP=$S($P(PSAIN,"^",13)="SUP":1,1:"")
"RTN","PSAPROC7",29,0)
 .;
"RTN","PSAPROC7",30,0)
 .S ^PSD(58.811,DA(1),1,DA,0)=$P(^(0),"^")_"^"_$P(PSAIN,"^",1)_"^P^"_$P(PSAIN,"^",3)_"^"_$G(PSALOCDR)_"^"_$G(PSADELDR)_"^"_$G(PSARECD)_"^"_$G(PSACSDR)_"^^"_DUZ_"^^"_$G(PSAMV)_"^"_$G(PSASUP)
"RTN","PSAPROC7",31,0)
 .S DIK=DIE D IX^DIK
"RTN","PSAPROC7",32,0)
 .S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D LINE
"RTN","PSAPROC7",33,0)
 .I PSACRED K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10///^S X=1" D ^DIE K DIE
"RTN","PSAPROC7",34,0)
 .S $P(^PSD(58.811,PSAIEN,0),"^",2)=$P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")
"RTN","PSAPROC7",35,0)
 .I $P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")="BBC" S $P(^PSD(58.811,PSAIEN,0),"^",2)="Bergen Brunswig Corporation"
"RTN","PSAPROC7",36,0)
 .L -^PSD(58.811,PSAIEN,0)
"RTN","PSAPROC7",37,0)
 .K ^XTMP("PSAPV",PSACTRL)
"RTN","PSAPROC7",38,0)
EXIT I '$O(^XTMP("PSAPV",0)) K ^XTMP("PSAPV")
"RTN","PSAPROC7",39,0)
 K DA,DD,DIC,DIE,DO,DR,PSACRED,PSACTRL,PSACS,PSACSDR,PSADATA,PSADELDR,PSADJ,PSADT,PSADUZ,PSAFLD,PSAIEN,PSAIEN1,PSAIEN2,PSAIEN3,PSAIN
"RTN","PSAPROC7",40,0)
 K PSALINE,PSALOCDR,PSAMV,PSANDC,PSAORD,PSAREA,PSARECD,PSASNODE,PSASUP,PSAUNIT,PSAUPC,PSAVSN,X,Y,ZTDESC,ZTDTH,ZTRTN
"RTN","PSAPROC7",41,0)
 Q
"RTN","PSAPROC7",42,0)
 ;
"RTN","PSAPROC7",43,0)
LINE ;Files line items.
"RTN","PSAPROC7",44,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE) S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)) DIC("P")=$P(^DD(58.8112,5,0),"^",2)
"RTN","PSAPROC7",45,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,(DA,X)=PSALINE,DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN2=+Y K DA,DIC,DLAYGO
"RTN","PSAPROC7",46,0)
 ;
"RTN","PSAPROC7",47,0)
 ;DAVEB PSA*3*3 (5may98)
"RTN","PSAPROC7",48,0)
 S PSADRG=$P($G(PSADATA),"^",6)
"RTN","PSAPROC7",49,0)
 S PSASYN=$P($G(PSADATA),"^",7)
"RTN","PSAPROC7",50,0)
 K PSAUNIT
"RTN","PSAPROC7",51,0)
 I $G(PSASYN)'="",$G(PSADRG)'="" S PSAUNIT=+$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",5)
"RTN","PSAPROC7",52,0)
 S PSAUNIT=$S(+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),$D(PSAUNIT):PSAUNIT,1:0)
"RTN","PSAPROC7",53,0)
 S PSACS=$S($P(PSADATA,"^",19)="CS":1,1:0),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSAUPC=$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",54,0)
 I PSANDC="",$P($P(PSADATA,"^",26),"~")'="" S PSANDC="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",55,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=PSAIEN2,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAPROC7",56,0)
 ;S DR="2///^S X="_+PSADATA_$S(PSANDC'="":";13///^S X=PSANDC",1:"")_$S(PSAVSN'="":";14///^S X=PSAVSN",1:"")_$S(PSAUPC'="":";15///^S X=PSAUPC",1:"") D ^DIE
"RTN","PSAPROC7",57,0)
 ;S DR="12///^S X="_PSACS_$S(+$P(PSADATA,"^",6):";1///^S X="_$P(PSADATA,"^",6),1:"")_$S(+PSAUNIT:";3///^S X="_+PSAUNIT,1:"")_";4///^S X="_+$P(PSADATA,"^",3)_";5////^S X="_DT_";6///^S X="_DUZ
"RTN","PSAPROC7",58,0)
 ;D ^DIE K DIE
"RTN","PSAPROC7",59,0)
 ;PSA*3*7
"RTN","PSAPROC7",60,0)
 ;DaveB (4may98) hard code filing data
"RTN","PSAPROC7",61,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",3)=+PSADATA
"RTN","PSAPROC7",62,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",11)=PSANDC
"RTN","PSAPROC7",63,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",12)=PSAVSN
"RTN","PSAPROC7",64,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",13)=PSAUPC
"RTN","PSAPROC7",65,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",10)=PSACS
"RTN","PSAPROC7",66,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",2)=PSADRG
"RTN","PSAPROC7",67,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",4)=PSAUNIT
"RTN","PSAPROC7",68,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",5)=$P(PSADATA,"^",3)
"RTN","PSAPROC7",69,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",6)=DT
"RTN","PSAPROC7",70,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",7)=DUZ
"RTN","PSAPROC7",71,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",72,0)
 ;End PSA*3*7
"RTN","PSAPROC7",73,0)
 ;
"RTN","PSAPROC7",74,0)
 I +$P(PSADATA,"^",15)!($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))) D ADJDRUG
"RTN","PSAPROC7",75,0)
 I $P(PSADATA,"^",8)'="" D QTY
"RTN","PSAPROC7",76,0)
 I +$P(PSADATA,"^",12) D OU
"RTN","PSAPROC7",77,0)
 I +$P(PSADATA,"^",23) D PRICE
"RTN","PSAPROC7",78,0)
 ;Adds the reorder level and/or dispense units per order unit
"RTN","PSAPROC7",79,0)
 I +$P(PSADATA,"^",7)!(+$P(PSADATA,"^",20))!(+$P(PSADATA,"^",21))!(+$P(PSADATA,"^",27)) D
"RTN","PSAPROC7",80,0)
 .S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,2)=$P(PSADATA,"^",20)_"^"_$P(PSADATA,"^",21)_"^"_$S(+$P(PSADATA,"^",7):+$P(PSADATA,"^",7),1:0)_"^"_+$P(PSADATA,"^",27)
"RTN","PSAPROC7",81,0)
 K ^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC7",82,0)
 Q
"RTN","PSAPROC7",83,0)
ADJDRUG ;Records adjusted drug received
"RTN","PSAPROC7",84,0)
 S PSAFLD="D"
"RTN","PSAPROC7",85,0)
 I +$P(PSADATA,"^",15) S PSADJ=+$P(PSADATA,"^",15),PSADUZ=+$P(PSADATA,"^",16),PSADT=+$P(PSADATA,"^",17),PSAREA="" D RECORD Q
"RTN","PSAPROC7",86,0)
 I $D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")) S PSASNODE=^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),PSADJ=$P(PSASNODE,"^",3),PSADUZ=+$P(PSASNODE,"^"),PSADT=+$P(PSASNODE,"^",2),PSAREA="" D RECORD
"RTN","PSAPROC7",87,0)
 Q
"RTN","PSAPROC7",88,0)
OU ;Records adjusted order unit
"RTN","PSAPROC7",89,0)
 S PSAFLD="O",PSADJ=+$P(PSADATA,"^",12),PSADUZ=+$P(PSADATA,"^",13),PSADT=+$P(PSADATA,"^",14),PSAREA=""
"RTN","PSAPROC7",90,0)
 D RECORD
"RTN","PSAPROC7",91,0)
 Q
"RTN","PSAPROC7",92,0)
PRICE ;Records adjusted price per order unit
"RTN","PSAPROC7",93,0)
 S PSAFLD="P",PSADJ=+$P(PSADATA,"^",23),PSADUZ=+$P(PSADATA,"^",24),PSADT=+$P(PSADATA,"^",25),PSAREA=""
"RTN","PSAPROC7",94,0)
 S:PSADJ'=+$P(PSADATA,"^",3) PSACRED=1
"RTN","PSAPROC7",95,0)
 D RECORD
"RTN","PSAPROC7",96,0)
 Q
"RTN","PSAPROC7",97,0)
QTY ;Records adjusted quantity received.
"RTN","PSAPROC7",98,0)
 S PSAFLD="Q",PSADJ=+$P(PSADATA,"^",8),PSADUZ=+$P(PSADATA,"^",9),PSADT=+$P(PSADATA,"^",10),PSAREA=$P(PSADATA,"^",11)
"RTN","PSAPROC7",99,0)
 S:PSADJ'=+$P(PSADATA,"^") PSACRED=1
"RTN","PSAPROC7",100,0)
 D RECORD
"RTN","PSAPROC7",101,0)
 Q
"RTN","PSAPROC7",102,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAPROC7",103,0)
 K DA S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSAIEN2,X=PSAFLD
"RTN","PSAPROC7",104,0)
 S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2)
"RTN","PSAPROC7",105,0)
 S DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN3=+Y K DLAYGO
"RTN","PSAPROC7",106,0)
 ;
"RTN","PSAPROC7",107,0)
 ;PSA*3*3
"RTN","PSAPROC7",108,0)
 ;DAVEB Hard code filing
"RTN","PSAPROC7",109,0)
 S DIE=DIC,DA=PSAIEN3
"RTN","PSAPROC7",110,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",2)=PSADJ
"RTN","PSAPROC7",111,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",3)=$G(PSAREA)
"RTN","PSAPROC7",112,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",4)=DT
"RTN","PSAPROC7",113,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",5)=DUZ
"RTN","PSAPROC7",114,0)
 ;
"RTN","PSAPROC7",115,0)
 ;S DIE=DIC,DA=PSAIEN3,DR="1///"_PSADJ_$S(PSAREA'="":";2////^S X=PSAREA",1:"")_";3///^S X="_PSADT_";4///^S X="_PSADUZ K DIC D ^DIE
"RTN","PSAPROC7",116,0)
 S DIK=DIE,DA=PSAIEN3 D IX1^DIK K DA,DIE,DIK,PSAFLD
"RTN","PSAPROC7",117,0)
 Q
"RTN","PSAPROC8")
0^32^B42292090
"RTN","PSAPROC8",1,0)
PSAPROC8 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC8",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPROC8",3,0)
 ;This routine processes uploaded invoices.
"RTN","PSAPROC8",4,0)
 ;
"RTN","PSAPROC8",5,0)
DU ;Prompts Dispense Unit if blank
"RTN","PSAPROC8",6,0)
 F  L +^PSDRUG(PSAIEN,0):0 I  Q
"RTN","PSAPROC8",7,0)
 S DIE="^PSDRUG(",DA=PSAIEN,DR=14.5 D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",8,0)
 I +$P($G(^PSDRUG(PSAIEN,660)),"^",8) D  G DU
"RTN","PSAPROC8",9,0)
 .F  L +^PSDRUG(PSAIEN,0):0 I  Q
"RTN","PSAPROC8",10,0)
 .S DIE="^PSDRUG(",DA=PSAIEN,DR="14.5///@" D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",11,0)
 I $P($G(^PSDRUG(PSAIEN,660)),"^",8)'="" S PSADU=1 Q
"RTN","PSAPROC8",12,0)
 ;
"RTN","PSAPROC8",13,0)
 W !,"The dispense units must be entered to change",!,"the status of the invoice to Processed."
"RTN","PSAPROC8",14,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the dispense units now",DIR("?",1)="Enter Yes to return to the DISPENSE UNIT prompt.",DIR("?")="Enter No to bypass entering the dispense units now."
"RTN","PSAPROC8",15,0)
 S DIR("??")="^D DISPYN^PSAPROC8" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC8",16,0)
 G:+Y DU
"RTN","PSAPROC8",17,0)
 Q
"RTN","PSAPROC8",18,0)
 ;
"RTN","PSAPROC8",19,0)
DUOU ;Gets Dispense Units per Order Unit
"RTN","PSAPROC8",20,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)
"RTN","PSAPROC8",21,0)
 S PSADU=1
"RTN","PSAPROC8",22,0)
 F  L +^PSDRUG(PSAIEN,0):0 I  Q
"RTN","PSAPROC8",23,0)
 S DIE="^PSDRUG("_PSAIEN_",1,",DA(1)=PSAIEN,DA=+PSASUB,DR=403 D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",24,0)
 I $D(Y)!($G(DTOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",25,0)
 Q:+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7)
"RTN","PSAPROC8",26,0)
 ;
"RTN","PSAPROC8",27,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A",1)="The dispense units per order unit must be entered to change the ",DIR("A")="status of the invoice to Processed. Do you want to enter the data now"
"RTN","PSAPROC8",28,0)
 S DIR("?",1)="Enter Yes to return to the "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)_"s per "_$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",2),0)),"^",2)_" prompt."
"RTN","PSAPROC8",29,0)
 S DIR("?")="Enter No to bypass entering the dispense units now.",DIR("??")="^D DUOUYN^PSAPROC8"
"RTN","PSAPROC8",30,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",31,0)
 G:+Y DUOU
"RTN","PSAPROC8",32,0)
 Q
"RTN","PSAPROC8",33,0)
OK ;
"RTN","PSAPROC8",34,0)
 S PSACNTOK=PSACNTOK+1,PSAOK(PSACNTOK)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC8",35,0)
 Q
"RTN","PSAPROC8",36,0)
PRICE ;Price per Order Unit changed
"RTN","PSAPROC8",37,0)
 S PSAIPR=$L($FN($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3),",",2)),PSAFPR=$L($FN($P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),",",2))
"RTN","PSAPROC8",38,0)
 S PSAJUST=$S(PSAIPR>PSAFPR:PSAIPR,1:PSAFPR)
"RTN","PSAPROC8",39,0)
 W !!,"Price per Order Unit -- Invoice's: $"_$J($FN($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3),",",2),PSAJUST,2),!?24,"File's   : $"_$J($FN($P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),",",2),PSAJUST,2),!
"RTN","PSAPROC8",40,0)
 S DIR(0)="Y",DIR("A")="Is the invoice's price per order unit correct",DIR("B")="Y",DIR("?",1)="Enter Yes if "_$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3)_" is correct."
"RTN","PSAPROC8",41,0)
 S DIR("?")="Enter No to keep the file's price per order unit.",DIR("??")="^D PRICEOU^PSAPROC1" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC8",42,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",22)=+Y
"RTN","PSAPROC8",43,0)
 I '+Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",23)=+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",24)=DUZ,$P(^(PSALINE),"^",25)=DT
"RTN","PSAPROC8",44,0)
 Q
"RTN","PSAPROC8",45,0)
 ;
"RTN","PSAPROC8",46,0)
REORDER ;Enter reorder level for drug if the field is blank.
"RTN","PSAPROC8",47,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(+PSAIEN,660)),"^",8)
"RTN","PSAPROC8",48,0)
 S PSADU=1,DIR(0)="NO^0:99999",DIR("A")="REORDER LEVEL IN "_$P($G(^PSD(58.8,PSALOC,0)),"^")
"RTN","PSAPROC8",49,0)
 S DIR("?")="Enter the minimum number of dispense units to keep in the "_$S($P(PSADATA,"^",19)="CS":"master vault.",1:"pharmacy location."),DIR("??")="^D REORD^PSAPROC8"
"RTN","PSAPROC8",50,0)
 S DIR("B")=$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",5):$P(^PSD(58.8,PSALOC,1,PSAIEN,0),"^",5),1:"")
"RTN","PSAPROC8",51,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",52,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",21)=+Y
"RTN","PSAPROC8",53,0)
 Q
"RTN","PSAPROC8",54,0)
 ;
"RTN","PSAPROC8",55,0)
STOCK ;Enter stock level for drug if the field is blank.
"RTN","PSAPROC8",56,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(+PSAIEN,660)),"^",8)
"RTN","PSAPROC8",57,0)
 S PSADU=1,DIR(0)="NO^0:99999",DIR("A")="STOCK LEVEL IN "_$P($G(^PSD(58.8,+PSALOC,0)),"^")
"RTN","PSAPROC8",58,0)
 S DIR("?")="Enter the minimum number of dispense units to keep on the shelf",DIR("??")="^D STKLEVEL^PSAPROC8"
"RTN","PSAPROC8",59,0)
 S DIR("B")=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",3):$P(^PSD(58.8,PSALOC,1,PSAIEN,0),"^",3),1:"")
"RTN","PSAPROC8",60,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",61,0)
 Q:$G(DIRUT)
"RTN","PSAPROC8",62,0)
 S:+Y $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",27)=+Y
"RTN","PSAPROC8",63,0)
 Q
"RTN","PSAPROC8",64,0)
 ;
"RTN","PSAPROC8",65,0)
DISPYN ;Extended help to enter dispense units
"RTN","PSAPROC8",66,0)
 W !?5,"Enter Yes if you want to enter the dispense units now.",!!?5,"Enter No to bypass entering the dispense units. The invoice will not",!?5,"be placed in a Processed status if the dispense units are not entered."
"RTN","PSAPROC8",67,0)
 Q
"RTN","PSAPROC8",68,0)
DUOUYN ;Extended help to enter dispense units per order units
"RTN","PSAPROC8",69,0)
 W !?5,"Enter Yes if you want to enter the dispense units per order unit now.",!!?5,"Enter No to bypass entering the dispense units per order unit. The"
"RTN","PSAPROC8",70,0)
 W !?5,"invoice will not be placed in a "_$S($D(PSABEFOR):"Verified",1:"Processed")_" status if the dispense units",!?5,"are not entered."
"RTN","PSAPROC8",71,0)
 Q
"RTN","PSAPROC8",72,0)
PRICEOU ;Extended help to 'Is invoice's price per order unit correct'
"RTN","PSAPROC8",73,0)
 W !?5,"Enter Yes if the invoice's price per order unit is correct. The",!?5,"invoice's price per order unit will be entered into the DRUG file."
"RTN","PSAPROC8",74,0)
 W !!?5,"Enter No if the invoice's price per order unit is not correct.",!?5,"The DRUG file's price per order unit will remain the same."
"RTN","PSAPROC8",75,0)
 Q
"RTN","PSAPROC8",76,0)
REORD ;Extended help for 'Reorder level'
"RTN","PSAPROC8",77,0)
 W !?5,"Enter the lowest amount of "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)_"s to keep in the "_$S($P(PSADATA,"^",19)="CS":"master vault",1:"pharmacy location")_"."
"RTN","PSAPROC8",78,0)
 W !!?5,"When the amount on hand is lower than the reorder level, a mail",!?5,"message will be sent showing the drug name, reorder level, and",!?5,"quantity on hand."
"RTN","PSAPROC8",79,0)
 Q
"RTN","PSAPROC8",80,0)
STKLEVEL ;Extended help for 'Stock level'
"RTN","PSAPROC8",81,0)
 W !?5,"Enter the ideal number of dispense units to keep on the shelf. When the",!?5,"number of dispense units is equal to or less than the reorder level, the"
"RTN","PSAPROC8",82,0)
 W !?5,"amount to order is determined by subtracting the current number of dispense",!?5,"units from the stock level."
"RTN","PSAPROC8",83,0)
 Q
"RTN","PSAPSI")
0^37^B33420061
"RTN","PSAPSI",1,0)
PSAPSI ;BIR/LTL-IV Dispensing (Single Drug) ;7/23/97
"RTN","PSAPSI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPSI",3,0)
 ;This routine gathers IV dispensing data for a single drug.
"RTN","PSAPSI",4,0)
 ;
"RTN","PSAPSI",5,0)
 K PSAQUIT D PSAWARN I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAPSI",6,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAPG,PSAW,PSAIV,PSAOUT,PSADT,DA,PSADRUG,PSADRUGN,PSALN,PSAQ,PSAR,X,Y
"RTN","PSAPSI",7,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G QUIT
"RTN","PSAPSI",8,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G QUIT
"RTN","PSAPSI",9,0)
 D NOW^%DTC S PSADT=X,X="T-60" D ^%DT S PSADT(1)=Y
"RTN","PSAPSI",10,0)
 F  W ! S DIC="^PSD(58.8,+PSALOC,1,",DA(1)=PSALOC,DIC(0)="AEQ",DIC("A")="Please select "_PSALOCN_" drug: " D ^DIC G:Y<0 QUIT S PSADRUG=+Y,(PSAIV,PSADT(2))=0 D  G:$G(PSAOUT) QUIT D DEV
"RTN","PSAPSI",11,0)
 .I '$O(^PS(52.6,"AC",+PSADRUG,0))&('$O(^PS(52.7,"AC",+PSADRUG,0))) W !!,"This drug is not linked to an entry in the IV ADDITIVE or SOLUTION file.",!! S PSAOUT=1 Q
"RTN","PSAPSI",12,0)
 .S PSADRUG(1)=$O(^PS(52.6,"AC",+PSADRUG,0))
"RTN","PSAPSI",13,0)
 .S PSADRUG(2)=$O(^PS(52.7,"AC",+PSADRUG,0))
"RTN","PSAPSI",14,0)
 .D:'$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,3)  Q:$G(PSAOUT)
"RTN","PSAPSI",15,0)
 ..W !!,"IV dispensing data has never been collected for this drug.",!!
"RTN","PSAPSI",16,0)
 ..S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-60"  D ^DIR K DIR S (PSADT(2),PSAR)=Y,(PSADT(3),PSAR(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAPSI",17,0)
 .I '$G(PSADT(2)) S PSADT(2)=$P($P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,3),","),PSADT(3)=0,PSA(7)=1
"RTN","PSAPSI",18,0)
 .S PSAW=PSADT(3)
"RTN","PSAPSI",19,0)
 .F  S PSAIV=$O(^PS(50.8,PSAIV)) Q:'PSAIV  F PSADT(4)=PSADT(2):0 S PSADT(4)=$O(^PS(50.8,+PSAIV,2,PSADT(4))) Q:'PSADT(4)  D  D:$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.7,+PSADRUG(2),0)) ^PSAPSI5
"RTN","PSAPSI",20,0)
 ..Q:'$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI",21,0)
 ..S PSADRUG(3)=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI",22,0)
 ..F  S PSAW=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW)) Q:'PSAW  S PSAW(1)=PSAW D:$O(^PSD(58.8,"AB",PSAW,0))=PSALOC
"RTN","PSAPSI",23,0)
 ...S PSAQ=$G(PSAQ)+$P($G(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW,0)),U,2)-$P($G(^(0)),U,5)
"RTN","PSAPSI",24,0)
 ..S:$G(PSAQ) ^TMP("PSA",$J,+PSADRUG,PSADT(4))=$G(^TMP("PSA",$J,+PSADRUG,PSADT(4)))+PSAQ S (PSAQ,PSAW)=0
"RTN","PSAPSI",25,0)
DEV I '$D(^TMP("PSA",$J,+PSADRUG)) W !!,"Sorry, no dispensing for this drug has been compiled since " S Y=$G(PSADT(2)) X ^DD("DD") W $S(Y]"":Y,1:"ever"),".",!! D  G QUIT
"RTN","PSAPSI",26,0)
 .W "The Compile IV Costs in Background option is scheduled to run "
"RTN","PSAPSI",27,0)
 .S Y=$P($G(^DIC(19,+$O(^DIC(19,"B","PSJI BACKGROUND JOB",0)),200)),U)
"RTN","PSAPSI",28,0)
 .X ^DD("DD") W $S(Y:Y,1:"*not scheduled*"),"."
"RTN","PSAPSI",29,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR G:$D(DIRUT) QUIT G:Y'=1 TR
"RTN","PSAPSI",30,0)
 K IO("Q"),DIC N %ZIS,IOP,POP S %ZIS="0Q" I Y=1 W ! D ^%ZIS
"RTN","PSAPSI",31,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G QUIT
"RTN","PSAPSI",32,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAPSI",ZTDESC="Daily drug dispensing log",(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS G QUIT
"RTN","PSAPSI",33,0)
LUP S (PSAPG,PSAOUT)=0,PSADRUG(1)=$P($G(^PSDRUG(+PSADRUG,660)),U,6),PSADRUG(2)=$P($G(^(660)),U,8)
"RTN","PSAPSI",34,0)
 S X=PSADRUG(1),X2="3$" D COMMA^%DTC S PSADRUG(3)=X
"RTN","PSAPSI",35,0)
 D HEADER
"RTN","PSAPSI",36,0)
 S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,+PSADRUG,PSA(4))) Q:'PSA(4)  D:$Y+5>IOSL HEADER G:PSAOUT STOP S PSA(6)=PSA(6)+1,Y=PSA(4) X ^DD("DD") D
"RTN","PSAPSI",37,0)
 .W !!,Y
"RTN","PSAPSI",38,0)
 .S (X,PSADRUG(6))=$G(^TMP("PSA",$J,+PSADRUG,PSA(4))),X2=0
"RTN","PSAPSI",39,0)
 .S:$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,4) X=X/$P($G(^(6)),U,4)
"RTN","PSAPSI",40,0)
 .S PSADRUG(4)=$G(PSADRUG(4))+X
"RTN","PSAPSI",41,0)
 .D COMMA^%DTC W ?14,X,PSADRUG(2),?40,PSADRUG(3),"/",PSADRUG(2),?63
"RTN","PSAPSI",42,0)
 .S X=X*PSADRUG(1),PSADRUG(5)=$G(PSADRUG(5))+X,X2="2$" D COMMA^%DTC W ?40,X
"RTN","PSAPSI",43,0)
 W !,PSALN,!,PSA(6)," DAY TOTALS: " S X=PSADRUG(4),X2=0 D COMMA^%DTC W ?5,X,PSADRUG(2)
"RTN","PSAPSI",44,0)
 S X=PSADRUG(5),X2="2$" D COMMA^%DTC W ?63,X
"RTN","PSAPSI",45,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAPSI",46,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSAPSI",47,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAPSI",48,0)
 W:'$G(PSAOUT) !!,"Updating transaction history and dispensing totals."
"RTN","PSAPSI",49,0)
TR I '$G(PSAOUT) S ZTIO="",ZTRTN="^PSAPSI1",ZTDESC="Update dispensing totals",ZTDTH=$H,(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAPSI",50,0)
QUIT K:$G(PSADRUG) ^TMP("PSA",$J,+PSADRUG),PSADRUG K PSA
"RTN","PSAPSI",51,0)
 Q
"RTN","PSAPSI",52,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAPSI",53,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAPSI",54,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,?2,"DAILY DISPENSING TOTALS FOR ",$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAPSI",55,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!
"RTN","PSAPSI",56,0)
 W "DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAPSI",57,0)
 Q
"RTN","PSAPSI",58,0)
 ;
"RTN","PSAPSI",59,0)
PSAWARN ;DAVEB (PSA*3*3)
"RTN","PSAPSI",60,0)
 ;
"RTN","PSAPSI",61,0)
 W @IOF,!!,?30," ** W A R N I N G **",!!,"Execution of this option should only be done for either one of the following:",!
"RTN","PSAPSI",62,0)
 W !,"1. The ""All Location Dispense/Purge"", [PSA IV ALL LOCATIONS] nightly back-"
"RTN","PSAPSI",63,0)
 W !,"   ground option has failed to run.",!!,"2. New drugs have been added to a pharmacy location, and you would like to see",!,"   the dispensing activity that has occurred for up to the last sixty days.",!
"RTN","PSAPSI",64,0)
 W !!,"Each time this option is executed, the balances are updated in the MONTHLY",!,"ACTIVITY multiple within the DRUG ACCOUNTABILITY STATS file (#58.8)."
"RTN","PSAPSI",65,0)
 W !!,"The proram will continue to add or subtract the dispensed amount each time the ",!,"option is used.",!
"RTN","PSAPSI",66,0)
ASK S DIR(0)="Y",DIR("A")="Do you really want to run this option",DIR("B")="NO" D ^DIR K DIR I $D(DIRUT) S PSAQUIT=1 Q
"RTN","PSAPSI",67,0)
 I Y'>0 S PSAQUIT=1 Q
"RTN","PSAPSI",68,0)
 K PSAQUIT Q
"RTN","PSAPSI2")
0^39^B25063127
"RTN","PSAPSI2",1,0)
PSAPSI2 ;BIR/LTL-IV Dispensing (All Drugs) ;7/23/97
"RTN","PSAPSI2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPSI2",3,0)
 ;This routine gathers IV dispensing for all drugs in a pharmacy location.
"RTN","PSAPSI2",4,0)
 ;
"RTN","PSAPSI2",5,0)
 K PSAQUIT D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAPSI2",6,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAPG,PSALN,PSALOCN,PSAS,PSA,PSAOUT,PSADT,DA,PSADRUG,PSADRUGN,PSAQ,PSAIV,PSAW,X,X2,Y,ZTSK
"RTN","PSAPSI2",7,0)
LOOK D ^PSADA G:'$G(PSALOC) QUIT
"RTN","PSAPSI2",8,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G QUIT
"RTN","PSAPSI2",9,0)
 D NOW^%DTC S PSADT=X,X="T-60" D ^%DT S PSADT(1)=Y,(PSAPG,PSAOUT,PSADRUG)=0
"RTN","PSAPSI2",10,0)
 S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-60"  D ^DIR K DIR S (PSADT(2),PSAR)=Y,(PSADT(3),PSAR(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAPSI2",11,0)
 S (PSADT(22),PSADT(23),PSAIV)=0
"RTN","PSAPSI2",12,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) STOP
"RTN","PSAPSI2",13,0)
 I Y'=1 S PSA(5)=1,ZTIO="",ZTRTN="LUP^PSAPSI2",ZTDESC="DA drug disp",ZTSAVE("PSA*")="",ZTDTH=$H D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G STOP
"RTN","PSAPSI2",14,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="0Q" I Y=1 W ! D ^%ZIS
"RTN","PSAPSI2",15,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G QUIT
"RTN","PSAPSI2",16,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH S ZTRTN="LUP^PSAPSI2",ZTDESC="Daily drug dispensing",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G STOP
"RTN","PSAPSI2",17,0)
LUP F  S PSADRUG=$O(^PSD(58.8,+PSALOC,1,PSADRUG)) Q:'PSADRUG  D:$Y+5>$G(IOSL)&('$G(PSA(5))) HEADER G:$G(PSAOUT) STOP D:$S($P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,14):$P($G(^(0)),U,14)>DT,1:1)  D:$D(^TMP("PSA",$J,+PSADRUG)) TASK
"RTN","PSAPSI2",18,0)
 .Q:$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,3)
"RTN","PSAPSI2",19,0)
 .S PSADRUGN=$P($G(^PSDRUG(+PSADRUG,0)),U),PSAIV=0
"RTN","PSAPSI2",20,0)
 .I '$G(PSA(5))&('$G(PSAPG)) W @IOF D HEADER
"RTN","PSAPSI2",21,0)
 .S PSADT(3)=0,PSA(7)=1
"RTN","PSAPSI2",22,0)
 .I '$O(^PS(52.6,"AC",+PSADRUG,0))&('$O(^PS(52.7,"AC",+PSADRUG,0)))&('$G(PSA(5))) Q
"RTN","PSAPSI2",23,0)
 .S PSADRUG(1)=$O(^PS(52.6,"AC",+PSADRUG,0))
"RTN","PSAPSI2",24,0)
 .S PSADRUG(2)=$O(^PS(52.7,"AC",+PSADRUG,0))
"RTN","PSAPSI2",25,0)
 .S PSAW=PSADT(3)
"RTN","PSAPSI2",26,0)
 .F  S PSAIV=$O(^PS(50.8,PSAIV)) Q:'PSAIV  F PSADT(4)=PSADT(2):0 S PSADT(4)=$O(^PS(50.8,+PSAIV,2,PSADT(4))) Q:'PSADT(4)  D  D:$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.7,+PSADRUG(2),0)) SOL
"RTN","PSAPSI2",27,0)
 ..Q:'$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI2",28,0)
 ..S PSADRUG(3)=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI2",29,0)
 ..F  S PSAW=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW)) Q:'PSAW  S PSAW(1)=PSAW D:$O(^PSD(58.8,"AB",PSAW,0))=PSALOC
"RTN","PSAPSI2",30,0)
 ...S PSAQ=$G(PSAQ)+$P($G(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW,0)),U,2)-$P($G(^(0)),U,5)
"RTN","PSAPSI2",31,0)
 ..S:$G(PSAQ) ^TMP("PSA",$J,+PSADRUG,PSADT(4))=$G(^TMP("PSA",$J,+PSADRUG,PSADT(4)))+PSAQ S (PSAQ,PSAW)=0
"RTN","PSAPSI2",32,0)
 .Q:$G(PSA(5))
"RTN","PSAPSI2",33,0)
 .S PSADRUG(1)=$P($G(^PSDRUG(+PSADRUG,660)),U,6),PSADRUG(2)=$P($G(^(660)),U,8)
"RTN","PSAPSI2",34,0)
 .S X=PSADRUG(1),X2="3$" D COMMA^%DTC S PSADRUG(3)=X
"RTN","PSAPSI2",35,0)
 .S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,+PSADRUG,PSA(4))) Q:'PSA(4)  D:$Y+4>IOSL HEADER Q:PSAOUT  S PSA(6)=PSA(6)+1,Y=PSA(4) X ^DD("DD") D
"RTN","PSAPSI2",36,0)
 ..W:$G(PSA(6))=1 !!,PSADRUGN W !!,Y
"RTN","PSAPSI2",37,0)
 ..S (X,PSADRUG(6))=$G(^TMP("PSA",$J,+PSADRUG,PSA(4))),X2=0
"RTN","PSAPSI2",38,0)
 ..S:$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,4) X=X/$P($G(^(6)),U,4)
"RTN","PSAPSI2",39,0)
 ..D COMMA^%DTC W ?14,X,PSADRUG(2),?40,PSADRUG(3),"/",PSADRUG(2),?63
"RTN","PSAPSI2",40,0)
 ..S PSADRUG(4)=$G(PSADRUG(4))+X
"RTN","PSAPSI2",41,0)
 ..S X=X*PSADRUG(1),PSADRUG(5)=$G(PSADRUG(5))+X,X2="2$" D COMMA^%DTC W ?40,X
"RTN","PSAPSI2",42,0)
 .I PSA(6) W !,PSALN,!,PSA(6)," DAY TOTALS: " S X=$G(PSADRUG(4)),X2=0 D COMMA^%DTC W ?5,X,PSADRUG(2) S PSADRUG(4)=0 S X=$G(PSADRUG(5)),X2="2$" D COMMA^%DTC W ?63,X S PSADRUG(5)=0
"RTN","PSAPSI2",43,0)
 I 'PSADRUG&($G(PSA(5))) S PSAOUT=1
"RTN","PSAPSI2",44,0)
STOP W:$E($G(IOST),1,2)="P-" @IOF
"RTN","PSAPSI2",45,0)
 I $E($G(IOST))="C",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSAPSI2",46,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAPSI2",47,0)
 K ^TMP("PSA",$J),PSA
"RTN","PSAPSI2",48,0)
QUIT Q
"RTN","PSAPSI2",49,0)
HEADER I $E(IOST,1,2)'="P-",$G(PSAPG) S DIR(0)="E" D ^DIR K DIR I Y<1 S PSAOUT=1 Q
"RTN","PSAPSI2",50,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAPSI2",51,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=$G(PSAPG)+1 W !,?2,"DAILY DISPENSING TOTALS FOR ",$E($G(PSALOCN),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAPSI2",52,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!
"RTN","PSAPSI2",53,0)
 W "DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAPSI2",54,0)
 Q
"RTN","PSAPSI2",55,0)
TASK S ZTIO="",ZTRTN="^PSAPSI1",ZTDTH=$H,ZTDESC="Dispensing totals",(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAPSI2",56,0)
 W:'$G(PSA(5)) !!,"Updating transaction file and dispensing totals." Q
"RTN","PSAPSI2",57,0)
SOL S PSAW=PSADT(3),PSADRUG(3)=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.7,+PSADRUG(2),0))
"RTN","PSAPSI2",58,0)
 F  S PSAW=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW)) Q:'PSAW  S PSAW(1)=PSAW D:$O(^PSD(58.8,"AB",PSAW,0))=PSALOC
"RTN","PSAPSI2",59,0)
 .S PSAQ=$G(PSAQ)+$P($G(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW,0)),U,2)-$P($G(^(0)),U,5)
"RTN","PSAPSI2",60,0)
 S:PSAQ ^TMP("PSA",$J,+PSADRUG,PSADT(4))=$G(^TMP("PSA",$J,+PSADRUG,PSADT(4)))+PSAQ S (PSAQ,PSAW)=0
"RTN","PSAPSI2",61,0)
 Q
"RTN","PSAPSI4")
0^38^B2992805
"RTN","PSAPSI4",1,0)
PSAPSI4 ;BIR/LTL-IV Dispensing (Single Drug) & (All Drugs) ;7/23/97
"RTN","PSAPSI4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAPSI4",3,0)
 ;This routine gets and sets the IV conversion factors.
"RTN","PSAPSI4",4,0)
 ;
"RTN","PSAPSI4",5,0)
 N PSADD,PSASOL,PSAC,Y,DIE,DA,DR
"RTN","PSAPSI4",6,0)
ADD S PSADD=$O(^PS(52.6,"AC",+PSAIT,0)) D:PSADD
"RTN","PSAPSI4",7,0)
 .W !,PSAIT(2)," is an IV Additive and will therefore be"
"RTN","PSAPSI4",8,0)
 I 'PSADD S PSASOL=$O(^PS(52.7,"AC",+PSAIT,0)) W !,PSAIT(2)," is an IV Solution and will therefore be"
"RTN","PSAPSI4",9,0)
 W !!,"dispensed in the IV module by the " D:PSADD
"RTN","PSAPSI4",10,0)
 .S Y=$P($G(^PS(52.6,+PSADD,0)),U,3),C=$P(^DD(52.6,2,0),U,3)
"RTN","PSAPSI4",11,0)
 .D Y^DIQ W Y
"RTN","PSAPSI4",12,0)
 W:$G(PSASOL) "ML"
"RTN","PSAPSI4",13,0)
 W ", but in ",PSALOCN," by the ",$P(PSAIT(4),U,8),".",!!
"RTN","PSAPSI4",14,0)
 W:PSADD "Please enter the number of ",Y,"s per ",$P(PSAIT(4),U,8),".",!
"RTN","PSAPSI4",15,0)
 S DIE="^PSD(58.8,+PSALOC,1,",DA(1)=PSALOC,DA=PSAIT,DR="25"
"RTN","PSAPSI4",16,0)
 I $G(PSASOL) W "The IV conversion factor is set to " S PSASOL(1)=+$P($G(^PS(52.7,+PSASOL,0)),U,3),DR="25////"_PSASOL(1) W PSASOL(1),".  <determined by IV Solution volume>",!
"RTN","PSAPSI4",17,0)
 D ^DIE K DIE,DA,DR,PSADD,PSASOL
"RTN","PSAREORD")
0^9^B29973014
"RTN","PSAREORD",1,0)
PSAREORD ;BIR/JMB-Nightly Background Job - CONT'D ;7/23/97
"RTN","PSAREORD",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAREORD",3,0)
 ;This routine checks each pharmacy location for current balances less
"RTN","PSAREORD",4,0)
 ;than or equal to the reorder level. A list is sent to the holders of
"RTN","PSAREORD",5,0)
 ;the PSA ORDERS key. If the location is a master vault, the message
"RTN","PSAREORD",6,0)
 ;will include those CS drugs only if the user has the PSJ RPHARM key.
"RTN","PSAREORD",7,0)
 ;
"RTN","PSAREORD",8,0)
PHARM ;Looks for drugs that are >= reorder level in pharmacy locations.
"RTN","PSAREORD",9,0)
 K ^TMP("PSAMSGO",$J),^TMP("PSAREORD",$J) S (PSACNT,PSALOC)=0
"RTN","PSAREORD",10,0)
 F  S PSALOC=$O(^PSD(58.8,"ADISP","P",PSALOC)) Q:'PSALOC  D
"RTN","PSAREORD",11,0)
 .Q:'$P($G(^PSD(58.8,PSALOC,0)),"^",14)!('$D(^PSD(58.8,PSALOC,0)))
"RTN","PSAREORD",12,0)
 .I +$G(^PSD(58.8,PSALOC,"I")),+^PSD(58.8,PSALOC,"I")'>DT Q
"RTN","PSAREORD",13,0)
 .S PSAFIRST=1,PSADRG=0
"RTN","PSAREORD",14,0)
 .F  S PSADRG=+$O(^PSD(58.8,PSALOC,1,PSADRG)) Q:'PSADRG  D
"RTN","PSAREORD",15,0)
 ..S PSANODE=$G(^PSD(58.8,PSALOC,1,PSADRG,0)) Q:PSANODE=""
"RTN","PSAREORD",16,0)
 ..Q:+$P(PSANODE,"^",4)>+$P(PSANODE,"^",5)
"RTN","PSAREORD",17,0)
 ..Q:'+$P(PSANODE,"^",4)&('+$P(PSANODE,"^",5))
"RTN","PSAREORD",18,0)
 ..S PSANDC=$P($G(^PSDRUG(PSADRG,2)),"^",4) K PSALVSN D:PSANDC'="" NDC
"RTN","PSAREORD",19,0)
 ..S ^TMP("PSAORD",$J,PSALOC,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P(^PSDRUG(PSADRG,0),"^"),1:"UNKNOWN ("_PSADRG_")"))=+$P(PSANODE,"^",3)_"^"_+$P(PSANODE,"^",4)_"^"_$G(PSALVSN)
"RTN","PSAREORD",20,0)
 K PSALVSN
"RTN","PSAREORD",21,0)
 ;
"RTN","PSAREORD",22,0)
VAULT ;Looks for drugs that are >= reorder level in master vaults.
"RTN","PSAREORD",23,0)
 S PSALOC=0 F  S PSALOC=$O(^PSD(58.8,"ADISP","M",PSALOC)) Q:'PSALOC  D
"RTN","PSAREORD",24,0)
 .Q:'$P($G(^PSD(58.8,PSALOC,0)),"^",14)!('$D(^PSD(58.8,PSALOC,0)))
"RTN","PSAREORD",25,0)
 .I +$G(^PSD(58.8,PSALOC,"I")),+^PSD(58.8,PSALOC,"I")'>DT Q
"RTN","PSAREORD",26,0)
 .S PSAFIRST=1,PSADRG=0
"RTN","PSAREORD",27,0)
 .F  S PSADRG=$O(^PSD(58.8,PSALOC,1,PSADRG)) Q:'PSADRG  D
"RTN","PSAREORD",28,0)
 ..S PSANODE=$G(^PSD(58.8,PSALOC,1,PSADRG,0))
"RTN","PSAREORD",29,0)
 ..Q:PSANODE=""!(+$P(PSANODE,"^",4)>+$P(PSANODE,"^",5))
"RTN","PSAREORD",30,0)
 ..Q:'+$P(PSANODE,"^",4)&('+$P(PSANODE,"^",5))
"RTN","PSAREORD",31,0)
 ..S PSANDC=$P($G(^PSDRUG(PSADRG,2)),"^",4) K PSALVSN D:PSANDC'="" NDC
"RTN","PSAREORD",32,0)
 ..S ^TMP("PSAORDCS",$J,PSALOC,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P(^PSDRUG(PSADRG,0),"^"),1:"UNKNOWN ("_PSADRG_")"))=+$P(PSANODE,"^",3)_"^"_+$P(PSANODE,"^",4)_"^"_$G(PSALVSN)
"RTN","PSAREORD",33,0)
 K PSALVSN I '$O(^TMP("PSAORD",$J,0)),'$O(^TMP("PSAORDCS",$J,0)) G EXIT
"RTN","PSAREORD",34,0)
 ;
"RTN","PSAREORD",35,0)
NONCS ;Loops through the non-controlled subs to create mail message text.
"RTN","PSAREORD",36,0)
 G:'$O(^TMP("PSAORD",$J,0)) CS K PSA S (PSACNT,PSALOC)=0
"RTN","PSAREORD",37,0)
 F  S PSALOC=$O(^TMP("PSAORD",$J,PSALOC)) Q:'PSALOC  D
"RTN","PSAREORD",38,0)
 .S PSAFIRST=1,PSADRG=""
"RTN","PSAREORD",39,0)
 .F  S PSADRG=$O(^TMP("PSAORD",$J,PSALOC,PSADRG)) Q:PSADRG=""  D
"RTN","PSAREORD",40,0)
 ..S PSASTOCK=$P(^TMP("PSAORD",$J,PSALOC,PSADRG),"^"),PSABAL=$P(^(PSADRG),"^",2),PSAVSN=$P(^(PSADRG),"^",3) D SETMSG
"RTN","PSAREORD",41,0)
 G:'$D(^XUSEC("PSJ RPHARM",DUZ))!('$O(^TMP("PSAORDCS",$J,0))) SEND
"RTN","PSAREORD",42,0)
 ;
"RTN","PSAREORD",43,0)
CS ;Loops through the controlled subs to create mail message text.
"RTN","PSAREORD",44,0)
 S PSALOC=0 F  S PSALOC=$O(^TMP("PSAORDCS",$J,PSALOC)) Q:'PSALOC  D
"RTN","PSAREORD",45,0)
 .S PSAFIRST=1,PSADRG=""
"RTN","PSAREORD",46,0)
 .F  S PSADRG=$O(^TMP("PSAORDCS",$J,PSALOC,PSADRG)) Q:PSADRG=""  D
"RTN","PSAREORD",47,0)
 ..S PSASTOCK=$P(^TMP("PSAORDCS",$J,PSALOC,PSADRG),"^"),PSABAL=$P(^(PSADRG),"^",2),PSAVSN=$P(^(PSADRG),"^",3) D SETMSG
"RTN","PSAREORD",48,0)
 ;
"RTN","PSAREORD",49,0)
SEND ;Send the mail message to the holders of the PSA ORDERS key.
"RTN","PSAREORD",50,0)
 S XMTEXT="^TMP(""PSAMSGO"",$J,",XMDUZ="Drug Accountability System",XMSUB="Drug Balances Below Reorder Level"
"RTN","PSAREORD",51,0)
 S PSADUZ=0 F  S PSADUZ=$O(^XUSEC("PSA ORDERS",PSADUZ)) Q:'PSADUZ  S XMY(PSADUZ)=""
"RTN","PSAREORD",52,0)
 G:'$D(XMY) QUIT D ^XMD
"RTN","PSAREORD",53,0)
QUIT K XMY,^TMP("PSAMSGO",$J)
"RTN","PSAREORD",54,0)
 Q
"RTN","PSAREORD",55,0)
 ;
"RTN","PSAREORD",56,0)
NDC ;Gets VSN dispense units,dispense units/order unit, order unit for
"RTN","PSAREORD",57,0)
 ;^TMP global
"RTN","PSAREORD",58,0)
 K PSASYN,PSAVSN,PSAOU,PSADUOU,PSADU,PSALVSN
"RTN","PSAREORD",59,0)
 S PSANDC=$E("000000",1,(6-$L($P(PSANDC,"-"))))_$P(PSANDC,"-")_$E("0000",1,(4-$L($P(PSANDC,"-",2))))_$P(PSANDC,"-",2)_$E("00",1,(2-$L($P(PSANDC,"-",3))))_$P(PSANDC,"-",3)
"RTN","PSAREORD",60,0)
 S PSASYN=+$O(^PSDRUG("C",PSANDC,PSADRG,0)) Q:'PSASYN!('$D(^PSDRUG(PSADRG,1,PSASYN,0)))
"RTN","PSAREORD",61,0)
 S PSAVSN=$P(^PSDRUG(PSADRG,1,PSASYN,0),"^",4),PSAOU=$S(+$P(^(0),"^",5):$P($G(^DIC(51.5,+$P(^(0),"^",5),0)),"^"),1:"")
"RTN","PSAREORD",62,0)
 S PSADUOU=$S(+$P(^PSDRUG(PSADRG,1,PSASYN,0),"^",7):+$P(^(0),"^",7),1:""),PSADU=$P($G(^PSDRUG(PSADRG,660)),"^",8)
"RTN","PSAREORD",63,0)
 Q:PSAVSN=""
"RTN","PSAREORD",64,0)
 S PSALVSN="VSN: "_PSAVSN I PSAOU'="",+PSADUOU,PSADU'="" S PSALVSN=PSALVSN_" "_PSADUOU_" "_PSADU_"/"_PSAOU
"RTN","PSAREORD",65,0)
 K PSASYN,PSAVSN,PSAOU,PSADUOU,PSADU
"RTN","PSAREORD",66,0)
 Q
"RTN","PSAREORD",67,0)
SETMSG ;Creates the body of the mail message.
"RTN","PSAREORD",68,0)
 I PSAFIRST D
"RTN","PSAREORD",69,0)
 .I PSACNT'=0 S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)="=============================================================================",PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)=" "
"RTN","PSAREORD",70,0)
 .K PSALOCA D SITES^PSAUTL1 S PSALOCA($P(^PSD(58.8,PSALOC,0),"^")_PSACOMB,PSALOC)=PSAISIT_"^"_PSAOSIT,PSALOCN=$O(PSALOCA("")),PSAFIRST=0
"RTN","PSAREORD",71,0)
 .S PSACNT=PSACNT+1,PSACNT(PSACNT)=$S($P(^PSD(58.8,PSALOC,0),"^",2)="P":"PHARMACY LOCATION",1:"MASTER VAULT")
"RTN","PSAREORD",72,0)
 .I $L(PSALOCN)>76 S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)=$P(PSALOCN,"(IP)",1)_"(IP)" S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)="                 "_$P(PSALOCN,"(IP)",2)
"RTN","PSAREORD",73,0)
 .I $L(PSALOCN)<77 S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)=PSALOCN
"RTN","PSAREORD",74,0)
 .S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)="                                           Stock    Current    Amount to"
"RTN","PSAREORD",75,0)
 .S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)="Drug Name:                                 Level    Balance        Order"
"RTN","PSAREORD",76,0)
 .S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)="-----------------------------------------------------------------------------"
"RTN","PSAREORD",77,0)
 S PSALEN=$L(PSADRG),PSASPACE=$E("                                        ",1,(42-PSALEN))
"RTN","PSAREORD",78,0)
 S PSACNT=PSACNT+1,^TMP("PSAMSGO",$J,PSACNT)=PSADRG_PSASPACE_$J(PSASTOCK,6,0)_"     "_$J(PSABAL,6,0)_"       "_$S((PSASTOCK-PSABAL)>.001:$J((PSASTOCK-PSABAL),6,0),1:"   N/A")
"RTN","PSAREORD",79,0)
 S PSACNT=PSACNT+1 S:$G(PSAVSN)'="" ^TMP("PSAMSGO",$J,PSACNT)="  "_PSAVSN
"RTN","PSAREORD",80,0)
 Q
"RTN","PSAREORD",81,0)
 ;
"RTN","PSAREORD",82,0)
EXIT ;Kills the variables & TMP globals.
"RTN","PSAREORD",83,0)
 K ^TMP("PSAMSGO",$J),^TMP("PSAORD",$J),^TMP("PSAORDCS",$J)
"RTN","PSAREORD",84,0)
 K PSA,PSABAL,PSACNT,PSACOMB,PSADRG,PSAFIRST,PSAISIT,PSALEN,PSALOC,PSALOCA,PSALOCN,PSANODE,PSAOSIT,PSAISITN,PSAOSITN,PSASPACE,PSASTOCK,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","PSAREORD",85,0)
 Q
"RTN","PSARWS")
0^8^B16948588
"RTN","PSARWS",1,0)
PSARWS ;BIR/LTL,JMB-Collects Ward Stock Data ;7/23/97
"RTN","PSARWS",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSARWS",3,0)
 ;This routine gathers AR/WS dispensing data. It is called by PSGWUAS.
"RTN","PSARWS",4,0)
 ;
"RTN","PSARWS",5,0)
 N D0,DR,DA,DIC,DIE,DLAYGO,PSA,PSAB,PSAD,PSADT,PSASIT,PSAT,PSADRUG,PSALOC,PSAQTY,PSADA,PSADAL,PSAPS,X,Y S (PSAPS,PSA)=0,PSADA=""
"RTN","PSARWS",6,0)
 ;get date dispensed,site(aou),drug,qty
"RTN","PSARWS",7,0)
 F  S PSA=$O(^PSI(58.5,"AMIS",PSA)),(PSADT,PSA(1),PSASIT,PSADRUG,PSAQTY)="" Q:'PSA  S PSADT=$O(^PSI(58.5,"AMIS",PSA,PSADT)) Q:'PSADT  S PSA(1)=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1))) Q:PSA(1)']""  D
"RTN","PSARWS",8,0)
 .S PSASIT=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1),PSASIT)) Q:'PSASIT!('$P($G(^PS(59.4,+$G(^PSI(58.1,+PSASIT,"SITE")),0)),U,26))  S PSASIT(1)=$G(^PSI(58.1,PSASIT,"SITE"))
"RTN","PSARWS",9,0)
 .S PSADRUG=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1),PSASIT,PSADRUG))
"RTN","PSARWS",10,0)
 .;drug stocked by any primary DA location?
"RTN","PSARWS",11,0)
 .Q:'PSADRUG!('$O(^PSD(58.8,"C",+PSADRUG,0)))
"RTN","PSARWS",12,0)
 .S (PSAPS,PSADA)=0
"RTN","PSARWS",13,0)
 .;If the location is active, the drug is tracked, & it is tracked in an
"RTN","PSARWS",14,0)
 .;inpatient site, set the PSADA(PSAPS) array.
"RTN","PSARWS",15,0)
 .F  S PSADA=$O(^PSD(58.8,"C",+PSADRUG,PSADA)) Q:'PSADA  I $G(^PSD(58.8,+PSADA,"I"))="",$P($G(^PSD(58.8,+PSADA,0)),U,2)="P",+$P($G(^PSD(58.8,+PSADA,0)),U,3) S PSAPS=PSAPS+1,PSADA(PSAPS)=PSADA
"RTN","PSARWS",16,0)
 .Q:'PSAPS
"RTN","PSARWS",17,0)
 .S PSAQTY=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1),PSASIT,PSADRUG,0))
"RTN","PSARWS",18,0)
 .S:PSA(1)="R" PSAQTY=-PSAQTY
"RTN","PSARWS",19,0)
 .;drug stocked by only one DA location
"RTN","PSARWS",20,0)
 .I PSAPS=1 S ^TMP("PSAR",$J,PSADRUG,PSADA(PSAPS))=PSAQTY+$G(^TMP("PSAR",$J,PSADRUG,PSADA(PSAPS))) Q
"RTN","PSARWS",21,0)
 .;more than one, check site
"RTN","PSARWS",22,0)
 .;
"RTN","PSARWS",23,0)
 .;Dave B (PSA*3*3)
"RTN","PSARWS",24,0)
 .S (PSAPS,PSAPS(1))=0 F  S PSAPS(1)=$O(PSADA(PSAPS(1))) Q:'PSAPS(1)  S PSADA=PSADA(PSAPS(1)) I $D(^PSD(58.8,"ASITE",+PSASIT(1),"P",PSADA)) S ^TMP("PSAR",$J,PSADRUG,PSADA)=PSAQTY+$G(^TMP("PSAR",$J,PSADRUG,PSADA))
"RTN","PSARWS",25,0)
COUNT G:'$O(^TMP("PSAR",$J,"")) END S PSAPS(1)=0
"RTN","PSARWS",26,0)
 F PSA=0:1 S PSA=$O(^TMP("PSAR",$J,PSA)) Q:'PSA  S PSAPS(1)=$G(PSAPS(1))+1
"RTN","PSARWS",27,0)
 ;get transaction numbers
"RTN","PSARWS",28,0)
 F  L +^PSD(58.81,0):0 I  Q
"RTN","PSARWS",29,0)
FIND S PSAD=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAD)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSARWS",30,0)
 S PSAT=PSAD,DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(PSA,PSA(1))=""
"RTN","PSARWS",31,0)
 F PSAD=PSAT:1:(PSAT+PSAPS(1)-1) S (DINUM,X)=PSAD D ^DIC
"RTN","PSARWS",32,0)
 L -^PSD(58.81,0) K DIC,DINUM,DLAYGO
"RTN","PSARWS",33,0)
 ;loop thru array
"RTN","PSARWS",34,0)
 F  S PSA=$O(^TMP("PSAR",$J,PSA)) Q:'PSA  D
"RTN","PSARWS",35,0)
 .S PSALOC=$O(^TMP("PSAR",$J,PSA,0))
"RTN","PSARWS",36,0)
 .S PSAB(1)=$G(^TMP("PSAR",$J,PSA,PSALOC))
"RTN","PSARWS",37,0)
 .;get date + current balance + update balance
"RTN","PSARWS",38,0)
 .F  L +^PSD(58.8,+PSALOC,1,+PSA,0):0 I  Q
"RTN","PSARWS",39,0)
 .D NOW^%DTC
"RTN","PSARWS",40,0)
 .S PSADT=+$E(%,1,12),PSAB=+$P($G(^PSD(58.8,+PSALOC,1,+PSA,0)),U,4),$P(^PSD(58.8,+PSALOC,1,+PSA,0),U,4)=PSAB-PSAB(1) K %
"RTN","PSARWS",41,0)
 .L -^PSD(58.8,+PSALOC,1,+PSA,0)
"RTN","PSARWS",42,0)
 .;update monthly activity multiple
"RTN","PSARWS",43,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSA,5,0)) ^(0)="^58.801A^^"
"RTN","PSARWS",44,0)
 .I '$D(^PSD(58.8,+PSALOC,1,+PSA,5,$E(DT,1,5)*100,0)) D
"RTN","PSARWS",45,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,+PSA,5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSAB)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSA,DLAYGO=58.8 D ^DIC K DIC("DR"),DINUM,DLAYGO
"RTN","PSARWS",46,0)
 ..S X="T-1M" D ^%DT S (X,DINUM)=$E(Y,1,5)*100 D ^DIC K DINUM
"RTN","PSARWS",47,0)
 ..S DIE=DIC,DA=+Y,DR="3////^S X=$G(PSAB)" D ^DIE K DIE,DA
"RTN","PSARWS",48,0)
 .S DIE="^PSD(58.8,+PSALOC,1,+PSA,5,",DA(2)=PSALOC,DA(1)=PSA
"RTN","PSARWS",49,0)
 .S DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^PSD(58.8,+PSALOC,1,+PSA,5,+$E(DT,1,5)*100,0)),U,6)+PSAB(1)"
"RTN","PSARWS",50,0)
 .D ^DIE K DIE,DA
"RTN","PSARWS",51,0)
 .;update transaction
"RTN","PSARWS",52,0)
 .S DIE="^PSD(58.81,",DR="1////2;2////^S X=PSALOC;3///^S X=PSADT;4////^S X=PSA;5////^S X=$G(PSAB(1));9////^S X=PSAB",DA=PSAT
"RTN","PSARWS",53,0)
 .D ^DIE
"RTN","PSARWS",54,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSA,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSARWS",55,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSA,4,",DIC(0)="L",(X,DINUM)=PSAT,DA(2)=PSALOC,DA(1)=PSA,DLAYGO=58.8 D ^DIC K DA,DIC,DINUM,DLAYGO S PSAT=PSAT+1
"RTN","PSARWS",56,0)
END K ^TMP("PSAR",$J)
"RTN","PSARWS",57,0)
 Q
"RTN","PSAUDP")
0^13^B10115428
"RTN","PSAUDP",1,0)
PSAUDP ;BIR/LTL,JMB-Nightly Background Job - CONT'D ;7/23/97
"RTN","PSAUDP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUDP",3,0)
 ;This is the entry point to gather IP dispensing data for all drugs in
"RTN","PSAUDP",4,0)
 ;all pharmacy locations. When the pick list is filed away, an
"RTN","PSAUDP",5,0)
 ;^XTMP("PSAPL") global is set to contain the dispensing data.
"RTN","PSAUDP",6,0)
 ;^XTMP("PSA",59.4 IP Site#,50 Drug#,Date dispensed)=Total Qty Dispensed
"RTN","PSAUDP",7,0)
 ;It is called by PSAPSI3.
"RTN","PSAUDP",8,0)
 ;
"RTN","PSAUDP",9,0)
PICKLST Q:'$O(^XTMP("PSAPL",0))
"RTN","PSAUDP",10,0)
 D DT^DICRW
"RTN","PSAUDP",11,0)
 ;PSAIP=IP SITE, PSA50=DRUG(IEN), PSADT=DT
"RTN","PSAUDP",12,0)
 S PSAIP=0 F  S PSAIP=$O(^XTMP("PSAPL",PSAIP)) Q:'PSAIP  D
"RTN","PSAUDP",13,0)
 .S PSA50=0 F  S PSA50=$O(^XTMP("PSAPL",PSAIP,PSA50)) Q:'PSA50  D
"RTN","PSAUDP",14,0)
 ..S PSADT=0 F  S PSADT=$O(^XTMP("PSAPL",PSAIP,PSA50,PSADT)) Q:'PSADT  D
"RTN","PSAUDP",15,0)
 ...;
"RTN","PSAUDP",16,0)
 ...;PSA*3*3 (DAVE B 5JUN98)
"RTN","PSAUDP",17,0)
 ...S XX=0 F  S XX=$O(^PSD(58.8,"ASITE",PSAIP,"P",XX)) I '$D(^PSD(58.8,XX,"I")) S PSALOC=XX Q
"RTN","PSAUDP",18,0)
 ...S PSAQTY=+$G(^XTMP("PSAPL",PSAIP,PSA50,PSADT))
"RTN","PSAUDP",19,0)
 ...D:$D(^PSD(58.8,PSALOC,1,PSA50)) PROCESS
"RTN","PSAUDP",20,0)
 ...K ^XTMP("PSAPL",PSAIP,PSA50,PSADT)
"RTN","PSAUDP",21,0)
 S X1=DT,X2=1 D C^%DTC S ^XTMP("PSAPL",0)=X
"RTN","PSAUDP",22,0)
END K DA,DIC,DIE,DINUM,DLAYGO,DR,PSA50,PSABAL,PSADT,PSAIP,PSALOC,PSANUM,PSAQTY,X,Y
"RTN","PSAUDP",23,0)
 Q
"RTN","PSAUDP",24,0)
PROCESS ;Stuff last UD dispensing fld with DT
"RTN","PSAUDP",25,0)
 F  L +^PSD(58.8,PSALOC,0):0 I  Q
"RTN","PSAUDP",26,0)
 S DIE="^PSD(58.8,",DA=PSALOC,DR="27////"_PSADT D ^DIE K DIE,DA,DR
"RTN","PSAUDP",27,0)
 ;Subtract dispensing from balance
"RTN","PSAUDP",28,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSA50,0)),"^",4)
"RTN","PSAUDP",29,0)
 S $P(^PSD(58.8,PSALOC,1,PSA50,0),"^",4)=PSABAL-$G(PSAQTY)
"RTN","PSAUDP",30,0)
 ;If no monthly activity node, add node with beginning balance.
"RTN","PSAUDP",31,0)
 I '$D(^PSD(58.8,PSALOC,1,PSA50,5,+$E(PSADT,1,5)*100,0)) D
"RTN","PSAUDP",32,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSA50,5,",DIC(0)="L",DIC("P")=$P(^DD(58.8001,20,0),U,2),(X,DINUM)=$E(PSADT,1,5)*100,DA(2)=PSALOC,DA(1)=PSA50
"RTN","PSAUDP",33,0)
 .S DIC("DR")="1////^S X=$G(PSABAL)",DLAYGO=58.8 D ^DIC K DIC,DLAYGO
"RTN","PSAUDP",34,0)
 .;Add current month's node and stuff beginning & ending balance.
"RTN","PSAUDP",35,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSA50,5,",DIC(0)="L",(X,DINUM)=$E(PSADT-100-(+$E(PSADT,4,5)=1*8800),1,5)*100,DA(2)=PSALOC,DA(1)=PSA50,DLAYGO=58.8 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAUDP",36,0)
 .S DIE="^PSD(58.8,PSALOC,1,PSA50,5,",DA(2)=PSALOC,DA(1)=PSA50,DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAUDP",37,0)
 ;Stuff total dispensed
"RTN","PSAUDP",38,0)
 S DIE="^PSD(58.8,PSALOC,1,PSA50,5,",DA(2)=PSALOC,DA(1)=PSA50,DA=$E(PSADT,1,5)*100,DR="9////^S X=$P($G(^(0)),U,6)+PSAQTY" D ^DIE K DIE,DA
"RTN","PSAUDP",39,0)
 ;Get next transaction node number
"RTN","PSAUDP",40,0)
FIND S PSANUM=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSANUM)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAUDP",41,0)
 ;Add next transaction node with data.
"RTN","PSAUDP",42,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSANUM D ^DIC K DIC,DLAYGO
"RTN","PSAUDP",43,0)
 S DIE="^PSD(58.81,",DA=PSANUM
"RTN","PSAUDP",44,0)
 S DR="1////2;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSA50;5////^S X=PSAQTY;9////^S X=$G(PSABAL)" D ^DIE K DIE,DA
"RTN","PSAUDP",45,0)
 ;Add activity node
"RTN","PSAUDP",46,0)
 S DIC="^PSD(58.8,PSALOC,1,PSA50,4,",DIC(0)="L",(X,DINUM)=PSANUM,DIC("P")=$P(^DD(58.8001,19,0),"^",2),DA(2)=PSALOC,DA(1)=PSA50,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSAUDP",47,0)
 L -^PSD(58.8,PSALOC,0)
"RTN","PSAUDP",48,0)
 Q
"RTN","PSAUP1")
0^10^B32900847
"RTN","PSAUP1",1,0)
PSAUP1 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAUP1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUP1",3,0)
XTMP ;This modules copies the prime vendor data in ^TMP("PSAPV SET",$J) to
"RTN","PSAUP1",4,0)
 ;^XTMP("PSAPV"). The data has passed all X12 checks.
"RTN","PSAUP1",5,0)
 ;
"RTN","PSAUP1",6,0)
 S X1=DT,X2=21 D C^%DTC S ^XTMP("PSAPV",0)=X_"^"_DT_"^Drug Accountability Prime Vendor Uploaded Invoice Data" L +^XTMP("PSAPV",0):0
"RTN","PSAUP1",7,0)
 ;
"RTN","PSAUP1",8,0)
 ;Sets array of orders & invoices in XTMP (uploaded or processed).
"RTN","PSAUP1",9,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:'PSACTRL  D
"RTN","PSAUP1",10,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAUP1",11,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAUP1",12,0)
 .;DAVE B PSA*3*3 - Incomplete invoice deletion
"RTN","PSAUP1",13,0)
 .I $P(PSAIN,"^",2)=""!($P(PSAIN,"^",4)="") K ^XTMP("PSAPV",PSACTRL) Q
"RTN","PSAUP1",14,0)
 .S PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2))=$S($P(PSAIN,"^",8)="P":"P",1:"U")
"RTN","PSAUP1",15,0)
DUPLICAT ;
"RTN","PSAUP1",16,0)
 ;Sets XTMP if incoming order & invoice is not a duplicate.
"RTN","PSAUP1",17,0)
 S (PSACTRL,PSADUP)=0
"RTN","PSAUP1",18,0)
 F  S PSACTRL=$O(^TMP("PSAPV SET",$J,PSACTRL)) S DAVESET=PSACTRL Q:PSACTRL=""  D  S PSACTRL=DAVESET
"RTN","PSAUP1",19,0)
DAV .;DaveB (patch 3)
"RTN","PSAUP1",20,0)
 .I $D(^XTMP("PSAPV",DAVESET,"IN")) S DATA=^("IN") I $P(^TMP("PSAPV SET",$J,PSACTRL,"IN"),"^",4)'=$P(DATA,"^",4),$P(^TMP("PSAPV SET",$J,PSACTRL,"IN"),"^",2)'=$P(DATA,"^",2) S PSACHKR=1
"RTN","PSAUP1",21,0)
 .I $D(PSACHKR) F  S DAVESET=$G(DAVESET)+.01 I '$D(^XTMP("PSAPV",DAVESET)) K PSACHKR Q
"RTN","PSAUP1",22,0)
 .;
"RTN","PSAUP1",23,0)
 .S PSASEG="" F  S PSASEG=$O(^TMP("PSAPV SET",$J,PSACTRL,PSASEG)) Q:PSASEG=""  S PSADUP=0 D
"RTN","PSAUP1",24,0)
 ..I PSASEG'="IT" D  Q
"RTN","PSAUP1",25,0)
 ...I PSASEG="IN" S PSAIN=^TMP("PSAPV SET",$J,PSACTRL,PSASEG) W "." D  Q
"RTN","PSAUP1",26,0)
 ....I $P(PSAIN,"^",2)=""!($P(PSAIN,"^",4)="") K ^TMP("PSAPV SET",$J,PSACTRL) Q  ; (DAVEB PSA*3*3) ,^XTMP("PSAPV",DAVESET) Q
"RTN","PSAUP1",27,0)
 ....D CHKDUP Q:PSADUP
"RTN","PSAUP1",28,0)
 ....S ^XTMP("PSAPV",DAVESET,"IN")=^TMP("PSAPV SET",$J,PSACTRL,PSASEG)
"RTN","PSAUP1",29,0)
 ....S LWRDT=$E(DT,1,3)-70,UPPRDT=$E(DT,1,3)+30
"RTN","PSAUP1",30,0)
 ....F Y=1,3,5,6 S DT1=$E(DT,1)_$E($P(^XTMP("PSAPV",DAVESET,"IN"),"^",Y),1,2),$P(^XTMP("PSAPV",DAVESET,"IN"),"^",Y)=$S((DT1>LWRDT&(DT1<UPPRDT)):$E(DT1)_$P(^XTMP("PSAPV",DAVESET,"IN"),"^",Y),1:($E(DT1,1)+1)_$P(^XTMP("PSAPV",DAVESET,"IN"),"^",Y))
"RTN","PSAUP1",31,0)
 ....F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",DAVESET,"IN"),"^",X) I XX>(DT+300000) S XXX=$E(XX,1)-2,$P(^XTMP("PSAPV",DAVESET,"IN"),"^",X)=XXX_$E(XX,2,99)
"RTN","PSAUP1",32,0)
 ....K LWRDT,UPPRDT,DT1,X,Y,XXX,XX
"RTN","PSAUP1",33,0)
 ....S PSAORD=$P($G(^TMP("PSAPV SET",$J,PSACTRL,"IN")),"^",4),PSAINV=$P($G(^("IN")),"^",2),PSAORDDT=$P($G(^("IN")),"^",3),PSAINVDT=$P($G(^("IN")),"^")
"RTN","PSAUP1",34,0)
 ....W:$D(^TMP("PSAPV SET",$J,PSACTRL,"IT")) !,">> Uploading order# "_PSAORD_", invoice# "_PSAINV
"RTN","PSAUP1",35,0)
 ...I PSASEG'="IN" S ^XTMP("PSAPV",DAVESET,PSASEG)=^TMP("PSAPV SET",$J,PSACTRL,PSASEG)
"RTN","PSAUP1",36,0)
 ..I PSASEG="IT" S PSALINE=0 F  S PSALINE=$O(^TMP("PSAPV SET",$J,PSACTRL,PSASEG,PSALINE)) Q:'PSALINE  S ^XTMP("PSAPV",DAVESET,PSASEG,PSALINE)=^TMP("PSAPV SET",$J,PSACTRL,PSASEG,PSALINE)
"RTN","PSAUP1",37,0)
 .K ^TMP("PSAPV SET",$J,PSACTRL)
"RTN","PSAUP1",38,0)
 .I '$D(^XTMP("PSAPV",DAVESET,"IT")) K ^XTMP("PSAPV",DAVESET)
"RTN","PSAUP1",39,0)
 L -^XTMP("PSAPV",0)
"RTN","PSAUP1",40,0)
 Q
"RTN","PSAUP1",41,0)
 ;
"RTN","PSAUP1",42,0)
CHKDUP ;Checks for duplicate orders & invoices and duplicates in XTMP.
"RTN","PSAUP1",43,0)
 I $D(PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2))) S PSASTA=PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2)) D  Q
"RTN","PSAUP1",44,0)
 .W !,"** Order# "_$P(PSAIN,"^",4)_", invoice# "_$P(PSAIN,"^",2)_" has been "
"RTN","PSAUP1",45,0)
 .I PSASTA="U" W " uploaded and",!,"   is awaiting processing. It cannot be uploaded more than once."
"RTN","PSAUP1",46,0)
 .I PSASTA'="U" W " processed and",!,"   is being prepared for verification. It cannot be uploaded more than once."
"RTN","PSAUP1",47,0)
 .K ^TMP("PSAPV SET",PSACTRL) Q
"RTN","PSAUP1",48,0)
 ;
"RTN","PSAUP1",49,0)
 Q:'$D(^PSD(58.811,"AORD",$P(PSAIN,"^",4),$P(PSAIN,"^",2)))
"RTN","PSAUP1",50,0)
 ;
"RTN","PSAUP1",51,0)
 ;Checks for duplicates in 58.811
"RTN","PSAUP1",52,0)
 S PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2),PSAORDN=$O(^PSD(58.811,"B",PSAORD,0)) Q:'PSAORDN
"RTN","PSAUP1",53,0)
 S PSAINVN=$O(^PSD(58.811,PSAORDN,1,"B",PSAINV,0)) Q:'PSAINVN
"RTN","PSAUP1",54,0)
 Q:'$D(^PSD(58.811,PSAORDN,1,PSAINVN,0))
"RTN","PSAUP1",55,0)
 S PSAIN=^PSD(58.811,PSAORDN,1,PSAINVN,0),PSASTA=$P(PSAIN,"^",3),PSAPC=$S(PSASTA="P":6,PSASTA="V"!(PSASTA="C"):8,1:0)
"RTN","PSAUP1",56,0)
 S (PSADT,PSALINE)=0 F  S PSALINE=$O(^PSD(58.811,PSAORDN,1,PSAINVN,1,PSALINE)) Q:'PSALINE!($G(PSADT))  S PSADT=+$P($G(^PSD(58.811,PSAORDN,1,PSAINVN,1,PSALINE,0)),"^",PSAPC)
"RTN","PSAUP1",57,0)
 W !,"** Order# "_PSAORD_" Invoice# "_PSAINV
"RTN","PSAUP1",58,0)
 S:+PSADT PSADT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)
"RTN","PSAUP1",59,0)
 I PSASTA="P" W " has been processed"_$S(+PSADT:" on "_PSADT,1:"")_" and",!,"   is awaiting verification. It cannot be uploaded more than once."
"RTN","PSAUP1",60,0)
 I PSASTA="V" W !,"   has been verified"_$S(+PSADT:" on "_PSADT,1:"")_"and",!,"   is updating the pharmacy location. It cannot be uploaded more than once."
"RTN","PSAUP1",61,0)
 I PSASTA="C" W " has been completed.",!,"   It cannot be uploaded more than once."
"RTN","PSAUP1",62,0)
 ;
"RTN","PSAUP1",63,0)
KILLDUP S PSADUP=1
"RTN","PSAUP1",64,0)
 K ^TMP("PSAPV SET",$J,PSACTRL),^XTMP("PSAPV",DAVESET)
"RTN","PSAUP1",65,0)
 Q
"RTN","PSAUP1",66,0)
PRT2 ;Extended help to second "Print invoices?"
"RTN","PSAUP1",67,0)
 W !?5,"Enter YES to print all invoices that are not processed and",!?5,"the invoices that were processed while you were in this option.",!!?5,"Enter NO to exit the option."
"RTN","PSAUP1",68,0)
 Q
"RTN","PSAUP1",69,0)
YNPRINT ;Extended help to "Print invoices?"
"RTN","PSAUP1",70,0)
 W !?5,"Enter YES to print the uploaded invoices. You",!?5,"can check the invoices prior to processing them.",!!?5,"Enter NO to not print the invoices."
"RTN","PSAUP1",71,0)
 Q
"RTN","PSAUP1",72,0)
 ;
"RTN","PSAUP1",73,0)
YNPROCES ;Extended help to "Do you want to process the invoices now?"
"RTN","PSAUP1",74,0)
 W !?5,"Enter YES to begin processing the uploaded invoices.",!!?5,"Enter NO if you do not want to process the invoices now. You can process"
"RTN","PSAUP1",75,0)
 W !?5,"them later by selecting the ""Process Uploaded Prime Vendor Invoice Data"" option."
"RTN","PSAUP1",76,0)
 Q
"RTN","PSAUP1",77,0)
 ;
"RTN","PSAUP1",78,0)
YNUPLOAD ;Extended help to "Are you ready to upload the prime vendor invoice data?"
"RTN","PSAUP1",79,0)
 W !?5,"Enter YES to start uploading the invoices.",!?5,"Enter NO or ""^"" to exit the option."
"RTN","PSAUP1",80,0)
 Q
"RTN","PSAUP1",81,0)
 ;
"RTN","PSAUP4")
0^24^B69716239
"RTN","PSAUP4",1,0)
PSAUP4 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;9/19/97
"RTN","PSAUP4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUP4",3,0)
 ;This routine prints invoices from the ^XTMP global on the screen or
"RTN","PSAUP4",4,0)
 ;to a printer.
"RTN","PSAUP4",5,0)
 ;
"RTN","PSAUP4",6,0)
 W !!,"Enter the device which will be used to print",!,"the invoices with all items, errors, and adjustments.",!
"RTN","PSAUP4",7,0)
 S %ZIS="Q" D ^%ZIS I POP S PSAOUT=1 Q
"RTN","PSAUP4",8,0)
 I $D(IO("Q")) S ZTDESC="Drug Acct. - Prime Vendor Invoice Upload Report",ZTRTN="DQ^PSAUP4" D ^%ZTLOAD Q
"RTN","PSAUP4",9,0)
 ;
"RTN","PSAUP4",10,0)
DQ ;queue starts here
"RTN","PSAUP4",11,0)
 S IOM=80
"RTN","PSAUP4",12,0)
 D NOW^%DTC S Y=% D DD^%DT S PSARUN=$E(Y,1,18),$P(PSASLN,"-",80)="",$P(PSADLN,"=",80)="",(PSADJDRG,PSADJSUP,PSAOUT)=0,PSAFPG=1
"RTN","PSAUP4",13,0)
 U IO
"RTN","PSAUP4",14,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""!(PSAOUT)  D START
"RTN","PSAUP4",15,0)
 W @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAUP4",16,0)
 ;
"RTN","PSAUP4",17,0)
EXIT ;Kills printing variables only
"RTN","PSAUP4",18,0)
 K %,%ZIS,DIR,DIRUT,PSAAECST,PSABY,PSACS,PSACTRL,PSADATA,PSADATE,PSADEC,PSADRG,PSADJDRG,PSADJORD,PSADJQTY,PSADJSUP,PSADLN,PSADS,PSAECOST,PSAEND,PSAFPG,PSAICOST,PSAIECST
"RTN","PSAUP4",19,0)
 K PSAIN,PSALINE,PSANDC,PSAODT,PSAODUZ,PSAOREA,PSAOUT,PSAPAGE,PSAPHARM,PSAQDT,PSAQDUZ,PSAQREA,PSAMV,PSARUN,PSAS,PSASLN,PSASS,PSAST,PSASTA,PSATOT,Y,ZTDESC,ZTRTN,ZTSK
"RTN","PSAUP4",20,0)
 Q
"RTN","PSAUP4",21,0)
 ;
"RTN","PSAUP4",22,0)
START S PSAPAGE=1,PSAEND=0 D HEADER S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAUP4",23,0)
 S (PSADJDRG,PSADJSUP,PSAIECST,PSAAECST)=0,PSAPHARM=$P(PSAIN,"^",7),PSAMV=$P(PSAIN,"^",12)
"RTN","PSAUP4",24,0)
 W !,"PRIME VENDOR : ",$S($P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")'="":$P($G(^("DS")),"^"),1:"UNKNOWN")
"RTN","PSAUP4",25,0)
 W !!,"ORDER#  : "_$P(PSAIN,"^",4),?40,"ORDER DATE  : "_$$DATE($P(PSAIN,"^",3))
"RTN","PSAUP4",26,0)
 W !,"INVOICE#: "_$P(PSAIN,"^",2),?40,"INVOICE DATE: "_$$DATE(+PSAIN)
"RTN","PSAUP4",27,0)
 S PSASTA=$P(PSAIN,"^",8)
"RTN","PSAUP4",28,0)
 W !,"STATUS  : "_$S(PSASTA="":"UPLOADED WITH ERRORS",PSASTA="OK":"UPLOADED WITHOUT ERRORS",PSASTA="P":"PROCESSED",1:"UNKNOWN")_$S($P(PSAIN,"^",13)="SUP":" (SUPPLY INVOICE)",1:"")
"RTN","PSAUP4",29,0)
 I $Y+8>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER
"RTN","PSAUP4",30,0)
 I $E(IOST,1,2)="C-" D LINE Q
"RTN","PSAUP4",31,0)
 W !!,"DELIVERY DATE REQUESTED: ",$$DATE($P(PSAIN,"^",5))
"RTN","PSAUP4",32,0)
 W !,"DATE RECEIVED          : "_$S(+$P(PSAIN,"^",11)&($$DATE(+$P(PSAIN,"^",11))):" ("_$$DATE($P(PSAIN,"^",6))_")",1:$$DATE($P(PSAIN,"^",6)))
"RTN","PSAUP4",33,0)
 I $Y+8>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:$G(PSAOUT)  D HEADER
"RTN","PSAUP4",34,0)
 ;
"RTN","PSAUP4",35,0)
BUYSHIP W !!,"BUYER INFORMATION:",?40,"SHIPPING INFORMATION:"
"RTN","PSAUP4",36,0)
 S PSABY=$G(^XTMP("PSAPV",PSACTRL,"BY"))
"RTN","PSAUP4",37,0)
 S PSAST=$G(^XTMP("PSAPV",PSACTRL,"ST"))
"RTN","PSAUP4",38,0)
 W !?2,$P(PSABY,"^"),?42,$P(PSAST,"^")
"RTN","PSAUP4",39,0)
 I $P(PSABY,"^",2)'=""!($P(PSAST,"^",2)'="") W ! W:$P(PSABY,"^",2)'="" ?2,$P(PSABY,"^",2) W:$P(PSAST,"^",2)'="" ?42,$P(PSAST,"^",2)
"RTN","PSAUP4",40,0)
 I $P(PSABY,"^",3)'=""!($P(PSAST,"^",3)'="") W ! W:$P(PSABY,"^",3)'="" ?2,$P(PSABY,"^",3) W:$P(PSAST,"^",3)'="" ?42,$P(PSAST,"^",3)
"RTN","PSAUP4",41,0)
 W !?2,$P(PSABY,"^",4)_" "_$P(PSABY,"^",5)_"  ",$P(PSABY,"^",6)
"RTN","PSAUP4",42,0)
 W ?42,$P(PSAST,"^",4)_" "_$P(PSAST,"^",5)_"  ",$P(PSAST,"^",6)
"RTN","PSAUP4",43,0)
 I $Y+8>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER
"RTN","PSAUP4",44,0)
 ;
"RTN","PSAUP4",45,0)
DISTRIB W !!,"DISTRIBUTOR INFORMATION:"
"RTN","PSAUP4",46,0)
 S PSADS=$G(^XTMP("PSAPV",PSACTRL,"DS"))
"RTN","PSAUP4",47,0)
 W !?2,$P(PSADS,"^")
"RTN","PSAUP4",48,0)
 W:$P(PSADS,"^",2)'="" !?2,$P(PSADS,"^",2)
"RTN","PSAUP4",49,0)
 W:$P(PSADS,"^",3)'="" !?2,$P(PSADS,"^",3)
"RTN","PSAUP4",50,0)
 W !?2,$P(PSADS,"^",4)_" "_$P(PSADS,"^",5)_"  ",$P(PSADS,"^",6)
"RTN","PSAUP4",51,0)
 I $Y+8>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER
"RTN","PSAUP4",52,0)
 D LINE
"RTN","PSAUP4",53,0)
 Q
"RTN","PSAUP4",54,0)
 ;
"RTN","PSAUP4",55,0)
DATE(PSADATE)         ;convert date
"RTN","PSAUP4",56,0)
 S %=$E(PSADATE,4,5)_"/"_$E(PSADATE,6,7)_"/"_$E(PSADATE,2,3)
"RTN","PSAUP4",57,0)
 I $TR(%,"/")="" S %="UNKNOWN"
"RTN","PSAUP4",58,0)
 Q %
"RTN","PSAUP4",59,0)
 ;
"RTN","PSAUP4",60,0)
LINE ;print line items
"RTN","PSAUP4",61,0)
 D LINEHDR
"RTN","PSAUP4",62,0)
 S (PSAICOST,PSALINE,PSATOT)=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE!(PSAOUT)  S PSADATA=^(PSALINE),PSADRG=0 D  Q:PSAOUT
"RTN","PSAUP4",63,0)
 .I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER,LINEHDR
"RTN","PSAUP4",64,0)
 .K PSADJQTY,PSAQDUZ,PSAQDT,PSAQREA,PSADJORD,PSAODUZ,PSAODT,PSAOREA
"RTN","PSAUP4",65,0)
 .W !,PSALINE
"RTN","PSAUP4",66,0)
DRUG .;Drug
"RTN","PSAUP4",67,0)
 .I +$P(PSADATA,"^",15) S PSADRG=+$P(PSADATA,"^",15) W ?8,"*"_$P($G(^PSDRUG(+$P(PSADATA,"^",15),0)),"^")_$S(+$P(PSADATA,"^",6)&($P($G(^PSDRUG(+$P(PSADATA,"^",6),0)),"^")'=""):" ("_$P(^PSDRUG(+$P(PSADATA,"^",6),0),"^")_")",1:"") S PSADJDRG=1
"RTN","PSAUP4",68,0)
 .I PSADRG,$D(^PSDRUG(PSADRG,"I")) W !,?5,"** INACTIVE IN DRUG FILE **"
"RTN","PSAUP4",69,0)
 .I '+$P(PSADATA,"^",15) D
"RTN","PSAUP4",70,0)
 ..I +$P(PSADATA,"^",6),$P($G(^PSDRUG(+$P(PSADATA,"^",6),0)),"^")'="" W ?9,$P(^PSDRUG(+$P(PSADATA,"^",6),0),"^") S PSADRG=+$P(PSADATA,"^",6) Q
"RTN","PSAUP4",71,0)
 ..I $P($G(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")),"^",3)'="" W ?7,"**"_$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),"^",3)  S PSADJSUP=1,PSADRG=0 Q
"RTN","PSAUP4",72,0)
 ..W ?9,"DRUG UNKNOWN"
"RTN","PSAUP4",73,0)
 .I $P(PSADATA,"^",19)="CS" W " (CONTROLLED SUBS)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT  W !?5,"*** INACTIVE IN MASTER VAULT"
"RTN","PSAUP4",74,0)
 .E  I PSADRG,$P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !?5,"*** INACTIVE IN PHARMACY LOCATION"
"RTN","PSAUP4",75,0)
 .;UPC
"RTN","PSAUP4",76,0)
 .I $P($P(PSADATA,"^",26),"~")'="" W !?9,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUP4",77,0)
 .;NDC
"RTN","PSAUP4",78,0)
 .S PSANDC=$P($P(PSADATA,"^",4),"~")
"RTN","PSAUP4",79,0)
 .I $E(PSANDC)'="S" D
"RTN","PSAUP4",80,0)
 ..W !?9 I PSANDC?12N W $E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12) Q
"RTN","PSAUP4",81,0)
 ..I PSANDC'="" W PSANDC Q
"RTN","PSAUP4",82,0)
 ..W "NDC UNKNOWN"
"RTN","PSAUP4",83,0)
 .;
"RTN","PSAUP4",84,0)
 .;VSN
"RTN","PSAUP4",85,0)
 .W ?25,$S($P($P(PSADATA,"^",5),"~")'="":$E($P($P(PSADATA,"^",5),"~"),1,14),1:"VSN UNKNOWN")
"RTN","PSAUP4",86,0)
 .;
"RTN","PSAUP4",87,0)
 .;QTY
"RTN","PSAUP4",88,0)
 .;No Adjusted Qty
"RTN","PSAUP4",89,0)
 .S PSAIECST=PSAIECST+($P(PSADATA,"^")*$P(PSADATA,"^",3))
"RTN","PSAUP4",90,0)
 .I $P(PSADATA,"^",8)="" W ?40,$J($P(PSADATA,"^"),6) S PSAECOST=$P(PSADATA,"^")*$P(PSADATA,"^",3),PSAAECST=PSAAECST+PSAECOST
"RTN","PSAUP4",91,0)
 .;Adj. Qty (P)
"RTN","PSAUP4",92,0)
 .I $P(PSADATA,"^",8)'="" D
"RTN","PSAUP4",93,0)
 ..S PSADJQTY=$P(PSADATA,"^",8),PSAQDUZ=$P(PSADATA,"^",9),PSAQDT=$P(PSADATA,"^",10),PSAQREA=$P(PSADATA,"^",11)
"RTN","PSAUP4",94,0)
 ..S PSAECOST=PSADJQTY*$P(PSADATA,"^",3),PSAAECST=PSAAECST+PSAECOST
"RTN","PSAUP4",95,0)
 ..W ?40,$J($P(PSADATA,"^",8),6)_"("_$P(PSADATA,"^")_")"
"RTN","PSAUP4",96,0)
 .;
"RTN","PSAUP4",97,0)
 .;Order Unit
"RTN","PSAUP4",98,0)
 .I '+$P(PSADATA,"^",12) D
"RTN","PSAUP4",99,0)
 ..I +$P($P(PSADATA,"^",2),"~",2),$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",2),0)),"^")'="" W ?53,$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",2),0)),"^") Q
"RTN","PSAUP4",100,0)
 ..I $P($P(PSADATA,"^",2),"~")="" W ?50,"(Blank)"
"RTN","PSAUP4",101,0)
 .;Adj. OU (P)
"RTN","PSAUP4",102,0)
 .I +$P(PSADATA,"^",12) S PSADJORD=$P(PSADATA,"^",12),PSAODUZ=$P(PSADATA,"^",13),PSAODT=$P(PSADATA,"^",14) W ?53,$P($G(^DIC(51.5,+$P(PSADATA,"^",12),0)),"^")_"("_$P($P(PSADATA,"^",2),"~")_")"
"RTN","PSAUP4",103,0)
 .;Unit price
"RTN","PSAUP4",104,0)
 .S PSADEC=$S($L($P($P(PSADATA,"^",3),".",2))>1:$L($P($P(PSADATA,"^",3),".",2)),1:2)
"RTN","PSAUP4",105,0)
 .W ?59,$J($P(PSADATA,"^",3),7,PSADEC)
"RTN","PSAUP4",106,0)
 .;Extended cost
"RTN","PSAUP4",107,0)
 .W ?67,$J(PSAECOST,12,2)
"RTN","PSAUP4",108,0)
 .I $Y+9>IOSL,+$P(PSADATA,"^",21),+$P(PSADATA,"^",27) D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER,LINEHDR
"RTN","PSAUP4",109,0)
 .I $G(PSADRG) D HAVEDRG
"RTN","PSAUP4",110,0)
 .I '$G(PSADRG) W !?9,"STOCK LEVEL  : ",!?9,"REORDER LEVEL: "_$P(PSADATA,"^",21),!?9,"DISPENSE UNITS/ORDER UNIT: "
"RTN","PSAUP4",111,0)
 .;
"RTN","PSAUP4",112,0)
 .;Print Adj Qty
"RTN","PSAUP4",113,0)
 .I $G(PSADJQTY)'="" D
"RTN","PSAUP4",114,0)
 ..I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER,LINEHDR
"RTN","PSAUP4",115,0)
 ..W !!?9,"ADJUSTED QUANTITY: "_PSADJQTY,!?9,$$DATE(PSAQDT)_" "_$P($G(^VA(200,+PSAQDUZ,0)),"^"),!?11,PSAQREA
"RTN","PSAUP4",116,0)
 .;Print Adj OU
"RTN","PSAUP4",117,0)
 .I +$G(PSADJORD) D
"RTN","PSAUP4",118,0)
 ..I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER,LINEHDR
"RTN","PSAUP4",119,0)
 ..W !!,?9,"ADJUSTED ORDER UNIT: "_$P($G(^DIC(51.5,+PSADJORD,0)),"^")
"RTN","PSAUP4",120,0)
 ..W !?9,$$DATE(PSAODT)_" "_$P($G(^VA(200,+PSAODUZ,0)),"^")_" - "_$P($G(^DIC(51.5,PSADJORD,0)),"^")
"RTN","PSAUP4",121,0)
 .W !
"RTN","PSAUP4",122,0)
 Q:PSAOUT
"RTN","PSAUP4",123,0)
 I $Y+6>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER
"RTN","PSAUP4",124,0)
 W !,PSASLN
"RTN","PSAUP4",125,0)
 W:$G(PSAAECST)'=$G(PSAIECST) !?48,"TOTAL ADUSTED COST",?67,$J(PSAAECST,12,2),!
"RTN","PSAUP4",126,0)
 W !?48,"TOTAL INVOICED COST",?67,$J(PSAIECST,12,2)
"RTN","PSAUP4",127,0)
 S PSAEND=1
"RTN","PSAUP4",128,0)
 I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN Q:PSAOUT  D HEADER
"RTN","PSAUP4",129,0)
 I PSADJDRG,$E(IOST)'="C" W !!,"* THE DRUG WAS MATCHED TO THE DRUG FILE."
"RTN","PSAUP4",130,0)
 I PSADJSUP,$E(IOST)'="C" W !!,"* THE ITEM IS A SUPPLY ITEM."
"RTN","PSAUP4",131,0)
 D:$E(IOST,1,2)="C-" SCREEN
"RTN","PSAUP4",132,0)
 Q
"RTN","PSAUP4",133,0)
 ;
"RTN","PSAUP4",134,0)
LINEHDR ;item header
"RTN","PSAUP4",135,0)
 W !?50,"ORDER",?62,"COST/",?71,"EXTENDED"
"RTN","PSAUP4",136,0)
 W !,"LINE#",?9,"NDC",?25,"VSN",?43,"QTY",?51,"UNIT",?62,"UNIT",?75,"COST",!,PSADLN,!
"RTN","PSAUP4",137,0)
 Q
"RTN","PSAUP4",138,0)
 ;
"RTN","PSAUP4",139,0)
HEADER ;Page header
"RTN","PSAUP4",140,0)
 I PSAFPG&($E(IOST,1,2)="C-") W @IOF G HDR1
"RTN","PSAUP4",141,0)
 S PSAFPG=0
"RTN","PSAUP4",142,0)
 W:'PSAFPG @IOF
"RTN","PSAUP4",143,0)
HDR1 W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE"
"RTN","PSAUP4",144,0)
 W !?26,"PRIME VENDOR UPLOAD REPORT",!
"RTN","PSAUP4",145,0)
 W:PSAPAGE'=1 !,"ORDER#: "_$P(PSAIN,"^",4)_"  INVOICE#: "_$P(PSAIN,"^",2)
"RTN","PSAUP4",146,0)
 I $E(IOST,1,2)="C-" W ?(74-$L(PSAPAGE)),"PAGE "_PSAPAGE,!,PSADLN
"RTN","PSAUP4",147,0)
 I $E(IOST)'="C" W !,"RUN: "_PSARUN,?(74-$L(PSAPAGE)),"PAGE "_PSAPAGE,!,PSADLN
"RTN","PSAUP4",148,0)
 S PSAPAGE=PSAPAGE+1
"RTN","PSAUP4",149,0)
 Q
"RTN","PSAUP4",150,0)
SCREEN ;Hold on screen
"RTN","PSAUP4",151,0)
 S PSAS=20-$Y I PSAS F PSASS=1:1:PSAS W !
"RTN","PSAUP4",152,0)
 I PSADJDRG,PSAEND W !," * THE DRUG WAS MATCHED TO THE DRUG FILE."
"RTN","PSAUP4",153,0)
 I PSADJSUP,PSAEND W !,"** THE ITEM IS A SUPPLY ITEM."
"RTN","PSAUP4",154,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1
"RTN","PSAUP4",155,0)
 Q
"RTN","PSAUP4",156,0)
 ;
"RTN","PSAUP4",157,0)
HAVEDRG ;Display data if drug is found.
"RTN","PSAUP4",158,0)
 S PSACS=$S($P(^PSDRUG(PSADRG,2),"^",3)["N":1,1:0)
"RTN","PSAUP4",159,0)
 I PSACS D
"RTN","PSAUP4",160,0)
 .I PSAMV,+$P($G(^PSD(58.8,PSAMV,0)),"^",14) D  Q
"RTN","PSAUP4",161,0)
 ..W !?9,"STOCK LEVEL  : "_$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),1:+$P($G(^PSD(58.8,PSAMV,1,PSADRG,0)),"^",3))
"RTN","PSAUP4",162,0)
 ..W !?9,"REORDER LEVEL: "_$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),1:+$P($G(^PSD(58.8,PSAMV,1,PSADRG,0)),"^",5))
"RTN","PSAUP4",163,0)
 .I 'PSAMV W !?9,"STOCK LEVEL  : "_$P(PSADATA,"^",27),!?9,"REORDER LEVEL: "_$P(PSADATA,"^",21)
"RTN","PSAUP4",164,0)
 I 'PSACS D
"RTN","PSAUP4",165,0)
 .I PSAPHARM,+$P($G(^PSD(58.8,PSAPHARM,0)),"^",14) D
"RTN","PSAUP4",166,0)
 ..W !?9,"STOCK LEVEL  : "_$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),1:+$P($G(^PSD(58.8,PSAPHARM,1,PSADRG,0)),"^",3))
"RTN","PSAUP4",167,0)
 ..W !?9,"REORDER LEVEL: "_$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),1:+$P($G(^PSD(58.8,PSAPHARM,1,PSADRG,0)),"^",5))
"RTN","PSAUP4",168,0)
 .I 'PSAPHARM W !?9,"STOCK LEVEL  : "_$P(PSADATA,"^",27),!?9,"REORDER LEVEL: "_$P(PSADATA,"^",21)
"RTN","PSAUP4",169,0)
 W !?9,"DISPENSE UNITS/ORDER UNIT: "
"RTN","PSAUP4",170,0)
 W $S(+$P(PSADATA,"^",20):+$P(PSADATA,"^",20),+$P($G(^PSDRUG(PSADRG,1,+$P(PSADATA,"^",7),0)),"^",7):+$P($G(^PSDRUG(PSADRG,1,+$P(PSADATA,"^",7),0)),"^",7),1:"")
"RTN","PSAUP4",171,0)
 Q
"RTN","PSAUP5")
0^1^B49555466
"RTN","PSAUP5",1,0)
PSAUP5 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;10/9/97
"RTN","PSAUP5",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUP5",3,0)
 ;This routine looks in the DRUG file for each line item on the order.
"RTN","PSAUP5",4,0)
 ;It looks for the NDC then VSN. If it is not found, no data is stored.
"RTN","PSAUP5",5,0)
 ;
"RTN","PSAUP5",6,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAUP5",7,0)
 .I '$D(^XTMP("PSAPV",PSACTRL,"IN"))!($P($G(^XTMP("PSAPV",PSACTRL,"IN")),"^",8)="P") Q
"RTN","PSAUP5",8,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2),PSACS=0
"RTN","PSAUP5",9,0)
 .W !,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN)
"RTN","PSAUP5",10,0)
 .S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAUP5",11,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE))  Q:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P"
"RTN","PSAUP5",12,0)
 ..S PSAOK=1,PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSANDC=$P(PSADATA,"^",4),PSAVSN=$P(PSADATA,"^",5)
"RTN","PSAUP5",13,0)
 ..DO GETDRUG W "."
"RTN","PSAUP5",14,0)
 ..S:PSAOK $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="OK"
"RTN","PSAUP5",15,0)
 .S (PSACNT,PSALLCS,PSALLOK,PSASUP)=0
"RTN","PSAUP5",16,0)
 .S:PSACS $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAUP5",17,0)
 .S PSALINE=0 F  S PSALINE=+$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAUP5",18,0)
 ..S PSACNT=PSACNT+1
"RTN","PSAUP5",19,0)
 ..S:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS" PSALLCS=PSALLCS+1
"RTN","PSAUP5",20,0)
 ..S:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="OK" PSALLOK=PSALLOK+1
"RTN","PSAUP5",21,0)
 ..S:'+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) PSASUP=PSASUP+1
"RTN","PSAUP5",22,0)
 .I PSACNT=PSASUP S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP"
"RTN","PSAUP5",23,0)
 .I PSACNT=PSALLCS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS"
"RTN","PSAUP5",24,0)
 .I PSACNT=PSALLOK S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="OK"
"RTN","PSAUP5",25,0)
 Q
"RTN","PSAUP5",26,0)
 ;
"RTN","PSAUP5",27,0)
GETDRUG ;Looks for NDC then VSNs in DRUG file.
"RTN","PSAUP5",28,0)
 ;Dave B (PSA*3*2)
"RTN","PSAUP5",29,0)
 I $D(PSANDC) S PSANDC=$P(PSANDC,"~")
"RTN","PSAUP5",30,0)
 I $D(PSAVSN) S PSAVSN=$P(PSAVSN,"~")
"RTN","PSAUP5",31,0)
 G:PSANDC=0 GETVSN
"RTN","PSAUP5",32,0)
 I PSANDC'="" S PSAIEN=+$O(^PSDRUG("C",PSANDC,0)) I PSAIEN S PSASUB=+$O(^PSDRUG("C",PSANDC,PSAIEN,0)) G FOUND
"RTN","PSAUP5",33,0)
 ;
"RTN","PSAUP5",34,0)
GETVSN ;Looks for Vendor Stock Number then NDC.
"RTN","PSAUP5",35,0)
 I PSAVSN'="" S PSAIEN=+$O(^PSDRUG("AVSN",PSAVSN,0)) I PSAIEN S PSASUB=+$O(^PSDRUG("AVSN",PSAVSN,PSAIEN,0)) G FOUND
"RTN","PSAUP5",36,0)
 ;
"RTN","PSAUP5",37,0)
 I (PSANDC=""&PSAVSN=""),$P(PSADATA,"^",26)'="" D ^PSAUP6
"RTN","PSAUP5",38,0)
 ;
"RTN","PSAUP5",39,0)
 S:'+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) PSAOK=0
"RTN","PSAUP5",40,0)
 G UOM
"RTN","PSAUP5",41,0)
 ;
"RTN","PSAUP5",42,0)
FOUND ;Store line item data if ordered item was found in DRUG file.
"RTN","PSAUP5",43,0)
 I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" S PSACS=1,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS"
"RTN","PSAUP5",44,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSAUP5",45,0)
 ;
"RTN","PSAUP5",46,0)
NDC ;If >1 NDC in DRUG file, store how many.
"RTN","PSAUP5",47,0)
 ;^XTMP $P4=NDC ~ # of nodes with same VSN (if >1 NDC) ~ VSN if different
"RTN","PSAUP5",48,0)
 ;          than one on SYNONYM multiple (if 1 NDC)
"RTN","PSAUP5",49,0)
 I PSANDC'="",$O(^PSDRUG("C",PSANDC,0)) D
"RTN","PSAUP5",50,0)
 .S (PSACNT,PSACNT1,PSAFND,PSAFND1,PSAIEN50)=0
"RTN","PSAUP5",51,0)
 .;
"RTN","PSAUP5",52,0)
 .;DAVE B (PSA*3*2)
"RTN","PSAUP5",53,0)
 .F  S PSAIEN50=+$O(^PSDRUG("C",PSANDC,PSAIEN50)) Q:'PSAIEN50  I '$D(^PSDRUG(PSAIEN50,"I")) S PSASYN=0 F  S PSASYN=+$O(^PSDRUG("C",PSANDC,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSAUP5",54,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAUP5",55,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)=PSAVSN S PSAFND=PSAFND+1,PSAFND1=PSAIEN50_"^"_PSASYN Q
"RTN","PSAUP5",56,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)'=PSAVSN S PSACNT=PSACNT+1,PSACNT1=PSAIEN50_"^"_PSASYN
"RTN","PSAUP5",57,0)
 .;
"RTN","PSAUP5",58,0)
 .;If NDC & VSN match, set ^XTMP
"RTN","PSAUP5",59,0)
 .I PSAFND=1 S PSAIEN=$P(PSAFND1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSAFND1,"^",2),$P(^(PSALINE),"^",7)=PSASUB,$P(^(PSALINE),"^",4)=PSANDC Q
"RTN","PSAUP5",60,0)
 .;
"RTN","PSAUP5",61,0)
 .;If >1 with same NDC & VSN, set # with same NDC & VSN in ^XTMP & flag
"RTN","PSAUP5",62,0)
 .I PSAFND>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)_"~"_PSAFND,PSAOK=0 Q
"RTN","PSAUP5",63,0)
 .;
"RTN","PSAUP5",64,0)
 .;If 1 NDC and ...
"RTN","PSAUP5",65,0)
 .I PSACNT=1 S PSAIEN=$P(PSACNT1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB D  Q
"RTN","PSAUP5",66,0)
 ..;VSN is null, accept as found & set ^XTMP
"RTN","PSAUP5",67,0)
 ..I $P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",4)="" S PSAIEN=$P(PSACNT1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB,$P(^(PSALINE),"^",4)=PSANDC Q
"RTN","PSAUP5",68,0)
 ..;Different VSN, set VSN in NDC piece in ^XTMP
"RTN","PSAUP5",69,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)_"~~"_$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",4),PSAOK=0
"RTN","PSAUP5",70,0)
 .;
"RTN","PSAUP5",71,0)
 .;If >1 NDC with differnt VSN, set flag in NDC piece of ^XTMP
"RTN","PSAUP5",72,0)
 .I PSACNT>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)_"~"_PSACNT,PSAOK=0
"RTN","PSAUP5",73,0)
 ;
"RTN","PSAUP5",74,0)
VSN ;If there >1 VSN with same VSN, store how many.
"RTN","PSAUP5",75,0)
 ;^XTMP $P5=VSN ~ # of nodes with same UOM (if >1 VSN) ~ NDC if different
"RTN","PSAUP5",76,0)
 ;          than one on SYNONYM multiple (if 1 VSN)
"RTN","PSAUP5",77,0)
 I PSAVSN'="",$O(^PSDRUG("AVSN",PSAVSN,0))  D
"RTN","PSAUP5",78,0)
 .S (PSACNT,PSACNT1,PSAFND,PSAFND1,PSAIEN50)=0
"RTN","PSAUP5",79,0)
 .;
"RTN","PSAUP5",80,0)
 .;DAVE B (PSA*3*2)
"RTN","PSAUP5",81,0)
 .F  S PSAIEN50=+$O(^PSDRUG("AVSN",PSAVSN,PSAIEN50)) Q:'PSAIEN50  I '$D(^PSDRUG(PSAIEN50,"I")) S PSASYN=0 F  S PSASYN=+$O(^PSDRUG("AVSN",PSAVSN,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSAUP5",82,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAUP5",83,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^")=PSANDC S PSAFND=PSAFND+1,PSAFND1=PSAIEN50_"^"_PSASYN Q
"RTN","PSAUP5",84,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^")'=PSANDC S PSACNT=PSACNT+1,PSACNT1=PSAIEN50_"^"_PSASYN
"RTN","PSAUP5",85,0)
 .;
"RTN","PSAUP5",86,0)
 .;If VSN & NDC match, set ^XTMP
"RTN","PSAUP5",87,0)
 .I PSAFND=1 D  Q
"RTN","PSAUP5",88,0)
 ..I '+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) D
"RTN","PSAUP5",89,0)
 ...S PSAIEN=$P(PSAFND1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSAFND1,"^",2),$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSAUP5",90,0)
 ...S:$P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS",PSACS=1
"RTN","PSAUP5",91,0)
 ...S:$P($G(^PSDRUG(PSAIEN,2)),"^",3)'["N" $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="",PSACS=0
"RTN","PSAUP5",92,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN
"RTN","PSAUP5",93,0)
 .;
"RTN","PSAUP5",94,0)
 .;If >1 with same VSN & NDC, set # with same NDC & VSN in ^XTMP & flag
"RTN","PSAUP5",95,0)
 .I PSAFND>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)_"~"_PSAFND,PSAOK=0 Q
"RTN","PSAUP5",96,0)
 .;
"RTN","PSAUP5",97,0)
 .;If 1 VSN and ...
"RTN","PSAUP5",98,0)
 .I PSACNT=1 D  Q
"RTN","PSAUP5",99,0)
 ..I '+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) S PSAIEN=$P(PSACNT1,"^"),$P(^(PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSAUP5",100,0)
 ..;NDC is null, accept as found & set ^XTMP
"RTN","PSAUP5",101,0)
 ..I $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)="" S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^") Q
"RTN","PSAUP5",102,0)
 ..;Different VSN, set VSN in NDC piece in ^XTMP
"RTN","PSAUP5",103,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)_"~~"_$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^"),PSAOK=0
"RTN","PSAUP5",104,0)
 .;
"RTN","PSAUP5",105,0)
 .;If >1 VSN with different NDC, set flag in NDC piece of ^XTMP
"RTN","PSAUP5",106,0)
 .I PSACNT>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)_"~"_PSACNT,PSAOK=0
"RTN","PSAUP5",107,0)
 ;
"RTN","PSAUP5",108,0)
UOM ;Locates X12 Unit of Measure Code in ORDER UNIT file.
"RTN","PSAUP5",109,0)
 ;^XTMP $P2=Alpha OU ~ 51.5 IEN
"RTN","PSAUP5",110,0)
 K PSAUOM I $P(PSADATA,"^",2)="" S PSAOK=0 G QTY
"RTN","PSAUP5",111,0)
 ;
"RTN","PSAUP5",112,0)
 ;If order unit is standard order unit, set IEN in ^XTMP
"RTN","PSAUP5",113,0)
 S PSAUOM=$O(^DIC(51.5,"B",$P($P(PSADATA,"^",2),"~"),0))
"RTN","PSAUP5",114,0)
 I 'PSAUOM D  Q:'PSAOK
"RTN","PSAUP5",115,0)
 .I +$P(PSADATA,"^",6),+$P(PSADATA,"^",7),+$P($G(^PSDRUG(PSAIEN,1,+$P(PSADATA,"^",7),0)),"^",5) D
"RTN","PSAUP5",116,0)
 ..S PSAUOM=+$P($G(^PSDRUG(PSAIEN,1,+$P(PSADATA,"^",7),0)),"^",5),PSAUOMN=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2),"~")
"RTN","PSAUP5",117,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2)=PSAUOMN_"~"_PSAUOM K PSAUOMN
"RTN","PSAUP5",118,0)
 .S:'PSAUOM PSAOK=0
"RTN","PSAUP5",119,0)
 I PSAUOM S PSAUOMN=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2),"~"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2)=PSAUOMN_"~"_PSAUOM K PSAUOMN
"RTN","PSAUP5",120,0)
 ;
"RTN","PSAUP5",121,0)
QTY ;If qty is 0 or blank, set flag
"RTN","PSAUP5",122,0)
 I '+$P(PSADATA,"^") S PSAOK=0 Q
"RTN","PSAUP5",123,0)
 ;
"RTN","PSAUP5",124,0)
DUOU ;If no dispense units per order unit, set flag.
"RTN","PSAUP5",125,0)
 S PSADRG=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6),PSASYN=$P(^(PSALINE),"^",7)
"RTN","PSAUP5",126,0)
 S:'PSASYN PSAOK=0
"RTN","PSAUP5",127,0)
 I PSASYN,'$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",7) S PSAOK=0
"RTN","PSAUP5",128,0)
 Q
"RTN","PSAUP6")
0^36^B8138399
"RTN","PSAUP6",1,0)
PSAUP6 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAUP6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUP6",3,0)
 ;This routine looks in the DRUG file for a supply line item. It looks
"RTN","PSAUP6",4,0)
 ;for a NDC with an "S" in front of the UPC. It then looks for a matching
"RTN","PSAUP6",5,0)
 ;VSN. If it is found, the NDC becomes "S"_UPC.
"RTN","PSAUP6",6,0)
 ;
"RTN","PSAUP6",7,0)
UPC ;If there is no NDC, the VSN is not found, & there is a UPC, look
"RTN","PSAUP6",8,0)
 ;for a supply item.
"RTN","PSAUP6",9,0)
 S (PSACNT,PSACNT1,PSAFND,PSAFND1,PSAIEN50)=0,PSASUP="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUP6",10,0)
 F  S PSAIEN50=+$O(^PSDRUG("C",PSASUP,PSAIEN50)) Q:'PSAIEN50  S PSASYN=0 F  S PSASYN=+$O(^PSDRUG("C",PSASUP,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSAUP6",11,0)
 .Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSAUP6",12,0)
 .;DAVE B (PSA*3*3)
"RTN","PSAUP6",13,0)
 .Q:$D(^PSDRUG(PSAIEN50,"I"))
"RTN","PSAUP6",14,0)
 .I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)=PSAVSN S PSAFND=PSAFND+1,PSAFND1=PSAIEN50_"^"_PSASYN Q
"RTN","PSAUP6",15,0)
 .I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)'=PSAVSN S PSACNT=PSACNT+1,PSACNT1=PSAIEN50_"^"_PSASYN
"RTN","PSAUP6",16,0)
 ;
"RTN","PSAUP6",17,0)
 ;If VSN & UPC match, set ^XTMP
"RTN","PSAUP6",18,0)
 I PSAFND=1 D  Q
"RTN","PSAUP6",19,0)
 .S PSAIEN=$P(PSAFND1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSAFND1,"^",2),$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSAUP6",20,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN,PSANDC=PSASUP,$P(^(PSALINE),"^",4)=PSANDC
"RTN","PSAUP6",21,0)
 ;
"RTN","PSAUP6",22,0)
 ;If >1 with same VSN & UPC, set # with same UPC & VSN in ^XTMP & flag
"RTN","PSAUP6",23,0)
 I PSAFND>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)_"~"_PSAFND,PSAOK=0 Q
"RTN","PSAUP6",24,0)
 ;
"RTN","PSAUP6",25,0)
 ;If 1 UPC and ...
"RTN","PSAUP6",26,0)
 I PSACNT=1 S PSAIEN=$P(PSACNT1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB D  Q
"RTN","PSAUP6",27,0)
 .;VSN is null, accept as found & set ^XTMP
"RTN","PSAUP6",28,0)
 .I $P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",4)="" S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN,PSANDC=PSASUP,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC Q
"RTN","PSAUP6",29,0)
 .;Different VSN, set VSN in UPC piece in ^XTMP
"RTN","PSAUP6",30,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)_"~~"_$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),PSAOK=0
"RTN","PSAUP6",31,0)
 ;
"RTN","PSAUP6",32,0)
 ;If >1 VSN with differnt NDC, set flag in NDC piece of ^XTMP
"RTN","PSAUP6",33,0)
 I PSACNT>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",26)_"~"_PSACNT,PSAOK=0
"RTN","PSAUP6",34,0)
 Q
"RTN","PSAUTL1")
0^25^B35221116
"RTN","PSAUTL1",1,0)
PSAUTL1 ;BIR/JMB-Prime Vendor Invoice Data Utility ;9/19/97
"RTN","PSAUTL1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUTL1",3,0)
 ;This routine contains utilities to get the location name, display an
"RTN","PSAUTL1",4,0)
 ;error-free item, display an item with errors, and display a line ready
"RTN","PSAUTL1",5,0)
 ;for verification. It is called by PSADJ, PSAHIS, PSALEVEL, PSALEVRP,
"RTN","PSAUTL1",6,0)
 ;PSANDF, PSAPROC, PSAPROC1, PSAPROC2, PSAPROC4, PSAPROC6, PSAPROC9,
"RTN","PSAUTL1",7,0)
 ;PSAREORD, PSAUTL3, PSAVER, PSAVER1, PSAVER2, PSAVER4, and PSAVER5.
"RTN","PSAUTL1",8,0)
 ;
"RTN","PSAUTL1",9,0)
SITES ;Gets the combined IP/OP's IP & OP site names
"RTN","PSAUTL1",10,0)
 S PSAISIT=+$P(^PSD(58.8,PSALOC,0),"^",3),PSAOSIT=+$P(^(0),"^",10)
"RTN","PSAUTL1",11,0)
 S PSAISITN=$S($P($G(^PS(59.4,PSAISIT,0)),"^")'="":$P($G(^PS(59.4,PSAISIT,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",12,0)
 S PSAOSITN=$S($P($G(^PS(59,PSAOSIT,0)),"^")'="":$P($G(^PS(59,PSAOSIT,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",13,0)
 I PSAISIT,PSAOSIT S PSACOMB=": "_PSAISITN_" (IP) "_PSAOSITN_" (OP)" Q
"RTN","PSAUTL1",14,0)
 I PSAISIT S PSACOMB=": "_PSAISITN_" (IP)" Q
"RTN","PSAUTL1",15,0)
 I PSAOSIT S PSACOMB=": "_PSAOSITN_" (OP)" Q
"RTN","PSAUTL1",16,0)
 Q
"RTN","PSAUTL1",17,0)
 ;
"RTN","PSAUTL1",18,0)
DISPLAY ;Displays an error-free line item
"RTN","PSAUTL1",19,0)
 S PSADISP=1
"RTN","PSAUTL1",20,0)
 S PSAIEN=$P(PSADATA,"^",6),PSASUB=$P($P(PSADATA,"^",7),"~"),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~")
"RTN","PSAUTL1",21,0)
 W !,PSALINE_"  "_$S($P($G(^PSDRUG(PSAIEN,0)),"^")'="":$P(^PSDRUG(PSAIEN,0),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",22,0)
 I PSAIEN D
"RTN","PSAUTL1",23,0)
 .I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **" Q
"RTN","PSAUTL1",24,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL1",25,0)
 .I $D(^PSDRUG(PSAIEN,"I")) W !?5,"** INACTIVE IN DRUG FILE **"
"RTN","PSAUTL1",26,0)
 W !,"Qty Invoiced: "_+$P(PSADATA,"^")
"RTN","PSAUTL1",27,0)
 W:$P($P(PSADATA,"^",26),"~")'="" ?38,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUTL1",28,0)
 W !,"Order Unit  : "
"RTN","PSAUTL1",29,0)
 S PSAOU=$S(+$P(PSADATA,"^",12):+$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),PSAIEN&(PSASUB)&(+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5)):+$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),1:0)
"RTN","PSAUTL1",30,0)
 W $S(PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",31,0)
 W:$E(PSANDC)'="S" ?38,"NDC: "_$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12)
"RTN","PSAUTL1",32,0)
 W !,"Unit Price  : $"_$P(PSADATA,"^",3),?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL1",33,0)
 W !,"Dispense Units: "_$S(+PSAIEN&($P($G(^PSDRUG(+PSAIEN,660)),"^",8)'=""):$P($G(^PSDRUG(+PSAIEN,660)),"^",8),1:"Blank")
"RTN","PSAUTL1",34,0)
 W !,"Dispense Units Per Order Unit: "_$S($P(PSADATA,"^",20):+$P(PSADATA,"^",20),+PSASUB&(+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7),1:"Blank")
"RTN","PSAUTL1",35,0)
 S PSALOC=$S($P(PSADATA,"^",19)="":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAUTL1",36,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)!('$G(PSAIEN))
"RTN","PSAUTL1",37,0)
 S PSASTOCK=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3),1:"Blank")
"RTN","PSAUTL1",38,0)
 W !,"Stock Level   : "_PSASTOCK
"RTN","PSAUTL1",39,0)
 S PSAREORD=$S(+$P(PSADATA,"^",20):+$P(PSADATA,"^",20),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5),1:"Blank")
"RTN","PSAUTL1",40,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL1",41,0)
 Q
"RTN","PSAUTL1",42,0)
 ;
"RTN","PSAUTL1",43,0)
EDITDISP ;Displays a line item with errors.
"RTN","PSAUTL1",44,0)
 W @IOF,!?23,"<<< PROCESS LINE ITEM SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAUTL1",45,0)
EDIT1 S PSADATA=$G(^XTMP("PSAPV",PSACTRL,"IT",PSALINE))
"RTN","PSAUTL1",46,0)
 S PSALOC=$S($P(PSADATA,"^",19)="":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAUTL1",47,0)
 W !,PSALINE_"  "_$S($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")):$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),"^",3),PSAIEN&($P($G(^PSDRUG(PSAIEN,0)),"^")'=""):$P(^PSDRUG(PSAIEN,0),"^"),1:"UNKNOWN ITEM")
"RTN","PSAUTL1",48,0)
 I PSAIEN D
"RTN","PSAUTL1",49,0)
 .I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **" Q
"RTN","PSAUTL1",50,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL1",51,0)
 ;
"RTN","PSAUTL1",52,0)
 W !,"Qty Invoiced: "
"RTN","PSAUTL1",53,0)
 I $P(PSADATA,"^",8)'="" W $P(PSADATA,"^",8)_" ("_$S(+PSADATA:+PSADATA,$P(PSADATA,"^")=0:0,1:"Blank")_")"
"RTN","PSAUTL1",54,0)
 I $P(PSADATA,"^",8)="" W $S(+PSADATA:+PSADATA,$P(PSADATA,"^")=0:0,1:"Blank")
"RTN","PSAUTL1",55,0)
 W:$P($P(PSADATA,"^",26),"~")'="" ?38,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUTL1",56,0)
 ;
"RTN","PSAUTL1",57,0)
 W !,"Order Unit  : "
"RTN","PSAUTL1",58,0)
 I +$P(PSADATA,"^",12) D
"RTN","PSAUTL1",59,0)
 .W $P($G(^DIC(51.5,+$P(PSADATA,"^",12),0)),"^")
"RTN","PSAUTL1",60,0)
 .W " ("_$S($P($P(PSADATA,"^",2),"~")'="":$P($P(PSADATA,"^",2),"~"),$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",3),0)),"^")'="":$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",3),0)),"^"),1:"Blank")_")"
"RTN","PSAUTL1",61,0)
 I '+$P(PSADATA,"^",12) D
"RTN","PSAUTL1",62,0)
 .W $S(+$P($P(PSADATA,"^",2),"~",2):$P($P(PSADATA,"^",2),"~"),PSAIEN&(PSASUB)&(+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5)):$P($G(^DIC(51.5,+$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),0)),"^"),1:"Blank")
"RTN","PSAUTL1",63,0)
 ;
"RTN","PSAUTL1",64,0)
 W:$E(PSANDC)'="S" ?38,"NDC: "_$S(PSANDC'="":$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12),1:"Blank")
"RTN","PSAUTL1",65,0)
 S PSAPRICE=$P(PSADATA,"^",3)
"RTN","PSAUTL1",66,0)
 I +PSAPRICE,$L($P(PSAPRICE,".",2))<2 S PSAPRICE=$P(PSAPRICE,".")_"."_$P(PSAPRICE,".",2)_$E("00",1,(2-$L($P(PSAPRICE,".",2))))
"RTN","PSAUTL1",67,0)
 W !,"Unit Price  : $"_$S($G(PSAPRICE):PSAPRICE,PSAPRICE=0:0,1:"Blank"),?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL1",68,0)
 S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSALOC=$S($P(PSADATA,"^",19)="CS":+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",7))
"RTN","PSAUTL1",69,0)
DU W !,"Dispense Units: "_$S(+PSAIEN&($P($G(^PSDRUG(+PSAIEN,660)),"^",8)'=""):$P($G(^PSDRUG(+PSAIEN,660)),"^",8),1:"Blank")
"RTN","PSAUTL1",70,0)
DUOU W !,"Dispense Units Per Order Unit: "_$S($P(PSADATA,"^",20):+$P(PSADATA,"^",20),+PSASUB&(+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7),1:"Blank"),!
"RTN","PSAUTL1",71,0)
 ;
"RTN","PSAUTL1",72,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)
"RTN","PSAUTL1",73,0)
 ;
"RTN","PSAUTL1",74,0)
 S PSASTOCK=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3),1:"Blank")
"RTN","PSAUTL1",75,0)
 W "Stock Level   : "_PSASTOCK
"RTN","PSAUTL1",76,0)
 S PSAREORD=$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5),1:"Blank")
"RTN","PSAUTL1",77,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL1",78,0)
 Q
"RTN","PSAUTL4")
0^26^B23488821
"RTN","PSAUTL4",1,0)
PSAUTL4 ;BIR ISC/JMB-Verify Invoices Utility ; 8/19/97
"RTN","PSAUTL4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAUTL4",3,0)
 ;This routine contains an utility to display a line item ready for
"RTN","PSAUTL4",4,0)
 ;verification. It is called by PSAVER1 and PSAVER2.
"RTN","PSAUTL4",5,0)
 ;
"RTN","PSAUTL4",6,0)
VERDISP ;Displays a line item on a processed or verified invoice
"RTN","PSAUTL4",7,0)
 W PSALINEN_"  "
"RTN","PSAUTL4",8,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAUTL4",9,0)
 I $G(PSADJ) D
"RTN","PSAUTL4",10,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAUTL4",11,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",12,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAUTL4",13,0)
 .S PSADRG=$S(PSADJ&('PSASUP):$G(PSADJD),PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAUTL4",14,0)
 .I $G(PSADJD),$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" W "*"_$P($G(^PSDRUG(+PSADJD,0)),"^") S (PSADRG,PSA50IEN)=+PSADJD Q
"RTN","PSAUTL4",15,0)
 .I $G(PSADJD),$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAUTL4",16,0)
 .W ?7,"**"_PSADJD S PSADJSUP=1,(PSADRG,PSA50IEN)=PSADJD
"RTN","PSAUTL4",17,0)
 I '$G(PSADJ) D
"RTN","PSAUTL4",18,0)
 .S (PSA50IEN,PSADRG)=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAUTL4",19,0)
 .W $S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):$P(^PSDRUG(+$P(PSADATA,"^",2),0),"^"),1:"DRUG UNKNOWN")
"RTN","PSAUTL4",20,0)
 I PSADRG D
"RTN","PSAUTL4",21,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **"
"RTN","PSAUTL4",22,0)
 .I $D(^PSDRUG(PSADRG,"I")) W !?5,"** INACTIVE IN DRUG FILE **" Q
"RTN","PSAUTL4",23,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL4",24,0)
QTY W !,"Qty Invoiced: "
"RTN","PSAUTL4",25,0)
 ;No Adj. Qty
"RTN","PSAUTL4",26,0)
 S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAUTL4",27,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",28,0)
 ;Adj. Qty
"RTN","PSAUTL4",29,0)
 I $G(PSADJQ) S PSAQTY=PSADJQ W PSAQTY_" ("_$S($P(PSADATA,"^",3):$P(PSADATA,"^",3),$P(PSADATA,"^",3)=0:0,1:"Blank")_")"
"RTN","PSAUTL4",30,0)
 I '$G(PSADJQ) W $P(PSADATA,"^",3) S PSAQTY=$P(PSADATA,"^",3)
"RTN","PSAUTL4",31,0)
UPC W:$P(PSADATA,"^",13)'="" ?38,"UPC: "_$P(PSADATA,"^",13)
"RTN","PSAUTL4",32,0)
OU W !,"Order Unit  : "
"RTN","PSAUTL4",33,0)
 S PSAOU=$S(+$P(PSADATA,"^",4)&($P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'=""):+$P(PSADATA,"^",4),1:"")
"RTN","PSAUTL4",34,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAUTL4",35,0)
 I +$P(PSATEMP,"^",3),PSADRG,+$P($G(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0)),"^",5) S PSAOU=+$P(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0),"^",5)
"RTN","PSAUTL4",36,0)
 S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAUTL4",37,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",38,0)
 ;Adj. Order Unit
"RTN","PSAUTL4",39,0)
 I PSADJO'="" W $S(+PSADJO&($P($G(^DIC(51.5,+PSADJO,0)),"^")'=""):$P($G(^DIC(51.5,+PSADJO,0)),"^"),1:"UNKNOWN")_" ("_$S(PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")_")" S PSAOU=+PSADJO
"RTN","PSAUTL4",40,0)
 I PSADJO="" W $S(+PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")
"RTN","PSAUTL4",41,0)
 ;
"RTN","PSAUTL4",42,0)
NDC S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAUTL4",43,0)
 I $E(PSANDC)'="S" W ?38,"NDC: "_$S(PSANDC'="":$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12),1:"Blank")
"RTN","PSAUTL4",44,0)
 ;
"RTN","PSAUTL4",45,0)
PRICE W !,"Unit Price  : $"
"RTN","PSAUTL4",46,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAUTL4",47,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAUTL4",48,0)
 ;Adj. Unit Price
"RTN","PSAUTL4",49,0)
 I $G(PSADJP) D
"RTN","PSAUTL4",50,0)
 .I $L($P(PSADJP,".",2))<2 S PSADJP=$P(PSADJP,".")_"."_$P(PSADJP,".",2)_$E("00",1,(2-$L($P(PSADJP,".",2))))
"RTN","PSAUTL4",51,0)
 .W $FN(PSADJP,",")_" ($"_$S(+$P(PSADATA,"^",5):$FN($P(PSADATA,"^",5),","),$P(PSADATA,"^",5)=0:"0.00",1:"")_")"
"RTN","PSAUTL4",52,0)
 .S PSAPRICE=PSADJP
"RTN","PSAUTL4",53,0)
 I '$G(PSADJP) D
"RTN","PSAUTL4",54,0)
 .S PSAPRICE=+$P(PSADATA,"^",5)
"RTN","PSAUTL4",55,0)
 .I $G(PSAPRICE)!(PSAPRICE=0) W $S($G(PSAPRICE):PSAPRICE,1:"0.00") Q
"RTN","PSAUTL4",56,0)
 .W "Blank"
"RTN","PSAUTL4",57,0)
 ;
"RTN","PSAUTL4",58,0)
VSN W ?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL4",59,0)
VDU S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAUTL4",60,0)
 W !,"Dispense Units: "_$S($P($G(^PSDRUG(+PSADRG,660)),"^",8)'="":$P($G(^PSDRUG(+PSADRG,660)),"^",8),1:"Blank")
"RTN","PSAUTL4",61,0)
VDUOU W !,"Dispense Units Per Order Unit: "_$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(+PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSADRG,1,PSASUB,0)),"^",7),1:"Blank"),!
"RTN","PSAUTL4",62,0)
 ;
"RTN","PSAUTL4",63,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)
"RTN","PSAUTL4",64,0)
 ;
"RTN","PSAUTL4",65,0)
STOCK S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3),1:"Blank")
"RTN","PSAUTL4",66,0)
 W "Stock Level   : "_PSASTOCK
"RTN","PSAUTL4",67,0)
REORDER S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5),1:"Blank")
"RTN","PSAUTL4",68,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL4",69,0)
 Q
"RTN","PSAVER2")
0^11^B44719783
"RTN","PSAVER2",1,0)
PSAVER2 ;BIR/JMB-Verify Invoices - CONT'D ;10/7/97
"RTN","PSAVER2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAVER2",3,0)
 ;This routine contains the prompts for the fields that the verifier
"RTN","PSAVER2",4,0)
 ;is allowed to edit.
"RTN","PSAVER2",5,0)
 ;
"RTN","PSAVER2",6,0)
ASKDRUG W !,"If the item will never be in the DRUG, press the Return key then",!,"answer YES to the ""Is this a supply item?"" prompt. To bypass this",!,"line item, enter ""^"" then press the Return key.",!
"RTN","PSAVER2",7,0)
 S PSAGAIN=0,PSABEFOR=PSADRG,DIC(0)="AEMQZ",DIC="^PSDRUG(" D ^DIC K DIC
"RTN","PSAVER2",8,0)
 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",9,0)
 S PSADJFLD="D",PSAREA="",PSASUPP=0
"RTN","PSAVER2",10,0)
 I +Y=-1 D  Q:PSASUPP!(PSAOUT)
"RTN","PSAVER2",11,0)
 .S PSAVER=1 D SUPPLY^PSANDF Q:PSAOUT  I 'PSASUPP S PSAGAIN=1 Q
"RTN","PSAVER2",12,0)
 .S PSA50IEN=0,PSADJ=PSAREA,PSAREA="" K ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)
"RTN","PSAVER2",13,0)
 .D RECORD
"RTN","PSAVER2",14,0)
 G:$G(PSAGAIN) ASKDRUG
"RTN","PSAVER2",15,0)
 S (PSA50IEN,PSADJ,PSADRG)=+Y D RECORD,HDR^PSAVER1,VERDISP^PSAUTL4
"RTN","PSAVER2",16,0)
 I PSANDC'="",$O(^PSDRUG("C",PSANDC,PSA50IEN,0)) D
"RTN","PSAVER2",17,0)
 .S PSASUB=+$O(^PSDRUG("C",PSANDC,PSA50IEN,0)),$P(^PSD(58.811,PSAIEN,1,PSAIEN1,2),"^",3)=PSASUB
"RTN","PSAVER2",18,0)
 .I '+$P($G(^PSDRUG(PSA50IEN,1,PSASUB,0)),"^",7) D DUOU Q
"RTN","PSAVER2",19,0)
 .I +$P($G(^PSDRUG(PSA50IEN,1,PSASUB,0)),"^",7),+$P($G(^PSDRUG(PSA50IEN,1,PSASUB,0)),"^",7)'=+$P($G(^PSDRUG(PSABEFOR,1,PSASUB,0)),"^",7) D DUOU
"RTN","PSAVER2",20,0)
 ;
"RTN","PSAVER2",21,0)
 I PSANDC'="",'$O(^PSDRUG("C",PSANDC,PSA50IEN,0)),PSA50IEN'=PSABEFOR D DUOU
"RTN","PSAVER2",22,0)
 ;
"RTN","PSAVER2",23,0)
 I PSANDC="",PSAUPC="" D
"RTN","PSAVER2",24,0)
 .W !,"The vendor did not send a NDC or UPC for the drug. Enter the",!,"NDC if it is available. Enter the UPC if you do not know the NDC.",!
"RTN","PSAVER2",25,0)
 .S DIR(0)="SA^N:NDC;U:UPC",DIR("A")="Will you enter the NDC or UPC? ",DIR("B")="N",DIR("??")="^D NDCUPC^PSANDF1" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",26,0)
 .I Y="N" D GETNDC^PSANDF Q:PSAOUT  S PSANDC=Y D:PSANDC'="" ADDDATA
"RTN","PSAVER2",27,0)
 .I Y="U" D GETUPC^PSANDF Q:PSAOUT  S PSANDC="S"_Y,PSAUPC=Y D:PSANDC'="" ADDDATA
"RTN","PSAVER2",28,0)
 Q
"RTN","PSAVER2",29,0)
 ;
"RTN","PSAVER2",30,0)
ADDDATA ;Adds the missing NDC and/or UPC
"RTN","PSAVER2",31,0)
 K DA S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=PSALINE,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DR="13///^S X="_PSANDC_$S(PSAUPC'="":";15///^S X="_PSAUPC,1:"")
"RTN","PSAVER2",32,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER2",33,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER2",34,0)
 K DIE I $G(DTOUT)!($G(DUOUT)) S PSAOUT=0 Q
"RTN","PSAVER2",35,0)
 D VERDISP^PSAUTL4
"RTN","PSAVER2",36,0)
 Q
"RTN","PSAVER2",37,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAVER2",38,0)
 S PSANEW=0
"RTN","PSAVER2",39,0)
 I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)="^58.811259SA^^"
"RTN","PSAVER2",40,0)
 I $D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B",PSADJFLD)) D  Q
"RTN","PSAVER2",41,0)
 .S DA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B",PSADJFLD,0))
"RTN","PSAVER2",42,0)
 .I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0)) D NEW Q
"RTN","PSAVER2",43,0)
 .D ADJ
"RTN","PSAVER2",44,0)
 ;
"RTN","PSAVER2",45,0)
NEW S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2) K DA
"RTN","PSAVER2",46,0)
 S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSALINE,X=PSADJFLD,DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811
"RTN","PSAVER2",47,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER2",48,0)
 D ^DIC L -^PSD(58.811,PSAIEN,1,PSAIEN1,0) K DIC,DLAYGO S DA=+Y
"RTN","PSAVER2",49,0)
 ;
"RTN","PSAVER2",50,0)
ADJ S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSALINE,DIE="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAVER2",51,0)
 ;
"RTN","PSAVER2",52,0)
 ;PSA*3*3 (DaveB 1JUN98)
"RTN","PSAVER2",53,0)
 S DR="5///"_PSADJ_$S(PSAREA'="":";6////^S X=PSAREA",1:"")_";7///^S X="_DT_";8////^S X="_DUZ
"RTN","PSAVER2",54,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER2",55,0)
 D ^DIE
"RTN","PSAVER2",56,0)
INDEX S DIK=DIE D IX1^DIK K DIE,DIK L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER2",57,0)
 Q
"RTN","PSAVER2",58,0)
 ;
"RTN","PSAVER2",59,0)
DUOU ;Gets Dispense Units Per Order Unit
"RTN","PSAVER2",60,0)
 W !,"DISPENSE UNITS: "_$S($P($G(^PSDRUG(PSA50IEN,660)),"^",8)'="":$P($G(^PSDRUG(PSA50IEN,660)),"^",8),1:"Blank")
"RTN","PSAVER2",61,0)
 S DIR(0)="NO^::2",DIR("A")="DISPENSE UNITS PER ORDER UNIT",DIR("B")=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^")
"RTN","PSAVER2",62,0)
 S DIR("?")="Enter the number of dispense units contained in one order unit",DIR("??")="^D DUOUHELP^PSAVER2"
"RTN","PSAVER2",63,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",64,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^")=+Y S:+Y PSASET=1
"RTN","PSAVER2",65,0)
 Q:Y'=""
"RTN","PSAVER2",66,0)
 ;
"RTN","PSAVER2",67,0)
 W !!,"The dispense units per order unit must be entered",!,"to change the status of the invoice to Verified."
"RTN","PSAVER2",68,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the data now"
"RTN","PSAVER2",69,0)
 S DIR("?",1)="Enter Yes to return to the DISPENSE UNITS PER ORDER UNIT prompt.",DIR("?")="Enter No to bypass entering the dispense units now."
"RTN","PSAVER2",70,0)
 S DIR("??")="^D DUOUYN^PSAPROC8" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",71,0)
 W ! G:+Y DUOU
"RTN","PSAVER2",72,0)
 Q
"RTN","PSAVER2",73,0)
 ;
"RTN","PSAVER2",74,0)
OU ;Get order unit
"RTN","PSAVER2",75,0)
 S DIC(0)="QAEMZ",DIC="^DIC(51.5,",DIC("A")="ORDER UNIT: ",DR=.01 S:+PSAOU&($P($G(^DIC(51.5,+PSAOU,0)),"^")'="") DIC("B")=$P(^DIC(51.5,+PSAOU,0),"^") D ^DIC K DIC
"RTN","PSAVER2",76,0)
 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",77,0)
 I +Y,+Y=+$P(PSADATA,"^",4) Q
"RTN","PSAVER2",78,0)
 G:Y=-1 OU S PSADJFLD="O",PSADJ=+Y,PSAREA="" D RECORD
"RTN","PSAVER2",79,0)
 Q
"RTN","PSAVER2",80,0)
 ;
"RTN","PSAVER2",81,0)
PHARM ;Pharmacy Location/Master Vault -- DR is set prior to the call.
"RTN","PSAVER2",82,0)
 K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1," D ^DIE K DIE
"RTN","PSAVER2",83,0)
 S:$G(DTOUT)!($G(DUOUT)) PSAOUT=1
"RTN","PSAVER2",84,0)
 Q
"RTN","PSAVER2",85,0)
 ;
"RTN","PSAVER2",86,0)
QTY ;Adjust the quantity received
"RTN","PSAVER2",87,0)
 S DIR(0)="N",DIR("A")="QUANTITY RECEIVED",DIR("B")=PSAQTY
"RTN","PSAVER2",88,0)
 S DIR("?",1)="If the quantity received is different than the invoiced or",DIR("?")="adjusted quantity, enter the correct quantity received.",DIR("??")="^D QTYHELP^PSAPROC3"
"RTN","PSAVER2",89,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",90,0)
 Q:PSAQTY=+Y  S PSADJ=+Y
"RTN","PSAVER2",91,0)
 S DIR(0)="F^1:30",DIR("A")="ADJUSTMENT REASON",DIR("?")="Enter the reason you adjusted the quantity received.",DIR("??")="^D ADJREA^PSAPROC3"
"RTN","PSAVER2",92,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",93,0)
 S PSADJFLD="Q",PSAREA=Y D RECORD
"RTN","PSAVER2",94,0)
 Q
"RTN","PSAVER2",95,0)
 ;
"RTN","PSAVER2",96,0)
RECD ;Date Received
"RTN","PSAVER2",97,0)
 K PSARECD S PSAREC=$S(+$P(PSAIN,"^",7):+$P(PSAIN,"^",7),+$P(PSAIN,"^",6):+$P(PSAIN,"^",6),1:"")
"RTN","PSAVER2",98,0)
 S DIR(0)="D",DIR("A")="Date received",DIR("?")="Enter the date the drugs were received.",DIR("??")="^D RECHELP^PSAPROC3" S:PSAREC DIR("B")=$$FMTE^XLFDT(PSAREC)
"RTN","PSAVER2",99,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",100,0)
 Q:'+$P(PSAIN,"^",7)&(+Y=+$P(PSAIN,"^",6))
"RTN","PSAVER2",101,0)
 Q:+$P(PSAIN,"^",6)'=+$P(PSAIN,"^",7)&(+$P(PSAIN,"^",7)=+Y)
"RTN","PSAVER2",102,0)
 S:+$P(PSAIN,"^",6)=+Y PSARECD="@"
"RTN","PSAVER2",103,0)
 S:+$P(PSAIN,"^",6)'=+Y&(+$P(PSAIN,"^",7)'=+Y) PSARECD=+Y
"RTN","PSAVER2",104,0)
 Q:'$D(PSARECD)  K DA
"RTN","PSAVER2",105,0)
 S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="8///"_$S(+PSARECD:"^S X="_PSARECD,1:"@")
"RTN","PSAVER2",106,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER2",107,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER2",108,0)
 K DIE
"RTN","PSAVER2",109,0)
 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1
"RTN","PSAVER2",110,0)
 Q
"RTN","PSAVER2",111,0)
 ;
"RTN","PSAVER2",112,0)
REORDER ;Enter reorder level for drug if the field is blank.
"RTN","PSAVER2",113,0)
 S DIR(0)="NO^0:99999",DIR("A")="REORDER LEVEL (in Dispense Units)",DIR("??")="^D REORD^PSAPROC8",DIR("B")=+PSAREORD
"RTN","PSAVER2",114,0)
 S DIR("?")="Enter the minimum number of dispense units to keep in the "_$S(+$P(PSADATA,"^",10):"master vault",1:"pharmacy location")_"."
"RTN","PSAVER2",115,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",116,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^",2)=+Y
"RTN","PSAVER2",117,0)
 Q
"RTN","PSAVER2",118,0)
STOCK ;Enter stock level for drug if the field is blank.
"RTN","PSAVER2",119,0)
 S DIR(0)="NO^0:99999",DIR("A")="STOCK LEVEL (in Dispense Units)",DIR("??")="^D STKLEVEL^PSAPROC8",DIR("B")=+PSASTOCK
"RTN","PSAVER2",120,0)
 S DIR("?")="Enter the ideal number of dispense units to keep on the shelf."
"RTN","PSAVER2",121,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",122,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^",4)=+Y
"RTN","PSAVER2",123,0)
 Q
"RTN","PSAVER3")
0^12^B66247490
"RTN","PSAVER3",1,0)
PSAVER3 ;BIR/JMB-Verify Invoices - CONT'D ;9/5/97
"RTN","PSAVER3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3**; 10/24/97
"RTN","PSAVER3",3,0)
 ;This routine checks for verification errors, prints an error report,
"RTN","PSAVER3",4,0)
 ;& changes data in DA ORDERS to verification if there are no errors.
"RTN","PSAVER3",5,0)
 ;
"RTN","PSAVER3",6,0)
SETLINE ;Set line as verified if all data is present.
"RTN","PSAVER3",7,0)
 K PSADRG,PSAOU,PSAQTY S (PSADJN,PSADJ)=0
"RTN","PSAVER3",8,0)
 S PSADATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER3",9,0)
 I $O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) D
"RTN","PSAVER3",10,0)
 .S PSAA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) Q:PSAA=2
"RTN","PSAVER3",11,0)
 .S PSADJ=0 F  S PSADJ=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ)) Q:'PSADJ  D
"RTN","PSAVER3",12,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER3",13,0)
 ..S PSADJN=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)
"RTN","PSAVER3",14,0)
 ..I $P(PSADJN,"^")="D" D
"RTN","PSAVER3",15,0)
 ...I (+$P(PSADJN,"^",9)&($P(PSADJN,"^",6)'?.N))!('+$P(PSADJN,"^",9)&(+$P(PSADJN,"^",5))&($P(PSADJN,"^",2)'?.N)) S PSASUP=PSASUP+1,PSALNSU=1,PSADRG=0 Q
"RTN","PSAVER3",16,0)
 ...S PSADRG=$S($P(PSADJN,"^",6)'="":$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",17,0)
 ..I $P(PSADJN,"^")="O" S PSAOU=$S(+$P(PSADJN,"^",6):+$P(PSADJN,"^",6),+$P(PSADJN,"^",2):+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",18,0)
 ..I $P(PSADJN,"^")="Q" S PSAQTY=$S($P(PSADJN,"^",6)'="":+$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",19,0)
 S:'$G(PSADRG) PSADRG=+$P(PSADATA,"^",2) S:'$D(PSAQTY) PSAQTY=+$P(PSADATA,"^",3)
"RTN","PSAVER3",20,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVER3",21,0)
 S PSASUB=$S(+$P(PSATEMP,"^",3):+$P(PSATEMP,"^",3),+$O(^PSDRUG("C",PSANDC,PSADRG,0)):+$O(^PSDRUG("C",PSANDC,PSADRG,0)),1:0)
"RTN","PSAVER3",22,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER3",23,0)
 I '$D(PSAOU) D
"RTN","PSAVER3",24,0)
 .I +$P(PSADATA,"^",4),$P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'="" S PSAOU=+$P(PSADATA,"^",4) Q
"RTN","PSAVER3",25,0)
 .I PSADRG,PSASUB,$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) S PSAOU=$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) Q
"RTN","PSAVER3",26,0)
 .I $P(PSATEMP,"^",5)'="",+$P($P(PSATEMP,"^",5),"~",2) S PSAOU=+$P($P(PSATEMP,"^",5),"~",2)
"RTN","PSAVER3",27,0)
 I PSASUB D
"RTN","PSAVER3",28,0)
 .;Next line added 8APR98 (Dave B)
"RTN","PSAVER3",29,0)
 .S PSALOC=$S($G(PSALOC)'="":PSALOC,1:$S($P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12),$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5),1:0))
"RTN","PSAVER3",30,0)
 .S:'PSADUOU PSADUOU=$S(PSADRG&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:0)
"RTN","PSAVER3",31,0)
 .S:'PSASTOCK PSASTOCK=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER3",32,0)
 .S:'PSAREORD PSAREORD=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER3",33,0)
 ;
"RTN","PSAVER3",34,0)
SUPPLY ;If it is a supply, automatically verify it.
"RTN","PSAVER3",35,0)
 I '+$G(PSAERR),PSALNSU,'$G(PSAPRINT) D VERIFY,VERIFY1 Q
"RTN","PSAVER3",36,0)
 ;
"RTN","PSAVER3",37,0)
NEWDRUG ;Store in array if drug is new to location/vault
"RTN","PSAVER3",38,0)
 I +PSADRG D
"RTN","PSAVER3",39,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N",+$P(PSAIN,"^",12),'$D(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)) D
"RTN","PSAVER3",40,0)
 ..S PSAHOLD(+$P(PSAIN,"^",12),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1
"RTN","PSAVER3",41,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N",+$P(PSAIN,"^",5),'$D(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)) D
"RTN","PSAVER3",42,0)
 ..S PSAHOLD(+$P(PSAIN,"^",5),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0
"RTN","PSAVER3",43,0)
 ;
"RTN","PSAVER3",44,0)
NOTSUP ;If it is not a supply, look for drug, qty, dispense units, dispense
"RTN","PSAVER3",45,0)
 ;units/order unit, order unit, location/master vault, & reorder level
"RTN","PSAVER3",46,0)
 I '+$P(PSADATA,"^",2)&('$G(PSADRG)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"D"
"RTN","PSAVER3",47,0)
 I $P(PSADATA,"^",3)=""&($G(PSAQTY)="") S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"Q"
"RTN","PSAVER3",48,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",8)="" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_8
"RTN","PSAVER3",49,0)
 I '+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",7)&('+$G(PSADUOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"U"
"RTN","PSAVER3",50,0)
 I '+$P(PSADATA,"^",4)&('$G(PSAOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"O"
"RTN","PSAVER3",51,0)
 ;
"RTN","PSAVER3",52,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N" D
"RTN","PSAVER3",53,0)
 .I '+$P(PSAIN,"^",5) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P" D CS^PSAVER5
"RTN","PSAVER3",54,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0,PSADATA=^(0)
"RTN","PSAVER3",55,0)
 I $P(PSAIN,"^",8)="N"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",5),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["P" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P"
"RTN","PSAVER3",56,0)
 ;
"RTN","PSAVER3",57,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" D
"RTN","PSAVER3",58,0)
 .I '+$P(PSAIN,"^",12) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M" D CS^PSAVER5
"RTN","PSAVER3",59,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1,PSADATA=^(0)
"RTN","PSAVER3",60,0)
 I $P(PSAIN,"^",8)="A"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",12),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["M" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M"
"RTN","PSAVER3",61,0)
 ;
"RTN","PSAVER3",62,0)
 S:$D(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) PSAERR=PSAERR+1,PSALNERR=1
"RTN","PSAVER3",63,0)
 I 'PSAERR D GOOD Q
"RTN","PSAVER3",64,0)
 Q
"RTN","PSAVER3",65,0)
 ;
"RTN","PSAVER3",66,0)
GOOD ;If no errors found, verify invoice.
"RTN","PSAVER3",67,0)
 D VERIFY,VERIFY1
"RTN","PSAVER3",68,0)
 S PSAL=0 F  S PSAL=+$O(PSAHOLD(PSAL)) Q:'PSAL  D
"RTN","PSAVER3",69,0)
 .S PSANAME="" F  S PSANAME=$O(PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)) Q:PSANAME=""  D
"RTN","PSAVER3",70,0)
 ..S PSANEWD(PSAL,PSANAME)=PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)
"RTN","PSAVER3",71,0)
 K PSAHOLD
"RTN","PSAVER3",72,0)
 Q
"RTN","PSAVER3",73,0)
 ;
"RTN","PSAVER3",74,0)
PRINT ;Prints verification error list
"RTN","PSAVER3",75,0)
 S DIR(0)="Y",DIR("A")="Do you want to print the verification error report",DIR("B")="N"
"RTN","PSAVER3",76,0)
 S DIR("?",1)="Enter YES if you want to print the report just displayed.",DIR("?")="Enter NO if you do not want to print the report.",DIR("??")="^D PRINTYN^PSAVER3"
"RTN","PSAVER3",77,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER3",78,0)
 Q:Y=""!('+Y)
"RTN","PSAVER3",79,0)
 W ! S %ZIS="Q" D ^%ZIS Q:POP
"RTN","PSAVER3",80,0)
 I $D(IO("Q")) D  Q
"RTN","PSAVER3",81,0)
 .S ZTDESC="Drug Acct. - Print Prime Vendor Invoices",ZTRTN="PRN^PSAVER3"
"RTN","PSAVER3",82,0)
 .;
"RTN","PSAVER3",83,0)
 .;DAVE B (PSA*3*13)
"RTN","PSAVER3",84,0)
 .F PSASAVE="PSAIN","PSASLN","PSANOVER" S:$D(@PSASAVE) ZTSAVE(PSASAVE)=""
"RTN","PSAVER3",85,0)
 .D ^%ZTLOAD
"RTN","PSAVER3",86,0)
 ;
"RTN","PSAVER3",87,0)
PRN ;Entry point to print verification errors
"RTN","PSAVER3",88,0)
 S (PSAERR,PSALINE,PSAOUT,PSAPG)=0,PSAPRINT=1
"RTN","PSAVER3",89,0)
 S PSAIEN=0 F  S PSAIEN=$O(PSANOVER(PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSAVER3",90,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^")
"RTN","PSAVER3",91,0)
 .S PSAIEN1=0 F  S PSAIEN1=$O(PSANOVER(PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSAVER3",92,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))  S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^")
"RTN","PSAVER3",93,0)
 ..S PSALINE=0 F  S PSALINE=$O(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSAVER3",94,0)
 ...D NOVER
"RTN","PSAVER3",95,0)
 .K PSANOVER(PSAIEN)
"RTN","PSAVER3",96,0)
 W !!,"** The invoice has not been placed in a Verified status!",!
"RTN","PSAVER3",97,0)
 D:$E(IOST,1,2)="C-" END^PSAPROC W:$E(IOST)'="C" @IOF
"RTN","PSAVER3",98,0)
 D ^%ZISC
"RTN","PSAVER3",99,0)
 Q
"RTN","PSAVER3",100,0)
 ;
"RTN","PSAVER3",101,0)
NOVER ;Prints errors
"RTN","PSAVER3",102,0)
 S PSANO=PSANOVER(PSAIEN,PSAIEN1,PSALINE),PSALEN=$L(PSANO)
"RTN","PSAVER3",103,0)
 S PSALINEN=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)),"^"),PSATAB=$L(PSALINEN)+8
"RTN","PSAVER3",104,0)
 I $E(IOST,1,2)="C-" D:'PSAPG HDR I $Y+(4+PSALEN)>IOSL D END^PSAPROC Q:PSAOUT  D HDR
"RTN","PSAVER3",105,0)
 I $E(IOST)'="C",$Y+(4+PSALEN)>IOSL!('PSAPG) D HDR
"RTN","PSAVER3",106,0)
 W "Line# "_PSALINEN_": "
"RTN","PSAVER3",107,0)
 W:PSANO[8 ?PSATAB,"Dispense unit",!
"RTN","PSAVER3",108,0)
 W:PSANO["U" ?PSATAB,"Dispense unit per order unit",!
"RTN","PSAVER3",109,0)
 W:PSANO["D" ?PSATAB,"Drug",!
"RTN","PSAVER3",110,0)
 I PSANO["M" W ?PSATAB,"Master Vault",!
"RTN","PSAVER3",111,0)
 W:PSANO["O" ?PSATAB,"Order unit",!
"RTN","PSAVER3",112,0)
 I PSANO["P" W ?PSATAB,"Pharmacy location",!
"RTN","PSAVER3",113,0)
 W:PSANO["Q" ?PSATAB,"Quantity",!
"RTN","PSAVER3",114,0)
 W !
"RTN","PSAVER3",115,0)
 Q
"RTN","PSAVER3",116,0)
 ;
"RTN","PSAVER3",117,0)
HDR ;Prints header
"RTN","PSAVER3",118,0)
 I $E(IOST,1,2)="C-" W @IOF,!?23,"<<< VERIFICATION ERROR REPORT >>>"
"RTN","PSAVER3",119,0)
 I $E(IOST)'="C" W:PSAPG'=1 @IOF W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",!?27,"VERIFICATION ERROR REPORT",?72,"Page "_PSAPG,!
"RTN","PSAVER3",120,0)
 S PSAPG=PSAPG+1
"RTN","PSAVER3",121,0)
 W !,"Order#: "_PSAORD_"  Invoice#: "_$P(PSAIN,"^")_"  Invoice Date: "_$$FMTE^XLFDT(+$P(PSAIN,"^",2)) W:'$G(PSAERR) !,PSASLN,!
"RTN","PSAVER3",122,0)
 I $G(PSAERR) W !!,"The following line numbers' status cannot be changed to Verified.",!,"The fields that contain an error or need data are listed with the line item.",!,PSASLN,!
"RTN","PSAVER3",123,0)
 Q
"RTN","PSAVER3",124,0)
 ;
"RTN","PSAVER3",125,0)
STATUS ;Sets invoice's status to Verified
"RTN","PSAVER3",126,0)
 ;
"RTN","PSAVER3",127,0)
 ;PSA*3*3 (DAVE B)
"RTN","PSAVER3",128,0)
 S DA=PSAIEN1,DA(1)=PSAIEN,DIE="^PSD(58.811,"_DA(1)_",1,",DR="2///V;12////^S X="_DUZ
"RTN","PSAVER3",129,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER3",130,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",131,0)
 K DIE
"RTN","PSAVER3",132,0)
 Q
"RTN","PSAVER3",133,0)
 ;
"RTN","PSAVER3",134,0)
VERIFY ;Set line item to verified
"RTN","PSAVER3",135,0)
 I PSADRG,$P($G(^PSDRUG(PSADRG,2)),"^",3)["N" S PSACSLN=1
"RTN","PSAVER3",136,0)
 E  S PSACSLN=0
"RTN","PSAVER3",137,0)
 K DA S DA=PSALINE,DA(1)=PSAIEN1,DA(2)=PSAIEN,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DR="7///^S X="_DT_";8////^S X="_DUZ_";12///^S X=PSACSLN"
"RTN","PSAVER3",138,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER3",139,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",140,0)
 K DIE
"RTN","PSAVER3",141,0)
 Q
"RTN","PSAVER3",142,0)
 ;
"RTN","PSAVER3",143,0)
VERIFY1 ;Set adjs if entire invioce was verified
"RTN","PSAVER3",144,0)
 S DA=0 F  S DA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA)) Q:'DA  D
"RTN","PSAVER3",145,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0))
"RTN","PSAVER3",146,0)
 .Q:$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",9)=DUZ
"RTN","PSAVER3",147,0)
 .S PSAREA="",PSADJ=$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",2) D ADJ^PSAVER2
"RTN","PSAVER3",148,0)
 Q
"RTN","PSAVER3",149,0)
 ;
"RTN","PSAVER3",150,0)
DDQOR ;Extended help for 'Edit field'
"RTN","PSAVER3",151,0)
 W !?5,"Enter the number or range of numbers of the field you want to edit.",!?5,"For example, 1-3 or 1,3"
"RTN","PSAVER3",152,0)
 Q
"RTN","PSAVER3",153,0)
LNHELP ;Extended help for 'Line Number"
"RTN","PSAVER3",154,0)
 W !?5,"Enter the number of the item on the invoice you want to edit.",!?5,"You may enter several line item numbers separated by comas.",!!?5,"Do NOT enter a range of numbers separated by a dash."
"RTN","PSAVER3",155,0)
 Q
"RTN","PSAVER3",156,0)
PRINTYN ;Extended help for 'Print verification report'
"RTN","PSAVER3",157,0)
 W !?5,"Enter YES to print the Verification Error Report on a printer.",!?5,"Enter NO if you do not want to print the report."
"RTN","PSAVER3",158,0)
 Q
"RTN","PSAVER6")
0^5^B33177107
"RTN","PSAVER6",1,0)
PSAVER6 ;BIR/JMB-Verify Invoices - CONT'D ;10/3/97
"RTN","PSAVER6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**1,3**; 10/24/97
"RTN","PSAVER6",3,0)
 ;Background Job:
"RTN","PSAVER6",4,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER6",5,0)
 ;in 58.8 after invoices have been verified.
"RTN","PSAVER6",6,0)
 ;
"RTN","PSAVER6",7,0)
START S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",8,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",9,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",10,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",11,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",12,0)
 ..S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER6",13,0)
 ..I +$P(PSAIN,"^",13) K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR Q
"RTN","PSAVER6",14,0)
 ..S PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSALINE=0
"RTN","PSAVER6",15,0)
 ..F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE  D
"RTN","PSAVER6",16,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER6",17,0)
 ...S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D GETDATA D:'PSASUP FILE
"RTN","PSAVER6",18,0)
 ..K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR
"RTN","PSAVER6",19,0)
 ..D MSG^PSAVER7
"RTN","PSAVER6",20,0)
EXIT ;Kills variables
"RTN","PSAVER6",21,0)
 K %,DA,DD,DIC,DIE,DINUM,DLAYGO,DO,PSA,PSAA,PSABAL,PSACBAL,PSACNT,PSACNT,PSACOD,PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAVER6",22,0)
 K PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALINE,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAVER6",23,0)
 K PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,Y
"RTN","PSAVER6",24,0)
 Q
"RTN","PSAVER6",25,0)
 ;
"RTN","PSAVER6",26,0)
GETDATA ;Gets invoice data to help file the data
"RTN","PSAVER6",27,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0
"RTN","PSAVER6",28,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVER6",29,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAVER6",30,0)
 I $G(PSADJ) D
"RTN","PSAVER6",31,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER6",32,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",33,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAVER6",34,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVER6",35,0)
 .I +PSADJD,$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAVER6",36,0)
 .I +PSADJD,$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVER6",37,0)
CS Q:PSASUP!('PSADRG)
"RTN","PSAVER6",38,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAVER6",39,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVER6",40,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",41,0)
 ;
"RTN","PSAVER6",42,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAVER6",43,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAVER6",44,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVER6",45,0)
 ;
"RTN","PSAVER6",46,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",47,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAVER6",48,0)
 ;
"RTN","PSAVER6",49,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVER6",50,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",51,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAVER6",52,0)
 S PSANDC=$P(PSADATA,"^",11),PSADASH=$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12)
"RTN","PSAVER6",53,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVER6",54,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVER6",55,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAVER6",56,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAVER6",57,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVER6",58,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVER6",59,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER6",60,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:0)
"RTN","PSAVER6",61,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAVER6",62,0)
 ;
"RTN","PSAVER6",63,0)
 ;DAVE B (18NOV98)
"RTN","PSAVER6",64,0)
 I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAVER6",65,0)
 Q:'+$P($G(^PSD(58.8,PSALOC,0)),"^",14)
"RTN","PSAVER6",66,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER6",67,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER6",68,0)
 Q
"RTN","PSAVER6",69,0)
 ;
"RTN","PSAVER6",70,0)
FILE ;File data in 58.8
"RTN","PSAVER6",71,0)
 I $D(PSADUREC),PSADUREC'>0 S PSADUREC=$S($D(PSADJQ):PSADJQ,$D(PSAQTY):PSAQTY,1:0)
"RTN","PSAVER6",72,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVER6",73,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVER6",74,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVER6",75,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER6",76,0)
 .F  L +^PSD(58.8,PSALOC,0):0 I  Q
"RTN","PSAVER6",77,0)
 .D ^DIC L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVER6",78,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVER6",79,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVER6",80,0)
 ;
"RTN","PSAVER6",81,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",82,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVER6",83,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVER6",84,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVER6",85,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVER6",86,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVER6",87,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVER6",88,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVER6",89,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC
"RTN","PSAVER6",90,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAVER6",91,0)
 .S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVER6",92,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVER6",93,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVER6",94,0)
 G TR^PSAVER7
"VER")
8.0^21.0
**END**
**END**
