Released PSB*3*11 SEQ #10
Extracted from mail message
**KIDS**:PSB*3.0*11^

**INSTALL NAME**
PSB*3.0*11
"BLD",5352,0)
PSB*3.0*11^BAR CODE MED ADMIN^0^3050829^y
"BLD",5352,1,0)
^^88^88^3050829^^^
"BLD",5352,1,1,0)
 
"BLD",5352,1,2,0)
1.   Problem: Remedy #HD0000000092269
"BLD",5352,1,3,0)
     Bar Code Medication Administration (BCMA) software errors at line 
"BLD",5352,1,4,0)
     "EN+78^PSBVDLPB" when a BCMA Medication Log (file #53.79) record 
"BLD",5352,1,5,0)
     being processed has its Action Status (field #.09) equal to "" .  
"BLD",5352,1,6,0)
     The errant record is the result of an administration not properly 
"BLD",5352,1,7,0)
     saved/discarded via Manual Medication Entry[PSB MED LOG NEW ENTRY]         
"BLD",5352,1,8,0)
 
"BLD",5352,1,9,0)
     Corrective Action:
"BLD",5352,1,10,0)
     BCMA will ignore all BCMA Medication Log (file #53.79)records with 
"BLD",5352,1,11,0)
     Action Status field (field #.09) equal to ""; and when appropriate, 
"BLD",5352,1,12,0)
     BCMA will send an electronic message (e-message) to members of the
"BLD",5352,1,13,0)
     mail group that is specified via the BCMA Site Parameter - "Mail 
"BLD",5352,1,14,0)
     Groups/Due List Error", when such a record is processed.  The 
"BLD",5352,1,15,0)
     subject line of  this  e-message will read "BCMA - Admin XXXX 
"BLD",5352,1,16,0)
     Problem". The subject line of this e-message will contain the 
"BLD",5352,1,17,0)
     internal entry number (IEN), identifying the errant BCMA Medication 
"BLD",5352,1,18,0)
     Log (file #53.79) record.  That IEN is represented above by the
"BLD",5352,1,19,0)
     text "XXXX".  PSB*3.0*11 will allow access to the errant records via 
"BLD",5352,1,20,0)
     Manual Medication Entry [PSB MED LOG NEW ENTRY] option for deletion 
"BLD",5352,1,21,0)
     or correction.  The errant records may be accessed using 
"BLD",5352,1,22,0)
     Manual Medication Entry [PSB MED LOG NEW ENTRY] option
"BLD",5352,1,23,0)
     by users possessing the PSB Manager Key or the user who initiated 
"BLD",5352,1,24,0)
     that administration. Details about the errant administration are 
"BLD",5352,1,25,0)
     within the e-message sent.  The e-message will contain data 
"BLD",5352,1,26,0)
     necessary to reprocess, via the Manual Medication Entry [PSB MED LOG 
"BLD",5352,1,27,0)
     NEW ENTRY] option, that incomplete and errant administration.
"BLD",5352,1,28,0)
     The following is an example e-message:
"BLD",5352,1,29,0)
**************************************************************************
"BLD",5352,1,30,0)
 
"BLD",5352,1,31,0)
 Subj: BCMA - Admin 11111 Problem  [#22222222] 07/13/05@13:37  12 lines
"BLD",5352,1,32,0)
 From: JACKSON,TODD ELLIS  In 'IN' basket.   Page 1
"BLD",5352,1,33,0)
 -----------------------------------------------------------------------
"BLD",5352,1,34,0)
   The following administration was NOT displayed
"BLD",5352,1,35,0)
   on the Virtual Due List
"BLD",5352,1,36,0)
 
"BLD",5352,1,37,0)
   Order Number....: 21V
"BLD",5352,1,38,0)
   Orderable Item..: HEPARIN SOLN
"BLD",5352,1,39,0)
   Patient.........: BCMAPATIENT,ONE (000-00-9678)
"BLD",5352,1,40,0)
   Ward/Bed........: 7A GEN MED 724-A
"BLD",5352,1,41,0)
   Reason..........: JUL 13, 2005@07:00 admin's ACTION STATUS is "UNKNOWN".
"BLD",5352,1,42,0)
   Schedule........: Q3H
"BLD",5352,1,43,0)
   Action Dt/Tm....: JUL 13, 2005@11:32:50
"BLD",5352,1,44,0)
   BCMA Med Log IEN: 11111
"BLD",5352,1,45,0)
   User............: ( # 00000000000 ) BCMAUSER,ONE
"BLD",5352,1,46,0)
 
"BLD",5352,1,47,0)
**************************************************************************
"BLD",5352,1,48,0)
     Per the above example, to correct the example, errant entry #11111, 
"BLD",5352,1,49,0)
     the specified "User" or a person holding the PSB Manager Key may use 
"BLD",5352,1,50,0)
     the Manual Medication Entry [PSB MED LOG NEW ENTRY] option and 
"BLD",5352,1,51,0)
     correct the "Reason" for the "BCMA - Admin Problem"; that person can 
"BLD",5352,1,52,0)
     correct that "JUL 13, 2005@07:00 admin's ACTION STATUS" per the 
"BLD",5352,1,53,0)
     specified patient and order, via corresponding responses to Manual 
"BLD",5352,1,54,0)
     Medication Entry [PSB MED LOG NEW ENTRY] option prompts.  The 
"BLD",5352,1,55,0)
     "correction" is to properly complete or delete that incomplete 
"BLD",5352,1,56,0)
     administration.
"BLD",5352,1,57,0)
 
"BLD",5352,1,58,0)
     An e-message triggered by an incomplete administration of a Pro
"BLD",5352,1,59,0)
     Re Nata (PRN) [As Needed] medication must be maintained via VISTA 
"BLD",5352,1,60,0)
     File Manager (FileMan).  The IEN of the entry that needs corrected 
"BLD",5352,1,61,0)
     is labeled "BCMA Med Log IEN:" within the e-message as well as 
"BLD",5352,1,62,0)
     displayed in the e-message's subject line, immediately after the 
"BLD",5352,1,63,0)
     text "BCMA - Admin".
"BLD",5352,1,64,0)
 
"BLD",5352,1,65,0)
     It is possible to correct any errant BCMA Medication Log (file 
"BLD",5352,1,66,0)
     #53.79) entry using FileMan and the IEN supplied by this e-message.
"BLD",5352,1,67,0)
 
"BLD",5352,1,68,0)
 
"BLD",5352,1,69,0)
2.   Problem: Remedy #HD0000000093022
"BLD",5352,1,70,0)
     The Manual Medication Entry [PSB MED LOG NEW ENTRY] option does not 
"BLD",5352,1,71,0)
     maintain the "Given" status per medication patch administrations on 
"BLD",5352,1,72,0)
     the BCMA Virtual Due List (VDL).  The user is unable to determine 
"BLD",5352,1,73,0)
     which administered patch must be removed when the VDL does not 
"BLD",5352,1,74,0)
     display the patch as "Given".  
"BLD",5352,1,75,0)
 
"BLD",5352,1,76,0)
     Corrective Action:
"BLD",5352,1,77,0)
     A patch administered via the Manual Medication Entry [PSB MED LOG 
"BLD",5352,1,78,0)
     NEW ENTRY] option will show as "Given" on the BCMA VDL.
"BLD",5352,1,79,0)
 
"BLD",5352,1,80,0)
 
"BLD",5352,1,81,0)
3.   Problem: Remedy #HD0000000103739
"BLD",5352,1,82,0)
     The Manual Medication Entry [PSB MED LOG NEW ENTRY] option 
"BLD",5352,1,83,0)
     malfunctions when attempting to administer an "odd schedule" order 
"BLD",5352,1,84,0)
     on days the order is not scheduled to be administered.
"BLD",5352,1,85,0)
 
"BLD",5352,1,86,0)
     Corrective Action:
"BLD",5352,1,87,0)
     Display appropriate data when "odd schedule" order administrations 
"BLD",5352,1,88,0)
     are attempted.
"BLD",5352,4,0)
^9.64PA^^0
"BLD",5352,"ABPKG")
n
"BLD",5352,"KRN",0)
^9.67PA^8989.52^19
"BLD",5352,"KRN",.4,0)
.4
"BLD",5352,"KRN",.401,0)
.401
"BLD",5352,"KRN",.402,0)
.402
"BLD",5352,"KRN",.403,0)
.403
"BLD",5352,"KRN",.5,0)
.5
"BLD",5352,"KRN",.84,0)
.84
"BLD",5352,"KRN",3.6,0)
3.6
"BLD",5352,"KRN",3.8,0)
3.8
"BLD",5352,"KRN",9.2,0)
9.2
"BLD",5352,"KRN",9.8,0)
9.8
"BLD",5352,"KRN",9.8,"NM",0)
^9.68A^10^9
"BLD",5352,"KRN",9.8,"NM",1,0)
PSBML^^0^B81900339
"BLD",5352,"KRN",9.8,"NM",3,0)
PSBMLLKU^^0^B62070466
"BLD",5352,"KRN",9.8,"NM",4,0)
PSBMLU^^0^B5930177
"BLD",5352,"KRN",9.8,"NM",5,0)
PSBOMH1^^0^B78413665
"BLD",5352,"KRN",9.8,"NM",6,0)
PSBOML^^0^B31797933
"BLD",5352,"KRN",9.8,"NM",7,0)
PSBVDLPB^^0^B82592790
"BLD",5352,"KRN",9.8,"NM",8,0)
PSBVDLUD^^0^B74549540
"BLD",5352,"KRN",9.8,"NM",9,0)
PSBVDLVL^^0^B58456162
"BLD",5352,"KRN",9.8,"NM",10,0)
PSBMLEN1^^0^B44879194
"BLD",5352,"KRN",9.8,"NM","B","PSBML",1)

"BLD",5352,"KRN",9.8,"NM","B","PSBMLEN1",10)

"BLD",5352,"KRN",9.8,"NM","B","PSBMLLKU",3)

"BLD",5352,"KRN",9.8,"NM","B","PSBMLU",4)

"BLD",5352,"KRN",9.8,"NM","B","PSBOMH1",5)

"BLD",5352,"KRN",9.8,"NM","B","PSBOML",6)

"BLD",5352,"KRN",9.8,"NM","B","PSBVDLPB",7)

"BLD",5352,"KRN",9.8,"NM","B","PSBVDLUD",8)

"BLD",5352,"KRN",9.8,"NM","B","PSBVDLVL",9)

"BLD",5352,"KRN",19,0)
19
"BLD",5352,"KRN",19.1,0)
19.1
"BLD",5352,"KRN",101,0)
101
"BLD",5352,"KRN",409.61,0)
409.61
"BLD",5352,"KRN",771,0)
771
"BLD",5352,"KRN",870,0)
870
"BLD",5352,"KRN",8989.51,0)
8989.51
"BLD",5352,"KRN",8989.52,0)
8989.52
"BLD",5352,"KRN",8994,0)
8994
"BLD",5352,"KRN","B",.4,.4)

"BLD",5352,"KRN","B",.401,.401)

"BLD",5352,"KRN","B",.402,.402)

"BLD",5352,"KRN","B",.403,.403)

"BLD",5352,"KRN","B",.5,.5)

"BLD",5352,"KRN","B",.84,.84)

"BLD",5352,"KRN","B",3.6,3.6)

"BLD",5352,"KRN","B",3.8,3.8)

"BLD",5352,"KRN","B",9.2,9.2)

"BLD",5352,"KRN","B",9.8,9.8)

"BLD",5352,"KRN","B",19,19)

"BLD",5352,"KRN","B",19.1,19.1)

"BLD",5352,"KRN","B",101,101)

"BLD",5352,"KRN","B",409.61,409.61)

"BLD",5352,"KRN","B",771,771)

"BLD",5352,"KRN","B",870,870)

"BLD",5352,"KRN","B",8989.51,8989.51)

"BLD",5352,"KRN","B",8989.52,8989.52)

"BLD",5352,"KRN","B",8994,8994)

"BLD",5352,"QUES",0)
^9.62^^
"BLD",5352,"REQB",0)
^9.611^5^4
"BLD",5352,"REQB",2,0)
PSB*3.0*9^2
"BLD",5352,"REQB",3,0)
PSB*3.0*6^2
"BLD",5352,"REQB",4,0)
PSB*3.0*3^2
"BLD",5352,"REQB",5,0)
PSB*3.0*12^2
"BLD",5352,"REQB","B","PSB*3.0*12",5)

"BLD",5352,"REQB","B","PSB*3.0*3",4)

"BLD",5352,"REQB","B","PSB*3.0*6",3)

"BLD",5352,"REQB","B","PSB*3.0*9",2)

"MBREQ")
0
"PKG",536,-1)
1^1
"PKG",536,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",536,20,0)
^9.402P^^0
"PKG",536,22,0)
^9.49I^1^1
"PKG",536,22,1,0)
3.0^3040224^3040318^11874
"PKG",536,22,1,"PAH",1,0)
11^3050829^10000000035
"PKG",536,22,1,"PAH",1,1,0)
^^88^88^3050829
"PKG",536,22,1,"PAH",1,1,1,0)
 
"PKG",536,22,1,"PAH",1,1,2,0)
1.   Problem: Remedy #HD0000000092269
"PKG",536,22,1,"PAH",1,1,3,0)
     Bar Code Medication Administration (BCMA) software errors at line 
"PKG",536,22,1,"PAH",1,1,4,0)
     "EN+78^PSBVDLPB" when a BCMA Medication Log (file #53.79) record 
"PKG",536,22,1,"PAH",1,1,5,0)
     being processed has its Action Status (field #.09) equal to "" .  
"PKG",536,22,1,"PAH",1,1,6,0)
     The errant record is the result of an administration not properly 
"PKG",536,22,1,"PAH",1,1,7,0)
     saved/discarded via Manual Medication Entry[PSB MED LOG NEW ENTRY]         
"PKG",536,22,1,"PAH",1,1,8,0)
 
"PKG",536,22,1,"PAH",1,1,9,0)
     Corrective Action:
"PKG",536,22,1,"PAH",1,1,10,0)
     BCMA will ignore all BCMA Medication Log (file #53.79)records with 
"PKG",536,22,1,"PAH",1,1,11,0)
     Action Status field (field #.09) equal to ""; and when appropriate, 
"PKG",536,22,1,"PAH",1,1,12,0)
     BCMA will send an electronic message (e-message) to members of the
"PKG",536,22,1,"PAH",1,1,13,0)
     mail group that is specified via the BCMA Site Parameter - "Mail 
"PKG",536,22,1,"PAH",1,1,14,0)
     Groups/Due List Error", when such a record is processed.  The 
"PKG",536,22,1,"PAH",1,1,15,0)
     subject line of  this  e-message will read "BCMA - Admin XXXX 
"PKG",536,22,1,"PAH",1,1,16,0)
     Problem". The subject line of this e-message will contain the 
"PKG",536,22,1,"PAH",1,1,17,0)
     internal entry number (IEN), identifying the errant BCMA Medication 
"PKG",536,22,1,"PAH",1,1,18,0)
     Log (file #53.79) record.  That IEN is represented above by the
"PKG",536,22,1,"PAH",1,1,19,0)
     text "XXXX".  PSB*3.0*11 will allow access to the errant records via 
"PKG",536,22,1,"PAH",1,1,20,0)
     Manual Medication Entry [PSB MED LOG NEW ENTRY] option for deletion 
"PKG",536,22,1,"PAH",1,1,21,0)
     or correction.  The errant records may be accessed using 
"PKG",536,22,1,"PAH",1,1,22,0)
     Manual Medication Entry [PSB MED LOG NEW ENTRY] option
"PKG",536,22,1,"PAH",1,1,23,0)
     by users possessing the PSB Manager Key or the user who initiated 
"PKG",536,22,1,"PAH",1,1,24,0)
     that administration. Details about the errant administration are 
"PKG",536,22,1,"PAH",1,1,25,0)
     within the e-message sent.  The e-message will contain data 
"PKG",536,22,1,"PAH",1,1,26,0)
     necessary to reprocess, via the Manual Medication Entry [PSB MED LOG 
"PKG",536,22,1,"PAH",1,1,27,0)
     NEW ENTRY] option, that incomplete and errant administration.
"PKG",536,22,1,"PAH",1,1,28,0)
     The following is an example e-message:
"PKG",536,22,1,"PAH",1,1,29,0)
**************************************************************************
"PKG",536,22,1,"PAH",1,1,30,0)
 
"PKG",536,22,1,"PAH",1,1,31,0)
 Subj: BCMA - Admin 11111 Problem  [#22222222] 07/13/05@13:37  12 lines
"PKG",536,22,1,"PAH",1,1,32,0)
 From: JACKSON,TODD ELLIS  In 'IN' basket.   Page 1
"PKG",536,22,1,"PAH",1,1,33,0)
 -----------------------------------------------------------------------
"PKG",536,22,1,"PAH",1,1,34,0)
   The following administration was NOT displayed
"PKG",536,22,1,"PAH",1,1,35,0)
   on the Virtual Due List
"PKG",536,22,1,"PAH",1,1,36,0)
 
"PKG",536,22,1,"PAH",1,1,37,0)
   Order Number....: 21V
"PKG",536,22,1,"PAH",1,1,38,0)
   Orderable Item..: HEPARIN SOLN
"PKG",536,22,1,"PAH",1,1,39,0)
   Patient.........: BCMAPATIENT,ONE (000-00-9678)
"PKG",536,22,1,"PAH",1,1,40,0)
   Ward/Bed........: 7A GEN MED 724-A
"PKG",536,22,1,"PAH",1,1,41,0)
   Reason..........: JUL 13, 2005@07:00 admin's ACTION STATUS is "UNKNOWN".
"PKG",536,22,1,"PAH",1,1,42,0)
   Schedule........: Q3H
"PKG",536,22,1,"PAH",1,1,43,0)
   Action Dt/Tm....: JUL 13, 2005@11:32:50
"PKG",536,22,1,"PAH",1,1,44,0)
   BCMA Med Log IEN: 11111
"PKG",536,22,1,"PAH",1,1,45,0)
   User............: ( # 00000000000 ) BCMAUSER,ONE
"PKG",536,22,1,"PAH",1,1,46,0)
 
"PKG",536,22,1,"PAH",1,1,47,0)
**************************************************************************
"PKG",536,22,1,"PAH",1,1,48,0)
     Per the above example, to correct the example, errant entry #11111, 
"PKG",536,22,1,"PAH",1,1,49,0)
     the specified "User" or a person holding the PSB Manager Key may use 
"PKG",536,22,1,"PAH",1,1,50,0)
     the Manual Medication Entry [PSB MED LOG NEW ENTRY] option and 
"PKG",536,22,1,"PAH",1,1,51,0)
     correct the "Reason" for the "BCMA - Admin Problem"; that person can 
"PKG",536,22,1,"PAH",1,1,52,0)
     correct that "JUL 13, 2005@07:00 admin's ACTION STATUS" per the 
"PKG",536,22,1,"PAH",1,1,53,0)
     specified patient and order, via corresponding responses to Manual 
"PKG",536,22,1,"PAH",1,1,54,0)
     Medication Entry [PSB MED LOG NEW ENTRY] option prompts.  The 
"PKG",536,22,1,"PAH",1,1,55,0)
     "correction" is to properly complete or delete that incomplete 
"PKG",536,22,1,"PAH",1,1,56,0)
     administration.
"PKG",536,22,1,"PAH",1,1,57,0)
 
"PKG",536,22,1,"PAH",1,1,58,0)
     An e-message triggered by an incomplete administration of a Pro
"PKG",536,22,1,"PAH",1,1,59,0)
     Re Nata (PRN) [As Needed] medication must be maintained via VISTA 
"PKG",536,22,1,"PAH",1,1,60,0)
     File Manager (FileMan).  The IEN of the entry that needs corrected 
"PKG",536,22,1,"PAH",1,1,61,0)
     is labeled "BCMA Med Log IEN:" within the e-message as well as 
"PKG",536,22,1,"PAH",1,1,62,0)
     displayed in the e-message's subject line, immediately after the 
"PKG",536,22,1,"PAH",1,1,63,0)
     text "BCMA - Admin".
"PKG",536,22,1,"PAH",1,1,64,0)
 
"PKG",536,22,1,"PAH",1,1,65,0)
     It is possible to correct any errant BCMA Medication Log (file 
"PKG",536,22,1,"PAH",1,1,66,0)
     #53.79) entry using FileMan and the IEN supplied by this e-message.
"PKG",536,22,1,"PAH",1,1,67,0)
 
"PKG",536,22,1,"PAH",1,1,68,0)
 
"PKG",536,22,1,"PAH",1,1,69,0)
2.   Problem: Remedy #HD0000000093022
"PKG",536,22,1,"PAH",1,1,70,0)
     The Manual Medication Entry [PSB MED LOG NEW ENTRY] option does not 
"PKG",536,22,1,"PAH",1,1,71,0)
     maintain the "Given" status per medication patch administrations on 
"PKG",536,22,1,"PAH",1,1,72,0)
     the BCMA Virtual Due List (VDL).  The user is unable to determine 
"PKG",536,22,1,"PAH",1,1,73,0)
     which administered patch must be removed when the VDL does not 
"PKG",536,22,1,"PAH",1,1,74,0)
     display the patch as "Given".  
"PKG",536,22,1,"PAH",1,1,75,0)
 
"PKG",536,22,1,"PAH",1,1,76,0)
     Corrective Action:
"PKG",536,22,1,"PAH",1,1,77,0)
     A patch administered via the Manual Medication Entry [PSB MED LOG 
"PKG",536,22,1,"PAH",1,1,78,0)
     NEW ENTRY] option will show as "Given" on the BCMA VDL.
"PKG",536,22,1,"PAH",1,1,79,0)
 
"PKG",536,22,1,"PAH",1,1,80,0)
 
"PKG",536,22,1,"PAH",1,1,81,0)
3.   Problem: Remedy #HD0000000103739
"PKG",536,22,1,"PAH",1,1,82,0)
     The Manual Medication Entry [PSB MED LOG NEW ENTRY] option 
"PKG",536,22,1,"PAH",1,1,83,0)
     malfunctions when attempting to administer an "odd schedule" order 
"PKG",536,22,1,"PAH",1,1,84,0)
     on days the order is not scheduled to be administered.
"PKG",536,22,1,"PAH",1,1,85,0)
 
"PKG",536,22,1,"PAH",1,1,86,0)
     Corrective Action:
"PKG",536,22,1,"PAH",1,1,87,0)
     Display appropriate data when "odd schedule" order administrations 
"PKG",536,22,1,"PAH",1,1,88,0)
     are attempted.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","PSBML")
0^1^B81900339
"RTN","PSBML",1,0)
PSBML ;BIRMINGHAM/EFC-BCMA MED LOG FUNCTIONS ;Mar 2004
"RTN","PSBML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,4,9,11**;Mar 2004
"RTN","PSBML",3,0)
 ;
"RTN","PSBML",4,0)
 ; Reference/IA
"RTN","PSBML",5,0)
 ; ^DPT/10035
"RTN","PSBML",6,0)
 ; DIC(42/10039
"RTN","PSBML",7,0)
 ; DIC(42/2440
"RTN","PSBML",8,0)
 ; File 200/10060
"RTN","PSBML",9,0)
 ; EN^PSJBCMA3/3320
"RTN","PSBML",10,0)
 ; $$SITE^VASITE/10112
"RTN","PSBML",11,0)
 ; ^XUSEC(/10076
"RTN","PSBML",12,0)
 ;
"RTN","PSBML",13,0)
RPC(RESULTS,PSBHDR,PSBREC) ; BCMA Filing Point
"RTN","PSBML",14,0)
 ; RPC: PSB TRANSACTION
"RTN","PSBML",15,0)
 ; ONLY Place an entry into the MED LOG is made.
"RTN","PSBML",16,0)
 ;
"RTN","PSBML",17,0)
 S PSBEDTFL=0
"RTN","PSBML",18,0)
 N PSBORD,PSBTRAN,PSBFDA
"RTN","PSBML",19,0)
 K PSBIEN,PSBHL7
"RTN","PSBML",20,0)
 S PSBIEN=$P(PSBHDR,U,1)
"RTN","PSBML",21,0)
 S PSBTRAN=$P(PSBHDR,U,2),PSBHL7=PSBTRAN
"RTN","PSBML",22,0)
 S PSBINST=$P($G(PSBHDR),U,3)
"RTN","PSBML",23,0)
 S PSBAUDIT=$S(PSBIEN="+1":0,1:1)
"RTN","PSBML",24,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",25,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),PSBINST="" S RESULTS(0)=1,RESULTS(1)="-1^Instructor not present" Q
"RTN","PSBML",26,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),'$D(^XUSEC("PSB INSTRUCTOR",PSBINST)) S RESULTS(0)=1,RESULTS(1)="-1^Instructor doesn't have authority" Q
"RTN","PSBML",27,0)
 S PSBINST(0)=$$GET1^DIQ(200,PSBINST_",",.01)
"RTN","PSBML",28,0)
 I PSBTRAN="ADD COMMENT" D COMMENT^PSBML1 Q
"RTN","PSBML",29,0)
 I PSBTRAN="PRN EFFECTIVENESS" D PRN^PSBML1 Q
"RTN","PSBML",30,0)
 I PSBTRAN="UPDATE STATUS" D  Q
"RTN","PSBML",31,0)
 .I '$D(^PSB(53.79,PSBIEN)) S RESULTS(0)=1,RESULTS(1)="-1^Administration is at an UNKNOWN STATUS" Q
"RTN","PSBML",32,0)
 .D UPDATED^PSBML2
"RTN","PSBML",33,0)
 I PSBTRAN="EDIT" D EDIT^PSBML2 Q
"RTN","PSBML",34,0)
 ;SAGG
"RTN","PSBML",35,0)
 N PSBWARD S PSBWARD=$G(^DPT(+$G(PSBREC(0)),.1),"UNKNOWN"),^PSB("SAGG",PSBWARD,DT)=$G(^PSB("SAGG",PSBWARD,DT))+1
"RTN","PSBML",36,0)
 I PSBREC(1)?1U1";"1.6N S PSBREC(1)=$P(PSBREC(1),";",1)_$E(PSBREC(1))
"RTN","PSBML",37,0)
 D PSJ1^PSBVT(PSBREC(0),$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1))
"RTN","PSBML",38,0)
 S PSBTAB=$P(PSBREC(9),U,1),PSBUID=$P(PSBREC(9),U,2)
"RTN","PSBML",39,0)
 D:PSBTRAN="MEDPASS"
"RTN","PSBML",40,0)
 .I (PSBDOSEF["PATCH"),(PSBREC(3)="G") D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",41,0)
 ..S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",42,0)
 ...S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT,PSBYZ)) Q:'PSBYZ  I ($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G") S RESULTS(0)=1,RESULTS(1)="-1^Previous Patch has not been removed. Administration canceled." Q
"RTN","PSBML",43,0)
 .I PSBREC(7)="BCMA/CPRS Interface Entry." S PSBNOW=PSBREC(5)  ;MOB AdmnTime
"RTN","PSBML",44,0)
 .F X=0:1:9 S PSBREC(X)=$G(PSBREC(X))
"RTN","PSBML",45,0)
 .I PSBREC(1)?1U1";".N S PSBREC(1)=$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1)
"RTN","PSBML",46,0)
 .I PSBREC(1)["V",+PSBREC(5)>0,+$P(PSBREC(5),".",2)=0,PSBIVT'["P" D NOW^%DTC S PSBREC(5)=$P(PSBREC(5),".",1)_"."_$P(%,".",2)
"RTN","PSBML",47,0)
 .I $P(PSBREC(9),U,1)="IVTAB",$P(PSBREC(9),U,2)="" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",48,0)
 .I $P(PSBREC(9),U,1)="PBTAB",$P(PSBREC(9),U,2)="",PSBREC(1)'["U",PSBREC(3)'="M",PSBREC(3)'="R",PSBREC(3)'="H" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",49,0)
 .;OnCall
"RTN","PSBML",50,0)
 .D:PSBREC(2)="OC"
"RTN","PSBML",51,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",52,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",53,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G"&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL")) D ERR(1,"On-Call already given")
"RTN","PSBML",54,0)
 .;1Time
"RTN","PSBML",55,0)
 .D:PSBREC(2)="O"
"RTN","PSBML",56,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",57,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",58,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G" D ERR(1,"One Time already Given")
"RTN","PSBML",59,0)
 .;Prn
"RTN","PSBML",60,0)
 .I PSBREC(2)="P",PSBREC(3)'="M",$P(PSBREC(9),U,1)'="IVTAB" D
"RTN","PSBML",61,0)
 ..I PSBREC(6)="" D ERR(1,"PRN Medications MUST Have a PRN Reason")
"RTN","PSBML",62,0)
 ..I PSBREC(5)]"" D ERR(1,"PRN Orders don't have scheduled times")
"RTN","PSBML",63,0)
 ..I PSBREC(3)'="G" D ERR(1,"PRN Orders cannot be marked NOT Given")
"RTN","PSBML",64,0)
 .;CSchd
"RTN","PSBML",65,0)
 .I PSBREC(2)="C",PSBTAB'="IVTAB" D
"RTN","PSBML",66,0)
 ..D:PSBREC(5)="" ERR(1,"Continuous Order MUST have admin time")
"RTN","PSBML",67,0)
 ..D:PSBREC(6)]"" ERR(1,"No PRN Reason allowed on Continuous Orders")
"RTN","PSBML",68,0)
 .I PSBREC(2)="C",$D(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),+PSBREC(5))),PSBIEN="+1" D  K PSBADMBY,PSBADMAT Q:PSBSIEN=""  Q:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",69,0)
 ..N PSBDTX S PSBDTX=$O(^PSB(53.79,"AORDX",PSBREC(0),PSBREC(1),""),-1)
"RTN","PSBML",70,0)
 ..S PSBSIEN=$O(^PSB(53.79,"AORDX",PSBREC(0),PSBREC(1),PSBDTX,""),-1)
"RTN","PSBML",71,0)
 ..I $D(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),+PSBREC(5))) D
"RTN","PSBML",72,0)
 ...I '(($P(^PSB(53.79,PSBSIEN,0),U,7)=DUZ)!($D(^XUSEC("PSB MANAGER",DUZ)))) S PSBSIEN="" Q
"RTN","PSBML",73,0)
 ...S PSBSIEN=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),+PSBREC(5),""))
"RTN","PSBML",74,0)
 ..I PSBSIEN']"" S RESULTS(0)=3,RESULTS(1)="-2^Error Filing Transaction MEDPASS",RESULTS(2)="This scheduled admin is",RESULTS(3)="being modified by another." Q
"RTN","PSBML",75,0)
 ..D:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",76,0)
 ...K PSBINCX I $P(^PSB(53.79,PSBSIEN,0),U,9)="" S PSBINCX=PSBSIEN Q
"RTN","PSBML",77,0)
 ...S Y=$P(^PSB(53.79,PSBSIEN,0),U,6) D DD^%DT S PSBADMAT=Y
"RTN","PSBML",78,0)
 ...S PSBADMBY=$$GET1^DIQ(200,$P(^PSB(53.79,PSBSIEN,0),U,7),.01,)
"RTN","PSBML",79,0)
 ...S RESULTS(0)=3,RESULTS(1)="-2^Error Filing Transaction MEDPASS"
"RTN","PSBML",80,0)
 ...S RESULTS(2)="Continuous Administration Date/Time already on file."
"RTN","PSBML",81,0)
 ...S RESULTS(3)="Administered by "_PSBADMBY_" at "_PSBADMAT_"."
"RTN","PSBML",82,0)
 ...I $D(XWB) S RESULTS(0)=RESULTS(0)+2,RESULTS(4)="                                         ",RESULTS(5)="            VDL will now be updated."
"RTN","PSBML",83,0)
 .;Non-Gvn
"RTN","PSBML",84,0)
 .I PSBREC(3)'="G",PSBREC(3)'="M",PSBUID'["V",PSBUID'["W" D
"RTN","PSBML",85,0)
 ..I PSBREC(7)="",PSBTAB'="IVTAB" D ERR(1,"Comment Required if Not Marked Given")
"RTN","PSBML",86,0)
 ..I PSBREC(7)="",PSBTAB="IVTAB" D ERR(1,"Comment Required if Not Marked Completed")
"RTN","PSBML",87,0)
 .S:PSBREC(3)="H" PSBREC(7)="Held: "_PSBREC(7)    ;UpdtCmmnt
"RTN","PSBML",88,0)
 .S:PSBREC(3)="R" PSBREC(7)="Refused: "_PSBREC(7) ;UpdtCmmnt
"RTN","PSBML",89,0)
 .S:PSBREC(3)="S" PSBREC(7)="Stopped: "_PSBREC(7) ;UpdtCmmnt
"RTN","PSBML",90,0)
 .;Valid ?
"RTN","PSBML",91,0)
 .I $G(PSBSIEN)'="" I $D(^PSB(53.79,PSBSIEN,0)) I $P(^PSB(53.79,PSBSIEN,0),U,9)="N" S PSBIEN=+PSBSIEN_",",$P(PSBHDR,U)=PSBIEN,PSBTRAN="UPDATE STATUS",PSBAUDIT=1   ; "not given" - UPDATE not CREATE
"RTN","PSBML",92,0)
 .D:PSBIEN="+1"  ;New ent?
"RTN","PSBML",93,0)
 ..D VAL(53.79,PSBIEN,.01,"`"_PSBREC(0)) ;Pat
"RTN","PSBML",94,0)
 ..S X=$G(^DPT(PSBREC(0),.1))_" "_$G(^(.101)) ;Wrd/RmBd
"RTN","PSBML",95,0)
 ..D VAL(53.79,PSBIEN,.02,X) ;PatLoc
"RTN","PSBML",96,0)
 ..D:$G(^DPT(PSBREC(0),.1))'=""
"RTN","PSBML",97,0)
 ...S Y=$O(^DIC(42,"B",$G(^DPT(PSBREC(0),.1)),"")),Y=$$GET1^DIQ(42,Y,.015,"I"),PSBDIV=$$SITE^VASITE(DT,Y)
"RTN","PSBML",98,0)
 ...D VAL(53.79,PSBIEN,.03,"`"_$P(PSBDIV,U,1)) ; Div
"RTN","PSBML",99,0)
 ..D VAL(53.79,PSBIEN,.04,PSBNOW)  ;EntrdDT
"RTN","PSBML",100,0)
 ..D VAL(53.79,PSBIEN,.05,"`"_DUZ) ;EntrdBy
"RTN","PSBML",101,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)  ;AdmnDT
"RTN","PSBML",102,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ) ;AdmnBy
"RTN","PSBML",103,0)
 ..D VAL(53.79,PSBIEN,.08,"`"_PSBREC(4)) ;OrdblItem
"RTN","PSBML",104,0)
 ..D VAL(53.79,PSBIEN,.11,PSBREC(1)) ;OrdTypeIEN
"RTN","PSBML",105,0)
 ..D VAL(53.79,PSBIEN,.12,PSBREC(2)) ;OrdSchdType
"RTN","PSBML",106,0)
 ..D VAL(53.79,PSBIEN,.13,PSBREC(5)) ;SchdAdmnDT
"RTN","PSBML",107,0)
 ..D:PSBTAB'="UDTAB" VAL(53.79,PSBIEN,.26,PSBUID) ;BagID
"RTN","PSBML",108,0)
 ..D:PSBTAB="IVTAB" VAL(53.79,PSBIEN,.13,"") ;no SchdAdmn per cont,non-PBack IV
"RTN","PSBML",109,0)
 ..D:PSBREC(1)?.N1"U" VAL(53.79,PSBIEN,.15,PSBDOSE) ;UDDosage
"RTN","PSBML",110,0)
 ..D:PSBREC(1)?.N1"V" VAL(53.79,PSBIEN,.35,PSBIFR)  ;IVInfRt
"RTN","PSBML",111,0)
 .;Ovrwrt if ordr exsts
"RTN","PSBML",112,0)
 .I PSBREC(3)="G"!(PSBREC(3))="C" D  ;Gvn/Compltd?
"RTN","PSBML",113,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)   ;AdmnDT
"RTN","PSBML",114,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ)  ;AdmnBy
"RTN","PSBML",115,0)
 .D:PSBREC(8)]"" VAL(53.79,PSBIEN,.16,PSBREC(8)) ;InjctSte
"RTN","PSBML",116,0)
 .D:'$G(PSBMMEN) VAL(53.79,PSBIEN,.09,PSBREC(3)) ;StatsofAdmn
"RTN","PSBML",117,0)
 .D:PSBREC(6)]"" VAL(53.79,PSBIEN,.21,$P(PSBREC(6),U)),VAL(53.79,PSBIEN,.27,$P(PSBREC(6),U,2)) ;PRNReasn
"RTN","PSBML",118,0)
 .D:PSBREC(7)]""
"RTN","PSBML",119,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.01,PSBREC(7)) ;Commnt
"RTN","PSBML",120,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.02,"`"_DUZ)   ;Who
"RTN","PSBML",121,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.03,PSBNOW)    ;Whn
"RTN","PSBML",122,0)
 .;DD/SOL/ADD
"RTN","PSBML",123,0)
 .I PSBREC(3)="G"!(PSBREC(3)="I")!(PSBREC(3)="H")!(PSBREC(3)="R")!(PSBREC(3)="M") D  ;Only gvn/infus
"RTN","PSBML",124,0)
 ..I PSBTRAN="UPDATE STATUS" K ^PSB(53.79,+PSBIEN,.5),^PSB(53.79,+PSBIEN,.6),^PSB(53.79,+PSBIEN,.7)
"RTN","PSBML",125,0)
 ..F PSBCNT=10:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML",126,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML",127,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML",128,0)
 ...Q:'PSBDD
"RTN","PSBML",129,0)
 ...S PSBIENS="+"_PSBCNT_","_PSBIEN
"RTN","PSBML",130,0)
 ...D VAL(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML",131,0)
 ...D VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML",132,0)
 ...D VAL(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4))
"RTN","PSBML",133,0)
 ...D:(PSBTAB="UDTAB")!(PSBTAB="PBTAB") VAL(PSBDD,PSBIENS,.04,$E($P(PSBREC(PSBCNT),U,5),1,20))
"RTN","PSBML",134,0)
 .I $O(RESULTS("")) S RESULTS(0)=1,RESULTS(1)="-1^Error(s) Filing Transaction MEDPASS"  Q
"RTN","PSBML",135,0)
 .D FILEIT
"RTN","PSBML",136,0)
 .D:(PSBREC(2)="O")&(PSBREC(3)="G") EXPIRE^PSBML1  ;1time exprd?
"RTN","PSBML",137,0)
 .I $P(RESULTS(0),U,1)=1,PSBTAB'="UDTAB",PSBUID]"",PSBUID'["WS" S PSBON=+PSBREC(1) D EN^PSJBCMA3(PSBREC(0),PSBON,PSBUID,PSBREC(3),PSBNOW)
"RTN","PSBML",138,0)
 Q
"RTN","PSBML",139,0)
BCBU ;HL7,NatConting
"RTN","PSBML",140,0)
 Q:+$G(RESULTS(0))'>0
"RTN","PSBML",141,0)
 N PSBIEN1 S PSBIEN1=$S($P(PSBIEN,",",2)'="":+$P(PSBIEN,",",2),$G(PSBIEN)="+1":PSBIEN(1),1:+$G(PSBIEN))
"RTN","PSBML",142,0)
 I $G(PSBIEN1)="" S RESULTS(0)=1,RESULTS(1)="-1^Contingency NOT processed" Q
"RTN","PSBML",143,0)
 I $G(PSBIEN)="+1" S PSBHL7="MEDPASS"
"RTN","PSBML",144,0)
 E  S:$G(PSBHL7)="" PSBHL7="UPDATE STATUS"
"RTN","PSBML",145,0)
 D:('$D(Y(0))!($G(Y(0))="SAVE")!($G(Y(0))="YES")) EN^PSBSVHL7(+PSBIEN1,PSBHL7),MEDL^ALPBCBU(+PSBIEN1) K PSBHL7 ;HL7,BCMAConting
"RTN","PSBML",146,0)
 ;**HDR-VDEF here** (frm *3)
"RTN","PSBML",147,0)
 Q
"RTN","PSBML",148,0)
VAL(PSBDD,PSBIEN,PSBFLD,PSBVAL) ;
"RTN","PSBML",149,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",150,0)
 D VAL^DIE(PSBDD,PSBIEN,PSBFLD,"F",PSBVAL,.PSBRET,"PSBFDA")
"RTN","PSBML",151,0)
 I PSBRET="^" F X=0:0 S X=$O(^TMP("DIERR",$J,X)) Q:'X  D ERR(2,^TMP("DIERR",$J,X)_": "_$G(^(X,"TEXT",1),"**"))
"RTN","PSBML",152,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",153,0)
 Q
"RTN","PSBML",154,0)
FILEIT ;UpdtMedLog
"RTN","PSBML",155,0)
 N PSBMSG,PSBAUD
"RTN","PSBML",156,0)
 S (PSB1,PSB2)=""
"RTN","PSBML",157,0)
 D APATCH^PSBML2
"RTN","PSBML",158,0)
 D CLEAN^DILF
"RTN","PSBML",159,0)
 D RESETADM^PSBUTL
"RTN","PSBML",160,0)
 D UPDATE^DIE("","PSBFDA","PSBIEN","PSBMSG")
"RTN","PSBML",161,0)
 I '$G(PSBMMEN) S X=+PSBIEN I $F("HR",$P(^PSB(53.79,X,0),U,9))>1 F Y=.5,.6,.7 S Z=0 F  S Z=$O(^PSB(53.79,+X,Y,Z)) Q:+Z=0  S $P(^PSB(53.79,+X,Y,Z,0),U,3)=0
"RTN","PSBML",162,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=1,RESULTS(1)="-1^"_PSBMSG("DIERR",1)_": "_PSBMSG("DIERR",1,"TEXT",1)  Q
"RTN","PSBML",163,0)
 I $G(PSB1)]"" X PSB1 I $G(PSB2)]"" X PSB2
"RTN","PSBML",164,0)
 I $D(PSBHDR) D:"NHMR"[$P(^PSB(53.79,$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN),0),U,9)
"RTN","PSBML",165,0)
 .N PSBINDX S PSBINDX=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN)
"RTN","PSBML",166,0)
 .K ^PSB(53.79,"APATCH",$P(^PSB(53.79,PSBINDX,0),U),$P(^PSB(53.79,PSBINDX,0),U,6),PSBINDX)
"RTN","PSBML",167,0)
 S RESULTS(0)=1,RESULTS(1)="1^Data Successfully Filed^"_$S($G(PSBIEN(1))'="":$G(PSBIEN(1)),1:+$G(PSBIEN))
"RTN","PSBML",168,0)
 D BCBU  ;NatConting
"RTN","PSBML",169,0)
 I $G(PSBINST,0) S PSBAUD=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:$P(PSBHDR,"^",1)) D AUDIT^PSBMLU(PSBAUD,"Instructor "_PSBINST(0)_" present.",PSBTRAN)
"RTN","PSBML",170,0)
 Q
"RTN","PSBML",171,0)
ERR(X,Y) ;
"RTN","PSBML",172,0)
 S X=$P("Business Logic Error^Data Validation Error",U,X)
"RTN","PSBML",173,0)
 S RESULTS($O(RESULTS(""),-1)+1)=X_": "_Y
"RTN","PSBML",174,0)
 Q
"RTN","PSBML",175,0)
COMMENT(DA,PSBCMT) ;
"RTN","PSBML",176,0)
 N PSBFDA,PSBIEN,PSBNOW
"RTN","PSBML",177,0)
 S PSBIEN="+1,"_DA_","
"RTN","PSBML",178,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",179,0)
 D VAL(53.793,PSBIEN,.01,PSBCMT)
"RTN","PSBML",180,0)
 S PSBFDA(53.793,PSBIEN,.02)=DUZ
"RTN","PSBML",181,0)
 S PSBFDA(53.793,PSBIEN,.03)=PSBNOW
"RTN","PSBML",182,0)
 D FILEIT
"RTN","PSBML",183,0)
 Q
"RTN","PSBMLEN1")
0^10^B44879194
"RTN","PSBMLEN1",1,0)
PSBMLEN1 ;BIRMINGHAM/EFC-BCMA MEDICATION LOG FUNCTIONS ;Mar 2004
"RTN","PSBMLEN1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,4,9,11**;Mar 2004
"RTN","PSBMLEN1",3,0)
 ;
"RTN","PSBMLEN1",4,0)
 ; Reference/IA
"RTN","PSBMLEN1",5,0)
 ; ENE^PSJBCMA4/3416
"RTN","PSBMLEN1",6,0)
 ; ^XUSEC/10076
"RTN","PSBMLEN1",7,0)
 ; HLP^DDSUTL/10150
"RTN","PSBMLEN1",8,0)
 ;
"RTN","PSBMLEN1",9,0)
NEW(Y) ; Create the new entry
"RTN","PSBMLEN1",10,0)
 N PSBREC,PSB,PSBADST,PSBFREQ
"RTN","PSBMLEN1",11,0)
 S PSBMMEN=1
"RTN","PSBMLEN1",12,0)
 W @IOF D CLEAN^PSBVT,PSJ1^PSBVT(DFN,Y)
"RTN","PSBMLEN1",13,0)
 D NOW^%DTC
"RTN","PSBMLEN1",14,0)
 I PSBOSP<% D  Q:%'=1
"RTN","PSBMLEN1",15,0)
 .W @IOF,$C(7)
"RTN","PSBMLEN1",16,0)
 .W !,"NOTICE: This order is NOT currently active."
"RTN","PSBMLEN1",17,0)
 .W !,"        Are You Sure You Want To Continue"
"RTN","PSBMLEN1",18,0)
 .S %=2 D YN^DICN
"RTN","PSBMLEN1",19,0)
 I PSBADST="" S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX),PSBADST=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBDT)
"RTN","PSBMLEN1",20,0)
 E  K ^TMP("PSB",$J,"GETADMIN") S ^TMP("PSB",$J,"GETADMIN",0)=PSBADST
"RTN","PSBMLEN1",21,0)
 S PSBODSCH=0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODSCH=1
"RTN","PSBMLEN1",22,0)
 W !,"Order:       ",PSBONX
"RTN","PSBMLEN1",23,0)
 W !,"Medication:  ",PSBOITX
"RTN","PSBMLEN1",24,0)
 W !,"Dosage:      ",PSBDOSE
"RTN","PSBMLEN1",25,0)
 W !,"Schedule:    ",PSBSCH
"RTN","PSBMLEN1",26,0)
 W !,"Admin Times: ",$S(PSBODSCH:"(Odd Sched.)",1:PSBADST)
"RTN","PSBMLEN1",27,0)
 I $D(^XUSEC("PSB READ ONLY",DUZ)) D  Q
"RTN","PSBMLEN1",28,0)
 .W !!,"Medications CANNOT be administered while in PSB READ ONLY mode.",!! R "Press ENTER KEY to continue. ",PSBCNTNU:5
"RTN","PSBMLEN1",29,0)
 W !!,"Is this the correct Order" S %=1 D YN^DICN Q:%'=1
"RTN","PSBMLEN1",30,0)
 ;
"RTN","PSBMLEN1",31,0)
 ; PRN, One-Time, On Call orders
"RTN","PSBMLEN1",32,0)
 ;
"RTN","PSBMLEN1",33,0)
 I PSBSCHT'="C" D
"RTN","PSBMLEN1",34,0)
 .D VAL^PSBMLVAL(.PSB,DFN,+PSBONX,$E(PSBONX,$L(PSBONX)))
"RTN","PSBMLEN1",35,0)
 .I PSBSCHT="P",($D(PSB(1))) W !!,"Brief Administration History:  ",! S X=$O(PSB(" "),-1),X=$S(X>4:4,1:X) F I=1:1:X W !,?5,PSB(I)
"RTN","PSBMLEN1",36,0)
 .I $D(^XUSEC("PSB READ ONLY",DUZ)) W !,"This operation is NOT AVAILABLE in PSB READ ONLY mode.",! Q
"RTN","PSBMLEN1",37,0)
 .I ($D(^XUSEC("PSB STUDENT",DUZ))),('$D(^XUSEC("PSB INSTRUCTOR"))) W !,"This operation is NOT AVAILABLE in PSB READ ONLY mode.",! Q
"RTN","PSBMLEN1",38,0)
 .W !!,"Create an administration for this order" S %=1 D YN^DICN Q:%'=1
"RTN","PSBMLEN1",39,0)
 .I PSBSCHT="P" D  Q:Y=""!(Y["^")
"RTN","PSBMLEN1",40,0)
 ..K DIR S DIR(0)="FB^1:30",DIR("A")="PRN Reason (1-30 characters)"
"RTN","PSBMLEN1",41,0)
 ..W !!,"NOTICE: PRN Reason is Required for ALL PRN Entries",!
"RTN","PSBMLEN1",42,0)
 ..D ^DIR
"RTN","PSBMLEN1",43,0)
 ..I Y=""!(Y["^") W !!,"Sorry, Reason is required, No Entry Made!" Q
"RTN","PSBMLEN1",44,0)
 ..S PSBREC(6)=$P(Y,"|")
"RTN","PSBMLEN1",45,0)
 .; Build the form of dosage to CAP or TAB or null
"RTN","PSBMLEN1",46,0)
 .S:(PSBDOSEF'?1"CAP".E)&(PSBDOSEF'?1"TAB".E)&(PSBDOSEF'?1"PATCH".E) PSBDOSEF=""
"RTN","PSBMLEN1",47,0)
 .; Build the variable dose check #####-#####MG
"RTN","PSBMLEN1",48,0)
 .S PSBVARD=$S(PSBDOSE?1.5N1"-"1.5N.E:1,1:0)
"RTN","PSBMLEN1",49,0)
 .S PSBREC(0)=DFN
"RTN","PSBMLEN1",50,0)
 .S PSBREC(1)=PSBONX
"RTN","PSBMLEN1",51,0)
 .S PSBREC(2)=PSBSCHT
"RTN","PSBMLEN1",52,0)
 .S PSBREC(3)="G"
"RTN","PSBMLEN1",53,0)
 .S PSBREC(4)=PSBOIT
"RTN","PSBMLEN1",54,0)
 .S PSBREC(5)=""
"RTN","PSBMLEN1",55,0)
 .S PSBREC(7)="Entry created with 'Manual Medication Entry' option."
"RTN","PSBMLEN1",56,0)
 .S PSBREC(8)=""
"RTN","PSBMLEN1",57,0)
 .S PSBREC(9)=$S(PSBONX["U":"UDTAB",1:"PBTAB")
"RTN","PSBMLEN1",58,0)
 .S PSBINDX=10
"RTN","PSBMLEN1",59,0)
 .S X="" F  S X=$O(PSBDDA(X)) Q:X=""  S PSBREC(PSBINDX)=$P(PSBDDA(X),U,1,2)_U_$P(PSBDDA(X),U,4)_U_$P(PSBDDA(X),U,4)_U_PSBDOSEF,PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",60,0)
 .S X="" F  S X=$O(PSBADA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBADA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",61,0)
 .S X="" F  S X=$O(PSBSOLA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBSOLA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",62,0)
 .D FILE
"RTN","PSBMLEN1",63,0)
 .I $G(DA),PSBREC(2)="O",$D(^PSB(53.79,DA)) I $P(^PSB(53.79,DA,0),U,9)="G" D ENE^PSJBCMA4(PSBREC(0),PSBREC(1))
"RTN","PSBMLEN1",64,0)
 ;
"RTN","PSBMLEN1",65,0)
 ; Continuous Meds
"RTN","PSBMLEN1",66,0)
 ;
"RTN","PSBMLEN1",67,0)
 I PSBSCHT="C" D
"RTN","PSBMLEN1",68,0)
 .W ! S %DT="AEQ",%DT("A")="Enter the DATE the medication was administered: "
"RTN","PSBMLEN1",69,0)
 .D NOW^%DTC S %DT(0)=(-1)*X,%DT("B")="" D ^%DT K %DT(0) Q:Y<1  S PSBDTX=Y D D^DIQ
"RTN","PSBMLEN1",70,0)
 .S:PSBODSCH PSBSCTMX=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBDTX)
"RTN","PSBMLEN1",71,0)
 .F PSBXX=0:1 Q:$G(^TMP("PSB",$J,"GETADMIN",PSBXX))=""  D
"RTN","PSBMLEN1",72,0)
 ..S X="",Y=$G(^TMP("PSB",$J,"GETADMIN",PSBXX))
"RTN","PSBMLEN1",73,0)
 ..F Z=1:1:$L(Y,"-") S X=X_$S(X]"":";",1:"")_Z_":"_$P(Y,"-",Z)
"RTN","PSBMLEN1",74,0)
 .I PSBODSCH,PSBSCTMX="" D  Q
"RTN","PSBMLEN1",75,0)
 ..W !!,"Order "_PSBONX_" is NOT SCHEDULED for administration on that entered date."
"RTN","PSBMLEN1",76,0)
 ..K DIR S DIR(0)="E^" D ^DIR
"RTN","PSBMLEN1",77,0)
 .K DIR S DIR(0)="S^"_X,DIR("A")="Select Administration Time"
"RTN","PSBMLEN1",78,0)
 .D ^DIR Q:Y<1
"RTN","PSBMLEN1",79,0)
 .S PSBDTX=+(PSBDTX_"."_Y(0))
"RTN","PSBMLEN1",80,0)
 .S Y=PSBDTX D D^DIQ
"RTN","PSBMLEN1",81,0)
 .W !!,"Create an administration for ",Y S %=1 D YN^DICN  Q:%'=1
"RTN","PSBMLEN1",82,0)
FORUM .; Build the form of dosage to CAP or TAB or null
"RTN","PSBMLEN1",83,0)
 .S PSBDOSEF=PSBDOSEF
"RTN","PSBMLEN1",84,0)
 .S:(PSBDOSEF'?1"CAP".E)&(PSBDOSEF'?1"TAB".E)&(PSBDOSEF'?1"PATCH".E) PSBDOSEF=""
"RTN","PSBMLEN1",85,0)
 .; Build the variable dose check #####-#####MG
"RTN","PSBMLEN1",86,0)
 .S PSBVARD=$S(PSBDOSE?1.5N1"-"1.5N.E:1,1:0)
"RTN","PSBMLEN1",87,0)
 .S PSBREC(0)=DFN
"RTN","PSBMLEN1",88,0)
 .S PSBREC(1)=PSBONX
"RTN","PSBMLEN1",89,0)
 .S PSBREC(2)=PSBSCHT
"RTN","PSBMLEN1",90,0)
 .S PSBREC(3)="G"
"RTN","PSBMLEN1",91,0)
 .S PSBREC(4)=PSBOIT
"RTN","PSBMLEN1",92,0)
 .S PSBREC(5)=PSBDTX
"RTN","PSBMLEN1",93,0)
 .S PSBREC(6)=""
"RTN","PSBMLEN1",94,0)
 .S PSBREC(7)="Entry created with 'Manual Medication Entry' option."
"RTN","PSBMLEN1",95,0)
 .S PSBREC(8)=""
"RTN","PSBMLEN1",96,0)
 .S PSBREC(9)=$S(PSBONX["U":"UDTAB",1:"PBTAB")
"RTN","PSBMLEN1",97,0)
 .S PSBINDX=10
"RTN","PSBMLEN1",98,0)
 .S X="" F  S X=$O(PSBDDA(X)) Q:X=""  S PSBREC(PSBINDX)=$P(PSBDDA(X),U,1,2)_U_$P(PSBDDA(X),U,4)_U_$P(PSBDDA(X),U,4)_U_PSBDOSEF,PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",99,0)
 .S X="" F  S X=$O(PSBADA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBADA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",100,0)
 .S X="" F  S X=$O(PSBSOLA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBSOLA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",101,0)
 .D FILE
"RTN","PSBMLEN1",102,0)
 Q
"RTN","PSBMLEN1",103,0)
 ;
"RTN","PSBMLEN1",104,0)
FILE ; Call the med log RPC to file it and DDS to edit it
"RTN","PSBMLEN1",105,0)
 N PSB,PSBSAVE,PSBAUDIT
"RTN","PSBMLEN1",106,0)
 D RPC^PSBML(.PSB,"+1^MEDPASS",.PSBREC)
"RTN","PSBMLEN1",107,0)
 I '$D(PSB) S PSB(0)=1,PSB(1)="1^RE-COMPLETE ENTRY^"_PSBINCX
"RTN","PSBMLEN1",108,0)
 I +PSB(1)<1 D  Q
"RTN","PSBMLEN1",109,0)
 .W @IOF,!,"Error(s) Creating Med Log Entry",!
"RTN","PSBMLEN1",110,0)
 .S X=$S(PSB(0)=1:0,1:1) F  S X=$O(PSB(X)) Q:X=""  W !,$J($S(X=1:X,1:X-1),2),". ",$S(X=1:$P(PSB(X),"^",2),1:PSB(X))
"RTN","PSBMLEN1",111,0)
 .W !!,"No Med Log Entry Created.",!!
"RTN","PSBMLEN1",112,0)
 .K DIR S DIR(0)="E" D ^DIR
"RTN","PSBMLEN1",113,0)
 S PSBSAVE=0 S:'$G(PSBMMEN) PSBAUDIT=1
"RTN","PSBMLEN1",114,0)
 S DA=$P(PSB(1),U,3),DDSFILE=53.79
"RTN","PSBMLEN1",115,0)
 I $P(^PSB(53.79,DA,.1),U,1)?.N1"U" S DR="[PSB NEW UD ENTRY]"
"RTN","PSBMLEN1",116,0)
 I $P(^PSB(53.79,DA,.1),U,1)?.N1"V" S DR="[PSB NEW IV ENTRY]"
"RTN","PSBMLEN1",117,0)
 D ^DDS
"RTN","PSBMLEN1",118,0)
 I PSBSAVE'=1 D
"RTN","PSBMLEN1",119,0)
 .W !,"Incomplete Med Log Entry, Deleting...#",DA S A=^PSB(53.79,DA,0),DFN=$P(A,U,1),AADT=$P(A,U,6)
"RTN","PSBMLEN1",120,0)
 .K ^PSB(53.79,"AADT",DFN,AADT,DA) S DIK="^PSB(53.79," D ^DIK
"RTN","PSBMLEN1",121,0)
 I PSBSAVE=1 D
"RTN","PSBMLEN1",122,0)
 .I $D(DA) D:($P(^PSB(53.79,DA,0),U,9)="G")
"RTN","PSBMLEN1",123,0)
 ..I $D(^PSB(53.79,DA,.5)) S PSBY=0 F  S PSBY=$O(^PSB(53.79,DA,.5,PSBY)) Q:+PSBY<1  D
"RTN","PSBMLEN1",124,0)
 ...I $P(^PSB(53.79,DA,.5,PSBY,0),U,4)="PATCH" D
"RTN","PSBMLEN1",125,0)
 ....S (PSBYX,PSBXUIT)="" F  S PSBYX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBYX),-1)   Q:PSBYX=""  D  Q:PSBXUIT
"RTN","PSBMLEN1",126,0)
 .....S PSBYZ="" S PSBYZ=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBYX,PSBYZ)) I (PSBYZ'=DA),$P(^PSB(53.79,PSBYZ,0),U,9)="G" D
"RTN","PSBMLEN1",127,0)
 ......W !!,"PATCH has been GIVEN before this admin completed; Deleting Med Log Entry...#",DA,!! S A=^PSB(53.79,DA,0),DFN=$P(A,U,1),AADT=$P(A,U,6)
"RTN","PSBMLEN1",128,0)
 ......K ^PSB(53.79,"AADT",DFN,AADT,DA) S DIK="^PSB(53.79," D ^DIK
"RTN","PSBMLEN1",129,0)
 ......S PSBXUIT=1
"RTN","PSBMLEN1",130,0)
 ....Q:PSBXUIT
"RTN","PSBMLEN1",131,0)
 ....S ^PSB(53.79,"APATCH",$P(^PSB(53.79,DA,0),U),$P(^PSB(53.79,DA,0),U,6),DA)=""
"RTN","PSBMLEN1",132,0)
 .Q:(PSBIEN="+1")&('$D(PSBIEN(1)))
"RTN","PSBMLEN1",133,0)
 .Q:$G(PSBXUIT)
"RTN","PSBMLEN1",134,0)
 .S X=$S($P(PSBIEN,",",2)]"":$P(PSBIEN,",",2),PSBIEN="+1":PSBIEN(1),1:"")
"RTN","PSBMLEN1",135,0)
 .I X]"" I ($F("HR",$P(^PSB(53.79,X,0),U,9))>1) F Y=.5,.6,.7 S Z=0 F  S Z=$O(^PSB(53.79,X,Y,Z)) Q:+Z=0  S $P(^PSB(53.79,X,Y,Z,0),U,3)=0
"RTN","PSBMLEN1",136,0)
 Q
"RTN","PSBMLEN1",137,0)
 ;
"RTN","PSBMLEN1",138,0)
FDATE ;Check Admin Time for future date/time.
"RTN","PSBMLEN1",139,0)
 N PSBTIMX
"RTN","PSBMLEN1",140,0)
 S PSBTIMX=X D NOW^%DTC
"RTN","PSBMLEN1",141,0)
 I PSBTIMX>% W $C(7) S (DDSERROR,DDSBR)=1 D HLP^DDSUTL("Future date/time is not allowed")
"RTN","PSBMLEN1",142,0)
 Q
"RTN","PSBMLEN1",143,0)
 ;
"RTN","PSBMLLKU")
0^3^B62070466
"RTN","PSBMLLKU",1,0)
PSBMLLKU ;BIRMINGHAM/TEJ-BCMA RPC LOOKUP UTLILITIES ;Mar 2004
"RTN","PSBMLLKU",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,9,11**;Mar 2004
"RTN","PSBMLLKU",3,0)
 ;
"RTN","PSBMLLKU",4,0)
 ; Reference/IA
"RTN","PSBMLLKU",5,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBMLLKU",6,0)
 ; $$DOB^DPTLK1/3266
"RTN","PSBMLLKU",7,0)
 ; $$SSN^DPTLK1/3267
"RTN","PSBMLLKU",8,0)
 ; ^DPT/10035
"RTN","PSBMLLKU",9,0)
 ; ^XUSEC/10076
"RTN","PSBMLLKU",10,0)
 ; File 52.6/436
"RTN","PSBMLLKU",11,0)
 ; File 52.7/437
"RTN","PSBMLLKU",12,0)
 ; File 50/221
"RTN","PSBMLLKU",13,0)
 ;
"RTN","PSBMLLKU",14,0)
 ;
"RTN","PSBMLLKU",15,0)
RPC(RESULTS,PSBREC) ; Remote Procedure Call Entry Point.
"RTN","PSBMLLKU",16,0)
 ;
"RTN","PSBMLLKU",17,0)
 S RESULTS="" D @(PSBREC(0)_"(.RESULTS,.PSBREC)") Q
"RTN","PSBMLLKU",18,0)
 Q
"RTN","PSBMLLKU",19,0)
 ;
"RTN","PSBMLLKU",20,0)
ADMLKUP(RESULTS,PSBREC) ;
"RTN","PSBMLLKU",21,0)
 ;  Lookup ADMinistrations per DFN and search DATE
"RTN","PSBMLLKU",22,0)
 ;   input - PSBREC(1)  DFN
"RTN","PSBMLLKU",23,0)
 ;           PSBREC(2)  Search DATE
"RTN","PSBMLLKU",24,0)
 ;
"RTN","PSBMLLKU",25,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",26,0)
 ;          (Administrations returned will be dated  = to Search Date
"RTN","PSBMLLKU",27,0)
 ;
"RTN","PSBMLLKU",28,0)
 ;
"RTN","PSBMLLKU",29,0)
 K RESULTS
"RTN","PSBMLLKU",30,0)
 S DFN=PSBREC(1),PSBSRCH=$G(PSBREC(2)) I $G(PSBSRCH)']"" D NOW^%DTC S PSBSRCH=$P(%,".")
"RTN","PSBMLLKU",31,0)
 S PSBDT=PSBSRCH,PSBCNT=0 S:PSBSRCH'["." PSBSRCH=PSBSRCH+.9
"RTN","PSBMLLKU",32,0)
 S RESULTS(0)=1,RESULTS(1)="-1^No Meds Found!"
"RTN","PSBMLLKU",33,0)
 F  S PSBSRCH=$O(^PSB(53.79,"AADT",DFN,PSBSRCH),-1) Q:'PSBSRCH!(PSBSRCH<PSBDT)  D
"RTN","PSBMLLKU",34,0)
 .S PSBIEN=""
"RTN","PSBMLLKU",35,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBSRCH,PSBIEN),-1) Q:'PSBIEN  D:'$D(^PSB(53.79,PSBIEN)) KILLAADT  Q:'$D(^PSB(53.79,PSBIEN))  D:$$CHKKEY(PSBIEN)
"RTN","PSBMLLKU",36,0)
 ..S PSBXORDN=$$GET1^DIQ(53.79,PSBIEN_",",.11) Q:'$D(^PSB(53.79,"AORDX",DFN,PSBXORDN,PSBSRCH))
"RTN","PSBMLLKU",37,0)
 ..Q:($$GET1^DIQ(53.79,PSBIEN_",",.06,"I")>PSBSRCH)
"RTN","PSBMLLKU",38,0)
 ..Q:($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")="N")!($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")']"")
"RTN","PSBMLLKU",39,0)
 ..S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=PSBIEN
"RTN","PSBMLLKU",40,0)
 ..S $P(RESULTS(PSBCNT),U,2)=PSBSRCH
"RTN","PSBMLLKU",41,0)
 ..S $P(RESULTS(PSBCNT),U,3)=$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBMLLKU",42,0)
 ..S:$$GET1^DIQ(53.79,PSBIEN_",",.26) $P(RESULTS(PSBCNT),U,4)=$$GET1^DIQ(53.79,PSBIEN_",",.26)
"RTN","PSBMLLKU",43,0)
 ..S $P(RESULTS(PSBCNT),U,5)=$$GET1^DIQ(53.79,PSBIEN_",",.09)
"RTN","PSBMLLKU",44,0)
 ..D  ; Get order information
"RTN","PSBMLLKU",45,0)
 ...K ^TMP("PSJ1",$J) D EN^PSJBCMA1(DFN,PSBXORDN,1)
"RTN","PSBMLLKU",46,0)
 ...S $P(RESULTS(PSBCNT),U,3)=$P(^TMP("PSJ1",$J,2),U,2)  ;OItem_" "_Dosage Form
"RTN","PSBMLLKU",47,0)
 ...S $P(RESULTS(PSBCNT),U,6)=$P(^TMP("PSJ1",$J,4),U)    ;Sched Type
"RTN","PSBMLLKU",48,0)
 ...K ^TMP("PSJ1",$J)
"RTN","PSBMLLKU",49,0)
 ..S $P(RESULTS(PSBCNT),U,7)=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I")
"RTN","PSBMLLKU",50,0)
 ..S $P(RESULTS(PSBCNT),U,8)=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBMLLKU",51,0)
 ..S:$D(^PSB(53.79,PSBIEN,.2)) $P(RESULTS(PSBCNT),U,9)=$P(^PSB(53.79,PSBIEN,.2),U),$P(RESULTS(PSBCNT),U,10)=$P(^PSB(53.79,PSBIEN,.2),U,2)
"RTN","PSBMLLKU",52,0)
 S:+$G(RESULTS(1))>0 $P(RESULTS(0),U)=PSBCNT
"RTN","PSBMLLKU",53,0)
 Q
"RTN","PSBMLLKU",54,0)
 ;
"RTN","PSBMLLKU",55,0)
CHKKEY(PSBIENX) ;
"RTN","PSBMLLKU",56,0)
 I '(($D(^XUSEC("PSB MANAGER",DUZ)))!($$GET1^DIQ(53.79,+PSBIENX,.07,"I")=DUZ)) Q 0
"RTN","PSBMLLKU",57,0)
 Q 1
"RTN","PSBMLLKU",58,0)
 ;
"RTN","PSBMLLKU",59,0)
PTLKUP(RESULTS,PSBREC) ; Patient lookup handled separately for security
"RTN","PSBMLLKU",60,0)
 ;   input - PSBREC (array)  User entered patient lookup data
"RTN","PSBMLLKU",61,0)
 ;
"RTN","PSBMLLKU",62,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",63,0)
 ;          (Person(s) in PATIENT File (#2) meeting search criteria)
"RTN","PSBMLLKU",64,0)
 ;
"RTN","PSBMLLKU",65,0)
 ;
"RTN","PSBMLLKU",66,0)
 K RESULTS
"RTN","PSBMLLKU",67,0)
 S PSBDATA=$E(PSBREC(1),1,30)
"RTN","PSBMLLKU",68,0)
 N PSBINDX
"RTN","PSBMLLKU",69,0)
 S PSBINDX=$S(PSBDATA?9N.1P:"SSN",PSBDATA?4N.1P:"BS5^BS",1:"")
"RTN","PSBMLLKU",70,0)
 D FIND^DIC(2,"","@;.01;.02;.03;.09","MP",PSBDATA,200,PSBINDX)
"RTN","PSBMLLKU",71,0)
 I $P(^TMP("DILIST",$J,0),U,3) D  Q
"RTN","PSBMLLKU",72,0)
 .S RESULTS(0)=1,RESULTS(1)="-1^Too many patients found matching '"_PSBDATA_"'. Please be more specific."
"RTN","PSBMLLKU",73,0)
 F PSBXX=0:0 S PSBXX=$O(^TMP("DILIST",$J,PSBXX)) Q:'PSBXX  D
"RTN","PSBMLLKU",74,0)
 .S RESULTS(PSBXX)=$$PTREC(+^TMP("DILIST",$J,PSBXX,0))
"RTN","PSBMLLKU",75,0)
 I '$D(RESULTS) S RESULTS(0)=1,RESULTS(1)="-1^No patients matching '"_PSBDATA_"'"
"RTN","PSBMLLKU",76,0)
 E  S RESULTS(0)=+$O(RESULTS(""),-1)
"RTN","PSBMLLKU",77,0)
 Q
"RTN","PSBMLLKU",78,0)
 ;
"RTN","PSBMLLKU",79,0)
PTREC(DFN) ;
"RTN","PSBMLLKU",80,0)
 ; Extrinsic to return a Pt Rec  in standard list format
"RTN","PSBMLLKU",81,0)
 N PSBXX
"RTN","PSBMLLKU",82,0)
 S PSBXX=$G(^DPT(DFN,0))
"RTN","PSBMLLKU",83,0)
 S PSBXX=DFN_U_$P(PSBXX,U,1)_U_$P(PSBXX,U,2)_U_$P(PSBXX,U,3)_U_$P(PSBXX,U,9)
"RTN","PSBMLLKU",84,0)
 S $P(PSBXX,U,6)=$$GET1^DIQ(2,DFN_",",.1)
"RTN","PSBMLLKU",85,0)
 S $P(PSBXX,U,7)=$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBMLLKU",86,0)
 S $P(PSBXX,U,10)=$$DOB^DPTLK1(DFN)
"RTN","PSBMLLKU",87,0)
 S $P(PSBXX,U,11)=$$SSN^DPTLK1(DFN)
"RTN","PSBMLLKU",88,0)
 Q PSBXX
"RTN","PSBMLLKU",89,0)
 ;
"RTN","PSBMLLKU",90,0)
SELECTAD(RESULTS,PSBREC) ; Select Administration
"RTN","PSBMLLKU",91,0)
 ;
"RTN","PSBMLLKU",92,0)
 ;  Process the SELECTed ADministration
"RTN","PSBMLLKU",93,0)
 ;   input - PSBREC(1) = PSB Med Log File (#53.79) IEN
"RTN","PSBMLLKU",94,0)
 ;
"RTN","PSBMLLKU",95,0)
 ;
"RTN","PSBMLLKU",96,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",97,0)
 ;          (Administration data that can be subsequently updated via GUI MED LOG EDIT)
"RTN","PSBMLLKU",98,0)
 ;
"RTN","PSBMLLKU",99,0)
 ;
"RTN","PSBMLLKU",100,0)
 K RESULTS,PSBXIV,PSBPTCHX
"RTN","PSBMLLKU",101,0)
 N PSBIEN,PSBCNT,PSBX S PSBIEN=PSBREC(1),PSBCNT=2
"RTN","PSBMLLKU",102,0)
 ; Construct form data    Patient^SSN^Med^BagID^AdminStat^AdminD/T^InjctSt^PRNReas^PRNEff^DisDrg^UntsGiven^Unt^
"RTN","PSBMLLKU",103,0)
 S RESULTS(0)=0
"RTN","PSBMLLKU",104,0)
 D:$$CHKKEY(PSBIEN)
"RTN","PSBMLLKU",105,0)
 .L +^PSB(53.79,PSBIEN):1
"RTN","PSBMLLKU",106,0)
 .E  S PSBCNT=1,RESULTS(1)="-1^ This administration is being modified by another process at this moment." Q
"RTN","PSBMLLKU",107,0)
 .S $P(RESULTS(1),U)=PSBIEN
"RTN","PSBMLLKU",108,0)
 .S $P(RESULTS(1),U,2)=$$GET1^DIQ(53.79,PSBIEN_",",.01,"I")
"RTN","PSBMLLKU",109,0)
 .S $P(RESULTS(1),U,3)=$$GET1^DIQ(53.79,PSBIEN_",",.01)
"RTN","PSBMLLKU",110,0)
 .S $P(RESULTS(1),U,4)=$$GET1^DIQ(2,$P(RESULTS(1),U,2)_",",.09)
"RTN","PSBMLLKU",111,0)
 .S $P(RESULTS(1),U,5)=$$GET1^DIQ(53.79,PSBIEN_",",.08,"I")_"~"_$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBMLLKU",112,0)
 .S $P(RESULTS(1),U,6)=$$GET1^DIQ(53.79,PSBIEN_",",.26)
"RTN","PSBMLLKU",113,0)
 .S $P(RESULTS(1),U,7)=$$GET1^DIQ(53.79,PSBIEN_",",.09,"I")
"RTN","PSBMLLKU",114,0)
 .;
"RTN","PSBMLLKU",115,0)
 .D:($P(RESULTS(1),U,7)'="N")&($P(RESULTS(1),U,7)]"") SELSTTUS(.RESULTS)  ; Amend RESULTS(1) data...
"RTN","PSBMLLKU",116,0)
 .S Y=$E($$GET1^DIQ(53.79,PSBIEN_",",.06,"I"),1,12) D DD^%DT
"RTN","PSBMLLKU",117,0)
 .S $P(RESULTS(1),U,8)=Y
"RTN","PSBMLLKU",118,0)
 .S $P(RESULTS(1),U,9)=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I")
"RTN","PSBMLLKU",119,0)
 .S $P(RESULTS(1),U,10)=$$GET1^DIQ(53.79,PSBIEN_",",.16)
"RTN","PSBMLLKU",120,0)
 .S $P(RESULTS(1),U,16)=0
"RTN","PSBMLLKU",121,0)
 .S $P(RESULTS(2),U)=$$GET1^DIQ(53.79,PSBIEN_",",.21),$P(RESULTS(2),U,2)=$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBMLLKU",122,0)
 .; Determine if there are any active IVs/Patchs per order
"RTN","PSBMLLKU",123,0)
 .D:$G(PSBPTCHX)
"RTN","PSBMLLKU",124,0)
 ..S PSBX="",PSBX="^PSB(53.79,""APATCH"","_$P(RESULTS(1),U,2)_")"
"RTN","PSBMLLKU",125,0)
 ..F  S PSBX=$Q(@PSBX) Q:PSBX=""  Q:$QS(PSBX,3)'=$P(RESULTS(1),U,2)  D  Q:$P(RESULTS(1),U,16)
"RTN","PSBMLLKU",126,0)
 ...S PSBXX=$QS(PSBX,5),PSBXXX=$S(($P(^PSB(53.79,PSBXX,0),U,9)="G")&(PSBXX'=PSBIEN):1,1:0)
"RTN","PSBMLLKU",127,0)
 ...I PSBXXX&($P(^PSB(53.79,PSBXX,.1),U)=$P(RESULTS(1),U,15)) S $P(RESULTS(1),U,16)=1
"RTN","PSBMLLKU",128,0)
 .D:$G(PSBXIV)
"RTN","PSBMLLKU",129,0)
 ..S PSBX="",PSBX="^PSB(53.79,""AUID"","_$P(RESULTS(1),U,2)_")"
"RTN","PSBMLLKU",130,0)
 ..F  S PSBX=$Q(@PSBX) Q:PSBX=""  Q:$QS(PSBX,3)'=$P(RESULTS(1),U,2)  Q:$QS(PSBX,4)>$P(RESULTS(1),U,15)  D  Q:$P(RESULTS(1),U,16)
"RTN","PSBMLLKU",131,0)
 ...Q:$QS(PSBX,4)'=$P(RESULTS(1),U,15)
"RTN","PSBMLLKU",132,0)
 ...S PSBXX=$QS(PSBX,6) S:(PSBXX'=PSBIEN) $P(RESULTS(1),U,16)=$S($P(^PSB(53.79,PSBXX,0),U,9)="I":1,$P(^PSB(53.79,PSBXX,0),U,9)="S":1,1:0)
"RTN","PSBMLLKU",133,0)
 .;
"RTN","PSBMLLKU",134,0)
 .; LOOP - Place DD in RESULTS
"RTN","PSBMLLKU",135,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.5,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",136,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",137,0)
 ..S RESULTS(PSBCNT)="DD^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U)_"^"_$$GET1^DIQ(50,$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",138,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,4)
"RTN","PSBMLLKU",139,0)
 ..S:$P(RESULTS(PSBCNT),U,4)?1"."1.N $P(RESULTS(PSBCNT),U,4)=0_+$P(RESULTS(PSBCNT),U,4)
"RTN","PSBMLLKU",140,0)
 ..S:$P(RESULTS(PSBCNT),U,5)?1"."1.N $P(RESULTS(PSBCNT),U,5)=0_+$P(RESULTS(PSBCNT),U,5)
"RTN","PSBMLLKU",141,0)
 .; LOOP - Place ADD in RESULTS
"RTN","PSBMLLKU",142,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.6,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",143,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",144,0)
 ..S RESULTS(PSBCNT)="ADD^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U)_"^"_$$GET1^DIQ(52.6,$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",145,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,4)
"RTN","PSBMLLKU",146,0)
 .; LOOP - Place SOL in RESULTS
"RTN","PSBMLLKU",147,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.7,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",148,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",149,0)
 ..S RESULTS(PSBCNT)="SOL^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U)_"^"_$$GET1^DIQ(52.7,$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",150,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,4)
"RTN","PSBMLLKU",151,0)
 .L -^PSB(53.79,PSBIEN)
"RTN","PSBMLLKU",152,0)
 S:PSBCNT>0 RESULTS(0)=PSBCNT
"RTN","PSBMLLKU",153,0)
 Q
"RTN","PSBMLLKU",154,0)
 ;
"RTN","PSBMLLKU",155,0)
SELSTTUS(RESULTS) ;
"RTN","PSBMLLKU",156,0)
 ; Provide the SELectable STaTUS
"RTN","PSBMLLKU",157,0)
 ;
"RTN","PSBMLLKU",158,0)
 ; Get TAB, ScheduleType, Current Status, provide Selectable Staus(s) in ^8
"RTN","PSBMLLKU",159,0)
 N PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBMROUT,PSBXTAB
"RTN","PSBMLLKU",160,0)
 K ^TMP("PSJ1",$J) D EN^PSJBCMA1($$GET1^DIQ(53.79,PSBIEN_",",.01,"I"),$$GET1^DIQ(53.79,PSBIEN_",",.11),1)
"RTN","PSBMLLKU",161,0)
 I ^TMP("PSJ1",$J,0)>0 D
"RTN","PSBMLLKU",162,0)
 .S PSBORTYP=$TR($P(^TMP("PSJ1",$J,0),U,3),"1234567890"),PSBIVTYP=$P(^TMP("PSJ1",$J,0),U,6)
"RTN","PSBMLLKU",163,0)
 .S PSBINTSY=$P(^TMP("PSJ1",$J,0),U,7),PSBCHMTY=$P(^TMP("PSJ1",$J,0),U,8),PSBMROUT=$P(^TMP("PSJ1",$J,1),U,4)
"RTN","PSBMLLKU",164,0)
 .S:$$IVPTAB^PSBVDLU3(PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBMROUT) PSBXTAB="PB"
"RTN","PSBMLLKU",165,0)
 .D:'$D(PSBXTAB)
"RTN","PSBMLLKU",166,0)
 ..I PSBORTYP="U" S PSBXTAB="UD"
"RTN","PSBMLLKU",167,0)
 ..I PSBORTYP="V" S PSBXTAB="IV"
"RTN","PSBMLLKU",168,0)
 ; Set Results(1) and other flags...
"RTN","PSBMLLKU",169,0)
 I ^TMP("PSJ1",$J,0)>0 D
"RTN","PSBMLLKU",170,0)
 .S $P(RESULTS(1),U,13)=$P(^TMP("PSJ1",$J,4),U)
"RTN","PSBMLLKU",171,0)
 .S $P(RESULTS(1),U,14)=$P(^TMP("PSJ1",$J,1),U,10)
"RTN","PSBMLLKU",172,0)
 .S $P(RESULTS(1),U,15)=$P(^TMP("PSJ1",$J,0),U,3)
"RTN","PSBMLLKU",173,0)
 .I (PSBXTAB="UD"),($P(^TMP("PSJ1",$J,2),U,6)="PATCH") S PSBPTCHX=1
"RTN","PSBMLLKU",174,0)
 .I PSBXTAB="IV" S PSBXIV=1
"RTN","PSBMLLKU",175,0)
 .S:$G(PSBXTAB)]"" $P(RESULTS(1),U,11)=$G(PSBXTAB)
"RTN","PSBMLLKU",176,0)
 K ^TMP("PSJ1",$J)
"RTN","PSBMLLKU",177,0)
 Q
"RTN","PSBMLLKU",178,0)
 ;
"RTN","PSBMLLKU",179,0)
KILLAADT ;
"RTN","PSBMLLKU",180,0)
 ;   Here because there is an errorant index entry via version 1.0/2.0
"RTN","PSBMLLKU",181,0)
 ;   Cleansing!
"RTN","PSBMLLKU",182,0)
 ;
"RTN","PSBMLLKU",183,0)
 K ^PSB(53.79,"AADT",DFN,PSBSRCH,PSBIEN)
"RTN","PSBMLLKU",184,0)
 Q
"RTN","PSBMLLKU",185,0)
 ;
"RTN","PSBMLU")
0^4^B5930177
"RTN","PSBMLU",1,0)
PSBMLU ;BIRMINGHAM/EFC-BCMA MEDICATION LOG FUNCTIONS ;Mar 2004
"RTN","PSBMLU",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,11**;Mar 2004
"RTN","PSBMLU",3,0)
 ;;
"RTN","PSBMLU",4,0)
 ; Reference/IA
"RTN","PSBMLU",5,0)
 ; ^XMD/10070
"RTN","PSBMLU",6,0)
EN ;
"RTN","PSBMLU",7,0)
 Q
"RTN","PSBMLU",8,0)
 ;
"RTN","PSBMLU",9,0)
AUDIT(IEN,TXT,PSBTRN) ; Append and Audit
"RTN","PSBMLU",10,0)
 D NOW^%DTC
"RTN","PSBMLU",11,0)
 S RDAT=%
"RTN","PSBMLU",12,0)
 D:PSBTRN="ADD COMMENT"
"RTN","PSBMLU",13,0)
 . N XA
"RTN","PSBMLU",14,0)
 . S XA=$O(^PSB(53.79,IEN,.3,"A"),-1)
"RTN","PSBMLU",15,0)
 . S RDAT=$P(^PSB(53.79,IEN,.3,XA,0),U,3)
"RTN","PSBMLU",16,0)
 D:PSBTRN="PRN EFFECTIVENESS" 
"RTN","PSBMLU",17,0)
 . S RDAT=$P(^PSB(53.79,IEN,.2),U,4)
"RTN","PSBMLU",18,0)
 D:PSBTRN="UPDATE STATUS"
"RTN","PSBMLU",19,0)
 . S RDAT=$P(^PSB(53.79,IEN,0),U,6)
"RTN","PSBMLU",20,0)
 D:PSBTRN="MEDPASS"
"RTN","PSBMLU",21,0)
 . S RDAT=$P(^PSB(53.79,IEN,0),U,6)
"RTN","PSBMLU",22,0)
 S:'$D(^PSB(53.79,IEN,.9,0)) ^(0)="^53.799D^^"
"RTN","PSBMLU",23,0)
 S PSBAD1=""
"RTN","PSBMLU",24,0)
 S PSBAD1=$O(^PSB(53.79,IEN,.9,"A"),-1)+1
"RTN","PSBMLU",25,0)
 S ^PSB(53.79,IEN,.9,PSBAD1,0)=RDAT_U_DUZ_U_TXT
"RTN","PSBMLU",26,0)
 Q
"RTN","PSBMLU",27,0)
 ;
"RTN","PSBMLU",28,0)
ERROR(PSB1,PSB2,DFN,PSB3,PSB4,PSB5,PSB6,PSB7) ;
"RTN","PSBMLU",29,0)
 ; PSB1 = order #
"RTN","PSBMLU",30,0)
 ; PSB2 = orderable item
"RTN","PSBMLU",31,0)
 ; PSB3 = message to be sent
"RTN","PSBMLU",32,0)
 ; PSB4 = schedule
"RTN","PSBMLU",33,0)
 ; PSB5 = action date/time
"RTN","PSBMLU",34,0)
 ; PSB6 = med log ien #
"RTN","PSBMLU",35,0)
 ; PSB7 = user identification
"RTN","PSBMLU",36,0)
 ; Send Error Msg about problems
"RTN","PSBMLU",37,0)
 S PSBMG=$$GET^XPAR("DIV","PSB MG DUE LIST ERROR",,"E")
"RTN","PSBMLU",38,0)
 Q:PSBMG=""
"RTN","PSBMLU",39,0)
 S PSBMSG(1)="  The following "_$S($G(PSBADMER):"administration",1:"order")_" was NOT displayed"
"RTN","PSBMLU",40,0)
 S PSBMSG(2)="  on the Virtual Due List"
"RTN","PSBMLU",41,0)
 S PSBMSG(3)=" "
"RTN","PSBMLU",42,0)
 S PSBMSG(4)="  Order Number....: "_PSB1
"RTN","PSBMLU",43,0)
 S PSBMSG(5)="  Orderable Item..: "_PSB2
"RTN","PSBMLU",44,0)
 S PSBMSG(6)="  Patient.........: "_$$GET1^DIQ(2,DFN_",",.01)_" ("_$$GET1^DIQ(2,DFN_",",.09)_")"
"RTN","PSBMLU",45,0)
 S PSBMSG(7)="  Ward/Bed........: "_$$GET1^DIQ(2,DFN_",",.1)_"/"_$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBMLU",46,0)
 S PSBMSG(8)="  Reason..........: "_PSB3
"RTN","PSBMLU",47,0)
 S PSBMSG(9)="  Schedule........: "_PSB4
"RTN","PSBMLU",48,0)
 I $D(PSB5) S PSBMSG(10)="  Action Dt/Tm....: "_PSB5
"RTN","PSBMLU",49,0)
 I $D(PSB6) S PSBMSG(11)="  BCMA Med Log IEN: "_PSB6
"RTN","PSBMLU",50,0)
 I $D(PSB7) S PSBMSG(12)="  User............: "_PSB7
"RTN","PSBMLU",51,0)
 S XMY("G."_PSBMG)="",XMTEXT="PSBMSG(",XMSUB="BCMA - "_$S($G(PSBADMER):"Admin "_$G(PSB6),1:"Order")_" Problem"
"RTN","PSBMLU",52,0)
 K PSBADMER
"RTN","PSBMLU",53,0)
 D ^XMD
"RTN","PSBMLU",54,0)
 K PSB1,PSB2,PSB3,PSB4,PSBMSG,PSBMG,XMY,XMSUB,XMTEXT
"RTN","PSBMLU",55,0)
 Q
"RTN","PSBMLU",56,0)
 ;
"RTN","PSBOMH1")
0^5^B78413665
"RTN","PSBOMH1",1,0)
PSBOMH1 ;BIRMINGHAM/EFC-MAH ;Mar 2004
"RTN","PSBOMH1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,9,11**;Mar 2004
"RTN","PSBOMH1",3,0)
 ;
"RTN","PSBOMH1",4,0)
 ; Reference/IA
"RTN","PSBOMH1",5,0)
 ; ^DILF/2054
"RTN","PSBOMH1",6,0)
 ; File 200/10060
"RTN","PSBOMH1",7,0)
 ;
"RTN","PSBOMH1",8,0)
EN ;
"RTN","PSBOMH1",9,0)
 ; Load administrations
"RTN","PSBOMH1",10,0)
 S (PSBORD,PSBIEN,PSBR1,PSBADIEN,PSBABR)="",PSBDT=PSBSTRT
"RTN","PSBOMH1",11,0)
 K PSBTSA
"RTN","PSBOMH1",12,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOMH1",13,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  Q:'$D(^PSB(53.79,PSBIEN))  L +^PSB(53.79,PSBIEN):3 I $P(^PSB(53.79,PSBIEN,0),U,9)]"" D  L -^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",14,0)
 ..Q:'$P($G(^PSB(53.79,PSBIEN,0)),U,6)  ; Bad IEN -no evnt dt
"RTN","PSBOMH1",15,0)
 ..Q:$P(^PSB(53.79,PSBIEN,0),U,9)="N"  ;NGiven
"RTN","PSBOMH1",16,0)
 ..S PSBORD=$P($G(^PSB(53.79,PSBIEN,.1)),U,1)
"RTN","PSBOMH1",17,0)
 ..; Continuous
"RTN","PSBOMH1",18,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="C"
"RTN","PSBOMH1",19,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=PSBAR(%H) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,PSBIEN,0),U,1),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",20,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,6)'=PSBDT,'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBMR) D  D CLEAN^PSBVT Q  ;chck IV audit
"RTN","PSBOMH1",21,0)
 ....S PSBSIEN=PSBIEN
"RTN","PSBOMH1",22,0)
 ....I $P(^PSB(53.79,PSBIEN,0),"^",10)]"" D BAGDTL^PSBRPC2(.PSBAUD,$P(^PSB(53.79,PSBIEN,0),U,10),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",23,0)
 ....S PSBIEN=PSBSIEN K PSBSIEN
"RTN","PSBOMH1",24,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  I $P(PSBAUD(X),U,3)="" K PSBAUD(X)
"RTN","PSBOMH1",25,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  Q:$P(PSBAUD(X),U,1)=PSBDT
"RTN","PSBOMH1",26,0)
 ....I X="" K PSBAUD Q
"RTN","PSBOMH1",27,0)
 ....I '$D(PSBAUD(X)) K PSBAUD Q
"RTN","PSBOMH1",28,0)
 ....S PSBS=$P(PSBAUD(X),U,3)
"RTN","PSBOMH1",29,0)
 ....I PSBS="GIVEN",$P($G(PSBAUD(X-1)),U,3)="NOT GIVEN" Q
"RTN","PSBOMH1",30,0)
 ....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",31,0)
 ....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NOACTION")
"RTN","PSBOMH1",32,0)
 ....D PSBSTIV
"RTN","PSBOMH1",33,0)
 ....S X=PSBDT_U_$P(PSBAUD(X),U,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",34,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",35,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X
"RTN","PSBOMH1",36,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",37,0)
 ....D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",38,0)
 ....K PSBAUD
"RTN","PSBOMH1",39,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",40,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",41,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",42,0)
 ...;get instrc info - audt log
"RTN","PSBOMH1",43,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",44,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",45,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",46,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",47,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("A")
"RTN","PSBOMH1",48,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)'="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("B")
"RTN","PSBOMH1",49,0)
 ...I PSBDT'=$P(^PSB(53.79,PSBIEN,0),U,6),$P(^PSB(53.79,PSBIEN,0),U,9)="RM" D
"RTN","PSBOMH1",50,0)
 ....D DDAUD
"RTN","PSBOMH1",51,0)
 ....S I="" F  S I=$O(PSBTAR(I),-1) Q:I=""  I $P(PSBTAR(I),U,1)=PSBDT D
"RTN","PSBOMH1",52,0)
 .....S PSBS=$P(PSBTAR(I),U,3)
"RTN","PSBOMH1",53,0)
 .....I PSBS="GIVEN",$P($G(PSBTAR(I-1)),U,3)="NOT GIVEN" Q  ; canceled - not given
"RTN","PSBOMH1",54,0)
 .....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",55,0)
 .....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NO ACTION")
"RTN","PSBOMH1",56,0)
 .....D PSBCTAR
"RTN","PSBOMH1",57,0)
 .....S X=$P(PSBTAR(I),U,1,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",58,0)
 ...Q:$P(X,U,2)=""
"RTN","PSBOMH1",59,0)
 ...S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",60,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X
"RTN","PSBOMH1",61,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",62,0)
 ...D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",63,0)
 ...Q
"RTN","PSBOMH1",64,0)
 ..; 1-Time On Call or PRN
"RTN","PSBOMH1",65,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="C"
"RTN","PSBOMH1",66,0)
 ...I PSBDT'=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I") Q
"RTN","PSBOMH1",67,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",68,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",69,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",70,0)
 ...S (PSBXA,PSBM)=1,(PSBZ,PSBT,PSBFLG)=""
"RTN","PSBOMH1",71,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.09)="REMOVED"  D
"RTN","PSBOMH1",72,0)
 ....F I=1:1 S PSBXA=$O(^PSB(53.79,PSBIEN,.9,PSBXA)) Q:PSBXA=""  I PSBXA?1.3N  S PSBZ=PSBZ+1,PSBT(PSBZ)=^PSB(53.79,PSBIEN,.9,PSBXA,0)
"RTN","PSBOMH1",73,0)
 ....F S=1:1 Q:PSBM<1  S PSBM=PSBZ-S  I (PSBM>0) I (PSBT(PSBM)["GIVEN")  S PSBFLG="1" S PRELINE1=$P(PSBT(PSBM),"'",2)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.04)_" "_$E($P(PSBT(PSBM),"'",4),1,3) Q
"RTN","PSBOMH1",74,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",75,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",76,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",77,0)
 ...I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D PSBOUT(PSBDT,PSBINIT)
"RTN","PSBOMH1",78,0)
 ...S PSBLINE1=$$GET1^DIQ(53.79,PSBIEN_",",.09)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.06)_" "_PSBINIT_"            "_$$GET1^DIQ(53.79,PSBIEN_",",.21),PSBLINE2=""
"RTN","PSBOMH1",79,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",80,0)
 ...D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOMH1",81,0)
 ....I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" S PSBLINE2="  Results: <No PRN Results On File>"
"RTN","PSBOMH1",82,0)
 ....E  D
"RTN","PSBOMH1",83,0)
 .....S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBOMH1",84,0)
 .....S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:NAME")
"RTN","PSBOMH1",85,0)
 .....I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",86,0)
 .....I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",87,0)
 ......S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",88,0)
 ......S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",89,0)
 .....I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D
"RTN","PSBOMH1",90,0)
 ......D:$D(^PSB(53.79,PSBIEN,.9,0))
"RTN","PSBOMH1",91,0)
 .......S (PSBXA2,PSBFG)=0,PSBEFFDT=$P(^PSB(53.79,PSBIEN,.2),U,4) F  S PSBXA2=$O(^PSB(53.79,PSBIEN,.9,PSBXA2)) Q:+PSBXA2'>0  D  Q:PSBFG=1
"RTN","PSBOMH1",92,0)
 ........D:($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U)=PSBEFFDT)&($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)["Instruct")&($P(^PSB(53.79,PSBIEN,.2),U,3)=$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,2))
"RTN","PSBOMH1",93,0)
 .........S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",94,0)
 .........S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)="",PSBFG=1
"RTN","PSBOMH1",95,0)
 .....S PSBLINE2="  Results: "_$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBOMH1",96,0)
 .....S PSBRTXTW="     Entered By "_PSBINIT_" on "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",97,0)
 .....I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",98,0)
 ...S X=PSBDT D H^%DTC F PSBWEEK=PSBAR(%H):-7 Q:$D(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",0))!('$D(PSBAR(PSBWEEK)))
"RTN","PSBOMH1",99,0)
 ...S X=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",""),-1)+1
"RTN","PSBOMH1",100,0)
 ...I PSBFLG="1" S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X)=PRELINE1
"RTN","PSBOMH1",101,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+1)=PSBLINE1
"RTN","PSBOMH1",102,0)
 ...I $G(PSBLINE2)]"" D
"RTN","PSBOMH1",103,0)
 ....I $L(PSBLINE2)<90 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=PSBLINE2 S:$$GET1^DIQ(53.79,PSBIEN_",",.24)'="" ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="      "_PSBRTXTW
"RTN","PSBOMH1",104,0)
 ....I $L(PSBLINE2)>90 D
"RTN","PSBOMH1",105,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=$E(PSBLINE2,1,90)
"RTN","PSBOMH1",106,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="           "_$E(PSBLINE2,91,161)
"RTN","PSBOMH1",107,0)
 .....I $L(PSBLINE2)'>161 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="      "_PSBRTXTW
"RTN","PSBOMH1",108,0)
 .....I $L(PSBLINE2)>161 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="     "_$E(PSBLINE2,162,200),^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+5)="     "_PSBRTXTW
"RTN","PSBOMH1",109,0)
 Q
"RTN","PSBOMH1",110,0)
 ;
"RTN","PSBOMH1",111,0)
DDAUD ;  audits for dispen drugs
"RTN","PSBOMH1",112,0)
 ;
"RTN","PSBOMH1",113,0)
 M PSBMLA=^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",114,0)
 S PSBGA="" I $D(PSBMLA(.9,0)) D
"RTN","PSBOMH1",115,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D  Q
"RTN","PSBOMH1",116,0)
 ..I $D(PSBMLA(.9,PSBX-2,0)) D DT^DILF("ENPST",$P(PSBMLA(.9,PSBX-2,0),"'",2),.PSBDATE)
"RTN","PSBOMH1",117,0)
 ..I '$D(PSBMLA(.9,PSBX-2,0)) S PSBDATE=$P(^PSB(53.79,PSBIEN,0),U,6)
"RTN","PSBOMH1",118,0)
 ..S PSBTMP(10000000-PSBDATE,"B")=PSBDATE_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,5))_U_$P(PSBMLA(.9,PSBX,0),"'",2)
"RTN","PSBOMH1",119,0)
 ..S PSBGA=1
"RTN","PSBOMH1",120,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D
"RTN","PSBOMH1",121,0)
 ..S PSBTMP(10000000-$P(PSBMLA(.9,PSBX,0),U,1),"B")=$P(PSBMLA(.9,PSBX,0),U,1)_U_$$INITIAL^PSBRPC2($P(PSBMLA(.9,PSBX,0),U,2))_U_$P($P(PSBMLA(.9,PSBX,0),U,3),"'",2)
"RTN","PSBOMH1",122,0)
 ..S PSBGA=1
"RTN","PSBOMH1",123,0)
 I PSBGA'=1 S PSBTMP(10000000-$P(PSBMLA(0),U,6),"A")=$P(PSBMLA(0),U,6)_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,7))
"RTN","PSBOMH1",124,0)
 S PSBQRY="PSBTMP",PSBCNT=1 F  S PSBQRY=$Q(@PSBQRY) Q:PSBQRY=""  D  ; does comment go with action
"RTN","PSBOMH1",125,0)
 .S PSBPQRY=$Q(@PSBQRY,-1)
"RTN","PSBOMH1",126,0)
 .I PSBPQRY="" S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; no prev action
"RTN","PSBOMH1",127,0)
 .I $QS(PSBPQRY,2)="C"  S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; prev line = comment
"RTN","PSBOMH1",128,0)
 .I $QS(PSBQRY,2)="C",$E($P(@$Q(@PSBQRY,-1),U,1),1,12)=$E($P(@PSBQRY,U,1),1,12),$P(@$Q(@PSBQRY,-1),U,2)=$P(@PSBQRY,U,2) D  Q
"RTN","PSBOMH1",129,0)
 ..S X=$P(@PSBQRY,U,4) S:X[":" X=$P(X,":",2) S $P(PSBTAR(PSBCNT-1),U,4)=X Q
"RTN","PSBOMH1",130,0)
 .S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1
"RTN","PSBOMH1",131,0)
 Q
"RTN","PSBOMH1",132,0)
 ;
"RTN","PSBOMH1",133,0)
PSBSTIV ;
"RTN","PSBOMH1",134,0)
 S YB="" F  S YB=$O(PSBAUD(YB)) Q:YB=""  D
"RTN","PSBOMH1",135,0)
 .S Z="" F  S Z=$O(^PSB(53.79,PSBIEN,.9,Z)) Q:Z=""  I Z'=0  D
"RTN","PSBOMH1",136,0)
 ..I $P(PSBAUD(YB),U,1)=$P(^PSB(53.79,PSBIEN,.9,Z,0),"^",1)  D
"RTN","PSBOMH1",137,0)
 ...I $P(^PSB(53.79,PSBIEN,.9,Z,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",138,0)
 ....I $P(PSBAUD(YB),U,2)'["*"  S $P(PSBAUD(YB),U,2)=$P(PSBAUD(YB),U,2)_"*"
"RTN","PSBOMH1",139,0)
 ....D PSBOUT($P(PSBAUD(YB),U,1),$P(PSBAUD(YB),U,2))
"RTN","PSBOMH1",140,0)
 Q
"RTN","PSBOMH1",141,0)
 ;
"RTN","PSBOMH1",142,0)
PSBCTAR   ;
"RTN","PSBOMH1",143,0)
 S YC="" F  S YC=$O(PSBTAR(YC)) Q:YC=""  D
"RTN","PSBOMH1",144,0)
 .S Z="" F  S Z=$O(^PSB(53.79,PSBIEN,.9,Z)) Q:Z=""  I Z'=0  D
"RTN","PSBOMH1",145,0)
 ..I $P(PSBTAR(YC),U,1)=$P(^PSB(53.79,PSBIEN,.9,Z,0),"^",1)  D
"RTN","PSBOMH1",146,0)
 ...I $P(^PSB(53.79,PSBIEN,.9,Z,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",147,0)
 ....S $P(PSBTAR(YC),U,2)=$P(PSBTAR(YC),U,2)_"*"
"RTN","PSBOMH1",148,0)
 ....D PSBOUT($P(^PSB(53.79,PSBIEN,.9,Z,0),"^",1),$P(PSBTAR(YC),U,2))
"RTN","PSBOMH1",149,0)
 Q
"RTN","PSBOMH1",150,0)
 ;
"RTN","PSBOMH1",151,0)
PSBOUT(PSBTET,PSBOT1) ;
"RTN","PSBOMH1",152,0)
 I '$D(^PSB(53.79,PSBIEN,.9,0))  D PSBENT^PSBOMH2(PSBOT1)
"RTN","PSBOMH1",153,0)
 S PSBIDA="" I $P(^PSB(53.79,PSBIEN,0),U,6)=PSBTET S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,7),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",154,0)
 S PSBXA1=0
"RTN","PSBOMH1",155,0)
 F  S PSBXA1=$O(^PSB(53.79,PSBIEN,.9,PSBXA1)) Q:+PSBXA1'>0  I PSBXA1'=0  D  Q:$G(PSBOT1)["*"
"RTN","PSBOMH1",156,0)
 .I $L(PSBXA1)<4  D
"RTN","PSBOMH1",157,0)
 ..I $P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1)=PSBTET  D
"RTN","PSBOMH1",158,0)
 ...S:$G(PSBIDA)="" PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",159,0)
 ...I (PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2)),$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",160,0)
 ....S INSDD=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1),Y=INSDD D DD^%DT S INSDD=Y
"RTN","PSBOMH1",161,0)
 ....S PSBOT1=PSBOT1_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),U,3)_" "_INSDD
"RTN","PSBOMH1",162,0)
 I $G(PSBIDA)="",$P(^PSB(53.79,PSBIEN,0),U,4)=PSBTET D
"RTN","PSBOMH1",163,0)
 .S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",164,0)
 S:$G(PSBOT1)]"" ^TMP("PSB",$J,"LEGEND",PSBOT1,PSBNAME)="",PSBINIT=PSBOT1,PSBTET=""
"RTN","PSBOMH1",165,0)
 Q
"RTN","PSBOMH1",166,0)
 ;
"RTN","PSBOML")
0^6^B31797933
"RTN","PSBOML",1,0)
PSBOML ;BIRMINGHAM/EFC-MEDICATION LOG ;Mar 2004
"RTN","PSBOML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,11**;Mar 2004
"RTN","PSBOML",3,0)
 ;
"RTN","PSBOML",4,0)
 ; Reference/IA
"RTN","PSBOML",5,0)
 ; ^DPT/10035
"RTN","PSBOML",6,0)
 ;
"RTN","PSBOML",7,0)
 ;
"RTN","PSBOML",8,0)
EN ; Begin printing
"RTN","PSBOML",9,0)
 N PSBSTRT,PSBSTOP,PSBHDR,DFN
"RTN","PSBOML",10,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOML",11,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOML",12,0)
 S PSBAUDF=$P(PSBRPT(.2),U,9)
"RTN","PSBOML",13,0)
 S PSBHDR(0)="Medication Log Report"
"RTN","PSBOML",14,0)
 S PSBHDR(1)="Continuing/PRN/Stat/One Time Medication/Treatment Record (Detailed Log) (VAF 10-2970 B, C, D)"
"RTN","PSBOML",15,0)
 ;
"RTN","PSBOML",16,0)
 ; Patient Report
"RTN","PSBOML",17,0)
 ;
"RTN","PSBOML",18,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOML",19,0)
 .S PSBHDR(2)="Log Type: INDIVIDUAL PATIENT"
"RTN","PSBOML",20,0)
 .S DFN=+$P(PSBRPT(.1),U,2)
"RTN","PSBOML",21,0)
 .W $$PTHDR()
"RTN","PSBOML",22,0)
 .S X=$O(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",23,0)
 .I X>PSBSTOP!(X="") W !!?10,"<<<< NO MEDICATIONS FOUND FOR THIS TIME FRAME >>>>",!! Q
"RTN","PSBOML",24,0)
 .S PSBGBL=$NAME(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",25,0)
 .F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'="AADT"!($QS(PSBGBL,3)'=DFN)!($QS(PSBGBL,4)>PSBSTOP)  D
"RTN","PSBOML",26,0)
 ..S PSBIEN=$QS(PSBGBL,5) Q:'$D(^PSB(53.79,PSBIEN))
"RTN","PSBOML",27,0)
 ..I $P(^PSB(53.79,PSBIEN,0),U,6)'=$QS(PSBGBL,4) Q
"RTN","PSBOML",28,0)
 ..I $Y>(IOSL-10) W $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOML",29,0)
 ..W $$LINE(PSBIEN)
"RTN","PSBOML",30,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOML",31,0)
 ;
"RTN","PSBOML",32,0)
 ; Ward Output
"RTN","PSBOML",33,0)
 ;
"RTN","PSBOML",34,0)
 D:$P(PSBRPT(.1),U,1)="W"
"RTN","PSBOML",35,0)
 .S PSBHDR(2)="LOG TYPE: WARD"
"RTN","PSBOML",36,0)
 .W $$WDHDR(PSBWRD)
"RTN","PSBOML",37,0)
 .S PSBTMPG=$NAME(^TMP("PSBO",$J,"B"))
"RTN","PSBOML",38,0)
 .F  S PSBTMPG=$Q(@PSBTMPG) Q:PSBTMPG=""  Q:$QS(PSBTMPG,1)'="PSBO"!($QS(PSBTMPG,2)'=$J)  D
"RTN","PSBOML",39,0)
 ..S DFN=$QS(PSBTMPG,5)
"RTN","PSBOML",40,0)
 ..I $Y>(IOSL-14) W $$WDHDR(PSBWRD)
"RTN","PSBOML",41,0)
 ..W !,$P(^DPT(DFN,0),U),"  (",$P(^(0),U,9),")"
"RTN","PSBOML",42,0)
 ..W !,"Ward: ",$G(^DPT(DFN,.1),"***"),"  Rm-Bed: ",$G(^DPT(DFN,.101),"***"),!
"RTN","PSBOML",43,0)
 ..S X=$O(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",44,0)
 ..I X>PSBSTOP!(X="") W !!?10,"<<<< NO MEDICATIONS FOUND FOR THIS TIME FRAME >>>>",!! Q
"RTN","PSBOML",45,0)
 ..S PSBGBL=$NAME(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",46,0)
 ..F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'="AADT"!($QS(PSBGBL,3)'=DFN)!($QS(PSBGBL,4)>PSBSTOP)  D
"RTN","PSBOML",47,0)
 ...S PSBIEN=$QS(PSBGBL,5) I $P(^PSB(53.79,PSBIEN,0),U,6)'=$QS(PSBGBL,4) Q
"RTN","PSBOML",48,0)
 ...W:$Y>(IOSL-10) $$WDHDR(PSBWRD)
"RTN","PSBOML",49,0)
 ...W $$LINE(PSBIEN)
"RTN","PSBOML",50,0)
 Q
"RTN","PSBOML",51,0)
 ;
"RTN","PSBOML",52,0)
LINE(PSBIEN) ; Displays the med log entry in PSBIEN
"RTN","PSBOML",53,0)
 N PSBX,PSBASTUS
"RTN","PSBOML",54,0)
 S X=$P($G(^PSB(53.79,PSBIEN,.1)),U)
"RTN","PSBOML",55,0)
 I X="" W !,"Error: Med Log Entry ",PSBIEN," has no order reference number!" Q ""
"RTN","PSBOML",56,0)
 I 'PSBAUDF,$P(^PSB(53.79,PSBIEN,0),U,9)="N" Q ""
"RTN","PSBOML",57,0)
 D CLEAN^PSBVT
"RTN","PSBOML",58,0)
 D PSJ1^PSBVT(DFN,X)
"RTN","PSBOML",59,0)
 I PSBDFN="-1" W !,"Error: Inpatient Meds API Failure!" Q ""
"RTN","PSBOML",60,0)
 M PSBX=^PSB(53.79,PSBIEN)
"RTN","PSBOML",61,0)
 S Y=$P(PSBX(0),U,4)+.0000001
"RTN","PSBOML",62,0)
 W !,$E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",63,0)
 W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",64,0)
 S Y=$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBOML",65,0)
 S Y=Y_" ["_PSBDOSE_PSBIFR_" "_PSBSCH
"RTN","PSBOML",66,0)
 S Y=Y_" "_PSBMRAB
"RTN","PSBOML",67,0)
 S:$P($G(^PSB(53.79,PSBIEN,.1)),U,6)]"" Y=Y_" Inj Site: "_$P(^(.1),U,6)
"RTN","PSBOML",68,0)
 S Y=Y_"]"
"RTN","PSBOML",69,0)
 W $$WRAP^PSBO(16,32,Y)
"RTN","PSBOML",70,0)
 W ?50,$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOML",71,0)
 S X=$P(PSBX(0),U,9)
"RTN","PSBOML",72,0)
 S PSBASTUS=$S(X="G":"Given",X="H":"Held",X="R":"Refused",X="I":"Infusing",X="C":"Completed",X="S":"Stopped",X="N":"Not Given",X="RM":"Removed",X="M":"Missing dose",1:"Status Unknown")
"RTN","PSBOML",73,0)
 S Y=$P(PSBX(0),U,6)+.0000001
"RTN","PSBOML",74,0)
 S Y=$E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)_" "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSBOML",75,0)
 S Y=Y_" "_PSBASTUS
"RTN","PSBOML",76,0)
 W $$WRAP^PSBO(57,15,Y)
"RTN","PSBOML",77,0)
 W:$P(PSBX(.1),U)["V" ?75,"Bag ID #",$$GET1^DIQ(53.79,PSBIEN,"IV UNIQUE ID")
"RTN","PSBOML",78,0)
 W:$P(PSBX(.1),U)["V" ?107,"NA",?115,"NA",?120,"NA"
"RTN","PSBOML",79,0)
 W !,$TR($$FMTE^XLFDT(PSBOST,2),"@"," ")_">"
"RTN","PSBOML",80,0)
 F PSBZ=.5,.6,.7 S PSBDHIT=0 F PSBY=0:0 S PSBY=$O(PSBX(PSBZ,PSBY)) Q:'PSBY  D
"RTN","PSBOML",81,0)
 .W:$X>75 !
"RTN","PSBOML",82,0)
 .S PSBDD=$S(PSBZ=.5:53.795,PSBZ=.6:53.796,1:53.797)
"RTN","PSBOML",83,0)
 .S Y=$$EXTERNAL^DILFD(PSBDD,.01,"",$P(PSBX(PSBZ,PSBY,0),U,1))
"RTN","PSBOML",84,0)
 .W $$WRAP^PSBO(75,28,Y)
"RTN","PSBOML",85,0)
 .I $P(PSBX(.1),U)["U" W ?105,$J($P(PSBX(PSBZ,PSBY,0),U,2),6,2),?113,$J($P(PSBX(PSBZ,PSBY,0),U,3),6,2) W $$WRAP^PSBO(120,12,$P(PSBX(PSBZ,PSBY,0),U,4)) S PSBDHIT=1
"RTN","PSBOML",86,0)
 .W:$P(PSBX(.1),U)["V"&($X+3+$L($P(PSBX(PSBZ,PSBY,0),U,3))>105) !?75
"RTN","PSBOML",87,0)
 .W:$P(PSBX(.1),U)["V" " - ",$P(PSBX(PSBZ,PSBY,0),U,3)
"RTN","PSBOML",88,0)
 D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOML",89,0)
 .W !?16,"PRN Reason: ",?30,$$GET1^DIQ(53.79,PSBIEN_",",.21)
"RTN","PSBOML",90,0)
 .W !?16,"PRN Effectiveness: "
"RTN","PSBOML",91,0)
 .I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" W "<No PRN Effectiveness Entered>" Q
"RTN","PSBOML",92,0)
 .W $$WRAP^PSBO(20,100,$$GET1^DIQ(53.79,PSBIEN_",",.22))
"RTN","PSBOML",93,0)
 .W !?20,"Entered By: ",$$GET1^DIQ(53.79,PSBIEN_",",.23)
"RTN","PSBOML",94,0)
 .W " Date/Time: ",$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOML",95,0)
 .W " Minutes: ",$$GET1^DIQ(53.79,PSBIEN_",",.25)
"RTN","PSBOML",96,0)
 D:$P(PSBRPT(.2),U,8)
"RTN","PSBOML",97,0)
 .W !?16,"Comments: ",?30 I '$O(PSBX(.3,0)) W "<No Comments>"
"RTN","PSBOML",98,0)
 .F PSBY=0:0 S PSBY=$O(PSBX(.3,PSBY)) Q:'PSBY  D
"RTN","PSBOML",99,0)
 ..W:$X>30 !?30
"RTN","PSBOML",100,0)
 ..S Y=$P(PSBX(.3,PSBY,0),U,3)+.0000001
"RTN","PSBOML",101,0)
 ..W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",102,0)
 ..W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",103,0)
 ..W ?46,$$GET1^DIQ(53.793,PSBY_","_PSBIEN_",","ENTERED BY:INITIAL")
"RTN","PSBOML",104,0)
 ..W $$WRAP^PSBO(52,70,$P(PSBX(.3,PSBY,0),U,1))
"RTN","PSBOML",105,0)
 W !,$TR($$FMTE^XLFDT(PSBOSP,2),"@"," ")_"<"
"RTN","PSBOML",106,0)
 D:PSBAUDF
"RTN","PSBOML",107,0)
 .W !?16,"Audits: ",?30 I '$O(PSBX(.9,0)) W "<No Audits>" Q
"RTN","PSBOML",108,0)
 .F PSBY=0:0 S PSBY=$O(PSBX(.9,PSBY)) Q:'PSBY  D
"RTN","PSBOML",109,0)
 ..W:$X>30 !?30
"RTN","PSBOML",110,0)
 ..S Y=$P(PSBX(.9,PSBY,0),U,1)+.0000001
"RTN","PSBOML",111,0)
 ..W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",112,0)
 ..W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",113,0)
 ..W ?46,$$GET1^DIQ(53.799,PSBY_","_PSBIEN_",","USER:INITIAL")
"RTN","PSBOML",114,0)
 ..W $$WRAP^PSBO(52,70,$P(PSBX(.9,PSBY,0),U,3))
"RTN","PSBOML",115,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOML",116,0)
 Q ""
"RTN","PSBOML",117,0)
 ;
"RTN","PSBOML",118,0)
WDHDR(PSBWARD) ;
"RTN","PSBOML",119,0)
 D WARD^PSBOHDR(PSBWARD,.PSBHDR)
"RTN","PSBOML",120,0)
 W $$SUB()
"RTN","PSBOML",121,0)
 Q ""
"RTN","PSBOML",122,0)
 ;
"RTN","PSBOML",123,0)
PTHDR() ;
"RTN","PSBOML",124,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBOML",125,0)
 W $$SUB()
"RTN","PSBOML",126,0)
 Q ""
"RTN","PSBOML",127,0)
 ;
"RTN","PSBOML",128,0)
SUB() ; Med Log Sub Header
"RTN","PSBOML",129,0)
 W:$X>1 !
"RTN","PSBOML",130,0)
 W "Activity Date",?16,"Orderable Item",?50,"Action",?57,"Action"
"RTN","PSBOML",131,0)
 W !,"Start Date>",?16,"[Dose/Sched/Route/Inj Site]",?50,"By"
"RTN","PSBOML",132,0)
 W ?57,"Date/Time",?75,"Drug/Additive/Solution",?105," U/Ord"
"RTN","PSBOML",133,0)
 W ?113," U/Gvn",?120,"Unit",!,"Stop Date<"
"RTN","PSBOML",134,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOML",135,0)
 Q ""
"RTN","PSBOML",136,0)
 ;
"RTN","PSBVDLPB")
0^7^B82592790
"RTN","PSBVDLPB",1,0)
PSBVDLPB ;BIRMINGHAM/EFC-BCMA IV VIRTUAL DUE LIST ;Mar 2004
"RTN","PSBVDLPB",2,0)
 ;;3.0;BAR CODE MED ADMIN;**11**;Mar 2004
"RTN","PSBVDLPB",3,0)
 ;
"RTN","PSBVDLPB",4,0)
 ; Reference/IA
"RTN","PSBVDLPB",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLPB",6,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLPB",7,0)
 ; File 200/10060
"RTN","PSBVDLPB",8,0)
 ;
"RTN","PSBVDLPB",9,0)
EN(DFN,PSBDT) ; Default Order List Return for Today
"RTN","PSBVDLPB",10,0)
 ;
"RTN","PSBVDLPB",11,0)
 ; RPC: PSB GETORDERLIST
"RTN","PSBVDLPB",12,0)
 ;
"RTN","PSBVDLPB",13,0)
 ; Description:
"RTN","PSBVDLPB",14,0)
 ; Returns the current IV order set for today to display on the
"RTN","PSBVDLPB",15,0)
 ; client VDL
"RTN","PSBVDLPB",16,0)
 ;
"RTN","PSBVDLPB",17,0)
 ;
"RTN","PSBVDLPB",18,0)
 N PSBDATA,PSBTBOUT
"RTN","PSBVDLPB",19,0)
 S PSBTBOUT=0,PSBDOADD=0
"RTN","PSBVDLPB",20,0)
 S:PSBTAB="PBTAB" PSBDOADD=1
"RTN","PSBVDLPB",21,0)
 ;
"RTN","PSBVDLPB",22,0)
 ;This routine now re-uses the ^TMP("PSJ",$J global built in PSBVDLTB
"RTN","PSBVDLPB",23,0)
 ;
"RTN","PSBVDLPB",24,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 Q  ; No orders
"RTN","PSBVDLPB",25,0)
 ;
"RTN","PSBVDLPB",26,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBVDLPB",27,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX)
"RTN","PSBVDLPB",28,0)
 .;
"RTN","PSBVDLPB",29,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLPB",30,0)
 .;
"RTN","PSBVDLPB",31,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLPB",32,0)
 .Q:'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBMR)
"RTN","PSBVDLPB",33,0)
 .Q:PSBOST>PSBWADM  ; Order Start Date/Time > admin window
"RTN","PSBVDLPB",34,0)
 .Q:PSBOSP<PSBWBEG  ; For all Order Stop Date/Time < vdl window
"RTN","PSBVDLPB",35,0)
 .Q:PSBOSTS["D"  ;     Is it DC'd
"RTN","PSBVDLPB",36,0)
 .Q:PSBNGF  ;  Is it marked DO NOT GIVE!
"RTN","PSBVDLPB",37,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLPB",38,0)
 .;
"RTN","PSBVDLPB",39,0)
 .D NOW^%DTC
"RTN","PSBVDLPB",40,0)
 .Q:PSBOSP<%
"RTN","PSBVDLPB",41,0)
 .;
"RTN","PSBVDLPB",42,0)
 .; include Active, Renewed, ReInstated and On Call
"RTN","PSBVDLPB",43,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call)
"RTN","PSBVDLPB",44,0)
 .Q:PSBSCHT'="O"&((PSBOSTS'="A")&(PSBOSTS'="R")&(PSBOSTS'="RE")&(PSBOSTS'="O")&(PSBOSTS'="H"))
"RTN","PSBVDLPB",45,0)
 .;
"RTN","PSBVDLPB",46,0)
 .; Is One Time Given
"RTN","PSBVDLPB",47,0)
 .;
"RTN","PSBVDLPB",48,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLPB",49,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLPB",50,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLPB",51,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  S:($P(^PSB(53.79,Y,.1),U)=PSBONX)&($P(^PSB(53.79,Y,0),U,9)="G") PSBGVN=1,(X,Y)=0
"RTN","PSBVDLPB",52,0)
 .;
"RTN","PSBVDLPB",53,0)
 .; How long does One Time remain on VDL ?
"RTN","PSBVDLPB",54,0)
 .S PSBRMN=1
"RTN","PSBVDLPB",55,0)
 .I PSBSCHT="O",PSBOSP'=PSBOST,%>PSBOSP S PSBRMN=0
"RTN","PSBVDLPB",56,0)
 .Q:'PSBRMN
"RTN","PSBVDLPB",57,0)
 .;
"RTN","PSBVDLPB",58,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLPB",59,0)
 .;
"RTN","PSBVDLPB",60,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLPB",61,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLPB",62,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLPB",63,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  S:($P(^PSB(53.79,Y,.1),U)=PSBON)&($P(^PSB(53.79,Y,0),U,9)="G") PSBGVN=1,(X,Y)=0
"RTN","PSBVDLPB",64,0)
 .;
"RTN","PSBVDLPB",65,0)
 .S PSBSTRT=PSBOST ; Order Start Date/Time
"RTN","PSBVDLPB",66,0)
 .S PSBSTOP=PSBOSP ; Order Stop Date/Time
"RTN","PSBVDLPB",67,0)
 .;
"RTN","PSBVDLPB",68,0)
 .S PSBREC=""
"RTN","PSBVDLPB",69,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLPB",70,0)
 .S $P(PSBREC,U,2)=PSBONX ; Order
"RTN","PSBVDLPB",71,0)
 .S $P(PSBREC,U,3)=+PSBON ; order ien
"RTN","PSBVDLPB",72,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLPB",73,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLPB",74,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLPB",75,0)
 .S Y=""
"RTN","PSBVDLPB",76,0)
 .S:PSBSM Y="SM"
"RTN","PSBVDLPB",77,0)
 .S:PSBHSM Y="HSM"
"RTN","PSBVDLPB",78,0)
 .S $P(PSBREC,U,7)=Y ; self med
"RTN","PSBVDLPB",79,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLPB",80,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLPB",81,0)
 .S $P(PSBREC,U,10)=PSBMR ; route
"RTN","PSBVDLPB",82,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLPB",83,0)
 .S (YZ,PSBSTUS,PSBADMER)="" K PSBHSTA,PSBHSTAX
"RTN","PSBVDLPB",84,0)
 .F XZ=1:1:20 S YZ=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ),-1),(PSBCNT,PSBFLAG)=0 Q:YZ=""  D
"RTN","PSBVDLPB",85,0)
 ..S:YZ>0 $P(PSBREC,U,11)=YZ
"RTN","PSBVDLPB",86,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ,X),-1) Q:X=""  D
"RTN","PSBVDLPB",87,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLPB",88,0)
 ...I $G(PSBSTUS)="" S PSBADMER=1 L +^PSB(53.79,X):1  I  D  L -^PSB(53.79,X) Q
"RTN","PSBVDLPB",89,0)
 ....K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLPB",90,0)
 ....S PSBPARM6=X,Y=$P(^PSB(53.79,X,.1),U,3) D DD^%DT S PSBPARM3=Y,Y=$P(^PSB(53.79,X,0),U,6) D DD^%DT S PSBPARM5=Y
"RTN","PSBVDLPB",91,0)
 ....S PSBPARM7=$P(^PSB(53.79,X,0),U,7) S PSBPARM7="( # "_PSBPARM7_" ) "_$$GET1^DIQ(200,PSBPARM7_",",.01)
"RTN","PSBVDLPB",92,0)
 ....K PSBXTMP S PSBXTMP=PSBONX
"RTN","PSBVDLPB",93,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,$$GET1^DIQ(53.79,PSBPARM6_",",.11))
"RTN","PSBVDLPB",94,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,PSBPARM3_" admin's ACTION STATUS is ""UNKNOWN"".",PSBSCH,PSBPARM5,PSBPARM6,PSBPARM7) ;  SEND AN E-MAIL
"RTN","PSBVDLPB",95,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBXTMP)  ;Reset Variables
"RTN","PSBVDLPB",96,0)
 ....S X=PSBPARM6 K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLPB",97,0)
 ...Q:PSBSTUS']""  I PSBSTUS'="N" S PSBFLAG=1,PSBHSTA(YZ,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBVDLPB",98,0)
 ...D:PSBSTUS="N"
"RTN","PSBVDLPB",99,0)
 ....S $P(PSBREC,U,11)=""
"RTN","PSBVDLPB",100,0)
 ....S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBVDLPB",101,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLPB",102,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLPB",103,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBVDLPB",104,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBVDLPB",105,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBVDLPB",106,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBVDLPB",107,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBVDLPB",108,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBVDLPB",109,0)
 .S $P(PSBREC,U,12)=""  ;med log ien inserted below for actual date
"RTN","PSBVDLPB",110,0)
 .S $P(PSBREC,U,13)=""  ;med log status inserted below for actual date
"RTN","PSBVDLPB",111,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLPB",112,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLPB",113,0)
 .S $P(PSBREC,U,16)=0  ; Default to not injectable
"RTN","PSBVDLPB",114,0)
 .;Scan for injectable routes
"RTN","PSBVDLPB",115,0)
 .F X="ID","IV","IM","SC","SQ" D  Q:$P(PSBREC,U,16)
"RTN","PSBVDLPB",116,0)
 ..I PSBMR?@(".E1"""_X_""".E") S $P(PSBREC,U,16)=1
"RTN","PSBVDLPB",117,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLPB",118,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLPB",119,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLPB",120,0)
 .S $P(PSBREC,U,18)=PSBIVT  ;IV TYPE - dosage form
"RTN","PSBVDLPB",121,0)
 .S $P(PSBREC,U,20)=PSBSTUS S:$P(PSBREC,U,11)="" $P(PSBREC,U,20)=""
"RTN","PSBVDLPB",122,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLPB",123,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLPB",124,0)
 .;
"RTN","PSBVDLPB",125,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLPB",126,0)
 .D NOW^%DTC
"RTN","PSBVDLPB",127,0)
 .S (PSBDDS,PSBSOLS,PSBADDS)="0"
"RTN","PSBVDLPB",128,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLPB",129,0)
 ..Q:$P(PSBDDA(Y),U,4)&($P(PSBDDA(Y),U,4)<%)  ; Inactive
"RTN","PSBVDLPB",130,0)
 ..S:$P(PSBDDA(Y),U,3)="" $P(PSBDDA(Y),U,3)=1
"RTN","PSBVDLPB",131,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,3)
"RTN","PSBVDLPB",132,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLPB",133,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLPB",134,0)
 .S PSBQRR=0
"RTN","PSBVDLPB",135,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D  Q
"RTN","PSBVDLPB",136,0)
 ..I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",137,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",138,0)
 .;
"RTN","PSBVDLPB",139,0)
 .; IV's - don't worry about admin times if blank
"RTN","PSBVDLPB",140,0)
 .I PSBONX["V","PSC"'[PSBIVT,PSBADST="" D  Q
"RTN","PSBVDLPB",141,0)
 ..I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",142,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",143,0)
 .;
"RTN","PSBVDLPB",144,0)
 .; Now we deal with only continuous
"RTN","PSBVDLPB",145,0)
 .; process admintimes
"RTN","PSBVDLPB",146,0)
 .S (PSBYES,PSBODD,PSBYTF)=0
"RTN","PSBVDLPB",147,0)
 .S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBVDLPB",148,0)
 .I PSBYES,PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLPB",149,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBVDLPB",150,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLPB",151,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLPB",152,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBVDLPB",153,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBVDLPB",154,0)
 .I 'PSBYES,PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBVDLPB",155,0)
 .S PSBADMIN=PSBADST
"RTN","PSBVDLPB",156,0)
 .I (PSBADMIN="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1("PBTAB") Q  ;calculate admin times based on frequency
"RTN","PSBVDLPB",157,0)
 .; No admin times, MAYDAY MAYDAY!!
"RTN","PSBVDLPB",158,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBVDLPB",159,0)
 .I PSBODD,PSBADST'="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH) Q
"RTN","PSBVDLPB",160,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLPB",161,0)
 .; build all orders for both days.
"RTN","PSBVDLPB",162,0)
 .F PSBY=1:1 Q:$P(PSBADMIN,"-",PSBY)=""  D
"RTN","PSBVDLPB",163,0)
 ..;For invalid admin times
"RTN","PSBVDLPB",164,0)
 ..I ($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N) D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBVDLPB",165,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLPB",166,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLPB",167,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLPB",168,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLPB",169,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,PSB,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLPB",170,0)
 .....I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",171,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",172,0)
 ..;
"RTN","PSBVDLPB",173,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLPB",174,0)
 ..;
"RTN","PSBVDLPB",175,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLPB",176,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLPB",177,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLPB",178,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLPB",179,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,PSB,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLPB",180,0)
 .....I 'PSBDOADD S PSBTBOUT=1,^TMP("PSB",$J,"PBTAB",0)=2,^TMP("PSB",$J,"PBTAB",1)=1,^TMP("PSB",$J,"PBTAB",2)=1 Q
"RTN","PSBVDLPB",181,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",182,0)
 ;
"RTN","PSBVDLPB",183,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLPB",184,0)
 D:PSBDOADD VNURSE^PSBVDLU1("PBTAB")
"RTN","PSBVDLPB",185,0)
 Q
"RTN","PSBVDLPB",186,0)
 ;
"RTN","PSBVDLUD")
0^8^B74549540
"RTN","PSBVDLUD",1,0)
PSBVDLUD ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBVDLUD",2,0)
 ;;3.0;BAR CODE MED ADMIN;**11**;Mar 2004
"RTN","PSBVDLUD",3,0)
 ;
"RTN","PSBVDLUD",4,0)
 ; Reference/IA
"RTN","PSBVDLUD",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLUD",6,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLUD",7,0)
 ;
"RTN","PSBVDLUD",8,0)
EN(DFN,PSBDT) ;
"RTN","PSBVDLUD",9,0)
 ;
"RTN","PSBVDLUD",10,0)
 ;
"RTN","PSBVDLUD",11,0)
 ; Description:
"RTN","PSBVDLUD",12,0)
 ; Returns the current unit dose order set for today to display
"RTN","PSBVDLUD",13,0)
 ; on the client VDL
"RTN","PSBVDLUD",14,0)
 ;
"RTN","PSBVDLUD",15,0)
 N PSBDATA,PSBTBOUT
"RTN","PSBVDLUD",16,0)
 S PSBTBOUT=0
"RTN","PSBVDLUD",17,0)
 ;
"RTN","PSBVDLUD",18,0)
 ;This routine now re-uses the ^TMP("PSJ",$J global built in PSBVDLTB
"RTN","PSBVDLUD",19,0)
 ;
"RTN","PSBVDLUD",20,0)
 G:$G(^TMP("PSJ",$J,1,0))=-1 1
"RTN","PSBVDLUD",21,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBVDLUD",22,0)
 .S:(PSBTAB'="UDTAB")&($G(^TMP("PSB",$J,"UDTAB",2))>0) PSBTBOUT=1
"RTN","PSBVDLUD",23,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX)
"RTN","PSBVDLUD",24,0)
 .;
"RTN","PSBVDLUD",25,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLUD",26,0)
 .;
"RTN","PSBVDLUD",27,0)
 .Q:PSBONX["V"  ;No IVs on UD tab
"RTN","PSBVDLUD",28,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLUD",29,0)
 .Q:PSBOST>PSBWADM  ; Order Start Date/Time > admin window
"RTN","PSBVDLUD",30,0)
 .Q:PSBOSP<PSBWBEG  ; For Non one-times Order Stop Date/Time < vdl window
"RTN","PSBVDLUD",31,0)
 .Q:PSBOSTS["D"  ;     Is it DC'd
"RTN","PSBVDLUD",32,0)
 .Q:PSBNGF  ;         Is it marked DO NOT GIVE!
"RTN","PSBVDLUD",33,0)
 .Q:PSBMR="IVP"!(PSBMR="IV PUSH")
"RTN","PSBVDLUD",34,0)
 .;
"RTN","PSBVDLUD",35,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLUD",36,0)
 .;
"RTN","PSBVDLUD",37,0)
 .D NOW^%DTC
"RTN","PSBVDLUD",38,0)
 .Q:PSBOSP<%
"RTN","PSBVDLUD",39,0)
 .;
"RTN","PSBVDLUD",40,0)
 .; include Active, Renewed, ReInstated and On Call
"RTN","PSBVDLUD",41,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call)
"RTN","PSBVDLUD",42,0)
 .I PSBSCHT'="O",PSBOSTS'="A",PSBOSTS'="H",PSBOSTS'="R",PSBOSTS'="RE",PSBOSTS'="O" Q
"RTN","PSBVDLUD",43,0)
 .;
"RTN","PSBVDLUD",44,0)
 .; Is One Time Given
"RTN","PSBVDLUD",45,0)
 .;
"RTN","PSBVDLUD",46,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLUD",47,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLUD",48,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLUD",49,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLUD",50,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLUD",51,0)
 .;
"RTN","PSBVDLUD",52,0)
 .; How long does One Time remain on VDL ??
"RTN","PSBVDLUD",53,0)
 .S PSBRMN=1
"RTN","PSBVDLUD",54,0)
 .I PSBSCHT="O",PSBOSP'=PSBOST&(%>PSBOSP) S PSBRMN=0
"RTN","PSBVDLUD",55,0)
 .Q:'PSBRMN
"RTN","PSBVDLUD",56,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLUD",57,0)
 .;
"RTN","PSBVDLUD",58,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLUD",59,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLUD",60,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLUD",61,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLUD",62,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLUD",63,0)
 .;
"RTN","PSBVDLUD",64,0)
 .S PSBREC=""
"RTN","PSBVDLUD",65,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLUD",66,0)
 .S $P(PSBREC,U,2)=PSBONX ; order
"RTN","PSBVDLUD",67,0)
 .S $P(PSBREC,U,3)=PSBON ; order ien
"RTN","PSBVDLUD",68,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLUD",69,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLUD",70,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLUD",71,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; self med
"RTN","PSBVDLUD",72,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLUD",73,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLUD",74,0)
 .S $P(PSBREC,U,10)=PSBMR ; route
"RTN","PSBVDLUD",75,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLUD",76,0)
 .S (PSBCNT,PSBFLAG)=0,(YZ,PSBSTUS,PSBADMER)="" K PSBHSTA,PSBHSTAX
"RTN","PSBVDLUD",77,0)
 .F XZ=1:1:20 S YZ=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ),-1),(PSBCNT,PSBFLAG)=0 Q:YZ=""  D
"RTN","PSBVDLUD",78,0)
 ..S:YZ>0 $P(PSBREC,U,11)=YZ
"RTN","PSBVDLUD",79,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,YZ,X),-1) Q:X=""  D
"RTN","PSBVDLUD",80,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLUD",81,0)
 ...I $G(PSBSTUS)="" S PSBADMER=1 L +^PSB(53.79,X):1  I  D  L -^PSB(53.79,X) Q
"RTN","PSBVDLUD",82,0)
 ....K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLUD",83,0)
 ....S PSBPARM6=X,Y=$P(^PSB(53.79,X,.1),U,3) D DD^%DT S PSBPARM3=Y,Y=$P(^PSB(53.79,X,0),U,6) D DD^%DT S PSBPARM5=Y
"RTN","PSBVDLUD",84,0)
 ....S PSBPARM7=$P(^PSB(53.79,X,0),U,7) S PSBPARM7="( # "_PSBPARM7_" ) "_$$GET1^DIQ(200,PSBPARM7_",",.01)
"RTN","PSBVDLUD",85,0)
 ....K PSBXTMP S PSBXTMP=PSBONX
"RTN","PSBVDLUD",86,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,$$GET1^DIQ(53.79,PSBPARM6_",",.11))
"RTN","PSBVDLUD",87,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,PSBPARM3_" admin's ACTION STATUS is ""UNKNOWN"".",PSBSCH,PSBPARM5,PSBPARM6,PSBPARM7) ;  SEND AN E-MAIL
"RTN","PSBVDLUD",88,0)
 ....D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBXTMP)  ;Reset Variables
"RTN","PSBVDLUD",89,0)
 ....S X=PSBPARM6 K PSBPARM3,PSBPARM5,PSBPARM6,PSBPARM7
"RTN","PSBVDLUD",90,0)
 ...Q:PSBSTUS']""  I PSBSTUS'="N" S PSBFLAG=1,PSBHSTA(YZ,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBVDLUD",91,0)
 ...D:PSBSTUS="N"
"RTN","PSBVDLUD",92,0)
 ....S $P(PSBREC,U,11)=""
"RTN","PSBVDLUD",93,0)
 ....S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBVDLUD",94,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLUD",95,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLUD",96,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBVDLUD",97,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBVDLUD",98,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBVDLUD",99,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBVDLUD",100,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBVDLUD",101,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBVDLUD",102,0)
 .S $P(PSBREC,U,12)=""  ;med log ien inserted below for actual date
"RTN","PSBVDLUD",103,0)
 .S $P(PSBREC,U,13)=""  ;med log status inserted below for actual date
"RTN","PSBVDLUD",104,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLUD",105,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLUD",106,0)
 .S $P(PSBREC,U,16)=0  ; Default to not injectable
"RTN","PSBVDLUD",107,0)
 .F X="ID","IV","IM","SC","SQ" D  Q:$P(PSBREC,U,16)
"RTN","PSBVDLUD",108,0)
 ..I PSBMR?@(".E1"""_X_""".E"),PSBMR'["MISC" S $P(PSBREC,U,16)=1
"RTN","PSBVDLUD",109,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLUD",110,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLUD",111,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLUD",112,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ; dosage form
"RTN","PSBVDLUD",113,0)
 .S $P(PSBREC,U,20)=PSBSTUS S:$P(PSBREC,U,11)="" $P(PSBREC,U,20)=""  ; last action status
"RTN","PSBVDLUD",114,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLUD",115,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLUD",116,0)
 .;
"RTN","PSBVDLUD",117,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLUD",118,0)
 .D NOW^%DTC
"RTN","PSBVDLUD",119,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBVDLUD",120,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLUD",121,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1 ;If drug was inactivated
"RTN","PSBVDLUD",122,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ; Inactive
"RTN","PSBVDLUD",123,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBVDLUD",124,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4)
"RTN","PSBVDLUD",125,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLUD",126,0)
 .;
"RTN","PSBVDLUD",127,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLUD",128,0)
 .S PSBQRR=0
"RTN","PSBVDLUD",129,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"UDTAB") Q
"RTN","PSBVDLUD",130,0)
 .;
"RTN","PSBVDLUD",131,0)
 .; Now we deal with only continuous
"RTN","PSBVDLUD",132,0)
 .; process admintimes
"RTN","PSBVDLUD",133,0)
 .; Display an order on the VDL based on the frequency received from IPM **PSB*2.0*3
"RTN","PSBVDLUD",134,0)
 .S (PSBYES,PSBODD,PSBYTF)=0
"RTN","PSBVDLUD",135,0)
 .I PSBSCH="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"No Schedule on this order")
"RTN","PSBVDLUD",136,0)
 .S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBVDLUD",137,0)
 .I PSBYES,PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLUD",138,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBVDLUD",139,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH) Q
"RTN","PSBVDLUD",140,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLUD",141,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBVDLUD",142,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBVDLUD",143,0)
 .I 'PSBYES,PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBVDLUD",144,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1("UDTAB") Q  ;calculate admin times based on frequency
"RTN","PSBVDLUD",145,0)
 .; No admin times, MAYDAY MAYDAY!!
"RTN","PSBVDLUD",146,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBVDLUD",147,0)
 .I PSBODD,PSBADST'="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH) Q
"RTN","PSBVDLUD",148,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLUD",149,0)
 .; build all orders for both days.
"RTN","PSBVDLUD",150,0)
 .F PSBY=1:1 Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBVDLUD",151,0)
 ..;For invalid admin times
"RTN","PSBVDLUD",152,0)
 ..I ($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N) D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBVDLUD",153,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLUD",154,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBVDLUD",155,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLUD",156,0)
 ...D:(PSB'<PSBOST)&(PSB<PSBOSP)  ; Make sure this time is active
"RTN","PSBVDLUD",157,0)
 ....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLUD",158,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",159,0)
 ..;
"RTN","PSBVDLUD",160,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLUD",161,0)
 ..;
"RTN","PSBVDLUD",162,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLUD",163,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBVDLUD",164,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLUD",165,0)
 ...D:(PSB'<PSBOST)&(PSB<PSBOSP)  ; Make sure this time is active
"RTN","PSBVDLUD",166,0)
 ....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLUD",167,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",168,0)
 .K PSBSTUS
"RTN","PSBVDLUD",169,0)
1 K PSBREC D EN^PSBVDLPA
"RTN","PSBVDLUD",170,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLUD",171,0)
 D:PSBTAB="UDTAB" VNURSE^PSBVDLU1("UDTAB")
"RTN","PSBVDLUD",172,0)
 D CLEAN^PSBVT
"RTN","PSBVDLUD",173,0)
 Q
"RTN","PSBVDLUD",174,0)
 ;
"RTN","PSBVDLVL")
0^9^B58456162
"RTN","PSBVDLVL",1,0)
PSBVDLVL ;BIRMINGHAM/EFC-BCMA VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBVDLVL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,12,11**;Mar 2004
"RTN","PSBVDLVL",3,0)
 ;
"RTN","PSBVDLVL",4,0)
EN(RESULTS,DFN,PSBXOR,PSBTYPE,PSBADMIN,PSBTAB,PSBUID,PSBASTS,PSBORSTS,PSBRMV) ;
"RTN","PSBVDLVL",5,0)
 ;
"RTN","PSBVDLVL",6,0)
 ; RPC: PSB VALIDATE ORDER
"RTN","PSBVDLVL",7,0)
 ;
"RTN","PSBVDLVL",8,0)
 ; Description: Final check of order against an actual administration
"RTN","PSBVDLVL",9,0)
 ;              date/time used immediately after scanned med has been
"RTN","PSBVDLVL",10,0)
 ;              validated to be a good un-administered order.
"RTN","PSBVDLVL",11,0)
 ;
"RTN","PSBVDLVL",12,0)
 K TEST
"RTN","PSBVDLVL",13,0)
 N PSBFLAG
"RTN","PSBVDLVL",14,0)
 I PSBRMV="I" D GETOHIST^PSBRPC2(.TEST,DFN,PSBXOR_PSBTYPE) S I=0 F  S I=$O(TEST(I)) Q:I=""  I $P(TEST(I),U,5)="I" S RESULTS(0)=1,RESULTS(1)="-2^" K TEST Q
"RTN","PSBVDLVL",15,0)
 K PSBOKAY D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBXOR_PSBTYPE) S PSB=0
"RTN","PSBVDLVL",16,0)
 S RESULTS(0)=1,RESULTS(1)="-1^***Unable to determine administration" ; Default Flag will be overwritten by anything
"RTN","PSBVDLVL",17,0)
 D NOW^%DTC
"RTN","PSBVDLVL",18,0)
 I ((PSBOSTS="A")!(PSBOSTS="R"))&(PSBOSP<%) S PSBOSTS="E"
"RTN","PSBVDLVL",19,0)
 I PSBORSTS'=PSBOSTS,((PSBSCHT'="O")&(PSBOSTS'="E")) S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-2^ORDER STATUS MISMATCH" Q
"RTN","PSBVDLVL",20,0)
 I ((PSBTAB="UDTAB")!(PSBTAB="PBTAB")),((PSBRMV="RM")!(PSBRMV="N")) D  Q
"RTN","PSBVDLVL",21,0)
 .S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^OKAY TO REMOVE"  ;  is a patch removal does not follow rest of validte rules
"RTN","PSBVDLVL",22,0)
 .I PSBASTS="" Q  ;status is not given - don't check for missmatch
"RTN","PSBVDLVL",23,0)
 .I $D(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN)) S X=$O(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN,"")) I $P($G(^PSB(53.79,+X,0)),U,9)'=PSBASTS  S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-2^Admin status mismatch"
"RTN","PSBVDLVL",24,0)
 I PSBTYPE="V",PSBSCHT'="P",((PSBUID="")!(PSBUID["WS")) S RESULTS(0)=1,RESULTS(1)="0^Okay to administer" Q:PSBTAB="IVTAB"
"RTN","PSBVDLVL",25,0)
 I PSBTYPE="V",PSBUID'="" D  Q:PSBTAB="IVTAB"  ; validate IV bags Piggybacks have additional tests
"RTN","PSBVDLVL",26,0)
 .S PSB=0,PSBSUID=PSBUID D EN^PSBPOIV(DFN,PSBXOR_PSBTYPE)
"RTN","PSBVDLVL",27,0)
 .S X="" F  S X=$O(^TMP("PSBAR",$J,X)) Q:X=""  D
"RTN","PSBVDLVL",28,0)
 ..I PSBSUID'=X Q
"RTN","PSBVDLVL",29,0)
 ..S PSBUIDS=^TMP("PSBAR",$J,X)
"RTN","PSBVDLVL",30,0)
 ..I $P(PSBUIDS,U,2)="I"!($P(PSBUIDS,U,2)="S") S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^Okay to administer" Q  ; is infusing or stopped
"RTN","PSBVDLVL",31,0)
 ..I $P(PSBUIDS,U,1)="I" S Y=$P(^TMP("PSBAR",$J,"I"),U,2) D DD^%DT S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=$P(^TMP("PSBAR",$J,"I"),U,3,99)_"  "_Y Q
"RTN","PSBVDLVL",32,0)
 ..I $P(PSBUIDS,U,1)["W" S PSBWS=$P(PSBUIDS,U,1) F PSBWM=2:1 Q:$P(PSBWS,";",PSBWM)=""  D
"RTN","PSBVDLVL",33,0)
 ...S Y=$P(^TMP("PSBAR",$J,"W",$P(PSBWS,";",PSBWM)),U,2) D DD^%DT S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=$P(^TMP("PSBAR",$J,"W",$P(PSBWS,";",PSBWM)),U,3,99)_" "_Y
"RTN","PSBVDLVL",34,0)
 ..S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^Okay to administer"
"RTN","PSBVDLVL",35,0)
 .K ^TMP("PSBAR",$J)
"RTN","PSBVDLVL",36,0)
 ;
"RTN","PSBVDLVL",37,0)
 ; no IV orders
"RTN","PSBVDLVL",38,0)
 ;
"RTN","PSBVDLVL",39,0)
 D NOW^%DTC
"RTN","PSBVDLVL",40,0)
 I PSBOSTS="H" S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^Order is on Provider Hold" Q
"RTN","PSBVDLVL",41,0)
 I PSBSCHT'="O"&(%<($$FMADD^XLFDT(PSBOST,"","",$$GET^XPAR("ALL","PSB ADMIN BEFORE")*-1))) S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-1^Order Not Active" Q
"RTN","PSBVDLVL",42,0)
 I PSBSCHT'="O"&(%>PSBOSP) S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-1^Order Not Active" Q
"RTN","PSBVDLVL",43,0)
 I (PSBSCHT="C")!((PSBSCHT="P")&(PSBDOSEF="PATCH")) D
"RTN","PSBVDLVL",44,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",45,0)
 .I PSBOSTS'="A",PSBOSTS'="R",PSBOSTS'="O" S PSBOKAY="-1^Order Not Active" Q
"RTN","PSBVDLVL",46,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",47,0)
 .S PSBFLAG=0 I PSBRMV="M"!(PSBRMV="H")!(PSBRMV="R") S PSBFLAG=1
"RTN","PSBVDLVL",48,0)
 .I $D(^PSB(53.79,"AORDX",DFN,PSBXOR_PSBTYPE)) D  Q:X
"RTN","PSBVDLVL",49,0)
 ..S X=0,PSBLADT=$O(^PSB(53.79,"AORDX",DFN,PSBXOR_PSBTYPE,""),-1),PSBLAIEN=$O(^PSB(53.79,"AORDX",DFN,PSBXOR_PSBTYPE,PSBLADT,""),-1)
"RTN","PSBVDLVL",50,0)
 ..I $P($G(^PSB(53.79,PSBLAIEN,0)),U,9)="G",$P($G(^PSB(53.79,PSBLAIEN,.5,1,0)),U,4)="PATCH",PSBFLAG=0 S X=1,PSBOKAY="-1^Previous patch has not been removed"
"RTN","PSBVDLVL",51,0)
 .I $D(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN)) D  Q:+PSBOKAY=-2
"RTN","PSBVDLVL",52,0)
 ..S X=$O(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN,""))
"RTN","PSBVDLVL",53,0)
 ..I $G(PSBASTS)]"",$P($G(^PSB(53.79,+X,0)),U,9)'=PSBASTS S PSBOKAY="-2^Admin status mismatch"
"RTN","PSBVDLVL",54,0)
 ..I $P($G(^PSB(53.79,+X,0)),U,9)']"" S PSBOKAY="-2^Admin Status unknown !"
"RTN","PSBVDLVL",55,0)
 ..L +^PSB(53.79,+X):1
"RTN","PSBVDLVL",56,0)
 ..I  L -^PSB(53.79,+X)
"RTN","PSBVDLVL",57,0)
 ..E  S PSBOKAY="-2^Admin Status unknown !"
"RTN","PSBVDLVL",58,0)
 .; Minutes before
"RTN","PSBVDLVL",59,0)
 .S PSBWIN1=$$GET^XPAR("DIV","PSB ADMIN BEFORE")*-1
"RTN","PSBVDLVL",60,0)
 .; Minutes After
"RTN","PSBVDLVL",61,0)
 .S PSBWIN2=$$GET^XPAR("DIV","PSB ADMIN AFTER")
"RTN","PSBVDLVL",62,0)
 .D NOW^%DTC S PSBMIN=$$DIFF^PSBUTL(PSBADMIN,%)
"RTN","PSBVDLVL",63,0)
 .; PENDING A PC SOLUTION!
"RTN","PSBVDLVL",64,0)
 .I PSBMIN<PSBWIN1 S PSBOKAY="1^Admin is "_(PSBMIN*-1)_" minutes before the scheduled administration time" Q
"RTN","PSBVDLVL",65,0)
 .I PSBMIN>PSBWIN2 S PSBOKAY="1^Admin is "_(PSBMIN)_" minutes after the scheduled administration time" Q
"RTN","PSBVDLVL",66,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",67,0)
 ; Validate a PRN Order
"RTN","PSBVDLVL",68,0)
 D:(PSBSCHT="P")
"RTN","PSBVDLVL",69,0)
 .I PSBOSTS'="A",PSBOSTS'="R",PSBOSTS'="O" S PSBOKAY="-1^Order Not Active" Q
"RTN","PSBVDLVL",70,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",71,0)
 .I (+($G(PSBOKAY))<0)&(PSBDOSEF="PATCH") Q  ;A Patch may have to be removed.
"RTN","PSBVDLVL",72,0)
 .S PSBOKAY="1^"
"RTN","PSBVDLVL",73,0)
 .; Get Last Four Givens
"RTN","PSBVDLVL",74,0)
 .S PSBDT=""
"RTN","PSBVDLVL",75,0)
 .F  S PSBDT=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,PSBDT),-1) Q:PSBDT=""  D
"RTN","PSBVDLVL",76,0)
 ..S PSBDA=""
"RTN","PSBVDLVL",77,0)
 ..F  S PSBDA=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,PSBDT,PSBDA),-1) Q:'PSBDA  D
"RTN","PSBVDLVL",78,0)
 ...S (PSBCNT1,PSBCNT2,PSBCNT3)=0
"RTN","PSBVDLVL",79,0)
 ...S PSBLADT=$$GET1^DIQ(53.79,PSBDA_",",.06,"I")  ;$P(^PSB(53.79,PSBDA,0),U,6)
"RTN","PSBVDLVL",80,0)
 ...S PSBSTUS=$$GET1^DIQ(53.79,PSBDA_",",.09)
"RTN","PSBVDLVL",81,0)
 ...S PSBSCH=$$GET1^DIQ(53.79,PSBDA_",",.12)
"RTN","PSBVDLVL",82,0)
 ...S PSBRSN=$$GET1^DIQ(53.79,PSBDA_",",.21)
"RTN","PSBVDLVL",83,0)
 ...S PSBINJ=$$GET1^DIQ(53.79,PSBDA_",",.16)
"RTN","PSBVDLVL",84,0)
 ...Q:$P(^PSB(53.79,PSBDA,0),U,9)="N"
"RTN","PSBVDLVL",85,0)
 ...F PSBZ=.5,.6,.7 F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBDA,PSBZ,PSBY)) Q:'PSBY  D
"RTN","PSBVDLVL",86,0)
 ....Q:'$D(^PSB(53.79,PSBDA,PSBZ,PSBY))
"RTN","PSBVDLVL",87,0)
 ....S PSBDD=$S(PSBZ=.5:53.795,PSBZ=.6:53.796,1:53.797)
"RTN","PSBVDLVL",88,0)
 ....S PSBUNIT=$$GET1^DIQ(PSBDD,PSBY_","_PSBDA_",",.03)
"RTN","PSBVDLVL",89,0)
 ....S PSBUNFR=$$GET1^DIQ(PSBDD,PSBY_","_PSBDA_",",.04)
"RTN","PSBVDLVL",90,0)
 ....I PSBZ=.5 S PSBCNT1=PSBCNT1+1
"RTN","PSBVDLVL",91,0)
 ....I PSBZ=.6 S PSBCNT2=PSBCNT2+1
"RTN","PSBVDLVL",92,0)
 ....I PSBZ=.7 S PSBCNT3=PSBCNT3+1
"RTN","PSBVDLVL",93,0)
 ...;Units given or free text not to display for multiple dispense drugs or additives and solution
"RTN","PSBVDLVL",94,0)
 ...I (PSBCNT1>1)!(PSBCNT2>0)!(PSBCNT3>0) S (PSBUNIT,PSBUNFR)=""
"RTN","PSBVDLVL",95,0)
 ...S X=PSBLADT_U
"RTN","PSBVDLVL",96,0)
 ...S X=X_PSBSTUS_U_PSBSCH_U_$G(PSBRSN)_U_$G(PSBINJ)_U_$G(PSBUNIT)_U_$G(PSBUNFR)
"RTN","PSBVDLVL",97,0)
 ...S PSBOKAY($O(PSBOKAY(""),-1)+1)=3_U_X
"RTN","PSBVDLVL",98,0)
 ...S:$D(PSBOKAY(4)) PSBDT=0
"RTN","PSBVDLVL",99,0)
 ; Validate a One-Time Order
"RTN","PSBVDLVL",100,0)
 D:PSBSCHT="O"
"RTN","PSBVDLVL",101,0)
 .S (PSBGVN,X,Y)=""
"RTN","PSBVDLVL",102,0)
 .F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1)  Q:'X  F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLVL",103,0)
 .I PSBGVN S PSBOKAY="-1^Dose Already on medication Log" Q
"RTN","PSBVDLVL",104,0)
 .; One Time are automatically expired so we don't check STATUS here
"RTN","PSBVDLVL",105,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",106,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",107,0)
 ; Validate an On Call Order
"RTN","PSBVDLVL",108,0)
 D:PSBSCHT="OC"
"RTN","PSBVDLVL",109,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",110,0)
 .S (PSBGVN,X,Y)=""
"RTN","PSBVDLVL",111,0)
 .F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1)  Q:'X  F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLVL",112,0)
 .I PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL")) S PSBOKAY="-1^Dose Already on medication Log" Q
"RTN","PSBVDLVL",113,0)
 .I PSBOSTS'="A",PSBOSTS'="R",PSBOSTS'="O" S PSBOKAY="-1^Order Not Active" Q
"RTN","PSBVDLVL",114,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",115,0)
 .I PSBGVN&($$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))&(PSBDOSEF="PATCH") S PSBOKAY="-1^Previous patch has not been removed" Q
"RTN","PSBVDLVL",116,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",117,0)
 ;
"RTN","PSBVDLVL",118,0)
 D:+PSBOKAY'<0
"RTN","PSBVDLVL",119,0)
 .N PSBDIFF,Y
"RTN","PSBVDLVL",120,0)
 .D:(PSBSCHT="C")!(PSBSCHT="OC"&('$G(PSBGVN)))
"RTN","PSBVDLVL",121,0)
 ..; On-call or cont and not on the log.
"RTN","PSBVDLVL",122,0)
 ..S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,""),-1)
"RTN","PSBVDLVL",123,0)
 ..;Check for the status of the medication and insert status in the text
"RTN","PSBVDLVL",124,0)
 ..I Y]"" S X=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,Y,""),-1),PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLVL",125,0)
 ..S:Y']"" PSBSTUS=""
"RTN","PSBVDLVL",126,0)
 ..I PSBSTUS="N" D  Q:$G(PSBQUIT)
"RTN","PSBVDLVL",127,0)
 ...S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y,X),-1)
"RTN","PSBVDLVL",128,0)
 ...D:X']""
"RTN","PSBVDLVL",129,0)
 ....S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y),-1) I Y']"" S PSBQUIT=1 Q
"RTN","PSBVDLVL",130,0)
 ....S X=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,Y,""),-1),PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLVL",131,0)
 ..S PSBDIFF=$$FMDIFF^XLFDT($$NOW^XLFDT(),Y,2)
"RTN","PSBVDLVL",132,0)
 ..Q:PSBDIFF>7200  ; Greater than 2 hours
"RTN","PSBVDLVL",133,0)
 ..I (PSBSTUS="G")!(PSBSTUS="H")!(PSBSTUS="R")!(PSBSTUS="RM") D
"RTN","PSBVDLVL",134,0)
 ...S PSBSTUS=$$GET1^DIQ(53.79,X_",",.09)
"RTN","PSBVDLVL",135,0)
 ...I PSBSTUS'="" D
"RTN","PSBVDLVL",136,0)
 ....S Y="1^*** NOTICE, "_PSBOITX_" was "_PSBSTUS_" "_(PSBDIFF\60)_" minutes ago."
"RTN","PSBVDLVL",137,0)
 ....I +PSBOKAY=1 S PSBOKAY(1)=Y
"RTN","PSBVDLVL",138,0)
 ....E  S PSBOKAY=Y
"RTN","PSBVDLVL",139,0)
 ;
"RTN","PSBVDLVL",140,0)
 S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=PSBOKAY
"RTN","PSBVDLVL",141,0)
 F X=1:1 Q:'$D(PSBOKAY(X))  S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=PSBOKAY(X)
"RTN","PSBVDLVL",142,0)
 Q
"RTN","PSBVDLVL",143,0)
 ;
"VER")
8.0^22.0
"BLD",5352,6)
^SEQ #10
**END**
**END**
