Released DG*5.3*680 SEQ #592
Extracted from mail message
**KIDS**:DG*5.3*680^

**INSTALL NAME**
DG*5.3*680
"BLD",5757,0)
DG*5.3*680^REGISTRATION^0^3051103^y
"BLD",5757,1,0)
^^1^1^3051004^
"BLD",5757,1,1,0)
This patch corrects problems when adding patients.
"BLD",5757,4,0)
^9.64PA^^
"BLD",5757,6)
1^
"BLD",5757,"KRN",0)
^9.67PA^8989.52^19
"BLD",5757,"KRN",.4,0)
.4
"BLD",5757,"KRN",.401,0)
.401
"BLD",5757,"KRN",.402,0)
.402
"BLD",5757,"KRN",.403,0)
.403
"BLD",5757,"KRN",.5,0)
.5
"BLD",5757,"KRN",.84,0)
.84
"BLD",5757,"KRN",3.6,0)
3.6
"BLD",5757,"KRN",3.8,0)
3.8
"BLD",5757,"KRN",9.2,0)
9.2
"BLD",5757,"KRN",9.8,0)
9.8
"BLD",5757,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5757,"KRN",9.8,"NM",1,0)
DPTLK1^^0^B38915744
"BLD",5757,"KRN",9.8,"NM",2,0)
DPTLK2^^0^B31148790
"BLD",5757,"KRN",9.8,"NM","B","DPTLK1",1)

"BLD",5757,"KRN",9.8,"NM","B","DPTLK2",2)

"BLD",5757,"KRN",19,0)
19
"BLD",5757,"KRN",19.1,0)
19.1
"BLD",5757,"KRN",101,0)
101
"BLD",5757,"KRN",409.61,0)
409.61
"BLD",5757,"KRN",771,0)
771
"BLD",5757,"KRN",870,0)
870
"BLD",5757,"KRN",8989.51,0)
8989.51
"BLD",5757,"KRN",8989.52,0)
8989.52
"BLD",5757,"KRN",8994,0)
8994
"BLD",5757,"KRN","B",.4,.4)

"BLD",5757,"KRN","B",.401,.401)

"BLD",5757,"KRN","B",.402,.402)

"BLD",5757,"KRN","B",.403,.403)

"BLD",5757,"KRN","B",.5,.5)

"BLD",5757,"KRN","B",.84,.84)

"BLD",5757,"KRN","B",3.6,3.6)

"BLD",5757,"KRN","B",3.8,3.8)

"BLD",5757,"KRN","B",9.2,9.2)

"BLD",5757,"KRN","B",9.8,9.8)

"BLD",5757,"KRN","B",19,19)

"BLD",5757,"KRN","B",19.1,19.1)

"BLD",5757,"KRN","B",101,101)

"BLD",5757,"KRN","B",409.61,409.61)

"BLD",5757,"KRN","B",771,771)

"BLD",5757,"KRN","B",870,870)

"BLD",5757,"KRN","B",8989.51,8989.51)

"BLD",5757,"KRN","B",8989.52,8989.52)

"BLD",5757,"KRN","B",8994,8994)

"BLD",5757,"QUES",0)
^9.62^^
"BLD",5757,"REQB",0)
^9.611^2^2
"BLD",5757,"REQB",1,0)
DG*5.3*641^1
"BLD",5757,"REQB",2,0)
DG*5.3*647^1
"BLD",5757,"REQB","B","DG*5.3*641",1)

"BLD",5757,"REQB","B","DG*5.3*647",2)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2941102^2941102
"PKG",5,22,1,"PAH",1,0)
680^3051103^100850
"PKG",5,22,1,"PAH",1,1,0)
^^1^1^3051103
"PKG",5,22,1,"PAH",1,1,1,0)
This patch corrects problems when adding patients.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DPTLK1")
0^1^B38915744
"RTN","DPTLK1",1,0)
DPTLK1 ;ALB/RMO - MAS Patient Look-up Check Cross-References ; 4/27/05 1:16pm
"RTN","DPTLK1",2,0)
 ;;5.3;Registration;**32,50,197,249,317,391,244,532,574,620,641,680**;Aug 13, 1993
"RTN","DPTLK1",3,0)
FIND ;Cross reference patient lookup
"RTN","DPTLK1",4,0)
 ;Optional input: DPTNOFZY='1' to suppress fuzzy lookups implemented
"RTN","DPTLK1",5,0)
 ;                by patch DG*5.3*244
"RTN","DPTLK1",6,0)
 ;
"RTN","DPTLK1",7,0)
 N DDCOMA,DPTXOLD,DPTOUT,DPTOVAL,DGLASTLK
"RTN","DPTLK1",8,0)
 S DGLASTLK=1
"RTN","DPTLK1",9,0)
 S (DPTXOLD,DPTX)=$$UCASE(DPTX)
"RTN","DPTLK1",10,0)
 I DPTX?1A.E1","1.A.E S DPTXOLD=DPTX,DDCOMA="I $E($P($G(DPTVAL),"","",2),1,"_$L($P(DPTX,",",2))_")="""_$TR($P(DPTX,",",2),"""")_"""",DPTX=$P(DPTX,",")
"RTN","DPTLK1",11,0)
 K DPTREFS S DPTREFS=$S(DIC(0)'["M":"B,NOP",DPTX?1A1N.N:$S($L(DPTX)<6:"BS5,CN,RM",1:"CN,RM"),DPTX?4N!(DPTX?4N1A):"BS,SSN,CN,RM",DPTX?9N.E:"SSN,CN,RM",1:"")
"RTN","DPTLK1",12,0)
 S:DPTREFS="" DPTREFS=$S(DPTX?1N.N:$S($L(DPTX)<5:"CN,RM,BS,SSN",1:"CN,RM,SSN"),DPTX?1N.E:"CN,RM",1:"B,NOP,CN,RM") S:$D(DPTIX) DPTREFS=DPTIX_","_DPTREFS
"RTN","DPTLK1",13,0)
 S DPTBEG=1,(DPTDFN,DPTNUM,DPTOUT)=0
"RTN","DPTLK1",14,0)
 F DPTLP=1:1 S DPTREF=$P(DPTREFS,",",DPTLP) Q:DPTREF=""!(DPTDFN)  D  Q:DPTDFN!DPTOUT
"RTN","DPTLK1",15,0)
 .S DPTVAL=DPTX
"RTN","DPTLK1",16,0)
 .I DPTREF="NOP",'$G(DPTNOFZY) S DPTVAL=$$FORMAT^XLFNAME7(DPTVAL,2,30,1,0,,1) Q:'$L(DPTVAL)
"RTN","DPTLK1",17,0)
 .D LOOK(DPTVAL)
"RTN","DPTLK1",18,0)
 .I DPTREF="B",'$G(DPTNOFZY) S DPTVAL=$$FORMAT^XLFNAME7(DPTX,2,30,1,0,,1) D:DPTVAL'=DPTX LOOK(DPTVAL)
"RTN","DPTLK1",19,0)
 .Q
"RTN","DPTLK1",20,0)
SET I 'DPTDFN S:DPTCNT=1&($D(DPTIFNS(DPTCNT))) DPTDFN=+DPTIFNS(DPTCNT) S DPT("NOPRT^")="" D PRTDPT:'DPTDFN&(DPTCNT>DPTNUM)&(DIC(0)["E") K DPT("NOPRT^") I 'DPTDFN,$D(DPTSEL),DPTSEL="" S DPTX="",DPTDFN=-1
"RTN","DPTLK1",21,0)
 I DPTDFN'>0,$L($G(DPTXOLD)) I DPTX=$P(DPTXOLD,",") S DPTX=DPTXOLD
"RTN","DPTLK1",22,0)
 I DPTDFN>0,$D(DPTXOLD) S DPTX=DPTXOLD
"RTN","DPTLK1",23,0)
 ; one last stab at lookup - DG*641
"RTN","DPTLK1",24,0)
 I '$G(DPTCNT),DPTX[",",DGLASTLK=1,'$G(DPTNOFZY) D
"RTN","DPTLK1",25,0)
 .S DPTX=$$FORMAT^XLFNAME7(DPTX,2,30,1)
"RTN","DPTLK1",26,0)
 .S DDCOMA="I $E($P($G(DPTVAL),"","",2),1,"_$L($P(DPTX,",",2))_")="""_$TR($P(DPTX,",",2),"""")_""""
"RTN","DPTLK1",27,0)
 .S DPTX=$P(DPTX,",")
"RTN","DPTLK1",28,0)
 .S DGLASTLK=0
"RTN","DPTLK1",29,0)
 .S DPTREFS="B,NOP,CN,RM"
"RTN","DPTLK1",30,0)
 .F DPTLP=1:1 S DPTREF=$P(DPTREFS,",",DPTLP) Q:DPTREF=""!(DPTDFN)  D  Q:DPTDFN!DPTOUT
"RTN","DPTLK1",31,0)
 ..S DPTVAL=DPTX
"RTN","DPTLK1",32,0)
 ..D LOOK(DPTVAL)
"RTN","DPTLK1",33,0)
 I DGLASTLK=0,$G(DPTCNT) S DGLASTLK=1 G SET
"RTN","DPTLK1",34,0)
 I DGLASTLK=0,'$G(DPTCNT),$L($G(DPTXOLD)) S DPTX=DPTXOLD
"RTN","DPTLK1",35,0)
 ; end of DG*641 change
"RTN","DPTLK1",36,0)
 ;
"RTN","DPTLK1",37,0)
Q K DPTBEG,DPTIFN,DPTIFNS,DPTLP,DPTLP1,DPTNUM,DPTREF,DPTREFS,DPTVAL
"RTN","DPTLK1",38,0)
 K DPTOVAL,DPTOUT,DPTXOLD,^TMP("DPTLK",$J)
"RTN","DPTLK1",39,0)
 Q
"RTN","DPTLK1",40,0)
 ;
"RTN","DPTLK1",41,0)
LOOK(DPTVAL) ;Look for x-ref matches
"RTN","DPTLK1",42,0)
 ;Input: DPTVAL=lookup seed value
"RTN","DPTLK1",43,0)
 I $L(DPTVAL),$D(^DPT(DPTREF,DPTVAL)) D CHKIFN Q:DPTDFN!DPTOUT
"RTN","DPTLK1",44,0)
 I $L(DPTVAL),'($D(^DPT(DPTREF,DPTVAL))&(DIC(0)["O"))&(DIC(0)'["X") D CHKVAL
"RTN","DPTLK1",45,0)
 Q
"RTN","DPTLK1",46,0)
 ;
"RTN","DPTLK1",47,0)
CHKVAL S DPTOVAL=DPTVAL
"RTN","DPTLK1",48,0)
 N DPTSEED S DPTSEED=DPTVAL
"RTN","DPTLK1",49,0)
 I DPTREF="SSN",(DPTVAL?9N1"p") D  Q
"RTN","DPTLK1",50,0)
 .S DPTVAL=$E(DPTVAL,1,9)_"P" D CHKIFN
"RTN","DPTLK1",51,0)
 .Q
"RTN","DPTLK1",52,0)
 I DPTREF="SSN",(DPTVAL?2.9N) D  Q
"RTN","DPTLK1",53,0)
 .S DPTVAL=$E(DPTVAL_"0000000",1,9)
"RTN","DPTLK1",54,0)
 .D CV1(DPTVAL),CHKIFN
"RTN","DPTLK1",55,0)
 .S DPTVAL=DPTVAL_"P" D CV1(DPTVAL),CHKIFN
"RTN","DPTLK1",56,0)
 .Q
"RTN","DPTLK1",57,0)
 D CV1(DPTVAL)
"RTN","DPTLK1",58,0)
 I DPTREF="CN"!(DPTREF="RM"),DPTVAL'["E",DPTVAL=+DPTVAL,'$D(^DPT(DPTREF,DPTVAL)) D  Q
"RTN","DPTLK1",59,0)
 .S DPTVAL=$O(^DPT(DPTREF,DPTVAL_" "),-1)
"RTN","DPTLK1",60,0)
 .D CV1(DPTVAL)
"RTN","DPTLK1",61,0)
 .Q
"RTN","DPTLK1",62,0)
 Q
"RTN","DPTLK1",63,0)
 ;
"RTN","DPTLK1",64,0)
CV1(DPTVAL) ;Look for input value matches
"RTN","DPTLK1",65,0)
 I $L(DPTVAL) F DPTLP1=0:0 S DPTVAL=$O(^DPT(DPTREF,DPTVAL)) Q:DPTVAL=""!(DPTDFN)!($P(DPTVAL,DPTSEED)'="")  D CHKIFN
"RTN","DPTLK1",66,0)
 Q
"RTN","DPTLK1",67,0)
 ;
"RTN","DPTLK1",68,0)
CHKIFN F DPTIFN=0:0 S DPTIFN=$O(^DPT(DPTREF,DPTVAL,DPTIFN)) Q:'DPTIFN!(DPTDFN)!DPTOUT  S Y=DPTIFN D SETDPT I $S<DPTSZ F I=1:1:DPTNUM-7 S J=$S($D(DPTIFNS(I)):+DPTIFNS(I),1:0) K DPTIFNS(I),DPTS(J) S DPTBEG=I
"RTN","DPTLK1",69,0)
 Q
"RTN","DPTLK1",70,0)
 ;
"RTN","DPTLK1",71,0)
SETDPT Q:($D(DPTS(Y))&($G(DPTREF)'="B"))!'$D(^DPT(Y,0))
"RTN","DPTLK1",72,0)
 ; screen out MERGED FROM records - DG/574
"RTN","DPTLK1",73,0)
 Q:$D(^DPT(Y,-9))
"RTN","DPTLK1",74,0)
 N DPTNVAL I '$D(DPTOVAL) N DPTOVAL S DPTOVAL=DPTX
"RTN","DPTLK1",75,0)
 I 1 S X=DPTOVAL X:$D(DIC("S")) DIC("S") Q:'$T  X:($D(DO("SCR"))) DO("SCR") Q:'$T  X:$D(DDCOMA) DDCOMA Q:'$T
"RTN","DPTLK1",76,0)
 K:$G(DPTCNT)<1 ^TMP("DPTLK",$J)
"RTN","DPTLK1",77,0)
 S DPTS(Y)=$S('$D(DPTREF):$P(^DPT(Y,0),U),1:$P(^DPT(Y,0),U))_U_$S($D(DPTVAL):$E(DPTVAL,($L(DPTOVAL)+1),$L(DPTVAL)),1:"")
"RTN","DPTLK1",78,0)
 S DPTNVAL=$P(^DPT(Y,0),U)_U_$S($G(DPTREF)="NOP":$P(^DPT(Y,0),U),$D(DPTVAL):DPTVAL,1:"")
"RTN","DPTLK1",79,0)
 Q:$D(^TMP("DPTLK",$J,Y,DPTNVAL))
"RTN","DPTLK1",80,0)
 S DPTCNT=DPTCNT+1,^TMP("DPTLK",$J,Y,DPTNVAL)="",DPTIFNS(DPTCNT)=Y_U_DPTNVAL
"RTN","DPTLK1",81,0)
 I $D(DPTLARR) D  Q
"RTN","DPTLK1",82,0)
 .I DPTLMAX,DPTCNT>DPTLMAX D  Q
"RTN","DPTLK1",83,0)
 ..S @DPTLARR@(DPTCNT)="ADDITIONAL MATCHES FOUND BUT NOT RETURNED"
"RTN","DPTLK1",84,0)
 ..S DPTOUT=1
"RTN","DPTLK1",85,0)
 ..Q
"RTN","DPTLK1",86,0)
 .S @DPTLARR@(DPTCNT)=DPTIFNS(DPTCNT)_U_$$SSN(Y)_U_$$DOB(Y)
"RTN","DPTLK1",87,0)
 .Q
"RTN","DPTLK1",88,0)
 I '(DPTCNT#5),DIC(0)["E" D PRTDPT
"RTN","DPTLK1",89,0)
 Q
"RTN","DPTLK1",90,0)
 ;
"RTN","DPTLK1",91,0)
PRTDPT I $D(DDS) D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY S X=0 X ^%ZOSF("RM")
"RTN","DPTLK1",92,0)
 N DPTP1,DPTP2
"RTN","DPTLK1",93,0)
 F DPTNUM=DPTNUM+1:1:DPTCNT Q:DPTOUT  S DPTIFN=+DPTIFNS(DPTNUM) D
"RTN","DPTLK1",94,0)
 .W:'$D(DDS) !
"RTN","DPTLK1",95,0)
 .S DPTP2=$P(DPTIFNS(DPTNUM),U,3)
"RTN","DPTLK1",96,0)
 .S DPTP1=$P(DPTIFNS(DPTNUM),U,2)
"RTN","DPTLK1",97,0)
 .W ?3,DPTNUM,?$X+(4-$L(DPTNUM))
"RTN","DPTLK1",98,0)
 .; write the xref value
"RTN","DPTLK1",99,0)
 .W DPTP2_"  "
"RTN","DPTLK1",100,0)
 .; write patient name if diff than xref value
"RTN","DPTLK1",101,0)
 .I DPTP1'=DPTP2 W DPTP1
"RTN","DPTLK1",102,0)
 .S Y=DPTIFN X:$D(^DPT(DPTIFN,0)) "N DDS X DIC(""W"")" I $D(DDS) S DY=DY+1,DX=0 X DDXY S $X=0
"RTN","DPTLK1",103,0)
 I '$D(DPT("NOPRT^")) W:'$D(DDS) ! W "ENTER '^' TO STOP, OR "
"RTN","DPTLK1",104,0)
 W:'$D(DDS) ! W "CHOOSE ",DPTBEG,"-",DPTNUM,": " R X:DTIME S DPTSEL=X D  Q:DPTSEL=""!$D(DTOUT)!$D(DUOUT)
"RTN","DPTLK1",105,0)
 .S:'$T DPTSEL=$S($D(DPTOVAL):DPTOVAL,$D(DPTVAL):DPTVAL,$D(DPTX):DPTX,$D(DPTXOLD):DPTXOLD,1:""),(DPTOUT,DTOUT)=1
"RTN","DPTLK1",106,0)
 .S:X="^" (DPTOUT,DUOUT)=1
"RTN","DPTLK1",107,0)
 S DPTDFN=$S(DPTSEL'?.ANP!($L(DPTSEL)>30):-1,'$D(DPTIFNS(DPTSEL)):-1,$D(DPTS(+DPTIFNS(DPTSEL))):+DPTIFNS(DPTSEL),1:-1),DPTX=$S(DPTDFN<0:DPTSEL,1:DPTX)
"RTN","DPTLK1",108,0)
 S:DPTDFN=-1 DPTXOLD=DPTSEL
"RTN","DPTLK1",109,0)
 Q
"RTN","DPTLK1",110,0)
 ;
"RTN","DPTLK1",111,0)
LIST(DPTX,DPTLMAX,DPTLARR) ;Silent lookup list
"RTN","DPTLK1",112,0)
 ;Input: DPTX=lookup value (name, SSN, room, ward, DFN or 
"RTN","DPTLK1",113,0)
 ;             "space_return").
"RTN","DPTLK1",114,0)
 ;       DPTLMAX=maximum number of matches to return (optional), this
"RTN","DPTLK1",115,0)
 ;               parameter has no effect if DFN or "space_return"
"RTN","DPTLK1",116,0)
 ;               lookup methods are used.
"RTN","DPTLK1",117,0)
 ;       DPTLARR=name of array to return list of matches, this should
"RTN","DPTLK1",118,0)
 ;               be a global if DPTLMAX is a large value or unspecified
"RTN","DPTLK1",119,0)
 ;               This array is returned in the format:
"RTN","DPTLK1",120,0)
 ;               @DPTLARR@(n)=DFN^patient_name^xref_lookup_match_value^
"RTN","DPTLK1",121,0)
 ;                            SSN^Date_of_Birth
"RTN","DPTLK1",122,0)
 ;               If more matches exist than the maximum to be returned
"RTN","DPTLK1",123,0)
 ;               as specified by DPTLMAX, the @DPTLARR@(DPTLMAX+1) node
"RTN","DPTLK1",124,0)
 ;               will be defined = "ADDITIONAL MATCHES FOUND BUT NOT 
"RTN","DPTLK1",125,0)
 ;               RETURNED".
"RTN","DPTLK1",126,0)
 ;               The calling program has the responsibility to kill
"RTN","DPTLK1",127,0)
 ;               @DPTLARR prior to calling this entry point.
"RTN","DPTLK1",128,0)
 ;Output: number of matches and array named by DPTLARR.
"RTN","DPTLK1",129,0)
 ;
"RTN","DPTLK1",130,0)
 N X,Y,DPTCNT,DIC,DPTSZ,DPTDFN,DPTIFNS,DPTS
"RTN","DPTLK1",131,0)
 S DPTCNT=0,DIC(0)="M",DPTSZ=1000 S:$G(DPTLMAX)<1 DPTLMAX=0
"RTN","DPTLK1",132,0)
 ;Check for "space_return" or DFN lookup
"RTN","DPTLK1",133,0)
 I DPTX=" "!($E(DPTX)="`") D  Q DPTCNT
"RTN","DPTLK1",134,0)
 .I DPTX=" " S Y=$S('($D(DUZ)#2):-1,$D(^DISV(DUZ,"^DPT(")):^("^DPT("),1:-1)
"RTN","DPTLK1",135,0)
 .I $E(DPTX)="`" S Y=$S($D(^DPT(+$P(DPTX,"`",2),0)):+$P(DPTX,"`",2),1:-1)
"RTN","DPTLK1",136,0)
 .Q:Y<1  Q:'$D(^DPT(Y,0))  D SETDPT S DPTCNT=1
"RTN","DPTLK1",137,0)
 .Q
"RTN","DPTLK1",138,0)
 D FIND
"RTN","DPTLK1",139,0)
 Q $S(DPTLMAX&(DPTCNT>DPTLMAX):DPTLMAX,1:DPTCNT)
"RTN","DPTLK1",140,0)
 ;
"RTN","DPTLK1",141,0)
UCASE(DGX) ;Uppercase lookup value
"RTN","DPTLK1",142,0)
 ;Input: DGX=lookup value
"RTN","DPTLK1",143,0)
 ;Output: transformed DGX
"RTN","DPTLK1",144,0)
 N DGI,DGY,DGZ S DGZ=DGX,DGX=""
"RTN","DPTLK1",145,0)
 F DGI=1:1:$L(DGZ) S DGY=$E(DGZ,DGI) D
"RTN","DPTLK1",146,0)
 .S:DGY?1L DGY=$C($A(DGY)-32)
"RTN","DPTLK1",147,0)
 .S DGX=DGX_DGY
"RTN","DPTLK1",148,0)
 Q DGX
"RTN","DPTLK1",149,0)
 ;        
"RTN","DPTLK1",150,0)
SSN(DFN) ;do not show ssn identifier for patient
"RTN","DPTLK1",151,0)
 ; input DFN = ien in file #2 [required]
"RTN","DPTLK1",152,0)
 ; output SSN = nnnnnnnnn
"RTN","DPTLK1",153,0)
 ;
"RTN","DPTLK1",154,0)
 N SSN
"RTN","DPTLK1",155,0)
 S SSN="",DFN=+DFN
"RTN","DPTLK1",156,0)
 I DFN>0 D
"RTN","DPTLK1",157,0)
 .I $$SCREEN(DFN) S SSN="*SENSITIVE*" Q
"RTN","DPTLK1",158,0)
 .S SSN=$P($G(^DPT(DFN,0)),U,9)
"RTN","DPTLK1",159,0)
 Q SSN
"RTN","DPTLK1",160,0)
 ;
"RTN","DPTLK1",161,0)
DOB(DFN,DGYR) ;do not show dob identifier for patient
"RTN","DPTLK1",162,0)
 ; input DFN = ien in file #2  [required]
"RTN","DPTLK1",163,0)
 ;       DGYR = 0/1  [optional]
"RTN","DPTLK1",164,0)
 ;              where 0 returns 4-digit year (default)
"RTN","DPTLK1",165,0)
 ;                    1 returns 2-digit year
"RTN","DPTLK1",166,0)
 ;                    2 returns File manager date
"RTN","DPTLK1",167,0)
 ; output DOB = mm/dd/yyyy (default)
"RTN","DPTLK1",168,0)
 ;            = mm/dd/yy, if DGYR=1
"RTN","DPTLK1",169,0)
 ;            = yyymmdd, if DGYR=2
"RTN","DPTLK1",170,0)
 N B,DOB,YEAR
"RTN","DPTLK1",171,0)
 S DOB="",DFN=+DFN,DGYR=+$G(DGYR)
"RTN","DPTLK1",172,0)
 I DFN>0 D
"RTN","DPTLK1",173,0)
 .I $$SCREEN(DFN) S DOB="*SENSITIVE*" Q
"RTN","DPTLK1",174,0)
 .S B=$P($G(^DPT(DFN,0)),U,3)
"RTN","DPTLK1",175,0)
 .I DGYR'=2 D  Q
"RTN","DPTLK1",176,0)
 ..S YEAR=$S(DGYR=1:"2D",1:"5D")
"RTN","DPTLK1",177,0)
 ..S DOB=$$FMTE^XLFDT(B,YEAR)
"RTN","DPTLK1",178,0)
 .S DOB=B
"RTN","DPTLK1",179,0)
 Q DOB
"RTN","DPTLK1",180,0)
 ;
"RTN","DPTLK1",181,0)
SCREEN(DFN) ;Screening logic for SSN & DOB
"RTN","DPTLK1",182,0)
 ;Input  : DFN - Pointer to PATIENT file (#2)
"RTN","DPTLK1",183,0)
 ;Output : 1 - Apply screen
"RTN","DPTLK1",184,0)
 ;         0 - Don't apply screen
"RTN","DPTLK1",185,0)
 ;Notes  : Screen applied if patient is sensitive or an employee
"RTN","DPTLK1",186,0)
 ;
"RTN","DPTLK1",187,0)
 N DGTIME,DGT,DGA1,DG1,DGXFR0
"RTN","DPTLK1",188,0)
 ;Inpatient check - no longer used (kept for future reference)
"RTN","DPTLK1",189,0)
 ;D H^DGUTL S DGT=DGTIME D ^DGPMSTAT I DG1 Q 0
"RTN","DPTLK1",190,0)
 ;Sensitive - screen
"RTN","DPTLK1",191,0)
 I $P($G(^DGSL(38.1,DFN,0)),"^",2) Q 1
"RTN","DPTLK1",192,0)
 ;Employee - screen
"RTN","DPTLK1",193,0)
 I $$EMPL^DGSEC4(DFN) Q 1
"RTN","DPTLK1",194,0)
 ;Don't screen
"RTN","DPTLK1",195,0)
 Q 0
"RTN","DPTLK2")
0^2^B31148790
"RTN","DPTLK2",1,0)
DPTLK2 ;ALB/RMO - MAS Patient Look-up Add New Patient ; 2/8/05 8:13am
"RTN","DPTLK2",2,0)
 ;;5.3;Registration;**32,197,214,244,532,578,615,620,647,680**;Aug 13, 1993
"RTN","DPTLK2",3,0)
 N DPTCT,DGVV,DPTLIDR,DGCOL S DGCOL=0
"RTN","DPTLK2",4,0)
 I $D(DDS) D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY
"RTN","DPTLK2",5,0)
 I '$D(DUZ(0)) W:DIC(0)["Q" !?3,*7,"Unable to Add Patient. Your Fileman Access Code is undefined." S DPTDFN=-1 G Q
"RTN","DPTLK2",6,0)
 I $S($D(DLAYGO):2\1-(DLAYGO\1),1:1),DUZ(0)'="@",$D(^DIC(2,0,"LAYGO")) F I=1:1 I DUZ(0)[$E(^("LAYGO"),I) Q:I'>$L(^("LAYGO"))  S DPTDFN=-1 W:DIC(0)["Q" *7," ??" G Q
"RTN","DPTLK2",7,0)
 N DG20NAME S DG20NAME=DPTX,DPTX=$$FORMAT^XLFNAME7(.DG20NAME,3,30,,1)
"RTN","DPTLK2",8,0)
 S DPTX=$S($E(DPTX)[""""&($E(DPTX,$L(DPTX))[""""):$P(DPTX,"""",2),$E(DPTX)["""":$P(DPTX,"""",2),$E(DPTX,$L(DPTX))["""":$P(DPTX,"""",1),1:DPTX)
"RTN","DPTLK2",9,0)
 I $L(DPTX)<3!($L(DPTX)>30)!(DPTX?1P.E)!(DPTX'[",")!(DPTX'?1U.ANP) W:DIC(0)["Q" *7," ??" S DPTDFN=-1 G Q
"RTN","DPTLK2",10,0)
 ; DG*647
"RTN","DPTLK2",11,0)
 I $P($G(XQY0),U)="DG COLLATERAL PATIENT" S DGCOL=1,DGCOL("DR")=$P(DIC("DR"),";",5,8)
"RTN","DPTLK2",12,0)
 K DPTLID I DIC(0)["E" D ASKADD D  G Q:DPTDFN<0 I ('$D(DIC("DR")))!(DGCOL) D CHKID G Q:DPTDFN<0 D ^DPTLK3 G Q:DPTDFN<0 W !!?3,"...adding new patient"
"RTN","DPTLK2",13,0)
 .S:DPTDFN<1&('$D(DTOUT)) DUOUT=1
"RTN","DPTLK2",14,0)
 S X=DPTX,DPT("NO^")=$G(DIE("NO^")) K DD,DO,DPTX N DPTZNV
"RTN","DPTLK2",15,0)
 S:$D(DPT("DR")) DIC("DR")="S DIE(""NO^"")=""BACK"";"_DPT("DR")
"RTN","DPTLK2",16,0)
 I DGCOL S:$D(DPT("DR")) DIC("DR")=DPT("DR")_";"_DGCOL("DR")
"RTN","DPTLK2",17,0)
 D FILE^DICN K:$D(DPT("DR")) DIC("DR")
"RTN","DPTLK2",18,0)
 I +Y>0 W ?24,"...new patient added",!?3
"RTN","DPTLK2",19,0)
 S DPTDFN=Y S:$L(DPT("NO^")) DIE("NO^")=DPT("NO^")
"RTN","DPTLK2",20,0)
 ;offer prompt of patient file components
"RTN","DPTLK2",21,0)
 S DIE="^DPT(",DA=+Y,DR="S DIE(""NO^"")=""BACK"";.01///^S (X,DPTZNV)=$$NCEDIT^DPTNAME(DA,1,.DG20NAME)"
"RTN","DPTLK2",22,0)
 D ^DIE K DR
"RTN","DPTLK2",23,0)
 ;look for other (local) identifiers
"RTN","DPTLK2",24,0)
 I '$D(DIC("DR")),DIC(0)["E",'DGCOL D
"RTN","DPTLK2",25,0)
 .F DPTID=0:0 S DPTID=$O(^DD(2,0,"ID",DPTID)) Q:'DPTID  D
"RTN","DPTLK2",26,0)
 ..I $F(DPTGID,U_DPTID_U) Q
"RTN","DPTLK2",27,0)
 ..I '$D(^DD(2,DPTID,0)) Q
"RTN","DPTLK2",28,0)
 ..S DPTLID=""
"RTN","DPTLK2",29,0)
 ..S DPTLIDR=$S('$D(DPTLIDR):DPTID,1:DPTLIDR_";"_DPTID)
"RTN","DPTLK2",30,0)
 I $D(DPTLID) W !!?3,"Please enter the following additional information:",!?3 S DIE="^DPT(",DA=+DPTDFN,DIE("NO^")="BACK",DR=DPTLIDR D ^DIE K DIE,DA,DR
"RTN","DPTLK2",31,0)
 ;
"RTN","DPTLK2",32,0)
Q K DFN,DPT("DR"),DPTLID,DPTGID,DPTID,DPTID0,DPTIDS
"RTN","DPTLK2",33,0)
 Q
"RTN","DPTLK2",34,0)
 ;
"RTN","DPTLK2",35,0)
ASKADD I $D(DDS) I $Y>21 D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY
"RTN","DPTLK2",36,0)
 S Y=+$P(^DPT(0),U,4)+1 W !?3,*7,"ARE YOU ADDING ",$S(DPTX'?.N:"'"_DPTX_"' AS ",1:""),"A NEW PATIENT (THE ",Y,$S(Y#10=1&(Y#100-11):"ST",Y#10=2&(Y#100-12):"ND",Y#10=3&(Y#100-13):"RD",1:"TH"),")"
"RTN","DPTLK2",37,0)
 S %=2 D YN^DICN S DPTDFN=$S(%<0!(%=2):-1,%=1:1,1:0) I 'DPTDFN W !?6,"Enter 'YES' to add a new applicant, or 'NO' not to." G ASKADD
"RTN","DPTLK2",38,0)
 I %=1 S:$$CONF1^DPTNAME(DPTX)'=1 DPTDFN=-1
"RTN","DPTLK2",39,0)
 Q
"RTN","DPTLK2",40,0)
 ;
"RTN","DPTLK2",41,0)
CHKID K DFN S DPTDFN=1,DPTGID="^.02^.03^.09^391^1901^.301^994^" I DGCOL S DPTGID="^.03^.09^.02^.3601^"
"RTN","DPTLK2",42,0)
 F DPTCT=2:1 S DPTID=$P(DPTGID,U,DPTCT) Q:'DPTID!(DPTDFN<0)  D CHKID1
"RTN","DPTLK2",43,0)
 Q
"RTN","DPTLK2",44,0)
 ;
"RTN","DPTLK2",45,0)
CHKID1 I $D(^DD(2,DPTID,0)) S DPT("DR")=$S('$D(DPT("DR")):DPTID,1:DPT("DR")_";"_DPTID),DPTID0=^DD(2,DPTID,0) D ASKID S:'$D(X) DPTDFN=-1
"RTN","DPTLK2",46,0)
 Q
"RTN","DPTLK2",47,0)
 ;
"RTN","DPTLK2",48,0)
ASKID N DGREC W !?3,"PATIENT ",$P(DPTID0,U),": " R X:DTIME D  I $D(DTOUT)!$G(DUOUT)!($G(DGREC)=1) W !?6,*7,"<'",DPTX,"'> NOT ADDED" K X Q
"RTN","DPTLK2",49,0)
 .S:'$T DTOUT=U
"RTN","DPTLK2",50,0)
 .S:X="^" DUOUT=1
"RTN","DPTLK2",51,0)
 .Q:$D(DTOUT)!($G(DUOUT))
"RTN","DPTLK2",52,0)
 .I DPTID=.09 D
"RTN","DPTLK2",53,0)
 ..N DGNEWPT
"RTN","DPTLK2",54,0)
 ..S DGNEWPT=1
"RTN","DPTLK2",55,0)
 ..D REC^DGSEC
"RTN","DPTLK2",56,0)
 I X["^" W:$E(X)["^" !?6,*7,"Sorry, '^' not allowed!" W " ??" G ASKID
"RTN","DPTLK2",57,0)
 ; field 994 is not a required field
"RTN","DPTLK2",58,0)
 I DPTID=994 I X["?" D HLPID G ASKID
"RTN","DPTLK2",59,0)
 I DPTID=994 I X="" G SKIP
"RTN","DPTLK2",60,0)
 I X["?"!(X="") W:X="" *7," ??" D HLPID G ASKID
"RTN","DPTLK2",61,0)
 I $P(DPTID0,U,2)["S" F I=1:1 S Y=$P($P(DPTID0,U,3),";",I) K:Y="" X Q:Y=""  I $P(Y,":",1)=X!($E($P(Y,":",2),1,$L(X))=X) S X=$P(Y,":",1),DPTSET=$P(Y,":",2) Q
"RTN","DPTLK2",62,0)
SKIP I $P(DPTID0,U,2)["P" D P1 G ASKID:Y'>0 Q:'$D(X)  S DPTIDS(DPTID)=X,DPT("DR")=DPT("DR")_"///"_X K DPTSET Q
"RTN","DPTLK2",63,0)
 I DPTID=.301,$D(X) D CHKIT Q:'$D(X)  I $D(X) W:$D(DPTSET) " ",DPTSET S DPTIDS(DPTID)=X,DPT("DR")=DPT("DR")_"///"_X K DPTSET Q
"RTN","DPTLK2",64,0)
 I DPTID'=.301 X $P(DPTID0,U,5,99) I $D(X) W:$D(DPTSET) " ",DPTSET S DPTIDS(DPTID)=X,DPT("DR")=DPT("DR")_"///"_X K DPTSET Q
"RTN","DPTLK2",65,0)
 W:'$D(X)&($P(DPTID0,U,2)'["D") *7," ??" D HLPID G ASKID
"RTN","DPTLK2",66,0)
 ;
"RTN","DPTLK2",67,0)
HLPID W:$D(^DD(2,DPTID,.1)) !?5,^(.1) W:$D(^DD(2,DPTID,3)) !?5,^(3) I $D(X),X["?" F I=0:0 S I=$O(^DD(2,DPTID,21,I)) Q:'I!(I>3&(X?1"?"))  I $D(^(I,0)) W !?5,^(0) I I>2,X?1"?" W !?5,"..."
"RTN","DPTLK2",68,0)
 X:$D(^DD(2,DPTID,4)) ^(4) I $P(DPTID0,U,2)["D" S X="?",%DT="E" D ^%DT
"RTN","DPTLK2",69,0)
 I $P(DPTID0,U,2)["S" W !?7,"CHOOSE FROM: " F I=1:1 S Y=$P($P(DPTID0,U,3),";",I) Q:Y=""  W !?7,$P(Y,":",1),?15," ",$P(Y,":",2)
"RTN","DPTLK2",70,0)
 I $P(DPTID0,U,2)["P" D P1
"RTN","DPTLK2",71,0)
 Q
"RTN","DPTLK2",72,0)
P1 I DPTID=".3601" S X=$$UCASE^DPTLK1(X) ;DG*5.3*680
"RTN","DPTLK2",73,0)
 S DPTDIC=$G(DIC),DPTDIC(0)=$G(DIC(0)) S:$D(DIC("S")) DPTDIC("S")=DIC("S") S:$D(DIC("W")) DPTDIC("W")=DIC("W") S DIC="^"_$P(DPTID0,"^",3),DIC(0)="QEMZ",D="B" D IX^DIC
"RTN","DPTLK2",74,0)
 S DIC=DPTDIC,DIC(0)=DPTDIC(0) S:$D(DPTDIC("S")) DIC("S")=DPTDIC("S") S:$D(DPTDIC("W")) DIC("W")=DPTDIC("W") K DPTDIC D DO^DIC1 S:X["^" DPTDFN=-1 I X'["^",X'["?",Y'>0 S X="?" G P1
"RTN","DPTLK2",75,0)
 ; DG*5.3*680  S X=+Y stores the IEN of the sponsor picked to pass to FILE^DICN 
"RTN","DPTLK2",76,0)
 I DPTID=".3601" S X=+Y I '$D(^DPT(+Y,"VET"))!($P($G(^DPT(+Y,"VET")),U)'="Y") D EN^DDIOL("Sponsor must be a veteran","","!?4") K X W !?6,*7,"<'",DPTX,"'> NOT ADDED"
"RTN","DPTLK2",77,0)
 Q
"RTN","DPTLK2",78,0)
CHKIT ; do input transform for .301
"RTN","DPTLK2",79,0)
 I X'="Y" Q
"RTN","DPTLK2",80,0)
 S DGVV=DPTIDS(391),DGVV=$O(^DG(391,"B",DGVV,0))
"RTN","DPTLK2",81,0)
 S DGVV=$S($D(^DG(391,+DGVV,0)):$P(^(0),"^",2),1:"")
"RTN","DPTLK2",82,0)
 I DPTIDS(1901)'="Y",'DGVV D EN^DDIOL("Applicant is NOT a veteran!!","","!?4") K X W !?6,*7,"<'",DPTX,"'> NOT ADDED"
"RTN","DPTLK2",83,0)
 Q
"RTN","DPTLK2",84,0)
DEL ;Delete logic
"RTN","DPTLK2",85,0)
 N I,J,A,G,Q,ERR S Q="""",ERR=0 F I=0:0 S I=$O(^DD(2,0,"PT",I)) Q:'I  F J=0:0 S J=$O(^DD(2,0,"PT",I,J)) Q:'J  D
"RTN","DPTLK2",86,0)
  .F K=0:0 S K=$O(^DD(I,+J,1,K)) Q:'K  S A=$G(^(K,0)) I $L($P(A,U,2)),'$L($P(A,U,3)) D
"RTN","DPTLK2",87,0)
 ..S G=$G(^DIC(+I,0,"GL")) Q:'$L(G)  I $D(@(G_Q_$P(A,U,2)_Q_","_DA_")")) W !,"Entry in "_$P($G(^DIC(I,0)),U)_" ("_I_") refers to this patient" S ERR=1 Q
"RTN","DPTLK2",88,0)
 I ERR
"VER")
8.0^22.0
"BLD",5757,6)
^592
**END**
**END**
