Released TIU*1*155 SEQ #140
Extracted from mail message
**KIDS**:TIU*1.0*155^

**INSTALL NAME**
TIU*1.0*155
"BLD",4103,0)
TIU*1.0*155^TEXT INTEGRATION UTILITIES^0^3030228^y
"BLD",4103,1,0)
^^2^2^3021230^^^
"BLD",4103,1,1,0)
The description of this patch may be found in the  National Patch Module 
"BLD",4103,1,2,0)
under TIU*1.0*155.
"BLD",4103,4,0)
^9.64PA^^
"BLD",4103,"ABPKG")
n
"BLD",4103,"INID")
^
"BLD",4103,"INIT")

"BLD",4103,"KRN",0)
^9.67PA^8989.52^19
"BLD",4103,"KRN",.4,0)
.4
"BLD",4103,"KRN",.401,0)
.401
"BLD",4103,"KRN",.402,0)
.402
"BLD",4103,"KRN",.403,0)
.403
"BLD",4103,"KRN",.5,0)
.5
"BLD",4103,"KRN",.84,0)
.84
"BLD",4103,"KRN",3.6,0)
3.6
"BLD",4103,"KRN",3.8,0)
3.8
"BLD",4103,"KRN",9.2,0)
9.2
"BLD",4103,"KRN",9.8,0)
9.8
"BLD",4103,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",4103,"KRN",9.8,"NM",1,0)
TIURB^^0^B40166353
"BLD",4103,"KRN",9.8,"NM",2,0)
TIUPS155^^0^B12187205
"BLD",4103,"KRN",9.8,"NM","B","TIUPS155",2)

"BLD",4103,"KRN",9.8,"NM","B","TIURB",1)

"BLD",4103,"KRN",19,0)
19
"BLD",4103,"KRN",19.1,0)
19.1
"BLD",4103,"KRN",101,0)
101
"BLD",4103,"KRN",409.61,0)
409.61
"BLD",4103,"KRN",771,0)
771
"BLD",4103,"KRN",870,0)
870
"BLD",4103,"KRN",8989.51,0)
8989.51
"BLD",4103,"KRN",8989.52,0)
8989.52
"BLD",4103,"KRN",8994,0)
8994
"BLD",4103,"KRN","B",.4,.4)

"BLD",4103,"KRN","B",.401,.401)

"BLD",4103,"KRN","B",.402,.402)

"BLD",4103,"KRN","B",.403,.403)

"BLD",4103,"KRN","B",.5,.5)

"BLD",4103,"KRN","B",.84,.84)

"BLD",4103,"KRN","B",3.6,3.6)

"BLD",4103,"KRN","B",3.8,3.8)

"BLD",4103,"KRN","B",9.2,9.2)

"BLD",4103,"KRN","B",9.8,9.8)

"BLD",4103,"KRN","B",19,19)

"BLD",4103,"KRN","B",19.1,19.1)

"BLD",4103,"KRN","B",101,101)

"BLD",4103,"KRN","B",409.61,409.61)

"BLD",4103,"KRN","B",771,771)

"BLD",4103,"KRN","B",870,870)

"BLD",4103,"KRN","B",8989.51,8989.51)

"BLD",4103,"KRN","B",8989.52,8989.52)

"BLD",4103,"KRN","B",8994,8994)

"BLD",4103,"QUES",0)
^9.62^^
"BLD",4103,"REQB",0)
^9.611^2^2
"BLD",4103,"REQB",1,0)
TEXT INTEGRATION UTILITIES 1.0^2
"BLD",4103,"REQB",2,0)
TIU*1.0*109^2
"BLD",4103,"REQB","B","TEXT INTEGRATION UTILITIES 1.0",1)

"BLD",4103,"REQB","B","TIU*1.0*109",2)

"MBREQ")
0
"PKG",193,-1)
1^1
"PKG",193,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",193,20,0)
^9.402P^^
"PKG",193,22,0)
^9.49I^1^1
"PKG",193,22,1,0)
1.0^3010321^3010321^11
"PKG",193,22,1,"PAH",1,0)
155^3030228
"PKG",193,22,1,"PAH",1,1,0)
^^2^2^3030228
"PKG",193,22,1,"PAH",1,1,1,0)
The description of this patch may be found in the  National Patch Module 
"PKG",193,22,1,"PAH",1,1,2,0)
under TIU*1.0*155.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","TIUPS155")
0^2^B12187205
"RTN","TIUPS155",1,0)
TIUPS155 ; SLC/CAM - Amended consult note clean up ;2/26/03
"RTN","TIUPS155",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**155**;Jun 20,1997 
"RTN","TIUPS155",3,0)
 ; 
"RTN","TIUPS155",4,0)
 ; Disassociates the retracted consult note from the consult
"RTN","TIUPS155",5,0)
 ; Links the amended note to the consult
"RTN","TIUPS155",6,0)
 ; This routine should only need to be run once. It can be deleted after 
"RTN","TIUPS155",7,0)
 ; it has successfully completed.
"RTN","TIUPS155",8,0)
 ; DBIA 10035  ^DPT(  .01    NAME   0;1  Direct Global Read 
"RTN","TIUPS155",9,0)
 ; DBIA 3576   TIU use of GMRCTIU
"RTN","TIUPS155",10,0)
 ; DBIA 3162 POINT TO REQUEST/CONSULTATION (#123) FILE
"RTN","TIUPS155",11,0)
 ; 
"RTN","TIUPS155",12,0)
PRINT ; -- Device Selection
"RTN","TIUPS155",13,0)
 ;
"RTN","TIUPS155",14,0)
 S %ZIS="Q" D ^%ZIS I POP K POP G PRT
"RTN","TIUPS155",15,0)
 I $D(IO("Q")) K IO("Q") D  Q
"RTN","TIUPS155",16,0)
 . S ZTRTN="LINK^TIUPS155"
"RTN","TIUPS155",17,0)
 . S ZTDESC="TIU*1*155 - PRINT CLEAN-UP RESULTS"
"RTN","TIUPS155",18,0)
 . D ^%ZTLOAD W !,$S($D(ZTSK):"Request queued",1:"Request Cancelled!")
"RTN","TIUPS155",19,0)
 . K ZTSK,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,%ZIS
"RTN","TIUPS155",20,0)
 . D HOME^%ZIS
"RTN","TIUPS155",21,0)
 U IO D LINK,^%ZISC
"RTN","TIUPS155",22,0)
PRT Q
"RTN","TIUPS155",23,0)
 ;
"RTN","TIUPS155",24,0)
LINK ; Updates the GMR global with the amended consult note. Stores in XTMP global
"RTN","TIUPS155",25,0)
 ; Rollsback retracted note from ^GMR(123 node 50
"RTN","TIUPS155",26,0)
 N TIUDA,TIUDA2,STATUS,GMRCSTAT,TIUAUTH,FLAG
"RTN","TIUPS155",27,0)
 N CNSERV,TIUPT,TIUPT1,TIUCNT,CNSLT,TIUY,TIUODA
"RTN","TIUPS155",28,0)
 ;    Variables
"RTN","TIUPS155",29,0)
 ;  TIUPT = Patient DFN
"RTN","TIUPS155",30,0)
 ;  TIUPT1 = Patient name
"RTN","TIUPS155",31,0)
 ;  CNSERV = To consult service
"RTN","TIUPS155",32,0)
 ;  TIUDA = IEN of note in TIU "G" cross ref
"RTN","TIUPS155",33,0)
 ;  TIUDA2 = IEN of note in GMR "B" cross ref of 50 node
"RTN","TIUPS155",34,0)
 ;  TIUODA = IEN  of retracted note
"RTN","TIUPS155",35,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","TIUPS155",36,0)
 S U="^"
"RTN","TIUPS155",37,0)
 S TIUCNT=0,CNSLT=""
"RTN","TIUPS155",38,0)
 D HDR
"RTN","TIUPS155",39,0)
 F  S CNSLT=$O(^TIU(8925,"G",CNSLT)) Q:CNSLT=""  I CNSLT["GMR" D
"RTN","TIUPS155",40,0)
 .S TIUDA=0
"RTN","TIUPS155",41,0)
 .F  S TIUDA=$O(^TIU(8925,"G",CNSLT,TIUDA)) Q:TIUDA=""  D
"RTN","TIUPS155",42,0)
 ..S STATUS=$P($G(^TIU(8925,TIUDA,0)),U,5) I STATUS=8 D
"RTN","TIUPS155",43,0)
 ...S TIUY=+$$ISA^TIULX(+$G(^TIU(8925,TIUDA,0)),+$$CLASS^TIUCNSLT)
"RTN","TIUPS155",44,0)
 ...I TIUY=1 D
"RTN","TIUPS155",45,0)
 ....S TIUDA2=0
"RTN","TIUPS155",46,0)
 ....S FLAG="NO" F  S TIUDA2=$O(^GMR(123,+CNSLT,50,"B",TIUDA2)) Q:TIUDA2=""  I +TIUDA2=TIUDA S FLAG="YES" Q
"RTN","TIUPS155",47,0)
 ....I FLAG="NO" D
"RTN","TIUPS155",48,0)
 .....S TIUCNT=TIUCNT+1
"RTN","TIUPS155",49,0)
 .....S TIUODA=$P($G(^TIU(8925,TIUDA,14)),U,6)
"RTN","TIUPS155",50,0)
 .....S TIUPT=$P($G(^TIU(8925,TIUDA,0)),U,2)
"RTN","TIUPS155",51,0)
 .....S TIUPT1=$P($G(^DPT(TIUPT,0)),U) I $L(TIUPT1)<25 S TIUPT1=$$ADDSP(TIUPT1)
"RTN","TIUPS155",52,0)
 .....S CNSERV=$$GET1^DIQ(123,+CNSLT,1) I $L(CNSERV)<25 S CNSERV=$$ADDSP(CNSERV)
"RTN","TIUPS155",53,0)
 .....S ^XTMP("TIUP155",$J,TIUCNT)=$E(TIUPT1,1,25)_"   Consult No. "_+CNSLT
"RTN","TIUPS155",54,0)
 .....S GMRCSTAT=$S(STATUS>6:"COMPLETED",1:"INCOMPLETE")
"RTN","TIUPS155",55,0)
 .....S TIUAUTH=$P($G(^TIU(8925,TIUDA,12)),U,2)
"RTN","TIUPS155",56,0)
 .....D ROLLBACK^TIUCNSLT(TIUODA)
"RTN","TIUPS155",57,0)
 .....D GET^GMRCTIU(+CNSLT,TIUDA,GMRCSTAT,TIUAUTH)
"RTN","TIUPS155",58,0)
 .....W !,$E(TIUPT1,1,20),?22,$E(CNSERV,1,20),?45,+CNSLT
"RTN","TIUPS155",59,0)
 W !
"RTN","TIUPS155",60,0)
 I TIUCNT'>0 W !,"There are no records to print."
"RTN","TIUPS155",61,0)
 D MAIL
"RTN","TIUPS155",62,0)
 W !
"RTN","TIUPS155",63,0)
 Q
"RTN","TIUPS155",64,0)
ADDSP(TIUY) ; Add space to name for display.
"RTN","TIUPS155",65,0)
 ;
"RTN","TIUPS155",66,0)
 N SPC,LEN,ADSP,CNT
"RTN","TIUPS155",67,0)
 S SPC=" ",LEN=$L(TIUY),ADSP=25-LEN
"RTN","TIUPS155",68,0)
 F CNT=1:1:ADSP S TIUY=TIUY_SPC
"RTN","TIUPS155",69,0)
 Q TIUY
"RTN","TIUPS155",70,0)
MAIL ; Send mail message
"RTN","TIUPS155",71,0)
 ;
"RTN","TIUPS155",72,0)
 N XMSUB,XMTEXT,XMY,XMTXT,XMDUZ
"RTN","TIUPS155",73,0)
 S XMSUB="TIU*1*155 Amended Note - Consult Clean up Report",XMDUZ="Patch TIU*1*155"
"RTN","TIUPS155",74,0)
 I '$D(^XTMP("TIUP155")) S XMTXT(1)="",XMTXT(2)="",XMTXT(3)="There are no records to print.",XMTEXT="XMTXT("
"RTN","TIUPS155",75,0)
 I $D(^XTMP("TIUP155")) S XMTEXT="^XTMP(""TIUP155"",$J,"
"RTN","TIUPS155",76,0)
 S:$G(DUZ) XMY(DUZ)=""
"RTN","TIUPS155",77,0)
 S XMY("G.PATIENT SAFETY NOTIFICATIONS")=""
"RTN","TIUPS155",78,0)
 D ^XMD
"RTN","TIUPS155",79,0)
 Q
"RTN","TIUPS155",80,0)
HDR ;  --Header for report--
"RTN","TIUPS155",81,0)
 ;
"RTN","TIUPS155",82,0)
 W !,?2,"TIU*1.0*155 Amended Note - Consult Clean Up Report"
"RTN","TIUPS155",83,0)
 W !!,"The following consult(s) have been updated to display and print amended"
"RTN","TIUPS155",84,0)
 W !,"notes on the Consult Tab."
"RTN","TIUPS155",85,0)
 W !!,"Patient",?22,"Consult Request",?45,"Consult No.",!
"RTN","TIUPS155",86,0)
 Q
"RTN","TIURB")
0^1^B40166353
"RTN","TIURB",1,0)
TIURB ; SLC/JER - More Review Screen Actions ;FEB 26, 2003
"RTN","TIURB",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**4,32,52,78,58,100,109,155**;Jun 20, 1997
"RTN","TIURB",3,0)
 ; **100** Moved DELETE, DEL, DELTEXT, DIK to new rtn TIURB2
"RTN","TIURB",4,0)
 ; DBIA 3576 TIU use of GMRCTIU
"RTN","TIURB",5,0)
AMEND ; Amendment action
"RTN","TIURB",6,0)
 N TIUDA,DFN,DIE,DR,TIU,TIUDATA,TIUI,TIUSIG,TIUY,X,X1,Y
"RTN","TIURB",7,0)
 N DIROUT,TIUCHNG,TIUDAARY,TIULST
"RTN","TIURB",8,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB",9,0)
 S TIUI=0
"RTN","TIURB",10,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB",11,0)
 . N RSTRCTD
"RTN","TIURB",12,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB",13,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURB",14,0)
 . I RSTRCTD D  Q
"RTN","TIURB",15,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB",16,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB",17,0)
 . W !!,"Amending #",+TIUDATA
"RTN","TIURB",18,0)
 . S TIUCHNG=0
"RTN","TIURB",19,0)
 . D AMEND1
"RTN","TIURB",20,0)
 . I $G(TIUDAARY(TIUI)) D
"RTN","TIURB",21,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURB",22,0)
 ; -- Update or Rebuild list, restore video:
"RTN","TIURB",23,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB",24,0)
 S VALMBCK="R"
"RTN","TIURB",25,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"amended")
"RTN","TIURB",26,0)
 Q
"RTN","TIURB",27,0)
AMEND1 ; Single record amend
"RTN","TIURB",28,0)
 N TIUCMT,TIUT0,TIUTYP,TIUAMND,TIUSNM,TIUSBLK,TIUCSNM,TIUCSBLK,DIE,DR
"RTN","TIURB",29,0)
 N DA,DFN,DIWESUB,TIU,TIUODA,TIUTITL,TIUCLSS,TIUCON,TIUCNSLT
"RTN","TIURB",30,0)
 ; TIU*155 Gets consult data if exists
"RTN","TIURB",31,0)
 S TIUTITL=$P($G(^TIU(8925,TIUDA,0)),U)
"RTN","TIURB",32,0)
 S TIUCLSS=$$CLASS^TIUCNSLT()
"RTN","TIURB",33,0)
 S TIUCON=+$$ISA^TIULX(TIUTITL,TIUCLSS)
"RTN","TIURB",34,0)
 S TIUCNSLT=+$P($G(^TIU(8925,TIUDA,14)),U,5)
"RTN","TIURB",35,0)
 L +^TIU(8925,+TIUDA):1
"RTN","TIURB",36,0)
 E  D  Q
"RTN","TIURB",37,0)
 . W !?5,$C(7),"Another user is editing this entry." H 3
"RTN","TIURB",38,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",39,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)'>6 D  Q
"RTN","TIURB",40,0)
 . W !?5,$C(7),"Only SIGNED Documents may be amended."
"RTN","TIURB",41,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",42,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",43,0)
 I +$$HASIMG^TIURB2(TIUDA) D IMGNOTE^TIURB2 Q
"RTN","TIURB",44,0)
 S TIUAMND=$$CANDO^TIULP(TIUDA,"AMENDMENT")
"RTN","TIURB",45,0)
 I +TIUAMND'>0 D  Q
"RTN","TIURB",46,0)
 . W !!,$C(7),$C(7),$C(7),$P(TIUAMND,U,2),!
"RTN","TIURB",47,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",48,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",49,0)
 W !!,"Before proceeding, please enter your Electronic Signature Code..."
"RTN","TIURB",50,0)
 S TIUAMND=$$GETSIG^TIURD2
"RTN","TIURB",51,0)
 I +TIUAMND'>0 D  Q
"RTN","TIURB",52,0)
 . W !!,"  Ok, no harm done...",!
"RTN","TIURB",53,0)
 . S TIUCHNG("REFRESH")=1
"RTN","TIURB",54,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",55,0)
 W !!,"The ORIGINAL document will be RETRACTED, and a copy will be amended...",!
"RTN","TIURB",56,0)
 S TIUODA=TIUDA
"RTN","TIURB",57,0)
 S TIUDA=+$$RETRACT^TIURD2(TIUDA,"",7)
"RTN","TIURB",58,0)
 I '+TIUDA D  Q
"RTN","TIURB",59,0)
 . W !!,$C(7),$C(7),$C(7),"Retraction of Original Document Failed.",!
"RTN","TIURB",60,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURB",61,0)
 . S TIUDA=TIUODA,TIUCHNG("REFRESH")=1
"RTN","TIURB",62,0)
 L +^TIU(8925,TIUDA):1
"RTN","TIURB",63,0)
 E  D  Q
"RTN","TIURB",64,0)
 . W !?5,$C(7),"Another user is editing this entry."
"RTN","TIURB",65,0)
 . D RECOVER^TIURD4(TIUODA,TIUDA) H 3
"RTN","TIURB",66,0)
 . S TIUDA=TIUODA,TIUCHNG("REFRESH")=1
"RTN","TIURB",67,0)
 S TIUSNM=$$DECRYPT^TIULC1($P(^TIU(8925,TIUDA,15),U,3),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",68,0)
 S TIUSBLK=$$DECRYPT^TIULC1($P($G(^TIU(8925,TIUDA,15)),U,4),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",69,0)
 S TIUCSNM=$$DECRYPT^TIULC1($P(^TIU(8925,TIUDA,15),U,9),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",70,0)
 S TIUCSBLK=$$DECRYPT^TIULC1($P($G(^TIU(8925,TIUDA,15)),U,10),1,$$CHKSUM^TIULC("^TIU(8925,"_TIUDA_",""TEXT"")"))
"RTN","TIURB",71,0)
 S TIUTYP=+$G(^TIU(8925,+TIUDA,0)),TIUT0=$G(^TIU(8925.1,+TIUTYP,0))
"RTN","TIURB",72,0)
 S TIUTYP(1)="1^"_+TIUTYP_U_$P(TIUT0,U,3)_U
"RTN","TIURB",73,0)
 S DFN=$P($G(^TIU(8925,+TIUDA,0)),U,2)
"RTN","TIURB",74,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIURB",75,0)
 S DIWESUB="Patient: "_$G(TIU("PNM"))
"RTN","TIURB",76,0)
 S TIUCHNG=0 D FULL^VALM1,TEXTEDIT^TIUEDI4(TIUDA,.TIUCMT,.TIUCHNG)
"RTN","TIURB",77,0)
 I '+$G(TIUCHNG) D  Q
"RTN","TIURB",78,0)
 . L -^TIU(8925,TIUDA)
"RTN","TIURB",79,0)
 . D RECOVER^TIURD4(TIUODA,TIUDA)
"RTN","TIURB",80,0)
 . L -^TIU(8925,TIUODA) H 3
"RTN","TIURB",81,0)
 . S TIUDA=TIUODA,TIUCHNG("REFRESH")=1
"RTN","TIURB",82,0)
 I +$G(TIUCHNG) D
"RTN","TIURB",83,0)
 . S DR=".05///AMENDED;1601////"_$$NOW^XLFDT_";1602////"_DUZ,DA=TIUDA,TIUSIG=0
"RTN","TIURB",84,0)
 . S DR=DR_";1603////"_$$NOW^XLFDT_";1604///^S X=$$SIGNAME^TIULS(DUZ);1605///^S X=$$SIGTITL^TIULS(DUZ)",TIUSIG=1
"RTN","TIURB",85,0)
 . S DIE=8925 D ^DIE
"RTN","TIURB",86,0)
 . ; Refile /es/-block fields
"RTN","TIURB",87,0)
 . S DR="1503///^S X=TIUSNM;1504///^S X=TIUSBLK;1509///^S X=TIUCSNM;1510///^S X=TIUCSBLK"
"RTN","TIURB",88,0)
 . D ^DIE
"RTN","TIURB",89,0)
 ; Drop Locks on both documents
"RTN","TIURB",90,0)
 L -^TIU(8925,+TIUDA)
"RTN","TIURB",91,0)
 L -^TIU(8925,+TIUODA)
"RTN","TIURB",92,0)
 S TIUDAARY(TIUI)=TIUDA
"RTN","TIURB",93,0)
 S TIUCHNG("RBLD")=1
"RTN","TIURB",94,0)
 ; TIU*155 If note is associated with a consult update ^GMR global
"RTN","TIURB",95,0)
 ; to include the amended note
"RTN","TIURB",96,0)
 ; Rollback retracted note from ^GMR(123 node 50
"RTN","TIURB",97,0)
 I $G(TIUCON)=1 D
"RTN","TIURB",98,0)
 . N STATUS,GMRCSTAT,TIUAUTH
"RTN","TIURB",99,0)
 . S STATUS=$P($G(^TIU(8925,TIUDA,0)),U,5)
"RTN","TIURB",100,0)
 . S GMRCSTAT=$S(STATUS>6:"COMPLETED",1:"INCOMPLETE")
"RTN","TIURB",101,0)
 . S TIUAUTH=$P($G(^TIU(8925,TIUDA,12)),U,2)
"RTN","TIURB",102,0)
 . D ROLLBACK^TIUCNSLT(TIUODA)
"RTN","TIURB",103,0)
 . D GET^GMRCTIU(TIUCNSLT,TIUDA,GMRCSTAT,TIUAUTH)
"RTN","TIURB",104,0)
 Q
"RTN","TIURB",105,0)
SENDBACK ; Send back a Document to transcription
"RTN","TIURB",106,0)
 N TIUDA,DFN,TIU,TIUDATA,TIUCHNG,TIUI,TIUY,Y,DIROUT,TIULST
"RTN","TIURB",107,0)
 N TIUDAARY
"RTN","TIURB",108,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB",109,0)
 S TIUI=0
"RTN","TIURB",110,0)
 I +$O(VALMY(0)) D CLEAR^VALM1
"RTN","TIURB",111,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB",112,0)
 . N TIU,RSTRCTD
"RTN","TIURB",113,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB",114,0)
 . S TIUDA=+$P(TIUDATA,U,2) S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURB",115,0)
 . I RSTRCTD D  Q
"RTN","TIURB",116,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB",117,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB",118,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURB",119,0)
 . S TIUCHNG=0
"RTN","TIURB",120,0)
 . D EN^VALM("TIU SEND BACK")
"RTN","TIURB",121,0)
 . I +$G(TIUCHNG) D
"RTN","TIURB",122,0)
 . . S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURB",123,0)
SENDX ; Revise list and cycle back as appropriate
"RTN","TIURB",124,0)
 I $G(TIUCHNG("ADDM"))!$G(TIUCHNG("DELETE")) S TIUCHNG("RBLD")=1
"RTN","TIURB",125,0)
 E  S TIUCHNG("UPDATE")=1
"RTN","TIURB",126,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB",127,0)
 S VALMBCK="R"
"RTN","TIURB",128,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"sent back")
"RTN","TIURB",129,0)
 Q
"RTN","TIURB",130,0)
LINK ; Link to problem(s)
"RTN","TIURB",131,0)
 N TIUCHNG,TIUDA,DFN,TIU,TIUDATA,TIUEDIT,TIUI,TIUY,TIULST,Y,DIROUT
"RTN","TIURB",132,0)
 N TIUDAARY
"RTN","TIURB",133,0)
 I '$D(VALMY) D EN^VALM2(XQORNOD(0))
"RTN","TIURB",134,0)
 S TIUI=0
"RTN","TIURB",135,0)
 I +$O(VALMY(0)) D CLEAR^VALM1
"RTN","TIURB",136,0)
 F  S TIUI=$O(VALMY(TIUI)) Q:+TIUI'>0  D  Q:$D(DIROUT)
"RTN","TIURB",137,0)
 . N TIU,VALMY,XQORM,VA,VADM,GMPDFN,GMPLUSER,RSTRCTD
"RTN","TIURB",138,0)
 . S TIUDATA=$G(^TMP("TIURIDX",$J,TIUI))
"RTN","TIURB",139,0)
 . S TIUDA=+$P(TIUDATA,U,2),GMPLUSER=1
"RTN","TIURB",140,0)
 . I '$D(^TIU(8925,+TIUDA,0)) D  Q
"RTN","TIURB",141,0)
 . . W !,$C(7),"Document no longer exists.",!
"RTN","TIURB",142,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURB",143,0)
 . S RSTRCTD=$$DOCRES^TIULRR(TIUDA)
"RTN","TIURB",144,0)
 . I RSTRCTD D  Q
"RTN","TIURB",145,0)
 . . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIURB",146,0)
 . . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIURB",147,0)
 . S TIUDAARY(TIUI)=TIUDA
"RTN","TIURB",148,0)
 . S DFN=+$P($G(^TIU(8925,+TIUDA,0)),U,2)
"RTN","TIURB",149,0)
 . I +DFN D DEM^VADPT S GMPDFN=DFN_U_VADM(1)_U_$E(VADM(1))_VA("BID")
"RTN","TIURB",150,0)
 . S TIUCHNG=0
"RTN","TIURB",151,0)
 . D EN^VALM("TIU LINK TO PROBLEM")
"RTN","TIURB",152,0)
 . I +$G(TIUCHNG) S TIULST=$G(TIULST)_$S($G(TIULST)]"":",",1:"")_TIUI
"RTN","TIURB",153,0)
LINKX ; Revise list and cycle back as appropriate
"RTN","TIURB",154,0)
 S TIUCHNG("REFRESH")=1
"RTN","TIURB",155,0)
 D UPRBLD^TIURL(.TIUCHNG,.VALMY) K VALMY
"RTN","TIURB",156,0)
 S VALMBCK="R"
"RTN","TIURB",157,0)
 D VMSG^TIURS1($G(TIULST),.TIUDAARY,"linked to problems")
"RTN","TIURB",158,0)
 Q
"RTN","TIURB",159,0)
DEL(DA) ; -- Call to DEL for backward compatibility
"RTN","TIURB",160,0)
 G GODEL^TIURB2
"RTN","TIURB",161,0)
 Q
"VER")
8.0^22.0
**END**
**END**
