Released XU*8*81 SEQ #71
Extracted from mail message
**KIDS**:XU*8.0*81^

**INSTALL NAME**
XU*8.0*81
"BLD",56,0)
XU*8.0*81^KERNEL^0^^y
"BLD",56,4,0)
^9.64PA^^
"BLD",56,"KRN",0)
^9.67PA^19^18
"BLD",56,"KRN",.4,0)
.4
"BLD",56,"KRN",.401,0)
.401
"BLD",56,"KRN",.402,0)
.402
"BLD",56,"KRN",.403,0)
.403
"BLD",56,"KRN",.5,0)
.5
"BLD",56,"KRN",.84,0)
.84
"BLD",56,"KRN",3.6,0)
3.6
"BLD",56,"KRN",3.8,0)
3.8
"BLD",56,"KRN",9.2,0)
9.2
"BLD",56,"KRN",9.8,0)
9.8
"BLD",56,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",56,"KRN",9.8,"NM",1,0)
XPDIJ^^0^B34917788
"BLD",56,"KRN",9.8,"NM",2,0)
XQ8^^0^B18831114
"BLD",56,"KRN",9.8,"NM",3,0)
XQ81^^0^B31328734
"BLD",56,"KRN",9.8,"NM",4,0)
XPDID^^0^B5560565
"BLD",56,"KRN",9.8,"NM",5,0)
XPDUTL^^0^B11436481
"BLD",56,"KRN",9.8,"NM","B","XPDID",4)

"BLD",56,"KRN",9.8,"NM","B","XPDIJ",1)

"BLD",56,"KRN",9.8,"NM","B","XPDUTL",5)

"BLD",56,"KRN",9.8,"NM","B","XQ8",2)

"BLD",56,"KRN",9.8,"NM","B","XQ81",3)

"BLD",56,"KRN",19,0)
19
"BLD",56,"KRN",19,"NM",0)
^9.68A^^
"BLD",56,"KRN",19.1,0)
19.1
"BLD",56,"KRN",101,0)
101
"BLD",56,"KRN",409.61,0)
409.61
"BLD",56,"KRN",771,0)
771
"BLD",56,"KRN",869.2,0)
869.2
"BLD",56,"KRN",870,0)
870
"BLD",56,"KRN",8994,0)
8994
"BLD",56,"KRN","B",.4,.4)

"BLD",56,"KRN","B",.401,.401)

"BLD",56,"KRN","B",.402,.402)

"BLD",56,"KRN","B",.403,.403)

"BLD",56,"KRN","B",.5,.5)

"BLD",56,"KRN","B",.84,.84)

"BLD",56,"KRN","B",3.6,3.6)

"BLD",56,"KRN","B",3.8,3.8)

"BLD",56,"KRN","B",9.2,9.2)

"BLD",56,"KRN","B",9.8,9.8)

"BLD",56,"KRN","B",19,19)

"BLD",56,"KRN","B",19.1,19.1)

"BLD",56,"KRN","B",101,101)

"BLD",56,"KRN","B",409.61,409.61)

"BLD",56,"KRN","B",771,771)

"BLD",56,"KRN","B",869.2,869.2)

"BLD",56,"KRN","B",870,870)

"BLD",56,"KRN","B",8994,8994)

"BLD",56,"QUES",0)
^9.62^^
"BLD",56,"REQB",0)
^9.611^^
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
81
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","XPDID")
0^4^B5560565
"RTN","XPDID",1,0)
XPDID ;SFISC/VYD,RSD - Display Install Progress ;05/14/98  10:29
"RTN","XPDID",2,0)
 ;;8.0;KERNEL;**81**;Jul 10, 1995
"RTN","XPDID",3,0)
 ;;
"RTN","XPDID",4,0)
 Q
"RTN","XPDID",5,0)
INIT ;initialize progress screen
"RTN","XPDID",6,0)
 N X,XPDSTR
"RTN","XPDID",7,0)
 I IO'=IO(0)!(IOST'["C-VT") S XPDIDVT=0 Q
"RTN","XPDID",8,0)
 I $T(PREP^XGF)="" S XPDIDVT=0 Q
"RTN","XPDID",9,0)
 ;S X="XGF" X ^%ZOSF("TEST") E  S XPDIDVT=0 Q
"RTN","XPDID",10,0)
 D PREP^XGF
"RTN","XPDID",11,0)
 S XPDIDVT=1,X="IOSTBM",XPDSTR="             25             50             75               "
"RTN","XPDID",12,0)
 D ENDR^%ZISS
"RTN","XPDID",13,0)
 S IOTM=3,IOBM=IOSL-4
"RTN","XPDID",14,0)
 W @IOSTBM
"RTN","XPDID",15,0)
 D FRAME^XGF(IOTM-2,0,IOTM-2,IOM-1)
"RTN","XPDID",16,0)
 D FRAME^XGF(IOBM,0,IOBM,IOM-1)
"RTN","XPDID",17,0)
 D FRAME^XGF(IOBM+1,10,IOBM+3,71)
"RTN","XPDID",18,0)
 D SAY^XGF(IOBM+2,11,XPDSTR)
"RTN","XPDID",19,0)
 D SAY^XGF(IOBM+2,0,$J("0",5)_"%")
"RTN","XPDID",20,0)
 D SAY^XGF(IOBM+3,0,"Complete")
"RTN","XPDID",21,0)
 D IOXY^XGF(IOTM-2,0)
"RTN","XPDID",22,0)
 Q
"RTN","XPDID",23,0)
 ;
"RTN","XPDID",24,0)
EXIT(XPDM) ;exit progress screen restore screen to normal
"RTN","XPDID",25,0)
 I $G(XPDIDVT) D
"RTN","XPDID",26,0)
 .S IOTM=1,IOBM=IOSL
"RTN","XPDID",27,0)
 .W @IOSTBM,@IOF
"RTN","XPDID",28,0)
 .W:$G(XPDM)]"" !!,XPDM,!!
"RTN","XPDID",29,0)
 .D CLEAN^XGF
"RTN","XPDID",30,0)
 K IOTM,IOBM,IOSTBM,XPDIDCNT,XPDIDMOD,XPDIDTOT,XPDIDVT
"RTN","XPDID",31,0)
 Q
"RTN","XPDID",32,0)
 ;
"RTN","XPDID",33,0)
TITLE(X) ;display title X
"RTN","XPDID",34,0)
 Q:'XPDIDVT
"RTN","XPDID",35,0)
 N XPDOX,XPDOY
"RTN","XPDID",36,0)
 S XPDOX=$X,XPDOY=$Y
"RTN","XPDID",37,0)
 D SAY^XGF(0,0,$$CJ^XLFSTR(X,IOM_"T")),CURSOR
"RTN","XPDID",38,0)
 Q
"RTN","XPDID",39,0)
 ;
"RTN","XPDID",40,0)
SETTOT(X) ;X=file # from build
"RTN","XPDID",41,0)
 Q:'$D(XPDIDVT)
"RTN","XPDID",42,0)
 S XPDIDTOT=$S(X=4:+$P($G(^XTMP("XPDI",XPDA,"BLD",XPDBLD,4,0)),U,4),X=9.8:+$G(^XTMP("XPDI",XPDA,"RTN")),1:+$P($G(^XTMP("XPDI",XPDA,"BLD",XPDBLD,"KRN",X,"NM",0)),U,4))
"RTN","XPDID",43,0)
 S XPDIDMOD=$S(XPDIDTOT<60:1,1:XPDIDTOT\60),XPDIDCNT=0
"RTN","XPDID",44,0)
 Q:'XPDIDVT
"RTN","XPDID",45,0)
 D UPDATE(0)
"RTN","XPDID",46,0)
 Q
"RTN","XPDID",47,0)
 ;
"RTN","XPDID",48,0)
UPDATE(XPDN) ;update the progress bar
"RTN","XPDID",49,0)
 I 'XPDIDVT W "." Q
"RTN","XPDID",50,0)
 N XPDLEN,XPDMC,XPDOX,XPDOY,XPDS,XPDSTR
"RTN","XPDID",51,0)
 S XPDOX=$X,XPDOY=$Y,XPDMC=60,XPDSTR="             25             50             75               "
"RTN","XPDID",52,0)
 S XPDLEN=$S(XPDIDTOT:XPDN/XPDIDTOT*XPDMC\1,1:0),XPDS=$E(XPDSTR,1,XPDLEN)
"RTN","XPDID",53,0)
 D SAY^XGF(IOBM+2,11,XPDS,"R1")
"RTN","XPDID",54,0)
 S XPDS=$E(XPDSTR,XPDLEN+1,XPDMC)
"RTN","XPDID",55,0)
 D SAY^XGF(IOBM+2,11+XPDLEN,XPDS)
"RTN","XPDID",56,0)
 D SAY^XGF(IOBM+2,0,$J(XPDLEN/XPDMC*100,5,0)),CURSOR
"RTN","XPDID",57,0)
 Q
"RTN","XPDID",58,0)
 ;
"RTN","XPDID",59,0)
CURSOR ;put cursor back
"RTN","XPDID",60,0)
 S:XPDOY>(IOBM-1) XPDOY=IOBM-1
"RTN","XPDID",61,0)
 D IOXY^XGF(XPDOY,XPDOX)
"RTN","XPDID",62,0)
 Q
"RTN","XPDIJ")
0^1^B34917788
"RTN","XPDIJ",1,0)
XPDIJ ;SFISC/RSD - Install Job ;06/03/98  13:22
"RTN","XPDIJ",2,0)
 ;;8.0;KERNEL;**2,21,28,41,44,68,81**;Jul 10, 1995
"RTN","XPDIJ",3,0)
EN ;install all packages
"RTN","XPDIJ",4,0)
 ;XPDA=ien of first package
"RTN","XPDIJ",5,0)
 ;this is needed to restore XPDIJ1
"RTN","XPDIJ",6,0)
 I $D(^XTMP("XPDI",XPDA,"RTN","XPDIJ1")) D
"RTN","XPDIJ",7,0)
 .N DIE,XCM,XCN,XCS,X
"RTN","XPDIJ",8,0)
 .S DIE="^XTMP(""XPDI"",XPDA,""RTN"",""XPDIJ1"",",XCN=0,X="XPDIJ1"
"RTN","XPDIJ",9,0)
 .X ^%ZOSF("SAVE")
"RTN","XPDIJ",10,0)
 .S XCN=$$RTNUP^XPDUTL("XPDIJ1",2)
"RTN","XPDIJ",11,0)
 N IEN,XPDI,XPD0,XPDSET,XPDABORT,XPDMENU,XPDQUIT,XPDVOL,X,Y,ZTRTN,ZTDTH,ZTIO,ZTDESC,ZTSK
"RTN","XPDIJ",12,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XPDIJ"
"RTN","XPDIJ",13,0)
 E  S X="ERR^XPDIJ",@^%ZOSF("TRAP")
"RTN","XPDIJ",14,0)
 Q:'$D(^XPD(9.7,+$G(XPDA),0))  S XPD0=^(0)
"RTN","XPDIJ",15,0)
 D INIT^XPDID
"RTN","XPDIJ",16,0)
 ;disable options & protocols for setname, XPDSET=1/0^setname^out of order msg.
"RTN","XPDIJ",17,0)
 S Y=$P(XPD0,U,8),XPDSET=+Y_U_$E(Y,2,99)_U_$S($L(Y):$P($G(^XTMP("XQOO",$E(Y,2,99),0)),U),1:"")
"RTN","XPDIJ",18,0)
 ;hang the number of seconds given in 0;10
"RTN","XPDIJ",19,0)
 I XPDSET D OFF^XQOO1($P(XPDSET,U,2)) I $P(XPD0,U,10) H ($P(XPD0,U,10)*60)
"RTN","XPDIJ",20,0)
 ;XPDVOL is set only if they want to update other CPUs
"RTN","XPDIJ",21,0)
 I $O(^XPD(9.7,XPDA,"VOL",0)) M XPDVOL=^XPD(9.7,XPDA,"VOL") D
"RTN","XPDIJ",22,0)
 .S Y=0
"RTN","XPDIJ",23,0)
 .F  S Y=$O(XPDVOL(Y)) Q:'Y  S $P(XPDVOL(Y,0),U,2,3)="^" K XPDVOL(Y,1)
"RTN","XPDIJ",24,0)
 .;jobup RTN^XPDIJ(XPDA), to install routines on other CPU if Taskman is running
"RTN","XPDIJ",25,0)
 .;check that taskman is running
"RTN","XPDIJ",26,0)
 .D:$$TM^%ZTLOAD
"RTN","XPDIJ",27,0)
 ..N XPDU,XPDY,XPDV,XPDV0,XPDVOL,ZTUCI,ZTCPU,ZTDESC,ZTRTN,ZTDTH,ZTIO,ZTSK
"RTN","XPDIJ",28,0)
 ..X ^%ZOSF("UCI") S XPDU=$P(Y,","),XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",29,0)
 ..F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=$P(^(XPDV,0),U) D:XPDV0'=XPDY
"RTN","XPDIJ",30,0)
 ...S ZTUCI=XPDU,ZTDTH=$H,ZTIO="",ZTDESC="KIDS update CPUs "_XPDV0,ZTCPU=XPDV0,ZTRTN="EN^XPDCPU("_XPDA_","_XPDV_")"
"RTN","XPDIJ",31,0)
 ...D ^%ZTLOAD
"RTN","XPDIJ",32,0)
 ...;save task number under Volume set multiple
"RTN","XPDIJ",33,0)
 ...Q:'$G(ZTSK)  K XPD
"RTN","XPDIJ",34,0)
 ...S XPD(9.703,XPDV_","_XPDA_",",3)=ZTSK D FILE^DIE("","XPD")
"RTN","XPDIJ",35,0)
 S Y=0
"RTN","XPDIJ",36,0)
 ;XPDABORT can be set in pre or post install to abort install
"RTN","XPDIJ",37,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S %=$O(^(Y,0)) D:%  Q:$D(XPDABORT)
"RTN","XPDIJ",38,0)
 .;build volume multiple for each package
"RTN","XPDIJ",39,0)
 .I $D(XPDVOL),'$D(^XPD(9.7,%,"VOL")) M ^("VOL")=XPDVOL
"RTN","XPDIJ",40,0)
 .N XPD,XPDA,XPDNM,XPDV,XPDV0,XPDVOL,XPDX,XPDY,Y
"RTN","XPDIJ",41,0)
 .S XPDA=%,XPDNM=$P($G(^XPD(9.7,XPDA,0)),U) D IN^XPDIJ1 Q:$D(XPDABORT)
"RTN","XPDIJ",42,0)
 .;check status of other cpu jobs, do if not this volume
"RTN","XPDIJ",43,0)
 .X ^%ZOSF("UCI") S XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",44,0)
 .F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=^(XPDV,0) D:$P(XPDV0,U)'=XPDY
"RTN","XPDIJ",45,0)
 ..;if completed time,write message and quit
"RTN","XPDIJ",46,0)
 ..I $P(XPDV0,U,2) D BMES^XPDUTL(" Job on VOLUME SET "_$P(XPDV0,U)_" Completed.") Q
"RTN","XPDIJ",47,0)
 ..;if job had no start time, write message and quit
"RTN","XPDIJ",48,0)
 ..I '$P(XPDV0,U,3) D  I '$P(XPDV0,U,3)  D VOLERR($P(XPDV0,U),1) Q
"RTN","XPDIJ",49,0)
 ...D BMES^XPDUTL(" Waiting for job on VOLUME SET "_$P(XPDV0,U)_" to start.")
"RTN","XPDIJ",50,0)
 ...;hang 1 minute, try 5 times
"RTN","XPDIJ",51,0)
 ...F %=1:1:5 H 60 S XPDV0=^XPD(9.7,XPDA,"VOL",XPDV,0) Q:$P(XPDV0,U,3)
"RTN","XPDIJ",52,0)
 ..D BMES^XPDUTL(" Waiting for job on VOLUME SET "_$P(XPDV0,U)_" to complete.")
"RTN","XPDIJ",53,0)
 ..S XPD=0,XPDX=$G(^XPD(9.7,XPDA,"VOL",XPDV,1))
"RTN","XPDIJ",54,0)
 ..;check the last update node
"RTN","XPDIJ",55,0)
 ..F  S Y=$P(^XPD(9.7,XPDA,"VOL",XPDV,0),U,2),X=$G(^(1)),XPD=XPD+1 Q:XPD>360!Y  S:X'=XPDX XPD=0,XPDX=X H 10
"RTN","XPDIJ",56,0)
 ..;quit if we have a complete time
"RTN","XPDIJ",57,0)
 ..I Y D BMES^XPDUTL(" Job on VOLUME SET "_$P(XPDV0,U)_" Completed.") Q
"RTN","XPDIJ",58,0)
 ..D VOLERR($P(XPDV0,U),0)
"RTN","XPDIJ",59,0)
 ;ZTREQ tells taskman to delete task
"RTN","XPDIJ",60,0)
 I $G(ZTSK) S ZTREQ="@" D
"RTN","XPDIJ",61,0)
 .;remove task # from Install File
"RTN","XPDIJ",62,0)
 .N XPD S XPD(9.7,XPDA_",",5)="@"
"RTN","XPDIJ",63,0)
 .D FILE^DIE("","XPD")
"RTN","XPDIJ",64,0)
 ;quit if install was aborted
"RTN","XPDIJ",65,0)
 I $D(XPDABORT) D EXIT^XPDID("Install Aborted!!"),^%ZISC Q
"RTN","XPDIJ",66,0)
 ;put option back in order
"RTN","XPDIJ",67,0)
 I $P(XPDSET,U,2)]"" D ON^XQOO1($P(XPDSET,U,2)) K ^XTMP("XQOO",$P(XPDSET,U,2))
"RTN","XPDIJ",68,0)
 ;check if an option was added
"RTN","XPDIJ",69,0)
 S IEN=$O(^XTMP("XPDI",XPDA,"BLD",0))
"RTN","XPDIJ",70,0)
 S Y=$O(^XTMP("XPDI",XPDA,"BLD",IEN,"KRN",19,"NM",0))
"RTN","XPDIJ",71,0)
 ;queue menu rebuild if an option was added
"RTN","XPDIJ",72,0)
 D:Y MENU
"RTN","XPDIJ",73,0)
 ;clean up globals
"RTN","XPDIJ",74,0)
 S Y=0
"RTN","XPDIJ",75,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S XPDI=$O(^(Y,0)) D:XPDI
"RTN","XPDIJ",76,0)
 .N Y,XPD
"RTN","XPDIJ",77,0)
 .;kill transport global
"RTN","XPDIJ",78,0)
 .K ^XTMP("XPDI",XPDI)
"RTN","XPDIJ",79,0)
 .;update the status field
"RTN","XPDIJ",80,0)
 .S XPD(9.7,XPDI_",",.02)=3
"RTN","XPDIJ",81,0)
 .D FILE^DIE("","XPD")
"RTN","XPDIJ",82,0)
 D EXIT^XPDID("Install Completed"),^%ZISC
"RTN","XPDIJ",83,0)
 Q
"RTN","XPDIJ",84,0)
 ;
"RTN","XPDIJ",85,0)
MENU ;rebuild menus on current CPU
"RTN","XPDIJ",86,0)
 S XPDMENU=1
"RTN","XPDIJ",87,0)
 D:$G(XPDIDVT)
"RTN","XPDIJ",88,0)
 .N DIR
"RTN","XPDIJ",89,0)
 .S DIR("A",1)=" "
"RTN","XPDIJ",90,0)
 .S DIR("A",2)=" An Option(s) has been added by this build."
"RTN","XPDIJ",91,0)
 .S DIR("A",3)=" Electing to rebuild menus now is highly recommended."
"RTN","XPDIJ",92,0)
 .S DIR("A",4)=" "
"RTN","XPDIJ",93,0)
 .S DIR("A")=" Do you want to rebuild Menu's now"
"RTN","XPDIJ",94,0)
 .S DIR(0)="Y"
"RTN","XPDIJ",95,0)
 .S DIR("B")="Y"
"RTN","XPDIJ",96,0)
 .D ^DIR S XPDMENU=+Y
"RTN","XPDIJ",97,0)
 Q:'XPDMENU
"RTN","XPDIJ",98,0)
 D KIDS^XQ81
"RTN","XPDIJ",99,0)
 ;check if need to queue menu rebuild on other CPUs
"RTN","XPDIJ",100,0)
 D:$O(^XPD(9.7,XPDA,"VOL",0))
"RTN","XPDIJ",101,0)
 .N XPDU,XPDY,XPDV,XPDV0,ZTUCI,ZTCPU
"RTN","XPDIJ",102,0)
 .X ^%ZOSF("UCI") S XPDU=$P(Y,","),XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",103,0)
 .;loop thru VOLUMES SET and don't do current volume set
"RTN","XPDIJ",104,0)
 .F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=$P(^(XPDV,0),U) D:XPDV0'=XPDY
"RTN","XPDIJ",105,0)
 ..S ZTUCI=XPDU,ZTDTH=$H,ZTIO="",ZTDESC="Install Menu Rebuild",ZTCPU=XPDV0,ZTRTN="KIDS^XQ81" D ^%ZTLOAD
"RTN","XPDIJ",106,0)
 Q
"RTN","XPDIJ",107,0)
 ;
"RTN","XPDIJ",108,0)
SAVE(X) ;restore routine X
"RTN","XPDIJ",109,0)
 N %,DIE,XCM,XCN,XCS
"RTN","XPDIJ",110,0)
 S DIE="^XTMP(""XPDI"",XPDA,""RTN"",X,",XCN=0
"RTN","XPDIJ",111,0)
 X ^%ZOSF("SAVE")
"RTN","XPDIJ",112,0)
 Q
"RTN","XPDIJ",113,0)
RTN(XPDA) ;restore all routines for package XPDA
"RTN","XPDIJ",114,0)
 ;^XPD("XPDI",XPDA,"RTN",routine name)=0-install, 1-delete, 2-skip^checksum
"RTN","XPDIJ",115,0)
 Q:$G(XPDA)=""
"RTN","XPDIJ",116,0)
 N X,XPDI,XPDJ S XPDI=""
"RTN","XPDIJ",117,0)
 F  S XPDI=$O(^XTMP("XPDI",XPDA,"RTN",XPDI)) Q:XPDI=""  S XPDJ=^(XPDI) D
"RTN","XPDIJ",118,0)
 .;if we are doing VT graphic display, set counter
"RTN","XPDIJ",119,0)
 .I $D(XPDIDVT) S XPDIDCNT=XPDIDCNT+1 D:'(XPDIDCNT#XPDIDMOD) UPDATE^XPDID(XPDIDCNT)
"RTN","XPDIJ",120,0)
 .I 'XPDJ D SAVE(XPDI) Q
"RTN","XPDIJ",121,0)
 .;set checksum to null, since routine wasn't loaded
"RTN","XPDIJ",122,0)
 .I $P(XPDJ,U,2) S $P(^XTMP("XPDI",XPDA,"BLD",XPDBLD,"KRN",9.8,"NM",$P(XPDJ,U,2),0),U,4)=""
"RTN","XPDIJ",123,0)
 .I $P(XPDJ,U)=1 S X=XPDI X ^%ZOSF("DEL")
"RTN","XPDIJ",124,0)
 ;if graphic display, update full count
"RTN","XPDIJ",125,0)
 I $D(XPDIDVT) D UPDATE^XPDID(XPDIDCNT)
"RTN","XPDIJ",126,0)
 Q
"RTN","XPDIJ",127,0)
 ;
"RTN","XPDIJ",128,0)
VOLERR(V,F) ;volume set not updated,V=volume set, F=flag
"RTN","XPDIJ",129,0)
 N XQA,XQAMSG,XPDMES
"RTN","XPDIJ",130,0)
 S XPDMES(1)=" ",XPDMES(2)=" ** Job on VOLUME SET "_V_$S(F:" never started **",1:" has been idle for an hour.")
"RTN","XPDIJ",131,0)
 S XPDMES(3)=" ** "_V_" has NOT been updated! **"
"RTN","XPDIJ",132,0)
 S XQA(DUZ)="",XQAMSG="VOLUME SET "_V_" NOT updated for Install "_$E($P($G(^XPD(9.7,+$G(XPDA),0)),"^"),1,30)
"RTN","XPDIJ",133,0)
 D MES^XPDUTL(.XPDMES),SETUP^XQALERT
"RTN","XPDIJ",134,0)
 Q
"RTN","XPDIJ",135,0)
 ;come here on error, record error in Install file and cleanup var.
"RTN","XPDIJ",136,0)
ERR N XPDERROR,XQA,XQAMSG
"RTN","XPDIJ",137,0)
 S XPDERROR=$$EC^%ZOSV
"RTN","XPDIJ",138,0)
 ;record error, write message, reset terminal
"RTN","XPDIJ",139,0)
 D ^%ZTER,BMES^XPDUTL(XPDERROR),EXIT^XPDID()
"RTN","XPDIJ",140,0)
 S XQA(DUZ)="",XQAMSG="Install "_$E($P($G(^XPD(9.7,+$G(XPDA),0)),"^"),1,30)_" has encountered an Error."
"RTN","XPDIJ",141,0)
 D SETUP^XQALERT G UNWIND^%ZTER
"RTN","XPDUTL")
0^5^B11436481
"RTN","XPDUTL",1,0)
XPDUTL ;SFISC/RSD - KIDS utilities ;06/23/98  10:21
"RTN","XPDUTL",2,0)
 ;;8.0;KERNEL;**21,28,39,81**;Jul 10, 1995
"RTN","XPDUTL",3,0)
 Q
"RTN","XPDUTL",4,0)
VERSION(X) ;Get current version from Package file, X=package name or
"RTN","XPDUTL",5,0)
 ;package namespace
"RTN","XPDUTL",6,0)
 N I
"RTN","XPDUTL",7,0)
 S I=$O(^DIC(9.4,"C",X,0)) S:I'>0 I=$O(^DIC(9.4,"B",X,0))
"RTN","XPDUTL",8,0)
 Q $P($G(^DIC(9.4,+I,"VERSION")),"^")
"RTN","XPDUTL",9,0)
 ;
"RTN","XPDUTL",10,0)
VER(X) ;returns version number from Build file, X=build name
"RTN","XPDUTL",11,0)
 Q:X["*" $P(X,"*",2)
"RTN","XPDUTL",12,0)
 Q $P(X," ",$L(X," "))
"RTN","XPDUTL",13,0)
 ;
"RTN","XPDUTL",14,0)
PKG(X) ;returns package name from Build file, X=build name
"RTN","XPDUTL",15,0)
 Q $S(X["*":$P(X,"*"),1:$P(X," ",1,$L(X," ")-1))
"RTN","XPDUTL",16,0)
 ;
"RTN","XPDUTL",17,0)
PATCH(X) ;return 1 if patch X was installed, X=aaaa*nn.nn*nnn
"RTN","XPDUTL",18,0)
 Q:X'?1.4U1"*"1.2N1"."1.2N.1(1"V",1"T").2N1"*"1.3N 0
"RTN","XPDUTL",19,0)
 N %,I,J
"RTN","XPDUTL",20,0)
 S I=$O(^DIC(9.4,"C",$P(X,"*"),0)) Q:'I 0
"RTN","XPDUTL",21,0)
 S J=$O(^DIC(9.4,I,22,"B",$P(X,"*",2),0)),X=$P(X,"*",3) Q:'J 0
"RTN","XPDUTL",22,0)
 ;check if patch is just a number
"RTN","XPDUTL",23,0)
 Q:$O(^DIC(9.4,I,22,J,"PAH","B",X,0)) 1
"RTN","XPDUTL",24,0)
 S %=$O(^DIC(9.4,I,22,J,"PAH","B",X_" SEQ"))
"RTN","XPDUTL",25,0)
 Q (X=+%)
"RTN","XPDUTL",26,0)
 ;
"RTN","XPDUTL",27,0)
NEWCP(XPD,XPDC,XPDP) ;create new check point, returns 0=error or ien
"RTN","XPDUTL",28,0)
 ;XPD=name, XPDC=call back, XPDP=parameters
"RTN","XPDUTL",29,0)
 Q:$G(XPD)="" 0
"RTN","XPDUTL",30,0)
 N %,XPDI,XPDJ,XPDF,XPDY
"RTN","XPDUTL",31,0)
 ;XPDCP="INI"=Pre-init, "INIT"=Post-init
"RTN","XPDUTL",32,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713)
"RTN","XPDUTL",33,0)
 S %=$$FIND1^DIC(XPDI,","_XPDA_",","X",XPD) Q:% %
"RTN","XPDUTL",34,0)
 S XPDF="+1,"_XPDA_",",XPDJ(XPDI,XPDF,.01)=XPD
"RTN","XPDUTL",35,0)
 S:$D(XPDC) XPDJ(XPDI,XPDF,2)=XPDC
"RTN","XPDUTL",36,0)
 S:$D(XPDP) XPDJ(XPDI,XPDF,3)=XPDP
"RTN","XPDUTL",37,0)
 D UPDATE^DIE("","XPDJ","XPDY")
"RTN","XPDUTL",38,0)
 Q $G(XPDY(1))
"RTN","XPDUTL",39,0)
 ;
"RTN","XPDUTL",40,0)
UPCP(XPD,XPDP) ;update check point, returns 0=error or ien
"RTN","XPDUTL",41,0)
 ;XPD=name, XPDP=parameters
"RTN","XPDUTL",42,0)
 N XPDI,XPDJ,XPDF,XPDY
"RTN","XPDUTL",43,0)
 ;XPDCP="INI"=Pre-init, "INIT"=Post-init
"RTN","XPDUTL",44,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",45,0)
 Q:'XPDY 0
"RTN","XPDUTL",46,0)
 S XPDF=XPDY_","_XPDA_","
"RTN","XPDUTL",47,0)
 S:$D(XPDP) XPDJ(XPDI,XPDF,3)=XPDP
"RTN","XPDUTL",48,0)
 D FILE^DIE("","XPDJ")
"RTN","XPDUTL",49,0)
 Q XPDY
"RTN","XPDUTL",50,0)
 ;
"RTN","XPDUTL",51,0)
COMCP(XPD) ;complete check point, returns 0=error or date/time
"RTN","XPDUTL",52,0)
 ;XPD=name
"RTN","XPDUTL",53,0)
 N XPDD,XPDI,XPDJ,XPDY
"RTN","XPDUTL",54,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",55,0)
 Q:'XPDY 0
"RTN","XPDUTL",56,0)
 S XPDD=$$NOW^XLFDT,XPDJ(XPDI,XPDY_","_XPDA_",",1)=XPDD
"RTN","XPDUTL",57,0)
 D FILE^DIE("","XPDJ")
"RTN","XPDUTL",58,0)
 Q XPDD
"RTN","XPDUTL",59,0)
 ;
"RTN","XPDUTL",60,0)
VERCP(XPD) ;verify check point, returns 1=completed, 0=not
"RTN","XPDUTL",61,0)
 ;-1=doesn't exist
"RTN","XPDUTL",62,0)
 ;XPD=name
"RTN","XPDUTL",63,0)
 N XPDI,XPDY
"RTN","XPDUTL",64,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",65,0)
 Q:'XPDY -1
"RTN","XPDUTL",66,0)
 Q ''$$GET1^DIQ(XPDI,XPDY_","_XPDA_",",1,"I")
"RTN","XPDUTL",67,0)
 ;
"RTN","XPDUTL",68,0)
PARCP(XPD,XPDF) ;returns parameters of check point
"RTN","XPDUTL",69,0)
 ;XPD=name, XPDF="PRE"
"RTN","XPDUTL",70,0)
 N XPDI,XPDY
"RTN","XPDUTL",71,0)
 I $G(XPDF)="PRE" N XPDCP S XPDCP="INI"
"RTN","XPDUTL",72,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",73,0)
 Q:'XPDY 0
"RTN","XPDUTL",74,0)
 Q $$GET1^DIQ(XPDI,XPDY_","_XPDA_",",3,"I")
"RTN","XPDUTL",75,0)
 ;
"RTN","XPDUTL",76,0)
CURCP(XPDF) ;returns current check point
"RTN","XPDUTL",77,0)
 ;XPDF flag - 0=externel, 1=internal
"RTN","XPDUTL",78,0)
 Q $S($G(XPDF):XPDCHECK,1:XPDCHECK(0))
"RTN","XPDUTL",79,0)
 ;
"RTN","XPDUTL",80,0)
WP(X) ;X=global ref
"RTN","XPDUTL",81,0)
 N %
"RTN","XPDUTL",82,0)
 Q:'$D(@X)
"RTN","XPDUTL",83,0)
 F %=1:1 Q:'$D(@X@(%))  W !,@X@(%)
"RTN","XPDUTL",84,0)
 Q:'$G(XPDA)  D WP^DIE(9.7,XPDA_",",20,"A",X)
"RTN","XPDUTL",85,0)
 Q
"RTN","XPDUTL",86,0)
MES(X) ;record message, X=message or an array passed by reference
"RTN","XPDUTL",87,0)
 N %
"RTN","XPDUTL",88,0)
 I $D(X)#2 S %=X K X S X(1)=%
"RTN","XPDUTL",89,0)
 ;write message
"RTN","XPDUTL",90,0)
 F %=1:1 Q:'$D(X(%))  W !,X(%)
"RTN","XPDUTL",91,0)
 Q:'$G(XPDA)  D WP^DIE(9.7,XPDA_",",20,"A","X")
"RTN","XPDUTL",92,0)
 Q
"RTN","XPDUTL",93,0)
BMES(X) ;add blank line before message
"RTN","XPDUTL",94,0)
 N %
"RTN","XPDUTL",95,0)
 I $D(X)#2 S %=X K X S X(1)=" ",X(2)=%
"RTN","XPDUTL",96,0)
 D MES(.X)
"RTN","XPDUTL",97,0)
 Q
"RTN","XPDUTL",98,0)
RTNUP(X,Y) ;update routine action, X=routine, Y=action
"RTN","XPDUTL",99,0)
 ;actions:  1=delete, 2=skip
"RTN","XPDUTL",100,0)
 N %
"RTN","XPDUTL",101,0)
 ;set action to Y
"RTN","XPDUTL",102,0)
 Q:'$G(Y)!'$D(^XTMP("XPDI",$G(XPDA),"RTN",X)) 0 S $P(^(X),U)=+Y
"RTN","XPDUTL",103,0)
 Q 1
"RTN","XPDUTL",104,0)
 ;get Build ien
"RTN","XPDUTL",105,0)
 S Y=$O(^XTMP("XPDI",XPDA,"BLD",0))
"RTN","XPDUTL",106,0)
 ;remove checksum when updating action, since action can only be
"RTN","XPDUTL",107,0)
 ;delete or skip, not sure if we want to do this
"RTN","XPDUTL",108,0)
 S:$P(%,U,2) $P(^XTMP("XPDI",XPDA,"BLD",Y,"KRN",9.8,"NM",$P(%,U,2),0),U,4)=""
"RTN","XPDUTL",109,0)
 Q 1
"RTN","XPDUTL",110,0)
DICCP(X) ;lookup check point, returns ien or 0
"RTN","XPDUTL",111,0)
 Q:$G(X)="" 0
"RTN","XPDUTL",112,0)
 ;if they pass ien, fail if can't find
"RTN","XPDUTL",113,0)
 I X=+X S Y=X Q:'$D(^XPD(9.7,XPDA,XPDCP,Y,0)) 0
"RTN","XPDUTL",114,0)
 E  S Y=$$FIND1^DIC(XPDI,","_XPDA_",","X",X)
"RTN","XPDUTL",115,0)
 Q Y
"RTN","XPDUTL",116,0)
 ;
"RTN","XPDUTL",117,0)
PRODE(XPDN,XPD) ;enable/disable protocols, return 1 for success
"RTN","XPDUTL",118,0)
 ;XPDN=protocol name, XPD=1-enable, 0-disable
"RTN","XPDUTL",119,0)
 Q:$G(XPDN)="" 0
"RTN","XPDUTL",120,0)
 S XPD=+$G(XPD)
"RTN","XPDUTL",121,0)
 D KIDS^XQOO1($P(XPDSET,U,2),101,XPDN,.XPD)
"RTN","XPDUTL",122,0)
 Q $S(XPD<0:0,1:1)
"RTN","XPDUTL",123,0)
 ;
"RTN","XPDUTL",124,0)
OPTDE(XPDN,XPD) ;enable/disable options, return 1 for success
"RTN","XPDUTL",125,0)
 ;XPDN=protocol name, XPD=1-enable, 0-disable
"RTN","XPDUTL",126,0)
 Q:$G(XPDN)="" 0
"RTN","XPDUTL",127,0)
 S XPD=+$G(XPD)
"RTN","XPDUTL",128,0)
 D KIDS^XQOO1($P(XPDSET,U,2),19,XPDN,.XPD)
"RTN","XPDUTL",129,0)
 Q $S(XPD<0:0,1:1)
"RTN","XQ8")
0^2^B18831114
"RTN","XQ8",1,0)
XQ8 ;SEA/AMF,MJM - Build menu trees ;05/14/98  10:29
"RTN","XQ8",2,0)
 ;;8.0;KERNEL;**81**;Jul 10, 1995
"RTN","XQ8",3,0)
 ;
"RTN","XQ8",4,0)
TIME ;See if there are prohibited times for this option
"RTN","XQ8",5,0)
 S %XQI=$P(^DIC(19,Y,0),U,9) I $L(%XQI)>2 S XQP(L)=%XQI_"MO-FR"
"RTN","XQ8",6,0)
 I $D(^DIC(19,Y,3.91)) S %XQI=0 F  S %XQI=$O(^DIC(19,Y,3.91,%XQI)) Q:%XQI'>0  S XQP(L)=$S($D(XQP(L)):XQP(L)_";",1:"")_$P(^(%XQI,0),U,1)_$P(^(0),U,2)
"RTN","XQ8",7,0)
 K %XQI I '$D(XQP(L)),$L($P(Y(0),U,9)) S XQP(L)=$P(Y(0),U,9)
"RTN","XQ8",8,0)
 Q
"RTN","XQ8",9,0)
UP F Z=1:1 Q:X?.NUP  S W=$A(X,Z) I W<123,W>96 S X=$E(X,1,Z-1)_$C(W-32)_$E(X,Z+1,255)
"RTN","XQ8",10,0)
 Q
"RTN","XQ8",11,0)
CHK S XQRE=$D(^XUTL("XQO",XQDIC,"^BUILD")) I XQRE,($P($H,",",2)-^("^BUILD")>1800)!(^("^BUILD")>$P($H,",",2)) K ^("^BUILD") S XQRE=0
"RTN","XQ8",12,0)
 Q
"RTN","XQ8",13,0)
PMO ;Called from XQ71+21
"RTN","XQ8",14,0)
 D CHK W !,$S(XQRE:"I'M REBUILDING",1:"I NEED TO REBUILD")," MENUS .... QUICK ACCESS IS TEMPORARILY DISABLED" W:$D(XQMMJ) !!,"Please proceed to '",$E(XQMMJ,2,99),"'" K XQMMJ,XQMM I XQRE K XQRE Q
"RTN","XQ8",15,0)
 Q
"RTN","XQ8",16,0)
PM2 D:$D(XQCON) CHK S:'$D(XQRE) XQRE=0 Q:XQRE  K ^XUTL("XQO",XQDIC) S ^XUTL("XQO",XQDIC,"^BUILD")=$P($H,",",2) G:$D(XQFG1) REBLD
"RTN","XQ8",17,0)
 S ZTIO="",ZTRTN="REBLD^XQ8",ZTDTH=$H,ZTSAVE("XQDIC")="",ZTDESC="Rebuild Menu "_XQDIC D ^%ZTLOAD Q
"RTN","XQ8",18,0)
 ;
"RTN","XQ8",19,0)
REBLD K XQFG1 S U="^",UU="^^" ;Taskman entry
"RTN","XQ8",20,0)
 S:'$D(XQDATE) XQDATE=$H
"RTN","XQ8",21,0)
 I XQDIC'="PXU" S Y=+$P(XQDIC,"P",2) Q:Y'>0  Q:'$D(^DIC(19,Y,0))
"RTN","XQ8",22,0)
 I '$D(XQXUF) K ^XUTL("XQO","PXU") S XQSAV=XQDIC S XQDIC="PXU",Y=$O(^DIC(19,"B","XUCOMMAND",0)) S:Y>0 %="",(L,X(0))=0,(XQPX,XQD)=Y D:Y>0 TREE1,PMOK S XQDIC=XQSAV,XQXUF=1,^XUTL("XQO","PXU",0)=XQDATE
"RTN","XQ8",23,0)
 S Y=$P(XQDIC,"P",2) G:Y'>0!'$D(^DIC(19,+Y,0)) PMOKA I Y>0,$D(^DIC(19,Y,0)),$P(^(0),U,4)="M" D PMOK S %="",(L,X(0))=0,XQD=Y D TREE1
"RTN","XQ8",24,0)
 S:$D(^DIC(19,$E(XQDIC,2,99),0)) ^(99.1)=XQDATE S ^XUTL("XQO",XQDIC,0)=XQDATE
"RTN","XQ8",25,0)
 S Y=+$P(XQDIC,"P",2)
"RTN","XQ8",26,0)
 I Y>0 S (XQD,%)=^DIC(19,Y,0),L=1,XQP(L)="" D TIME S ^XUTL("XQO",XQDIC,U,Y)=U_$P(%,U,1,2)_U_$S(($P(%,U,3)]""):1,1:"")_U_$P(%,U,4)_UU_$P(%,U,6,8)_U_XQP(L)_U_$P(%,U,10,99)
"RTN","XQ8",27,0)
 I Y>0,'$D(^DIC(19,Y,"U")) S XQFL=0 S:$D(X)#2 XQSAVE=X,XQFL=1 S X=$E($P(^DIC(19,+Y,0),U,2),1,30) D UP S ^("U")=X S:XQFL X=XQSAVE
"RTN","XQ8",28,0)
 I Y>0 S ^XUTL("XQO",XQDIC,^DIC(19,Y,"U")_U)=Y_"^0"
"RTN","XQ8",29,0)
PMOKA K ^XUTL("XQO",XQDIC,"^BUILD") I '$D(XQFG),$D(ZTSK) K ^%ZTSK(ZTSK)
"RTN","XQ8",30,0)
PMOK K %,XQA,XQD,XQE,XQF,XQFL,XQP,XQR,XQRE,XQSAVE
"RTN","XQ8",31,0)
 Q
"RTN","XQ8",32,0)
TREE ;
"RTN","XQ8",33,0)
 S X(L)=$O(^DIC(19,XQD,10,X(L))) Q:X(L)'>0  S Y=^(X(L),0),%=$P(Y,U,2),Y=+Y G:$D(XQR(Y))!'$D(^DIC(19,Y,0)) TREE S XQR(Y)="" I $D(XQFG),'$D(XQNTREE) W:'(Y#5) "."
"RTN","XQ8",34,0)
TREE1 S Y(0)=^DIC(19,Y,0),X=$S($D(^("U")):^("U"),1:"") I X="" S X=$E($P(Y(0),U,2),1,30) D UP S ^("U")=X
"RTN","XQ8",35,0)
 S Y(1)=X S:'$L($P(Y(0),U,5)) $P(Y(0),U,5)=0
"RTN","XQ8",36,0)
 G:$L($P(Y(0),U,3)) TREE S:$L($P(Y(0),U,6)) XQK(L)=$P(Y(0),U,6) S XQA(L)=Y S:$L($P(Y(0),U,10)) XQE(L)=$P(Y(0),U,10)
"RTN","XQ8",37,0)
 S:$P(Y(0),U,16) XQF(L)=$P(^DIC(19,Y,3),U) I $D(XQF(L)) K:XQF(L)="" XQF(L)
"RTN","XQ8",38,0)
 D TIME,PMOSET S L=L+1,X(L)=0,(XQD,XQD(L))=Y D TREE
"RTN","XQ8",39,0)
 Q:L<2  K XQR(XQD(L)) S L=L-1 K XQA(L),XQK(L),XQP(L),XQE(L),XQF(L) S XQD=XQD(L) G TREE
"RTN","XQ8",40,0)
 ;
"RTN","XQ8",41,0)
PMOSET ;
"RTN","XQ8",42,0)
 S K=0,X=$E(Y(1),1,27) I $L(X) S X=X_U D:$D(^XUTL("XQO",XQDIC,X))!$D(^(X_"1")) PMO3 S:L&'K ^XUTL("XQO",XQDIC,X)=Y_"^1"
"RTN","XQ8",43,0)
 I $D(%),$L(%) S X=%,K=0 D UP Q:'$L(X)  S X=X_U D:$D(^XUTL("XQO",XQDIC,X))!$D(^(X_"1")) PMO3 S:L&'K ^XUTL("XQO",XQDIC,X)=Y_"^0"
"RTN","XQ8",44,0)
 S (XQA,XQK,XQP,XQE,XQF)="" F D="XQA","XQK","XQP","XQE","XQF" F I=1:1:L I $D(@(D_"(I)")) S @D=@D_@(D_"(I)")_","
"RTN","XQ8",45,0)
 I '$D(^XUTL("XQO",XQDIC,"^",Y)) S ^(Y)=U_$P(Y(0),U,1,2)_U_$S(($P(Y(0),U,3)]""):1,1:"")_U_$P(Y(0),U,4)_U_XQA_U_XQK_U_$P(Y(0),U,7,8)_U_XQP_U_XQE_U_$P(Y(0),U,11,15)_U_XQF_U_$P(Y(0),U,17,99) Q
"RTN","XQ8",46,0)
 S %=$S('$D(^XUTL("XQO",XQDIC,"^",Y,0)):1,1:^(0)+1),^(0)=%,^(0,%)=XQA_U_XQK_U_XQP_U_XQE_U_XQF
"RTN","XQ8",47,0)
 Q
"RTN","XQ8",48,0)
PMO3 ;
"RTN","XQ8",49,0)
 S D=X,K=$S($D(^XUTL("XQO",XQDIC,X)):(Y=+^(X)),1:0) F  S V=$O(^XUTL("XQO",XQDIC,D)) Q:K!($P(V,U,1)'=$P(X,U,1))  S D=V S:Y=+^(V) K=1
"RTN","XQ8",50,0)
 I 'K S I=$P(D,U,2) S:'$L(I) I=0 I I=0 S ^(X_"1")=^XUTL("XQO",XQDIC,X) K ^(X) S I=1
"RTN","XQ8",51,0)
 I 'K S X=X_(I+1)
"RTN","XQ8",52,0)
 Q
"RTN","XQ8",53,0)
 ;BUILD moved to XQ81
"RTN","XQ8",54,0)
 Q
"RTN","XQ81")
0^3^B31328734
"RTN","XQ81",1,0)
XQ81 ;SEA/AMF,SF/RWF - Build menu trees ;05/28/98  11:19
"RTN","XQ81",2,0)
 ;;8.0;KERNEL;**81**;Jul 10, 1995
"RTN","XQ81",3,0)
BUILD ;
"RTN","XQ81",4,0)
 ;
"RTN","XQ81",5,0)
RD2 K XQFG W !!,"This option will build menu trees for each primary and secondary menu.",!,"You may build all the trees, or build them selectively, using 'verify'.",!,"Note that the 'compiled menus' will only be built into ^XUTL on this CPU.",!
"RTN","XQ81",6,0)
 S DIR(0)="Y",DIR("A")="Do you wish to verify each primary menu",DIR("B")="NO",DIR("??")="XQBUILDTREE-VER" D ^DIR K DIR G:$D(DIRUT) BLDEND S XQVE=(Y=1)
"RTN","XQ81",7,0)
 S DIR(0)="Y",DIR("A")="Would you like to build secondary menu trees too",DIR("B")="YES",DIR("??")="XQBUILDTREE-SEC" D ^DIR G:$D(DIRUT) BLDEND S XQBSEC=(Y=1)
"RTN","XQ81",8,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Would you like to queue this job",DIR("B")="YES" D ^DIR K DIR G:$D(DIRUT) BLDEND I Y=1 S ZTRTN="DQ^XQ81",ZTIO="",ZTSAVE("XQVE")="",ZTSAVE("XQBSEC")="",ZTDESC="Build menu tree" D ^%ZTLOAD K ZTSK G BLDEND
"RTN","XQ81",9,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Do you really wish to run this DIRECTLY (it may take some time)",DIR("B")="NO" D ^DIR K DIR G:$D(DIRUT) BLDEND G:Y'=1 RD2
"RTN","XQ81",10,0)
 ;
"RTN","XQ81",11,0)
KIDS ;Entry from KIDS
"RTN","XQ81",12,0)
 I '$D(XQVE) S XQFG=0,XQBSEC=1,XQVE=0
"RTN","XQ81",13,0)
 N XQNTREE,XQNDONE S (XQNTREE,XQNDONE)=0
"RTN","XQ81",14,0)
 ;
"RTN","XQ81",15,0)
 ;Set up the error trap so we can clear the screen if it blows
"RTN","XQ81",16,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XQ81"
"RTN","XQ81",17,0)
 E  S X="ERR^XQ81",@^%ZOSF("TRAP")
"RTN","XQ81",18,0)
 ;
"RTN","XQ81",19,0)
 ;Set up the bar graph and window if not from KIDS
"RTN","XQ81",20,0)
 I '$D(XPDNM) D INIT^XPDID
"RTN","XQ81",21,0)
 I XPDIDVT D
"RTN","XQ81",22,0)
 .I $D(XPDIDTOT) S XQSAVTOT=XPDIDTOT
"RTN","XQ81",23,0)
 .S X="Rebuilding Menus" D TITLE^XPDID(X)
"RTN","XQ81",24,0)
 .S XPDIDTOT=50 ;Number of divisions in bar graph
"RTN","XQ81",25,0)
 .D UPDATE^XPDID(0)
"RTN","XQ81",26,0)
 .Q
"RTN","XQ81",27,0)
 ;
"RTN","XQ81",28,0)
 W !!,"Starting Menu Rebuild:  ",$$HTE^XLFDT($H)
"RTN","XQ81",29,0)
 S XQFG=0 W !!,"Collecting primary menus in the New Person file..."
"RTN","XQ81",30,0)
DQ ;Entry from taskman  Write if $D(XQFG)
"RTN","XQ81",31,0)
 S ^XUTL("XQO","P0")="",XQSEC=1,XQ81T="" I 'XQVE H 1
"RTN","XQ81",32,0)
 S XQI="" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:XQI'=+XQI!(XQI="")  I $D(^XUTL("XQO",XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",33,0)
 S XQI="U" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:"U"'[$E(XQI)!(XQI="")  I $D(^XUTL("XQO",XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",34,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:"P"'[$E(XQI)!(XQI="")  I $D(^XUTL("XQO",XQI,0))#2,$L(^(0)) S XQ81T=^(0) Q
"RTN","XQ81",35,0)
 S:XQ81T="" XQ81T="Unknown"
"RTN","XQ81",36,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:"P"'[$E(XQI)!(XQI="")  I "P"[$E(XQI),XQI'="P0" K ^XUTL("XQO",XQI)
"RTN","XQ81",37,0)
 ;
"RTN","XQ81",38,0)
 ;Find the various trees and put them into ^TMP($J), and count them
"RTN","XQ81",39,0)
 S:'$D(XQH) XQH=$H K ^TMP($J) S XQI=.5 F XQK=0:0 S XQI=$O(^VA(200,XQI)) Q:XQI'=+XQI  I $D(^VA(200,XQI,0)),$L($P(^VA(200,XQI,0),U,3)) D SET
"RTN","XQ81",40,0)
 ;
"RTN","XQ81",41,0)
 S (XQNTREE,%)=0 F  S %=$O(^TMP($J,%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",42,0)
 S %=0 F  S %=$O(^TMP($J,"SEC",%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",43,0)
 ;
"RTN","XQ81",44,0)
 W:$D(XQFG) !!?20,"Primary menus found in the New Person file",!?20,"------------------------------------------"
"RTN","XQ81",45,0)
 W:$D(XQFG) !!,"OPTION NAME         MENU TEXT",?49,"# OF",?62,"LAST",?71,"LAST",!?49,"USERS",?62,"USED",?71,"BUILT",!
"RTN","XQ81",46,0)
 S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,XQBLD)) Q:XQBLD'>0!(X=U)  I $D(^DIC(19,XQBLD,0)) S XQJ=^DIC(19,XQBLD,0) D VER
"RTN","XQ81",47,0)
 S XQSEC=0 I $D(XQFG),XQBSEC W !!,"Building secondary menu trees...."
"RTN","XQ81",48,0)
 I XQBSEC S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,"SEC",XQBLD)) Q:XQBLD'>0  D SEC
"RTN","XQ81",49,0)
 K ^XUTL("XQO","P0") I 'XQVE S XQK="P" F XQBLD=0:0 S XQK=$O(^XUTL("XQO",XQK)) Q:XQK'["P"  S ^(XQK,0)=XQH
"RTN","XQ81",50,0)
 G BLDEND
"RTN","XQ81",51,0)
 ;
"RTN","XQ81",52,0)
SEC S XQL="P"_XQBLD Q:$D(^XUTL("XQO",XQL))  D RD3 Q
"RTN","XQ81",53,0)
 S XQL="P" F XQN=0:0 S XQL=$O(^XUTL("XQO",XQL)) Q:$E(XQL)'="P"  I $D(^XUTL("XQO",XQL,"^",XQBLD)) Q
"RTN","XQ81",54,0)
 D:$E(XQL)'="P" RD3
"RTN","XQ81",55,0)
 Q
"RTN","XQ81",56,0)
 ;
"RTN","XQ81",57,0)
VER I $D(XQFG) D
"RTN","XQ81",58,0)
 .N XQMT,XQOPNM
"RTN","XQ81",59,0)
 .S XQK=$P(^TMP($J,XQBLD),U,2)
"RTN","XQ81",60,0)
 .S:$L(XQK) XQK=$E(XQK,4,5)_"/"_$E(XQK,6,7)_"/"_$E(XQK,2,3)
"RTN","XQ81",61,0)
 .S XQOPNM=$P(XQJ,U)
"RTN","XQ81",62,0)
 .S XQMT=$P(XQJ,U,2) I $L(XQMT)>28 S XQMT=$E(XQMT,1,25)_"..."
"RTN","XQ81",63,0)
 .W !,$P(XQJ,U,1)
"RTN","XQ81",64,0)
 .W:($L(XQOPNM)>20) !
"RTN","XQ81",65,0)
 .W ?20,XQMT,?49,+^TMP($J,XQBLD),?60,XQK
"RTN","XQ81",66,0)
 .Q
"RTN","XQ81",67,0)
 ;
"RTN","XQ81",68,0)
 I $D(XQFG) S:$D(^XUTL("XQO","P"_XQBLD,0)) XQ81T=+^(0) I $L(XQ81T) S %H=XQ81T D YMD^%DTC S XQK=X W ?71,$E(XQK,4,5),"/",$E(XQK,6,7),"/",$E(XQK,2,3)
"RTN","XQ81",69,0)
 ;
"RTN","XQ81",70,0)
RD3 ;Update counter an rebuild it if necessary
"RTN","XQ81",71,0)
 I $D(XQFG),XPDIDVT D
"RTN","XQ81",72,0)
 .N %
"RTN","XQ81",73,0)
 .S XQNDONE=XQNDONE+1
"RTN","XQ81",74,0)
 .S %=(XQNDONE/XQNTREE)*XPDIDTOT
"RTN","XQ81",75,0)
 .D UPDATE^XPDID(%)
"RTN","XQ81",76,0)
 .Q
"RTN","XQ81",77,0)
 ;
"RTN","XQ81",78,0)
 S XQDIC="P"_XQBLD D CHK^XQ8 I XQRE W:$D(XQFG) !,"SOMEONE ELSE IS CURRENTLY REBUILDING THIS MENU" Q
"RTN","XQ81",79,0)
 I XQVE,XQSEC S DIR(0)="Y",DIR("A")="Rebuild",DIR("B")="YES" D ^DIR Q:$D(DIRUT)  W ! Q:Y'=1
"RTN","XQ81",80,0)
 S XQFG1=1 D PM2^XQ8
"RTN","XQ81",81,0)
 Q
"RTN","XQ81",82,0)
SET G:'$D(^VA(200,XQI,201)) SET1 S XQK=+^(201) Q:'$L(XQK)  ;I $D(XQFG) W:'(XQI#10) "."
"RTN","XQ81",83,0)
 S XQR="" S:$D(^VA(200,XQI,1.1)) XQR=$P(^(1.1),".",1) S XQP=1_U_XQR
"RTN","XQ81",84,0)
 I $D(^TMP($J,XQK)) S XQP=^TMP($J,XQK) S XQP=XQP+1_U_$S(XQR>$P(XQP,U,2):XQR,1:$P(XQP,U,2))
"RTN","XQ81",85,0)
 I $D(^DIC(19,XQK,0)),$P(^(0),U,4)="M" S ^TMP($J,XQK)=XQP
"RTN","XQ81",86,0)
SET1 I XQBSEC F XQN=0:0 S XQN=$O(^VA(200,XQI,203,XQN)) Q:XQN'>0  S XQL=+^(XQN,0) I $D(^DIC(19,XQL,0)) S ^TMP($J,"SEC",XQL)=""
"RTN","XQ81",87,0)
 Q
"RTN","XQ81",88,0)
 ;
"RTN","XQ81",89,0)
QUE ;Entry point for the option XQBUILDTREEQUE, and XQBUILDALL
"RTN","XQ81",90,0)
 S XQVE=0,XQBSEC=1 K XQFG
"RTN","XQ81",91,0)
 G DQ
"RTN","XQ81",92,0)
 ;
"RTN","XQ81",93,0)
BLDEND ;
"RTN","XQ81",94,0)
 ;
"RTN","XQ81",95,0)
 K %,%H,%TG,D,DIC,DIR,I,J,K,L,V,XQBSEC,X,Y,Z,XQL,XQN,XQRE,XQK,XQI,XQII,UU,XQH,XQPX,XQSAV,XQXUF,XQ81T,XQDATE,XQSEC,XQVE,XQBLD,XQP,XQR,XQJ,^TMP($J)
"RTN","XQ81",96,0)
 ;
"RTN","XQ81",97,0)
 I '$D(XPDIDVT) K XQFG Q
"RTN","XQ81",98,0)
 ;
"RTN","XQ81",99,0)
 I $D(XQFG),XPDIDVT F %=((XQNDONE/XQNTREE)*XPDIDTOT):1:XPDIDTOT D UPDATE^XPDID(%) H .25
"RTN","XQ81",100,0)
 I $D(XQFG),XPDIDVT D UPDATE^XPDID(XPDIDTOT)
"RTN","XQ81",101,0)
 I $D(XQFG) W !!,"Menu Rebuild Complete:  ",$$HTE^XLFDT($H)
"RTN","XQ81",102,0)
 ;
"RTN","XQ81",103,0)
 H 2
"RTN","XQ81",104,0)
 ;If we're not from KIDS then clean it up, otherwise let kids do it.
"RTN","XQ81",105,0)
 I '$D(XPDNM) D
"RTN","XQ81",106,0)
 .D EXIT^XPDID()
"RTN","XQ81",107,0)
 .K XPDIDVT,XPDIDTOT
"RTN","XQ81",108,0)
 .Q
"RTN","XQ81",109,0)
 ;
"RTN","XQ81",110,0)
 I $D(XQSAVTOT) S XPDIDTOT=XQSAVTOT K XQSAVTOT
"RTN","XQ81",111,0)
 K XQFG
"RTN","XQ81",112,0)
 Q
"RTN","XQ81",113,0)
 ;
"RTN","XQ81",114,0)
ERR ;Come here on error
"RTN","XQ81",115,0)
 N XQERROR
"RTN","XQ81",116,0)
 S XQERROR=$$EC^%ZOSV
"RTN","XQ81",117,0)
 D ^%ZTER
"RTN","XQ81",118,0)
 D EXIT^XPDID()
"RTN","XQ81",119,0)
 G UNWIND^%ZTER
"RTN","XQ81",120,0)
 Q
"VER")
8.0^21.0
**END**
**END**
