Released IB*2*252 SEQ #228
Extracted from mail message
**KIDS**:IB*2.0*252^

**INSTALL NAME**
IB*2.0*252
"BLD",4974,0)
IB*2.0*252^INTEGRATED BILLING^0^3031111^y
"BLD",4974,1,0)
^^6^6^3031111^
"BLD",4974,1,1,0)
This patch addresses the following NOIS message(s):
"BLD",4974,1,2,0)
---------------------------------------------------
"BLD",4974,1,3,0)
POR-0903-52494         BUFFER FILE PROBLEMS
"BLD",4974,1,4,0)
BAY-1003-30706         Critical Message received from IIV
"BLD",4974,1,5,0)
LOU-0903-42302         IIV Payer Link Report /column
"BLD",4974,1,6,0)
UNY-1003-12260         <NULLSUBSCR>VALID+5^IBCNEUT4
"BLD",4974,4,0)
^9.64PA^^
"BLD",4974,"ABPKG")
n
"BLD",4974,"KRN",0)
^9.67PA^8989.52^19
"BLD",4974,"KRN",.4,0)
.4
"BLD",4974,"KRN",.401,0)
.401
"BLD",4974,"KRN",.402,0)
.402
"BLD",4974,"KRN",.403,0)
.403
"BLD",4974,"KRN",.5,0)
.5
"BLD",4974,"KRN",.84,0)
.84
"BLD",4974,"KRN",3.6,0)
3.6
"BLD",4974,"KRN",3.8,0)
3.8
"BLD",4974,"KRN",9.2,0)
9.2
"BLD",4974,"KRN",9.8,0)
9.8
"BLD",4974,"KRN",9.8,"NM",0)
^9.68A^12^12
"BLD",4974,"KRN",9.8,"NM",1,0)
IBCNERPB^^0^B46761930
"BLD",4974,"KRN",9.8,"NM",2,0)
IBCNERPC^^0^B45814881
"BLD",4974,"KRN",9.8,"NM",3,0)
IBCNERPD^^0^B45776123
"BLD",4974,"KRN",9.8,"NM",4,0)
IBCNBLA1^^0^B76414362
"BLD",4974,"KRN",9.8,"NM",5,0)
IBCNBEE^^0^B43835386
"BLD",4974,"KRN",9.8,"NM",6,0)
IBCNEHLP^^0^B75367905
"BLD",4974,"KRN",9.8,"NM",7,0)
IBCNEHLR^^0^B26953930
"BLD",4974,"KRN",9.8,"NM",8,0)
IBCNEUT3^^0^B57302311
"BLD",4974,"KRN",9.8,"NM",9,0)
IBCNEUT6^^0^B17301975
"BLD",4974,"KRN",9.8,"NM",10,0)
IBCNEAMC^^0^B32146789
"BLD",4974,"KRN",9.8,"NM",11,0)
IBCNEAME^^0^B9090150
"BLD",4974,"KRN",9.8,"NM",12,0)
IBCNEHLI^^0^B6661034
"BLD",4974,"KRN",9.8,"NM","B","IBCNBEE",5)

"BLD",4974,"KRN",9.8,"NM","B","IBCNBLA1",4)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEAMC",10)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEAME",11)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEHLI",12)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEHLP",6)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEHLR",7)

"BLD",4974,"KRN",9.8,"NM","B","IBCNERPB",1)

"BLD",4974,"KRN",9.8,"NM","B","IBCNERPC",2)

"BLD",4974,"KRN",9.8,"NM","B","IBCNERPD",3)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEUT3",8)

"BLD",4974,"KRN",9.8,"NM","B","IBCNEUT6",9)

"BLD",4974,"KRN",19,0)
19
"BLD",4974,"KRN",19.1,0)
19.1
"BLD",4974,"KRN",101,0)
101
"BLD",4974,"KRN",409.61,0)
409.61
"BLD",4974,"KRN",771,0)
771
"BLD",4974,"KRN",870,0)
870
"BLD",4974,"KRN",8989.51,0)
8989.51
"BLD",4974,"KRN",8989.52,0)
8989.52
"BLD",4974,"KRN",8994,0)
8994
"BLD",4974,"KRN","B",.4,.4)

"BLD",4974,"KRN","B",.401,.401)

"BLD",4974,"KRN","B",.402,.402)

"BLD",4974,"KRN","B",.403,.403)

"BLD",4974,"KRN","B",.5,.5)

"BLD",4974,"KRN","B",.84,.84)

"BLD",4974,"KRN","B",3.6,3.6)

"BLD",4974,"KRN","B",3.8,3.8)

"BLD",4974,"KRN","B",9.2,9.2)

"BLD",4974,"KRN","B",9.8,9.8)

"BLD",4974,"KRN","B",19,19)

"BLD",4974,"KRN","B",19.1,19.1)

"BLD",4974,"KRN","B",101,101)

"BLD",4974,"KRN","B",409.61,409.61)

"BLD",4974,"KRN","B",771,771)

"BLD",4974,"KRN","B",870,870)

"BLD",4974,"KRN","B",8989.51,8989.51)

"BLD",4974,"KRN","B",8989.52,8989.52)

"BLD",4974,"KRN","B",8994,8994)

"BLD",4974,"QUES",0)
^9.62^^
"BLD",4974,"REQB",0)
^9.611^2^1
"BLD",4974,"REQB",2,0)
IB*2.0*184^2
"BLD",4974,"REQB","B","IB*2.0*184",2)

"MBREQ")
0
"PKG",248,-1)
1^1
"PKG",248,0)
INTEGRATED BILLING^IB^APP
"PKG",248,20,0)
^9.402P^1^1
"PKG",248,20,1,0)
2^^IBAXDR
"PKG",248,20,1,1)

"PKG",248,20,"B",2,1)

"PKG",248,22,0)
^9.49I^1^1
"PKG",248,22,1,0)
2.0^2940321^2940616
"PKG",248,22,1,"PAH",1,0)
252^3031111
"PKG",248,22,1,"PAH",1,1,0)
^^6^6^3031111
"PKG",248,22,1,"PAH",1,1,1,0)
This patch addresses the following NOIS message(s):
"PKG",248,22,1,"PAH",1,1,2,0)
---------------------------------------------------
"PKG",248,22,1,"PAH",1,1,3,0)
POR-0903-52494         BUFFER FILE PROBLEMS
"PKG",248,22,1,"PAH",1,1,4,0)
BAY-1003-30706         Critical Message received from IIV
"PKG",248,22,1,"PAH",1,1,5,0)
LOU-0903-42302         IIV Payer Link Report /column
"PKG",248,22,1,"PAH",1,1,6,0)
UNY-1003-12260         <NULLSUBSCR>VALID+5^IBCNEUT4
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","IBCNBEE")
0^5^B43835386
"RTN","IBCNBEE",1,0)
IBCNBEE ;ALB/ARH-Ins Buffer: add/edit existing entries in buffer ;1 Jun 97
"RTN","IBCNBEE",2,0)
 ;;2.0;INTEGRATED BILLING;**82,184,252**;21-MAR-94
"RTN","IBCNBEE",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNBEE",4,0)
 ;
"RTN","IBCNBEE",5,0)
ADD(IBSOURCE) ; add a new buffer file entry (#355.33), sets only status (0) node data
"RTN","IBCNBEE",6,0)
 N IBARR,IBERR,IBIFN,IBX I '$G(IBSOURCE) S IBSOURCE=1
"RTN","IBCNBEE",7,0)
 ;
"RTN","IBCNBEE",8,0)
 S IBARR(355.33,"+1,",.01)="NOW",IBARR(355.33,"+1,",.03)=IBSOURCE
"RTN","IBCNBEE",9,0)
 D UPDATE^DIE("E","IBARR","IBIFN","IBERR")
"RTN","IBCNBEE",10,0)
 S IBX=+$G(IBIFN(1)) I $D(IBERR) S $P(IBX,U,2)=$G(IBERR("DIERR",1,"TEXT",1))
"RTN","IBCNBEE",11,0)
 Q IBX
"RTN","IBCNBEE",12,0)
 ;
"RTN","IBCNBEE",13,0)
STATUS(IBBUFDA,STATUS,NC,NG,NP) ; edit the status node
"RTN","IBCNBEE",14,0)
 ;
"RTN","IBCNBEE",15,0)
 N IBX,IBARR,IBIFN Q:'$G(IBBUFDA)  S IBIFN=IBBUFDA_","
"RTN","IBCNBEE",16,0)
 D CHK^DIE(355.33,.04,"",$G(STATUS),.IBX) Q:IBX="^"
"RTN","IBCNBEE",17,0)
 ;
"RTN","IBCNBEE",18,0)
 S IBARR(355.33,IBIFN,.04)=STATUS I STATUS="R" S (NC,NG,NP)=0
"RTN","IBCNBEE",19,0)
 S IBARR(355.33,IBIFN,.07)=+$G(NC),IBARR(355.33,IBIFN,.08)=+$G(NG),IBARR(355.33,IBIFN,.09)=+$G(NP)
"RTN","IBCNBEE",20,0)
 D FILE^DIE("E","IBARR")
"RTN","IBCNBEE",21,0)
 Q
"RTN","IBCNBEE",22,0)
 ;
"RTN","IBCNBEE",23,0)
INS(IBBUFDA,FLDS) ; edit the insurance company portion of a buffer file entry
"RTN","IBCNBEE",24,0)
 ;
"RTN","IBCNBEE",25,0)
 N DIC,DIE,DA,DR,X,Y,IBCNEXT1
"RTN","IBCNBEE",26,0)
 I $P($G(^IBA(355.33,+$G(IBBUFDA),0)),U,4)'="E" Q
"RTN","IBCNBEE",27,0)
 I $G(FLDS)="" S FLDS="MR"
"RTN","IBCNBEE",28,0)
 ;
"RTN","IBCNBEE",29,0)
 ; ESG - 6/18/02 - SDD 5.1.4 - Usage of Auto Match when editing
"RTN","IBCNBEE",30,0)
 ;     - the insurance company name in the buffer.  Also added an
"RTN","IBCNBEE",31,0)
 ;     - input transform (see below) to clean up the data coming in.
"RTN","IBCNBEE",32,0)
 ;     - fetch the current buffer ins co name
"RTN","IBCNBEE",33,0)
 ;
"RTN","IBCNBEE",34,0)
 I FLDS="MR" S IBCNEXT1=$P($G(^IBA(355.33,IBBUFDA,20)),U,1)
"RTN","IBCNBEE",35,0)
 ;
"RTN","IBCNBEE",36,0)
 S DR=$P($T(@(FLDS_"INS")+1),";;",2,9999) Q:DR=""
"RTN","IBCNBEE",37,0)
 ;
"RTN","IBCNBEE",38,0)
 I FLDS="MR" Q:$$INSNAME(IBBUFDA)<0  S DR=$P($T(@(FLDS_"INS")+1),";;",2,9999),DR=$P(DR,";",2,99999)
"RTN","IBCNBEE",39,0)
 ;
"RTN","IBCNBEE",40,0)
 S DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR
"RTN","IBCNBEE",41,0)
 Q
"RTN","IBCNBEE",42,0)
 ;
"RTN","IBCNBEE",43,0)
GRP(IBBUFDA,FLDS) ; edit the group/plan portion of the buffer file entry
"RTN","IBCNBEE",44,0)
 ;
"RTN","IBCNBEE",45,0)
 N DIC,DIE,DA,DR,X,Y I $P($G(^IBA(355.33,+$G(IBBUFDA),0)),U,4)'="E" Q
"RTN","IBCNBEE",46,0)
 I $G(FLDS)="" S FLDS="MR"
"RTN","IBCNBEE",47,0)
 ;
"RTN","IBCNBEE",48,0)
 S DR=$P($T(@(FLDS_"GRP")+1),";;",2,9999) Q:DR=""
"RTN","IBCNBEE",49,0)
 S DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR
"RTN","IBCNBEE",50,0)
 Q
"RTN","IBCNBEE",51,0)
 ;
"RTN","IBCNBEE",52,0)
POLICY(IBBUFDA,FLDS) ; edit the patient policy portion of the buffer file entry
"RTN","IBCNBEE",53,0)
 ;
"RTN","IBCNBEE",54,0)
 N DIC,DIE,DA,DR,X,Y,IBZZ I $P($G(^IBA(355.33,+$G(IBBUFDA),0)),U,4)'="E" Q
"RTN","IBCNBEE",55,0)
 I $G(FLDS)="" S FLDS="MR"
"RTN","IBCNBEE",56,0)
 ;
"RTN","IBCNBEE",57,0)
 S DR=$P($T(@(FLDS_"POL")+1),";;",2,9999) Q:DR=""
"RTN","IBCNBEE",58,0)
 S DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR Q:$D(Y)
"RTN","IBCNBEE",59,0)
 ;
"RTN","IBCNBEE",60,0)
 I FLDS="MR" D ESGHP(IBBUFDA)
"RTN","IBCNBEE",61,0)
 Q
"RTN","IBCNBEE",62,0)
 ;
"RTN","IBCNBEE",63,0)
ESGHP(IBBUFDA) ; sponsoring employer information
"RTN","IBCNBEE",64,0)
 N DIR,DIRUT,DUOUT,DTOUT,VAOA,VAERR,VA,DFN,IB60,IBE,IBEMPST,IBREL
"RTN","IBCNBEE",65,0)
 ;
"RTN","IBCNBEE",66,0)
 ; if insured is patient or spouse, ask if insured's current employer is the plan's sponsoring employer, if yes auto stuff it
"RTN","IBCNBEE",67,0)
 I +$G(^IBA(355.33,IBBUFDA,61)) W ! S IB60=$G(^IBA(355.33,IBBUFDA,60)) D  Q:$D(DIRUT)
"RTN","IBCNBEE",68,0)
 . ; sponsoring employer is current employer?
"RTN","IBCNBEE",69,0)
 . S DFN=+IB60,IBREL=$P(IB60,U,6),VAOA("A")=$S(IBREL="01":5,IBREL="02":6,1:"") I 'DFN!(VAOA("A")="") Q
"RTN","IBCNBEE",70,0)
 . D OAD^VADPT I $G(VAOA(9))="" Q
"RTN","IBCNBEE",71,0)
 . S DIR("?")="Enter Yes if this plan is sponsored by the "_$S(IBREL="01":"patient's",1:"spouse's")_" current employer."
"RTN","IBCNBEE",72,0)
 . S DIR("?",1)="Entering Yes will result in the "_$S(IBREL="01":"patient's",1:"spouse's")_" current employer data being",DIR("?",2)="added to the policy as the Sponsoring Employer data.",DIR("?",3)=""
"RTN","IBCNBEE",73,0)
 . S DIR("A")="Current Employer "_VAOA(9)_" Sponsors this Plan",DIR("B")="No",DIR(0)="Y" D ^DIR W ! I Y'=1 Q
"RTN","IBCNBEE",74,0)
 . ;
"RTN","IBCNBEE",75,0)
 . D DELEMP(IBBUFDA) ; delete any data already contained in these fields
"RTN","IBCNBEE",76,0)
 . ;
"RTN","IBCNBEE",77,0)
 . ; if the insured's current employer sponsors the plan then stuff that employer's address into the buffer
"RTN","IBCNBEE",78,0)
 . S IBE=$S(IBREL="01":.311,1:.25),IBEMPST=$P($G(^DPT(DFN,IBE)),U,15) D
"RTN","IBCNBEE",79,0)
 . S DR="61.02///"_VAOA(9)_";61.03///"_IBEMPST_";61.06///"_$E(VAOA(1),1,30)_";61.07///"_$E(VAOA(2),1,30)
"RTN","IBCNBEE",80,0)
 . S DR=DR_";61.08///"_$E(VAOA(3),1,30)_";61.09///"_$E(VAOA(4),1,20)_";61.1////"_$P(VAOA(5),U,1)
"RTN","IBCNBEE",81,0)
 . S DR=DR_";61.11////"_$P(VAOA(11),U,1)_";61.12///"_$E(VAOA(8),1,15)
"RTN","IBCNBEE",82,0)
 . S DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR
"RTN","IBCNBEE",83,0)
 ;
"RTN","IBCNBEE",84,0)
 ; if employer sponsored plan, edit buffer entry's sponsoring employer info
"RTN","IBCNBEE",85,0)
 I +$G(^IBA(355.33,IBBUFDA,61)) S DR="61.02:61.12",DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR
"RTN","IBCNBEE",86,0)
 ;
"RTN","IBCNBEE",87,0)
 ; if not employer sponsored plan, delete any existing sponsoring employer data
"RTN","IBCNBEE",88,0)
 I $D(^IBA(355.33,IBBUFDA,61)),'$G(^IBA(355.33,IBBUFDA,61)) D DELEMP(IBBUFDA)
"RTN","IBCNBEE",89,0)
 Q
"RTN","IBCNBEE",90,0)
 ;
"RTN","IBCNBEE",91,0)
DELEMP(IBBUFDA) ; delete sponsoring employer data
"RTN","IBCNBEE",92,0)
 N DIC,DIE,DA,DR,X,Y Q:'$D(^IBA(355.33,+$G(IBBUFDA),61))
"RTN","IBCNBEE",93,0)
 S DR="61.02///@;61.03///@;61.04///@;61.05///@;61.06///@;61.07///@;61.08///@;61.09///@;61.10///@;61.11///@;61.12///@"
"RTN","IBCNBEE",94,0)
 S DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR
"RTN","IBCNBEE",95,0)
 Q
"RTN","IBCNBEE",96,0)
 ;
"RTN","IBCNBEE",97,0)
INSHELP ;
"RTN","IBCNBEE",98,0)
 W !!,"------------------------ INSURANCE COMPANY INFORMATION -------------------------",!
"RTN","IBCNBEE",99,0)
 Q
"RTN","IBCNBEE",100,0)
GRPHELP ;
"RTN","IBCNBEE",101,0)
 W !!,"---------------------------- GROUP/PLAN INFORMATION ----------------------------"
"RTN","IBCNBEE",102,0)
 W !," The following data defines a specific Group or Plan provided by an Insurance "
"RTN","IBCNBEE",103,0)
 W !," Company.  This may be either a group plan with many potential members or an "
"RTN","IBCNBEE",104,0)
 W !," individual plan with a single member.",!
"RTN","IBCNBEE",105,0)
 Q
"RTN","IBCNBEE",106,0)
POLHELP ;
"RTN","IBCNBEE",107,0)
 W !!,"---------------------- POLICY AND SUBSCRIBER INFORMATION -----------------------"
"RTN","IBCNBEE",108,0)
 W !," The following data defines the subscriber specific policy information for a "
"RTN","IBCNBEE",109,0)
 W !," particular Insurance Plan.  The subscriber, the insured, and the policy holder "
"RTN","IBCNBEE",110,0)
 W !," all refer to the person who is a member of the plan and therefore holds the "
"RTN","IBCNBEE",111,0)
 W !," policy.  The patient must be covered under the plan but may not be the policy"
"RTN","IBCNBEE",112,0)
 W !," holder.",!
"RTN","IBCNBEE",113,0)
 Q
"RTN","IBCNBEE",114,0)
 ;
"RTN","IBCNBEE",115,0)
INSNAME(IBBUFDA) ;  Reset insurance company name
"RTN","IBCNBEE",116,0)
 N DR,DIE,DA,Y,X,IBX,IBNEW,IBNAME
"RTN","IBCNBEE",117,0)
 S IBX=-1
"RTN","IBCNBEE",118,0)
 S DR=20.01,DIE="^IBA(355.33,",DA=IBBUFDA
"RTN","IBCNBEE",119,0)
 D ^DIE
"RTN","IBCNBEE",120,0)
 I '$D(Y) S IBNEW=$$CHECK(IBBUFDA)
"RTN","IBCNBEE",121,0)
 I +$G(IBNEW)'<0,$G(IBNEW)'=0,$D(IBNEW) S DR=$P(DR,";",1)_"////"_IBNEW S DIE="^IBA(355.33,",DA=IBBUFDA D ^DIE K DIE,DA,DR I '$D(Y) S IBX=0
"RTN","IBCNBEE",122,0)
 ; BHS - 10/15/03 - If user entered a caret during $$CHECK still set
"RTN","IBCNBEE",123,0)
 ;                  return value to 0 so the user can edit the other
"RTN","IBCNBEE",124,0)
 ;                  INS fields
"RTN","IBCNBEE",125,0)
 I $G(IBNEW)=0!($G(IBNEW)=-1) S IBX=0
"RTN","IBCNBEE",126,0)
 Q IBX
"RTN","IBCNBEE",127,0)
 ;
"RTN","IBCNBEE",128,0)
CHECK(IBBUFDA) ; Select Insurance Company Name and Automatch
"RTN","IBCNBEE",129,0)
 ; Buffer file (#355.33), field# 20.01.
"RTN","IBCNBEE",130,0)
 ; ESG - 6/18/02 - SDD 5.1.4 - Usage of Auto Match when editing the
"RTN","IBCNBEE",131,0)
 ;       insurance company name.  Also, display the insurance company
"RTN","IBCNBEE",132,0)
 ;       name lookup/lister and the Auto Match lookup/lister.
"RTN","IBCNBEE",133,0)
 ;
"RTN","IBCNBEE",134,0)
 NEW IBNEW,IBNAME,AMLIST
"RTN","IBCNBEE",135,0)
 ;
"RTN","IBCNBEE",136,0)
 S IBNEW=0,IBNAME=$P($G(^IBA(355.33,$G(IBBUFDA),20)),U,1)
"RTN","IBCNBEE",137,0)
 I IBNAME="" G CHECKQ
"RTN","IBCNBEE",138,0)
 ;
"RTN","IBCNBEE",139,0)
 ; Perform an insurance company lookup/lister
"RTN","IBCNBEE",140,0)
 ; BHS - 10/15/03 - Removed quits when user enters a caret to quit the
"RTN","IBCNBEE",141,0)
 ;                  the ins lister or Auto Match lister
"RTN","IBCNBEE",142,0)
 S IBNEW=$$DICINS^IBCNBU1(IBNAME,1,10)
"RTN","IBCNBEE",143,0)
 I IBNEW=0!(IBNEW<0) D
"RTN","IBCNBEE",144,0)
 . I '$$AMLOOK^IBCNEUT1(IBNAME,1,.AMLIST) Q
"RTN","IBCNBEE",145,0)
 . S IBNEW=$$AMSEL^IBCNEUT1(.AMLIST)
"RTN","IBCNBEE",146,0)
 ;
"RTN","IBCNBEE",147,0)
 ; user chose a valid insurance company - possible Auto Match add
"RTN","IBCNBEE",148,0)
 I IBNEW'<0,IBNEW'=0 D AMADD^IBCNEUT6(X,IBCNEXT1)
"RTN","IBCNBEE",149,0)
 ;
"RTN","IBCNBEE",150,0)
CHECKQ Q IBNEW
"RTN","IBCNBEE",151,0)
 ;
"RTN","IBCNBEE",152,0)
MRINS ; Insurance Company fields asked of MCCR users in the Buffer Process options (all buffer ins fields 20.01-21.06)
"RTN","IBCNBEE",153,0)
 ;;20.01;20.05;20.02:20.04;21.01;I X="" S Y="@111";21.02;I X="" S Y="@111";21.03;@111;21.04:21.06
"RTN","IBCNBEE",154,0)
 ;
"RTN","IBCNBEE",155,0)
MRGRP ; Group/Plan fields asked of MCCR users in the Buffer Process options (all buffer grp fields 40.01-40.09)
"RTN","IBCNBEE",156,0)
 ;;40.01:40.03;40.09;40.04:40.08
"RTN","IBCNBEE",157,0)
 ;
"RTN","IBCNBEE",158,0)
MRPOL ; Patient Policy fields asked of MCCR users in the Buffer Process options (all buffer policy fields except ESGHP 60.02-61.01
"RTN","IBCNBEE",159,0)
 ;;60.02;60.03;60.05;60.06//^S X=$S(X="v":"01",X="s":"02",1:"");S IBZZ=X;60.04;I IBZZ'="01" S Y="@111";60.07///1;60.08///@;60.09///@;S Y="@112";@111;60.07:60.09;@112;60.1:60.12;.03;61.01
"RTN","IBCNBEE",160,0)
 ;
"RTN","IBCNBEE",161,0)
OTINS ; Insurance Company fields asked of non-MCCR users entering buffer data from options outside IB (20.01-20.04,21.01-21.06)
"RTN","IBCNBEE",162,0)
 ;;20.01:20.04;21.01;I X="" S Y="@111";21.02;I X="" S Y="@111";21.03;@111;21.04:21.06
"RTN","IBCNBEE",163,0)
 ;
"RTN","IBCNBEE",164,0)
OTGRP ; Group/Plan fields asked of non-MCCR users entering buffer data from options outside IB (40.02,40.03,40.09)
"RTN","IBCNBEE",165,0)
 ;;40.02;40.03;40.09
"RTN","IBCNBEE",166,0)
 ;
"RTN","IBCNBEE",167,0)
OTPOL ; Patient Policy fields asked of non-MCCR users entering buffer data from options outside IB (60.02-60.09)
"RTN","IBCNBEE",168,0)
 ;;60.02;60.03;60.05;60.06//^S X=$S(X="v":"01",X="s":"02",1:"");S IBZZ=X;60.04;I IBZZ'="01" S Y="@111";60.07///1;60.08///@;60.09///@;S Y="@112";@111;60.07:60.09;@112
"RTN","IBCNBLA1")
0^4^B76414362
"RTN","IBCNBLA1",1,0)
IBCNBLA1 ;ALB/ARH-Ins Buffer: LM action calls (cont) ;1 Jun 97
"RTN","IBCNBLA1",2,0)
 ;;2.0;INTEGRATED BILLING;**82,133,149,184,252**;21-MAR-94
"RTN","IBCNBLA1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNBLA1",4,0)
 ;
"RTN","IBCNBLA1",5,0)
ADDBUF ; add a new buffer entry protocol
"RTN","IBCNBLA1",6,0)
 N DIC,DIR,DIRUT,DUOUT,X,Y,IBIN,DFN,IBBUFDA,IBDATA,AMLIST,IBHELP
"RTN","IBCNBLA1",7,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","IBCNBLA1",8,0)
 ;
"RTN","IBCNBLA1",9,0)
 ; Patient lookup
"RTN","IBCNBLA1",10,0)
 S DIC(0)="AEQM",DIC="^DPT(" D ^DIC Q:Y'>0  S DFN=+Y W !
"RTN","IBCNBLA1",11,0)
 ;
"RTN","IBCNBLA1",12,0)
INS ; Insurance company lookup
"RTN","IBCNBLA1",13,0)
 S DIR("A")="Insurance Company",DIR(0)="FO^1:30"
"RTN","IBCNBLA1",14,0)
 S DIR("?",1)="Please enter the name of the insurance company that provides coverage for this"
"RTN","IBCNBLA1",15,0)
 S DIR("?",2)="patient.  This response is a free text response, however, a partial insurance"
"RTN","IBCNBLA1",16,0)
 S DIR("?")="company name look-up is available here."
"RTN","IBCNBLA1",17,0)
 ; BHS - 10/15/03 - Removed quit condition when user enters a caret
"RTN","IBCNBLA1",18,0)
 ;                  during the insurance lister and only sets IBIN
"RTN","IBCNBLA1",19,0)
 ;                  when a valid selection is made
"RTN","IBCNBLA1",20,0)
 D ^DIR K DIR Q:$D(DIRUT)  S IBIN=Y,Y=$$DICINS^IBCNBU1(Y,1,10) I Y'<0,Y'=0 S IBIN=Y
"RTN","IBCNBLA1",21,0)
 ;
"RTN","IBCNBLA1",22,0)
 ; ESG - 6/17/02 - Usage of Auto Match file when adding a buffer entry
"RTN","IBCNBLA1",23,0)
 ;     - SDD 5.1.3
"RTN","IBCNBLA1",24,0)
 ;
"RTN","IBCNBLA1",25,0)
 ; BHS - 10/15/03 - Added condition to allow Auto Match lookup when user
"RTN","IBCNBLA1",26,0)
 ;                  entered a caret during the insurance lister
"RTN","IBCNBLA1",27,0)
 I Y=0!(Y<0),$$AMLOOK^IBCNEUT1(IBIN,1,.AMLIST) S Y=$$AMSEL^IBCNEUT1(.AMLIST) I Y'<0,Y'=0 S IBIN=Y
"RTN","IBCNBLA1",28,0)
 I '$$INPTTR(355.33,20.01,$$UP^XLFSTR(IBIN)) D  G INS
"RTN","IBCNBLA1",29,0)
 . D FIELD^DID(355.33,20.01,"","HELP-PROMPT","IBHELP")
"RTN","IBCNBLA1",30,0)
 . W !?5,IBHELP("HELP-PROMPT") Q
"RTN","IBCNBLA1",31,0)
 ;
"RTN","IBCNBLA1",32,0)
 S DIR(0)="Y",DIR("A")="Add a new Insurance Buffer entry for this patient and company",DIR("B")="YES" W ! D ^DIR K DIR Q:Y'=1
"RTN","IBCNBLA1",33,0)
 ;
"RTN","IBCNBLA1",34,0)
 S IBDATA(20.01)=$$UP^XLFSTR(IBIN),IBDATA(60.01)=DFN
"RTN","IBCNBLA1",35,0)
 S IBBUFDA=+$$ADDSTF^IBCNBES(1,DFN,.IBDATA) K IBDATA Q:'IBBUFDA
"RTN","IBCNBLA1",36,0)
 ;
"RTN","IBCNBLA1",37,0)
 I '$$LOCK^IBCNBU1(IBBUFDA,1) Q
"RTN","IBCNBLA1",38,0)
 D INSHELP^IBCNBEE,INS^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",39,0)
 D GRPHELP^IBCNBEE,GRP^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",40,0)
 D POLHELP^IBCNBEE,POLICY^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",41,0)
 D BUFF^IBCNEUT2(IBBUFDA,+$$INSERROR^IBCNEUT3("B",IBBUFDA))   ; symbol
"RTN","IBCNBLA1",42,0)
 D UNLOCK^IBCNBU1(IBBUFDA)
"RTN","IBCNBLA1",43,0)
 ;
"RTN","IBCNBLA1",44,0)
 D INIT^IBCNBLL,HDR^IBCNBLL S VALMBCK="R"
"RTN","IBCNBLA1",45,0)
 Q
"RTN","IBCNBLA1",46,0)
 ;
"RTN","IBCNBLA1",47,0)
INSEDIT(IBBUFDA) ; edit the Insurance data of a buffer entry
"RTN","IBCNBLA1",48,0)
 ;
"RTN","IBCNBLA1",49,0)
 Q:'$G(IBBUFDA)  D FULL^VALM1
"RTN","IBCNBLA1",50,0)
 D INSHELP^IBCNBEE,INS^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",51,0)
 ;
"RTN","IBCNBLA1",52,0)
 D CLEAN^VALM10,INIT^IBCNBLE,HDR^IBCNBLE S VALMBCK="R" D UPDLN^IBCNBLL(IBBUFDA,"EDITED")
"RTN","IBCNBLA1",53,0)
 Q
"RTN","IBCNBLA1",54,0)
 ;
"RTN","IBCNBLA1",55,0)
GRPEDIT(IBBUFDA) ; edit the Group/Plan data of a buffer entry
"RTN","IBCNBLA1",56,0)
 ;
"RTN","IBCNBLA1",57,0)
 Q:'$G(IBBUFDA)  D FULL^VALM1
"RTN","IBCNBLA1",58,0)
 D GRPHELP^IBCNBEE,GRP^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",59,0)
 ;
"RTN","IBCNBLA1",60,0)
 D CLEAN^VALM10,INIT^IBCNBLE,HDR^IBCNBLE S VALMBCK="R"
"RTN","IBCNBLA1",61,0)
 Q
"RTN","IBCNBLA1",62,0)
 ;
"RTN","IBCNBLA1",63,0)
POLEDIT(IBBUFDA) ; edit the Subscriber Policy data of a buffer entry
"RTN","IBCNBLA1",64,0)
 ;
"RTN","IBCNBLA1",65,0)
 Q:'$G(IBBUFDA)  D FULL^VALM1
"RTN","IBCNBLA1",66,0)
 D POLHELP^IBCNBEE,POLICY^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",67,0)
 ;
"RTN","IBCNBLA1",68,0)
 D CLEAN^VALM10,INIT^IBCNBLE,HDR^IBCNBLE S VALMBCK="R" D UPDLN^IBCNBLL(IBBUFDA,"EDITED")
"RTN","IBCNBLA1",69,0)
 Q
"RTN","IBCNBLA1",70,0)
 ;
"RTN","IBCNBLA1",71,0)
ALLEDIT(IBBUFDA) ; edit All data of a buffer entry
"RTN","IBCNBLA1",72,0)
 ;
"RTN","IBCNBLA1",73,0)
 Q:'$G(IBBUFDA)  D FULL^VALM1
"RTN","IBCNBLA1",74,0)
 D INSHELP^IBCNBEE,INS^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",75,0)
 D GRPHELP^IBCNBEE,GRP^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",76,0)
 D POLHELP^IBCNBEE,POLICY^IBCNBEE(IBBUFDA)
"RTN","IBCNBLA1",77,0)
 ;
"RTN","IBCNBLA1",78,0)
 D CLEAN^VALM10,INIT^IBCNBLE,HDR^IBCNBLE S VALMBCK="R" D UPDLN^IBCNBLL(IBBUFDA,"EDITED")
"RTN","IBCNBLA1",79,0)
 Q
"RTN","IBCNBLA1",80,0)
 ;
"RTN","IBCNBLA1",81,0)
CMPEDIT(IBBUFDA) ; display a buffer entry and an existing ins entry for comparison, allow edit of buffer data
"RTN","IBCNBLA1",82,0)
 Q:'$G(IBBUFDA)
"RTN","IBCNBLA1",83,0)
 N IBDA,IBPOLDA,IBGRPDA,IBINSDA,DIR,DIRUT,X,Y
"RTN","IBCNBLA1",84,0)
 ;
"RTN","IBCNBLA1",85,0)
 D FULL^VALM1
"RTN","IBCNBLA1",86,0)
 ;
"RTN","IBCNBLA1",87,0)
 S IBDA=$$SEL^IBCNBLA("IBCNBLPX") I 'IBDA G CMPQ
"RTN","IBCNBLA1",88,0)
 I $P(IBDA,U,4)'="",+$G(^IBA(355.33,+IBBUFDA,60))'=$P(IBDA,U,4) W !,"Buffer Patient doesn't match Policy Patient, can't continue." G CMPQ
"RTN","IBCNBLA1",89,0)
 S IBINSDA=+IBDA,IBGRPDA=+$P(IBDA,U,2),IBPOLDA=+$P(IBDA,U,3)
"RTN","IBCNBLA1",90,0)
 ;
"RTN","IBCNBLA1",91,0)
CEINS W @IOF
"RTN","IBCNBLA1",92,0)
 I 'IBINSDA W !,"No Insurance Company Selected for Comparison."
"RTN","IBCNBLA1",93,0)
 W ! D INS^IBCNBCD(IBBUFDA,IBINSDA)
"RTN","IBCNBLA1",94,0)
 S DIR("?")="The Buffer entry's Insurance Company data may be edited or Return advances the display to the Group/Plan data.",DIR("??")="^D HELP^IBCNBUH,WAIT^IBCNBUH,INS^IBCNBCD("_IBBUFDA_","_IBINSDA_")"
"RTN","IBCNBLA1",95,0)
 W ! S DIR(0)="FO",DIR("A")="Enter 'E' to edit buffer data or Return to continue"
"RTN","IBCNBLA1",96,0)
 D ^DIR K DIR I Y'="",$D(DIRUT) G CMPQ
"RTN","IBCNBLA1",97,0)
 I Y'="","EEee"[Y D INSHELP^IBCNBEE,INS^IBCNBEE(IBBUFDA) G CEINS
"RTN","IBCNBLA1",98,0)
 ;
"RTN","IBCNBLA1",99,0)
CEGRP W @IOF
"RTN","IBCNBLA1",100,0)
 I 'IBGRPDA W !,"No Insurance Group/Plan Selected for Comparison."
"RTN","IBCNBLA1",101,0)
 I +IBGRPDA W !,?14,"Patient is "_$S(+IBPOLDA:"",1:"NOT ")_"a member of this Insurance Group/Plan",!
"RTN","IBCNBLA1",102,0)
 W ! D GRP^IBCNBCD(IBBUFDA,IBGRPDA)
"RTN","IBCNBLA1",103,0)
 S DIR("?")="The Buffer entry's Group/Plan data may be edited or Return advances the display to the Patient Policy data.",DIR("??")="^D HELP^IBCNBUH,WAIT^IBCNBUH,GRP^IBCNBCD("_IBBUFDA_","_IBGRPDA_")"
"RTN","IBCNBLA1",104,0)
 W ! S DIR(0)="FO",DIR("A")="Enter 'E' to edit buffer data or Return to continue"
"RTN","IBCNBLA1",105,0)
 D ^DIR K DIR I Y'="",$D(DIRUT) G CMPQ
"RTN","IBCNBLA1",106,0)
 I Y'="","EEee"[Y D GRPHELP^IBCNBEE,GRP^IBCNBEE(IBBUFDA) G CEGRP
"RTN","IBCNBLA1",107,0)
 ;
"RTN","IBCNBLA1",108,0)
CEPOL W @IOF
"RTN","IBCNBLA1",109,0)
 I 'IBPOLDA W !,"No Patient Policy Selected for Comparison."
"RTN","IBCNBLA1",110,0)
 W ! D POLICY^IBCNBCD(IBBUFDA,IBPOLDA)
"RTN","IBCNBLA1",111,0)
 S DIR("?")="The Buffer entry's Patient Policy data may be edited or return to the screen display.",DIR("??")="^D HELP^IBCNBUH,WAIT^IBCNBUH,POLICY^IBCNBCD("_IBBUFDA_","_IBPOLDA_")"
"RTN","IBCNBLA1",112,0)
 W ! S DIR(0)="FO",DIR("A")="Enter 'E' to edit buffer data or Return to continue"
"RTN","IBCNBLA1",113,0)
 D ^DIR K DIR I Y'="",$D(DIRUT) G CMPQ
"RTN","IBCNBLA1",114,0)
 I Y'="","EEee"[Y D POLHELP^IBCNBEE,POLICY^IBCNBEE(IBBUFDA) G CEPOL
"RTN","IBCNBLA1",115,0)
 ;
"RTN","IBCNBLA1",116,0)
CMPQ D CLEAN^VALM10,INIT^IBCNBLP,HDR^IBCNBLP S VALMBCK="R" D UPDLN^IBCNBLL(IBBUFDA,"EDITED")
"RTN","IBCNBLA1",117,0)
 Q
"RTN","IBCNBLA1",118,0)
 ;
"RTN","IBCNBLA1",119,0)
VERIFY(IBBUFDA) ; verify a buffer entry
"RTN","IBCNBLA1",120,0)
 ;
"RTN","IBCNBLA1",121,0)
 N DIR,DIRUT,X,Y,IBX,IBY Q:'$G(IBBUFDA)
"RTN","IBCNBLA1",122,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","IBCNBLA1",123,0)
 W ! D DISPBUF^IBCNBU1(IBBUFDA)
"RTN","IBCNBLA1",124,0)
 ;
"RTN","IBCNBLA1",125,0)
 S IBX=$G(^IBA(355.33,IBBUFDA,0)),IBY="" I +$P(IBX,U,10) S IBY="Re-" W !!,"This entry already verified by ",$$EXPAND^IBTRE(355.33,.11,$P(IBX,U,11))," on ",$$FMTE^XLFDT($P(IBX,U,10)),"."
"RTN","IBCNBLA1",126,0)
 ;
"RTN","IBCNBLA1",127,0)
 S DIR("?")="Enter Yes if the coverage and information in this Buffer entry has been verified to be accurate." W !!
"RTN","IBCNBLA1",128,0)
 S DIR(0)="YO",DIR("B")="N",DIR("A")=IBY_"Verify the coverage in this buffer entry"
"RTN","IBCNBLA1",129,0)
 D ^DIR
"RTN","IBCNBLA1",130,0)
 I Y=1 D
"RTN","IBCNBLA1",131,0)
 . ; WCW - 04/11/2003 Clear out IIV Status when manually verified
"RTN","IBCNBLA1",132,0)
 . D CLEAR^IBCNEUT4(IBBUFDA,.IIVERR,1) K IIVERR
"RTN","IBCNBLA1",133,0)
 . K IBX S IBX(.1)="NOW",IBX(.11)=DUZ D EDITSTF^IBCNBES(IBBUFDA,.IBX)
"RTN","IBCNBLA1",134,0)
 . D INIT^IBCNBLE,HDR^IBCNBLE S VALMBCK="R" D UPDLN^IBCNBLL(IBBUFDA,"EDITED") W "  Coverage Verified ..." H 2
"RTN","IBCNBLA1",135,0)
 ;
"RTN","IBCNBLA1",136,0)
 Q
"RTN","IBCNBLA1",137,0)
 ;
"RTN","IBCNBLA1",138,0)
REJECT(IBBUFDA,DIRUT) ; process a reject and then delete a buffer entry
"RTN","IBCNBLA1",139,0)
 ; Output parameter DIRUT is optional and passed in by reference.  This
"RTN","IBCNBLA1",140,0)
 ; variable will be defined if the user enters a leading up-arrow,
"RTN","IBCNBLA1",141,0)
 ; times out, or enters a null response.  This is so the calling routine
"RTN","IBCNBLA1",142,0)
 ; can detect if the user did something other than say Yes or No to
"RTN","IBCNBLA1",143,0)
 ; this question.
"RTN","IBCNBLA1",144,0)
 ;
"RTN","IBCNBLA1",145,0)
 N DIR,X,Y,IBX Q:'$G(IBBUFDA)
"RTN","IBCNBLA1",146,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","IBCNBLA1",147,0)
 W ! D DISPBUF^IBCNBU1(IBBUFDA)
"RTN","IBCNBLA1",148,0)
 W !!,"This action will delete all insurance and patient specific data from a buffer ",!,"entry without first saving that data to the insurance files, leaving a stub ",!,"entry for reporting purposes.",!
"RTN","IBCNBLA1",149,0)
 ;
"RTN","IBCNBLA1",150,0)
 S IBX=$G(^IBA(355.33,IBBUFDA,0)) I +$P(IBX,U,10) W !!,"This entry has been verified by ",$$EXPAND^IBTRE(355.33,.11,$P(IBX,U,11))," on ",$$FMTE^XLFDT($P(IBX,U,10)),".",!!
"RTN","IBCNBLA1",151,0)
 ;
"RTN","IBCNBLA1",152,0)
 S DIR("?")="Enter Yes to delete this buffer entry without saving any of it's data to the Insurance files."
"RTN","IBCNBLA1",153,0)
 S DIR(0)="YO",DIR("B")="N",DIR("A")="Reject this buffer entry (delete without saving to Insurance files)"
"RTN","IBCNBLA1",154,0)
 D ^DIR
"RTN","IBCNBLA1",155,0)
 I $D(DIRUT) G REJX
"RTN","IBCNBLA1",156,0)
 I Y=1 D REJECT^IBCNBAR(IBBUFDA) S VALMBCK="Q" D UPDLN^IBCNBLL(IBBUFDA,"REJECTED")
"RTN","IBCNBLA1",157,0)
REJX ;
"RTN","IBCNBLA1",158,0)
 Q
"RTN","IBCNBLA1",159,0)
 ;
"RTN","IBCNBLA1",160,0)
ACCEPT(IBBUFDA) ; process a buffer entry for acceptance
"RTN","IBCNBLA1",161,0)
 ;
"RTN","IBCNBLA1",162,0)
 Q:'$G(IBBUFDA)
"RTN","IBCNBLA1",163,0)
 N IBDA,IBINSDA,IBGRPDA,IBPOLDA,IBACCEPT S IBACCEPT=0
"RTN","IBCNBLA1",164,0)
 ;
"RTN","IBCNBLA1",165,0)
 D FULL^VALM1
"RTN","IBCNBLA1",166,0)
 ;
"RTN","IBCNBLA1",167,0)
 S IBDA=$$SEL^IBCNBLA("IBCNBLPX")
"RTN","IBCNBLA1",168,0)
 I $P(IBDA,U,4)'="",+$G(^IBA(355.33,+IBBUFDA,60))'=$P(IBDA,U,4) W !,"Buffer Patient doesn't match Policy Patient, can't continue." G ACCPTQ
"RTN","IBCNBLA1",169,0)
 I +$P(IBDA,U,3),'$P(IBDA,U,2) W !!,"Error: the selected policy has no associated plan.  Can not continue." D WAIT^IBCNBUH G ACCPTQ
"RTN","IBCNBLA1",170,0)
 ;
"RTN","IBCNBLA1",171,0)
 S IBINSDA=+IBDA,IBGRPDA=+$P(IBDA,U,2),IBPOLDA=+$P(IBDA,U,3)
"RTN","IBCNBLA1",172,0)
 S:'IBINSDA (IBGRPDA,IBPOLDA)=0 S:'IBGRPDA IBPOLDA=0
"RTN","IBCNBLA1",173,0)
 ;
"RTN","IBCNBLA1",174,0)
 I 'IBINSDA,'$D(^XUSEC("IB INSURANCE COMPANY ADD",DUZ)) D  G ACCPTQ
"RTN","IBCNBLA1",175,0)
 . W !!,"Sorry, but you do not have the required privileges to add",!,"new Insurance Companies."
"RTN","IBCNBLA1",176,0)
 . D WAIT^IBCNBUH
"RTN","IBCNBLA1",177,0)
 ;
"RTN","IBCNBLA1",178,0)
 S IBACCEPT=$$ACCEPT^IBCNBAA(IBBUFDA,IBINSDA,IBGRPDA,IBPOLDA)
"RTN","IBCNBLA1",179,0)
 ;
"RTN","IBCNBLA1",180,0)
ACCPTQ S VALMBCK="R" I +IBACCEPT S VALMBCK="Q" D UPDLN^IBCNBLL(IBBUFDA,"ACCEPTED")
"RTN","IBCNBLA1",181,0)
 Q
"RTN","IBCNBLA1",182,0)
 ;
"RTN","IBCNBLA1",183,0)
RESP(BUFF) ; List Response Report for Trace # associated with this entry
"RTN","IBCNBLA1",184,0)
 ; BUFF = buffer IEN
"RTN","IBCNBLA1",185,0)
 N NG,IBRSP,IBSTR,IBTRC,STOP,IBCNERTN,POP,IBCNESPC
"RTN","IBCNBLA1",186,0)
 S NG=0
"RTN","IBCNBLA1",187,0)
 I $G(BUFF)="" S NG=1
"RTN","IBCNBLA1",188,0)
 I 'NG S IBRSP=$O(^IBCN(365,"AF",BUFF,"")) I IBRSP="" S NG=1
"RTN","IBCNBLA1",189,0)
 I 'NG S IBSTR=$G(^IBCN(365,IBRSP,0)),IBTRC=$P(IBSTR,U,9) I IBTRC="" S NG=1
"RTN","IBCNBLA1",190,0)
 I NG W !!,"This entry does not have an associated IIV response." D PAUSE^VALM1 G RESPX
"RTN","IBCNBLA1",191,0)
 S STOP=0,IBCNERTN="IBCNERP1",IBCNESPC("TRCN")=IBTRC_U_IBRSP
"RTN","IBCNBLA1",192,0)
 D R100^IBCNERP1
"RTN","IBCNBLA1",193,0)
RESPX S VALMBCK="R"
"RTN","IBCNBLA1",194,0)
 Q
"RTN","IBCNBLA1",195,0)
INPTTR(FILE,FLD,X) ; Does value X pass input transform for file, field?
"RTN","IBCNBLA1",196,0)
 N XCUTE
"RTN","IBCNBLA1",197,0)
 S XCUTE=$$GET1^DID(FILE,FLD,,"INPUT TRANSFORM")
"RTN","IBCNBLA1",198,0)
 X XCUTE
"RTN","IBCNBLA1",199,0)
 Q $D(X)
"RTN","IBCNEAMC")
0^10^B32146789
"RTN","IBCNEAMC",1,0)
IBCNEAMC ;DAOU/ESG - IIV AUTO MATCH BUFFER LISTING ;11-JUN-2002
"RTN","IBCNEAMC",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEAMC",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEAMC",4,0)
 ;
"RTN","IBCNEAMC",5,0)
EN ; -- main entry point for IBCNE AUTO MATCH BUFFER LIST
"RTN","IBCNEAMC",6,0)
 NEW IBCNENIL,COL,CTRLCOL,FINISH,POP,VALMBCK,X,%DT
"RTN","IBCNEAMC",7,0)
 D EN^VALM("IBCNE AUTO MATCH BUFFER LIST")
"RTN","IBCNEAMC",8,0)
 Q
"RTN","IBCNEAMC",9,0)
 ;
"RTN","IBCNEAMC",10,0)
HDR ; -- header code
"RTN","IBCNEAMC",11,0)
 S VALMHDR(1)="These are Insurance Company names from the Insurance Buffer file that do not"
"RTN","IBCNEAMC",12,0)
 S VALMHDR(2)="exist in the Insurance Company file (either as Names or as Synonyms).  They"
"RTN","IBCNEAMC",13,0)
 S VALMHDR(3)="also do not exist or pattern match with any entry in the Auto Match file."
"RTN","IBCNEAMC",14,0)
 Q
"RTN","IBCNEAMC",15,0)
 ;
"RTN","IBCNEAMC",16,0)
INIT ; -- init variables and list array
"RTN","IBCNEAMC",17,0)
 NEW ENTDATE,IBBUFDA,BUFFNAME
"RTN","IBCNEAMC",18,0)
 KILL ^TMP($J,"IBCNEAMC")
"RTN","IBCNEAMC",19,0)
 S IBCNENIL=0        ; initialize the no data flag
"RTN","IBCNEAMC",20,0)
 S ENTDATE=0
"RTN","IBCNEAMC",21,0)
 F  S ENTDATE=$O(^IBA(355.33,"AEST","E",ENTDATE)) Q:'ENTDATE  S IBBUFDA=0 F  S IBBUFDA=$O(^IBA(355.33,"AEST","E",ENTDATE,IBBUFDA)) Q:'IBBUFDA  D
"RTN","IBCNEAMC",22,0)
 . S BUFFNAME=$$TRIM($P($G(^IBA(355.33,IBBUFDA,20)),U,1))
"RTN","IBCNEAMC",23,0)
 . I BUFFNAME="" Q                       ; no name in buffer file
"RTN","IBCNEAMC",24,0)
 . I $D(^DIC(36,"B",BUFFNAME)) Q         ; insurance company name
"RTN","IBCNEAMC",25,0)
 . I $D(^DIC(36,"C",BUFFNAME)) Q         ; insurance company synonym
"RTN","IBCNEAMC",26,0)
 . I $$AMLOOK^IBCNEUT1(BUFFNAME) Q       ; Auto Match file lookup
"RTN","IBCNEAMC",27,0)
 . S ^TMP($J,"IBCNEAMC",2,BUFFNAME)=""   ; name not found so add it
"RTN","IBCNEAMC",28,0)
 . Q
"RTN","IBCNEAMC",29,0)
 ; Now build the ListMan array for display
"RTN","IBCNEAMC",30,0)
 S BUFFNAME="",VALMCNT=0
"RTN","IBCNEAMC",31,0)
 F  S BUFFNAME=$O(^TMP($J,"IBCNEAMC",2,BUFFNAME)) Q:BUFFNAME=""  D
"RTN","IBCNEAMC",32,0)
 . S VALMCNT=VALMCNT+1
"RTN","IBCNEAMC",33,0)
 . S ^TMP($J,"IBCNEAMC",1,VALMCNT,0)=$J(VALMCNT,4)_"  "_BUFFNAME
"RTN","IBCNEAMC",34,0)
 . S ^TMP($J,"IBCNEAMC",3,VALMCNT)=BUFFNAME
"RTN","IBCNEAMC",35,0)
 . Q
"RTN","IBCNEAMC",36,0)
 ;
"RTN","IBCNEAMC",37,0)
 ; Check to see if there's no data
"RTN","IBCNEAMC",38,0)
 I 'VALMCNT D
"RTN","IBCNEAMC",39,0)
 . S IBCNENIL=1     ; no data flag is true
"RTN","IBCNEAMC",40,0)
 . S ^TMP($J,"IBCNEAMC",1,1,0)=""
"RTN","IBCNEAMC",41,0)
 . S ^TMP($J,"IBCNEAMC",1,2,0)=""
"RTN","IBCNEAMC",42,0)
 . S ^TMP($J,"IBCNEAMC",1,3,0)="     There is no data to display."
"RTN","IBCNEAMC",43,0)
 . S VALMCNT=3
"RTN","IBCNEAMC",44,0)
 . Q
"RTN","IBCNEAMC",45,0)
INITX ;
"RTN","IBCNEAMC",46,0)
 Q
"RTN","IBCNEAMC",47,0)
 ;
"RTN","IBCNEAMC",48,0)
 ; For speed reasons, code taken from TRIM^XLFSTR
"RTN","IBCNEAMC",49,0)
TRIM(X,SIDE,CHAR) ; Trim chars from left/right of string
"RTN","IBCNEAMC",50,0)
 NEW LEFT,RIGHT
"RTN","IBCNEAMC",51,0)
 I X="" Q X
"RTN","IBCNEAMC",52,0)
 S SIDE=$G(SIDE,"LR"),CHAR=$G(CHAR," "),LEFT=1,RIGHT=$L(X)
"RTN","IBCNEAMC",53,0)
 I X=CHAR Q ""
"RTN","IBCNEAMC",54,0)
 I SIDE["R" F RIGHT=$L(X):-1:1 Q:$E(X,RIGHT)'=CHAR
"RTN","IBCNEAMC",55,0)
 I SIDE["L" F LEFT=1:1:$L(X) Q:$E(X,LEFT)'=CHAR
"RTN","IBCNEAMC",56,0)
 Q $E(X,LEFT,RIGHT)
"RTN","IBCNEAMC",57,0)
 ;
"RTN","IBCNEAMC",58,0)
 ;
"RTN","IBCNEAMC",59,0)
HELP ; -- help code
"RTN","IBCNEAMC",60,0)
 D FULL^VALM1
"RTN","IBCNEAMC",61,0)
 W !!," There are three main actions you may take on this screen."
"RTN","IBCNEAMC",62,0)
 W !," You may select an action by typing in the first character of the action."
"RTN","IBCNEAMC",63,0)
 W !!,"   Select Entry"
"RTN","IBCNEAMC",64,0)
 W !,"     You choose a single insurance company name from the list."
"RTN","IBCNEAMC",65,0)
 W !,"     This name becomes the default Auto Match value for a new"
"RTN","IBCNEAMC",66,0)
 W !,"     Auto Match entry.  You may then associate this Auto Match value"
"RTN","IBCNEAMC",67,0)
 W !,"     with a valid insurance company name."
"RTN","IBCNEAMC",68,0)
 W !!,"   Auto Match Enter/Edit"
"RTN","IBCNEAMC",69,0)
 W !,"     This action will take you to the Enter/Edit Auto Match Entries"
"RTN","IBCNEAMC",70,0)
 W !,"     option.  You may add, edit, or delete multiple Auto Match"
"RTN","IBCNEAMC",71,0)
 W !,"     entries in this option."
"RTN","IBCNEAMC",72,0)
 W !!,"   Exit"
"RTN","IBCNEAMC",73,0)
 W !,"     Exit out of this option."
"RTN","IBCNEAMC",74,0)
 D PAUSE^VALM1
"RTN","IBCNEAMC",75,0)
 S VALMBCK="R"
"RTN","IBCNEAMC",76,0)
HELPX ;
"RTN","IBCNEAMC",77,0)
 Q
"RTN","IBCNEAMC",78,0)
 ;
"RTN","IBCNEAMC",79,0)
 ;
"RTN","IBCNEAMC",80,0)
EXIT ; -- exit code
"RTN","IBCNEAMC",81,0)
 KILL ^TMP($J,"IBCNEAMC")
"RTN","IBCNEAMC",82,0)
 Q
"RTN","IBCNEAMC",83,0)
 ;
"RTN","IBCNEAMC",84,0)
 ;
"RTN","IBCNEAMC",85,0)
SELECT ; -- select an entry from the list
"RTN","IBCNEAMC",86,0)
 NEW STOP,AMIEN,NEWENTRY,BUFFNAME,INSNM
"RTN","IBCNEAMC",87,0)
 NEW DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","IBCNEAMC",88,0)
 D FULL^VALM1
"RTN","IBCNEAMC",89,0)
 ;
"RTN","IBCNEAMC",90,0)
 ; Check for Auto Match security key before allowing selection
"RTN","IBCNEAMC",91,0)
 I '$$KCHK^XUSRB("IBCNE IIV AUTO MATCH") D  G SELECTX
"RTN","IBCNEAMC",92,0)
 . W !!?5,"You don't hold the proper security key to access this function."
"RTN","IBCNEAMC",93,0)
 . W !?5,"The necessary key is IBCNE IIV AUTO MATCH.  Please see your manager."
"RTN","IBCNEAMC",94,0)
 . D PAUSE^VALM1
"RTN","IBCNEAMC",95,0)
 . Q
"RTN","IBCNEAMC",96,0)
 ;
"RTN","IBCNEAMC",97,0)
 ; Make sure there is something there
"RTN","IBCNEAMC",98,0)
 I IBCNENIL D  G SELECTX
"RTN","IBCNEAMC",99,0)
 . W !!?5,"There are no entries in the list."
"RTN","IBCNEAMC",100,0)
 . D PAUSE^VALM1
"RTN","IBCNEAMC",101,0)
 . Q
"RTN","IBCNEAMC",102,0)
 ;
"RTN","IBCNEAMC",103,0)
 S DIR(0)="NO^1:"_VALMCNT_":0"
"RTN","IBCNEAMC",104,0)
 S DIR("A")="Select Entry"
"RTN","IBCNEAMC",105,0)
 S DIR("?",1)=" Please enter the line number corresponding to the insurance company name."
"RTN","IBCNEAMC",106,0)
 S DIR("?",2)=" The valid range of line numbers is displayed in the prompt."
"RTN","IBCNEAMC",107,0)
 S DIR("?",3)=" "
"RTN","IBCNEAMC",108,0)
 S DIR("?",4)=" The insurance company name you select will be used as the default response for"
"RTN","IBCNEAMC",109,0)
 S DIR("?",5)=" a new Auto Match entry.  You may either accept this entry as is or you may"
"RTN","IBCNEAMC",110,0)
 S DIR("?")=" modify it by changing the spelling or by adding wildcard characters."
"RTN","IBCNEAMC",111,0)
 D ^DIR K DIR
"RTN","IBCNEAMC",112,0)
 I 'Y G SELECTX
"RTN","IBCNEAMC",113,0)
 S BUFFNAME=$G(^TMP($J,"IBCNEAMC",3,Y))
"RTN","IBCNEAMC",114,0)
 I BUFFNAME="" W ! G SELECTX
"RTN","IBCNEAMC",115,0)
 W "  ",BUFFNAME,!
"RTN","IBCNEAMC",116,0)
 ;
"RTN","IBCNEAMC",117,0)
 D LOOKUP I STOP G SELECTX ;Prompt user for Insurance Co.
"RTN","IBCNEAMC",118,0)
 I $D(^IBCN(365.11,"B",BUFFNAME)) D  G SELECTX ; has entry been added?
"RTN","IBCNEAMC",119,0)
 . W !!,BUFFNAME," has already been added to the Auto Match file."
"RTN","IBCNEAMC",120,0)
 . S DIR(0)="E" D ^DIR K DIR
"RTN","IBCNEAMC",121,0)
 . D INIT ; refresh listing
"RTN","IBCNEAMC",122,0)
 D AMADD^IBCNEUT6(INSNM,BUFFNAME)
"RTN","IBCNEAMC",123,0)
 D INIT
"RTN","IBCNEAMC",124,0)
SELECTX ;
"RTN","IBCNEAMC",125,0)
 S VALMBCK="R"
"RTN","IBCNEAMC",126,0)
 Q
"RTN","IBCNEAMC",127,0)
 ;
"RTN","IBCNEAMC",128,0)
LOOKUP ; Prompt for associated Insurance Company
"RTN","IBCNEAMC",129,0)
 S STOP=0
"RTN","IBCNEAMC",130,0)
 S DIC=36,DIC(0)="AEMVZ"
"RTN","IBCNEAMC",131,0)
 D ^DIC
"RTN","IBCNEAMC",132,0)
 I Y<1!$D(DTOUT)!$D(DUOUT) S STOP=1 G LOOKX
"RTN","IBCNEAMC",133,0)
 S INSNM=$P(Y(0),U)
"RTN","IBCNEAMC",134,0)
LOOKX Q
"RTN","IBCNEAMC",135,0)
 ;
"RTN","IBCNEAMC",136,0)
LINK ; -- link to the Auto Match Enter/Edit option
"RTN","IBCNEAMC",137,0)
 D FULL^VALM1
"RTN","IBCNEAMC",138,0)
 ;
"RTN","IBCNEAMC",139,0)
 ; Check for Auto Match security key before allowing selection
"RTN","IBCNEAMC",140,0)
 I '$$KCHK^XUSRB("IBCNE IIV AUTO MATCH") D  G LINKX
"RTN","IBCNEAMC",141,0)
 . W !!?5,"You don't hold the proper security key to access this function."
"RTN","IBCNEAMC",142,0)
 . W !?5,"The necessary key is IBCNE IIV AUTO MATCH.  Please see your manager."
"RTN","IBCNEAMC",143,0)
 . D PAUSE^VALM1
"RTN","IBCNEAMC",144,0)
 . Q
"RTN","IBCNEAMC",145,0)
 ;
"RTN","IBCNEAMC",146,0)
 D ENTER^IBCNEAME
"RTN","IBCNEAMC",147,0)
LINKX ;
"RTN","IBCNEAMC",148,0)
 D INIT S VALMBCK="R"
"RTN","IBCNEAMC",149,0)
 Q
"RTN","IBCNEAMC",150,0)
 ;
"RTN","IBCNEAME")
0^11^B9090150
"RTN","IBCNEAME",1,0)
IBCNEAME ;DAOU/ESG - IIV AUTO MATCH ENTRY/EDIT ;29-APR-2002
"RTN","IBCNEAME",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEAME",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEAME",4,0)
 ;
"RTN","IBCNEAME",5,0)
ENTER ;
"RTN","IBCNEAME",6,0)
 NEW STOP,AMIEN,NEWENTRY
"RTN","IBCNEAME",7,0)
 D INIT
"RTN","IBCNEAME",8,0)
LOOP ;
"RTN","IBCNEAME",9,0)
 D LOOKUP() I STOP G EXIT   ; lookup or add an entry
"RTN","IBCNEAME",10,0)
 D EDIT I STOP G LOOP       ; edit the entry values
"RTN","IBCNEAME",11,0)
 D CONFIRM                  ; display a confirmation message
"RTN","IBCNEAME",12,0)
 G LOOP                     ; repeat
"RTN","IBCNEAME",13,0)
EXIT ;
"RTN","IBCNEAME",14,0)
 Q
"RTN","IBCNEAME",15,0)
 ;
"RTN","IBCNEAME",16,0)
 ;
"RTN","IBCNEAME",17,0)
INIT ; clear the screen; display the purpose of this option
"RTN","IBCNEAME",18,0)
 W @IOF
"RTN","IBCNEAME",19,0)
 W !?14,"Enter/Edit Insurance Company Name Auto Match Entries"
"RTN","IBCNEAME",20,0)
 W !!,"This option will allow you to enter, edit, and manage the entries in the"
"RTN","IBCNEAME",21,0)
 W !,"Insurance Company Auto Match file.  This file will aid in the proper selection"
"RTN","IBCNEAME",22,0)
 W !,"of Insurance Companies by associating together a valid, correct Insurance"
"RTN","IBCNEAME",23,0)
 W !,"Company name with an incorrect entry that a clerk may enter during data entry."
"RTN","IBCNEAME",24,0)
 W !
"RTN","IBCNEAME",25,0)
INITX ;
"RTN","IBCNEAME",26,0)
 Q
"RTN","IBCNEAME",27,0)
 ;
"RTN","IBCNEAME",28,0)
LOOKUP(DEFAULT) ; Procedure to look-up or add an entry
"RTN","IBCNEAME",29,0)
 ;
"RTN","IBCNEAME",30,0)
 ; Optional input parameter DEFAULT will be set if calling this
"RTN","IBCNEAME",31,0)
 ; procedure from routine IBCNEAMC.  Otherwise it will be undefined.
"RTN","IBCNEAME",32,0)
 ;
"RTN","IBCNEAME",33,0)
 NEW DA,DIC,DILN,DISYS,X,Y,DTOUT,DUOUT
"RTN","IBCNEAME",34,0)
 S STOP=0
"RTN","IBCNEAME",35,0)
 S (AMIEN,NEWENTRY)=""
"RTN","IBCNEAME",36,0)
 S DIC="^IBCN(365.11,",DLAYGO=365.11
"RTN","IBCNEAME",37,0)
 S DIC(0)="AELMVZ"
"RTN","IBCNEAME",38,0)
 S DIC("A")="Select an Auto Match Entry: "
"RTN","IBCNEAME",39,0)
 I $G(DEFAULT)'="" S DIC("B")=DEFAULT
"RTN","IBCNEAME",40,0)
 S DIC("W")="D LIST^IBCNEAME(Y)"
"RTN","IBCNEAME",41,0)
 D ^DIC
"RTN","IBCNEAME",42,0)
 I Y=-1!$D(DTOUT)!$D(DUOUT) S STOP=1 G LOOKX
"RTN","IBCNEAME",43,0)
 S AMIEN=+Y
"RTN","IBCNEAME",44,0)
 I $P(Y,U,3) S NEWENTRY=1
"RTN","IBCNEAME",45,0)
LOOKX ;
"RTN","IBCNEAME",46,0)
 Q
"RTN","IBCNEAME",47,0)
 ;
"RTN","IBCNEAME",48,0)
EDIT ; Procedure to Edit the fields for this entry
"RTN","IBCNEAME",49,0)
 NEW DIE,DA,DR,DTOUT,D,D0,DDH,DI,DIC,DISYS,DQ,DZ,X,Y
"RTN","IBCNEAME",50,0)
 S DIE=365.11
"RTN","IBCNEAME",51,0)
 S DA=AMIEN
"RTN","IBCNEAME",52,0)
 S DR=".01;.02;.05////"_$$NOW^XLFDT_";.06////"_DUZ
"RTN","IBCNEAME",53,0)
 I NEWENTRY D
"RTN","IBCNEAME",54,0)
 . ; if this is a new entry, then stuff in all of these fields
"RTN","IBCNEAME",55,0)
 . ; without user interaction
"RTN","IBCNEAME",56,0)
 . S DR=".03////"_$$NOW^XLFDT_";.04////"_DUZ
"RTN","IBCNEAME",57,0)
 . S DR=DR_";.05////"_$$NOW^XLFDT_";.06////"_DUZ
"RTN","IBCNEAME",58,0)
 . S DR=DR_";.07////"_$P($G(^IBCN(365.11,DA,0)),U,1)
"RTN","IBCNEAME",59,0)
 . S DR=DR_";.08////"_$P($G(^IBCN(365.11,DA,0)),U,2)
"RTN","IBCNEAME",60,0)
 . Q
"RTN","IBCNEAME",61,0)
 D ^DIE
"RTN","IBCNEAME",62,0)
 I $D(Y) W ! S STOP=1 G EDITX         ; user entered up arrow
"RTN","IBCNEAME",63,0)
 I '$D(DA) W !!?3,"This entry has been deleted.",! S STOP=1 G EDITX
"RTN","IBCNEAME",64,0)
EDITX ;
"RTN","IBCNEAME",65,0)
 Q
"RTN","IBCNEAME",66,0)
 ;
"RTN","IBCNEAME",67,0)
CONFIRM ; Display a confirmation message indicating what was filed
"RTN","IBCNEAME",68,0)
 NEW DATA
"RTN","IBCNEAME",69,0)
 I 'AMIEN G CONFX
"RTN","IBCNEAME",70,0)
 S DATA=$G(^IBCN(365.11,AMIEN,0))
"RTN","IBCNEAME",71,0)
 W !!?3,$P(DATA,U,1)," is now associated with ",$P(DATA,U,2),".",!
"RTN","IBCNEAME",72,0)
CONFX ;
"RTN","IBCNEAME",73,0)
 Q
"RTN","IBCNEAME",74,0)
 ;
"RTN","IBCNEAME",75,0)
LIST(IEN) ; FileMan lister display
"RTN","IBCNEAME",76,0)
 NEW DATA,D1,D2
"RTN","IBCNEAME",77,0)
 ; DATA=^IBCN(365.11,IEN,0)
"RTN","IBCNEAME",78,0)
 S DATA=^(0)
"RTN","IBCNEAME",79,0)
 S D1=$P(DATA,U,1),D2=$P(DATA,U,2)
"RTN","IBCNEAME",80,0)
 W $$FO^IBCNEUT1("",12-$L(D1))," is associated with ",D2
"RTN","IBCNEAME",81,0)
LISTX ;
"RTN","IBCNEAME",82,0)
 Q
"RTN","IBCNEAME",83,0)
 ;
"RTN","IBCNEHLI")
0^12^B6661034
"RTN","IBCNEHLI",1,0)
IBCNEHLI ;DAOU/ALA - Incoming HL7 messages ;16-JUN-2002
"RTN","IBCNEHLI",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEHLI",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEHLI",4,0)
 ;
"RTN","IBCNEHLI",5,0)
 ;**Program Description**
"RTN","IBCNEHLI",6,0)
 ;  This program parses each incoming HL7 message.
"RTN","IBCNEHLI",7,0)
 ;
"RTN","IBCNEHLI",8,0)
EN ;  Starting point - put message into a TMP global
"RTN","IBCNEHLI",9,0)
 ;
"RTN","IBCNEHLI",10,0)
 N ACK,BUFF,DFN,ERACT,ERCON,ERFLG,ERTXT,EVENT,HCT,HL,HLECH,HLEID
"RTN","IBCNEHLI",11,0)
 N HLEIDS,HLFS,HLQ,IBPRTCL,IDUZ,MGRP,MSGID,RDAT0,RIEN,SBDEP,SEG
"RTN","IBCNEHLI",12,0)
 N SEGMT,SEGMT2,TAG,TQN,TRACE,VRFDT,DISYS,IPCT,PAYRID,PIEN,CNT
"RTN","IBCNEHLI",13,0)
 N ERROR,IRIEN,RSTYPE,SUBID,TQIEN
"RTN","IBCNEHLI",14,0)
 N DA,EBDA,IBFDA,II,MSGP,SYMBOL,IBSEG,PP,PRIEN,QFL,IBIEN,TQDATA,IBQFL
"RTN","IBCNEHLI",15,0)
 ;
"RTN","IBCNEHLI",16,0)
 K ^TMP($J,"IBCNEHLI")
"RTN","IBCNEHLI",17,0)
 F SEGCNT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","IBCNEHLI",18,0)
 . S CNT=0
"RTN","IBCNEHLI",19,0)
 . S ^TMP($J,"IBCNEHLI",SEGCNT,CNT)=HLNODE
"RTN","IBCNEHLI",20,0)
 . F  S CNT=$O(HLNODE(CNT)) Q:'CNT  D
"RTN","IBCNEHLI",21,0)
 .. S ^TMP($J,"IBCNEHLI",SEGCNT,CNT)=HLNODE(CNT)
"RTN","IBCNEHLI",22,0)
 ;
"RTN","IBCNEHLI",23,0)
 ;  Get the IIV user
"RTN","IBCNEHLI",24,0)
 S IDUZ=$$FIND1^DIC(200,"","X","INTERFACE,IB IIV")
"RTN","IBCNEHLI",25,0)
 ;   Determine which protocol to use
"RTN","IBCNEHLI",26,0)
 S SEGMT=$G(^TMP($J,"IBCNEHLI",1,0))
"RTN","IBCNEHLI",27,0)
 I $E(SEGMT,1,3)'="MSH" S MSG(1)="MSH Segment is not the first segment found" D ERR Q
"RTN","IBCNEHLI",28,0)
 S HLFS=$E(SEGMT,4)
"RTN","IBCNEHLI",29,0)
 S EVENT=$P(SEGMT,HLFS,9),IBPRTCL=""
"RTN","IBCNEHLI",30,0)
 ;
"RTN","IBCNEHLI",31,0)
 ;  The event type determines protocol
"RTN","IBCNEHLI",32,0)
 I EVENT="MFN^M01" S TAG="TBL",IBPRTCL="IBCNE IIV MFN IN"
"RTN","IBCNEHLI",33,0)
 I EVENT="RPI^I01" S TAG="RSP",IBPRTCL="IBCNE IIV IN"
"RTN","IBCNEHLI",34,0)
 I EVENT="MFK^M01" S TAG="ACK",IBPRTCL="IBCNE IIV REGISTER"
"RTN","IBCNEHLI",35,0)
 I IBPRTCL="" S MSG(1)="Unable to find a protocol for Event = "_EVENT D ERR Q
"RTN","IBCNEHLI",36,0)
 S HLEID=$$HLP^IBCNEHLU(IBPRTCL)
"RTN","IBCNEHLI",37,0)
 ;
"RTN","IBCNEHLI",38,0)
 ;  Initialize the HL7 variables
"RTN","IBCNEHLI",39,0)
 D INIT^HLFNC2(HLEID,.HL)
"RTN","IBCNEHLI",40,0)
 S HLEIDS=$O(^ORD(101,HLEID,775,"B",0))
"RTN","IBCNEHLI",41,0)
 ;
"RTN","IBCNEHLI",42,0)
 ;  Call the event tag
"RTN","IBCNEHLI",43,0)
 D @TAG
"RTN","IBCNEHLI",44,0)
 ;
"RTN","IBCNEHLI",45,0)
 K ^TMP($J,"IBCNEHLI"),HLNEXT,HLNODE,HLQUIT,SEGCNT
"RTN","IBCNEHLI",46,0)
 Q
"RTN","IBCNEHLI",47,0)
 ;
"RTN","IBCNEHLI",48,0)
TBL ;  Table Update Processing
"RTN","IBCNEHLI",49,0)
 D ^IBCNEHLT
"RTN","IBCNEHLI",50,0)
 ;
"RTN","IBCNEHLI",51,0)
 I ERFLG D ERR
"RTN","IBCNEHLI",52,0)
 ;
"RTN","IBCNEHLI",53,0)
 K ERFLG
"RTN","IBCNEHLI",54,0)
 Q
"RTN","IBCNEHLI",55,0)
 ;
"RTN","IBCNEHLI",56,0)
RSP ;  Response Processing
"RTN","IBCNEHLI",57,0)
 D ^IBCNEHLR
"RTN","IBCNEHLI",58,0)
 ;
"RTN","IBCNEHLI",59,0)
 K ACK,BUFF,DFN,ERACT,ERCON,ERFLG,ERTXT,EVENT,HCT,HL,HLECH,HLEID
"RTN","IBCNEHLI",60,0)
 K HLEIDS,HLFS,HLQ,IBPRTCL,IDUZ,MGRP,MSGID,RDAT0,RIEN,SBDEP,SEG
"RTN","IBCNEHLI",61,0)
 K SEGMT,SEGMT2,TAG,TQN,TRACE,VRFDT,DISYS,IPCT,PAYRID,PIEN
"RTN","IBCNEHLI",62,0)
 K ERROR,IRIEN,RSTYPE,SUBID,TQIEN
"RTN","IBCNEHLI",63,0)
 K DA,EBDA,IBFDA,II,MSGP,SYMBOL,IBSEG,PP,PRIEN,QFL
"RTN","IBCNEHLI",64,0)
 Q
"RTN","IBCNEHLI",65,0)
 ;
"RTN","IBCNEHLI",66,0)
ACK ;  Acknowledgement Processing
"RTN","IBCNEHLI",67,0)
 D ^IBCNEHLK
"RTN","IBCNEHLI",68,0)
 ;
"RTN","IBCNEHLI",69,0)
 Q
"RTN","IBCNEHLI",70,0)
 ;
"RTN","IBCNEHLI",71,0)
ERR ; Process an error
"RTN","IBCNEHLI",72,0)
 S MGRP=$$MGRP^IBCNEUT5()
"RTN","IBCNEHLI",73,0)
 D MSG^IBCNEUT5(MGRP,"INCOMING IIV HL7 PROBLEM","MSG(")
"RTN","IBCNEHLI",74,0)
 K MSG,MGRP
"RTN","IBCNEHLI",75,0)
 Q
"RTN","IBCNEHLP")
0^6^B75367905
"RTN","IBCNEHLP",1,0)
IBCNEHLP ;DAOU/ALA - HL7 Process Incoming RPI Msgs (cont.) ;26-JUN-2002
"RTN","IBCNEHLP",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEHLP",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEHLP",4,0)
 ;
"RTN","IBCNEHLP",5,0)
 ;**Program Description**
"RTN","IBCNEHLP",6,0)
 ;  This program will process the individual segments of the 
"RTN","IBCNEHLP",7,0)
 ;  incoming IIV response messages.
"RTN","IBCNEHLP",8,0)
 ; 
"RTN","IBCNEHLP",9,0)
 ; * Each of these tags are called by IBCNEHLR.
"RTN","IBCNEHLP",10,0)
 ;
"RTN","IBCNEHLP",11,0)
 ;  Variables
"RTN","IBCNEHLP",12,0)
 ;    SEG = HL7 Segment Name
"RTN","IBCNEHLP",13,0)
 ;    MSGID = Original Message Control ID
"RTN","IBCNEHLP",14,0)
 ;    ACK =  Acknowledgment (AA=Accepted, AE=Error)
"RTN","IBCNEHLP",15,0)
 ;    ERTXT = Error Message Text
"RTN","IBCNEHLP",16,0)
 ;    ERFLG = Error quit flag
"RTN","IBCNEHLP",17,0)
 ;    ERACT = Error Action
"RTN","IBCNEHLP",18,0)
 ;    ERCON = Error Condition
"RTN","IBCNEHLP",19,0)
 ;    RIEN = Response Record IEN
"RTN","IBCNEHLP",20,0)
 ;
"RTN","IBCNEHLP",21,0)
 Q  ; No direct calls
"RTN","IBCNEHLP",22,0)
 ;
"RTN","IBCNEHLP",23,0)
MSA ;  Process the MSA segment
"RTN","IBCNEHLP",24,0)
 S ACK=$G(IBSEG(2)),MSGID=$G(IBSEG(3)),TRACE=$G(IBSEG(5))
"RTN","IBCNEHLP",25,0)
 S ERTXT=$G(IBSEG(4)),ERACT=$G(IBSEG(6)),ERCON=$G(IBSEG(7))
"RTN","IBCNEHLP",26,0)
 ;
"RTN","IBCNEHLP",27,0)
 I MSGID="" D  G MSAX
"RTN","IBCNEHLP",28,0)
 . ;Find the PID segment to extract ICN and patient name
"RTN","IBCNEHLP",29,0)
 . N ICN,NAME
"RTN","IBCNEHLP",30,0)
 . S (ICN,NAME)=""
"RTN","IBCNEHLP",31,0)
 . F  S HCT=$O(^TMP($J,"IBCNEHLI",HCT)) Q:HCT=""  D  Q:ERFLG
"RTN","IBCNEHLP",32,0)
 ..  D SPAR
"RTN","IBCNEHLP",33,0)
 ..  S SEG=$G(IBSEG(1)) Q:SEG'="PID"
"RTN","IBCNEHLP",34,0)
 ..  S ICN=$G(IBSEG(4)),NAME=$G(IBSEG(6)),ERFLG=1
"RTN","IBCNEHLP",35,0)
 . D ERRMSG S ERFLG=1
"RTN","IBCNEHLP",36,0)
 ;
"RTN","IBCNEHLP",37,0)
 ;  Check for message id/payer combination and get response IEN
"RTN","IBCNEHLP",38,0)
 D PCK^IBCNEHLS
"RTN","IBCNEHLP",39,0)
 ;
"RTN","IBCNEHLP",40,0)
 ;  If no record IEN, quit
"RTN","IBCNEHLP",41,0)
 I $G(RIEN)="" G MSAX
"RTN","IBCNEHLP",42,0)
 ;
"RTN","IBCNEHLP",43,0)
 ; Update record with information
"RTN","IBCNEHLP",44,0)
 S RSUPDT(365,RIEN_",",.09)=TRACE,RSUPDT(365,RIEN_",",.06)=3
"RTN","IBCNEHLP",45,0)
 S RSUPDT(365,RIEN_",",4.01)=ERTXT
"RTN","IBCNEHLP",46,0)
 S VRFDT=$$NOW^XLFDT(),RSUPDT(365,RIEN_",",.07)=VRFDT
"RTN","IBCNEHLP",47,0)
 ;
"RTN","IBCNEHLP",48,0)
 ; Update with internal values
"RTN","IBCNEHLP",49,0)
 D FILE^DIE("I","RSUPDT","ERROR")
"RTN","IBCNEHLP",50,0)
 ;
"RTN","IBCNEHLP",51,0)
 S RSUPDT(365,RIEN_",",1.14)=ERCON,RSUPDT(365,RIEN_",",1.15)=ERACT
"RTN","IBCNEHLP",52,0)
 ;
"RTN","IBCNEHLP",53,0)
 ; Update with external values
"RTN","IBCNEHLP",54,0)
 D FILE^DIE("E","RSUPDT","ERROR")
"RTN","IBCNEHLP",55,0)
MSAX ;
"RTN","IBCNEHLP",56,0)
 Q
"RTN","IBCNEHLP",57,0)
 ;
"RTN","IBCNEHLP",58,0)
CTD ;  Contact segment processing
"RTN","IBCNEHLP",59,0)
 NEW CTNAME,CTQUAL,CTNUM,CTQIEN,IENS,FLD,DATA,II,FFL
"RTN","IBCNEHLP",60,0)
 ;
"RTN","IBCNEHLP",61,0)
 ;  Parse out data from segment
"RTN","IBCNEHLP",62,0)
 S CTNAME=$G(IBSEG(3)),CTQUAL=$G(IBSEG(7)),CTNUM=$G(IBSEG(6))
"RTN","IBCNEHLP",63,0)
 I $TR(CTNAME," ")="" S CTNAME="NOT SPECIFIED"
"RTN","IBCNEHLP",64,0)
 S CTQIEN=$$FIND1^DIC(365.021,"","X",CTQUAL)
"RTN","IBCNEHLP",65,0)
 I CTNAME[$E(HLECH,1,1) S CTNAME=$$FMNAME^HLFNC(CTNAME,HLECH)
"RTN","IBCNEHLP",66,0)
 S CTNAME=$E(CTNAME,1,32)
"RTN","IBCNEHLP",67,0)
 ;
"RTN","IBCNEHLP",68,0)
 ;  Look up contact person
"RTN","IBCNEHLP",69,0)
 NEW DA,DIC,DLAYGO,X,Y,D1,DILN,DISYS
"RTN","IBCNEHLP",70,0)
 S DA(1)=RIEN,DIC="^IBCN(365,"_DA(1)_",3,",DIC(0)="LZ",DLAYGO=365.03
"RTN","IBCNEHLP",71,0)
 I '$D(^IBCN(365,DA(1),3,0)) S ^IBCN(365,DA(1),3,0)="^365.03^^"
"RTN","IBCNEHLP",72,0)
 S X=CTNAME D ^DIC
"RTN","IBCNEHLP",73,0)
 S DA=+Y,DATA=^IBCN(365,DA(1),3,DA,0),FLD=2,FFL=0
"RTN","IBCNEHLP",74,0)
 ;
"RTN","IBCNEHLP",75,0)
 ;  Check if contact already has this communication qualifier on file
"RTN","IBCNEHLP",76,0)
 F II=2,4,6 I $P(DATA,U,II)=CTQIEN S FLD=II,FFL=1 Q
"RTN","IBCNEHLP",77,0)
 I 'FFL F II=2,4,6 I $P(DATA,U,II)="" S FLD=II Q
"RTN","IBCNEHLP",78,0)
 ;
"RTN","IBCNEHLP",79,0)
 S IENS=$$IENS^DILF(.DA)
"RTN","IBCNEHLP",80,0)
 S RSUPDT(365.03,IENS,".0"_(FLD+1))=CTNUM
"RTN","IBCNEHLP",81,0)
 S RSUPDT(365.03,IENS,".0"_FLD)=CTQIEN
"RTN","IBCNEHLP",82,0)
 D FILE^DIE("I","RSUPDT","ERROR")
"RTN","IBCNEHLP",83,0)
CTDX ;
"RTN","IBCNEHLP",84,0)
 Q
"RTN","IBCNEHLP",85,0)
 ;
"RTN","IBCNEHLP",86,0)
PID ;  Patient segment processing
"RTN","IBCNEHLP",87,0)
 NEW ICN,DOB,SEX,SSN,NAME,DFN,DOD,LUPDT,LFAC,XDFN
"RTN","IBCNEHLP",88,0)
 ;
"RTN","IBCNEHLP",89,0)
 S ICN=$G(IBSEG(4)),DOB=$G(IBSEG(8)),SEX=$G(IBSEG(9))
"RTN","IBCNEHLP",90,0)
 S SSN=$G(IBSEG(20)),NAME=$G(IBSEG(6)),DFN=$G(IBSEG(5))
"RTN","IBCNEHLP",91,0)
 S DOD=$G(IBSEG(30)),LUPDT=$G(IBSEG(34)),LFAC=$G(IBSEG(35))
"RTN","IBCNEHLP",92,0)
 ;
"RTN","IBCNEHLP",93,0)
 ;  Convert data from HL7 format to VISTA format
"RTN","IBCNEHLP",94,0)
 S NAME=$$FMNAME^HLFNC(NAME,HLECH)
"RTN","IBCNEHLP",95,0)
 S DOD=$$FMDATE^HLFNC(DOD),DOB=$$FMDATE^HLFNC(DOB),LUPDT=$$FMDATE^HLFNC(LUPDT)
"RTN","IBCNEHLP",96,0)
 ;
"RTN","IBCNEHLP",97,0)
 ; Use ICN to find the patients DFN at this site
"RTN","IBCNEHLP",98,0)
 S XDFN=$$GETDFN^MPIF001(ICN)
"RTN","IBCNEHLP",99,0)
 I +XDFN'>0,+ICN>0 D  Q
"RTN","IBCNEHLP",100,0)
 . S ERFLG=1,IERN=$$ERRN^IBCNEUT7("ERROR(""DIERR"")")
"RTN","IBCNEHLP",101,0)
 . S ERROR("DIERR",IERN,"TEXT",1)="Unable to determine the patient's DFN value for this site."
"RTN","IBCNEHLP",102,0)
 . S ERROR("DIERR",IERN,"TEXT",2)=" The ICN for the patient in this response is ICN: "_ICN
"RTN","IBCNEHLP",103,0)
 . S ERROR("DIERR",IERN,"TEXT",3)=" eIIV was unable to file the response information."
"RTN","IBCNEHLP",104,0)
 ;
"RTN","IBCNEHLP",105,0)
 I +ICN>0 S DFN=XDFN
"RTN","IBCNEHLP",106,0)
 ;
"RTN","IBCNEHLP",107,0)
 ;  Perform date of death check
"RTN","IBCNEHLP",108,0)
 I DOD'="" D DODCK
"RTN","IBCNEHLP",109,0)
 ;
"RTN","IBCNEHLP",110,0)
 I $P(^IBCN(365,RIEN,0),U,2)="" S RSUPDT(365,RIEN_",",.02)=DFN
"RTN","IBCNEHLP",111,0)
 S RSUPDT(365,RIEN_",",1.02)=DOB,RSUPDT(365,RIEN_",",1.04)=SEX
"RTN","IBCNEHLP",112,0)
 S RSUPDT(365,RIEN_",",1.03)=SSN,RSUPDT(365,RIEN_",",1.16)=DOD
"RTN","IBCNEHLP",113,0)
 S RSUPDT(365,RIEN_",",1.01)=NAME,RSUPDT(365,RIEN_",",1.08)="v"
"RTN","IBCNEHLP",114,0)
 S RSUPDT(365,RIEN_",",1.09)="01"
"RTN","IBCNEHLP",115,0)
 D FILE^DIE("I","RSUPDT","ERROR")
"RTN","IBCNEHLP",116,0)
PIDX ;
"RTN","IBCNEHLP",117,0)
 Q
"RTN","IBCNEHLP",118,0)
DODCK ;  Date of death check
"RTN","IBCNEHLP",119,0)
 NEW CDOD,CIDDSP,IDDSP,IDSSN,XMSUB,MSG
"RTN","IBCNEHLP",120,0)
 S CDOD=$P($G(^DPT(DFN,.35)),U,1),CIDDSP=$$FMTE^XLFDT(CDOD,"5Z")
"RTN","IBCNEHLP",121,0)
 S IDDSP=$$FMTE^XLFDT(DOD,"5Z")
"RTN","IBCNEHLP",122,0)
 S IDSSN=$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","IBCNEHLP",123,0)
 ;
"RTN","IBCNEHLP",124,0)
 ; If the two dates of death are the same, quit
"RTN","IBCNEHLP",125,0)
 I CDOD=DOD Q
"RTN","IBCNEHLP",126,0)
 ;
"RTN","IBCNEHLP",127,0)
 ;  If no current date of death but payer sent one
"RTN","IBCNEHLP",128,0)
 I CDOD="" D  Q
"RTN","IBCNEHLP",129,0)
 . ;  Send an email message
"RTN","IBCNEHLP",130,0)
 . S XMSUB="Date of Death Received"
"RTN","IBCNEHLP",131,0)
 . S MSG(1)="A Date of Death ("_IDDSP_") was received for patient: "_NAME_"/"_IDSSN_" from"
"RTN","IBCNEHLP",132,0)
 . S MSG(2)="payer "_$$GET1^DIQ(365,RIEN,.03,"E")_".  There is no current Date of Death on file for "
"RTN","IBCNEHLP",133,0)
 . S MSG(3)="this patient."
"RTN","IBCNEHLP",134,0)
 . D TXT^IBCNEUT7("MSG")
"RTN","IBCNEHLP",135,0)
 . D MSG^IBCNEUT5(MGRP,XMSUB,"MSG(")
"RTN","IBCNEHLP",136,0)
 ;
"RTN","IBCNEHLP",137,0)
 S XMSUB="Variant Date of Death"
"RTN","IBCNEHLP",138,0)
 S MSG(1)="A Date of Death ("_IDDSP_") was received for patient: "_NAME_"/"_IDSSN_" from payer "_$$GET1^DIQ(365,RIEN,.03,"E")_"."
"RTN","IBCNEHLP",139,0)
 S MSG(2)="This Date of Death does not currently match the Date of Death ("_CIDDSP_") on file for this patient. "
"RTN","IBCNEHLP",140,0)
 D TXT^IBCNEUT7("MSG")
"RTN","IBCNEHLP",141,0)
 D MSG^IBCNEUT5(MGRP,XMSUB,"MSG(")
"RTN","IBCNEHLP",142,0)
 ;
"RTN","IBCNEHLP",143,0)
 Q
"RTN","IBCNEHLP",144,0)
GT1 ;  Guarantor segment processing
"RTN","IBCNEHLP",145,0)
 NEW NAME,DOB,SEX,WHO,RELTN,SSN
"RTN","IBCNEHLP",146,0)
 S NAME=$G(IBSEG(4)),DOB=$G(IBSEG(9)),SEX=$G(IBSEG(10))
"RTN","IBCNEHLP",147,0)
 S WHO=$G(IBSEG(11)),RELTN=$G(IBSEG(12)),SSN=$G(IBSEG(13))
"RTN","IBCNEHLP",148,0)
 S SUBID=$G(IBSEG(3))
"RTN","IBCNEHLP",149,0)
 ;
"RTN","IBCNEHLP",150,0)
 S WHO=$S(WHO="01":"s",WHO="34":"o",1:WHO)
"RTN","IBCNEHLP",151,0)
 S DOB=$$FMDATE^HLFNC(DOB),NAME=$$FMNAME^HLFNC(NAME,HLECH)
"RTN","IBCNEHLP",152,0)
 ;
"RTN","IBCNEHLP",153,0)
 S RSUPDT(365,RIEN_",",1.01)=NAME,RSUPDT(365,RIEN_",",1.08)=WHO
"RTN","IBCNEHLP",154,0)
 S RSUPDT(365,RIEN_",",1.02)=DOB,RSUPDT(365,RIEN_",",1.04)=SEX
"RTN","IBCNEHLP",155,0)
 S RSUPDT(365,RIEN_",",1.03)=SSN,RSUPDT(365,RIEN_",",1.09)=RELTN
"RTN","IBCNEHLP",156,0)
 S RSUPDT(365,RIEN_",",1.18)=SUBID
"RTN","IBCNEHLP",157,0)
 D FILE^DIE("I","RSUPDT","ERROR")
"RTN","IBCNEHLP",158,0)
GT1X ;
"RTN","IBCNEHLP",159,0)
 Q
"RTN","IBCNEHLP",160,0)
IN1 ;  Insurance segment processing
"RTN","IBCNEHLP",161,0)
 NEW PAYRID,PYRNM,GNAME,GNUMB,EFFDT,EXPDT,COB,SRVDT,MBRID
"RTN","IBCNEHLP",162,0)
 ;
"RTN","IBCNEHLP",163,0)
 S MBRID=$G(IBSEG(3)),PAYRID=$G(IBSEG(4)),PYRNM=$G(IBSEG(5))
"RTN","IBCNEHLP",164,0)
 S GNAME=$G(IBSEG(10)),GNUMB=$G(IBSEG(9))
"RTN","IBCNEHLP",165,0)
 S EFFDT=$G(IBSEG(13)),EXPDT=$G(IBSEG(14))
"RTN","IBCNEHLP",166,0)
 S COB=$G(IBSEG(23)),SRVDT=$G(IBSEG(27))
"RTN","IBCNEHLP",167,0)
 ;
"RTN","IBCNEHLP",168,0)
 S EFFDT=$$FMDATE^HLFNC(EFFDT),EXPDT=$$FMDATE^HLFNC(EXPDT)
"RTN","IBCNEHLP",169,0)
 S SRVDT=$$FMDATE^HLFNC(SRVDT)
"RTN","IBCNEHLP",170,0)
 ;
"RTN","IBCNEHLP",171,0)
 S RSUPDT(365,RIEN_",",1.05)=$S($G(SUBID)'="":SUBID,1:MBRID)
"RTN","IBCNEHLP",172,0)
 S RSUPDT(365,RIEN_",",1.07)=GNUMB
"RTN","IBCNEHLP",173,0)
 S RSUPDT(365,RIEN_",",1.06)=GNAME,RSUPDT(365,RIEN_",",1.11)=EFFDT
"RTN","IBCNEHLP",174,0)
 S RSUPDT(365,RIEN_",",1.12)=EXPDT,RSUPDT(365,RIEN_",",1.1)=SRVDT
"RTN","IBCNEHLP",175,0)
 S RSUPDT(365,RIEN_",",1.13)=COB,RSUPDT(365,RIEN_",",1.18)=MBRID
"RTN","IBCNEHLP",176,0)
 D FILE^DIE("I","RSUPDT","ERROR")
"RTN","IBCNEHLP",177,0)
IN1X ;
"RTN","IBCNEHLP",178,0)
 Q
"RTN","IBCNEHLP",179,0)
IN3 ;  Addt'l Insurance - Cert Segment
"RTN","IBCNEHLP",180,0)
 NEW CRDT
"RTN","IBCNEHLP",181,0)
 ;
"RTN","IBCNEHLP",182,0)
 S CRDT=$G(IBSEG(8))
"RTN","IBCNEHLP",183,0)
 S CRDT=$$FMDATE^HLFNC(CRDT)
"RTN","IBCNEHLP",184,0)
 S RSUPDT(365,RIEN_",",1.17)=CRDT
"RTN","IBCNEHLP",185,0)
 D FILE^DIE("I","RSUPDT","ERROR")
"RTN","IBCNEHLP",186,0)
IN3X ;
"RTN","IBCNEHLP",187,0)
 Q
"RTN","IBCNEHLP",188,0)
ZEB ;  Eligibility/Benefit segment processing
"RTN","IBCNEHLP",189,0)
 NEW DA,DIC,DLAYGO,X,Y,D1,DILN,DISYS,EBN,IENS,RSUPDT
"RTN","IBCNEHLP",190,0)
 S EBN=$G(IBSEG(2))
"RTN","IBCNEHLP",191,0)
 S DA(1)=RIEN,DIC="^IBCN(365,"_DA(1)_",2,",DIC(0)="L",DLAYGO=365.02
"RTN","IBCNEHLP",192,0)
 I '$D(^IBCN(365,DA(1),2,0)) S ^IBCN(365,DA(1),2,0)="^365.02^^"
"RTN","IBCNEHLP",193,0)
 S X=EBN D ^DIC
"RTN","IBCNEHLP",194,0)
 S DA=+Y,EBDA=DA
"RTN","IBCNEHLP",195,0)
 ;
"RTN","IBCNEHLP",196,0)
 S IENS=$$IENS^DILF(.DA)
"RTN","IBCNEHLP",197,0)
 ;
"RTN","IBCNEHLP",198,0)
 F II=2:1:9 S RSUPDT(365.02,IENS,".0"_II)=$G(IBSEG(II+1))
"RTN","IBCNEHLP",199,0)
 S RSUPDT(365.02,IENS,".1")=$G(IBSEG(11))
"RTN","IBCNEHLP",200,0)
 F II=11:1:13 S RSUPDT(365.02,IENS,"."_II)=$G(IBSEG(II+1))
"RTN","IBCNEHLP",201,0)
 D FILE^DIE("E","RSUPDT","ERROR")
"RTN","IBCNEHLP",202,0)
ZEBX ;
"RTN","IBCNEHLP",203,0)
 Q
"RTN","IBCNEHLP",204,0)
NTE ;  Notes segment processing
"RTN","IBCNEHLP",205,0)
 I $G(EBDA)="" Q
"RTN","IBCNEHLP",206,0)
 S NOTES(1)=$G(IBSEG(4))
"RTN","IBCNEHLP",207,0)
 S DA(1)=RIEN,DA=EBDA
"RTN","IBCNEHLP",208,0)
 S IENS=$$IENS^DILF(.DA)
"RTN","IBCNEHLP",209,0)
 D WP^DIE(365.02,IENS,2,"A","NOTES","ERROR")
"RTN","IBCNEHLP",210,0)
 K NOTES
"RTN","IBCNEHLP",211,0)
NTEX ;
"RTN","IBCNEHLP",212,0)
 Q
"RTN","IBCNEHLP",213,0)
 ;
"RTN","IBCNEHLP",214,0)
SPAR ;  Segment Parsing
"RTN","IBCNEHLP",215,0)
 NEW ISCT,II,IJ,IK,ISDATA,ISPEC,ISBEG,ISEND,IS,LSDATA,IM,NPC
"RTN","IBCNEHLP",216,0)
 ;
"RTN","IBCNEHLP",217,0)
 S ISCT="",II=0,IS=0
"RTN","IBCNEHLP",218,0)
 F  S ISCT=$O(^TMP($J,"IBCNEHLI",HCT,ISCT)) Q:ISCT=""  D
"RTN","IBCNEHLP",219,0)
 . S IS=IS+1
"RTN","IBCNEHLP",220,0)
 . S ISDATA(IS)=$G(^TMP($J,"IBCNEHLI",HCT,ISCT))
"RTN","IBCNEHLP",221,0)
 . I $O(^TMP($J,"IBCNEHLI",HCT,ISCT))="" S ISDATA(IS)=ISDATA(IS)_"|"
"RTN","IBCNEHLP",222,0)
 . S ISPEC(IS)=$L(ISDATA(IS),HLFS)
"RTN","IBCNEHLP",223,0)
 ;
"RTN","IBCNEHLP",224,0)
 S IM=0,LSDATA=""
"RTN","IBCNEHLP",225,0)
LP S IM=IM+1 Q:IM>IS
"RTN","IBCNEHLP",226,0)
 S LSDATA=LSDATA_ISDATA(IM),NPC=ISPEC(IM)
"RTN","IBCNEHLP",227,0)
 F IJ=1:1:NPC-1 D
"RTN","IBCNEHLP",228,0)
 . S II=II+1,IBSEG(II)=$$CLNSTR($P(LSDATA,HLFS,IJ),HL("ECH"),$E(HL("ECH")))
"RTN","IBCNEHLP",229,0)
 S LSDATA=$P(LSDATA,HLFS,NPC)
"RTN","IBCNEHLP",230,0)
 G LP
"RTN","IBCNEHLP",231,0)
 ;
"RTN","IBCNEHLP",232,0)
CLNSTR(STRING,CHARS,SUBSEP) ; Remove extra trailing components and subcompo^
"RTN","IBCNEHLP",233,0)
 ;                         in the HL7 segment
"RTN","IBCNEHLP",234,0)
 N RTSTRING,NUMPEC,PEC
"RTN","IBCNEHLP",235,0)
 S RTSTRING=$$RTRIMCH(STRING,CHARS)
"RTN","IBCNEHLP",236,0)
 ; Now we have string without trailing chars, remove from subs
"RTN","IBCNEHLP",237,0)
 S NUMPEC=$L(RTSTRING,SUBSEP)
"RTN","IBCNEHLP",238,0)
 F PEC=1:1:NUMPEC S $P(RTSTRING,SUBSEP,PEC)=$$RTRIMCH($P(RTSTRING,SUBSEP,PEC),CHARS)
"RTN","IBCNEHLP",239,0)
 Q RTSTRING
"RTN","IBCNEHLP",240,0)
 ;
"RTN","IBCNEHLP",241,0)
RTRIMCH(STR,CHRS) ; Remove the trailing chars from string
"RTN","IBCNEHLP",242,0)
 N R,L
"RTN","IBCNEHLP",243,0)
 S L=1,CHRS=$G(CHRS," ")
"RTN","IBCNEHLP",244,0)
 F R=$L(STR):-1:1 Q:CHRS'[$E(STR,R)
"RTN","IBCNEHLP",245,0)
 I L=R,(CHRS[$E(STR)) S STR=""
"RTN","IBCNEHLP",246,0)
 Q $E(STR,L,R)
"RTN","IBCNEHLP",247,0)
 ;
"RTN","IBCNEHLP",248,0)
ERRMSG ; Send Mailman message if message ctrl id = ""
"RTN","IBCNEHLP",249,0)
 N XMSUB,MSG,MSGCT
"RTN","IBCNEHLP",250,0)
 S XMSUB="Message Control Id Field is Blank",MSGCT=$S(TRACE="":4,1:3)
"RTN","IBCNEHLP",251,0)
 S MSG(1)="A response was received with a blank Message Control Id"
"RTN","IBCNEHLP",252,0)
 I TRACE="" S MSG(1)=MSG(1)_" and Trace #"
"RTN","IBCNEHLP",253,0)
 S MSG(2)="for "_$S(TRACE'="":"Trace #: "_TRACE_", ",1:"")_"ICN #: "_ICN_", Patient: "_NAME_"."
"RTN","IBCNEHLP",254,0)
 I TRACE="" D
"RTN","IBCNEHLP",255,0)
 . S MSG(3)="It is likely that there are communication issues with the EC."
"RTN","IBCNEHLP",256,0)
 S MSG(MSGCT)="This response cannot be processed.  Please contact the NVS."
"RTN","IBCNEHLP",257,0)
 D MSG^IBCNEUT5(MGRP,XMSUB,"MSG(")
"RTN","IBCNEHLP",258,0)
 Q
"RTN","IBCNEHLR")
0^7^B26953930
"RTN","IBCNEHLR",1,0)
IBCNEHLR ;DAOU/ALA - HL7 Process Incoming RPI Messages ;26-JUN-2002
"RTN","IBCNEHLR",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEHLR",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEHLR",4,0)
 ;
"RTN","IBCNEHLR",5,0)
 ;**Program Description**
"RTN","IBCNEHLR",6,0)
 ;  This program will process incoming IIV response messages.
"RTN","IBCNEHLR",7,0)
 ;  This includes updating the record in the IIV Response File,
"RTN","IBCNEHLR",8,0)
 ;  updating the Buffer record (if there is one and creating a new
"RTN","IBCNEHLR",9,0)
 ;  one if there isn't) with the appropriate Buffer Symbol and data
"RTN","IBCNEHLR",10,0)
 ;
"RTN","IBCNEHLR",11,0)
 ;**Modified by  Date        Reason
"RTN","IBCNEHLR",12,0)
 ;  DAOU/BHS     10/04/2002  Added logic to update the service date in
"RTN","IBCNEHLR",13,0)
 ;                           the TQ entry so long as the Error Action is
"RTN","IBCNEHLR",14,0)
 ;                           not Please submit original transaction.
"RTN","IBCNEHLR",15,0)
 ;
"RTN","IBCNEHLR",16,0)
 ;  Variables
"RTN","IBCNEHLR",17,0)
 ;    SEG = HL7 Segment Name
"RTN","IBCNEHLR",18,0)
 ;    MSGID = Original Message Control ID
"RTN","IBCNEHLR",19,0)
 ;    ACK =  Acknowledgment (AA=Accepted, AE=Error)
"RTN","IBCNEHLR",20,0)
 ;    ERTXT = Error Message Text
"RTN","IBCNEHLR",21,0)
 ;    ERFLG = Error quit flag
"RTN","IBCNEHLR",22,0)
 ;    ERACT = Error Action
"RTN","IBCNEHLR",23,0)
 ;    ERCON = Error Condition
"RTN","IBCNEHLR",24,0)
 ;    RIEN = Response Record IEN
"RTN","IBCNEHLR",25,0)
 ;
"RTN","IBCNEHLR",26,0)
EN ; Entry Point
"RTN","IBCNEHLR",27,0)
 N RSUPDT,UP
"RTN","IBCNEHLR",28,0)
 S ERFLG=0,MGRP=$$MGRP^IBCNEUT5(),HCT=1
"RTN","IBCNEHLR",29,0)
 ;
"RTN","IBCNEHLR",30,0)
 ;  Loop through the message and find each segment for processing
"RTN","IBCNEHLR",31,0)
 F  S HCT=$O(^TMP($J,"IBCNEHLI",HCT)) Q:HCT=""  D  Q:ERFLG
"RTN","IBCNEHLR",32,0)
 . D SPAR^IBCNEHLP
"RTN","IBCNEHLR",33,0)
 . S SEG=$G(IBSEG(1))
"RTN","IBCNEHLR",34,0)
 . ;
"RTN","IBCNEHLR",35,0)
 . I SEG="MSA" D MSA^IBCNEHLP Q:ERFLG
"RTN","IBCNEHLR",36,0)
 . ;
"RTN","IBCNEHLR",37,0)
 . ;  Contact Segment
"RTN","IBCNEHLR",38,0)
 . I SEG="CTD" D CTD^IBCNEHLP
"RTN","IBCNEHLR",39,0)
 . ;
"RTN","IBCNEHLR",40,0)
 . ;  Patient Segment
"RTN","IBCNEHLR",41,0)
 . I SEG="PID" D PID^IBCNEHLP
"RTN","IBCNEHLR",42,0)
 . ;
"RTN","IBCNEHLR",43,0)
 . ;  Guarantor Segment
"RTN","IBCNEHLR",44,0)
 . I SEG="GT1" D GT1^IBCNEHLP
"RTN","IBCNEHLR",45,0)
 . ;
"RTN","IBCNEHLR",46,0)
 . ;  Insurance Segment
"RTN","IBCNEHLR",47,0)
 . I SEG="IN1" D IN1^IBCNEHLP
"RTN","IBCNEHLR",48,0)
 . ;
"RTN","IBCNEHLR",49,0)
 . ;  Addt'l Insurance Segment
"RTN","IBCNEHLR",50,0)
 . ;I SEG="IN2" ; for future expansion, add IN2 tag to IBCNEHLP
"RTN","IBCNEHLR",51,0)
 . ;
"RTN","IBCNEHLR",52,0)
 . ;  Addt'l Insurance - Cert Segment
"RTN","IBCNEHLR",53,0)
 . I SEG="IN3" D IN3^IBCNEHLP
"RTN","IBCNEHLR",54,0)
 . ;
"RTN","IBCNEHLR",55,0)
 . ;  Eligibility/Benefit Segment
"RTN","IBCNEHLR",56,0)
 . I SEG="ZEB" D ZEB^IBCNEHLP
"RTN","IBCNEHLR",57,0)
 . ;
"RTN","IBCNEHLR",58,0)
 . ;  Notes Segment
"RTN","IBCNEHLR",59,0)
 . I SEG="NTE" D NTE^IBCNEHLP
"RTN","IBCNEHLR",60,0)
 ;
"RTN","IBCNEHLR",61,0)
 D FIL
"RTN","IBCNEHLR",62,0)
 Q
"RTN","IBCNEHLR",63,0)
 ; ============================================
"RTN","IBCNEHLR",64,0)
FIL ;  Finish processing the response message
"RTN","IBCNEHLR",65,0)
 ;
"RTN","IBCNEHLR",66,0)
 ; If an unknown error action or an error filing the response message,
"RTN","IBCNEHLR",67,0)
 ; send an email
"RTN","IBCNEHLR",68,0)
 I ",W,X,R,P,C,N,Y,S,"'[(","_$G(ERACT)_",")&($G(ERACT)'="")!$D(ERROR) D
"RTN","IBCNEHLR",69,0)
 . ;
"RTN","IBCNEHLR",70,0)
 . D CE  ; send critical message
"RTN","IBCNEHLR",71,0)
 . ;
"RTN","IBCNEHLR",72,0)
 . ;If the response could not be created, stop processing
"RTN","IBCNEHLR",73,0)
 . I '$D(RIEN) Q
"RTN","IBCNEHLR",74,0)
 . ;
"RTN","IBCNEHLR",75,0)
 . ; Set the Transmission Queue Status to 'Response Received'
"RTN","IBCNEHLR",76,0)
 . S RDAT0=$G(^IBCN(365,RIEN,0)),TQN=$P(RDAT0,U,5)
"RTN","IBCNEHLR",77,0)
 . S TQDATA=$G(^IBCN(365.1,TQN,0))
"RTN","IBCNEHLR",78,0)
 . I TQDATA="" Q
"RTN","IBCNEHLR",79,0)
 . D SST^IBCNEUT2(TQN,3)
"RTN","IBCNEHLR",80,0)
 . ;
"RTN","IBCNEHLR",81,0)
 . ; No further processing for identifications
"RTN","IBCNEHLR",82,0)
 . S IBQFL=$P(TQDATA,U,11)
"RTN","IBCNEHLR",83,0)
 . I IBQFL="I" Q
"RTN","IBCNEHLR",84,0)
 . ;
"RTN","IBCNEHLR",85,0)
 . ; If unsolicited message or no buffer in TQ, create new buffer entry
"RTN","IBCNEHLR",86,0)
 . S IBIEN=$P(TQDATA,U,5),RSTYPE=$P($G(^IBCN(365,RIEN,0)),U,10)
"RTN","IBCNEHLR",87,0)
 . I RSTYPE="U" S IBIEN=""
"RTN","IBCNEHLR",88,0)
 . ;
"RTN","IBCNEHLR",89,0)
 . I IBIEN="" D  Q           ; create a new buffer entry
"RTN","IBCNEHLR",90,0)
 ..  S DFN=$P(TQDATA,U,2)        ; Determine Patient DFN
"RTN","IBCNEHLR",91,0)
 ..  S SYMBOL=12 D BUF^IBCNEHLS  ; Determine Patient Ins record IEN
"RTN","IBCNEHLR",92,0)
 . ;
"RTN","IBCNEHLR",93,0)
 . ;Update buffer symbol
"RTN","IBCNEHLR",94,0)
 . D BUFF^IBCNEUT2(IBIEN,12)
"RTN","IBCNEHLR",95,0)
 ;
"RTN","IBCNEHLR",96,0)
 ; If an error occurred, you're done!
"RTN","IBCNEHLR",97,0)
 I $G(ERFLG)=1 Q
"RTN","IBCNEHLR",98,0)
 ;
"RTN","IBCNEHLR",99,0)
 ; Initialize variables from Response file
"RTN","IBCNEHLR",100,0)
 S RDAT0=$G(^IBCN(365,RIEN,0))
"RTN","IBCNEHLR",101,0)
 S DFN=$P(RDAT0,U,2),BUFF=$P(RDAT0,U,4),TQN=$P(RDAT0,U,5)
"RTN","IBCNEHLR",102,0)
 S RSTYPE=$P(RDAT0,U,10)
"RTN","IBCNEHLR",103,0)
 S TRACE=$P(RDAT0,U,9)
"RTN","IBCNEHLR",104,0)
 S RSRVDT=$P($G(^IBCN(365,RIEN,1)),U,10)
"RTN","IBCNEHLR",105,0)
 ;
"RTN","IBCNEHLR",106,0)
 ;  Set the Transmission Queue Status to 'Response Received'
"RTN","IBCNEHLR",107,0)
 I $G(RSTYPE)="O" D SST^IBCNEUT2(TQN,3)
"RTN","IBCNEHLR",108,0)
 ;
"RTN","IBCNEHLR",109,0)
 ; Update the TQ service date to the date in the response file
"RTN","IBCNEHLR",110,0)
 ; if they are different AND the Error Action <> 
"RTN","IBCNEHLR",111,0)
 ; 'P' for 'Please submit original transaction'
"RTN","IBCNEHLR",112,0)
 ;
"RTN","IBCNEHLR",113,0)
 ; *** Temporary change to suppress update of service & freshness dates.
"RTN","IBCNEHLR",114,0)
 ; *** To reinstate, remove comment (;) from next line.
"RTN","IBCNEHLR",115,0)
 ;I TQN'="",$G(RSTYPE)="O" D
"RTN","IBCNEHLR",116,0)
 ;. S TQSRVDT=$P($G(^IBCN(365.1,TQN,0)),U,12)
"RTN","IBCNEHLR",117,0)
 ;. I RSRVDT'="",TQSRVDT'=RSRVDT,$G(ERACT)'="P" D SAVETQ^IBCNEUT2(TQN,RSRVDT)
"RTN","IBCNEHLR",118,0)
 ;. ; update freshness date by same delta
"RTN","IBCNEHLR",119,0)
 ;. D SAVFRSH^IBCNEUT5(TQN,+$$FMDIFF^XLFDT(RSRVDT,TQSRVDT,1))
"RTN","IBCNEHLR",120,0)
 ;
"RTN","IBCNEHLR",121,0)
 K TQSRVDT,RSRVDT
"RTN","IBCNEHLR",122,0)
 ;
"RTN","IBCNEHLR",123,0)
 ;  Check for error action
"RTN","IBCNEHLR",124,0)
 I $G(ERACT)'=""!($G(ERTXT)'="") D ERROR^IBCNEHLS(TQN,ERACT,ERCON,TRACE) G FILX
"RTN","IBCNEHLR",125,0)
 ;
"RTN","IBCNEHLR",126,0)
 ;  If a buffer entry, check if buffer status is still 'Entered'
"RTN","IBCNEHLR",127,0)
 I BUFF'="",(($P(^IBA(355.33,BUFF,0),U,4)'="E")!$$SYMBOL^IBCNBLL(BUFF)="*") G FILX
"RTN","IBCNEHLR",128,0)
 ;
"RTN","IBCNEHLR",129,0)
 ;  Set buffer symbol to verified
"RTN","IBCNEHLR",130,0)
 S SYMBOL=8
"RTN","IBCNEHLR",131,0)
 ;
"RTN","IBCNEHLR",132,0)
 ;  If okay, update the buffer entry
"RTN","IBCNEHLR",133,0)
 I BUFF'="" D RP^IBCNEBF(RIEN,"",BUFF)
"RTN","IBCNEHLR",134,0)
 ;
"RTN","IBCNEHLR",135,0)
 ;  If not a buffer entry, create one
"RTN","IBCNEHLR",136,0)
 I BUFF="" D RP^IBCNEBF(RIEN,1) S BUFF=+IBFDA,UP(365,RIEN_",",.04)=BUFF
"RTN","IBCNEHLR",137,0)
 ;
"RTN","IBCNEHLR",138,0)
 ;  Set IIV Processed Date to now
"RTN","IBCNEHLR",139,0)
 S UP(355.33,BUFF_",",.15)=$$NOW^XLFDT()
"RTN","IBCNEHLR",140,0)
 D FILE^DIE("I","UP","ERROR")
"RTN","IBCNEHLR",141,0)
FILX ;
"RTN","IBCNEHLR",142,0)
 Q
"RTN","IBCNEHLR",143,0)
 ;
"RTN","IBCNEHLR",144,0)
CE ;  Create and send response processing error message
"RTN","IBCNEHLR",145,0)
 N XMY,VEN,MCT,SUBCNT
"RTN","IBCNEHLR",146,0)
 S VEN=0,MCT=8,ERFLG=1,SUBCNT=""
"RTN","IBCNEHLR",147,0)
 S MSG(1)="IMPORTANT: Error While Processing Response Message from the EC"
"RTN","IBCNEHLR",148,0)
 S MSG(2)="-------------------------------------------------------------"
"RTN","IBCNEHLR",149,0)
 S MSG(3)="*** IRM *** Please contact VA IIV Technical Support because the"
"RTN","IBCNEHLR",150,0)
 S MSG(4)="response message received from the Eligibility Communicator"
"RTN","IBCNEHLR",151,0)
 S MSG(5)="could not be processed.  Programming changes may be necessary"
"RTN","IBCNEHLR",152,0)
 S MSG(6)="to properly handle the response."
"RTN","IBCNEHLR",153,0)
 S MSG(7)="The associated Trace # is "_$S($G(TRACE)="":"Unknown",1:TRACE)_".  Please review the"
"RTN","IBCNEHLR",154,0)
 S MSG(8)="response with the IIV Response Report by Trace #."
"RTN","IBCNEHLR",155,0)
 F  S VEN=$O(ERROR("DIERR",VEN)) Q:'VEN  D
"RTN","IBCNEHLR",156,0)
 . F  S SUBCNT=$O(ERROR("DIERR",VEN,"TEXT",SUBCNT)) Q:'SUBCNT  D
"RTN","IBCNEHLR",157,0)
 . . S MCT=MCT+1,MSG(MCT)=ERROR("DIERR",VEN,"TEXT",SUBCNT)
"RTN","IBCNEHLR",158,0)
 . S MCT=MCT+1,MSG(MCT)=" "
"RTN","IBCNEHLR",159,0)
 D MSG^IBCNEUT5(MGRP,MSG(1),"MSG(",,.XMY)
"RTN","IBCNEHLR",160,0)
 Q
"RTN","IBCNEHLR",161,0)
 ;
"RTN","IBCNERPB")
0^1^B46761930
"RTN","IBCNERPB",1,0)
IBCNERPB ;DAOU/RO -  IIV PAYER LINK REPORT ;AUG-2003
"RTN","IBCNERPB",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNERPB",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNERPB",4,0)
 ;
"RTN","IBCNERPB",5,0)
 ; IIV - Insurance Identification and Verification Interface
"RTN","IBCNERPB",6,0)
 ;
"RTN","IBCNERPB",7,0)
 ; Input parameters: N/A
"RTN","IBCNERPB",8,0)
 ; Other relevant variables ZTSAVED for queueing:
"RTN","IBCNERPB",9,0)
 ;  IBCNERTN = "IBCNERPB" (current routine name for queueing the
"RTN","IBCNERPB",10,0)
 ;   COMPILE process)
"RTN","IBCNERPB",11,0)
 ; ********
"RTN","IBCNERPB",12,0)
 ;  IBCNESPC("REP")=1 for Payer List report, 2 for Company List
"RTN","IBCNERPB",13,0)
 ;  IBCNESPC("PTYPE")=Payer type (1-no active ins linked, 2-at least 1 ins linked, 3-All Payers)
"RTN","IBCNERPB",14,0)
 ;  IBCNESPC("PSORT")=Primary Sort for Payer report
"RTN","IBCNERPB",15,0)
 ;  IBCNESPC("PPYR")=single Payer name or '' for all
"RTN","IBCNERPB",16,0)
 ;  IBCNESPC("PDET")=Ins detail on payer report (1-include list of ins,2-do not list)
"RTN","IBCNERPB",17,0)
 ;
"RTN","IBCNERPB",18,0)
 ;  IBCNESPC("ITYPE")=Ins Company type (1-no payer link, 2-linked to payer, 3-All ins companies)
"RTN","IBCNERPB",19,0)
 ;  IBCNESPC("ISORT")=Primary Sort for Payer Insurance report
"RTN","IBCNERPB",20,0)
 ;  IBCNESPC("IMAT")=Partial matching Ins carriers
"RTN","IBCNERPB",21,0)
 ; Only call this routine at a tag
"RTN","IBCNERPB",22,0)
 Q
"RTN","IBCNERPB",23,0)
 ;
"RTN","IBCNERPB",24,0)
EN ; Main entry pt
"RTN","IBCNERPB",25,0)
 ; Init vars
"RTN","IBCNERPB",26,0)
 N STOP,IBCNERTN,POP,IBCNESPC
"RTN","IBCNERPB",27,0)
 ;
"RTN","IBCNERPB",28,0)
 S STOP=0
"RTN","IBCNERPB",29,0)
 S IBCNERTN="IBCNERPB"
"RTN","IBCNERPB",30,0)
 W @IOF
"RTN","IBCNERPB",31,0)
 W !,"IIV Payer Link Report",!
"RTN","IBCNERPB",32,0)
 W !,"In order for an Insurance Company to be eligible for electronic insurance"
"RTN","IBCNERPB",33,0)
 W !,"eligibility communications via the IIV software, the Insurance Company"
"RTN","IBCNERPB",34,0)
 W !,"needs to be linked to an appropriate payer from the National EDI Payer list."
"RTN","IBCNERPB",35,0)
 W !,"The National EDI Payer list contains the names of the payers that are"
"RTN","IBCNERPB",36,0)
 W !,"currently participating with the IIV process."
"RTN","IBCNERPB",37,0)
 W !!,"This report option provides information to assist with finding unlinked"
"RTN","IBCNERPB",38,0)
 W !,"insurance companies or payers, which can subsequently be linked through the"
"RTN","IBCNERPB",39,0)
 W !,"INSURANCE COMPANY EDIT option."
"RTN","IBCNERPB",40,0)
 ;
"RTN","IBCNERPB",41,0)
 ; Report type
"RTN","IBCNERPB",42,0)
R05 D RTYPE I STOP G:$$STOP EXIT G R05
"RTN","IBCNERPB",43,0)
 S IBCNESPC("PPYR")=""
"RTN","IBCNERPB",44,0)
 ; If rpt by ins company, go to questions
"RTN","IBCNERPB",45,0)
 I $G(IBCNESPC("REP"))=2 G R120
"RTN","IBCNERPB",46,0)
 ; Payer type params
"RTN","IBCNERPB",47,0)
R20 D PAYER I STOP G:$$STOP EXIT G R05
"RTN","IBCNERPB",48,0)
 I IBCNESPC("PPYR")'="" S IBCNESPC("PTYPE")=3 G R30
"RTN","IBCNERPB",49,0)
 ; Payer details
"RTN","IBCNERPB",50,0)
R25 D PTYPE I STOP G:$$STOP EXIT G R20
"RTN","IBCNERPB",51,0)
 S IBCNESPC("PDET")=2 I IBCNESPC("PTYPE")=1 G R40
"RTN","IBCNERPB",52,0)
 ; insurance company details
"RTN","IBCNERPB",53,0)
R30 D PDET I STOP G:$$STOP EXIT G R25
"RTN","IBCNERPB",54,0)
 I IBCNESPC("PPYR")'="" S IBCNESPC("ISORT")=1 G R100
"RTN","IBCNERPB",55,0)
 ; Type of data to return param
"RTN","IBCNERPB",56,0)
R40 D PSORT I STOP G:$$STOP EXIT G R20
"RTN","IBCNERPB",57,0)
 G R100
"RTN","IBCNERPB",58,0)
 ; Payer type params
"RTN","IBCNERPB",59,0)
R120 D ITYPE^IBCNERPC I STOP G:$$STOP EXIT G R05
"RTN","IBCNERPB",60,0)
 ; Partial Ins Name to include
"RTN","IBCNERPB",61,0)
R130 D IMAT^IBCNERPC I STOP G:$$STOP EXIT G R120
"RTN","IBCNERPB",62,0)
 I IBCNESPC("ITYPE")=1 S IBCNESPC("ISORT")=1 G R100
"RTN","IBCNERPB",63,0)
 ; Type of data to return param
"RTN","IBCNERPB",64,0)
R140 D ISORT^IBCNERPC I STOP G:$$STOP EXIT G R130
"RTN","IBCNERPB",65,0)
 ; Select output device
"RTN","IBCNERPB",66,0)
R100 ; Issue output width warning if not queued
"RTN","IBCNERPB",67,0)
 I IBCNERTN="IBCNERPB",'$D(ZTQUEUED) W !!!,"*** This report is 132 characters wide ***",!
"RTN","IBCNERPB",68,0)
 D DEVICE(IBCNERTN,.IBCNESPC) I STOP G:$$STOP EXIT G R05
"RTN","IBCNERPB",69,0)
 G EXIT
"RTN","IBCNERPB",70,0)
 ;
"RTN","IBCNERPB",71,0)
EXIT ; Exit pt
"RTN","IBCNERPB",72,0)
 Q
"RTN","IBCNERPB",73,0)
 ;
"RTN","IBCNERPB",74,0)
 ;
"RTN","IBCNERPB",75,0)
COMPILE(IBCNERTN,IBCNESPC) ;
"RTN","IBCNERPB",76,0)
 ; Entry point called from EN^XUTMDEVQ in either direct or queued mode.
"RTN","IBCNERPB",77,0)
 ; Input params:
"RTN","IBCNERPB",78,0)
 ;  IBCNERTN = Routine name for ^TMP($J,...
"RTN","IBCNERPB",79,0)
 ;  IBCNESPC = Array passed by ref of the report params
"RTN","IBCNERPB",80,0)
 ;
"RTN","IBCNERPB",81,0)
 ; Init scratch globals
"RTN","IBCNERPB",82,0)
 K ^TMP($J,IBCNERTN)
"RTN","IBCNERPB",83,0)
 ; Compile
"RTN","IBCNERPB",84,0)
 I IBCNERTN="IBCNERPB" D EN^IBCNERPC(IBCNERTN,.IBCNESPC)
"RTN","IBCNERPB",85,0)
 ; Print
"RTN","IBCNERPB",86,0)
 I '$G(ZTSTOP) D
"RTN","IBCNERPB",87,0)
 . I IBCNERTN="IBCNERPB" D EN3^IBCNERPD(IBCNERTN,.IBCNESPC)
"RTN","IBCNERPB",88,0)
 ; Close device
"RTN","IBCNERPB",89,0)
 D ^%ZISC
"RTN","IBCNERPB",90,0)
 ; Kill scratch globals
"RTN","IBCNERPB",91,0)
 K ^TMP($J,IBCNERTN)
"RTN","IBCNERPB",92,0)
 ; Purge task record
"RTN","IBCNERPB",93,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBCNERPB",94,0)
 ;
"RTN","IBCNERPB",95,0)
COMPILX ; COMPILE exit pt
"RTN","IBCNERPB",96,0)
 Q
"RTN","IBCNERPB",97,0)
 ;
"RTN","IBCNERPB",98,0)
STOP() ; Determine if user wants to exit out of the whole option
"RTN","IBCNERPB",99,0)
 ; Init vars
"RTN","IBCNERPB",100,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPB",101,0)
 ;
"RTN","IBCNERPB",102,0)
 W !
"RTN","IBCNERPB",103,0)
 S DIR(0)="Y"
"RTN","IBCNERPB",104,0)
 S DIR("A")="Do you want to exit out of this option entirely"
"RTN","IBCNERPB",105,0)
 S DIR("B")="YES"
"RTN","IBCNERPB",106,0)
 S DIR("?",1)="  Enter YES to immediately exit out of this option."
"RTN","IBCNERPB",107,0)
 S DIR("?")="  Enter NO to return to the previous question."
"RTN","IBCNERPB",108,0)
 D ^DIR K DIR
"RTN","IBCNERPB",109,0)
 I $D(DIRUT) S (STOP,Y)=1 G STOPX
"RTN","IBCNERPB",110,0)
 I 'Y S STOP=0
"RTN","IBCNERPB",111,0)
 ;
"RTN","IBCNERPB",112,0)
STOPX ; STOP exit pt
"RTN","IBCNERPB",113,0)
 Q Y
"RTN","IBCNERPB",114,0)
 ;
"RTN","IBCNERPB",115,0)
RTYPE ; Prompt to allow users to select main report option
"RTN","IBCNERPB",116,0)
 ; Init vars
"RTN","IBCNERPB",117,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPB",118,0)
 ;
"RTN","IBCNERPB",119,0)
 S DIR(0)="S^1:Payer List;2:Insurance Company List"
"RTN","IBCNERPB",120,0)
 S DIR("A")="Select a report option"
"RTN","IBCNERPB",121,0)
 S DIR("B")=1
"RTN","IBCNERPB",122,0)
 S DIR("?",1)="  1 - Payer List:   This option lists the payers in the National"
"RTN","IBCNERPB",123,0)
 S DIR("?",2)="                    Payer list, and optionally provides information about"
"RTN","IBCNERPB",124,0)
 S DIR("?",3)="                    the insurance companies that are linked to that payer"
"RTN","IBCNERPB",125,0)
 S DIR("?",4)="  2 - Insurance"
"RTN","IBCNERPB",126,0)
 S DIR("?",5)="      Company List: This option lists insurance companies and"
"RTN","IBCNERPB",127,0)
 S DIR("?")="                    optionally displays linked payer information"
"RTN","IBCNERPB",128,0)
 D ^DIR K DIR
"RTN","IBCNERPB",129,0)
 I $D(DIRUT) S STOP=1 G RTYPEX
"RTN","IBCNERPB",130,0)
 S IBCNESPC("REP")=Y
"RTN","IBCNERPB",131,0)
 ;
"RTN","IBCNERPB",132,0)
RTYPEX ; RTYPE exit pt
"RTN","IBCNERPB",133,0)
 Q
"RTN","IBCNERPB",134,0)
 ;
"RTN","IBCNERPB",135,0)
PTYPE ; Prompt to select Payer Type to include
"RTN","IBCNERPB",136,0)
 ; Init vars
"RTN","IBCNERPB",137,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPB",138,0)
 ;
"RTN","IBCNERPB",139,0)
 S DIR(0)="S^1:Unlinked Payers;2:Linked Payers;3:ALL Payers"
"RTN","IBCNERPB",140,0)
 S DIR("A")="Select the type of payers to display"
"RTN","IBCNERPB",141,0)
 S DIR("B")="3"
"RTN","IBCNERPB",142,0)
 S DIR("?",1)="  1 - Only payers with no active insurance companies linked"
"RTN","IBCNERPB",143,0)
 S DIR("?",2)="  2 - Only payers with at least one insurance company linked"
"RTN","IBCNERPB",144,0)
 S DIR("?")="  3 - ALL Payers"
"RTN","IBCNERPB",145,0)
 D ^DIR K DIR
"RTN","IBCNERPB",146,0)
 I $D(DIRUT) S STOP=1 G PTYPEX
"RTN","IBCNERPB",147,0)
 S IBCNESPC("PTYPE")=Y
"RTN","IBCNERPB",148,0)
 ;
"RTN","IBCNERPB",149,0)
PTYPEX ; TYPE exit pt
"RTN","IBCNERPB",150,0)
 Q
"RTN","IBCNERPB",151,0)
PAYER ; Select Payer - File #365.12
"RTN","IBCNERPB",152,0)
 ; Init vars
"RTN","IBCNERPB",153,0)
 NEW DIC,DTOUT,DUOUT,X,Y
"RTN","IBCNERPB",154,0)
 ;
"RTN","IBCNERPB",155,0)
 W !!!
"RTN","IBCNERPB",156,0)
 S DIC(0)="ABEQ"
"RTN","IBCNERPB",157,0)
 S DIC("A")=$$FO^IBCNEUT1("Select a Payer (RETURN for ALL Payers): ",39,"L")
"RTN","IBCNERPB",158,0)
 ; Do not allow editing of '~NO PAYER' entry
"RTN","IBCNERPB",159,0)
 S DIC("S")="I $P(^(0),U,1)'=""~NO PAYER"""
"RTN","IBCNERPB",160,0)
 S DIC="^IBE(365.12,"
"RTN","IBCNERPB",161,0)
 D ^DIC
"RTN","IBCNERPB",162,0)
 I $D(DUOUT)!$D(DTOUT) S Y="" S STOP=1 G PAYERX
"RTN","IBCNERPB",163,0)
 I Y=-1 S Y=""
"RTN","IBCNERPB",164,0)
 S IBCNESPC("PPYR")=Y
"RTN","IBCNERPB",165,0)
PAYERX ; Prompt for ending Payer value
"RTN","IBCNERPB",166,0)
 Q
"RTN","IBCNERPB",167,0)
PDET ; Prompt to select to display Insurance Company details to include
"RTN","IBCNERPB",168,0)
 ; Init vars
"RTN","IBCNERPB",169,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPB",170,0)
 ;
"RTN","IBCNERPB",171,0)
 S DIR(0)="S^1:List linked insurance company detail;2:Do not list linked insurance company detail"
"RTN","IBCNERPB",172,0)
 S DIR("A")="Select insurance company detail option"
"RTN","IBCNERPB",173,0)
 S DIR("B")="1"
"RTN","IBCNERPB",174,0)
 S DIR("?",1)="  1 - Include a list of insurance companies linked to the payers"
"RTN","IBCNERPB",175,0)
 S DIR("?")="  2 - Do not list linked insurance companies, total number only"
"RTN","IBCNERPB",176,0)
 D ^DIR K DIR
"RTN","IBCNERPB",177,0)
 I $D(DIRUT) S STOP=1 G PDETEX
"RTN","IBCNERPB",178,0)
 S IBCNESPC("PDET")=Y
"RTN","IBCNERPB",179,0)
 ;
"RTN","IBCNERPB",180,0)
PDETEX ; TYPE exit pt
"RTN","IBCNERPB",181,0)
 Q
"RTN","IBCNERPB",182,0)
 ;
"RTN","IBCNERPB",183,0)
PSORT ; Prompt to allow users to select primary sort
"RTN","IBCNERPB",184,0)
 ; Init vars
"RTN","IBCNERPB",185,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPB",186,0)
 ;
"RTN","IBCNERPB",187,0)
 S DIR(0)="S^1:Payer Name;2:VA National Payer ID;3:Nationally Enabled Status;4:Locally Enabled Status;5:# of Linked Insurance Companies"
"RTN","IBCNERPB",188,0)
 S DIR("A")="Select the primary sort field"
"RTN","IBCNERPB",189,0)
 S DIR("B")=1
"RTN","IBCNERPB",190,0)
 S DIR("?")="  Select a data field by which this report should be primarily sorted."
"RTN","IBCNERPB",191,0)
 D ^DIR K DIR
"RTN","IBCNERPB",192,0)
 I $D(DIRUT) S STOP=1 G PSORTX
"RTN","IBCNERPB",193,0)
 S IBCNESPC("PSORT")=Y
"RTN","IBCNERPB",194,0)
 ;
"RTN","IBCNERPB",195,0)
PSORTX ; SORT exit pt
"RTN","IBCNERPB",196,0)
 Q
"RTN","IBCNERPB",197,0)
 ;
"RTN","IBCNERPB",198,0)
DEVICE(IBCNERTN,IBCNESPC) ; Device Handler and possible TaskManager calls
"RTN","IBCNERPB",199,0)
 ;
"RTN","IBCNERPB",200,0)
 ; Input params:
"RTN","IBCNERPB",201,0)
 ;  IBCNERTN = Routine name for ^TMP($J,...
"RTN","IBCNERPB",202,0)
 ;  IBCNESPC = Array passed by ref of the report params
"RTN","IBCNERPB",203,0)
 ;
"RTN","IBCNERPB",204,0)
 ; Init vars
"RTN","IBCNERPB",205,0)
 N ZTRTN,ZTDESC,ZTSAVE,POP
"RTN","IBCNERPB",206,0)
 ;
"RTN","IBCNERPB",207,0)
 S ZTRTN="COMPILE^IBCNERPB("""_IBCNERTN_""",.IBCNESPC)"
"RTN","IBCNERPB",208,0)
 S ZTDESC="IBCNE IIV Payer Link Report"
"RTN","IBCNERPB",209,0)
 S ZTSAVE("IBCNESPC(")=""
"RTN","IBCNERPB",210,0)
 S ZTSAVE("IBCNERTN")=""
"RTN","IBCNERPB",211,0)
 D EN^XUTMDEVQ(ZTRTN,ZTDESC,.ZTSAVE)
"RTN","IBCNERPB",212,0)
 I POP S STOP=1
"RTN","IBCNERPB",213,0)
 ;
"RTN","IBCNERPB",214,0)
DEVICEX ; DEVICE exit pt
"RTN","IBCNERPB",215,0)
 Q
"RTN","IBCNERPC")
0^2^B45814881
"RTN","IBCNERPC",1,0)
IBCNERPC ;DAOU/RO - IIV PAYER LINK REPORT COMPILE ;AUG-2003
"RTN","IBCNERPC",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNERPC",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNERPC",4,0)
 ;
"RTN","IBCNERPC",5,0)
 ; IIV - Insurance Identification and Verification
"RTN","IBCNERPC",6,0)
 ;
"RTN","IBCNERPC",7,0)
 ; Input vars from IBCNERPB:
"RTN","IBCNERPC",8,0)
 ;  IBCNESPC("REP")=1 for Payer List report, 2 for Company List
"RTN","IBCNERPC",9,0)
 ;  IBCNESPC("PTYPE")=Payer type (1-no active ins linked, 2-at least 1 ins linked, 3-All Payers)
"RTN","IBCNERPC",10,0)
 ;  IBCNESPC("PSORT")=Primary Sort for Payer report
"RTN","IBCNERPC",11,0)
 ;  IBCNESPC("PDET")=Ins detail on payer report (1-include list of ins,2-do not list)
"RTN","IBCNERPC",12,0)
 ;
"RTN","IBCNERPC",13,0)
 ;  IBCNESPC("ITYPE")=Ins Company type (1-no payer link, 2-linked to payer, 3-All ins companies)
"RTN","IBCNERPC",14,0)
 ;  IBCNESPC("ISORT")=Primary Sort for Payer Insurance report
"RTN","IBCNERPC",15,0)
 ;  IBCNESPC("IMAT")=Partial matching Ins carriers
"RTN","IBCNERPC",16,0)
 ;
"RTN","IBCNERPC",17,0)
 ; Output vars used by IBCNERPC:
"RTN","IBCNERPC",18,0)
 ;  
"RTN","IBCNERPC",19,0)
 ;   IBCNERTN="IBCNERPB"
"RTN","IBCNERPC",20,0)
 ;   SORT1=depends on sorting option chosen
"RTN","IBCNERPC",21,0)
 ;   SORT2=Payer Name (Report by Payer) or Ins Company Name (if report is Insurance)
"RTN","IBCNERPC",22,0)
 ;  ^TMP($J,IBCNERTN,SORT1,SORT2,CNT) 
"RTN","IBCNERPC",23,0)
 ;   CNT=Seq ct
"RTN","IBCNERPC",24,0)
 ;  ^TMP($J,IBCNERTN,SORT1,SORT2,CNT,1) 
"RTN","IBCNERPC",25,0)
 ;
"RTN","IBCNERPC",26,0)
 ; Must call at EN
"RTN","IBCNERPC",27,0)
 Q
"RTN","IBCNERPC",28,0)
 ;
"RTN","IBCNERPC",29,0)
EN(IBCNERTN,IBCNESPC) ; Entry
"RTN","IBCNERPC",30,0)
 ; Init
"RTN","IBCNERPC",31,0)
 N IBTYP,IBCT,IBCTX
"RTN","IBCNERPC",32,0)
 ;
"RTN","IBCNERPC",33,0)
 N IBDET,IBSRT,IBPY,IBVAID,IBPROF,IBINST,IBNAACT,IBLOACT,IBINS,IBINST
"RTN","IBCNERPC",34,0)
 N IBINSN,IBAPP,IBPYR,SORT1,SORT2,IBSRT,IBMAT,IBPPYR
"RTN","IBCNERPC",35,0)
 ;
"RTN","IBCNERPC",36,0)
 I '$D(ZTQUEUED),$G(IOST)["C-" W !!,"Compiling report data ..."
"RTN","IBCNERPC",37,0)
 ;
"RTN","IBCNERPC",38,0)
 ; Temp ct
"RTN","IBCNERPC",39,0)
 S IBCT=0
"RTN","IBCNERPC",40,0)
 ;
"RTN","IBCNERPC",41,0)
 ; Kill scratch globals
"RTN","IBCNERPC",42,0)
 K ^TMP($J,IBCNERTN)
"RTN","IBCNERPC",43,0)
 ;
"RTN","IBCNERPC",44,0)
 ;
"RTN","IBCNERPC",45,0)
 S IBREP=$G(IBCNESPC("REP"))
"RTN","IBCNERPC",46,0)
 S IBDET=$G(IBCNESPC("PDET"))
"RTN","IBCNERPC",47,0)
 S IBTYP=$G(IBCNESPC("PTYPE"))
"RTN","IBCNERPC",48,0)
 S IBSRT=$G(IBCNESPC("PSORT"))
"RTN","IBCNERPC",49,0)
 S IBPPYR=$G(IBCNESPC("PPYR"))
"RTN","IBCNERPC",50,0)
 ;
"RTN","IBCNERPC",51,0)
 ; Ins Report
"RTN","IBCNERPC",52,0)
 I IBREP=2 G INS
"RTN","IBCNERPC",53,0)
 ;
"RTN","IBCNERPC",54,0)
 ; Loop thru the IIV payer File (#365.12)
"RTN","IBCNERPC",55,0)
 S IBPY=0,SORT1=""
"RTN","IBCNERPC",56,0)
 F  S IBPY=$O(^IBE(365.12,IBPY)) Q:'IBPY  D  Q:$G(ZTSTOP)
"RTN","IBCNERPC",57,0)
 . I $D(ZTQUEUED),$$S^%ZTLOAD() S ZTSTOP=1 Q
"RTN","IBCNERPC",58,0)
 . ; Payer name from Payer File (#365.12)
"RTN","IBCNERPC",59,0)
 . S IBPYR=$P($G(^IBE(365.12,IBPY,0)),U) I IBSRT=1 S SORT1=IBPYR
"RTN","IBCNERPC",60,0)
 . S SORT2=IBPYR
"RTN","IBCNERPC",61,0)
 . I IBPYR=""!(IBPYR="~NO PAYER") Q
"RTN","IBCNERPC",62,0)
 . I IBPPYR'="",IBPY'=$P(IBPPYR,U) Q
"RTN","IBCNERPC",63,0)
 . ; get VA national ID
"RTN","IBCNERPC",64,0)
 . S IBVAID=$P($G(^IBE(365.12,IBPY,0)),U,2) I IBSRT=2 S SORT1=IBVAID
"RTN","IBCNERPC",65,0)
 . ; get the EDI numbers (professional and institutional)
"RTN","IBCNERPC",66,0)
 . S IBPROF=$P($G(^IBE(365.12,IBPY,0)),U,5)
"RTN","IBCNERPC",67,0)
 . S IBINST=$P($G(^IBE(365.12,IBPY,0)),U,6)
"RTN","IBCNERPC",68,0)
 . S IBAPP=$$PYRAPP^IBCNEUT5("IIV",IBPY),(IBNAACT,IBLOACT)=0
"RTN","IBCNERPC",69,0)
 . S:IBAPP'="" IBNAACT=$P($G(^IBE(365.12,IBPY,1,IBAPP,0)),U,2)
"RTN","IBCNERPC",70,0)
 . S:IBAPP'="" IBLOACT=$P($G(^IBE(365.12,IBPY,1,IBAPP,0)),U,3)
"RTN","IBCNERPC",71,0)
 . ; if no sort value, use 0
"RTN","IBCNERPC",72,0)
 . I IBSRT=3 S SORT1=IBNAACT I SORT1="" S SORT1=0
"RTN","IBCNERPC",73,0)
 . I IBSRT=4 S SORT1=IBLOACT I SORT1="" S SORT1=0
"RTN","IBCNERPC",74,0)
 . I SORT1="" S SORT1=" "
"RTN","IBCNERPC",75,0)
 . ; if sorting by count and detail, need to figure count first else sort will not work
"RTN","IBCNERPC",76,0)
 . I IBSRT=5,IBTYP>1,IBDET=1 D  S SORT1=-IBCTX
"RTN","IBCNERPC",77,0)
 . . S IBCTX=0,IBINS="" F  S IBINS=$O(^DIC(36,"AC",IBPY,IBINS)) Q:IBINS=""  D
"RTN","IBCNERPC",78,0)
 . . . S IBINSN=$G(^DIC(36,IBINS,0)),IBINSN=$P(IBINSN,U) Q:IBINSN=""  S IBCTX=IBCTX+1
"RTN","IBCNERPC",79,0)
 . ; search for insurance carriers for this payer
"RTN","IBCNERPC",80,0)
 . S IBCT=0,IBINS="" F  S IBINS=$O(^DIC(36,"AC",IBPY,IBINS)) Q:IBINS=""  D
"RTN","IBCNERPC",81,0)
 . . S IBINSN=$G(^DIC(36,IBINS,0)),IBINSN=$P(IBINSN,U) Q:IBINSN=""
"RTN","IBCNERPC",82,0)
 . . S IBCT=IBCT+1 I IBTYP=1 Q
"RTN","IBCNERPC",83,0)
 . . ; save off address and EDI#'s for Insurance carrier
"RTN","IBCNERPC",84,0)
 . . I IBDET=1 S ^TMP($J,IBCNERTN,SORT1,SORT2,IBPY,IBINSN,IBINS)=$P($G(^DIC(36,IBINS,.11)),U,1,6)_U_$P($G(^DIC(36,IBINS,3)),U,2)_U_$P($G(^DIC(36,IBINS,3)),U,4)
"RTN","IBCNERPC",85,0)
 . I IBTYP=1,IBCT>0 Q
"RTN","IBCNERPC",86,0)
 . I IBTYP=2,IBCT=0 Q
"RTN","IBCNERPC",87,0)
 . ; use reverse sort for count
"RTN","IBCNERPC",88,0)
 . I IBSRT=5 S SORT1=-IBCT
"RTN","IBCNERPC",89,0)
 . S ^TMP($J,IBCNERTN,SORT1,SORT2,IBPY)=IBVAID_U_IBPROF_U_IBINST_U_IBNAACT_U_IBLOACT_U_IBCT
"RTN","IBCNERPC",90,0)
 G EXIT
"RTN","IBCNERPC",91,0)
 ;
"RTN","IBCNERPC",92,0)
INS ;
"RTN","IBCNERPC",93,0)
 S IBTYP=$G(IBCNESPC("ITYPE"))
"RTN","IBCNERPC",94,0)
 S IBSRT=$G(IBCNESPC("ISORT"))
"RTN","IBCNERPC",95,0)
 S IBMAT=$G(IBCNESPC("IMAT"))
"RTN","IBCNERPC",96,0)
 ; Loop thru the Insurance company file
"RTN","IBCNERPC",97,0)
 S IBINS=0
"RTN","IBCNERPC",98,0)
 F  S IBINS=$O(^DIC(36,IBINS)) Q:'IBINS  D  Q:$G(ZTSTOP)
"RTN","IBCNERPC",99,0)
 . I $D(ZTQUEUED),$$S^%ZTLOAD() S ZTSTOP=1 Q
"RTN","IBCNERPC",100,0)
 . S (SORT1,IBPYR,IBNAACT,IBLOACT,IBPROF,IBINST,IBVAID)=""
"RTN","IBCNERPC",101,0)
 . S IBINSN=$P($G(^DIC(36,IBINS,0)),U) I IBSRT=1 S SORT1=IBINSN
"RTN","IBCNERPC",102,0)
 . S SORT2=IBINSN
"RTN","IBCNERPC",103,0)
 . I IBINSN="" Q
"RTN","IBCNERPC",104,0)
 . I IBMAT'="",'$F($$UP^XLFSTR(IBINSN),$$UP^XLFSTR(IBMAT)) Q
"RTN","IBCNERPC",105,0)
 . ; get payer
"RTN","IBCNERPC",106,0)
 . S IBPY=$P($G(^DIC(36,IBINS,3)),U,10)
"RTN","IBCNERPC",107,0)
 . I IBTYP=1,IBPY'="" Q
"RTN","IBCNERPC",108,0)
 . I IBTYP=2,IBPY="" Q
"RTN","IBCNERPC",109,0)
 . I IBPY'="" D
"RTN","IBCNERPC",110,0)
 . . ; Payer name from Payer File (#365.12)
"RTN","IBCNERPC",111,0)
 . . S IBPYR=$P($G(^IBE(365.12,IBPY,0)),U) I IBSRT=2 S SORT1=IBPYR
"RTN","IBCNERPC",112,0)
 . . ; get VA national ID
"RTN","IBCNERPC",113,0)
 . . S IBVAID=$P($G(^IBE(365.12,IBPY,0)),U,2) I IBSRT=3 S SORT1=IBVAID
"RTN","IBCNERPC",114,0)
 . . S IBPROF=$P($G(^IBE(365.12,IBPY,0)),U,5)
"RTN","IBCNERPC",115,0)
 . . S IBINST=$P($G(^IBE(365.12,IBPY,0)),U,6)
"RTN","IBCNERPC",116,0)
 . . S IBAPP=$$PYRAPP^IBCNEUT5("IIV",IBPY),(IBNAACT,IBLOACT)=0
"RTN","IBCNERPC",117,0)
 . . S:IBAPP'="" IBNAACT=$P($G(^IBE(365.12,IBPY,1,IBAPP,0)),U,2)
"RTN","IBCNERPC",118,0)
 . . S:IBAPP'="" IBLOACT=$P($G(^IBE(365.12,IBPY,1,IBAPP,0)),U,3)
"RTN","IBCNERPC",119,0)
 . . I IBSRT=4 S SORT1=IBNAACT I SORT1="" S SORT1=0
"RTN","IBCNERPC",120,0)
 . . I IBSRT=5 S SORT1=IBLOACT I SORT1="" S SORT1=0
"RTN","IBCNERPC",121,0)
 . I SORT1="" S SORT1=" "
"RTN","IBCNERPC",122,0)
 . S ^TMP($J,IBCNERTN,SORT1,SORT2,IBINS)=IBPYR_U_IBVAID_U_IBPROF_U_IBINST_U_IBNAACT_U_IBLOACT_U_IBCT_U_$G(^DIC(36,IBINS,.11))_U_"~"_$G(^DIC(36,IBINS,3))
"RTN","IBCNERPC",123,0)
 ;
"RTN","IBCNERPC",124,0)
EXIT ;
"RTN","IBCNERPC",125,0)
 Q
"RTN","IBCNERPC",126,0)
 ; Lines moved from IBCNERPB
"RTN","IBCNERPC",127,0)
ITYPE ; Prompt to select Insurance Company type to include
"RTN","IBCNERPC",128,0)
 ; Init vars
"RTN","IBCNERPC",129,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPC",130,0)
 ;
"RTN","IBCNERPC",131,0)
 S DIR(0)="S^1:Unlinked insurance companies;2:Linked insurance companies;3:All insurance companies"
"RTN","IBCNERPC",132,0)
 S DIR("A")="Select type of insurance companies to display"
"RTN","IBCNERPC",133,0)
 S DIR("B")="3"
"RTN","IBCNERPC",134,0)
 S DIR("?",1)="  1 - Only insurance companies that are not currently linked to a payer"
"RTN","IBCNERPC",135,0)
 S DIR("?",2)="  2 - Only insurance companies that are currently linked to a payer"
"RTN","IBCNERPC",136,0)
 S DIR("?")="  3 - ALL insurance companies"
"RTN","IBCNERPC",137,0)
 D ^DIR K DIR
"RTN","IBCNERPC",138,0)
 I $D(DIRUT) S STOP=1 G ITYPEX
"RTN","IBCNERPC",139,0)
 S IBCNESPC("ITYPE")=Y
"RTN","IBCNERPC",140,0)
 ;
"RTN","IBCNERPC",141,0)
ITYPEX ; TYPE exit pt
"RTN","IBCNERPC",142,0)
 Q
"RTN","IBCNERPC",143,0)
ISORT ; Prompt to allow users to select primary sort
"RTN","IBCNERPC",144,0)
 ; Init vars
"RTN","IBCNERPC",145,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPC",146,0)
 ;
"RTN","IBCNERPC",147,0)
 S DIR(0)="S^1:Insurance Company Name;2:Payer Name;3:VA National Payer ID;4:Nationally Enabled Status;5:Locally Enabled Status"
"RTN","IBCNERPC",148,0)
 S DIR("A")="Select the primary sort field"
"RTN","IBCNERPC",149,0)
 S DIR("B")=1
"RTN","IBCNERPC",150,0)
 S DIR("?")="  Select the data field by which this report should be primarily sorted."
"RTN","IBCNERPC",151,0)
 D ^DIR K DIR
"RTN","IBCNERPC",152,0)
 I $D(DIRUT) S STOP=1 G ISORTX
"RTN","IBCNERPC",153,0)
 S IBCNESPC("ISORT")=Y
"RTN","IBCNERPC",154,0)
 ;
"RTN","IBCNERPC",155,0)
ISORTX ; SORT exit pt
"RTN","IBCNERPC",156,0)
 Q
"RTN","IBCNERPC",157,0)
IMAT ; Prompt to allow users to select partial Ins carrier to include
"RTN","IBCNERPC",158,0)
 N DIR,X,Y,DIRUT
"RTN","IBCNERPC",159,0)
 ;
"RTN","IBCNERPC",160,0)
 W !
"RTN","IBCNERPC",161,0)
 S DIR(0)="FO"
"RTN","IBCNERPC",162,0)
 S DIR("A")="Enter an insurance company search keyword (RETURN for ALL)"
"RTN","IBCNERPC",163,0)
 S DIR("B")=""
"RTN","IBCNERPC",164,0)
 S DIR("?",1)="     Enter a value to match insurance company names with."
"RTN","IBCNERPC",165,0)
 S DIR("?",2)="     Simply hit RETURN to select ALL or enter a keyword"
"RTN","IBCNERPC",166,0)
 S DIR("?",3)="     (ex. 'CIGNA' would return CIGNA, CIGNA HICN, NATIONAL CIGNA,"
"RTN","IBCNERPC",167,0)
 S DIR("?")="     REGION 1 CIGNA and any others with the term 'CIGNA' in it)"
"RTN","IBCNERPC",168,0)
 D ^DIR K DIR
"RTN","IBCNERPC",169,0)
 I $D(DUOUT)!$D(DTOUT) S Y="" S STOP=1 G IMATX
"RTN","IBCNERPC",170,0)
 S IBCNESPC("IMAT")=Y
"RTN","IBCNERPC",171,0)
 ;                                                                       
"RTN","IBCNERPC",172,0)
IMATX Q
"RTN","IBCNERPD")
0^3^B45776123
"RTN","IBCNERPD",1,0)
IBCNERPD ;DAOU/RO - IIV PAYER LINK REPORT PRINT;AUG-2003
"RTN","IBCNERPD",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNERPD",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNERPD",4,0)
 ;
"RTN","IBCNERPD",5,0)
 ; IIV - Insurance Identification and Verification
"RTN","IBCNERPD",6,0)
 ;
"RTN","IBCNERPD",7,0)
 ; Called by IBCNERPB
"RTN","IBCNERPD",8,0)
 ; Input from IBCNERPB/C:
"RTN","IBCNERPD",9,0)
 ;  
"RTN","IBCNERPD",10,0)
 ;  ^TMP($J,IBCNERTN,S1,S2,CT,0)
"RTN","IBCNERPD",11,0)
 ;    IBCNERTN="IBCNERPB", 
"RTN","IBCNERPD",12,0)
 ;    CT=Seq ct
"RTN","IBCNERPD",13,0)
 ;  ^TMP($J,IBCNERTN,S1,S2,CT,1) 
"RTN","IBCNERPD",14,0)
 ;
"RTN","IBCNERPD",15,0)
EN3(IBCNERTN,IBCNESPC) ; Entry pt.  
"RTN","IBCNERPD",16,0)
 N IBTYP,IBSRT,CRT,MAXCNT,IBPXT
"RTN","IBCNERPD",17,0)
 N IBPGC,X,Y,DIR,DTOUT,DUOUT,LIN,IBTRC,IBMAT,IBREP,IBDET,IBPPYR,ZZ
"RTN","IBCNERPD",18,0)
 S IBREP=$G(IBCNESPC("REP"))
"RTN","IBCNERPD",19,0)
 S IBDET=$G(IBCNESPC("PDET"))
"RTN","IBCNERPD",20,0)
 S IBTYP=$G(IBCNESPC("PTYPE"))
"RTN","IBCNERPD",21,0)
 S IBSRT=$G(IBCNESPC("PSORT"))
"RTN","IBCNERPD",22,0)
 S IBPPYR=$G(IBCNESPC("PPYR"))
"RTN","IBCNERPD",23,0)
 ; Ins Report
"RTN","IBCNERPD",24,0)
 I IBREP=2 D
"RTN","IBCNERPD",25,0)
 . S IBTYP=$G(IBCNESPC("ITYPE"))
"RTN","IBCNERPD",26,0)
 . S IBSRT=$G(IBCNESPC("ISORT"))
"RTN","IBCNERPD",27,0)
 . S IBMAT=$G(IBCNESPC("IMAT"))
"RTN","IBCNERPD",28,0)
 S (IBPXT,IBPGC)=0
"RTN","IBCNERPD",29,0)
 ; Determine IO params
"RTN","IBCNERPD",30,0)
 I IOST["C-" S MAXCNT=IOSL-3,CRT=1
"RTN","IBCNERPD",31,0)
 E  S MAXCNT=IOSL-6,CRT=0
"RTN","IBCNERPD",32,0)
 D PRINT(IBCNERTN,IBREP,IBDET,IBTYP,IBSRT,.IBPGC,.IBPXT,MAXCNT,CRT)
"RTN","IBCNERPD",33,0)
 I $G(ZTSTOP)!IBPXT G EXIT3
"RTN","IBCNERPD",34,0)
 I CRT,IBPGC>0,'$D(ZTQUEUED) D
"RTN","IBCNERPD",35,0)
 . I MAXCNT<51 F LIN=1:1:(MAXCNT-$Y) W !
"RTN","IBCNERPD",36,0)
 . S DIR(0)="E" D ^DIR K DIR
"RTN","IBCNERPD",37,0)
EXIT3 ; Exit pt
"RTN","IBCNERPD",38,0)
 Q
"RTN","IBCNERPD",39,0)
 ;
"RTN","IBCNERPD",40,0)
PRINT(RTN,REP,DET,TYP,SRT,PGC,PXT,MAX,CRT) ; Print data
"RTN","IBCNERPD",41,0)
 ; Input: RTN="IBCENRPB"
"RTN","IBCNERPD",42,0)
 ;   PGC=page ct, PXT=exit flg,
"RTN","IBCNERPD",43,0)
 ;  MAX=max line ct/pg, CRT=1/0
"RTN","IBCNERPD",44,0)
 N EORMSG,NONEMSG,SORT1,SORT2,CNT,DASH
"RTN","IBCNERPD",45,0)
 S EORMSG="*** END OF REPORT ***"
"RTN","IBCNERPD",46,0)
 S NONEMSG="* * * N O  D A T A  F O U N D * * *"
"RTN","IBCNERPD",47,0)
 S (SORT1,SORT2)="",$P(DASH,"-",132)=""
"RTN","IBCNERPD",48,0)
 I '$D(^TMP($J,RTN)) D HEADER W !,?(80-$L(NONEMSG)\2),NONEMSG,!!
"RTN","IBCNERPD",49,0)
 F  S SORT1=$O(^TMP($J,RTN,SORT1)) Q:SORT1=""  D  Q:PXT!$G(ZTSTOP)
"RTN","IBCNERPD",50,0)
 . S SORT2="" F  S SORT2=$O(^TMP($J,RTN,SORT1,SORT2)) Q:SORT2=""  D  Q:PXT!$G(ZTSTOP)
"RTN","IBCNERPD",51,0)
 . . S CNT="" F  S CNT=$O(^TMP($J,RTN,SORT1,SORT2,CNT)) Q:CNT=""  D  Q:PXT!$G(ZTSTOP)
"RTN","IBCNERPD",52,0)
 . . . K DISPDATA  ; Init disp
"RTN","IBCNERPD",53,0)
 . . . D DATA(.DISPDATA),LINE(.DISPDATA)  ; build/display data
"RTN","IBCNERPD",54,0)
 ;
"RTN","IBCNERPD",55,0)
 I $G(ZTSTOP)!PXT G PRINTX
"RTN","IBCNERPD",56,0)
 I $Y+1>MAX!('PGC) D HEADER I $G(ZTSTOP)!PXT G PRINTX
"RTN","IBCNERPD",57,0)
 W !,?(80-$L(EORMSG)\2),EORMSG
"RTN","IBCNERPD",58,0)
PRINTX ;
"RTN","IBCNERPD",59,0)
 Q
"RTN","IBCNERPD",60,0)
 ;
"RTN","IBCNERPD",61,0)
HEADER ; Print hdr info
"RTN","IBCNERPD",62,0)
 N X,Y,DIR,DTOUT,DUOUT,OFFSET,HDR,LIN,HDR
"RTN","IBCNERPD",63,0)
 I CRT,PGC>0,'$D(ZTQUEUED) D  I PXT G HEADERX
"RTN","IBCNERPD",64,0)
 . I MAX<51 F LIN=1:1:(MAX-$Y) W !
"RTN","IBCNERPD",65,0)
 . S DIR(0)="E" D ^DIR K DIR
"RTN","IBCNERPD",66,0)
 . I $D(DTOUT)!($D(DUOUT)) S PXT=1 Q
"RTN","IBCNERPD",67,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD() S ZTSTOP=1 G HEADERX
"RTN","IBCNERPD",68,0)
 S PGC=PGC+1
"RTN","IBCNERPD",69,0)
 W @IOF,!,?1,"IIV Payer Link Report"
"RTN","IBCNERPD",70,0)
 S HDR=$$FMTE^XLFDT($$NOW^XLFDT,1)_"  Page: "_PGC,OFFSET=131-$L(HDR)
"RTN","IBCNERPD",71,0)
 W ?OFFSET,HDR
"RTN","IBCNERPD",72,0)
 W !,?1,"Report Option: "_$S(REP=1:"Payer List",1:"Insurance Company List")
"RTN","IBCNERPD",73,0)
 I REP=1 D
"RTN","IBCNERPD",74,0)
 . S HDR=$S(TYP=1:"Unlinked Payers Only",TYP=2:"Linked Payers Only",1:"All Payers")
"RTN","IBCNERPD",75,0)
 . I TYP=3 S HDR=HDR_", "_$S(DET=1:"With Ins. Co. Detail",1:"Without Ins. Co. Detail")
"RTN","IBCNERPD",76,0)
 I REP=2 D
"RTN","IBCNERPD",77,0)
 . S HDR=$S(TYP=1:"Unlinked Insurance Companies Only",TYP=2:"Linked Insurance Companies Only",1:"All Insurance Companies")
"RTN","IBCNERPD",78,0)
 S OFFSET=79-$L(HDR)
"RTN","IBCNERPD",79,0)
 W ?OFFSET,HDR
"RTN","IBCNERPD",80,0)
 W !
"RTN","IBCNERPD",81,0)
 I REP=1 D
"RTN","IBCNERPD",82,0)
 . I IBPPYR'="" W ?1,"For Single Payer: ",$P(IBPPYR,"^",2)
"RTN","IBCNERPD",83,0)
 . W !?39,"National",?54,"# Linked",?67,"Nationally",?82,"Locally",?94,"Prof.",?115,"Inst."
"RTN","IBCNERPD",84,0)
 . W !,"Payer Name:",?39,"Payer ID",?54,"Ins. Co.",?67,"Active?",?82,"Active?",?94,"EDI#",?115,"EDI#"
"RTN","IBCNERPD",85,0)
 I REP=2 D
"RTN","IBCNERPD",86,0)
 . I IBMAT'="" W ?1,"Only Insurance Companies that match: ",IBMAT
"RTN","IBCNERPD",87,0)
 . W !?56,"Nat.",?71,"Loc.",?83,"Prof.",?104,"Inst."
"RTN","IBCNERPD",88,0)
 . W !,"Insurance Company:",?56,"Act?",?71,"Act?",?83,"EDI#",?104,"EDI#"
"RTN","IBCNERPD",89,0)
 . I TYP'=1 W !,"   Payer:",?41,"VA ID"
"RTN","IBCNERPD",90,0)
 W !,DASH
"RTN","IBCNERPD",91,0)
HEADERX ;
"RTN","IBCNERPD",92,0)
 Q
"RTN","IBCNERPD",93,0)
 ;
"RTN","IBCNERPD",94,0)
LINE(DISPDATA) ;  Print data
"RTN","IBCNERPD",95,0)
 N LNCT,LNTOT,NWPG
"RTN","IBCNERPD",96,0)
 S LNTOT=+$O(DISPDATA(""),-1)
"RTN","IBCNERPD",97,0)
 S NWPG=0
"RTN","IBCNERPD",98,0)
 F LNCT=1:1:LNTOT D  Q:$G(ZTSTOP)!PXT
"RTN","IBCNERPD",99,0)
 . I $Y+1>MAX!('PGC) D HEADER S NWPG=1 I $G(ZTSTOP)!PXT Q
"RTN","IBCNERPD",100,0)
 . W !,?1,DISPDATA(LNCT) Q
"RTN","IBCNERPD",101,0)
 . I 'NWPG!(NWPG&(DISPDATA(LNCT)'="")) W !,?1,DISPDATA(LNCT)
"RTN","IBCNERPD",102,0)
 . I NWPG S NWPG=0
"RTN","IBCNERPD",103,0)
 . Q
"RTN","IBCNERPD",104,0)
LINEX Q
"RTN","IBCNERPD",105,0)
 ;
"RTN","IBCNERPD",106,0)
DATA(DISPDATA) ;  Build disp lines
"RTN","IBCNERPD",107,0)
 N LCT,CT,CT2,RPTDATA,XX,YY,ZZ
"RTN","IBCNERPD",108,0)
 ; Merge into local array
"RTN","IBCNERPD",109,0)
 N %X,%Y
"RTN","IBCNERPD",110,0)
 S %X="^TMP($J,RTN,SORT1,SORT2,CNT,"
"RTN","IBCNERPD",111,0)
 S %Y="RPTDATA("
"RTN","IBCNERPD",112,0)
 I $D(^TMP($J,RTN,SORT1,SORT2,CNT))#10=1 S RPTDATA=^TMP($J,RTN,SORT1,SORT2,CNT)
"RTN","IBCNERPD",113,0)
 D %XY^%RCR K %X,%Y
"RTN","IBCNERPD",114,0)
 ; Build
"RTN","IBCNERPD",115,0)
 ;
"RTN","IBCNERPD",116,0)
 ; PAYER REPORT
"RTN","IBCNERPD",117,0)
 I REP=1 D
"RTN","IBCNERPD",118,0)
 . ; 1st line is payer
"RTN","IBCNERPD",119,0)
 . S LCT=1,DISPDATA(1)=$$FO^IBCNEUT1(SORT2,35,"L")_"   "_$$FO^IBCNEUT1($P(RPTDATA,U,1),10,"L")_"     "_$$FO^IBCNEUT1($P(RPTDATA,U,6),5,"R")_"        "_$$FO^IBCNEUT1($S($P(RPTDATA,U,4)=1:"YES",1:"NO"),15,"L")
"RTN","IBCNERPD",120,0)
 . S DISPDATA(1)=DISPDATA(1)_$$FO^IBCNEUT1($S($P(RPTDATA,U,5)=1:"YES",1:"NO"),12,"L")_$$FO^IBCNEUT1($P(RPTDATA,U,2),16,"L")_"     "_$$FO^IBCNEUT1($P(RPTDATA,U,3),16,"L")
"RTN","IBCNERPD",121,0)
 . ; See if detail is required
"RTN","IBCNERPD",122,0)
 . I DET=1 D
"RTN","IBCNERPD",123,0)
 . . I $O(RPTDATA(""))'="" S LCT=LCT+1,DISPDATA(LCT)="   Linked Insurance Companies:"
"RTN","IBCNERPD",124,0)
 . . S (XX,YY,ZZ)="" F  S XX=$O(RPTDATA(XX)) Q:XX=""  F  S YY=$O(RPTDATA(XX,YY)) Q:YY=""  D
"RTN","IBCNERPD",125,0)
 . . . S ZZ=RPTDATA(XX,YY)
"RTN","IBCNERPD",126,0)
 . . . S LCT=LCT+1,DISPDATA(LCT)="   "_$$FO^IBCNEUT1(XX,35,"L")_"  "_$$FO^IBCNEUT1($P(ZZ,U,1),20,"L")_" "_$E($P(ZZ,U,4),1,15)
"RTN","IBCNERPD",127,0)
 . . . ; don't display ','s if no address/state on file
"RTN","IBCNERPD",128,0)
 . . . I $P(ZZ,U,5)'="" S DISPDATA(LCT)=DISPDATA(LCT)_", "_$P($G(^DIC(5,$P(ZZ,U,5)+0,0)),U,2)
"RTN","IBCNERPD",129,0)
 . . . S DISPDATA(LCT)=DISPDATA(LCT)_$$FO^IBCNEUT1(" ",93-$L(DISPDATA(LCT)),"L")
"RTN","IBCNERPD",130,0)
 . . . ; display EDI#'s
"RTN","IBCNERPD",131,0)
 . . . S DISPDATA(LCT)=DISPDATA(LCT)_$$FO^IBCNEUT1($P(ZZ,U,7),16,"L")_"     "_$$FO^IBCNEUT1($P(ZZ,U,8),16,"L")
"RTN","IBCNERPD",132,0)
 ;
"RTN","IBCNERPD",133,0)
 ; Insurance Company Report
"RTN","IBCNERPD",134,0)
 I REP=2 D
"RTN","IBCNERPD",135,0)
 . ; Ins carrier
"RTN","IBCNERPD",136,0)
 . S DISPDATA(1)=$$FO^IBCNEUT1(SORT2,82,"L")
"RTN","IBCNERPD",137,0)
 . ; Ins address
"RTN","IBCNERPD",138,0)
 . S ZZ=$P(RPTDATA,"~",2),DISPDATA(1)=DISPDATA(1)_$$FO^IBCNEUT1($P(ZZ,U,2),16,"L")_"     "_$$FO^IBCNEUT1($P(ZZ,U,4),16,"L")
"RTN","IBCNERPD",139,0)
 . S DISPDATA(2)="        "_$P(RPTDATA,U,8)_"  "_$P(RPTDATA,U,11)
"RTN","IBCNERPD",140,0)
 . ; Add state/zip if defined
"RTN","IBCNERPD",141,0)
 . I $P(RPTDATA,U,12)'="" S DISPDATA(2)=DISPDATA(2)_", "_$P($G(^DIC(5,$P(RPTDATA,U,12)+0,0)),U,2)_" "_$$FO^IBCNEUT1($P(RPTDATA,U,13),5,"L")
"RTN","IBCNERPD",142,0)
 . ; if no payer is linked AND displaying payers
"RTN","IBCNERPD",143,0)
 . I $P(RPTDATA,U)="",TYP'=1 S DISPDATA(3)="   ** NOT CURRENTLY LINKED **",LCT=4,DISPDATA(4)="  " Q
"RTN","IBCNERPD",144,0)
 . ; if no payer and not displaying then quit
"RTN","IBCNERPD",145,0)
 . I $P(RPTDATA,U)="" S LCT=3,DISPDATA(3)="  " Q
"RTN","IBCNERPD",146,0)
 . ; Display Payer Info Line
"RTN","IBCNERPD",147,0)
 . S DISPDATA(3)="  "_$$FO^IBCNEUT1($P(RPTDATA,U,1),35,"L")_"   "_$$FO^IBCNEUT1($P(RPTDATA,U,2),15,"L")_$$FO^IBCNEUT1($S($P(RPTDATA,U,5)=1:"YES",1:"NO"),15,"L")
"RTN","IBCNERPD",148,0)
 . S DISPDATA(3)=DISPDATA(3)_$$FO^IBCNEUT1($S($P(RPTDATA,U,6)=1:"YES",1:"NO"),12,"L")_$$FO^IBCNEUT1($P(RPTDATA,U,4),16,"L")_"     "_$$FO^IBCNEUT1($P(RPTDATA,U,4),16,"L")
"RTN","IBCNERPD",149,0)
 . S LCT=4,DISPDATA(4)=" "
"RTN","IBCNERPD",150,0)
 S LCT=LCT+1
"RTN","IBCNERPD",151,0)
 Q
"RTN","IBCNEUT3")
0^8^B57302311
"RTN","IBCNEUT3",1,0)
IBCNEUT3 ;DAOU/AM - IIV MISC. UTILITIES ;12-JUN-2002
"RTN","IBCNEUT3",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEUT3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEUT3",4,0)
 ;
"RTN","IBCNEUT3",5,0)
 ; The purpose of the INSERROR utility is to identify a legitimate
"RTN","IBCNEUT3",6,0)
 ; Insurance Company name, returning the associated Payer IEN and
"RTN","IBCNEUT3",7,0)
 ; National ID.  This extrinsic function can receive either Insurance or
"RTN","IBCNEUT3",8,0)
 ; Buffer data, identified as TYPE I or B, respectively.
"RTN","IBCNEUT3",9,0)
 ;
"RTN","IBCNEUT3",10,0)
 ; The former is the simpler case.  The IEN, in this case the Insurance
"RTN","IBCNEUT3",11,0)
 ; IEN, is validated using the following criteria (some of which is
"RTN","IBCNEUT3",12,0)
 ; validated in routine IBCNEUT4) :
"RTN","IBCNEUT3",13,0)
 ;
"RTN","IBCNEUT3",14,0)
 ; [1] Does it have a National ID?
"RTN","IBCNEUT3",15,0)
 ; [2] Does the National ID have IIV defined?
"RTN","IBCNEUT3",16,0)
 ; [3] Is the Payer active (i.e. the deactivated flag is turned off)
"RTN","IBCNEUT3",17,0)
 ; [4] Is the national connection enabled?
"RTN","IBCNEUT3",18,0)
 ; [5] Is the National ID blocked by VISTA?
"RTN","IBCNEUT3",19,0)
 ;
"RTN","IBCNEUT3",20,0)
 ; If all 5 criteria are met, the Payer IEN and National ID are
"RTN","IBCNEUT3",21,0)
 ; returned.  If not, an error is generated and returned in ARRAY with
"RTN","IBCNEUT3",22,0)
 ; information specific to the type of problem encountered.
"RTN","IBCNEUT3",23,0)
 ;
"RTN","IBCNEUT3",24,0)
 ; If the TYPE passed is B for Buffer, the IEN is the Buffer IEN.
"RTN","IBCNEUT3",25,0)
 ; The Insurance Company name is retrieved from the Buffer file and
"RTN","IBCNEUT3",26,0)
 ; leading and trailing spaces are stripped.  This value is compared to
"RTN","IBCNEUT3",27,0)
 ; the entries in the "B" cross reference of the Insurance Company file
"RTN","IBCNEUT3",28,0)
 ; (whose values have also been stripped of leading and trailing spaces).
"RTN","IBCNEUT3",29,0)
 ; If a match (or several matches) is found,and a unique National ID is
"RTN","IBCNEUT3",30,0)
 ; identified, confirm the 5 set of insurance validation criteria and
"RTN","IBCNEUT3",31,0)
 ; process as above.
"RTN","IBCNEUT3",32,0)
 ;
"RTN","IBCNEUT3",33,0)
 ; If no match in the Insurance Company could be made, check the Auto
"RTN","IBCNEUT3",34,0)
 ; Match file.  If a unique IEN is identified, confirm the 5 set of
"RTN","IBCNEUT3",35,0)
 ; criteria stated above and process in kind.
"RTN","IBCNEUT3",36,0)
 ;
"RTN","IBCNEUT3",37,0)
 ; If no match could be established in both the Insurance Company and the
"RTN","IBCNEUT3",38,0)
 ; Auto Match files, check the insurance company synonym file (stripping 
"RTN","IBCNEUT3",39,0)
 ; off leading and trailing spaces) while preserving case sensitivity.
"RTN","IBCNEUT3",40,0)
 ; If a unique Insurance Company could be identified, confirm the 5 set
"RTN","IBCNEUT3",41,0)
 ; of validation criteria and process as above. 
"RTN","IBCNEUT3",42,0)
 ;
"RTN","IBCNEUT3",43,0)
 ; 
"RTN","IBCNEUT3",44,0)
 ; Can't be called from the top
"RTN","IBCNEUT3",45,0)
 Q
"RTN","IBCNEUT3",46,0)
 ;
"RTN","IBCNEUT3",47,0)
 ;
"RTN","IBCNEUT3",48,0)
INSERROR(TYPE,IEN,ERRFLG,ARRAY) ;
"RTN","IBCNEUT3",49,0)
 ; Formal parameters:
"RTN","IBCNEUT3",50,0)
 ;  TYPE:   Type of IEN passed in the second parameter.
"RTN","IBCNEUT3",51,0)
 ;          Either "B" for "Buffer" or "I" for "Insurance".
"RTN","IBCNEUT3",52,0)
 ;          Mandatory, passed by value.
"RTN","IBCNEUT3",53,0)
 ;  IEN:    IEN to perform a lookup for. Mandatory, passed by value.
"RTN","IBCNEUT3",54,0)
 ;  ERRFLG: Error flag. "" or 0 if no extended error information is
"RTN","IBCNEUT3",55,0)
 ;          requested, 1 if extended error information is requested.
"RTN","IBCNEUT3",56,0)
 ;          Optional (the default is 0), passed by value.
"RTN","IBCNEUT3",57,0)
 ;  ARRAY:  Array of error messages returned by the function.
"RTN","IBCNEUT3",58,0)
 ;          Optional, passed by reference. Whatever is passed in will be
"RTN","IBCNEUT3",59,0)
 ;          KILLed by the function. The structure of the return array is
"RTN","IBCNEUT3",60,0)
 ;          as follows:
"RTN","IBCNEUT3",61,0)
 ;          ARRAY         # of error messages passed back
"RTN","IBCNEUT3",62,0)
 ;          ARRAY(error#) Data for this error number, including error
"RTN","IBCNEUT3",63,0)
 ;          number 1 present in the value returned by the function.
"RTN","IBCNEUT3",64,0)
 ;                [1]   IEN of the error code in the symbol file
"RTN","IBCNEUT3",65,0)
 ;                [2]   # of lines in the error message text
"RTN","IBCNEUT3",66,0)
 ;          ARRAY(error #,line #) - One line of error message text
"RTN","IBCNEUT3",67,0)
 ;                                  up to 70 characters long
"RTN","IBCNEUT3",68,0)
 ;
"RTN","IBCNEUT3",69,0)
 ;          Returned value consists of the following "^"-delimited pcs:
"RTN","IBCNEUT3",70,0)
 ;           [1]   The IEN of the IIV SYMBOL File (#365.15) entry for
"RTN","IBCNEUT3",71,0)
 ;                 the first error condition encountered by the function.
"RTN","IBCNEUT3",72,0)
 ;                 This is only present if a valid Payer was not found.
"RTN","IBCNEUT3",73,0)
 ;           [2]   Payer IEN if a Payer was found, "" otherwise
"RTN","IBCNEUT3",74,0)
 ;           [3]   National ID if a Payer was found
"RTN","IBCNEUT3",75,0)
 ;
"RTN","IBCNEUT3",76,0)
 ; Initialize all variables used in this program
"RTN","IBCNEUT3",77,0)
 N INSIEN,INSNAME,NAMEARR,PAYID,PAYIEN,SYMIEN
"RTN","IBCNEUT3",78,0)
 ; Initialize return variables
"RTN","IBCNEUT3",79,0)
 S (PAYID,PAYIEN,SYMIEN)=""
"RTN","IBCNEUT3",80,0)
 ; If the calling program didn't pass the Extended Error flag, init it
"RTN","IBCNEUT3",81,0)
 S ERRFLG=+$G(ERRFLG)
"RTN","IBCNEUT3",82,0)
 ; Initialize array of extended error info to be returned
"RTN","IBCNEUT3",83,0)
 K ARRAY
"RTN","IBCNEUT3",84,0)
 ; Validate input parameters
"RTN","IBCNEUT3",85,0)
 I $G(TYPE)'="B",$G(TYPE)'="I" S SYMIEN=$$ERROR^IBCNEUT8("B9","IEN type "_$G(TYPE)_" passed to the insurance match algorithm is neither 'B' nor 'I'.") G EXIT
"RTN","IBCNEUT3",86,0)
 I $G(IEN)="" S SYMIEN=$$ERROR^IBCNEUT8("B9","IEN is not passed to the insurance match algorithm.") G EXIT
"RTN","IBCNEUT3",87,0)
 I TYPE="B",'$D(^IBA(355.33,IEN)) S SYMIEN=$$ERROR^IBCNEUT8("B9","Invalid Buffer IEN "_IEN_" has been passed to the insurance match algorithm.") G EXIT
"RTN","IBCNEUT3",88,0)
 I TYPE="I",'$D(^DIC(36,IEN)) S SYMIEN=$$ERROR^IBCNEUT8("B9","Invalid Insurance Company IEN "_IEN_" has been passed to the insurance match algorithm.") G EXIT
"RTN","IBCNEUT3",89,0)
 ;
"RTN","IBCNEUT3",90,0)
 ; If the IEN is an Insurance Company IEN, validate it
"RTN","IBCNEUT3",91,0)
 I TYPE="I" D  G EXIT
"RTN","IBCNEUT3",92,0)
 . N TMP
"RTN","IBCNEUT3",93,0)
 . ; Check to see if ins co is ACTIVE
"RTN","IBCNEUT3",94,0)
 . S TMP=$$ACTIVE^IBCNEUT4(IEN)
"RTN","IBCNEUT3",95,0)
 . I 'TMP S SYMIEN=$$ERROR^IBCNEUT8("B10","Insurance Company "_$P(TMP,U,2)_" is not active.") Q
"RTN","IBCNEUT3",96,0)
 . D VALID^IBCNEUT4(IEN,.PAYIEN,.PAYID,.SYMIEN)
"RTN","IBCNEUT3",97,0)
 ;
"RTN","IBCNEUT3",98,0)
 ; Retrieve the ins co name from the Ins Buffer
"RTN","IBCNEUT3",99,0)
 S INSNAME=$$TRIM^XLFSTR($P($G(^IBA(355.33,IEN,20)),U,1))
"RTN","IBCNEUT3",100,0)
 I INSNAME="" S SYMIEN=$$ERROR^IBCNEUT8("B13") G EXIT
"RTN","IBCNEUT3",101,0)
 ; Retrieve all ins co IENs matching this ins co name
"RTN","IBCNEUT3",102,0)
 D INSIEN^IBCNEUT8(INSNAME,.INSIEN)
"RTN","IBCNEUT3",103,0)
 ; 
"RTN","IBCNEUT3",104,0)
 ; If one or more ins. co. name matches found, retrieve Payer info
"RTN","IBCNEUT3",105,0)
 I $D(INSIEN) D  G EXIT
"RTN","IBCNEUT3",106,0)
 . ; If there is one INSIEN - make sure it is ACTIVE
"RTN","IBCNEUT3",107,0)
 . I $O(INSIEN(""))=$O(INSIEN(""),-1),'$$ACTIVE^IBCNEUT4($O(INSIEN(""))) S SYMIEN=$$ERROR^IBCNEUT8("B10","Insurance company "_INSNAME_" is not active.") Q
"RTN","IBCNEUT3",108,0)
 . ; Find National IDs for these ins co IENs
"RTN","IBCNEUT3",109,0)
 . D FINDPAY^IBCNEUT8(.INSIEN,.PAYID)
"RTN","IBCNEUT3",110,0)
 . ; There were Multiple INSIENs - if none exist ALL were INACTIVE
"RTN","IBCNEUT3",111,0)
 . I '$D(INSIEN) S SYMIEN=$$ERROR^IBCNEUT8("B10","All insurance companies named "_INSNAME_" are not active.") Q
"RTN","IBCNEUT3",112,0)
 . ; Quit with an error if no National ID is found for these ins cos
"RTN","IBCNEUT3",113,0)
 . I $O(PAYID(""))="" S SYMIEN=$$ERROR^IBCNEUT8("B4","Insurance company "_INSNAME_" is not linked to a National ID.") Q
"RTN","IBCNEUT3",114,0)
 . ; Quit with an error if more than one National ID found
"RTN","IBCNEUT3",115,0)
 . I $O(PAYID(""))'=$O(PAYID(""),-1) S SYMIEN=$$ERROR^IBCNEUT8("B3","Insurance company "_INSNAME_" is linked to more than one National ID",.PAYID),PAYID="" Q
"RTN","IBCNEUT3",116,0)
 . ; Validate the found unique Payer
"RTN","IBCNEUT3",117,0)
 . D VALID^IBCNEUT4(PAYID($O(PAYID(""))),.PAYIEN,.PAYID,.SYMIEN)
"RTN","IBCNEUT3",118,0)
 ;
"RTN","IBCNEUT3",119,0)
 ; If no exact ins co name match was found, check AutoMatch file
"RTN","IBCNEUT3",120,0)
 ; No need to filter out inactives as the AMLOOK will handle it
"RTN","IBCNEUT3",121,0)
 I $$AMLOOK^IBCNEUT1(INSNAME,1,.NAMEARR) D  I $D(INSIEN) G EXIT
"RTN","IBCNEUT3",122,0)
 . N NAME
"RTN","IBCNEUT3",123,0)
 . ; Based on the array of ins cos returned by the AutoMatch
"RTN","IBCNEUT3",124,0)
 . ; build an array of ins co IENs that they point to
"RTN","IBCNEUT3",125,0)
 . S NAME="" F  S NAME=$O(NAMEARR(NAME)) Q:NAME=""  D INSIEN^IBCNEUT8($$TRIM^XLFSTR(NAME),.INSIEN)
"RTN","IBCNEUT3",126,0)
 . ; If nothing found in the Insurance Co x-ref, quit w/o validation
"RTN","IBCNEUT3",127,0)
 . I '$D(INSIEN) Q
"RTN","IBCNEUT3",128,0)
 . ; Check if there is more than one ins co IEN that matches
"RTN","IBCNEUT3",129,0)
 . ; the entered name, in which case exit with an error
"RTN","IBCNEUT3",130,0)
 . I $O(INSIEN(""))'=$O(INSIEN(""),-1) S SYMIEN=$$ERROR^IBCNEUT8("B2","Insurance company name "_INSNAME_" in the Insurance Buffer matched more than one insurance company in the Auto Match file",.NAMEARR) Q
"RTN","IBCNEUT3",131,0)
 . ; Validate the found unique ins co IEN
"RTN","IBCNEUT3",132,0)
 . D VALID^IBCNEUT4($O(INSIEN("")),.PAYIEN,.PAYID,.SYMIEN)
"RTN","IBCNEUT3",133,0)
 ;
"RTN","IBCNEUT3",134,0)
 ;  If the first two lookups failed, check the Ins Co Synonym file:
"RTN","IBCNEUT3",135,0)
 ; Retrieve all ins co IENs that match in the Synonym file
"RTN","IBCNEUT3",136,0)
 ;M INSIEN=^DIC(36,"C",INSNAME)
"RTN","IBCNEUT3",137,0)
 N %X,%Y
"RTN","IBCNEUT3",138,0)
 S %X="^DIC(36,""C"",INSNAME,"
"RTN","IBCNEUT3",139,0)
 S %Y="INSIEN("
"RTN","IBCNEUT3",140,0)
 I $D(^DIC(36,"C",INSNAME))#10=1 S INSIEN=^DIC(36,"C",INSNAME)
"RTN","IBCNEUT3",141,0)
 D %XY^%RCR K %X,%Y
"RTN","IBCNEUT3",142,0)
 ;
"RTN","IBCNEUT3",143,0)
 ; If nothing found in the Synonym file, error out
"RTN","IBCNEUT3",144,0)
 I '$D(INSIEN) S SYMIEN=$$ERROR^IBCNEUT8("B1","Insurance company "_INSNAME_" could not be matched to a valid entry in the Insurance Company file.") G EXIT
"RTN","IBCNEUT3",145,0)
 ; Loop thru the ins co IENs that matched in the Synonym file
"RTN","IBCNEUT3",146,0)
 S INSIEN=0 F  S INSIEN=$O(INSIEN(INSIEN)) Q:'INSIEN  D
"RTN","IBCNEUT3",147,0)
 . N NAME
"RTN","IBCNEUT3",148,0)
 . ; Retrieve the ins co name for this IEN
"RTN","IBCNEUT3",149,0)
 . S NAME=$$TRIM^XLFSTR($P($G(^DIC(36,INSIEN,0)),U,1))
"RTN","IBCNEUT3",150,0)
 . I NAME'="" S NAMEARR(NAME)=""
"RTN","IBCNEUT3",151,0)
 ;
"RTN","IBCNEUT3",152,0)
 ; If more than one ins co name was found, error out
"RTN","IBCNEUT3",153,0)
 I $O(NAMEARR(""))'=$O(NAMEARR(""),-1) D  G EXIT
"RTN","IBCNEUT3",154,0)
 . S SYMIEN=$$ERROR^IBCNEUT8("B2","Insurance company name "_INSNAME_" in the Insurance Buffer matched more than one insurance company name in the Synonym cross-reference of the Insurance Company file",.NAMEARR)
"RTN","IBCNEUT3",155,0)
 ;
"RTN","IBCNEUT3",156,0)
 ; If there is one INSIEN - make sure it is ACTIVE
"RTN","IBCNEUT3",157,0)
 I $O(INSIEN(""))=$O(INSIEN(""),-1),'$$ACTIVE^IBCNEUT4($O(INSIEN(""))) S SYMIEN=$$ERROR^IBCNEUT8("B10","Insurance company "_INSNAME_" is not active.") G EXIT
"RTN","IBCNEUT3",158,0)
 ; Find National IDs for these ins co IENs
"RTN","IBCNEUT3",159,0)
 D FINDPAY^IBCNEUT8(.INSIEN,.PAYID)
"RTN","IBCNEUT3",160,0)
 ;
"RTN","IBCNEUT3",161,0)
 ; There were Multiple INSIENs - if none exist ALL were INACTIVE
"RTN","IBCNEUT3",162,0)
 I '$D(INSIEN) S SYMIEN=$$ERROR^IBCNEUT8("B10","All insurance companies named "_INSNAME_" are not active."),PAYID="" G EXIT
"RTN","IBCNEUT3",163,0)
 ; If no National ID was found, error out
"RTN","IBCNEUT3",164,0)
 I $O(PAYID(""))="" S SYMIEN=$$ERROR^IBCNEUT8("B4","Insurance company "_$O(NAMEARR(""))_" is not linked to a National ID.") G EXIT
"RTN","IBCNEUT3",165,0)
 ; If multiple National IDs were found, error out
"RTN","IBCNEUT3",166,0)
 I $O(PAYID(""))'=$O(PAYID(""),-1) S SYMIEN=$$ERROR^IBCNEUT8("B3","Insurance company "_$O(NAMEARR(""))_" is linked to more than one National ID",.PAYID),PAYID="" G EXIT
"RTN","IBCNEUT3",167,0)
 ; Validate the found unique National ID
"RTN","IBCNEUT3",168,0)
 D VALID^IBCNEUT4(PAYID($O(PAYID(""))),.PAYIEN,.PAYID,.SYMIEN)
"RTN","IBCNEUT3",169,0)
 ;
"RTN","IBCNEUT3",170,0)
EXIT ; Main function exit point
"RTN","IBCNEUT3",171,0)
 Q SYMIEN_U_PAYIEN_U_PAYID
"RTN","IBCNEUT3",172,0)
 ;
"RTN","IBCNEUT6")
0^9^B17301975
"RTN","IBCNEUT6",1,0)
IBCNEUT6 ;DAOU/ESG - IIV MISC. UTILITIES ;14-AUG-2002
"RTN","IBCNEUT6",2,0)
 ;;2.0;INTEGRATED BILLING;**184,252**;21-MAR-94
"RTN","IBCNEUT6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEUT6",4,0)
 ;
"RTN","IBCNEUT6",5,0)
 ; Can't be called from the top
"RTN","IBCNEUT6",6,0)
 Q
"RTN","IBCNEUT6",7,0)
 ;
"RTN","IBCNEUT6",8,0)
AMCHECK ; This procedure will examine the insurance company names in the 
"RTN","IBCNEUT6",9,0)
 ; Auto Match file (#365.11) to make sure there is still at least
"RTN","IBCNEUT6",10,0)
 ; one active insurance company with that name.  If there isn't,
"RTN","IBCNEUT6",11,0)
 ; then the Auto Match entries for that insurance company name
"RTN","IBCNEUT6",12,0)
 ; will be deleted.
"RTN","IBCNEUT6",13,0)
 ;
"RTN","IBCNEUT6",14,0)
 NEW NAME,INSIEN,FOUNDACT,DA,DIK,DIC,X,Y,%
"RTN","IBCNEUT6",15,0)
 S NAME=""
"RTN","IBCNEUT6",16,0)
 F  S NAME=$O(^IBCN(365.11,"C",NAME)) Q:NAME=""  D
"RTN","IBCNEUT6",17,0)
 . ;
"RTN","IBCNEUT6",18,0)
 . ; For this Auto Match ins co name, see if there is an active ins co
"RTN","IBCNEUT6",19,0)
 . S INSIEN=0,FOUNDACT=0
"RTN","IBCNEUT6",20,0)
 . F  S INSIEN=$O(^DIC(36,"B",NAME,INSIEN)) Q:'INSIEN  I $$ACTIVE^IBCNEUT4(INSIEN) S FOUNDACT=1 Q
"RTN","IBCNEUT6",21,0)
 . ;
"RTN","IBCNEUT6",22,0)
 . ; If an active ins co was found, then we're OK so quit
"RTN","IBCNEUT6",23,0)
 . I FOUNDACT Q
"RTN","IBCNEUT6",24,0)
 . ;
"RTN","IBCNEUT6",25,0)
 . ; Otherwise, we need to delete all Auto Match entries for this name
"RTN","IBCNEUT6",26,0)
 . S DA=0,DIK="^IBCN(365.11,"
"RTN","IBCNEUT6",27,0)
 . F  S DA=$O(^IBCN(365.11,"C",NAME,DA)) Q:'DA  D ^DIK
"RTN","IBCNEUT6",28,0)
 . Q
"RTN","IBCNEUT6",29,0)
AMCHKX ;
"RTN","IBCNEUT6",30,0)
 Q
"RTN","IBCNEUT6",31,0)
 ;
"RTN","IBCNEUT6",32,0)
 ;
"RTN","IBCNEUT6",33,0)
AMADD(INSNAME,IBCNEXT1) ; Conditionally add an Auto Match entry based on user input
"RTN","IBCNEUT6",34,0)
 ; Input Parameters:
"RTN","IBCNEUT6",35,0)
 ;    INSNAME is a valid, active insurance company name
"RTN","IBCNEUT6",36,0)
 ;   IBCNEXT1 is the existing entry in the ins co name field in the
"RTN","IBCNEUT6",37,0)
 ;            buffer.  This may be used as the Auto Match value for
"RTN","IBCNEUT6",38,0)
 ;            a new auto match entry.
"RTN","IBCNEUT6",39,0)
 ;
"RTN","IBCNEUT6",40,0)
 NEW AMDATA,AMIEN,AMERROR
"RTN","IBCNEUT6",41,0)
 NEW DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","IBCNEUT6",42,0)
 NEW D,D0,D1,DA,DB,DC,DDH,DE,DG,DH,DI,DIC,DIE,DIEL,DIFLD,DIG,DIH
"RTN","IBCNEUT6",43,0)
 NEW DIK,DILN,DIPA,DISYS,DIV,DK,DL,DM,DN,DOV,DP,DQ,DR,DU,DV,DZ
"RTN","IBCNEUT6",44,0)
 ;
"RTN","IBCNEUT6",45,0)
 ; First, check security key to see if user is allowed to do this
"RTN","IBCNEUT6",46,0)
 I '$$KCHK^XUSRB("IBCNE IIV AUTO MATCH") G AMADDX
"RTN","IBCNEUT6",47,0)
 ;
"RTN","IBCNEUT6",48,0)
 S IBCNEXT1=$$UP^XLFSTR(IBCNEXT1)               ; all uppercase
"RTN","IBCNEUT6",49,0)
 S IBCNEXT1=$$TRIM^XLFSTR(IBCNEXT1)             ; lead/trail spaces
"RTN","IBCNEUT6",50,0)
 I IBCNEXT1="" G AMADDX                         ; must exist
"RTN","IBCNEUT6",51,0)
 I $L(IBCNEXT1)>30!($L(IBCNEXT1)<3) G AMADDX    ; too long or too short
"RTN","IBCNEUT6",52,0)
 I IBCNEXT1=INSNAME G AMADDX                    ; cannot equal the name
"RTN","IBCNEUT6",53,0)
 I $D(^IBCN(365.11,"B",IBCNEXT1)) G AMADDX      ; already in Auto Match
"RTN","IBCNEUT6",54,0)
 I $D(^DIC(36,"B",IBCNEXT1)) G AMADDX           ; already an ins co name
"RTN","IBCNEUT6",55,0)
 I $D(^DIC(36,"C",IBCNEXT1)) G AMADDX           ; already a synonym
"RTN","IBCNEUT6",56,0)
 I IBCNEXT1["*" G AMADDX                        ; no wildcards allowed
"RTN","IBCNEUT6",57,0)
 ;
"RTN","IBCNEUT6",58,0)
 S DIR(0)="YO"
"RTN","IBCNEUT6",59,0)
 S DIR("A",1)=" "
"RTN","IBCNEUT6",60,0)
 S DIR("A",2)="Do you want to add an Auto Match entry that associates"
"RTN","IBCNEUT6",61,0)
 S DIR("A")=IBCNEXT1_" with "_INSNAME
"RTN","IBCNEUT6",62,0)
 S DIR("B")="No"
"RTN","IBCNEUT6",63,0)
 S DIR("?",1)="      The Auto Match Value is "_IBCNEXT1_"."
"RTN","IBCNEUT6",64,0)
 S DIR("?",2)="The Insurance Company Name is "_INSNAME_"."
"RTN","IBCNEUT6",65,0)
 S DIR("?",3)=" "
"RTN","IBCNEUT6",66,0)
 S DIR("?",4)="Please enter NO if you do not want to associate these two values together"
"RTN","IBCNEUT6",67,0)
 S DIR("?",5)="in the Auto Match file."
"RTN","IBCNEUT6",68,0)
 S DIR("?",6)=" "
"RTN","IBCNEUT6",69,0)
 S DIR("?",7)="Please enter YES if you do want to create an Auto Match entry for these"
"RTN","IBCNEUT6",70,0)
 S DIR("?",8)="two values.  If you enter YES, then you will have the chance to modify"
"RTN","IBCNEUT6",71,0)
 S DIR("?")="the Auto Match Value."
"RTN","IBCNEUT6",72,0)
 D ^DIR K DIR
"RTN","IBCNEUT6",73,0)
 D EN^DDIOL(,,"!!")
"RTN","IBCNEUT6",74,0)
 ;
"RTN","IBCNEUT6",75,0)
 ; If user didn't say Yes, then we exit
"RTN","IBCNEUT6",76,0)
 I 'Y G AMADDX
"RTN","IBCNEUT6",77,0)
 ; To allow for edits to the .01 field and not the .02 field,
"RTN","IBCNEUT6",78,0)
 ; Add this new entry first and then edit only the .01 field.
"RTN","IBCNEUT6",79,0)
 S AMDATA(365.11,"+1,",.01)=IBCNEXT1
"RTN","IBCNEUT6",80,0)
 S AMDATA(365.11,"+1,",.02)=INSNAME
"RTN","IBCNEUT6",81,0)
 S AMDATA(365.11,"+1,",.03)=$$NOW^XLFDT
"RTN","IBCNEUT6",82,0)
 S AMDATA(365.11,"+1,",.04)=DUZ
"RTN","IBCNEUT6",83,0)
 S AMDATA(365.11,"+1,",.05)=$$NOW^XLFDT
"RTN","IBCNEUT6",84,0)
 S AMDATA(365.11,"+1,",.06)=DUZ
"RTN","IBCNEUT6",85,0)
 S AMDATA(365.11,"+1,",.07)=IBCNEXT1
"RTN","IBCNEUT6",86,0)
 S AMDATA(365.11,"+1,",.08)=INSNAME
"RTN","IBCNEUT6",87,0)
 D UPDATE^DIE("","AMDATA","AMIEN","AMERROR")
"RTN","IBCNEUT6",88,0)
 ;
"RTN","IBCNEUT6",89,0)
 I $D(AMERROR) G AMADDX       ; FileMan error so get out
"RTN","IBCNEUT6",90,0)
 S AMIEN=+$G(AMIEN(1))        ; internal entry number created
"RTN","IBCNEUT6",91,0)
 I 'AMIEN G AMADDX            ; if IEN not there get out
"RTN","IBCNEUT6",92,0)
 ;
"RTN","IBCNEUT6",93,0)
 ; Here we have to edit the entry to allow for the opportunity to 
"RTN","IBCNEUT6",94,0)
 ; change something
"RTN","IBCNEUT6",95,0)
 S DIE=365.11,DA=AMIEN,DR=".01;.05////"_$$NOW^XLFDT_";.06////"_DUZ
"RTN","IBCNEUT6",96,0)
 D ^DIE
"RTN","IBCNEUT6",97,0)
 ;
"RTN","IBCNEUT6",98,0)
 ; Display the confirmation message to the user
"RTN","IBCNEUT6",99,0)
 S AMDATA=$G(^IBCN(365.11,AMIEN,0))
"RTN","IBCNEUT6",100,0)
 I AMDATA'="" D EN^DDIOL($P(AMDATA,U,1)_" is now associated with "_$P(AMDATA,U,2)_".",,"!!?3")
"RTN","IBCNEUT6",101,0)
 D EN^DDIOL(,,"!!")
"RTN","IBCNEUT6",102,0)
AMADDX ;
"RTN","IBCNEUT6",103,0)
 Q
"RTN","IBCNEUT6",104,0)
 ;
"VER")
8.0^22.0
**END**
**END**
