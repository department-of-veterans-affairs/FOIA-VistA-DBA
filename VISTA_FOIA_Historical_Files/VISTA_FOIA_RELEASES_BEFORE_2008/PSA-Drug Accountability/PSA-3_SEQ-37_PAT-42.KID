Released PSA*3*42 SEQ #37
Extracted from mail message
**KIDS**:PSA*3.0*42^

**INSTALL NAME**
PSA*3.0*42
"BLD",5834,0)
PSA*3.0*42^DRUG ACCOUNTABILITY^0^3050607^y
"BLD",5834,1,0)
^^18^18^3050405^
"BLD",5834,1,1,0)
This patch address the following problems:
"BLD",5834,1,2,0)
 
"BLD",5834,1,3,0)
1.      68526           Price updates into the Drug file #50 are failing 
"BLD",5834,1,4,0)
due to current logic that both order units and dispense units between the 
"BLD",5834,1,5,0)
matched drug and the invoice must be equal before updating. Also, the
"BLD",5834,1,6,0)
reporting and/or representation of which drugs are about to have order
"BLD",5834,1,7,0)
units, costs, dispense units, and/or NDCs is hard to read, not concise,
"BLD",5834,1,8,0)
and unwanted changes are being overlooked.
"BLD",5834,1,9,0)
 
"BLD",5834,1,10,0)
2.      85690   Drugs that are added to pharmacy locations are initially 
"BLD",5834,1,11,0)
setup with a minimum of information and need to be completed manually by 
"BLD",5834,1,12,0)
the pharmacy staff. A method of notification is needed to let the 
"BLD",5834,1,13,0)
pharmacy staff know which drugs are needing completion.
"BLD",5834,1,14,0)
 
"BLD",5834,1,15,0)
3.      68611   Invoice items that have a zero quantity are updating 
"BLD",5834,1,16,0)
inventory costing for dispensing. This results in a miss-representation 
"BLD",5834,1,17,0)
of costs being presented for statistics and being billed to third party 
"BLD",5834,1,18,0)
insurances.
"BLD",5834,4,0)
^9.64PA^^
"BLD",5834,"KRN",0)
^9.67PA^8989.52^19
"BLD",5834,"KRN",.4,0)
.4
"BLD",5834,"KRN",.401,0)
.401
"BLD",5834,"KRN",.402,0)
.402
"BLD",5834,"KRN",.403,0)
.403
"BLD",5834,"KRN",.5,0)
.5
"BLD",5834,"KRN",.84,0)
.84
"BLD",5834,"KRN",3.6,0)
3.6
"BLD",5834,"KRN",3.8,0)
3.8
"BLD",5834,"KRN",9.2,0)
9.2
"BLD",5834,"KRN",9.8,0)
9.8
"BLD",5834,"KRN",9.8,"NM",0)
^9.68A^9^5
"BLD",5834,"KRN",9.8,"NM",3,0)
PSAVER6^^0^B48612927
"BLD",5834,"KRN",9.8,"NM",5,0)
PSAVER7^^0^B16426253
"BLD",5834,"KRN",9.8,"NM",6,0)
PSAVERA3^^0^B8881546
"BLD",5834,"KRN",9.8,"NM",8,0)
PSAPROC7^^0^B50647267
"BLD",5834,"KRN",9.8,"NM",9,0)
PSAUTL6^^0^B17849828
"BLD",5834,"KRN",9.8,"NM","B","PSAPROC7",8)

"BLD",5834,"KRN",9.8,"NM","B","PSAUTL6",9)

"BLD",5834,"KRN",9.8,"NM","B","PSAVER6",3)

"BLD",5834,"KRN",9.8,"NM","B","PSAVER7",5)

"BLD",5834,"KRN",9.8,"NM","B","PSAVERA3",6)

"BLD",5834,"KRN",19,0)
19
"BLD",5834,"KRN",19.1,0)
19.1
"BLD",5834,"KRN",101,0)
101
"BLD",5834,"KRN",409.61,0)
409.61
"BLD",5834,"KRN",771,0)
771
"BLD",5834,"KRN",870,0)
870
"BLD",5834,"KRN",8989.51,0)
8989.51
"BLD",5834,"KRN",8989.52,0)
8989.52
"BLD",5834,"KRN",8994,0)
8994
"BLD",5834,"KRN","B",.4,.4)

"BLD",5834,"KRN","B",.401,.401)

"BLD",5834,"KRN","B",.402,.402)

"BLD",5834,"KRN","B",.403,.403)

"BLD",5834,"KRN","B",.5,.5)

"BLD",5834,"KRN","B",.84,.84)

"BLD",5834,"KRN","B",3.6,3.6)

"BLD",5834,"KRN","B",3.8,3.8)

"BLD",5834,"KRN","B",9.2,9.2)

"BLD",5834,"KRN","B",9.8,9.8)

"BLD",5834,"KRN","B",19,19)

"BLD",5834,"KRN","B",19.1,19.1)

"BLD",5834,"KRN","B",101,101)

"BLD",5834,"KRN","B",409.61,409.61)

"BLD",5834,"KRN","B",771,771)

"BLD",5834,"KRN","B",870,870)

"BLD",5834,"KRN","B",8989.51,8989.51)

"BLD",5834,"KRN","B",8989.52,8989.52)

"BLD",5834,"KRN","B",8994,8994)

"BLD",5834,"QUES",0)
^9.62^^
"BLD",5834,"REQB",0)
^9.611^2^1
"BLD",5834,"REQB",2,0)
PSA*3.0*21^1
"BLD",5834,"REQB","B","PSA*3.0*21",2)

"MBREQ")
0
"PKG",487,-1)
1^1
"PKG",487,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",487,20,0)
^9.402P^^
"PKG",487,22,0)
^9.49I^1^1
"PKG",487,22,1,0)
3.0^2971024^2981028^66481
"PKG",487,22,1,"PAH",1,0)
42^3050607^123456966
"PKG",487,22,1,"PAH",1,1,0)
^^18^18^3050607
"PKG",487,22,1,"PAH",1,1,1,0)
This patch address the following problems:
"PKG",487,22,1,"PAH",1,1,2,0)
 
"PKG",487,22,1,"PAH",1,1,3,0)
1.      68526           Price updates into the Drug file #50 are failing 
"PKG",487,22,1,"PAH",1,1,4,0)
due to current logic that both order units and dispense units between the 
"PKG",487,22,1,"PAH",1,1,5,0)
matched drug and the invoice must be equal before updating. Also, the
"PKG",487,22,1,"PAH",1,1,6,0)
reporting and/or representation of which drugs are about to have order
"PKG",487,22,1,"PAH",1,1,7,0)
units, costs, dispense units, and/or NDCs is hard to read, not concise,
"PKG",487,22,1,"PAH",1,1,8,0)
and unwanted changes are being overlooked.
"PKG",487,22,1,"PAH",1,1,9,0)
 
"PKG",487,22,1,"PAH",1,1,10,0)
2.      85690   Drugs that are added to pharmacy locations are initially 
"PKG",487,22,1,"PAH",1,1,11,0)
setup with a minimum of information and need to be completed manually by 
"PKG",487,22,1,"PAH",1,1,12,0)
the pharmacy staff. A method of notification is needed to let the 
"PKG",487,22,1,"PAH",1,1,13,0)
pharmacy staff know which drugs are needing completion.
"PKG",487,22,1,"PAH",1,1,14,0)
 
"PKG",487,22,1,"PAH",1,1,15,0)
3.      68611   Invoice items that have a zero quantity are updating 
"PKG",487,22,1,"PAH",1,1,16,0)
inventory costing for dispensing. This results in a miss-representation 
"PKG",487,22,1,"PAH",1,1,17,0)
of costs being presented for statistics and being billed to third party 
"PKG",487,22,1,"PAH",1,1,18,0)
insurances.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSAPROC7")
0^8^B50647267
"RTN","PSAPROC7",1,0)
PSAPROC7 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;9/6/97
"RTN","PSAPROC7",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,24,27,21,42**; 10/24/97
"RTN","PSAPROC7",3,0)
 ;This routine takes the data in XTMP and moves it to DA ORDERS file.
"RTN","PSAPROC7",4,0)
 ;It deletes the data in XTMP after it is copies.
"RTN","PSAPROC7",5,0)
 ;
"RTN","PSAPROC7",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC7",7,0)
INVOICE ;PSA*3*21 (3JAN01) - FILE INVOICE IMMEDIATELY
"RTN","PSAPROC7",8,0)
 ;
"RTN","PSAPROC7",9,0)
 S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")) Q:PSAIN=""
"RTN","PSAPROC7",10,0)
 Q:$P(PSAIN,"^",8)'="P"
"RTN","PSAPROC7",11,0)
 S PSAORD=$P(PSAIN,"^",4),PSAIEN=+$O(^PSD(58.811,"B",PSAORD,0)),PSACRED=0
"RTN","PSAPROC7",12,0)
 I 'PSAIEN D
"RTN","PSAPROC7",13,0)
 .F  L +^PSD(58.811,0):0 I  Q
"RTN","PSAPROC7",14,0)
 .;(PSA*3*24 - Dave B. Jun 2 00 - Improper DIC call)
"RTN","PSAPROC7",15,0)
 .S DIC="^PSD(58.811,",DIC(0)="L",X=PSAORD D FILE^DICN K DIC L -^PSD(58.811,0) S PSAIEN=+Y
"RTN","PSAPROC7",16,0)
 F  L +^PSD(58.811,PSAIEN,0):10 I  Q
"RTN","PSAPROC7",17,0)
 S:'$D(^PSD(58.811,PSAIEN,1,0)) DIC("P")=$P(^DD(58.811,2,0),"^",2)
"RTN","PSAPROC7",18,0)
 S DA(1)=PSAIEN,DIC="^PSD(58.811,"_DA(1)_",1,",DIC(0)="L",X=$P(PSAIN,"^",2),DLAYGO=58.811 D ^DIC K DA,DLAYGO S PSAIEN1=+Y
"RTN","PSAPROC7",19,0)
 S DA(1)=PSAIEN,DA=PSAIEN1,DIE=DIC K DIC
"RTN","PSAPROC7",20,0)
 S PSALOCDR=$P($G(PSAIN),"^",7)
"RTN","PSAPROC7",21,0)
 S PSADELDR=$P($G(PSAIN),"^",6)
"RTN","PSAPROC7",22,0)
 S PSACSDR=$S($P(PSAIN,"^",10)="ALL CS":"A",$P(PSAIN,"^",9)="CS":"S",1:"N")
"RTN","PSAPROC7",23,0)
 S PSARECD=$P($G(PSAIN),"^",11)
"RTN","PSAPROC7",24,0)
 S PSAMV=$S(+$P(PSAIN,"^",12):$P(PSAIN,"^",12),1:"")
"RTN","PSAPROC7",25,0)
 S PSASUP=$S($P(PSAIN,"^",13)="SUP":1,1:"")
"RTN","PSAPROC7",26,0)
 ;DAVE B ( PSA*3*12) Invalid Concatenation of zero node
"RTN","PSAPROC7",27,0)
 S ^PSD(58.811,DA(1),1,DA,0)=$P(^(0),"^")_"^"_$P(PSAIN,"^",1)_"^P^"_$P(PSAIN,"^",3)_"^"_$G(PSALOCDR)_"^"_$G(PSADELDR)_"^"_$G(PSARECD)_"^"_$G(PSACSDR)_"^^"_DUZ_"^^"_$G(PSAMV)_"^"_$G(PSASUP)
"RTN","PSAPROC7",28,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",29,0)
 K ^TMP($J,"PSADIF"),PSADIFLC ;*42 pre verify storage for  OU, DUOU, Cost, NDC changes
"RTN","PSAPROC7",30,0)
 S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D LINE
"RTN","PSAPROC7",31,0)
 D SCANDIF,MM ;*42 look for differences to drug file SEND EMAIL
"RTN","PSAPROC7",32,0)
 I PSACRED K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10///^S X=1" D ^DIE K DIE
"RTN","PSAPROC7",33,0)
 S $P(^PSD(58.811,PSAIEN,0),"^",2)=$P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")
"RTN","PSAPROC7",34,0)
 L -^PSD(58.811,PSAIEN,0)
"RTN","PSAPROC7",35,0)
 K ^XTMP("PSAPV",PSACTRL)
"RTN","PSAPROC7",36,0)
 Q
"RTN","PSAPROC7",37,0)
 ;
"RTN","PSAPROC7",38,0)
LINE ;Files line items.
"RTN","PSAPROC7",39,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE) S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)) DIC("P")=$P(^DD(58.8112,5,0),"^",2)
"RTN","PSAPROC7",40,0)
 ;PSA*3*31 Dave B - Check for invoice already in file
"RTN","PSAPROC7",41,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,(DA,X)=PSALINE,DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN2=+Y K DA,DIC,DLAYGO
"RTN","PSAPROC7",42,0)
 ;
"RTN","PSAPROC7",43,0)
 ;DAVEB PSA*3*3 (5may98)
"RTN","PSAPROC7",44,0)
 S PSADRG=$P($G(PSADATA),"^",6)
"RTN","PSAPROC7",45,0)
 S PSASYN=$P($G(PSADATA),"^",7)
"RTN","PSAPROC7",46,0)
 K PSAUNIT
"RTN","PSAPROC7",47,0)
 I $G(PSASYN)'="",$G(PSADRG)'="" S PSAUNIT=+$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",5)
"RTN","PSAPROC7",48,0)
 ;
"RTN","PSAPROC7",49,0)
 ;DAVE B (PSA*3*12) Assignment of order unit didn't take into 
"RTN","PSAPROC7",50,0)
 ;account the adjusted order unit.
"RTN","PSAPROC7",51,0)
 S PSAUNIT=$S($D(PSAUNIT):PSAUNIT,$P(PSADATA,"^",12)'="":$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),1:0)
"RTN","PSAPROC7",52,0)
 S PSACS=$S($P(PSADATA,"^",19)="CS":1,1:0),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSAUPC=$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",53,0)
 I PSANDC="",$P($P(PSADATA,"^",26),"~")'="" S PSANDC="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",54,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=$S($D(PSAIEN2):PSAIEN2,1:PSALINE),DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAPROC7",55,0)
 ;DaveB (4may98) hard code filing data
"RTN","PSAPROC7",56,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",3)=+PSADATA
"RTN","PSAPROC7",57,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",11)=PSANDC
"RTN","PSAPROC7",58,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",12)=PSAVSN
"RTN","PSAPROC7",59,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",13)=PSAUPC
"RTN","PSAPROC7",60,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",10)=PSACS
"RTN","PSAPROC7",61,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",2)=PSADRG
"RTN","PSAPROC7",62,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",4)=PSAUNIT
"RTN","PSAPROC7",63,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",5)=$P(PSADATA,"^",3)
"RTN","PSAPROC7",64,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",6)=DT
"RTN","PSAPROC7",65,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",7)=DUZ
"RTN","PSAPROC7",66,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",67,0)
 ;End PSA*3*7
"RTN","PSAPROC7",68,0)
 ;
"RTN","PSAPROC7",69,0)
 I +$P(PSADATA,"^",15)!($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))) D ADJDRUG
"RTN","PSAPROC7",70,0)
 I $P(PSADATA,"^",8)'="" D QTY
"RTN","PSAPROC7",71,0)
 I +$P(PSADATA,"^",12) D OU
"RTN","PSAPROC7",72,0)
 I +$P(PSADATA,"^",23) D PRICE
"RTN","PSAPROC7",73,0)
 ;Adds the reorder level and/or dispense units per order unit
"RTN","PSAPROC7",74,0)
 I +$P(PSADATA,"^",7)!(+$P(PSADATA,"^",20))!(+$P(PSADATA,"^",21))!(+$P(PSADATA,"^",27)) D
"RTN","PSAPROC7",75,0)
 .S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,2)=$P(PSADATA,"^",20)_"^"_$P(PSADATA,"^",21)_"^"_$S(+$P(PSADATA,"^",7):+$P(PSADATA,"^",7),1:0)_"^"_+$P(PSADATA,"^",27)
"RTN","PSAPROC7",76,0)
 K ^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC7",77,0)
 Q
"RTN","PSAPROC7",78,0)
ADJDRUG ;Records adjusted drug received
"RTN","PSAPROC7",79,0)
 S PSAFLD="D"
"RTN","PSAPROC7",80,0)
 I +$P(PSADATA,"^",15) S PSADJ=+$P(PSADATA,"^",15),PSADUZ=+$P(PSADATA,"^",16),PSADT=+$P(PSADATA,"^",17),PSAREA="" D RECORD Q
"RTN","PSAPROC7",81,0)
 I $D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")) S PSASNODE=^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),PSADJ=$P(PSASNODE,"^",3),PSADUZ=+$P(PSASNODE,"^"),PSADT=+$P(PSASNODE,"^",2),PSAREA="" D RECORD
"RTN","PSAPROC7",82,0)
 Q
"RTN","PSAPROC7",83,0)
OU ;Records adjusted order unit
"RTN","PSAPROC7",84,0)
 S PSAFLD="O",PSADJ=+$P(PSADATA,"^",12),PSADUZ=+$P(PSADATA,"^",13),PSADT=+$P(PSADATA,"^",14),PSAREA=""
"RTN","PSAPROC7",85,0)
 D RECORD
"RTN","PSAPROC7",86,0)
 Q
"RTN","PSAPROC7",87,0)
PRICE ;Records adjusted price per order unit
"RTN","PSAPROC7",88,0)
 S PSAFLD="P",PSADJ=+$P(PSADATA,"^",23),PSADUZ=+$P(PSADATA,"^",24),PSADT=+$P(PSADATA,"^",25),PSAREA=""
"RTN","PSAPROC7",89,0)
 S:PSADJ'=+$P(PSADATA,"^",3) PSACRED=1
"RTN","PSAPROC7",90,0)
 D RECORD
"RTN","PSAPROC7",91,0)
 Q
"RTN","PSAPROC7",92,0)
QTY ;Records adjusted quantity received.
"RTN","PSAPROC7",93,0)
 S PSAFLD="Q",PSADJ=+$P(PSADATA,"^",8),PSADUZ=+$P(PSADATA,"^",9),PSADT=+$P(PSADATA,"^",10),PSAREA=$P(PSADATA,"^",11)
"RTN","PSAPROC7",94,0)
 S:PSADJ'=+$P(PSADATA,"^") PSACRED=1
"RTN","PSAPROC7",95,0)
 D RECORD
"RTN","PSAPROC7",96,0)
 Q
"RTN","PSAPROC7",97,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAPROC7",98,0)
 K DA S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSAIEN2,X=PSAFLD
"RTN","PSAPROC7",99,0)
 S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2)
"RTN","PSAPROC7",100,0)
 ;PSA*3*27 (DAVE B) removed killing of DA variable on next line
"RTN","PSAPROC7",101,0)
 S DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN3=+Y K DLAYGO
"RTN","PSAPROC7",102,0)
 ;
"RTN","PSAPROC7",103,0)
 ;PSA*3*3
"RTN","PSAPROC7",104,0)
 ;DAVEB Hard code filing
"RTN","PSAPROC7",105,0)
 S DIE=DIC,DA=PSAIEN3
"RTN","PSAPROC7",106,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",2)=PSADJ
"RTN","PSAPROC7",107,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",3)=$G(PSAREA)
"RTN","PSAPROC7",108,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",4)=DT
"RTN","PSAPROC7",109,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",5)=DUZ
"RTN","PSAPROC7",110,0)
 ;
"RTN","PSAPROC7",111,0)
 ;S DIE=DIC,DA=PSAIEN3,DR="1///"_PSADJ_$S(PSAREA'="":";2////^S X=PSAREA",1:"")_";3///^S X="_PSADT_";4///^S X="_PSADUZ K DIC D ^DIE
"RTN","PSAPROC7",112,0)
 S DIK=DIE,DA=PSAIEN3 D IX1^DIK K DA,DIE,DIK,PSAFLD
"RTN","PSAPROC7",113,0)
 Q
"RTN","PSAPROC7",114,0)
 ;*42 CHANGES
"RTN","PSAPROC7",115,0)
SCANDIF ; inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAPROC7",116,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAPROC7",117,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAPROC7",118,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK
"RTN","PSAPROC7",119,0)
 Q
"RTN","PSAPROC7",120,0)
MM ;
"RTN","PSAPROC7",121,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAPROC7",122,0)
 Q
"RTN","PSAPROC7",123,0)
CHECK ;Check line item for differences to drug file *42
"RTN","PSAPROC7",124,0)
 N ITM,ITMI,DRG,DRIEN,DIF,ZZ,XX,XXX,PCNT,PDIF,T,IENS
"RTN","PSAPROC7",125,0)
 ; use new API call to retrieve item fields see PSAUTL6
"RTN","PSAPROC7",126,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITM)
"RTN","PSAPROC7",127,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITMI,"I")
"RTN","PSAPROC7",128,0)
 I ITM(2)'>0 Q  ;zero quantity will not be filed
"RTN","PSAPROC7",129,0)
 S ITM("OU")=ITM(3),ITM("DUOU")=ITM(10),ITM("NDC")=ITM(13),ITM("PPOU")=ITM(4),ITM("PPDU")=$J(ITM("PPOU")/ITM("DUOU"),1,4)
"RTN","PSAPROC7",130,0)
 S DRIEN=+ITMI(1)
"RTN","PSAPROC7",131,0)
 S DRG("OU")=$$GET1^DIQ(50,DRIEN,12),DRG("DUOU")=$$GET1^DIQ(50,DRIEN,15),DRG("NDC")=$$GET1^DIQ(50,DRIEN,31),DRG("PPDU")=$$GET1^DIQ(50,DRIEN,16)
"RTN","PSAPROC7",132,0)
 K DIF
"RTN","PSAPROC7",133,0)
 F XX="OU","DUOU","NDC" I ITM(XX)'=DRG(XX) S DIF(XX)=""
"RTN","PSAPROC7",134,0)
 I ITM("PPDU")'=DRG("PPDU") S PCNT=.05*DRG("PPDU"),PDIF=DRG("PPDU")-ITM("PPDU") S:PDIF<0 PDIF=-1*PDIF S:PDIF>PCNT DIF("PPDU")=""
"RTN","PSAPROC7",135,0)
 I $D(DIF) D
"RTN","PSAPROC7",136,0)
 . F ZZ=" ",$J(ITM(.01),3)_"   "_ITM(1) D SET
"RTN","PSAPROC7",137,0)
 . S XXX="" F  S XXX=$O(DIF(XXX)) Q:XXX=""  D
"RTN","PSAPROC7",138,0)
 .. S ZZ="  ",T=XXX,ZZ=$$SETSTR^VALM1(T,ZZ,4,$L(T))
"RTN","PSAPROC7",139,0)
 .. S T="Old: "_DRG(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,13,$L(T))
"RTN","PSAPROC7",140,0)
 .. S T="New: "_ITM(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,36,$L(T))
"RTN","PSAPROC7",141,0)
 .. D SET
"RTN","PSAPROC7",142,0)
 Q
"RTN","PSAPROC7",143,0)
SET ;set differences into ^TMP
"RTN","PSAPROC7",144,0)
 S:'$G(PSADIFLC) PSADIFLC=3
"RTN","PSAPROC7",145,0)
 S ^TMP($J,"PSADIF",PSADIFLC,0)=ZZ,PSADIFLC=PSADIFLC+1
"RTN","PSAPROC7",146,0)
 Q
"RTN","PSAPROC7",147,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAPROC7",148,0)
 K DIR N IENS
"RTN","PSAPROC7",149,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAPROC7",150,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAPROC7",151,0)
 S XMSUB="PRE Verify "_PSAORD_" : "_PSAINV_" Variance Report"
"RTN","PSAPROC7",152,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAPROC7",153,0)
 W !,XMSUB,!
"RTN","PSAPROC7",154,0)
 W !,"Noted differences between the invoice line items and the drug file have",!,"been found. A mail message is being sent to G.PSA NDC UPDATES."
"RTN","PSAPROC7",155,0)
 W !!,"    Please check the message for accuracy.",!
"RTN","PSAPROC7",156,0)
 K DIR S DIR(0)="E",DIR("A")="<cr> - continue" D ^DIR
"RTN","PSAPROC7",157,0)
 K DIR
"RTN","PSAPROC7",158,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAPROC7",159,0)
 D ^XMD
"RTN","PSAPROC7",160,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAPROC7",161,0)
 Q
"RTN","PSAUTL6")
0^9^B17849828
"RTN","PSAUTL6",1,0)
PSAUTL6 ;VMP/PDW-PULL ORDER INVOICE LINE ITEM DATA ;03/28/2005
"RTN","PSAUTL6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**42**; 10/24/97
"RTN","PSAUTL6",3,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAUTL6",4,0)
 ;
"RTN","PSAUTL6",5,0)
ITEM(PSAIEN,PSAIEN1,PSALINE,ITM,FORM) ;RETURN LINE ITEM INFO with data adjusted IN .ITM array by reference
"RTN","PSAUTL6",6,0)
 ;PSAIEN - Order IEN, PSAIEN1 - Invoice IEN, PSALINE - Item IEN
"RTN","PSAUTL6",7,0)
 ; FORM="I" INTERNAL VALUE, ="" EXTERNAL VALUE
"RTN","PSAUTL6",8,0)
 ; ITM return array pass by reference  ITM(field number #)= value
"RTN","PSAUTL6",9,0)
 ; .01-Line, 1-Drug, 2-QTY, 3-OU, 4-PPOU, 5-DtProc, 6-Proc, 7-DtVer
"RTN","PSAUTL6",10,0)
 ; 8-Ver, 10-DUOU, 11-ReOrd Lev, 12-CS, 13-NDC(-), 14-VSN, 15-UPC
"RTN","PSAUTL6",11,0)
 ; 16-Syn Node, 17-Stock Lev
"RTN","PSAUTL6",12,0)
 ; code borrowed from PSAVER6 March 25,2005
"RTN","PSAUTL6",13,0)
 N PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAUTL6",14,0)
 N PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAUTL6",15,0)
 N PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X
"RTN","PSAUTL6",16,0)
 N PSA0QTY,PSASUB,IENS
"RTN","PSAUTL6",17,0)
 I '$L($G(FORM)) S FORM=""
"RTN","PSAUTL6",18,0)
 S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAUTL6",19,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)
"RTN","PSAUTL6",20,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0
"RTN","PSAUTL6",21,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAUTL6",22,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAUTL6",23,0)
 I $G(PSADJ) D
"RTN","PSAUTL6",24,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAUTL6",25,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL6",26,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAUTL6",27,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):$G(PSADJD),1:+$P(PSADATA,"^",2))
"RTN","PSAUTL6",28,0)
 .I +PSADJD,$G(PSADJD)=+$G(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAUTL6",29,0)
 .I +PSADJD,$G(PSADJD)=+$G(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAUTL6",30,0)
CS ;Q:PSASUP!('PSADRG)
"RTN","PSAUTL6",31,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAUTL6",32,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAUTL6",33,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL6",34,0)
 ;
"RTN","PSAUTL6",35,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAUTL6",36,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAUTL6",37,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAUTL6",38,0)
 ;
"RTN","PSAUTL6",39,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAUTL6",40,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAUTL6",41,0)
 ;
"RTN","PSAUTL6",42,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAUTL6",43,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL6",44,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAUTL6",45,0)
 S PSANDC=$P(PSADATA,"^",11) I FORM="" D PSANDC1^PSAHELP S PSANDC=PSANDCX K PSANDCX
"RTN","PSAUTL6",46,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAUTL6",47,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAUTL6",48,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAUTL6",49,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAUTL6",50,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAUTL6",51,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAUTL6",52,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAUTL6",53,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAUTL6",54,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAUTL6",55,0)
 ;
"RTN","PSAUTL6",56,0)
 ;DAVE B (18NOV98)
"RTN","PSAUTL6",57,0)
 ;I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAUTL6",58,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAUTL6",59,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAUTL6",60,0)
 S ITM(.01)=PSALINE,ITM(1)=PSADRG,ITM(2)=PSAQTY,ITM(3)=PSAOU,ITM(4)=PSANPOU,ITM(13)=PSANDC,ITM(10)=PSADUOU
"RTN","PSAUTL6",61,0)
 S IENS=PSALINE_","_PSAIEN1_","_PSAIEN
"RTN","PSAUTL6",62,0)
 F X=5,6,7,8,12,14,15,16,17 S ITM(X)=$$GET1^DIQ(58.81125,IENS,X,FORM)
"RTN","PSAUTL6",63,0)
 I FORM'="I" S ITM(3)=$$GET1^DIQ(51.5,ITM(3),.01) S:+ITM(1)=ITM(1) ITM(1)=$$GET1^DIQ(50,ITM(1),.01) ;also handle supply items ITM(1)=supply item name
"RTN","PSAUTL6",64,0)
 Q
"RTN","PSAVER6")
0^3^B48612927
"RTN","PSAVER6",1,0)
PSAVER6 ;BIR/JMB-Verify Invoices - CONT'D ;10/3/97
"RTN","PSAVER6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**1,3,21,42**; 10/24/97
"RTN","PSAVER6",3,0)
 ;Background Job:
"RTN","PSAVER6",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER6",5,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER6",6,0)
 ;in 58.8 after invoices have been verified.
"RTN","PSAVER6",7,0)
 ;
"RTN","PSAVER6",8,0)
START ;|=> *42 add Post Verify variance report
"RTN","PSAVER6",9,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",10,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",11,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",12,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",13,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",14,0)
 ..D SCANDIF
"RTN","PSAVER6",15,0)
 ; *42 <=|
"RTN","PSAVER6",16,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",17,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",18,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",19,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",20,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",21,0)
 ..S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER6",22,0)
 ..I +$P(PSAIN,"^",13) K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR Q
"RTN","PSAVER6",23,0)
 ..S PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSALINE=0
"RTN","PSAVER6",24,0)
 ..F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE  D
"RTN","PSAVER6",25,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER6",26,0)
 ...S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D GETDATA I 'PSASUP,'$D(PSA0QTY) D FILE ;PSA*3*42
"RTN","PSAVER6",27,0)
 ..K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR
"RTN","PSAVER6",28,0)
EXIT ;Kills variables
"RTN","PSAVER6",29,0)
 K %,DA,DD,DIC,DIE,DINUM,DLAYGO,DO,PSA,PSAA,PSABAL,PSACBAL,PSACNT,PSACNT,PSACOD,PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAVER6",30,0)
 K PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALINE,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAVER6",31,0)
 K PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,Y
"RTN","PSAVER6",32,0)
 K PSA0QTY
"RTN","PSAVER6",33,0)
 Q
"RTN","PSAVER6",34,0)
 ;
"RTN","PSAVER6",35,0)
GETDATA ;Gets invoice data to help file the data
"RTN","PSAVER6",36,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0
"RTN","PSAVER6",37,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVER6",38,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAVER6",39,0)
 I $G(PSADJ) D
"RTN","PSAVER6",40,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER6",41,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",42,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAVER6",43,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVER6",44,0)
 .I +PSADJD,$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAVER6",45,0)
 .I +PSADJD,$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVER6",46,0)
CS Q:PSASUP!('PSADRG)
"RTN","PSAVER6",47,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAVER6",48,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVER6",49,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",50,0)
 ;
"RTN","PSAVER6",51,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAVER6",52,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAVER6",53,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVER6",54,0)
 ;
"RTN","PSAVER6",55,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",56,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAVER6",57,0)
 ;
"RTN","PSAVER6",58,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVER6",59,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",60,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAVER6",61,0)
 S PSANDC=$P(PSADATA,"^",11) D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVER6",62,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVER6",63,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVER6",64,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAVER6",65,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAVER6",66,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVER6",67,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVER6",68,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER6",69,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER6",70,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAVER6",71,0)
 ;
"RTN","PSAVER6",72,0)
 ;DAVE B (18NOV98)
"RTN","PSAVER6",73,0)
 I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAVER6",74,0)
 Q:'+$P($G(^PSD(58.8,PSALOC,0)),"^",14)
"RTN","PSAVER6",75,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER6",76,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER6",77,0)
 K PSA0QTY I '$G(PSAQTY),'$G(PSADJQ) S PSA0QTY=1 Q  ;PSA*3*42 (0 QTY)
"RTN","PSAVER6",78,0)
 Q
"RTN","PSAVER6",79,0)
 ;
"RTN","PSAVER6",80,0)
FILE ;File data in 58.8
"RTN","PSAVER6",81,0)
 I $D(PSADUREC),PSADUREC'>0 S PSADUREC=$S($D(PSADJQ):PSADJQ,$D(PSAQTY):PSAQTY,1:0)
"RTN","PSAVER6",82,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVER6",83,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVER6",84,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVER6",85,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER6",86,0)
 .F  L +^PSD(58.8,PSALOC,0):0 I  Q
"RTN","PSAVER6",87,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVER6",88,0)
 .D MM ;*42 send mailmessage
"RTN","PSAVER6",89,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVER6",90,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVER6",91,0)
 ;
"RTN","PSAVER6",92,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",93,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVER6",94,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVER6",95,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVER6",96,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVER6",97,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVER6",98,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVER6",99,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVER6",100,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC
"RTN","PSAVER6",101,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAVER6",102,0)
 .S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVER6",103,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVER6",104,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVER6",105,0)
 G TR^PSAVER7
"RTN","PSAVER6",106,0)
MM ;
"RTN","PSAVER6",107,0)
 ;*42 Mail Message to holders of PSDMGR, PSAMGR key
"RTN","PSAVER6",108,0)
 N PSACS S PSACS=$S($$GET1^DIQ(50,PSADRG,63)["N":" Controlled Substance ",1:"")
"RTN","PSAVER6",109,0)
 S XMSUB=$$GET1^DIQ(50,PSADRG,.01)_" added to "_$$GET1^DIQ(58.8,PSALOC,.01)
"RTN","PSAVER6",110,0)
 N TXT S TXT(1)=XMSUB
"RTN","PSAVER6",111,0)
 S TXT(2)="by Drug Accountability on "_$$FMTE^XLFDT(PSADT,"D")
"RTN","PSAVER6",112,0)
 S TXT(3)="Order: "_$G(PSAORD)_" Invoice: "_$G(PSAINV)_PSACS
"RTN","PSAVER6",113,0)
 S TXT(4)="Please complete the drug's setup with CS or DA menus."
"RTN","PSAVER6",114,0)
 M XMY=^XUSEC("PSDMGR") M XMY=^XUSEC("PSAMGR") K XMY(.5)
"RTN","PSAVER6",115,0)
 S XMTEXT="TXT("
"RTN","PSAVER6",116,0)
 D ^XMD
"RTN","PSAVER6",117,0)
 Q
"RTN","PSAVER6",118,0)
SCANDIF ;*42 inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAVER6",119,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAVER6",120,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAVER6",121,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK^PSAPROC7 ;checks and stores differences in ^TMP($J,
"RTN","PSAVER6",122,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAVER6",123,0)
 Q
"RTN","PSAVER6",124,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAVER6",125,0)
 K DIR N IENS
"RTN","PSAVER6",126,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAVER6",127,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAVER6",128,0)
 S XMSUB="POST Verify "_PSAORD_" : "_PSAINV_" Variance Report"
"RTN","PSAVER6",129,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAVER6",130,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",131,0)
 S XMDUZ="Price & NDC Updater"
"RTN","PSAVER6",132,0)
 D ^XMD
"RTN","PSAVER6",133,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAVER6",134,0)
 Q
"RTN","PSAVER7")
0^5^B16426253
"RTN","PSAVER7",1,0)
PSAVER7 ;BIR/JMB-Verify Invoices - CONT'D ;7/23/97
"RTN","PSAVER7",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**12,21,42**; 10/24/97
"RTN","PSAVER7",3,0)
 ;Background Job
"RTN","PSAVER7",4,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER7",5,0)
 ;in 58.8 after invoices have been verified. This routine is called
"RTN","PSAVER7",6,0)
 ;by PSAVER6.
"RTN","PSAVER7",7,0)
 ;
"RTN","PSAVER7",8,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER7",9,0)
TR ;File transaction data in 58.81
"RTN","PSAVER7",10,0)
 F  L +^PSD(58.81,0):0 I  Q
"RTN","PSAVER7",11,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAVER7",12,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAVER7",13,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////1;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSADUREC;6////^S X=PSAVDUZ;9////^S X=PSABAL;71////^S X=PSAINV;106////^S X=PSAORD"
"RTN","PSAVER7",14,0)
 I $G(PSACS) S DR=DR_";100////^S X=PSACS"
"RTN","PSAVER7",15,0)
 F  L +^PSD(58.81,DA,0):0 I  Q
"RTN","PSAVER7",16,0)
 D ^DIE L -^PSD(58.81,DA,0) K DIE
"RTN","PSAVER7",17,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,4,0)) DIC("P")=$P(^DD(58.8001,19,0),"^",2)
"RTN","PSAVER7",18,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,(X,DINUM)=PSAT,DIC="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER7",19,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVER7",20,0)
 D ^DIC L -^PSD(58.8,PSALOC,1,PSADRG,0) K DIC,DINUM,DLAYGO
"RTN","PSAVER7",21,0)
 ;
"RTN","PSAVER7",22,0)
50 S PSAODASH=$P($G(^PSDRUG(PSADRG,2)),"^",4)
"RTN","PSAVER7",23,0)
 S PSAONDC=$P(PSAODASH,"-")_$P(PSAODASH,"-",2)_$P(PSAODASH,"-",3)
"RTN","PSAVER7",24,0)
 ;(PSA*3*21) NDC & PRICING UPDATES (DAVE BLOCKER 10NOV99)
"RTN","PSAVER7",25,0)
 S PSADUOU=$S($G(PSADUOU)'>0:1,1:PSADUOU)
"RTN","PSAVER7",26,0)
 S PSADUREC=(PSAQTY*PSADUOU)
"RTN","PSAVER7",27,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="50////^S X="_(PSADUREC+$G(^PSDRUG(PSADRG,660.1)))
"RTN","PSAVER7",28,0)
 F  L +^PSDRUG(DA,0):0 I  Q
"RTN","PSAVER7",29,0)
 D ^DIE L -^PSDRUG(DA,0) K DIE,DA,DR
"RTN","PSAVER7",30,0)
 ;This section replaces most of the routine
"RTN","PSAVER7",31,0)
 ;PSAOU = order unit from invoice
"RTN","PSAVER7",32,0)
 ;PSAPOU & PSANPOU = Price of Order Unit from invoice
"RTN","PSAVER7",33,0)
 ;PSADUOU=Dispense Units per OU form invoice data
"RTN","PSAVER7",34,0)
 ;PSANPDU= Price of Dispense Units per Order Unit
"RTN","PSAVER7",35,0)
 ;
"RTN","PSAVER7",36,0)
 ;Drug file Information
"RTN","PSAVER7",37,0)
 K DRUG
"RTN","PSAVER7",38,0)
 S PSANODE=$G(^PSDRUG(PSADRG,660))
"RTN","PSAVER7",39,0)
 F X=2,3,5,6 S DRUG(X)=$P($G(PSANODE),"^",X)
"RTN","PSAVER7",40,0)
 ;
"RTN","PSAVER7",41,0)
 S PSANPDU=$J(($G(PSAPOU)/$G(PSADUOU)),0,3) ;Price of Order Unit divide by Disp. Units per Order Unit
"RTN","PSAVER7",42,0)
 ;PSA*3*42 |>  (let changes happen and file, put changes into mail message)
"RTN","PSAVER7",43,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="12///^S X=PSAOU;15///^S X=PSADUOU;Q;13///^S X=PSAPOU" ;*42
"RTN","PSAVER7",44,0)
 F  L +^PSDRUG(DA,0):0 I  Q
"RTN","PSAVER7",45,0)
 D ^DIE,SYNONYM K DIE,DA,DR
"RTN","PSAVER7",46,0)
 ; <| PSA*42
"RTN","PSAVER7",47,0)
PTCH21 ;PSA*3*21 (Vendor's VSN changing to 8 digits, check also)
"RTN","PSAVER7",48,0)
 ;If NDC or VSN changes should it create to synonym entry ?
"RTN","PSAVER7",49,0)
 I $G(^PSDRUG(PSADRG,1,PSASUB,0))="" G NDC
"RTN","PSAVER7",50,0)
 I $G(^PSDRUG(PSADRG,1,PSASUB,0)) S PSAEDTT=0,DATA=^PSDRUG(PSADRG,1,PSASUB,0) D
"RTN","PSAVER7",51,0)
 .I PSAVSN'=$P(DATA,"^",4) S PSAEDTT=1 ;VSN
"RTN","PSAVER7",52,0)
 .I PSAPOU'=$P(DATA,"^",6) S PSAEDTT=1 ;Price per order unit
"RTN","PSAVER7",53,0)
 .I PSADUOU'=$P(DATA,"^",7) S PSAEDTT=1 ;Dispense Units per Order Unit
"RTN","PSAVER7",54,0)
 .I PSANPDU'=$P(DATA,"^",8) S PSAEDTT=1 ;New Price per dispense unit
"RTN","PSAVER7",55,0)
 .I $G(PSAEDTT)>0 D
"RTN","PSAVER7",56,0)
 ..S DA=PSASUB,DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAVER7",57,0)
 ..S DR="2////^S X=PSADASH"_$S(PSACS:";1////C",1:";1////D")_";400////^S X=PSAVSN;401////^S X=PSAOU"_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_";404///^S X=PSANPDU"_";405///^S X=PSAVEND"
"RTN","PSAVER7",58,0)
 ..D ^DIE K DIE,DR,DA
"RTN","PSAVER7",59,0)
NDC ;NDC UPDATE
"RTN","PSAVER7",60,0)
 I PSANDC'="",PSANDC'=PSAONDC D  ;*42
"RTN","PSAVER7",61,0)
 .S DIE="^PSDRUG(",DA=PSADRG,DR="31////^S X=PSADASH"
"RTN","PSAVER7",62,0)
 .F  L +^PSDRUG(DA,0):0 I  Q
"RTN","PSAVER7",63,0)
 .D ^DIE L -^PSDRUG(DA,0) K DIE,DA
"RTN","PSAVER7",64,0)
SYNONYM ;Adds/edits the SYNONYM multiple in DRUG file
"RTN","PSAVER7",65,0)
 Q:PSANDC=""  K DA,DR S DA(1)=PSADRG
"RTN","PSAVER7",66,0)
 ;
"RTN","PSAVER7",67,0)
 S:'$D(^PSDRUG(PSADRG,1,0)) DIC("P")="50.1A"
"RTN","PSAVER7",68,0)
 I 'PSASUB!(PSASUB&('$D(^PSDRUG(PSADRG,1,PSASUB,0)))) D
"RTN","PSAVER7",69,0)
 .S DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="Z",X=PSANDC,DLAYGO=50
"RTN","PSAVER7",70,0)
 .F  L +^PSDRUG(PSADRG,0):0 I  Q
"RTN","PSAVER7",71,0)
 .D FILE^DICN L -^PSDRUG(PSADRG,0) K DIC,DLAYGO S PSASUB=+Y
"RTN","PSAVER7",72,0)
 I PSASUB,$D(^PSDRUG(PSADRG,1,PSASUB,0)) S DA=PSASUB
"RTN","PSAVER7",73,0)
 S DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAVER7",74,0)
 S DR="2////^S X=PSADASH"_$S($G(PSACS)>0:";1////C",1:";1////D")_";400////^S X=PSAVSN;401////^S X=PSAOU"_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_";404///^S X=PSANPDU;405///^S X=PSAVEND"
"RTN","PSAVER7",75,0)
 F  L +^PSDRUG(PSADRG,0):0 I  Q
"RTN","PSAVER7",76,0)
 D ^DIE L -^PSDRUG(PSADRG,0)
"RTN","PSAVER7",77,0)
 K DIE,DR,X1,X2,DATA
"RTN","PSAVER7",78,0)
 Q
"RTN","PSAVERA3")
0^6^B8881546
"RTN","PSAVERA3",1,0)
PSAVERA3 ;BHM/DB - RECORD TRANSACTION & UPDATE DRUG FILE;31JAN00
"RTN","PSAVERA3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,42**; 10/24/97
"RTN","PSAVERA3",3,0)
 ;
"RTN","PSAVERA3",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVERA3",5,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVERA3",6,0)
 ;
"RTN","PSAVERA3",7,0)
OU S DIC(0)="QAEMZ",DIC="^DIC(51.5,",DIC("A")="Select New Order Unit: "
"RTN","PSAVERA3",8,0)
 D ^DIC G Q:+Y'>0 S PSAOU=+Y
"RTN","PSAVERA3",9,0)
 I $G(PSAOU)=$G(PSAAOU) W !,"No change." G Q
"RTN","PSAVERA3",10,0)
 S DIR("B")=$S($P($G(^PSDRUG(PSADRG,660)),"^",5)'="":$P($G(^PSDRUG(PSADRG,660)),"^",5),1:"Blank")
"RTN","PSAVERA3",11,0)
 S DIR(0)="NO^::2",DIR("A")="DISPENSE UNITS PER ORDER UNIT"
"RTN","PSAVERA3",12,0)
 S DIR("?")="Enter the number of dispense units contained in one order unit",DIR("??")="^D DUOUHELP^PSAPROC3"
"RTN","PSAVERA3",13,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 G Q
"RTN","PSAVERA3",14,0)
 S PSANDUOU=+Y
"RTN","PSAVERA3",15,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^")=+Y S:+Y PSASET=1
"RTN","PSAVERA3",16,0)
 ;
"RTN","PSAVERA3",17,0)
DRG K PSASUB S X1=0 F  S X1=$O(^PSDRUG(PSADRG,1,X1)) Q:X1'>0  S DATA=$G(^PSDRUG(PSADRG,1,X1,0)) I $P(DATA,"^",1)=PSANDC S PSASUB=X1
"RTN","PSAVERA3",18,0)
 W !,"Old Dispense Units Per Order Unit: "_$P($G(^PSDRUG(PSADRG,660)),"^",5),?45,"Price Per Disp. Unit: "_$J($P($G(^PSDRUG(PSADRG,660)),"^",6),8,2)
"RTN","PSAVERA3",19,0)
 W !,"New Dispense Units Per Order Unit: "_PSANDUOU
"RTN","PSAVERA3",20,0)
 I PSANDUOU=$P($G(^PSDRUG(PSADRG,660)),"^",5) W ?45," unchanged " G UPDATE
"RTN","PSAVERA3",21,0)
 W ?64,$J((PSAPRICE/PSANDUOU),8,2)
"RTN","PSAVERA3",22,0)
UPDATE ;update file
"RTN","PSAVERA3",23,0)
 I $G(PSANDC)'="",$L(PSANDC)'=11 D
"RTN","PSAVERA3",24,0)
 .I $G(PSANDC)'="" S X=11,X1=$L(PSANDC) F X=1:1:(11-X1) S PSANDC="0"_PSANDC ;*42 11 digit NDC
"RTN","PSAVERA3",25,0)
 .S NDC0=1 F X=1:1:$L(PSANDC) I $E(PSANDC,X)'=0&($E(PSANDC,X)'="-") K NDC0
"RTN","PSAVERA3",26,0)
 .I $G(NDC0)=1 S PSANDC=""
"RTN","PSAVERA3",27,0)
 D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVERA3",28,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",4)'=$G(PSADASH) S DIE="^PSDRUG(",DA=PSADRG,DR="31////^S X=PSADASH" D ^DIE
"RTN","PSAVERA3",29,0)
 S PSANPDU=PSAPRICE/PSANDUOU
"RTN","PSAVERA3",30,0)
 W !,"Updating Drug File's Synonym data"
"RTN","PSAVERA3",31,0)
 I $G(PSASUB)=""!('$D(^PSDRUG(PSADRG,1))) S DA(1)=PSADRG,DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="L",X=PSANDC,DLAYGO=50 D ^DIC S PSASUB=+Y
"RTN","PSAVERA3",32,0)
 S DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,",DA=PSASUB,DR="401////^S X=PSAOU;403////^S X=PSANDUOU;404////^S X=PSANPDU" D ^DIE
"RTN","PSAVERA3",33,0)
 W !,"Updating Drug File's Dispense Units Per Order Unit & Price Per Dispense Unit"
"RTN","PSAVERA3",34,0)
 K DR,DIE
"RTN","PSAVERA3",35,0)
 S DIE="^PSDRUG("_DA(1),DR="12///^S X=PSAOU;13////^S X=PSAPRICE;Q;15////^S X=PSANDUOU" D ^DIE
"RTN","PSAVERA3",36,0)
 S PSADJFLD="O",PSADJ=PSAOU,PSAREA="" D RECORD^PSAVER2
"RTN","PSAVERA3",37,0)
 W !,"making adjustment in DRUG ACCOUNTABILITY ORDER file"
"RTN","PSAVERA3",38,0)
 W !,"TAKING A BREAK !?"
"RTN","PSAVERA3",39,0)
 Q
"RTN","PSAVERA3",40,0)
Q Q
"VER")
8.0^22.0
"BLD",5834,6)
^SEQ #37
**END**
**END**
