KIDS Distribution saved on Jun 28, 2006@16:56:50
SD*5.3*478,GMRC*3*52,PX*1*176
**KIDS**:SD*5.3*478^GMRC*3.0*52^PX*1.0*176^

**INSTALL NAME**
SD*5.3*478
"BLD",5958,0)
SD*5.3*478^SCHEDULING^0^3060628^y
"BLD",5958,1,0)
^^1^1^3060313^
"BLD",5958,1,1,0)
Links appointment to consult/procedure.
"BLD",5958,4,0)
^9.64PA^44^1
"BLD",5958,4,44,0)
44
"BLD",5958,4,44,2,0)
^9.641^44.003^1
"BLD",5958,4,44,2,44.003,0)
PATIENT  (sub-file)
"BLD",5958,4,44,2,44.003,1,0)
^9.6411^688^1
"BLD",5958,4,44,2,44.003,1,688,0)
CONSULT LINK
"BLD",5958,4,44,222)
y^n^p^^^^n^^n
"BLD",5958,4,44,224)

"BLD",5958,4,"APDD",44,44.003)

"BLD",5958,4,"APDD",44,44.003,688)

"BLD",5958,4,"B",44,44)

"BLD",5958,"ABPKG")
n
"BLD",5958,"INI")

"BLD",5958,"INIT")

"BLD",5958,"KRN",0)
^9.67PA^8989.52^19
"BLD",5958,"KRN",.4,0)
.4
"BLD",5958,"KRN",.401,0)
.401
"BLD",5958,"KRN",.402,0)
.402
"BLD",5958,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",5958,"KRN",.402,"NM",1,0)
SD ASSOCIATED STOP    FILE #123.5^123.5^0
"BLD",5958,"KRN",.402,"NM","B","SD ASSOCIATED STOP    FILE #123.5",1)

"BLD",5958,"KRN",.403,0)
.403
"BLD",5958,"KRN",.5,0)
.5
"BLD",5958,"KRN",.84,0)
.84
"BLD",5958,"KRN",3.6,0)
3.6
"BLD",5958,"KRN",3.8,0)
3.8
"BLD",5958,"KRN",9.2,0)
9.2
"BLD",5958,"KRN",9.8,0)
9.8
"BLD",5958,"KRN",9.8,"NM",0)
^9.68A^26^24
"BLD",5958,"KRN",9.8,"NM",1,0)
SDAM1^^0^B27486316
"BLD",5958,"KRN",9.8,"NM",2,0)
SDAM10^^0^B8130933
"BLD",5958,"KRN",9.8,"NM",3,0)
SDAM2^^0^B30409826
"BLD",5958,"KRN",9.8,"NM",4,0)
SDAM3^^0^B9638005
"BLD",5958,"KRN",9.8,"NM",5,0)
SDAMC^^0^B12821748
"BLD",5958,"KRN",9.8,"NM",6,0)
SDAUT2^^0^B31407723
"BLD",5958,"KRN",9.8,"NM",7,0)
SDC^^0^B24772235
"BLD",5958,"KRN",9.8,"NM",8,0)
SDC1^^0^B5430963
"BLD",5958,"KRN",9.8,"NM",9,0)
SDCNP^^0^B16969835
"BLD",5958,"KRN",9.8,"NM",10,0)
SDCNP0^^0^B29432577
"BLD",5958,"KRN",9.8,"NM",11,0)
SDCNP1^^0^B31981215
"BLD",5958,"KRN",9.8,"NM",12,0)
SDCNP1A^^0^B28182331
"BLD",5958,"KRN",9.8,"NM",13,0)
SDCNSLT^^0^B40454930
"BLD",5958,"KRN",9.8,"NM",16,0)
SDM^^0^B33726440
"BLD",5958,"KRN",9.8,"NM",17,0)
SDM1^^0^B34209967
"BLD",5958,"KRN",9.8,"NM",18,0)
SDM1A^^0^B42131509
"BLD",5958,"KRN",9.8,"NM",19,0)
SDM2^^0^B24545266
"BLD",5958,"KRN",9.8,"NM",20,0)
SDMULT^^0^B10325943
"BLD",5958,"KRN",9.8,"NM",21,0)
SDN^^0^B30846315
"BLD",5958,"KRN",9.8,"NM",22,0)
SDPURG1^^0^B11203537
"BLD",5958,"KRN",9.8,"NM",23,0)
SDQQCN2^^0^B2209146
"BLD",5958,"KRN",9.8,"NM",24,0)
SD53P478^^0^B748840
"BLD",5958,"KRN",9.8,"NM",25,0)
SDC0^^0^B26494152
"BLD",5958,"KRN",9.8,"NM",26,0)
SDAMN^^0^B7272637
"BLD",5958,"KRN",9.8,"NM","B","SD53P478",24)

"BLD",5958,"KRN",9.8,"NM","B","SDAM1",1)

"BLD",5958,"KRN",9.8,"NM","B","SDAM10",2)

"BLD",5958,"KRN",9.8,"NM","B","SDAM2",3)

"BLD",5958,"KRN",9.8,"NM","B","SDAM3",4)

"BLD",5958,"KRN",9.8,"NM","B","SDAMC",5)

"BLD",5958,"KRN",9.8,"NM","B","SDAMN",26)

"BLD",5958,"KRN",9.8,"NM","B","SDAUT2",6)

"BLD",5958,"KRN",9.8,"NM","B","SDC",7)

"BLD",5958,"KRN",9.8,"NM","B","SDC0",25)

"BLD",5958,"KRN",9.8,"NM","B","SDC1",8)

"BLD",5958,"KRN",9.8,"NM","B","SDCNP",9)

"BLD",5958,"KRN",9.8,"NM","B","SDCNP0",10)

"BLD",5958,"KRN",9.8,"NM","B","SDCNP1",11)

"BLD",5958,"KRN",9.8,"NM","B","SDCNP1A",12)

"BLD",5958,"KRN",9.8,"NM","B","SDCNSLT",13)

"BLD",5958,"KRN",9.8,"NM","B","SDM",16)

"BLD",5958,"KRN",9.8,"NM","B","SDM1",17)

"BLD",5958,"KRN",9.8,"NM","B","SDM1A",18)

"BLD",5958,"KRN",9.8,"NM","B","SDM2",19)

"BLD",5958,"KRN",9.8,"NM","B","SDMULT",20)

"BLD",5958,"KRN",9.8,"NM","B","SDN",21)

"BLD",5958,"KRN",9.8,"NM","B","SDPURG1",22)

"BLD",5958,"KRN",9.8,"NM","B","SDQQCN2",23)

"BLD",5958,"KRN",19,0)
19
"BLD",5958,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",5958,"KRN",19,"NM",1,0)
SD ASSOCIATED STOP CODE^^0
"BLD",5958,"KRN",19,"NM","B","SD ASSOCIATED STOP CODE",1)

"BLD",5958,"KRN",19.1,0)
19.1
"BLD",5958,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",5958,"KRN",101,0)
101
"BLD",5958,"KRN",409.61,0)
409.61
"BLD",5958,"KRN",409.61,"NM",0)
^9.68A^2^1
"BLD",5958,"KRN",409.61,"NM",2,0)
SDAM APPT MGT^^0
"BLD",5958,"KRN",409.61,"NM","B","SDAM APPT MGT",2)

"BLD",5958,"KRN",771,0)
771
"BLD",5958,"KRN",870,0)
870
"BLD",5958,"KRN",8989.51,0)
8989.51
"BLD",5958,"KRN",8989.52,0)
8989.52
"BLD",5958,"KRN",8994,0)
8994
"BLD",5958,"KRN","B",.4,.4)

"BLD",5958,"KRN","B",.401,.401)

"BLD",5958,"KRN","B",.402,.402)

"BLD",5958,"KRN","B",.403,.403)

"BLD",5958,"KRN","B",.5,.5)

"BLD",5958,"KRN","B",.84,.84)

"BLD",5958,"KRN","B",3.6,3.6)

"BLD",5958,"KRN","B",3.8,3.8)

"BLD",5958,"KRN","B",9.2,9.2)

"BLD",5958,"KRN","B",9.8,9.8)

"BLD",5958,"KRN","B",19,19)

"BLD",5958,"KRN","B",19.1,19.1)

"BLD",5958,"KRN","B",101,101)

"BLD",5958,"KRN","B",409.61,409.61)

"BLD",5958,"KRN","B",771,771)

"BLD",5958,"KRN","B",870,870)

"BLD",5958,"KRN","B",8989.51,8989.51)

"BLD",5958,"KRN","B",8989.52,8989.52)

"BLD",5958,"KRN","B",8994,8994)

"BLD",5958,"PRE")
SD53P478
"BLD",5958,"QUES",0)
^9.62^^
"BLD",5958,"REQB",0)
^9.611^13^11
"BLD",5958,"REQB",1,0)
SD*5.3*379^2
"BLD",5958,"REQB",2,0)
SD*5.3*356^2
"BLD",5958,"REQB",3,0)
SD*5.3*408^2
"BLD",5958,"REQB",4,0)
SD*5.3*403^2
"BLD",5958,"REQB",6,0)
SD*5.3*414^2
"BLD",5958,"REQB",7,0)
SD*5.3*380^2
"BLD",5958,"REQB",8,0)
SD*5.3*424^2
"BLD",5958,"REQB",10,0)
SD*5.3*439^2
"BLD",5958,"REQB",11,0)
SD*5.3*444^2
"BLD",5958,"REQB",12,0)
SD*5.3*445^2
"BLD",5958,"REQB",13,0)
SD*5.3*467^2
"BLD",5958,"REQB","B","SD*5.3*356",2)

"BLD",5958,"REQB","B","SD*5.3*379",1)

"BLD",5958,"REQB","B","SD*5.3*380",7)

"BLD",5958,"REQB","B","SD*5.3*403",4)

"BLD",5958,"REQB","B","SD*5.3*408",3)

"BLD",5958,"REQB","B","SD*5.3*414",6)

"BLD",5958,"REQB","B","SD*5.3*424",8)

"BLD",5958,"REQB","B","SD*5.3*439",10)

"BLD",5958,"REQB","B","SD*5.3*444",11)

"BLD",5958,"REQB","B","SD*5.3*445",12)

"BLD",5958,"REQB","B","SD*5.3*467",13)

"FIA",44)
HOSPITAL LOCATION
"FIA",44,0)
^SC(
"FIA",44,0,0)
44I
"FIA",44,0,1)
y^n^p^^^^n^^n
"FIA",44,0,10)

"FIA",44,0,11)

"FIA",44,0,"RLRO")

"FIA",44,0,"VR")
5.3^SD
"FIA",44,44)
1
"FIA",44,44.003)
1
"FIA",44,44.003,688)

"KRN",.402,2612,-1)
0^1
"KRN",.402,2612,0)
SD ASSOCIATED STOP^3060324.1355^^123.5^^^3060425
"KRN",.402,2612,"DIAB",1,1,123.5688,0)
ALL
"KRN",.402,2612,"DR",1,123.5)
688;
"KRN",.402,2612,"DR",2,123.5688)
.01
"KRN",19,12532,-1)
0^1
"KRN",19,12532,0)
SD ASSOCIATED STOP CODE^CONSULT ASSOCIATED STOP CODE^^E^^^^^^^^
"KRN",19,12532,1,0)
^19.06^1^1^3050601^^
"KRN",19,12532,1,1,0)
This option assigns associated stop code to a consult request.
"KRN",19,12532,30)
GMR(123.5,
"KRN",19,12532,31)
AEMQ
"KRN",19,12532,50)
GMR(123.5,
"KRN",19,12532,51)
[SD ASSOCIATED STOP]
"KRN",19,12532,99.1)
59963,30031
"KRN",19,12532,"U")
CONSULT ASSOCIATED STOP CODE
"KRN",409.61,19,-1)
0^2
"KRN",409.61,19,0)
SDAM APPT MGT^1^1^80^6^12^1^1^Appointment^SDAM MENU^Appt Mgt Module^1^999
"KRN",409.61,19,.35)
3000712
"KRN",409.61,19,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,19,"ARRAY")
 ^TMP("SDAM",$J)
"KRN",409.61,19,"COL",0)
^409.621^6^6
"KRN",409.61,19,"COL",1,0)
NAME^6^25^Patient or Clinic
"KRN",409.61,19,"COL",2,0)
DATE^32^16^Appt Date/Time
"KRN",409.61,19,"COL",3,0)
STAT^54^21^Status
"KRN",409.61,19,"COL",4,0)
APPT#^2^3
"KRN",409.61,19,"COL",5,0)
TIME^76^5
"KRN",409.61,19,"COL",6,0)
CONSULT^49^4
"KRN",409.61,19,"COL","B","APPT#",4)

"KRN",409.61,19,"COL","B","CONSULT",6)

"KRN",409.61,19,"COL","B","DATE",2)

"KRN",409.61,19,"COL","B","NAME",1)

"KRN",409.61,19,"COL","B","STAT",3)

"KRN",409.61,19,"COL","B","TIME",5)

"KRN",409.61,19,"EXP")
D EN^SDAMEP
"KRN",409.61,19,"FNL")
D FNL^SDAM
"KRN",409.61,19,"HDR")
D HDR^SDAM
"KRN",409.61,19,"HLP")
D HLP^SDAM5
"KRN",409.61,19,"INIT")
D INIT^SDAM
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
478^3060628^123456810
"PKG",16,22,1,"PAH",1,1,0)
^^1^1^3060628
"PKG",16,22,1,"PAH",1,1,1,0)
Links appointment to consult/procedure.
"PRE")
SD53P478
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
24
"RTN","SD53P478")
0^24^B748840
"RTN","SD53P478",1,0)
SD53P478 ;ALB/MRY - POST INIT ;3/14/06
"RTN","SD53P478",2,0)
 ;;5.3;Scheduling;**478**;Aug 13, 1993
"RTN","SD53P478",3,0)
 ;
"RTN","SD53P478",4,0)
EN ;
"RTN","SD53P478",5,0)
 S XPDABORT=""
"RTN","SD53P478",6,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^") D  G ABRT
"RTN","SD53P478",7,0)
 . D BMES^XPDUTL("*****")
"RTN","SD53P478",8,0)
 . D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","SD53P478",9,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","SD53P478",10,0)
 W !!,">> Environment check complete and okay."
"RTN","SD53P478",11,0)
 I XPDABORT="" K XPDABORT
"RTN","SD53P478",12,0)
 Q
"RTN","SD53P478",13,0)
 ;
"RTN","SD53P478",14,0)
ABRT ; Abort transport, but leave in ^XTMP.
"RTN","SD53P478",15,0)
 S XPDABORT=2 Q
"RTN","SDAM1")
0^1^B27486316
"RTN","SDAM1",1,0)
SDAM1 ;MJK/ALB - Appt Mgt (Patient);Apr 23 1999 ; 8/31/05 3:29pm
"RTN","SDAM1",2,0)
 ;;5.3;Scheduling;**149,155,193,189,445,478**;Aug 13, 1993
"RTN","SDAM1",3,0)
 ;
"RTN","SDAM1",4,0)
INIT ; -- get init pat appt data
"RTN","SDAM1",5,0)
 ;  input:          DFN := ifn of pat
"RTN","SDAM1",6,0)
 ; output:  ^TMP("SDAM" := appt array
"RTN","SDAM1",7,0)
 S X=$P($G(^DG(43,1,"SCLR")),U,12),SDPRD=$S(X:X,1:2)
"RTN","SDAM1",8,0)
 S X1=DT,X2=-SDPRD D C^%DTC S SDBEG=X
"RTN","SDAM1",9,0)
 S X1=DT,X2=999 D C^%DTC S SDEND=X
"RTN","SDAM1",10,0)
 D CHGCAP^VALM("NAME","Clinic")
"RTN","SDAM1",11,0)
 S X="ALL" D LIST^SDAM
"RTN","SDAM1",12,0)
 Q
"RTN","SDAM1",13,0)
 ;
"RTN","SDAM1",14,0)
BLD ; -- scan apts
"RTN","SDAM1",15,0)
 N SDAMDD,SDNAME,SDMAX,SDLARGE,DFN,SDCL,BL,XC,XW,AC,AW,TC,TW,NC,NW,SC,SW,SDT,CC,CW,CN,CNPAT,CNSTLNK,CSTAT ; done for speed see INIT
"RTN","SDAM1",16,0)
 D INIT^SDAM10
"RTN","SDAM1",17,0)
 S DFN=SDFN
"RTN","SDAM1",18,0)
 F SDT=SDBEG:0 S SDT=$O(^DPT(DFN,"S",SDT)) Q:'SDT!($P(SDT,".",1)>SDEND)  I $D(^(SDT,0)) S SDATA=^(0),SDCL=+SDATA,SDNAME=$P($G(^SC(SDCL,0)),U) D  K:CNSTLNK="" CNSTLNK D BLD1  ;SD/478
"RTN","SDAM1",19,0)
 .S CNSTLNK="",CN=0 F  S CN=$O(^SC(SDCL,"S",SDT,1,CN)) Q:'+CN  S CNPAT=$P($G(^SC(SDCL,"S",SDT,1,CN,0)),U) I CNPAT=DFN S CNSTLNK=$P($G(^SC(SDCL,"S",SDT,1,CN,"CONS")),U),CSTAT="" S:CNSTLNK'="" CSTAT=$P($G(^GMR(123,CNSTLNK,0)),U,12) Q  ;SD/478
"RTN","SDAM1",20,0)
 D NUL^SDAM10,LARGE^SDAM10:$D(SDLARGE)
"RTN","SDAM1",21,0)
 S $P(^TMP("SDAM",$J,0),U,4)=VALMCNT
"RTN","SDAM1",22,0)
 Q
"RTN","SDAM1",23,0)
 ;
"RTN","SDAM1",24,0)
BLD1 ; -- build array
"RTN","SDAM1",25,0)
 N SDX,X,Y,Y1,SDSTAT,SDELIG
"RTN","SDAM1",26,0)
 S SDSTAT=$$STATUS(DFN,SDT,SDCL,SDATA,$S($D(SDDA):SDDA,1:""))
"RTN","SDAM1",27,0)
 G BLD1Q:'$$CHK(DFN,SDT,SDCL,SDATA,.SDAMLIST,SDSTAT)
"RTN","SDAM1",28,0)
 ;; Changes for GAF enhancement
"RTN","SDAM1",29,0)
 S SDGAFREQ=" "
"RTN","SDAM1",30,0)
 S SDELIG=$$ELSTAT^SDUTL2(DFN)
"RTN","SDAM1",31,0)
 I $$MHCLIN^SDUTL2(SDCL),'($$COLLAT^SDUTL2(SDELIG)!$P(SDATA,U,11)) D
"RTN","SDAM1",32,0)
 .S SDGAF=$$NEWGAF^SDUTL2(DFN),SDGAFST=$P(SDGAF,"^")
"RTN","SDAM1",33,0)
 .S:SDGAFST SDGAFREQ="*"
"RTN","SDAM1",34,0)
 S SDACNT=SDACNT+1,X="",$P(X," ",VALMWD+1)=""
"RTN","SDAM1",35,0)
 W:(SDACNT#10)=0 "."
"RTN","SDAM1",36,0)
 I SDACNT=SDMAX,$P(SDT,".")'=SDEND S SDEND=$P(SDT,"."),SDLARGE=""
"RTN","SDAM1",37,0)
 S X=SDGAFREQ_$E(X,2,AC-1)_$E(SDACNT_BL,1,AW)_$E(X,AC+AW+1,VALMWD)
"RTN","SDAM1",38,0)
 S X=$E(X,1,NC-1)_$E($$LOWER(SDNAME)_BL,1,NW)_$E(X,NC+NW+1,VALMWD)
"RTN","SDAM1",39,0)
 S X=$E(X,1,XC-1)_$E($$FMTE^XLFDT(SDT,"5Z")_BL,1,XW)_$E(X,XC+XW+1,VALMWD)  ;to make date field work for SD*5.3*189 - uses FM List Template
"RTN","SDAM1",40,0)
 S:'$D(CSTAT) CSTAT="" ;SD/478
"RTN","SDAM1",41,0)
 S X=$E(X,1,CC-1)_$E($S((CSTAT=1!(CSTAT=2)!(CSTAT=13)):" ",$G(CNSTLNK):"Consult",1:"        ")_BL,1,CW)_$E(X,CC+CW+1,VALMWD) K CNSTLNK,CSTAT ;SD/478
"RTN","SDAM1",42,0)
 S Y=$P(SDSTAT,";",3)
"RTN","SDAM1",43,0)
 I Y'["FUTURE" S X=$E(X,1,SC-1)_$E($$LOWER(Y)_BL,1,SW)_$E(X,SC+SW+1,VALMWD)
"RTN","SDAM1",44,0)
 I Y["FUTURE" S X=$E(X,1,SC-1)_$E($$LOWER(Y)_$$ANC_BL,1,SW+TW+1)
"RTN","SDAM1",45,0)
 S Y1=$S($P(SDSTAT,";",5):$P(SDSTAT,";",5),1:$P(SDSTAT,";",4)),Y1=$S($P(Y1,".")=DT:$$TIME($P(Y1,".",2)),1:"")
"RTN","SDAM1",46,0)
 S:Y1]"" X=$E(X,1,TC-1)_$E(Y1_BL,1,TW)_$E(X,TC+TW+1,VALMWD)
"RTN","SDAM1",47,0)
 D SET(X)
"RTN","SDAM1",48,0)
 I $D(SDAMBOLD(DFN,SDT,SDCL)) D FLDCTRL^VALM10(VALMCNT,"STAT",IOINHI,IOINORM),FLDCTRL^VALM10(VALMCNT,"TIME",IOINHI,IOINORM)
"RTN","SDAM1",49,0)
 S ^TMP("SDAMIDX",$J,SDACNT)=VALMCNT_U_DFN_U_SDT_U_SDCL_U_$S($D(SDDA):SDDA,1:"")
"RTN","SDAM1",50,0)
BLD1Q Q
"RTN","SDAM1",51,0)
 ;
"RTN","SDAM1",52,0)
ANC() ; -- set ancillary info
"RTN","SDAM1",53,0)
 N I,Y,C
"RTN","SDAM1",54,0)
 S Y="",C=0
"RTN","SDAM1",55,0)
 F I=3:1:5 I $P(SDATA,U,I)]"" S Y=Y_" "_$P("^^Lab^XRay^EKG",U,I)_"@"_$$TIME($P($P(SDATA,U,I),".",2)),C=C+1 Q:C=2
"RTN","SDAM1",56,0)
 I Y]"" S Y="/"_$E(Y,2,99)
"RTN","SDAM1",57,0)
 Q Y
"RTN","SDAM1",58,0)
 ;  
"RTN","SDAM1",59,0)
SET(X) ;
"RTN","SDAM1",60,0)
 S VALMCNT=VALMCNT+1,^TMP("SDAM",$J,VALMCNT,0)=X
"RTN","SDAM1",61,0)
 S:SDACNT ^TMP("SDAM",$J,"IDX",VALMCNT,SDACNT)=""
"RTN","SDAM1",62,0)
 Q
"RTN","SDAM1",63,0)
 ;
"RTN","SDAM1",64,0)
CHK(DFN,SDT,SDCL,SDATA,SDAMLIST,SDSTAT,SDDA) ; -- does appt meet criteria
"RTN","SDAM1",65,0)
 ;   input:        DFN := ifn of pat.
"RTN","SDAM1",66,0)
 ;                 SDT := appt d/t
"RTN","SDAM1",67,0)
 ;                SDCL := ifn of clinic
"RTN","SDAM1",68,0)
 ;               SDATA := 0th node of pat appt entry
"RTN","SDAM1",69,0)
 ;            SDAMLIST := list definition
"RTN","SDAM1",70,0)
 ;              SDSTAT := appt status data from $$STATUS call
"RTN","SDAM1",71,0)
 ;                SDDA := ifn for ^SC(clinic,"S",date,1,ifn) {optional}
"RTN","SDAM1",72,0)
 ;  output: [returned] := meets criteria for list [0 - no | 1 - yes ]
"RTN","SDAM1",73,0)
 ;
"RTN","SDAM1",74,0)
 S Y=0
"RTN","SDAM1",75,0)
 I $D(SDAMLIST(+SDSTAT)) S Y=1 G CHKQ
"RTN","SDAM1",76,0)
 I $P(SDAMLIST,U)="ALL" S Y=1
"RTN","SDAM1",77,0)
 I $P(SDAMLIST,U)="CHECKED IN" I $P(SDSTAT,";",3)="ACT REQ/CHECKED IN" S Y=1  ; - SD*5.3*445
"RTN","SDAM1",78,0)
CHKQ I Y,$D(SDAMLIST("SCR")) X SDAMLIST("SCR") S Y=$T
"RTN","SDAM1",79,0)
 Q Y
"RTN","SDAM1",80,0)
 ;
"RTN","SDAM1",81,0)
STATUS(DFN,SDT,SDCL,SDATA,SDDA) ; -- return appt status
"RTN","SDAM1",82,0)
 ;   input:        DFN := ifn of pat.
"RTN","SDAM1",83,0)
 ;                 SDT := appt d/t
"RTN","SDAM1",84,0)
 ;                SDCL := ifn of clinic
"RTN","SDAM1",85,0)
 ;               SDATA := 0th node of pat appt entry
"RTN","SDAM1",86,0)
 ;                SDDA := ifn for ^SC(clinic,"S",date,1,ifn) {optional}
"RTN","SDAM1",87,0)
 ;  output: [returned] := appt status ifn ^ status name ^ print status ^
"RTN","SDAM1",88,0)
 ;                        check in d/t ^ check out d/t ^ adm mvt ifn
"RTN","SDAM1",89,0)
 ;
"RTN","SDAM1",90,0)
 ;S = status ; C = ci/co indicator ; Y = 'C' node ; P = print status
"RTN","SDAM1",91,0)
 N S,C,Y,P,VADMVT,VAINDT
"RTN","SDAM1",92,0)
 ;
"RTN","SDAM1",93,0)
 ; -- get data for evaluation
"RTN","SDAM1",94,0)
 S:'$G(SDDA) SDDA=+$$FIND^SDAM2(DFN,SDT,SDCL)
"RTN","SDAM1",95,0)
 S Y=$G(^SC(SDCL,"S",SDT,1,SDDA,"C"))
"RTN","SDAM1",96,0)
 ;
"RTN","SDAM1",97,0)
 ; -- set initial status value ; non-count clinic?
"RTN","SDAM1",98,0)
 S S=$S($P(SDATA,"^",2)]"":$P($P($P(^DD(2.98,3,0),"^",3),$P(SDATA,"^",2)_":",2),";"),$P($G(^SC(SDCL,0)),U,17)="Y":"NON-COUNT",1:"")
"RTN","SDAM1",99,0)
 ;
"RTN","SDAM1",100,0)
 ; -- inpatient?
"RTN","SDAM1",101,0)
 S VAINDT=SDT D ADM^VADPT2
"RTN","SDAM1",102,0)
 I S["INPATIENT",$S('VADMVT:1,'$P(^DG(43,1,0),U,21):0,1:$P($G(^DIC(42,+$P($G(^DGPM(VADMVT,0)),U,6),0)),U,3)="D") S S=""
"RTN","SDAM1",103,0)
 ;
"RTN","SDAM1",104,0)
 ; -- determine ci/co indicator
"RTN","SDAM1",105,0)
 S C=$S($P(Y,"^",3):"CHECKED OUT",Y:"CHECKED IN",S]"":"",SDT>(DT+.2359):"FUTURE",1:"NO ACTION TAKEN") S:S="" S=C
"RTN","SDAM1",106,0)
 I S="NO ACTION TAKEN",$P(SDT,".")=DT,C'["CHECKED" S C="TODAY"
"RTN","SDAM1",107,0)
 ; -- $$REQ & $$COCMP in SDM1A not used for speed
"RTN","SDAM1",108,0)
 I S="CHECKED OUT"!(S="CHECKED IN"),SDT'<$P(^DG(43,1,"SCLR"),U,23),'$P($G(^SCE(+$P(SDATA,U,20),0)),U,7) S S="NO ACTION TAKEN"
"RTN","SDAM1",109,0)
 ;
"RTN","SDAM1",110,0)
 ; -- determine print status
"RTN","SDAM1",111,0)
 S P=$S(S=C!(C=""):S,1:"")
"RTN","SDAM1",112,0)
 I P="" D
"RTN","SDAM1",113,0)
 .I S="NO ACTION TAKEN",C="CHECKED OUT"!(C="CHECKED IN") S P="ACT REQ/"_C Q
"RTN","SDAM1",114,0)
 .S P=$S(S="NO ACTION TAKEN":S,1:$P(S," "))_"/"_C
"RTN","SDAM1",115,0)
 ;
"RTN","SDAM1",116,0)
STATUSQ Q +$O(^SD(409.63,"AC",S,0))_";"_S_";"_P_";"_$P(Y,"^")_";"_$P(Y,"^",3)_";"_+VADMVT
"RTN","SDAM1",117,0)
 ;
"RTN","SDAM1",118,0)
 ;
"RTN","SDAM1",119,0)
LOWER(X) ; convert to lowercase ; same as LOWER^VALM1 ; here for speed
"RTN","SDAM1",120,0)
 N Y,C,I
"RTN","SDAM1",121,0)
 S Y=$E(X)_$TR($E(X,2,999),"ABCDEFGHIJKLMNOPQRSTUVWXYZ@","abcdefghijklmnopqrstuvwxyz ")
"RTN","SDAM1",122,0)
 F C=" ",",","/" S I=0 F  S I=$F(Y,C,I) Q:'I  S Y=$E(Y,1,I-1)_$TR($E(Y,I),"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")_$E(Y,I+1,999)
"RTN","SDAM1",123,0)
 Q Y
"RTN","SDAM1",124,0)
 ;
"RTN","SDAM1",125,0)
TIME(X) ; -- format time only :=   hr:min
"RTN","SDAM1",126,0)
 Q $E(X_"0000",1,2)_":"_$E(X_"0000",3,4)
"RTN","SDAM10")
0^2^B8130933
"RTN","SDAM10",1,0)
SDAM10 ;MJK/ALB - Appt Mgt (Patient cont.); 3/18/05 3:51pm
"RTN","SDAM10",2,0)
 ;;5.3;Scheduling;**189,258,403,478**;Aug 13, 1993
"RTN","SDAM10",3,0)
 ;
"RTN","SDAM10",4,0)
HDR ; -- list screen header
"RTN","SDAM10",5,0)
 ;   input:       SDFN := ifn of pat
"RTN","SDAM10",6,0)
 ;  output:  VALMHDR() := hdr array
"RTN","SDAM10",7,0)
 ;
"RTN","SDAM10",8,0)
 N VAERR,VA,X
"RTN","SDAM10",9,0)
 S DFN=SDFN D PID^VADPT
"RTN","SDAM10",10,0)
 S VALMHDR(1)=$E($P("Patient: "_$G(^DPT(SDFN,0)),U),1,46)_" ("_VA("BID")_")"  ;for proper display of patient name for SD*5.3*189
"RTN","SDAM10",11,0)
 S X=$P($$FMT^SDUTL2(SDFN),U,2),X=$S(X["GMT":X,X]"":"MT: "_X,1:"")
"RTN","SDAM10",12,0)
 S VALMHDR(1)=$$SETSTR^VALM1(X,VALMHDR(1),47,15)  ;repositioned header to display clinic or patient name properly for SD*5.3*189
"RTN","SDAM10",13,0)
 S X=$S($D(^DPT(SDFN,.1)):"Ward: "_^(.1),1:"Outpatient")
"RTN","SDAM10",14,0)
 S VALMHDR(1)=$$SETSTR^VALM1(X,VALMHDR(1),81-$L(X),$L(X))
"RTN","SDAM10",15,0)
 Q
"RTN","SDAM10",16,0)
 ;
"RTN","SDAM10",17,0)
PAT ; -- change pat
"RTN","SDAM10",18,0)
 K TMP ;SD/478
"RTN","SDAM10",19,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","SDAM10",20,0)
 K X I $D(XQORNOD(0)) S X=$P($P(XQORNOD(0),U,4),"=",2)
"RTN","SDAM10",21,0)
 I $D(X),X="" R !!,"Select Patient: ",X:DTIME
"RTN","SDAM10",22,0)
 D RT^SDAMEX S DIC="^DPT(",DIC(0)="EMQ" D ^DIC K DIC G PAT:X["?"
"RTN","SDAM10",23,0)
PAT1 S %=1 W !,"   ...OK" D YN^DICN I %=0 W "   Answer with 'Yes' or 'No'" G PAT1
"RTN","SDAM10",24,0)
 I %'=1 S Y=-1
"RTN","SDAM10",25,0)
 I Y<0 D  G PATQ
"RTN","SDAM10",26,0)
 .I SDAMTYP="P" S VALMSG=$C(7)_"Patient has not been changed."
"RTN","SDAM10",27,0)
 .I SDAMTYP="C" S VALMSG=$C(7)_"View of clinic remains in affect."
"RTN","SDAM10",28,0)
 I SDAMTYP'="P" D CHGCAP^VALM("NAME","Clinic") S SDAMTYP="P"
"RTN","SDAM10",29,0)
 S SDFN=+Y K SDCLN D BLD^SDAM1
"RTN","SDAM10",30,0)
PATQ Q
"RTN","SDAM10",31,0)
 ;
"RTN","SDAM10",32,0)
INIT ; -- init bld vars
"RTN","SDAM10",33,0)
 K VALMHDR,SDDA,^TMP("SDAMIDX",$J)
"RTN","SDAM10",34,0)
 D CLEAN^VALM10
"RTN","SDAM10",35,0)
 S VALMBG=1,(VALMCNT,SDACNT)=0,BL="",$P(BL," ",30)="",SDMAX=100
"RTN","SDAM10",36,0)
 S SDAMDD=$P(^DD(2.98,3,0),U,3)
"RTN","SDAM10",37,0)
 ; -- format vars     |- column -| |- width -|
"RTN","SDAM10",38,0)
 S X=VALMDDF("APPT#"),AC=$P(X,U,2),AW=$P(X,U,3) ; A for appt
"RTN","SDAM10",39,0)
 S X=VALMDDF("DATE"),XC=$P(X,U,2),XW=$P(X,U,3) ;  X for date
"RTN","SDAM10",40,0)
 S X=VALMDDF("NAME"),NC=$P(X,U,2),NW=$P(X,U,3) ;  N for name
"RTN","SDAM10",41,0)
 S X=VALMDDF("STAT"),SC=$P(X,U,2),SW=$P(X,U,3) ;  S for status
"RTN","SDAM10",42,0)
 S X=VALMDDF("TIME"),TC=$P(X,U,2),TW=$P(X,U,3) ;  T for time
"RTN","SDAM10",43,0)
 S (CC,CW)="",X=$G(VALMDDF("CONSULT")) I X'="" S CC=$P(X,U,2),CW=$P(X,U,3) ;  C for Consult ;SD/478
"RTN","SDAM10",44,0)
 Q
"RTN","SDAM10",45,0)
 ;
"RTN","SDAM10",46,0)
LARGE ; -- too large note
"RTN","SDAM10",47,0)
 W !!?5,*7,"Note: Ending Date was changed to '",$$FDATE^VALM1(SDEND),"' because"
"RTN","SDAM10",48,0)
 W !?11,"too many appointments met date range criteria." D PAUSE^VALM1
"RTN","SDAM10",49,0)
 Q
"RTN","SDAM10",50,0)
 ;
"RTN","SDAM10",51,0)
NUL ; -- set nul message
"RTN","SDAM10",52,0)
 I '$O(^TMP("SDAM",$J,0)) D SET^SDAM1(" "),SET^SDAM1("    No appointments meet criteria.")
"RTN","SDAM10",53,0)
 Q
"RTN","SDAM10",54,0)
 ;
"RTN","SDAM2")
0^3^B30409826
"RTN","SDAM2",1,0)
SDAM2 ;ALB/MJK - Appt Mgt (cont); 8/18/05 12:10pm
"RTN","SDAM2",2,0)
 ;;5.3;Scheduling;**250,296,327,478**;Aug 13, 1993
"RTN","SDAM2",3,0)
 ;
"RTN","SDAM2",4,0)
CI ; -- protocol SDAM APPT CHECK IN entry pt
"RTN","SDAM2",5,0)
 ; input:  VALMY := array entries
"RTN","SDAM2",6,0)
 ;
"RTN","SDAM2",7,0)
 N SDI,SDAT,VALMY,SDAMCIDT,SDCIACT
"RTN","SDAM2",8,0)
 D SEL^VALM2 S SDI=0,SDCIACT=""
"RTN","SDAM2",9,0)
 D NOW^%DTC S SDAMCIDT=$P(%,".")_"."_$E($P(%,".",2)_"0000",1,4)
"RTN","SDAM2",10,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT D
"RTN","SDAM2",11,0)
 .S SDAT=^TMP("SDAMIDX",$J,SDI)
"RTN","SDAM2",12,0)
 .W !,^TMP("SDAM",$J,+SDAT,0)
"RTN","SDAM2",13,0)
 .D:VALMCC SELECT^VALM10(+SDAT,1)
"RTN","SDAM2",14,0)
 .D ONE($P(SDAT,U,2),$P(SDAT,U,4),$P(SDAT,U,3),$P(SDAT,U,5),0,SDAMCIDT)
"RTN","SDAM2",15,0)
 .D:VALMCC SELECT^VALM10(+SDAT,0)
"RTN","SDAM2",16,0)
 S VALMBCK=$S(VALMCC:"",1:"R")
"RTN","SDAM2",17,0)
 Q
"RTN","SDAM2",18,0)
 ;
"RTN","SDAM2",19,0)
ONE(DFN,SDCL,SDT,SDDA,SDASK,SDAMCIDT) ; -- check in one appt
"RTN","SDAM2",20,0)
 ; input:  DFN := ifn of patient
"RTN","SDAM2",21,0)
 ;        SDCL := clinic# 
"RTN","SDAM2",22,0)
 ;         SDT := appt d/t
"RTN","SDAM2",23,0)
 ;        SDDA := ifn in ^SC multiple or null
"RTN","SDAM2",24,0)
 ;       SDASK := ask d/t of ci always [1|yes or 0|no]
"RTN","SDAM2",25,0)
 ;    SDAMCIDT := ci date/time [optional]
"RTN","SDAM2",26,0)
 ;
"RTN","SDAM2",27,0)
 I $D(XRTL) D T0^%ZOSV
"RTN","SDAM2",28,0)
 S:'SDDA SDDA=$$FIND(DFN,SDT,SDCL)
"RTN","SDAM2",29,0)
 I 'SDDA W !!,*7,"You cannot check in this appointment." D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",30,0)
 N SDATA,SDCIHDL,X S SDATA=SDDA_U_DFN_U_SDT_U_SDCL,SDCIHDL=$$HANDLE^SDAMEVT(1)
"RTN","SDAM2",31,0)
 D BEFORE^SDAMEVT(.SDATA,DFN,SDT,SDCL,SDDA,SDCIHDL)
"RTN","SDAM2",32,0)
 I '$D(^SD(409.63,"ACI",1,+SDATA("BEFORE","STATUS"))) W !!,*7,"You cannot check in this appointment." D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",33,0)
 ; *** mt blocking removed
"RTN","SDAM2",34,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T,$G(EASACT)'="W",$$MT^EASMTCHK(DFN,"","C",SDT) D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",35,0)
 I $P(SDT,".")>DT W !!,*7,"It is too soon to check in this appointment." D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",36,0)
 S:'$D(^SC(SDCL,"S",0)) ^(0)="^44.001DA^^"
"RTN","SDAM2",37,0)
 S DR="",X=$G(^SC(SDCL,"S",SDT,1,SDDA,"C"))
"RTN","SDAM2",38,0)
 I +X S DR=309
"RTN","SDAM2",39,0)
 ; -- already co'ed
"RTN","SDAM2",40,0)
 I DR="",$P(X,U,3) D
"RTN","SDAM2",41,0)
 .S DR="309//"
"RTN","SDAM2",42,0)
 .I $P(^SC(SDCL,0),U,24)!(SDASK) S DR=DR_$$FTIME^VALM1($P(X,U,3)) Q
"RTN","SDAM2",43,0)
 .S DR=DR_"//^S X="_$P(X,U,3)
"RTN","SDAM2",44,0)
 ;
"RTN","SDAM2",45,0)
 I DR="",$P(^SC(SDCL,0),U,24)!(SDASK) S DR="309//"_$S(SDAMCIDT:$$FTIME^VALM1(SDAMCIDT),1:"NOW")
"RTN","SDAM2",46,0)
 I DR="" S DR="309///"_$S(SDAMCIDT:"/"_SDAMCIDT,1:"NOW")
"RTN","SDAM2",47,0)
 S DA(2)=SDCL,DA(1)=SDT,DA=SDDA,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1," D ^DIE
"RTN","SDAM2",48,0)
 D AFTER^SDAMEVT(.SDATA,DFN,SDT,SDCL,SDDA,SDCIHDL)
"RTN","SDAM2",49,0)
 I '$P(SDATA("AFTER","STATUS"),U,4),'$P(SDATA("BEFORE","STATUS"),U,4) W !?8,*7,"...appointment has not been checked in" D PAUSE^VALM1
"RTN","SDAM2",50,0)
 I SDATA("BEFORE","STATUS")'=SDATA("AFTER","STATUS") D
"RTN","SDAM2",51,0)
 .I $P(SDATA("AFTER","STATUS"),U,4),'$P(SDATA("BEFORE","STATUS"),U,4) W !?8,"...checked in ",$$FTIME^VALM1($P(SDATA("AFTER","STATUS"),U,4))
"RTN","SDAM2",52,0)
 .I $D(SDCIACT) D
"RTN","SDAM2",53,0)
 ..S Y=SDATA("AFTER","STATUS"),Y1=$P(Y,U,4),Y=$P(Y,U,3)
"RTN","SDAM2",54,0)
 ..I $P(SDATA("BEFORE","STATUS"),U,3)'=Y D UPD($$LOWER^VALM1(Y),"STAT",+SDAT,1),UPD("","TIME",+SDAT,1)
"RTN","SDAM2",55,0)
 ..I $P(SDATA("AFTER","STATUS"),U,3)["CHECKED IN" D UPD($S($P(Y1,".")=DT:$$TIME^SDAM1($P(Y1,".",2)),1:"     "),"TIME",+SDAT,1)
"RTN","SDAM2",56,0)
 .D EVT^SDAMEVT(.SDATA,4,0,SDCIHDL) ; 4 := ci evt , 0 := interactive mode
"RTN","SDAM2",57,0)
 I $D(XRT0) S XRTN="SDAM2" D T1^%ZOSV
"RTN","SDAM2",58,0)
ONEQ K DA,DIE,DR,DQ,DE,Y,Y1 Q
"RTN","SDAM2",59,0)
 ;
"RTN","SDAM2",60,0)
 ;
"RTN","SDAM2",61,0)
FIND(DFN,SDT,SDCL) ; -- return appt ifn for pat
"RTN","SDAM2",62,0)
 ;   input:        DFN := ifn of pat.
"RTN","SDAM2",63,0)
 ;                 SDT := appt d/t
"RTN","SDAM2",64,0)
 ;                SDCL := ifn of clinic
"RTN","SDAM2",65,0)
 ;  output: [returned] := ifn if pat has appt on date/time
"RTN","SDAM2",66,0)
 ;
"RTN","SDAM2",67,0)
 N Y
"RTN","SDAM2",68,0)
 S Y=0 F  S Y=$O(^SC(SDCL,"S",SDT,1,Y)) Q:'Y  I $D(^(Y,0)),DFN=+^(0),$D(^DPT(+DFN,"S",SDT,0)),$$VALID(DFN,SDCL,SDT,Y) S CNSTLNK=$P($G(^SC(SDCL,"S",SDT,1,Y,"CONS")),U) K:CNSTLNK="" CNSTLNK Q  ;SD/478
"RTN","SDAM2",69,0)
 Q Y
"RTN","SDAM2",70,0)
 ;
"RTN","SDAM2",71,0)
UPD(TEXT,FLD,LINE,SAVE) ; -- update data for screen
"RTN","SDAM2",72,0)
 D FLDTEXT^VALM10(LINE,FLD,TEXT)
"RTN","SDAM2",73,0)
 D:VALMCC CNTRL^VALM10(LINE,$P(VALMDDF(FLD),U,2),$P(VALMDDF(FLD),U,3),IOINHI,IOINORM,+$G(SAVE))
"RTN","SDAM2",74,0)
 Q
"RTN","SDAM2",75,0)
 ;
"RTN","SDAM2",76,0)
MAKE ; -- make appt action
"RTN","SDAM2",77,0)
 N ORACTION,ORVP,XQORQUIT,SDAMERR
"RTN","SDAM2",78,0)
 D FULL^VALM1
"RTN","SDAM2",79,0)
 W !!,VALMHDR(1)
"RTN","SDAM2",80,0)
 D ^SDM
"RTN","SDAM2",81,0)
 I '$D(SDAMERR) D BLD^SDAM
"RTN","SDAM2",82,0)
 I $D(SDAMERR) D PAUSE^VALM1
"RTN","SDAM2",83,0)
 D SDM^SDKILL S VALMBCK="R"
"RTN","SDAM2",84,0)
 Q
"RTN","SDAM2",85,0)
 ;
"RTN","SDAM2",86,0)
WI ; -- walk-in visit action
"RTN","SDAM2",87,0)
 S VALMBCK="R"
"RTN","SDAM2",88,0)
 D FULL^VALM1
"RTN","SDAM2",89,0)
 I SDAMTYP="P" I $$CL^SDAMWI(SDFN) D BLD^SDAM1
"RTN","SDAM2",90,0)
 I SDAMTYP="C" I $$PT^SDAMWI(SDCLN) D BLD^SDAM3
"RTN","SDAM2",91,0)
 ;evaluate wait list ;SD/327
"RTN","SDAM2",92,0)
EWLCHK ;check if patient has any open EWL entries (SD/372)
"RTN","SDAM2",93,0)
 ;CLN expected as clinic IEN
"RTN","SDAM2",94,0)
 I '$D(DFN) Q
"RTN","SDAM2",95,0)
 I $D(SDT) N SDEV D EN^SDWLEVAL(DFN,.SDEV) D
"RTN","SDAM2",96,0)
 .I SDEV,$L(SDEV(1))>0 W !,SDEV(1),! D
"RTN","SDAM2",97,0)
 ..;display appointment
"RTN","SDAM2",98,0)
 ..K ^TMP($J,"SDAMA301"),^TMP($J,"APPT")
"RTN","SDAM2",99,0)
 ..N SD S SD=SDT
"RTN","SDAM2",100,0)
 ..;S SC=+$G(SDATA)
"RTN","SDAM2",101,0)
 ..I '$D(SC) S SC=+$G(CLN)
"RTN","SDAM2",102,0)
 ..W:$D(IOF) @IOF D APPT^SDWLEVAL(DFN,SD,SC)
"RTN","SDAM2",103,0)
 ..Q:'$D(^TMP($J,"APPT"))
"RTN","SDAM2",104,0)
 ..D APPTD^SDWLEVAL ;display appointment
"RTN","SDAM2",105,0)
 .Q:'$D(^TMP($J,"APPT"))  ;no appointment created
"RTN","SDAM2",106,0)
 .N SDTC D EWLANS^SDWLEVAL(.SDTC) ;user may reject EWL
"RTN","SDAM2",107,0)
 .;ask for selection of EWL to display
"RTN","SDAM2",108,0)
 .;ASKS - returned answer (A/C/S/^)
"RTN","SDAM2",109,0)
 .;    ^TMP("SDWLPL",$J) and ^TMP($J,"SDWLPL") are used
"RTN","SDAM2",110,0)
 .;      to generate EWL open entries
"RTN","SDAM2",111,0)
 .I SDTC N SDCTN S SDCTN=0 F  N ASKS K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL") D ANS2^SDWLPL(DFN,.ASKS) Q:ASKS="^"  D  Q:SDCTN
"RTN","SDAM2",112,0)
 ..Q:'$D(^TMP($J,"SDWLPL"))  D ASKREM^SDWLEVAL S SDCTN=1 ;display and process selected open EWL entries
"RTN","SDAM2",113,0)
 .I 'SDTC Q  ;no EWL evaluation per user's decision
"RTN","SDAM2",114,0)
 .Q
"RTN","SDAM2",115,0)
 Q
"RTN","SDAM2",116,0)
 ;
"RTN","SDAM2",117,0)
DATE ; -- change date range
"RTN","SDAM2",118,0)
 S VALMB=SDBEG D RANGE^VALM11
"RTN","SDAM2",119,0)
 I $S('VALMBEG:1,SDBEG'=VALMBEG:0,1:SDEND=VALMEND) W !!,"Date range was not changed." D PAUSE^VALM1 S VALMBCK="" G DATEQ
"RTN","SDAM2",120,0)
 S SDBEG=VALMBEG,SDEND=VALMEND
"RTN","SDAM2",121,0)
 I SDAMTYP="P" D BLD^SDAM1
"RTN","SDAM2",122,0)
 I SDAMTYP="C" D BLD^SDAM3
"RTN","SDAM2",123,0)
 S VALMBCK="R"
"RTN","SDAM2",124,0)
DATEQ K VALMB,VALMBEG,VALMEND Q
"RTN","SDAM2",125,0)
 ;
"RTN","SDAM2",126,0)
INP(DFN,VDATE) ; -- determine inpat status ; dom is not an inpat appt
"RTN","SDAM2",127,0)
 N SDINP,VAINDT,VADMVT
"RTN","SDAM2",128,0)
 S SDINP="",VAINDT=VDATE D ADM^VADPT2 G INPQ:'VADMVT
"RTN","SDAM2",129,0)
 I $P(^DG(43,1,0),U,21),$P($G(^DIC(42,+$P($G(^DGPM(VADMVT,0)),U,6),0)),U,3)="D" G INPQ
"RTN","SDAM2",130,0)
 S SDINP="I"
"RTN","SDAM2",131,0)
INPQ Q SDINP
"RTN","SDAM2",132,0)
 ;
"RTN","SDAM2",133,0)
VALID(DFN,SDCL,SDT,SDDA) ; -- return valid appt.
"RTN","SDAM2",134,0)
 ; **NOTE:  For speed consideration the ^SC and ^DPT nodes must be
"RTN","SDAM2",135,0)
 ;          check to see they exist prior to calling this entry point.
"RTN","SDAM2",136,0)
 ;   input:        DFN := ifn of pat.
"RTN","SDAM2",137,0)
 ;                 SDT := appt d/t
"RTN","SDAM2",138,0)
 ;                SDCL := ifn of clinic
"RTN","SDAM2",139,0)
 ;                SDDA := ifn of appt
"RTN","SDAM2",140,0)
 ;  output: [returned] := 1 for valid appt., 0 for not valid
"RTN","SDAM2",141,0)
 Q $S($P(^SC(SDCL,"S",SDT,1,SDDA,0),U,9)'="C":1,$P(^DPT(DFN,"S",SDT,0),U,2)["C":1,1:0)
"RTN","SDAM3")
0^4^B9638005
"RTN","SDAM3",1,0)
SDAM3 ;MJK/ALB - Appt Mgt (Clinic) ; 4/21/05 12:23pm
"RTN","SDAM3",2,0)
 ;;5.3;Scheduling;**63,189,380,478**;Aug 13, 1993
"RTN","SDAM3",3,0)
 ;
"RTN","SDAM3",4,0)
INIT ; -- get init clinic appt data
"RTN","SDAM3",5,0)
 ;  input:        SDCLN := ifn of pat
"RTN","SDAM3",6,0)
 ; output:  ^TMP("SDAM" := appt array
"RTN","SDAM3",7,0)
 S X=$P($G(^DG(43,1,"SCLR")),U,12),SDPRD=$S(X:X,1:2)
"RTN","SDAM3",8,0)
 S X1=DT,X2=-SDPRD D C^%DTC S VALMB=X D RANGE^VALM11
"RTN","SDAM3",9,0)
 I '$D(VALMBEG) S VALMQUIT="" G INITQ
"RTN","SDAM3",10,0)
 S SDBEG=VALMBEG,SDEND=VALMEND
"RTN","SDAM3",11,0)
 D CHGCAP^VALM("NAME","Patient")
"RTN","SDAM3",12,0)
 S X="NO ACTION TAKEN" D LIST^SDAM
"RTN","SDAM3",13,0)
INITQ K VALMB,VALMBEG,VALMEND Q
"RTN","SDAM3",14,0)
 ;
"RTN","SDAM3",15,0)
BLD ; -- scan apts
"RTN","SDAM3",16,0)
 N VA,SDAMDD,SDNAME,SDMAX,SDLARGE,DFN,SDCL,BL,XC,XW,AC,AW,TC,TW,NC,NW,SC,SW,SDT,SDDA ; done for speed see INIT^SDAM10
"RTN","SDAM3",17,0)
 D INIT^SDAM10
"RTN","SDAM3",18,0)
 F SDT=SDBEG:0 S SDT=$O(^SC(SDCLN,"S",SDT)) Q:'SDT!($P(SDT,".",1)>SDEND)  D
"RTN","SDAM3",19,0)
 .F SDDA=0:0 S SDDA=$O(^SC(SDCLN,"S",SDT,1,SDDA)) Q:'SDDA  S CNSTLNK=$P($G(^SC(SDCLN,"S",SDT,1,SDDA,"CONS")),U),CSTAT="" S:CNSTLNK'="" CSTAT=$P($G(^GMR(123,CNSTLNK,0)),U,12) D  ;SD/478
"RTN","SDAM3",20,0)
 ..I $D(^SC(SDCLN,"S",SDT,1,SDDA,0)) S DFN=+^(0) D PID^VADPT I $D(^DPT(DFN,"S",SDT,0)),$$VALID^SDAM2(DFN,SDCLN,SDT,SDDA) S SDATA=^DPT(DFN,"S",SDT,0),SDCL=SDCLN,SDNAME=VA("BID")_" "_$P($G(^DPT(DFN,0)),U) D:SDCLN=+SDATA BLD1^SDAM1  ;SD/478
"RTN","SDAM3",21,0)
 D NUL^SDAM10,LARGE^SDAM10:$D(SDLARGE)
"RTN","SDAM3",22,0)
 S $P(^TMP("SDAM",$J,0),U,4)=VALMCNT
"RTN","SDAM3",23,0)
 Q
"RTN","SDAM3",24,0)
 ;
"RTN","SDAM3",25,0)
HDR ; -- list screen header
"RTN","SDAM3",26,0)
 ;   input:      SDCLN := ifn of pat
"RTN","SDAM3",27,0)
 ;  output:  VALMHDR() := hdr array
"RTN","SDAM3",28,0)
 ;
"RTN","SDAM3",29,0)
 S VALMHDR(1)=$E($P("Clinic: "_$G(^SC(SDCLN,0)),"^",1),1,45)  ;for proper display of clinic name for SD*5.3*189
"RTN","SDAM3",30,0)
 Q
"RTN","SDAM3",31,0)
 ;
"RTN","SDAM3",32,0)
CLN ; -- change clinic
"RTN","SDAM3",33,0)
 I $G(SDAMLIST)["CANCELLED" S VALMBCK="" W !!,*7,"You must be viewing a patient to list cancelled appointments." D PAUSE^VALM1 G CLNQ
"RTN","SDAM3",34,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","SDAM3",35,0)
 S X="" I $D(XQORNOD(0)) S X=$P($P(XQORNOD(0),U,4),"=",2)
"RTN","SDAM3",36,0)
 W ! S DIC="^SC(",DIC(0)=$S(X]"":"",1:"A")_"EMQ",DIC("A")="Select Clinic: ",DIC("S")="I $P(^(0),U,3)=""C"",'$G(^(""OOS""))"
"RTN","SDAM3",37,0)
 D ^DIC K DIC
"RTN","SDAM3",38,0)
 I Y<0 D  G CLNQ
"RTN","SDAM3",39,0)
 .I SDAMTYP="C" S VALMSG=$C(7)_"Clinic has not been changed."
"RTN","SDAM3",40,0)
 .I SDAMTYP="P" S VALMSG=$C(7)_"View of patient remains in affect."
"RTN","SDAM3",41,0)
 I SDAMTYP'="C" D CHGCAP^VALM("NAME","Patient") S SDAMTYP="C"
"RTN","SDAM3",42,0)
 N SDRES I SDAMTYP="C" S SDRES=$$CLNCK^SDUTL2(+Y,1) I 'SDRES D  G CLNQ
"RTN","SDAM3",43,0)
 .W !,?5,"Clinic MUST be corrected before continuing." D PAUSE^VALM1
"RTN","SDAM3",44,0)
 S SDCLN=+Y K SDFN D BLD
"RTN","SDAM3",45,0)
CLNQ Q
"RTN","SDAM3",46,0)
 ;
"RTN","SDAMC")
0^5^B12821748
"RTN","SDAMC",1,0)
SDAMC ;ALB/MJK - Cancel Appt Action ; 8/31/05 3:02pm
"RTN","SDAMC",2,0)
 ;;5.3;Scheduling;**20,28,32,46,263,414,444,478**;Aug 13, 1993
"RTN","SDAMC",3,0)
 ;
"RTN","SDAMC",4,0)
EN ; -- protocol SDAM APPT CANCEL entry pt
"RTN","SDAMC",5,0)
 ; input:  VALMY := array entries
"RTN","SDAMC",6,0)
 ;
"RTN","SDAMC",7,0)
 N SDI,SDAT,VALMY,SDAMCIDT,CNT,L,SDWH,SDCP,SDREM,SDSCR,SDMSG,SCLHOLD
"RTN","SDAMC",8,0)
 K ^UTILITY($J)
"RTN","SDAMC",9,0)
 ;
"RTN","SDAMC",10,0)
 ;
"RTN","SDAMC",11,0)
 I '$D(DFN),$G(SDFN),($G(SDAMTYP)="P") S DFN=SDFN
"RTN","SDAMC",12,0)
 ;
"RTN","SDAMC",13,0)
 S VALMBCK=""
"RTN","SDAMC",14,0)
 D SEL^VALM2,CHK G ENQ:'$O(VALMY(0))
"RTN","SDAMC",15,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","SDAMC",16,0)
 S SDWH=$$WHO,SDCP=$S(SDWH="C":0,1:1) G ENQ:SDWH=-1
"RTN","SDAMC",17,0)
 S SDSCR=$$RSN(SDWH) G ENQ:SDSCR=-1
"RTN","SDAMC",18,0)
 S (TMPD,SDREM)=$$REM G ENQ:SDREM=-1 ;SD/478
"RTN","SDAMC",19,0)
 S (SDI,CNT,L)=0
"RTN","SDAMC",20,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT S SDAT=^(SDI) W !,^TMP("SDAM",$J,+SDAT,0) D CAN($P(SDAT,U,2),$P(SDAT,U,3),.CNT,.L,SDWH,SDCP,SDSCR,SDREM)
"RTN","SDAMC",21,0)
 I SDAMTYP="P" D BLD^SDAM1
"RTN","SDAMC",22,0)
 I SDAMTYP="C" D BLD^SDAM3
"RTN","SDAMC",23,0)
ENQ Q
"RTN","SDAMC",24,0)
 ;
"RTN","SDAMC",25,0)
CAN(DFN,SDT,CNT,L,SDWH,SDCP,SDSCR,SDREM) ;
"RTN","SDAMC",26,0)
 N A1,NDT S NDT=SDT
"RTN","SDAMC",27,0)
 I $P($G(^DPT(DFN,"S",NDT,0)),U,2)["C" W !!,"Appointment already cancelled" H 2 G CANQ
"RTN","SDAMC",28,0)
 I $D(^DPT(DFN,"S",NDT,0)) S SD0=^(0) I $P(SD0,"^",2)'["C" S SC=+SD0,L=L\1+1,APL="" D FLEN^SDCNP1A S ^UTILITY($J,"SDCNP",L)=NDT_"^"_SC_"^"_COV_"^"_APL_"^^"_APL_"^^^^^^"_SDSP D CHKSO^SDCNP0 ;SD/478
"RTN","SDAMC",29,0)
 ;SD*5.3*414 next line added to set hold variable SCLHOLD for clinic ptr
"RTN","SDAMC",30,0)
 S APP=1,A1=L\1 S SCLHOLD=$P(^UTILITY($J,"SDCNP",A1),U,2) D BEGD^SDCNP0
"RTN","SDAMC",31,0)
 D MES,NOPE W ! S (CNT,L)=0 K ^UTILITY($J,"SDCNP")
"RTN","SDAMC",32,0)
CANQ ;
"RTN","SDAMC",33,0)
 ;Wait List Message
"RTN","SDAMC",34,0)
 ;
"RTN","SDAMC",35,0)
 I $G(SCLHOLD)'="" S:'$D(SDCLN) SDCLN=SCLHOLD  ; SD*5.3*414
"RTN","SDAMC",36,0)
 I $G(SDCLN)'="",$D(^SDWL(409.3,"SC",SDCLN)) D
"RTN","SDAMC",37,0)
 .W !,?1,"There are Patients on the Wait List waiting for an Appointment in the",!?1,$P(^SC(SDCLN,0),U,1)," Clinic.",!
"RTN","SDAMC",38,0)
 S DIR(0)="E" D ^DIR W !
"RTN","SDAMC",39,0)
 K:SDAMTYP="P" SDCLN
"RTN","SDAMC",40,0)
 K SCLHOLD,SC,COV,APP
"RTN","SDAMC",41,0)
 Q
"RTN","SDAMC",42,0)
MES ; -- set error message
"RTN","SDAMC",43,0)
 S SDMSG="W !,""Enter appt. numbers separated by commas and/or a range separated"",!,""by dashes (ie 2,4,6-9)"" H 2"
"RTN","SDAMC",44,0)
 Q
"RTN","SDAMC",45,0)
 ;
"RTN","SDAMC",46,0)
WHO() ;
"RTN","SDAMC",47,0)
 W ! S DIR(0)="SOA^PC:PATIENT;C:CLINIC",DIR("A")="Appointments cancelled by (P)atient or (C)linic: ",DIR("B")="Patient"
"RTN","SDAMC",48,0)
 D ^DIR K DIR
"RTN","SDAMC",49,0)
 Q $S(Y=""!(Y="^"):-1,1:Y)
"RTN","SDAMC",50,0)
 ;
"RTN","SDAMC",51,0)
RSN(SDWH) ;
"RTN","SDAMC",52,0)
RSN1 W ! S DIC="^SD(409.2,",DIC(0)="AEMQ",DIC("S")="I '$P(^(0),U,4),"""_$E(SDWH)_"B""[$P(^(0),U,2)" D ^DIC K DIC
"RTN","SDAMC",53,0)
 I X["^" G RSNQ
"RTN","SDAMC",54,0)
 I Y<0 W *7 G RSN1
"RTN","SDAMC",55,0)
RSNQ Q +Y
"RTN","SDAMC",56,0)
 ;
"RTN","SDAMC",57,0)
REM() ;
"RTN","SDAMC",58,0)
 W ! S DIR(0)="2.98,17" D ^DIR K DIR
"RTN","SDAMC",59,0)
 I $E(X)="^" S Y=-1
"RTN","SDAMC",60,0)
 Q Y
"RTN","SDAMC",61,0)
 ;
"RTN","SDAMC",62,0)
NOPE ;
"RTN","SDAMC",63,0)
 N SDEND,SDPAUSE
"RTN","SDAMC",64,0)
 S:'CNT SDPAUSE=1
"RTN","SDAMC",65,0)
 D NOPE^SDCNP1
"RTN","SDAMC",66,0)
 D:$G(SDPAUSE) PAUSE^VALM1
"RTN","SDAMC",67,0)
 Q
"RTN","SDAMC",68,0)
 ;
"RTN","SDAMC",69,0)
CHK ; -- check if status of appt permits cancelling
"RTN","SDAMC",70,0)
 N SDI S SDI=0
"RTN","SDAMC",71,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT S SDAT=^(SDI) I '$D(^SD(409.63,"ACAN",1,+$$STATUS^SDAM1($P(SDAT,U,2),$P(SDAT,U,3),+$G(^DPT(+$P(SDAT,U,2),"S",+$P(SDAT,U,3),0)),$G(^(0))))) D
"RTN","SDAMC",72,0)
 .W !,^TMP("SDAM",$J,+SDAT,0),!!,*7,"You cannot cancel this appointment."
"RTN","SDAMC",73,0)
 .K VALMY(SDI) D PAUSE^VALM1
"RTN","SDAMC",74,0)
 Q
"RTN","SDAMN")
0^26^B7272637
"RTN","SDAMN",1,0)
SDAMN ;ALB/MJK - No-Show Appt Action ; 2/4/92
"RTN","SDAMN",2,0)
 ;;5.3;Scheduling;**478**;Aug 13, 1993
"RTN","SDAMN",3,0)
 ;
"RTN","SDAMN",4,0)
EN ; -- protocol SDAM APPT NO-SHOW entry pt
"RTN","SDAMN",5,0)
 ; input:  VALMY := array entries
"RTN","SDAMN",6,0)
 ;
"RTN","SDAMN",7,0)
 N VALMY,SDI,SDAT,SDTIME,SDNSACT,DFN,SDCL,SDT,SDSTB,SDSTA,SDSTOP
"RTN","SDAMN",8,0)
 S VALMBCK="",(SDNSACT,SDSTOP)=0
"RTN","SDAMN",9,0)
 D SEL^VALM2 G ENQ:'$O(VALMY(0))
"RTN","SDAMN",10,0)
 D FULL^VALM1 S VALMBCK="R",SDI=0
"RTN","SDAMN",11,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT S SDAT=^(SDI) D  Q:SDSTOP
"RTN","SDAMN",12,0)
 .D NOW^%DTC S SDTIME=%
"RTN","SDAMN",13,0)
 .W !,^TMP("SDAM",$J,+SDAT,0),!
"RTN","SDAMN",14,0)
 .S DFN=+$P(SDAT,U,2),SDT=+$P(SDAT,U,3),SDCL=+$P(SDAT,U,4)
"RTN","SDAMN",15,0)
 .S SDSTB=$$STATUS^SDAM1(DFN,SDT,SDCL,$G(^DPT(DFN,"S",SDT,0))) ; before status
"RTN","SDAMN",16,0)
 .Q:'$$CHK
"RTN","SDAMN",17,0)
 .S SDSTOP=$$NS(DFN,SDT,SDCL,SDTIME,.SDNSACT)
"RTN","SDAMN",18,0)
 .S SDSTA=$$STATUS^SDAM1(DFN,SDT,SDCL,$G(^DPT(DFN,"S",SDT,0))) ; after status
"RTN","SDAMN",19,0)
 .I 'SDNSACT,'$$UPD(SDSTB,SDSTA,SDAT,$G(CNSTLNK)) S SDNSACT=2
"RTN","SDAMN",20,0)
 ; values for SDNSACT :   0 = no re-build
"RTN","SDAMN",21,0)
 ;                        1 = re-build because of re-book
"RTN","SDAMN",22,0)
 ;                        2 = re-build because after not for list
"RTN","SDAMN",23,0)
 I SDNSACT,SDAMTYP="P" D BLD^SDAM1
"RTN","SDAMN",24,0)
 I SDNSACT,SDAMTYP="C" D BLD^SDAM3
"RTN","SDAMN",25,0)
ENQ Q
"RTN","SDAMN",26,0)
 ;
"RTN","SDAMN",27,0)
NS(DFN,SDT,SC,SDTIME,SDNSACT) ; execute no-show code
"RTN","SDAMN",28,0)
 ; input:   DFN := pt file ifn
"RTN","SDAMN",29,0)
 ;          SDT := d/t of appt
"RTN","SDAMN",30,0)
 ;           SC := clinic ifn
"RTN","SDAMN",31,0)
 ;       SDTIME := now
"RTN","SDAMN",32,0)
 ;      SDNSACT := ns processing flag
"RTN","SDAMN",33,0)
 ;     [return] := did user uparrow [ 0|no , 1|yes]
"RTN","SDAMN",34,0)
 ;
"RTN","SDAMN",35,0)
 N SDI,SDCP,SDYES,SDINP,SDLT1,SDLT,SDDT,SDMSG,A,L,I,SDV1,SDCL
"RTN","SDAMN",36,0)
 K ^UTILITY($J)
"RTN","SDAMN",37,0)
 D LO^DGUTL S SDLT1="",SDYES="",SDDT=DT,I=SDT,SDT=$P(I,".")
"RTN","SDAMN",38,0)
 S SDMSG=" DOES NOT HAVE A NO-SHOW LETTER ASSIGNED TO IT!"
"RTN","SDAMN",39,0)
 S SDV1=$O(^DG(40.8,0)) D DIV^SDUTL I $T S SDV1=$P($G(^SC(SC,0)),U,15)
"RTN","SDAMN",40,0)
 D EN1^SDN,73^SDN,PAUSE^VALM1
"RTN","SDAMN",41,0)
NSQ Q 'Y
"RTN","SDAMN",42,0)
 ;
"RTN","SDAMN",43,0)
CHK() ; -- check if status of appt permits no-show
"RTN","SDAMN",44,0)
 N SDOK S SDOK=1
"RTN","SDAMN",45,0)
 I '$D(^SD(409.63,"ANS",1,+SDSTB)) S SDOK=0,X="You cannot execute no-show processing for this appointment."
"RTN","SDAMN",46,0)
 I SDOK,SDT>SDTIME S SDOK=1,X="It is too soon to no-show this appointment."
"RTN","SDAMN",47,0)
 I 'SDOK W !!,*7,X K VALMY(SDI) D PAUSE^VALM1
"RTN","SDAMN",48,0)
 Q SDOK
"RTN","SDAMN",49,0)
 ;
"RTN","SDAMN",50,0)
UPD(BEFORE,AFTER,SDAT,CNST) ; can just the 1 display line be changed w/o re-build
"RTN","SDAMN",51,0)
 ; input:   BEFORE := before status info in $$STATUS format
"RTN","SDAMN",52,0)
 ;           AFTER := after     "     "   "     "      "
"RTN","SDAMN",53,0)
 ;            SDAT := selected VALMY entry's data
"RTN","SDAMN",54,0)
 ;            CNST := consult status (null, consult link ien)
"RTN","SDAMN",55,0)
 N Y S Y=0
"RTN","SDAMN",56,0)
 I +BEFORE=+AFTER S Y=1 G UPDQ
"RTN","SDAMN",57,0)
 I $D(SDAMLIST(+AFTER)) S Y=1 I $D(SDAMLIST("SCR")) X SDAMLIST("SCR") S Y=$T
"RTN","SDAMN",58,0)
 I 'Y,$P(SDAMLIST,U)="ALL" S Y=1
"RTN","SDAMN",59,0)
 I Y D
"RTN","SDAMN",60,0)
 . S ^TMP("SDAM",$J,+SDAT,0)=$$SETFLD^VALM1($P(AFTER,";",3),^TMP("SDAM",$J,+SDAT,0),"STAT")
"RTN","SDAMN",61,0)
 . I '$G(CNST) S ^TMP("SDAM",$J,+SDAT,0)=$$SETFLD^VALM1("    ",^TMP("SDAM",$J,+SDAT,0),"CONSULT")
"RTN","SDAMN",62,0)
UPDQ Q Y
"RTN","SDAUT2")
0^6^B31407723
"RTN","SDAUT2",1,0)
SDAUT2 ;MAN/GRR - LOOK FOR OPEN SLOTS ; 3/3/05 12:08pm
"RTN","SDAUT2",2,0)
 ;;5.3;Scheduling;**206,168,186,478**;Aug 13, 1993
"RTN","SDAUT2",3,0)
 K SDNOSH
"RTN","SDAUT2",4,0)
EN1 S (FND,DUPE)=0,NDATE="",SDSOH=$S('$D(^SC(SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1) I $S('$D(^DPT(+A,.35)):0,$P(^(.35),"^",1)']"":0,1:1) S MESS="NOT REBOOKED, PATIENT HAS DIED" G END
"RTN","SDAUT2",5,0)
 S MESS="" K SDPAT S:'$D(J) SDPAT="" F NDATE=SDSTRTDT-1:0 S NDATE=$O(^SC(SC,"ST",NDATE)) Q:NDATE'>0!(NDATE>ENDATE)!(FND)  I ^(NDATE,1)["[",$E(NDATE,6,7) S Z=^(1) I '$D(^HOLIDAY(NDATE))!(SDSOH) S HNDATE=NDATE D SRCH Q:FND
"RTN","SDAUT2",6,0)
 I 'FND,$D(SDPAT) S NDATE="",MESS="NOT REBOOKED, NO PATTERN FOUND" G END
"RTN","SDAUT2",7,0)
 I 'FND S NDATE="",MESS="NOT REBOOKED, NO OPEN SLOTS" G END
"RTN","SDAUT2",8,0)
 ;
"RTN","SDAUT2",9,0)
 ;**186**  MLR 11/30/00  Checking date for "non-cancelled" appointments
"RTN","SDAUT2",10,0)
 D DUPE
"RTN","SDAUT2",11,0)
 ;
"RTN","SDAUT2",12,0)
 N SDATA,SDDA,SDABHDL S SDDA=L,SDABHDL=$$HANDLE^SDAMEVT(1) D BEFORE^SDAMEVT(.SDATA,+A,GDATE,SC,SDDA,SDABHDL)
"RTN","SDAUT2",13,0)
 S NDATE=CKDATE,DNODE=^DPT(+A,"S",GDATE,0),$P(DNODE,"^",2)=$S($D(SDNOSH):"NA",$D(SDCP):$S(SDCP:"PCA",1:"CA"),1:"CA"),$P(DNODE,"^",10)=NDATE D STORE S ^DPT(+A,"S",NDATE,0)=HOLD,^DPT(+A,"S",GDATE,0)=DNODE,^SC(SC,"S",NDATE,1,0)="^44.003PA^^"
"RTN","SDAUT2",14,0)
 ;xref DATE APPT. MADE field
"RTN","SDAUT2",15,0)
 D
"RTN","SDAUT2",16,0)
 .N DIV,DA,DIK
"RTN","SDAUT2",17,0)
 .S DA=NDATE,DA(1)=+A,DIK="^DPT(DA(1),""S"",",DIK(1)=20 D EN1^DIK
"RTN","SDAUT2",18,0)
 .Q
"RTN","SDAUT2",19,0)
 I '$D(SDCP) S SDNODE=^SC(SC,"S",GDATE,1,L,0)
"RTN","SDAUT2",20,0)
 N LNK,CY
"RTN","SDAUT2",21,0)
 K QT S ^SC(SC,"ST",HNDATE,1)=Z,^SC(SC,"S",NDATE,0)=NDATE F CY=1:1 I '$D(^SC(SC,"S",NDATE,1,CY)) D  Q:$D(QT)  ;SD/478
"RTN","SDAUT2",22,0)
 .S ^(CY,0)=+A_"^"_LEN,$P(^SC(SC,"S",NDATE,1,CY,0),"^",4,8)=$P(SDNODE,"^",4)_"^^"_$S($D(DUZ):DUZ,1:"")_"^"_DT_"^"_$P(SDNODE,"^",8) ;SD/478
"RTN","SDAUT2",23,0)
 .S TPAT=$P(SDNODE,U) I $D(AUTO(SC,$S($D(SDCP):SD,1:GDATE),TPAT)) S LNK=AUTO(SC,GDATE,TPAT) D AUTOREB^SDCNSLT(SC,NDATE,LNK,CY)  ;SD/478
"RTN","SDAUT2",24,0)
 .S QT=""  ;SD/478
"RTN","SDAUT2",25,0)
 S $P(^SC(SC,"S",NDATE,1,CY,0),"^",10)=$P(SDNODE,"^",10) ;SD/478
"RTN","SDAUT2",26,0)
 I $D(^SC("ARAD",SC,GDATE,+A)) S ^SC("ARAD",SC,NDATE,+A)=""
"RTN","SDAUT2",27,0)
 S SDTTM=NDATE,SDPL=CY,SDSC=SC,DFN=+A,SDRT="A" D RT^SDUTL,EVT ;SD/478
"RTN","SDAUT2",28,0)
END K ARG,BTIM,CKDATE,CNT,DIF,DISBEG,DNODE,FND,GOT,HDIF,HH1,HH2,HH3,HNDATE,HOLD,HSTM,HT1,HT2,HT3,INC,INCM,J,K,LEN,M,MM1,MM2,MM3,MMD,MMD2,NC,NS,NSTM,NTIM,REM,SDPAT,SDPL,SDSC,SDT20,SDTEST,SDTTM,STM,STR,TEMP,TM,WH,XK,^UTILITY($J,"I")
"RTN","SDAUT2",29,0)
 Q
"RTN","SDAUT2",30,0)
 ;
"RTN","SDAUT2",31,0)
DUPE ;**186**  MLR  Checking date for "non-cancelled" appointments prior to
"RTN","SDAUT2",32,0)
 ;11/30/00      setting "MULTIPLE APPNTS. ON CANCELLED DATE" message
"RTN","SDAUT2",33,0)
 N I S I=$P(GDATE,"."),DUPE=0
"RTN","SDAUT2",34,0)
 F  S I=$O(^DPT(+A,"S",I)) Q:'I!DUPE!($P(I,".")>GDATE)  D
"RTN","SDAUT2",35,0)
 . Q:I=GDATE
"RTN","SDAUT2",36,0)
 . I $P(^DPT(+A,"S",I,0),U,2)="I" S DUPE=1 Q
"RTN","SDAUT2",37,0)
 . I $P(^DPT(+A,"S",I,0),U,2)="" S DUPE=1 Q
"RTN","SDAUT2",38,0)
 . Q
"RTN","SDAUT2",39,0)
 Q  ;DUPE
"RTN","SDAUT2",40,0)
 ;
"RTN","SDAUT2",41,0)
SRCH I $D(SDCP),(GDATE\1)=NDATE Q
"RTN","SDAUT2",42,0)
 S LEN=$P(A,"^",2),INC=$P(^SC(SC,"SL"),"^",6),DISBEG=$P(^("SL"),"^",3),STR="123456789jklmnopqrstuvwxyz",INCM=$S(INC=4:15,INC=3:20,INC=6:10,INC=2:30,INC=1:60,1:0) G:INCM=0 NO S SDDIF=$S(INC<3:8/INC,1:2) K SDTEST N SDIV S SDIV=""
"RTN","SDAUT2",43,0)
 S:$D(^SC(+SC,0)) SDIV=$S('$P(^(0),"^",15):$O(^DG(40.8,0)),1:$P(^(0),"^",15)) I $D(^DG(40.8,+SDIV,"LTR")) F XK=3,4,5 I $P(^DPT(+A,"S",GDATE,0),"^",XK)]"" S TEMP=$P($P(^(0),"^",XK),".",2),SDTEST(XK)=$P(^DG(40.8,SDIV,"LTR"),"^",(XK-1)) D FTM,FTM3
"RTN","SDAUT2",44,0)
 S BTIM=$S($D(^SC(SC,"SDP")):$P(^("SDP"),"^",3),1:""),BTIM=$S($E(+$O(SDTEST("")),2,999)>BTIM:$E(+$O(SDTEST("")),2,999),1:BTIM) S:DISBEG="" DISBEG=8
"RTN","SDAUT2",45,0)
 S NS=LEN\INCM,ST=$F(Z,"["),GOT=0,INC=$S(INC<3:4,1:INC)
"RTN","SDAUT2",46,0)
 I BTIM]"" S ARG=INC*2,DIF=BTIM-DISBEG S:DIF>0 ST=DIF*ARG+ARG+1
"RTN","SDAUT2",47,0)
 S CNT=0 F J=0:SDDIF:80 Q:$E(Z,ST+J,80)'["]"  S K=$E(Z,ST+J),CNT=$S(K]""&(STR[K):CNT+1,1:0) S:$S(STR[K:0,K?1A!(K=0):0,1:1) SDST=$F(Z,"[",ST+J),J=$S('SDST:80,1:SDST-SDDIF-ST) I CNT=NS D MORE Q:GOT  S CNT=0
"RTN","SDAUT2",48,0)
 Q
"RTN","SDAUT2",49,0)
MORE S TM=(NS-1)*SDDIF,STM=ST+J-TM,NSTM=STM-1/(INC*2)-1,HSTM=$P(NSTM,".",1)+DISBEG,HSTM=$S(HSTM<10:".0"_HSTM,1:"."_HSTM)
"RTN","SDAUT2",50,0)
 I NSTM\1'=NSTM S REM="."_$E($P(NSTM,".",2),1,3),MIN=REM*60+.1,HSTM=HSTM_$P(MIN,".",1)
"RTN","SDAUT2",51,0)
 S CKDATE=NDATE_HSTM,CKDATE=+CKDATE I $D(^DPT(+A,"S",CKDATE,0)),$P(^(0),"^",2)'["C" Q
"RTN","SDAUT2",52,0)
 S FND=1,GOT=1 F M=STM:SDDIF:STM+(NS*SDDIF)-2 S CHAR=$E(Z,M,M),WH=$F(STR,CHAR)-2,NC=$S(WH<1:0,1:$E(STR,WH,WH)),Z=$E(Z,1,M-1)_NC_$E(Z,M+1,99)
"RTN","SDAUT2",53,0)
 Q
"RTN","SDAUT2",54,0)
STORE S SDINP=$$INP^SDAM2(+A,NDATE)
"RTN","SDAUT2",55,0)
 S HOLD=SC_"^"_$$STATUS^SDM1A(SC,SDINP,NDATE)_"^"_$P(^DPT(+A,"S",GDATE,0),"^",3,5)_"^^"_$P(^(0),"^",7,9)_"^^"_$P(^(0),"^",11)_"^^"_$P(^(0),"^",13)_"^^^"_$P(^(0),"^",16)_"^^^"_DT_"^^^^^^A^0"
"RTN","SDAUT2",56,0)
 F XK=3,4,5 I $P(HOLD,"^",XK)]"" S TEMP=$P($P(HOLD,"^",XK),".",2) D FTM,FTM1 S TEMP=HNDATE_NTIM,$P(HOLD,"^",XK)=TEMP K SDINP
"RTN","SDAUT2",57,0)
 Q
"RTN","SDAUT2",58,0)
FTM S HT1="."_$P(GDATE,".",2)+.000001,HT2="."_TEMP+.000001,HT3="."_$P(NDATE,".",2)+.000001,HH1=$E(HT1,1,3),MM1=$E(HT1,4,5),HH2=$E(HT2,1,3),MM2=$E(HT2,4,5)
"RTN","SDAUT2",59,0)
 I MM2>MM1 S MM1=MM1+60,HH1=HH1-.01
"RTN","SDAUT2",60,0)
 S MMD=MM1-MM2,HDIF=HH1-HH2 Q
"RTN","SDAUT2",61,0)
FTM1 S HH3=$E(HT3,1,3),MM3=$E(HT3,4,5)
"RTN","SDAUT2",62,0)
 I MMD>MM3 S MM3=MM3+60,HH3=HH3-.01
"RTN","SDAUT2",63,0)
 S MMD2=MM3-MMD,HH3=HH3-HDIF,NTIM=HH3_MMD2,NTIM=+NTIM
"RTN","SDAUT2",64,0)
 Q
"RTN","SDAUT2",65,0)
FTM3 S HH1="."_$E(SDTEST(XK),1,2),MM1=$E(SDTEST(XK),3,4),MM2=MM1+MMD S:MM2>59 MM2=MM2-60,HDIF=HDIF+.01 S HH2=HH1+HDIF,HH2=HH2*100 S:MM2>0 HH1=HH1+.01 S SDTEST(-(HH2))="" K SDTEST(XK)
"RTN","SDAUT2",66,0)
 Q
"RTN","SDAUT2",67,0)
NO W !,"THIS CLINIC IS MISSING THE INCREMENTS PER HOUR FIELD, CANNOT REBOOK",! K ^UTILITY($J,"I") Q
"RTN","SDAUT2",68,0)
 ;
"RTN","SDAUT2",69,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDAUT2",70,0)
 ; -- noshow event
"RTN","SDAUT2",71,0)
 I $D(SDNOSH) D NOSHOW^SDAMEVT(.SDATA,DFN,GDATE,SDSC,SDDA,0,SDABHDL)
"RTN","SDAUT2",72,0)
 ; -- cancel event
"RTN","SDAUT2",73,0)
 I '$D(SDNOSH) D CANCEL^SDAMEVT(.SDATA,DFN,GDATE,SDSC,SDDA,0,SDABHDL)
"RTN","SDAUT2",74,0)
 ; -- make appt evt
"RTN","SDAUT2",75,0)
 N NDATE,GDATE,A,SDCL,B,A8,SDCTRL,CNT,SDWH,SDCP,SDMSG,SDCTR K SDATA
"RTN","SDAUT2",76,0)
 D MAKE^SDAMEVT(DFN,SDTTM,SDSC,SDPL,0)
"RTN","SDAUT2",77,0)
 Q
"RTN","SDC")
0^7^B24772235
"RTN","SDC",1,0)
SDC ;MAN/GRR,ALB/LDB - CANCEL A CLINIC'S AVAILABILITY ; 3/2/05 2:11pm
"RTN","SDC",2,0)
 ;;5.3;Scheduling;**15,32,79,132,167,478**;Aug 13, 1993
"RTN","SDC",3,0)
 N SDATA,SDCNHDL ; for evt dvr
"RTN","SDC",4,0)
SDC1 K SDLT,SDCP S NOAP="" D LO^DGUTL
"RTN","SDC",5,0)
 S DIC=44,DIC(0)="MEQA",DIC("S")="I $P(^(0),""^"",3)=""C"",'$G(^(""OOS""))",DIC("A")="Select CLINIC NAME: " D ^DIC K DIC("S"),DIC("A") G:'$D(^SC(+Y,"SL")) END^SDC0
"RTN","SDC",6,0)
 S SC=+Y,SL=^("SL"),%DT="AEXF",%DT("A")="CANCEL '"_$P(Y,U,2)_"' FOR WHAT DATE: " D ^%DT K %DT G:Y<0 END^SDC0 ;NAKED REFERNCE - ^SC(IFN,"SL")
"RTN","SDC",7,0)
 S (SD,CDATE)=Y,%=$P(SL,U,6),SI=$S(%="":4,%<3:4,%:%,1:4),%=$P(SL,U,3),STARTDAY=$S($L(%):%,1:8) D NOW^%DTC S SDTIME=%
"RTN","SDC",8,0)
 K SDRE,SDIN,SDRE1 I $D(^SC(SC,"I")) S SDIN=+^("I"),SDRE=+$P(^("I"),"^",2),Y=SDRE D:Y DTS^SDUTL S SDRE1=$S(SDRE:" to "_Y,1:"")
"RTN","SDC",9,0)
 I $S('$D(SDIN):0,SDIN'>0!(SDIN>SD):0,SDRE'>SD&(SDRE):0,1:1) W !,*7,"Clinic is inactive ",$S('SDRE:"as of ",1:"from ") S Y=SDIN D DTS^SDUTL W Y,SDRE1 G SDC1
"RTN","SDC",10,0)
 I '$D(^SC(SC,"ST",SD,1)) S DH="" D B S ^SC(SC,"ST",SD,1)=$P("SU^MO^TU^WE^TH^FR^SA",U,DOW+1)_" "_$E(SD,6,7)_$J("",SI+SI-6)_DH,^(0)=SD G N
"RTN","SDC",11,0)
 I ^(1)["CANCELLED" W !,"APPOINTMENTS HAVE ALREADY BEEN CANCELLED",!,*7 S ANS="N",SDTIME="*",SDV1=$S($P(^SC(SC,0),"^",15):$P(^(0),"^",15),1:+$O(^DG(40.8,0))) K SDX G ASKL^SDC0 ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDC",12,0)
N I '$F(^SC(SC,"ST",SD,1),"[") K:^(1)?2U.E ^SC(SC,"ST",SD) W !,*7,"CLINIC DOES NOT MEET ON THAT DAY" G SDC1 ; KILLs node if not holiday
"RTN","SDC",13,0)
 I $O(^SC(SC,"S",SD))\1-SD W *7,!?5,"NO APPOINTMENTS SCHEDULED" S NOAP=1 G W
"RTN","SDC",14,0)
 W !,"FIRST, I'LL LIST THE EXISTING APPOINTMENTS",!
"RTN","SDC",15,0)
 K DUOUT,DTOUT D ^SDC1 I $D(DUOUT)!$D(DTOUT) D END^SDC0 Q
"RTN","SDC",16,0)
 I ^SC(SC,"ST",SD,1)["X" G ^SDC2
"RTN","SDC",17,0)
W S DH=0,%="" W !,"WANT TO CANCEL THE WHOLE DAY" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G W
"RTN","SDC",18,0)
 I %=1 G WP:$$COED^SDC4(SC,SD,SD+.2359,1),ALL
"RTN","SDC",19,0)
 Q:%<1
"RTN","SDC",20,0)
WP S %="" W !,"WANT TO CANCEL PART OF THE DAY" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G WP
"RTN","SDC",21,0)
 Q:(%-1)
"RTN","SDC",22,0)
F R !,"STARTING TIME: ",X:DTIME Q:U[X  D TC^SDC2 G F:Y<0 S FR=Y,ST=%
"RTN","SDC",23,0)
T R !,"ENDING TIME: ",X:DTIME Q:U[X  D TC^SDC2 G T:Y<0 S SDHTO=X,TO=Y I TO'>FR W !,"Ending time must be greater than starting time",*7 G T
"RTN","SDC",24,0)
 I $$COED^SDC4(SC,FR,TO,1) K FR,SDHTO,TO,ST W ! G F
"RTN","SDC",25,0)
ROPT R !,"Reason for cancellation:  ",I:DTIME I I?1"?".E W !,"YOU MAY ENTER A MESSAGE CONCERNING THE CANCELLATION HERE" G ROPT
"RTN","SDC",26,0)
 N CANREM S CANREM=I
"RTN","SDC",27,0)
 Q:I["^"  I '$D(^SC(SC,"SDCAN",0)) S ^SC(SC,"SDCAN",0)="^44.05D^"_FR_"^1" G SKIP
"RTN","SDC",28,0)
 S A=^SC(SC,"SDCAN",0),SDCNT=$P(A,"^",4),^SC(SC,"SDCAN",0)=$P(A,"^",1,2)_"^"_FR_"^"_(SDCNT+1)
"RTN","SDC",29,0)
SKIP S ^SC(SC,"SDCAN",FR,0)=FR_"^"_SDHTO
"RTN","SDC",30,0)
 S NOAP=$S($O(^SC(SC,"S",(FR-.0001)))'>0:1,$O(^SC(SC,"S",(FR-.0001)))>TO:1,1:0) I 'NOAP S NOAP=$S($O(^SC(SC,"S",+$O(^SC(SC,"S",(FR-.0001))),0))="MES":1,1:0)
"RTN","SDC",31,0)
 S ^SC(SC,"S",FR,0)=FR,^("MES")="CANCELLED UNTIL "_X_$S(I?.P:"",1:" ("_I_")") D S S I=^(1),I=I_$J("",%-$L(I)),Y=""
"RTN","SDC",32,0)
 F X=0:2:% S DH=$E(I,X+SI+SI),P=$S(X<ST:DH_$E(I,X+1+SI+SI),X=%:$S(Y="[":Y,1:DH)_$E(I,X+1+SI+SI),1:$S(Y="["&(X=ST):"]",1:"X")_"X"),Y=$S(DH="]":"",DH="[":DH,1:Y),I=$E(I,1,X-1+SI+SI)_P_$E(I,X+2+SI+SI,999)
"RTN","SDC",33,0)
 S:'$F(I,"[") I5=$F(I,"X"),I=$E(I,1,(I5-2))_"["_$E(I,I5,999) K I5
"RTN","SDC",34,0)
 S DH=0,^(1)=I,FR=FR-.0001 G C ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDC",35,0)
S S ^("CAN")=^SC(SC,"ST",SD,1) Q
"RTN","SDC",36,0)
 ;
"RTN","SDC",37,0)
ALL N CANREM
"RTN","SDC",38,0)
 W !,"Reason for cancellation: " R CANREM:DTIME I $L(CANREM)>160!($L(CANREM)<3) W !,*7,"Reason must be between 3 to 160 characters long",! G ALL
"RTN","SDC",39,0)
 D S S ^(1)="   "_$E(SD,6,7)_"    **CANCELLED**",FR=SD,TO=SD+.9 ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDC",40,0)
C S FR=$O(^SC(SC,"S",FR)) I FR<1!(FR'<TO) W !!,"CANCELLED!  " K SDX G CHKEND^SDC0
"RTN","SDC",41,0)
 N TDH,TMPD,DIE,DR
"RTN","SDC",42,0)
 F I=0:0 S I=$O(^SC(SC,"S",FR,1,I)) Q:I'>0  D
"RTN","SDC",43,0)
 .S DFN=+^SC(SC,"S",FR,1,I,0),SDCNHDL=$$HANDLE^SDAMEVT(1)
"RTN","SDC",44,0)
 .D BEFORE^SDAMEVT(.SDATA,DFN,FR,SC,I,SDCNHDL)
"RTN","SDC",45,0)
 .S $P(^SC(SC,"S",FR,1,I,0),"^",9)="C"
"RTN","SDC",46,0)
 .S SDSC=SC,SDTTM=FR,SDPL=I,TDH=DH,TMPD=CANREM D CANCEL^SDCNSLT S DH=TDH ;SD/478
"RTN","SDC",47,0)
 .I $D(^DPT(DFN,"S",FR,0)),$P(^(0),"^",2)'["C" S $P(^(0),"^",2)="C",$P(^(0),"^",12)=DUZ,$P(^(0),"^",14)=SDTIME,DH=DH+1,TDH=DH,DIE="^DPT(DFN,"_"""S"""_",",DR="17///^S X=CANREM",DA=FR D ^DIE S DH=TDH D MORE
"RTN","SDC",48,0)
 G C
"RTN","SDC",49,0)
 ;
"RTN","SDC",50,0)
B S X=SD D DOW^SDM0 S DOW=Y,SS=+$O(^SC(SC,"T"_Y,X)) I $D(^(SS,1)),^(1)]"" S DH=^(1),DO=X+1,DA(1)=SC
"RTN","SDC",51,0)
 Q
"RTN","SDC",52,0)
MORE I $D(^SC("ARAD",SC,FR,DFN)) S ^(DFN)="N"
"RTN","SDC",53,0)
 S SDIV=$S($P(^SC(SC,0),"^",15)]"":$P(^(0),"^",15),1:" 1"),SDV1=$S(SDIV:SDIV,1:+$O(^DG(40.8,0))) I $D(^DPT("ASDPSD","C",SDIV,SC,FR,DFN)) K ^(DFN)
"RTN","SDC",54,0)
 S SDH=DH,SDTTM=FR,SDSC=SC,SDPL=I,SDRT="D" D RT^SDUTL
"RTN","SDC",55,0)
 S DH=SDH K SDH D CK1,EVT
"RTN","SDC",56,0)
 K SD1,SDIV,SDPL,SDRT,SDSC,SDTTM,SDX Q
"RTN","SDC",57,0)
CK1 S SDX=0 F SD1=FR\1:0 S SD1=$O(^DPT(DFN,"S",SD1)) Q:'SD1!((SD1\1)'=(FR\1))  I $P(^(SD1,0),"^",2)'["C",$P(^(0),"^",2)'["N" S SDX=1 Q
"RTN","SDC",58,0)
 Q:SDX  F SD1=2,4 I $D(^SC("AAS",SD1,FR\1,DFN)) S SDX=1 Q
"RTN","SDC",59,0)
 Q:SDX  IF $D(^SCE(+$$EXAE^SDOE(DFN,FR\1,FR\1),0)) S SDX=1
"RTN","SDC",60,0)
 Q:SDX  K ^DPT("ASDPSD","B",SDIV,FR\1,DFN) Q
"RTN","SDC",61,0)
 ;
"RTN","SDC",62,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDC",63,0)
 ; -- cancel event
"RTN","SDC",64,0)
 N FR,I,SDTIME,DH,SC
"RTN","SDC",65,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SDTTM,SDSC,SDPL,0,SDCNHDL) K SDATA,SDCNHDL
"RTN","SDC",66,0)
 Q
"RTN","SDC0")
0^25^B26494152
"RTN","SDC0",1,0)
SDC0 ;MAN/GRR,ALB/TMP/LDB - Continuation of SDC (cancel a clinic) ; 16 JUL 2003  1:27 pm
"RTN","SDC0",2,0)
 ;;5.3;Scheduling;**303,330,379,398,467,478**;Aug 13, 1993
"RTN","SDC0",3,0)
 ;
"RTN","SDC0",4,0)
 ;SD/467 - open matched EWL entries with canceled appointments
"RTN","SDC0",5,0)
 ;
"RTN","SDC0",6,0)
CHKEND G:NOAP END
"RTN","SDC0",7,0)
 S %=1,DTOUT=0 W !,"WANT TO AUTO-REBOOK APPOINTMENTS NOW" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G CHKEND
"RTN","SDC0",8,0)
 S ANS=$S('(%-1):"Y",1:"N") I %<0 W " NO" Q:'DTOUT
"RTN","SDC0",9,0)
ASKL S SDLT1="",%=1,(SDLET,SDFORM)="" W !,"WANT LETTERS PRINTED NOW" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G ASKL
"RTN","SDC0",10,0)
 W:%<0 " NO" S ALS=$S('(%-1):"Y",1:"N") G:ALS'["Y" AOR
"RTN","SDC0",11,0)
EN Q:($P(^SC(SC,0),"^",3)'="C")!($D(SDVAUTC(+SC)))  S SDIV=$P(^SC(SC,0),"^",15),SDIV=$S(SDIV:SDIV,1:$O(^DG(40.8,0))) I $D(SDLT),SDIV'=SDV1 Q
"RTN","SDC0",12,0)
 K SDRE,SDIN I $D(SDLT)&($D(^SC(SC,"I"))) S SDIN=+^("I"),SDRE=+$P(^("I"),"^",2) I $D(SDIN),SDIN,SDIN'>SDBD&('$D(SDRE)!('SDRE)!(SDRE>SDED)) Q
"RTN","SDC0",13,0)
 S:'SDLT1 SDLET=$S($D(^SC(SC,"LTR")):$P(^("LTR"),"^",3),1:"") S ALS=$S(SDLET:"Y",1:"N")
"RTN","SDC0",14,0)
 I ALS="N"!(ANS="Y") S SDFFFF=1
"RTN","SDC0",15,0)
 I ALS="N" W !,"NO LETTERS ARE ASSIGNED TO THE ",$P(^SC(SC,0),"^")," CLINIC" Q:$D(SDLT)
"RTN","SDC0",16,0)
 I SDFORM="",$D(^DG(40.8,SDIV,"LTR")),^("LTR") S SDFORM=^("LTR")
"RTN","SDC0",17,0)
 I $D(SDLT),(ALS'="N") D CHK Q
"RTN","SDC0",18,0)
 Q:$D(SDLT)
"RTN","SDC0",19,0)
AOR G:ANS'["Y"&(ALS'["Y") END
"RTN","SDC0",20,0)
 I '$D(SDLT) S DGPGM="START^SDC0",DGVAR="SC^SI^CDATE^ALS^ANS^SDLET^SDTIME"_$S($D(SDIN):"^SDIN^SDRE",1:"")_"^SDFORM^SDV1^SDFFFF^AUTO#"
"RTN","SDC0",21,0)
 I '$D(SDLT) D FZIS^DGUTQ G:POP END
"RTN","SDC0",22,0)
START U IO I ANS'["Y"&('$D(SDLT)) D:ALS["Y" APP D END Q
"RTN","SDC0",23,0)
BEG1 N SDFIRST
"RTN","SDC0",24,0)
 I $D(SDLT) S SDAR=$S('VAUTC:"VAUTC",1:"^SC"),ANS="N",ALS="Y" D
"RTN","SDC0",25,0)
 .F SC=0:0 S SC=$O(@(SDAR_"("_SC_")")) Q:SC'>0  D
"RTN","SDC0",26,0)
 ..K SDOK1 D EN I $D(SDOK1),SDLET D
"RTN","SDC0",27,0)
 ...F SD=(SDBD-.1):0 S SD=$O(^SC(SC,"S",SD)) S CDATE=SD Q:SD>(SDED+.999999)!(SD'>0)  D
"RTN","SDC0",28,0)
 ....D DUP
"RTN","SDC0",29,0)
 S SDFIRST=$S($G(SDFFFF)=1:0,1:1)
"RTN","SDC0",30,0)
 I $D(SDLT),$D(^UTILITY("SDLT",$J)) D PR^SDC3,END Q
"RTN","SDC0",31,0)
 Q:$D(SDLT)  D ^SDAUT1
"RTN","SDC0",32,0)
 I MAX=0 W !,"AUTO-REBOOKING NOT ALLOWED FOR THIS CLINIC" G APP:ALS["Y",END
"RTN","SDC0",33,0)
 F GDATE=CDATE:0 S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  F L=0:0 S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  S A=^(L,0) I $D(^DPT(+A,"S",GDATE,0)),$P(^(0),"^",2)="C",$P(^(0),"^",14)=SDTIME D ^SDAUT2,^SDCCP
"RTN","SDC0",34,0)
 D:ALS["Y" APP
"RTN","SDC0",35,0)
END ;
"RTN","SDC0",36,0)
 D:$G(SC)>0&($G(CDATE)>0) RESOLVE
"RTN","SDC0",37,0)
 K %,%DT,%H,%I,%DT,%IS,%ZIS,A,ALS,ANS,BY,CDATE,CHAR,DA,DFN,DH,DHD,DIC,DIS,DO,DOW,FLDS,FR,GDATE,I,L,LET,MAX,NOAP,P,POP,SI,SL,SS,ST,SDSTRTDT,TO,X,Y,ADDR,B,CLIN,HX,L0,L1,L2,LL,PDAT,S,TIME,Z,D,ENDATE,J,SM,STIME,X1,X2,SDX1,SDX2,SDRE,SDRE1,SDIN,FSW
"RTN","SDC0",38,0)
 K ^TMP("SDC0",$J),SDAP,SDAPNUM
"RTN","SDC0",39,0)
 K SC,SD,Z0,Z5,DGPGM,DUPE,J2,MESS,NDATE,SDDIF,SDFORM,SDINP,SDFORM,SDLET,SDLT1,SDNODE,SDRT,SDSOH,SDST,SDV1,DGVAR,SD1,SD8,SD81,SDANS,SDCNT,SDERR,SDHTO,SDJ,SDTIME,SDZ,STARTDAY,SD82,SDOK,SDOK1,SDLE,SDZ,SDOK1,TST,W,^UTILITY("SD")
"RTN","SDC0",40,0)
 K SDFFFF,DIW,DIWF,DIWL,DIWR,DIWT,DN,DUPE,J2,MESS,NDATE,SDADD,SDC,SDCL,SDDAT,SDDIF,SDFORM,SDHX,SDINP,SDIV,SDLET,SDNODE,SDRT,SDSOH,SDST,SDT0,TST,SDV1,^TMP($J,"BADADD") D CLOSE^DGUTQ Q
"RTN","SDC0",41,0)
CHK K SDOK1 I $D(^SC(SC,"SL")) S SL=^("SL"),%=$P(SL,"^",6),SI=$S(%="":4,%<3:4,%:%,1:4) S SDOK1=1 K SL,% E  W $P(^SC(SC,0),"^")," does not have an appointment length indicated."
"RTN","SDC0",42,0)
 Q
"RTN","SDC0",43,0)
RESOLVE ;evaluate canceled and rebooked appointments with relation to EWL
"RTN","SDC0",44,0)
 S GDATE=CDATE K ^TMP("SDWLREB",$J),^TMP($J,"SDWLPL")
"RTN","SDC0",45,0)
 F  S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  S L=0 F  S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  D
"RTN","SDC0",46,0)
 .S DFN=+^SC(SC,"S",GDATE,1,L,0)
"RTN","SDC0",47,0)
 .N RBFLG,SDTRB,SDCAN,SDREB S SDREB=0 D REBOOK^SDWLREB(DFN,GDATE,SC,.RBFLG,.SDTRB,.SDCAN) Q:SDCAN'=SDTIME
"RTN","SDC0",48,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDC0",49,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDC0",50,0)
 .D OPENEWL^SDWLREB(DFN,GDATE,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDC0",51,0)
 I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDC0",52,0)
 Q
"RTN","SDC0",53,0)
 ;
"RTN","SDC0",54,0)
DUP ;SCREEN FOR DUPLICATE PATIENTS - SD*5.3*379
"RTN","SDC0",55,0)
 S SDAP="" F  S SDAP=$O(^SC(SC,"S",SD,SDAP)) Q:SDAP=""  D
"RTN","SDC0",56,0)
 .S SDAPNUM="" F  S SDAPNUM=$O(^SC(SC,"S",SD,SDAP,SDAPNUM)) Q:SDAPNUM=""  D
"RTN","SDC0",57,0)
 ..I $D(^SC(SC,"S",SD,SDAP,SDAPNUM,0)) D
"RTN","SDC0",58,0)
 ...S A=$P(^SC(SC,"S",SD,SDAP,SDAPNUM,0),"^",1)
"RTN","SDC0",59,0)
 ...I '$D(^TMP("SDC0",$J,SD,A)) S ^TMP("SDC0",$J,SD,A)="" D ^SDC3
"RTN","SDC0",60,0)
 Q
"RTN","SDC0",61,0)
APP I $G(SDFFFF)=1 S SDFIRST=0
"RTN","SDC0",62,0)
 F GDATE=CDATE:0 S GDATE=$O(^SC(+SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  F L=0:0 S L=$O(^SC(+SC,"S",GDATE,1,L)) Q:L=""  S A=^(L,0) D CHECK
"RTN","SDC0",63,0)
 I $D(^TMP($J,"BADADD")) D BADADD^SDLT K ^TMP($J,"BADADD")
"RTN","SDC0",64,0)
 Q
"RTN","SDC0",65,0)
CHK1 S (SDX,X)=GDATE D WRAPP^SDLT
"RTN","SDC0",66,0)
 I $P(S,"^",2)'["A" D REST^SDLT Q
"RTN","SDC0",67,0)
 S SDX=$P(S,"^",10) I '$D(^DPT(+A,"S",SDX,0)) D REST^SDLT Q
"RTN","SDC0",68,0)
 W !!,"The cancelled appointment(s) were rescheduled as follows:",!
"RTN","SDC0",69,0)
 S S=^DPT(+A,"S",SDX,0) D WRAPP^SDLT,REST^SDLT
"RTN","SDC0",70,0)
 Q
"RTN","SDC0",71,0)
CHECK I $$BADADR^DGUTL3(+A) S ^TMP($J,"BADADD",$P(^DPT(+A,0),"^"),+A)="" Q
"RTN","SDC0",72,0)
 ;
"RTN","SDC0",73,0)
 ;SCREEN FOR DUPLICATES - SD*5.3*379
"RTN","SDC0",74,0)
 ;
"RTN","SDC0",75,0)
 I $D(^TMP("SDC0",$J,GDATE,A)) Q
"RTN","SDC0",76,0)
 S ^TMP("SDC0",$J,GDATE,A)=""
"RTN","SDC0",77,0)
 I $S('$D(^DPT(+A,.35)):1,$P(^DPT(+A,.35),"^",1)']"":1,1:0),$D(^DPT(+A,"S",GDATE)),$P(^DPT(+A,"S",GDATE,0),"^",2)["C",$P(^(0),"^",14)=SDTIME!(SDTIME="*") S S=^DPT(+A,"S",GDATE,0) D ^SDLT,CHK1
"RTN","SDC1")
0^8^B5430963
"RTN","SDC1",1,0)
SDC1 ;ALB/GRR - PRINT CLINIC PRE-CANCELLATION LIST ; 6/30/05 10:15am
"RTN","SDC1",2,0)
 ;;5.3;Scheduling;**379,398,439,478**;Aug 13, 1993
"RTN","SDC1",3,0)
 K ^TMP("SDC1",$J) S DGVAR="SD^SC^SDTIME",DGPGM="START^SDC1" D ZIS^DGUTQ Q:POP
"RTN","SDC1",4,0)
START U IO S SDCNT=0 K DUOUT,DTOUT N SDBADD,SNODE S SDBADD=0,SNODE=""
"RTN","SDC1",5,0)
 ; sd*5.3*439 FOR loop changed to exclude if different clinic
"RTN","SDC1",6,0)
 F J=SD:0 S J=$O(^SC(SC,"S",J)) Q:J=""!(J\1-SD)!$D(DTOUT)!$D(DUOUT)  D
"RTN","SDC1",7,0)
 . S J2=0 F  S J2=$O(^SC(SC,"S",J,1,J2)) Q:J2=""!$D(DTOUT)!$D(DUOUT)  D
"RTN","SDC1",8,0)
 .. S DFN=+^SC(SC,"S",J,1,J2,0),SDLE=$P(^(0),U,2)
"RTN","SDC1",9,0)
 .. Q:'$D(^DPT(DFN,"S",J,0))  S SNODE=^(0)
"RTN","SDC1",10,0)
 .. Q:$P(SNODE,U,1)'=SC&($P(SNODE,U,14)'=SDTIME)
"RTN","SDC1",11,0)
 .. I $P(SNODE,U,2)'["C"!($P(SNODE,U,14)=SDTIME) D PLST Q:$D(DTOUT)!$D(DUOUT)
"RTN","SDC1",12,0)
 G:$D(DUOUT)!$D(DTOUT) EXIT  I SDCNT=0 S NOAP=1 W !,"NO APPOINTMENTS SCHEDULED"
"RTN","SDC1",13,0)
 I SDBADD D
"RTN","SDC1",14,0)
 . W !!,"* THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDC1",15,0)
 . W !,"WILL BE PRINTED."
"RTN","SDC1",16,0)
 I $E(IOST,1,2)'="C-" W @IOF
"RTN","SDC1",17,0)
EXIT K DUOUT,DTOUT,I,J,J2,X,DFN,SNODE,SDLE,SDCNT,^TMP("SDC1",$J) W !! D CLOSE^DGUTQ Q  ; sd*5.3*439 added local vars to kill
"RTN","SDC1",18,0)
PLST I SDCNT=0!($Y+2>IOSL) S DIR(0)="E" D:$E(IOST,1,2)="C-" ^DIR K DIR Q:$D(DTOUT)!$D(DUOUT)  D HED
"RTN","SDC1",19,0)
 ;
"RTN","SDC1",20,0)
 ;CHECK FOR DUPICATE ENTRY IN FILE 44 - SD*5.3*379
"RTN","SDC1",21,0)
 ;
"RTN","SDC1",22,0)
 I $D(^TMP("SDC1",$J,J,DFN)) Q
"RTN","SDC1",23,0)
 S ^TMP("SDC1",$J,J,DFN)=""
"RTN","SDC1",24,0)
 ;
"RTN","SDC1",25,0)
 N VA D PID^VADPT6
"RTN","SDC1",26,0)
 N CSLNK S CSLNK=$P($G(^SC(SC,"S",J,1,J2,"CONS")),U) ;SD/478
"RTN","SDC1",27,0)
 W ! I $$BADADR^DGUTL3(+DFN) W "*" S SDBADD=1
"RTN","SDC1",28,0)
 W $P(^DPT(DFN,0),"^",1),?30,VA("PID") S X=J D TM^SDROUT0 W ?43,$J(X,8),?52,$S(CSLNK'="":"CONS",1:""),?58,SDLE W:$D(^DPT(DFN,.13)) ?64,$P(^(.13),"^",1) ;SD/478
"RTN","SDC1",29,0)
 S SDCNT=SDCNT+1 Q
"RTN","SDC1",30,0)
HED W @IOF,!,$P(^SC(SC,0),"^",1)," Clinic Pre-cancellation list",!,"PATIENT NAME",?34,"ID",?43,"APPT TIME",?56,"LENGTH",?64,"TELEPHONE"
"RTN","SDC1",31,0)
 W ! F I=1:1:79 W "-"
"RTN","SDC1",32,0)
 Q
"RTN","SDCNP")
0^9^B16969835
"RTN","SDCNP",1,0)
SDCNP ;ALB/LDB - CANCEL SINGLE OR MULTIPLE APPOINTMENTS FOR PATIENT ; 3/2/05 2:33pm
"RTN","SDCNP",2,0)
 ;;5.3;Scheduling;**32,116,478**;Aug 13, 1993
"RTN","SDCNP",3,0)
 K ORACTION
"RTN","SDCNP",4,0)
RD G END:$D(ORACTION)!($D(SDAMTYP)) S DIC="^DPT(",DIC(0)="AEQM" D ^DIC G:X=""!(X="^") END I Y<0 W !,*7,*7,"PATIENT NOT FOUND",*7,*7 G RD
"RTN","SDCNP",5,0)
 S (DA,DFN)=+Y,NAME=$P(Y,"^",2)
"RTN","SDCNP",6,0)
EN D DT^SDUTL:'$D(DT) S HDT=DT,APL="" D NOW^%DTC S (SDTM,HDT)=$J(%,".",4),(SDERR,CNT)=0
"RTN","SDCNP",7,0)
SEL R !,"DO YOU WANT TO CANCEL (P)AST OR (F)UTURE APPOINTMENTS? F// ",X9:DTIME G:X9["^"!('$T) END S:X9="" X9="F" S X9=$$UP^XLFSTR(X9) I "FP"'[X9!(X9["?") W !,"Enter a P to cancel past appointments or F to cancel future appointments" G SEL
"RTN","SDCNP",8,0)
 S SDPV=$S(X9=""!(X9["F"):"",1:1)
"RTN","SDCNP",9,0)
 S SDERR=0 W ! I ('$O(^DPT(DFN,"S",$P(SDTM,".")))&'SDPV)!(SDPV&($O(^DPT(DFN,"S",0))'<SDTM)) G NO^SDCNP0
"RTN","SDCNP",10,0)
STAT R !,"APPOINTMENTS CANCELLED BY (P)ATIENT OR BY (C)LINIC? P// ",SDWH:DTIME G:SDWH="^"!('$T) END S SDWH=$$UP^XLFSTR(SDWH) I SDWH'="",SDWH'["P",SDWH'["C" W !,"Enter a P for by Patient or a C for by Clinic" G STAT
"RTN","SDCNP",11,0)
 S SDWH=$S(SDWH["P":"PC",SDWH="":"PC",1:"C"),SDCP=$S(SDWH="C":0,1:1)
"RTN","SDCNP",12,0)
RSN S SDSCRPC=$S(SDWH["P":"P",1:"C"),DIC="^SD(409.2,",DIC(0)="AEQM",DIC("S")="I '$P(^(0),U,4),(SDSCRPC_""B""[$P(^(0),U,2))" D ^DIC G:X="^" END S SDSCR=$S(X="":X,1:+Y) K SDSCRPC,DIC I X="" G RSN
"RTN","SDCNP",13,0)
REM R !,"CANCELLATION REMARKS: ",SDREM:DTIME G:SDREM["^"!('$T) END G:SDREM="" W  ;SD/478
"RTN","SDCNP",14,0)
 S TMPD=SDREM ;SD/478
"RTN","SDCNP",15,0)
 I $L(SDREM)<3!($L(SDREM)>160)!(SDREM?."?") W !,*7,"Must be 3 to 160 characters in length" G REM
"RTN","SDCNP",16,0)
 I SDREM'?.ANP W !,*7,"NO CONTROL CHARACTERS" G REM
"RTN","SDCNP",17,0)
W K Z,Z1,ZX W !!,"READY TO CANCEL ",$S('SDPV:"PENDING",1:"PREVIOUS")," APPTS",!
"RTN","SDCNP",18,0)
DATE I SDPV S %DT="AEXP",%DT("A")="DISPLAY APPTS STARTING WITH DATE: FIRST// " S %DT(0)="-NOW" D ^%DT G:X["^" END S HDT=$S(Y>0:Y,1:0) K %DT
"RTN","SDCNP",19,0)
 G ^SDCNP0
"RTN","SDCNP",20,0)
END D END^SDAUT2 K %,%DT,%H,%I,%Y,A,A1,A2,A8,A9,B,ADDR,DTOUT,ANS,APL,APP,APPZ,AT,CNT,C,CDATE,CHAR,CLIN,CNN,COMMENT,COV,D0,DA,DATE,DGPGM,DGVAR,DI,DIC,DIE,DIPGM,DIV,DK,DL,DOW,DR,DUPE,ENDATE,GDATE,HDT,HSI,I,J,L,L1,L5,LL,NAME,NDT,NDATE,M1,M8,MAX
"RTN","SDCNP",21,0)
 K PDAT,POP,Q,Q1,S,S1,S2,S3,S5,S9,SD0,SD2,SB,SC,SD,SDA,SDAP,SD1,SDCL,SDCP,SDCNT,SDCNT1,SDCTR,SDCTRL,SDDH,SDDI,SDDIF,SDDK,SDDM,SDDT,SDDT1,SDEND,SDERR,SDFOR,SDINP,SDIO,SDJ,SDJ1,SDLET,SDLN,SDLN1,SDLN2,SDMSG,SDMDT,SDNODE,SDP,SDP1,SDPV,SDPT,SDPRT,SDR
"RTN","SDCNP",22,0)
 K A0,A1,A3,A5,ALL,SDREM,SDS,SDRT,SDTADE,SDTADB,SDPRT,SDSCR,SDSOH,SDA,SDT,SDTH,SDT1,SDTTM,SDX,SDX1,SDV,SDV2,SL,SM,STARTDAY,STIME,STR,TIME,SDTM,SDWH,SDXX,X1,X3,X8,X9,SI,SS,ST,SDSTRTDT,X,Y,Z,Z0,Z1,Z5,Z6,Z7,Z9,ZL,ZX,^UTILITY($J)
"RTN","SDCNP",23,0)
 K MESS,MIN,DIW,DIWF,DIWL,DIWR,DIWT,DN,DQ,L0,SDADD,SDC,SDDAT,SDHX,SDT0,SD20,TST,TMPD Q
"RTN","SDCNP",24,0)
OERR S XQORQUIT=1 Q:'$D(ORVP)  S (DA,DFN)=+ORVP,NAME=$S($D(^DPT(DFN,0)):$P(^(0),"^",1),1:"") D EN N PAUSE W !,"Press Return to continue: " R PAUSE:DTIME K PAUSE Q
"RTN","SDCNP0")
0^10^B29432577
"RTN","SDCNP0",1,0)
SDCNP0 ;ALB/LDB - CANCEL APPT. FOR A PATIENT ; 3/2/05 3:13pm
"RTN","SDCNP0",2,0)
 ;;5.3;Scheduling;**132,167,478**;Aug 13, 1993
"RTN","SDCNP0",3,0)
EN2 D WAIT^DICD S NDT=HDT/1,L=0 F J=1:1 S NDT=$O(^DPT(DFN,"S",NDT)) Q:NDT'>0!(SDPV&(NDT'<SDTM))  S SD0=^(NDT,0) I $P(SD0,"^",2)'["C" S SC=+SD0,L=L\1+1,APL="" D FLEN^SDCNP1A S ^UTILITY($J,"SDCNP",L)=NDT_"^"_SC_"^"_COV_"^"_APL_"^^"_APL D CHKSO
"RTN","SDCNP0",4,0)
WH1 G:L'>0 NO S (SDCTRL,SDCTR)=0,APP="" W:'SDERR @IOF
"RTN","SDCNP0",5,0)
 W ! F Z=0:0 S Z=$O(^UTILITY($J,"SDCNP",Z)) Q:Z'>0  W !,$J($S(Z\1=Z:"("_$J(Z,2)_") ",1:""),5) S AT=$S($P(^(Z),"^",2)'?.N:1,1:0),Y=$P($P(^(Z),"^"),".") D DT^SDM0 S X=$P(^(Z),"^"),^(Z,"CNT")="" X ^DD("FUNC",2,1) W " ",$J(X,8) D MORE Q:SDCTRL
"RTN","SDCNP0",6,0)
 S:SDERR SDCTRL=1 I Z>0 G:SDCTRL&(APP']"") NOPE^SDCNP1 G:SDCTRL DEL
"RTN","SDCNP0",7,0)
 D WH G NOPE^SDCNP1:APP']"",DEL
"RTN","SDCNP0",8,0)
WH W !!,"SELECT APPOINTMENTS TO BE CANCELLED" W:Z>0 " OR HIT RETURN TO CONTINUE DISPLAY" R ": ",APP:DTIME I '$T!(APP="^") S SDCTRL=1,APP="" Q
"RTN","SDCNP0",9,0)
 S SDMSG="W !,""Enter appt. numbers separated by commas and/or a range separated"",!,""by dashes (ie 2,4,6-9)"" H 2" I APP["?" X SDMSG G WH
"RTN","SDCNP0",10,0)
 S SDCTRL=$S(APP']"":0,1:1) Q
"RTN","SDCNP0",11,0)
DEL S SDERR=0 F J=1:1 S SDDH=$P(APP,",",J) Q:SDDH']""  D MTCH^SDCNP1
"RTN","SDCNP0",12,0)
 G:SDERR WH1
"RTN","SDCNP0",13,0)
DEL1 F J=1:1 S SDDH=$P(APP,",",J) Q:SDDH']""  S SDDI=$P(SDDH,"-"),SDDM=$P(SDDH,"-",2) D CKK^SDCNP1A Q:SDERR  D CKK1^SDCNP1A Q:SDERR  Q:'SDDI  F A1=SDDI:1:$S(SDDM:SDDM,1:SDDI) D BEGD
"RTN","SDCNP0",14,0)
 G:SDERR WH1 G NOPE^SDCNP1
"RTN","SDCNP0",15,0)
BEGD S (SD,S)=$P(^UTILITY($J,"SDCNP",A1),"^",1),I=$P(^UTILITY($J,"SDCNP",A1),"^",2)
"RTN","SDCNP0",16,0)
 S SL=^SC(I,"SL"),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y
"RTN","SDCNP0",17,0)
 I $$CODT^SDCOU(DFN,+^UTILITY($J,"SDCNP",A1),+$P(^(A1),U,2)) W !,*7,">>> Appointment #",A1," has a check out date and cannot be cancelled." Q
"RTN","SDCNP0",18,0)
 D PROT^SDCNP1A Q:SDPRT=1  D CAN S $P(^UTILITY($J,"SDCNP",A1),"^",4)="*** JUST CANCELLED ***" Q
"RTN","SDCNP0",19,0)
CAN Q:$P(^UTILITY($J,"SDCNP",A1),"^",4)["JUST CANCELLED"  S CNT=CNT+1,DIV=$S($P(^SC(I,0),"^",15)]"":" "_$P(^(0),"^",15),1:" 1") I $D(^DPT("ASDPSD","C",DIV,I,S,DFN)) K ^(DFN)
"RTN","SDCNP0",20,0)
 N SDATA,SDCPHDL S SDCPHDL=$$HANDLE^SDAMEVT(1) D BEFORE^SDAMEVT(.SDATA,DFN,S,I,"",SDCPHDL)
"RTN","SDCNP0",21,0)
 S:'$D(^DPT(DFN,"S",0)) ^(0)="^2.98P^^" I $D(SDREM) S DIE="^DPT("_DFN_",""S"",",(DA,Y)=S,DA(1)=DFN,DR="17///^S X="_"""""_SDREM_""""" D ^DIE K DIE,DR
"RTN","SDCNP0",22,0)
 S ^DPT("ASDCN",I,DA,DA(1))=$S(SDWH["P":1,1:"") K DA
"RTN","SDCNP0",23,0)
 S $P(^DPT(DFN,"S",S,0),"^",2)=SDWH S:$D(DUZ) $P(^(0),"^",12)=DUZ D NOW^%DTC S SDT=$J(%,2,4),$P(^(0),"^",14)=SDT,$P(^(0),"^",15)=SDSCR,(DA,Y)=0 F X=0:0 S X=+$O(^SC(I,"S",S,1,X)) Q:'$D(^(X,0))  D C Q:Y&(DA)
"RTN","SDCNP0",24,0)
 I $D(^DPT("ASDPSD","B",DIV,S\1,DFN)) D CK1
"RTN","SDCNP0",25,0)
 Q:'Y  S SL=$P(^SC(I,"S",S,1,Y,0),U,2) I DA,'$D(^("OB")) K ^SC(I,"S",S,1,DA,"OB")
"RTN","SDCNP0",26,0)
 S SDDA=DA,SDTTM=S,SDRT="D",SDPL=Y,SDSC=I D RT^SDUTL D CANCEL^SDCNSLT S Y=SDPL,S=SDTTM,I=SDSC,DA=SDDA K SDDA ;SD/478
"RTN","SDCNP0",27,0)
 S SDNODE=^SC(I,"S",S,1,Y,0),^SC("ARAD",I,S,DFN)="N",TLNK=$P($G(^SC(I,"S",S,1,Y,"CONS")),U) K ^SC(I,"S",S,1,Y) K:$O(^SC(I,"S",S,0))'>0 ^SC(I,"S",S,0) D CLRK^SDCNP1  ;SD/478
"RTN","SDCNP0",28,0)
 K:TLNK'="" ^SC("AWAS1",TLNK),TLNK ;SD/478
"RTN","SDCNP0",29,0)
 ;S SDNODE=^SC(I,"S",S,1,Y,0),^SC("ARAD",I,S,DFN)="N" S DA(2)=I,DA(1)=S,DA=Y,DIK="^SC("_DA(2)_",""S"","_DA(1)_",1," D ^DIK K:$O(^SC(I,"S",S,0))'>0 ^SC(I,"S",S,0) D CLRK^SDCNP1 ;SD/478
"RTN","SDCNP0",30,0)
 D EVT
"RTN","SDCNP0",31,0)
 Q:'$D(^SC(I,"ST",SD\1,1))
"RTN","SDCNP0",32,0)
EN01 S S=^SC(I,"ST",SD\1,1),Y=SD#1-SB*100,ST=Y#1*SI\.6+(Y\1*SI),SS=SL*HSI/60
"RTN","SDCNP0",33,0)
 I Y'<1 F I=ST+ST:SDDIF S Y=$E(STR,$F(STR,$E(S,I+1))) Q:Y=""  S S=$E(S,1,I)_Y_$E(S,I+2,999),SS=SS-1 Q:SS'>0
"RTN","SDCNP0",34,0)
 S ^(1)=S Q  ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDCNP0",35,0)
C I +^SC(I,"S",S,1,X,0)=DFN S Y=X Q
"RTN","SDCNP0",36,0)
 Q:'$D(^("OB"))!DA  S:^("OB")?1"O".E DA=X Q
"RTN","SDCNP0",37,0)
NO W !,"NO ",$S('SDPV:"PENDING",1:"PREVIOUS")," APPOINTMENTS",*7,*7,*7
"RTN","SDCNP0",38,0)
 D END^SDCNP G RD^SDCNP
"RTN","SDCNP0",39,0)
 Q
"RTN","SDCNP0",40,0)
CHKSO S COV=$S($P(^DPT(DFN,"S",NDT,0),"^",11)=1:" (COLLATERAL) ",1:"") F SDJ=3,4,5 I $P(^DPT(DFN,"S",NDT,0),"^",SDJ)]"" S L=L+.1,^UTILITY($J,"SDCNP",L)=$P(^(0),"^",SDJ)_"^"_$S(SDJ=3:"LAB",SDJ=4:"XRAY",1:"EKG")_"^0^0"
"RTN","SDCNP0",41,0)
 Q
"RTN","SDCNP0",42,0)
MORE S SDCTR=SDCTR+2 I AT W ?41,$P(^UTILITY($J,"SDCNP",Z),"^",2) G OVR
"RTN","SDCNP0",43,0)
 W " ",$S($P(^UTILITY($J,"SDCNP",Z),"^",4)?.N:"("_$P(^(Z),"^",4)_" MIN) ",1:$P(^(Z),"^",4))," ",$S($D(^SC($P(^(Z),"^",2),0)):$P(^(0),"^",1),1:"DELETED CLINIC"),$P(^UTILITY($J,"SDCNP",Z),"^",3) ;SD/478
"RTN","SDCNP0",44,0)
 N CSND,CSDT,CSSD,CONSULT,Y
"RTN","SDCNP0",45,0)
 S CSND=^UTILITY($J,"SDCNP",Z),CSDT=$P(CSND,U),CSSD=$P(CSND,U,2) S CONSULT=$$CONSULT(CSSD,CSDT) I +$G(CONSULT) S Y=$P(^GMR(123,CONSULT,0),U) D DD^%DT W !?5,"CONSULT ",Y,"/ ",CONSULT
"RTN","SDCNP0",46,0)
 D STATUS($X>55)
"RTN","SDCNP0",47,0)
OVR I SDCTR>20,$O(^UTILITY($J,"SDCNP",Z)) S (SDCTRL,SDCTR)=0 W *7 D WH W:'SDCTRL @IOF
"RTN","SDCNP0",48,0)
 Q
"RTN","SDCNP0",49,0)
CONSULT(CSSD,CSDT) ;
"RTN","SDCNP0",50,0)
 N CSI S CONSULT=""
"RTN","SDCNP0",51,0)
 S CSI=0 F  S CSI=$O(^SC(CSSD,"S",CSDT,1,CSI)) Q:'+CSI  I $P($G(^SC(CSSD,"S",CSDT,1,CSI,0)),U)=DFN S CONSULT=$P($G(^SC(CSSD,"S",CSDT,1,CSI,"CONS")),U) Q  ;SD/478
"RTN","SDCNP0",52,0)
 Q CONSULT
"RTN","SDCNP0",53,0)
CK1 S SDX=0 F SD1=S\1:0 S SD1=$O(^DPT(DFN,"S",SD1)) Q:'SD1!((SD1\1)'=(S\1))  I $P(^(SD1,0),"^",2)'["C",$P(^(0),"^",2)'["N" S SDX=1 Q
"RTN","SDCNP0",54,0)
 Q:SDX  F SD1=2,4 I $D(^SC("AAS",SD1,S\1,DFN)) S SDX=1 Q
"RTN","SDCNP0",55,0)
 Q:SDX  IF $D(^SCE(+$$EXAE^SDOE(DFN,S\1,S\1),0)) S SDX=1
"RTN","SDCNP0",56,0)
 Q:SDX  K ^DPT("ASDPSD","B",DIV,S\1,DFN) Q
"RTN","SDCNP0",57,0)
 ;
"RTN","SDCNP0",58,0)
STATUS(LF) ;
"RTN","SDCNP0",59,0)
 W:LF !
"RTN","SDCNP0",60,0)
 W ?55,"(",$E($$LOWER^VALM1($P($$STATUS^SDAM1(DFN,+^UTILITY($J,"SDCNP",Z),+$P(^(Z),U,2),$G(^DPT(DFN,"S",+^(Z),0))),";",3)),1,23),")"
"RTN","SDCNP0",61,0)
 W:'LF !
"RTN","SDCNP0",62,0)
 Q
"RTN","SDCNP0",63,0)
 ;
"RTN","SDCNP0",64,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDCNP0",65,0)
 N I,STR,SS,SL,SD,SB,SI,HSI,J,APP,S,A1,STARTDAY,CNT,DIV,SDERR,SDDIF
"RTN","SDCNP0",66,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SDTTM,SDSC,SDPL,0,SDCPHDL)
"RTN","SDCNP0",67,0)
 Q
"RTN","SDCNP1")
0^11^B31981215
"RTN","SDCNP1",1,0)
SDCNP1 ;ALB/LDB - CANCEL APPOINTMENT (cont.) ; 14 MAR 88@13:00
"RTN","SDCNP1",2,0)
 ;;5.3;Scheduling;**398,467,478**;Aug 13, 1993
"RTN","SDCNP1",3,0)
 ;
"RTN","SDCNP1",4,0)
 ;SD/467 - EWL Open Matched Entry with rebook
"RTN","SDCNP1",5,0)
NOPE W !,*7,$S(CNT:CNT_" Appointment"_$S(CNT>1:"s",1:"")_" cancelled",1:"NOTHING CANCELLED")
"RTN","SDCNP1",6,0)
 S SDCNT=CNT,SDA=1,SDCNT1=0 I CNT,$S('$D(^DPT(DFN,.35)):1,'$P(^(.35),U):1,1:0) S (SDA,X8)=0 D ASK G:X8="^" END
"RTN","SDCNP1",7,0)
 ;no rebooking to take place; open EWL entries only if applicable
"RTN","SDCNP1",8,0)
 I $D(DFN)>0 D EWL(DFN) ;SD/467
"RTN","SDCNP1",9,0)
 I SDA,SDCNT W !,*7,"NO AUTO-REBOOKING --Patient has died."
"RTN","SDCNP1",10,0)
 I 'SDA,SDCNT S A=DFN D LOOP1^SDCNP1A,LET
"RTN","SDCNP1",11,0)
END K:'$D(DIROUT) DFN D END^SDCNP Q:$D(DIROUT)  G RD^SDCNP
"RTN","SDCNP1",12,0)
ASK S (SDCTR,SDCTRL)=0,%=2 W !!,"DO YOU WISH TO REBOOK ANY APPOINTMENT(S) THAT YOU HAVE CANCELLED" D YN^DICN S ALS=% D:'% REASK G:'% ASK I %-1 S CNT=0 S:%<0 X8="^" D  Q
"RTN","SDCNP1",13,0)
 .W !,"OK"
"RTN","SDCNP1",14,0)
 W !!,"PLEASE NOTE THAT YOU MUST ENTER A DEVICE TO AUTO-REBOOK",!
"RTN","SDCNP1",15,0)
ZIS S %ZIS("A")="DEVICE TO OUTPUT REBOOKED APPT(S). :",%ZIS="QN" D ^%ZIS I POP S X8="^" Q
"RTN","SDCNP1",16,0)
 S L=0 F  S L=$O(^UTILITY($J,"SDCNP",L)) Q:'L  I $P(^(L),U,4)="*** JUST CANCELLED ***" S ^UTILITY($J,"SDCNP1",DFN,$P(^(L),"^",2),$P(^(L),"^"))=^(L)
"RTN","SDCNP1",17,0)
 D SDLST
"RTN","SDCNP1",18,0)
LST S B=0 F  S B=$O(^UTILITY($J,"SDCNP2",DFN,B)) Q:'B  W !!,$J($S(B\1=B:"("_$J(B,2)_") ",1:""),5) S AT=$S($P(^(B),"^",2)'?.N:1,1:0),Y=$P($P(^(B),"^"),".") D DT^SDM0 S X=$P(^(B),"^") X ^DD("FUNC",2,1) W " ",$J(X,8) S Z1(B)="" D MORE Q:SDCTRL
"RTN","SDCNP1",19,0)
 D WH
"RTN","SDCNP1",20,0)
 I B>0 G:SDCTRL&(A8']"") NOPE1 G:SDCTRL DEL
"RTN","SDCNP1",21,0)
 Q
"RTN","SDCNP1",22,0)
SDLST S L1=0 S Z5=0 F  S Z5=$O(^UTILITY($J,"SDCNP1",DFN,Z5)) Q:'Z5  F Z6=0:0 S Z7=Z6,Z6=$O(^UTILITY($J,"SDCNP1",DFN,Z5,Z6)) I Z6="" S L1=L1+1,^UTILITY($J,"SDCNP2",DFN,L1)=Z7_"^"_Z5_"^"_$P(^(Z7),"^",3,6) Q
"RTN","SDCNP1",23,0)
 Q
"RTN","SDCNP1",24,0)
MORE S SDCTR=SDCTR+2 I AT W ?41,$P(^UTILITY($J,"SDCNP2",B),"^",2) G OVR
"RTN","SDCNP1",25,0)
 S S5=^UTILITY($J,"SDCNP2",DFN,B) W " (",$P(S5,"^",6)," MINUTES)  ",$S($D(^SC($P(S5,"^",2),0)):$P(^(0),"^",1),1:"DELETED CLINIC"),$P(S5,"^",3) S M1=$P(^SC($P(S5,"^",2),"SDP"),"^",4) W !,?41,"Max days for rebooking= ",M1
"RTN","SDCNP1",26,0)
OVR I SDCTR>20,$O(^UTILITY($J,"SDCNP2",B))>0 S (SDCTRL,SDCTR)=0 W *7 D WH W:'SDCTRL @IOF
"RTN","SDCNP1",27,0)
 Q
"RTN","SDCNP1",28,0)
WH W !!,"SELECT APPOINTMENT(S) TO BE REBOOKED" W:B>0 " OR HIT RETURN TO CONTINUE DISPLAY" R ": ",A8:DTIME I '$T!(A8="^") S SDCTRL=1,A8="",X8="^" Q
"RTN","SDCNP1",29,0)
 I A8["?" X SDMSG G WH
"RTN","SDCNP1",30,0)
DEL S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  D MTCH
"RTN","SDCNP1",31,0)
 I SDERR G LST
"RTN","SDCNP1",32,0)
DEL1 S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  S SDDI=$P(SDDH,"-"),SDDM=$P(SDDH,"-",2) D CKK^SDCNP1A Q:SDERR  D CKK2^SDCNP1A Q:SDERR  F Z9=SDDI:1:$S(SDDM:SDDM,1:SDDI) D:SDDI REBK I 'SDDI S SDERR=1 Q
"RTN","SDCNP1",33,0)
 G:SDERR LST Q:A8["^"!(A8="")  S SDERR=0 D ^SDCNP1A Q:X8="^"
"RTN","SDCNP1",34,0)
 D:MAX QUE
"RTN","SDCNP1",35,0)
 D NOPE1
"RTN","SDCNP1",36,0)
 Q 
"RTN","SDCNP1",37,0)
LET S %=2 W !!,"DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT(S)" D YN^DICN S ANS="Y" D:'% REASK G:'% LET Q:(%-1)
"RTN","SDCNP1",38,0)
 I $$BADADR^DGUTL3(+DFN) D  Q  ;display, don't print BAI list
"RTN","SDCNP1",39,0)
 . W *7,!,"** THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDCNP1",40,0)
 . W !,"WILL BE PRINTED."
"RTN","SDCNP1",41,0)
 . S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1",42,0)
QUE2 ;S DGPGM="SDLET^SDCNP1A",DGVAR="SDCL#^DUZ^DFN^DT^A^SDWH" D ZIS^DGUTQ D:POP CLOSE^DGUTQ Q:POP  D SDLET^SDCNP1A Q
"RTN","SDCNP1",43,0)
 S %ZIS="MQ" K IO("Q") D ^%ZIS Q:POP  ;SD/478
"RTN","SDCNP1",44,0)
 I $D(IO("Q")) D  D:IO'=IO(0) NOTELTR D ^%ZISC W @IOF Q  ;SD/478
"RTN","SDCNP1",45,0)
 .S ZTRTN="SDLET^SDCNP1A" F ZTS="SDCL(","DUZ","DFN","DT","A","SDWH","AUTO(" S ZTSAVE(ZTS)=""  ;SD/478
"RTN","SDCNP1",46,0)
 .K ZTS D ^%ZTLOAD  ;SD/478
"RTN","SDCNP1",47,0)
 D:IO'=IO(0) NOTELTR D SDLET^SDCNP1A,^%ZISC W @IOF  ;SD/478
"RTN","SDCNP1",48,0)
 Q  ;SD/478
"RTN","SDCNP1",49,0)
NOTELTR I ANS["Y",ALS=1 S:$D(CNDIE) @(CNDIE_CNDA_",1,CNINDX,0)")="CANCEL APPOINTMENT AUTO REBOOK letter printed." K CNDIE,CNDA,CNINDX ;SD/478 CANCEL APPT AUTO REBOOK LETTER PRINTED.
"RTN","SDCNP1",50,0)
 I ANS["Y" S:$D(CNDIE) @(CNDIE_CNDA_",1,CNINDX,0)")="CANCEL APPOINTMENT letter printed." K CNDIE,CNDA,CNINDX ;SD/478 CANCEL APPT LETTER IS PRINTED.
"RTN","SDCNP1",51,0)
 Q
"RTN","SDCNP1",52,0)
QUE I IO'=IO(0) S DGPGM="^SDCNP2",DGVAR="SDCL#^NDATE^A^GDATE^DT^DUZ",IOP=IO,X="NOW" D Q1^DGUTQ Q
"RTN","SDCNP1",53,0)
 U IO I IO=IO(0),$E(IOST,1,2)="C-" S SDIO=1 D ^SDCNP2 Q
"RTN","SDCNP1",54,0)
NOPE1 W @IOF,!,*7,$S(SDCNT1:SDCNT1_" Appointment"_$S(SDCNT1>1:"s",1:"")_" rebooked",1:"NOTHING REBOOKED") Q
"RTN","SDCNP1",55,0)
REBK K ^UTILITY($J,"SDCNP") S ^UTILITY($J,"SDCNP2","REBK",DFN,Z9)=^UTILITY($J,"SDCNP2",DFN,Z9)
"RTN","SDCNP1",56,0)
 Q
"RTN","SDCNP1",57,0)
 F A9=SDDI,SDDM Q:'SDDM&(SDDI-A9)  I '$D(Z1(A9)) S SDERR=1 W !,*7,"There is no appointment number ",A9
"RTN","SDCNP1",58,0)
 Q
"RTN","SDCNP1",59,0)
REASK W !,"ANSWER (Y)ES OR (N)O" Q
"RTN","SDCNP1",60,0)
CLRK S $P(^DPT(DFN,"S",S,0),"^",19)=$P(SDNODE,"^",7),$P(^DPT(DFN,"S",S,0),"^",18)=$P(SDNODE,"^",6) Q
"RTN","SDCNP1",61,0)
MTCH Q:SDDH?1N.N!(SDDH?1.N1"-".N)  S SDERR=1 X SDMSG
"RTN","SDCNP1",62,0)
 Q
"RTN","SDCNP1",63,0)
EWL(DFN) ;
"RTN","SDCNP1",64,0)
 I '$D(^UTILITY($J,"SDCNP1")) I '$D(^UTILITY($J,"SDCNP")) Q
"RTN","SDCNP1",65,0)
 ;call to EWL to open and optionally close EWL entry with rebooked appointment
"RTN","SDCNP1",66,0)
 N SDFRB,SDT,SC,SDREB K ^TMP("SDWLREB",$J),^TMP($J,"SDWPL"),^TMP($J,"APPT")
"RTN","SDCNP1",67,0)
 I $D(^UTILITY($J,"SDCNP1")) S SDFRB="^UTILITY($J,""SDCNP1"")"  D REB I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB Q
"RTN","SDCNP1",68,0)
 E  S SDFRB="^UTILITY($J,""SDCNP"")" D CAN I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDCNP1",69,0)
 Q
"RTN","SDCNP1",70,0)
REB I $D(^UTILITY($J,"SDCNP1")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP1"  S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",71,0)
 .;N NN F NN=1:1 Q:'$D(^UTILITY($J,"SDCNP","REBK",DFN,NN))  I $P($G(^UTILITY($J,"SDCNP2","REBK",DFN,NN)),U)=SDT S SDREB=1 Q
"RTN","SDCNP1",72,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",73,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",74,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",75,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",76,0)
 Q
"RTN","SDCNP1",77,0)
CAN I $D(^UTILITY($J,"SDCNP")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP"  I @SDFRB["CANCELLED" S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",78,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",79,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",80,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",81,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",82,0)
 Q
"RTN","SDCNP1A")
0^12^B28182331
"RTN","SDCNP1A",1,0)
SDCNP1A ;ALB/LDB - CANCEL APPT. (continued) ; 5/26/05 10:59am
"RTN","SDCNP1A",2,0)
 ;;5.3;Scheduling;**167,340,398,478**;Aug 13, 1993
"RTN","SDCNP1A",3,0)
LOOP S SDCNT1=0 F SDAP=0:0 S SDAP=$O(^UTILITY($J,"SDCNP2","REBK",DFN,SDAP)) Q:SDAP'>0  S SDP1=^(SDAP),S1=$P(SDP1,"^",2),S9=$P(^SC(S1,0),"^") D SDDT Q:X8="^"  D RBK S MAX=1
"RTN","SDCNP1A",4,0)
 Q
"RTN","SDCNP1A",5,0)
SDDT W !!,"IN ",S9 D:'$D(DT) DT^SDUTL D DT S %DT="AEX",%DT("A")="START REBOOKING FROM WHAT DATE: "_D S %DT(0)=DT D ^%DT K %DT S X8=X Q:$D(DTOUT)!(X="^")  S:X8="" Y=DT G:Y<0 SDDT S SDDT=+Y\1 K X,Y,DIC S X1=SDDT,X2=DT D ^%DTC
"RTN","SDCNP1A",6,0)
 S (M8,MAX)=0,S1=$P(SDP1,"^",2),S2=$P(SDP1,"^"),M1=$S($D(^SC(S1,"SDP")):$P(^("SDP"),"^",4),1:0) D MAX G:M8 SDDT
"RTN","SDCNP1A",7,0)
 I S2>DT S X1=SDDT,X2=1 D C^%DTC S SDDT=X
"RTN","SDCNP1A",8,0)
 Q
"RTN","SDCNP1A",9,0)
MAX I X>M1 S M8=1 W !!,"Exceeds maximum number of days for rebooking in ",S9 S MAX=0
"RTN","SDCNP1A",10,0)
 Q
"RTN","SDCNP1A",11,0)
RBK S GDATE=S2,SC=S1,LEN=$P(SDP1,"^",6),A=DFN_"^"_LEN,(CDATE,DATE)=SDDT D OVR1,SDIN D ^SDAUT1 D:'MAX NRBK D:MAX ^SDAUT2,SDNP K SDIN Q
"RTN","SDCNP1A",12,0)
OVR1 N X S SL=$S($D(^SC(SC,"SL")):^("SL"),1:"") Q:'SL  S X=$P(SL,U,6),SI=$S(X="":4,X<3:4,X:X,1:4),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SDSTRTDT=$S(DT>DATE:DT,1:DATE),STIME=$S($D(^SC(SC,"SDP")):$P(^("SDP"),U,3),1:"0800"),SDSTRTDT=SDSTRTDT+2
"RTN","SDCNP1A",13,0)
 Q
"RTN","SDCNP1A",14,0)
SDIN I $D(^SC(SC,"I")) S SDIN=+^("I") Q
"RTN","SDCNP1A",15,0)
 Q
"RTN","SDCNP1A",16,0)
SDNP S SDCL(SDAP)=SC_"^"_GDATE_"^"_NDATE S:NDATE SDCNT1=SDCNT1+1 Q
"RTN","SDCNP1A",17,0)
NRBK W !,"NO REBOOKING ALLOWED FOR ",$P(^SC(SC,0),"^") Q
"RTN","SDCNP1A",18,0)
DT S X1=$P(DT,"."),X2=10 D C^%DTC S Y=X D D^DIQ S D=Y_"//" Q
"RTN","SDCNP1A",19,0)
PROT S SDPRT=0 I $D(^SC(+I,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(+I,"SDPRIV",DUZ)) W !,*7,"Appt. in ",$P(^SC(+I,0),"^")," NOT CANCELLED ",!,"Access to this clinic is restricted to only privileged users!",*7 S SDPRT=1 Q
"RTN","SDCNP1A",20,0)
 Q
"RTN","SDCNP1A",21,0)
FLEN S COV=$S($P(^DPT(DFN,"S",NDT,0),"^",11)=1:" (COLLATERAL) ",1:"") I $D(^SC(SC,"S",NDT)) F ZL=0:0 S ZL=$O(^SC(SC,"S",NDT,1,ZL)) Q:ZL'>0  I +^(ZL,0)=DFN S APL=$P(^(0),"^",2),SDSP=$P($G(^SC(SC,"S",NDT,1,ZL,"CONS")),U) Q  ;SD/478
"RTN","SDCNP1A",22,0)
 Q
"RTN","SDCNP1A",23,0)
LOOP1 S SDCNT1=0 F L=0:0 S L=$O(^UTILITY($J,"SDCNP",L)) Q:L'>0  I ^(L)["JUST CANCELLED" S $P(SDCL(L),"^")=$P(^(L),"^",2),$P(SDCL(L),"^",2)=$P(^(L),"^")
"RTN","SDCNP1A",24,0)
 K ^UTILITY($J) Q
"RTN","SDCNP1A",25,0)
SDLET N NDT,GDT
"RTN","SDCNP1A",26,0)
 U IO D Q
"RTN","SDCNP1A",27,0)
 F SDP=0:0 S SDP=$O(SDCL(SDP)) Q:SDP'>0  D
"RTN","SDCNP1A",28,0)
 . S SDP1=SDCL(SDP),SDC=+SDP1,GDT=$P(SDP1,"^",2),NDT=$P(SDP1,"^",3),SDV1=$P(^SC(SDC,0),"^",15)
"RTN","SDCNP1A",29,0)
 . D B I (SDB)!(SDK) Q
"RTN","SDCNP1A",30,0)
 . S:'SDV1 SDV1=+$O(^DG(40.8,0))
"RTN","SDCNP1A",31,0)
 . D F S:SDLET ^UTILITY($J,SDLET,+A,GDT)=SDC_"^"_NDT
"RTN","SDCNP1A",32,0)
 F SDLET=0:0 S SDLET=$O(^UTILITY($J,SDLET)) Q:SDLET'>0  F B0=0:0 S A1=B0,B0=$O(^UTILITY($J,SDLET,B0)) D:'B0 R Q:'B0  D:A1&(A1'=B0) R S A=B0 D ^SDLT,APP
"RTN","SDCNP1A",33,0)
 I $D(^UTILITY($J,"NO")) W @IOF,! F SC=0:0 S SC=$O(^UTILITY($J,"NO",SC)) Q:SC'>0  W !,$P(^SC(SC,0),"^")," Clinic is not assigned a letter",!!
"RTN","SDCNP1A",34,0)
E I $D(^TMP($J,"BADADD")) D BADADD^SDLT K ^TMP($J,"BADADD") I $E(IOST,1,2)="C-" S DIR(0)="E" D ^DIR K ^DIR(0)
"RTN","SDCNP1A",35,0)
 ;I $G(SDB),SDB W !!,"BAD ADDRESS INDICATOR FOR THIS PATIENT. NO LETTER WILL BE PRINTED." S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1A",36,0)
 I $G(SDK),'SDK W !!,"NO LETTER CAN BE PRINTED FOR THIS PATIENT." S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1A",37,0)
 K A,SDCL D CLOSE^DGUTQ
"RTN","SDCNP1A",38,0)
Q K A1,SDFORM,SDLET,SDNDT,SDP1,SDV1,^UTILITY($J),SDB,SDK Q
"RTN","SDCNP1A",39,0)
F S SDFORM="" I $D(^DG(40.8,SDV1,"LTR")),^("LTR") S SDFORM=^("LTR")
"RTN","SDCNP1A",40,0)
 S SDLET="" I $D(^SC(SDC,"LTR")) S:SDWH["P" SDLET=$P(^("LTR"),"^",4) S:SDWH'["P" SDLET=$P(^("LTR"),"^",3)
"RTN","SDCNP1A",41,0)
 I 'SDLET S ^UTILITY($J,"NO",SDC)=""
"RTN","SDCNP1A",42,0)
 Q
"RTN","SDCNP1A",43,0)
R I $D(^UTILITY($J,"R",SDLET,A1)) W !!,"The appointment(s) have been rescheduled as follows:",! F A2=0:0 S A2=$O(^UTILITY($J,"R",SDLET,A1,A2)) Q:A2'>0  S (X,SDX)=A2,SDC=+^(A2),A=A1,SDS=^DPT(DFN,"S",SDX,0) D WRAPP^SDLT K X,SDX
"RTN","SDCNP1A",44,0)
 D REST^SDLT Q
"RTN","SDCNP1A",45,0)
APP F SDX=0:0 S SDX=$O(^UTILITY($J,SDLET,A,SDX)) Q:SDX'>0  S S=^DPT(+A,"S",SDX,0),SDC=+^(0) D WRAPP^SDLT I $P(^UTILITY($J,SDLET,A,SDX),"^",2) S ^UTILITY($J,"R",SDLET,A,$P(^UTILITY($J,SDLET,A,SDX),"^",2))=$P(^(SDX),"^")
"RTN","SDCNP1A",46,0)
 Q
"RTN","SDCNP1A",47,0)
CKK I $L(SDDI)>4!($L(SDDM)>4) S SDERR=1 W !,"There is no appointment number ",$S($L(SDDI)>5:SDDI,1:SDDM) Q
"RTN","SDCNP1A",48,0)
 Q
"RTN","SDCNP1A",49,0)
CKK1 F Z0=SDDI,SDDM Q:'SDDI!('SDDM&(SDDI-Z0))  S SDERR=0 S:$L(Z0)>5 SDERR=1 Q:SDERR  S:$L(SDDI)<5 SDDI=+SDDI S:$L(SDDM)<5 SDDM=+SDDM I $L(Z0)>5!('$D(^UTILITY($J,"SDCNP",Z0,"CNT"))) S SDERR=1 Q
"RTN","SDCNP1A",50,0)
 W:SDERR !,*7,"There is no appointment number ",Z0 H 2 Q
"RTN","SDCNP1A",51,0)
CKK2 F Z0=SDDI,SDDM Q:'SDDI!('SDDM&(SDDI-Z0))  S SDERR=0 S:$L(Z0)>5 SDERR=1 Q:SDERR  S:$L(SDDI)<5 SDDI=+SDDI S:$L(SDDM)<5 SDDM=+SDDM I $L(Z0)>5!('$D(^UTILITY($J,"SDCNP2",DFN,Z0))) S SDERR=1 Q
"RTN","SDCNP1A",52,0)
 W:SDERR !,*7,"There is no appointment number ",Z0 Q
"RTN","SDCNP1A",53,0)
B S SDB=$$BADADR^DGUTL3(+A)
"RTN","SDCNP1A",54,0)
 S:SDB ^TMP($J,"BADADD",$P(^DPT(+A,0),"^"),+A)=""
"RTN","SDCNP1A",55,0)
CHECK S SDK=0 I $S('$D(^DPT(+A,.35)):1,$P(^(.35),"^",1)']"":1,1:0),$D(^DPT(+A,"S",GDT,0)),$S($P(^(0),"^",2)["N":1,$D(SDCP)&$P(^(0),"^",2)["C":1,1:0),$P(^(0),"^",14)=SDTIME!(SDTIME="*"),'$D(^DPT(+A,.1)) S SDK=1
"RTN","SDCNP1A",56,0)
 Q
"RTN","SDCNSLT")
0^13^B40454930
"RTN","SDCNSLT",1,0)
SDCNSLT ;ALB/HAG-LINK APPOINTMENTS TO CONSULTS; 4/12/05 3:44pm
"RTN","SDCNSLT",2,0)
 ;;5.3;Scheduling;**478**;Aug 13, 1993
"RTN","SDCNSLT",3,0)
A ;===GET ACTIVE AND PENDING CONSULT
"RTN","SDCNSLT",4,0)
 N A,ND,CNT,CONS,CPRSTAT,DTENTR,DTIN,DTLMT,DTR,NOS,NOSHOW,SENDER,SERVICE,SRV,P8,PROC,PT,PTNM,STATUS
"RTN","SDCNSLT",5,0)
 K TMP S NOSHOW="no-show",CNT=0,$P(DSH,"-",IOM-1)="",PT=DFN,X1=DT,X2=-365 D C^%DTC S DTLMT=X
"RTN","SDCNSLT",6,0)
 S A=":" F  S A=$O(^GMR(123,"F",PT,A),-1) Q:'+A  S ND=^GMR(123,A,0),PROC=$P($G(^GMR(123,A,1.11)),U),DTENTR=$P(ND,U) I DTENTR>DTLMT S CPRSTAT=$P(ND,U,12) D:CPRSTAT=5!(CPRSTAT=6)!(CPRSTAT=8)!(CPRSTAT=13)
"RTN","SDCNSLT",7,0)
 .I STPCOD'="" S SRV=$P(ND,U,5) Q:'+SRV  I $D(^GMR(123.5,"AB1",STPCOD,SRV)) S PTIEN=$P(ND,U,2) D
"RTN","SDCNSLT",8,0)
 ..I CPRSTAT=8 S SHOW=0 Q:$D(^SC("AWAS1",A))  S NOS=$O(^GMR(123,A,40,":"),-1) Q:'+NOS  S X2=$P($G(^GMR(123,A,40,NOS,0)),U),X1=DT D ^%DTC Q:X'=""&(X>180)  D SCHED(PTIEN,STPCOD,.SHOW) Q:'SHOW
"RTN","SDCNSLT",9,0)
 ..;CPRSTAT 13 is a cancel
"RTN","SDCNSLT",10,0)
 ..I CPRSTAT=13 S NOS=$O(^GMR(123,A,40,":"),-1) Q:'+NOS  S NOS=$O(^GMR(123,A,40,NOS),-1) Q:'+NOS  S X2=$P($G(^GMR(123,A,40,NOS,0)),U),X1=DT D ^%DTC Q:X'=""&(X>180)  S COMMENT=$G(^GMR(123,A,40,NOS,1,1,0)) Q:COMMENT'[NOSHOW
"RTN","SDCNSLT",11,0)
 ..S:+PTIEN PTNM=$P(^DPT(PTIEN,0),U) S SERVICE=$P(^GMR(123.5,SRV,0),U),STATUS=$P(^ORD(100.01,CPRSTAT,0),U),SENDER=$P(ND,U,14) S:+SENDER SENDER=$P(^VA(200,SENDER,0),U)
"RTN","SDCNSLT",12,0)
 ..S Y=DTENTR D DD^%DT S DTIN=Y,DTR=$E(DTENTR,4,5)_"/"_$E(DTENTR,6,7)_"/"_$E(DTENTR,2,3)_"@"_$P(Y,"@",2)
"RTN","SDCNSLT",13,0)
 ..S CNT=CNT+1,TMP(CNT)=PTIEN_U_SERVICE_U_SENDER_U_STATUS_U_DTR_U_A_U_DTIN_U_$P(ND,U,17)_U_PROC
"RTN","SDCNSLT",14,0)
 Q:'$D(TMP)
"RTN","SDCNSLT",15,0)
QST N DIR,DTOUT,DUOUT,CNSULT
"RTN","SDCNSLT",16,0)
 S DIR(0)="Y",DIR("A")="Will this appointment be for a CONSULT/PROCEDURE",DIR("B")="YES",DIR("?")="Answer 'Y'es if appointment is for a Consult or Procedure." W ! D ^DIR S CNSULT=Y
"RTN","SDCNSLT",17,0)
 I CNSULT[U!(CNSULT=0)!(CNSULT="") K TMP Q
"RTN","SDCNSLT",18,0)
HDR W !!,"Please select from the list of consult(s), press 0 for none.",!
"RTN","SDCNSLT",19,0)
 W !,PTNM,!!,"#  Service",?27,"Sending Provider",?45,"Request Date",?60,"Cons #",?68,"Reqst Type",!,DSH
"RTN","SDCNSLT",20,0)
 S A=0 F  S A=$O(TMP(A)) Q:'+A  S ND=TMP(A),P8=$P(ND,U,8) W !,A,". ",$S(P8="P":$E($P(ND,U,9),1,23),1:$E($P(ND,U,2),1,23)),?27,$E($P(ND,U,3),1,17),?45,$E($P(ND,U,5),1,14)," ",$P(ND,U,6) W ?68,$S(P8="P":"Procedure",P8="C":"Consult",1:"")
"RTN","SDCNSLT",21,0)
 W !
"RTN","SDCNSLT",22,0)
READ R !,"Select Consult: ",CONS:DTIME G:CONS="" A
"RTN","SDCNSLT",23,0)
 I CONS=0!(CONS[U) W " ... NONE." K TMP Q
"RTN","SDCNSLT",24,0)
 I "? "[CONS W !," Select consult by number on the left side." G READ
"RTN","SDCNSLT",25,0)
 I '$D(TMP(CONS)) W *7," ?? Select consult by number on the left side." G READ
"RTN","SDCNSLT",26,0)
 S CNSLTLNK=$P(TMP(CONS),U,6)
"RTN","SDCNSLT",27,0)
 Q
"RTN","SDCNSLT",28,0)
SCHED(PTIEN,STPCOD,SHOW) ;===CONSULT IS SCHEDULE NOW CHECK IF IT HAS APPOINTMENT BY STOP CODE.
"RTN","SDCNSLT",29,0)
 N APT,CLNC,B,S1,S2,S3,S4,STOP,STOPCOD,X,Y
"RTN","SDCNSLT",30,0)
 S %DT="ST",X="T-1" D ^%DT S APT=Y,S1=0,STOP=0 F  S APT=$O(^DPT(PTIEN,"S",APT)) Q:'+APT!(STOP)  S S1=1,CLNC=$P(^DPT(PTIEN,"S",APT,0),U) I CLNC'="" S STOPCOD=$P(^SC(CLNC,0),U,7) I STOPCOD'="" S S2=0 I STOPCOD=STPCOD S S2=1 D
"RTN","SDCNSLT",31,0)
 .S S3=0,S4=0,B=0 F  S B=$O(^SC(CLNC,"S",APT,1,B)) Q:'+B!(STOP)  S S3=1 D
"RTN","SDCNSLT",32,0)
 ..I ($P($G(^SC(CLNC,"S",APT,1,B,0)),U)=PTIEN) S S4=1,STOP=1,SHOW=0
"RTN","SDCNSLT",33,0)
 I S1=0 S SHOW=1 Q  ;show if no appointment in the patient side
"RTN","SDCNSLT",34,0)
 I S2=0 S SHOW=1 Q  ;show if stop code does not match
"RTN","SDCNSLT",35,0)
 I S3=0 S SHOW=1 Q  ;show if no appointment in the clinic
"RTN","SDCNSLT",36,0)
 I S4=0 S SHOW=1 Q  ;show if patient does not match in appointment
"RTN","SDCNSLT",37,0)
 Q
"RTN","SDCNSLT",38,0)
LINK(SC,SDY,SD,CNSLTLNK) ;===LINK APPOINTMENT TO CONSULT
"RTN","SDCNSLT",39,0)
 N DA,DIE,DR,TDA,X
"RTN","SDCNSLT",40,0)
 S TDA=SDY,DA(2)=SC,DA(1)=SD,DA=TDA,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688////^S X=CNSLTLNK" D ^DIE
"RTN","SDCNSLT",41,0)
 Q
"RTN","SDCNSLT",42,0)
EDITCS(SD,TMPD,TMPYCLNC,CNSLTLNK) ;===MARK CONSULT AS SCHEDULED
"RTN","SDCNSLT",43,0)
 N CSCHDT,SNDPRV,TME,X,Y,COMMENT,ER
"RTN","SDCNSLT",44,0)
 S %DT="ST",X="NOW" D ^%DT S CSCHDT=Y
"RTN","SDCNSLT",45,0)
 S SNDPRV=$P($G(^GMR(123,CNSLTLNK,0)),U,14),Y=SD D DD^%DT S TME=$P($P(Y,"@",2),":",1,2)
"RTN","SDCNSLT",46,0)
 S COMMENT(1)=$P(TMPYCLNC,U,2)_" Consult Appt. on "_$E(SD,4,5)_"/"_$E(SD,6,7)_"/"_$E(SD,2,3)_" @ "_TME
"RTN","SDCNSLT",47,0)
 S COMMENT(2)=TMPD
"RTN","SDCNSLT",48,0)
 D SCH^SDQQCN2(.ER,CNSLTLNK,SNDPRV,CSCHDT,0,,.COMMENT) K COMMENT
"RTN","SDCNSLT",49,0)
 Q
"RTN","SDCNSLT",50,0)
CANCEL ;===appt was cancelled then mark consult as edit/resubmit, add comment.
"RTN","SDCNSLT",51,0)
 N APPT,CONSULT,CPRSSTAT,ER,GM40,GMRND,SDPATNT,USER,SNDPRV,J
"RTN","SDCNSLT",52,0)
 ;Variables CNDIE, CNDA and CNINDX used in calling routine for Cancel letter printed comment in consult.
"RTN","SDCNSLT",53,0)
 S:$D(SCLNK) CONSULT=SCLNK
"RTN","SDCNSLT",54,0)
 S:'$D(SCLNK) CONSULT=$P($G(^SC(SDSC,"S",SDTTM,1,SDPL,"CONS")),U)
"RTN","SDCNSLT",55,0)
 Q:'+CONSULT
"RTN","SDCNSLT",56,0)
 S:$D(SCSNOD) SDPATNT=$P(SCSNOD,U)
"RTN","SDCNSLT",57,0)
 S:'$D(SCSNOD) SDPATNT=$P($G(^SC(SDSC,"S",SDTTM,1,SDPL,0)),U)
"RTN","SDCNSLT",58,0)
 S CPRSSTAT=$P($G(^GMR(123,CONSULT,0)),U,12) I CPRSSTAT'="" S CPRSSTAT=$P($G(^ORD(100.01,CPRSSTAT,0)),U) Q:CPRSSTAT'="SCHEDULED"
"RTN","SDCNSLT",59,0)
 S SNDPRV=$P($G(^GMR(123,CONSULT,0)),U,14)
"RTN","SDCNSLT",60,0)
 S USER=$P(^VA(200,DUZ,0),U),Y=SDTTM D DD^%DT S APPT=$E(SDTTM,4,5)_"/"_$E(SDTTM,6,7)_"/"_$E(SDTTM,2,3)_" @ "_$P(Y,"@",2)
"RTN","SDCNSLT",61,0)
 S COMMENT(1)=$P(^SC(SDSC,0),U)_" Appt. on "_APPT_" was cancelled"_$S($D(SDWH):$S(SDWH["P":" by the Patient.",SDWH["C":" by the Clinic.",1:"."),$D(SDADM):" for administrative purposes.",1:", whole clinic.")
"RTN","SDCNSLT",62,0)
 S CNINDX=2 S:$D(TMPD) COMMENT(2)="Remarks: "_TMPD,CNINDX=CNINDX+1 K TMPD
"RTN","SDCNSLT",63,0)
 N SDERR S SDERR=$$STATUS^GMRCGUIS(CONSULT,6,3,SNDPRV,"","",.COMMENT)
"RTN","SDCNSLT",64,0)
 S CNDIE="^GMR(123,"_CONSULT_",40,",CNDA=+$G(COMMENT(0))
"RTN","SDCNSLT",65,0)
 K COMMENT,DA
"RTN","SDCNSLT",66,0)
 S AUTO(SDSC,SDTTM,SDPATNT)=CONSULT
"RTN","SDCNSLT",67,0)
 S DA(2)=SDSC,DA(1)=SDTTM,DA=SDPL,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688///@" D ^DIE
"RTN","SDCNSLT",68,0)
 K SCSNOD,SDADM,SCLNK
"RTN","SDCNSLT",69,0)
 Q
"RTN","SDCNSLT",70,0)
AUTOREB(SC,NDATE,LNK,CY) ;===AUTO REBOOK
"RTN","SDCNSLT",71,0)
 N DIC,DA,DIE,DR,Y,TME,SNDPRV,CSCHDT,COMMENT,ER
"RTN","SDCNSLT",72,0)
 S DA(2)=SC,DA(1)=NDATE,DA=CY,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688////^S X=LNK" D ^DIE
"RTN","SDCNSLT",73,0)
 S Y=NDATE D DD^%DT S TME=$P(Y,"@",2)
"RTN","SDCNSLT",74,0)
 S COMMENT(1)=$P(^SC(SC,0),U)_" Consult Appt. on "_$E(NDATE,4,5)_"/"_$E(NDATE,6,7)_"/"_$E(NDATE,2,3)_" @ "_TME_" (Auto Rebooked)."
"RTN","SDCNSLT",75,0)
 S %DT="ST",X="NOW" D ^%DT S CSCHDT=Y
"RTN","SDCNSLT",76,0)
 S SNDPRV=$P($G(^GMR(123,LNK,0)),U,14)
"RTN","SDCNSLT",77,0)
 D SCH^SDQQCN2(.ER,LNK,SNDPRV,CSCHDT,0,,.COMMENT) K COMMENT
"RTN","SDCNSLT",78,0)
 Q
"RTN","SDCNSLT",79,0)
NOSHOW(SC,SDDTM,CNPAT,CNSTLNK,CN,AUTO,NSDIE,NSDA) ;
"RTN","SDCNSLT",80,0)
 ;Appt. was a NoShow, then mark Consult as Edit/Resubmit, add comment using silent call to notify user.
"RTN","SDCNSLT",81,0)
 ;Variables NSDIE and NSDA used in calling routine for NoShow letter printed comment in consult.
"RTN","SDCNSLT",82,0)
 N CSNOD,CPRSSTAT,NOSHOW,CSRQSRV,TPRNT,CSPRT,USER,Y,APPT,COMMENT,DA,DIC,DUZ2,DIC,DR,GM40,GMRND,ER,SNDPRV,J
"RTN","SDCNSLT",83,0)
 S CSNOD=$G(^GMR(123,CNSTLNK,0)),CPRSSTAT=$P(CSNOD,U,12),SNDPRV=$P(CSNOD,U,14),NOSHOW="no-show",AUTO(SC,SDDTM,CNPAT)=CNSTLNK
"RTN","SDCNSLT",84,0)
 I CPRSSTAT'="" S CPRSSTAT=$P($G(^ORD(100.01,CPRSSTAT,0)),U) Q:CPRSSTAT'="SCHEDULED"
"RTN","SDCNSLT",85,0)
 S CSRQSRV=$P(CSNOD,U,5) I CSRQSRV'="" S TPRNT=$P($G(^GMR(123.5,CSRQSRV,123)),U,9) I TPRNT'="" S:$P($G(^%ZIS(1,TPRNT,0)),U)'="" CSPRT=$P(^(0),U) ;reprint consult
"RTN","SDCNSLT",86,0)
 S USER=$P(^VA(200,DUZ,0),U),Y=SDDTM D DD^%DT S APPT=$E(SDDTM,4,5)_"/"_$E(SDDTM,6,7)_"/"_$E(SDDTM,2,3)_" @ "_$P(Y,"@",2)
"RTN","SDCNSLT",87,0)
 S COMMENT(1)=$P(^SC(SC,0),U)_" Appt. on "_APPT_" was a "_NOSHOW_"." ;no-show is a key word used by a search do not change
"RTN","SDCNSLT",88,0)
 N SDERR S SDERR=$$STATUS^GMRCGUIS(CNSTLNK,6,3,SNDPRV,"","",.COMMENT)
"RTN","SDCNSLT",89,0)
 S NSDIE="^GMR(123,"_CNSTLNK_",40,",NSDA=+$G(COMMENT(0))
"RTN","SDCNSLT",90,0)
 K COMMENT,DA
"RTN","SDCNSLT",91,0)
 S DA(2)=SC,DA(1)=SDDTM,DA=CN,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688///@" D ^DIE
"RTN","SDCNSLT",92,0)
 I $D(CSPRT) D EN^GMRCP5(CNSTLNK,"C",CSPRT)
"RTN","SDCNSLT",93,0)
 K CNSTLNK Q
"RTN","SDM")
0^16^B33726440
"RTN","SDM",1,0)
SDM ;SF/GFT,ALB/BOK - MAKE AN APPOINTMENT ; 4/21/05 10:22pm
"RTN","SDM",2,0)
 ;;5.3;Scheduling;**15,32,38,41,44,79,94,167,168,218,223,250,254,296,380,478**;AUG 13, 1993
"RTN","SDM",3,0)
 ;                                           If defined...
"RTN","SDM",4,0)
 ; appt mgt vars:  SDFN := DFN of patient....will not be asked
"RTN","SDM",5,0)
 ;                SDCLN := ifn of clinic.....will not be asked    
"RTN","SDM",6,0)
 ;              SDAMERR := returned if error occurs
"RTN","SDM",7,0)
 ; 
"RTN","SDM",8,0)
 S:'$D(SDMM) SDMM=0
"RTN","SDM",9,0)
EN1 L  W !! D I^SDUTL I '$D(SDCLN) S DIC="^SC(",DIC(0)="AEMZQ",DIC("A")="Select CLINIC: ",DIC("S")="I $P(^(0),U,3)=""C"",'$G(^(""OOS""))" D ^DIC K DIC G:Y<0!'$D(^("SL")) END
"RTN","SDM",10,0)
 N SDRES S:$D(SDCLN) Y=+SDCLN S SDRES=$$CLNCK^SDUTL2(+Y,1)
"RTN","SDM",11,0)
 I 'SDRES W !,?5,"Clinic MUST be corrected before continuing." G END:$D(SDCLN),SDM
"RTN","SDM",12,0)
 K SDAPTYP,SDIN,SDRE,SDXXX S:$D(SDCLN) Y=+SDCLN
"RTN","SDM",13,0)
 S TMPYCLNC=Y,STPCOD=$P($G(^SC(+TMPYCLNC,0)),U,7) ;SD/478
"RTN","SDM",14,0)
 I $D(^SC(+Y,"I")) S SDIN=+^("I"),SDRE=+$P(^("I"),U,2)
"RTN","SDM",15,0)
 K SDINA I $D(SDIN),SDIN S SDINA=SDIN K SDIN
"RTN","SDM",16,0)
 I $D(SD),$D(SC),+Y'=+SC K SD
"RTN","SDM",17,0)
 S SL=$G(^SC(+Y,"SL")),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SC=Y,SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X=1:X,X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y
"RTN","SDM",18,0)
 I $D(^SC(+SC,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(+SC,"SDPRIV",DUZ)) W !,*7,"Access to ",$$CNAM(+SC)," is prohibited!",!,"Only users with a special code may access this clinic.",*7 S:$D(SDCLN) SDAMERR="" G END:$D(SDCLN),SDM
"RTN","SDM",19,0)
 D CS^SDM1A S SDW="",WY="Y"
"RTN","SDM",20,0)
 I '$D(ORACTION),'$D(SDFN) S (DIC,DIE)="^DPT(",DIC(0)="AQZME" D ^DIC S DFN=+Y G:Y<0 END:$D(SDCLN),^SDM0:X[U,SDM
"RTN","SDM",21,0)
 S:$D(SDFN) DFN=SDFN
"RTN","SDM",22,0)
 I $D(^DPT(DFN,.35)),$P(^(.35),U)]"" W !?10,*7,"PATIENT HAS DIED." S:$D(SDFN) SDAMERR="" G END:$D(SDFN),SDM
"RTN","SDM",23,0)
 D ^SDM4 I $S('$D(COLLAT):1,COLLAT=7:1,1:0) G:$D(SDCLN) END G SDM
"RTN","SDM",24,0)
 ;-- get sub-category for appointment type
"RTN","SDM",25,0)
 S SDXSCAT=$$SUB^DGSAUTL(SDAPTYP,2,"")
"RTN","SDM",26,0)
 K SDXXX D EN G END:$D(SDCLN),SDM
"RTN","SDM",27,0)
EN K SDMLT1 W:$P(VAEL(9),U,2)]"" !!,?15,"MEANS TEST STATUS: ",$P(VAEL(9),U,2),!
"RTN","SDM",28,0)
 ; *** sck, mt blocking removed
"RTN","SDM",29,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T,$$MT^EASMTCHK(DFN,+$G(SDAPTYP),"M") S SDAMERR="" Q
"RTN","SDM",30,0)
 S Y=DFN,Y(0)=^DPT(DFN,0) I VADM(7)]"" W !?3,*7,VADM(7)
"RTN","SDM",31,0)
 I $D(^DGS(41.1,"B",DFN)) F I=0:0 S I=$O(^DGS(41.1,"B",DFN,I)) Q:I'>0  I $P(^DGS(41.1,I,0),U,2)'<DT&('$P(^DGS(41.1,I,0),U,13)) W !,"SCHEDULED FOR ADMISSION ON " S Y=$P(^(0),U,2) D DT^SDM0
"RTN","SDM",32,0)
PEND S %="" W:$O(^DPT(DFN,"S",DT))'>DT !,"NO PENDING APPOINTMENTS"
"RTN","SDM",33,0)
 I $O(^DPT(DFN,"S",DT))>DT D  G END:%<0,HELP:'%
"RTN","SDM",34,0)
 .S %=1 W !,"DISPLAY PENDING APPOINTMENTS:"
"RTN","SDM",35,0)
 .D YN^DICN
"RTN","SDM",36,0)
 .I %Y["^" S SDMLT1=1
"RTN","SDM",37,0)
 D:%=1
"RTN","SDM",38,0)
 .N DX,DY,SDXY,SDEND S SDXY="S DX=$X,DY=0"_$S($L($G(^%ZOSF("XY"))):" "_^("XY"),1:"") X SDXY
"RTN","SDM",39,0)
 .S CN=1
"RTN","SDM",40,0)
 .F Y=DT:0 S Y=$O(^DPT(DFN,"S",Y)) Q:Y'>0  I "I"[$P(^(Y,0),U,2) X:(($Y+4)>IOSL) "D OUT^SDUTL X SDXY" Q:$G(SDEND)  D CHKSO W:$X>9 ! W CN,".",?4 D DT^SDM0 W ?23 S DA=+SSC W SDLN,$S($D(^SC(DA,0)):$P(^(0),U),1:"DELETED CLINIC "),COV,"  ",SDAT16 D
"RTN","SDM",41,0)
 ..S CNIEN=0 F  S CNIEN=$O(^SC(+SSC,"S",HY,1,CNIEN)) Q:'+CNIEN  S CNPAT=$P($G(^SC(+SSC,"S",HY,1,CNIEN,0)),U) I CNPAT=DFN W:+$G(^SC(+SSC,"S",HY,1,CNIEN,"CONS")) " Consult Appt." S CN=CN+1 Q  ;SD/478
"RTN","SDM",42,0)
 ;Prompt for ETHNICITY if no value on file
"RTN","SDM",43,0)
 I '$O(^DPT(DFN,.06,0)) D
"RTN","SDM",44,0)
 .S DA=DFN,DR="6ETHNICITY",DIE="^DPT("
"RTN","SDM",45,0)
 .S DR(2,2.06)=".01ETHNICITY"
"RTN","SDM",46,0)
 .D ^DIE K DR
"RTN","SDM",47,0)
 ;Prompt for RACE if no value on file
"RTN","SDM",48,0)
 I '$O(^DPT(DFN,.02,0)) D
"RTN","SDM",49,0)
 .S DA=DFN,DR="2RACE",DIE="^DPT("
"RTN","SDM",50,0)
 .S DR(2,2.02)=".01RACE"
"RTN","SDM",51,0)
 .D ^DIE K DR
"RTN","SDM",52,0)
 S DA=DFN,DR=$S('$D(^DPT(DA,.11)):"[SDM1]",$P(^(.11),U)="":"[SDM1]",1:"")
"RTN","SDM",53,0)
 S DIE="^DPT(" D ^DIE:DR]"" K DR Q:$D(SDXXX)
"RTN","SDM",54,0)
E S Y=$P(SL,U,5)
"RTN","SDM",55,0)
 S SDW="" I $D(^DPT(DFN,.1)) S SDW=^(.1) W !,"NOTE - PATIENT IS NOW IN WARD "_SDW
"RTN","SDM",56,0)
 Q:$D(SDXXX)
"RTN","SDM",57,0)
EN2 F X=0:0 S X=$O(^DPT(DFN,"DE",X)) Q:'$D(^(+X,0))  I ^(0)-SC=0!'(^(0)-Y) F XX=0:0 S XX=$O(^DPT(DFN,"DE",X,1,XX)) Q:XX<1  S SDDIS=$P(^(XX,0),U,3) I 'SDDIS D:'$D(SDMULT) A^SDCNSLT G ^SDM0
"RTN","SDM",58,0)
 I '$D(^SC(+Y,0)) S Y=+SC
"RTN","SDM",59,0)
 S Y=$P(^SC(Y,0),U)
"RTN","SDM",60,0)
 ; SCRESTA = Array of pt's teams causing restricted consults
"RTN","SDM",61,0)
 N SCRESTA
"RTN","SDM",62,0)
 S SCREST=$$RESTPT^SCAPMCU4(DFN,DT,"SCRESTA")
"RTN","SDM",63,0)
 IF SCREST D
"RTN","SDM",64,0)
 .N SCTM
"RTN","SDM",65,0)
 . S SCCLNM=Y
"RTN","SDM",66,0)
 . W !,?5,"Patient has restricted consults due to team assignment(s):"
"RTN","SDM",67,0)
 .S SCTM=0
"RTN","SDM",68,0)
 .F  S SCTM=$O(SCRESTA(SCTM)) Q:'SCTM  W !,?10,SCRESTA(SCTM)
"RTN","SDM",69,0)
 IF SCREST&'$G(SCOKCONS) D  Q
"RTN","SDM",70,0)
 .W !,?5,"This patient may only be given appointments and enrolled in clinics via"
"RTN","SDM",71,0)
 .W !,?15,"Make Consult Appointment Option, and"
"RTN","SDM",72,0)
 .W !,?15,"Edit Clinic Enrollment Data option"
"RTN","SDM",73,0)
 D:$G(SCREST) MAIL^SCMCCON(DFN,.SCCLNM,2,DT,"SCRESTA")
"RTN","SDM",74,0)
 K DR,SCREST,SCCLNM
"RTN","SDM",75,0)
 D:'$D(SDMULT) ^SDCNSLT ;SD/478
"RTN","SDM",76,0)
 G ^SDM0
"RTN","SDM",77,0)
 ;
"RTN","SDM",78,0)
CHKSO S COV=$S($P(^DPT(DFN,"S",Y,0),U,11)=1:" (COLLATERAL)",1:""),HY=Y,SSC=^(0),SDAT16=$S($D(^SD(409.1,+$P(SSC,U,16),0)):$P(^(0),U),1:"")
"RTN","SDM",79,0)
 F SDJ=3,4,5 I $P(^DPT(DFN,"S",HY,0),U,SDJ)]"" S Y=$P(^(0),U,SDJ) W:$X>9 ! W ?10,"*" D DT^SDM0 W ?32,$S(SDJ=3:"LAB",SDJ=4:"XRAY",1:"EKG")
"RTN","SDM",80,0)
 S SDLN="" F J=0:0 S J=$O(^SC(+SSC,"S",HY,1,J)) Q:'J  I $D(^(J,0)),+^(0)=DFN S SDLN="("_$P(^(0),U,2)_" MIN) " Q
"RTN","SDM",81,0)
 S Y=HY Q
"RTN","SDM",82,0)
 ;
"RTN","SDM",83,0)
END D KVAR^VADPT K SDAPTYP,SDSC,%,%DT,ASKC,COV,DA,DIC,DIE,DP,DR,HEY,HSI,HY,J,SB,SC,SDDIF,SDJ,SDLN,SD17,SDMAX,SDU,SDYC,SI,SL,SSC,STARTDAY,STR
"RTN","SDM",84,0)
 K WY,X,XX,Y,S,SD,SDAP16,SDEDT,SDTY,SM,SS,ST,ARG,CCX,CCXN,HX,I,PXR,SDINA,SDW,COLLAT,SDDIS I $D(SDMM) K:'SDMM SDMM
"RTN","SDM",85,0)
 K A,CC,CLNIEN,CN,CNIEN,CNPAT,CNSLTLNK,CNSULT,CNT,CONS,CPRSTAT,CW,DSH,DTENTR,DTIN,DTLMT,DTR,ND,P8,PROC,PT,PTIEN,PTNM,RTMP,NOSHOW,SCPTTM,SD1,SDAMSCN,SDATE,SDDOT,SDII,SDINC,SDINCM,SDLEN,SDNS,SDSI,SDST,SDSTR,SDSTRTDT
"RTN","SDM",86,0)
 K SDXSCAT,SENDER,SERVICE,SRV,STATUS,STPCOD,TMP,TMPYCLNC,TYPE
"RTN","SDM",87,0)
 I '$D(SDMLT) K SDMLT1
"RTN","SDM",88,0)
 Q
"RTN","SDM",89,0)
 ;
"RTN","SDM",90,0)
OERR S XQORQUIT=1 Q:'$D(ORVP)  S DFN=+ORVP G SDM
"RTN","SDM",91,0)
 ;
"RTN","SDM",92,0)
HELP W !,"YES - TO DISPLAY FUTURE APPOINTMENTS",!,"NO - FUTURE APPOINTMENTS NOT DISPLAYED" G PEND
"RTN","SDM",93,0)
 ;
"RTN","SDM",94,0)
CNAM(SDCL) ;Return clinic name
"RTN","SDM",95,0)
 ;Input: SDCL=clinic ien
"RTN","SDM",96,0)
 N SDX
"RTN","SDM",97,0)
 S SDX=$P($G(^SC(+SDCL,0)),U)
"RTN","SDM",98,0)
 Q $S($L(SDX):SDX,1:"this clinic")
"RTN","SDM1")
0^17^B34209967
"RTN","SDM1",1,0)
SDM1 ;SF/GFT - MAKE APPOINTMENT ; 3/29/05 12:35pm [5/5/05 9:41am]
"RTN","SDM1",2,0)
 ;;5.3;Scheduling;**32,167,168,80,223,263,273,408,327,478**;Aug 13, 1993
"RTN","SDM1",3,0)
1 L  Q:$D(SDXXX)  S CCXN=0 K MXOK,COV,SDPROT Q:DFN<0  S SC=+SC
"RTN","SDM1",4,0)
 S X1=DT,SDEDT=365 S:$D(^SC(SC,"SDP")) SDEDT=$P(^SC(SC,"SDP"),"^",2)
"RTN","SDM1",5,0)
 S X2=SDEDT D C^%DTC S SDEDT=X D WRT
"RTN","SDM1",6,0)
 I $D(^SC(SC,"SI")),$O(^("SI",0))>0 W !,*7,?8,"**** SPECIAL INSTRUCTIONS ****",! S %I=0 F %=0:1 S %I=$O(^SC(SC,"SI",%I)) Q:%I'>0  W ^(%I,0) W:% ! I '%,$O(^SC(SC,"SI",%I))>0 S POP=0 D SPIN Q:POP
"RTN","SDM1",7,0)
 I $D(SDINA),SDINA>DT D IN W !,?8,@SDMSG K SDMSG
"RTN","SDM1",8,0)
 G:SDMM RDTY^SDMM
"RTN","SDM1",9,0)
 ;
"RTN","SDM1",10,0)
ADT S:'$D(SDW) SDW=""
"RTN","SDM1",11,0)
 S SDSOH=$S('$D(^SC(SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),CCX=""
"RTN","SDM1",12,0)
 S SDONCE=$G(SDONCE)+1  ;Prevent repetitive iteration
"RTN","SDM1",13,0)
 S X=$S(SDONCE<2:$G(SDSDATE),1:"")  ;Use default date/time if specified as 'desired date'  
"RTN","SDM1",14,0)
 I 'X R !,"DATE/TIME: ",X:DTIME G:X="M"!(X="m") MORDIS^SDM0 I "^"[X D WL(SC) Q   ;sd/327
"RTN","SDM1",15,0)
 ;
"RTN","SDM1",16,0)
 I X="D"!(X="d") S X=$$REDDT() G:X>0 MORD2^SDM0 S X="" W "  ??",! G ADT
"RTN","SDM1",17,0)
 I X?1"?".E D  G ADT
"RTN","SDM1",18,0)
 .W !,"Enter a date/time for the appointment"
"RTN","SDM1",19,0)
 .W:$D(SD) " or a space to choose the same date/time as the patient you have just previously scheduled into this clinic"
"RTN","SDM1",20,0)
 .W ".",!,"You may also select 'M' to display the next month's availability or"
"RTN","SDM1",21,0)
 .W !,"'D' to specify an earlier or later date to begin the availability display."
"RTN","SDM1",22,0)
 I X=" ",$D(SD),SD S Y=SD D AT^SDUTL W Y S Y=SD G OVR
"RTN","SDM1",23,0)
 I $E($P(X,"@",2),1,4)?1.4"0" K %DT S X=$P(X,"@"),X=$S($L(X):X,1:"T"),%DT="XF" D ^%DT G ADT:Y'>0 S X1=Y,X2=-1 D C^%DTC S X=X_.24
"RTN","SDM1",24,0)
 K %DT S %DT="TXEF" D ^%DT
"RTN","SDM1",25,0)
 ;SD*5.3*408  verify that day hasn't been canceled via "SET UP A CLINIC"
"RTN","SDM1",26,0)
 I $G(^SC(+SC,"ST",$P(Y,"."),1))'="",^SC(+SC,"ST",$P(Y,"."),1)'["[" D  G ADT
"RTN","SDM1",27,0)
 .W !,"There is no availability for this date/time.",!
"RTN","SDM1",28,0)
 I $P(Y,".",2)=24 S X1=$P(Y,"."),X2=1 D C^%DTC S Y=X_".000001"
"RTN","SDM1",29,0)
OVR I $D(^HOLIDAY($P(Y,"."),0)),'SDSOH W *7,?50,$P(^(0),U,2),"??" K SDSDATE G ADT
"RTN","SDM1",30,0)
 I $D(SDINA),$P(Y,".")'<SDINA,$S('$D(SDRE):1,SDRE>$P(Y,".")!('SDRE):1,1:0) D IN W !,*7,@SDMSG K SDMSG K SDSDATE G ADT
"RTN","SDM1",31,0)
 I Y#1=0 K SDSDATE G 1
"RTN","SDM1",32,0)
 I $P(Y,".")'<SDEDT W !,*7,"EXCEEDS MAXIMUM DAYS FOR FUTURE APPOINTMENT!!",*7 K SDSDATE G ADT
"RTN","SDM1",33,0)
 ;
"RTN","SDM1",34,0)
EN1 S (TMPD,X,SD)=Y,SM=0 D DOW  ;SD/478
"RTN","SDM1",35,0)
 F S=$P(SD,"."):0 S S=+$O(^DPT(DFN,"S",S)) Q:$P(S,".")-($P(SD,"."))  S I=+^(S,0) G ^SDM2:$P(^(0),U,2)'["C"
"RTN","SDM1",36,0)
 ;
"RTN","SDM1",37,0)
PRECAN I $D(^DPT(DFN,"S",SD,0)),$P(^(0),U,2)["P" S %=1 W !,"THIS TIME WAS PREVIOUSLY CANCELLED BY THE PATIENT",!,"ARE YOU SURE THAT YOU WANT TO PROCEED" D YN^DICN W:'% !,"ANSWER WITH (Y)ES OR (N)O" I (%-1) K SDSDATE G ADT
"RTN","SDM1",38,0)
 W !
"RTN","SDM1",39,0)
 ;
"RTN","SDM1",40,0)
S I '$D(^SC(SC,"ST",$P(SD,"."),1)) S SS=+$O(^SC(+SC,"T"_Y,SD)) G XW:SS'>0,XW:^(SS,1)="" S ^SC(+SC,"ST",$P(SD,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(SD,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(SD,".")
"RTN","SDM1",41,0)
LEN I $P(SL,U,2)]"" W !,"LENGTH OF APPOINTMENT (IN MINUTES): ",+SL,"// " R S:DTIME I S]"" G:$L(S)>3 LEN Q:U[S  S POP=0 D L G LEN:POP,S:S\5*5'=S,S:S>360,S:S<5 S SL=S_U_$P(SL,U,2,99)
"RTN","SDM1",42,0)
 ;
"RTN","SDM1",43,0)
SC S SDLOCK=$S('$D(SDLOCK):1,1:SDLOCK+1) G:SDLOCK>9 LOCK
"RTN","SDM1",44,0)
 L ^SC(SC,"ST",$P(SD,"."),1):5 G:'$T SC
"RTN","SDM1",45,0)
 S SDLOCK=0,S=^SC(SC,"ST",$P(SD,"."),1)
"RTN","SDM1",46,0)
 S I=SD#1-SB*100,ST=I#1*SI\.6+($P(I,".")*SI),SS=SL*HSI/60*SDDIF+ST+ST
"RTN","SDM1",47,0)
 G X:(I<1!'$F(S,"["))&(S'["CAN")
"RTN","SDM1",48,0)
 I SM<7 S %=$F(S,"[",SS-1) S:'%!($P(SL,"^",6)<3) %=999 I $F(S,"]",SS)'<%!(SDDIF=2&$E(S,ST+ST+1,SS-1)["[") S SM=7
"RTN","SDM1",49,0)
 ;
"RTN","SDM1",50,0)
SP I ST+ST>$L(S),$L(S)<80 S S=S_" " G SP
"RTN","SDM1",51,0)
 S SDNOT=1
"RTN","SDM1",52,0)
 F I=ST+ST:SDDIF:SS-SDDIF S ST=$E(S,I+1) S:ST="" ST=" " S Y=$E(STR,$F(STR,ST)-2) G C:S["CAN"!(ST="X"&($D(^SC(+SC,"ST",$P(SD,"."),"CAN")))),X:Y="" S:Y'?1NL&(SM<6) SM=6 S ST=$E(S,I+2,999) S:ST="" ST=" " S S=$E(S,1,I)_Y_ST
"RTN","SDM1",53,0)
 Q:SDMM  G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",54,0)
 ;
"RTN","SDM1",55,0)
E G:'$D(^XUSEC("SDOB",DUZ)) NOOB
"RTN","SDM1",56,0)
 S %=2 W *7,!,$E($T(@SM),5,99),"...OK" D YN^DICN
"RTN","SDM1",57,0)
 I '% W !,"RESPOND YES OR NO" G E
"RTN","SDM1",58,0)
 S SM=9 G SC:'(%-1) K SDSDATE G 1
"RTN","SDM1",59,0)
 ;
"RTN","SDM1",60,0)
LOCK Q:SDMM  W !,*7,"ANOTHER USER HAS LOCKED THIS DATE - TRY AGAIN LATER" Q
"RTN","SDM1",61,0)
 ;
"RTN","SDM1",62,0)
6 ;;OVERBOOK!
"RTN","SDM1",63,0)
7 ;;THAT TIME IS NOT WITHIN SCHEDULED PERIOD!
"RTN","SDM1",64,0)
C S POP=1 W !,*7,"CAN'T BOOK WITHIN A CANCELLED TIME PERIOD!",!
"RTN","SDM1",65,0)
 Q:SDMM  K SDSDATE G 1
"RTN","SDM1",66,0)
 ;
"RTN","SDM1",67,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM1",68,0)
 ;
"RTN","SDM1",69,0)
DOW S %=$E(X,1,3),Y=$E(X,4,5),Y=Y>2&'(%#4)+$E("144025036146",Y)
"RTN","SDM1",70,0)
 F %=%:-1:281 S Y=%#4=1+1+Y
"RTN","SDM1",71,0)
 S Y=$E(X,6,7)+Y#7 Q
"RTN","SDM1",72,0)
 ;
"RTN","SDM1",73,0)
X I SDMM S POP=1 Q
"RTN","SDM1",74,0)
 G:I<1 XW
"RTN","SDM1",75,0)
 S:Y'?1NL&(SM<6) SM=6
"RTN","SDM1",76,0)
 G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",77,0)
XW W *7,"  WHEN??" K SDSDATE G 1
"RTN","SDM1",78,0)
 ;
"RTN","SDM1",79,0)
NOOB W !,"NO OPEN SLOTS THEN",*7 K SDSDATE G 1
"RTN","SDM1",80,0)
 ;
"RTN","SDM1",81,0)
WRT W !,+SL," MINUTE APPOINTMENTS "
"RTN","SDM1",82,0)
 W $S($P(SL,U,2)["V":"(VARIABLE LENGTH)",1:"") Q
"RTN","SDM1",83,0)
 ;
"RTN","SDM1",84,0)
L S SDSL=$S($P(SL,"^",6)]"":60/$P(SL,"^",6),1:"") Q:'SDSL
"RTN","SDM1",85,0)
 I S\(SDSL)*(SDSL)'=S W *7,!,"Appt. length must = or be a multiple of the increment minutes per hour (",SDSL,")",! S POP=1
"RTN","SDM1",86,0)
 Q
"RTN","SDM1",87,0)
 ;
"RTN","SDM1",88,0)
IN S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL S Y1=Y,Y=SDRE
"RTN","SDM1",89,0)
 D:Y DTS^SDUTL
"RTN","SDM1",90,0)
 S SDMSG="""*** Note: Clinic is scheduled to be inactivated on "","_""""_Y1_""""_$S(SDRE:",!,?10,"_""" and reactivated on "","_""""_Y_"""",1:""),Y=SDHY K Y1,SDHY
"RTN","SDM1",91,0)
 Q
"RTN","SDM1",92,0)
 ;
"RTN","SDM1",93,0)
SPIN W !,"There are more special instructions. Do you want to display them"
"RTN","SDM1",94,0)
 S %=2 D YN^DICN
"RTN","SDM1",95,0)
 I '% W !,"Enter Y to see the remaining special instructions, or N if you don't wish to see them" G SPIN
"RTN","SDM1",96,0)
 I (%-1) S POP=1 Q
"RTN","SDM1",97,0)
 W !,^SC(SC,"SI",%I,0),! Q
"RTN","SDM1",98,0)
 ;
"RTN","SDM1",99,0)
REDDT() ;Prompt for availability redisplay date
"RTN","SDM1",100,0)
 N %DT,X,Y
"RTN","SDM1",101,0)
 S %DT="AEX"
"RTN","SDM1",102,0)
 S %DT("A")="DATE TO BEGIN THE RE-DISPLAY OF CLINIC AVAILABILITY: "
"RTN","SDM1",103,0)
 W ! D ^%DT
"RTN","SDM1",104,0)
 Q Y
"RTN","SDM1",105,0)
WL(SC) ;Wait List Hook/teh patch 263 ;SD/327 passed 'SC'
"RTN","SDM1",106,0)
 Q:$G(SC)'>0
"RTN","SDM1",107,0)
 I '$D(^SC(SC)) Q
"RTN","SDM1",108,0)
 I $D(SC) S SDWLFLG=0 D
"RTN","SDM1",109,0)
 .I $D(^SDWL(409.32,"B",+SC)) S SDWLFLG=1
"RTN","SDM1",110,0)
 .I 'SDWLFLG S SDWLDSS=$P($G(^SC(+SC,0)),U,7) I $D(^SDWL(409.31,"B",SDWLDSS)) S SDWLFLG=2 D
"RTN","SDM1",111,0)
 ..I SDWLFLG=1 S SDWLSC=$O(^SDWL(409.32,"B",+SC,0)) I $P(^SDWL(409.32,SDWLSC,0),U,4) S SDWLFLG=0
"RTN","SDM1",112,0)
 .I SDWLFLG=2 S SDWLDS=$O(^SDWL(409.31,"E",DUZ(2),0)) I $D(^SDWL(409.31,SDWLDSS,"I",+SDWLDS,0)),$P(^(0),U,4) S SDWLFLG=0
"RTN","SDM1",113,0)
 .I SDWLFLG D
"RTN","SDM1",114,0)
 ..K SDWLSC,SDWLDSS,SDWLDS,SDWLFLG
"RTN","SDM1",115,0)
 ..S SDWLOPT=1,SDWLERR=0 D OPT^SDWLE D EN^SDWLKIL
"RTN","SDM1",116,0)
 Q
"RTN","SDM1",117,0)
 ;
"RTN","SDM1A")
0^18^B42131509
"RTN","SDM1A",1,0)
SDM1A ;SF/GFT,ALB/TMP - MAKE APPOINTMENT ; 8/18/05 12:57pm
"RTN","SDM1A",2,0)
 ;;5.3;Scheduling;**26,94,155,206,168,223,241,263,327,478**;Aug 13, 1993
"RTN","SDM1A",3,0)
OK I $D(SDMLT) D ^SDM4 Q:X="^"!(SDMADE=2)
"RTN","SDM1A",4,0)
 S ^SC(SC,"ST",$P(SD,"."),1)=S,^DPT(DFN,"S",SD,0)=SC,^SC(SC,"S",SD,0)=SD S:'$D(^DPT(DFN,"S",0)) ^(0)="^2.98P^^" S:'$D(^SC(SC,"S",0)) ^(0)="^44.001DA^^" L
"RTN","SDM1A",5,0)
S1 L ^SC(SC,"S",SD,1):5 G:'$T S1 F SDY=1:1 I '$D(^SC(SC,"S",SD,1,SDY)) S:'$D(^(0)) ^(0)="^44.003PA^^" S ^(SDY,0)=DFN_U_(+SL) L  Q
"RTN","SDM1A",6,0)
 I SM S ^("OB")="O" ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDY,"OB")
"RTN","SDM1A",7,0)
 I $D(^SC(SC,"RAD")),^("RAD")="Y"!(^("RAD")=1) S ^SC("ARAD",SC,SD,DFN)=""
"RTN","SDM1A",8,0)
 S SDINP=$$INP^SDAM2(DFN,SD)
"RTN","SDM1A",9,0)
 ;-- added sub-category
"RTN","SDM1A",10,0)
 S COV=3,SDYC="",COV=$S(COLLAT=1:1,1:3),SDYC=$S(COLLAT=7:1,1:"")
"RTN","SDM1A",11,0)
 S:SD<DT SDSRTY="W"
"RTN","SDM1A",12,0)
 S ^DPT(DFN,"S",SD,0)=SC_"^"_$$STATUS(SC,SDINP,SD)_"^^^^^"_COV_"^^^^"_SDYC_"^^^^^"_SDAPTYP_U_$G(SD17)_"^^"_DT_"^^^^^"_$G(SDXSCAT)_U_$P($G(SDSRTY),U,2)_U_$$NAVA^SDMANA(SC,SD,$P($G(SDSRTY),U,2))
"RTN","SDM1A",13,0)
 S ^DPT(DFN,"S",SD,1)=$G(SDDATE)_U_$G(SDSRFU)
"RTN","SDM1A",14,0)
 I $D(SDMULT) S SDCLNCND=^SC(SC,0),STPCOD=$P(SDCLNCND,U,7),TMPYCLNC=SC_U_$P(SDCLNCND,U) D A^SDCNSLT ;SD/478 MULTI CLINIC OPTION SELECTED
"RTN","SDM1A",15,0)
 ;xref DATE APPT. MADE field
"RTN","SDM1A",16,0)
 D
"RTN","SDM1A",17,0)
 .N DIV,DA,DIK
"RTN","SDM1A",18,0)
 .S DA=SD,DA(1)=DFN,DIK="^DPT(DA(1),""S"",",DIK(1)=20 D EN1^DIK
"RTN","SDM1A",19,0)
 .Q
"RTN","SDM1A",20,0)
 K:$D(^DPT(DFN,"S",SD,"R")) ^("R") K:$D(^DPT("ASDCN",SC,SD,DFN)) ^(DFN)
"RTN","SDM1A",21,0)
 S SDRT="A",SDTTM=SD,SDPL=SDY,SDSC=SC D RT^SDUTL
"RTN","SDM1A",22,0)
 W !,"   ",+SL,"-MINUTE APPOINTMENT MADE" K SDINP
"RTN","SDM1A",23,0)
 ;confirm request type & follow-up indicator
"RTN","SDM1A",24,0)
 I $D(SDSRTY(0)) D CONF(.SDSRTY,.SDSRFU,DFN,SD,SC) W !
"RTN","SDM1A",25,0)
 I $P(SD,".")'>DT,$D(^DPT(DFN,.321)) D EN1^SDM3
"RTN","SDM1A",26,0)
 ;
"RTN","SDM1A",27,0)
 ;Wait List SD*5.3*263
"RTN","SDM1A",28,0)
 ;I '$D(SDWLLIST) D ^SDWLR ;replaced with sd/372, see below
"RTN","SDM1A",29,0)
EWLCHK ;check if patient has any open EWL entries (SD/372)
"RTN","SDM1A",30,0)
 N SDEV D EN^SDWLEVAL(DFN,.SDEV)
"RTN","SDM1A",31,0)
 ;process open EWL entries if exist
"RTN","SDM1A",32,0)
 I SDEV,$L(SDEV(1))>0 W !,SDEV(1),! D
"RTN","SDM1A",33,0)
 .;display appointment
"RTN","SDM1A",34,0)
 .K ^TMP($J,"SDAMA301"),^TMP($J,"APPT")
"RTN","SDM1A",35,0)
 .;SD-Appt Date/Time
"RTN","SDM1A",36,0)
 .;SC- Appt Clinic
"RTN","SDM1A",37,0)
 .W:$D(IOF) @IOF D APPT^SDWLEVAL(DFN,SD,SC)
"RTN","SDM1A",38,0)
 .Q:'$D(^TMP($J,"APPT"))
"RTN","SDM1A",39,0)
 .D APPTD^SDWLEVAL ;display appointment from ^TMP($J,"APPT")
"RTN","SDM1A",40,0)
 .;
"RTN","SDM1A",41,0)
 .N SDTC D EWLANS^SDWLEVAL(.SDTC) ;user may reject EWL
"RTN","SDM1A",42,0)
 .;ask for selection of EWL to display
"RTN","SDM1A",43,0)
 .;ASKS - returned answer (A/C/S/^)
"RTN","SDM1A",44,0)
 .;    ^TMP("SDWLPL",$J) and ^TMP($J,"SDWLPL") are used
"RTN","SDM1A",45,0)
 .;      to generate EWL open entries
"RTN","SDM1A",46,0)
 .I SDTC N SDCTN S SDCTN=0 F  N ASKS K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL") D ANS2^SDWLPL(DFN,.ASKS) Q:ASKS="^"  D  Q:SDCTN
"RTN","SDM1A",47,0)
 ..Q:'$D(^TMP($J,"SDWLPL"))  D ASKREM^SDWLEVAL S SDCTN=1 ;display and process selected open EWL entries
"RTN","SDM1A",48,0)
 .I 'SDTC Q  ;no EWL evaluation per user's decision
"RTN","SDM1A",49,0)
 .Q
"RTN","SDM1A",50,0)
 ;
"RTN","SDM1A",51,0)
 ;continue appointment entry process
"RTN","SDM1A",52,0)
ORD S %=2 W !,"WANT PATIENT NOTIFIED OF LAB,X-RAY, OR EKG STOPS" D YN^DICN I '% W !,"  Enter YES to notify patient on appt. letter of LAB, X-RAY, or EKG stops" G ORD
"RTN","SDM1A",53,0)
 I '(%-1) D ORDY^SDM3
"RTN","SDM1A",54,0)
OTHER R !,"  OTHER INFO: ",D:DTIME I D["^" W !,*7,"'^' not allowed - hit return if no 'OTHER INFO' is to be entered" G OTHER
"RTN","SDM1A",55,0)
 S TMPD=D I $L(D)>150 D MSG^SDMM G OTHER ;SD/478
"RTN","SDM1A",56,0)
 I D]"",D?."?"!(D'?.ANP) W "  ENTER LAB, SCAN, ETC." G OTHER
"RTN","SDM1A",57,0)
 I $L(^SC(SC,"S",SD,1,SDY,0))+$L(D)+$L(DT)+$S($D(DUZ):$L(DUZ),1:0)>250 D MSG^SDMM G OTHER
"RTN","SDM1A",58,0)
 S $P(^(0),"^",4)=D,$P(^(0),U,6,7)=$S($D(DUZ):DUZ,1:"")_U_DT ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDY,0)
"RTN","SDM1A",59,0)
 D:$D(TMP) LINK^SDCNSLT(SC,SDY,SD,CNSLTLNK) ;SD/478
"RTN","SDM1A",60,0)
 D:$D(TMP) EDITCS^SDCNSLT(SD,TMPD,TMPYCLNC,CNSLTLNK) ;SD/478
"RTN","SDM1A",61,0)
 K TMP  ;SD/478
"RTN","SDM1A",62,0)
XR I $S('$D(^SC(SC,"RAD")):1,^("RAD")="Y":0,^("RAD")=1:0,1:1) S %=2 W !,"WANT PREVIOUS X-RAY RESULTS SENT TO CLINIC" D YN^DICN G:'% HXR I '(%-1) S ^SC("ARAD",SC,SD,DFN)=""
"RTN","SDM1A",63,0)
SDMM S SDEMP=0 I COLLAT=7 S:SDEC'=SDCOL SDEMP=SDCOL G OV
"RTN","SDM1A",64,0)
 D ELIG^VADPT I $O(VAEL(1,0))>0 D ELIG^SDM4:"369"[SDAPTYP S SDEMP=$S(SDDECOD:SDDECOD,1:SDEMP)
"RTN","SDM1A",65,0)
OV Q:$D(SDZM)  K SDQ1,SDEC,SDCOL I +SDEMP S $P(^SC(SC,"S",SD,1,SDY,0),"^",10)=+SDEMP
"RTN","SDM1A",66,0)
 S SDMADE=1 D EVT Q
"RTN","SDM1A",67,0)
HXR W !,"  Enter YES to have previous XRAY results sent to the clinic" G XR
"RTN","SDM1A",68,0)
 Q
"RTN","SDM1A",69,0)
CS S SDCS=+$P(^SC(+SC,0),"^",7) I $S('$D(^DIC(40.7,SDCS,0)):1,'$P(^(0),"^",3):0,1:$P(^(0),"^",3)'>DT) W !!,*7,"** WARNING - CLINIC HAS AN INVALID OR INACTIVE STOP CODE!!!",!!
"RTN","SDM1A",70,0)
 S SDCS=+$P(^SC(+SC,0),"^",18) I $S('SDCS:0,'$D(^DIC(40.7,SDCS,0)):1,'$P(^(0),"^",3):0,1:$P(^(0),"^",3)'>DT) W !!,*7,"** WARNING - CLINIC HAS AN INVALID OR INACTIVE CREDIT STOP CODE!!!",!!
"RTN","SDM1A",71,0)
 K SDCS Q
"RTN","SDM1A",72,0)
 ;
"RTN","SDM1A",73,0)
STATUS(SDCL,SDINP,SDT) ; -- determine status for NEW appts
"RTN","SDM1A",74,0)
 Q $S(SDINP]"":SDINP,$$CHK(.SDCL,.SDT):"NT",1:"")
"RTN","SDM1A",75,0)
 ;
"RTN","SDM1A",76,0)
CHK(SDCL,SDT) ; -- should appt be NT'ed
"RTN","SDM1A",77,0)
 ; -- non-count clinic check := don't NT appt
"RTN","SDM1A",78,0)
 ; -- appt update executed   := need to NT appt
"RTN","SDM1A",79,0)
 ; -- otherwise              := don't NT appt
"RTN","SDM1A",80,0)
 Q $S($P($G(^SC(SDCL,0)),U,17)="Y":0,$D(^SDD(409.65,"AUPD",$P(SDT,"."))):1,1:0)
"RTN","SDM1A",81,0)
 ;
"RTN","SDM1A",82,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDM1A",83,0)
 D MAKE^SDAMEVT(DFN,SD,SC,SDY,0)
"RTN","SDM1A",84,0)
 Q
"RTN","SDM1A",85,0)
 ;
"RTN","SDM1A",86,0)
REQ(SDT) ; -- which is required check in(CI) or out(CO)
"RTN","SDM1A",87,0)
 Q $S($$REQDT()>SDT:"CI",1:"CO")
"RTN","SDM1A",88,0)
 ;
"RTN","SDM1A",89,0)
REQDT() ; -- co required date
"RTN","SDM1A",90,0)
 Q $S($P(^DG(43,1,"SCLR"),U,23):$P(^("SCLR"),U,23),1:2931001)
"RTN","SDM1A",91,0)
 ;
"RTN","SDM1A",92,0)
COCMP(DFN,SDT) ; -- date CO completed
"RTN","SDM1A",93,0)
 Q $P($G(^SCE(+$P($G(^DPT(DFN,"S",SDT,0)),U,20),0)),U,7)
"RTN","SDM1A",94,0)
 ;
"RTN","SDM1A",95,0)
CI(SDCL,SDT,SDDA,SDACT) ; -- ok to update DPT
"RTN","SDM1A",96,0)
 N C
"RTN","SDM1A",97,0)
 I '$$CHK(.SDCL,.SDT) G CIQ
"RTN","SDM1A",98,0)
 I $$REQ(SDT)'="CI" G CIQ
"RTN","SDM1A",99,0)
 I SDACT="SET",$D(^DPT(+^SC(SDCL,"S",SDT,1,SDDA,0),"S",SDT,0)),$P(^(0),U,2)="NT" S $P(^(0),U,2)=""
"RTN","SDM1A",100,0)
 I SDACT="KILL" S C=$G(^SC(SDCL,"S",SDT,1,SDDA,"C")) I $D(^DPT(+$G(^(0)),"S",SDT,0)),$P(^(0),U,2)="",'$P(C,U,3) S $P(^(0),U,2)="NT"
"RTN","SDM1A",101,0)
CIQ Q
"RTN","SDM1A",102,0)
 ;
"RTN","SDM1A",103,0)
CO(SDCL,SDT,SDDA,SDACT) ; -- ok to update DPT
"RTN","SDM1A",104,0)
 N DFN,C
"RTN","SDM1A",105,0)
 I '$$CHK(.SDCL,.SDT) G COQ
"RTN","SDM1A",106,0)
 I $$REQ(.SDT)'="CO" D  G COQ
"RTN","SDM1A",107,0)
 .I SDACT="SET",$D(^DPT(+^SC(SDCL,"S",SDT,1,SDDA,0),"S",SDT,0)),$P(^(0),U,2)="NT" S $P(^(0),U,2)=""
"RTN","SDM1A",108,0)
 .I SDACT="KILL" S C=$G(^SC(SDCL,"S",SDT,1,SDDA,"C")) I $D(^DPT(+$G(^(0)),"S",SDT,0)),$P(^(0),U,2)="",'C S $P(^(0),U,2)="NT"
"RTN","SDM1A",109,0)
 S DFN=+^SC(SDCL,"S",SDT,1,SDDA,0)
"RTN","SDM1A",110,0)
 D UPD(.DFN,.SDT,$$COCMP(.DFN,.SDT),$S(SDACT="SET":X,1:""))
"RTN","SDM1A",111,0)
COQ Q
"RTN","SDM1A",112,0)
 ;
"RTN","SDM1A",113,0)
UPD(DFN,SDT,SDCOCMP,SDCODT) ; -- update status
"RTN","SDM1A",114,0)
 N Y
"RTN","SDM1A",115,0)
 I $D(^DPT(DFN,"S",SDT,0)) S Y=$P(^(0),U,2) D
"RTN","SDM1A",116,0)
 .I 'SDCOCMP!('SDCODT) S:Y="" $P(^DPT(DFN,"S",SDT,0),U,2)="NT" Q
"RTN","SDM1A",117,0)
 .S:Y="NT" $P(^DPT(DFN,"S",SDT,0),U,2)=""
"RTN","SDM1A",118,0)
 Q
"RTN","SDM1A",119,0)
 ;
"RTN","SDM1A",120,0)
OE(SDOE,SDACT) ; -- called by x-ref on co completed field(#.07) in ^SCE
"RTN","SDM1A",121,0)
 N Y S Y=^SCE(SDOE,0)
"RTN","SDM1A",122,0)
 I $P(Y,U,8)'=1 G OEQ
"RTN","SDM1A",123,0)
 I $$REQ(+Y)'="CO" G OEQ
"RTN","SDM1A",124,0)
 I '$$CANT(+$P(Y,U,2),+Y,SDOE),'$$CHK(+$P(Y,U,4),+Y) G OEQ
"RTN","SDM1A",125,0)
 D UPD(+$P(Y,U,2),+Y,$S(SDACT="SET":X,1:""),$P($G(^SC(+$P(Y,U,4),"S",+Y,1,+$P(Y,U,9),"C")),U,3))
"RTN","SDM1A",126,0)
OEQ Q
"RTN","SDM1A",127,0)
 ;
"RTN","SDM1A",128,0)
CONF(SDSRTY,SDSRFU,DFN,SDT,SC) ;Confirm scheduling request type
"RTN","SDM1A",129,0)
 ;Input: SDSRTY=request type
"RTN","SDM1A",130,0)
 ;Input: SDSRFU=follow-up indicator
"RTN","SDM1A",131,0)
 ;Input: DFN=patient ien
"RTN","SDM1A",132,0)
 ;Input: SDT=appointment date/time
"RTN","SDM1A",133,0)
 ;Input: SC=clinic ifn
"RTN","SDM1A",134,0)
 ;
"RTN","SDM1A",135,0)
 N DIR,DIE,DA,DR,SDX,SDY,X,Y
"RTN","SDM1A",136,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","SDM1A",137,0)
 S DIR("A")="THIS APPOINTMENT IS MARKED AS '"_SDSRTY(0)_"', IS THIS CORRECT"
"RTN","SDM1A",138,0)
 W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)
"RTN","SDM1A",139,0)
 I 'Y S SDX='SDSRTY,SDX(0)=$$TXRT(.SDX) W !!,"THIS APPOINTMENT HAS NOW BEEN MARKED AS '"_$S('SDSRTY:"",1:"NOT ")_"NEXT AVAILABLE'."
"RTN","SDM1A",140,0)
 ;S DIR("A")="THIS APPOINTMENT IS DEFINED AS '"_$S(SDSRFU:"FOLLOW-UP",1:"OTHER THAN FOLLOW-UP")_"', OK"
"RTN","SDM1A",141,0)
 ;W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)
"RTN","SDM1A",142,0)
 ;I 'Y S SDY='SDSRFU W "  (changed)"
"RTN","SDM1A",143,0)
 Q:'$D(SDX)  S DR=""
"RTN","SDM1A",144,0)
 I $D(SDX) S DR="25///^S X=$P(SDX,U,2);26///^S X=$$NAVA^SDMANA(SC,SDT,$P(SDX,U,2))"
"RTN","SDM1A",145,0)
 ;I $D(SDY) S:$L(DR) DR=DR_";" S DR=DR_"26///^S X=SDY"
"RTN","SDM1A",146,0)
 S DA=SDT,DA(1)=DFN
"RTN","SDM1A",147,0)
 S DIE="^DPT(DA(1),""S""," D ^DIE
"RTN","SDM1A",148,0)
 Q
"RTN","SDM1A",149,0)
 ;
"RTN","SDM1A",150,0)
TXRT(SDSRTY)    ;Transform request type
"RTN","SDM1A",151,0)
 ;Input: SDSRTY=variable to return request type (pass by reference)
"RTN","SDM1A",152,0)
 ;Output: external text for SDSRTY(0)
"RTN","SDM1A",153,0)
 I SDSRTY S SDSRTY=SDSRTY_U_"N" Q "NEXT AVAILABLE"
"RTN","SDM1A",154,0)
 S SDSRTY=SDSRTY_U_"O" Q "NOT NEXT AVAILABLE"
"RTN","SDM1A",155,0)
 ;
"RTN","SDM1A",156,0)
CANT(DFN,SDT,SDOE) ;Determine if clinic appt. has been marked "NT"
"RTN","SDM1A",157,0)
 ;Output: '1' if appt. points to encounter and is marked "NT", otherwise '0'
"RTN","SDM1A",158,0)
 N SDAPP S SDAPP=$G(^DPT(DFN,"S",SDT,0))
"RTN","SDM1A",159,0)
 Q:$P(SDAPP,U,20)'=SDOE 0
"RTN","SDM1A",160,0)
 Q $P(SDAPP,U,2)="NT"
"RTN","SDM1A",161,0)
 ;
"RTN","SDM1A",162,0)
 ; -- Variable doc for above tags
"RTN","SDM1A",163,0)
 ;     SDCL := file 44 ien
"RTN","SDM1A",164,0)
 ;      SDT := appt date/time
"RTN","SDM1A",165,0)
 ;      DFN := file 2 ien
"RTN","SDM1A",166,0)
 ;     SDDA := ^SC(SDCL,"S",SDT,1,SDDA,0)
"RTN","SDM1A",167,0)
 ;    SDACT := current x-ref action 'set' or 'kill' 
"RTN","SDM1A",168,0)
 ;  SDCOCMP := check out completed date
"RTN","SDM1A",169,0)
 ;   SDCODT := check out date/time
"RTN","SDM1A",170,0)
 ;     SDOE := Outpatient Encounter ien
"RTN","SDM1A",171,0)
 ;    SDINP := inpatient status ('I' or null)    
"RTN","SDM1A",172,0)
 ;    SDINP := inpatient status ('I' or null)    
"RTN","SDM2")
0^19^B24545266
"RTN","SDM2",1,0)
SDM2 ;SF/GFT - MAKE APPOINTMENT ; 07 Jan 2000  6:30 PM
"RTN","SDM2",2,0)
 ;;5.3;Scheduling;**32,132,168,356,434,467,478**;Aug 13, 1993
"RTN","SDM2",3,0)
 ;
"RTN","SDM2",4,0)
 ;SD/467 - call EWL to open its entry if matching appointment is canceled
"RTN","SDM2",5,0)
 W *7,!,"PATIENT ALREADY HAS APPOINTMENT "
"RTN","SDM2",6,0)
 N SDATA,SDCMHDL ; for evt dvr
"RTN","SDM2",7,0)
 I $D(^DPT(DFN,"S",SD,0)),$P(^(0),"^",2)'["C" S S=SD,I=+^(0) D FLEN W "(",APL," MINUTES) THEN" D IN,PROT G:$D(SDPROT) ^SDM1 R ".",!,"  DO YOU WANT TO CANCEL IT? ",X:DTIME S X=$$UP^XLFSTR(X) D:X?1"Y".A STAT G CAN:X?1"Y".A W "??",*7 G ^SDM1
"RTN","SDM2",8,0)
SDAY S %=1 W "ON THE SAME DAY (" D AT,IN W ") ...OK" D YN^DICN I '% W !,"RESPOND YES OR NO",!,"PATIENT ALREADY HAS APPOINTMENT " G SDAY
"RTN","SDM2",9,0)
 G ^SDM1:(%-1),PRECAN^SDM1
"RTN","SDM2",10,0)
 ;
"RTN","SDM2",11,0)
CAN Q:'$D(^SC(I,"SL"))  S SCI=I,DIV=$S($P(^SC(I,0),"^",15)]"":" "_$P(^(0),"^",15),1:" 1") I $D(^DPT("ASDPSD","C",DIV,I,S,DFN)) K ^(DFN)
"RTN","SDM2",12,0)
 S SD17=$P(^DPT(DFN,"S",S,0),"^") K ^SC("ARAD",I,S,DFN) S (DA,SDSY)=0 F SDSX=0:0 S SDSX=$O(^SC(I,"S",S,1,SDSX)) Q:'SDSX  Q:'$D(^(SDSX,0))  D C Q:SDSY&(DA)
"RTN","SDM2",13,0)
 I $D(^DPT("ASDPSD","B",DIV,$P(S,"."),DFN)) D CK1
"RTN","SDM2",14,0)
 G OUT:'SDSY S SL1=$P(^SC(I,"S",S,1,SDSY,0),U,2) I DA,'$D(^("OB")) K ^SC(I,"S",S,1,DA,"OB")
"RTN","SDM2",15,0)
 S SDRT="D",SDTTM=SD,SDPL=SDSY,SDSC=I D RT^SDUTL
"RTN","SDM2",16,0)
 I I'=SC D
"RTN","SDM2",17,0)
 .W !
"RTN","SDM2",18,0)
 .I $$BADADR^DGUTL3(DFN)>0 D  Q
"RTN","SDM2",19,0)
 ..W !!,"**BAD ADDRESS INDICATOR FOR THIS PATIENT. NO LETTER WILL BE PRINTED.**",!!
"RTN","SDM2",20,0)
 .S DIR("A")="DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT"
"RTN","SDM2",21,0)
 .S DIR("A",1)="THIS IS THE ONLY OPPORTUNITY.",DIR("B")="YES"
"RTN","SDM2",22,0)
 .S DIR(0)="Y" D ^DIR W ! K DIR
"RTN","SDM2",23,0)
 .Q:(Y'=1)
"RTN","SDM2",24,0)
 .N SDWH,A,SC,SDCL S SDWH="P",A=+DFN,SDCL(1)=I_"^"_S N DFN
"RTN","SDM2",25,0)
 .S %ZIS("A")="Device for cancellation letter: ",%ZIS("B")=""
"RTN","SDM2",26,0)
 .N I,S,SDHX,SDP
"RTN","SDM2",27,0)
 .D ^%ZIS Q:POP  U IO
"RTN","SDM2",28,0)
 .D SDLET^SDCNP1A
"RTN","SDM2",29,0)
 .D ^%ZISC
"RTN","SDM2",30,0)
 N SCSNOD,SCLNK,SCSRV,SCGMR,SCSTPCOD
"RTN","SDM2",31,0)
 S SCSNOD=^SC(I,"S",S,1,SDSY,0),SCLNK=$P($G(^SC(I,"S",S,1,SDSY,"CONS")),U),SDADM="" S:'$D(STPCOD) STPCOD=$P($G(^SC(I,0)),U,7) K TMPD ;SD/478
"RTN","SDM2",32,0)
 I SCLNK'="" K ^SC("AWAS1",SCLNK) S SCSRV=$P($G(^GMR(123,SCLNK,0)),U,5),SCGMR=0 F  S SCGMR=$O(^GMR(123.5,SCSRV,688,SCGMR)) Q:'+SCGMR  S SCSTPCOD=$P(^GMR(123.5,SCSRV,688,SCGMR,0),U) I STPCOD=SCSTPCOD D
"RTN","SDM2",33,0)
 .S TMP=1 S:'$D(CNSLTLNK) CNSLTLNK=SCLNK Q  ;SD/478
"RTN","SDM2",34,0)
 K ^SC(I,"S",S,1,SDSY)
"RTN","SDM2",35,0)
 I '$D(^SC(I,"ST",$P(SD,"."),1)) G OUT
"RTN","SDM2",36,0)
 S SD1(1)=^SC(I,"SL"),SD1=$P(SD1(1),"^",3),SB1=$S(SD1:SD1,1:8)-1/100,SD1=$P(SD1(1),"^",6),HSI1=$S(SD1:SD1,1:4),SI1=$S(SD1="":4,SD1<3:4,SD1:SD1,1:4),SDDIF1=$S(HSI1<3:8/HSI1,1:2) K SD1
"RTN","SDM2",37,0)
 S S=^SC(I,"ST",$P(SD,"."),1),SDQ=SD#1-SB1*100,ST=SDQ#1*SI1\.6+($P(SDQ,".")*SI1),SS=SL1*HSI1/60
"RTN","SDM2",38,0)
 I SDQ'<1 F I=ST+ST:SDDIF1 S SDQ=$E(STR,$F(STR,$E(S,I+1))) Q:SDQ=""  S S=$E(S,1,I)_SDQ_$E(S,I+2,999),SS=SS-1 Q:SS'>0
"RTN","SDM2",39,0)
 S ^(1)=S K SL1,SB1,SDDIF1,HSI1,SI1,SDQ ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDM2",40,0)
OUT D EVT Q:$D(SDNSF)  D CANCEL^SDCNSLT W *7,!,"APPOINTMENT IN ",$P(^SC(SCI,0),"^",1)," CANCELLED!" S X=SD D DOW^SDM1 W !,"APPOINTMENT NOW BEING MADE IN ",$P(^SC(SC,0),"^",1) K SCI G S^SDM1  ;SD/478
"RTN","SDM2",41,0)
 ;
"RTN","SDM2",42,0)
C I +^SC(I,"S",S,1,SDSX,0)=DFN,$P(^(0),"^",9)'["C" S SDSY=SDSX Q
"RTN","SDM2",43,0)
 Q:'$D(^("OB"))!DA  S:^("OB")?1"O".E DA=SDSX Q  ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDSX,"OB")
"RTN","SDM2",44,0)
 ;
"RTN","SDM2",45,0)
AT W "AT ",$E(S_0,9,10),":",$E(S_"000",11,12) Q
"RTN","SDM2",46,0)
IN W:SC-I&$D(^SC(I,0)) " IN ",$P(^(0),U,1) Q
"RTN","SDM2",47,0)
PROT K SDPROT
"RTN","SDM2",48,0)
 I $D(^SC(I,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(I,"SDPRIV",DUZ)) D  Q
"RTN","SDM2",49,0)
 .W !!,*7,">>> Access to ",$$CNAM(I)," is prohibited!"
"RTN","SDM2",50,0)
 .W !,"    Only users with a special code may access this clinic.",!
"RTN","SDM2",51,0)
 .S SDPROT=""
"RTN","SDM2",52,0)
 ;
"RTN","SDM2",53,0)
 I $$CODT^SDCOU(DFN,SD,I) D  Q
"RTN","SDM2",54,0)
 .W !?5,*7,">>> A check out date has been entered for this appointment!"
"RTN","SDM2",55,0)
 .W !?5,"    Please enter another date and time.   Thank you.",!
"RTN","SDM2",56,0)
 .S SDPROT=""
"RTN","SDM2",57,0)
 Q
"RTN","SDM2",58,0)
 ;
"RTN","SDM2",59,0)
CNAM(SDCL) ;Return clinic name
"RTN","SDM2",60,0)
 ;Input: SDCL=clinic ien
"RTN","SDM2",61,0)
 N SDX
"RTN","SDM2",62,0)
 S SDX=$P($G(^SC(+SDCL,0)),U)
"RTN","SDM2",63,0)
 Q $S($L(SDX):SDX,1:"this clinic")
"RTN","SDM2",64,0)
 ;
"RTN","SDM2",65,0)
FLEN S APL="" I $D(^SC(I,"S",SD)) F ZL=0:0 S ZL=$O(^SC(I,"S",SD,1,ZL)) Q:ZL=""  I +^(ZL,0)=DFN S APL=$P(^SC(I,"S",SD,1,ZL,0),"^",2)
"RTN","SDM2",66,0)
 Q
"RTN","SDM2",67,0)
 ;
"RTN","SDM2",68,0)
DISP G ^SDM1 ; LINE TAG IS NO LONGER USED
"RTN","SDM2",69,0)
 ;W !?4 K S F SDQ=Y:0 S SDQ=$N(^SC(SC,"S",SDQ)) Q:Y+1<SDQ!(SDQ<0)  F I=0:0 S I=$N(^SC(SC,"S",SDQ,1,I)) Q:I'>0  Q:'$D(^(I,0))  S ST=$S($P(^(0),U,4)="":"BLANK",1:"'"_$E($P(^(0),U,4),1,28)_"'"),S(ST)=$S($D(S(ST)):S(ST)+1,1:1)
"RTN","SDM2",70,0)
 ;I '$D(S) W "NO APPNT'S SCHEDULED YET" G ^SDM1
"RTN","SDM2",71,0)
 ;W "'OTHER' TYPES ALREADY SCHEDULED:   ",!
"RTN","SDM2",72,0)
 ;S S=0 F I=0:1 S S=$N(S(S)) G ^SDM1:S=-1 W:$X+$L(S)>72 ! W S,": ",S(S),"     "
"RTN","SDM2",73,0)
CK1 S SDZ=0 F SD1=$P(S,"."):0 S SD1=$O(^DPT(DFN,"S",SD1)) Q:'SD1!((SD1\1)'=(S\1))  I $P(^(SD1,0),"^",2)'["C",$P(^(0),"^",2)'["N" S SDZ=1 Q
"RTN","SDM2",74,0)
 Q:SDZ  F SD1=2,4 I $D(^SC("AAS",SD1,$P(S,"."),DFN)) S SDZ=1 Q
"RTN","SDM2",75,0)
 Q:SDZ  IF $D(^SCE(+$$EXAE^SDOE(DFN,S\1,S\1),0)) S SDX=1
"RTN","SDM2",76,0)
 Q:SDZ  K ^DPT("ASDPSD","B",DIV,$P(S,"."),DFN) Q
"RTN","SDM2",77,0)
STAT N X S SDCMHDL=$$HANDLE^SDAMEVT(1) D BEFORE^SDAMEVT(.SDATA,DFN,SD,I,"",SDCMHDL),NOW^%DTC
"RTN","SDM2",78,0)
 S $P(^DPT(DFN,"S",SD,0),"^",2)="C",$P(^(0),"^",14)=$E(%,1,12) S:$D(DUZ) $P(^(0),"^",12)=DUZ S ^DPT("ASDCN",+^(0),SD,DFN)=""
"RTN","SDM2",79,0)
 K ^TMP("SDWLREB",$J),^TMP($J,"SDWLPL") N SC S SC=+^DPT(DFN,"S",SD,0) D OPENEWL^SDWLREB(DFN,SD,SC,0) K ^TMP($J,"SDWLP")
"RTN","SDM2",80,0)
 I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB ; SD/467
"RTN","SDM2",81,0)
 Q
"RTN","SDM2",82,0)
 ;
"RTN","SDM2",83,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDM2",84,0)
 ; -- cancel event
"RTN","SDM2",85,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SDTTM,SDSC,SDPL,0,SDCMHDL)
"RTN","SDM2",86,0)
 Q
"RTN","SDMULT")
0^20^B10325943
"RTN","SDMULT",1,0)
SDMULT ;ALB/TMP - MAKE MULTI-CLINIC APPOINTMENTS ; 02 Jan 2000  6:30 PM
"RTN","SDMULT",2,0)
 ;;5.3;Scheduling;**63,168,380,478**;Aug 13, 1993
"RTN","SDMULT",3,0)
 I '$D(DT) D DT^SDUTL
"RTN","SDMULT",4,0)
 S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K SDNEXT,SDC1,IOP
"RTN","SDMULT",5,0)
1 K SDAPTYP S SDMLT="",DIC="^DPT(",DIC(0)="AQZME" D ^DIC S DFN=+Y I "^"[X K FND S SDNEXT="" K SDMLT,SDAPTYP G END^SDMULT0
"RTN","SDMULT",6,0)
 G:Y<0 1 D 2^VADPT I +VADM(6) W !?10,*7,"PATIENT HAS DIED." G 1
"RTN","SDMULT",7,0)
 S SDW=$S('$D(^DPT(DFN,.1)):"",^(.1)]"":^(.1),1:""),(SDMM,COLLAT)=0
"RTN","SDMULT",8,0)
 S SDXXX="" D EN^SDM I $D(SDMLT1) K FND G END^SDMULT0
"RTN","SDMULT",9,0)
 D:'$D(DT) DT^SDUTL S SDCT=0,SDMAX=DT K SDC W !!,"YOU MAY SELECT FROM 2-4 CLINICS",!
"RTN","SDMULT",10,0)
RD S DIC="^SC(",DIC(0)="AEMQZ",DIC("S")="I $P(^(0),""^"",3)=""C"",'$G(^(""OOS""))",DIC("A")="Select CLINIC: " D ^DIC K DIC("S"),DIC("A") I X="",SDCT>1 G START^SDMULT0
"RTN","SDMULT",11,0)
 I $S(X["^":1,'$D(DTOUT):0,$D(DTOUT)&DTOUT:1,1:0) K FND G END^SDMULT0
"RTN","SDMULT",12,0)
 I $D(SDNEXT) S SDMAX=DT G:X]"" C G END^SDMULT0
"RTN","SDMULT",13,0)
 I X']"" W !,*7,"MUST HAVE MORE THAN 1 CLINIC" G RD
"RTN","SDMULT",14,0)
 N SDRES S SDRES=$$CLNCK^SDUTL2(+Y,1)
"RTN","SDMULT",15,0)
 I 'SDRES W !,?5,"Clinic MUST be corrected before continuing." G RD
"RTN","SDMULT",16,0)
 G:Y'>0 RD I $D(SDC1(+Y)) W !,*7,"This clinic has already been selected" G RD
"RTN","SDMULT",17,0)
C I $D(^SC(+Y,"SDPROT")),$P(^("SDPROT"),"^",1)="Y",'$D(^SC(+Y,"SDPRIV",DUZ)) W !,*7,"Access to ",$$CNAM(+Y)," is prohibited!",!,"Only users with a special code may access this clinic.",*7 G RD
"RTN","SDMULT",18,0)
 I '$D(SDNEXT) S SDOK=0,SC=+Y,SDHY=Y,Y=$S($D(^SC(SC,"SL")):$P(^("SL"),"^",5),1:"") K SD S SDMULT=1 D EN2^SDM S Y=SDHY K SDHY I 'SDOK W !,"CLINIC IGNORED!!" G RD ;SD/478
"RTN","SDMULT",19,0)
 K SDOK I '$D(^SC(+Y,"SL")) W !,"No appt length specified - cannot book appts" G RD
"RTN","SDMULT",20,0)
 S SL=^("SL"),SDL=+SL ;NAKED REFERENCE ^SC(IFN,"SL")
"RTN","SDMULT",21,0)
LEN I $P(SL,"^",2)]"" W !,"  APPOINTMENT LENGTH DESIRED: ",+SL R "// ",X:DTIME G:$L(X)>3 LEN G:X["^" END^SDMULT0 I X]"" S POP=0,S=X D L^SDM1 G:POP LEN S SDL=S
"RTN","SDMULT",22,0)
 S X2=$S($D(^SC(+Y,"SDP")):$P(^("SDP"),"^",2),1:0),X1=DT D C^%DTC S SDMAX=$S('(X-DT):SDMAX,'(SDMAX-DT):X,X<SDMAX:X,1:SDMAX)
"RTN","SDMULT",23,0)
 I SDMAX'>DT W !,*7,$P(Y,"^",2)," has max # of days for future booking undef or = 0" G RD
"RTN","SDMULT",24,0)
 S SDC1(+Y)=$P(Y,U,2)_"^"_SDL,SDCT=SDCT+1,SDC(SDCT)=Y,X2=$S($D(^SC(+Y,"SDP")):$P(^("SDP"),"^",2),1:0),X1=DT D C^%DTC S SDMAX=$S('(X-DT):SDMAX,'(SDMAX-DT):X,X<SDMAX:X,1:SDMAX)
"RTN","SDMULT",25,0)
 G DT^SDNEXT:$D(SDNEXT),START^SDMULT0:'(SDCT#4),RD
"RTN","SDMULT",26,0)
 ;
"RTN","SDMULT",27,0)
 ;
"RTN","SDMULT",28,0)
CNAM(SDCL) ;Return clinic name
"RTN","SDMULT",29,0)
 ;Input: SDCL=clinic ien
"RTN","SDMULT",30,0)
 N SDX
"RTN","SDMULT",31,0)
 S SDX=$P($G(^SC(+SDCL,0)),U)
"RTN","SDMULT",32,0)
 Q $S($L(SDX):SDX,1:"this clinic")
"RTN","SDN")
0^21^B30846315
"RTN","SDN",1,0)
SDN ;SF/GFT,ALB/LDB - RECORD NO SHOWS ; 5/26/05 11:55am
"RTN","SDN",2,0)
 ;;5.3;Scheduling;**32,79,398,478**;Aug 13, 1993
"RTN","SDN",3,0)
 N SDATA ; for evt driver
"RTN","SDN",4,0)
 S U="^" D NOW^%DTC S SDTIME=%,SDLT1="" K ^UTILITY($J),SDCP,SDLT D LO^DGUTL
"RTN","SDN",5,0)
 S SDDT=DT,SDV1=$O(^DG(40.8,0)) D DIV^SDUTL I $T S DIC=40.8,DIC(0)="AEQM" S SDLT=1 D NSLET1^SDDIV K SDLT G:Y<0 END^SDN0 S SDV1=DIV
"RTN","SDN",6,0)
7 R !!,"NO-SHOWS FOR WHAT DATE: ",X:DTIME Q:U[X  S %DT="EP",%DT(0)=-DT D ^%DT G 7:Y<0 S SDT=Y,SDYES=""
"RTN","SDN",7,0)
 S SM="S SDCT=0 F I=SD1:0:SD2 S I=$N(^DPT(+Y,""S"",I)) S:I<0!(I'<SD2) I=9999999 I I\1=SDT,$D(^(I,0)),+^(0)=SC,$P(^(0),U,2)'[""C"",'$$CODT^SDCOU(+Y,I,SC) Q"
"RTN","SDN",8,0)
 S SM1="S SDCT=0 F I=SD1:0 S I=$N(^DPT(+Y,""S"",I)) Q:I<0!(I'<SD2)  I I\1=SDT,$D(^(I,0)),+^(0)=SC,$P(^(0),""^"",2)'[""C"",'$$CODT^SDCOU(+Y,I,SC) S SDCT=SDCT+1,SDT(SDCT)=I"
"RTN","SDN",9,0)
71 W ! K DIC S SC=0,DIC="^SC(",DIC(0)="AEMQ",DIC("A")="Select CLINIC NAME: ",DIC("S")="I $P(^(0),""^"",3)=""C"",'$G(^(""OOS"")),$S($P(^(0),""^"",15)=SDV1:1,'$P(^(0),""^"",15):1,'SDV1:1,1:0)"
"RTN","SDN",10,0)
 D ^DIC K DIC("A"),DIC("S") G 73:Y<0 S SC=+Y,SD1=SDT,SD2=SDT+1 S SDMSG=" DOES NOT HAVE A NO-SHOW LETTER ASSIGNED TO IT!"
"RTN","SDN",11,0)
72 Q:$D(SDNSACT)  S SD1=SDT,DIC="^DPT(",DIC(0)="AEMQ",DIC("S")=SM
"RTN","SDN",12,0)
 K SDT S SDT=SD1
"RTN","SDN",13,0)
 D ^DIC K DIC("S") G 71:"^"[X,72:Y<0 S DFN=+Y X SM1 D SDMLT Q:'SDCT  S I=SDT(SDCT)
"RTN","SDN",14,0)
EN1 ; -- entry pt for protocol action
"RTN","SDN",15,0)
 S SDSTAT=$P(^DPT(+DFN,"S",I,0),U,2) I SDSTAT="I" D NS^SDN2 G 72
"RTN","SDN",16,0)
 I SDSTAT=""!(SDSTAT="NT") D  G 72
"RTN","SDN",17,0)
 .N SDNSHDL,SDDA S SDNSHDL=$$HANDLE^SDAMEVT(1),SDDA=$$FIND^SDAM2(DFN,I,SC)
"RTN","SDN",18,0)
 .S SDDTM=I D BEFORE^SDAMEVT(.SDATA,DFN,SDDTM,SC,SDDA,SDNSHDL)
"RTN","SDN",19,0)
 .S $P(^DPT(+DFN,"S",I,0),U,2)="N",$P(^(0),"^",14)=SDTIME S:$D(DUZ) $P(^(0),"^",12)=DUZ
"RTN","SDN",20,0)
 .S:'SDYES SDYES=1
"RTN","SDN",21,0)
 .S:'$D(^UTILITY($J,"CL",DFN,SC,I))&(SDSTAT'="C") ^(I)=""
"RTN","SDN",22,0)
 .W "...OK   New Status: ",$P($$STATUS^SDAM1(DFN,I,SC,^DPT(DFN,"S",I,0),SDDA),";",3)
"RTN","SDN",23,0)
 .D EVT K SDATA
"RTN","SDN",24,0)
 W:$P(^DPT(+DFN,"S",I,0),U,2)["A" *7,!,"THIS APPOINTMENT ALREADY A NO-SHOW AND REBOOKED... ARE YOU SURE YOU"
"RTN","SDN",25,0)
ALNS S %=2 W:$P(^DPT(+DFN,"S",I,0),U,2)'["A" !,*7,"  ALREADY RECORDED AS NO-SHOW..." W " WANT TO ERASE" D YN^DICN I '% W !,"RESPOND YES OR NO" G ALNS
"RTN","SDN",26,0)
 I (%-1) G 72
"RTN","SDN",27,0)
 I '(%-1) W "...NO LONGER A NO-SHOW!" D
"RTN","SDN",28,0)
 .N SDNSHDL,SDDA S SDNSHDL=$$HANDLE^SDAMEVT(1),SDDA=$$FIND^SDAM2(DFN,I,SC)
"RTN","SDN",29,0)
 .S SDDTM=I D BEFORE^SDAMEVT(.SDATA,DFN,SDDTM,SC,SDDA,SDNSHDL)
"RTN","SDN",30,0)
 .S SDINP=$$INP^SDAM2(DFN,SDDTM),X=I,Y=DFN
"RTN","SDN",31,0)
 .S $P(^DPT(+Y,"S",SDDTM,0),U,2)=$S(SDINP["I":SDINP,1:""),$P(^(0),"^",14)="",$P(^(0),"^",12)=""
"RTN","SDN",32,0)
 .I SDINP="",$$CHK^SDM1A(SC,SDDTM),+$$STATUS^SDAM1(DFN,SDDTM,SC,^DPT(DFN,"S",SDDTM,0),SDDA)'=1 S $P(^DPT(DFN,"S",SDDTM,0),U,2)="NT" ; not inpt and not ci
"RTN","SDN",33,0)
 .D EVT K SDATA
"RTN","SDN",34,0)
 .K SDINP,^UTILITY($J,"CL",+Y,SC,SDDTM),SDDTM
"RTN","SDN",35,0)
 G 72
"RTN","SDN",36,0)
73 ;
"RTN","SDN",37,0)
 G:SDYES ASKA G END^SDN0
"RTN","SDN",38,0)
CK1 S SD1=I X SM I I<SD2,$P(^DPT(+Y,"S",I,0),U,2)["C" S POP=1
"RTN","SDN",39,0)
 S:I'<SD2 POP=1 Q:'POP  I I'<SD2 S POP=1 Q
"RTN","SDN",40,0)
 G CK1
"RTN","SDN",41,0)
ASKA S %=2,DTOUT=0 W !,"WANT TO AUTO-REBOOK NO-SHOW APPOINTMENTS NOW" D YN^DICN I '% W !,"RESPOND YES (Y) OR NO (N)" G ASKA
"RTN","SDN",42,0)
 W:DTOUT " NO" S ANS=$S(%=1:"Y",1:"N"),(SDED,DATEND)=SDT+.9
"RTN","SDN",43,0)
 I $D(SDNSACT),'SDNSACT,%=1 S SDNSACT=1 ;No-show action flag
"RTN","SDN",44,0)
ASKL S %=1,DTOUT=0,SDLET="" W !,"WANT LETTERS PRINTED NOW" D YN^DICN I '% W !,"RESPOND YES (Y) OR NO (N)" G ASKL
"RTN","SDN",45,0)
 W:DTOUT " NO" S ALS=$S(%=1:"Y",1:"N")
"RTN","SDN",46,0)
 I $D(SDNSACT),(ALS="Y"),$$BADADR^DGUTL3(+DFN) D  ;display, don't print BAI list
"RTN","SDN",47,0)
 . W *7,!,"** THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDN",48,0)
 . W !,"WILL BE PRINTED."
"RTN","SDN",49,0)
 . S ALS="N"
"RTN","SDN",50,0)
 . S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDN",51,0)
 I ALS'["Y"&(ANS'["Y") D DIS^SDNDIS G END^SDN0
"RTN","SDN",52,0)
RD1 I $D(SDNSACT) S Y=SC G RD2
"RTN","SDN",53,0)
 R !!,"FOR CLINIC: ALL// ",X:DTIME K C,DIC Q:X="^"  S X=$$UP^XLFSTR(X) G AOR:X="ALL"!(X="") I X?.E1"?" W !,?3,"ENTER A CLINIC NAME, OR 'ALL' FOR ALL CLINICS" G RD1
"RTN","SDN",54,0)
 S DIC(0)="QEM",DIC=44,DIC("S")="I $P(^(0),""^"",3)=""C""" D ^DIC K DIC("S") G:Y<0 RD1
"RTN","SDN",55,0)
RD2 S C=+Y I '$D(^SC(C,"LTR")) W !,$P(^SC(C,0),"^")_SDMSG S ALS="N"
"RTN","SDN",56,0)
 I $D(^SC(C,"LTR")),'+^("LTR") W !,$P(^SC(C,0),"^")_SDMSG S ALS="N"
"RTN","SDN",57,0)
 I $D(^SC(C,"LTR")),+^("LTR") S SDLET=+^("LTR")
"RTN","SDN",58,0)
AOR S:'$D(C) C="ALL" I ANS'["Y"&(ALS'["Y") D DIS^SDNDIS G END^SDN0
"RTN","SDN",59,0)
 D DIS^SDNDIS
"RTN","SDN",60,0)
 ;S DGPGM="START^SDN0",DGVAR="SC^SDDT^ALS^ANS^SDLET^SDV1^SDT^C^DATEND^SDTIME^SDLT1"
"RTN","SDN",61,0)
 ;S POP=0 D ZIS^DGUTQ G:POP END^SDN0
"RTN","SDN",62,0)
 S %ZIS="MQ" K IO("Q") D ^%ZIS G:POP END^SDN0
"RTN","SDN",63,0)
 I $D(IO("Q")) D  D:IO'=IO(0) NSLTR W @IOF G END^SDN0
"RTN","SDN",64,0)
 .S ZTRTN="START^SDN0" F ZTS="SC","SDDT","ALS","ANS","SDLET","SDV1","SDT","C","DATEND","SDTIME","SDLT1","AUTO(" S ZTSAVE(ZTS)=""
"RTN","SDN",65,0)
 .K ZTS D ^%ZTLOAD
"RTN","SDN",66,0)
 D:IO'=IO(0) NSLTR D START^SDN0,^%ZISC W @IOF G END^SDN0
"RTN","SDN",67,0)
 ;G START^SDN0     ;???
"RTN","SDN",68,0)
 Q
"RTN","SDN",69,0)
NSLTR I ANS["Y",ALS["Y" S:$D(NSDIE) @(NSDIE_NSDA_",1,2,0)")="NO-SHOW AUTO-REBOOK letter printed." K NSDIE,NSDA ;SD/478 AT THIS POINT NO SHOW AUTO REBOOK LETTER IS PRINTED.
"RTN","SDN",70,0)
 I ALS["Y" S:$D(NSDIE) @(NSDIE_NSDA_",1,2,0)")="NO-SHOW letter printed." K NSDIE,NSDA ;SD/478 AT THIS POINT NO SHOW LETTER IS PRINTED.
"RTN","SDN",71,0)
 Q
"RTN","SDN",72,0)
SDMLT ;
"RTN","SDN",73,0)
 N SDCNT,SDSTAT
"RTN","SDN",74,0)
 S SDCNT=SDCT,SDCT=0
"RTN","SDN",75,0)
 F  S SDCT=$O(SDT(SDCT)) Q:'SDCT  D
"RTN","SDN",76,0)
 .S SDSTAT=$$STATUS^SDAM1(DFN,SDT(SDCT),SC,^DPT(DFN,"S",SDT(SDCT),0))
"RTN","SDN",77,0)
 .W !,SDCT,"). ",$$FTIME^VALM1(SDT(SDCT)),"   Status: ",$P(SDSTAT,";",3) W:$P(SDSTAT,";",4) *7
"RTN","SDN",78,0)
 S SDCT=SDCNT
"RTN","SDN",79,0)
ASK I SDCT>1!($P(SDSTAT,";",4)) R !!,"SELECT APPOINTMENT: ",SDCT:DTIME Q:'$T!(U[SDCT)  I SDCT["?"!('$D(SDT(SDCT))) W !,"Please enter one number to indicate which appointment." S SDCT=SDCNT G ASK
"RTN","SDN",80,0)
 W ! Q
"RTN","SDN",81,0)
 ;
"RTN","SDN",82,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDN",83,0)
 N I,SDINP,Y,SDSTAT,SDTIME,SDYES,SM,SM1,SD1,SD2,SDMSG,SDT,SDCT,CNSTLNK,CN,CNPAT
"RTN","SDN",84,0)
 D NOSHOW^SDAMEVT(.SDATA,DFN,SDDTM,SC,SDDA,0,SDNSHDL)
"RTN","SDN",85,0)
 S CNSTLNK="",CN=0 F  S CN=$O(^SC(SC,"S",SDDTM,1,CN)) Q:'+CN  S CNPAT=$P($G(^SC(SC,"S",SDDTM,1,CN,0)),U) I CNPAT=DFN S CNSTLNK=$P($G(^SC(SC,"S",SDDTM,1,CN,"CONS")),U) Q  ;SD/478
"RTN","SDN",86,0)
 D:+CNSTLNK NOSHOW^SDCNSLT(SC,SDDTM,CNPAT,CNSTLNK,CN,.AUTO,.NSDIE,.NSDA) ;SD/478
"RTN","SDN",87,0)
 Q
"RTN","SDN",88,0)
 ;
"RTN","SDPURG1")
0^22^B11203537
"RTN","SDPURG1",1,0)
SDPURG1 ;ALB/TMP - Purge-Print Routine ; 12/24/85
"RTN","SDPURG1",2,0)
 ;;5.3;Scheduling;**132,478**;Aug 13, 1993
"RTN","SDPURG1",3,0)
START U IO S (SDCT,POP)=0 W @IOF,!,"*** SCHEDULING PURGE IN PROCESS ***",! D NOW^%DTC
"RTN","SDPURG1",4,0)
 G:'SD44 SD2 W !,"Begin purge of Hospital Location File nodes " S Y=% D DT^DIQ S SDCT=0
"RTN","SDPURG1",5,0)
 F A=0:0 S A=$O(^SC(A)) D:'A ENDA Q:'A  I $D(^(A,0)),$P(^(0),"^",3)="C" D A F B=0:0 S B=$O(^SC(A,"S",B)) Q:'B!(B'<SDLIM1)  S DA(1)=A,DA=B,DIK="^SC("_DA(1)_",""S"",",X=DIK_B_")" D PRTS,^DIK K DIK W:'(SDCT#100)&('SDPR) "."
"RTN","SDPURG1",6,0)
 S SDCT=0 G 1010
"RTN","SDPURG1",7,0)
A F B="C","OST","ST" F C=0:0 S C=$O(^SC(A,B,C)) Q:'C!(C'<SDLIM1)  D MORE,DOT
"RTN","SDPURG1",8,0)
 Q
"RTN","SDPURG1",9,0)
1010 F A=0:0 S A=$O(^SC("AAS",A)) W:'A !,SDCT," 10/10 AND UNSCHEDULED XREFS PURGED",!!,"End of Hospital Location purge" Q:'A  F B=0:0 S B=$O(^SC("AAS",A,B)) Q:'B!(B'<SDLIM1)  D MORE3 S X="^SC(""AAS"","_A_","_B_")" K @X D DOT
"RTN","SDPURG1",10,0)
SD2 G:'SD2 END D NOW^%DTC S SDCT=0 G ^SDPURG2
"RTN","SDPURG1",11,0)
DOT W:'(SDCT#100)&('SDPR) "." Q
"RTN","SDPURG1",12,0)
SETA S $P(^SC(A,"S",0),"^",4)="",POP=1 Q
"RTN","SDPURG1",13,0)
ENDA W !,SDCT," APPTS AND MISCELLANEOUS HOSPITAL LOCATION NODES DELETED" Q
"RTN","SDPURG1",14,0)
PRTS S:'$D(^SC(A,"S",0)) ^(0)="^44.001DA^^" S:'$D(^SC(A,"S",B,1,0)) ^(0)="^44.003PA^^"
"RTN","SDPURG1",15,0)
 W:$D(^SC(A,"S",B,0))&(SDPR) !,$P(X,")")_",0) = ",^(0) F C=0:0 S C=$O(^SC(A,"S",B,1,C)) Q:'C  W:SDPR !,$P(X,")")_",1,"_C_",0) = ",^(C,0) S SDCT=SDCT+1
"RTN","SDPURG1",16,0)
 Q
"RTN","SDPURG1",17,0)
D ;K ^SC(A,"S",B) Q  ;original line
"RTN","SDPURG1",18,0)
 S DA(1)=A,DA=B,DIK="^SC("_DA(1)_",""S""," D ^DIK Q
"RTN","SDPURG1",19,0)
MORE S J=-1
"RTN","SDPURG1",20,0)
 I B["ST" F I=0:0 S J=$O(^SC(A,B,C,J)) Q:J=""  S:'$D(^SC(A,B,0)) ^(0)="^"_$S(B="ST":"44.005",1:"44.002")_"DA^^" S X="^SC("_A_","""_B_""","_C_","_$S(+J=J:J,1:""""_J_"""")_")",POP=1 D KILL,CT S:B="OST"&('$D(^SC(A,"OST",C,0))) ^(0)=C
"RTN","SDPURG1",21,0)
 I B'["ST" S X="^SC("_A_","""_B_""","_C_",0)",POP=1 D KILL,CT F I=0:0 S I=$O(^SC(A,B,C,1,I)) Q:'I  S X="^SC("_A_","""_B_""","_C_",1,"_I_",0)",POP=1 D KILL,CT
"RTN","SDPURG1",22,0)
 S DA(1)=A,DA=C,DIK="^SC("_DA(1)_","""_B_""",",X=DIK_C_")" D ^DIK K DIK Q
"RTN","SDPURG1",23,0)
MORE3 F I=0:0 S I=$O(^SC("AAS",A,B,I)) Q:'I  S POP=1,X="^SC(""AAS"","_A_","_B_","_I_")" D KILL,CT
"RTN","SDPURG1",24,0)
 Q
"RTN","SDPURG1",25,0)
KILL I SDPR W:$S(($D(@X)#2):1,1:0) !,X," = ",@X
"RTN","SDPURG1",26,0)
 I POP S POP=0 Q
"RTN","SDPURG1",27,0)
 Q
"RTN","SDPURG1",28,0)
CT S SDCT=SDCT+1 Q
"RTN","SDPURG1",29,0)
 D ^DIK Q
"RTN","SDPURG1",30,0)
END W !!,"*** SCHEDULING PURGE COMPLETED *** " D NOW^%DTC S Y=% D DT^DIQ
"RTN","SDPURG1",31,0)
 I SD44!(SD2) W ! W:SD44 "Hospital Location " W:SD44&(SD2) "and " W:SD2 "Patient " W "file nodes have been purged through: " S X1=SDLIM1,X2=-1 D C^%DTC S Y=X D DT^DIQ
"RTN","SDPURG1",32,0)
Q K A,B,C,D,E,F,I,J,SD44,SD2,SDC,SDLIM,SDLIM1,SDCT,SDPR,X,X1,X2,Y,POP,%,%Y D CLOSE^DGUTQ Q
"RTN","SDQQCN2")
0^23^B2209146
"RTN","SDQQCN2",1,0)
SDQQCN2 ;ALB/MJK - COMMENT to REQUEST/CONSULTATION ; 3/23/06 12:10pm
"RTN","SDQQCN2",2,0)
 ;;5.3;Scheduling;**478**;Aug 13, 1993
"RTN","SDQQCN2",3,0)
 ;
"RTN","SDQQCN2",4,0)
 ;IA#2980 GMRCGUIB
"RTN","SDQQCN2",5,0)
 ; Code taken from ORQQCN2
"RTN","SDQQCN2",6,0)
 ; OR variables in ORQQCN2 replaced with SD names.
"RTN","SDQQCN2",7,0)
CMT(SDERR,SDIEN,SDCOM,SDALRT,SDALTO,SDDATE) ;Add comment to existing consult without changing status
"RTN","SDQQCN2",8,0)
 ;SDIEN - IEN of consult from File 123
"RTN","SDQQCN2",9,0)
 ;SDERR - return array for results/errors
"RTN","SDQQCN2",10,0)
 ;SDCOM is the comments array to be added
"RTN","SDQQCN2",11,0)
 ;     passed in as SDCOM(1)="Xxxx Xxxxx...",SDCOM(2)="Xxxx Xx Xxx...", SDCOM(3)="Xxxxx Xxx Xx...", etc.
"RTN","SDQQCN2",12,0)
 ;SDALRT - should alerts be sent to anyone?
"RTN","SDQQCN2",13,0)
 ;SDALTO - array of alert recipient IENs
"RTN","SDQQCN2",14,0)
 N SDAD,SDDUZ,SDNP,X,I
"RTN","SDQQCN2",15,0)
 S SDERR=0,SDAD=$S($D(SDDATE):SDDATE,1:$$NOW^XLFDT),SDNP=""
"RTN","SDQQCN2",16,0)
 I '$D(SDCOM) S SDERR="1^Comments required - no action taken" Q
"RTN","SDQQCN2",17,0)
 I '$D(^GMR(123,SDIEN)) S SDERR="1^No such consult" Q
"RTN","SDQQCN2",18,0)
 I $G(SDALRT)=1 D
"RTN","SDQQCN2",19,0)
 .F I=1:1  S X=$P(SDALTO,";",I) Q:X=""  S SDDUZ(X)=""
"RTN","SDQQCN2",20,0)
 D CMT^GMRCGUIB(SDIEN,.SDCOM,.SDDUZ,SDAD,DUZ)
"RTN","SDQQCN2",21,0)
 Q
"RTN","SDQQCN2",22,0)
 ;
"RTN","SDQQCN2",23,0)
SCH(SDERR,SDIEN,SDNP,SDDATE,SDALRT,SDALTO,SDCOM) ;Schedule consult and change status
"RTN","SDQQCN2",24,0)
 ;SDERR - return array for results/errors
"RTN","SDQQCN2",25,0)
 ;SDIEN - IEN of consult from File 123
"RTN","SDQQCN2",26,0)
 ;SDNP - Provider who Scheduled consult
"RTN","SDQQCN2",27,0)
 ;SDDATE - Date/Time Consult was scheduled.
"RTN","SDQQCN2",28,0)
 ;SDALRT - should alerts be sent to anyone?
"RTN","SDQQCN2",29,0)
 ;SDALTO - array of alert recipient IENs
"RTN","SDQQCN2",30,0)
 ;SDCOM is the comments array to be added
"RTN","SDQQCN2",31,0)
 ;     passed in as SDCOM(1)="Xxxx Xxxxx...",SDCOM(2)="Xxxx Xx Xxx...", SDCOM(3)="Xxxxx Xxx Xx...", etc.
"RTN","SDQQCN2",32,0)
 N SDAD,SDDUZ,X
"RTN","SDQQCN2",33,0)
 S SDERR=0,SDAD=$S($D(SDDATE):SDDATE,1:$$NOW^XLFDT)
"RTN","SDQQCN2",34,0)
 S:+$G(SDNP)=0 SDNP=DUZ
"RTN","SDQQCN2",35,0)
 I '$D(^GMR(123,SDIEN)) S SDERR="1^No such consult" Q
"RTN","SDQQCN2",36,0)
 I $G(SDALRT)=1 D
"RTN","SDQQCN2",37,0)
 .F I=1:1  S X=$P(SDALTO,";",I) Q:X=""  S SDDUZ(X)=""
"RTN","SDQQCN2",38,0)
 S SDERR=$$SCH^GMRCGUIB(SDIEN,SDNP,SDAD,.SDDUZ,.SDCOM)
"RTN","SDQQCN2",39,0)
 Q
"UP",44,44.003,-2)
44^S
"UP",44,44.003,-1)
44.001^1
"UP",44,44.003,0)
44.003
"VER")
8.0^22.0
"^DD",44,44.003,688,0)
CONSULT LINK^P123'^GMR(123,^CONS;1^Q
"^DD",44,44.003,688,1,0)
^.1^^-1
"^DD",44,44.003,688,1,1,0)
44^AWAS1
"^DD",44,44.003,688,1,1,1)
S ^SC("AWAS1",$E(X,1,30),DA(2),DA(1),DA)=""
"^DD",44,44.003,688,1,1,2)
K ^SC("AWAS1",$E(X,1,30),DA(2),DA(1),DA)
"^DD",44,44.003,688,1,1,"%D",0)
^^1^1^3060313^
"^DD",44,44.003,688,1,1,"%D",1,0)
This is used as a backward pointer.
"^DD",44,44.003,688,1,1,"DT")
3060313
"^DD",44,44.003,688,1,2,0)
44^AHST1^MUMPS
"^DD",44,44.003,688,1,2,1)
Q:$G(SDSEED)  S XX=X,%DT="ST",X="NOW" D ^%DT S X=XX,^SC("AHST1",$E(X,1,30),Y,DA(2),DA(1),DA)=""
"^DD",44,44.003,688,1,2,2)
Q
"^DD",44,44.003,688,1,2,"%D",0)
^.101^1^1^3060524^^
"^DD",44,44.003,688,1,2,"%D",1,0)
This x-ref is used to track historical data.
"^DD",44,44.003,688,1,2,"DT")
3060524
"^DD",44,44.003,688,3)
Enter the consult associated with this appointment.
"^DD",44,44.003,688,21,0)
^.001^1^1^3060313^^
"^DD",44,44.003,688,21,1,0)
This field links the appointment to a consult.
"^DD",44,44.003,688,"DT")
3060524
**INSTALL NAME**
GMRC*3.0*52
"BLD",6014,0)
GMRC*3.0*52^CONSULT/REQUEST TRACKING^0^3060628^y
"BLD",6014,1,0)
^^1^1^3060321^
"BLD",6014,1,1,0)
CONSULT/SCHEDULING LINK
"BLD",6014,4,0)
^9.64PA^123^2
"BLD",6014,4,123,0)
123
"BLD",6014,4,123,2,0)
^9.641^123^2
"BLD",6014,4,123,2,123,0)
REQUEST/CONSULTATION  (File-top level)
"BLD",6014,4,123,2,123,1,0)
^9.6411^8^1
"BLD",6014,4,123,2,123,1,8,0)
CPRS STATUS
"BLD",6014,4,123,2,123.02,0)
REQUEST PROCESSING ACTIVITY  (sub-file)
"BLD",6014,4,123,2,123.02,1,0)
^9.6411^6^1
"BLD",6014,4,123,2,123.02,1,6,0)
FORWARDED FROM
"BLD",6014,4,123,222)
y^n^p^^^^n^^n
"BLD",6014,4,123,224)

"BLD",6014,4,123.5,0)
123.5
"BLD",6014,4,123.5,2,0)
^9.641^123.5688^1
"BLD",6014,4,123.5,2,123.5688,0)
ASSOCIATED STOP CODE  (sub-file)
"BLD",6014,4,123.5,2,123.5688,1,0)
^9.6411^^0
"BLD",6014,4,123.5,222)
y^n^p^^^^n^^n
"BLD",6014,4,123.5,224)

"BLD",6014,4,"APDD",123,123)

"BLD",6014,4,"APDD",123,123,8)

"BLD",6014,4,"APDD",123,123.02)

"BLD",6014,4,"APDD",123,123.02,6)

"BLD",6014,4,"APDD",123.5,123.5688)

"BLD",6014,4,"B",123,123)

"BLD",6014,4,"B",123.5,123.5)

"BLD",6014,"ABPKG")
n
"BLD",6014,"INI")
PRE^GMRC3P52
"BLD",6014,"INIT")
POST^GMRC3P52
"BLD",6014,"KRN",0)
^9.67PA^8989.52^19
"BLD",6014,"KRN",.4,0)
.4
"BLD",6014,"KRN",.401,0)
.401
"BLD",6014,"KRN",.402,0)
.402
"BLD",6014,"KRN",.403,0)
.403
"BLD",6014,"KRN",.5,0)
.5
"BLD",6014,"KRN",.84,0)
.84
"BLD",6014,"KRN",3.6,0)
3.6
"BLD",6014,"KRN",3.8,0)
3.8
"BLD",6014,"KRN",9.2,0)
9.2
"BLD",6014,"KRN",9.8,0)
9.8
"BLD",6014,"KRN",9.8,"NM",0)
^9.68A^6^5
"BLD",6014,"KRN",9.8,"NM",1,0)
GMRC3P52^^0^B28981915
"BLD",6014,"KRN",9.8,"NM",3,0)
GMRCONS1^^0^B53960049
"BLD",6014,"KRN",9.8,"NM",4,0)
GMRCONS2^^0^B64110738
"BLD",6014,"KRN",9.8,"NM",5,0)
GMRCONS3^^0^B45564463
"BLD",6014,"KRN",9.8,"NM",6,0)
GMRCGUIS^^0^B3928168
"BLD",6014,"KRN",9.8,"NM","B","GMRC3P52",1)

"BLD",6014,"KRN",9.8,"NM","B","GMRCGUIS",6)

"BLD",6014,"KRN",9.8,"NM","B","GMRCONS1",3)

"BLD",6014,"KRN",9.8,"NM","B","GMRCONS2",4)

"BLD",6014,"KRN",9.8,"NM","B","GMRCONS3",5)

"BLD",6014,"KRN",19,0)
19
"BLD",6014,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",6014,"KRN",19,"NM",1,0)
GMRC RPT SD SCH-MGT CONSULTS^^0
"BLD",6014,"KRN",19,"NM","B","GMRC RPT SD SCH-MGT CONSULTS",1)

"BLD",6014,"KRN",19.1,0)
19.1
"BLD",6014,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",6014,"KRN",101,0)
101
"BLD",6014,"KRN",101,"NM",0)
^9.68A^4^4
"BLD",6014,"KRN",101,"NM",1,0)
GMRC SD CONSLTS SELECT SERVICE^^0
"BLD",6014,"KRN",101,"NM",2,0)
GMRC SD CONSLTS SELECT STATUS^^0
"BLD",6014,"KRN",101,"NM",3,0)
GMRC SD OUTSTANDING CONSULTS MENU^^0
"BLD",6014,"KRN",101,"NM",4,0)
GMRC COLUMN WIDTH PRINT LIST^^4^
"BLD",6014,"KRN",101,"NM","B","GMRC COLUMN WIDTH PRINT LIST",4)

"BLD",6014,"KRN",101,"NM","B","GMRC SD CONSLTS SELECT SERVICE",1)

"BLD",6014,"KRN",101,"NM","B","GMRC SD CONSLTS SELECT STATUS",2)

"BLD",6014,"KRN",101,"NM","B","GMRC SD OUTSTANDING CONSULTS MENU",3)

"BLD",6014,"KRN",409.61,0)
409.61
"BLD",6014,"KRN",409.61,"NM",0)
^9.68A^1^1
"BLD",6014,"KRN",409.61,"NM",1,0)
GMRC SD PENDING CONSULTS^^0
"BLD",6014,"KRN",409.61,"NM","B","GMRC SD PENDING CONSULTS",1)

"BLD",6014,"KRN",771,0)
771
"BLD",6014,"KRN",870,0)
870
"BLD",6014,"KRN",8989.51,0)
8989.51
"BLD",6014,"KRN",8989.52,0)
8989.52
"BLD",6014,"KRN",8994,0)
8994
"BLD",6014,"KRN","B",.4,.4)

"BLD",6014,"KRN","B",.401,.401)

"BLD",6014,"KRN","B",.402,.402)

"BLD",6014,"KRN","B",.403,.403)

"BLD",6014,"KRN","B",.5,.5)

"BLD",6014,"KRN","B",.84,.84)

"BLD",6014,"KRN","B",3.6,3.6)

"BLD",6014,"KRN","B",3.8,3.8)

"BLD",6014,"KRN","B",9.2,9.2)

"BLD",6014,"KRN","B",9.8,9.8)

"BLD",6014,"KRN","B",19,19)

"BLD",6014,"KRN","B",19.1,19.1)

"BLD",6014,"KRN","B",101,101)

"BLD",6014,"KRN","B",409.61,409.61)

"BLD",6014,"KRN","B",771,771)

"BLD",6014,"KRN","B",870,870)

"BLD",6014,"KRN","B",8989.51,8989.51)

"BLD",6014,"KRN","B",8989.52,8989.52)

"BLD",6014,"KRN","B",8994,8994)

"BLD",6014,"PRE")

"BLD",6014,"QUES",0)
^9.62^^
"BLD",6014,"REQB",0)
^9.611^1^1
"BLD",6014,"REQB",1,0)
SD*5.3*478^2
"BLD",6014,"REQB","B","SD*5.3*478",1)

"FIA",123)
REQUEST/CONSULTATION
"FIA",123,0)
^GMR(123,
"FIA",123,0,0)
123DI
"FIA",123,0,1)
y^n^p^^^^n^^n
"FIA",123,0,10)

"FIA",123,0,11)

"FIA",123,0,"RLRO")

"FIA",123,0,"VR")
3.0^GMRC
"FIA",123,123)
1
"FIA",123,123,8)

"FIA",123,123.02)
1
"FIA",123,123.02,6)

"FIA",123.5)
REQUEST SERVICES
"FIA",123.5,0)
^GMR(123.5,
"FIA",123.5,0,0)
123.5I
"FIA",123.5,0,1)
y^n^p^^^^n^^n
"FIA",123.5,0,10)

"FIA",123.5,0,11)

"FIA",123.5,0,"RLRO")

"FIA",123.5,0,"VR")
3.0^GMRC
"FIA",123.5,123.5)
1
"FIA",123.5,123.5,688)

"FIA",123.5,123.5688)
0
"INI")
PRE^GMRC3P52
"INIT")
POST^GMRC3P52
"IX",123,123,"AE",0)
123^AE^Index by SERVICE, STATUS, DATE OF REQUEST^R^^R^IR^I^123^^^^^S
"IX",123,123,"AE",.1,0)
^^2^2^3050427
"IX",123,123,"AE",.1,1,0)
This cross reference is used for services to see all consults by service,
"IX",123,123,"AE",.1,2,0)
OE/RR status and Date of Request.
"IX",123,123,"AE",1)
S ^GMR(123,"AE",$E(X(1),1,5),$E(X(2),1,5),$E(X(3),1,20),DA)=""
"IX",123,123,"AE",2)
K ^GMR(123,"AE",$E(X(1),1,5),$E(X(2),1,5),$E(X(3),1,20),DA)
"IX",123,123,"AE",2.5)
K ^GMR(123,"AE")
"IX",123,123,"AE",11.1,0)
^.114IA^3^3
"IX",123,123,"AE",11.1,1,0)
1^F^123^1^5^1^F
"IX",123,123,"AE",11.1,2,0)
2^F^123^8^5^2^F
"IX",123,123,"AE",11.1,3,0)
3^F^123^3^20^3^F
"IX",123,123,"AE",11.1,3,2)
S X=9999999-X
"KRN",19,12541,-1)
0^1
"KRN",19,12541,0)
GMRC RPT SD SCH-MGT CONSULTS^Service Consults Schedule-Management Report^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,12541,25)
EN^GMRCONS1
"KRN",19,12541,"U")
SERVICE CONSULTS SCHEDULE-MANA
"KRN",101,3489,-1)
4^4
"KRN",101,3489,0)
GMRC COLUMN WIDTH PRINT LIST
"KRN",101,4343,-1)
0^2
"KRN",101,4343,0)
GMRC SD CONSLTS SELECT STATUS^Status^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,4343,1,0)
^^2^2^3060410^
"KRN",101,4343,1,1,0)
List Manager Protocol:  Select a list of statuses for displaying consults 
"KRN",101,4343,1,2,0)
still pending resolution (all consults not discontinued or complete.)
"KRN",101,4343,2,0)
^101.02A^^0
"KRN",101,4343,4)
24^2
"KRN",101,4343,15)
S VALMBCK="R"
"KRN",101,4343,20)
S VALMBG=1,GMRCSTAT="" D NEWSTS^GMRCONS3
"KRN",101,4343,99)
60424,38895
"KRN",101,4344,-1)
0^1
"KRN",101,4344,0)
GMRC SD CONSLTS SELECT SERVICE^Service^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,4344,1,0)
^^2^2^3060410^
"KRN",101,4344,1,1,0)
List Manager Protocol:  Select a new service for displaying consults 
"KRN",101,4344,1,2,0)
still pending resolution (all consults not discontinued or complete.)
"KRN",101,4344,2,0)
^101.02A^^0
"KRN",101,4344,4)
24^2
"KRN",101,4344,15)
S VALMBCK="R"
"KRN",101,4344,20)
K GMRNOSRV D SERV^GMRCONS1 S:$D(GMRNOSRV) VALMBCK="R" Q:$D(GMRNOSRV)  K ^TMP("GMRCR",$J) S VALMBG=1 D START^GMRCONS1
"KRN",101,4344,99)
60424,38895
"KRN",101,4345,-1)
0^3
"KRN",101,4345,0)
GMRC SD OUTSTANDING CONSULTS MENU^Print Outstanding Consults By Service^^M^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,4345,1,0)
^^3^3^3060410^
"KRN",101,4345,1,1,0)
List Manager Protocol to print outstanding consults by service for QC 
"KRN",101,4345,1,2,0)
purposes.  In this option, ALL SERVICES is not allowed to be entered at 
"KRN",101,4345,1,3,0)
the SERVICE: prompt.
"KRN",101,4345,4)
18
"KRN",101,4345,10,0)
^101.01PA^4^4
"KRN",101,4345,10,2,0)
4344^SV^1^
"KRN",101,4345,10,2,"^")
GMRC SD CONSLTS SELECT SERVICE
"KRN",101,4345,10,3,0)
4343^ST^2^
"KRN",101,4345,10,3,"^")
GMRC SD CONSLTS SELECT STATUS
"KRN",101,4345,10,4,0)
3489^PR^4^
"KRN",101,4345,10,4,"^")
GMRC COLUMN WIDTH PRINT LIST
"KRN",101,4345,26)
D SHOW^VALM
"KRN",101,4345,99)
60424,38895
"KRN",409.61,760,-1)
0^1
"KRN",409.61,760,0)
GMRC SD PENDING CONSULTS^1^1^102^5^20^1^1^^GMRC SD OUTSTANDING CONSULTS MENU^Service Consults By Status^1^^1
"KRN",409.61,760,1)
^GMRC COLUMN WIDTH HIDDEN MENU
"KRN",409.61,760,"ARRAY")
 ^TMP("GMRCR",$J,"CP")
"KRN",409.61,760,"COL",0)
^409.621^1^1
"KRN",409.61,760,"COL",1,0)
CAPTION LINE^2^79
"KRN",409.61,760,"COL","B","CAPTION LINE",1)

"KRN",409.61,760,"FNL")
D KILL^VALM10(),CLEAR^VALM1,EXIT^GMRCPC
"KRN",409.61,760,"HDR")
D HDR^GMRCPC
"KRN",409.61,760,"HLP")
D HELP^GMRCPC
"KRN",409.61,760,"INIT")
D START^GMRCONS1
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",222,-1)
1^1
"PKG",222,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",222,20,0)
^9.402P^^
"PKG",222,22,0)
^9.49I^1^1
"PKG",222,22,1,0)
3.0
"PKG",222,22,1,"PAH",1,0)
52^3060628^123456810
"PKG",222,22,1,"PAH",1,1,0)
^^1^1^3060628
"PKG",222,22,1,"PAH",1,1,1,0)
CONSULT/SCHEDULING LINK
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","GMRC3P52")
0^1^B28981915
"RTN","GMRC3P52",1,0)
GMRC3P52 ;ALB/MRY - POST INIT ;04/14/06  
"RTN","GMRC3P52",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**52**;DEC 27, 1997
"RTN","GMRC3P52",3,0)
 ;
"RTN","GMRC3P52",4,0)
EN ;
"RTN","GMRC3P52",5,0)
 S XPDABORT=""
"RTN","GMRC3P52",6,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^") D  G ABRT
"RTN","GMRC3P52",7,0)
 . D BMES^XPDUTL("*****")
"RTN","GMRC3P52",8,0)
 . D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","GMRC3P52",9,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","GMRC3P52",10,0)
 W !!,">> Environment check complete and okay."
"RTN","GMRC3P52",11,0)
 I XPDABORT="" K XPDABORT
"RTN","GMRC3P52",12,0)
 Q
"RTN","GMRC3P52",13,0)
 ;
"RTN","GMRC3P52",14,0)
ABRT ; Abort transport, but leave in ^XTMP.
"RTN","GMRC3P52",15,0)
 S XPDABORT=2 Q
"RTN","GMRC3P52",16,0)
 ;
"RTN","GMRC3P52",17,0)
PRE ;Set seed flag, so, 'AHST' xref of the new Consult Link field (#688)
"RTN","GMRC3P52",18,0)
 ;of the Hospital Location file (#44) doesn't get set during install.
"RTN","GMRC3P52",19,0)
 S SDSEED=1
"RTN","GMRC3P52",20,0)
 Q
"RTN","GMRC3P52",21,0)
POST ;-------------------------------------------------------------------
"RTN","GMRC3P52",22,0)
 ;Add option to menu.
"RTN","GMRC3P52",23,0)
 N GMRCOK
"RTN","GMRC3P52",24,0)
 S GMRCOK=$$ADD^XPDMENU("GMRC REPORTS","GMRC RPT SD SCH-MGT CONSULTS","SH",6)
"RTN","GMRC3P52",25,0)
 D BMES^XPDUTL("*****")
"RTN","GMRC3P52",26,0)
 I GMRCOK=1 D
"RTN","GMRC3P52",27,0)
 .D MES^XPDUTL("Adding option 'Service Consults Schedule-Management Report'")
"RTN","GMRC3P52",28,0)
 .D MES^XPDUTL("               to 'Consult Tracking Reports' menu.")
"RTN","GMRC3P52",29,0)
 E  D
"RTN","GMRC3P52",30,0)
 .D MES^XPDUTL("Error - 'Service Consults Schedule-Management Report' option not added.")
"RTN","GMRC3P52",31,0)
 .D BMES^XPDUTL("*****")
"RTN","GMRC3P52",32,0)
 ;
"RTN","GMRC3P52",33,0)
 ;---------------------------------------------------------------------
"RTN","GMRC3P52",34,0)
 ;Post-init for sites running Class 3 software.
"RTN","GMRC3P52",35,0)
 ;
"RTN","GMRC3P52",36,0)
 ;Quit, if Class 3 field not installed.
"RTN","GMRC3P52",37,0)
 ;
"RTN","GMRC3P52",38,0)
 ;File 123.5
"RTN","GMRC3P52",39,0)
 ;   Loop down Class 3 ^GMR("AB" xref. to build new entries.
"RTN","GMRC3P52",40,0)
 ;   Sites can remove Class 3 field when satisfied of changes.
"RTN","GMRC3P52",41,0)
 ;
"RTN","GMRC3P52",42,0)
 ;---------------------------------------------------------------------
"RTN","GMRC3P52",43,0)
 ;Convert #123.5 Class 3 ASSOCIATED STOP CODE field and xrefs.
"RTN","GMRC3P52",44,0)
 I '$D(^GMR(123.5,"AB")),'$D(^XTMP("GMRC3P52")) Q  ;quit, no Class 3 data.
"RTN","GMRC3P52",45,0)
 D BMES^XPDUTL("*****")
"RTN","GMRC3P52",46,0)
 N GMRX,GMRDA,GMRSTOP,DIC
"RTN","GMRC3P52",47,0)
 ;Check/create ^XTMP for conversion run to completion.
"RTN","GMRC3P52",48,0)
 I $D(^XTMP("GMRC3P52")) D  I $G(GMRSTOP) G CONS
"RTN","GMRC3P52",49,0)
 . I $P($G(^XTMP("GMRC3P52",1)),U,2)="DONE" D
"RTN","GMRC3P52",50,0)
 .. S GMRSTOP=1
"RTN","GMRC3P52",51,0)
 .. D MES^XPDUTL("Conversion of Class III Associated Stop Codes already run to completion.")
"RTN","GMRC3P52",52,0)
 .. D MES^XPDUTL(" ")
"RTN","GMRC3P52",53,0)
 . E  S GMRX=+$P($G(^XTMP("GMRC3P52",1)),U)
"RTN","GMRC3P52",54,0)
 E  S ^XTMP("GMRC3P52",0)=$$FMADD^XLFDT(DT,90)_"^"_DT
"RTN","GMRC3P52",55,0)
 D MES^XPDUTL("...Moving File #123.5, ASSOCIATED STOP CODE (Class 3) field entries...")
"RTN","GMRC3P52",56,0)
 D MES^XPDUTL(" ")
"RTN","GMRC3P52",57,0)
 I $G(GMRX)']0 S GMRX=0
"RTN","GMRC3P52",58,0)
 F  S GMRX=$O(^GMR(123.5,"AB",GMRX)) Q:'GMRX  D
"RTN","GMRC3P52",59,0)
 . S GMRDA=0 F  S GMRDA=$O(^GMR(123.5,"AB",GMRX,GMRDA)) Q:'GMRDA  D
"RTN","GMRC3P52",60,0)
 .. ;check for duplicate.  FILE^DICN call will add duplicates.
"RTN","GMRC3P52",61,0)
 .. I +$O(^GMR(123.5,"AB1",GMRX,GMRDA,0)) Q
"RTN","GMRC3P52",62,0)
 .. K DIC("DR")
"RTN","GMRC3P52",63,0)
 .. S DA(1)=GMRDA
"RTN","GMRC3P52",64,0)
 .. S DIC="^GMR(123.5,"_DA(1)_",688,"
"RTN","GMRC3P52",65,0)
 .. S DIC(0)="L",DIC("P")=$P(^DD(123.5,688,0),"^",2)
"RTN","GMRC3P52",66,0)
 .. S DIC("DR")="688///"_GMRX
"RTN","GMRC3P52",67,0)
 .. S X=GMRX
"RTN","GMRC3P52",68,0)
 .. K D0 D FILE^DICN
"RTN","GMRC3P52",69,0)
 .. I Y=-1 Q
"RTN","GMRC3P52",70,0)
 .. S $P(^XTMP("GMRC3P52",1),U)=GMRX
"RTN","GMRC3P52",71,0)
 S $P(^XTMP("GMRC3P52",1),U,2)="DONE"
"RTN","GMRC3P52",72,0)
 ;
"RTN","GMRC3P52",73,0)
CONS ;---------------------------------------------------------------------
"RTN","GMRC3P52",74,0)
 ;Post-init for sites running Class 3 software.
"RTN","GMRC3P52",75,0)
 ;
"RTN","GMRC3P52",76,0)
 ;Quit, if Class 3 field not installed.
"RTN","GMRC3P52",77,0)
 ;
"RTN","GMRC3P52",78,0)
 ;File 44
"RTN","GMRC3P52",79,0)
 ;   Loop down Class 3 ^SC("AWAS" xref. to build new entries.
"RTN","GMRC3P52",80,0)
 ;---------------------------------------------------------------------
"RTN","GMRC3P52",81,0)
 ;
"RTN","GMRC3P52",82,0)
 ;Convert HOSPITAL LOCATION Class III CONSULT LINK field and xrefs.
"RTN","GMRC3P52",83,0)
 I '$D(^SC("AWAS")),'$D(^XTMP("SD53P478")) Q  ;quit, no Class 3 data
"RTN","GMRC3P52",84,0)
 N CNSLTLNK,SDC,SDT,SDY,DA,DIE,DR,SDSTOP
"RTN","GMRC3P52",85,0)
 ;Check/create ^XTMP for conversion run to completion.
"RTN","GMRC3P52",86,0)
 I $D(^XTMP("SD53P478")) D  I $G(SDSTOP) Q
"RTN","GMRC3P52",87,0)
 . I $P($G(^XTMP("SD53P478",1)),U,2)="DONE" D
"RTN","GMRC3P52",88,0)
 .. S SDSTOP=1
"RTN","GMRC3P52",89,0)
 .. D MES^XPDUTL("Conversion of Class III Consult Link entries already run to completion.")
"RTN","GMRC3P52",90,0)
 .. D MES^XPDUTL(" ")
"RTN","GMRC3P52",91,0)
 . E  S CNSLTLNK=+$P($G(^XTMP("SD53P478",1)),U)
"RTN","GMRC3P52",92,0)
 E  S ^XTMP("SD53P478",0)=$$FMADD^XLFDT(DT,90)_"^"_DT
"RTN","GMRC3P52",93,0)
 D MES^XPDUTL("...Moving File #44, CONSULT LINK (Class 3) field entries...")
"RTN","GMRC3P52",94,0)
 ;Loop down Class III CONSULT LINK "AWAS" xref (if exits).
"RTN","GMRC3P52",95,0)
 I $G(CNSLTLNK)']0 S CNSLTLNK=0
"RTN","GMRC3P52",96,0)
 F  S CNSLTLNK=$O(^SC("AWAS",CNSLTLNK)) Q:'CNSLTLNK  D
"RTN","GMRC3P52",97,0)
 .S SDC=0 F  S SDC=$O(^SC("AWAS",CNSLTLNK,SDC)) Q:'SDC  D
"RTN","GMRC3P52",98,0)
 ..S SDT=0 F  S SDT=$O(^SC("AWAS",CNSLTLNK,SDC,SDT)) Q:'SDT  D
"RTN","GMRC3P52",99,0)
 ...S SDY=0 F  S SDY=$O(^SC("AWAS",CNSLTLNK,SDC,SDT,SDY)) Q:'SDY  D
"RTN","GMRC3P52",100,0)
 ....;don't process if already exists (install rerun).
"RTN","GMRC3P52",101,0)
 ....Q:$D(^SC("AWAS1",CNSLTLNK,SDC,SDT,SDY))
"RTN","GMRC3P52",102,0)
 ....;create Class I CONSULT LINK field and xrefs.
"RTN","GMRC3P52",103,0)
 ....S DA(2)=SDC,DA(1)=SDT,DA=SDY
"RTN","GMRC3P52",104,0)
 ....S DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688////^S X=CNSLTLNK"
"RTN","GMRC3P52",105,0)
 ....D ^DIE
"RTN","GMRC3P52",106,0)
 . S $P(^XTMP("SD53P478",1),U)=CNSLTLNK
"RTN","GMRC3P52",107,0)
 S $P(^XTMP("SD53P478",1),U,2)="DONE"
"RTN","GMRC3P52",108,0)
 ;move Class 3 'AHST' Consult history to new 'AHST1' xref.
"RTN","GMRC3P52",109,0)
 D MES^XPDUTL("  ....Restoring historical cross reference entries.")
"RTN","GMRC3P52",110,0)
 M ^SC("AHST1")=^SC("AHST")
"RTN","GMRC3P52",111,0)
 D BMES^XPDUTL("Class III Conversion Complete.")
"RTN","GMRC3P52",112,0)
 K SDSEED
"RTN","GMRC3P52",113,0)
 D BMES^XPDUTL("*****")
"RTN","GMRC3P52",114,0)
 ;
"RTN","GMRC3P52",115,0)
NOTIFY ;Send notification
"RTN","GMRC3P52",116,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,XMZ
"RTN","GMRC3P52",117,0)
 I '$G(GMRSTOP),'$G(SDSTOP),($P($G(^XTMP("GMRC3P52",1)),U,2)="DONE"),($P($G(^XTMP("SD53P478",1)),U,2)="DONE") D
"RTN","GMRC3P52",118,0)
 . S XMDUZ="APPOINTMENT/CONSULT LINK"
"RTN","GMRC3P52",119,0)
 . S XMSUB="Class 3 Consults Conversion Complete"
"RTN","GMRC3P52",120,0)
 . S XMTEXT="^TMP(""GMRC3P52"",$J,"
"RTN","GMRC3P52",121,0)
 . S XMY(DUZ)=""
"RTN","GMRC3P52",122,0)
 . S ^TMP("GMRC3P52",$J,1)=" "
"RTN","GMRC3P52",123,0)
 . S ^TMP("GMRC3P52",$J,2)="The conversion of your ASSOCIATED STOP CODES and CONSULT LINK Class III entries"
"RTN","GMRC3P52",124,0)
 . S ^TMP("GMRC3P52",$J,3)="to the new Class I fields in patch SD*5.3*478 has successfully completed."
"RTN","GMRC3P52",125,0)
 . S ^TMP("GMRC3P52",$J,4)=" "
"RTN","GMRC3P52",126,0)
 . S ^TMP("GMRC3P52",$J,5)="After completely satified with you conversion, please follow the instructions"
"RTN","GMRC3P52",127,0)
 . S ^TMP("GMRC3P52",$J,6)="in the Patch Installation Guide for removing your Class III fields."
"RTN","GMRC3P52",128,0)
 . D ^XMD K ^TMP("GMRC3P52",$J),XMY
"RTN","GMRC3P52",129,0)
 Q
"RTN","GMRCGUIS")
0^6^B3928168
"RTN","GMRCGUIS",1,0)
GMRCGUIS ;ALB/TDP - update Consult Status ;4/26/2006
"RTN","GMRCGUIS",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**52**;DEC 27, 1997
"RTN","GMRCGUIS",3,0)
 ;
"RTN","GMRCGUIS",4,0)
 ;Called by SDCNSLT for Scheduling Consult Appointment Linkage
"RTN","GMRCGUIS",5,0)
STATUS(GMRCO,GMRCSTS,GMRCA,GMRCORNP,GMRCAD,GMRCADUZ,GMRCMT) ;Change status/last action/add comment consult API
"RTN","GMRCGUIS",6,0)
 ; Input variables:
"RTN","GMRCGUIS",7,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIS",8,0)
 ;GMRCSTS - Status of the consult
"RTN","GMRCGUIS",9,0)
 ;GMRCA - Last Action to be added to the consult
"RTN","GMRCGUIS",10,0)
 ;GMRCORNP - Name of the person who actually 'Received' the consult 
"RTN","GMRCGUIS",11,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIS",12,0)
 ;GMRCADUZ - array of alert recipients as chosen by user (by reference)
"RTN","GMRCGUIS",13,0)
 ;   ARRAY(DUZ)="" 
"RTN","GMRCGUIS",14,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIS",15,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIS",16,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIS",17,0)
 ;
"RTN","GMRCGUIS",18,0)
 ;Output:
"RTN","GMRCGUIS",19,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIS",20,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIS",21,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIS",22,0)
 ;
"RTN","GMRCGUIS",23,0)
 N DFN,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIS",24,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT,GMRCMT=0
"RTN","GMRCGUIS",25,0)
 I 'GMRCSTS!('GMRCA) D  Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIS",26,0)
 . S GMRCERR="1",GMRCERMS="Status/last action update is missing or wrong."
"RTN","GMRCGUIS",27,0)
 . D EXIT^GMRCGUIA
"RTN","GMRCGUIS",28,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIS",29,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIS",30,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" D  Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIS",31,0)
 . S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found."
"RTN","GMRCGUIS",32,0)
 . D EXIT^GMRCGUIA
"RTN","GMRCGUIS",33,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT^GMRCGUIA Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIS",34,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIS",35,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIS",36,0)
 . S DA=$$SETDA^GMRCGUIB
"RTN","GMRCGUIS",37,0)
 . S GMRCMT(0)=DA,GMRCMT=1
"RTN","GMRCGUIS",38,0)
 . D SETCOM^GMRCGUIB(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIS",39,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"",.GMRCMT,"",GMRCAD)
"RTN","GMRCGUIS",40,0)
 D  ;send alerts
"RTN","GMRCGUIS",41,0)
 . N TXT
"RTN","GMRCGUIS",42,0)
 . S TXT="Comment Added to Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIS",43,0)
 . I $P(^GMR(123,+GMRCO,0),U,14) S GMRCADUZ($P(^(0),U,14))=""
"RTN","GMRCGUIS",44,0)
 . D MSG^GMRCP(DFN,TXT,GMRCO,63,.GMRCADUZ,0)
"RTN","GMRCGUIS",45,0)
 D EXIT^GMRCGUIA
"RTN","GMRCGUIS",46,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCONS1")
0^3^B53960049
"RTN","GMRCONS1",1,0)
GMRCONS1 ;ALB/MRY - Consult/Scheduling link report ;4/10/06  14:21
"RTN","GMRCONS1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**52**;DEC 27, 1997
"RTN","GMRCONS1",3,0)
EN ;
"RTN","GMRCONS1",4,0)
 K GMRNOSRV D SERV Q:$D(GMRNOSRV)
"RTN","GMRCONS1",5,0)
 D EN^VALM("GMRC SD PENDING CONSULTS")
"RTN","GMRCONS1",6,0)
 Q
"RTN","GMRCONS1",7,0)
SERV I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCONS1",8,0)
 K GMRRS,STAT,DIC,TOT,TOTAL
"RTN","GMRCONS1",9,0)
 S TOTAL=0,DIC=123.5,DIC(0)="QAEMZ",DIC("A")="Select Service/Specialty: ",D="B^D" D MIX^DIC1 K DIC S:Y=-1 GMRNOSRV="" Q:Y=-1
"RTN","GMRCONS1",10,0)
 K ST,STAT S SRVNM=Y(0,0),RS=+Y,ST="",ORD=0 F  S ORD=$O(^ORD(100.01,ORD)) Q:'+ORD  S STAT(ORD)=$P(^ORD(100.01,ORD,0),U)
"RTN","GMRCONS1",11,0)
SD S %DT="EAT",%DT("A")="Enter Starting Date: " D ^%DT S:Y=-1 GMRNOSRV="" Q:Y=-1  S PSD=Y,SD=Y-.01
"RTN","GMRCONS1",12,0)
 S %DT="EAT",%DT("A")="Enter  Ending  Date: " D ^%DT S:Y=-1 GMRNOSRV="" Q:Y=-1  S ED=Y_.24
"RTN","GMRCONS1",13,0)
 I ED<SD W !!,$C(7),"Ending Date Can Not Be Before Starting Date.",! G SD
"RTN","GMRCONS1",14,0)
 Q
"RTN","GMRCONS1",15,0)
START D WAIT^DICD K ^TMP($J),^TMP("GMRCR",$J) S GMRRS("RS",RS)="",CS=RS D SERVICE
"RTN","GMRCONS1",16,0)
 S GRP=0 F  S GRP=$O(^GMR(123.5,RS,10,GRP)) Q:'+GRP  S CS=$P(^GMR(123.5,RS,10,GRP,0),U) I $P(^GMR(123.5,CS,0),U,2)'=9 S GMRRS("RS",CS)="" D SERVICE
"RTN","GMRCONS1",17,0)
 K ST F I="COMPLETE","DISCONTINUED","PENDING","ACTIVE","SCHEDULED","PARTIAL RESULTS","DISCONTINUED/EDIT","CANCELLED" S TOT(I)=0
"RTN","GMRCONS1",18,0)
 S SDI=SD F  S SDI=$O(^GMR(123,"E",SDI)) Q:'+SDI!(SDI>ED)  S GIEN=0 F  S GIEN=$O(^GMR(123,"E",SDI,GIEN)) Q:'+GIEN  S ND=^GMR(123,GIEN,0),SERV=$P(ND,U,5),STATUS=$P(ND,U,12) I SERV'="",$D(GMRRS("RS",SERV)),$D(STAT(STATUS)) D
"RTN","GMRCONS1",19,0)
 .S LSTACT=$P($G(^GMR(123.1,$P(ND,U,13),0)),U),PTIEN=$P(ND,U,2),ATDPT=$G(^DPT(PTIEN,0)),PTNM=$P(ATDPT,U),L4=$E($P(ATDPT,U,9),6,9),SRVCON=$P($G(^DPT(PTIEN,.3)),U,2),SRVCON=$S(SRVCON="":"",1:SRVCON_"%")
"RTN","GMRCONS1",20,0)
 .S AWAS1=$S($D(^SC("AWAS1",GIEN)):"LINKED",1:"NOT LINKED"),AHST1=$S($D(^SC("AHST1",GIEN)):"HAS HISTORY",1:"NO HISTORY"),STATS=$P(STAT(STATUS),U)
"RTN","GMRCONS1",21,0)
 .S ^TMP($J,"S",STATS,SDI,GIEN)=PTNM_U_PTIEN_U_LSTACT_U_AWAS1_U_AHST1_U_SERV_U_STATS_U_SDI_U_L4_U_SRVCON
"RTN","GMRCONS1",22,0)
 .S:$D(TOT(STATS)) TOT(STATS)=TOT(STATS)+1 S:'$D(TOT(STATS)) TOT(STATS)=1 S TOTAL=TOTAL+1
"RTN","GMRCONS1",23,0)
 D ^GMRCONS2
"RTN","GMRCONS1",24,0)
EXIT2 K A,ACT,AD,AHST1,ATDPT,AW,AWAS1,B,CHKOT,CLNC,CMMT,CS,CSS,ED,EN,EN2,GIEN,GMRND,GRP,GXHEC,H2,HEC,HECA,HEX,I,L4,LC,LGTH,LGTH1,LSTACT,ND,ORD,ORDATE,P3,P8,P9,PTIEN,PTNM,RS,S,SC,SCDT,SCLNC,SD,SDI,SDWL,SDWLND,SERV
"RTN","GMRCONS1",25,0)
 K SIEN,ST,STAT,STATUS,STOPCD,STPCOD,SUM,SUM2,TEXT,TND,TOT,TOTALTX,TYPE
"RTN","GMRCONS1",26,0)
 K BB,C,CLNCNM,D,GMRRS,SRV,SRVNM,STATS,SUBTOT,TOTAL,TX
"RTN","GMRCONS1",27,0)
 K PD,PSD
"RTN","GMRCONS1",28,0)
 K ASP8,ASP9,CMHD,CNSDT,CNSLT,CNSLTND,DIC,P4,POP,PRTCNDT,SRVCON,STCD,X,Y
"RTN","GMRCONS1",29,0)
 Q
"RTN","GMRCONS1",30,0)
SERVICE ;
"RTN","GMRCONS1",31,0)
 S STPCLNC="",SC=0 F  S SC=$O(^GMR(123.5,CS,688,SC)) Q:'+SC  S STPCOD=$P(^GMR(123.5,CS,688,SC,0),U) I STPCOD'="" S STPCLNC=$P(^DIC(40.7,STPCOD,0),U)_","_STPCLNC
"RTN","GMRCONS1",32,0)
 S SC=0 F  S SC=$O(^GMR(123.5,CS,688,SC)) Q:'+SC  S STPCOD=$P(^GMR(123.5,CS,688,SC,0),U) I STPCOD'="" D
"RTN","GMRCONS1",33,0)
 .S STPCOD=$P(^DIC(40.7,STPCOD,0),U,2) S:$D(^TMP($J,"SC",STPCOD)) ^TMP($J,"SC",STPCOD)=STPCLNC_^TMP($J,"SC",STPCOD) S:'$D(^TMP($J,"SC",STPCOD)) ^TMP($J,"SC",STPCOD)=STPCLNC
"RTN","GMRCONS1",34,0)
 Q
"RTN","GMRCONS1",35,0)
CLINIC ;
"RTN","GMRCONS1",36,0)
 S CLNC=$P(^GMR(123.5,A,0),U) W @IOF,CLNC," (",A,")",!
"RTN","GMRCONS1",37,0)
 Q
"RTN","GMRCONS1",38,0)
ACTIVE I '$D(^SC("AHST1",CS)) D ASP D  Q
"RTN","GMRCONS1",39,0)
 .I ASP9 S ^TMP($J,"A","ACTWOLHWL")=^TMP($J,"A","ACTWOLHWL")+1,^TMP($J,"A","ACTWOLHWL",SRV,AD,CS)=TND,WL="" D KILNODE Q
"RTN","GMRCONS1",40,0)
 .I ASP8 S ^TMP($J,"A","ACTWOLHWL")=^TMP($J,"A","ACTWOLHWL")+1,^TMP($J,"A","ACTWOLHWL",SRV,AD,CS)=TND,WL="" D KILNODE Q
"RTN","GMRCONS1",41,0)
 .I '$D(WL) D
"RTN","GMRCONS1",42,0)
 ..I $P($G(^GMR(123,CS,12)),U,5)="P" D
"RTN","GMRCONS1",43,0)
 ...S ^TMP($J,"A","ACTWOLHIFC")=^TMP($J,"A","ACTWOLHIFC")+1,^TMP($J,"A","ACTWOLHIFC",SRV,AD,CS)=TND
"RTN","GMRCONS1",44,0)
 ..E  D
"RTN","GMRCONS1",45,0)
 ...S ^TMP($J,"A","ACTWOLHNWL",SRV,AD,CS)=TND,^TMP($J,"A","ACTWOLHNWL")=^TMP($J,"A","ACTWOLHNWL")+1
"RTN","GMRCONS1",46,0)
 ..D KILNODE Q
"RTN","GMRCONS1",47,0)
 I LSTACT="EDIT/RESUBMITTED"!(LSTACT="ADDED COMMENT")!(LSTACT="STATUS CHANGE") K FND S EN2=$O(^GMR(123,CS,40,":"),-1),EN=":" F  S EN=$O(^GMR(123,CS,40,EN),-1) Q:'+EN!($D(FND))  D EDITRSB
"RTN","GMRCONS1",48,0)
 Q
"RTN","GMRCONS1",49,0)
SCHEDULE I '$D(^SC("AHST1",CS)) D ASP D  Q
"RTN","GMRCONS1",50,0)
 .I ASP9 S ^TMP($J,"A","SCHWOLHWL")=^TMP($J,"A","SCHWOLHWL")+1,^TMP($J,"A","SCHWOLHWL",SRV,AD,CS)=TND,WL="" D KILNODE Q
"RTN","GMRCONS1",51,0)
 .I ASP8 S ^TMP($J,"A","SCHWOLHWL")=^TMP($J,"A","SCHWOLHWL")+1,^TMP($J,"A","SCHWOLHWL",SRV,AD,CS)=TND,WL="" D KILNODE Q
"RTN","GMRCONS1",52,0)
 .I '$D(WL) D
"RTN","GMRCONS1",53,0)
 ..I $P($G(^GMR(123,CS,12)),U,5)="P" D
"RTN","GMRCONS1",54,0)
 ...S ^TMP($J,"A","SCHWOLHIFC")=^TMP($J,"A","SCHWOLHIFC")+1,^TMP($J,"A","SCHWOLHIFC",SRV,AD,CS)=TND
"RTN","GMRCONS1",55,0)
 ..E  D
"RTN","GMRCONS1",56,0)
 ...S ^TMP($J,"A","SCHWOLHNWL",SRV,AD,CS)=TND,^TMP($J,"A","SCHWOLHNWL")=^TMP($J,"A","SCHWOLHNWL")+1
"RTN","GMRCONS1",57,0)
 ..D KILNODE Q
"RTN","GMRCONS1",58,0)
 I $D(^SC("AWAS1",CS)) S AW="AWAS1" K FND S SCLNC=$O(^SC(AW,CS,":"),-1),SCDT=$O(^SC(AW,CS,SCLNC,":"),-1),SIEN=$O(^SC(AW,CS,SCLNC,SCDT,":"),-1),CSS=$P($G(^SC(SCLNC,"S",SCDT,1,SIEN,"CONS")),U) D  Q
"RTN","GMRCONS1",59,0)
 .I CSS=CS S CHKOT=$P($G(^SC(SCLNC,"S",SCDT,1,SIEN,"C")),U,3) D
"RTN","GMRCONS1",60,0)
 ..I CHKOT'="" S ^TMP($J,"A","SCHWALCO")=^TMP($J,"A","SCHWALCO")+1,^TMP($J,"A","SCHWALCO",SRV,AD,CS)=TND D KILNODE Q
"RTN","GMRCONS1",61,0)
 ..I CHKOT="" S ^TMP($J,"A","SCHWALNCO")=^TMP($J,"A","SCHWALNCO")+1,^TMP($J,"A","SCHWALNCO",SRV,AD,CS)=TND D KILNODE Q
"RTN","GMRCONS1",62,0)
 I $D(^SC("AHST1",CS))&('$D(^SC("AWAS1",CS))) S ^TMP($J,"A","SCHWHNAL")=^TMP($J,"A","SCHWHNAL")+1,^TMP($J,"A","SCHWHNAL",SRV,AD,CS)=TND D KILNODE
"RTN","GMRCONS1",63,0)
 Q
"RTN","GMRCONS1",64,0)
PENDING D ASP D
"RTN","GMRCONS1",65,0)
 .I ASP9 S ^TMP($J,"A","PENWL")=^TMP($J,"A","PENWL")+1,^TMP($J,"A","PENWL",SRV,AD,CS)=TND,WL="" D KILNODE Q
"RTN","GMRCONS1",66,0)
 .I ASP8 S ^TMP($J,"A","PENWL")=^TMP($J,"A","PENWL")+1,^TMP($J,"A","PENWL",SRV,AD,CS)=TND,WL="" D KILNODE Q
"RTN","GMRCONS1",67,0)
 I '$D(WL) S ^TMP($J,"A","PENNWL")=^TMP($J,"A","PENNWL")+1,^TMP($J,"A","PENNWL",SRV,AD,CS)=TND D KILNODE
"RTN","GMRCONS1",68,0)
 Q
"RTN","GMRCONS1",69,0)
ASP ;
"RTN","GMRCONS1",70,0)
 S ASP9=0,ASP8=0,STAT="",SDWL=0 F  S SDWL=$O(^SDWL(409.3,"B",PTIEN,SDWL)) Q:'+SDWL  S SDWLND=$G(^SDWL(409.3,SDWL,0)),STAT=$P(SDWLND,U,17),ORDATE=$P(SDWLND,U,2) D  Q:$D(WL)
"RTN","GMRCONS1",71,0)
 .S P9=$P(SDWLND,U,9),P8=$P(SDWLND,U,8)
"RTN","GMRCONS1",72,0)
 .I P9'="" S CLNC=$P(^SDWL(409.32,P9,0),U) I CLNC'="" S STCD=$P(^SC(CLNC,0),U,7) I STCD'="" S STOPCD=$P(^DIC(40.7,STCD,0),U,2),CLNC2=$P(^DIC(40.7,STCD,0),U) D:$D(^TMP($J,"SC",STOPCD))  Q
"RTN","GMRCONS1",73,0)
 ..I STAT="O"&(ORDATE=$P(AD,".")!(ORDATE>AD))&(STPCLNC[CLNC2) S ASP9=1 Q
"RTN","GMRCONS1",74,0)
 .I P8'="" S CLNC=$P(^SDWL(409.31,P8,0),U) I CLNC'="" S STOPCD=$P(^DIC(40.7,CLNC,0),U,2),CLNC2=$P(^DIC(40.7,CLNC,0),U) I STOPCD'="" D:$D(^TMP($J,"SC",STOPCD))  Q
"RTN","GMRCONS1",75,0)
 ..I STAT="O"&(ORDATE=$P(AD,".")!(ORDATE>AD))&(STPCLNC[CLNC2) S ASP8=1 Q
"RTN","GMRCONS1",76,0)
 Q
"RTN","GMRCONS1",77,0)
INCMPLTE S ^TMP($J,"A","INCMPLTE")=^TMP($J,"A","INCMPLTE")+1,^TMP($J,"A","INCMPLTE",SRV,AD,CS)=TND
"RTN","GMRCONS1",78,0)
 Q
"RTN","GMRCONS1",79,0)
CANCELED S ^TMP($J,"A","CANCELED")=^TMP($J,"A","CANCELED")+1,^TMP($J,"A","CANCELED",SRV,AD,CS)=TND
"RTN","GMRCONS1",80,0)
 Q
"RTN","GMRCONS1",81,0)
DSCNTUED S ^TMP($J,"A","DSCNTUED")=^TMP($J,"A","DSCNTUED")+1,^TMP($J,"A","DSCNTUED",SRV,AD,CS)=TND
"RTN","GMRCONS1",82,0)
 Q
"RTN","GMRCONS1",83,0)
COMPLETE S ^TMP($J,"A","COMPLETE")=^TMP($J,"A","COMPLETE")+1,^TMP($J,"A","COMPLETE",SRV,AD,CS)=TND
"RTN","GMRCONS1",84,0)
 Q
"RTN","GMRCONS1",85,0)
CLOSE S ^TMP($J,"A","CLOSE")=^TMP($J,"A","CLOSE")+1,^TMP($J,"A","CLOSE",SRV,AD,CS)=TND
"RTN","GMRCONS1",86,0)
 Q
"RTN","GMRCONS1",87,0)
TOC S ^TMP($J,"A","TOC")=^TMP($J,"A","TOC")+1,^TMP($J,"A","TOC",SRV,AD,CS)=TND
"RTN","GMRCONS1",88,0)
 Q
"RTN","GMRCONS1",89,0)
TCC S ^TMP($J,"A","TCC")=^TMP($J,"A","TCC")+1,^TMP($J,"A","TCC",SRV,AD,CS)=TND
"RTN","GMRCONS1",90,0)
 Q
"RTN","GMRCONS1",91,0)
EDITRSB S GMRND=^GMR(123,CS,40,EN,0),ACT=$P(GMRND,U,2),ACT=$P(^GMR(123.1,ACT,0),U)
"RTN","GMRCONS1",92,0)
 S:(ACT'="EDIT/RESUBMITTED")!(ACT'="STATUS CHANGE") EN2=EN I (ACT="EDIT/RESUBMITTED")!(ACT="STATUS CHANGE") D
"RTN","GMRCONS1",93,0)
 .S CMMT=$G(^GMR(123,CS,40,EN2,1,1,0))
"RTN","GMRCONS1",94,0)
ACTERNS .I CMMT["was a no-show" S ^TMP($J,"A","ACTERNS")=^TMP($J,"A","ACTERNS")+1,^TMP($J,"A","ACTERNS",SRV,AD,CS)=TND,FND="" D KILNODE Q
"RTN","GMRCONS1",95,0)
ACTERCP .I CMMT["was cancelled by the Patient" S ^TMP($J,"A","ACTERCP")=^TMP($J,"A","ACTERCP")+1,^TMP($J,"A","ACTERCP",SRV,AD,CS)=TND,FND="" D KILNODE Q
"RTN","GMRCONS1",96,0)
ACTERCC .I CMMT["was cancelled by the Clinic"!(CMMT["was cancelled, whole clinic") S ^TMP($J,"A","ACTERCC")=^TMP($J,"A","ACTERCC")+1,^TMP($J,"A","ACTERCC",SRV,AD,CS)=TND,FND="" D KILNODE Q
"RTN","GMRCONS1",97,0)
ACTERAP .I CMMT["was cancelled for" S ^TMP($J,"A","ACTERAP")=^TMP($J,"A","ACTERAP")+1,^TMP($J,"A","ACTERAP",SRV,AD,CS)=TND,FND="" D KILNODE Q
"RTN","GMRCONS1",98,0)
ACTEROW .S ^TMP($J,"A","ACTEROW")=^TMP($J,"A","ACTEROW")+1,^TMP($J,"A","ACTEROW",SRV,AD,CS)=TND,FND="" D KILNODE Q
"RTN","GMRCONS1",99,0)
 Q
"RTN","GMRCONS1",100,0)
KILNODE K ^TMP($J,"S",ST,AD,CS)
"RTN","GMRCONS1",101,0)
 Q
"RTN","GMRCONS1",102,0)
CHKLIN I ($Y>(IOSL-4)) S HLD="" D PROMPT Q:HLD[U  X CMHD S PG=PG+1
"RTN","GMRCONS1",103,0)
 Q
"RTN","GMRCONS1",104,0)
IOSL Q:($Y>(IOSL-3))
"RTN","GMRCONS1",105,0)
PROMPT I IOST["C-" R !!,"Press enter to continue or '^' to exit. ",HLD:DTIME S PROMPT="" I HLD[" " S HLD=U
"RTN","GMRCONS1",106,0)
 Q
"RTN","GMRCONS2")
0^4^B64110738
"RTN","GMRCONS2",1,0)
GMRCONS2 ;ALB/MRY - Consult/Scheduling link report ;4/10/06  14:21
"RTN","GMRCONS2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**52**;DEC 27, 1997
"RTN","GMRCONS2",3,0)
 ;
"RTN","GMRCONS2",4,0)
 ;Continued from GMRCONS1
"RTN","GMRCONS2",5,0)
 D SUMARY,CT,SUMARY2,CT2
"RTN","GMRCONS2",6,0)
 S SETNOD=" " D SETNOD S SETNOD=" " D SETNOD S SETNOD="End of report." D SETNOD
"RTN","GMRCONS2",7,0)
 ;
"RTN","GMRCONS2",8,0)
VALM S VALMHDR(1)="Service: "_SRVNM
"RTN","GMRCONS2",9,0)
 S SETNOD=$$SPC("Status",21),SETNOD=SETNOD_"Date",SETNOD=$$SPC(SETNOD,31),SETNOD=SETNOD_"SC",SETNOD=$$SPC(SETNOD,36),SETNOD=SETNOD_"L4",SETNOD=$$SPC(SETNOD,41),SETNOD=SETNOD_"Patient",SETNOD=$$SPC(SETNOD,62)
"RTN","GMRCONS2",10,0)
 S SETNOD=SETNOD_"Appointment",SETNOD=$$SPC(SETNOD,79),SETNOD=SETNOD_"Date/Time",SETNOD=$$SPC(SETNOD,97)
"RTN","GMRCONS2",11,0)
 D CHGCAP^VALM("CAPTION LINE",SETNOD)
"RTN","GMRCONS2",12,0)
 Q
"RTN","GMRCONS2",13,0)
 ;
"RTN","GMRCONS2",14,0)
SUMARY ;Create the "A" x-ref
"RTN","GMRCONS2",15,0)
 ;;ACTERAP;Active, By Admin;Active, Edit Re-submit Admin Purpose
"RTN","GMRCONS2",16,0)
 ;;ACTERCC;Active, Can By Clinic;Active, Edit Re-submit, Cancel by Clinic
"RTN","GMRCONS2",17,0)
 ;;ACTERCP;Active, Can By Patient;Active, Edit Re-submit, Cancel by Patient
"RTN","GMRCONS2",18,0)
 ;;ACTERNS;Active, No-Show;Active, Edit Re-submit, No Show
"RTN","GMRCONS2",19,0)
 ;;ACTEROW;Active, Edit Resubmit;Active, Edit Re-submit, Old Way
"RTN","GMRCONS2",20,0)
 ;;ACTWOLHNWL;Active, Manually;Active, Without Link History
"RTN","GMRCONS2",21,0)
 ;;ACTWOLHWL;Active, EWL;Active, Without Link History EWL
"RTN","GMRCONS2",22,0)
 ;;ACTWOLHIFC;Active, IFC;Active, Without Link History IFC
"RTN","GMRCONS2",23,0)
 ;;CANCELED;Cancelled;Cancelled
"RTN","GMRCONS2",24,0)
 ;;COMPLETE;Completed;Completed
"RTN","GMRCONS2",25,0)
 ;;DSCNTUED;Discontinued;Discontinued
"RTN","GMRCONS2",26,0)
 ;;INCMPLTE;Incomplete;Incomplete
"RTN","GMRCONS2",27,0)
 ;;PENNWL;Pending;Pending
"RTN","GMRCONS2",28,0)
 ;;PENWL;Pending, EWL;Pending, Electronic Wait List
"RTN","GMRCONS2",29,0)
 ;;SCHWALCO;Sch, Linked, Ck'd Out;Scheduled, Linked, Checked Out;1
"RTN","GMRCONS2",30,0)
 ;;SCHWALNCO;Scheduled, Linked;Scheduled, Linked;1
"RTN","GMRCONS2",31,0)
 ;;SCHWHNAL;Sch, Not Linked now;Scheduled, Not Linked
"RTN","GMRCONS2",32,0)
 ;;SCHWOLHNWL;Sch, Never Linked;Scheduled, Without Link History
"RTN","GMRCONS2",33,0)
 ;;SCHWOLHWL;Schedule, EWL;Scheduled, Without Link history, wait listed
"RTN","GMRCONS2",34,0)
 ;;SCHWOLHIFC;Schedule, IFC;Scheduled, Without Link history, interfacility consult
"RTN","GMRCONS2",35,0)
 ;;TOC;Total Open Consults;Total Open Consults
"RTN","GMRCONS2",36,0)
 ;;TCC;Total Closed Consults;Total Closed Consults
"RTN","GMRCONS2",37,0)
 ;;
"RTN","GMRCONS2",38,0)
 F A=1:1 S B=$T(SUMARY+A) Q:$P(B,";",3)=""  S ^TMP($J,"A",$P(B,";",3))=0
"RTN","GMRCONS2",39,0)
 S ST="" F  S ST=$O(^TMP($J,"S",ST)) Q:ST=""  D  K WL
"RTN","GMRCONS2",40,0)
 .S AD=0 F  S AD=$O(^TMP($J,"S",ST,AD)) Q:'+AD  S CS=0 F  S CS=$O(^TMP($J,"S",ST,AD,CS)) Q:'+CS  S TND=^(CS),PTNM=$P(TND,U),PTIEN=$P(TND,U,2),LSTACT=$P(TND,U,3),AWAS1=$P(TND,U,4),AHST1=$P(TND,U,5),SRV=$P(TND,U,6) D  K WL
"RTN","GMRCONS2",41,0)
 ..S STPCLNC="",SC=0 F  S SC=$O(^GMR(123.5,SRV,688,SC)) Q:'+SC  S STPCOD=$P(^GMR(123.5,SRV,688,SC,0),U) I STPCOD'="" S STPCLNC=$P(^DIC(40.7,STPCOD,0),U)_","_STPCLNC
"RTN","GMRCONS2",42,0)
 ..I ST="ACTIVE" D ACTIVE,TOC
"RTN","GMRCONS2",43,0)
 ..I ST="SCHEDULED" D SCHEDULE,TOC
"RTN","GMRCONS2",44,0)
 ..I ST="PENDING" D PENDING,TOC
"RTN","GMRCONS2",45,0)
 ..I ST="PARTIAL RESULTS" D INCMPLTE,KILNODE,TOC
"RTN","GMRCONS2",46,0)
 ..I ST="CANCELLED" D CANCELED,KILNODE,TCC
"RTN","GMRCONS2",47,0)
 ..I ST="DISCONTINUED" D DSCNTUED,KILNODE,TCC
"RTN","GMRCONS2",48,0)
 ..I ST="COMPLETE" D COMPLETE,KILNODE,TCC
"RTN","GMRCONS2",49,0)
 Q
"RTN","GMRCONS2",50,0)
ACTIVE D ACTIVE^GMRCONS1 Q
"RTN","GMRCONS2",51,0)
SCHEDULE D SCHEDULE^GMRCONS1 Q
"RTN","GMRCONS2",52,0)
PENDING D PENDING^GMRCONS1 Q
"RTN","GMRCONS2",53,0)
INCMPLTE D INCMPLTE^GMRCONS1 Q
"RTN","GMRCONS2",54,0)
CANCELED D CANCELED^GMRCONS1 Q
"RTN","GMRCONS2",55,0)
DSCNTUED D DSCNTUED^GMRCONS1 Q
"RTN","GMRCONS2",56,0)
COMPLETE D COMPLETE^GMRCONS1 Q
"RTN","GMRCONS2",57,0)
TOC D TOC^GMRCONS1 Q
"RTN","GMRCONS2",58,0)
TCC D TCC^GMRCONS1 Q
"RTN","GMRCONS2",59,0)
KILNODE D KILNODE^GMRCONS1 Q
"RTN","GMRCONS2",60,0)
 ;
"RTN","GMRCONS2",61,0)
CT ;whole summary
"RTN","GMRCONS2",62,0)
 S LN=0,WDTH=102,PG=1,$P(DSH,"=",WDTH)="",FR=$E(PSD,4,5)_"/"_$E(PSD,6,7)_"/"_$E(PSD,2,3),TO=$E(ED,4,5)_"/"_$E(ED,6,7)_"/"_$E(ED,2,3),PD=$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)
"RTN","GMRCONS2",63,0)
 S SETNOD="SUMMARY From: "_FR_" To "_TO,SETNOD=$$SPC(SETNOD,93),SETNOD=SETNOD_PD D SETNOD
"RTN","GMRCONS2",64,0)
 S SETNOD=DSH D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS2",65,0)
 S PG=PG+1,BB=$O(^TMP($J,"A","")),SUBTOT=0
"RTN","GMRCONS2",66,0)
 S B="",SUM2=0,SUM=0 F  S B=$O(^TMP($J,"A",B)) Q:B=""  S TOT=^(B) I TOT'=0 D:B'="COMPLETE"&(B'="CANCELED")&(B'="DSCNTUED")&(B'="TOC")&(B'="TCC")
"RTN","GMRCONS2",67,0)
 .F TX=1:1 S TEXT=$T(SUMARY+TX),P3=$P(TEXT,";",3) Q:P3=""  I P3[B S SUM=SUM+TOT,SUBTOT=SUBTOT+TOT,SETNOD="    "_$J(TOT,6)_"  "_$P(TEXT,";",4) D SETNOD Q
"RTN","GMRCONS2",68,0)
 S SUM2=SUM2+SUM,SETNOD="----------" D SETNOD S SETNOD=$$SPC("    "_$J(SUM,6),12),SETNOD=SETNOD_"Total OPEN consults" D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS2",69,0)
 S B="",SUM=0 F  S B=$O(^TMP($J,"A",B)) Q:B=""  S TOT=^(B) I TOT'=0 D:B="COMPLETE"!(B="CANCELED")!(B="DSCNTUED")
"RTN","GMRCONS2",70,0)
 .F TX=1:1 S TEXT=$T(SUMARY+TX),P3=$P(TEXT,";",3) Q:P3=""  I P3[B S SUM=SUM+TOT,SETNOD="    "_$J(TOT,6)_"  "_$P(TEXT,";",4) D SETNOD Q
"RTN","GMRCONS2",71,0)
 S SUM2=SUM2+SUM,SETNOD="----------" D SETNOD S SETNOD=$$SPC("    "_$J(SUM,6),12),SETNOD=SETNOD_"Total CLOSED consults" D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS2",72,0)
 S SETNOD="==========" D SETNOD S SETNOD=$$SPC("    "_$J(SUM2,6),12),SETNOD=SETNOD_"GRAND TOTAL" D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS2",73,0)
 Q
"RTN","GMRCONS2",74,0)
SPC(DATA,COL) ;
"RTN","GMRCONS2",75,0)
 N SPC S SPC=DATA,L2=COL,L1=$L(DATA) F L3=1:1:(L2-L1) S SPC=SPC_" "
"RTN","GMRCONS2",76,0)
 Q SPC
"RTN","GMRCONS2",77,0)
 Q
"RTN","GMRCONS2",78,0)
SETNOD ;
"RTN","GMRCONS2",79,0)
 S LN=LN+1,^TMP("GMRCR",$J,"CP",LN,0)=SETNOD,SPC="",VALMCNT=LN
"RTN","GMRCONS2",80,0)
 Q
"RTN","GMRCONS2",81,0)
CT2 ;print clinic summary
"RTN","GMRCONS2",82,0)
 S A="" F  S A=$O(^TMP($J,"B",A)) Q:A=""  S PG=PG+1 D
"RTN","GMRCONS2",83,0)
 .S SETNOD=" " D SETNOD
"RTN","GMRCONS2",84,0)
 .S SETNOD=A_" "_FR_" - "_TO D SETNOD S SETNOD=$$SPC(" ",22),SETNOD=SETNOD_"Consult",SETNOD=$$SPC(SETNOD,63),SETNOD=SETNOD_"Clinic",SETNOD=$$SPC(SETNOD,80),SETNOD=SETNOD_"Appointment",SETNOD=$$SPC(SETNOD,97),SETNOD=SETNOD_"Stop" D SETNOD
"RTN","GMRCONS2",85,0)
 .S SETNOD=$$SPC("Status",22),SETNOD=SETNOD_"Date",SETNOD=$$SPC(SETNOD,32),SETNOD=SETNOD_"SC",SETNOD=$$SPC(SETNOD,37),SETNOD=SETNOD_"L4",SETNOD=$$SPC(SETNOD,42),SETNOD=SETNOD_"Patient",SETNOD=$$SPC(SETNOD,63)
"RTN","GMRCONS2",86,0)
 .S SETNOD=SETNOD_"Appointment",SETNOD=$$SPC(SETNOD,80),SETNOD=SETNOD_"Date/time",SETNOD=$$SPC(SETNOD,97),SETNOD=SETNOD_"Code" D SETNOD S SETNOD=DSH D SETNOD
"RTN","GMRCONS2",87,0)
 .S PG=PG+1,SUM=0,B="" F  S B=$O(^TMP($J,"B",A,B)) Q:B=""  S TOT=^(B) I TOT'=0 D:B'="COMPLETE"&(B'="CANCELED")&(B'="DSCNTUED")&(B'="TOC")&(B'="TCC")
"RTN","GMRCONS2",88,0)
 ..S CNSDT=0 F  S CNSDT=$O(^TMP($J,"B",A,B,CNSDT)) Q:'+CNSDT  S CNSLT=0 F  S CNSLT=$O(^TMP($J,"B",A,B,CNSDT,CNSLT)) Q:'+CNSLT  S CNSLTND=^(CNSLT),PTNM=$P(CNSLTND,U),PRTCNDT=$E(CNSDT,4,5)_"-"_$E(CNSDT,6,7)_"-"_$E(CNSDT,2,3) D
"RTN","GMRCONS2",89,0)
 ...F TX=1:1 S TEXT=$T(SUMARY+TX),P3=$P(TEXT,";",3) Q:P3=""  I P3[B S P4=$P(TEXT,";",4),P6=$P(TEXT,";",6) D
"RTN","GMRCONS2",90,0)
 ....I P6=1 I $D(^SC("AWAS1",CNSLT)) D
"RTN","GMRCONS2",91,0)
 .....S CLINIC=$O(^SC("AWAS1",CNSLT,":"),-1),SDAPT=$O(^SC("AWAS1",CNSLT,CLINIC,":"),-1),STCOD=$P(^SC(CLINIC,0),U,7),STCOD=$P(^DIC(40.7,STCOD,0),U,2),CLINIC=$P(^SC(CLINIC,0),U),SDAPT1=$E(SDAPT,4,5)_"-"_$E(SDAPT,6,7)_"-"_$E(SDAPT,2,3)
"RTN","GMRCONS2",92,0)
 .....S Y=SDAPT D DD^%DT S SDAPTIM=$E($P(Y,"@",2),1,5)
"RTN","GMRCONS2",93,0)
 ....S SETNOD=$$SPC(P4,22),SETNOD=SETNOD_PRTCNDT,SETNOD=$$SPC(SETNOD,32),SETNOD=SETNOD_$P(CNSLTND,U,10),SETNOD=$$SPC(SETNOD,37),SETNOD=SETNOD_$P(CNSLTND,U,9),SETNOD=$$SPC(SETNOD,42),SETNOD=SETNOD_$E(PTNM,1,18),SETNOD=$$SPC(SETNOD,63)
"RTN","GMRCONS2",94,0)
 ....D:P6=1  D SETNOD S SUM=SUM+TOT
"RTN","GMRCONS2",95,0)
 .....S SETNOD=SETNOD_$E(CLINIC,1,15),SETNOD=$$SPC(SETNOD,80),SETNOD=SETNOD_SDAPT1_" @ "_SDAPTIM,SETNOD=$$SPC(SETNOD,98),SETNOD=SETNOD_$E(STCOD,1,5)
"RTN","GMRCONS2",96,0)
 .S SETNOD=" " D SETNOD
"RTN","GMRCONS2",97,0)
 .S BB=$O(^TMP($J,"B",A,"")),SUBTOT=0,SUM2=0,SUM=0,B="" F  S B=$O(^TMP($J,"B",A,B)) Q:B=""  S TOT=^(B) I TOT'=0 D:B'="COMPLETE"&(B'="CANCELED")&(B'="DSCNTUED")&(B'="TOC")&(B'="TCC")
"RTN","GMRCONS2",98,0)
 ..F TX=1:1 S TEXT=$T(SUMARY+TX),P3=$P(TEXT,";",3) Q:P3=""  I P3[B S SUM=SUM+TOT S SUBTOT=SUBTOT+TOT D
"RTN","GMRCONS2",99,0)
 ...S SETNOD="    "_$J(TOT,6)_"  "_$P(TEXT,";",4) D SETNOD Q
"RTN","GMRCONS2",100,0)
 .S SUM2=SUM2+SUM,SETNOD="----------" D SETNOD S SETNOD=$$SPC("    "_$J(SUM,6),12),SETNOD=SETNOD_"Total OPEN consults" D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS2",101,0)
 .S SUM=0,B="" F  S B=$O(^TMP($J,"B",A,B)) Q:B=""  S TOT=^(B) I TOT'=0 D:B="COMPLETE"!(B="CANCELED")!(B="DSCNTUED")
"RTN","GMRCONS2",102,0)
 ..F TX=1:1 S TEXT=$T(SUMARY+TX),P3=$P(TEXT,";",3) Q:P3=""  I P3[B S SUM=SUM+TOT,SETNOD="    "_$J(TOT,6)_"  "_$P(TEXT,";",4) D SETNOD Q
"RTN","GMRCONS2",103,0)
 .S SUM2=SUM2+SUM,SETNOD="----------" D SETNOD S SETNOD=$$SPC("    "_$J(SUM,6),12),SETNOD=SETNOD_"Total CLOSED consults" D SETNOD
"RTN","GMRCONS2",104,0)
 .S SETNOD=" " D SETNOD S SETNOD="==========" D SETNOD
"RTN","GMRCONS2",105,0)
 .S SETNOD=$$SPC("    "_$J(SUM2,6),12),SETNOD=SETNOD_"Total "_A_" consults" D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS2",106,0)
 Q
"RTN","GMRCONS2",107,0)
SUMARY2 ;create the "B" x-reference
"RTN","GMRCONS2",108,0)
 S A="" F  S A=$O(^TMP($J,"A",A)) Q:A=""  S B=0 F  S B=$O(^TMP($J,"A",A,B)) Q:'+B  S C=0 F  S C=$O(^TMP($J,"A",A,B,C)) Q:'+C  S D=0 F  S D=$O(^TMP($J,"A",A,B,C,D)) Q:'+D  S ND=^(D) D
"RTN","GMRCONS2",109,0)
 .S CLNCNM=$P(^GMR(123.5,B,0),U) S ^TMP($J,"B",CLNCNM,A,C,D)=ND,^TMP($J,"C",A,CLNCNM,C,D)=ND S:'($D(^TMP($J,"B",CLNCNM,A))#2) ^TMP($J,"B",CLNCNM,A)=0 S ^TMP($J,"B",CLNCNM,A)=^TMP($J,"B",CLNCNM,A)+1
"RTN","GMRCONS2",110,0)
 Q
"RTN","GMRCONS3")
0^5^B45564463
"RTN","GMRCONS3",1,0)
GMRCONS3 ;ALB/MRY - Consult Status link report ;4/10/06  14:21
"RTN","GMRCONS3",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**52**;DEC 27, 1997
"RTN","GMRCONS3",3,0)
NEWSTS ;
"RTN","GMRCONS3",4,0)
 N TEMPSTAT
"RTN","GMRCONS3",5,0)
 S TEMPSTAT=GMRCSTAT
"RTN","GMRCONS3",6,0)
 S GMRCSTAT=$$STS Q:GMRCSTAT=""
"RTN","GMRCONS3",7,0)
 ;S:$D(GMRCQUT) GMRCSTAT=TEMPSTAT
"RTN","GMRCONS3",8,0)
 D CT3
"RTN","GMRCONS3",9,0)
 Q
"RTN","GMRCONS3",10,0)
STS() ;Select a set of status for view.
"RTN","GMRCONS3",11,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCONS3",12,0)
 N DIR,X,Y,GMRCSTCK
"RTN","GMRCONS3",13,0)
STSAGAIN ;Loop to get another status.
"RTN","GMRCONS3",14,0)
 S DIR(0)="SAOM^al:All Status's;ap:All Pending;dc:Discont.;c:Completed;p:Pending;a:Active;s:Scheduled;pr:Incomplete;x:Cancelled"
"RTN","GMRCONS3",15,0)
 S DIR("A")="Only Display Consults With Status of: "
"RTN","GMRCONS3",16,0)
 S DIR("B")="All Status's"
"RTN","GMRCONS3",17,0)
 I $D(GMRCSTCK) D
"RTN","GMRCONS3",18,0)
 . S DIR("A")="Another Status to display: "
"RTN","GMRCONS3",19,0)
 . K DIR("B")
"RTN","GMRCONS3",20,0)
 D ^DIR
"RTN","GMRCONS3",21,0)
 I $D(DUOUT)!($D(DTOUT)) S GMRCQUT=1 G END
"RTN","GMRCONS3",22,0)
 I '$L(Y) G END
"RTN","GMRCONS3",23,0)
 D STCK($$LOW^XLFSTR(Y))
"RTN","GMRCONS3",24,0)
 I $D(GMRCSTCK),GMRCSTCK'="COM,PEN,ACT,SCH,INC,DSC,CAN" G STSAGAIN
"RTN","GMRCONS3",25,0)
END Q $S($D(GMRCSTCK):GMRCSTCK,1:"")
"RTN","GMRCONS3",26,0)
 ;
"RTN","GMRCONS3",27,0)
STCK(RES)     ;change code to status
"RTN","GMRCONS3",28,0)
 N CODE
"RTN","GMRCONS3",29,0)
 ; al:All Status's;dc:Discont.;c:Completed;h:On Hold;f:Flagged;p:Pending;a:Active;e:Expired;s:Scheduled
"RTN","GMRCONS3",30,0)
 ;;pr:Incomplete;d:Delayed;u:Unreleased;dce:Discont/Ed;x:Cancelled;l:Lapsed;rn:Renewed;':No Status")
"RTN","GMRCONS3",31,0)
CASE ;
"RTN","GMRCONS3",32,0)
 I RES="al" S GMRCSTCK="COM,PEN,ACT,SCH,INC,DSC,CAN" Q  ;All Status's
"RTN","GMRCONS3",33,0)
 ;                                display     no.  file name      file abbr.
"RTN","GMRCONS3",34,0)
 I RES="ap" D  Q
"RTN","GMRCONS3",35,0)
 .F CODE="PEN","ACT","SCH","INC" D CKCODE(CODE) ;   All Pending Statuses
"RTN","GMRCONS3",36,0)
 I RES="dc" D CKCODE("DSC") Q  ;  Discont.    1  DISCONTINUED       dc
"RTN","GMRCONS3",37,0)
 I RES="c" D CKCODE("COM") Q  ;   Completed   2  COMPLETE           c
"RTN","GMRCONS3",38,0)
 I RES="p" D CKCODE("PEN") Q  ;   Pending      5  PENDING            p
"RTN","GMRCONS3",39,0)
 I RES="a" D CKCODE("ACT") Q  ;   Active       6  ACTIVE             a
"RTN","GMRCONS3",40,0)
 I RES="s" D CKCODE("SCH") Q  ;   Scheduled    8  SCHEDULED          s
"RTN","GMRCONS3",41,0)
 I RES="pr" D CKCODE("INC") Q  ;  Incomplete   9  PARTIAL RESULTS   pr
"RTN","GMRCONS3",42,0)
 I RES="x" D CKCODE("CAN") Q  ;  Cancelled   13  CANCELLED          x
"RTN","GMRCONS3",43,0)
ENDCASE Q
"RTN","GMRCONS3",44,0)
 ;
"RTN","GMRCONS3",45,0)
CKCODE(CODE) ;
"RTN","GMRCONS3",46,0)
 I $D(GMRCSTCK),$$FND(CODE) W $C(7),!,"Already selected" Q
"RTN","GMRCONS3",47,0)
 ;I +$G(GMRCSTCK) S GMRCSTCK=GMRCSTCK_","_CODE
"RTN","GMRCONS3",48,0)
 ;I $G(GMRCSTCK) S GMRCSTCK=GMRCSTCK_","_CODE
"RTN","GMRCONS3",49,0)
 I $D(GMRCSTCK) S GMRCSTCK=GMRCSTCK_","_CODE
"RTN","GMRCONS3",50,0)
 E  S GMRCSTCK=CODE
"RTN","GMRCONS3",51,0)
 Q
"RTN","GMRCONS3",52,0)
 ;
"RTN","GMRCONS3",53,0)
FND(CD) ;status already selected?
"RTN","GMRCONS3",54,0)
 I GMRCSTCK=CD Q 1
"RTN","GMRCONS3",55,0)
 I $F(GMRCSTCK,(CD_",")) Q 1
"RTN","GMRCONS3",56,0)
 I $E(GMRCSTCK,$L(GMRCSTCK))=CD Q 1
"RTN","GMRCONS3",57,0)
 Q 0
"RTN","GMRCONS3",58,0)
 ;
"RTN","GMRCONS3",59,0)
NUMBER ;
"RTN","GMRCONS3",60,0)
 I GMRCCTRL'=120 S GMRCCTRL=120
"RTN","GMRCONS3",61,0)
 E  S GMRCCTRL=0
"RTN","GMRCONS3",62,0)
 Q
"RTN","GMRCONS3",63,0)
 ;
"RTN","GMRCONS3",64,0)
SUMARY ;
"RTN","GMRCONS3",65,0)
 ;;ACTERAP;Active, By Admin;Active, Edit Re-submit Admin Purpose
"RTN","GMRCONS3",66,0)
 ;;ACTERCC;Active, Can By Clinic;Active, Edit Re-submit, Cancel by Clinic
"RTN","GMRCONS3",67,0)
 ;;ACTERCP;Active, Can By Patient;Active, Edit Re-submit, Cancel by Patient
"RTN","GMRCONS3",68,0)
 ;;ACTERNS;Active, No-Show;Active, Edit Re-submit, No Show
"RTN","GMRCONS3",69,0)
 ;;ACTEROW;Active, Edit Resubmit;Active, Edit Re-submit, Old Way
"RTN","GMRCONS3",70,0)
 ;;ACTWOLHNWL;Active, Manually;Active, Without Link History
"RTN","GMRCONS3",71,0)
 ;;ACTWOLHWL;Active, EWL;Active, Without Link History
"RTN","GMRCONS3",72,0)
 ;;ACTWOLHIFC;Active, IFC;Active, Without Link History
"RTN","GMRCONS3",73,0)
 ;;CANCELED;Cancelled;Cancelled
"RTN","GMRCONS3",74,0)
 ;;COMPLETE;Completed;Completed
"RTN","GMRCONS3",75,0)
 ;;DSCNTUED;Discontinued;Discontinued
"RTN","GMRCONS3",76,0)
 ;;INCMPLTE;Incomplete;Incomplete
"RTN","GMRCONS3",77,0)
 ;;PENNWL;Pending;Pending
"RTN","GMRCONS3",78,0)
 ;;PENWL;Pending, EWL;Pending, Electronic Wait List
"RTN","GMRCONS3",79,0)
 ;;SCHWALCO;Sch, Linked, Ck'd Out;Scheduled, Linked, Checked Out;1
"RTN","GMRCONS3",80,0)
 ;;SCHWALNCO;Scheduled, Linked;Scheduled, Linked;1
"RTN","GMRCONS3",81,0)
 ;;SCHWHNAL;Sch, Not Linked now;Scheduled, Not Linked
"RTN","GMRCONS3",82,0)
 ;;SCHWOLHNWL;Sch, Never Linked;Scheduled, Without Link History
"RTN","GMRCONS3",83,0)
 ;;SCHWOLHWL;Schedule, EWL;Scheduled, Without Link history, wait listed
"RTN","GMRCONS3",84,0)
 ;;SCHWOLHIFC;Schedule, IFC;Scheduled, Without Link history, interfacility consult 
"RTN","GMRCONS3",85,0)
 ;;TOC;Total Open Consults;Total Open Consults
"RTN","GMRCONS3",86,0)
 ;;TCC;Total Closed Consults;Total Closed Consults
"RTN","GMRCONS3",87,0)
 ;;
"RTN","GMRCONS3",88,0)
CT3 ;print clinic summary
"RTN","GMRCONS3",89,0)
 D WAIT^DICD K ^TMP("GMRCR",$J)
"RTN","GMRCONS3",90,0)
 S LN=0,A="" F  S A=$O(^TMP($J,"B",A)) Q:A=""  D
"RTN","GMRCONS3",91,0)
 .K SUM S HDR="",B="" F  S B=$O(^TMP($J,"B",A,B)) Q:B=""  D:GMRCSTAT[$E(B,1,3)
"RTN","GMRCONS3",92,0)
 ..I $D(HDR) D HEADER K HDR
"RTN","GMRCONS3",93,0)
 ..S SUM(B)=^TMP($J,"B",A,B)
"RTN","GMRCONS3",94,0)
 ..S CNSDT=0 F  S CNSDT=$O(^TMP($J,"B",A,B,CNSDT)) Q:'+CNSDT  S CNSLT=0 F  S CNSLT=$O(^TMP($J,"B",A,B,CNSDT,CNSLT)) Q:'+CNSLT  S CNSLTND=^(CNSLT),PTNM=$P(CNSLTND,U),PRTCNDT=$E(CNSDT,4,5)_"-"_$E(CNSDT,6,7)_"-"_$E(CNSDT,2,3) D
"RTN","GMRCONS3",95,0)
 ...F TX=1:1 S TEXT=$T(SUMARY+TX),P3=$P(TEXT,";",3) Q:P3=""  I P3[B S P4=$P(TEXT,";",4),P6=$P(TEXT,";",6) D
"RTN","GMRCONS3",96,0)
 ....I P6=1 I $D(^SC("AWAS1",CNSLT)) D
"RTN","GMRCONS3",97,0)
 .....S CLINIC=$O(^SC("AWAS1",CNSLT,":"),-1),SDAPT=$O(^SC("AWAS1",CNSLT,CLINIC,":"),-1),STCOD=$P(^SC(CLINIC,0),U,7),STCOD=$P(^DIC(40.7,STCOD,0),U,2),CLINIC=$P(^SC(CLINIC,0),U),SDAPT1=$E(SDAPT,4,5)_"-"_$E(SDAPT,6,7)_"-"_$E(SDAPT,2,3)
"RTN","GMRCONS3",98,0)
 .....S Y=SDAPT D DD^%DT S SDAPTIM=$E($P(Y,"@",2),1,5)
"RTN","GMRCONS3",99,0)
 ....S SETNOD=$$SPC(P4,22),SETNOD=SETNOD_PRTCNDT,SETNOD=$$SPC(SETNOD,32),SETNOD=SETNOD_$P(CNSLTND,U,10),SETNOD=$$SPC(SETNOD,37),SETNOD=SETNOD_$P(CNSLTND,U,9),SETNOD=$$SPC(SETNOD,42),SETNOD=SETNOD_$E(PTNM,1,18),SETNOD=$$SPC(SETNOD,63)
"RTN","GMRCONS3",100,0)
 ....D:P6=1  D SETNOD
"RTN","GMRCONS3",101,0)
 .....S SETNOD=SETNOD_$E(CLINIC,1,15),SETNOD=$$SPC(SETNOD,80),SETNOD=SETNOD_SDAPT1_" @ "_SDAPTIM,SETNOD=$$SPC(SETNOD,98),SETNOD=SETNOD_$E(STCOD,1,5)
"RTN","GMRCONS3",102,0)
 .I $D(SUM) S SETNOD=" " D SETNOD D  S SETNOD=" " D SETNOD S SETNOD=" " D SETNOD
"RTN","GMRCONS3",103,0)
 ..S I="" F  S I=$O(SUM(I)) Q:I=""  F II=1:1 S SM=$T(SUMARY+II) S PC3=$P(SM,";",3) Q:PC3=""  I I=PC3 S SETNOD=$$SPC(" ",6),SETNOD=SETNOD_$$SPC(SUM(I),6),SETNOD=SETNOD_$P(SM,";",4) D SETNOD Q
"RTN","GMRCONS3",104,0)
 Q
"RTN","GMRCONS3",105,0)
HEADER ;
"RTN","GMRCONS3",106,0)
 S SETNOD=A_" "_FR_" - "_TO D SETNOD S SETNOD=$$SPC(" ",22),SETNOD=SETNOD_"Consult",SETNOD=$$SPC(SETNOD,63),SETNOD=SETNOD_"Clinic",SETNOD=$$SPC(SETNOD,80),SETNOD=SETNOD_"Appointment",SETNOD=$$SPC(SETNOD,97),SETNOD=SETNOD_"Stop" D SETNOD
"RTN","GMRCONS3",107,0)
 S SETNOD=$$SPC("Status",22),SETNOD=SETNOD_"Date",SETNOD=$$SPC(SETNOD,32),SETNOD=SETNOD_"SC",SETNOD=$$SPC(SETNOD,37),SETNOD=SETNOD_"L4",SETNOD=$$SPC(SETNOD,42),SETNOD=SETNOD_"Patient",SETNOD=$$SPC(SETNOD,63)
"RTN","GMRCONS3",108,0)
 S SETNOD=SETNOD_"Appointment",SETNOD=$$SPC(SETNOD,80),SETNOD=SETNOD_"Date/time",SETNOD=$$SPC(SETNOD,97),SETNOD=SETNOD_"Code" D SETNOD S SETNOD=DSH D SETNOD
"RTN","GMRCONS3",109,0)
 Q
"RTN","GMRCONS3",110,0)
SETNOD ;
"RTN","GMRCONS3",111,0)
 S LN=LN+1,^TMP("GMRCR",$J,"CP",LN,0)=SETNOD,SPC="",VALMCNT=LN
"RTN","GMRCONS3",112,0)
 Q
"RTN","GMRCONS3",113,0)
SPC(DATA,COL) ;
"RTN","GMRCONS3",114,0)
 N SPC S SPC=DATA,L2=COL,L1=$L(DATA) F L3=1:1:(L2-L1) S SPC=SPC_" "
"RTN","GMRCONS3",115,0)
 Q SPC
"RTN","GMRCONS3",116,0)
 Q
"UP",123,123.02,-1)
123^40
"UP",123,123.02,0)
123.02
"UP",123.5,123.5688,-1)
123.5^688
"UP",123.5,123.5688,0)
123.5688
"VER")
8.0^22.0
"^DD",123,123,8,0)
CPRS STATUS^*P100.01'^ORD(100.01,^0;12^S DIC("S")="I '$$SCREEN^XTID(100.01,,Y_"","")" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",123,123,8,1,0)
^.1
"^DD",123,123,8,1,1,0)
123^D
"^DD",123,123,8,1,1,1)
S ^GMR(123,"D",$E(X,1,30),DA)=""
"^DD",123,123,8,1,1,2)
K ^GMR(123,"D",$E(X,1,30),DA)
"^DD",123,123,8,1,1,"%D",0)
^^1^1^2920129^
"^DD",123,123,8,1,1,"%D",1,0)
This cross-reference allows searching based on the OE/RR status.
"^DD",123,123,8,1,1,"DT")
2920129
"^DD",123,123,8,1,2,0)
123^AF^MUMPS
"^DD",123,123,8,1,2,1)
I "^5^6^"[(U_X_U) N B,C,D I $D(^SC("AWAS1",DA)) S B=$O(^SC("AWAS1",DA,0)),C=$O(^SC("AWAS1",DA,B,0)),D=$O(^SC("AWAS1",DA,B,C,0)) S $P(^SC(B,"S",C,1,D,"CONS"),U)="" K ^SC("AWAS1",DA)
"^DD",123,123,8,1,2,2)
Q
"^DD",123,123,8,1,2,"%D",0)
^^2^2^3060503^
"^DD",123,123,8,1,2,"%D",1,0)
This x-ref removes the consult link to an appointment, if one exists,
"^DD",123,123,8,1,2,"%D",2,0)
when this field has a status change to Pending (5) or Active (6).
"^DD",123,123,8,1,2,"DT")
3060503
"^DD",123,123,8,3)
Enter the CPRS STATUS of this consult (e.g., pending, active, complete, etc.).
"^DD",123,123,8,12)
Data Standardization of Order Status (#100.01) file.
"^DD",123,123,8,12.1)
S DIC("S")="I '$$SCREEN^XTID(100.01,,Y_"","")"
"^DD",123,123,8,21,0)
^.001^3^3^3060118^^^^
"^DD",123,123,8,21,1,0)
This is the current CPRS status of the consult or request order.
"^DD",123,123,8,21,2,0)
The Action Types which may be taken from the "Select Action: " prompt
"^DD",123,123,8,21,3,0)
update the status in this file as well as in the Orders File (100).
"^DD",123,123,8,"DT")
3060503
"^DD",123,123.02,6,0)
FORWARDED FROM^P123.5'^GMR(123.5,^0;6^Q
"^DD",123,123.02,6,1,0)
^.1
"^DD",123,123.02,6,1,1,0)
123^AD^MUMPS
"^DD",123,123.02,6,1,1,1)
N B S B=DA(1) N A,C,D,E S A="AWAS1" I $D(^SC(A,B)) S C=$O(^SC(A,B,0)),D=$O(^SC(A,B,C,0)),E=$O(^SC(A,B,C,D,0)) S $P(^SC(C,"S",D,1,E,"CONS"),U)="" K ^SC("AWAS1",B)
"^DD",123,123.02,6,1,1,2)
Q
"^DD",123,123.02,6,1,1,"%D",0)
^^2^2^3060410^
"^DD",123,123.02,6,1,1,"%D",1,0)
This x-ref removes the appointment link to the consult when this field is 
"^DD",123,123.02,6,1,1,"%D",2,0)
filled in.
"^DD",123,123.02,6,1,1,"DT")
3060410
"^DD",123,123.02,6,3)
Enter the name of the Hospital Service which is forwarding the consult.
"^DD",123,123.02,6,21,0)
^^2^2^2970611^^^
"^DD",123,123.02,6,21,1,0)
This is the Service which forwarded the Consult to the new TO SERVICE.
"^DD",123,123.02,6,21,2,0)
It is maintained for an audit trail.
"^DD",123,123.02,6,"DT")
3060410
"^DD",123.5,123.5,688,0)
ASSOCIATED STOP CODE^123.5688P^^688;0
"^DD",123.5,123.5688,0)
ASSOCIATED STOP CODE SUB-FIELD^^.01^1
"^DD",123.5,123.5688,0,"DT")
3060425
"^DD",123.5,123.5688,0,"IX","B",123.5688,.01)

"^DD",123.5,123.5688,0,"NM","ASSOCIATED STOP CODE")

"^DD",123.5,123.5688,0,"UP")
123.5
"^DD",123.5,123.5688,.01,0)
ASSOCIATED STOP CODE^M*P40.7'^DIC(40.7,^0;1^S DIC("S")="I $P(^(0),U,2)>100" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",123.5,123.5688,.01,1,0)
^.1
"^DD",123.5,123.5688,.01,1,1,0)
123.5688^B
"^DD",123.5,123.5688,.01,1,1,1)
S ^GMR(123.5,DA(1),688,"B",$E(X,1,30),DA)=""
"^DD",123.5,123.5688,.01,1,1,2)
K ^GMR(123.5,DA(1),688,"B",$E(X,1,30),DA)
"^DD",123.5,123.5688,.01,1,2,0)
123.5^AB1
"^DD",123.5,123.5688,.01,1,2,1)
S ^GMR(123.5,"AB1",$E(X,1,30),DA(1),DA)=""
"^DD",123.5,123.5688,.01,1,2,2)
K ^GMR(123.5,"AB1",$E(X,1,30),DA(1),DA)
"^DD",123.5,123.5688,.01,1,2,"DT")
3060314
"^DD",123.5,123.5688,.01,3)
Enter all clinic stop code for this consult.
"^DD",123.5,123.5688,.01,12)
CLINIC STOP POINTED TO MUST BE GREATER THAN 100
"^DD",123.5,123.5688,.01,12.1)
S DIC("S")="I $P(^(0),U,2)>100"
"^DD",123.5,123.5688,.01,21,0)
^.001^19^19^3060425^^^
"^DD",123.5,123.5688,.01,21,1,0)
This field is used to associate consult request service to clinics.
"^DD",123.5,123.5688,.01,21,2,0)
 
"^DD",123.5,123.5688,.01,21,3,0)
If the stopcode attached to the REQUEST SERVICE is the same as the stop 
"^DD",123.5,123.5688,.01,21,4,0)
code of the clinic profiles into which a procedure of the parent service
"^DD",123.5,123.5688,.01,21,5,0)
would be scheduled, then both consults and procedures would display for
"^DD",123.5,123.5688,.01,21,6,0)
the clerk to make a link at the time the appointment was made.  However,
"^DD",123.5,123.5688,.01,21,7,0)
if the stopcode of the REQUEST SERVICE is different than the stop code of
"^DD",123.5,123.5688,.01,21,8,0)
the clinic into which the procedure is scheduled, it would be necessary to
"^DD",123.5,123.5688,.01,21,9,0)
put both stopcodes into the REQUEST SERVICE to allow both consults and
"^DD",123.5,123.5688,.01,21,10,0)
procedure requests to display for scheduling clerks.
"^DD",123.5,123.5688,.01,21,11,0)
 
"^DD",123.5,123.5688,.01,21,12,0)
The stop code of the chosen clinic during the scheduling process is 
"^DD",123.5,123.5688,.01,21,13,0)
compared to the stop codes of any consult which could be linked to the
"^DD",123.5,123.5688,.01,21,14,0)
appointment.  If there is a match, and the current status of the consult
"^DD",123.5,123.5688,.01,21,15,0)
meets the criteria listed below, the clerk will be presented with the
"^DD",123.5,123.5688,.01,21,16,0)
following query:
"^DD",123.5,123.5688,.01,21,17,0)
                "Will this appointment be for a CONSULT/ PROCEDURE? NO//"
"^DD",123.5,123.5688,.01,21,18,0)
This query allows the scheduling clerk to first display, and then link, 
"^DD",123.5,123.5688,.01,21,19,0)
the appointment to the consult.
"^DD",123.5,123.5688,.01,"DT")
3060425
**INSTALL NAME**
PX*1.0*176
"BLD",6015,0)
PX*1.0*176^PCE PATIENT CARE ENCOUNTER^0^3060628^y
"BLD",6015,1,0)
^^1^1^3060323^
"BLD",6015,1,1,0)
CONSULT/SCHEDULING APPOINTMENT LINK INTERFACE
"BLD",6015,4,0)
^9.64PA^^
"BLD",6015,"KRN",0)
^9.67PA^8989.52^19
"BLD",6015,"KRN",.4,0)
.4
"BLD",6015,"KRN",.401,0)
.401
"BLD",6015,"KRN",.402,0)
.402
"BLD",6015,"KRN",.403,0)
.403
"BLD",6015,"KRN",.5,0)
.5
"BLD",6015,"KRN",.84,0)
.84
"BLD",6015,"KRN",3.6,0)
3.6
"BLD",6015,"KRN",3.8,0)
3.8
"BLD",6015,"KRN",9.2,0)
9.2
"BLD",6015,"KRN",9.8,0)
9.8
"BLD",6015,"KRN",19,0)
19
"BLD",6015,"KRN",19.1,0)
19.1
"BLD",6015,"KRN",101,0)
101
"BLD",6015,"KRN",409.61,0)
409.61
"BLD",6015,"KRN",409.61,"NM",0)
^9.68A^1^1
"BLD",6015,"KRN",409.61,"NM",1,0)
PXCE SDAM MENU^^0
"BLD",6015,"KRN",409.61,"NM","B","PXCE SDAM MENU",1)

"BLD",6015,"KRN",771,0)
771
"BLD",6015,"KRN",771,"NM",0)
^9.68A^^
"BLD",6015,"KRN",870,0)
870
"BLD",6015,"KRN",8989.51,0)
8989.51
"BLD",6015,"KRN",8989.52,0)
8989.52
"BLD",6015,"KRN",8994,0)
8994
"BLD",6015,"KRN","B",.4,.4)

"BLD",6015,"KRN","B",.401,.401)

"BLD",6015,"KRN","B",.402,.402)

"BLD",6015,"KRN","B",.403,.403)

"BLD",6015,"KRN","B",.5,.5)

"BLD",6015,"KRN","B",.84,.84)

"BLD",6015,"KRN","B",3.6,3.6)

"BLD",6015,"KRN","B",3.8,3.8)

"BLD",6015,"KRN","B",9.2,9.2)

"BLD",6015,"KRN","B",9.8,9.8)

"BLD",6015,"KRN","B",19,19)

"BLD",6015,"KRN","B",19.1,19.1)

"BLD",6015,"KRN","B",101,101)

"BLD",6015,"KRN","B",409.61,409.61)

"BLD",6015,"KRN","B",771,771)

"BLD",6015,"KRN","B",870,870)

"BLD",6015,"KRN","B",8989.51,8989.51)

"BLD",6015,"KRN","B",8989.52,8989.52)

"BLD",6015,"KRN","B",8994,8994)

"BLD",6015,"QUES",0)
^9.62^^
"BLD",6015,"REQB",0)
^9.611^1^1
"BLD",6015,"REQB",1,0)
SD*5.3*478^2
"BLD",6015,"REQB","B","SD*5.3*478",1)

"KRN",409.61,305,-1)
0^1
"KRN",409.61,305,0)
PXCE SDAM MENU^1^1^80^7^15^1^1^Appointment^PXCE SDAM MENU^PCE Appointment List^1^999
"KRN",409.61,305,1)
^PXCE MAIN HIDDEN ACTIONS
"KRN",409.61,305,"ARRAY")
 ^TMP("SDAM",$J)
"KRN",409.61,305,"COL",0)
^409.621^6^6
"KRN",409.61,305,"COL",1,0)
NAME^6^25^Patient or Clinic
"KRN",409.61,305,"COL",2,0)
DATE^32^16^Appt Date/Time
"KRN",409.61,305,"COL",3,0)
STAT^54^21^Status
"KRN",409.61,305,"COL",4,0)
APPT#^2^3
"KRN",409.61,305,"COL",5,0)
TIME^76^5
"KRN",409.61,305,"COL",6,0)
CONSULT^49^4
"KRN",409.61,305,"COL","B","APPT#",4)

"KRN",409.61,305,"COL","B","CONSULT",6)

"KRN",409.61,305,"COL","B","DATE",2)

"KRN",409.61,305,"COL","B","NAME",1)

"KRN",409.61,305,"COL","B","STAT",3)

"KRN",409.61,305,"COL","B","TIME",5)

"KRN",409.61,305,"EXP")
D EXPND^PXCESDAM
"KRN",409.61,305,"FNL")
D EXIT^PXCE
"KRN",409.61,305,"HDR")
D HDR^PXCE
"KRN",409.61,305,"HLP")
D PROTOCOL^PXCEHELP
"KRN",409.61,305,"INIT")
D INIT^PXCESDAM
"MBREQ")
0
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"PKG",363,-1)
1^1
"PKG",363,0)
PCE PATIENT CARE ENCOUNTER^PX^Patient Care Encounter (VA Parent package)
"PKG",363,20,0)
^9.402P^^
"PKG",363,22,0)
^9.49I^1^1
"PKG",363,22,1,0)
1.0^2960812^2961106^1555
"PKG",363,22,1,"PAH",1,0)
176^3060628^123456810
"PKG",363,22,1,"PAH",1,1,0)
^^1^1^3060628
"PKG",363,22,1,"PAH",1,1,1,0)
CONSULT/SCHEDULING APPOINTMENT LINK INTERFACE
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.0
**END**
**END**
