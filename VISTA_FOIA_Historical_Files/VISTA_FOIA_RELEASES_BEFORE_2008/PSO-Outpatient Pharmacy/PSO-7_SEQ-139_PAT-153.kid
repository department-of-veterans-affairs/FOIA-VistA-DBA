Released PSO*7*153 SEQ #139
Extracted from mail message
**KIDS**:PSO*7.0*153^

**INSTALL NAME**
PSO*7.0*153
"BLD",970,0)
PSO*7.0*153^OUTPATIENT PHARMACY^0^3031021^y
"BLD",970,1,0)
^^78^78^3031020^
"BLD",970,1,1,0)
1. A new code has been added to the INACTIVATION REASON CODE field (#3)
"BLD",970,1,2,0)
of the TPB ELIGIBILITY file (#52.91). The code is PATIENT UNREACHABLE.
"BLD",970,1,3,0)
This code will now be selectable when manually inactivating a patient
"BLD",970,1,4,0)
from the TPB ELIGIBILITY file (#52.91). It will also display, when
"BLD",970,1,5,0)
appropriate, on the reports generated by the Report TPB Patients Letters
"BLD",970,1,6,0)
Printed/NOT Printed [PSO TPB LETTERS PRINTED REPORT] option, and the TPB
"BLD",970,1,7,0)
Patient Report [PSO TPB PATIENT REPORT] option.
"BLD",970,1,8,0)
 
"BLD",970,1,9,0)
2. Every Sunday, Transitional Pharmacy Benefit (TPB) patient data is sent
"BLD",970,1,10,0)
in an HL7 message to Austin. This patch exports a new mail group, PSO TPB
"BLD",970,1,11,0)
HL7 EXTRACT. Members of this mail group will receive weekly mail messages
"BLD",970,1,12,0)
concerning the HL7 extract of TPB patient information. These messages
"BLD",970,1,13,0)
will either display information that the message generation was
"BLD",970,1,14,0)
successful, or display information that the message generation was
"BLD",970,1,15,0)
unsuccessful, along with a reason why it was unsuccessful. Upon install,
"BLD",970,1,16,0)
the installer will be prompted for the coordinator of the mail group. The
"BLD",970,1,17,0)
Post-Install routine of this patch will automatically add the patch
"BLD",970,1,18,0)
installer as a member of the mail group.
"BLD",970,1,19,0)
 
"BLD",970,1,20,0)
The Post-Install routine PSO153PS will also set the AUTOSTART field (#4.5)
"BLD",970,1,21,0)
of the HL LOGICAL LINK file (#870) of the PSOTPBAAC HL Logical Link to
"BLD",970,1,22,0)
"Enabled".
"BLD",970,1,23,0)
 
"BLD",970,1,24,0)
A correction has been made to the HL7 message to distinguish between
"BLD",970,1,25,0)
a new record and an edited record.
"BLD",970,1,26,0)
 
"BLD",970,1,27,0)
3. The weekly HL7 transmission to Austin is found to cause problems at few
"BLD",970,1,28,0)
sites due to some bad "AX" cross-references of the TPB ELIGIBILITY file
"BLD",970,1,29,0)
(#52.91). This patch fixes this issue.
"BLD",970,1,30,0)
 
"BLD",970,1,31,0)
4. There is a possibility of getting a null subscript error when using the
"BLD",970,1,32,0)
View Provider [PSO PROVIDER INQUIRE] option to view the provider details
"BLD",970,1,33,0)
after either of the following circumstances:
"BLD",970,1,34,0)
 
"BLD",970,1,35,0)
a. When a new provider was added using the Add New Providers [PSO PROVIDER
"BLD",970,1,36,0)
   ADD] option, and "No" was the response to the NON-VA PRESCRIBER field
"BLD",970,1,37,0)
   (#53.91) of NEW PERSON file (#200).
"BLD",970,1,38,0)
b. When a Provider was edited using the Edit Provider [PSO PROVIDER EDIT]
"BLD",970,1,39,0)
   option, and "No" was the response to the NON-VA PRESCRIBER field
"BLD",970,1,40,0)
   (#53.91) of NEW PERSON file (#200), and then an "^" was entered prior
"BLD",970,1,41,0)
   to responding to the prompts for these fields of the NEW PERSON file
"BLD",970,1,42,0)
   (#200):
"BLD",970,1,43,0)
   TAX ID field (#53.92)
"BLD",970,1,44,0)
   EXCLUSIONARY CHECK PERFORMED field (#53.93)
"BLD",970,1,45,0)
   DATE EXCLUSIONARY LIST CHECKED field (#53.94)
"BLD",970,1,46,0)
   ON EXCLUSIONARY LIST field  (#53.95)
"BLD",970,1,47,0)
   EXCLUSIONARY CHECKED BY field (#53.96)
"BLD",970,1,48,0)
 
"BLD",970,1,49,0)
This patch corrects the error.
"BLD",970,1,50,0)
 
"BLD",970,1,51,0)
5. When selecting a provider using the TPB Rx (Prescription) Entry [PSO
"BLD",970,1,52,0)
TPB RXENTRY] option, if the provider is unauthorized to write med orders
"BLD",970,1,53,0)
or flagged as inactive, there are currently no alerts or warnings
"BLD",970,1,54,0)
indicating that the provider cannot be selected. This patch will provide
"BLD",970,1,55,0)
one of the following messages during provider selection if such conditions
"BLD",970,1,56,0)
are encountered:
"BLD",970,1,57,0)
 
"BLD",970,1,58,0)
a. This Provider is not Authorized to Write Med Orders. Use the Edit
"BLD",970,1,59,0)
   Provider [PSO PROVIDER EDIT] option to change the Authorization flag.
"BLD",970,1,60,0)
 
"BLD",970,1,61,0)
b. This Provider is flagged as Inactive. Use the Edit Provider
"BLD",970,1,62,0)
   [PSO PROVIDER EDIT] option to change the Inactive Date.
"BLD",970,1,63,0)
 
"BLD",970,1,64,0)
c. This Provider is not Authorized to Write Med Orders and flagged as
"BLD",970,1,65,0)
   Inactive. Use the Edit Provider [PSO PROVIDER EDIT] option to change
"BLD",970,1,66,0)
   them.
"BLD",970,1,67,0)
 
"BLD",970,1,68,0)
6. The FAX NUMBER field (#.136) of the NEW PERSON file (#200) has been
"BLD",970,1,69,0)
added to the following options, for display and for editing:
"BLD",970,1,70,0)
Add New Providers [PSO PROVIDER ADD] option
"BLD",970,1,71,0)
Edit Provider [PSO PROVIDER EDIT] option
"BLD",970,1,72,0)
View Provider [PSO PROVIDER INQUIRE] option
"BLD",970,1,73,0)
 
"BLD",970,1,74,0)
This enhancement is requested by E3R 18457.
"BLD",970,1,75,0)
 
"BLD",970,1,76,0)
7. This patch provides an API to the Scheduling V. 5.3 package that
"BLD",970,1,77,0)
returns a list of all patients eligible for the TPB, to be used for
"BLD",970,1,78,0)
reporting purposes.
"BLD",970,4,0)
^9.64PA^52.91^1
"BLD",970,4,52.91,0)
52.91
"BLD",970,4,52.91,2,0)
^9.641^52.91^1
"BLD",970,4,52.91,2,52.91,0)
TPB ELIGIBILITY  (File-top level)
"BLD",970,4,52.91,2,52.91,1,0)
^9.6411^3^1
"BLD",970,4,52.91,2,52.91,1,3,0)
INACTIVATION REASON CODE
"BLD",970,4,52.91,222)
y^y^p^^^^n^^n
"BLD",970,4,52.91,224)

"BLD",970,4,"APDD",52.91,52.91)

"BLD",970,4,"APDD",52.91,52.91,3)

"BLD",970,4,"B",52.91,52.91)

"BLD",970,"INID")
^n
"BLD",970,"INIT")
PSO153PS
"BLD",970,"KRN",0)
^9.67PA^8989.52^19
"BLD",970,"KRN",.4,0)
.4
"BLD",970,"KRN",.401,0)
.401
"BLD",970,"KRN",.402,0)
.402
"BLD",970,"KRN",.403,0)
.403
"BLD",970,"KRN",.5,0)
.5
"BLD",970,"KRN",.84,0)
.84
"BLD",970,"KRN",3.6,0)
3.6
"BLD",970,"KRN",3.8,0)
3.8
"BLD",970,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",970,"KRN",3.8,"NM",1,0)
PSO TPB HL7 EXTRACT^^0
"BLD",970,"KRN",3.8,"NM","B","PSO TPB HL7 EXTRACT",1)

"BLD",970,"KRN",9.2,0)
9.2
"BLD",970,"KRN",9.8,0)
9.8
"BLD",970,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",970,"KRN",9.8,"NM",1,0)
PSOPRVW^^0^B32968618
"BLD",970,"KRN",9.8,"NM",2,0)
PSOTPCAN^^0^B56194290
"BLD",970,"KRN",9.8,"NM",3,0)
PSOTPCRP^^0^B52762483
"BLD",970,"KRN",9.8,"NM",4,0)
PSOTPHL1^^0^B71593697
"BLD",970,"KRN",9.8,"NM",5,0)
PSOTPCEE^^0^B7754641
"BLD",970,"KRN",9.8,"NM",6,0)
PSOTPPRV^^0^B7105822
"BLD",970,"KRN",9.8,"NM","B","PSOPRVW",1)

"BLD",970,"KRN",9.8,"NM","B","PSOTPCAN",2)

"BLD",970,"KRN",9.8,"NM","B","PSOTPCEE",5)

"BLD",970,"KRN",9.8,"NM","B","PSOTPCRP",3)

"BLD",970,"KRN",9.8,"NM","B","PSOTPHL1",4)

"BLD",970,"KRN",9.8,"NM","B","PSOTPPRV",6)

"BLD",970,"KRN",19,0)
19
"BLD",970,"KRN",19.1,0)
19.1
"BLD",970,"KRN",101,0)
101
"BLD",970,"KRN",409.61,0)
409.61
"BLD",970,"KRN",771,0)
771
"BLD",970,"KRN",870,0)
870
"BLD",970,"KRN",8989.51,0)
8989.51
"BLD",970,"KRN",8989.52,0)
8989.52
"BLD",970,"KRN",8994,0)
8994
"BLD",970,"KRN","B",.4,.4)

"BLD",970,"KRN","B",.401,.401)

"BLD",970,"KRN","B",.402,.402)

"BLD",970,"KRN","B",.403,.403)

"BLD",970,"KRN","B",.5,.5)

"BLD",970,"KRN","B",.84,.84)

"BLD",970,"KRN","B",3.6,3.6)

"BLD",970,"KRN","B",3.8,3.8)

"BLD",970,"KRN","B",9.2,9.2)

"BLD",970,"KRN","B",9.8,9.8)

"BLD",970,"KRN","B",19,19)

"BLD",970,"KRN","B",19.1,19.1)

"BLD",970,"KRN","B",101,101)

"BLD",970,"KRN","B",409.61,409.61)

"BLD",970,"KRN","B",771,771)

"BLD",970,"KRN","B",870,870)

"BLD",970,"KRN","B",8989.51,8989.51)

"BLD",970,"KRN","B",8989.52,8989.52)

"BLD",970,"KRN","B",8994,8994)

"BLD",970,"QUES",0)
^9.62^^
"BLD",970,"REQB",0)
^9.611^1^1
"BLD",970,"REQB",1,0)
PSO*7.0*146^2
"BLD",970,"REQB","B","PSO*7.0*146",1)

"FIA",52.91)
TPB ELIGIBILITY
"FIA",52.91,0)
^PS(52.91,
"FIA",52.91,0,0)
52.91P
"FIA",52.91,0,1)
y^y^p^^^^n^^n
"FIA",52.91,0,10)

"FIA",52.91,0,11)

"FIA",52.91,0,"RLRO")

"FIA",52.91,0,"VR")
7.0^PSO
"FIA",52.91,52.91)
1
"FIA",52.91,52.91,3)

"INIT")
PSO153PS
"IX",52.91,52.91,"AX",0)
52.91^AX^Triggers the "AX" x-ref only during manual edit.^MU^^R^IR^I^52.91^^^^^A
"IX",52.91,52.91,"AX",1)
S:$$PATCH^XPDUTL("PSO*7.0*146") ^PS(52.91,"AX",DT,DA)="" Q
"IX",52.91,52.91,"AX",1.4)
N I S (X,I)=0 F  S I=$O(X1(I)) Q:'I  I X1(I)'=X2(I) S X=1 Q
"IX",52.91,52.91,"AX",2)
S:$$PATCH^XPDUTL("PSO*7.0*146") ^PS(52.91,"AX",DT,DA)="" Q
"IX",52.91,52.91,"AX",2.4)
N I S (X,I)=0 F  S I=$O(X1(I)) Q:'I  I X1(I)'=X2(I) S X=1 Q
"IX",52.91,52.91,"AX",11.1,0)
^.114IA^8^8
"IX",52.91,52.91,"AX",11.1,1,0)
1^F^52.91^1^^1^F
"IX",52.91,52.91,"AX",11.1,2,0)
2^F^52.91^2^^^F
"IX",52.91,52.91,"AX",11.1,3,0)
3^F^52.91^3^^^F
"IX",52.91,52.91,"AX",11.1,4,0)
4^F^52.91^4^^^F
"IX",52.91,52.91,"AX",11.1,5,0)
5^F^52.91^5^^^F
"IX",52.91,52.91,"AX",11.1,6,0)
6^F^52.91^6^^^F
"IX",52.91,52.91,"AX",11.1,7,0)
7^F^52.91^8^^^F
"IX",52.91,52.91,"AX",11.1,8,0)
8^F^52.91^9^^^F
"KRN",3.8,19,-1)
0^1
"KRN",3.8,19,0)
PSO TPB HL7 EXTRACT^PU^y^^^^
"KRN",3.8,19,2,0)
^^2^2^3030919^
"KRN",3.8,19,2,1,0)
Members of this mail group will receive weekly mail messages regarding
"KRN",3.8,19,2,2,0)
the HL7 transmission of the Transitional Pharmacy Benefit data.
"KRN",3.8,19,3)

"MBREQ")
0
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1;;MAILGDEL^XPDIA1(%)
"ORD",11,3.8,0)
MAIL GROUP
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^2971216^2980805^5
"PKG",16,22,1,"PAH",1,0)
153^3031021
"PKG",16,22,1,"PAH",1,1,0)
^^78^78^3031021
"PKG",16,22,1,"PAH",1,1,1,0)
1. A new code has been added to the INACTIVATION REASON CODE field (#3)
"PKG",16,22,1,"PAH",1,1,2,0)
of the TPB ELIGIBILITY file (#52.91). The code is PATIENT UNREACHABLE.
"PKG",16,22,1,"PAH",1,1,3,0)
This code will now be selectable when manually inactivating a patient
"PKG",16,22,1,"PAH",1,1,4,0)
from the TPB ELIGIBILITY file (#52.91). It will also display, when
"PKG",16,22,1,"PAH",1,1,5,0)
appropriate, on the reports generated by the Report TPB Patients Letters
"PKG",16,22,1,"PAH",1,1,6,0)
Printed/NOT Printed [PSO TPB LETTERS PRINTED REPORT] option, and the TPB
"PKG",16,22,1,"PAH",1,1,7,0)
Patient Report [PSO TPB PATIENT REPORT] option.
"PKG",16,22,1,"PAH",1,1,8,0)
 
"PKG",16,22,1,"PAH",1,1,9,0)
2. Every Sunday, Transitional Pharmacy Benefit (TPB) patient data is sent
"PKG",16,22,1,"PAH",1,1,10,0)
in an HL7 message to Austin. This patch exports a new mail group, PSO TPB
"PKG",16,22,1,"PAH",1,1,11,0)
HL7 EXTRACT. Members of this mail group will receive weekly mail messages
"PKG",16,22,1,"PAH",1,1,12,0)
concerning the HL7 extract of TPB patient information. These messages
"PKG",16,22,1,"PAH",1,1,13,0)
will either display information that the message generation was
"PKG",16,22,1,"PAH",1,1,14,0)
successful, or display information that the message generation was
"PKG",16,22,1,"PAH",1,1,15,0)
unsuccessful, along with a reason why it was unsuccessful. Upon install,
"PKG",16,22,1,"PAH",1,1,16,0)
the installer will be prompted for the coordinator of the mail group. The
"PKG",16,22,1,"PAH",1,1,17,0)
Post-Install routine of this patch will automatically add the patch
"PKG",16,22,1,"PAH",1,1,18,0)
installer as a member of the mail group.
"PKG",16,22,1,"PAH",1,1,19,0)
 
"PKG",16,22,1,"PAH",1,1,20,0)
The Post-Install routine PSO153PS will also set the AUTOSTART field (#4.5)
"PKG",16,22,1,"PAH",1,1,21,0)
of the HL LOGICAL LINK file (#870) of the PSOTPBAAC HL Logical Link to
"PKG",16,22,1,"PAH",1,1,22,0)
"Enabled".
"PKG",16,22,1,"PAH",1,1,23,0)
 
"PKG",16,22,1,"PAH",1,1,24,0)
A correction has been made to the HL7 message to distinguish between
"PKG",16,22,1,"PAH",1,1,25,0)
a new record and an edited record.
"PKG",16,22,1,"PAH",1,1,26,0)
 
"PKG",16,22,1,"PAH",1,1,27,0)
3. The weekly HL7 transmission to Austin is found to cause problems at few
"PKG",16,22,1,"PAH",1,1,28,0)
sites due to some bad "AX" cross-references of the TPB ELIGIBILITY file
"PKG",16,22,1,"PAH",1,1,29,0)
(#52.91). This patch fixes this issue.
"PKG",16,22,1,"PAH",1,1,30,0)
 
"PKG",16,22,1,"PAH",1,1,31,0)
4. There is a possibility of getting a null subscript error when using the
"PKG",16,22,1,"PAH",1,1,32,0)
View Provider [PSO PROVIDER INQUIRE] option to view the provider details
"PKG",16,22,1,"PAH",1,1,33,0)
after either of the following circumstances:
"PKG",16,22,1,"PAH",1,1,34,0)
 
"PKG",16,22,1,"PAH",1,1,35,0)
a. When a new provider was added using the Add New Providers [PSO PROVIDER
"PKG",16,22,1,"PAH",1,1,36,0)
   ADD] option, and "No" was the response to the NON-VA PRESCRIBER field
"PKG",16,22,1,"PAH",1,1,37,0)
   (#53.91) of NEW PERSON file (#200).
"PKG",16,22,1,"PAH",1,1,38,0)
b. When a Provider was edited using the Edit Provider [PSO PROVIDER EDIT]
"PKG",16,22,1,"PAH",1,1,39,0)
   option, and "No" was the response to the NON-VA PRESCRIBER field
"PKG",16,22,1,"PAH",1,1,40,0)
   (#53.91) of NEW PERSON file (#200), and then an "^" was entered prior
"PKG",16,22,1,"PAH",1,1,41,0)
   to responding to the prompts for these fields of the NEW PERSON file
"PKG",16,22,1,"PAH",1,1,42,0)
   (#200):
"PKG",16,22,1,"PAH",1,1,43,0)
   TAX ID field (#53.92)
"PKG",16,22,1,"PAH",1,1,44,0)
   EXCLUSIONARY CHECK PERFORMED field (#53.93)
"PKG",16,22,1,"PAH",1,1,45,0)
   DATE EXCLUSIONARY LIST CHECKED field (#53.94)
"PKG",16,22,1,"PAH",1,1,46,0)
   ON EXCLUSIONARY LIST field  (#53.95)
"PKG",16,22,1,"PAH",1,1,47,0)
   EXCLUSIONARY CHECKED BY field (#53.96)
"PKG",16,22,1,"PAH",1,1,48,0)
 
"PKG",16,22,1,"PAH",1,1,49,0)
This patch corrects the error.
"PKG",16,22,1,"PAH",1,1,50,0)
 
"PKG",16,22,1,"PAH",1,1,51,0)
5. When selecting a provider using the TPB Rx (Prescription) Entry [PSO
"PKG",16,22,1,"PAH",1,1,52,0)
TPB RXENTRY] option, if the provider is unauthorized to write med orders
"PKG",16,22,1,"PAH",1,1,53,0)
or flagged as inactive, there are currently no alerts or warnings
"PKG",16,22,1,"PAH",1,1,54,0)
indicating that the provider cannot be selected. This patch will provide
"PKG",16,22,1,"PAH",1,1,55,0)
one of the following messages during provider selection if such conditions
"PKG",16,22,1,"PAH",1,1,56,0)
are encountered:
"PKG",16,22,1,"PAH",1,1,57,0)
 
"PKG",16,22,1,"PAH",1,1,58,0)
a. This Provider is not Authorized to Write Med Orders. Use the Edit
"PKG",16,22,1,"PAH",1,1,59,0)
   Provider [PSO PROVIDER EDIT] option to change the Authorization flag.
"PKG",16,22,1,"PAH",1,1,60,0)
 
"PKG",16,22,1,"PAH",1,1,61,0)
b. This Provider is flagged as Inactive. Use the Edit Provider
"PKG",16,22,1,"PAH",1,1,62,0)
   [PSO PROVIDER EDIT] option to change the Inactive Date.
"PKG",16,22,1,"PAH",1,1,63,0)
 
"PKG",16,22,1,"PAH",1,1,64,0)
c. This Provider is not Authorized to Write Med Orders and flagged as
"PKG",16,22,1,"PAH",1,1,65,0)
   Inactive. Use the Edit Provider [PSO PROVIDER EDIT] option to change
"PKG",16,22,1,"PAH",1,1,66,0)
   them.
"PKG",16,22,1,"PAH",1,1,67,0)
 
"PKG",16,22,1,"PAH",1,1,68,0)
6. The FAX NUMBER field (#.136) of the NEW PERSON file (#200) has been
"PKG",16,22,1,"PAH",1,1,69,0)
added to the following options, for display and for editing:
"PKG",16,22,1,"PAH",1,1,70,0)
Add New Providers [PSO PROVIDER ADD] option
"PKG",16,22,1,"PAH",1,1,71,0)
Edit Provider [PSO PROVIDER EDIT] option
"PKG",16,22,1,"PAH",1,1,72,0)
View Provider [PSO PROVIDER INQUIRE] option
"PKG",16,22,1,"PAH",1,1,73,0)
 
"PKG",16,22,1,"PAH",1,1,74,0)
This enhancement is requested by E3R 18457.
"PKG",16,22,1,"PAH",1,1,75,0)
 
"PKG",16,22,1,"PAH",1,1,76,0)
7. This patch provides an API to the Scheduling V. 5.3 package that
"PKG",16,22,1,"PAH",1,1,77,0)
returns a list of all patients eligible for the TPB, to be used for
"PKG",16,22,1,"PAH",1,1,78,0)
reporting purposes.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSO153PS")
0^^B629408
"RTN","PSO153PS",1,0)
PSO153PS ;BIR/RTR-Patch 153 Post Install routine ;09/17/03
"RTN","PSO153PS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**153**;DEC 1997
"RTN","PSO153PS",3,0)
 ;External reference to File 870 supported by DBIA 1496
"RTN","PSO153PS",4,0)
 ;
"RTN","PSO153PS",5,0)
 ;Set AUTOSTART to Enabled for PSOTPBAAC Logical Link
"RTN","PSO153PS",6,0)
 N DIE,DR,DIC,DA,X,Y
"RTN","PSO153PS",7,0)
 K DIC S DIC(0)="X",DIC=870,X="PSOTPBAAC" D ^DIC K DIC
"RTN","PSO153PS",8,0)
 I +Y>0 K DIE S DA=+Y,DIE=870,DR="4.5////"_1 D ^DIE K DA,DR,DIE
"RTN","PSO153PS",9,0)
 ;
"RTN","PSO153PS",10,0)
 ;Add patch installer to the HL7 mail group
"RTN","PSO153PS",11,0)
 I '$G(DUZ) Q
"RTN","PSO153PS",12,0)
 N XMY,PSOADDMG S XMY(DUZ)="" S PSOADDMG=$$MG^XMBGRP("PSO TPB HL7 EXTRACT",0,"","",.XMY,"",1)
"RTN","PSO153PS",13,0)
 Q
"RTN","PSOPRVW")
0^1^B32968618
"RTN","PSOPRVW",1,0)
PSOPRVW ;BIR/SAB,MHA-enter/edit/view provider ;03/26/96
"RTN","PSOPRVW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,153**;DEC 1997
"RTN","PSOPRVW",3,0)
 ;Ref. to ^VA(200 supp. by IA 224
"RTN","PSOPRVW",4,0)
 ;Ref. to ^DIC(7 supp. by IA 491
"RTN","PSOPRVW",5,0)
START W ! S DIC("A")="Select Provider: ",DIC("S")="I $D(^VA(200,+Y,""PS""))",DIC="^VA(200,",DIC(0)="AEQMZ" D ^DIC G:"^"[X EX G:Y<0 START K DIC S PRNO=+Y
"RTN","PSOPRVW",6,0)
 W @IOF,"Name: "_$P(^VA(200,PRNO,0),"^")
"RTN","PSOPRVW",7,0)
 I +$P(^VA(200,PRNO,"PS"),"^",4),$P(^("PS"),"^",4)'>DT W ?40,$C(7),"* * * INACTIVE AS OF ",$E($P(^("PS"),"^",4),4,5),"/",$E($P(^("PS"),"^",4),6,7),"/",$E($P(^("PS"),"^",4),2,3)," * * *"
"RTN","PSOPRVW",8,0)
 ;W !,"SSN#: " S T=$S($P(^VA(200,PRNO,1),"^",9)]"":$P(^(1),"^",9),1:"") W:T $E(T,1,3),"-",$E(T,4,5),"-",$E(T,6,9)
"RTN","PSOPRVW",9,0)
 W !,"Initials: "_$P(^VA(200,PRNO,0),"^",2)
"RTN","PSOPRVW",10,0)
 W !,"NON-VA Prescriber: "
"RTN","PSOPRVW",11,0)
 I $P($G(^VA(200,PRNO,"TPB")),"^")]"" W $S($P(^("TPB"),"^"):"Yes",1:"No")
"RTN","PSOPRVW",12,0)
 W ?40,"Tax ID: "_$P($G(^VA(200,PRNO,"TPB")),"^",2)
"RTN","PSOPRVW",13,0)
 W !,"Exclusionary Check Performed: " I $P($G(^VA(200,PRNO,"TPB")),"^",3)]"" W $S($P(^("TPB"),"^",3):"Yes",1:"No")
"RTN","PSOPRVW",14,0)
 W ?40,"Date Exclusionary List Checked: "
"RTN","PSOPRVW",15,0)
 S Y=$P($G(^VA(200,PRNO,"TPB")),"^",4) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSOPRVW",16,0)
 W !,"On Exclusionary List: " I $P($G(^VA(200,PRNO,"TPB")),"^",5)]"" W $S($P(^("TPB"),"^",5):"Yes",1:"No")
"RTN","PSOPRVW",17,0)
 W !,"Exclusionary Checked By: "
"RTN","PSOPRVW",18,0)
 I $P($G(^VA(200,PRNO,"TPB")),"^",6) W $P($G(^VA(200,$P(^("TPB"),"^",6),0)),"^")
"RTN","PSOPRVW",19,0)
 W !,"Authorized to Write Orders: "_$S($P(^VA(200,PRNO,"PS"),"^"):"Yes",1:"No"),!,"Requires Cosigner: "_$S($P(^("PS"),"^",7):"Yes",1:"No") I $P(^("PS"),"^",7),$D(^VA(200,+$P(^("PS"),"^",8),0)) W !,"Usual Cosigner: "_$P(^(0),"^")
"RTN","PSOPRVW",20,0)
 W !,"Class: " S PRCLS=+$P(^VA(200,PRNO,"PS"),"^",5),PRCLS=$S(PRCLS>0&$D(^DIC(7,PRCLS,0)):$P(^(0),"^"),1:"") W PRCLS
"RTN","PSOPRVW",21,0)
 W ?40,"DEA# "_$P(^VA(200,PRNO,"PS"),"^",2),!," Type: " S T=+$P(^("PS"),"^",6),L=$P(^DD(200,53.6,0),"^",3)_";"_T_":Unknown" F I=1:1 I $P($P(L,";",I),":",1)=T W $P($P(L,";",I),":",2) Q
"RTN","PSOPRVW",22,0)
 W ?40,"VA#  "_$P(^VA(200,PRNO,"PS"),"^",3),!,"Remarks: "_$P(^("PS"),"^",9),!,"Synonym(s):  "_$S($P($G(^VA(200,PRNO,.1)),"^",4)]"":$P(^(.1),"^",4)_",",1:"")_$S($P(^(0),"^",2)]"":" "_$P(^(0),"^",2),1:"")
"RTN","PSOPRVW",23,0)
 W !,"Service/Section: " S PSOSSDA=$G(DA) I $P($G(^VA(200,PRNO,5)),"^") K DIQ S DIC="^DIC(49,",DA=$P(^VA(200,PRNO,5),"^"),DR=.01,DIQ="PSOSECT",DIQ(0)="E" D EN^DIQ1 W $G(PSOSECT(49,DA,.01,"E")) S DA=$G(PSOSSDA) K DR,DIC,DIQ,PSOSSDA,PSOSECT
"RTN","PSOPRVW",24,0)
 I '$D(^VA(200,PRNO,.11)) G NUM
"RTN","PSOPRVW",25,0)
 W !!,"Address: ",?10,$P(^VA(200,PRNO,.11),"^") W:$P(^(.11),"^",2)'="" !?10,$P(^(.11),"^",2) W:$P(^(.11),"^",3)'="" !?10,$P(^(.11),"^",3)
"RTN","PSOPRVW",26,0)
 W !?10,$P(^VA(200,PRNO,.11),"^",4),", " S STAT=+$P($G(^(.11)),"^",5) W $S($D(^DIC(5,STAT,0)):$P(^(0),"^"),1:"")_"  "_$P(^VA(200,PRNO,.11),"^",6)
"RTN","PSOPRVW",27,0)
NUM G:'$D(^VA(200,PRNO,.13)) START
"RTN","PSOPRVW",28,0)
 W !,"Phone:    "_$P(^VA(200,PRNO,.13),"^"),!,$S($P(^(.13),"^",2)]"":"Office:   "_$P(^(.13),"^",2),1:""),!
"RTN","PSOPRVW",29,0)
 W:$P(^VA(200,PRNO,.13),"^",3)]"" !,"Phone #3: "_$P(^(.13),"^",3) W:$P(^(.13),"^",4)]"" !,"Phone #4: "_$P(^(.13),"^",4) W:$P(^(.13),"^",6)]"" !,"Fax #:    "_$P(^(.13),"^",6)
"RTN","PSOPRVW",30,0)
 W:$P($G(^VA(200,PRNO,.14)),"^")]"" !,"Room Loc: "_$P(^(.14),"^")
"RTN","PSOPRVW",31,0)
 G START
"RTN","PSOPRVW",32,0)
EX K DIC,DIE,DA,DR,D0,PRNO,PRCLS,STAT,T,Y,X,L,LF,I,DIR,DIROUT,DUOUT,DTOUT,DIRUT,%,%Y,%W,%Z,C,DDH,DI,DIH,DLAYGO,DQ,X1,XMDT,XMN
"RTN","PSOPRVW",33,0)
 Q
"RTN","PSOPRVW",34,0)
ASK ;edit providers
"RTN","PSOPRVW",35,0)
 K DIR,DTOUT,DUOUT,DIROUT,DIRUT
"RTN","PSOPRVW",36,0)
 W !! S DIC("A")="Select Provider: ",(DIC,DIE)=200,DIC(0)="AEQMZ" D ^DIC G:"^"[X EX G:Y<0 ASK S (FADA,DA)=+Y
"RTN","PSOPRVW",37,0)
 I '$D(^VA(200,DA,"PS")) G NPRV
"RTN","PSOPRVW",38,0)
ASK1 W @IOF,?25,"Provider: "_$P(^VA(200,DA,0),"^"),! F DR="TPB","PS",".11",".13",".14" D EN^DIQ
"RTN","PSOPRVW",39,0)
 K DIC,Y
"RTN","PSOPRVW",40,0)
EDT W ! L +^VA(200,DA):0
"RTN","PSOPRVW",41,0)
 I '$T W $C(7),!!,"Provider Data is Being Edited by Another User!",! G QX
"RTN","PSOPRVW",42,0)
 N RTPB S RTPB=$G(^VA(200,DA,"TPB"))
"RTN","PSOPRVW",43,0)
 S DR="53.91" D ^DIE I $D(Y)!$D(DTOUT) G QX
"RTN","PSOPRVW",44,0)
 I 'X,$G(PSOTPBFG) G QX
"RTN","PSOPRVW",45,0)
 I X S DR="53.92R;53.93R;53.94R;53.95R"
"RTN","PSOPRVW",46,0)
 E  S DR="53.92;53.93;53.94;53.95"
"RTN","PSOPRVW",47,0)
 S DR=DR_";D:X MS^PSOPRVW",DIE("NO^")="OUTOK" D ^DIE K DIE("NO^")
"RTN","PSOPRVW",48,0)
 I '$D(^VA(200,DA,"TPB")),$G(PSOTPBFG) G QX
"RTN","PSOPRVW",49,0)
 I $D(Y)!$D(DTOUT) D:$P($G(^VA(200,DA,"TPB")),"^",3)  G QX
"RTN","PSOPRVW",50,0)
 .I RTPB=""!('$P(RTPB,"^",3)) S DR="53.96////"_DUZ D ^DIE
"RTN","PSOPRVW",51,0)
 I $P($G(^VA(200,DA,"TPB")),"^",3) D
"RTN","PSOPRVW",52,0)
 .I RTPB=""!('$P(RTPB,"^",3)) S DR="53.96////"_DUZ D ^DIE
"RTN","PSOPRVW",53,0)
 G:$G(PSOTPBFG) QX
"RTN","PSOPRVW",54,0)
ED1 S DR="53.1:53.7;I 'X S Y=""@1"";53.8;@1;53.9;.111:.116;.131:.134;.136;.141"
"RTN","PSOPRVW",55,0)
 D ^DIE S FADA=DA D:'$D(Y) KEY
"RTN","PSOPRVW",56,0)
QX K FADA,RTPB L -^VA(200,DA) Q:$G(PSOTPBFG)  G:+$G(VADA) ADD G ASK
"RTN","PSOPRVW",57,0)
 Q
"RTN","PSOPRVW",58,0)
 G:'$D(^VA(200,DA,"TPB")) ED1
"RTN","PSOPRVW",59,0)
ADD ;add new providers (kernel 7)
"RTN","PSOPRVW",60,0)
 W !
"RTN","PSOPRVW",61,0)
 S VADA=$$ADD^XUSERNEW("53.91;S:'X Y=""@2"";53.92R;53.93R;53.94R;53.95R;D:X MS^PSOPRVW;@2;53.1;53.2;53.3;53.4;53.5;53.6;53.7;S:'X Y=""@1"";53.8;@1;53.9;.111:.116;.131:.134;.136;.141")
"RTN","PSOPRVW",62,0)
 S (FADA,DA)=+VADA,(DIC,DIE)="^VA(200,"
"RTN","PSOPRVW",63,0)
 I VADA>0,$P(VADA,"^",3),$P($G(^VA(200,DA,"TPB")),"^") D
"RTN","PSOPRVW",64,0)
 .S DR="53.96////"_DUZ D ^DIE
"RTN","PSOPRVW",65,0)
 I VADA>0,'$P(VADA,"^",3) S DIC(0)="AEQMZ" G:'$D(^VA(200,+VADA,"PS")) NPRV G:$D(^VA(200,+VADA,"PS")) ASK1
"RTN","PSOPRVW",66,0)
 D:VADA>0 KEY K DIK,DIC,Y,X,VADA,VA,DEA Q:$G(PSOTPBFG)  K DA G EX
"RTN","PSOPRVW",67,0)
 Q
"RTN","PSOPRVW",68,0)
NPRV W ! S DIR("A",1)=$P(^VA(200,DA,0),"^")_" is NOT currently indicated as being a provider.",DIR("A")="Do you want to make "_$P(^VA(200,DA,0),"^")_" a provider? (Y/N): ",DIR(0)="SA^1:YES;0:NO",DIR("B")="NO"
"RTN","PSOPRVW",69,0)
 S DIR("?",1)="Answer with '1' or 'Yes' if "_$P(^VA(200,DA,0),"^")_" is to become a provider",DIR("?")="otherwise press return for 'No' and re-enter name." D ^DIR G:$D(DTOUT) EX
"RTN","PSOPRVW",70,0)
 G:'Y!($D(DIRUT))&('+$G(VADA)) ASK G:'$P(+$G(VADA),"^",3)&('Y) ADD
"RTN","PSOPRVW",71,0)
 G EDT
"RTN","PSOPRVW",72,0)
 Q
"RTN","PSOPRVW",73,0)
KEY I $D(^VA(200,DA,"PS")) D
"RTN","PSOPRVW",74,0)
 .I '$P(^VA(200,DA,"PS"),"^",4)!($P(^("PS"),"^",4)>DT) S PSOPDA=DA K DIC S DIC="^DIC(19.1,",DIC(0)="MZ",X="PROVIDER" D ^DIC K DIC S DA=PSOPDA K PSOPDA I +Y>0 S X=+Y D
"RTN","PSOPRVW",75,0)
 ..S:'$D(^VA(200,FADA,51,0)) ^VA(200,FADA,51,0)="^"_$P(^DD(200,51,0),"^",2)_"^^"
"RTN","PSOPRVW",76,0)
 ..S DIC="^VA(200,"_FADA_",51,",DIC(0)="LM",DIC("DR")="1////"_$S($G(DUZ):DUZ,1:"")_";2///"_DT,DLAYGO=200.051,DINUM=X,DA(1)=FADA
"RTN","PSOPRVW",77,0)
 ..L +^VA(200,FADA):0 K DD,DO D FILE^DICN L -^VA(200,FADA) K DIC,DR,X,Y
"RTN","PSOPRVW",78,0)
 Q
"RTN","PSOPRVW",79,0)
MS ;
"RTN","PSOPRVW",80,0)
 W !!,$C(7),"This provider will not be selectable during TPB medication order entry!!",!
"RTN","PSOPRVW",81,0)
 Q
"RTN","PSOTPCAN")
0^2^B56194290
"RTN","PSOTPCAN",1,0)
PSOTPCAN ;BIR/RTR-TPB Utility routine ;08/23/03
"RTN","PSOTPCAN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,153**;DEC 1997
"RTN","PSOTPCAN",3,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOTPCAN",4,0)
 ;External reference to VA(200 supported by DBIA 224
"RTN","PSOTPCAN",5,0)
 ;
"RTN","PSOTPCAN",6,0)
 ;Check Rx being DC'd, if it's a TPB Rx, check to inactivate patient
"RTN","PSOTPCAN",7,0)
 ;Called from all DC actions
"RTN","PSOTPCAN",8,0)
CAN(PSOTPRCX) ;
"RTN","PSOTPCAN",9,0)
 I '$G(PSOTPRCX) Q
"RTN","PSOTPCAN",10,0)
 N PSOTPRC
"RTN","PSOTPCAN",11,0)
 S PSOTPRC=$P($G(^PSRX(PSOTPRCX,0)),"^",2)
"RTN","PSOTPCAN",12,0)
 I '$G(PSOTPRC) Q
"RTN","PSOTPCAN",13,0)
 I '$P($G(^PSRX(PSOTPRCX,"TPB")),"^") Q
"RTN","PSOTPCAN",14,0)
 I '$D(^PS(52.91,PSOTPRC,0)) Q
"RTN","PSOTPCAN",15,0)
 I $P($G(^PS(52.91,PSOTPRC,0)),"^",3),$P($G(^(0)),"^",3)'>DT Q
"RTN","PSOTPCAN",16,0)
 ;Patient is active in the TPB File, and TPB Rx is being canceled
"RTN","PSOTPCAN",17,0)
 I PSOTPRC'=$P($G(^PSRX(PSOTPRCX,0)),"^",2) Q
"RTN","PSOTPCAN",18,0)
 N PSOTPCSS,PSOTCXFL,PSOTC1,PSOTC2,PSOTC3,X1,X2,DA,DR,DIE,X,Y
"RTN","PSOTPCAN",19,0)
 S PSOTCXFL=0
"RTN","PSOTPCAN",20,0)
 S X1=DT,X2=-1 D C^%DTC S PSOTC3=X
"RTN","PSOTPCAN",21,0)
 F PSOTC1=PSOTC3:0 S PSOTC1=$O(^PS(55,PSOTPRC,"P","A",PSOTC1)) Q:'PSOTC1!(PSOTCXFL)  S PSOTC2="" F  S PSOTC2=$O(^PS(55,PSOTPRC,"P","A",PSOTC1,PSOTC2)) Q:PSOTC2=""!(PSOTCXFL)  D
"RTN","PSOTPCAN",22,0)
 .I $P($G(^PSRX(PSOTC2,0)),"^",2)'=PSOTPRC Q
"RTN","PSOTPCAN",23,0)
 .S PSOTPCSS=$P($G(^PSRX(PSOTC2,"STA")),"^")
"RTN","PSOTPCAN",24,0)
 .I PSOTPCSS'=0,PSOTPCSS'=1,PSOTPCSS'=2,PSOTPCSS'=3,PSOTPCSS'=4,PSOTPCSS'=5,PSOTPCSS'=16 Q
"RTN","PSOTPCAN",25,0)
 .I $P($G(^PSRX(PSOTC2,"TPB")),"^"),$P($G(^(2)),"^",6)'<DT S PSOTCXFL=1
"RTN","PSOTPCAN",26,0)
 I 'PSOTCXFL K DA,DIE,DR S DA=PSOTPRC,DIE="^PS(52.91,",DR="2////"_DT_";3////"_6 D ^DIE K DIE,DA,DR
"RTN","PSOTPCAN",27,0)
 Q
"RTN","PSOTPCAN",28,0)
 ;
"RTN","PSOTPCAN",29,0)
MARK ;Mark Rx as TPB Rx if applicable
"RTN","PSOTPCAN",30,0)
 N PSOTPODE,PSOZTRX
"RTN","PSOTPCAN",31,0)
 I '$G(PSOX("IRXN")) Q
"RTN","PSOTPCAN",32,0)
 I '$D(^PSRX(PSOX("IRXN"),0)) Q
"RTN","PSOTPCAN",33,0)
 I '$G(PSOTPBFG) Q
"RTN","PSOTPCAN",34,0)
 ;I $G(PSOFDR) Q
"RTN","PSOTPCAN",35,0)
 S PSOTPODE=$G(^PSRX(PSOX("IRXN"),0))
"RTN","PSOTPCAN",36,0)
 I '$P(PSOTPODE,"^",2)!('$P(PSOTPODE,"^",3))!('$P(PSOTPODE,"^",4)) Q
"RTN","PSOTPCAN",37,0)
 S PSOZTRX=$P($G(^PS(53,+$P(PSOTPODE,"^",3),0)),"^") I $$UP^XLFSTR(PSOZTRX)'="NON-VA" Q
"RTN","PSOTPCAN",38,0)
 I '$P($G(^VA(200,+$P(PSOTPODE,"^",4),"TPB")),"^") Q
"RTN","PSOTPCAN",39,0)
 I $P($G(^VA(200,+$P(PSOTPODE,"^",4),"TPB")),"^",5)'=0 Q
"RTN","PSOTPCAN",40,0)
 I '$D(^PS(52.91,+$P(PSOTPODE,"^",2),0)) Q
"RTN","PSOTPCAN",41,0)
 I $P($G(^PS(52.91,+$P(PSOTPODE,"^",2),0)),"^",3),$P($G(^(0)),"^",3)'>DT Q
"RTN","PSOTPCAN",42,0)
 ;Hard setting, to avoid DIE kiling any needed variables, no cross references on field, if added, need to use FileMan here
"RTN","PSOTPCAN",43,0)
 S $P(^PSRX(PSOX("IRXN"),"TPB"),"^")=1
"RTN","PSOTPCAN",44,0)
 Q
"RTN","PSOTPCAN",45,0)
MARKV ;Mark from Verify action
"RTN","PSOTPCAN",46,0)
 N PSOTPV1,PSOTPV2
"RTN","PSOTPCAN",47,0)
 I '$G(PSONVLP) Q
"RTN","PSOTPCAN",48,0)
 I '$D(^PSRX(PSONVLP,0)) Q
"RTN","PSOTPCAN",49,0)
 I '$G(PSOTPBFG) Q
"RTN","PSOTPCAN",50,0)
 ;I $G(PSOFDR) Q
"RTN","PSOTPCAN",51,0)
 S PSOTPV1=$G(^PSRX(PSONVLP,0))
"RTN","PSOTPCAN",52,0)
 I '$P(PSOTPV1,"^",2)!('$P(PSOTPV1,"^",3))!('$P(PSOTPV1,"^",4)) Q
"RTN","PSOTPCAN",53,0)
 S PSOTPV2=$P($G(^PS(53,+$P(PSOTPV1,"^",3),0)),"^") I $$UP^XLFSTR(PSOTPV2)'="NON-VA" Q
"RTN","PSOTPCAN",54,0)
 I '$P($G(^VA(200,+$P(PSOTPV1,"^",4),"TPB")),"^") Q
"RTN","PSOTPCAN",55,0)
 I $P($G(^VA(200,+$P(PSOTPV1,"^",4),"TPB")),"^",5)'=0 Q
"RTN","PSOTPCAN",56,0)
 I '$D(^PS(52.91,+$P(PSOTPV1,"^",2),0)) Q
"RTN","PSOTPCAN",57,0)
 I $P($G(^PS(52.91,+$P(PSOTPV1,"^",2),0)),"^",3),$P($G(^(0)),"^",3)'>DT Q
"RTN","PSOTPCAN",58,0)
 S $P(^PSRX(PSONVLP,"TPB"),"^")=1
"RTN","PSOTPCAN",59,0)
 Q
"RTN","PSOTPCAN",60,0)
RXPAT ;Sets Rx patient status to null
"RTN","PSOTPCAN",61,0)
 N PSOZZTRX
"RTN","PSOTPCAN",62,0)
 I $G(X),$G(X)'>DT D
"RTN","PSOTPCAN",63,0)
 .S PSOZZTRX=$P($G(^PS(53,+$P($G(^PS(55,DA,"PS")),"^"),0)),"^") S PSOZZTRX=$$UP^XLFSTR(PSOZZTRX) I PSOZZTRX="NON-VA" S $P(^PS(55,DA,"PS"),"^")=""
"RTN","PSOTPCAN",64,0)
 Q
"RTN","PSOTPCAN",65,0)
SET(PSOTPPST) ;Pass in DFN on a hard set of INACTIVATION OF BENEFIT DATE
"RTN","PSOTPCAN",66,0)
 N PSOZXTRX
"RTN","PSOTPCAN",67,0)
 I $P($G(^PS(52.91,PSOTPPST,0)),"^",3),$P($G(^(0)),"^",3)'>DT S PSOZXTRX=$P($G(^PS(53,+$P($G(^PS(55,PSOTPPST,"PS")),"^"),0)),"^") I $$UP^XLFSTR(PSOZXTRX)="NON-VA" S $P(^PS(55,PSOTPPST,"PS"),"^")=""
"RTN","PSOTPCAN",68,0)
 Q
"RTN","PSOTPCAN",69,0)
PCAP(PSOPAPPT) ;Find nearest Primary Care appointment
"RTN","PSOTPCAN",70,0)
 Q "TODAY AT NOON"
"RTN","PSOTPCAN",71,0)
 ;
"RTN","PSOTPCAN",72,0)
PDIR(PSOTPEX) ;
"RTN","PSOTPCAN",73,0)
 Q:'$G(PSOTPEX)
"RTN","PSOTPCAN",74,0)
 N PSOTPEXS
"RTN","PSOTPCAN",75,0)
 S PSOTPEXT=0
"RTN","PSOTPCAN",76,0)
 S PSOTPEXS=$P($G(^DPT(PSOTPEX,0)),"^",9)
"RTN","PSOTPCAN",77,0)
 W !!?10,$C(7),$P($G(^DPT(PSOTPEX,0)),"^")_" ("_$E(PSOTPEXS,1,3)_"-"_$E(PSOTPEXS,4,5)_"-"_$E(PSOTPEXS,6,9)_")"
"RTN","PSOTPCAN",78,0)
 W !?10,"Patient is eligible for the Transitional Pharmacy Benefit!!"
"RTN","PSOTPCAN",79,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press <ret> to continue, '^' to exit"  D ^DIR K DIR I Y'=1 S PSOTPEXT=1
"RTN","PSOTPCAN",80,0)
 Q
"RTN","PSOTPCAN",81,0)
VOPN ;
"RTN","PSOTPCAN",82,0)
 I '$G(PSOTPPEN) Q
"RTN","PSOTPCAN",83,0)
 I '$D(^PSRX(PSOTPPEN,0)) Q
"RTN","PSOTPCAN",84,0)
 N PSOTPPE3,PSOTPPE4,PSOTPPE5,PSOTPPE6,PSOTPPE7,PSOTPPE8
"RTN","PSOTPCAN",85,0)
 S PSOTPPE6=1
"RTN","PSOTPCAN",86,0)
 S PSOTPPE3=$P($G(^PSRX(PSOTPPEN,0)),"^",3),PSOTPPE4=$P($G(^PSRX(PSOTPPEN,0)),"^",4)
"RTN","PSOTPCAN",87,0)
VOPNX ;
"RTN","PSOTPCAN",88,0)
 I 'PSOTPPE4 S PSOTPPEX=1,PSOTPPE5(PSOTPPE6)="Unknown Provider!",PSOTPPE6=PSOTPPE6+1
"RTN","PSOTPCAN",89,0)
 I 'PSOTPPE3 S PSOTPPEX=1 S PSOTPPE5(PSOTPPE6)="Unknown Patient Status!",PSOTPPE6=PSOTPPE6+1
"RTN","PSOTPCAN",90,0)
 I PSOTPPE4,'$P($G(^VA(200,PSOTPPE4,"TPB")),"^") S PSOTPPE5(PSOTPPE6)="Provider is not flagged as a NON-VA PRESCRIBER!",PSOTPPE6=PSOTPPE6+1,PSOTPPEX=1
"RTN","PSOTPCAN",91,0)
 I PSOTPPE4,$P($G(^VA(200,PSOTPPE4,"TPB")),"^",5)'=0 S PSOTPPE5(PSOTPPE6)="Provider is not flagged as not being on exclusionary list!",PSOTPPE6=PSOTPPE6+1,PSOTPPEX=1
"RTN","PSOTPCAN",92,0)
 I PSOTPPE3 S PSOTPPE7=$P($G(^PS(53,PSOTPPE3,0)),"^") S PSOTPPE7=$$UP^XLFSTR(PSOTPPE7) I PSOTPPE7'="NON-VA" S PSOTPPE5(PSOTPPE6)="Rx Patient Status is not equal to 'NON-VA'!",PSOTPPE6=PSOTPPE6+1,PSOTPPEX=1
"RTN","PSOTPCAN",93,0)
 I $G(PSOTPPEX) D  I $G(PSOTPPE9) S VALMSG="Cannot Verify through this option"
"RTN","PSOTPCAN",94,0)
 .W ! F PSOTPPE8=0:0 S PSOTPPE8=$O(PSOTPPE5(PSOTPPE8)) Q:'PSOTPPE8  W !,$G(PSOTPPE5(PSOTPPE8))
"RTN","PSOTPCAN",95,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOTPCAN",96,0)
 Q
"RTN","PSOTPCAN",97,0)
VOPNR ;
"RTN","PSOTPCAN",98,0)
 I '$G(PSOTPPEN) Q
"RTN","PSOTPCAN",99,0)
 I '$D(^PS(52.41,PSOTPPEN,0)) Q
"RTN","PSOTPCAN",100,0)
 N PSOTPPE3,PSOTPPE4,PSOTPPE5,PSOTPPE6,PSOTPPE7,PSOTPPE8
"RTN","PSOTPCAN",101,0)
 S PSOTPPE6=1
"RTN","PSOTPCAN",102,0)
 I $P(^PS(52.41,PSOTPPEN,0),"^",3)="RNW",$D(^PSRX(+$P(^PS(52.41,PSOTPPEN,0),"^",21),0)) S PSOTPPE3=$P($G(^PSRX(+$P(^PS(52.41,PSOTPPEN,0),"^",21),0)),"^",3) G NOREN
"RTN","PSOTPCAN",103,0)
 S PSOTPPE3=$P($G(^PS(55,+$P($G(^PS(52.41,PSOTPPEN,0)),"^",2),"PS")),"^")
"RTN","PSOTPCAN",104,0)
NOREN ;
"RTN","PSOTPCAN",105,0)
 S PSOTPPE4=$P($G(^PS(52.41,PSOTPPEN,0)),"^",5)
"RTN","PSOTPCAN",106,0)
 G VOPNX
"RTN","PSOTPCAN",107,0)
 ;
"RTN","PSOTPCAN",108,0)
DSPL(PSOTPWRN) ;
"RTN","PSOTPCAN",109,0)
 N DIR,PSOTPWR1,PSOTPWR2,PSOTPWR3
"RTN","PSOTPCAN",110,0)
 I '$G(PSOTPWRN) Q
"RTN","PSOTPCAN",111,0)
 I '$D(^PS(52.41,PSOTPWRN,0)) Q
"RTN","PSOTPCAN",112,0)
 I $P(^PS(52.41,PSOTPWRN,0),"^",3)="RNW",$D(^PSRX(+$P(^PS(52.41,PSOTPWRN,0),"^",21),0)) D  Q
"RTN","PSOTPCAN",113,0)
 .S PSOTPWR1=$P($G(^PSRX(+$P(^PS(52.41,PSOTPWRN,0),"^",21),0)),"^",3),PSOTPWR2=$P($G(^PS(53,PSOTPWR1,0)),"^") S PSOTPWR3=$$UP^XLFSTR(PSOTPWR2) I PSOTPWR3="NON-VA" D
"RTN","PSOTPCAN",114,0)
 ..K DIR W !!,"This order has an Rx Patient Status of 'NON-VA'!",! K DIR S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSOTPCAN",115,0)
 S PSOTPWR1=$P($G(^PS(55,+$P($G(^PS(52.41,PSOTPWRN,0)),"^",2),"PS")),"^")
"RTN","PSOTPCAN",116,0)
 S PSOTPWR2=$P($G(^PS(53,PSOTPWR1,0)),"^") S PSOTPWR3=$$UP^XLFSTR(PSOTPWR2) I PSOTPWR3="NON-VA" D
"RTN","PSOTPCAN",117,0)
 .W !!,"This order has an Rx Patient Status of 'NON-VA'!",! K DIR S DIR(0)="E",DIR("A")="Press return to continue"  D ^DIR K DIR
"RTN","PSOTPCAN",118,0)
 Q
"RTN","PSOTPCAN",119,0)
EXFLAG(PSOTPPX) ;Exit TPB RX option, reset TPG flag if necessary,
"RTN","PSOTPCAN",120,0)
 ;and possibly delete inactive date and reason code for patient in 52.91
"RTN","PSOTPCAN",121,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOTPCAN",122,0)
 I '$G(PSOTPPX) Q
"RTN","PSOTPCAN",123,0)
 I '$D(^PS(52.91,PSOTPPX,0)) Q
"RTN","PSOTPCAN",124,0)
 I $E($P(^PS(52.91,PSOTPPX,0),"^",3),1,7)'=DT Q
"RTN","PSOTPCAN",125,0)
 I $P(^PS(52.91,PSOTPPX,0),"^",4)'=6 Q
"RTN","PSOTPCAN",126,0)
 N DR,DIE,X1,X2,X,Y,DA,PSOTPPX1,PSOTPPX2,PSOTPPX3,PSOTPPX4,PSOTPPX5,PSOTPPX6,PSOTPPX7,PSOTPPX9
"RTN","PSOTPCAN",127,0)
 S X1=DT,X2=-1 D C^%DTC S PSOTPPX1=X
"RTN","PSOTPCAN",128,0)
 S PSOTPPX9=0
"RTN","PSOTPCAN",129,0)
 F PSOTPPX2=PSOTPPX1:0 S PSOTPPX2=$O(^PS(55,PSOTPPX,"P","A",PSOTPPX2)) Q:'PSOTPPX2  S PSOTPPX3="" F  S PSOTPPX3=$O(^PS(55,PSOTPPX,"P","A",PSOTPPX2,PSOTPPX3)) Q:PSOTPPX3=""  D
"RTN","PSOTPCAN",130,0)
 .I PSOTPPX'=$P($G(^PSRX(PSOTPPX3,0)),"^",2) Q
"RTN","PSOTPCAN",131,0)
 .I $P($G(^PSRX(PSOTPPX3,"TPB")),"^") Q
"RTN","PSOTPCAN",132,0)
 .I $E($P($G(^PSRX(PSOTPPX3,2)),"^"),1,7)'=DT Q
"RTN","PSOTPCAN",133,0)
 .S PSOTPPX4=$P($G(^PSRX(PSOTPPX3,"STA")),"^") I PSOTPPX4="" Q
"RTN","PSOTPCAN",134,0)
 .I PSOTPPX4'=0,PSOTPPX4'=1,PSOTPPX4'=2,PSOTPPX4'=3,PSOTPPX4'=4,PSOTPPX4'=5,PSOTPPX4'=16 Q
"RTN","PSOTPCAN",135,0)
 .S PSOTPPX5=$P(^PSRX(PSOTPPX3,0),"^",3),PSOTPPX6=$P(^(0),"^",4)
"RTN","PSOTPCAN",136,0)
 .I 'PSOTPPX5!('PSOTPPX6) Q
"RTN","PSOTPCAN",137,0)
 .S PSOTPPX7=$P($G(^PS(53,+PSOTPPX5,0)),"^") S PSOTPPX7=$$UP^XLFSTR(PSOTPPX7) I PSOTPPX7'="NON-VA" Q
"RTN","PSOTPCAN",138,0)
 .I '$P($G(^VA(200,PSOTPPX6,"TPB")),"^")!($P($G(^("TPB")),"^",5)'=0) Q
"RTN","PSOTPCAN",139,0)
 .S $P(^PSRX(PSOTPPX3,"TPB"),"^")=1,PSOTPPX9=1
"RTN","PSOTPCAN",140,0)
 I PSOTPPX9 K DA,DIE,DR S DIE="^PS(52.91,",DA=PSOTPPX,DR="2////"_"@"_";3////"_"@" D ^DIE K DIE,DA,DR
"RTN","PSOTPCAN",141,0)
 Q
"RTN","PSOTPCAN",142,0)
 ;
"RTN","PSOTPCAN",143,0)
SCH ;DBIA to return TPB patients to Scheduling
"RTN","PSOTPCAN",144,0)
 N PSOSCT,PSOSCTD
"RTN","PSOTPCAN",145,0)
 K ^TMP($J,"PSODFN")
"RTN","PSOTPCAN",146,0)
 F PSOSCT=0:0 S PSOSCT=$O(^PS(52.91,PSOSCT)) Q:'PSOSCT  I PSOSCT=$P($G(^(PSOSCT,0)),"^") D
"RTN","PSOTPCAN",147,0)
 .S PSOSCTD=$P($G(^PS(52.91,PSOSCT,0)),"^",3)
"RTN","PSOTPCAN",148,0)
 .I 'PSOSCTD!(PSOSCTD>DT) D
"RTN","PSOTPCAN",149,0)
 ..I $P($G(^DPT(PSOSCT,0)),"^")="" Q
"RTN","PSOTPCAN",150,0)
 ..S ^TMP($J,"PSODFN",$P($G(^DPT(PSOSCT,0)),"^"),PSOSCT)=""
"RTN","PSOTPCAN",151,0)
 Q
"RTN","PSOTPCEE")
0^5^B7754641
"RTN","PSOTPCEE",1,0)
PSOTPCEE ;BIR/MHA-transitional pharmacy benefit enter/edit ;07/01/03
"RTN","PSOTPCEE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,153**;DEC 1997
"RTN","PSOTPCEE",3,0)
 ;;External reference to SDPHARM1 supported by DBIA 4196
"RTN","PSOTPCEE",4,0)
 ;;External reference ^DIC(4 supported by DBIA 2251
"RTN","PSOTPCEE",5,0)
ST N PSODFN,FLG,PSODF,FI,INST,SNO,CDT,UL S FI=52.91,$P(UL,"=",79)="="
"RTN","PSOTPCEE",6,0)
PT K DIC,DIE,PSODFN,FLG,PSODF,REC,INST,SNO,CDT
"RTN","PSOTPCEE",7,0)
 W ! S (DIC,DIE)=52.91,DIC(0)="QEALM",DLAYGO=FI
"RTN","PSOTPCEE",8,0)
 ;S DIC("W")="W ?15,$$GET1^DIQ(2,+Y,.01)"
"RTN","PSOTPCEE",9,0)
 D ^DIC G:+Y'>0 PTX S FLG=$P(Y,"^",3)
"RTN","PSOTPCEE",10,0)
 S (PSODFN,DA)=+Y,DR=.351,DIC=2,DIQ="PSODF" D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOTPCEE",11,0)
 I $G(PSODF(2,DA,.351))]"",FLG D  G PT
"RTN","PSOTPCEE",12,0)
 .W !!?10,$C(7),"Patient died on "_PSODF(2,PSODFN,.351)_" - Cannot be added to file!!",!
"RTN","PSOTPCEE",13,0)
 .S DIK="^PS(52.91," D ^DIK K DIK
"RTN","PSOTPCEE",14,0)
 L +^PS(FI,DA):0 I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! G PT
"RTN","PSOTPCEE",15,0)
 S (INST,SNO)="" D:FLG
"RTN","PSOTPCEE",16,0)
 .S X=$$DEF^SDPHARM1(DA) S:X INST=$P(X,"^"),SNO=$P(X,"^",2)
"RTN","PSOTPCEE",17,0)
 .S DR="1////"_DT_";5////M;6////"_SNO_";7////"_INST D ^DIE
"RTN","PSOTPCEE",18,0)
INS S REC=$G(^PS(FI,DA,0))
"RTN","PSOTPCEE",19,0)
 S DR="7" D ^DIE I $D(Y)!($D(DTOUT)) D:FLG RM L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",20,0)
 I X,X'=$P(REC,"^",8) S $P(REC,"^",7)=$P($G(^DIC(4,X,99)),"^"),DR="6////"_$P($G(^DIC(4,X,99)),"^") D ^DIE
"RTN","PSOTPCEE",21,0)
 S DR="6" D ^DIE I $D(Y)!($D(DTOUT)) D:FLG RM L -^PS(52.91,DA) G PT
"RTN","PSOTPCEE",22,0)
 I X,X'=$P(REC,"^",7),$$IEN^XUAF4(X) S DR="7////"_$$IEN^XUAF4(X) D ^DIE G INS
"RTN","PSOTPCEE",23,0)
 S CDT=$P(REC,"^",3)
"RTN","PSOTPCEE",24,0)
 S DR="2" D ^DIE I $D(Y)!($D(DTOUT)) L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",25,0)
 I CDT,X="" S DR="3////@" D ^DIE W !,"INACTIVATION REASON CODE: " G CONT
"RTN","PSOTPCEE",26,0)
 I X S DR="3R",DIE("NO^")="" D ^DIE I $D(DTOUT) S DR="3////3" D ^DIE L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",27,0)
CONT L -^PS(FI,DA)
"RTN","PSOTPCEE",28,0)
 S Y=$S(FLG:DT,1:$P(REC,"^",2)) X ^DD("DD")
"RTN","PSOTPCEE",29,0)
 W !!,UL,!,"DATE PHARMACY BENEFIT BEGAN: "_Y
"RTN","PSOTPCEE",30,0)
 S Y=$P(REC,"^",6),Y=$S(Y="E":"EWL",Y="S":"SCHEDULED APPOINTMENT",Y="X":"EWL & SCHEDULED APPOINTMENT",Y="M":"MANUAL",1:"")
"RTN","PSOTPCEE",31,0)
 W ?42,"WAIT TYPE: "_Y
"RTN","PSOTPCEE",32,0)
 S Y=$P(REC,"^",5) I Y X ^DD("DD")
"RTN","PSOTPCEE",33,0)
 W !,"DESIRED APPOINTMENT DATE: "_Y
"RTN","PSOTPCEE",34,0)
 W !,"EXCLUSION REASON: " S Y=$P(REC,"^",9)
"RTN","PSOTPCEE",35,0)
 W:Y=1 "ACTIVE RX"
"RTN","PSOTPCEE",36,0)
 W:Y=2 "ACTUAL APPT. < 30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCEE",37,0)
 W:Y=3 "ACTIVE RX & ACTUAL APPT. < 30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCEE",38,0)
 S Y=$P(REC,"^",10) I Y X ^DD("DD")
"RTN","PSOTPCEE",39,0)
 W !,"PRIMARY CARE SCHEDULE APT DATE: "_Y_"   "_"RX #: "_$P(REC,"^",11)
"RTN","PSOTPCEE",40,0)
 S Y=$P(REC,"^",12) I Y X ^DD("DD")
"RTN","PSOTPCEE",41,0)
 W !,"DATE LETTER PRINTED: "_Y,!,UL
"RTN","PSOTPCEE",42,0)
 G PT
"RTN","PSOTPCEE",43,0)
PTX K DIC,DIE,%DT,DR,DA Q
"RTN","PSOTPCEE",44,0)
RM ;
"RTN","PSOTPCEE",45,0)
 ;W !?10,$C(7),"Required Data - Setting patient as Inactive"
"RTN","PSOTPCEE",46,0)
 ;S DR="2////"_DT_";3////3" D ^DIE
"RTN","PSOTPCEE",47,0)
 W !!,$C(7),"Required Data - deleting patient entry from TPB ELIGIBILITY (#52.91) File."
"RTN","PSOTPCEE",48,0)
 K DIK S DIK="^PS(52.91,",DA=PSODFN D ^DIK K DIK,^PS(52.91,"AX",DT,DA)
"RTN","PSOTPCEE",49,0)
 Q
"RTN","PSOTPCRP")
0^3^B52762483
"RTN","PSOTPCRP",1,0)
PSOTPCRP ;BIR/RTR-Non VA phycisian eligible patient report ;07/07/03
"RTN","PSOTPCRP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,153**;DEC 1997
"RTN","PSOTPCRP",3,0)
EN ;
"RTN","PSOTPCRP",4,0)
 W !!,"This report prints entries from the TPB ELIGIBILITY file (#52.91)."
"RTN","PSOTPCRP",5,0)
 W !,"If multiple Institutions are selected, and some Institutions have data and",!,"some don't, only those Institutions that have data will print on the report.",!
"RTN","PSOTPCRP",6,0)
 N PSOGPINS,PSOGPAR,PSOGOK,PSOGSORT
"RTN","PSOTPCRP",7,0)
 S PSOGPINS=0
"RTN","PSOTPCRP",8,0)
INST ;Ask for Institutions
"RTN","PSOTPCRP",9,0)
 K DIR S DIR(0)="S^S:SELECT;A:ALL",DIR("B")="SELECT",DIR("A")="Print Report for Selected Institutions, or All Institutions" D  D ^DIR K DIR I Y["^"!($D(DTOUT))!($D(DUOUT)) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",10,0)
 .S DIR("?")=" ",DIR("?",1)="Enter 'S' to select one or more Institutions to print the report for,",DIR("?",2)="Enter 'A' to print the report for all Institutions."
"RTN","PSOTPCRP",11,0)
 I Y="A" S PSOGPINS=1 G PASS
"RTN","PSOTPCRP",12,0)
 S PSOGOK=0
"RTN","PSOTPCRP",13,0)
INSTX ;Ask for individual Institutions
"RTN","PSOTPCRP",14,0)
 K DIC S DIC(0)="QEAMZ",DIC=4 D  W ! D ^DIC K DIC I 'PSOGOK,(Y<1!($D(DUOUT))!($D(DTOUT))) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",15,0)
 .I 'PSOGOK,$G(DUZ(2)) S DIC("B")=DUZ(2)
"RTN","PSOTPCRP",16,0)
 .I PSOGOK S DIC("A")="Select another INSTITUTION NAME:"
"RTN","PSOTPCRP",17,0)
 I Y>0 S PSOGPAR(+Y)="",PSOGOK=1 G INSTX
"RTN","PSOTPCRP",18,0)
 I '$O(PSOGPAR(0)) W !,"No Institutions selected, nothing queued to print.",! Q
"RTN","PSOTPCRP",19,0)
PASS ;
"RTN","PSOTPCRP",20,0)
ACT ;Ask for type of report
"RTN","PSOTPCRP",21,0)
 W ! K DIR S DIR(0)="S^A:ALL PATIENTS;E:ELIGIBLE PATIENTS;I:INELIGIBLE PATIENTS",DIR("B")="ALL PATIENTS",DIR("A")="Select patients for report" D  D ^DIR K DIR I Y["^"!($D(DTOUT))!($D(DUOUT)) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",22,0)
 .S DIR("?")=" ",DIR("?",1)="To see only those patients currently eligible for the Transitional Pharmacy",DIR("?",2)="Benefit program, enter 'E'. To see all patients currently in the TPB"
"RTN","PSOTPCRP",23,0)
 .S DIR("?",3)="ELIGIBILITY file (#52.91), but not currently eligible for the benefit,",DIR("?",4)="enter 'I'. To see all patients in the TPB ELIGIBILITY file (#52.91),"
"RTN","PSOTPCRP",24,0)
 .S DIR("?",5)="both eligible and ineligible, enter 'A'."
"RTN","PSOTPCRP",25,0)
 S PSOGSORT=Y
"RTN","PSOTPCRP",26,0)
 W ! K IOP,%ZIS,POP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",27,0)
 I $D(IO("Q")) S ZTRTN="START^PSOTPCRP",ZTDESC="TPB ELIGIBILITY Report",ZTSAVE("PSOGPINS")="",ZTSAVE("PSOGSORT")="",ZTSAVE("PSOGPAR(")="" D ^%ZTLOAD K %ZIS W !,"Report queued to print.",! K ZTRTN,ZTDESC,ZTSAVE Q
"RTN","PSOTPCRP",28,0)
START ;
"RTN","PSOTPCRP",29,0)
 K ^TMP("PSOGP",$J)
"RTN","PSOTPCRP",30,0)
 U IO
"RTN","PSOTPCRP",31,0)
 N DIC,DIQ,DA,DR,PSOGPOUT,PSOGDV,PSOGPAGE,PSOGTOP,PSOGPLIN,PSOGLOP,PSOGNODE,PSOGNAME,PSOINAME,PSOTAR,PSOG1,PSOG2,PSOG3,PSOG4,DFN,VADM,PSOGSSN,PSOGSSNX,PSOXND,PSOXRS,VA,VAERR,PSOTINS,PSOTARX,PSOVADIS,PSOVADIX
"RTN","PSOTPCRP",32,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOTPCRP",33,0)
 S PSOGPOUT=0,PSOGDV=$S($E(IOST,1,2)'="C-":0,1:1),PSOGPAGE=1
"RTN","PSOTPCRP",34,0)
 S $P(PSOGPLIN,"-",79)=""
"RTN","PSOTPCRP",35,0)
 ;Set TMP global, store grand total count in PSOGTOP, Subtotals in PSOTAR array
"RTN","PSOTPCRP",36,0)
 S PSOGTOP=0
"RTN","PSOTPCRP",37,0)
 F PSOGLOP=0:0 S PSOGLOP=$O(^PS(52.91,PSOGLOP)) Q:'PSOGLOP  D
"RTN","PSOTPCRP",38,0)
 .S PSOGNODE=$G(^PS(52.91,PSOGLOP,0)) I 'PSOGNODE Q
"RTN","PSOTPCRP",39,0)
 .;If selecting institutions, and patient if file with no Institution won't show on the report??
"RTN","PSOTPCRP",40,0)
 .I 'PSOGPINS,'$D(PSOGPAR(+$P(PSOGNODE,"^",8))),$P(PSOGNODE,"^",8) Q
"RTN","PSOTPCRP",41,0)
 .I PSOGSORT="E",$P(PSOGNODE,"^",3),$P(PSOGNODE,"^",3)'>DT Q
"RTN","PSOTPCRP",42,0)
 .I PSOGSORT="I" I '$P(PSOGNODE,"^",3)!($P(PSOGNODE,"^",3)>DT) Q
"RTN","PSOTPCRP",43,0)
 .K VADM S DFN=+$P(PSOGNODE,"^") I 'DFN Q
"RTN","PSOTPCRP",44,0)
 .D DEM^VADPT I $G(VADM(1))="" K VADM Q
"RTN","PSOTPCRP",45,0)
 .S PSOGNAME=$G(VADM(1))
"RTN","PSOTPCRP",46,0)
 .K VADM
"RTN","PSOTPCRP",47,0)
 .K VA,VAERR S DFN=+$P(PSOGNODE,"^") D PID^VADPT6
"RTN","PSOTPCRP",48,0)
 .S PSOGNAME=PSOGNAME_"("_$G(VA("BID"))_")"
"RTN","PSOTPCRP",49,0)
 .K VA,VAERR
"RTN","PSOTPCRP",50,0)
 .S ^TMP("PSOGP",$J,$S($P(PSOGNODE,"^",8):$P(PSOGNODE,"^",8),1:"NONE"),PSOGNAME,$P(PSOGNODE,"^"),PSOGLOP)="",PSOGTOP=PSOGTOP+1
"RTN","PSOTPCRP",51,0)
 .I $P(PSOGNODE,"^",8) S PSOTAR($P(PSOGNODE,"^",8))=$G(PSOTAR($P(PSOGNODE,"^",8)))+1 Q
"RTN","PSOTPCRP",52,0)
 .S PSOTAR("NONE")=$G(PSOTAR("NONE"))+1
"RTN","PSOTPCRP",53,0)
 ;D HD
"RTN","PSOTPCRP",54,0)
 I 'PSOGTOP D HD W !!,"No patients found that meet report criteria.",! G END
"RTN","PSOTPCRP",55,0)
 S PSOG1="" F  S PSOG1=$O(^TMP("PSOGP",$J,PSOG1)) Q:PSOG1=""!(PSOGPOUT)  D
"RTN","PSOTPCRP",56,0)
 .I $G(PSOG1)="NONE" S PSOINAME="NONE"
"RTN","PSOTPCRP",57,0)
 .I $G(PSOG1)'="NONE" K PSOTINS,DIC,DIQ,DA,DR S DIC=4,DR=".01",DA=+PSOG1,DIQ(0)="E",DIQ="PSOTINS" D EN^DIQ1 S PSOINAME=$G(PSOTINS(4,+PSOG1,.01,"E")) K DIC,DIQ,DR,DA,PSOTINS
"RTN","PSOTPCRP",58,0)
 .D HD I PSOGPOUT Q
"RTN","PSOTPCRP",59,0)
 .S PSOTARX=0
"RTN","PSOTPCRP",60,0)
 .S PSOG2="" F  S PSOG2=$O(^TMP("PSOGP",$J,PSOG1,PSOG2)) Q:PSOG2=""!(PSOGPOUT)  F PSOG3=0:0 S PSOG3=$O(^TMP("PSOGP",$J,PSOG1,PSOG2,PSOG3)) Q:'PSOG3!(PSOGPOUT)  D
"RTN","PSOTPCRP",61,0)
 ..F PSOG4=0:0 S PSOG4=$O(^TMP("PSOGP",$J,PSOG1,PSOG2,PSOG3,PSOG4)) Q:'PSOG4!(PSOGPOUT)  D
"RTN","PSOTPCRP",62,0)
 ...S PSOXND=$G(^PS(52.91,PSOG4,0))
"RTN","PSOTPCRP",63,0)
 ...D ADDR
"RTN","PSOTPCRP",64,0)
 ...S PSOTARX=PSOTARX+1
"RTN","PSOTPCRP",65,0)
 ...W !!,PSOG2
"RTN","PSOTPCRP",66,0)
 ...W ?38,$S($P(PSOXND,"^",2):$E($P(PSOXND,"^",2),4,5)_"/"_$E($P(PSOXND,"^",2),6,7)_"/"_$E($P(PSOXND,"^",2),2,3),1:"")
"RTN","PSOTPCRP",67,0)
 ...W ?47,$S($P(PSOXND,"^",3):$E($P(PSOXND,"^",3),4,5)_"/"_$E($P(PSOXND,"^",3),6,7)_"/"_$E($P(PSOXND,"^",3),2,3),1:"")
"RTN","PSOTPCRP",68,0)
 ...W ?56,$S($P(PSOXND,"^",12):$E($P(PSOXND,"^",12),4,5)_"/"_$E($P(PSOXND,"^",12),6,7)_"/"_$E($P(PSOXND,"^",12),2,3),1:"")
"RTN","PSOTPCRP",69,0)
 ...S PSOXRS=$P(PSOXND,"^",4)
"RTN","PSOTPCRP",70,0)
 ...W ?65,$S(PSOXRS=1:"VA Provider",PSOXRS=2:"No/Show/Cancel",PSOXRS=3:"Patient Ended",PSOXRS=4:"N/F Rx",PSOXRS=5:"Patient Expired",PSOXRS=6:"Rx's Inactive",PSOXRS=7:"Exclusion",PSOXRS=8:"Refused Appt.",PSOXRS=9:"Pat Unreachable",1:"")
"RTN","PSOTPCRP",71,0)
 ...I $P(PSOXND,"^",9) D
"RTN","PSOTPCRP",72,0)
 ....I $P(PSOXND,"^",9)=1 W !?1,"Exclusion: ACTIVE RX "_$P(PSOXND,"^",11) Q
"RTN","PSOTPCRP",73,0)
 ....I $P(PSOXND,"^",9)=2 W !?1,"Exclusion: ACTUAL APPT. <30 DAYS FROM DATE APPT. MADE" Q
"RTN","PSOTPCRP",74,0)
 ....I $P(PSOXND,"^",9)=3 W !?1,"Exclusion: ACTIVE RX "_$P(PSOXND,"^",11)_" & ACTUAL APPT. <30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCRP",75,0)
 ...I ($Y+6)>IOSL,$G(PSOVADIS)'="" D HD I PSOGPOUT K PSOVADIS,PSOVADIX Q
"RTN","PSOTPCRP",76,0)
 ...I $G(PSOVADIS)'="" W !,$G(PSOVADIS)
"RTN","PSOTPCRP",77,0)
 ...I ($Y+6)>IOSL,$G(PSOVADIX)'="" D HD I PSOGPOUT K PSOVADIS,PSOVADIX Q
"RTN","PSOTPCRP",78,0)
 ...I $G(PSOVADIX)'="" W !,$G(PSOVADIX)
"RTN","PSOTPCRP",79,0)
 ...K PSOVADIS,PSOVADIX
"RTN","PSOTPCRP",80,0)
 ...I ($Y+6)>IOSL,PSOTARX'=$G(PSOTAR(PSOG1)) D HD
"RTN","PSOTPCRP",81,0)
 G END
"RTN","PSOTPCRP",82,0)
HD ;HEADER
"RTN","PSOTPCRP",83,0)
 I PSOGDV,PSOGPAGE'=1 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue, '^' to exit" D ^DIR K DIR I 'Y S PSOGPOUT=1 Q
"RTN","PSOTPCRP",84,0)
 I PSOGPAGE=1,'PSOGDV W ! I 1
"RTN","PSOTPCRP",85,0)
 E  W @IOF
"RTN","PSOTPCRP",86,0)
 W !,$S(PSOGSORT="E":"Eligible Patients",PSOGSORT="I":"Ineligible Patients",1:"All Patients")_$S($G(PSOINAME)="":"",1:" (")_$G(PSOINAME)_$S($G(PSOINAME)="":"",1:")")_"  Total: "_$S($G(PSOG1)'="":$G(PSOTAR(PSOG1)),1:""),?68,"PAGE: "_PSOGPAGE
"RTN","PSOTPCRP",87,0)
 S PSOGPAGE=PSOGPAGE+1
"RTN","PSOTPCRP",88,0)
 ;I $G(PSOINAME)'="" W !,"("_PSOINAME_")"_"  Total: ",$G(PSOTAR(PSOG1))
"RTN","PSOTPCRP",89,0)
 W !,"Grand Total: "_PSOGTOP,?38,"Start",?47,"Stop",?56,"Letter",?65,"Inactivation",!,"Patient",?38,"Date",?47,"Date",?56,"Date",?65,"Reason",!,PSOGPLIN
"RTN","PSOTPCRP",90,0)
 Q
"RTN","PSOTPCRP",91,0)
END ;End report
"RTN","PSOTPCRP",92,0)
 K ^TMP("PSOGP",$J),PSOGPAR,PSOGSORT,PSOGPINS
"RTN","PSOTPCRP",93,0)
 I '$G(PSOGPOUT),PSOGDV W !!,"End of Report." K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOTPCRP",94,0)
 I 'PSOGDV W !!,"End of Report."
"RTN","PSOTPCRP",95,0)
 I PSOGDV W !
"RTN","PSOTPCRP",96,0)
 E  W @IOF
"RTN","PSOTPCRP",97,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTPCRP",98,0)
 Q
"RTN","PSOTPCRP",99,0)
ADDR ;Check for difference in State
"RTN","PSOTPCRP",100,0)
 N PSOVA1,PSOVA2,VAPA
"RTN","PSOTPCRP",101,0)
 S (PSOVADIX,PSOVADIS)=""
"RTN","PSOTPCRP",102,0)
 S DFN=$P($G(^PS(52.91,PSOG4,0)),"^")
"RTN","PSOTPCRP",103,0)
 I '$G(DFN) Q
"RTN","PSOTPCRP",104,0)
 D ADD^VADPT
"RTN","PSOTPCRP",105,0)
 I '$G(VAPA(12)) K VAPA G ADDRX
"RTN","PSOTPCRP",106,0)
 I $P($G(VAPA(22,1)),"^",3)'="Y",$P($G(VAPA(22,2)),"^",3)'="Y",$P($G(VAPA(22,5)),"^",3)'="Y" K VAPA G ADDRX
"RTN","PSOTPCRP",107,0)
 S PSOVADIS="Confidential State = "_$P($G(VAPA(17)),"^",2)
"RTN","PSOTPCRP",108,0)
 I $G(VAPA(5))'=$G(VAPA(17)) S PSOVADIX=$S($G(VAPA(9)):"Temporary State = ",1:"Permanent State = ")_$P($G(VAPA(5)),"^",2)
"RTN","PSOTPCRP",109,0)
 K VAPA
"RTN","PSOTPCRP",110,0)
 Q
"RTN","PSOTPCRP",111,0)
ADDRX ;
"RTN","PSOTPCRP",112,0)
 K VAPA D ADD^VADPT I '$G(VAPA(9)) S PSOVADIS="Permanent State = "_$P($G(VAPA(5)),"^",2) K VAPA Q
"RTN","PSOTPCRP",113,0)
 S PSOVADIS="Temporary State = "_$P($G(VAPA(5)),"^",2)
"RTN","PSOTPCRP",114,0)
 S PSOVA1=$G(VAPA(5))
"RTN","PSOTPCRP",115,0)
 K VAPA S VAPA("P")="" D ADD^VADPT
"RTN","PSOTPCRP",116,0)
 S PSOVA2=$G(VAPA(5))
"RTN","PSOTPCRP",117,0)
 I PSOVA1=PSOVA2 K VAPA Q
"RTN","PSOTPCRP",118,0)
 S PSOVADIX="Permanent State = "_$P($G(PSOVA2),"^",2)
"RTN","PSOTPCRP",119,0)
 K VAPA
"RTN","PSOTPCRP",120,0)
 Q
"RTN","PSOTPHL1")
0^4^B71593697
"RTN","PSOTPHL1",1,0)
PSOTPHL1 ;BPFO/EL-CREATE HL7 BATCH MESSAGE FILE ;09/10/03
"RTN","PSOTPHL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,153**;DEC 1997
"RTN","PSOTPHL1",3,0)
 ;
"RTN","PSOTPHL1",4,0)
 ; Summary:
"RTN","PSOTPHL1",5,0)
 ; Use of ^VAFCQRY API is approved under private IA #3630
"RTN","PSOTPHL1",6,0)
 ; For initial run, makes sure the "Transmission End Date" (#46.2) in 
"RTN","PSOTPHL1",7,0)
 ;    File 59.7 - Pharmacy System File is null.
"RTN","PSOTPHL1",8,0)
 ; If field (#46.2) is null, the system will pick up all DFN in File 52.91 
"RTN","PSOTPHL1",9,0)
 ;    from the first date of file creation to the "RunDate"-1.
"RTN","PSOTPHL1",10,0)
 ; If field (#46.2) has a date, the system will pick up DFN starting 
"RTN","PSOTPHL1",11,0)
 ;    from the last "Transmission End Date"+1 to the "RunDate"-1.
"RTN","PSOTPHL1",12,0)
 ; This program only runs on Sunday.  RunTime will be 6pm.
"RTN","PSOTPHL1",13,0)
 ; Tab: EN^PSOTPHL1(RDT,EDT,.SDT) is the ad-hoc entry point if user 
"RTN","PSOTPHL1",14,0)
 ;    wants to run it at certain "Transmission Begin Date", 
"RTN","PSOTPHL1",15,0)
 ;    "Transmission End Date", & return actual "Transmission Begin Date".       
"RTN","PSOTPHL1",16,0)
 ; If run is success, an audit node will be placed at File 59.7 as:
"RTN","PSOTPHL1",17,0)
 ;    ^PS(59.7,D0,46)=TransmissionStartDt_"^"_TransmissionEndDt_"^"_MshID_"^"_MshCnt_"^"_LineCnt
"RTN","PSOTPHL1",18,0)
 ;
"RTN","PSOTPHL1",19,0)
 ; At the end of each run, this program will send out mail to the mail
"RTN","PSOTPHL1",20,0)
 ;   group "PSO TPB HL7 EXTRACT" except the non-Sunday TaskMan check
"RTN","PSOTPHL1",21,0)
 ;
"RTN","PSOTPHL1",22,0)
 N A,B,C,CK,EDT,ERR,FRTIME,I,L,R,RDT,SDT,SET,X
"RTN","PSOTPHL1",23,0)
 N BCNT,DATA,DFN,EVENT,LN,MCNT,PGM,PS,PSO
"RTN","PSOTPHL1",24,0)
 N BBDT,BEDT,DADT,EXC,INS,PADT,PN,REASON,STA,WAITYP
"RTN","PSOTPHL1",25,0)
 ;
"RTN","PSOTPHL1",26,0)
START S CK=0 D DATE I CK=1 G ENDS
"RTN","PSOTPHL1",27,0)
 ;  
"RTN","PSOTPHL1",28,0)
 D EN^PSOTPHL1(RDT,EDT,.SDT)
"RTN","PSOTPHL1",29,0)
 Q
"RTN","PSOTPHL1",30,0)
 ;
"RTN","PSOTPHL1",31,0)
DATE ; Check if first time run or Sunday
"RTN","PSOTPHL1",32,0)
 S (EDT,FRTIME,PS,SET)=0,PS=59.7
"RTN","PSOTPHL1",33,0)
 S EDT=$$GET1^DIQ(PS,"1,46",46.2,"I"),EDT=+EDT
"RTN","PSOTPHL1",34,0)
 D NOW^%DTC
"RTN","PSOTPHL1",35,0)
 D DW^%DTC
"RTN","PSOTPHL1",36,0)
 I EDT'>0 S FRTIME=1 G GDATE
"RTN","PSOTPHL1",37,0)
 I X'["SUN" S CK=1 Q
"RTN","PSOTPHL1",38,0)
 ;
"RTN","PSOTPHL1",39,0)
 S SDT=EDT+1
"RTN","PSOTPHL1",40,0)
GDATE S RDT="",SET=1
"RTN","PSOTPHL1",41,0)
 S RDT=$S(EDT:EDT,1:0)
"RTN","PSOTPHL1",42,0)
 S EDT=DT-1
"RTN","PSOTPHL1",43,0)
 Q
"RTN","PSOTPHL1",44,0)
 ;
"RTN","PSOTPHL1",45,0)
INIT ; Variable Initialization
"RTN","PSOTPHL1",46,0)
 S (BCNT,LN,MCNT,CK)=0
"RTN","PSOTPHL1",47,0)
 S PGM="PSOTPHL1"
"RTN","PSOTPHL1",48,0)
 S PSO=52.91
"RTN","PSOTPHL1",49,0)
 D INHL7
"RTN","PSOTPHL1",50,0)
 ;
"RTN","PSOTPHL1",51,0)
 K ^TMP("HLS",$J),^TMP(PGM,$J,EDT)
"RTN","PSOTPHL1",52,0)
 ;
"RTN","PSOTPHL1",53,0)
 Q
"RTN","PSOTPHL1",54,0)
 ;
"RTN","PSOTPHL1",55,0)
INHL7 S EVENT="PSO TPB EV"
"RTN","PSOTPHL1",56,0)
 I '$D(U) S U="^"
"RTN","PSOTPHL1",57,0)
 D INIT^HLFNC2(EVENT,.HL)
"RTN","PSOTPHL1",58,0)
 I $G(HL) S ERR=$P(HL,"^",2),CK=1 Q
"RTN","PSOTPHL1",59,0)
 D CREATE^HLTF(.HLMID,.HLDA,.HLDT,.HLDT1)
"RTN","PSOTPHL1",60,0)
 D INHD
"RTN","PSOTPHL1",61,0)
 Q
"RTN","PSOTPHL1",62,0)
 ;
"RTN","PSOTPHL1",63,0)
INHD I '$D(DTIME) S DTIME=0
"RTN","PSOTPHL1",64,0)
 I '$D(HL("DTM")) S HL("DTM")=HLDT1
"RTN","PSOTPHL1",65,0)
 I '$D(HL("FS")) S HL("FS")="^"
"RTN","PSOTPHL1",66,0)
 I '$D(HL("ECH")) S HL("ECH")="~|\&"
"RTN","PSOTPHL1",67,0)
 I '$D(HL("ETN")) S HL("ETN")="S12"
"RTN","PSOTPHL1",68,0)
 I '$D(HL("MTN")) S HL("MTN")="SIU"
"RTN","PSOTPHL1",69,0)
 I '$D(HL("MTN_ETN")) S HL("MTN_ETN")="SIU_S12"
"RTN","PSOTPHL1",70,0)
 I '$D(HL("PID")) S HL("PID")="P"
"RTN","PSOTPHL1",71,0)
 I '$D(HL("Q")) S HL("Q")=""""
"RTN","PSOTPHL1",72,0)
 I '$D(HL("VER")) S HL("VER")="2.4"
"RTN","PSOTPHL1",73,0)
 I '$D(HL("CC")) S HL("CC")="US"
"RTN","PSOTPHL1",74,0)
 I '$D(HL("ACAT")) S HL("ACAT")="AL"
"RTN","PSOTPHL1",75,0)
 I '$D(HL("APAT")) S HL("APAT")="NE"
"RTN","PSOTPHL1",76,0)
 I '$D(HL("SAN")) S HL("SAN")="PSO TPB-PHARM"
"RTN","PSOTPHL1",77,0)
 I '$D(HL("RAN")) S HL("RAN")="PSO TPB-ACC"
"RTN","PSOTPHL1",78,0)
 ;
"RTN","PSOTPHL1",79,0)
 Q
"RTN","PSOTPHL1",80,0)
 ;
"RTN","PSOTPHL1",81,0)
BHS ; CREATE "BHS" SEGMENT
"RTN","PSOTPHL1",82,0)
 S BCNT=BCNT+1
"RTN","PSOTPHL1",83,0)
 S LN=LN+1
"RTN","PSOTPHL1",84,0)
 ;
"RTN","PSOTPHL1",85,0)
 Q
"RTN","PSOTPHL1",86,0)
 ;
"RTN","PSOTPHL1",87,0)
EN(RDT,EDT,SDT) ; ENTRY POINT FOR PROCESS
"RTN","PSOTPHL1",88,0)
 D INIT I CK=1 G OUT
"RTN","PSOTPHL1",89,0)
 D BHS
"RTN","PSOTPHL1",90,0)
 D PROCESS
"RTN","PSOTPHL1",91,0)
 D BTS
"RTN","PSOTPHL1",92,0)
 G OUT
"RTN","PSOTPHL1",93,0)
 ;
"RTN","PSOTPHL1",94,0)
PROCESS ; Sort and Process the message body
"RTN","PSOTPHL1",95,0)
 I '$D(SET) S SDT=RDT,RDT=RDT-1
"RTN","PSOTPHL1",96,0)
 I $G(FRTIME)=1 D FRTIME
"RTN","PSOTPHL1",97,0)
P10 S RDT=$O(^PS(PSO,"AX",RDT)) G P30:(RDT>EDT)!(RDT="")
"RTN","PSOTPHL1",98,0)
 I SDT>RDT S SDT=RDT
"RTN","PSOTPHL1",99,0)
 S DFN=""
"RTN","PSOTPHL1",100,0)
P20 S DFN=$O(^PS(PSO,"AX",RDT,DFN)) G P10:DFN=""
"RTN","PSOTPHL1",101,0)
 I '$D(^PS(PSO,DFN,0)) K ^PS(PSO,"AX",RDT,DFN) G P20
"RTN","PSOTPHL1",102,0)
 S ^TMP(PGM,$J,EDT,"ZZ",DFN)=RDT
"RTN","PSOTPHL1",103,0)
 G P20
"RTN","PSOTPHL1",104,0)
 ;
"RTN","PSOTPHL1",105,0)
FRTIME ; To generate a complete data set for the frist time 
"RTN","PSOTPHL1",106,0)
 S (DFN,RDT,X)=""
"RTN","PSOTPHL1",107,0)
 S SDT=999999999
"RTN","PSOTPHL1",108,0)
F10 S DFN=$O(^PS(PSO,DFN)) Q:(DFN'?1N.N)!(DFN="")
"RTN","PSOTPHL1",109,0)
 I '$D(^PS(PSO,DFN,0)) G F10
"RTN","PSOTPHL1",110,0)
 S X=$P(^PS(PSO,DFN,0),"^",2)
"RTN","PSOTPHL1",111,0)
 I SDT>X S SDT=X
"RTN","PSOTPHL1",112,0)
 S ^TMP(PGM,$J,EDT,"ZZ",DFN)=X
"RTN","PSOTPHL1",113,0)
 G F10
"RTN","PSOTPHL1",114,0)
 ;
"RTN","PSOTPHL1",115,0)
P30 I '$D(^TMP(PGM,$J,EDT,"ZZ")) D  G GEN
"RTN","PSOTPHL1",116,0)
 .  S MCNT=0
"RTN","PSOTPHL1",117,0)
 .  D MSH^HLFNC2(.HL,HLMID_"-"_MCNT,.X,"")
"RTN","PSOTPHL1",118,0)
 .  D WRITE
"RTN","PSOTPHL1",119,0)
 ;
"RTN","PSOTPHL1",120,0)
 S DFN=""
"RTN","PSOTPHL1",121,0)
DFN S DFN=$O(^TMP(PGM,$J,EDT,"ZZ",DFN)) G GEN:DFN=""
"RTN","PSOTPHL1",122,0)
 S RDT=^TMP(PGM,$J,EDT,"ZZ",DFN)
"RTN","PSOTPHL1",123,0)
 D EXTRACT
"RTN","PSOTPHL1",124,0)
 D MSH
"RTN","PSOTPHL1",125,0)
 D SCH
"RTN","PSOTPHL1",126,0)
 D PID
"RTN","PSOTPHL1",127,0)
 G DFN
"RTN","PSOTPHL1",128,0)
 ;
"RTN","PSOTPHL1",129,0)
GEN S HLP="" D GENERATE^HLMA(EVENT,"GB",1,.R,HLDA,.HLP)
"RTN","PSOTPHL1",130,0)
 Q
"RTN","PSOTPHL1",131,0)
 ;
"RTN","PSOTPHL1",132,0)
EXTRACT ; Extract data from File 52.91
"RTN","PSOTPHL1",133,0)
 S (A,B,BBDT,BEDT,C,DADT,DATA,EXC,INS,PADT,PN,REASON,STA,WAITYP,X)=""
"RTN","PSOTPHL1",134,0)
 S X=^PS(PSO,DFN,0)
"RTN","PSOTPHL1",135,0)
 S DATA="PN,BBDT,BEDT,REASON,DADT,WAITYP,STA,INS,EXC,PADT"
"RTN","PSOTPHL1",136,0)
 F I=1:1:10 S @$P(DATA,",",I)=$P(X,"^",I)
"RTN","PSOTPHL1",137,0)
 I $D(PADT) S PADT=$P(PADT,".")
"RTN","PSOTPHL1",138,0)
 I +BBDT=+RDT S HL("ETN")="S12"
"RTN","PSOTPHL1",139,0)
 E  S HL("ETN")="S14"
"RTN","PSOTPHL1",140,0)
 S HL("MTN_ETN")=HL("MTN")_"_"_HL("ETN")
"RTN","PSOTPHL1",141,0)
 S A="BBDT,BEDT,DADT,PADT"
"RTN","PSOTPHL1",142,0)
 F I=1:1:4 S B=$P(A,",",I) I $G(@B)>0 S C=$$HLDATE^HLFNC(@B,"DT"),@$P(A,",",I)=C
"RTN","PSOTPHL1",143,0)
 Q
"RTN","PSOTPHL1",144,0)
 ;
"RTN","PSOTPHL1",145,0)
MSH ; CREATE "MSH" SEGMENT
"RTN","PSOTPHL1",146,0)
 S MCNT=MCNT+1
"RTN","PSOTPHL1",147,0)
 D MSH^HLFNC2(.HL,HLMID_"-"_MCNT,.X,"")
"RTN","PSOTPHL1",148,0)
 ;
"RTN","PSOTPHL1",149,0)
 D WRITE
"RTN","PSOTPHL1",150,0)
 Q
"RTN","PSOTPHL1",151,0)
 ;
"RTN","PSOTPHL1",152,0)
SCH ; CREATE "SCH" SEGMENT
"RTN","PSOTPHL1",153,0)
 K SCH S (X,A,B,C)="",I=0 S:REASON>9 REASON=9
"RTN","PSOTPHL1",154,0)
 S X="Seen by VA Provider,No/Show/Cancellation,Patient Ended"
"RTN","PSOTPHL1",155,0)
 S X=X_",Non-Formulary Rx not accepted,Patient Expired,All Rx's Inactive"
"RTN","PSOTPHL1",156,0)
 S X=X_",Exclusion,Patient Refused Appointment,Patient Unreachable"
"RTN","PSOTPHL1",157,0)
 S A=$P(X,",",REASON)
"RTN","PSOTPHL1",158,0)
 ;
"RTN","PSOTPHL1",159,0)
 S X="" S:EXC>3 EXC=3
"RTN","PSOTPHL1",160,0)
 S X="Excluded due to active Rx#"
"RTN","PSOTPHL1",161,0)
 S X=X_",Excluded due to actual appt<30 days from desired appt date"
"RTN","PSOTPHL1",162,0)
 S X=X_",Exclued due to active Rx# and actual appt<30 days from desired appt date"
"RTN","PSOTPHL1",163,0)
 S B=$P(X,",",EXC)
"RTN","PSOTPHL1",164,0)
 ;
"RTN","PSOTPHL1",165,0)
 I WAITYP="E" S C="EWL"
"RTN","PSOTPHL1",166,0)
 E  I WAITYP="M" S C="Manual"
"RTN","PSOTPHL1",167,0)
 E  I WAITYP="S" S C="Schedule"
"RTN","PSOTPHL1",168,0)
 E  S C="S\T\E"
"RTN","PSOTPHL1",169,0)
 ;
"RTN","PSOTPHL1",170,0)
 S X=""
"RTN","PSOTPHL1",171,0)
 S X=HL("FS")_HL("FS")_HL("FS")_HL("FS")_HL("FS")_HL("FS")_REASON_"~"_A
"RTN","PSOTPHL1",172,0)
 S X=X_HL("FS")_EXC_"~"_B_HL("FS")_WAITYP_"~"_C
"RTN","PSOTPHL1",173,0)
 S X=X_HL("FS")_HL("FS")_HL("FS")
"RTN","PSOTPHL1",174,0)
 S I=I+1,SCH(I)="SCH"_X
"RTN","PSOTPHL1",175,0)
 ;
"RTN","PSOTPHL1",176,0)
 S X="",X=X_"~~~"_DADT_"~~~~Desired Appointment Date|~~~"
"RTN","PSOTPHL1",177,0)
 S X=X_PADT_"~~~~Primary Care Scheduled Appointment Date|~~~"
"RTN","PSOTPHL1",178,0)
 S X=X_BBDT_"~~~~Date Pharmacy Benefit Began|~~~"
"RTN","PSOTPHL1",179,0)
 S X=X_BEDT_"~~~~Inactivation of Benefit Date|~~~"
"RTN","PSOTPHL1",180,0)
 S X=X_$$HLDATE^HLFNC(RDT,"DT")_"~~~~Record Change Date"
"RTN","PSOTPHL1",181,0)
 I $L(SCH(I)_X)<246 S SCH(I)=SCH(I)_X
"RTN","PSOTPHL1",182,0)
 E  S I=I+1,SCH(I)=X
"RTN","PSOTPHL1",183,0)
 ;
"RTN","PSOTPHL1",184,0)
 S X="",$P(X,"^",12)=STA_"~~~"_INS_"&"_$$GET1^DIQ(4,INS_",0",.01)
"RTN","PSOTPHL1",185,0)
 I $L(SCH(I)_X)<246 S SCH(I)=SCH(I)_X
"RTN","PSOTPHL1",186,0)
 E  S I=I+1,SCH(I)=X
"RTN","PSOTPHL1",187,0)
 ;
"RTN","PSOTPHL1",188,0)
 F I=1:1 S X=$G(SCH(I)) Q:X=""  D
"RTN","PSOTPHL1",189,0)
 . I I=1 D WRITE
"RTN","PSOTPHL1",190,0)
 . E  D WRITEN
"RTN","PSOTPHL1",191,0)
 Q
"RTN","PSOTPHL1",192,0)
 ;
"RTN","PSOTPHL1",193,0)
PID ; CREATE "PID" SEGMENT
"RTN","PSOTPHL1",194,0)
 K PID
"RTN","PSOTPHL1",195,0)
 D DEM^VADPT,ADD^VADPT
"RTN","PSOTPHL1",196,0)
 D BLDPID^PSOTPHL2(DFN,1,.PID,.HL,.ERR)
"RTN","PSOTPHL1",197,0)
 Q:$G(PID(1))=""
"RTN","PSOTPHL1",198,0)
 S X=""
"RTN","PSOTPHL1",199,0)
 F I=1:1 S X=$G(PID(I)) Q:X=""  D
"RTN","PSOTPHL1",200,0)
 . I I=1 D WRITE
"RTN","PSOTPHL1",201,0)
 . E  D WRITEN
"RTN","PSOTPHL1",202,0)
 Q
"RTN","PSOTPHL1",203,0)
 ;
"RTN","PSOTPHL1",204,0)
BTS ; CREATE "BTS" SEGMENT
"RTN","PSOTPHL1",205,0)
 S LN=LN+1
"RTN","PSOTPHL1",206,0)
 Q
"RTN","PSOTPHL1",207,0)
 ;
"RTN","PSOTPHL1",208,0)
WRITE ; Write single line
"RTN","PSOTPHL1",209,0)
 S LN=LN+1
"RTN","PSOTPHL1",210,0)
 S ^TMP("HLS",$J,LN)=X
"RTN","PSOTPHL1",211,0)
 Q
"RTN","PSOTPHL1",212,0)
 ;
"RTN","PSOTPHL1",213,0)
WRITEN ; Write multiple lines
"RTN","PSOTPHL1",214,0)
 S ^TMP("HLS",$J,LN,I-1)=X
"RTN","PSOTPHL1",215,0)
 Q
"RTN","PSOTPHL1",216,0)
 ;
"RTN","PSOTPHL1",217,0)
CLEANUP ; Clean up variables
"RTN","PSOTPHL1",218,0)
 K A,B,C,CK,EDT,ERR,I,L,R,RDT,SDT,X
"RTN","PSOTPHL1",219,0)
 K BCNT,DATA,DFN,EVENT,LN,MCNT,PGM,PS,PSO
"RTN","PSOTPHL1",220,0)
 K BBDT,BEDT,DADT,EXC,INS,PADT,PN,REASON,STA,WAITYP
"RTN","PSOTPHL1",221,0)
 Q
"RTN","PSOTPHL1",222,0)
 ;
"RTN","PSOTPHL1",223,0)
OUT ; End of compilation
"RTN","PSOTPHL1",224,0)
 I CK=1 G END
"RTN","PSOTPHL1",225,0)
 K ^TMP("HLS",$J),^TMP(PGM,$J,EDT),PID,SCH
"RTN","PSOTPHL1",226,0)
 I SDT>EDT S SDT=EDT
"RTN","PSOTPHL1",227,0)
 I $G(SET)=1 S ^PS(PS,1,46)=SDT_"^"_EDT_"^"_HLDA_"^"_MCNT_"^"_LN
"RTN","PSOTPHL1",228,0)
 ;
"RTN","PSOTPHL1",229,0)
END D MAIL
"RTN","PSOTPHL1",230,0)
 I $G(SET)'=1 D CLEANUP
"RTN","PSOTPHL1",231,0)
ENDS I $G(FRTIME)=1 D RESET
"RTN","PSOTPHL1",232,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTPHL1",233,0)
 Q
"RTN","PSOTPHL1",234,0)
 ;
"RTN","PSOTPHL1",235,0)
RESET ; Reset to run tomorrow
"RTN","PSOTPHL1",236,0)
 D RESCH^XUTMOPT("PSO TPB HL7 EXTRACT","T+1@18:00","","24H","L")
"RTN","PSOTPHL1",237,0)
 Q
"RTN","PSOTPHL1",238,0)
 ;
"RTN","PSOTPHL1",239,0)
RESET1 ; Reset to run tomorrow
"RTN","PSOTPHL1",240,0)
 D RESET,EDIT^XUTMOPT("PSO TPB HL7 EXTRACT")
"RTN","PSOTPHL1",241,0)
 Q
"RTN","PSOTPHL1",242,0)
 ;
"RTN","PSOTPHL1",243,0)
MAIL ;Send mail message
"RTN","PSOTPHL1",244,0)
 I '$G(DUZ) Q
"RTN","PSOTPHL1",245,0)
 K PSOTTEXT,XMY S (XMDUZ,XMSUB,XMTEST,A,B,C,I,L,R,X)=""
"RTN","PSOTPHL1",246,0)
 S C="G.PSO TPB HL7 EXTRACT"
"RTN","PSOTPHL1",247,0)
 S XMY(C)=""
"RTN","PSOTPHL1",248,0)
 S PSOTTEXT(1)="SENT TO: "_C
"RTN","PSOTPHL1",249,0)
 S XMDUZ="PSO TPB HL7 EXTRACT"
"RTN","PSOTPHL1",250,0)
 S (A,B)=""
"RTN","PSOTPHL1",251,0)
 I '$D(SET) S A="Ad-Hoc"
"RTN","PSOTPHL1",252,0)
 E  S A=$S(($G(FRTIME)=1):"first-time",1:"weekly")
"RTN","PSOTPHL1",253,0)
 S B=$S(($G(CK)=1):"unsuccessful",1:"successful")
"RTN","PSOTPHL1",254,0)
 S XMSUB="PSO TPB HL7 "_A_" update ** "_B_" **"
"RTN","PSOTPHL1",255,0)
 S A=XMSUB
"RTN","PSOTPHL1",256,0)
 I $G(CK)=1 D FAIL
"RTN","PSOTPHL1",257,0)
 E  D SUCC
"RTN","PSOTPHL1",258,0)
 S PSOTTEXT(2)=" "
"RTN","PSOTPHL1",259,0)
 S PSOTTEXT(3)="The weekly generation of the HL7 Message of"
"RTN","PSOTPHL1",260,0)
 S PSOTTEXT(3.2)="TPB Patient Information was "_B
"RTN","PSOTPHL1",261,0)
 S PSOTTEXT(4)=""
"RTN","PSOTPHL1",262,0)
 S PSOTTEXT(5)=I
"RTN","PSOTPHL1",263,0)
 S PSOTTEXT(6)=L
"RTN","PSOTPHL1",264,0)
 S PSOTTEXT(6.2)=R
"RTN","PSOTPHL1",265,0)
 S PSOTTEXT(6.4)=X
"RTN","PSOTPHL1",266,0)
 S PSOTTEXT(7)=" "
"RTN","PSOTPHL1",267,0)
 D NOW^%DTC S Y=% X ^DD("DD") S PSOTTEXT(8)="The job ended at "_$G(Y)
"RTN","PSOTPHL1",268,0)
 S PSOTTEXT(9)=" "
"RTN","PSOTPHL1",269,0)
 S XMTEXT="PSOTTEXT(" N DIFROM D ^XMD
"RTN","PSOTPHL1",270,0)
 I $D(XMMG),(XMMG["Error =") D
"RTN","PSOTPHL1",271,0)
 .  K XMY(C)
"RTN","PSOTPHL1",272,0)
 .  S XMSUB=A,XMY(DUZ)="",PSOTTEXT(1)=PSOTTEXT(1)_"   ("_XMMG_")",XMMG=""
"RTN","PSOTPHL1",273,0)
 .  S XMTEXT="PSOTTEXT(" D ^XMD
"RTN","PSOTPHL1",274,0)
 K PSOTTEXT,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","PSOTPHL1",275,0)
 Q
"RTN","PSOTPHL1",276,0)
FAIL ; Msg for unsuccessful run
"RTN","PSOTPHL1",277,0)
 S I="Reason: "_$S(($D(ERR)):ERR,1:"Check Event Server Protocol OR the run date")
"RTN","PSOTPHL1",278,0)
 S L=" "
"RTN","PSOTPHL1",279,0)
 S R="Please contact National Help Desk @888-596-4357"
"RTN","PSOTPHL1",280,0)
 S X=" "
"RTN","PSOTPHL1",281,0)
 Q
"RTN","PSOTPHL1",282,0)
 ;
"RTN","PSOTPHL1",283,0)
SUCC ; Msg for successful run
"RTN","PSOTPHL1",284,0)
 S I="Please check the PSOTPBAAC HL7 Logical Link to ensure"
"RTN","PSOTPHL1",285,0)
 S L="successful transmission to the Austin Automation Center."
"RTN","PSOTPHL1",286,0)
 S R=" "
"RTN","PSOTPHL1",287,0)
 S X="MSH-ID: "_HLDA
"RTN","PSOTPHL1",288,0)
 Q
"RTN","PSOTPHL1",289,0)
 ;
"RTN","PSOTPPRV")
0^6^B7105822
"RTN","PSOTPPRV",1,0)
PSOTPPRV ;BIR/MHA-TPB NON-VA provider selection ;08/21/03
"RTN","PSOTPPRV",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,153**;DEC 1997
"RTN","PSOTPPRV",3,0)
ST K DA,DIC,DIE,X,Y,XLFNC
"RTN","PSOTPPRV",4,0)
 W !!,"Select Provider: " R X:$S($D(DTIME):DTIME,1:300) I '$T G KV
"RTN","PSOTPPRV",5,0)
 G:X=""!(X["^")!($D(DTOUT)) KV
"RTN","PSOTPPRV",6,0)
 I X?1."?" D  G ST
"RTN","PSOTPPRV",7,0)
 .W !!,"Answer with NEW PERSON NAME, or INITIAL, or SSN, or DEA#, or VA#"
"RTN","PSOTPPRV",8,0)
 S (DIE,DIC)=200,DIC(0)="EMQZ"
"RTN","PSOTPPRV",9,0)
 ;S DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSOTPPRV",10,0)
 D ^DIC G:$D(DUOUT)!($D(DTOUT)) ST N CNT S CNT=0
"RTN","PSOTPPRV",11,0)
 I +Y>0,'$P($G(^VA(200,+Y,"PS")),"^"),$P($G(^VA(200,+Y,"PS")),"^",4),$P(^("PS"),"^",4)'>DT D  G ST
"RTN","PSOTPPRV",12,0)
 .W !!,"This Provider is not Authorized to Write Med Orders and flagged as Inactive."
"RTN","PSOTPPRV",13,0)
 .W !,"Use the Edit Provider [PSO PROVIDER EDIT] option to change them."
"RTN","PSOTPPRV",14,0)
 I +Y>0,'$P($G(^VA(200,+Y,"PS")),"^") D  G ST
"RTN","PSOTPPRV",15,0)
 .W !!,"This Provider is not Authorized to Write Med Orders. Use the Edit Provider"
"RTN","PSOTPPRV",16,0)
 .W !,"[PSO PROVIDER EDIT] option to change the Authorization flag."
"RTN","PSOTPPRV",17,0)
 I +Y>0 I $P($G(^VA(200,+Y,"PS")),"^",4),$P(^("PS"),"^",4)'>DT D  G ST
"RTN","PSOTPPRV",18,0)
 .W !!,"This Provider is flagged as Inactive. Use the Edit Provider"
"RTN","PSOTPPRV",19,0)
 .W !,"[PSO PROVIDER EDIT] option to change the Inactive Date."
"RTN","PSOTPPRV",20,0)
 I +Y>0 D  G:CNT STC
"RTN","PSOTPPRV",21,0)
 .I $D(^VA(200,+Y,"PS")),$P(^("PS"),"^"),$S('$P(^("PS"),"^",4):1,1:$P(^("PS"),"^",4)'<DT) Q
"RTN","PSOTPPRV",22,0)
 .S CNT=1
"RTN","PSOTPPRV",23,0)
 I +Y>0 D  I 'CNT S DA=+Y G GD
"RTN","PSOTPPRV",24,0)
 .I $P($G(^VA(200,+Y,"TPB")),"^"),$P(^("TPB"),"^",5)=0 Q
"RTN","PSOTPPRV",25,0)
 .S CNT=1
"RTN","PSOTPPRV",26,0)
STC I CNT K CNT S DA=+Y D  G:$D(DIRUT)!('Y) ST G:Y EDT
"RTN","PSOTPPRV",27,0)
 .W !,"Please identify Provider as a NON-VA PRESCRIBER in the Provider File.",!
"RTN","PSOTPPRV",28,0)
 .D KV S DIR("A")="Do you want to edit Provider:",DIR("B")="Y",DIR(0)="YN" D ^DIR
"RTN","PSOTPPRV",29,0)
 I Y<0 D  G:'$D(X) ST G:$D(DIRUT)!('Y) ST G:Y ADD
"RTN","PSOTPPRV",30,0)
 .I X[""""!($A(X)=45)!($L(X,",")'=2)!(X'?1.E1","1.E) K X Q
"RTN","PSOTPPRV",31,0)
 .S XLFNC=X D STDNAME^XLFNAME(.XLFNC,"C")
"RTN","PSOTPPRV",32,0)
 .S X=XLFNC I $L(X)>35!($L(X)<3) K X Q
"RTN","PSOTPPRV",33,0)
 .W !!,"Provider not found in Provider File"
"RTN","PSOTPPRV",34,0)
 .D KV S DIR("A")="Do you want to enter a new Provider:",DIR("B")="Y",DIR(0)="YN" D ^DIR
"RTN","PSOTPPRV",35,0)
 Q
"RTN","PSOTPPRV",36,0)
EDT D ASK1^PSOPRVW G GD
"RTN","PSOTPPRV",37,0)
ADD D ADD^PSOPRVW
"RTN","PSOTPPRV",38,0)
GD G:'$D(DA) ST
"RTN","PSOTPPRV",39,0)
 I $D(^VA(200,DA,"PS")),$P(^("PS"),"^"),$S('$P(^("PS"),"^",4):1,1:$P(^("PS"),"^",4)'<DT) G STQ
"RTN","PSOTPPRV",40,0)
 G ST
"RTN","PSOTPPRV",41,0)
STQ I $P($G(^VA(200,+DA,"TPB")),"^"),$P(^("TPB"),"^",5)=0 G KV
"RTN","PSOTPPRV",42,0)
 G ST
"RTN","PSOTPPRV",43,0)
KV K DIR,DIRUT,DTOUT,DUOUT,D,X,Y
"RTN","PSOTPPRV",44,0)
 Q
"VER")
8.0^22.0
"^DD",52.91,52.91,3,0)
INACTIVATION REASON CODE^*S^1:SEEN BY VA PROVIDER;2:NO/SHOW/CANCELLATION;3:PATIENT ENDED;4:NON-FORMULARY RX NOT ACCEPTED;5:PATIENT EXPIRED;6:ALL RX'S INACTIVE;7:EXCLUSION;8:PATIENT REFUSED APPT;9:PATIENT UNREACHABLE;^0;4^Q
"^DD",52.91,52.91,3,12)
Only these codes are allowed for manual entry.
"^DD",52.91,52.91,3,12.1)
S DIC("S")="I Y'=7"
"^DD",52.91,52.91,3,21,0)
^.001^4^4^3030919^^
"^DD",52.91,52.91,3,21,1,0)
This field contains a code representing the reason for inactivating a
"^DD",52.91,52.91,3,21,2,0)
patient for this benefit. EXCLUSION code 7, is hidden and not user 
"^DD",52.91,52.91,3,21,3,0)
selectable. It is used by the post-install routine during initial
"^DD",52.91,52.91,3,21,4,0)
extraction.
"^DD",52.91,52.91,3,"DT")
3030919
**END**
**END**
