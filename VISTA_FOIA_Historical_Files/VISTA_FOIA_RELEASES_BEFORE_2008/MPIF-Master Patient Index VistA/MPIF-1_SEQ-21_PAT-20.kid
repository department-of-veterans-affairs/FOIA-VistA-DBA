Released MPIF*1*20 SEQ #21
Extracted from mail message
**KIDS**:MPIF*1.0*20^

**INSTALL NAME**
MPIF*1.0*20
"BLD",1341,0)
MPIF*1.0*20^MASTER PATIENT INDEX VISTA^0^3020712^y
"BLD",1341,1,0)
^^3^3^3020712^
"BLD",1341,1,1,0)
Remote Procedures
"BLD",1341,1,2,0)
Refer to patch MPIF*1.0*20 in the FORUM Patch Module for a complete 
"BLD",1341,1,3,0)
description.
"BLD",1341,4,0)
^9.64PA^^
"BLD",1341,"ABNS",0)
^9.66A^^
"BLD",1341,"ABPKG")
n^n^
"BLD",1341,"KRN",0)
^9.67PA^19^17
"BLD",1341,"KRN",.4,0)
.4
"BLD",1341,"KRN",.401,0)
.401
"BLD",1341,"KRN",.402,0)
.402
"BLD",1341,"KRN",.403,0)
.403
"BLD",1341,"KRN",.5,0)
.5
"BLD",1341,"KRN",.84,0)
.84
"BLD",1341,"KRN",3.6,0)
3.6
"BLD",1341,"KRN",3.8,0)
3.8
"BLD",1341,"KRN",9.2,0)
9.2
"BLD",1341,"KRN",9.8,0)
9.8
"BLD",1341,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",1341,"KRN",9.8,"NM",1,0)
MPIFDUPS^^0^B2061208
"BLD",1341,"KRN",9.8,"NM",2,0)
MPIFRPC^^0^B35812148
"BLD",1341,"KRN",9.8,"NM",3,0)
MPIFEXT^^0^B46733837
"BLD",1341,"KRN",9.8,"NM",4,0)
MPIF002^^0^B6101579
"BLD",1341,"KRN",9.8,"NM",5,0)
MPIFEXT2^^0^B36299229
"BLD",1341,"KRN",9.8,"NM",6,0)
MPIFEXT3^^0^B22621526
"BLD",1341,"KRN",9.8,"NM",7,0)
MPIFRPC2^^0^B12614271
"BLD",1341,"KRN",9.8,"NM",8,0)
MPIFQ0^^0^B74643511
"BLD",1341,"KRN",9.8,"NM","B","MPIF002",4)

"BLD",1341,"KRN",9.8,"NM","B","MPIFDUPS",1)

"BLD",1341,"KRN",9.8,"NM","B","MPIFEXT",3)

"BLD",1341,"KRN",9.8,"NM","B","MPIFEXT2",5)

"BLD",1341,"KRN",9.8,"NM","B","MPIFEXT3",6)

"BLD",1341,"KRN",9.8,"NM","B","MPIFQ0",8)

"BLD",1341,"KRN",9.8,"NM","B","MPIFRPC",2)

"BLD",1341,"KRN",9.8,"NM","B","MPIFRPC2",7)

"BLD",1341,"KRN",19,0)
19
"BLD",1341,"KRN",19,"NM",0)
^9.68A^^
"BLD",1341,"KRN",19.1,0)
19.1
"BLD",1341,"KRN",101,0)
101
"BLD",1341,"KRN",409.61,0)
409.61
"BLD",1341,"KRN",771,0)
771
"BLD",1341,"KRN",870,0)
870
"BLD",1341,"KRN",8994,0)
8994
"BLD",1341,"KRN",8994,"NM",0)
^9.68A^8^7
"BLD",1341,"KRN",8994,"NM",1,0)
MPIF SSN DUPS^^0
"BLD",1341,"KRN",8994,"NM",2,0)
MPIF ICN STATS^^0
"BLD",1341,"KRN",8994,"NM",3,0)
MPIF INACTIVATE^^0
"BLD",1341,"KRN",8994,"NM",4,0)
MPIF CHANGE CMOR^^0
"BLD",1341,"KRN",8994,"NM",5,0)
MPIF EXT PDAT REMOTE^^0
"BLD",1341,"KRN",8994,"NM",7,0)
MPIF REMOTE SPI^^0
"BLD",1341,"KRN",8994,"NM",8,0)
MPIF REMOTE ICN UPDATE^^0
"BLD",1341,"KRN",8994,"NM","B","MPIF CHANGE CMOR",4)

"BLD",1341,"KRN",8994,"NM","B","MPIF EXT PDAT REMOTE",5)

"BLD",1341,"KRN",8994,"NM","B","MPIF ICN STATS",2)

"BLD",1341,"KRN",8994,"NM","B","MPIF INACTIVATE",3)

"BLD",1341,"KRN",8994,"NM","B","MPIF REMOTE ICN UPDATE",8)

"BLD",1341,"KRN",8994,"NM","B","MPIF REMOTE SPI",7)

"BLD",1341,"KRN",8994,"NM","B","MPIF SSN DUPS",1)

"BLD",1341,"KRN","B",.4,.4)

"BLD",1341,"KRN","B",.401,.401)

"BLD",1341,"KRN","B",.402,.402)

"BLD",1341,"KRN","B",.403,.403)

"BLD",1341,"KRN","B",.5,.5)

"BLD",1341,"KRN","B",.84,.84)

"BLD",1341,"KRN","B",3.6,3.6)

"BLD",1341,"KRN","B",3.8,3.8)

"BLD",1341,"KRN","B",9.2,9.2)

"BLD",1341,"KRN","B",9.8,9.8)

"BLD",1341,"KRN","B",19,19)

"BLD",1341,"KRN","B",19.1,19.1)

"BLD",1341,"KRN","B",101,101)

"BLD",1341,"KRN","B",409.61,409.61)

"BLD",1341,"KRN","B",771,771)

"BLD",1341,"KRN","B",870,870)

"BLD",1341,"KRN","B",8994,8994)

"BLD",1341,"QUES",0)
^9.62^^
"BLD",1341,"REQB",0)
^9.611^1^1
"BLD",1341,"REQB",1,0)
MPIF*1.0*21^1
"BLD",1341,"REQB","B","MPIF*1.0*21",1)

"KRN",8994,135,-1)
0^4
"KRN",8994,135,0)
MPIF CHANGE CMOR^RCCMOR^MPIFRPC^1^S^^^^1
"KRN",8994,135,1,0)
^^3^3^3020417^
"KRN",8994,135,1,1,0)
This remote procedure call (RPC) allows the changing/updating of the 
"KRN",8994,135,1,2,0)
COORDINATING MASTER OF RECORD (#991.03) field in the PATIENT (#2) file 
"KRN",8994,135,1,3,0)
for a specific patient. An A08 Update message can also be triggered.
"KRN",8994,135,2,0)
^8994.02A^5^4
"KRN",8994,135,2,2,0)
ICN^1^10^1^2
"KRN",8994,135,2,2,1,0)
^8994.021^1^1^3011105^^
"KRN",8994,135,2,2,1,1,0)
ICN - not including the checksum
"KRN",8994,135,2,3,0)
CMOR^1^3^1^3
"KRN",8994,135,2,3,1,0)
^8994.021^1^1^3011105^^^
"KRN",8994,135,2,3,1,1,0)
The station number of the site that is to become the CMOR
"KRN",8994,135,2,4,0)
SSN^1^9^0^4
"KRN",8994,135,2,4,1,0)
^8994.021^3^3^3020312^^^^
"KRN",8994,135,2,4,1,1,0)
Social Security Number for the patient that is to be changed.  SSN will
"KRN",8994,135,2,4,1,2,0)
only be used if ICN is not found to check if the problem is with the AICN
"KRN",8994,135,2,4,1,3,0)
x-ref on the ICN field.
"KRN",8994,135,2,5,0)
A08^1^1^0^5
"KRN",8994,135,2,5,1,0)
^^2^2^3020312^
"KRN",8994,135,2,5,1,1,0)
This field will serve as a flag to note whether or not an A08 update 
"KRN",8994,135,2,5,1,2,0)
message should be triggered.
"KRN",8994,135,2,"B","A08",5)

"KRN",8994,135,2,"B","CMOR",3)

"KRN",8994,135,2,"B","ICN",2)

"KRN",8994,135,2,"B","SSN",4)

"KRN",8994,135,2,"PARAMSEQ",2,2)

"KRN",8994,135,2,"PARAMSEQ",3,3)

"KRN",8994,135,2,"PARAMSEQ",4,4)

"KRN",8994,135,2,"PARAMSEQ",5,5)

"KRN",8994,135,3,0)
^8994.03^2^2^3020312^^^^
"KRN",8994,135,3,1,0)
1 if successfully change the CMOR
"KRN",8994,135,3,2,0)
-1^error message if unable to make the change
"KRN",8994,141,-1)
0^1
"KRN",8994,141,0)
MPIF SSN DUPS^TOSITE^MPIFDUPS^1^S^^^^1
"KRN",8994,141,1,0)
^8994.01^2^2^3010928^^
"KRN",8994,141,1,1,0)
This RPC will be used by the data management teams' stat report to search
"KRN",8994,141,1,2,0)
for multiple SSNs with differnt ICNs from the same site.
"KRN",8994,141,2,0)
^8994.02A^2^1
"KRN",8994,141,2,2,0)
ARRAY^2^100^1^2
"KRN",8994,141,2,"B","ARRAY",2)

"KRN",8994,141,2,"PARAMSEQ",2,2)

"KRN",8994,142,-1)
0^2
"KRN",8994,142,0)
MPIF ICN STATS^ICNSTAT^MPIFRPC^2^P^^^^1
"KRN",8994,142,1,0)
^8994.01^2^2^3011015^^^^
"KRN",8994,142,1,1,0)
RPC to return ICN, Exceptions pending, CMOR, CMOR History, ICN History 
"KRN",8994,142,1,2,0)
for any given ICN
"KRN",8994,142,2,0)
^8994.02A^2^2
"KRN",8994,142,2,1,0)
ICN^1^16^0^2
"KRN",8994,142,2,2,0)
SSN^1^9^0^3
"KRN",8994,142,2,"B","ICN",1)

"KRN",8994,142,2,"B","SSN",2)

"KRN",8994,142,2,"PARAMSEQ",2,1)

"KRN",8994,142,2,"PARAMSEQ",3,2)

"KRN",8994,142,3,0)
^8994.03^9^9^3011015^^^
"KRN",8994,142,3,1,0)
Array returned:
"KRN",8994,142,3,2,0)
 
"KRN",8994,142,3,3,0)
RETURN("ICN") = current ICN value
"KRN",8994,142,3,4,0)
RETURN("CMOR") = current CMOR - station number
"KRN",8994,142,3,5,0)
RETURN("ICN HISTORY") = list of ICNs seperated by ^ - contents of ICN 
"KRN",8994,142,3,6,0)
history multiple
"KRN",8994,142,3,7,0)
RETURN("CMOR HISTORY") = list of CMORs seperated by ^ - contents of CMOR 
"KRN",8994,142,3,8,0)
history multiple
"KRN",8994,142,3,9,0)
RETURN("EXCEPTIONS PENDING") = 
"KRN",8994,143,-1)
0^5
"KRN",8994,143,0)
MPIF EXT PDAT REMOTE^PATINFO^MPIFEXT2^2^S^^^^1
"KRN",8994,143,1,0)
^8994.01^1^1^3011116^^^^
"KRN",8994,143,1,1,0)
Extended PDAT call remote.  ICN or SSN can be passed.
"KRN",8994,143,2,0)
^8994.02A^7^4
"KRN",8994,143,2,1,0)
ICN^1^16^0^2
"KRN",8994,143,2,1,1,0)
^^1^1^3011105^
"KRN",8994,143,2,1,1,1,0)
ICN for patient requesting data on.
"KRN",8994,143,2,2,0)
SSN^1^9^0^3
"KRN",8994,143,2,2,1,0)
^^1^1^3011105^
"KRN",8994,143,2,2,1,1,0)
SSN for patient data to be returned on.
"KRN",8994,143,2,6,0)
RPC^1^1^0^4
"KRN",8994,143,2,7,0)
EXIST^1^1^0^5
"KRN",8994,143,2,7,1,0)
^^4^4^3011116^
"KRN",8994,143,2,7,1,1,0)
If there is no value or 0 is passed, then a new request for data should 
"KRN",8994,143,2,7,1,2,0)
be made.  If there is a 1 passed, then if there is an existing request in 
"KRN",8994,143,2,7,1,3,0)
the ^XTMP("MPIF EXT PDAT",ICN/SSN,SITE) global, then that request should 
"KRN",8994,143,2,7,1,4,0)
be used to return the data -- request had already been made.
"KRN",8994,143,2,"B","EXIST",7)

"KRN",8994,143,2,"B","ICN",1)

"KRN",8994,143,2,"B","RPC",6)

"KRN",8994,143,2,"B","SSN",2)

"KRN",8994,143,2,"PARAMSEQ",2,1)

"KRN",8994,143,2,"PARAMSEQ",3,2)

"KRN",8994,143,2,"PARAMSEQ",4,6)

"KRN",8994,143,2,"PARAMSEQ",5,7)

"KRN",8994,144,-1)
0^3
"KRN",8994,144,0)
MPIF INACTIVATE^INACT^MPIFRPC^1^^^^^1
"KRN",8994,144,1,0)
^^2^2^3020417^
"KRN",8994,144,1,1,0)
This remote procedure call (RPC) allows the remote inactivation of a 
"KRN",8994,144,1,2,0)
patient from the MPI at a specific site.
"KRN",8994,144,2,0)
^8994.02A^1^1
"KRN",8994,144,2,1,0)
ICN^1^16^1^2
"KRN",8994,144,2,1,1,0)
^^1^1^3011015^
"KRN",8994,144,2,1,1,1,0)
ICN to be inactivated
"KRN",8994,144,2,"B","ICN",1)

"KRN",8994,144,2,"PARAMSEQ",2,1)

"KRN",8994,144,3,0)
^^2^2^3011015^
"KRN",8994,144,3,1,0)
0 for successful inactivation
"KRN",8994,144,3,2,0)
-1^error messaage in not successful
"KRN",8994,145,-1)
0^7
"KRN",8994,145,0)
MPIF REMOTE SPI^SPI^MPIFRPC2^2^^^^^1
"KRN",8994,145,1,0)
^8994.01^3^3^3020523^^
"KRN",8994,145,1,1,0)
This remote procedure call (RPC) allows the remote sending of a specific 
"KRN",8994,145,1,2,0)
patient at a specific site to the MPI for ICN assignment.  The patient is 
"KRN",8994,145,1,3,0)
found based upon social security number.
"KRN",8994,145,2,0)
^8994.02A^2^2
"KRN",8994,145,2,1,0)
SSN^1^9^1^2
"KRN",8994,145,2,1,1,0)
^^2^2^3011024^
"KRN",8994,145,2,1,1,1,0)
SSN for the patient that is to be sent to the MPI for ICN assignment.  
"KRN",8994,145,2,1,1,2,0)
Should there be more than one entry with that SSN, all will be sent.
"KRN",8994,145,2,2,0)
DFN^1^20^1^3
"KRN",8994,145,2,2,1,0)
^8994.021^1^1^3020523^^
"KRN",8994,145,2,2,1,1,0)
DFN for patient to be SPI'd.  DFN or SSN should be used to find patient.
"KRN",8994,145,2,"B","DFN",2)

"KRN",8994,145,2,"B","SSN",1)

"KRN",8994,145,2,"PARAMSEQ",2,1)

"KRN",8994,145,2,"PARAMSEQ",3,2)

"KRN",8994,145,3,0)
^8994.03^3^3^3020523^^^
"KRN",8994,145,3,1,0)
Result of SSN being sent to MPI.  If ICN found/created on the MPI that 
"KRN",8994,145,3,2,0)
will be return.  An error message will be returned if there was a problem 
"KRN",8994,145,3,3,0)
or a local ICN assigned.
"KRN",8994,147,-1)
0^8
"KRN",8994,147,0)
MPIF REMOTE ICN UPDATE^UPDATE^MPIFRPC2^1^^^^^1
"KRN",8994,147,1,0)
^^5^5^3020417^
"KRN",8994,147,1,1,0)
This remote procedure call (RPC) allows the remote update of the 
"KRN",8994,147,1,2,0)
INTEGRATION CONTROL NUMBER (#991.01), ICN CHECKSUM (#991.02), and 
"KRN",8994,147,1,3,0)
COORDINATING MASTER OF RECORD (#991.03) fields in the PATIENT (#2) file 
"KRN",8994,147,1,4,0)
at a specified site. The patient is found based upon social security 
"KRN",8994,147,1,5,0)
number.
"KRN",8994,147,2,0)
^8994.02A^5^5
"KRN",8994,147,2,1,0)
SSN^1^9^1^2
"KRN",8994,147,2,1,1,0)
^8994.021^1^1^3011130^^^
"KRN",8994,147,2,1,1,1,0)
Social Security Number of the patient to be updated.
"KRN",8994,147,2,2,0)
ICN^1^16^1^3
"KRN",8994,147,2,2,1,0)
^^1^1^3011130^
"KRN",8994,147,2,2,1,1,0)
ICN - without the checksum to be updated in field 991.01
"KRN",8994,147,2,3,0)
CHECK^1^6^1^4
"KRN",8994,147,2,3,1,0)
^^1^1^3011130^
"KRN",8994,147,2,3,1,1,0)
 CHECKSUM for the patient to be stored in field 991.02
"KRN",8994,147,2,4,0)
CMOR^1^3^1^5
"KRN",8994,147,2,4,1,0)
^8994.021^1^1^3011130^^
"KRN",8994,147,2,4,1,1,0)
 Station Number to be stored as the CMOR in field 991.03.
"KRN",8994,147,2,5,0)
A08^1^1^0^6
"KRN",8994,147,2,5,1,0)
^^1^1^3011130^
"KRN",8994,147,2,5,1,1,0)
If an A08 message needs to be sent this flag should be set to 1.
"KRN",8994,147,2,"B","A08",5)

"KRN",8994,147,2,"B","CHECK",3)

"KRN",8994,147,2,"B","CMOR",4)

"KRN",8994,147,2,"B","ICN",2)

"KRN",8994,147,2,"B","SSN",1)

"KRN",8994,147,2,"PARAMSEQ",2,1)

"KRN",8994,147,2,"PARAMSEQ",3,2)

"KRN",8994,147,2,"PARAMSEQ",4,3)

"KRN",8994,147,2,"PARAMSEQ",5,4)

"KRN",8994,147,2,"PARAMSEQ",6,5)

"KRN",8994,147,3,0)
^^2^2^3011130^
"KRN",8994,147,3,1,0)
 1 for successful update
"KRN",8994,147,3,2,0)
 -1^error message if not successfully updated.
"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
20^3020712^12564
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3020712
"PKG",282,22,1,"PAH",1,1,1,0)
Remote Procedures
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*20 in the FORUM Patch Module for a complete 
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","MPIF002")
0^4^B6101579
"RTN","MPIF002",1,0)
MPIF002 ;CIOFOSF/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF002",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIF002",3,0)
 ;
"RTN","MPIF002",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIF002",5,0)
 ;  ^DPT( - #2070
"RTN","MPIF002",6,0)
 ;
"RTN","MPIF002",7,0)
GETICNH(DFN,ICNHA) ;
"RTN","MPIF002",8,0)
 ;Return all ICNs in ICN History for patient DFN
"RTN","MPIF002",9,0)
 ; DFN = IEN of patient in the Patient (#2) file
"RTN","MPIF002",10,0)
 ; ICNHA - array where ICN History will be returned.
"RTN","MPIF002",11,0)
 ;
"RTN","MPIF002",12,0)
 N IEN,ICN,CNT,RET
"RTN","MPIF002",13,0)
 I '$D(^DPT(DFN)) S ICNHA="-1^NO SUCH DFN" Q
"RTN","MPIF002",14,0)
 I '$D(^DPT(DFN,"MPIFHIS")) S ICNHA="-1^NO ICN HISTORY" Q
"RTN","MPIF002",15,0)
 S (IEN,CNT)=0,RET=""
"RTN","MPIF002",16,0)
 F  S IEN=$O(^DPT(DFN,"MPIFHIS",IEN)) Q:IEN=""  D
"RTN","MPIF002",17,0)
 .S ICN=$P($G(^DPT(DFN,"MPIFHIS",IEN,0)),"^")
"RTN","MPIF002",18,0)
 .I ICN'="" S CNT=CNT+1,ICNHA(CNT)=""""_ICN_""""
"RTN","MPIF002",19,0)
 I CNT=0 S ICNHA="-1^NO ICN HISTORY" Q
"RTN","MPIF002",20,0)
 S ICNHA=CNT
"RTN","MPIF002",21,0)
 Q
"RTN","MPIF002",22,0)
 ;
"RTN","MPIF002",23,0)
GETCMORH(DFN,CMORHA) ;
"RTN","MPIF002",24,0)
 ;Return all CMORs in CMOR History for patient DFN
"RTN","MPIF002",25,0)
 ; DFN = IEN of patient in the Patient (#2) file
"RTN","MPIF002",26,0)
 ; CMORHA - array where CMOR history will be returned
"RTN","MPIF002",27,0)
 ;
"RTN","MPIF002",28,0)
 N IEN,CMOR,CNT,RET
"RTN","MPIF002",29,0)
 I '$D(^DPT(DFN)) S CMORHA="-1^NO SUCH DFN" Q
"RTN","MPIF002",30,0)
 I '$D(^DPT(DFN,"MPICMOR")) S CMORHA="-1^NO CMOR HISTORY" Q
"RTN","MPIF002",31,0)
 S (IEN,CNT)=0,RET=""
"RTN","MPIF002",32,0)
 F  S IEN=$O(^DPT(DFN,"MPICMOR",IEN)) Q:IEN=""  D
"RTN","MPIF002",33,0)
 .S CMOR=$P($G(^DPT(DFN,"MPICMOR",IEN,0)),"^")
"RTN","MPIF002",34,0)
 .I CMOR'="" S CMOR=$P($$NNT^XUAF4(CMOR),"^",2)
"RTN","MPIF002",35,0)
 .I CMOR'="" S CNT=CNT+1,CMORHA(CNT)=""""_CMOR_""""
"RTN","MPIF002",36,0)
 I CNT=0 S CMORHA="-1^NO CMOR HISTORY" Q
"RTN","MPIF002",37,0)
 S CMORHA=CNT
"RTN","MPIF002",38,0)
 Q
"RTN","MPIF002",39,0)
 ;
"RTN","MPIF002",40,0)
GETDFNS(SSN) ;
"RTN","MPIF002",41,0)
 ; Find DFN for a given SSN - all if there are more than one
"RTN","MPIF002",42,0)
 ; SSN - SSN for patient attempted to be found in the Patient file (#2)
"RTN","MPIF002",43,0)
 ; Return - list of DFNs or -1^error msg
"RTN","MPIF002",44,0)
 ;
"RTN","MPIF002",45,0)
 N DFN,LIST,CNT,NODE
"RTN","MPIF002",46,0)
 I '$D(^DPT("SSN",SSN)) Q "-1^No such SSN"
"RTN","MPIF002",47,0)
 S (DFN,LIST)="",CNT=0
"RTN","MPIF002",48,0)
 F  S DFN=$O(^DPT("SSN",SSN,DFN)) Q:DFN=""  D
"RTN","MPIF002",49,0)
 .I $D(^DPT(DFN)) D
"RTN","MPIF002",50,0)
 ..S LIST=LIST_DFN_"^",CNT=CNT+1
"RTN","MPIF002",51,0)
 ..S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF002",52,0)
 ..S ICN=$P($G(^DPT(DFN,"MPI")),"^")
"RTN","MPIF002",53,0)
 ..I ICN'="",'$D(^DPT("AICN",ICN,DFN)) S ^DPT("AICN",ICN,DFN)=""
"RTN","MPIF002",54,0)
 ..; check if missing AICN x-ref and set if missing
"RTN","MPIF002",55,0)
 I CNT=0 Q "-1^No such SSN"
"RTN","MPIF002",56,0)
 Q LIST
"RTN","MPIF002",57,0)
 ;
"RTN","MPIF002",58,0)
GETICNS(SSN) ;
"RTN","MPIF002",59,0)
 ; Find all ICNs for a given SSN -- all if there are more than one
"RTN","MPIF002",60,0)
 ; patient with that SSN
"RTN","MPIF002",61,0)
 ; SSN - SSN for patient attempted to be found in the Patient file (#2)
"RTN","MPIF002",62,0)
 ; Returned is a list of ICNs for this SSN
"RTN","MPIF002",63,0)
 ;
"RTN","MPIF002",64,0)
 N XX,DFNS,DFN,LIST,ICN,NODE
"RTN","MPIF002",65,0)
 S LIST=""
"RTN","MPIF002",66,0)
 I $G(SSN)'="" S DFNS=$$GETDFNS(SSN)
"RTN","MPIF002",67,0)
 I +DFNS=-1 Q DFNS
"RTN","MPIF002",68,0)
 F XX=1:1 S DFN=$P(DFNS,"^",XX) Q:DFN=""  D
"RTN","MPIF002",69,0)
 .S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIF002",70,0)
 .I +ICN>0 S LIST=LIST_ICN_"^"
"RTN","MPIF002",71,0)
 .I +ICN<0 S NODE=$$MPINODE^MPIFAPI(DFN),ICN=$P(NODE,"^") I ICN'="",'$D(^DPT("AICN",ICN,DFN)) S ^DPT("AICN",ICN,DFN)=""
"RTN","MPIF002",72,0)
 Q LIST
"RTN","MPIF002",73,0)
 ;
"RTN","MPIFDUPS")
0^1^B2061208
"RTN","MPIFDUPS",1,0)
MPIFDUPS ;SFCIO/CMC-MPIF RPC APIS ;26 Sept 01
"RTN","MPIFDUPS",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIFDUPS",3,0)
 ;
"RTN","MPIFDUPS",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFDUPS",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFDUPS",6,0)
 ;
"RTN","MPIFDUPS",7,0)
TOSITE(RETURN,ARRAY) ;
"RTN","MPIFDUPS",8,0)
 ; RPC for processing ICNs from MPI's TOSITE global
"RTN","MPIFDUPS",9,0)
 I $G(ARRAY)="" S RETURN="-1^NO DATA TO CHECK" Q
"RTN","MPIFDUPS",10,0)
 N ENT,ICN,SSN,SITE,NODE,MPIN,DFN
"RTN","MPIFDUPS",11,0)
 S RETURN=""
"RTN","MPIFDUPS",12,0)
 F ENT=1:1 S NODE=$P(ARRAY,"^",ENT) Q:NODE=""!(+RETURN=-1)  D
"RTN","MPIFDUPS",13,0)
 .S SITE=$P(NODE,";")
"RTN","MPIFDUPS",14,0)
 .I $P($$SITE^VASITE,"^",3)'=SITE S RETURN="-1^WRONG SITE^"_ARRAY Q
"RTN","MPIFDUPS",15,0)
 .S ICN=$P(NODE,";",2),SSN=$P(NODE,";",3)
"RTN","MPIFDUPS",16,0)
 .S DFN=+$$GETDFN^MPIF001(ICN)
"RTN","MPIFDUPS",17,0)
 .I DFN<0 S RETURN=RETURN_NODE_";1^" Q
"RTN","MPIFDUPS",18,0)
 . ; ^ 1=ICN doesn't exist
"RTN","MPIFDUPS",19,0)
 .I DFN D
"RTN","MPIFDUPS",20,0)
 ..; checking if ICN is on MPI node
"RTN","MPIFDUPS",21,0)
 ..S MPIN=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIFDUPS",22,0)
 ..I $P(MPIN,"^")'=ICN S RETURN=RETURN_NODE_";4^" Q
"RTN","MPIFDUPS",23,0)
 ..; checking if SSN is the same as on MPI  - 4=icn should be inactivated
"RTN","MPIFDUPS",24,0)
 ..I $P(^DPT(DFN,0),"^",9)'=SSN S RETURN=RETURN_NODE_";3^" Q
"RTN","MPIFDUPS",25,0)
 ..; 3 = SSN conflict
"RTN","MPIFDUPS",26,0)
 ..S RETURN=RETURN_NODE_";2^" Q
"RTN","MPIFDUPS",27,0)
 ..; 2 = ICN exists
"RTN","MPIFDUPS",28,0)
 Q
"RTN","MPIFDUPS",29,0)
 ;
"RTN","MPIFEXT")
0^3^B46733837
"RTN","MPIFEXT",1,0)
MPIFEXT ;SFCIO/CMC-EXTENDED PDAT - RPC ;26 JUN 01
"RTN","MPIFEXT",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIFEXT",3,0)
 ;
"RTN","MPIFEXT",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFEXT",5,0)
 ;  ^DGCN(391.91 - #2751
"RTN","MPIFEXT",6,0)
 ;  EN1^XWB2HL7 - #3144
"RTN","MPIFEXT",7,0)
 ;  RTNDATA^XEBDRPC - #3149
"RTN","MPIFEXT",8,0)
 ;
"RTN","MPIFEXT",9,0)
PEXT(RETURN,ICN,SSN,LOCAL,ALL,SITE,RPC) ;get patient info array
"RTN","MPIFEXT",10,0)
 N MPINODE,ARRAY,DFN,TICN,TSSN
"RTN","MPIFEXT",11,0)
 I RPC="" S RPC=0 ; default is 0 for RPC
"RTN","MPIFEXT",12,0)
 I $G(ICN)=""&($G(SSN)="") S RETURN="-1^NO ICN OR SSN PASSED" Q
"RTN","MPIFEXT",13,0)
 I $G(LOCAL)=""&($G(ALL)="")&($G(SITE)="") S ALL=1
"RTN","MPIFEXT",14,0)
 ; ^ All is the default
"RTN","MPIFEXT",15,0)
 I LOCAL=1 D PATINFO^MPIFEXT2(.RETURN,ICN,SSN,0) Q
"RTN","MPIFEXT",16,0)
 I ALL=1 D ALL(.RETURN,ICN,SSN,RPC) Q
"RTN","MPIFEXT",17,0)
 I SITE'="" D SITE(.RETURN,ICN,SSN,SITE,RPC)
"RTN","MPIFEXT",18,0)
 Q
"RTN","MPIFEXT",19,0)
 ;
"RTN","MPIFEXT",20,0)
SITE(RETS,ICN,SSN,SITE,RPC) ;
"RTN","MPIFEXT",21,0)
 ; request PDAT from one remote site
"RTN","MPIFEXT",22,0)
 I $G(SITE)="" S RETS="-1^No Site Passed" Q
"RTN","MPIFEXT",23,0)
 I $G(ICN)=""&($G(SSN)="") S RETS="-1^No ICN or SSN passed" Q
"RTN","MPIFEXT",24,0)
 I ICN="" S EXIST=$$ASK(SSN,SITE)
"RTN","MPIFEXT",25,0)
 I SSN="" S EXIST=$$ASK(ICN,SITE)
"RTN","MPIFEXT",26,0)
 I EXIST=1 D
"RTN","MPIFEXT",27,0)
 .I ICN="" S RETS(0)=$G(^XTMP("MPIF EXT PDAT"_SSN,SITE))
"RTN","MPIFEXT",28,0)
 .I SSN="" S RETS(0)=$G(^XTMP("MPIF EXT PDAT"_ICN,SITE))
"RTN","MPIFEXT",29,0)
 .I RETS(0)="" S EXIST=0
"RTN","MPIFEXT",30,0)
 I EXIST=0 D
"RTN","MPIFEXT",31,0)
 .I ICN="" K ^XTMP("MPIF EXT PDAT"_SSN,SITE)
"RTN","MPIFEXT",32,0)
 .I SSN="" K ^XTMP("MPIF EXT PDAT"_ICN,SITE)
"RTN","MPIFEXT",33,0)
 .D EN1^XWB2HL7(.RETS,SITE,"MPIF EXT PDAT REMOTE",1,ICN,SSN,1)
"RTN","MPIFEXT",34,0)
 .I $G(ICN)'="" S ^XTMP("MPIF EXT PDAT"_ICN,0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_"^"_$$NOW^XLFDT_"^"_"Remote data from site",^XTMP("MPIF EXT PDAT"_ICN,SITE)=RETS(0)
"RTN","MPIFEXT",35,0)
 .I $G(SSN)'="" S ^XTMP("MPIF EXT PDAT"_SSN,0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_"^"_$$NOW^XLFDT_"^"_"Remote data from site",^XTMP("MPIF EXT PDAT"_SSN,SITE)=RETS(0)
"RTN","MPIFEXT",36,0)
 ;
"RTN","MPIFEXT",37,0)
 N CNT,SUB
"RTN","MPIFEXT",38,0)
 S CNT=0
"RTN","MPIFEXT",39,0)
AGAIN H 2 K RES D RTNDATA^XWBDRPC(.RES,RETS(0)) S CNT=CNT+1
"RTN","MPIFEXT",40,0)
 I +RES(0)=-1&(RES(0)["Not DONE") I CNT<10 G AGAIN
"RTN","MPIFEXT",41,0)
 I +RES(0)=-1&(RES(0)["Not DONE") I CNT>10 S RETS(SITE)="Unable to get data" Q
"RTN","MPIFEXT",42,0)
 I RES(0)="0^New" I CNT<10 G AGAIN
"RTN","MPIFEXT",43,0)
 I RES(0)="0^New" I CNT>10 S RETS(SITE)="Unable to get data" Q
"RTN","MPIFEXT",44,0)
 I +RES(0)=-1 S RETS=RES(0) Q
"RTN","MPIFEXT",45,0)
 I RES'="" I CNT<10 G AGAIN
"RTN","MPIFEXT",46,0)
 I RES'="" I CNT>10 S RETS(SITE)="Unable to get data" Q
"RTN","MPIFEXT",47,0)
 D REFORMAT(.RES)
"RTN","MPIFEXT",48,0)
 K RETS,EXIST
"RTN","MPIFEXT",49,0)
 M RETS(SITE)=RES
"RTN","MPIFEXT",50,0)
 K RES
"RTN","MPIFEXT",51,0)
 Q
"RTN","MPIFEXT",52,0)
 ;
"RTN","MPIFEXT",53,0)
ALL(RETS2,ICN,SSN,RPC) ;
"RTN","MPIFEXT",54,0)
 ; request PDAT from ALL TFs and the MPI
"RTN","MPIFEXT",55,0)
 I $G(ICN)=""&($G(SSN)="") S RETS1="-1^No ICN or SSN passed" Q
"RTN","MPIFEXT",56,0)
 N DFN,ICN2
"RTN","MPIFEXT",57,0)
 I ICN="" S EXIST=$$ASK(SSN,1)
"RTN","MPIFEXT",58,0)
 I SSN="" S EXIST=$$ASK(ICN,1)
"RTN","MPIFEXT",59,0)
 I SSN'="" S ICN=$$GETICNS^MPIF002(SSN)
"RTN","MPIFEXT",60,0)
 F XX=1:1 S ICN2=$P(ICN,"^",XX) Q:ICN2=""  D
"RTN","MPIFEXT",61,0)
 .S DFN=$$GETDFN^MPIF001(ICN2)
"RTN","MPIFEXT",62,0)
 .I +DFN<0 S RETS2(ICN2)="-1^No such ICN" Q
"RTN","MPIFEXT",63,0)
 .D ALL2(DFN,ICN2,SSN,1,.RETS2,EXIST)
"RTN","MPIFEXT",64,0)
 K EXIST
"RTN","MPIFEXT",65,0)
 Q
"RTN","MPIFEXT",66,0)
 ;
"RTN","MPIFEXT",67,0)
ALL2(DFN,ICN,SSN,RPC,RETS1,EXIST) ;
"RTN","MPIFEXT",68,0)
 D GETTFS(DFN,.ARR)
"RTN","MPIFEXT",69,0)
 I +ARR=-1 G MPI
"RTN","MPIFEXT",70,0)
 S SITE=""
"RTN","MPIFEXT",71,0)
 F  S SITE=$O(ARR(SITE)) Q:SITE=""  D
"RTN","MPIFEXT",72,0)
 .K RETS1
"RTN","MPIFEXT",73,0)
 .I EXIST=1 D
"RTN","MPIFEXT",74,0)
 ..I ICN="" S RETS1(0)=$G(^XTMP("MPIF EXT PDAT"_SSN,SITE))
"RTN","MPIFEXT",75,0)
 ..I SSN="" S RETS1(0)=$G(^XTMP("MPIF EXT PDAT"_ICN,SITE))
"RTN","MPIFEXT",76,0)
 ..I RETS1(0)="" S EXIST=0
"RTN","MPIFEXT",77,0)
 .I EXIST=0 D
"RTN","MPIFEXT",78,0)
 ..I ICN="" K ^XTMP("MPIF EXT PDAT"_SSN,SITE)
"RTN","MPIFEXT",79,0)
 ..I SSN="" K ^XTMP("MPIF EXT PDAT"_ICN,SITE)
"RTN","MPIFEXT",80,0)
 ..D EN1^XWB2HL7(.RETS1,SITE,"MPIF EXT PDAT REMOTE",1,ICN,SSN,RPC)
"RTN","MPIFEXT",81,0)
 ..I $G(ICN)'="" S ^XTMP("MPIF EXT PDAT"_ICN,SITE,0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_"^"_$$NOW^XLFDT_"^"_"Remote data from site",^XTMP("MPIF EXT PDAT"_ICN,SITE)=RETS1(0)
"RTN","MPIFEXT",82,0)
 ..I $G(SSN)'="" S ^XTMP("MPIF EXT PDAT"_SSN,SITE,0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_"^"_$$NOW^XLFDT_"^"_"Remote data from site",^XTMP("MPIF EXT PDAT"_SSN,SITE)=RETS1(0)
"RTN","MPIFEXT",83,0)
 ;
"RTN","MPIFEXT",84,0)
MPI K RETS1
"RTN","MPIFEXT",85,0)
 I EXIST=1 D
"RTN","MPIFEXT",86,0)
 .I ICN="" S RETS1(0)=$G(^XTMP("MPIF EXT PDAT"_SSN,"MPI"))
"RTN","MPIFEXT",87,0)
 .I SSN="" S RETS1(0)=$G(^XTMP("MPIF EXT PDAT"_ICN,"MPI"))
"RTN","MPIFEXT",88,0)
 .I RETS1(0)="" S EXIST=0
"RTN","MPIFEXT",89,0)
 I EXIST=0 D
"RTN","MPIFEXT",90,0)
 .I ICN="" K ^XTMP("MPIF EXT PDAT"_SSN,"MPI")
"RTN","MPIFEXT",91,0)
 .I SSN="" K ^XTMP("MPIF EXT PDAT"_ICN,"MPI")
"RTN","MPIFEXT",92,0)
 .D EN1^XWB2HL7(.RETS1,"MPI","MPIF EXT PDAT REMOTE",1,ICN,SSN,RPC)
"RTN","MPIFEXT",93,0)
 .I $G(ICN)'="" S ^XTMP("MPIF EXT PDAT"_ICN,"MPI",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_"^"_$$NOW^XLFDT_"^"_"Remote data from site",^XTMP("MPIF EXT PDAT"_ICN,"MPI")=RETS1(0)
"RTN","MPIFEXT",94,0)
 .I $G(SSN)'="" S ^XTMP("MPIF EXT PDAT"_SSN,"MPI",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_"^"_$$NOW^XLFDT_"^"_"Remote data from site",^XTMP("MPIF EXT PDAT"_SSN,"MPI")=RETS1(0)
"RTN","MPIFEXT",95,0)
 ;
"RTN","MPIFEXT",96,0)
 K RETS1,RES,RESS2
"RTN","MPIFEXT",97,0)
 N ZNODE,IEN
"RTN","MPIFEXT",98,0)
 H 2
"RTN","MPIFEXT",99,0)
 I SSN="" S IEN=ICN
"RTN","MPIFEXT",100,0)
 I ICN="" S IEN=SSN
"RTN","MPIFEXT",101,0)
 S SITE=""
"RTN","MPIFEXT",102,0)
 F  S SITE=$O(^XTMP("MPIF EXT PDAT"_IEN,SITE)) Q:SITE=""  D
"RTN","MPIFEXT",103,0)
 .S ZNODE=$G(^XTMP("MPIF EXT PDAT"_IEN,SITE))
"RTN","MPIFEXT",104,0)
 .K RES
"RTN","MPIFEXT",105,0)
 .D RET(.RES,SITE,ZNODE)
"RTN","MPIFEXT",106,0)
 .K RETS1(SITE)
"RTN","MPIFEXT",107,0)
 .M RETS1(SITE)=RES
"RTN","MPIFEXT",108,0)
 .K RES
"RTN","MPIFEXT",109,0)
 ;
"RTN","MPIFEXT",110,0)
 K RES,RESS2
"RTN","MPIFEXT",111,0)
 D PATINFO^MPIFEXT2(.RESS2,ICN,SSN,0)
"RTN","MPIFEXT",112,0)
 S SITE=$P($$SITE^VASITE,"^",3)
"RTN","MPIFEXT",113,0)
 K RETS1(SITE)
"RTN","MPIFEXT",114,0)
 M RETS1(SITE)=RESS2
"RTN","MPIFEXT",115,0)
 K RESS2,ARR
"RTN","MPIFEXT",116,0)
 Q
"RTN","MPIFEXT",117,0)
 ;
"RTN","MPIFEXT",118,0)
RET(REST,SITE,IEN) ;
"RTN","MPIFEXT",119,0)
 ; RETRIEVING DATA
"RTN","MPIFEXT",120,0)
 N RES1,CNT S CNT=0
"RTN","MPIFEXT",121,0)
AGAIN1 H 2 K RES1,REST D RTNDATA^XWBDRPC(.RES1,IEN) S CNT=CNT+1
"RTN","MPIFEXT",122,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT<10 G AGAIN1
"RTN","MPIFEXT",123,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT>10 S REST(SITE)="Unable to get data" Q
"RTN","MPIFEXT",124,0)
 I RES1(0)="0^New" I CNT<10 G AGAIN1
"RTN","MPIFEXT",125,0)
 I RES1(0)="0^New" I CNT>10 S REST(SITE)="Unable to get data" Q
"RTN","MPIFEXT",126,0)
 I +RES1(0)=-1 S REST(SITE)=RES1(0) Q
"RTN","MPIFEXT",127,0)
 I RES1'="" I CNT<10 G AGAIN1
"RTN","MPIFEXT",128,0)
 I RES1'="" I CNT>10 S REST(SITE)="Unable to get data" Q
"RTN","MPIFEXT",129,0)
 D REFORMAT(.RES1)
"RTN","MPIFEXT",130,0)
 K REST
"RTN","MPIFEXT",131,0)
 M REST=RES1
"RTN","MPIFEXT",132,0)
 Q
"RTN","MPIFEXT",133,0)
 ;
"RTN","MPIFEXT",134,0)
GETTFS(DFN,ARRAY) ;
"RTN","MPIFEXT",135,0)
 ; get list of TF station numbers for a patient (dfn)
"RTN","MPIFEXT",136,0)
 ;
"RTN","MPIFEXT",137,0)
 N SITE,HERE,HSTN,CNT
"RTN","MPIFEXT",138,0)
 I $D(^DGCN(391.91,"APAT",DFN))="" S ARRAY="-1^No TFs" Q
"RTN","MPIFEXT",139,0)
 S HERE=+$$SITE^VASITE(),HSTN=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFEXT",140,0)
 S SITE="",CNT=0
"RTN","MPIFEXT",141,0)
 F  S SITE=$O(^DGCN(391.91,"APAT",DFN,SITE)) Q:SITE=""  D
"RTN","MPIFEXT",142,0)
 .Q:SITE=HERE
"RTN","MPIFEXT",143,0)
 .S CNT=CNT+1
"RTN","MPIFEXT",144,0)
 .S ARRAY($P($$NNT^XUAF4(SITE),"^",2))=""
"RTN","MPIFEXT",145,0)
 I CNT=0 S ARRAY="-1^No other site TFs" Q
"RTN","MPIFEXT",146,0)
 S ARRAY=CNT
"RTN","MPIFEXT",147,0)
 Q
"RTN","MPIFEXT",148,0)
 ;
"RTN","MPIFEXT",149,0)
REFORMAT(ARRAY) ; Reformat from RPC=1 format to RPC=0 format
"RTN","MPIFEXT",150,0)
 N XX,ARR,TARR
"RTN","MPIFEXT",151,0)
 S XX=0
"RTN","MPIFEXT",152,0)
 F  S XX=$O(ARRAY(XX)) Q:XX=""  D
"RTN","MPIFEXT",153,0)
 .I XX=1 S TARR=$P(ARRAY(XX),"(")
"RTN","MPIFEXT",154,0)
 .S ARR=$P(ARRAY(XX),"=")
"RTN","MPIFEXT",155,0)
 .S @ARR=$P(ARRAY(XX),"=",2)
"RTN","MPIFEXT",156,0)
 K ARRAY
"RTN","MPIFEXT",157,0)
 M ARRAY=@TARR
"RTN","MPIFEXT",158,0)
 K @TARR
"RTN","MPIFEXT",159,0)
 Q
"RTN","MPIFEXT",160,0)
 ;
"RTN","MPIFEXT",161,0)
ASK(ICNSSN,SITE) ; Function to check if there has been a previous request
"RTN","MPIFEXT",162,0)
 ; made for this ICN/SSN. If so, ask the user if they wish to view if or 
"RTN","MPIFEXT",163,0)
 ; create a new request.
"RTN","MPIFEXT",164,0)
 ;
"RTN","MPIFEXT",165,0)
 N DIR,X,Y,SITE1
"RTN","MPIFEXT",166,0)
 I '$D(^XTMP("MPIF EXT PDAT"_ICNSSN)) Q 0
"RTN","MPIFEXT",167,0)
 I SITE=1 D
"RTN","MPIFEXT",168,0)
 .S SITE1=0
"RTN","MPIFEXT",169,0)
 .W !!,"There has been a request made for this patient to site(s): "
"RTN","MPIFEXT",170,0)
 .F  S SITE1=$O(^XTMP("MPIF EXT PDAT"_ICNSSN,SITE1)) Q:SITE1=""  D
"RTN","MPIFEXT",171,0)
 ..I SITE1=$P($$SITE^VASITE(),"^",3) Q
"RTN","MPIFEXT",172,0)
 ..W !,SITE1,?10,$P($$NNT^XUAF4($$LKUP^XUAF4(SITE1)),"^"),?40,"made at "
"RTN","MPIFEXT",173,0)
 ..N Y S Y=$P(^XTMP("MPIF EXT PDAT"_ICNSSN,SITE1,0),"^",2) D DD^%DT
"RTN","MPIFEXT",174,0)
 ..W Y
"RTN","MPIFEXT",175,0)
 I SITE'=1,'$D(^XTMP("MPIF EXT PDAT"_ICNSSN,SITE)) Q 0
"RTN","MPIFEXT",176,0)
 I SITE'=1,SITE'=$P($$SITE^VASITE(),"^",3) D
"RTN","MPIFEXT",177,0)
 .W !!,"There has been a previous request made for this patient from the same "
"RTN","MPIFEXT",178,0)
 .W !,"site you are requesting.  The request was made at "
"RTN","MPIFEXT",179,0)
 .N Y S Y=$P($G(^XTMP("MPIF EXT PDAT"_ICNSSN,SITE,0)),"^",2) D DD^%DT
"RTN","MPIFEXT",180,0)
 .W Y
"RTN","MPIFEXT",181,0)
 S DIR("A")="Would you like to view this data?"
"RTN","MPIFEXT",182,0)
 S DIR(0)="Y",DIR("B")="No"
"RTN","MPIFEXT",183,0)
 D ^DIR
"RTN","MPIFEXT",184,0)
 I Y'=1 Q 0
"RTN","MPIFEXT",185,0)
 Q 1
"RTN","MPIFEXT2")
0^5^B36299229
"RTN","MPIFEXT2",1,0)
MPIFEXT2 ;SFCIO/CMC-EXTENDED PDAT - RPC ;26 JUN 01
"RTN","MPIFEXT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIFEXT2",3,0)
 ;
"RTN","MPIFEXT2",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFEXT2",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFEXT2",6,0)
 ;  NOTICE^DGSEC4 - #3027
"RTN","MPIFEXT2",7,0)
 ;  PTSEC^DGSEC4 - #3027
"RTN","MPIFEXT2",8,0)
 ;  D GETS^DIQ(2,DFN_",",".097","I","MPIFAR") - #3581
"RTN","MPIFEXT2",9,0)
 ;
"RTN","MPIFEXT2",10,0)
PATINFO(RETN,ICN,SSN,RPC) ;get patient info array
"RTN","MPIFEXT2",11,0)
 N MPINODE,MPIFAR,DFN,TICN,TSSN,TEXT,CNTD,PICN,XX,X
"RTN","MPIFEXT2",12,0)
 I $G(ICN)=""&($G(SSN)="") S RETN="-1^NO ICN OR SSN PASSED" Q
"RTN","MPIFEXT2",13,0)
 S TICN=ICN,TSSN=SSN,TEXT=""
"RTN","MPIFEXT2",14,0)
 I $G(SSN)'="" D
"RTN","MPIFEXT2",15,0)
 .S ICN=$$GETICNS^MPIF002(SSN)
"RTN","MPIFEXT2",16,0)
 .I RPC=1 S TEXT="MPI(""SSN USED"")="
"RTN","MPIFEXT2",17,0)
 .S RETN(1,"SSN USED")=TEXT_""""_SSN_""""
"RTN","MPIFEXT2",18,0)
 .; possible to have multiple entries with same SSN
"RTN","MPIFEXT2",19,0)
 S PICN=ICN,CNTD=0
"RTN","MPIFEXT2",20,0)
 F XX=1:1 S ICN=$P(PICN,"^",XX) Q:ICN=""  D
"RTN","MPIFEXT2",21,0)
 .S DFN=$$GETDFN^MPIF001(+ICN),CNTD=CNTD+1
"RTN","MPIFEXT2",22,0)
 .I +DFN=-1 S RETN(XX)="-1^NO SUCH ICN "_ICN Q
"RTN","MPIFEXT2",23,0)
 .I '$D(^DPT(DFN)) S RETN(XX)="-1^BAD AICN X-REF, PT FILE ENTRY DOESN'T EXIST DFN= "_DFN_" ICN= "_ICN Q
"RTN","MPIFEXT2",24,0)
 .; check if this data can be returned and if sensative pt bulletin needed
"RTN","MPIFEXT2",25,0)
 .N SENS D PTSEC^DGSEC4(.SENS,DFN,1,"Remote Procedure from MPI^RPC frm MPI ext PDAT infor")
"RTN","MPIFEXT2",26,0)
 .N NOT D NOTICE^DGSEC4(.NOT,DFN,"Remote Procedure from MPI^RPC frm MPI ext PDAT infor")
"RTN","MPIFEXT2",27,0)
 .I SENS(1)=3!(SENS(1)=4)!(SENS(1)=-1) S RETN(XX)="-1^SENSATIVE PT ISSUE "_SENS(2)_" DFN= "_DFN_" ICN= "_ICN Q
"RTN","MPIFEXT2",28,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""DFN"")="
"RTN","MPIFEXT2",29,0)
 .S RETN(XX,"DFN")=TEXT_""""_DFN_""""
"RTN","MPIFEXT2",30,0)
 .S MPINODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIFEXT2",31,0)
 .D GETS^DIQ(2,DFN_",",".097","I","MPIFAR")
"RTN","MPIFEXT2",32,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""ENTERED PT FILE"")="
"RTN","MPIFEXT2",33,0)
 .S RETN(DFN,"ENTERED PT FILE")=TEXT_""""_$$FMTE^XLFDT(MPIFAR(2,DFN_",",.097,"I"),5)_""""
"RTN","MPIFEXT2",34,0)
 .K VADM
"RTN","MPIFEXT2",35,0)
 .D DEM^VADPT
"RTN","MPIFEXT2",36,0)
 .F X=1,2,3,5,6,8 D
"RTN","MPIFEXT2",37,0)
 ..I X=1 D
"RTN","MPIFEXT2",38,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""NAME"")="
"RTN","MPIFEXT2",39,0)
 ...S RETN(DFN,"NAME")=TEXT_""""_VADM(1)_""""
"RTN","MPIFEXT2",40,0)
 ..I X=2 D
"RTN","MPIFEXT2",41,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""SEX"")="
"RTN","MPIFEXT2",42,0)
 ...S RETN(DFN,"SEX")=TEXT_""""_VADM(5)_""""
"RTN","MPIFEXT2",43,0)
 ..I X=3 D
"RTN","MPIFEXT2",44,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""DOB"")="
"RTN","MPIFEXT2",45,0)
 ...S RETN(DFN,"DOB")=TEXT_""""_VADM(3)_""""
"RTN","MPIFEXT2",46,0)
 ..I X=8 D
"RTN","MPIFEXT2",47,0)
 ..I RPC=1 S TEXT="MPI("_DFN_",""RACE"")="
"RTN","MPIFEXT2",48,0)
 ..S RETN(DFN,"RACE")=TEXT_""""_VADM(8)_""""
"RTN","MPIFEXT2",49,0)
 ..I X=2 D
"RTN","MPIFEXT2",50,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""SSN"")="
"RTN","MPIFEXT2",51,0)
 ...S RETN(DFN,"SSN")=TEXT_""""_VADM(2)_""""
"RTN","MPIFEXT2",52,0)
 ..I X=6 D
"RTN","MPIFEXT2",53,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""DOD"")="
"RTN","MPIFEXT2",54,0)
 ...S RETN(DFN,"DOD")=TEXT_""""_$$FMTE^XLFDT($P(VADM(6),"^"))_""""
"RTN","MPIFEXT2",55,0)
 .K VAPA,VADM
"RTN","MPIFEXT2",56,0)
 .D ADD^VADPT
"RTN","MPIFEXT2",57,0)
 .F X=1,2,3,4,5,6,8,11 D
"RTN","MPIFEXT2",58,0)
 ..I X=1 D
"RTN","MPIFEXT2",59,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""ADDRESS"")="
"RTN","MPIFEXT2",60,0)
 ...S RETN(DFN,"ADDRESS 1")=TEXT_""""_VAPA(1)_""""
"RTN","MPIFEXT2",61,0)
 ..I X=6 D
"RTN","MPIFEXT2",62,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""ZIP"")="
"RTN","MPIFEXT2",63,0)
 ...S RETN(DFN,"ZIP")=TEXT_""""_VAPA(6)_""""
"RTN","MPIFEXT2",64,0)
 ..I X=2 D
"RTN","MPIFEXT2",65,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""ADDRESS 2"")="
"RTN","MPIFEXT2",66,0)
 ...S RETN(DFN,"ADDRESS 2")=TEXT_""""_VAPA(2)_""""
"RTN","MPIFEXT2",67,0)
 ..I X=3 D
"RTN","MPIFEXT2",68,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""ADDRESS 3"")="
"RTN","MPIFEXT2",69,0)
 ...S RETN(DFN,"ADDRESS 3")=TEXT_""""_VAPA(3)_""""
"RTN","MPIFEXT2",70,0)
 ..I X=5 D
"RTN","MPIFEXT2",71,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""STATE"")="
"RTN","MPIFEXT2",72,0)
 ...S RETN(DFN,"STATE")=TEXT_""""_$P(VAPA(5),"^",2)_""""
"RTN","MPIFEXT2",73,0)
 ..I X=4 D
"RTN","MPIFEXT2",74,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""CITY"")="
"RTN","MPIFEXT2",75,0)
 ...S RETN(DFN,"CITY")=TEXT_""""_VAPA(4)_""""
"RTN","MPIFEXT2",76,0)
 ..I X=8 D
"RTN","MPIFEXT2",77,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""HOME PHONE #"")="
"RTN","MPIFEXT2",78,0)
 ...S RETN(DFN,"HOME PHONE #")=TEXT_""""_VAPA(8)_""""
"RTN","MPIFEXT2",79,0)
 .K VAPA,VAEL
"RTN","MPIFEXT2",80,0)
 .D ELIG^VADPT
"RTN","MPIFEXT2",81,0)
 .I VAEL(4)=1 S VAEL("VET Y/N")="YES"
"RTN","MPIFEXT2",82,0)
 .I VAEL(4)'=1 S VAEL("VET Y/N")="NO"
"RTN","MPIFEXT2",83,0)
 .F X=1,4,7 D
"RTN","MPIFEXT2",84,0)
 ..I X=7 D
"RTN","MPIFEXT2",85,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""CLAIM #"")="
"RTN","MPIFEXT2",86,0)
 ...S RETN(DFN,"CLAIM #")=TEXT_""""_VAEL(7)_""""
"RTN","MPIFEXT2",87,0)
 ..I X=4 D
"RTN","MPIFEXT2",88,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""VET Y/N"")="
"RTN","MPIFEXT2",89,0)
 ...S RETN(DFN,"VET Y/N")=TEXT_""""_VAEL("VET Y/N")_""""
"RTN","MPIFEXT2",90,0)
 ..I X=1 D
"RTN","MPIFEXT2",91,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""PRIM ELIG"")="
"RTN","MPIFEXT2",92,0)
 ...S RETN(DFN,"PRIM ELIG")=TEXT_""""_$P(VAEL(1),"^",2)_""""
"RTN","MPIFEXT2",93,0)
 .K VAEL,VAOA
"RTN","MPIFEXT2",94,0)
 .D OAD^VADPT
"RTN","MPIFEXT2",95,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""NOK NAME"")="
"RTN","MPIFEXT2",96,0)
 .S RETN(DFN,"NOK NAME")=TEXT_""""_VAOA(9)_""""
"RTN","MPIFEXT2",97,0)
 .K VAOA
"RTN","MPIFEXT2",98,0)
 .S VAOA("A")=1
"RTN","MPIFEXT2",99,0)
 .D OAD^VADPT
"RTN","MPIFEXT2",100,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""EMERGENCY POC"")="
"RTN","MPIFEXT2",101,0)
 .S RETN(DFN,"EMERGENCY POC")=TEXT_""""_VAOA(9)_""""
"RTN","MPIFEXT2",102,0)
 .K VAOA
"RTN","MPIFEXT2",103,0)
 .S VAOA("A")=2
"RTN","MPIFEXT2",104,0)
 .D OAD^VADPT
"RTN","MPIFEXT2",105,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""DESIGNEE"")="
"RTN","MPIFEXT2",106,0)
 .S RETN(DFN,"DESIGNEE")=TEXT_""""_VAOA(9)_""""
"RTN","MPIFEXT2",107,0)
 .K VAOA,VAPD
"RTN","MPIFEXT2",108,0)
 .D OPD^VADPT
"RTN","MPIFEXT2",109,0)
 .F X=1,2,3,4,5 D
"RTN","MPIFEXT2",110,0)
 ..I X=5 D
"RTN","MPIFEXT2",111,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""MMN"")="
"RTN","MPIFEXT2",112,0)
 ...S RETN(DFN,"MMN")=TEXT_""""_VAPD(5)_""""
"RTN","MPIFEXT2",113,0)
 ..I X=1 D
"RTN","MPIFEXT2",114,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""POBC"")="
"RTN","MPIFEXT2",115,0)
 ...S RETN(DFN,"POBC")=TEXT_""""_VAPD(1)_""""
"RTN","MPIFEXT2",116,0)
 ..I X=2 D
"RTN","MPIFEXT2",117,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""POBS"")="
"RTN","MPIFEXT2",118,0)
 ...S RETN(DFN,"POBS")=TEXT_""""_$P(VAPD(2),"^",2)_""""
"RTN","MPIFEXT2",119,0)
 ..I X=3 D
"RTN","MPIFEXT2",120,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""FATHER'S NAME"")="
"RTN","MPIFEXT2",121,0)
 ...S RETN(DFN,"FATHER'S NAME")=TEXT_""""_VAPD(3)_""""
"RTN","MPIFEXT2",122,0)
 ..I X=4 D
"RTN","MPIFEXT2",123,0)
 ...I RPC=1 S TEXT="MPI("_DFN_",""MOTHER'S NAME"")="
"RTN","MPIFEXT2",124,0)
 ...S RETN(DFN,"MOTHER'S NAME")=TEXT_""""_VAPD(4)_""""
"RTN","MPIFEXT2",125,0)
 .K VAPD,VASV
"RTN","MPIFEXT2",126,0)
 .D SVC^VADPT
"RTN","MPIFEXT2",127,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""LAST SRV BRANCH"")="
"RTN","MPIFEXT2",128,0)
 .S RETN(DFN,"LAST SRV BRANCH")=TEXT_""""_$P(VASV(6,1),"^",2)_""""
"RTN","MPIFEXT2",129,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""LAST SRV #"")="
"RTN","MPIFEXT2",130,0)
 .S RETN(DFN,"LAST SRV #")=TEXT_""""_VASV(6,2)_""""
"RTN","MPIFEXT2",131,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""LAST SRV ENT DT"")="
"RTN","MPIFEXT2",132,0)
 .S RETN(DFN,"LAST SRV ENT DT")=TEXT_""""_$$FMTE^XLFDT($P(VASV(6,4),"^"))_""""
"RTN","MPIFEXT2",133,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""LAST SRV SEP DT"")="
"RTN","MPIFEXT2",134,0)
 .S RETN(DFN,"LAST SRV SEP DT")=TEXT_""""_$$FMTE^XLFDT($P(VASV(6,5),"^"))_""""
"RTN","MPIFEXT2",135,0)
 .K VASV
"RTN","MPIFEXT2",136,0)
 .N MPINODE
"RTN","MPIFEXT2",137,0)
 .S MPINODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIFEXT2",138,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""SUB CONTROL #"")="
"RTN","MPIFEXT2",139,0)
 .S RETN(DFN,"SUB CONTROL #")=TEXT_""""_$P(MPINODE,"^",5)_""""
"RTN","MPIFEXT2",140,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""SCORE"")="
"RTN","MPIFEXT2",141,0)
 .S RETN(DFN,"SCORE")=TEXT_""""_$P(MPINODE,"^",6)_""""
"RTN","MPIFEXT2",142,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""SCORE DATE"")="
"RTN","MPIFEXT2",143,0)
 .S RETN(DFN,"SCORE DATE")=TEXT_""""_$P(MPINODE,"^",7)_""""
"RTN","MPIFEXT2",144,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""LOCAL ICN"")="
"RTN","MPIFEXT2",145,0)
 .I $P(MPINODE,"^",4)=1 S RETN(DFN,"LOCAL ICN")=TEXT_"""YES"""
"RTN","MPIFEXT2",146,0)
 .I $P(MPINODE,"^",4)="" S RETN(DFN,"LOCAL ICN")=TEXT_"""NO"""
"RTN","MPIFEXT2",147,0)
 .N RESULT,SENS
"RTN","MPIFEXT2",148,0)
 .S SENS="NO"
"RTN","MPIFEXT2",149,0)
 .D PTSEC^DGSEC4(.RESULT,DFN)
"RTN","MPIFEXT2",150,0)
 .I RESULT(1)>0 S SENS="YES"
"RTN","MPIFEXT2",151,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""SENSATIVE PT"")="
"RTN","MPIFEXT2",152,0)
 .S RETN(DFN,"SENSATIVE PT")=TEXT_""""_SENS_""""
"RTN","MPIFEXT2",153,0)
 .D ALIAS^MPIFEXT3(.RETN,DFN,RPC)
"RTN","MPIFEXT2",154,0)
 .D CMORCH^MPIFEXT3(.RETN,DFN,RPC)
"RTN","MPIFEXT2",155,0)
 .D TFLIST^MPIFEXT3(.RETN,DFN,RPC)
"RTN","MPIFEXT2",156,0)
 .D SUBLST^MPIFEXT3(.RETN,DFN,RPC)
"RTN","MPIFEXT2",157,0)
 D ICNSTAT^MPIFRPC(.RETN,TICN,TSSN,RPC)
"RTN","MPIFEXT2",158,0)
 K VA,VAERR
"RTN","MPIFEXT2",159,0)
 Q
"RTN","MPIFEXT2",160,0)
 ;
"RTN","MPIFEXT3")
0^6^B22621526
"RTN","MPIFEXT3",1,0)
MPIFEXT3 ;SFCIO/CMC-EXTENDED PDAT 3 - RPC ;26 JUN 01
"RTN","MPIFEXT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIFEXT3",3,0)
 ;
"RTN","MPIFEXT3",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFEXT3",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFEXT3",6,0)
 ;  $$GET1^DIQ(870,+$P(ARRAY("LINKS",SUBNUM),"^",6)_",",.02,"E") - #3573
"RTN","MPIFEXT3",7,0)
 ;  D GETS^DIQ(2,IEN_",","1*","E","MPIFA") - #3581
"RTN","MPIFEXT3",8,0)
 ;
"RTN","MPIFEXT3",9,0)
ALIAS(RET,IEN,RPC) ; get any Aliases for patient IEN
"RTN","MPIFEXT3",10,0)
 N ALIEN,RET2,MPIFA
"RTN","MPIFEXT3",11,0)
 I RPC=1 S TEXT="MPI("_IEN_",""ALIAS(ES)"")="
"RTN","MPIFEXT3",12,0)
 S ALIEN=0,RET2=""
"RTN","MPIFEXT3",13,0)
 D GETS^DIQ(2,IEN_",","1*","E","MPIFA")
"RTN","MPIFEXT3",14,0)
 ;; MPIFA(2.01,"1,1,",.01,"E")=Funky K
"RTN","MPIFEXT3",15,0)
 F  S ALIEN=$O(MPIFA(2.01,ALIEN)) Q:'ALIEN  D
"RTN","MPIFEXT3",16,0)
 .I $G(MPIFA(2.01,ALIEN,.01,"E"))'="" S RET2=RET2_$G(MPIFA(2.01,ALIEN,.01,"E"))_"^"
"RTN","MPIFEXT3",17,0)
 I RET2=""!(RET2?."^") S RET2="NONE"
"RTN","MPIFEXT3",18,0)
 S RET(IEN,"ALIAS(ES)")=TEXT_""""_RET2_""""
"RTN","MPIFEXT3",19,0)
 Q
"RTN","MPIFEXT3",20,0)
CMORCH(RET,DFN,RPC) ; get any CMOR Change Requests for this patient
"RTN","MPIFEXT3",21,0)
 K MPIFCCR
"RTN","MPIFEXT3",22,0)
 D CCRDAT^MPIFUTL(DFN,"MPIFCCR")
"RTN","MPIFEXT3",23,0)
 N REQ,FLD,TOT
"RTN","MPIFEXT3",24,0)
 S REQ=0,TOT=$G(MPIFCCR(0))
"RTN","MPIFEXT3",25,0)
 F  S REQ=$O(MPIFCCR(REQ)) Q:REQ=""  D
"RTN","MPIFEXT3",26,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REQ #"")="
"RTN","MPIFEXT3",27,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REQ #")=TEXT_""""_$G(MPIFCCR(REQ,.01))_""""
"RTN","MPIFEXT3",28,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REQ BY"")="
"RTN","MPIFEXT3",29,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REQ BY")=TEXT_""""_$G(MPIFCCR(REQ,.02))_""""
"RTN","MPIFEXT3",30,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""DT REQ"")="
"RTN","MPIFEXT3",31,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"DT REQ")=TEXT_""""_$G(MPIFCCR(REQ,.03))_""""
"RTN","MPIFEXT3",32,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""PATIENT"")="
"RTN","MPIFEXT3",33,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"PATIENT")=TEXT_""""_$G(MPIFCCR(REQ,.04))_""""
"RTN","MPIFEXT3",34,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REQ PHONE"")="
"RTN","MPIFEXT3",35,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REQ PHONE")=TEXT_""""_$G(MPIFCCR(REQ,.05))_""""
"RTN","MPIFEXT3",36,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""STATUS"")="
"RTN","MPIFEXT3",37,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"STATUS")=TEXT_""""_$G(MPIFCCR(REQ,.06))_""""
"RTN","MPIFEXT3",38,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""SITE"")="
"RTN","MPIFEXT3",39,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"SITE")=TEXT_""""_$G(MPIFCCR(REQ,.07))_""""
"RTN","MPIFEXT3",40,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""TYPE"")="
"RTN","MPIFEXT3",41,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"TYPE")=TEXT_""""_$G(MPIFCCR(REQ,.08))_""""
"RTN","MPIFEXT3",42,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""CMOR AFTER APP"")="
"RTN","MPIFEXT3",43,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"CMOR AFTER APP")=TEXT_""""_$G(MPIFCCR(REQ,.09))_""""
"RTN","MPIFEXT3",44,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REQ NAME"")="
"RTN","MPIFEXT3",45,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REQ NAME")=TEXT_""""_$G(MPIFCCR(REQ,1.01))_""""
"RTN","MPIFEXT3",46,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REQ REASON"")="
"RTN","MPIFEXT3",47,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REQ REASON")=TEXT_""""_$G(MPIFCCR(REQ,1.02))_""""
"RTN","MPIFEXT3",48,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""TYPE OF ACTION"")="
"RTN","MPIFEXT3",49,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"TYPE OF ACTION")=TEXT_""""_$G(MPIFCCR(REQ,1.03))_""""
"RTN","MPIFEXT3",50,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REV BY"")="
"RTN","MPIFEXT3",51,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REV BY")=TEXT_""""_$G(MPIFCCR(REQ,2.01))_""""
"RTN","MPIFEXT3",52,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""DT REV"")="
"RTN","MPIFEXT3",53,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"DT REV")=TEXT_""""_$G(MPIFCCR(REQ,2.02))_""""
"RTN","MPIFEXT3",54,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REV PHONE"")="
"RTN","MPIFEXT3",55,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REV PHONE")=TEXT_""""_$G(MPIFCCR(REQ,2.03))_""""
"RTN","MPIFEXT3",56,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REV BY"")="
"RTN","MPIFEXT3",57,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REV BY")=TEXT_""""_$G(MPIFCCR(REQ,3.01))_""""
"RTN","MPIFEXT3",58,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""REV COMMENTS"")="
"RTN","MPIFEXT3",59,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"REV COMMENTS")=TEXT_""""_$G(MPIFCCR(REQ,3.02))_""""
"RTN","MPIFEXT3",60,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""CMOR CHG REQ"","_REQ_",""BLURB"")="
"RTN","MPIFEXT3",61,0)
 .S RET(DFN,"CMOR CHG REQ",REQ,"BLURB")=TEXT_""""_$G(MPIFCCR(REQ,999))_""""
"RTN","MPIFEXT3",62,0)
 K MPIFCCR
"RTN","MPIFEXT3",63,0)
 Q
"RTN","MPIFEXT3",64,0)
TFLIST(RET,DFN,RPC) ;
"RTN","MPIFEXT3",65,0)
 ; return the complete list of Treating Facilities for patient DFN
"RTN","MPIFEXT3",66,0)
 N ARRAY,TEXT,XX,STN,NM
"RTN","MPIFEXT3",67,0)
 S (STN,TEXT)="",XX=0
"RTN","MPIFEXT3",68,0)
 D GETTFS^MPIFEXT(DFN,.ARRAY)
"RTN","MPIFEXT3",69,0)
 I RPC=1 S TEXT="MPI("_DFN_",""TF LIST"","
"RTN","MPIFEXT3",70,0)
 S RET(DFN,"TF LIST",0)=TEXT_XX_")="
"RTN","MPIFEXT3",71,0)
 I +ARRAY<1 S RET(DFN,"TF LIST",0)=TEXT_XX_")="_"""NONE""" Q
"RTN","MPIFEXT3",72,0)
 F  S STN=$O(ARRAY(STN)) Q:STN=""  D
"RTN","MPIFEXT3",73,0)
 .S XX=XX+1
"RTN","MPIFEXT3",74,0)
 .S NM=$P($$NNT^XUAF4($$LKUP^XUAF4(STN)),"^")
"RTN","MPIFEXT3",75,0)
 .S RET(DFN,"TF LIST",XX)=TEXT_XX_")="_""""_NM_" ("_STN_")"""
"RTN","MPIFEXT3",76,0)
 S RET(DFN,"TF LIST",0)=$G(RET(DFN,"TF LIST",0))_XX
"RTN","MPIFEXT3",77,0)
 Q
"RTN","MPIFEXT3",78,0)
SUBLST(RET,DFN,RPC) ;
"RTN","MPIFEXT3",79,0)
 ; return the complete list of Subscribers for patient DFN
"RTN","MPIFEXT3",80,0)
 N INST,TERM,TERMDT,MPINODE,SUBNUM,SUB,XX,MPIFX
"RTN","MPIFEXT3",81,0)
 S XX=0,TEXT=""
"RTN","MPIFEXT3",82,0)
 S MPINODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIFEXT3",83,0)
 S SUB=$P(MPINODE,"^",5)
"RTN","MPIFEXT3",84,0)
 I RPC=1 S TEXT="MPI("_DFN_",""SUB LIST"","
"RTN","MPIFEXT3",85,0)
 S RET(DFN,"SUB LIST",0)=TEXT_XX_")="
"RTN","MPIFEXT3",86,0)
 I SUB<1 S RET(DFN,"SUB LIST",0)=TEXT_XX_")="_"""NONE""" Q
"RTN","MPIFEXT3",87,0)
 D GET^HLSUB(SUB,0,"",.MPIFX)
"RTN","MPIFEXT3",88,0)
 I '$O(MPIFX("LINKS",0)) S RET(DFN,"SUB LIST",0)=TEXT_XX_")="_"""NONE""" Q
"RTN","MPIFEXT3",89,0)
 S SUBNUM=0
"RTN","MPIFEXT3",90,0)
 F  S SUBNUM=$O(MPIFX("LINKS",SUBNUM)) Q:SUBNUM=""  D
"RTN","MPIFEXT3",91,0)
 .S XX=XX+1
"RTN","MPIFEXT3",92,0)
 .S INST=$$GET1^DIQ(870,+$P(MPIFX("LINKS",SUBNUM),"^",6)_",",.02,"E")
"RTN","MPIFEXT3",93,0)
 .S TERM=$P(MPIFX("LINKS",SUBNUM),"^",10)
"RTN","MPIFEXT3",94,0)
 .S TERMDT=$$FMTE^XLFDT($E(TERM,1,12)) I TERMDT="" S TERMDT="None Found"
"RTN","MPIFEXT3",95,0)
 .S RET(DFN,"SUB LIST",XX)=TEXT_XX_")="_""""_INST_"   Termination Date:"_TERMDT_""""
"RTN","MPIFEXT3",96,0)
 S RET(DFN,"SUB LIST",0)=$G(RET(DFN,"SUB LIST",0))_XX
"RTN","MPIFEXT3",97,0)
 Q
"RTN","MPIFQ0")
0^8^B74643511
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17,21,20**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$SEND2^VAFCUTL1- #2779
"RTN","MPIFQ0",8,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFQ0",9,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",10,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",11,0)
 ;
"RTN","MPIFQ0",12,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",13,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",14,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",15,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",16,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W:'$D(MPIFRPC) !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",17,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",18,0)
 W:'$D(MPIFRPC) !
"RTN","MPIFQ0",19,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",20,0)
 I $$SEND^RGJUSITE'>0 W:'$D(MPIFRPC) !,"MPI/PD Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",21,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",22,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",23,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",24,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",25,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N W:'$D(MPIFRPC) !,"Patient is missing Date of Birth -- Required Field" D LOCAL(DFN) G END
"RTN","MPIFQ0",26,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",27,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",28,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",29,0)
 I $E(LOCDATA(2,DFN,.01),1,3)="EEE" W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" G END
"RTN","MPIFQ0",30,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",31,0)
 G JUMP
"RTN","MPIFQ0",32,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",33,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",34,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",35,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",36,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",37,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S MPIFRTN="MISSING DOB" D EXC^MPIFVTQ(DFN) G END
"RTN","MPIFQ0",38,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",39,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",40,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",41,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",42,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",43,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC
"RTN","MPIFQ0",44,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",45,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",46,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",47,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",48,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",49,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",50,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",51,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",52,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",53,0)
 ;Create MSH
"RTN","MPIFQ0",54,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",55,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",56,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",57,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",58,0)
 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",59,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",60,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",61,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and continue with Registration
"RTN","MPIFQ0",62,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",63,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",64,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",65,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",66,0)
 K ^TMP("MPIFQ0",$J) ;array data is parsed into for display in LM
"RTN","MPIFQ0",67,0)
INIPARS N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",68,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",69,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFQ0",70,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",71,0)
 .N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN,HEREICN,HERESSN,MIDDLE,IEN,F,SUFF,SEX
"RTN","MPIFQ0",72,0)
 .S STRING="",FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2),MIDDLE=$P(SEG,HL("FS"),10),SUFF=$P(SEG,HL("FS"),15)
"RTN","MPIFQ0",73,0)
 .S (LASTSSN,SSN)=$P(SEG,HL("FS"),3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",74,0)
 .I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",75,0)
 .I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",76,0)
 .S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",77,0)
 .S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",78,0)
 .I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN
"RTN","MPIFQ0",79,0)
 .I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",80,0)
 .S FIRST=FIRST+1,CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",81,0)
 .I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",82,0)
 .S TF=$P(SEG,HL("FS"),8)
"RTN","MPIFQ0",83,0)
 .I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",84,0)
 .;Same patient just adding TF's
"RTN","MPIFQ0",85,0)
 .I TF'="",ICN=FICN,FIRST'=2 S COUNTER=COUNTER+1,^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF_"^"_IEN
"RTN","MPIFQ0",86,0)
 .Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",87,0)
 .S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",88,0)
 .I $G(LASTNAME)="" Q
"RTN","MPIFQ0",89,0)
 .I $G(BIRTHDAY)]"" S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY),BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFQ0",90,0)
 .;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",91,0)
 .S INDEX=INDEX+1,COUNTER=1,HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",92,0)
 .I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",93,0)
 .S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",94,0)
 .S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",95,0)
 .S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",96,0)
 .S ^TMP("MPIFQ0",$J,INDEX,0)=STRING,^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",97,0)
 .S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_CCMOR_"^"_SEX
"RTN","MPIFQ0",98,0)
 .S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",99,0)
 .S ^TMP("MPIFQ0",$J,INDEX,"HOLD")=SEG
"RTN","MPIFQ0",100,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",101,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",102,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",103,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",104,0)
 .D A28(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",105,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to see if it's definitely the same patient.
"RTN","MPIFQ0",106,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",107,0)
 .N CMOR,ICN,DATA,TICN,SNM,SNM2
"RTN","MPIFQ0",108,0)
 .S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA"),CMOR=CCMOR,ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",109,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",110,0)
 .S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",111,0)
 .I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",112,0)
 .I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",113,0)
 .; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",114,0)
 .S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",115,0)
 .S SNM2=$P(DATA,"^") D NAME^VAFCPID2(0,.SNM2,0) S $P(DATA,"^")=SNM2
"RTN","MPIFQ0",116,0)
 .I $P(DATA,"^")'=SNM D  Q
"RTN","MPIFQ0",117,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",118,0)
 ..I '$D(MPIFINT) D LOC2(DFN) Q
"RTN","MPIFQ0",119,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",120,0)
 .D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",121,0)
 .S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",122,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",123,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",124,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",125,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",126,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",127,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",128,0)
EXIT I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",129,0)
 K VALMCNT,VALMLST
"RTN","MPIFQ0",130,0)
 K CCMOR,FICN H 3 W:'$D(MPIFRPC) !!
"RTN","MPIFQ0",131,0)
END Q
"RTN","MPIFQ0",132,0)
A28(DFN) ;
"RTN","MPIFQ0",133,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",134,0)
 I +ICN>0 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",135,0)
 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",136,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",137,0)
 Q
"RTN","MPIFQ0",138,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",139,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",140,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",141,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",142,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",143,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",144,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",145,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",146,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",147,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",148,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",149,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",150,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",151,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",152,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",153,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",154,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",155,0)
 N HERE S HERE=+$P($$SITE^VASITE,"^",3) D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",156,0)
 Q
"RTN","MPIFQ0",157,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",158,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",159,0)
 N ICN S ICN=$$ICNLC^MPIF001(DFN) ;don't assign local if exists
"RTN","MPIFQ0",160,0)
 Q
"RTN","MPIFQ0",161,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",162,0)
 Q:$G(ICN)="" 0
"RTN","MPIFQ0",163,0)
 N DFN S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",164,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",165,0)
 Q DFN
"RTN","MPIFQ0",166,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFQ0",167,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",168,0)
 ;DIC is the file reference, DA is the file entry IEN, ARRAY is the
"RTN","MPIFQ0",169,0)
 ;storage array for the values to be stored in, DR are the fields
"RTN","MPIFQ0",170,0)
 ;requested, EI is external/internal values of the fields or don't
"RTN","MPIFQ0",171,0)
 ;return null values
"RTN","MPIFQ0",172,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFQ0",173,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",174,0)
 D EN^DIQ1
"RTN","MPIFQ0",175,0)
 Q
"RTN","MPIFQ0",176,0)
LOC2(DFN) ;
"RTN","MPIFQ0",177,0)
 W:'$D(MPIFRPC) !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",178,0)
 D START^RGHLLOG(),EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN),STOP^RGHLLOG()
"RTN","MPIFQ0",179,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",180,0)
 Q
"RTN","MPIFRPC")
0^2^B35812148
"RTN","MPIFRPC",1,0)
MPIFRPC ;SFCIO/CMC-MPIF RPC APIS ;26 JUN 01
"RTN","MPIFRPC",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIFRPC",3,0)
 ;
"RTN","MPIFRPC",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFRPC",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFRPC",6,0)
 ;  AVAFC^VAFCDD01 - #3493
"RTN","MPIFRPC",7,0)
 ;  GETEX^RGEX03 - #3554
"RTN","MPIFRPC",8,0)
 ;  NOTICE^DGSEC4 - #3027
"RTN","MPIFRPC",9,0)
 ;  PTSEC^DGSEC4 - #3027
"RTN","MPIFRPC",10,0)
 ;
"RTN","MPIFRPC",11,0)
ICNSTAT(RETURN,ICN,SSN,RPC) ;
"RTN","MPIFRPC",12,0)
 ;RPC to return status of ICN passed or if SSN is passed find ICN and return status including ICN, ICN History, CMOR History, Exceptions pending
"RTN","MPIFRPC",13,0)
 ; RETURN - array to return ICN data
"RTN","MPIFRPC",14,0)
 ; ICN - ICN for the patient in the Patient (#2) file data is to be returned on
"RTN","MPIFRPC",15,0)
 ; SSN - social security number for the patient in the Patient (#2) file data is to be returned on
"RTN","MPIFRPC",16,0)
 ; RPC - 0 or 1 to denote if the call is being made from a RPC or called locally. 1=RPC remote call 0=locally called - 1 is default
"RTN","MPIFRPC",17,0)
 ;
"RTN","MPIFRPC",18,0)
 N PICN,CNTD,DFN,TICN,LOCAL,XX,RETS,TEXT,CMOR,ICNH,CMORH
"RTN","MPIFRPC",19,0)
 I $G(RPC)="" S RPC=1
"RTN","MPIFRPC",20,0)
 I $G(ICN)=""&($G(SSN)="") S RETURN="-1^NO ICN OR SSN PASSED" Q
"RTN","MPIFRPC",21,0)
 I $G(SSN)'="" S ICN=$$GETICNS^MPIF002(SSN),RETURN(1,"SSN USED")="MPI(""SSN USED"")="_""""_SSN_"""" ; possible to have multiple entries with same SSN
"RTN","MPIFRPC",22,0)
 S PICN=ICN,CNTD=0,TEXT=""
"RTN","MPIFRPC",23,0)
 F XX=1:1 S ICN=$P(PICN,"^",XX) Q:ICN=""  D
"RTN","MPIFRPC",24,0)
 .S DFN=$$GETDFN^MPIF001(+ICN),CNTD=CNTD+1
"RTN","MPIFRPC",25,0)
 .I +DFN=-1 S RETURN(XX)="-1^NO SUCH ICN "_ICN Q
"RTN","MPIFRPC",26,0)
 .I '$D(^DPT(DFN)) S RETURN(DFN)="-1^BAD AICN X-REF, PT FILE ENTRY DOESN'T EXIST DFN= "_DFN_" ICN= "_ICN Q
"RTN","MPIFRPC",27,0)
 .; check if this data can be returned and if sensative pt bulletin needed
"RTN","MPIFRPC",28,0)
 .N SENS D PTSEC^DGSEC4(.SENS,DFN,1,"Remote Procedure from MPI^RPC from MPI for ICN Information")
"RTN","MPIFRPC",29,0)
 .N NOT D NOTICE^DGSEC4(.NOT,DFN,"Remote Procedure from MPI^RPC from MPI for ICN Information")
"RTN","MPIFRPC",30,0)
 .I SENS(1)=3!(SENS(1)=4)!(SENS(1)=-1) S RETURN(XX)="-1^SENSATIVE PT ISSUE "_SENS(2)_" DFN= "_DFN_" ICN= "_ICN Q
"RTN","MPIFRPC",31,0)
 .I RPC=1 S TEXT="MPI("_DFN_",""DFN"")="
"RTN","MPIFRPC",32,0)
 .S RETURN(DFN,"DFN")=TEXT_""""_DFN_""""
"RTN","MPIFRPC",33,0)
 .S TICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC",34,0)
 .I +TICN<0 D
"RTN","MPIFRPC",35,0)
 ..I RPC=1 S RETURN(DFN,1)="MPI("_DFN_",1)="_""""_"No current ICN"
"RTN","MPIFRPC",36,0)
 ..I RPC=0 S RETURN(DFN,1)="""No Current ICN"
"RTN","MPIFRPC",37,0)
 .I +TICN>0 D
"RTN","MPIFRPC",38,0)
 ..I RPC=1 S RETURN(DFN,"ICN")="MPI("_DFN_",""ICN"")="_""""_TICN_""""
"RTN","MPIFRPC",39,0)
 ..I RPC=0 S RETURN(DFN,"ICN")=""""_TICN_""""
"RTN","MPIFRPC",40,0)
 .S LOCAL=""
"RTN","MPIFRPC",41,0)
 .I $E($G(RETURN(DFN,"ICN")),1,3)=$P($$SITE^VASITE(),"^",3) S LOCAL="Y"
"RTN","MPIFRPC",42,0)
 .I LOCAL=""&(+TICN>0) D
"RTN","MPIFRPC",43,0)
 ..I RPC=1 S RETURN(DFN,1)="MPI("_DFN_",1)="_""""_"NATIONAL ICN"
"RTN","MPIFRPC",44,0)
 ..I RPC=0 S RETURN(DFN,1)=""""_"NATIONAL ICN"
"RTN","MPIFRPC",45,0)
 .I LOCAL="Y"&(+TICN>0) D
"RTN","MPIFRPC",46,0)
 ..I RPC=1 S RETURN(DFN,1)="MPI("_DFN_",1)="_""""_"LOCAL ICN"
"RTN","MPIFRPC",47,0)
 ..I RPC=0 S RETURN(DFN,1)=""""_"LOCAL ICN"_""""
"RTN","MPIFRPC",48,0)
 .S CMOR=$$GETVCCI^MPIF001(DFN)
"RTN","MPIFRPC",49,0)
 .I +CMOR=-1 S CMOR=$P(CMOR,"^",2)
"RTN","MPIFRPC",50,0)
 .I RPC=1 S RETURN(DFN,"CMOR")="MPI("_DFN_",""CMOR"")="""_CMOR_""""
"RTN","MPIFRPC",51,0)
 .I RPC=0 S RETURN(DFN,"CMOR")=""""_CMOR_""""
"RTN","MPIFRPC",52,0)
 .D GETICNH^MPIF002(DFN,.ICNH)
"RTN","MPIFRPC",53,0)
 .I +ICNH=-1 D
"RTN","MPIFRPC",54,0)
 ..I RPC=1 S RETURN(DFN,"ICN HISTORY")="MPI("_DFN_",""ICN HISTORY"")="""_$P(ICNH,"^",2)_""""
"RTN","MPIFRPC",55,0)
 ..I RPC=0 S RETURN(DFN,"ICN HISTORY")=""""_$P(ICNH,"^",2)_""""
"RTN","MPIFRPC",56,0)
 .I +ICNH'=-1 D
"RTN","MPIFRPC",57,0)
 ..M RETURN(DFN,"ICN HISTORY")=ICNH
"RTN","MPIFRPC",58,0)
 ..I RPC=1 D
"RTN","MPIFRPC",59,0)
 ...N IEN
"RTN","MPIFRPC",60,0)
 ...S IEN="" F  S IEN=$O(RETURN(DFN,"ICN HISTORY",IEN)) Q:IEN=""  S RETURN(DFN,"ICN HISTORY",IEN)="MPI("_DFN_",""ICN HISTORY"","_IEN_")="_$G(RETURN(DFN,"ICN HISTORY",IEN))
"RTN","MPIFRPC",61,0)
 ...S RETURN(DFN,"ICN HISTORY")="MPI("_DFN_",""ICN HISTORY"")="_$G(RETURN(DFN,"ICN HISTORY"))
"RTN","MPIFRPC",62,0)
 .;
"RTN","MPIFRPC",63,0)
 .D GETCMORH^MPIF002(DFN,.CMORH)
"RTN","MPIFRPC",64,0)
 .I +CMORH=-1 D
"RTN","MPIFRPC",65,0)
 ..I RPC=1 S RETURN(DFN,"CMOR HISTORY")="MPI("_DFN_",""CMOR HISTORY"")="""_$P(CMORH,"^",2)_""""
"RTN","MPIFRPC",66,0)
 ..I RPC=0 S RETURN(DFN,"CMOR HISTORY")=""""_$P(CMORH,"^",2)_""""
"RTN","MPIFRPC",67,0)
 .I +CMORH'=-1 D
"RTN","MPIFRPC",68,0)
 ..M RETURN(DFN,"CMOR HISTORY")=CMORH
"RTN","MPIFRPC",69,0)
 ..I RPC=1 D
"RTN","MPIFRPC",70,0)
 ...N IEN
"RTN","MPIFRPC",71,0)
 ...S IEN="" F  S IEN=$O(RETURN(DFN,"CMOR HISTORY",IEN)) Q:IEN=""  S RETURN(DFN,"CMOR HISTORY",IEN)="MPI("_DFN_",""CMOR HISTORY"","_IEN_")="_$G(RETURN(DFN,"CMOR HISTORY",IEN))
"RTN","MPIFRPC",72,0)
 ...S RETURN(DFN,"CMOR HISTORY")="MPI("_DFN_",""CMOR HISTORY"")="_$G(RETURN(DFN,"CMOR HISTORY"))
"RTN","MPIFRPC",73,0)
 .;
"RTN","MPIFRPC",74,0)
 .D EXC(DFN,.RETS,XX)
"RTN","MPIFRPC",75,0)
 .I RETS(XX,"EXCEPTIONS")="No Exceptions" D
"RTN","MPIFRPC",76,0)
 ..I RPC=1 S RETURN(DFN,"EXCEPTIONS")="MPI("_DFN_",""EXCEPTIONS"")=""NO EXCEPTIONS""",RETURN(DFN,1)=$G(RETURN(DFN,1))_" with No Exceptions"_""""
"RTN","MPIFRPC",77,0)
 ..I RPC=0 S RETURN(DFN,"EXCEPTIONS")="""NO EXCEPTIONS""",RETURN(DFN,1)=$G(RETURN(DFN,1))_" with No Exceptions"_""""
"RTN","MPIFRPC",78,0)
 .I RETS(XX,"EXCEPTIONS")'="No Exceptions" D
"RTN","MPIFRPC",79,0)
 ..I RPC=1 S RETURN(DFN,1)=$G(RETURN(DFN,1))_" with Exceptions"_"""",RETURN(DFN,"EXCEPTIONS")="MPI("_DFN_",""EXCEPTIONS"")="_""""_$G(RETS(XX,"EXCEPTIONS"))_""""
"RTN","MPIFRPC",80,0)
 ..I RPC=0 S RETURN(DFN,1)=$G(RETURN(DFN,1))_" with Exceptions"_"""",RETURN(DFN,"EXCEPTIONS")=$G(RETS(XX,"EXCEPTIONS"))
"RTN","MPIFRPC",81,0)
 I CNTD>1 D
"RTN","MPIFRPC",82,0)
 .I RPC=1 S RETURN(1,"ICNS PROCESSED")="MPI(""ICNS PROCESSED"")="_""""_CNTD_""""
"RTN","MPIFRPC",83,0)
 .I RPC=0 S RETURN(1,"ICNS PROCESSED")="MPI(""ICNS PROCESSED"")="_CNTD
"RTN","MPIFRPC",84,0)
 Q
"RTN","MPIFRPC",85,0)
EXC(DFN,RET,YY) ;
"RTN","MPIFRPC",86,0)
 ; process exceptions into single value
"RTN","MPIFRPC",87,0)
 N TVAL,IEN
"RTN","MPIFRPC",88,0)
 D GETEX^RGEX03(.VAL,DFN)
"RTN","MPIFRPC",89,0)
 I +VAL(0)=0 S RET(YY,"EXCEPTIONS")="No Exceptions"
"RTN","MPIFRPC",90,0)
 I +VAL(0)'=0 D
"RTN","MPIFRPC",91,0)
 .S IEN=0,TVAL=""
"RTN","MPIFRPC",92,0)
 .F IEN=$O(VAL(IEN)) Q:IEN=""  S TVAL=TVAL_$P($G(VAL(IEN)),"^")_"^"
"RTN","MPIFRPC",93,0)
 .S RET(YY,"EXCEPTIONS")=""""_TVAL_""""
"RTN","MPIFRPC",94,0)
 K VAL
"RTN","MPIFRPC",95,0)
 Q
"RTN","MPIFRPC",96,0)
 ;
"RTN","MPIFRPC",97,0)
INACT(RETURN,ICN) ;
"RTN","MPIFRPC",98,0)
 ;RPC to inactivate the ICN passed.
"RTN","MPIFRPC",99,0)
 ; RETURN - 1 for successful inactivation or -1^error msg
"RTN","MPIFRPC",100,0)
 ; ICN = is the ICN for the patient that is to be inactivated
"RTN","MPIFRPC",101,0)
 ;
"RTN","MPIFRPC",102,0)
 I $G(ICN)="" S RETURN="-1^No ICN Passed" Q
"RTN","MPIFRPC",103,0)
 I +ICN<1 S RETURN="-1^Invalid ICN" Q
"RTN","MPIFRPC",104,0)
 N DFN,TICN,ER
"RTN","MPIFRPC",105,0)
 S DFN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFRPC",106,0)
 I +DFN<0 S RETURN="-1^No such ICN" Q
"RTN","MPIFRPC",107,0)
 S TICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC",108,0)
 I +TICN'=+ICN S RETURN="-1^ICN is not active" Q
"RTN","MPIFRPC",109,0)
 D PAT^MPIFDEL(DFN,.ER)
"RTN","MPIFRPC",110,0)
 I ER'="" S RETURN="-1^"_ER Q
"RTN","MPIFRPC",111,0)
 S RETURN=1
"RTN","MPIFRPC",112,0)
 Q
"RTN","MPIFRPC",113,0)
 ;
"RTN","MPIFRPC",114,0)
RCCMOR(RETURN,ICN,CMOR,SSN,A08) ;
"RTN","MPIFRPC",115,0)
 ;RPC to change the CMOR value to CMOR for patient with ICN value ICN
"RTN","MPIFRPC",116,0)
 ; RETURN - array to return 1 for successful update or -1^ERROR MSG
"RTN","MPIFRPC",117,0)
 ; ICN = ICN for the patient that the CMOR is to be changed for
"RTN","MPIFRPC",118,0)
 ; CMOR = Station Number of the site that should become the CMOR
"RTN","MPIFRPC",119,0)
 ; SSN = Social Security Number of the patient involved, to be used if 
"RTN","MPIFRPC",120,0)
 ;      ICN is not found due to bad AICN x-ref
"RTN","MPIFRPC",121,0)
 ; A08 = 1 means trigger A08 message, 0 means don't send A08 msg
"RTN","MPIFRPC",122,0)
 ;
"RTN","MPIFRPC",123,0)
 I $G(ICN)=""!($G(CMOR)="") S RETURN="-1^Missing Required fields" Q
"RTN","MPIFRPC",124,0)
 N DFN,CIEN,DFNS
"RTN","MPIFRPC",125,0)
 S DFN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFRPC",126,0)
 I DFN'>0&($G(SSN)="") S RETURN(1)="-1^Unknown ICN" Q
"RTN","MPIFRPC",127,0)
 I DFN'>0 D
"RTN","MPIFRPC",128,0)
 .Q:'$D(^DPT("SSN",SSN))
"RTN","MPIFRPC",129,0)
 .S DFNS=$$GETDFNS^MPIF002(SSN)
"RTN","MPIFRPC",130,0)
 .S DFN=$$CHK(DFNS,ICN)
"RTN","MPIFRPC",131,0)
 I DFN'>0!(+ICN=-1) S RETURN(1)="-1^Unknown ICN" Q
"RTN","MPIFRPC",132,0)
 S CIEN=$$IEN^XUAF4(CMOR)
"RTN","MPIFRPC",133,0)
 I CIEN'>0 S RETURN(1)="-1^Unknown Institution" Q
"RTN","MPIFRPC",134,0)
 S RETURN(1)=$$CHANGE^MPIF001(DFN,CIEN)
"RTN","MPIFRPC",135,0)
 I A08=1 D AVAFC^VAFCDD01(DFN) ; trigger A08 msg
"RTN","MPIFRPC",136,0)
 I A08=1 S RETURN(1)=RETURN(1)_"^and A08 triggered"
"RTN","MPIFRPC",137,0)
 ;trigger a08
"RTN","MPIFRPC",138,0)
 Q
"RTN","MPIFRPC",139,0)
 ;
"RTN","MPIFRPC",140,0)
CHK(DFNS,ICN) ; see if had broken AICN x-ref, if so, fix it and return 
"RTN","MPIFRPC",141,0)
 ; correct DFN for patient that's CMOR is to be changed.
"RTN","MPIFRPC",142,0)
 ;
"RTN","MPIFRPC",143,0)
 N IEN,NODE,NXT,FOUND,DFN
"RTN","MPIFRPC",144,0)
 S FOUND=0
"RTN","MPIFRPC",145,0)
 F NXT=1:1 S IEN=$P(DFNS,"^",NXT) Q:IEN=""!(FOUND=1)  D
"RTN","MPIFRPC",146,0)
 .S NODE=$$MPINODE^MPIFAPI(NXT)
"RTN","MPIFRPC",147,0)
 .I $P(NODE,"^")=ICN S FOUND=1,^DPT("AICN",ICN,IEN)="",DFN=IEN
"RTN","MPIFRPC",148,0)
 I FOUND=0 Q "-1^No such ICN"
"RTN","MPIFRPC",149,0)
 Q DFN
"RTN","MPIFRPC2")
0^7^B12614271
"RTN","MPIFRPC2",1,0)
MPIFRPC2 ;SFCIO/CMC-MPIF RPC APIS ;24 OCT 01
"RTN","MPIFRPC2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20**;30 Apr 99
"RTN","MPIFRPC2",3,0)
 ;
"RTN","MPIFRPC2",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFRPC2",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFRPC2",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFRPC2",7,0)
 ;  AVAFC^VAFCDD01 - #3493
"RTN","MPIFRPC2",8,0)
 ;  $$SEND2^VAFCUTL1 - #2779    
"RTN","MPIFRPC2",9,0)
 ;
"RTN","MPIFRPC2",10,0)
SPI(RETURN,SSN,DFN1) ;
"RTN","MPIFRPC2",11,0)
 ;RPC to Single Patient Initialization on patient with SSN
"RTN","MPIFRPC2",12,0)
 ; RETURN - 1 for successful inactivation or -1^error msg
"RTN","MPIFRPC2",13,0)
 ; SSN = is the SSN for the patient that is to be SPI'd
"RTN","MPIFRPC2",14,0)
 ; DFN1 = is the IEN for the patient that is to be SPI'd
"RTN","MPIFRPC2",15,0)
 ;
"RTN","MPIFRPC2",16,0)
 N RES,XX,DFN,ICN,TICN,MPIFA
"RTN","MPIFRPC2",17,0)
 I SSN=""&($G(DFN1)="") S RETURN="-1^No SSN or DFN Passed" Q
"RTN","MPIFRPC2",18,0)
 I SSN'="",SSN'?9N S RETURN="-1^Invalid SSN" Q
"RTN","MPIFRPC2",19,0)
 I SSN'="",'$D(^DPT("SSN",SSN)) S RETURN="-1^No such SSN" Q
"RTN","MPIFRPC2",20,0)
 I SSN'="" D
"RTN","MPIFRPC2",21,0)
 .S RETURN(0)="SSN USED "_SSN
"RTN","MPIFRPC2",22,0)
 .S RES=$$GETDFNS^MPIF002(SSN)
"RTN","MPIFRPC2",23,0)
 I SSN="",DFN1'?1N.N S RETURN="-1^Invalid DFN" Q
"RTN","MPIFRPC2",24,0)
 I SSN="",'$D(^DPT(DFN1,0)) S RETURN="-1^No such DFN" Q
"RTN","MPIFRPC2",25,0)
 I SSN="" D
"RTN","MPIFRPC2",26,0)
 .S RETURN(0)="DFN USED "_DFN1
"RTN","MPIFRPC2",27,0)
 .S RES=DFN1
"RTN","MPIFRPC2",28,0)
 I +RES=-1 S RETURN=RES Q
"RTN","MPIFRPC2",29,0)
 F XX=1:1 S DFN=$P(RES,"^",XX) Q:DFN=""  D
"RTN","MPIFRPC2",30,0)
 .; can be multiple entries with same SSN
"RTN","MPIFRPC2",31,0)
 .S TICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC2",32,0)
 .I +TICN'=-1&($P($$SITE^VASITE,"^",3)'=$E(TICN,1,3)) S RETURN(XX,0)="DFN= "_DFN_" already has an ICN, ICN="_TICN Q
"RTN","MPIFRPC2",33,0)
 .S MPIFS=1,HLP("ACKTIME")=300,MPIFRES=1,MPIFRPC=1
"RTN","MPIFRPC2",34,0)
 .I +$$SEND2^VAFCUTL1(DFN,"T")=1 S RETURN(XX,0)="DFN "_DFN_" Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" Q
"RTN","MPIFRPC2",35,0)
 .D GETS^DIQ(2,DFN_",",".01","IE","MPIFA")
"RTN","MPIFRPC2",36,0)
 .I $E(MPIFA(2,DFN_",",.01,"E"),1,3)="EEE" S RETURN(XX,0)="DFN "_DFN_" Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" Q
"RTN","MPIFRPC2",37,0)
 .D CIRNEXC^MPIFQ0
"RTN","MPIFRPC2",38,0)
 .K MPIFS,MPIFRES,MPIFRPC
"RTN","MPIFRPC2",39,0)
 .S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC2",40,0)
 .I +ICN=-1 S RETURN(XX,0)="DFN "_DFN_" problem getting ICN assinged "_$P(ICN,"^",2),RETURN="-1^Unable to get ICN" Q
"RTN","MPIFRPC2",41,0)
 .K RET S RET=""
"RTN","MPIFRPC2",42,0)
 .I $P($$SITE^VASITE,"^",3)=$E(+ICN,1,3) D  Q
"RTN","MPIFRPC2",43,0)
 ..D EXC^MPIFRPC(DFN,.RET,XX)
"RTN","MPIFRPC2",44,0)
 ..S RET(XX,"EXCEPTIONS")=$TR($G(RET(XX,"EXCEPTIONS")),"""","")
"RTN","MPIFRPC2",45,0)
 ..S RETURN(XX,0)="DFN "_DFN_" Local ICN assigned "_ICN_" EXCEPTIONS: "_$G(RET(XX,"EXCEPTIONS")),RETURN="-1^Local ICN assigned" Q
"RTN","MPIFRPC2",46,0)
 .S RETURN(XX)=ICN
"RTN","MPIFRPC2",47,0)
 Q
"RTN","MPIFRPC2",48,0)
 ;
"RTN","MPIFRPC2",49,0)
UPDATE(RET,SSN,ICN,CHK,CMOR,A08) ;
"RTN","MPIFRPC2",50,0)
 ; update fields 991.01,991.02 and 991.03 remotely
"RTN","MPIFRPC2",51,0)
 I SSN=""!(ICN="")!(CHK="")!(CMOR="") S RET="-1^Missing required parameter" Q
"RTN","MPIFRPC2",52,0)
 I '$D(^DPT("SSN",SSN)) S RET="-1^No patient has that SSN at this site" Q
"RTN","MPIFRPC2",53,0)
 N DFN,MPIFA,TMP
"RTN","MPIFRPC2",54,0)
 S DFN=$O(^DPT("SSN",SSN,""))
"RTN","MPIFRPC2",55,0)
 I $O(^DPT("SSN",SSN,DFN))'="" S RET="-1^More than one patient has that SSN at this site" Q
"RTN","MPIFRPC2",56,0)
 S TMP=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFRPC2",57,0)
 I +TMP'=-1,$E(TMP,1,3)'=$P($$SITE^VASITE(),"^",3) S RET="-1^Patient has a national ICN, ICN="_TMP Q
"RTN","MPIFRPC2",58,0)
 S MPIFA(991.01)=ICN,MPIFA(991.02)=CHK,MPIFA(991.03)=$$LKUP^XUAF4(CMOR)
"RTN","MPIFRPC2",59,0)
 S RET=$$UPDATE^MPIFAPI(DFN,"MPIFA")
"RTN","MPIFRPC2",60,0)
 D FILE^VAFCTFU(DFN,+$$SITE^VASITE) ; update tf list
"RTN","MPIFRPC2",61,0)
 I A08=1 D AVAFC^VAFCDD01(DFN) ; trigger A08 msg
"RTN","MPIFRPC2",62,0)
 I A08=1 S RET=RET_"^and A08 triggered"
"RTN","MPIFRPC2",63,0)
 Q
"VER")
8.0^22.0
**END**
**END**
