Released PSO*7*212 SEQ #194
Extracted from mail message
**KIDS**:PSO*7.0*212^

**INSTALL NAME**
PSO*7.0*212
"BLD",6397,0)
PSO*7.0*212^OUTPATIENT PHARMACY^0^3050914^y
"BLD",6397,1,0)
^^2^2^3050822^
"BLD",6397,1,1,0)
PREVENT THE Monthly Rx Cost Compilation OPTION FROM RUNNING MORE THAN 
"BLD",6397,1,2,0)
ONCE CON-CURRENTLY USING VARIBALE LOCKING TECHNIQUES.
"BLD",6397,4,0)
^9.64PA^^
"BLD",6397,"KRN",0)
^9.67PA^8989.52^19
"BLD",6397,"KRN",.4,0)
.4
"BLD",6397,"KRN",.401,0)
.401
"BLD",6397,"KRN",.402,0)
.402
"BLD",6397,"KRN",.403,0)
.403
"BLD",6397,"KRN",.5,0)
.5
"BLD",6397,"KRN",.84,0)
.84
"BLD",6397,"KRN",3.6,0)
3.6
"BLD",6397,"KRN",3.8,0)
3.8
"BLD",6397,"KRN",9.2,0)
9.2
"BLD",6397,"KRN",9.8,0)
9.8
"BLD",6397,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",6397,"KRN",9.8,"NM",1,0)
PSOCSTD^^0^34971214
"BLD",6397,"KRN",9.8,"NM",2,0)
PSOCSTM^^0^44070535
"BLD",6397,"KRN",9.8,"NM","B","PSOCSTD",1)

"BLD",6397,"KRN",9.8,"NM","B","PSOCSTM",2)

"BLD",6397,"KRN",19,0)
19
"BLD",6397,"KRN",19.1,0)
19.1
"BLD",6397,"KRN",101,0)
101
"BLD",6397,"KRN",409.61,0)
409.61
"BLD",6397,"KRN",771,0)
771
"BLD",6397,"KRN",870,0)
870
"BLD",6397,"KRN",8989.51,0)
8989.51
"BLD",6397,"KRN",8989.52,0)
8989.52
"BLD",6397,"KRN",8994,0)
8994
"BLD",6397,"KRN","B",.4,.4)

"BLD",6397,"KRN","B",.401,.401)

"BLD",6397,"KRN","B",.402,.402)

"BLD",6397,"KRN","B",.403,.403)

"BLD",6397,"KRN","B",.5,.5)

"BLD",6397,"KRN","B",.84,.84)

"BLD",6397,"KRN","B",3.6,3.6)

"BLD",6397,"KRN","B",3.8,3.8)

"BLD",6397,"KRN","B",9.2,9.2)

"BLD",6397,"KRN","B",9.8,9.8)

"BLD",6397,"KRN","B",19,19)

"BLD",6397,"KRN","B",19.1,19.1)

"BLD",6397,"KRN","B",101,101)

"BLD",6397,"KRN","B",409.61,409.61)

"BLD",6397,"KRN","B",771,771)

"BLD",6397,"KRN","B",870,870)

"BLD",6397,"KRN","B",8989.51,8989.51)

"BLD",6397,"KRN","B",8989.52,8989.52)

"BLD",6397,"KRN","B",8994,8994)

"BLD",6397,"QUES",0)
^9.62^^
"BLD",6397,"REQB",0)
^9.611^1^1
"BLD",6397,"REQB",1,0)
PSO*7.0*198^2
"BLD",6397,"REQB","B","PSO*7.0*198",1)

"MBREQ")
0
"PKG",134,-1)
1^1
"PKG",134,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",134,20,0)
^9.402P^^
"PKG",134,22,0)
^9.49I^1^1
"PKG",134,22,1,0)
7.0^2971216^2980417^1271
"PKG",134,22,1,"PAH",1,0)
212^3050914^33255
"PKG",134,22,1,"PAH",1,1,0)
^^2^2^3050914
"PKG",134,22,1,"PAH",1,1,1,0)
PREVENT THE Monthly Rx Cost Compilation OPTION FROM RUNNING MORE THAN 
"PKG",134,22,1,"PAH",1,1,2,0)
ONCE CON-CURRENTLY USING VARIBALE LOCKING TECHNIQUES.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOCSTD")
0^1^B34971214
"RTN","PSOCSTD",1,0)
PSOCSTD ;BHAM ISC/SAB - daily rx cost compilation ;9/14/05 1:13pm
"RTN","PSOCSTD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,17,28,89,198,212**;DEC 1997
"RTN","PSOCSTD",3,0)
 ;External Ref to ^DPT DBIA# 10035
"RTN","PSOCSTD",4,0)
 ;External Ref to ^PS(55 DBIA# 2228
"RTN","PSOCSTD",5,0)
 ;External Ref to ^PSDRUG DBIA# 221
"RTN","PSOCSTD",6,0)
 ;
"RTN","PSOCSTD",7,0)
 ;PSO*198 correct For loops to begin on the previous day @ time 999999
"RTN","PSOCSTD",8,0)
 ;PSO*212 quit if it is the 1st day & monthly compile is running
"RTN","PSOCSTD",9,0)
 ;
"RTN","PSOCSTD",10,0)
 I $E(DT,6,7)="01",$$MTHLCK^PSOCSTM(0) Q                      ;PSO*212
"RTN","PSOCSTD",11,0)
 K BEGDATE,ENDDATE S %DT(0)=$E(DT,1,5)_"00"
"RTN","PSOCSTD",12,0)
 W !!,"**** Date Range Selection ****" I '$O(^PS(59,0)) W $C(7),!,"PLEASE ENTER SITE PARAMETERS !!",!,$C(7) G EX
"RTN","PSOCSTD",13,0)
BEG W ! S %DT="APE",%DT("A")="   Beginning DATE : " D ^%DT G:"^"[X EX G:Y<0 BEG S (%DT(0),BEGDATE)=Y
"RTN","PSOCSTD",14,0)
EN W ! S %DT="APE",%DT("A")="   Ending    DATE : " D ^%DT K %DT G:"^"[X EX G:Y<0 EN W ! S ENDDATE=Y
"RTN","PSOCSTD",15,0)
 S ZTIO="",ZTRTN="START^PSOCSTD",ZTDESC="Rx Daily Cost Compile" F G="BEGDATE","ENDDATE" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOCSTD",16,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"Task #"_ZTSK_" Queued !" K G,BEGDATE,ENDDATE,ZTSAVE,ZTIO,ZTSK,ZTRTN,ZTDESC Q
"RTN","PSOCSTD",17,0)
START K ^TMP($J) G:$E(DT,6,7)="01" MTH
"RTN","PSOCSTD",18,0)
 I '$D(BEGDATE)!('$D(ENDDATE)) S X1=DT,X2=-1 D C^%DTC S (BEGDATE,ENDDATE)=X
"RTN","PSOCSTD",19,0)
 K BDT S PSG=0 F I=1:1 S X=$T(G+I) Q:$P(X,";",3)=""  S PSOA(I)=$P(X,";",3),PSOB(I)=$P(X,";",4),PSG=PSG+1,PSOA1(I)=$P(X,";",5),PSOB1(I)=$P(X,";",6)
"RTN","PSOCSTD",20,0)
 S PSD=0 F I=1:1 S X=$T(D+I) Q:X=""  S PSOC(I)=$P(X,";",3),PSOD(I)=$P(X,";",4),PSD=PSD+1,PSOC1(I)=$P(X,";",5),PSOD1(I)=$P(X,";",6)
"RTN","PSOCSTD",21,0)
 F PSDT=BEGDATE:1:ENDDATE K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTD",22,0)
 S (TNR,TNO,TNP)=0
"RTN","PSOCSTD",23,0)
 ;PSO*198 fix begin value of $O loops
"RTN","PSOCSTD",24,0)
SRCH S PSDT=BEGDATE-1+.999999 F  S PSDT=$O(^PSRX("AL",PSDT)) Q:'PSDT!($E(PSDT,1,7)>ENDDATE)  S (OR,RF)=0 D SRCH1 S:'$D(BDT) BDT=PSDT
"RTN","PSOCSTD",25,0)
 S PSDT=BEGDATE-1+.999999 F  S PSDT=$O(^PSRX("AM",PSDT)) Q:'PSDT!($E(PSDT,1,7)>ENDDATE)  D SRCH2 S:'$D(BDT) BDT=PSDT
"RTN","PSOCSTD",26,0)
 S PSOCNT=0 F PSDT=0:0 S PSDT=$O(^PSCST("B",PSDT)) Q:'PSDT  S PSD=PSDT,PSOCNT=PSOCNT+1
"RTN","PSOCSTD",27,0)
 S ^PSCST(0)="DRUG COST^50.9D^"_PSD_"^"_PSOCNT,EDT=ENDDATE
"RTN","PSOCSTD",28,0)
 F PSDT=BEGDATE:1:ENDDATE F II=2:1:7 S:$D(^PSCST(PSDT,0)) $P(^PSCST(PSDT,0),"^",II)=0
"RTN","PSOCSTD",29,0)
 S PSDT=BEGDATE-1 F  S PSDT=$O(^PSCST(PSDT)) Q:'PSDT!(PSDT>ENDDATE)  D
"RTN","PSOCSTD",30,0)
 .S DRG=0  F  S DRG=$O(^PSCST(PSDT,"D",DRG)) Q:'DRG  S DRC=^PSCST(PSDT,"D",DRG,0) D
"RTN","PSOCSTD",31,0)
 ..F II=2:1:7 S $P(^PSCST(PSDT,0),"^",II)=$P(^PSCST(PSDT,0),"^",II)+$P(DRC,"^",II)
"RTN","PSOCSTD",32,0)
 S PSDT=0 F  S PSDT=$O(^TMP($J,"PAT",PSDT)) Q:'PSDT  D SDFN
"RTN","PSOCSTD",33,0)
 D:$D(BDT) ZNODE^PSOCSTM
"RTN","PSOCSTD",34,0)
EX K ^TMP($J),FL,%DT,A,B,BEGDATE,COST,DATA,DATA1,DATA2,DRUG,DFN,ENDDATE,I,II,ML,OR,PAST,PHYS,PSOCNT,DIV,PSD,PSDT,PSFILL,PSG,QTY,RF,RX0
"RTN","PSOCSTD",35,0)
 K RXF,PAR,NDZ1,NDZ2,BDT,D,CLINIC,RX1,RX2,RXN,C,VALUE,VISITS,WD,X,X1,X2,Y,BDT,EDT,PSOA1,PSOB1,PSOC1,PSOD1,PSOC
"RTN","PSOCSTD",36,0)
 K TDFN,TDIV S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCSTD",37,0)
 L -^PSOCSTM                                                  ;PSO*212
"RTN","PSOCSTD",38,0)
 Q
"RTN","PSOCSTD",39,0)
SDFN S (TDFN,DIV)=0 F  S DIV=$O(^TMP($J,"PAT",PSDT,DIV)) Q:'DIV  D SDFN1
"RTN","PSOCSTD",40,0)
 S ^PSCST(PSDT,1)=DT_"^"_TDFN Q
"RTN","PSOCSTD",41,0)
SDFN1 S (DFN,TDIV)=0 F  S DFN=$O(^TMP($J,"PAT",PSDT,DIV,DFN)) Q:'DFN  S TDIV=TDIV+1,TDFN=TDFN+1
"RTN","PSOCSTD",42,0)
 S $P(^PSCST(PSDT,"V",DIV,0),"^",8)=TDIV Q
"RTN","PSOCSTD",43,0)
SRCH1 S RXF="" F RXN=0:0 S RXN=$O(^PSRX("AL",PSDT,RXN)) Q:'RXN  F  S RXF=$O(^PSRX("AL",PSDT,RXN,RXF)) Q:RXF=""  S PAR=0 D CHK S (OR,RF)=0
"RTN","PSOCSTD",44,0)
 Q
"RTN","PSOCSTD",45,0)
SRCH2 S (RXN,RXF)=0 F  S RXN=$O(^PSRX("AM",PSDT,RXN)) Q:'RXN  F  S RXF=$O(^PSRX("AM",PSDT,RXN,RXF)) Q:'RXF  S PAR=1 D CHK S (OR,RF)=0
"RTN","PSOCSTD",46,0)
 Q
"RTN","PSOCSTD",47,0)
CHK Q:'$D(^PSRX(RXN,0))  I '$D(^PSRX(RXN,2)) Q
"RTN","PSOCSTD",48,0)
 S RX0=^PSRX(RXN,0) S RX2=^PSRX(RXN,2)
"RTN","PSOCSTD",49,0)
 S DFN=+$P(RX0,"^",2) Q:'$D(^DPT(DFN,0))  D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOCSTD",50,0)
 S DRUG=+$P(RX0,"^",6) Q:'$D(^PSDRUG(DRUG,0))
"RTN","PSOCSTD",51,0)
 ;S CLASS=+$P(^(0),"^",2) Q:'$D(^PS(50.605,CLASS,0))
"RTN","PSOCSTD",52,0)
 S DIV=+$P(RX2,"^",9) Q:'$D(^PS(59,DIV,0))
"RTN","PSOCSTD",53,0)
 S PHYS=+$P(RX0,"^",4) Q:'$D(^VA(200,PHYS,0))  S PAST=+$P(RX0,"^",3) Q:'$D(^PS(53,PAST,0))
"RTN","PSOCSTD",54,0)
 S CLINIC=+$P(RX0,"^",5) K:'$D(^SC(CLINIC,0)) CLINIC
"RTN","PSOCSTD",55,0)
 S COST=$S(+$P(RX0,"^",17):+$P(RX0,"^",17),$D(^PSDRUG(DRUG,660)):+$P(^(660),"^",6),1:0)
"RTN","PSOCSTD",56,0)
 S QTY=+$P(RX0,"^",7),ML=$S($P(RX0,"^",11)="M":1,1:0),WD=$S($P(RX0,"^",11)="W":1,1:0)
"RTN","PSOCSTD",57,0)
 I $G(PAR) D  S PR=0 Q
"RTN","PSOCSTD",58,0)
 .I '$D(^PSRX(RXN,"P",RXF,0)) K ^PSRX("AM",PSDT,RXN,RXF) Q
"RTN","PSOCSTD",59,0)
 .I $P(^PSRX(RXN,"P",RXF,0),"^",19) S RF=0,RX1=^PSRX(RXN,"P",RXF,0),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9)) D SET,REF S TNP=TNP+1
"RTN","PSOCSTD",60,0)
 I $P(RX2,"^",13),'RXF S OR=OR+1,COST=QTY*COST D SET,SF S TNO=TNO+1 Q
"RTN","PSOCSTD",61,0)
 D:RXF
"RTN","PSOCSTD",62,0)
 .I '$D(^PSRX(RXN,1,RXF,0)) K ^PSRX("AL",PSDT,RXN,RXF) Q
"RTN","PSOCSTD",63,0)
 .I $P(^PSRX(RXN,1,RXF,0),"^",18) S RF=0,RX1=^PSRX(RXN,1,RXF,0),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9)) D SET,REF S TNR=TNR+1
"RTN","PSOCSTD",64,0)
 Q
"RTN","PSOCSTD",65,0)
SF S DATA="^"_OR_"^"_RF_"^"_COST_"^"_QTY_"^"_ML_"^"_WD
"RTN","PSOCSTD",66,0)
 S:'$D(^TMP($J,"PAT",$P(PSDT,"."),DIV,DFN)) ^TMP($J,"PAT",$P(PSDT,"."),DIV,DFN)=""
"RTN","PSOCSTD",67,0)
 F I=1:1:PSG Q:('$D(CLINIC))&(I=PSG)  S DATA1=$S(($D(@(PSOA(I)))#2):^(0),1:@(PSOB(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTD",68,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @PSOA(I)=DATA2
"RTN","PSOCSTD",69,0)
 .S:'$D(@PSOA1(I)) @PSOA1(I)=PSOB1(I) S $P(@PSOA1(I),"^",4)=+$P(@PSOA1(I),"^",4)+1,$P(@PSOA1(I),"^",3)=@PSOB(I)
"RTN","PSOCSTD",70,0)
 F I=1:1:PSD S DATA1=$S(($D(@(PSOC(I)))#2):$G(^(0)),1:@(PSOD(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTD",71,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @PSOC(I)=DATA2 D
"RTN","PSOCSTD",72,0)
 .S:'$D(@PSOC1(I)) @PSOC1(I)=PSOD1(I) S $P(@PSOC1(I),"^",4)=+$P(@PSOC1(I),"^",4)+1,$P(@PSOC1(I),"^",3)=@PSOD(I)
"RTN","PSOCSTD",73,0)
 Q
"RTN","PSOCSTD",74,0)
SET S ^PSCST($P(PSDT,"."),0)=$P(PSDT,"."),^PSCST("B",$P(PSDT,"."),$P(PSDT,"."))="" Q
"RTN","PSOCSTD",75,0)
 ;
"RTN","PSOCSTD",76,0)
MTH S X1=DT,X2=-1 D C^%DTC S (BDT,EDT)=$E(X,1,5)_"00"
"RTN","PSOCSTD",77,0)
 F PSDT=(BDT+1):1:X K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTD",78,0)
 D START^PSOCSTM G EX
"RTN","PSOCSTD",79,0)
 Q
"RTN","PSOCSTD",80,0)
REF S OR=0,COST=$S(+$P(RX1,"^",11):+$P(RX1,"^",11),$D(^PSDRUG(DRUG,660)):+$P(^(660),"^",6),1:0)
"RTN","PSOCSTD",81,0)
 S RF=RF+1,QTY=+$P(RX1,"^",4),ML=$S($P(RX1,"^",2)="M":1,1:0),WD=$S($P(RX1,"^",2)="W":1,1:0) S COST=QTY*COST
"RTN","PSOCSTD",82,0)
 S PHYS=$S($P(RX1,"^",17):$P(RX1,"^",17),1:$P(RX0,"^",4)) D SF
"RTN","PSOCSTD",83,0)
 Q
"RTN","PSOCSTD",84,0)
 ;
"RTN","PSOCSTD",85,0)
G ;;
"RTN","PSOCSTD",86,0)
 ;;^PSCST($P(PSDT,"."),0);PSDT;^TMP($J,"A1");1
"RTN","PSOCSTD",87,0)
 ;;^PSCST($P(PSDT,"."),"P",PHYS,0);PHYS;^PSCST($P(PSDT,"."),"P",0);^50.9001PA^^
"RTN","PSOCSTD",88,0)
 ;;^PSCST($P(PSDT,"."),"P",PHYS,"D",DRUG,0);DRUG;^PSCST($P(PSDT,"."),"P",PHYS,"D",0);^50.9002PA^^
"RTN","PSOCSTD",89,0)
 ;;^PSCST($P(PSDT,"."),"D",DRUG,0);DRUG;^PSCST($P(PSDT,"."),"D",0);^50.9003PA^^
"RTN","PSOCSTD",90,0)
 ;;^PSCST($P(PSDT,"."),"D",DRUG,"P",PHYS,0);PHYS;^PSCST($P(PSDT,"."),"D",DRUG,"P",0);^50.9004PA^^
"RTN","PSOCSTD",91,0)
 ;;^PSCST($P(PSDT,"."),"PS",PAST,0);PAST;^PSCST($P(PSDT,"."),"PS",0);^50.9005PA^^
"RTN","PSOCSTD",92,0)
 ;;^PSCST($P(PSDT,"."),"S",CLINIC,0);CLINIC;^PSCST($P(PSDT,"."),"S",0);^50.9008PA^^
"RTN","PSOCSTD",93,0)
 ;;
"RTN","PSOCSTD",94,0)
D ;;
"RTN","PSOCSTD",95,0)
 ;;^PSCST($P(PSDT,"."),"V",DIV,0);DIV;^PSCST($P(PSDT,"."),"V",0);^50.9006PA^^
"RTN","PSOCSTD",96,0)
 ;;^PSCST($P(PSDT,"."),"V",DIV,"D",DRUG,0);DRUG;^PSCST($P(PSDT,"."),"V",DIV,"D",0);^50.9007PA^^
"RTN","PSOCSTD",97,0)
 ;;^PSCST($P(PSDT,"."),"V",DIV,"P",PHYS,0);PHYS;^PSCST($P(PSDT,"."),"V",DIV,"P",0);^50.901PA^^
"RTN","PSOCSTM")
0^2^B44070535
"RTN","PSOCSTM",1,0)
PSOCSTM ;BHAM ISC/SAB - monthly rx cost compilation ;9/14/05 1:13pm
"RTN","PSOCSTM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,17,19,28,89,212**;DEC 1997
"RTN","PSOCSTM",3,0)
 ;External Ref. to ^PS(55 DBIA# 2228
"RTN","PSOCSTM",4,0)
 ;External Ref. to ^DPT DBIA# 10035
"RTN","PSOCSTM",5,0)
 ;External Ref. to ^PSDRUG DBIA# 221
"RTN","PSOCSTM",6,0)
 ;
"RTN","PSOCSTM",7,0)
 ;PSO*212 don't allow this request, if monthly compile is running
"RTN","PSOCSTM",8,0)
 ;
"RTN","PSOCSTM",9,0)
 Q:$$MTHLCK(1)            ;get lock, quit if already locked    PSO*212
"RTN","PSOCSTM",10,0)
 K BDT,EDT W !!,"**** Date Range Selection ****" S LATE=$E(DT,1,5)_"00"
"RTN","PSOCSTM",11,0)
BEG W ! S %DT="APE",%DT("A")="   Beginning MONTH/YEAR : " D ^%DT G:Y<0 Q W:Y'<LATE !!,$C(7),"Run 'DAILY' compilation routine for selected month!",! G:Y'<LATE BEG I (+$E(Y,6,7)'=0)!(+$E(Y,4,5)=0) D QUES G BEG
"RTN","PSOCSTM",12,0)
 S BDT=Y
"RTN","PSOCSTM",13,0)
END S %DT(0)=BDT W ! S %DT="APE",%DT("A")="   Ending    MONTH/YEAR : " D ^%DT K %DT G:Y<0 Q W:Y'<LATE !!,$C(7),"Run 'DAILY' compilation routine for selected month!",! G:Y'<LATE END I (+$E(Y,6,7)'=0)!(+$E(Y,4,5)=0) D QUES G END
"RTN","PSOCSTM",14,0)
 W ! S EDT=Y
"RTN","PSOCSTM",15,0)
 S ZTIO="",ZTRTN="START^PSOCSTM",ZTDESC="Rx Monthly Cost Compile" F G="EDT","BDT" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOCSTM",16,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"Task #"_ZTSK_" Queued!" K G,BDT,EDT,ZTSAVE,ZTIO,ZTRTN,ZTDESC Q
"RTN","PSOCSTM",17,0)
 L -^PSOCSTM                                    ;unlock month end flag
"RTN","PSOCSTM",18,0)
 ;
"RTN","PSOCSTM",19,0)
START Q:$$MTHLCK^PSOCSTM(1)      ;get lock, quit if already locked  PSO*212
"RTN","PSOCSTM",20,0)
 K ^TMP($J) S PSG=0 F I=1:1 S X=$T(G+I) Q:$P(X,";",3)=""  S A(I)=$P(X,";",3),B(I)=$P(X,";",4),PSG=PSG+1,A1(I)=$P(X,";",5),B1(I)=$P(X,";",6)
"RTN","PSOCSTM",21,0)
 S PSD=0 F I=1:1 S X=$T(D+I) Q:X=""  S C(I)=$P(X,";",3),D(I)=$P(X,";",4),PSD=PSD+1,C1(I)=$P(X,";",5),D1(I)=$P(X,";",6)
"RTN","PSOCSTM",22,0)
 F PSDT=BDT:100:EDT K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTM",23,0)
 S STOP=$E(EDT,1,5)_"31.2359",PSDT=BDT F  S PSDT=$O(^PSCST(PSDT)) Q:'PSDT!(PSDT>STOP)  K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTM",24,0)
 K STOP
"RTN","PSOCSTM",25,0)
 ;
"RTN","PSOCSTM",26,0)
SRCH F PSDT=BDT:100:EDT S PSDTX=PSDT+100 D:$E(PSDT,4,5)<13 SRCH1,SET1 S:$E(PSDT,4,5)>12 PSDT=$E(PSDT,1,2)_($E(PSDT,3)+1)_"0000"
"RTN","PSOCSTM",27,0)
 S PSOCNT=0 F PSDT=0:0 S PSDT=$O(^PSCST("B",PSDT)) Q:'PSDT  S PSD=PSDT,PSOCNT=PSOCNT+1
"RTN","PSOCSTM",28,0)
 S ^PSCST(0)="DRUG COST^50.9D^"_PSD_"^"_PSOCNT D ZNODE
"RTN","PSOCSTM",29,0)
Q K ^TMP($J),%DT,A,B,BDT,COST,DATA,DATA1,DATA2,DRG,DFN,EDT,I,II,LATE,ML,OR,PAST,PHYS,PSOCNT,PSD,PSDT,PSDT1,PSDTX,RXF,PSG,QTY,RF,RX0
"RTN","PSOCSTM",30,0)
 K RX2,DIV,D,C,CLINIC,A1,B1,C1,D1,RX1,RXN,VAL,VAR,PGM,VALUE,CDT,NDT,VISITS,DV,VIS,WD,X,X1,X2,Y S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCSTM",31,0)
 L -^PSOCSTM                                    ;unlock month end flag
"RTN","PSOCSTM",32,0)
 Q
"RTN","PSOCSTM",33,0)
 ;
"RTN","PSOCSTM",34,0)
SRCH1 D INI F PSDT1=PSDT:0:PSDTX S PSDT1=$O(^PSRX("AL",PSDT1)) Q:'PSDT1!($E(PSDT1,1,7)>PSDTX)  D
"RTN","PSOCSTM",35,0)
 .S CDT=$P(PSDT1,".") F RXN=0:0 S RXN=$O(^PSRX("AL",PSDT1,RXN)) Q:'RXN  S RXF="" F  S RXF=$O(^PSRX("AL",PSDT1,RXN,RXF)) Q:RXF=""  D CHK
"RTN","PSOCSTM",36,0)
 .S NDT=$O(^PSRX("AL",PSDT1)) D:$P(NDT,".")'=CDT VST
"RTN","PSOCSTM",37,0)
 F PSDT1=PSDT:0:PSDTX S PSDT1=$O(^PSRX("AM",PSDT1)) Q:'PSDT1!($E(PSDT1,1,7)>PSDTX)  D
"RTN","PSOCSTM",38,0)
 .S CDT=$P(PSDT1,"."),RXN=0 F  S RXN=$O(^PSRX("AM",PSDT1,RXN)) Q:'RXN  S RXF=0 F  S RXF=$O(^PSRX("AM",PSDT1,RXN,RXF)) Q:RXF=""  S PAR=1 D CHK
"RTN","PSOCSTM",39,0)
 .S NDT=$O(^PSRX("AM",PSDT1)) D:$P(NDT,".")'=CDT VST K PAR
"RTN","PSOCSTM",40,0)
 Q
"RTN","PSOCSTM",41,0)
INI K VIS S (VISITS,DV)=0 F  S DV=$O(^PS(59,DV)) Q:'+DV  S VIS(DV)=0
"RTN","PSOCSTM",42,0)
 Q
"RTN","PSOCSTM",43,0)
VST S DV=0 F  S DV=$O(^TMP($J,"PAT",DV)) Q:'DV  D
"RTN","PSOCSTM",44,0)
 .S DFN=0 F  S DFN=$O(^TMP($J,"PAT",DV,DFN)) Q:'DFN  S VIS(DV)=VIS(DV)+1,VISITS=VISITS+1
"RTN","PSOCSTM",45,0)
 K ^TMP($J,"PAT") Q
"RTN","PSOCSTM",46,0)
CHK I '$D(^PSRX(RXN,0)) K ^PSRX("AL",PSDT,RXN,RXF) Q
"RTN","PSOCSTM",47,0)
 Q:'$D(^PSRX(RXN,2))  S RX0=^PSRX(RXN,0),RX2=^PSRX(RXN,2)
"RTN","PSOCSTM",48,0)
 S DFN=+$P(RX0,"^",2) Q:'$D(^DPT(DFN,0))  D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOCSTM",49,0)
 S DRG=+$P(RX0,"^",6) Q:'$D(^PSDRUG(DRG,0))
"RTN","PSOCSTM",50,0)
 ;S CLASS=+$P(^(0),"^",2) Q:'$D(^PS(50.605,CLASS,0))
"RTN","PSOCSTM",51,0)
 S DIV=+$P(RX2,"^",9) Q:'$D(^PS(59,DIV,0))
"RTN","PSOCSTM",52,0)
 S PHYS=+$P(RX0,"^",4) Q:'$D(^VA(200,PHYS,0))
"RTN","PSOCSTM",53,0)
 S PAST=+$P(RX0,"^",3) Q:'$D(^PS(53,PAST,0))
"RTN","PSOCSTM",54,0)
 S CLINIC=+$P(RX0,"^",5) K:'$D(^SC(CLINIC,0)) CLINIC
"RTN","PSOCSTM",55,0)
 S COST=$S(+$P(RX0,"^",17):+$P(RX0,"^",17),$D(^PSDRUG(DRG,660)):+$P(^(660),"^",6),1:0)
"RTN","PSOCSTM",56,0)
 I $G(PAR) D  S PR=0 Q
"RTN","PSOCSTM",57,0)
 .I '$D(^PSRX(RXN,"P",RXF,0)) K ^PSRX("AM",PSDT,RXN,RXF) Q
"RTN","PSOCSTM",58,0)
 .I $P(^PSRX(RXN,"P",RXF,0),"^",19) D
"RTN","PSOCSTM",59,0)
 ..S RX1=^PSRX(RXN,"P",RXF,0),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9))
"RTN","PSOCSTM",60,0)
 ..S PHYS=$S($P(RX1,"^",17):$P(RX1,"^",17),1:$P(RX0,"^",4))
"RTN","PSOCSTM",61,0)
 ..S OR=0,RF=1,QTY=+$P(RX1,"^",4),ML=$S($P(RX1,"^",2)="M":1,1:0),WD=$S($P(RX1,"^",2)="W":1,1:0) S COST=QTY*COST D SET,SF
"RTN","PSOCSTM",62,0)
 I $P(RX2,"^",13),'RXF D  Q
"RTN","PSOCSTM",63,0)
 .S OR=1,RF=0,QTY=+$P(RX0,"^",7),ML=$S($P(RX0,"^",11)="M":1,1:0),WD=$S($P(RX0,"^",11)="W":1,1:0),COST=QTY*COST D SET,SF
"RTN","PSOCSTM",64,0)
 D:RXF 
"RTN","PSOCSTM",65,0)
 .I '$D(^PSRX(RXN,1,RXF,0)) K ^PSRX("AL",PSDT,RXN,RXF) Q
"RTN","PSOCSTM",66,0)
 .Q:'$P(^PSRX(RXN,1,RXF,0),"^",18)  S RX1=^PSRX(RXN,1,RXF,0)
"RTN","PSOCSTM",67,0)
 .S OR=0,RF=1,QTY=+$P(RX1,"^",4),ML=$S($P(RX1,"^",2)="M":1,1:0),WD=$S($P(RX1,"^",2)="W":1,1:0) S COST=QTY*COST
"RTN","PSOCSTM",68,0)
 .S PHYS=$S($P(RX1,"^",17):$P(RX1,"^",17),1:$P(RX0,"^",4)),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9))
"RTN","PSOCSTM",69,0)
 .D SET,SF
"RTN","PSOCSTM",70,0)
 Q
"RTN","PSOCSTM",71,0)
SF S DATA="^"_OR_"^"_RF_"^"_COST_"^"_QTY_"^"_ML_"^"_WD,^TMP($J,"PAT",DIV,DFN)=""
"RTN","PSOCSTM",72,0)
 F I=1:1:PSG Q:('$D(CLINIC))&(I=PSG)  S DATA1=$S($D(@A(I))#2:^(0),1:@(B(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTM",73,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @A(I)=DATA2
"RTN","PSOCSTM",74,0)
 .S:'$D(@A1(I)) @A1(I)=B1(I) S $P(@A1(I),"^",4)=+$P(@A1(I),"^",4)+1,$P(@A1(I),"^",3)=@B(I)
"RTN","PSOCSTM",75,0)
 F I=1:1:PSD S DATA1=$S(($D(@(C(I)))#2):$G(^(0)),1:@(D(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTM",76,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @C(I)=DATA2 D
"RTN","PSOCSTM",77,0)
 .S:'$D(@C1(I)) @C1(I)=D1(I) S $P(@C1(I),"^",4)=+$P(@C1(I),"^",4)+1,$P(@C1(I),"^",3)=@D(I)
"RTN","PSOCSTM",78,0)
 Q
"RTN","PSOCSTM",79,0)
 ;
"RTN","PSOCSTM",80,0)
SET S:'$D(^PSCST(PSDT,0)) ^PSCST(PSDT,0)=PSDT,^PSCST("B",PSDT,PSDT)="" Q
"RTN","PSOCSTM",81,0)
SET1 S ^PSCST(PSDT,1)=DT_"^"_VISITS
"RTN","PSOCSTM",82,0)
 S DV=0 F  S DV=$O(VIS(DV)) Q:'DV  S $P(^PSCST(PSDT,"V",DV,0),"^",8)=+VIS(DV)
"RTN","PSOCSTM",83,0)
 Q
"RTN","PSOCSTM",84,0)
QUES W !,$C(7),"??",!,"For example, September 1993 could be entered as 9/93 or SEP 93.",!,"For Year 2000 Compliance enter date as 9/2000 or SEP 2000." Q
"RTN","PSOCSTM",85,0)
ZNODE ;update zero nodes
"RTN","PSOCSTM",86,0)
 F PSDT=BDT:$S('$D(BEGDATE):100,1:1):EDT S NDZ=0 F ND="D","P","PS","S","V" S NODE(ND)=0 D:$O(^PSCST(PSDT,"D",0))
"RTN","PSOCSTM",87,0)
 .F  S NDZ=$O(^PSCST(PSDT,ND,NDZ)) Q:'NDZ  S NODE(ND)=NODE(ND)+1,NDZ2=NDZ D:ND="V"
"RTN","PSOCSTM",88,0)
 ..S NDZ1=0,NODE(ND,"P")=0 F  S NDZ1=$O(^PSCST(PSDT,ND,NDZ2,"P",NDZ1)) Q:'NDZ1  S NODE(ND,"P")=NODE(ND,"P")+1
"RTN","PSOCSTM",89,0)
 ..S $P(^PSCST(PSDT,ND,NDZ2,"P",0),"^",4)=NODE(ND,"P"),NDZ1=0
"RTN","PSOCSTM",90,0)
 .S:$G(^PSCST(PSDT,ND,0))]"" $P(^PSCST(PSDT,ND,0),"^",4)=NODE(ND),NDZ=0
"RTN","PSOCSTM",91,0)
 K NDZ,ND,NODE,NDZ2,NDZ1 Q
"RTN","PSOCSTM",92,0)
 ;
"RTN","PSOCSTM",93,0)
MTHLCK(GET) ;lock for month end run or query if month end is running
"RTN","PSOCSTM",94,0)
 ; INPUT:  GET = 1  try to get lock and keep locked
"RTN","PSOCSTM",95,0)
 ;               0  query if locked only, leave as unlocked
"RTN","PSOCSTM",96,0)
 ; RETURNS: 1 - already locked
"RTN","PSOCSTM",97,0)
 ;          0 - was not already locked
"RTN","PSOCSTM",98,0)
 ;
"RTN","PSOCSTM",99,0)
 I '$D(ZTQUEUED) W !,"checking for duplicate job..."
"RTN","PSOCSTM",100,0)
 N GOTLOCK
"RTN","PSOCSTM",101,0)
 L +^PSOCSTM:10 S GOTLOCK=$T   ;delay 10 secs to handle slower systems
"RTN","PSOCSTM",102,0)
 I GOTLOCK,'GET L -^PSOCSTM Q 0
"RTN","PSOCSTM",103,0)
 I GOTLOCK,GET Q 0
"RTN","PSOCSTM",104,0)
 N AST S AST="",$P(AST,"*",79)=""
"RTN","PSOCSTM",105,0)
 D:'($D(ZTQUEUED))
"RTN","PSOCSTM",106,0)
 .W !!,*7,AST,!
"RTN","PSOCSTM",107,0)
 .W "Monthly Rx Cost Compilation is currently running, "
"RTN","PSOCSTM",108,0)
 .W "Try your request later",!
"RTN","PSOCSTM",109,0)
 .W AST,!!
"RTN","PSOCSTM",110,0)
 Q 1
"RTN","PSOCSTM",111,0)
 ;
"RTN","PSOCSTM",112,0)
 ;
"RTN","PSOCSTM",113,0)
G ;;
"RTN","PSOCSTM",114,0)
 ;;^PSCST(PSDT,0);PSDT;^TMP($J,"A1");1
"RTN","PSOCSTM",115,0)
 ;;^PSCST(PSDT,"P",PHYS,0);PHYS;^PSCST(PSDT,"P",0);^50.9001PA^^
"RTN","PSOCSTM",116,0)
 ;;^PSCST(PSDT,"P",PHYS,"D",DRG,0);DRG;^PSCST(PSDT,"P",PHYS,"D",0);^50.9002PA^^
"RTN","PSOCSTM",117,0)
 ;;^PSCST(PSDT,"D",DRG,0);DRG;^PSCST(PSDT,"D",0);^50.9003PA^^
"RTN","PSOCSTM",118,0)
 ;;^PSCST(PSDT,"D",DRG,"P",PHYS,0);PHYS;^PSCST(PSDT,"D",DRG,"P",0);^50.9004PA^^
"RTN","PSOCSTM",119,0)
 ;;^PSCST(PSDT,"PS",PAST,0);PAST;^PSCST(PSDT,"PS",0);^50.9005PA^^
"RTN","PSOCSTM",120,0)
 ;;^PSCST(PSDT,"S",CLINIC,0);CLINIC;^PSCST(PSDT,"S",0);^50.9008PA^^
"RTN","PSOCSTM",121,0)
 ;;
"RTN","PSOCSTM",122,0)
D ;;
"RTN","PSOCSTM",123,0)
 ;;^PSCST(PSDT,"V",DIV,0);DIV;^PSCST(PSDT,"V",0);^50.9006PA^^
"RTN","PSOCSTM",124,0)
 ;;^PSCST(PSDT,"V",DIV,"D",DRG,0);DRG;^PSCST(PSDT,"V",DIV,"D",0);^50.9007PA^^
"RTN","PSOCSTM",125,0)
 ;;^PSCST(PSDT,"V",DIV,"P",PHYS,0);PHYS;^PSCST(PSDT,"V",DIV,"P",0);^50.901PA^^
"VER")
8.0^22.0
"BLD",6397,6)
^SEQ #194
**END**
**END**
