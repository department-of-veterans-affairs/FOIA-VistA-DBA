Released PSO*7*184 SEQ #170
Extracted from mail message
**KIDS**:PSO*7.0*184^

**INSTALL NAME**
PSO*7.0*184
"BLD",1052,0)
PSO*7.0*184^OUTPATIENT PHARMACY^0^3041028^y
"BLD",1052,1,0)
^^36^36^3040928^
"BLD",1052,1,1,0)
 
"BLD",1052,1,2,0)
 1. MOU-1203-30359
"BLD",1052,1,3,0)
    When using the Return Medication to Stock [PSO RETURNED STOCK]
"BLD",1052,1,4,0)
    option for a controlled substance, the pharmacist is allowed to
"BLD",1052,1,5,0)
    up-arrow ("^") out of the comments field even though it is a
"BLD",1052,1,6,0)
    required field.  When this happens, some Controlled Substance
"BLD",1052,1,7,0)
    files are partially updated and will cause the medication to be
"BLD",1052,1,8,0)
    returned twice.  This patch will resolve this issue by not allowing
"BLD",1052,1,9,0)
    the pharmacist to up-arrow out of the comments field.
"BLD",1052,1,10,0)
    
"BLD",1052,1,11,0)
 2. SHE-0404-51324
"BLD",1052,1,12,0)
    The potential exists to modify the number of refills for a
"BLD",1052,1,13,0)
    controlled substance from a maximum of 5 to 11.  This can happen
"BLD",1052,1,14,0)
    in the Patient Processing Option [PSO LM BACKDOOR ORDERS] while
"BLD",1052,1,15,0)
    finishing a renewed order.
"BLD",1052,1,16,0)
 
"BLD",1052,1,17,0)
 3. DAY-0604-41287
"BLD",1052,1,18,0)
    An issue was identified in the Imaging software that allowed the
"BLD",1052,1,19,0)
    software to automatically select a patient based on name even if
"BLD",1052,1,20,0)
    multiple patients existed with the same name.  A fix is being
"BLD",1052,1,21,0)
    included in Pharmacy to kill an internal variable to not allow
"BLD",1052,1,22,0)
    this behavior.  This change does not affect the pharmacy application
"BLD",1052,1,23,0)
    in any way.
"BLD",1052,1,24,0)
 
"BLD",1052,1,25,0)
 4. CLL-0604-40968
"BLD",1052,1,26,0)
    When using the Return Medication to Stock [PSO RETURNED STOCK]
"BLD",1052,1,27,0)
    option it is possible to get the following message:
"BLD",1052,1,28,0)
    
"BLD",1052,1,29,0)
    Original Fill CANNOT be Returned!
"BLD",1052,1,30,0)
    This fill entered before installation of version 6.  There are no
"BLD",1052,1,31,0)
    refills.
"BLD",1052,1,32,0)
    
"BLD",1052,1,33,0)
    This message is generated when the pharmacist try's to return a
"BLD",1052,1,34,0)
    medication to stock for a prescription that has a fill date that
"BLD",1052,1,35,0)
    is less than the date Version 6.0 of the Outpatient Pharmacy
"BLD",1052,1,36,0)
    application was installed.  This message will be removed.
"BLD",1052,4,0)
^9.64PA^^
"BLD",1052,"ABPKG")
n
"BLD",1052,"KRN",0)
^9.67PA^8989.52^19
"BLD",1052,"KRN",.4,0)
.4
"BLD",1052,"KRN",.401,0)
.401
"BLD",1052,"KRN",.402,0)
.402
"BLD",1052,"KRN",.403,0)
.403
"BLD",1052,"KRN",.5,0)
.5
"BLD",1052,"KRN",.84,0)
.84
"BLD",1052,"KRN",3.6,0)
3.6
"BLD",1052,"KRN",3.8,0)
3.8
"BLD",1052,"KRN",9.2,0)
9.2
"BLD",1052,"KRN",9.8,0)
9.8
"BLD",1052,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1052,"KRN",9.8,"NM",1,0)
PSODIR1^^0^B62027893
"BLD",1052,"KRN",9.8,"NM",2,0)
PSODIR3^^0^B24224437
"BLD",1052,"KRN",9.8,"NM",3,0)
PSOCPTRI^^0^B29483202
"BLD",1052,"KRN",9.8,"NM",4,0)
PSORESK^^0^B55889598
"BLD",1052,"KRN",9.8,"NM","B","PSOCPTRI",3)

"BLD",1052,"KRN",9.8,"NM","B","PSODIR1",1)

"BLD",1052,"KRN",9.8,"NM","B","PSODIR3",2)

"BLD",1052,"KRN",9.8,"NM","B","PSORESK",4)

"BLD",1052,"KRN",19,0)
19
"BLD",1052,"KRN",19.1,0)
19.1
"BLD",1052,"KRN",101,0)
101
"BLD",1052,"KRN",409.61,0)
409.61
"BLD",1052,"KRN",771,0)
771
"BLD",1052,"KRN",870,0)
870
"BLD",1052,"KRN",8989.51,0)
8989.51
"BLD",1052,"KRN",8989.52,0)
8989.52
"BLD",1052,"KRN",8994,0)
8994
"BLD",1052,"KRN","B",.4,.4)

"BLD",1052,"KRN","B",.401,.401)

"BLD",1052,"KRN","B",.402,.402)

"BLD",1052,"KRN","B",.403,.403)

"BLD",1052,"KRN","B",.5,.5)

"BLD",1052,"KRN","B",.84,.84)

"BLD",1052,"KRN","B",3.6,3.6)

"BLD",1052,"KRN","B",3.8,3.8)

"BLD",1052,"KRN","B",9.2,9.2)

"BLD",1052,"KRN","B",9.8,9.8)

"BLD",1052,"KRN","B",19,19)

"BLD",1052,"KRN","B",19.1,19.1)

"BLD",1052,"KRN","B",101,101)

"BLD",1052,"KRN","B",409.61,409.61)

"BLD",1052,"KRN","B",771,771)

"BLD",1052,"KRN","B",870,870)

"BLD",1052,"KRN","B",8989.51,8989.51)

"BLD",1052,"KRN","B",8989.52,8989.52)

"BLD",1052,"KRN","B",8994,8994)

"BLD",1052,"QUES",0)
^9.62^^
"BLD",1052,"REQB",0)
^9.611^5^4
"BLD",1052,"REQB",1,0)
PSO*7.0*166^2
"BLD",1052,"REQB",2,0)
PSO*7.0*46^2
"BLD",1052,"REQB",4,0)
PSO*7.0*55^2
"BLD",1052,"REQB",5,0)
PSO*7.0*185^2
"BLD",1052,"REQB","B","PSO*7.0*166",1)

"BLD",1052,"REQB","B","PSO*7.0*185",5)

"BLD",1052,"REQB","B","PSO*7.0*46",2)

"BLD",1052,"REQB","B","PSO*7.0*55",4)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^3011218^2980805^5
"PKG",16,22,1,"PAH",1,0)
184^3041028
"PKG",16,22,1,"PAH",1,1,0)
^^36^36^3041028
"PKG",16,22,1,"PAH",1,1,1,0)
 
"PKG",16,22,1,"PAH",1,1,2,0)
 1. MOU-1203-30359
"PKG",16,22,1,"PAH",1,1,3,0)
    When using the Return Medication to Stock [PSO RETURNED STOCK]
"PKG",16,22,1,"PAH",1,1,4,0)
    option for a controlled substance, the pharmacist is allowed to
"PKG",16,22,1,"PAH",1,1,5,0)
    up-arrow ("^") out of the comments field even though it is a
"PKG",16,22,1,"PAH",1,1,6,0)
    required field.  When this happens, some Controlled Substance
"PKG",16,22,1,"PAH",1,1,7,0)
    files are partially updated and will cause the medication to be
"PKG",16,22,1,"PAH",1,1,8,0)
    returned twice.  This patch will resolve this issue by not allowing
"PKG",16,22,1,"PAH",1,1,9,0)
    the pharmacist to up-arrow out of the comments field.
"PKG",16,22,1,"PAH",1,1,10,0)
    
"PKG",16,22,1,"PAH",1,1,11,0)
 2. SHE-0404-51324
"PKG",16,22,1,"PAH",1,1,12,0)
    The potential exists to modify the number of refills for a
"PKG",16,22,1,"PAH",1,1,13,0)
    controlled substance from a maximum of 5 to 11.  This can happen
"PKG",16,22,1,"PAH",1,1,14,0)
    in the Patient Processing Option [PSO LM BACKDOOR ORDERS] while
"PKG",16,22,1,"PAH",1,1,15,0)
    finishing a renewed order.
"PKG",16,22,1,"PAH",1,1,16,0)
 
"PKG",16,22,1,"PAH",1,1,17,0)
 3. DAY-0604-41287
"PKG",16,22,1,"PAH",1,1,18,0)
    An issue was identified in the Imaging software that allowed the
"PKG",16,22,1,"PAH",1,1,19,0)
    software to automatically select a patient based on name even if
"PKG",16,22,1,"PAH",1,1,20,0)
    multiple patients existed with the same name.  A fix is being
"PKG",16,22,1,"PAH",1,1,21,0)
    included in Pharmacy to kill an internal variable to not allow
"PKG",16,22,1,"PAH",1,1,22,0)
    this behavior.  This change does not affect the pharmacy application
"PKG",16,22,1,"PAH",1,1,23,0)
    in any way.
"PKG",16,22,1,"PAH",1,1,24,0)
 
"PKG",16,22,1,"PAH",1,1,25,0)
 4. CLL-0604-40968
"PKG",16,22,1,"PAH",1,1,26,0)
    When using the Return Medication to Stock [PSO RETURNED STOCK]
"PKG",16,22,1,"PAH",1,1,27,0)
    option it is possible to get the following message:
"PKG",16,22,1,"PAH",1,1,28,0)
    
"PKG",16,22,1,"PAH",1,1,29,0)
    Original Fill CANNOT be Returned!
"PKG",16,22,1,"PAH",1,1,30,0)
    This fill entered before installation of version 6.  There are no
"PKG",16,22,1,"PAH",1,1,31,0)
    refills.
"PKG",16,22,1,"PAH",1,1,32,0)
    
"PKG",16,22,1,"PAH",1,1,33,0)
    This message is generated when the pharmacist try's to return a
"PKG",16,22,1,"PAH",1,1,34,0)
    medication to stock for a prescription that has a fill date that
"PKG",16,22,1,"PAH",1,1,35,0)
    is less than the date Version 6.0 of the Outpatient Pharmacy
"PKG",16,22,1,"PAH",1,1,36,0)
    application was installed.  This message will be removed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSOCPTRI")
0^3^B29483202
"RTN","PSOCPTRI",1,0)
PSOCPTRI ;BHAM ISC/CPM,RTR - SUPPORT FOR CHAMPUS RX BILLING ;14-AUG-96
"RTN","PSOCPTRI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,55,184**;DEC 1997
"RTN","PSOCPTRI",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCPTRI",4,0)
 ;
"RTN","PSOCPTRI",5,0)
 ;
"RTN","PSOCPTRI",6,0)
TRANS(ORIG,REF,PSOV) ; Extract Rx information for transmission to FI
"RTN","PSOCPTRI",7,0)
 ;  Input:   ORIG  --  Pointer to the rx in file #52
"RTN","PSOCPTRI",8,0)
 ;            REF  --  Pointer to the refill in file #52.1
"RTN","PSOCPTRI",9,0)
 ;                     (This is 0 if we are billing the original fill)
"RTN","PSOCPTRI",10,0)
 ;           PSOV  --  Passed by reference.  This array will be used
"RTN","PSOCPTRI",11,0)
 ;                     to return the output (described below).
"RTN","PSOCPTRI",12,0)
 ; Output:   PSOE  --  This is normally 1, or -1 if the NDC cannot
"RTN","PSOCPTRI",13,0)
 ;                     be determined.
"RTN","PSOCPTRI",14,0)
 ;
"RTN","PSOCPTRI",15,0)
 ;
"RTN","PSOCPTRI",16,0)
 ;     Description of output variables to be passed to billing:
"RTN","PSOCPTRI",17,0)
 ;
"RTN","PSOCPTRI",18,0)
 ;            PSOV("NDC")       NDC # from the DRUG (#50) file
"RTN","PSOCPTRI",19,0)
 ;            PSOV("DIV")       Pharmacy (in file #59) dispensing the rx
"RTN","PSOCPTRI",20,0)
 ;            PSOV("FDT")       Rx Fill Date
"RTN","PSOCPTRI",21,0)
 ;                                 Last fill, field #101, or
"RTN","PSOCPTRI",22,0)
 ;                                 Dispensed, field #25
"RTN","PSOCPTRI",23,0)
 ;            PSOV("RX#")       Prescription number, field #.01
"RTN","PSOCPTRI",24,0)
 ;            PSOV("QTY")       Quantity, field #7
"RTN","PSOCPTRI",25,0)
 ;            PSOV("SUP")       Days Supply, field #8
"RTN","PSOCPTRI",26,0)
 ;            PSOV("ISS")       Issue Date, field #1
"RTN","PSOCPTRI",27,0)
 ;            PSOV("#REF")      # Refills, field #9
"RTN","PSOCPTRI",28,0)
 ;            PSOV("COMP")      2 if manufactured in Pharmacy, else 1
"RTN","PSOCPTRI",29,0)
 ;            PSOV("DEA")       DEA number from "PS" node in File 200
"RTN","PSOCPTRI",30,0)
 ;
"RTN","PSOCPTRI",31,0)
 N PSOE,PSORX S PSOE=1
"RTN","PSOCPTRI",32,0)
 ;
"RTN","PSOCPTRI",33,0)
 S PSORX(0)=$G(^PSRX(ORIG,0)),PSORX(2)=$G(^(2)),PSORX(3)=$G(^(3))
"RTN","PSOCPTRI",34,0)
 S:$G(REF) PSORX("REF")=$G(^PSRX(ORIG,1,REF,0))
"RTN","PSOCPTRI",35,0)
 I PSORX(0)="" S PSOE=-1 G TRANSQ
"RTN","PSOCPTRI",36,0)
 ;
"RTN","PSOCPTRI",37,0)
 S PSOV("RX#")=$P(PSORX(0),"^") ; prescription number
"RTN","PSOCPTRI",38,0)
 ; - first check for a valid NDC #
"RTN","PSOCPTRI",39,0)
 S PSOV("NDC")=$P($G(^PSDRUG(+$P(PSORX(0),"^",6),2)),"^",4)
"RTN","PSOCPTRI",40,0)
 I +PSOV("NDC")=0 S PSOE=-1 G TRANSQ
"RTN","PSOCPTRI",41,0)
 ;
"RTN","PSOCPTRI",42,0)
 ; - extract everything else
"RTN","PSOCPTRI",43,0)
 S PSOV("DIV")=$S($P($G(PSORX("REF")),"^",9):$P(PSORX("REF"),"^",9),1:$P(PSORX(2),"^",9)) ;                  pharmacy division
"RTN","PSOCPTRI",44,0)
 S PSOV("FDT")=$S($G(REF):$E($P(PSORX("REF"),"^"),1,7),1:$E($P(PSORX(2),"^",2),1,7))
"RTN","PSOCPTRI",45,0)
 I PSOV("FDT")="" S PSOV("FDT")=$S($P(PSORX(3),"^"):$P(PSORX(3),"^"),1:$P(PSORX(2),"^",5))
"RTN","PSOCPTRI",46,0)
 ;
"RTN","PSOCPTRI",47,0)
 S PSOV("QTY")=$S($P($G(PSORX("REF")),"^",4)'="":$P(PSORX("REF"),"^",4),1:$P(PSORX(0),"^",7)) ;                  quantity
"RTN","PSOCPTRI",48,0)
 S PSOV("SUP")=$S($P($G(PSORX("REF")),"^",10)'="":$P(PSORX("REF"),"^",10),1:$P(PSORX(0),"^",8)) ;                  days supply
"RTN","PSOCPTRI",49,0)
 S PSOV("ISS")=$P(PSORX(0),"^",13) ;                 date rx written
"RTN","PSOCPTRI",50,0)
 S PSOV("#REF")=$P(PSORX(0),"^",9) ;                 # refills authorized
"RTN","PSOCPTRI",51,0)
 ;
"RTN","PSOCPTRI",52,0)
 N PSOX S PSOX=+$P(PSORX(0),"^",6) S PSOV("COMP")=$P($G(^PSDRUG(PSOX,0)),"^",3) S PSOV("COMP")=$S(PSOV("COMP")[0:2,1:1) ; Compound drug
"RTN","PSOCPTRI",53,0)
 ;
"RTN","PSOCPTRI",54,0)
 S PSOV("DEA")=$S($P(PSORX(0),"^",4):$P($G(^VA(200,$P(PSORX(0),"^",4),"PS")),"^",2),1:"") ; DEA #
"RTN","PSOCPTRI",55,0)
 ;
"RTN","PSOCPTRI",56,0)
 ;
"RTN","PSOCPTRI",57,0)
TRANSQ Q PSOE
"RTN","PSOCPTRI",58,0)
 ;
"RTN","PSOCPTRI",59,0)
 ;
"RTN","PSOCPTRI",60,0)
LABEL(RX,PSOLAP,PSOSITE,DUZ,PSOTRAMT) ; Print the label.
"RTN","PSOCPTRI",61,0)
 ;  Input:        RX  --  Pointer to the prescription in file #52
"RTN","PSOCPTRI",62,0)
 ;            PSOLAP  --  Label printer
"RTN","PSOCPTRI",63,0)
 ;           PSOSITE  --  Pointer to the Pharmacy in file #59
"RTN","PSOCPTRI",64,0)
 ;               DUZ  --  Pointer to the use in file #200
"RTN","PSOCPTRI",65,0)
 ;          PSOTRAMT  --  Amount to be paid
"RTN","PSOCPTRI",66,0)
 ;
"RTN","PSOCPTRI",67,0)
 ;
"RTN","PSOCPTRI",68,0)
 Q:PSOLAP["LAT-TERM"
"RTN","PSOCPTRI",69,0)
 Q:'$D(^PSRX(RX,0))
"RTN","PSOCPTRI",70,0)
 Q:'$D(^PS(59,PSOSITE,0))
"RTN","PSOCPTRI",71,0)
 N CT,II,III,NOW,RXFF,X,Y,PSOSYS,PSOPAR,PSOBARS,PDUZ,PSOBAR0,PSOBAR1,REPRINT,PSOCHAMP,PSHRX,DIQUIET
"RTN","PSOCPTRI",72,0)
 S DIQUIET=1 D DT^DICRW
"RTN","PSOCPTRI",73,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCPTRI",74,0)
 S:$P($G(^PSRX(RX,"STA")),"^")'=3 REPRINT=""
"RTN","PSOCPTRI",75,0)
 D:$P($G(^PSRX(RX,"STA")),"^")=3
"RTN","PSOCPTRI",76,0)
 .S RXFF=0 F II=0:0 S II=$O(^PSRX(RX,1,II)) Q:'II  S RXFF=II
"RTN","PSOCPTRI",77,0)
 .K DIE S DIE="^PSRX(",DA=RX,DR=$S('RXFF:"22///"_DT_";",1:"")_"100///"_0_";101///"_$S('RXFF:DT,1:+$P($G(^PSRX(RX,1,+$G(RXFF),0)),"^")) D ^DIE K DIE
"RTN","PSOCPTRI",78,0)
 .S PSHRX=RX D EN^PSOHLSN1(RX,"OE","","Rx removed from CHAMPUS billing hold","A") S RX=PSHRX
"RTN","PSOCPTRI",79,0)
 .K ^PSRX("AH",+$P($G(^PSRX(RX,"H")),"^"),RX) S ^PSRX(DA,"H")=""
"RTN","PSOCPTRI",80,0)
 .D NOW^%DTC S NOW=%
"RTN","PSOCPTRI",81,0)
 .S III=0 F CT=0:0 S CT=$O(^PSRX(RX,"A",CT)) Q:'CT  S III=CT
"RTN","PSOCPTRI",82,0)
 .S III=III+1,^PSRX(RX,"A",0)="^52.3DA^"_III_"^"_III
"RTN","PSOCPTRI",83,0)
 .S ^PSRX(RX,"A",III,0)=NOW_"^"_"U"_"^"_+$G(DUZ)_"^"_$S(RXFF<6:RXFF,1:(RXFF+1))_"^"_"Rx removed from CHAMPUS billing hold"
"RTN","PSOCPTRI",84,0)
 ;
"RTN","PSOCPTRI",85,0)
IO S %ZIS="",IOP=PSOLAP D ^%ZIS I POP H 5 G IO
"RTN","PSOCPTRI",86,0)
 N PSOIOS S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSOCPTRI",87,0)
 S PSOSYS=$G(^PS(59,PSOSITE,1))
"RTN","PSOCPTRI",88,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PDUZ=DUZ
"RTN","PSOCPTRI",89,0)
 S PPL=RX
"RTN","PSOCPTRI",90,0)
 S PSOCHAMP=1
"RTN","PSOCPTRI",91,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&($P(PSOPAR,"^",19))
"RTN","PSOCPTRI",92,0)
 D DQ^PSOLBL
"RTN","PSOCPTRI",93,0)
 D ^%ZISC
"RTN","PSOCPTRI",94,0)
 ;
"RTN","PSOCPTRI",95,0)
 Q
"RTN","PSOCPTRI",96,0)
 ;
"RTN","PSOCPTRI",97,0)
 ;
"RTN","PSOCPTRI",98,0)
CHK(ORIG,REF) ; Should this rx be billed to the CHAMPUS Fiscal Intermediary?
"RTN","PSOCPTRI",99,0)
 ;  Input:   ORIG  --  Pointer to the rx in file #52
"RTN","PSOCPTRI",100,0)
 ;            REF  --  Pointer to the refill in file #52.1, or
"RTN","PSOCPTRI",101,0)
 ;                     0 for the original fill
"RTN","PSOCPTRI",102,0)
 ; Output:   PSOB  --  0 => The rx should not be billed
"RTN","PSOCPTRI",103,0)
 ;                     1 => The rx may be billed.
"RTN","PSOCPTRI",104,0)
 ;
"RTN","PSOCPTRI",105,0)
 N PSOB
"RTN","PSOCPTRI",106,0)
 ;
"RTN","PSOCPTRI",107,0)
 ; - ignore CHAMPUS billing for certain RX Patient Statuses
"RTN","PSOCPTRI",108,0)
 I $P($G(^PS(53,+$P($G(^PSRX(+$G(ORIG),0)),"^",3),0)),"^",8) G CHKQ
"RTN","PSOCPTRI",109,0)
 ;
"RTN","PSOCPTRI",110,0)
 S PSOB=1
"RTN","PSOCPTRI",111,0)
 ;
"RTN","PSOCPTRI",112,0)
CHKQ Q +$G(PSOB)
"RTN","PSOCPTRI",113,0)
 ;
"RTN","PSOCPTRI",114,0)
DEV ;Get devices
"RTN","PSOCPTRI",115,0)
 N PSOTRION
"RTN","PSOCPTRI",116,0)
 S PSOTRION=ION
"RTN","PSOCPTRI",117,0)
 I $G(PSOLAP)]"",$G(PSOLAP)'=ION Q
"RTN","PSOCPTRI",118,0)
DEVA W ! S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS I POP!($E(IOST)'["P") W !,"Label Printer device must be selected!",! G DEVA
"RTN","PSOCPTRI",119,0)
 S PSOLAP=ION
"RTN","PSOCPTRI",120,0)
 N PSOIOS S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSOCPTRI",121,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&($P($G(PSOPAR),"^",10))
"RTN","PSOCPTRI",122,0)
 D ^%ZISC S ION=PSOTRION Q
"RTN","PSOCPTRI",123,0)
 ;
"RTN","PSOCPTRI",124,0)
EXM ;Edit Champus Billing Exemption field
"RTN","PSOCPTRI",125,0)
 I '$D(PSOPAR) D ^PSOLSET G EXM
"RTN","PSOCPTRI",126,0)
 W ! K DIC S DIC="^PS(53,",DIC(0)="AEQMZ" D ^DIC K DIC I Y<0!($D(DTOUT))!($D(DUOUT)) G EXMQ
"RTN","PSOCPTRI",127,0)
 W ! K DIE S DA=+Y,DIE="^PS(53,",DR=16 D ^DIE
"RTN","PSOCPTRI",128,0)
EXMQ K DIE,DIC,Y
"RTN","PSOCPTRI",129,0)
 Q
"RTN","PSOCPTRI",130,0)
RESDIR ;Reset DIR just in case
"RTN","PSOCPTRI",131,0)
 S DIR("A")="LABEL: QUEUE"_$S($P(PSOPAR,"^",23):"/HOLD",1:"")_$S($P(PSOPAR,"^",24):"/SUSPEND",1:"")_$S($P(PSOPAR,"^",26):"/LABEL",1:"")_" or '^' to bypass "
"RTN","PSOCPTRI",132,0)
 S DIR("?",1)="Enter 'Q' to queue labels to print",DIR("?")="Enter '^' to bypass label functions",DIR("?",4)="Enter 'S' to suspend labels to print later"
"RTN","PSOCPTRI",133,0)
 S DIR("?",2)="Enter 'H' to hold label until Rx can be filled",DIR("?",3)="Enter 'P' for Rx profile"
"RTN","PSOCPTRI",134,0)
 S:$P(PSOPAR,"^",26) DIR("?",5)="Enter 'L' to print labels without queuing"
"RTN","PSOCPTRI",135,0)
 Q
"RTN","PSODIR1")
0^1^B62027893
"RTN","PSODIR1",1,0)
PSODIR1 ;IHS/DSD - ASKS DATA FOR RX ORDER ENTRY CONT. ;02/17/93 17:03
"RTN","PSODIR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,102,121,131,146,166,184**;DEC 1997
"RTN","PSODIR1",3,0)
 ;Ext ref ^PS(55-DBIA 2228, ^PSDRUG(-DBIA 221
"RTN","PSODIR1",4,0)
PTSTAT(PSODIR) ;
"RTN","PSODIR1",5,0)
PTSTATEN K DIC,DR,DIE S PSODIR("FIELD")=0
"RTN","PSODIR1",6,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" K PSORX("PATIENT STATUS"),PSODIR("PATIENT STATUS") N PSOFNDRX,PSOFNDFL,PSOFNDPS D
"RTN","PSODIR1",7,0)
 .S PSOFNDFL=0 F PSOFNDPS=0:0 S PSOFNDPS=$O(^PS(53,PSOFNDPS)) Q:'PSOFNDPS!(PSOFNDFL)  D
"RTN","PSODIR1",8,0)
 ..S PSOFNDRX=$P($G(^PS(53,PSOFNDPS,0)),"^") S PSOFNDRX=$$UP^XLFSTR(PSOFNDRX) I PSOFNDRX="NON-VA" S PSOFNDFL=1 S (PSORX("PATIENT STATUS"),DIC("B"))=$P($G(^PS(53,PSOFNDPS,0)),"^")
"RTN","PSODIR1",9,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW",$G(PSORX("PATIENT STATUS"))="" W !,"Could not find a 'NON-VA' Patient Status in the RX PATIENT STATUS file (#53)!" D PSTPB D  S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",10,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODIR1",11,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBB
"RTN","PSODIR1",12,0)
 S:$G(PSORX("PATIENT STATUS"))]"" DIC("B")=PSORX("PATIENT STATUS")
"RTN","PSODIR1",13,0)
 S:$G(PSODIR("PATIENT STATUS"))]"" DIC("B")=PSODIR("PATIENT STATUS")
"RTN","PSODIR1",14,0)
TPBB ;
"RTN","PSODIR1",15,0)
 S DIC("A")="PATIENT STATUS: "
"RTN","PSODIR1",16,0)
 S DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSODIR1",17,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" N PSOPSDIR,PSOFNDZZ,PSOPSUPA S (PSOPSDIR,PSOPSUPA)=0 D  I PSOPSDIR S:PSOPSUPA PSODIR("DFLG")=1 G:PSOPSUPA PTSTATX W ! D PSTPB G PTSTATEN
"RTN","PSODIR1",18,0)
 .I +Y'>0!($D(DTOUT))!($D(DUOUT)) S (PSOPSDIR,PSOPSUPA)=1 Q
"RTN","PSODIR1",19,0)
 .S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y,PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",20,0)
 .S PSOFNDZZ=$P($G(^PS(53,+Y,0)),"^") S PSOFNDZZ=$$UP^XLFSTR(PSOFNDZZ) I PSOFNDZZ'="NON-VA" S PSOPSDIR=1 K PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"),PSODIR("PTST NODE")
"RTN","PSODIR1",21,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBSC
"RTN","PSODIR1",22,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PTSTATX
"RTN","PSODIR1",23,0)
 I $D(DUOUT)!$D(DTOUT) S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",24,0)
 I Y=-1 W $C(7)," Required" G PTSTATEN
"RTN","PSODIR1",25,0)
 N PSOFNDX,PSOFNDXY,PSOFNDXX,PSOFNDYY
"RTN","PSODIR1",26,0)
 S PSOFNDXY=$G(Y),PSOFNDYY=$G(Y(0))
"RTN","PSODIR1",27,0)
 I '$G(PSOTPBFG),$G(PSOFROM)="NEW" S PSOFNDX=$P($G(^PS(53,+Y,0)),"^") S PSOFNDXX=$$UP^XLFSTR(PSOFNDX) I PSOFNDXX="NON-VA" K PSOFNDX,PSOFNDXY,PSOFNDYY,PSOFNDXX,Y W !!,"Cannot select 'NON-VA' Rx Patient Status!",! G PTSTATEN
"RTN","PSODIR1",28,0)
 S Y=$G(PSOFNDXY),Y(0)=$G(PSOFNDYY)
"RTN","PSODIR1",29,0)
 K PSOFNDXY,PSOFNDYY,PSOFNDX,PSOFNDXX
"RTN","PSODIR1",30,0)
 S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y
"RTN","PSODIR1",31,0)
 S PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",32,0)
TPBSC ;
"RTN","PSODIR1",33,0)
 I $G(PSOFDR),$P($G(OR0),"^",17)="C" G PTSTATX
"RTN","PSODIR1",34,0)
 L +^PS(55,PSODFN):0 I '$T G PTSTATX
"RTN","PSODIR1",35,0)
 S DIE="55",DR="3////"_+Y,DA=PSODFN D ^DIE K DIE,DA,D0
"RTN","PSODIR1",36,0)
 L -^PS(55,PSODFN)
"RTN","PSODIR1",37,0)
PTSTATX K DTOUT,DUOUT,X,Y,DA
"RTN","PSODIR1",38,0)
 Q
"RTN","PSODIR1",39,0)
SIG(PSODIR) ;
"RTN","PSODIR1",40,0)
 I $G(PSOFDR),$G(PSODIR("SIG"))']"" D SIGOK G:$G(SIGOK)!($G(PSODIR("DFLG"))) SIGX
"RTN","PSODIR1",41,0)
 K DIR,DIC
"RTN","PSODIR1",42,0)
 S DIR(0)="52,10"
"RTN","PSODIR1",43,0)
 S:$G(PSODRUG("SIG"))]"" DIR("B")=PSODRUG("SIG")
"RTN","PSODIR1",44,0)
 S:$G(PSODIR("SIG"))]"" DIR("B")=PSODIR("SIG")
"RTN","PSODIR1",45,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") SIGX
"RTN","PSODIR1",46,0)
 S PSODIR("SIG")=Y,SIGOK=0 K SIG
"RTN","PSODIR1",47,0)
SIGX K X,Y
"RTN","PSODIR1",48,0)
 Q
"RTN","PSODIR1",49,0)
QTY(PSODIR) ;
"RTN","PSODIR1",50,0)
QTYA K DIR,DIC
"RTN","PSODIR1",51,0)
 I $G(CLOZPAT)=1 S DIR("A",1)="Patient Eligible for 14 day supply or 7 day supply with 1 refill"
"RTN","PSODIR1",52,0)
 S DIR(0)="52,7" S:$G(PSODRUG("IEN")) DIR("A")="QTY ( "_$G(PSODRUG("UNIT"))_" ) "_$S($P($G(^PSDRUG(+PSODRUG("IEN"),5)),"^")]"":$P(^PSDRUG(+PSODRUG("IEN"),5),"^"),1:"")
"RTN","PSODIR1",53,0)
 K QTYHLD I $G(PSODIR("QTY"))]"" S QTYHLD=PSODIR("QTY") K PSODIR("QTY")
"RTN","PSODIR1",54,0)
 D:'$G(PSOQTY) QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",55,0)
 I '$G(SPEED),$G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",56,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",57,0)
 I $G(SPEED),$G(PSODIR("QTY"))']"" S PSODIR("QTY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",7)
"RTN","PSODIR1",58,0)
 S:$G(PSODIR("QTY"))]"" DIR("B")=PSODIR("QTY")
"RTN","PSODIR1",59,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") QTYX
"RTN","PSODIR1",60,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("DAYS SUPPLY")),(Y/+PSODIR("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  G:$G(PSODIR("DFLG")) QTYX  G QTYA
"RTN","PSODIR1",61,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" D DAYSEN
"RTN","PSODIR1",62,0)
 S PSODIR("QTY")=Y
"RTN","PSODIR1",63,0)
QTYX K X,Y
"RTN","PSODIR1",64,0)
 Q
"RTN","PSODIR1",65,0)
COPIES(PSODIR) ;
"RTN","PSODIR1",66,0)
 K DIR,DIC
"RTN","PSODIR1",67,0)
 S DIR(0)="52,10.6"
"RTN","PSODIR1",68,0)
 S DIR("B")=$S($G(PSODIR("COPIES"))]"":PSODIR("COPIES"),1:1)
"RTN","PSODIR1",69,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") COPIESX
"RTN","PSODIR1",70,0)
 S PSODIR("COPIES")=Y
"RTN","PSODIR1",71,0)
COPIESX K X,Y
"RTN","PSODIR1",72,0)
 Q
"RTN","PSODIR1",73,0)
DAYS(PSODIR) ;
"RTN","PSODIR1",74,0)
DAYSEN K DIR,DIC
"RTN","PSODIR1",75,0)
 S DIR(0)="N^1:"_$S($G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:90)
"RTN","PSODIR1",76,0)
 S DIR("B")=$S($D(CLOZPAT)&('$G(PSODIR("DAYS SUPPLY"))):7,$G(PSODIR("DAYS SUPPLY"))]"":PSODIR("DAYS SUPPLY"),$P($G(PSODIR("PTST NODE")),"^",3):$P(PSODIR("PTST NODE"),"^",3),1:30)
"RTN","PSODIR1",77,0)
 S DIR("A")="DAYS SUPPLY",DIR("?")="Enter a whole number between 1 and "_$S($G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:90)
"RTN","PSODIR1",78,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") DAYSX
"RTN","PSODIR1",79,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("QTY"))]"",(+PSODIR("QTY")/Y>PSODRUG("MAXDOSE")) W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" G DAYSEN
"RTN","PSODIR1",80,0)
 S PSODIR("DAYS SUPPLY")=Y D:$G(PSOFROM)="NEW"
"RTN","PSODIR1",81,0)
 .K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",82,0)
 .I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",83,0)
 .K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",84,0)
 I $D(CLOZPAT),PSODIR("DAYS SUPPLY")'=7 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",85,0)
 K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",86,0)
 I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",87,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",88,0)
DAYSX K X,Y
"RTN","PSODIR1",89,0)
 Q
"RTN","PSODIR1",90,0)
REFILL(PSODIR) ;
"RTN","PSODIR1",91,0)
 I $G(OR0) G REFOR
"RTN","PSODIR1",92,0)
 S PSODIR("CS")=0 K DIR,DIC,PSOX
"RTN","PSODIR1",93,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSODIR("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSODIR("CS"),"^",2)=1
"RTN","PSODIR1",94,0)
 I PSODIR("CS") D
"RTN","PSODIR1",95,0)
 .S PSOX=5,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=5:PSOX,1:PSOX1)
"RTN","PSODIR1",96,0)
 .S PSOX=$S('PSOX:0,PSODIR("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR1",97,0)
 E  D
"RTN","PSODIR1",98,0)
 .S PSOX=11,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=11:PSOX,1:PSOX1)
"RTN","PSODIR1",99,0)
 .S PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR1",100,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") D  G REFILLX
"RTN","PSODIR1",101,0)
 .I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!'$O(^PSRX(+$G(PSODIR("IRXN")),1,0))!('$G(PSOLOKED)) D  Q
"RTN","PSODIR1",102,0)
 ..S VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["F":"this drug.",1:"Narcotics.") W !,VALMSG,!
"RTN","PSODIR1",103,0)
 ..S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR1",104,0)
 ..Q
"RTN","PSODIR1",105,0)
 .;reset refills to the # given
"RTN","PSODIR1",106,0)
 .D RFRSET^PSODIR2
"RTN","PSODIR1",107,0)
 .Q
"RTN","PSODIR1",108,0)
 I $P($G(PSODIR("CS")),"^",2)=1 W !,"No refills allowed on Schedule 2 drugs...",! S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0 G REFILLX
"RTN","PSODIR1",109,0)
 I $D(CLOZPAT) S PSOX=$S($G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,1:0)
"RTN","PSODIR1",110,0)
 S DIR(0)="N^"_$S($G(RFTT):RFTT,1:0)_":"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR1",111,0)
 S DIR("B")=$S($G(COPY):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR1",112,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR1",113,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") REFILLX
"RTN","PSODIR1",114,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR1",115,0)
REFILLX S:$G(PSODIR("# OF REFILLS"))']"" PSODIR("# OF REFILLS")=$S($G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR1",116,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA,PSOCS
"RTN","PSODIR1",117,0)
 Q
"RTN","PSODIR1",118,0)
 ;OERR CALL
"RTN","PSODIR1",119,0)
REFOR ;
"RTN","PSODIR1",120,0)
 D REFOR^PSODIR3
"RTN","PSODIR1",121,0)
 G REFILLX
"RTN","PSODIR1",122,0)
 Q
"RTN","PSODIR1",123,0)
DIR ;
"RTN","PSODIR1",124,0)
 S (PSODIR("FIELD"),PSODIR("DFLG"))=0
"RTN","PSODIR1",125,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR1",126,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR1",127,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",128,0)
 I $D(DIRUT)!($D(DIROUT)),$G(SPEED) S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",129,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR1",130,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT
"RTN","PSODIR1",131,0)
 Q
"RTN","PSODIR1",132,0)
JUMP ;
"RTN","PSODIR1",133,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR1",134,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR1",135,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR1",136,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR1",137,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR1",138,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR1",139,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR1",140,0)
JUMPX S X="^"_X
"RTN","PSODIR1",141,0)
 Q
"RTN","PSODIR1",142,0)
SIGOK ;review and decide on oerr sig
"RTN","PSODIR1",143,0)
 I '$O(SIG(0)) S SIGOK=0 Q
"RTN","PSODIR1",144,0)
 K SIGOK W !,"SIG: "
"RTN","PSODIR1",145,0)
 F SIG=0:0 S SIG=$O(SIG(SIG)) W SIG(SIG)_" ",!?5 Q:'$O(SIG(SIG))
"RTN","PSODIR1",146,0)
 K DIR,DIRUT,DUOUT,DTOUT S DIR("B")="YES",DIR(0)="Y",DIR("A")="Is this SIG correct" D ^DIR K DIR I $D(DIRUT) S PSODIR("DFLG")=1 K DIRUT,DUOUT,DTOUT Q
"RTN","PSODIR1",147,0)
 S SIGOK=Y I Y K PSODIR("SIG")
"RTN","PSODIR1",148,0)
 Q
"RTN","PSODIR1",149,0)
PSTPB ;
"RTN","PSODIR1",150,0)
 W !,"New orders entered through this option must have a Patient Status of 'NON-VA'!",!
"RTN","PSODIR1",151,0)
 Q
"RTN","PSODIR3")
0^2^B24224437
"RTN","PSODIR3",1,0)
PSODIR3 ;ISC-BIRM/SAB - rx order entry contd ;09/27/96
"RTN","PSODIR3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,46,184**;DEC 1997
"RTN","PSODIR3",3,0)
 ;
"RTN","PSODIR3",4,0)
EXP(PSODIR) ;
"RTN","PSODIR3",5,0)
 K DIC,DIR
"RTN","PSODIR3",6,0)
 I $G(PSODRUG("EXPIRATION DATE"))]"" S Y=PSODRUG("EXPIRATION DATE") X ^DD("DD") S PSORX("EXPIRATION DATE")=Y
"RTN","PSODIR3",7,0)
 S DIR("A")="EXPIRES",DIR("B")=$S($G(PSORX("EXPIRATION DATE"))]"":PSORX("EXPIRATION DATE"),1:"T+6M")
"RTN","PSODIR3",8,0)
 S DIR(0)="D^NOW::EX",DIR("?")="Both the month and date are required." D ^DIR
"RTN","PSODIR3",9,0)
 G:PSODIR("DFLG")!PSODIR("FIELD") EXPX
"RTN","PSODIR3",10,0)
 S PSODIR("EXPIRATION DATE")=Y
"RTN","PSODIR3",11,0)
EXPX K X,Y
"RTN","PSODIR3",12,0)
 Q
"RTN","PSODIR3",13,0)
 ;
"RTN","PSODIR3",14,0)
MW(PSODIR) ;
"RTN","PSODIR3",15,0)
 K DIR,DIC
"RTN","PSODIR3",16,0)
 S DIR(0)="52,11"
"RTN","PSODIR3",17,0)
 S DIR("B")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),1:"WINDOW")
"RTN","PSODIR3",18,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") MWX
"RTN","PSODIR3",19,0)
 I $G(Y(0))']"" S PSODIR("DFLG")=1 G MWX
"RTN","PSODIR3",20,0)
 S PSODIR("MAIL/WINDOW")=Y,PSORX("MAIL/WINDOW")=Y(0)
"RTN","PSODIR3",21,0)
 I $G(PSORX("EDIT"))]"",PSODIR("MAIL/WINDOW")'="W" K PSODIR("METHOD OF PICK-UP")
"RTN","PSODIR3",22,0)
MW1 G:PSODIR("MAIL/WINDOW")'="W"!('$P($G(PSOPAR),"^",12)) MWX
"RTN","PSODIR3",23,0)
 S DIR(0)="52,35O"
"RTN","PSODIR3",24,0)
 S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP")
"RTN","PSODIR3",25,0)
 D DIR G:PSODIR("DFLG") MWX
"RTN","PSODIR3",26,0)
 I X[U W !,"Cannot jump to another field ..",! G MW1
"RTN","PSODIR3",27,0)
 S (PSODIR("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y
"RTN","PSODIR3",28,0)
MWX K X,Y
"RTN","PSODIR3",29,0)
 Q
"RTN","PSODIR3",30,0)
 ;
"RTN","PSODIR3",31,0)
FILLDT(PSODIR) ;
"RTN","PSODIR3",32,0)
 K DIR,DIC
"RTN","PSODIR3",33,0)
 S DIR("A")="FILL DATE",DIR("B")=$S($G(PSORX("FILL DATE"))]"":PSORX("FILL DATE"),1:"TODAY")
"RTN","PSODIR3",34,0)
 S DIR(0)="D^"_$S($G(PSODIR("ISSUE DATE"))]"":PSODIR("ISSUE DATE"),1:DT)_$S($G(DUZ("AG"))="I":":"_DT_":EX",1:"::EX")
"RTN","PSODIR3",35,0)
 S DIR("?",1)="The earliest fill date allowed is determined by the ISSUE DATE,"
"RTN","PSODIR3",36,0)
 S DIR("?",2)="the FILL DATE cannot be before the ISSUE DATE."
"RTN","PSODIR3",37,0)
 S DIR("?")="Both the month and date are required."
"RTN","PSODIR3",38,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") FILLDTX
"RTN","PSODIR3",39,0)
 S PSODIR("FILL DATE")=Y
"RTN","PSODIR3",40,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y
"RTN","PSODIR3",41,0)
FILLDTX K X,Y
"RTN","PSODIR3",42,0)
 Q
"RTN","PSODIR3",43,0)
 ;
"RTN","PSODIR3",44,0)
CLERK(PSODIR) ;
"RTN","PSODIR3",45,0)
 I $G(DUZ("AG"))'="I",$G(DUZ) S PSODIR("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^") G CLERKX
"RTN","PSODIR3",46,0)
 K DIR,DIC
"RTN","PSODIR3",47,0)
 S DIR("A")="CLERK",DIR("B")=$S($G(PSORX("CLERK CODE"))]"":PSORX("CLERK CODE"),1:$P($G(^VA(200,DUZ,0)),"^",2)),DIR(0)="52,16"
"RTN","PSODIR3",48,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") CLERKX
"RTN","PSODIR3",49,0)
 S PSODIR("CLERK CODE")=+Y,PSORX("CLERK CODE")=$P(Y,"^")
"RTN","PSODIR3",50,0)
CLERKX Q
"RTN","PSODIR3",51,0)
 ;
"RTN","PSODIR3",52,0)
DIR ;
"RTN","PSODIR3",53,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR3",54,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR3",55,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR3",56,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR3",57,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR3",58,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR3",59,0)
 Q
"RTN","PSODIR3",60,0)
 ;
"RTN","PSODIR3",61,0)
JUMP ;
"RTN","PSODIR3",62,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR3",63,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR3",64,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR3",65,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR3",66,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR3",67,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR3",68,0)
JUMPX S X="^"_X
"RTN","PSODIR3",69,0)
 Q
"RTN","PSODIR3",70,0)
 ;Continued from PSODIR1, Tag REFOR, Added PSOCS set and changed G REFILLX references to a QUIT
"RTN","PSODIR3",71,0)
REFOR ;
"RTN","PSODIR3",72,0)
 F DEA=1:1 Q:$E($G(PSODRUG("DEA")),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOCS,"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOCS,"^",2)=1
"RTN","PSODIR3",73,0)
 I $G(PSOCS) D
"RTN","PSODIR3",74,0)
 .S (PSOX,PSOMAX)=$S($G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,$D(CLOZPAT)&(PSODIR("DAYS SUPPLY")'=7):0,1:5)
"RTN","PSODIR3",75,0)
 .S PSOX=$S('PSOX:0,PSODIR("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR3",76,0)
 E  D
"RTN","PSODIR3",77,0)
 .S (PSOX,PSOMAX)=$S($G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,$D(CLOZPAT)&(PSODIR("DAYS SUPPLY")'=7):0,1:11)
"RTN","PSODIR3",78,0)
 .S PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR3",79,0)
 K PSOELSE I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F") D  Q
"RTN","PSODIR3",80,0)
 .S VALMSG="No refills allowed on "_$S($G(PSODRUG("DEA"))["F":"this drug.",1:"Narcotics ..")
"RTN","PSODIR3",81,0)
 .W !,VALMSG,!
"RTN","PSODIR3",82,0)
 .S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR3",83,0)
 I $D(CLOZPAT) D
"RTN","PSODIR3",84,0)
 .S PSOX=$S($G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,1:0)
"RTN","PSODIR3",85,0)
 .I PSODIR("DAYS SUPPLY")'=7 S (PSODIR("# OF REFILLS"),PSODIR("N# REF"))=0
"RTN","PSODIR3",86,0)
 S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR3",87,0)
 S DIR("B")=$S($G(POERR)&($G(PSODIR("# OF REFILLS"))):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR3",88,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR3",89,0)
 D DIR Q:PSODIR("DFLG")!PSODIR("FIELD")
"RTN","PSODIR3",90,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR3",91,0)
 Q
"RTN","PSORESK")
0^4^B55889598
"RTN","PSORESK",1,0)
PSORESK ;BIR/SAB-return to stock ;03/31/93
"RTN","PSORESK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,9,27,40,47,55,85,130,185,184**;DEC 1997
"RTN","PSORESK",3,0)
 ;
"RTN","PSORESK",4,0)
 ;REF/IA
"RTN","PSORESK",5,0)
 ;^PSDRUG/221
"RTN","PSORESK",6,0)
 ;^PS(59.7/694
"RTN","PSORESK",7,0)
 ;L, UL, PSOL, and PSOUL^PSSLOCK/2789
"RTN","PSORESK",8,0)
 ;^PS(55/2228
"RTN","PSORESK",9,0)
 ;PSDRTS^PSDOPT0/3064
"RTN","PSORESK",10,0)
AC I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W !!,"Outpatient Pharmacy Site Parameters are required!" Q
"RTN","PSORESK",11,0)
 S RESK=1 K PSODEF,^UTILITY($J,"PSOPCE") S PSOPCECT=1
"RTN","PSORESK",12,0)
BC K PSOWHERE,PSODEFLG,PSOINVTX,XTYPE W !! S DIR("A")="Enter/Wand PRESCRIPTION number",DIR("?")="^D HP^PSORESK1",DIR(0)="FO" D ^DIR K DIR I $D(DIRUT) K PSODEF G EX
"RTN","PSORESK",13,0)
 I X'["-" D BCI W:'$G(RXP) !,"INVALID Rx" G:'$G(RXP) BC G BC1
"RTN","PSORESK",14,0)
 I X["-" D  I $P(X,"-")'=$G(PSORESST) W !,$C(7),$C(7),"   INVALID STATION NUMBER !!",$C(7),$C(7),! K PSORESST G BC
"RTN","PSORESK",15,0)
 .K PSORESST S PSORESSX=$G(X) K PSORESAR S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DIQ="PSORESAR",DR="99" D EN^DIQ1 S PSORESST=$G(PSORESAR(4,DA,99,"I")) K PSORESAR,DIQ,DA,DR S X=$G(PSORESSX) K PSORESSX
"RTN","PSORESK",16,0)
 I X["-" S RXP=$P(X,"-",2) I '$D(^PSRX(+$G(RXP),0))!($G(RXP)']"") W !,$C(7),$C(7),$C(7),"   NON-EXISTENT Rx" G BC
"RTN","PSORESK",17,0)
 G:$D(^PSRX(RXP,0)) BC1 W !,$C(7),$C(7),$C(7),"   IMPROPER BARCODE FORMAT" G BC
"RTN","PSORESK",18,0)
BC1 ;
"RTN","PSORESK",19,0)
 S PSORRDFN=+$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSORESK",20,0)
 D ICN^PSODPT(PSORRDFN)
"RTN","PSORESK",21,0)
 S PSOPLCK=$$L^PSSLOCK(PSORRDFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G BC
"RTN","PSORESK",22,0)
 K PSOPLCK D PSOL^PSSLOCK(RXP) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),! K PSOMSG D UL^PSSLOCK(+$G(PSORRDFN)) G BC
"RTN","PSORESK",23,0)
 S PSOLOUD=1 D:$P($G(^PS(55,+$P(^PSRX(RXP,0),"^",2),0)),"^",6)'=2 EN^PSOHLUP($P(^PSRX(RXP,0),"^",2)) K PSOLOUD
"RTN","PSORESK",24,0)
 I $S('+$P($G(^PSRX(+RXP,"STA")),"^"):0,$P(^("STA"),"^")=11:0,$P(^("STA"),"^")=12:0,$P(^("STA"),"^")=14:0,$P(^("STA"),"^")=15:0,1:1) D STAT^PSORESK1 D UL G BC
"RTN","PSORESK",25,0)
 S COPAYFLG=1,QDRUG=$P($G(^PSRX(RXP,0)),"^",6),QTY=$P($G(^(0)),"^",7) I $O(^PSRX(RXP,1,0)) G REF
"RTN","PSORESK",26,0)
 S Y="O" I $O(^PSRX(RXP,"P",0)) D  I $D(DUOUT)!($D(DTOUT)) D UL G BC
"RTN","PSORESK",27,0)
 .S DIR(0)="SA^O:ORIGINAL;P:PARTIAL",DIR("B")="ORIGINAL",DIR("A",1)="",DIR("A",2)="There are Partials for this Rx.",DIR("A")="Which are you Returning To Stock? "
"RTN","PSORESK",28,0)
 .S DIR("?")=" Press return for Original. Enter 'P' for Partial" D ^DIR K DIR
"RTN","PSORESK",29,0)
 S XTYPE=$S(Y="O":"O",1:"P") G:Y="P" PAR
"RTN","PSORESK",30,0)
 I $P($G(^PSRX(RXP,2)),"^",15) W !,$C(7),$C(7),"Original fill for Rx # "_$P(^PSRX(RXP,0),"^")_" was Returned to Stock." D UL G BC
"RTN","PSORESK",31,0)
 I '$P($G(^PSRX(RXP,2)),"^",13) W !,$C(7),$C(7),"Rx # "_$P(^PSRX(RXP,0),"^")_" was NOT released !" D UL G BC
"RTN","PSORESK",32,0)
 S PSOLOCRL=$P($G(^PSRX(RXP,2)),"^",13),PSOWHERE=$S($D(^PSRX("AR",+$G(PSOLOCRL),RXP,0)):1,1:0)
"RTN","PSORESK",33,0)
 W ! S DIR("B")="YES",DIR("A",1)="Are you sure you want to RETURN TO STOCK Rx # "_$P(^PSRX(RXP,0),"^")
"RTN","PSORESK",34,0)
 S DIR("A",2)="for "_$P(^DPT($P(^PSRX(RXP,0),"^",2),0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",DIR("A")="Drug: "_$P(^PSDRUG($P(^PSRX(RXP,0),"^",6),0),"^")
"RTN","PSORESK",35,0)
 I $G(PSOWHERE) S DIR("A",3)=" ",DIR("A",4)="   *** This prescription was filled at the CMOP *** ",DIR("A",5)=" "
"RTN","PSORESK",36,0)
 S DIR(0)="YO" D ^DIR K DIR I Y=0!($D(DIRUT)) D UL G BC
"RTN","PSORESK",37,0)
 ;ORI
"RTN","PSORESK",38,0)
 D  D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",39,0)
 .I $T(PSDRTS^PSDOPT0)]"" D PSDRTS^PSDOPT0(RXP,"O^"_0,$P(^PSRX(RXP,2),"^",9),$P(^PSRX(RXP,0),"^",7)) D MSG
"RTN","PSORESK",40,0)
 .Q:$G(RETSK)
"RTN","PSORESK",41,0)
 .K PSOINVTX,PSODEFLG I $G(PSOWHERE),$G(^PSDRUG(QDRUG,660.1)) D INVT^PSORXDL I $G(PSODEFLG) W !!?5,"Prescription Not Returned to Stock!",! Q
"RTN","PSORESK",42,0)
 .I +$G(^PSRX(RXP,"IB")) D CP^PSORESK1 Q:'$G(COPAYFLG)
"RTN","PSORESK",43,0)
 .;Ask comments until answered, do not allow exiting.
"RTN","PSORESK",44,0)
 .F  D  I '$D(DIRUT) Q
"RTN","PSORESK",45,0)
 ..K DIR,DUOUT,DTOUT,DIRUT,X,Y
"RTN","PSORESK",46,0)
 ..S DIR(0)="F0^10:75",DIR("A")="Comments",DIR("?")="Comments are required, 10-75 characters."
"RTN","PSORESK",47,0)
 ..S DIR("B")=$S($D(PSODEF):PSODEF,1:"Per Pharmacy Request")
"RTN","PSORESK",48,0)
 ..D ^DIR I $D(DIRUT) W !?5,"Comments are required, 10-75 characters.",! Q
"RTN","PSORESK",49,0)
 ..S (PSODEF,COM)=$G(Y) K DIR,X,Y
"RTN","PSORESK",50,0)
 ..Q
"RTN","PSORESK",51,0)
 .I $G(^PSDRUG(QDRUG,660.1)) D
"RTN","PSORESK",52,0)
 ..I $G(PSOWHERE),'$G(PSOINVTX) Q
"RTN","PSORESK",53,0)
 ..S ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)+QTY
"RTN","PSORESK",54,0)
 .I $G(PSOWHERE) K ^PSRX("AR",+$G(PSOLOCRL),RXP,0)
"RTN","PSORESK",55,0)
 .D NOW^%DTC S DA=RXP,DA=RXP,DIE="^PSRX(",DR="31///@;32.1///"_% D ^DIE K DIE,DR,DA Q:$D(Y)
"RTN","PSORESK",56,0)
 .D ACT^PSORESK1 S DA=$O(^PS(52.5,"B",RXP,0)) I DA S DIK="^PS(52.5," D ^DIK
"RTN","PSORESK",57,0)
 .D EN^PSOHLSN1(RXP,"ZD") W !,"Rx # "_$P(^PSRX(RXP,0),"^")_" Returned to Stock.",!
"RTN","PSORESK",58,0)
 .Q
"RTN","PSORESK",59,0)
 ;
"RTN","PSORESK",60,0)
REF I $O(^PSRX(RXP,1,0)),$O(^PSRX(RXP,"P",0)) D  I $D(DTOUT)!($D(DUOUT)) D UL G BC
"RTN","PSORESK",61,0)
 .S DIR(0)="SA^R:REFILL;P:PARTIAL",DIR("B")="REFILL",DIR("A",1)="",DIR("A",2)="There are Refills and Partials for this Rx.",DIR("A")="Which are you Returning To Stock? "
"RTN","PSORESK",62,0)
 .S DIR("?")=" Press return for Refill. Enter 'P' for Partial" D ^DIR K DIR
"RTN","PSORESK",63,0)
 I $O(^PSRX(RXP,1,0)),$O(^PSRX(RXP,"P",0)) S XTYPE=$S(Y="R":1,1:"P")
"RTN","PSORESK",64,0)
PAR S:$G(XTYPE)']"" XTYPE=1 S TYPE=0 F YY=0:0 S YY=$O(^PSRX(RXP,XTYPE,YY)) Q:'YY  S TYPE=YY
"RTN","PSORESK",65,0)
 I 'TYPE D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",66,0)
 I $P($G(^PSRX(RXP,XTYPE,TYPE,0)),"^",16) W $C(7),!!,"Last Fill Already Returned to Stock !",! D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",67,0)
 I '$P(^PSRX(RXP,XTYPE,TYPE,0),"^",$S(XTYPE:18,1:19)) W !!,$C(7),$C(7),$S(XTYPE:"Refill",1:"PARTIAL")_" #"_TYPE_" was NOT released !",! D UL G BC
"RTN","PSORESK",68,0)
 W ! K DIR,DUOUT,DTOUT
"RTN","PSORESK",69,0)
 K PSOLOCRL,PSOWHERE I $G(XTYPE) S PSOLOCRL=$P($G(^PSRX(RXP,XTYPE,+$G(TYPE),0)),"^",18),PSOWHERE=$S($D(^PSRX("AR",+$G(PSOLOCRL),RXP,+$G(TYPE))):1,1:0)
"RTN","PSORESK",70,0)
 W ! S DIR("B")="YES",DIR("A",1)="Are you sure you want to RETURN TO STOCK Rx # "_$P(^PSRX(RXP,0),"^")_$S(XTYPE:" Refill ",1:" Partial ")_"# "_TYPE,DIR(0)="Y"
"RTN","PSORESK",71,0)
 S DIR("A",2)="for "_$P(^DPT($P(^PSRX(RXP,0),"^",2),0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",DIR("A")="Drug: "_$P(^PSDRUG($P(^PSRX(RXP,0),"^",6),0),"^")
"RTN","PSORESK",72,0)
 I $G(PSOWHERE) S DIR("A",3)=" ",DIR("A",4)="   *** This prescription was filled at the CMOP *** ",DIR("A",5)=" "
"RTN","PSORESK",73,0)
 D ^DIR K DIR I 'Y!($D(DUOUT))!($D(DTOUT)) D UL G BC
"RTN","PSORESK",74,0)
 I $T(PSDRTS^PSDOPT0)]"" D
"RTN","PSORESK",75,0)
 .I XTYPE D PSDRTS^PSDOPT0(RXP,"R^"_TYPE,$P(^PSRX(RXP,1,TYPE,0),"^",9),$P(^(0),"^",4)) D MSG Q
"RTN","PSORESK",76,0)
 .D PSDRTS^PSDOPT0(RXP,"P^"_TYPE,$P(^PSRX(RXP,"P",TYPE,0),"^",9),$P(^(0),"^",4)) D MSG
"RTN","PSORESK",77,0)
 I $G(RETSK) D UL,EX G BC
"RTN","PSORESK",78,0)
 K PSOINVTX,PSODEFLG I $G(PSOWHERE),$G(^PSDRUG(QDRUG,660.1)) D INVT^PSORXDL I $G(PSODEFLG) W !!?5,"Prescription Not Returned to Stock!",! D UL G BC
"RTN","PSORESK",79,0)
 I +$G(^PSRX(RXP,"IB")),XTYPE D CP^PSORESK1 I '$G(COPAYFLG) D UL G BC
"RTN","PSORESK",80,0)
 ;Ask comments until answered, do not allow exiting.
"RTN","PSORESK",81,0)
 F  D  I '$D(DIRUT) Q
"RTN","PSORESK",82,0)
 .K DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORESK",83,0)
 .S DIR(0)="F0^10:75",DIR("A")="Comments",DIR("?")="Comments are required, 10-75 characters."
"RTN","PSORESK",84,0)
 .S DIR("B")=$S($D(PSODEF):PSODEF,1:"Per Pharmacy Request")
"RTN","PSORESK",85,0)
 .D ^DIR K DIR I $D(DIRUT) W !?5,"Comments are required, 10-75 characters.",! Q
"RTN","PSORESK",86,0)
 .Q
"RTN","PSORESK",87,0)
 S (PSODEF,COM)=$G(Y) K X,Y
"RTN","PSORESK",88,0)
 D NOW^%DTC S QTY=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",4) I $G(^PSDRUG(QDRUG,660.1)) D
"RTN","PSORESK",89,0)
 .I $G(PSOWHERE),'$G(PSOINVTX) Q
"RTN","PSORESK",90,0)
 .S ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)+$G(QTY)
"RTN","PSORESK",91,0)
 I $G(PSOWHERE) K ^PSRX("AR",+$G(PSOLOCRL),RXP,$G(TYPE))
"RTN","PSORESK",92,0)
 S DA(1)=RXP,DA=TYPE,DIE="^PSRX("_DA(1)_","_$S(XTYPE:1,1:"""P""")_",",DR=$S(XTYPE:"17////@",1:"8////@")_";.01///@"
"RTN","PSORESK",93,0)
 W ! D ^DIE I $D(Y) D UL G BC
"RTN","PSORESK",94,0)
 D:XTYPE'="P" NPF
"RTN","PSORESK",95,0)
 D ACT^PSORESK1
"RTN","PSORESK",96,0)
 W !!,"Rx # "_$P(^PSRX(RXP,0),"^")_$S(XTYPE:" REFILL",1:" PARTIAL")_" #"_TYPE_" Returned to Stock" S DA=$O(^PS(52.5,"B",RXP,0)) I DA S DIK="^PS(52.5," D ^DIK
"RTN","PSORESK",97,0)
 K PSODISPP S:'$G(XTYPE) PSODISPP=1 D EN^PSOHLSN1(RXP,"ZD") K PSODISPP
"RTN","PSORESK",98,0)
 D UL G BC
"RTN","PSORESK",99,0)
EX ;
"RTN","PSORESK",100,0)
 K DA,DR,DIE,X,X1,X2,Y,RXP,REC,DIR,XDT,REC,RDUZ,DIRUT,PSOCPN,PSOCPRX,YY,QDRUG,QTY,TYPE,XTYPE,I,%,DIRUT,COPAYFLG,PSOINVTX,RESK,PSOPCECT,COM,PSOWHERE,PSOLOCRL,PSODEFLG,PSORRDFN,PSOMSG,PSOPLCK,PSDCS,PSDRS,RETSK
"RTN","PSORESK",101,0)
 Q
"RTN","PSORESK",102,0)
MSG I $G(PSDCS),'$G(PSDRS) W !!,"The PSDMGR key is required to return a CONTROLLED SUBSTANCE Rx to stock and",!,"update corresponding vault balances." S RETSK=1
"RTN","PSORESK",103,0)
 Q
"RTN","PSORESK",104,0)
BCI S RXP=0
"RTN","PSORESK",105,0)
RXP S RXP=$O(^PSRX("B",X,RXP)) I $P($G(^PSRX(+RXP,"STA")),"^")=13 G RXP
"RTN","PSORESK",106,0)
 Q
"RTN","PSORESK",107,0)
UL ;
"RTN","PSORESK",108,0)
 I $G(RXP) D PSOUL^PSSLOCK(RXP)
"RTN","PSORESK",109,0)
 D UL^PSSLOCK(+$G(PSORRDFN))
"RTN","PSORESK",110,0)
 Q
"RTN","PSORESK",111,0)
NPF N PSOY I $G(TYPE)-1>0,+$P(^PSRX(RXP,1,TYPE-1,0),"^") D
"RTN","PSORESK",112,0)
 .S X1=+$P(^PSRX(RXP,1,$G(TYPE)-1,0),"^"),X2=$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",113,0)
 .D C^%DTC S PSOY=X,X1=$P(^PSRX(RXP,2),"^",2),X2=TYPE*$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",114,0)
 .D C^%DTC S X=$S(PSOY<X:X,1:PSOY)
"RTN","PSORESK",115,0)
 I $G(TYPE)-1<1 D
"RTN","PSORESK",116,0)
 .S X1=$P(^PSRX(RXP,2),"^",2),X2=$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",117,0)
 .D C^%DTC S:$P(^PSRX(RXP,3),"^",8) X=""
"RTN","PSORESK",118,0)
 I $G(X) S DA=RXP,DIE=52,DR="102///"_X D ^DIE K DIE
"RTN","PSORESK",119,0)
 Q
"VER")
8.0^22.0
**END**
**END**
