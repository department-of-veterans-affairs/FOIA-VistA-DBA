Released PSA*3*50 SEQ #42
Extracted from mail message
**KIDS**:PSA*3.0*50^

**INSTALL NAME**
PSA*3.0*50
"BLD",6552,0)
PSA*3.0*50^DRUG ACCOUNTABILITY^0^3060602^y
"BLD",6552,1,0)
^^21^21^3060216^
"BLD",6552,1,1,0)
This patch addresses the following problems:
"BLD",6552,1,2,0)
   
"BLD",6552,1,3,0)
1. HD 68113 Invoice select prompt (1-0)
"BLD",6552,1,4,0)
The software is not properly detecting when all invoices being worked 
"BLD",6552,1,5,0)
with have been processed. It is asking the user to make a selection when 
"BLD",6552,1,6,0)
there are no invoices left to select from. The software errors out with 
"BLD",6552,1,7,0)
an undefined if the user continues.
"BLD",6552,1,8,0)
 
"BLD",6552,1,9,0)
2. HD 93607 A faulty message 'The invoice has not been placed in a 
"BLD",6552,1,10,0)
Processed status!' is presented.
"BLD",6552,1,11,0)
Processing invoices through a particular path and question sequence will 
"BLD",6552,1,12,0)
generate the above message which is wrong as the invoice has just 
"BLD",6552,1,13,0)
completed processing necessary to be able to proceed to the verification 
"BLD",6552,1,14,0)
stage.
"BLD",6552,1,15,0)
 
"BLD",6552,1,16,0)
3. HD 91604 An undefined error occurs when the selection list of invoices 
"BLD",6552,1,17,0)
to send on to verification has a missed node in the display numbering 
"BLD",6552,1,18,0)
sequence of the invoices. The user is able to put in a range from the 
"BLD",6552,1,19,0)
beginning of the list to the last number in the list and the processing 
"BLD",6552,1,20,0)
tries to work on all numbers in between. It hits the number of the 
"BLD",6552,1,21,0)
missing node and it breaks.
"BLD",6552,4,0)
^9.64PA^^
"BLD",6552,"KRN",0)
^9.67PA^8989.52^19
"BLD",6552,"KRN",.4,0)
.4
"BLD",6552,"KRN",.401,0)
.401
"BLD",6552,"KRN",.402,0)
.402
"BLD",6552,"KRN",.403,0)
.403
"BLD",6552,"KRN",.5,0)
.5
"BLD",6552,"KRN",.84,0)
.84
"BLD",6552,"KRN",3.6,0)
3.6
"BLD",6552,"KRN",3.8,0)
3.8
"BLD",6552,"KRN",9.2,0)
9.2
"BLD",6552,"KRN",9.8,0)
9.8
"BLD",6552,"KRN",9.8,"NM",0)
^9.68A^7^3
"BLD",6552,"KRN",9.8,"NM",3,0)
PSAPROC1^^0^B40499741
"BLD",6552,"KRN",9.8,"NM",5,0)
PSAPROC2^^0^B70245487
"BLD",6552,"KRN",9.8,"NM",7,0)
PSAPROC6^^0^B76371787
"BLD",6552,"KRN",9.8,"NM","B","PSAPROC1",3)

"BLD",6552,"KRN",9.8,"NM","B","PSAPROC2",5)

"BLD",6552,"KRN",9.8,"NM","B","PSAPROC6",7)

"BLD",6552,"KRN",19,0)
19
"BLD",6552,"KRN",19.1,0)
19.1
"BLD",6552,"KRN",101,0)
101
"BLD",6552,"KRN",409.61,0)
409.61
"BLD",6552,"KRN",771,0)
771
"BLD",6552,"KRN",870,0)
870
"BLD",6552,"KRN",8989.51,0)
8989.51
"BLD",6552,"KRN",8989.52,0)
8989.52
"BLD",6552,"KRN",8994,0)
8994
"BLD",6552,"KRN","B",.4,.4)

"BLD",6552,"KRN","B",.401,.401)

"BLD",6552,"KRN","B",.402,.402)

"BLD",6552,"KRN","B",.403,.403)

"BLD",6552,"KRN","B",.5,.5)

"BLD",6552,"KRN","B",.84,.84)

"BLD",6552,"KRN","B",3.6,3.6)

"BLD",6552,"KRN","B",3.8,3.8)

"BLD",6552,"KRN","B",9.2,9.2)

"BLD",6552,"KRN","B",9.8,9.8)

"BLD",6552,"KRN","B",19,19)

"BLD",6552,"KRN","B",19.1,19.1)

"BLD",6552,"KRN","B",101,101)

"BLD",6552,"KRN","B",409.61,409.61)

"BLD",6552,"KRN","B",771,771)

"BLD",6552,"KRN","B",870,870)

"BLD",6552,"KRN","B",8989.51,8989.51)

"BLD",6552,"KRN","B",8989.52,8989.52)

"BLD",6552,"KRN","B",8994,8994)

"BLD",6552,"QUES",0)
^9.62^^
"BLD",6552,"REQB",0)
^9.611^1^1
"BLD",6552,"REQB",1,0)
PSA*3.0*34^1
"BLD",6552,"REQB","B","PSA*3.0*34",1)

"MBREQ")
0
"PKG",487,-1)
1^1
"PKG",487,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",487,20,0)
^9.402P^^
"PKG",487,22,0)
^9.49I^1^1
"PKG",487,22,1,0)
3.0^2971024^2981028^66481
"PKG",487,22,1,"PAH",1,0)
50^3060602^123456966
"PKG",487,22,1,"PAH",1,1,0)
^^21^21^3060602
"PKG",487,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",487,22,1,"PAH",1,1,2,0)
   
"PKG",487,22,1,"PAH",1,1,3,0)
1. HD 68113 Invoice select prompt (1-0)
"PKG",487,22,1,"PAH",1,1,4,0)
The software is not properly detecting when all invoices being worked 
"PKG",487,22,1,"PAH",1,1,5,0)
with have been processed. It is asking the user to make a selection when 
"PKG",487,22,1,"PAH",1,1,6,0)
there are no invoices left to select from. The software errors out with 
"PKG",487,22,1,"PAH",1,1,7,0)
an undefined if the user continues.
"PKG",487,22,1,"PAH",1,1,8,0)
 
"PKG",487,22,1,"PAH",1,1,9,0)
2. HD 93607 A faulty message 'The invoice has not been placed in a 
"PKG",487,22,1,"PAH",1,1,10,0)
Processed status!' is presented.
"PKG",487,22,1,"PAH",1,1,11,0)
Processing invoices through a particular path and question sequence will 
"PKG",487,22,1,"PAH",1,1,12,0)
generate the above message which is wrong as the invoice has just 
"PKG",487,22,1,"PAH",1,1,13,0)
completed processing necessary to be able to proceed to the verification 
"PKG",487,22,1,"PAH",1,1,14,0)
stage.
"PKG",487,22,1,"PAH",1,1,15,0)
 
"PKG",487,22,1,"PAH",1,1,16,0)
3. HD 91604 An undefined error occurs when the selection list of invoices 
"PKG",487,22,1,"PAH",1,1,17,0)
to send on to verification has a missed node in the display numbering 
"PKG",487,22,1,"PAH",1,1,18,0)
sequence of the invoices. The user is able to put in a range from the 
"PKG",487,22,1,"PAH",1,1,19,0)
beginning of the list to the last number in the list and the processing 
"PKG",487,22,1,"PAH",1,1,20,0)
tries to work on all numbers in between. It hits the number of the 
"PKG",487,22,1,"PAH",1,1,21,0)
missing node and it breaks.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSAPROC1")
0^3^B40499741^B38965265
"RTN","PSAPROC1",1,0)
PSAPROC1 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**12,21,50**; 10/24/97
"RTN","PSAPROC1",3,0)
 ;
"RTN","PSAPROC1",4,0)
 ;This routine processes uploaded invoices.
"RTN","PSAPROC1",5,0)
 ;
"RTN","PSAPROC1",6,0)
 ;;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC1",7,0)
 ;
"RTN","PSAPROC1",8,0)
CHK ;Check for invoices with a status of "OK" (uploaded & error free)
"RTN","PSAPROC1",9,0)
 ;& status of "" (uploaded & errors). 
"RTN","PSAPROC1",10,0)
 K PSA,PSAOK S (PSACNTOK,PSACNTER,PSACTRL)=0
"RTN","PSAPROC1",11,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC1",12,0)
 .;DAVE B (PSA*3*12 13MAY99) Restrict to appropriate division
"RTN","PSAPROC1",13,0)
 .I $G(PSASORT)'=0,$G(PSASORT)'="",$D(^XTMP("PSAPV",PSACTRL,"ST")),$P(^XTMP("PSAPV",PSACTRL,"ST"),"^",1)'=PSASORT Q
"RTN","PSAPROC1",14,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))  S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC1",15,0)
 .I $P(PSAIN,"^",8)="OK"!($P(PSAIN,"^",13)="SUP") D  Q
"RTN","PSAPROC1",16,0)
 ..I $P(PSAIN,"^",10)="ALL CS",$P(PSAIN,"^",12)'="" D OK Q
"RTN","PSAPROC1",17,0)
 ..I $P(PSAIN,"^",10)'="ALL CS",$P(PSAIN,"^",9)="CS",$P(PSAIN,"^",12)'="",$P(PSAIN,"^",7)'="" D OK Q
"RTN","PSAPROC1",18,0)
 ..I $P(PSAIN,"^",10)'="ALL CS",$P(PSAIN,"^",9)'="CS",$P(PSAIN,"^",7)'="" D OK Q
"RTN","PSAPROC1",19,0)
 ..S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=$P(PSAIN,"^",4)_"^"_$P(PSAIN,"^",2)_"^"_PSACTRL_"^"_$P(PSAIN,"^",7)
"RTN","PSAPROC1",20,0)
 .I $P(PSAIN,"^",8)="" S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=$P(PSAIN,"^",4)_"^"_$P(PSAIN,"^",2)_"^"_PSACTRL_"^"_$P(PSAIN,"^",7)
"RTN","PSAPROC1",21,0)
 S PSA=+$O(PSAOK(0))
"RTN","PSAPROC1",22,0)
 G:'PSA ^PSAPROC2
"RTN","PSAPROC1",23,0)
 ;
"RTN","PSAPROC1",24,0)
NOERROR ;Display list of invoices that can be processed by selecting
"RTN","PSAPROC1",25,0)
 ;invoice number.
"RTN","PSAPROC1",26,0)
 W @IOF,!?21,"<<< PROCESS ENTIRE INVOICE SCREEN >>>"
"RTN","PSAPROC1",27,0)
 W !!?2,"No errors have been detected on the following invoices. If there are no",!?2,"corrections, you can change the invoices' status to ""Processed"" by"
"RTN","PSAPROC1",28,0)
 W !?2,"selecting them from the list. If you do have corrections, press the return",!?2,"key then a second list will be displayed. You will be able to choose the",!?2,"invoices from that list and enter corrections."
"RTN","PSAPROC1",29,0)
 W !!?2,"Choose the invoices from the list you want to process.",!,PSADLN
"RTN","PSAPROC1",30,0)
 S (PSACNT,PSASTOP)=0,PSAMENU=""
"RTN","PSAPROC1",31,0)
 F  S PSAMENU=$O(PSAOK(PSAMENU)) Q:PSAMENU=""!(PSAOUT)  D  Q:PSASTOP
"RTN","PSAPROC1",32,0)
 .I $Y+4>IOSL D HEADER Q:PSASTOP
"RTN","PSAPROC1",33,0)
 .S PSAORD=$P(PSAOK(PSAMENU),"^"),PSAINV=$P(PSAOK(PSAMENU),"^",2),PSACTRL=$P(PSAOK(PSAMENU),"^",3),PSACNT=PSACNT+1
"RTN","PSAPROC1",34,0)
 .W !?2,PSAMENU_". ",?4,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC1",35,0)
 K PSASTOP W !,PSADLN
"RTN","PSAPROC1",36,0)
 S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices to process",DIR("?",1)="Enter the number to the left of the invoice",DIR("?")="data to be processed or a range of numbers." W !
"RTN","PSAPROC1",37,0)
 S DIR("??")="^D SEL^PSAPROC1" D ^DIR K DIR G:Y="" EDIT I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC1",38,0)
 S PSASEL=Y
"RTN","PSAPROC1",39,0)
INVSEL F PSAPC=1:1 S PSA=+$P(PSASEL,",",PSAPC) Q:'PSA  D  Q:PSAOUT
"RTN","PSAPROC1",40,0)
 .I '$D(PSAOK(PSA)) Q  ;*50
"RTN","PSAPROC1",41,0)
 .S PSACTRL=$P(PSAOK(PSA),"^",3) Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC1",42,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSARECD=+$P(PSAIN,"^",6),PSALINES=0
"RTN","PSAPROC1",43,0)
 .D PROCESS
"RTN","PSAPROC1",44,0)
 Q:PSAOUT  G:'+$O(PSAOK(0)) PROC2
"RTN","PSAPROC1",45,0)
EDIT ;Edit error free invoices
"RTN","PSAPROC1",46,0)
 S PSA=0 F  S PSA=$O(PSAOK(PSA)) Q:'PSA  D
"RTN","PSAPROC1",47,0)
 .I $P($G(^XTMP("PSAPV",$P(PSAOK(PSA),"^",3),"IN")),"^",8)="OK"!($P($G(^("IN")),"^",13)="SUP") D
"RTN","PSAPROC1",48,0)
 ..S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=$P(^XTMP("PSAPV",$P(PSAOK(PSA),"^",3),"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_$P(PSAOK(PSA),"^",3)_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC1",49,0)
 ;
"RTN","PSAPROC1",50,0)
PROC2 I +$O(PSAERR(0)) D ^PSAPROC2
"RTN","PSAPROC1",51,0)
 Q
"RTN","PSAPROC1",52,0)
 ;
"RTN","PSAPROC1",53,0)
HEADER S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC1",54,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSASTOP=1 Q
"RTN","PSAPROC1",55,0)
 W @IOF,!?21,"<<< PROCESS ENTIRE INVOICE SCREEN >>>",!!,PSADLN
"RTN","PSAPROC1",56,0)
 Q
"RTN","PSAPROC1",57,0)
 ;
"RTN","PSAPROC1",58,0)
PROCESS ;Get date recd & line item data
"RTN","PSAPROC1",59,0)
 I $P(PSAIN,"^",13)="SUP" D HDR,SUPPLY^PSAPROC6 Q
"RTN","PSAPROC1",60,0)
 D HDR,RECD^PSAPROC3 Q:PSAOUT  S (PSACS,PSALNCNT)=0,PSALINE=""
"RTN","PSAPROC1",61,0)
 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D  Q:PSAOUT
"RTN","PSAPROC1",62,0)
 .K PSAPHARM,PSAMV
"RTN","PSAPROC1",63,0)
 .S PSALNCNT=PSALNCNT+1,(PSADISP,PSADU,PSAHDR)=0
"RTN","PSAPROC1",64,0)
 .S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),+$P(PSADATA,"^",6):+$P(PSADATA,"^",6),1:0),PSASUB=+$P(PSADATA,"^",7)
"RTN","PSAPROC1",65,0)
 .S:$P(PSADATA,"^",19)="CS" PSAMV=+$P(PSAIN,"^",12) S:$P(PSADATA,"^",19)'="CS" PSAPHARM=+$P(PSAIN,"^",7)
"RTN","PSAPROC1",66,0)
 .S PSALOC=+$S($P(PSADATA,"^",19)="CS":PSAMV,1:PSAPHARM)
"RTN","PSAPROC1",67,0)
 .I $P($G(^PSDRUG(PSAIEN,660)),"^",8)="" D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D DU^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC1",68,0)
 .I '+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7),$P($G(^PSDRUG(PSAIEN,660)),"^",8)'="" D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D:PSASUB DUOU^PSAPROC8 D:'PSASUB DUOU^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC1",69,0)
 .I +$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6)'=+$P(PSADATA,"^",3) D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D PRICE^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC1",70,0)
 .I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D  Q:PSAOUT
"RTN","PSAPROC1",71,0)
 ..I '+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",3),'+$P(PSADATA,"^",27) D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D STOCK^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC1",72,0)
 ..I '+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",5),'+$P(PSADATA,"^",21) D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D REORDER^PSAPROC8
"RTN","PSAPROC1",73,0)
 .D SETLINE^PSAPROC3 S:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS" PSACS=PSACS+1
"RTN","PSAPROC1",74,0)
 S PSAOK=0
"RTN","PSAPROC1",75,0)
CS I PSACS D  Q:PSAOUT
"RTN","PSAPROC1",76,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAPROC1",77,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)="" K PSACS S PSACS(PSACTRL)="" D MASTER^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)'="" PSAOK=1
"RTN","PSAPROC1",78,0)
 .I PSACS=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS" Q
"RTN","PSAPROC1",79,0)
 .I PSACS'=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)=""
"RTN","PSAPROC1",80,0)
NCS I 'PSACS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="",$P(^("IN"),"^",10)="",$P(^("IN"),"^",12)="" D:$P(^("IN"),"^",7)="" GETLOC^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)'="" PSAOK=1
"RTN","PSAPROC1",81,0)
 ;
"RTN","PSAPROC1",82,0)
 I PSALNCNT=PSALINES S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="P" K PSAOK(PSA) W !!,"The invoice status has been changed to Processed!" D ^PSAPROC7 I 1 ;PSA*3*21 (1/3/01- file immediately);*50 
"RTN","PSAPROC1",83,0)
 E  W !!,"** The invoice has not been placed in a Processed status!"
"RTN","PSAPROC1",84,0)
 D END^PSAPROC
"RTN","PSAPROC1",85,0)
 Q
"RTN","PSAPROC1",86,0)
 ;
"RTN","PSAPROC1",87,0)
HDR ;Header for editing line items with missing data
"RTN","PSAPROC1",88,0)
 S PSAHDR=1
"RTN","PSAPROC1",89,0)
 W @IOF,!?21,"<<< PROCESS ENTIRE INVOICE SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSADLN
"RTN","PSAPROC1",90,0)
 Q
"RTN","PSAPROC1",91,0)
OK ;Sets okay array
"RTN","PSAPROC1",92,0)
 S PSACNTOK=PSACNTOK+1,PSAOK(PSACNTOK)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC1",93,0)
 Q
"RTN","PSAPROC1",94,0)
 ;
"RTN","PSAPROC1",95,0)
SEL ;Extended help to 'Select invoices'
"RTN","PSAPROC1",96,0)
 W !?5,"Enter the number to the left of the invoice data that you want to process."
"RTN","PSAPROC1",97,0)
 Q
"RTN","PSAPROC2")
0^5^B70245487^B69077641
"RTN","PSAPROC2",1,0)
PSAPROC2 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**34,50**; 10/24/97
"RTN","PSAPROC2",3,0)
 ;This routine allows the user to edit invoices with errors or missing
"RTN","PSAPROC2",4,0)
 ;data.
"RTN","PSAPROC2",5,0)
 ;
"RTN","PSAPROC2",6,0)
CHK S PSA=+$O(PSAERR(0))
"RTN","PSAPROC2",7,0)
 I 'PSA W @IOF,!!,"There are no invoices that need to be processed." D END^PSAPROC Q
"RTN","PSAPROC2",8,0)
 ;
"RTN","PSAPROC2",9,0)
INV D HDR W !,"  More data is needed on the following invoices. Choose the invoices from",!,"  the list you want to edit.",!,PSASLN
"RTN","PSAPROC2",10,0)
 S (PSACNT,PSAMENU,PSASTOP)=0
"RTN","PSAPROC2",11,0)
 F  S PSAMENU=+$O(PSAERR(PSAMENU)) Q:'PSAMENU!(PSAOUT)  D  Q:PSASTOP
"RTN","PSAPROC2",12,0)
 .I $Y+4>IOSL D HEADER Q:PSASTOP
"RTN","PSAPROC2",13,0)
 .S PSAORD=$P(PSAERR(PSAMENU),"^"),PSAINV=$P(PSAERR(PSAMENU),"^",2),PSACTRL=$P(PSAERR(PSAMENU),"^",3),PSACNT=PSACNT+1
"RTN","PSAPROC2",14,0)
 .W !?2,PSAMENU_". ",?6,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC2",15,0)
 W !,PSASLN K DIR,PSASTOP
"RTN","PSAPROC2",16,0)
 S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices to edit",DIR("?",1)="Enter the number to the left of the invoice",DIR("?")="data to be processed or a range of numbers." W !
"RTN","PSAPROC2",17,0)
 S DIR("??")="^D SELHELP^PSAPROC2" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC2",18,0)
 S PSASEL=Y
"RTN","PSAPROC2",19,0)
 ;
"RTN","PSAPROC2",20,0)
PROC W ! S DIR("A",1)="Do you want to select the line items to be edited (S) or",DIR("A")="have them automatically (A) displayed for you?",DIR("B")="A",DIR(0)="SB^S:Select;A:Automatically displayed"
"RTN","PSAPROC2",21,0)
 S DIR("?",1)="Enter ""S"" to allow you to select the line items to be edited.",DIR("?",2)="Enter ""A"" to automatically receive prompts for the line items",DIR("?")="that need editing."
"RTN","PSAPROC2",22,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC2",23,0)
 G:Y="S" SEL^PSAPROC6
"RTN","PSAPROC2",24,0)
 ;
"RTN","PSAPROC2",25,0)
AUTO ;Process line items
"RTN","PSAPROC2",26,0)
 F PSAPC=1:1 S PSAMENU=$P(PSASEL,",",PSAPC) Q:'PSAMENU!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAPROC2",27,0)
 .Q:'$D(PSAERR(PSAMENU))
"RTN","PSAPROC2",28,0)
 .S PSACTRL=$P(PSAERR(PSAMENU),"^",3),(PSALNCNT,PSALINES,PSACS,PSALLSUP)=0
"RTN","PSAPROC2",29,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))!('$D(^XTMP("PSAPV",PSACTRL,"IT")))
"RTN","PSAPROC2",30,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSALOC=+$P(PSAIN,"^",7),PSAMV=+$P(PSAIN,"^",12)
"RTN","PSAPROC2",31,0)
 .D HDR W !,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAPROC2",32,0)
 .W:$P(PSAIN,"^",9)="CS" !!,"MASTER VAULT: "_$S(PSAMV:$P($G(^PSD(58.8,PSAMV,0)),"^"),1:"Blank")
"RTN","PSAPROC2",33,0)
 .I $P(PSAIN,"^",10)="" D
"RTN","PSAPROC2",34,0)
 ..D SITES^PSAUTL1 S PSALOCN=$S($D(^PSD(58.8,PSALOC,0)):$P($G(^PSD(58.8,PSALOC,0)),"^"),1:"UNKNOWN")_PSACOMB
"RTN","PSAPROC2",35,0)
 ..W !!,"PHARMACY LOCATION: " I 'PSALOC W "Blank" Q
"RTN","PSAPROC2",36,0)
 ..W:$L(PSALOCN)>76 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 !,PSALOCN
"RTN","PSAPROC2",37,0)
 .W ! S PSARECD=$S(+$P(PSAIN,"^",11):+$P(PSAIN,"^",11),+$P(PSAIN,"^",6):+$P(PSAIN,"^",6),1:"") D RECD^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC2",38,0)
 .;
"RTN","PSAPROC2",39,0)
 .;Gets & processes the line items
"RTN","PSAPROC2",40,0)
 .S PSALINE="" F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAPROC2",41,0)
 ..S PSALNCNT=PSALNCNT+1,(PSAPASS,PSASUPP)=0,PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC2",42,0)
 ..I $P(PSADATA,"^",18)="OK"!($P(PSADATA,"^",18)="P") S:$P(PSADATA,"^",18)="OK" $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P" S PSALINES=PSALINES+1 S:$P(PSADATA,"^",19)="CS" PSACS=PSACS+1 Q
"RTN","PSAPROC2",43,0)
 ..S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC2",44,0)
 ..S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),1:+$P(PSADATA,"^",6)),PSASUB=+$P(PSADATA,"^",7),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~")
"RTN","PSAPROC2",45,0)
 ..D EDITDISP^PSAUTL1 D ^PSAPROC9
"RTN","PSAPROC2",46,0)
 .D:'PSAOUT SETINV
"RTN","PSAPROC2",47,0)
 Q:PSAOUT
"RTN","PSAPROC2",48,0)
 I '$O(PSAERR(0)) Q  ;*50 rid select (1-0)
"RTN","PSAPROC2",49,0)
 W @IOF,!,"If you are changing the status of an invoice to Processed, this is the",!,"last time you will be allowed to edit it before it goes to the verifier."
"RTN","PSAPROC2",50,0)
 W !,"If you are not changing the status of an invoice to Processed, you can",!,"edit it now.",!!,"You can edit the invoice's delivery date, pharmacy location, master vault,"
"RTN","PSAPROC2",51,0)
 W !,"and the line item's drug, quantity received, order unit, and dispense units",!,"per order unit. The reorder level can be edited if the pharmacy location or"
"RTN","PSAPROC2",52,0)
 W !,"master vault is set up to track the reorder levels.",!
"RTN","PSAPROC2",53,0)
 S DIR(0)="Y",DIR("A")="Edit invoices",DIR("B")="N",DIR("?",1)="Enter Yes to edit the invoices you just processed.",DIR("?",1)="Enter No to accept the invoices as they are now."
"RTN","PSAPROC2",54,0)
 S DIR("??")="^D EDIT^PSAPROC2" D ^DIR K DIR I $G(DIRUT)!('Y) S PSAOUT=1 Q
"RTN","PSAPROC2",55,0)
 ;
"RTN","PSAPROC2",56,0)
EDITINV ;Edits the invoice before placing in Processed status.
"RTN","PSAPROC2",57,0)
 K PSAERR S (PSACTRL,PSAERR,PSAOUT)=0
"RTN","PSAPROC2",58,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC2",59,0)
 .S:$D(^XTMP("PSAPV",PSACTRL,"IN")) PSAERR=PSAERR+1,PSAERR(PSAERR)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)_"^"_$P(^("IN"),"^",12)
"RTN","PSAPROC2",60,0)
 ;
"RTN","PSAPROC2",61,0)
 W @IOF,!?26,"<<< EDIT INVOICE SCREEN >>>"
"RTN","PSAPROC2",62,0)
 W !!,"Choose the invoices to be edited. You can edit the invoice's date received and",!,"the line item's drug, quantity received, and order unit. The reorder and"
"RTN","PSAPROC2",63,0)
 W !,"stock levels can be edited if the pharmacy location or master vault is set",!,"up to maintain the reorder levels.",!,PSASLN,!
"RTN","PSAPROC2",64,0)
 S (PSACNT,PSAMENU,PSASTOP)=0
"RTN","PSAPROC2",65,0)
 F  S PSAMENU=+$O(PSAERR(PSAMENU)) Q:'PSAMENU!(PSAOUT)  D  Q:PSASTOP
"RTN","PSAPROC2",66,0)
 .I $Y+4>IOSL D HDR1 Q:PSASTOP
"RTN","PSAPROC2",67,0)
 .S PSAORD=$P(PSAERR(PSAMENU),"^"),PSAINV=$P(PSAERR(PSAMENU),"^",2),PSACTRL=$P(PSAERR(PSAMENU),"^",3),PSACNT=PSACNT+1
"RTN","PSAPROC2",68,0)
 .W !?1,PSACNT_".",?4,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC2",69,0)
 K PSASTOP
"RTN","PSAPROC2",70,0)
 S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices",DIR("?",1)="Enter the number to the left of the invoice",DIR("?")="data to be edited or a range of numbers." W !
"RTN","PSAPROC2",71,0)
 S DIR("??")="^D SEL^PSAPROC2" D ^DIR K DIR S:Y="" DUOUT=1 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q  ;*50
"RTN","PSAPROC2",72,0)
 S PSASEL=Y D ^PSAPROC6
"RTN","PSAPROC2",73,0)
 Q
"RTN","PSAPROC2",74,0)
HDR ;Screen header
"RTN","PSAPROC2",75,0)
 W @IOF,!?19,"<<< EDIT INVOICES TO BE PROCESSED SCREEN >>>",!
"RTN","PSAPROC2",76,0)
 Q
"RTN","PSAPROC2",77,0)
 ;
"RTN","PSAPROC2",78,0)
HDR1 ;Screen header with hold
"RTN","PSAPROC2",79,0)
 S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC2",80,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSASTOP=1 Q
"RTN","PSAPROC2",81,0)
 W @IOF,!?26,"<<< EDIT INVOICE SCREEN >>>",!!,PSASLN
"RTN","PSAPROC2",82,0)
 Q
"RTN","PSAPROC2",83,0)
 ;
"RTN","PSAPROC2",84,0)
HEADER ;Screen hold with header
"RTN","PSAPROC2",85,0)
 S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC2",86,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSASTOP=1 Q
"RTN","PSAPROC2",87,0)
 W @IOF,!?19,"<<< EDIT INVOICES TO BE PROCESSED SCREEN >>>",!!,PSASLN
"RTN","PSAPROC2",88,0)
 Q
"RTN","PSAPROC2",89,0)
 ;
"RTN","PSAPROC2",90,0)
SETINV ;Sets invoice to processed if okay.
"RTN","PSAPROC2",91,0)
 S PSAOK=1
"RTN","PSAPROC2",92,0)
 I PSALLSUP=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)="",$P(^("IN"),"^",9)="",$P(^("IN"),"^",10)="",$P(^("IN"),"^",12)="",$P(^("IN"),"^",13)="SUP",PSAOK=1 G STATUS
"RTN","PSAPROC2",93,0)
 E  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)=""
"RTN","PSAPROC2",94,0)
 I PSACS D  Q:PSAOUT
"RTN","PSAPROC2",95,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAPROC2",96,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)="" S PSACS(PSACTRL)="" D MASTER^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)="" PSAOK=0
"RTN","PSAPROC2",97,0)
 .I PSACS=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS" Q
"RTN","PSAPROC2",98,0)
 .I PSACS'=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)=""
"RTN","PSAPROC2",99,0)
 I 'PSACS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="",$P(^("IN"),"^",10)="",$P(^("IN"),"^",12)="" D:$P(^("IN"),"^",7)="" GETLOC^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)="" PSAOK=0
"RTN","PSAPROC2",100,0)
 ;
"RTN","PSAPROC2",101,0)
STATUS I PSALNCNT=PSALINES!(PSALNCNT=PSALLSUP),PSAOK D CHG^PSAPROC6,END^PSAPROC Q
"RTN","PSAPROC2",102,0)
 E  W !!,"** The invoice has not been placed in a Processed status!"
"RTN","PSAPROC2",103,0)
 D END^PSAPROC
"RTN","PSAPROC2",104,0)
 Q
"RTN","PSAPROC2",105,0)
EDIT ;Extended help for 'edit any invoices'
"RTN","PSAPROC2",106,0)
 W !?5,"If you answer Yes, a list of the invoices you were able to process will",!?5,"be displayed. You will be able to select the invoices to be edited then"
"RTN","PSAPROC2",107,0)
 W !?5,"the line item numbers. You will be able to edit the date the invoice was",!?5,"received, drug, quantity, order unit, and dispense units per order unit."
"RTN","PSAPROC2",108,0)
 W !?5,"If the drugs are assigned to a pharmacy location or master vault that",!?5,"maintains reorder levels, you will also be able to edit the reorder and",!?5,"stock levels.",!!?5,"Enter No if the invoice are correct."
"RTN","PSAPROC2",109,0)
 Q
"RTN","PSAPROC2",110,0)
SEL ;Extended help to 'Select invoices to process'
"RTN","PSAPROC2",111,0)
 W !?5,"Enter the number to the left of the invoice data that you want to process."
"RTN","PSAPROC2",112,0)
 Q
"RTN","PSAPROC2",113,0)
SELHELP ;Extended help to 'Select invoices to edit'
"RTN","PSAPROC2",114,0)
 W !?5,"Enter the number to the left of the invoice data that you want to",!?5,"edit. The line items will be displayed for you to select the ones"
"RTN","PSAPROC2",115,0)
 W !?5,"you want to edit. You are given this opportunity to edit the invoice",!?5,"because the automatic display may not catch all the needed corrections."
"RTN","PSAPROC2",116,0)
 W !!?5,"For example, the quantity on the invoice may be 6, but one bottle may",!?5,"be broken. Six is a valid quantity that the automatic display will not"
"RTN","PSAPROC2",117,0)
 W !?5,"realize as being incorrect. By answering Yes, you will be allowed to change",!?5,"the quantity to 5."
"RTN","PSAPROC2",118,0)
 Q
"RTN","PSAPROC6")
0^7^B76371787^B71811767
"RTN","PSAPROC6",1,0)
PSAPROC6 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;10/7/97
"RTN","PSAPROC6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,21,34,50**; 10/24/97
"RTN","PSAPROC6",3,0)
 ;
"RTN","PSAPROC6",4,0)
 ;This routine allows the user to edit invoices by selecting the
"RTN","PSAPROC6",5,0)
 ;invoice's line item number.
"RTN","PSAPROC6",6,0)
 ;
"RTN","PSAPROC6",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC6",8,0)
 ;
"RTN","PSAPROC6",9,0)
SEL ;Loops thru selected invoices
"RTN","PSAPROC6",10,0)
 F PSAPC=1:1 S PSAMENU=$P(PSASEL,",",PSAPC) Q:'PSAMENU!(PSAOUT)  D CORR Q:PSAOUT  D CHECK
"RTN","PSAPROC6",11,0)
 Q  ;; <= *50  TO QUIT PROPERLY
"RTN","PSAPROC6",12,0)
 ;
"RTN","PSAPROC6",13,0)
CHECK ;Looks to see if all line items are processed
"RTN","PSAPROC6",14,0)
 S (PSACS,PSAERR,PSALINE,PSALINES,PSALNCNT,PSALNSU,PSAOUT,PSASUP)=0
"RTN","PSAPROC6",15,0)
 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAPROC6",16,0)
 .S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSALNCNT=PSALNCNT+1
"RTN","PSAPROC6",17,0)
 .S:$P(PSADATA,"^",18)="P"!($P(PSADATA,"^",18)="OK") PSALINES=PSALINES+1
"RTN","PSAPROC6",18,0)
 .S:$P(PSADATA,"^",19)="CS" PSACS=PSACS+1
"RTN","PSAPROC6",19,0)
 I PSACS,PSALNCNT=PSACS D
"RTN","PSAPROC6",20,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS",$P(^("IN"),"^",9)="CS" W !,"All drugs on the invoice are marked as a controlled substance."
"RTN","PSAPROC6",21,0)
 .D:$P($G(^PSD(58.8,+$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12),0)),"^",2)'="M" MASTER^PSAPROC9
"RTN","PSAPROC6",22,0)
 E  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)=""
"RTN","PSAPROC6",23,0)
 I PSACS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAPROC6",24,0)
 I +PSALNCNT,PSALNCNT=PSALINES D CHG D END^PSAPROC Q
"RTN","PSAPROC6",25,0)
 E  W !!,"** The invoice has not been placed in a Processed status!"
"RTN","PSAPROC6",26,0)
 D END^PSAPROC
"RTN","PSAPROC6",27,0)
 Q
"RTN","PSAPROC6",28,0)
 ;
"RTN","PSAPROC6",29,0)
CHG ;Asks if invoice's status should be changed to verified. If so, status
"RTN","PSAPROC6",30,0)
 ;is changed & new drugs to location is listed.
"RTN","PSAPROC6",31,0)
 W ! S DIR(0)="Y",DIR("A")="Do you want to change the invoice's status to Processed",DIR("?",1)="Enter YES to change the invoice's status to Processed.",DIR("?")="Enter NO to keep the invoice's status as Uploaded."
"RTN","PSAPROC6",32,0)
 S DIR("??")="^D CHGYN^PSAPROC6" D ^DIR K DIR
"RTN","PSAPROC6",33,0)
 I 'Y!($G(DIRUT)) S PSACHG=0,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="" W !!,"** The invoice's status has not been changed to Processed." Q
"RTN","PSAPROC6",34,0)
 S PSACHG=+Y,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="P"
"RTN","PSAPROC6",35,0)
 K PSAERR(PSAMENU) ;*50 rid select (1-0)
"RTN","PSAPROC6",36,0)
 W !!,"The invoice status has been changed to Processed!"
"RTN","PSAPROC6",37,0)
 ;
"RTN","PSAPROC6",38,0)
 ;PSA*3*21 (1/3/01 - file data in 58.811)
"RTN","PSAPROC6",39,0)
 D ^PSAPROC7
"RTN","PSAPROC6",40,0)
 ;
"RTN","PSAPROC6",41,0)
 Q
"RTN","PSAPROC6",42,0)
 ;
"RTN","PSAPROC6",43,0)
CORR S PSACTRL=$P(PSAERR(PSAMENU),"^",3),(PSALNCNT,PSALINES,PSACS)=0
"RTN","PSAPROC6",44,0)
 S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSARECD=$S(+$P(PSAIN,"^",11):+$P(PSAIN,"^",11),+$P(PSAIN,"^",6):+$P(PSAIN,"^",6),1:""),PSALOC=+$P(PSAIN,"^",7),PSAMV=+$P(PSAIN,"^",12)
"RTN","PSAPROC6",45,0)
 D HDR,RECD^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC6",46,0)
LOC I $P(PSAIN,"^",9)="CS" W !!,"MASTER VAULT: "_$P($G(^PSD(58.8,PSAMV,0)),"^") D MV Q:PSAOUT
"RTN","PSAPROC6",47,0)
 I $P(PSAIN,"^",10)="" D  Q:PSAOUT
"RTN","PSAPROC6",48,0)
 .;OIFO BAY PINES;TEH;PATCH PSA*3.0*34
"RTN","PSAPROC6",49,0)
 .D SITES^PSAUTL1 S PSALOCN=$S($D(^PSD(58.8,PSALOC,0)):$P($G(^PSD(58.8,PSALOC,0)),"^"),1:"UNKNOWN")_PSACOMB
"RTN","PSAPROC6",50,0)
 .W !!,"PHARMACY LOCATION: "
"RTN","PSAPROC6",51,0)
 .W:$L(PSALOCN)>76 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 !,PSALOCN D PHARM
"RTN","PSAPROC6",52,0)
LINES S PSADONE=0 F  W !!,"Line Item Numbers: " D  Q:PSAOUT!(PSADONE)
"RTN","PSAPROC6",53,0)
 .S PSALINE=0 S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  W ?19,PSALINE
"RTN","PSAPROC6",54,0)
 .F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAPROC6",55,0)
 ..I $X+$L(PSALINE)+2>79 W !,?19,PSALINE Q
"RTN","PSAPROC6",56,0)
 ..W ","_PSALINE
"RTN","PSAPROC6",57,0)
 .W ! S DIR(0)="LO",DIR("A")="Select Line Item Number",DIR("?")="Enter the line numbers to be edited",DIR("??")="^D LNHELP^PSAPROC6"
"RTN","PSAPROC6",58,0)
 .D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC6",59,0)
 .I X="" S PSADONE=1 Q
"RTN","PSAPROC6",60,0)
 .S PSALINE=X
"RTN","PSAPROC6",61,0)
 .I '$D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) W !,"Invalid line number." Q
"RTN","PSAPROC6",62,0)
 .S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC6",63,0)
 .S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),1:+$P(PSADATA,"^",6))
"RTN","PSAPROC6",64,0)
 .S PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSASUB=+$P(PSADATA,"^",7),PSASUP=0
"RTN","PSAPROC6",65,0)
 .S PSALOC=$S($P(PSADATA,"^",19)="CS":+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",7))
"RTN","PSAPROC6",66,0)
 .D EDITDISP^PSAUTL1 W !,PSASLN,!
"RTN","PSAPROC6",67,0)
 .D EDITITEM ;*50 ready for patch *54 make an entry point
"RTN","PSAPROC6",68,0)
 Q
"RTN","PSAPROC6",69,0)
EDITITEM        ;perform edit and checks on an item *50 to be ready for *54
"RTN","PSAPROC6",70,0)
 D
"RTN","PSAPROC6",71,0)
 .W "1. Drug",!,"2. Quantity Received",!,"3. Order Unit",!,"4. Dispense Units per Order Unit" S PSACHO=4
"RTN","PSAPROC6",72,0)
 .I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) W !,"5. Stock Level",!,"6. Reorder Level" S PSACHO=6
"RTN","PSAPROC6",73,0)
 .W ! S DIR(0)="LO^1:"_PSACHO,DIR("A")="Edit fields",DIR("?")="Enter the number(s) of the data to be edited",DIR("??")="^D DQOR^PSAPROC6"
"RTN","PSAPROC6",74,0)
 .D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC6",75,0)
 .Q:Y=""  S PSAFLDS=Y,PSADU=0 D EDITDISP^PSAUTL1 W !,PSASLN
"RTN","PSAPROC6",76,0)
FIELDS .F PSAPCF=1:1 S PSAFLD=$P(PSAFLDS,",",PSAPCF) Q:'PSAFLD!(PSAOUT)  D
"RTN","PSAPROC6",77,0)
 ..I PSAFLD=1 D ASKDRUG^PSANDF Q
"RTN","PSAPROC6",78,0)
 ..I PSAFLD=2 D QTY^PSAPROC3 Q
"RTN","PSAPROC6",79,0)
 ..I PSAFLD=3 D GETOU^PSAPROC3 Q
"RTN","PSAPROC6",80,0)
 ..I PSAFLD=4,PSAIEN D:$P($G(^PSDRUG(PSAIEN,660)),"^",8)="" DU^PSAPROC8 D DUOU^PSAPROC3 Q
"RTN","PSAPROC6",81,0)
 ..I PSAFLD=5 D STOCK^PSAPROC8 Q
"RTN","PSAPROC6",82,0)
 ..I PSAFLD=6 D REORDER^PSAPROC8
"RTN","PSAPROC6",83,0)
 .D:'PSAOUT PROCESS
"RTN","PSAPROC6",84,0)
 Q
"RTN","PSAPROC6",85,0)
 ;
"RTN","PSAPROC6",86,0)
PROCESS ;Checks for & prompts for missing data.
"RTN","PSAPROC6",87,0)
 Q:$D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))
"RTN","PSAPROC6",88,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC6",89,0)
 S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),+$P(PSADATA,"^",6):+$P(PSADATA,"^",6),1:0),PSASUB=+$P(PSADATA,"^",7)
"RTN","PSAPROC6",90,0)
 ;If no order unit, store it.
"RTN","PSAPROC6",91,0)
 I '+$P($P(PSADATA,"^",2),"~",2),'$P(PSADATA,"^",12) D  Q:PSAOUT
"RTN","PSAPROC6",92,0)
 .I PSAIEN,PSASUB,'$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5) D GETOU^PSAPROC3 Q
"RTN","PSAPROC6",93,0)
 .I PSAIEN,'PSASUB D GETOU^PSAPROC3
"RTN","PSAPROC6",94,0)
 ;If synonym & doesn't have disp units/order unit, store it 50.
"RTN","PSAPROC6",95,0)
 I PSAIEN,PSASUB,'+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7),'+$P(PSADATA,"^",20) S PSADU=0 D DUOU^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",96,0)
 ;If no synonym & disp units/order unit, store it XTMP.
"RTN","PSAPROC6",97,0)
 I PSAIEN,'PSASUB,'$P(PSADATA,"^",20) D DUOU^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC6",98,0)
 I '+$P(PSADATA,"^",3) D PRICE^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC6",99,0)
 ;If not CS & maintains stock, prompt for stock & reorder levels
"RTN","PSAPROC6",100,0)
 I $P(PSADATA,"^",19)'="CS",+$P(PSAIN,"^",7),+$P($G(^PSD(58.8,+$P(PSAIN,"^",7),0)),"^",14) D
"RTN","PSAPROC6",101,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",3),'+$P(PSADATA,"^",27) S PSALOC=$P(PSAIN,"^",7) D STOCK^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",102,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",5),'+$P(PSADATA,"^",21) S PSALOC=$P(PSAIN,"^",7) D REORDER^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",103,0)
 ;If CS & maintains stock, prompt for stock & reorder level
"RTN","PSAPROC6",104,0)
 I $P(PSADATA,"^",19)="CS",+$P(PSAIN,"^",12),+$P($G(^PSD(58.8,+$P(PSAIN,"^",12),0)),"^",14) D
"RTN","PSAPROC6",105,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",3),'+$P(PSADATA,"^",27) S PSALOC=$P(PSAIN,"^",12) D STOCK^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",106,0)
 .I '+$P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",5),'+$P(PSADATA,"^",21) S PSALOC=$P(PSAIN,"^",12) D REORDER^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC6",107,0)
 Q:PSAOUT  D CHECK^PSANDF Q:PSAOUT  D SETLINE^PSAPROC3
"RTN","PSAPROC6",108,0)
 Q
"RTN","PSAPROC6",109,0)
 ;
"RTN","PSAPROC6",110,0)
MV ;Assigns master vault
"RTN","PSAPROC6",111,0)
 S DIC("A")="Select Master Vault: ",DIC="^PSD(58.8,",DIC(0)="QAEMZ" S:+PSAMV DIC("B")=$P($G(^PSD(58.8,+PSAMV,0)),"^")
"RTN","PSAPROC6",112,0)
 S DIC("S")="I $D(^PSD(58.8,""ADISP"",""M"",+Y)),'+$G(^PSD(58.8,+Y,""I""))!(+$G(^PSD(58.8,+Y,""I""))&(+$G(^PSD(58.8,+Y,""I""))'<DT))"
"RTN","PSAPROC6",113,0)
 D ^DIC K DIC I $G(DTOUT)!($G(DUOUT))!(Y<0) S PSAOUT=1 Q
"RTN","PSAPROC6",114,0)
 S PSAMV=+Y,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=+Y,PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC6",115,0)
 Q
"RTN","PSAPROC6",116,0)
 ;
"RTN","PSAPROC6",117,0)
PHARM ;Assigns pharmacy location
"RTN","PSAPROC6",118,0)
 ;S DIC("A")="Select Pharmacy Location: ",DIC="^PSD(58.8,",DIC(0)="QAEMZ" S:+PSALOC DIC("B")=$P($G(^PSD(58.8,+PSALOC,0)),"^")
"RTN","PSAPROC6",119,0)
 ;S DIC("S")="I $D(^PSD(58.8,""ADISP"",""P"",+Y)),'$G(^PSD(58.8,+Y,""I""))!(+$G(^PSD(58.8,+Y,""I""))&(+$G(^PSD(58.8,+Y,""I""))'<DT))"
"RTN","PSAPROC6",120,0)
 ;D ^DIC K DIC I $G(DTOUT)!($G(DUOUT))!(Y<0) S PSAOUT=1 Q
"RTN","PSAPROC6",121,0)
 ;S PSALOC=+Y,$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=+Y,PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC6",122,0)
 ;Dave Blocker  (PSA*3*21)
"RTN","PSAPROC6",123,0)
 D ^PSAUTL5 Q:$G(PSALOC)'>0  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=+PSALOC,PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC6",124,0)
 ;Eop
"RTN","PSAPROC6",125,0)
 Q
"RTN","PSAPROC6",126,0)
 ;
"RTN","PSAPROC6",127,0)
SUPPLY ;Asks if all items are supply items. If so, invoice is deleted from
"RTN","PSAPROC6",128,0)
 ;^XTMP global. If not, invoice is added to list of invoices to be edited.
"RTN","PSAPROC6",129,0)
 W ! S DIR(0)="Y",DIR("A")="Are all the items on the invoice supply items",DIR("B")="N"
"RTN","PSAPROC6",130,0)
 S DIR("?",1)="Enter YES if all line items are not drugs in the DRUG file.",DIR("?")="Enter NO if there is at least one line item that is in the DRUG file."
"RTN","PSAPROC6",131,0)
 S DIR("??")="^D ALLSUP^PSAPROC6" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC6",132,0)
 G:'Y NO
"RTN","PSAPROC6",133,0)
 W ! S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="Y",DIR("?",1)="Enter YES if all the line items on the invoice are supply items.",DIR("?")="Enter NO if there is at least one item on the invoice that is not a supply."
"RTN","PSAPROC6",134,0)
 S DIR("??")="^D ALLSUP^PSAPROC6" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC6",135,0)
NO I 'Y S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=PSAOK(PSA) K PSAOK(PSA) Q
"RTN","PSAPROC6",136,0)
 K PSAOK(PSA) S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="P",PSASUP=1,PSALINE=0
"RTN","PSAPROC6",137,0)
 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSAPROC6",138,0)
 .S ^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")=DUZ_"^"_DT_"^"_"SUPPLY ITEM",$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P"
"RTN","PSAPROC6",139,0)
 Q
"RTN","PSAPROC6",140,0)
 ;
"RTN","PSAPROC6",141,0)
HDR ;Screen header
"RTN","PSAPROC6",142,0)
 W @IOF,!?26,"<<< EDIT INVOICE SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAPROC6",143,0)
 Q
"RTN","PSAPROC6",144,0)
 ;
"RTN","PSAPROC6",145,0)
CHGYN ;Extended help - 'Do you want to change the invoice's status to Processed'
"RTN","PSAPROC6",146,0)
 W !?5,"Enter YES if the invoice is completely correct. You will not be able",!?5,"to edit it again."
"RTN","PSAPROC6",147,0)
 W !!?5,"Enter NO if you need to edit the invoice again. You can edit it again",!?5,"by selecting the Process Orders option."
"RTN","PSAPROC6",148,0)
 Q
"RTN","PSAPROC6",149,0)
DQOR ;Extended help - 'Edit field'
"RTN","PSAPROC6",150,0)
 W !?5,"Enter the number or range of numbers of the field you want to edit."
"RTN","PSAPROC6",151,0)
 Q
"RTN","PSAPROC6",152,0)
LNHELP ;Extended help - 'Line Number"
"RTN","PSAPROC6",153,0)
 W !?5,"Enter the number of the item on the invoice you want to edit. You can",!?5,"enter a line item number then edit that line item. The ""Line Number""",!?5,"prompt will be displayed again. You can keep entering and editing line"
"RTN","PSAPROC6",154,0)
 W !?5,"items until you press the Return key at the ""Line Number"" prompt."
"RTN","PSAPROC6",155,0)
 Q
"RTN","PSAPROC6",156,0)
ALLSUP ;Extended help - "Are all the items on the invoice supply items" &
"RTN","PSAPROC6",157,0)
 ;"Are you sure?"
"RTN","PSAPROC6",158,0)
 W !!?5,"Enter YES if none of the line items on the invoice are",!?5,"in the DRUG file and will never be in the DRUG file.",!!?5,"Enter NO if there is at least one line item on the",!?5,"invoice that is in the DRUG file."
"RTN","PSAPROC6",159,0)
 Q
"VER")
8.0^22.0
"BLD",6552,6)
^42
**END**
**END**
