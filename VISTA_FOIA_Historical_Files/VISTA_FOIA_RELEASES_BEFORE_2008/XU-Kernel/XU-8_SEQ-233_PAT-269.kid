Released XU*8*269 SEQ #233
Extracted from mail message
**KIDS**:XU*8.0*269^

**INSTALL NAME**
XU*8.0*269
"BLD",631,0)
XU*8.0*269^KERNEL^0^3021121^y
"BLD",631,1,0)
^^2^2^3021121^
"BLD",631,1,1,0)
Please refer to the Description in FORUM Patch Module for details.
"BLD",631,1,2,0)
Patch XU*8*269 Add LOCKING to XUESSO1.
"BLD",631,4,0)
^9.64PA^^
"BLD",631,"KRN",0)
^9.67PA^8989.52^20
"BLD",631,"KRN",.4,0)
.4
"BLD",631,"KRN",.401,0)
.401
"BLD",631,"KRN",.402,0)
.402
"BLD",631,"KRN",.403,0)
.403
"BLD",631,"KRN",.5,0)
.5
"BLD",631,"KRN",.84,0)
.84
"BLD",631,"KRN",3.6,0)
3.6
"BLD",631,"KRN",3.8,0)
3.8
"BLD",631,"KRN",9.2,0)
9.2
"BLD",631,"KRN",9.8,0)
9.8
"BLD",631,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",631,"KRN",9.8,"NM",1,0)
XUESSO1^^0^B27617417
"BLD",631,"KRN",9.8,"NM",2,0)
XGF^^0^B7221901
"BLD",631,"KRN",9.8,"NM","B","XGF",2)

"BLD",631,"KRN",9.8,"NM","B","XUESSO1",1)

"BLD",631,"KRN",19,0)
19
"BLD",631,"KRN",19.1,0)
19.1
"BLD",631,"KRN",101,0)
101
"BLD",631,"KRN",409.61,0)
409.61
"BLD",631,"KRN",771,0)
771
"BLD",631,"KRN",870,0)
870
"BLD",631,"KRN",8989.51,0)
8989.51
"BLD",631,"KRN",8989.52,0)
8989.52
"BLD",631,"KRN",8994,0)
8994
"BLD",631,"KRN",8994.2,0)
8994.2
"BLD",631,"KRN","B",.4,.4)

"BLD",631,"KRN","B",.401,.401)

"BLD",631,"KRN","B",.402,.402)

"BLD",631,"KRN","B",.403,.403)

"BLD",631,"KRN","B",.5,.5)

"BLD",631,"KRN","B",.84,.84)

"BLD",631,"KRN","B",3.6,3.6)

"BLD",631,"KRN","B",3.8,3.8)

"BLD",631,"KRN","B",9.2,9.2)

"BLD",631,"KRN","B",9.8,9.8)

"BLD",631,"KRN","B",19,19)

"BLD",631,"KRN","B",19.1,19.1)

"BLD",631,"KRN","B",101,101)

"BLD",631,"KRN","B",409.61,409.61)

"BLD",631,"KRN","B",771,771)

"BLD",631,"KRN","B",870,870)

"BLD",631,"KRN","B",8989.51,8989.51)

"BLD",631,"KRN","B",8989.52,8989.52)

"BLD",631,"KRN","B",8994,8994)

"BLD",631,"KRN","B",8994.2,8994.2)

"BLD",631,"QUES",0)
^9.62^^
"BLD",631,"REQB",0)
^9.611^1^1
"BLD",631,"REQB",1,0)
XU*8.0*254^2
"BLD",631,"REQB","B","XU*8.0*254",1)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
269^3021121
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3021121
"PKG",3,22,1,"PAH",1,1,1,0)
Please refer to the Description in FORUM Patch Module for details.
"PKG",3,22,1,"PAH",1,1,2,0)
Patch XU*8*269 Add LOCKING to XUESSO1.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","XGF")
0^2^B7221901
"RTN","XGF",1,0)
XGF ;SFISC/VYD - Graphics Functions ;11/06/2002  11:10
"RTN","XGF",2,0)
 ;;8.0;KERNEL;**269**;Jul 10, 1995
"RTN","XGF",3,0)
PREP ;prepair graphics environment
"RTN","XGF",4,0)
 D PREP^XGSETUP Q
"RTN","XGF",5,0)
 ;
"RTN","XGF",6,0)
 ;
"RTN","XGF",7,0)
IOXY(R,C) ;cursor positioning R:row, C:col
"RTN","XGF",8,0)
 D ADJRC
"RTN","XGF",9,0)
 W $$IOXY^XGS(R,C)
"RTN","XGF",10,0)
 S $Y=R,$X=C
"RTN","XGF",11,0)
 Q
"RTN","XGF",12,0)
 ;
"RTN","XGF",13,0)
 ;
"RTN","XGF",14,0)
SAY(R,C,S,A) ;coordinate output instead of WRITE
"RTN","XGF",15,0)
 D ADJRC
"RTN","XGF",16,0)
 S:C+$L(S)>IOM S=$E(S,1,IOM-C) ;truncate if longer than screen
"RTN","XGF",17,0)
 I $L($G(A)) S A=$$UP^XLFSTR(A) D SAY^XGS(R,C,S,$S($$ATRSYNTX(A):A,1:"")) I 1
"RTN","XGF",18,0)
 E  D SAY^XGS(R,C,S)
"RTN","XGF",19,0)
 Q
"RTN","XGF",20,0)
 ;
"RTN","XGF",21,0)
 ;
"RTN","XGF",22,0)
SAYU(R,C,S,A) ;coordinate output w/ underline instead of WRITE
"RTN","XGF",23,0)
 D ADJRC
"RTN","XGF",24,0)
 I $L($G(A)) S A=$$UP^XLFSTR(A) D SAYU^XGS(R,C,S,$S($$ATRSYNTX(A):A,1:"")) I 1
"RTN","XGF",25,0)
 E  D SAYU^XGS(R,C,S)
"RTN","XGF",26,0)
 Q
"RTN","XGF",27,0)
 ;
"RTN","XGF",28,0)
 ;
"RTN","XGF",29,0)
ADJRC ;adjust row and column R and C are assumed to exist
"RTN","XGF",30,0)
 S R=$S($G(R)="":$Y,1:R),C=$S($G(C)="":$X,1:C) ;use current coords if none are passed
"RTN","XGF",31,0)
 S:"+-"[$E(R) R=$Y+$S(R="+":1,R="-":-1,1:R) ;increment/decrement
"RTN","XGF",32,0)
 S:"+-"[$E(C) C=$X+$S(C="+":1,C="-":-1,1:C)
"RTN","XGF",33,0)
 S R=$S(R<0:0,1:R\1),C=$S(C<0:0,1:C\1) ;make sure only pos int
"RTN","XGF",34,0)
 Q
"RTN","XGF",35,0)
 ;
"RTN","XGF",36,0)
 ;
"RTN","XGF",37,0)
SETA(XGATR) ;set screen attribute(s) regardless of previous state
"RTN","XGF",38,0)
 ;XGATR=1 char when converted to binary represents all new attr
"RTN","XGF",39,0)
 N XGOLDX,XGOLDY
"RTN","XGF",40,0)
 S XGOLDX=$X,XGOLDY=$Y ;save $X $Y
"RTN","XGF",41,0)
 W $$SET^XGSA(XGATR)
"RTN","XGF",42,0)
 S $X=XGOLDX,$Y=XGOLDY ;restore $X $Y
"RTN","XGF",43,0)
 Q
"RTN","XGF",44,0)
 ;
"RTN","XGF",45,0)
 ;
"RTN","XGF",46,0)
CHGA(XGATR) ;change screen attribute(s) w/ respect to previous state
"RTN","XGF",47,0)
 ;XGNEWATR=string of attr to change eg. "B0U1" or "E1"
"RTN","XGF",48,0)
 N XGOLDX,XGOLDY,XGSYNTX,XGACODE,%
"RTN","XGF",49,0)
 S XGATR=$$UP^XLFSTR(XGATR) ;make sure all attr codes are in upper case
"RTN","XGF",50,0)
 D:$$ATRSYNTX(XGATR)
"RTN","XGF",51,0)
 . S XGOLDX=$X,XGOLDY=$Y ;save $X $Y
"RTN","XGF",52,0)
 . W $$CHG^XGSA(XGATR)
"RTN","XGF",53,0)
 . S $X=XGOLDX,$Y=XGOLDY ;restore $X $Y
"RTN","XGF",54,0)
 Q
"RTN","XGF",55,0)
 ;
"RTN","XGF",56,0)
 ;
"RTN","XGF",57,0)
ATRSYNTX(XGATR) ;check attribute code syntax
"RTN","XGF",58,0)
 ;proper attr is 1 or more (char from {BIRGUE} concat w/ 1 or 0)
"RTN","XGF",59,0)
 N XGSYNTX,%
"RTN","XGF",60,0)
 S XGSYNTX=$S($L(XGATR)&($L(XGATR)#2=0):1,1:0) ;even # of chars
"RTN","XGF",61,0)
 F %=1:2:$L(XGATR) S:"B1B0I1I0R1R0G1G0U1U0E1"'[$E(XGATR,%,%+1) XGSYNTX=0
"RTN","XGF",62,0)
 Q XGSYNTX
"RTN","XGF",63,0)
 ;
"RTN","XGF",64,0)
 ;
"RTN","XGF",65,0)
RESTORE(S) ;restore screen region TOP,LEFT,BOTTOM,RIGHT,SAVE ROOT
"RTN","XGF",66,0)
 D RESTORE^XGSW(S) Q
"RTN","XGF",67,0)
 K @S
"RTN","XGF",68,0)
 ;
"RTN","XGF",69,0)
 ;
"RTN","XGF",70,0)
SAVE(T,L,B,R,S) ;save screen region TOP,LEFT,BOTTOM,RIGHT,SAVE ROOT
"RTN","XGF",71,0)
 D SAVE^XGSW(T,L,B,R,S) Q
"RTN","XGF",72,0)
 ;
"RTN","XGF",73,0)
 ;
"RTN","XGF",74,0)
WIN(T,L,B,R,S) ;put up a window TOP,LEFT,BOTTOM,RIGHT[,SAVE ROOT]
"RTN","XGF",75,0)
 ;window style is not yet implemented
"RTN","XGF",76,0)
 I $L($G(S)) D WIN^XGSW(T,L,B,R,S) I 1
"RTN","XGF",77,0)
 E  D WIN^XGSW(T,L,B,R)
"RTN","XGF",78,0)
 Q
"RTN","XGF",79,0)
 ;
"RTN","XGF",80,0)
 ;
"RTN","XGF",81,0)
FRAME(T,L,B,R) ;put a frame without clearing the inside TOP,LEFT,BOTTOM,RIGHT
"RTN","XGF",82,0)
 D FRAME^XGSBOX(T,L,B,R) Q
"RTN","XGF",83,0)
 ;
"RTN","XGF",84,0)
 ;
"RTN","XGF",85,0)
CLEAR(T,L,B,R) ;clear screen portion TOP,LEFT,BOTTOM,RIGHT
"RTN","XGF",86,0)
 D CLEAR^XGSBOX(T,L,B,R) Q
"RTN","XGF",87,0)
 ;
"RTN","XGF",88,0)
 ;
"RTN","XGF",89,0)
CLEAN ;clean up and destroy graphics environment
"RTN","XGF",90,0)
 D CLEAN^XGSETUP Q
"RTN","XGF",91,0)
 ;
"RTN","XGF",92,0)
 ;
"RTN","XGF",93,0)
INITKB(XGTRM) ;initialize keyboard
"RTN","XGF",94,0)
 ;turn escape processing on, turn on passed terminators (if any)
"RTN","XGF",95,0)
 D INIT^XGKB($G(XGTRM)) Q
"RTN","XGF",96,0)
 ;
"RTN","XGF",97,0)
 ;
"RTN","XGF",98,0)
READ(XGCHARS,XGTO) ;read the keyboard
"RTN","XGF",99,0)
 ;XGCHARS:number of chars to read, XGTO:timeout
"RTN","XGF",100,0)
 Q $$READ^XGKB($G(XGCHARS),$G(XGTO))
"RTN","XGF",101,0)
 ;
"RTN","XGF",102,0)
 ;
"RTN","XGF",103,0)
RESETKB ;reset keyboard(escape processing off, terminators off)
"RTN","XGF",104,0)
 D EXIT^XGKB Q
"RTN","XUESSO1")
0^1^B27617417
"RTN","XUESSO1",1,0)
XUESSO1 ;LUKE/SEA Single Sign-on utilities; ;11/06/2002  08:40
"RTN","XUESSO1",2,0)
 ;;8.0;KERNEL;**165,183,196,245,254,269**;Jul 10, 1995
"RTN","XUESSO1",3,0)
 ;
"RTN","XUESSO1",4,0)
GET(INDUZ) ;Gather identifying data from user's home site.
"RTN","XUESSO1",5,0)
 ;Must have Name, Access&Verify codes, SSN (no pseudo), station name&number
"RTN","XUESSO1",6,0)
 N %,NAME,SITE,SSN,PHONE,X,N
"RTN","XUESSO1",7,0)
 I '$D(DUZ) G BOMB
"RTN","XUESSO1",8,0)
 I '$D(DUZ(2)) G BOMB
"RTN","XUESSO1",9,0)
 I '$D(INDUZ) S INDUZ=DUZ
"RTN","XUESSO1",10,0)
 S N=$G(^VA(200,DUZ,0))
"RTN","XUESSO1",11,0)
 I '$L(N) G BOMB
"RTN","XUESSO1",12,0)
 S %=$P(N,U,3) I $L(%)<1 G BOMB ;No Access Code
"RTN","XUESSO1",13,0)
 S %=$P($G(^VA(200,INDUZ,.1)),U,2) I $L(%)<1 G BOMB ;No Verify Code
"RTN","XUESSO1",14,0)
 S %=$P(N,U,11) I $L(%)>1,(DT>%) G BOMB ;Terminated
"RTN","XUESSO1",15,0)
 S NAME=$P(N,U)
"RTN","XUESSO1",16,0)
 I '$L(NAME) G BOMB
"RTN","XUESSO1",17,0)
 ;
"RTN","XUESSO1",18,0)
 S SITE=$$NS^XUAF4(DUZ(2)) ;Site is name^station#
"RTN","XUESSO1",19,0)
 I $P(SITE,U,2)="" G BOMB ;Need a station number
"RTN","XUESSO1",20,0)
 ;
"RTN","XUESSO1",21,0)
 S SSN=$P($G(^VA(200,DUZ,1)),U,9)
"RTN","XUESSO1",22,0)
 I $$SPECIAL($P(SITE,"^",2)) S SSN=999999999 G G4 ;Manila RO doesn't need SSN
"RTN","XUESSO1",23,0)
 I 'SSN G BOMB
"RTN","XUESSO1",24,0)
 ;Don't allow if the SSN is pseudo
"RTN","XUESSO1",25,0)
 I $E(SSN,10)="P" G BOMB
"RTN","XUESSO1",26,0)
 ;Don't allow if the SSN is not real, (e.g. 00000NNNN)
"RTN","XUESSO1",27,0)
 I $E(SSN,1,5)="00000" G BOMB
"RTN","XUESSO1",28,0)
 ;
"RTN","XUESSO1",29,0)
G4 S PHONE=$$PH
"RTN","XUESSO1",30,0)
 S X=SSN_U_NAME_U_SITE_U_DUZ
"RTN","XUESSO1",31,0)
 I $L(PHONE)>2&($L(PHONE<20)) S X=X_U_PHONE
"RTN","XUESSO1",32,0)
 ;ssn^name^station name^station number^DUZ^phone
"RTN","XUESSO1",33,0)
 Q X
"RTN","XUESSO1",34,0)
 ;
"RTN","XUESSO1",35,0)
 ;
"RTN","XUESSO1",36,0)
BOMB ;Insufficient information to allow visiting
"RTN","XUESSO1",37,0)
 S X="-1^Insufficient User Information On File.  ssn,name,station name,station number,DUZ"
"RTN","XUESSO1",38,0)
 Q X
"RTN","XUESSO1",39,0)
 ;
"RTN","XUESSO1",40,0)
 ;
"RTN","XUESSO1",41,0)
PH() ; Try for a phone number or pager
"RTN","XUESSO1",42,0)
 N %,X
"RTN","XUESSO1",43,0)
 S %=""
"RTN","XUESSO1",44,0)
 S X=$G(^VA(200,DUZ,.13))
"RTN","XUESSO1",45,0)
 I '$L(X) Q ""
"RTN","XUESSO1",46,0)
 ;
"RTN","XUESSO1",47,0)
 S %=$P(X,U,5) I $L(%)>6 Q %  ;Commercial #
"RTN","XUESSO1",48,0)
 S %=$P(X,U,2) I $L(%)>2 Q %  ;Office
"RTN","XUESSO1",49,0)
 S %=$P(X,U,8) I $L(%)>6 Q %  ;Digital Pager
"RTN","XUESSO1",50,0)
 S %=$P(X,U,7) I $L(%)>6 Q %  ;Pager
"RTN","XUESSO1",51,0)
 S %=$P(X,U,3) I $L(%)>2 Q %  ;Phone #3
"RTN","XUESSO1",52,0)
 S %=$P(X,U,4) I $L(%)>2 Q %  ;Phone #4
"RTN","XUESSO1",53,0)
 S %=$P(X,U,1) I $L(%)>2 Q %  ;Home Phone
"RTN","XUESSO1",54,0)
 Q "" ;Couldn't find one.
"RTN","XUESSO1",55,0)
 ;
"RTN","XUESSO1",56,0)
SPECIAL(SN) ;Special Manila RO site
"RTN","XUESSO1",57,0)
 Q 358=SN
"RTN","XUESSO1",58,0)
 ;
"RTN","XUESSO1",59,0)
 ;
"RTN","XUESSO1",60,0)
PUT(DATIN) ;;Setup data from authenticating site GET() at receiving site
"RTN","XUESSO1",61,0)
 ;Return: 0=fail, 1=OK
"RTN","XUESSO1",62,0)
 N NEWDUZ,FDR,TODAY,IEN,DIC,USER,X,%T
"RTN","XUESSO1",63,0)
 N SSN,NAME,SITE,SITENUM,RMTDUZ,PHONE
"RTN","XUESSO1",64,0)
 S TODAY=$$HTFM^XLFDT($H),DT=$P(TODAY,"."),U="^"
"RTN","XUESSO1",65,0)
 S NEWDUZ=0
"RTN","XUESSO1",66,0)
 K ^TMP("DIERR",$J)
"RTN","XUESSO1",67,0)
 ;
"RTN","XUESSO1",68,0)
 IF (U_DATIN)["^^" Q 0 ;There is some data missing
"RTN","XUESSO1",69,0)
 S SSN=$P(DATIN,U,1)
"RTN","XUESSO1",70,0)
 S NAME=$P(DATIN,U,2)
"RTN","XUESSO1",71,0)
 S SITE=$P(DATIN,U,3)
"RTN","XUESSO1",72,0)
 S SITENUM=$P(DATIN,U,4)
"RTN","XUESSO1",73,0)
 S RMTDUZ=$P(DATIN,U,5)
"RTN","XUESSO1",74,0)
 S PHONE=$P(DATIN,U,6)
"RTN","XUESSO1",75,0)
 ;Format checks
"RTN","XUESSO1",76,0)
 I NAME'?1U.E1","1U.E Q 0
"RTN","XUESSO1",77,0)
 I SSN'?9N Q 0
"RTN","XUESSO1",78,0)
 I '$L(SITE)!('$L(SITENUM)) Q 0
"RTN","XUESSO1",79,0)
 ;
"RTN","XUESSO1",80,0)
 ;Get a LOCK. Block if can't get.
"RTN","XUESSO1",81,0)
 L +^VA(200,"HL7"):10 Q:'$T 0
"RTN","XUESSO1",82,0)
 S %T=$$TALL() L -^VA(200,"HL7")
"RTN","XUESSO1",83,0)
 I %T Q $$SET(NEWDUZ) ;Return 1 if OK.
"RTN","XUESSO1",84,0)
 Q 0
"RTN","XUESSO1",85,0)
 ;
"RTN","XUESSO1",86,0)
TALL() ;Test for existing user or adds a new one
"RTN","XUESSO1",87,0)
 N DUZ,FLAG S FLAG=0,DUZ=0,DUZ(0)=""
"RTN","XUESSO1",88,0)
 ;See if the SSN is in the NPF cross reference
"RTN","XUESSO1",89,0)
 I '$$SPECIAL(SITENUM),$D(^VA(200,"SSN",SSN)) D
"RTN","XUESSO1",90,0)
 .S NEWDUZ=$O(^VA(200,"SSN",SSN,0))
"RTN","XUESSO1",91,0)
 .I '$D(^VA(200,NEWDUZ,8910,"B",SITENUM)) D VISM
"RTN","XUESSO1",92,0)
 .D UPDT
"RTN","XUESSO1",93,0)
 .S FLAG=1
"RTN","XUESSO1",94,0)
 .Q
"RTN","XUESSO1",95,0)
 ;See if in the AVISIT cross reference
"RTN","XUESSO1",96,0)
 I 'FLAG,$$SPECIAL(SITENUM) D
"RTN","XUESSO1",97,0)
 . S NEWDUZ=$O(^VA(200,"AVISIT",SITENUM,RMTDUZ,0))
"RTN","XUESSO1",98,0)
 . Q:NEWDUZ'>0
"RTN","XUESSO1",99,0)
 . D UPDT S FLAG=1
"RTN","XUESSO1",100,0)
 . Q
"RTN","XUESSO1",101,0)
 I FLAG Q 1 ;Quit here if we found a match for SSN or AVISIT
"RTN","XUESSO1",102,0)
 ;
"RTN","XUESSO1",103,0)
 ;
"RTN","XUESSO1",104,0)
 ;There is no matching SSN, try for a NAME match in "B"
"RTN","XUESSO1",105,0)
 S FLAG=0,NAME=$$UP^XLFSTR(NAME)
"RTN","XUESSO1",106,0)
 I $D(^VA(200,"B",NAME)) D
"RTN","XUESSO1",107,0)
 .N %,USER,USER2
"RTN","XUESSO1",108,0)
 .S NEWDUZ=$O(^VA(200,"B",NAME,0))
"RTN","XUESSO1",109,0)
 .S USER2=$O(^VA(200,"B",NAME,NEWDUZ)) ;More then one?
"RTN","XUESSO1",110,0)
 .Q:$L(USER2)>0
"RTN","XUESSO1",111,0)
 .;
"RTN","XUESSO1",112,0)
 .S %=$P($G(^VA(200,NEWDUZ,1)),U,9)
"RTN","XUESSO1",113,0)
 .Q:%'=SSN  ;Don't use this name if it has a different SSN
"RTN","XUESSO1",114,0)
 .;
"RTN","XUESSO1",115,0)
 .I '$L($P(^VA(200,NEWDUZ,1),U,9)) D ADDS
"RTN","XUESSO1",116,0)
 .I '$D(^VA(200,NEWDUZ,8910,"B",SITENUM)) D VISM
"RTN","XUESSO1",117,0)
 .D UPDT S FLAG=1
"RTN","XUESSO1",118,0)
 .Q
"RTN","XUESSO1",119,0)
 I FLAG Q 1 ;Quit here if we found an exact match for NAME (w/o SSN)
"RTN","XUESSO1",120,0)
 ;
"RTN","XUESSO1",121,0)
NEWU ;We didn't find anybody under SSN or NAME so we add a new user
"RTN","XUESSO1",122,0)
 ;
"RTN","XUESSO1",123,0)
 S DIC(0)="" ;Turn off ^XUA4A7 (work around)
"RTN","XUESSO1",124,0)
 ;
"RTN","XUESSO1",125,0)
 ;Put the name in the .01 field first.
"RTN","XUESSO1",126,0)
 D ADDU ;ADDU will set NEWDUZ
"RTN","XUESSO1",127,0)
 ;If NEWDUZ is still 0, the User add didn't work so exit.
"RTN","XUESSO1",128,0)
 I NEWDUZ=0 Q 0
"RTN","XUESSO1",129,0)
 ; Add SSN and Alias
"RTN","XUESSO1",130,0)
 D ADDS,ADDA
"RTN","XUESSO1",131,0)
 ; Fill in the  VISITED FROM multiple
"RTN","XUESSO1",132,0)
 D VISM,UPDT ;Do update for all data in UPDT
"RTN","XUESSO1",133,0)
 ;
"RTN","XUESSO1",134,0)
 I $D(^TMP("DIERR",$J)) Q 0  ;W !!,"=========> FileMan Error",!!
"RTN","XUESSO1",135,0)
 ;
"RTN","XUESSO1",136,0)
 I NEWDUZ D BULL Q 1  ;Every thing OK
"RTN","XUESSO1",137,0)
 Q 0  ;Couldn't add user
"RTN","XUESSO1",138,0)
 ;
"RTN","XUESSO1",139,0)
 ;
"RTN","XUESSO1",140,0)
 ;              *****Subroutines*****
"RTN","XUESSO1",141,0)
 ;
"RTN","XUESSO1",142,0)
 ;
"RTN","XUESSO1",143,0)
SET(NEWDUZ) ;Set the user up to go
"RTN","XUESSO1",144,0)
 Q:NEWDUZ'>0 0
"RTN","XUESSO1",145,0)
 N XUSER,XOPT
"RTN","XUESSO1",146,0)
 S DUZ=NEWDUZ,U="^"
"RTN","XUESSO1",147,0)
 D DUZ^XUS1A
"RTN","XUESSO1",148,0)
 Q 1
"RTN","XUESSO1",149,0)
 ;
"RTN","XUESSO1",150,0)
ADDU ;Add a new name to the New Person File
"RTN","XUESSO1",151,0)
 N DD,DO,DIC,DA,X,Y
"RTN","XUESSO1",152,0)
 S DIC="^VA(200,",DIC(0)="L",X=NAME
"RTN","XUESSO1",153,0)
 D FILE^DICN
"RTN","XUESSO1",154,0)
 S:Y>0 NEWDUZ=+Y
"RTN","XUESSO1",155,0)
 Q
"RTN","XUESSO1",156,0)
 ;
"RTN","XUESSO1",157,0)
ADDS ;Add a SSN to the file
"RTN","XUESSO1",158,0)
 Q:$$SPECIAL(SITENUM)
"RTN","XUESSO1",159,0)
 S IEN=NEWDUZ_","
"RTN","XUESSO1",160,0)
 S FDR(200,IEN,9)=SSN
"RTN","XUESSO1",161,0)
 ;Do update for all data in UPDT
"RTN","XUESSO1",162,0)
 Q
"RTN","XUESSO1",163,0)
 ;
"RTN","XUESSO1",164,0)
ADDA ;Add a new Alias to file 200.04
"RTN","XUESSO1",165,0)
 Q:$D(^VA(200,NEWDUZ,3,"B","VISITOR"))
"RTN","XUESSO1",166,0)
 S IEN="+2,"_NEWDUZ_","
"RTN","XUESSO1",167,0)
 S FDR("200.04",IEN,.01)="VISITOR"
"RTN","XUESSO1",168,0)
 ;Do update for all data in UPDT
"RTN","XUESSO1",169,0)
 Q
"RTN","XUESSO1",170,0)
 ;
"RTN","XUESSO1",171,0)
VISM ;Create a multiple for this site number in the VISTED FROM file
"RTN","XUESSO1",172,0)
 ;K IEN,FDR
"RTN","XUESSO1",173,0)
 S IEN="+3,"_NEWDUZ_","
"RTN","XUESSO1",174,0)
 S FDR("200.06",IEN,.01)=SITENUM
"RTN","XUESSO1",175,0)
 ;
"RTN","XUESSO1",176,0)
 S FDR("200.06",IEN,1)=SITE
"RTN","XUESSO1",177,0)
 S FDR("200.06",IEN,2)=RMTDUZ
"RTN","XUESSO1",178,0)
 S FDR("200.06",IEN,3)=TODAY
"RTN","XUESSO1",179,0)
 I $D(PHONE),($L(PHONE)>2) S FDR("200.06",IEN,5)=PHONE
"RTN","XUESSO1",180,0)
 ;Do update for all data in UPDT
"RTN","XUESSO1",181,0)
 Q
"RTN","XUESSO1",182,0)
 ;
"RTN","XUESSO1",183,0)
UPDT ;Update the LAST VISIT field
"RTN","XUESSO1",184,0)
 I $D(FDR(200.06)) S IEN=$O(FDR(200.06,""))
"RTN","XUESSO1",185,0)
 E  S IEN=$O(^VA(200,NEWDUZ,8910,"B",SITENUM,0))_","_NEWDUZ_","
"RTN","XUESSO1",186,0)
 S FDR(200.06,IEN,4)=TODAY
"RTN","XUESSO1",187,0)
 K IEN D UPDATE^DIE("E","FDR","IEN") ;File all the data
"RTN","XUESSO1",188,0)
 Q
"RTN","XUESSO1",189,0)
 ;
"RTN","XUESSO1",190,0)
BULL ;Set up the bulletin and fire it off, Let MM see if bulletin is there
"RTN","XUESSO1",191,0)
 N XMB
"RTN","XUESSO1",192,0)
 S XMB="XUVISIT"
"RTN","XUESSO1",193,0)
 S XMB(1)=$$FMTE^XLFDT(TODAY)
"RTN","XUESSO1",194,0)
 S XMB(2)=NAME
"RTN","XUESSO1",195,0)
 S XMB(3)=NEWDUZ
"RTN","XUESSO1",196,0)
 S XMB(4)=SITE
"RTN","XUESSO1",197,0)
 S XMB(5)=SITENUM
"RTN","XUESSO1",198,0)
 S XMB(6)=RMTDUZ
"RTN","XUESSO1",199,0)
 S XMB(7)=PHONE
"RTN","XUESSO1",200,0)
 D ^XMB
"RTN","XUESSO1",201,0)
 Q
"VER")
8.0^22.0
**END**
**END**
