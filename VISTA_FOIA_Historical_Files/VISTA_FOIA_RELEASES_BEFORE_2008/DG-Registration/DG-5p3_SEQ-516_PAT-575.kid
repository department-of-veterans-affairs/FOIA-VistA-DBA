Released DG*5.3*575 SEQ #516
Extracted from mail message
**KIDS**:DG*5.3*575^

**INSTALL NAME**
DG*5.3*575
"BLD",1939,0)
DG*5.3*575^REGISTRATION^0^3040616^y
"BLD",1939,1,0)
^^3^3^3031218^
"BLD",1939,1,1,0)
TRIGGER UPDATES
"BLD",1939,1,2,0)
Refer to patch DG*5.3*575 in the FORUM Patch Module for a complete
"BLD",1939,1,3,0)
description.
"BLD",1939,4,0)
^9.64PA^2^1
"BLD",1939,4,2,0)
2
"BLD",1939,4,2,2,0)
^9.641^2^1
"BLD",1939,4,2,2,2,0)
PATIENT  (File-top level)
"BLD",1939,4,2,2,2,1,0)
^9.6411^.302^1
"BLD",1939,4,2,2,2,1,.302,0)
SERVICE CONNECTED PERCENTAGE
"BLD",1939,4,2,222)
y^n^p^^^^n^^n
"BLD",1939,4,2,224)

"BLD",1939,4,"APDD",2,2)

"BLD",1939,4,"APDD",2,2,.302)

"BLD",1939,4,"B",2,2)

"BLD",1939,"ABNS",0)
^9.66A^^
"BLD",1939,"ABPKG")
n^n^
"BLD",1939,"INID")
^y
"BLD",1939,"INIT")
DG575PST
"BLD",1939,"KRN",0)
^9.67PA^8989.52^19
"BLD",1939,"KRN",.4,0)
.4
"BLD",1939,"KRN",.4,"NM",0)
^9.68A^^
"BLD",1939,"KRN",.401,0)
.401
"BLD",1939,"KRN",.402,0)
.402
"BLD",1939,"KRN",.403,0)
.403
"BLD",1939,"KRN",.5,0)
.5
"BLD",1939,"KRN",.84,0)
.84
"BLD",1939,"KRN",3.6,0)
3.6
"BLD",1939,"KRN",3.8,0)
3.8
"BLD",1939,"KRN",9.2,0)
9.2
"BLD",1939,"KRN",9.8,0)
9.8
"BLD",1939,"KRN",9.8,"NM",0)
^9.68A^7^5
"BLD",1939,"KRN",9.8,"NM",1,0)
VAFCQRY1^^0^B49608704
"BLD",1939,"KRN",9.8,"NM",4,0)
VAFCTR^^0^B1104232
"BLD",1939,"KRN",9.8,"NM",5,0)
VAFHPIVT^^0^B21313463
"BLD",1939,"KRN",9.8,"NM",6,0)
VAFCQRY^^0^B10059825
"BLD",1939,"KRN",9.8,"NM",7,0)
VAFCQRY3^^0^B13092523
"BLD",1939,"KRN",9.8,"NM","B","VAFCQRY",6)

"BLD",1939,"KRN",9.8,"NM","B","VAFCQRY1",1)

"BLD",1939,"KRN",9.8,"NM","B","VAFCQRY3",7)

"BLD",1939,"KRN",9.8,"NM","B","VAFCTR",4)

"BLD",1939,"KRN",9.8,"NM","B","VAFHPIVT",5)

"BLD",1939,"KRN",19,0)
19
"BLD",1939,"KRN",19.1,0)
19.1
"BLD",1939,"KRN",101,0)
101
"BLD",1939,"KRN",101,"NM",0)
^9.68A^2^2
"BLD",1939,"KRN",101,"NM",1,0)
VAFC MPIPD FIELD TRIGGER^^0
"BLD",1939,"KRN",101,"NM",2,0)
DG FIELD MONITOR^^2
"BLD",1939,"KRN",101,"NM","B","DG FIELD MONITOR",2)

"BLD",1939,"KRN",101,"NM","B","VAFC MPIPD FIELD TRIGGER",1)

"BLD",1939,"KRN",409.61,0)
409.61
"BLD",1939,"KRN",771,0)
771
"BLD",1939,"KRN",870,0)
870
"BLD",1939,"KRN",8989.51,0)
8989.51
"BLD",1939,"KRN",8989.52,0)
8989.52
"BLD",1939,"KRN",8994,0)
8994
"BLD",1939,"KRN","B",.4,.4)

"BLD",1939,"KRN","B",.401,.401)

"BLD",1939,"KRN","B",.402,.402)

"BLD",1939,"KRN","B",.403,.403)

"BLD",1939,"KRN","B",.5,.5)

"BLD",1939,"KRN","B",.84,.84)

"BLD",1939,"KRN","B",3.6,3.6)

"BLD",1939,"KRN","B",3.8,3.8)

"BLD",1939,"KRN","B",9.2,9.2)

"BLD",1939,"KRN","B",9.8,9.8)

"BLD",1939,"KRN","B",19,19)

"BLD",1939,"KRN","B",19.1,19.1)

"BLD",1939,"KRN","B",101,101)

"BLD",1939,"KRN","B",409.61,409.61)

"BLD",1939,"KRN","B",771,771)

"BLD",1939,"KRN","B",870,870)

"BLD",1939,"KRN","B",8989.51,8989.51)

"BLD",1939,"KRN","B",8989.52,8989.52)

"BLD",1939,"KRN","B",8994,8994)

"BLD",1939,"QUES",0)
^9.62^^
"BLD",1939,"REQB",0)
^9.611^6^6
"BLD",1939,"REQB",1,0)
DG*5.3*477^1
"BLD",1939,"REQB",2,0)
DG*5.3*527^1
"BLD",1939,"REQB",3,0)
DG*5.3*179^1
"BLD",1939,"REQB",4,0)
DG*5.3*526^1
"BLD",1939,"REQB",5,0)
RG*1.0*34^0
"BLD",1939,"REQB",6,0)
MPIF*1.0*25^0
"BLD",1939,"REQB","B","DG*5.3*179",3)

"BLD",1939,"REQB","B","DG*5.3*477",1)

"BLD",1939,"REQB","B","DG*5.3*526",4)

"BLD",1939,"REQB","B","DG*5.3*527",2)

"BLD",1939,"REQB","B","MPIF*1.0*25",6)

"BLD",1939,"REQB","B","RG*1.0*34",5)

"FIA",2)
PATIENT
"FIA",2,0)
^DPT(
"FIA",2,0,0)
2I
"FIA",2,0,1)
y^n^p^^^^n^^n
"FIA",2,0,10)

"FIA",2,0,11)

"FIA",2,0,"RLRO")

"FIA",2,0,"VR")
5.3^DG
"FIA",2,2)
1
"FIA",2,2,.302)

"INIT")
DG575PST
"KRN",101,1936,-1)
2^2
"KRN",101,1936,0)
DG FIELD MONITOR^DG Field Monitor^^X^12555^^^^^^^5
"KRN",101,1936,10,0)
^101.01PA^3^2
"KRN",101,1936,10,3,0)
1994^^^
"KRN",101,1936,10,3,"^")
VAFC MPIPD FIELD TRIGGER
"KRN",101,1994,-1)
0^1
"KRN",101,1994,0)
VAFC MPIPD FIELD TRIGGER^TRIGGER FIELDS FOR MPIPD^^A^^^^^^^^REGISTRATION
"KRN",101,1994,1,0)
^^1^1^3030925^
"KRN",101,1994,1,1,0)
MPI/PD FIELD MONITORING
"KRN",101,1994,20)
D MPIPD^VAFCTR
"KRN",101,1994,99)
59437,52041
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813^2970721^12541
"PKG",5,22,1,"PAH",1,0)
575^3040616
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3040616
"PKG",5,22,1,"PAH",1,1,1,0)
TRIGGER UPDATES
"PKG",5,22,1,"PAH",1,1,2,0)
Refer to patch DG*5.3*575 in the FORUM Patch Module for a complete
"PKG",5,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","DG575PST")
0^^B25345226
"RTN","DG575PST",1,0)
DG575PST ;BIR/CMC-PATCH DG*5.3*575 POST INSTALLATION ROUTINE ;5/15/03
"RTN","DG575PST",2,0)
 ;;5.3;Registration;**575**;Aug 13, 1993
"RTN","DG575PST",3,0)
 ;
"RTN","DG575PST",4,0)
POST ;Post init
"RTN","DG575PST",5,0)
 N DGFLD,DGMFLD,DGOUT,DGFILE
"RTN","DG575PST",6,0)
 ;File cross references
"RTN","DG575PST",7,0)
 D XR(2,994)
"RTN","DG575PST",8,0)
 D XR(2.01,.01)
"RTN","DG575PST",9,0)
 D XR(2.02,.01)
"RTN","DG575PST",10,0)
 D XR(2.06,.01)
"RTN","DG575PST",11,0)
 D TEMPL
"RTN","DG575PST",12,0)
 Q
"RTN","DG575PST",13,0)
 ;
"RTN","DG575PST",14,0)
XR(DGFILE,DGFLD) ;File index type cross references
"RTN","DG575PST",15,0)
 ;
"RTN","DG575PST",16,0)
 N DGFDA,DGIEN,DGWP,DGERR,DGXR,DGVAL,DGOUT,DIERR
"RTN","DG575PST",17,0)
 ;Set up x-refs. Any value that has a ".", will have the period
"RTN","DG575PST",18,0)
 ;replaved with a "D" to prevent x-ref's such as .11 and 11 having
"RTN","DG575PST",19,0)
 ;identical xref names
"RTN","DG575PST",20,0)
 I DGFILE=2.01 S DGXR="AVAFC20101" ;ALIAS
"RTN","DG575PST",21,0)
 I DGFILE=2.02 S DGXR="AVAFC20201" ;RACE
"RTN","DG575PST",22,0)
 I DGFILE=2.06 S DGXR="AVAFC20601" ;ETHNICITY
"RTN","DG575PST",23,0)
 I '$D(DGXR) S DGXR=$S(DGFLD[".":"AVAFC"_$P(DGFLD,".",2),1:"AVAFC"_DGFLD)
"RTN","DG575PST",24,0)
 ;Check for existing x-ref
"RTN","DG575PST",25,0)
 S DGVAL(1)=DGFILE,DGVAL(2)=DGXR
"RTN","DG575PST",26,0)
 D FIND^DIC(.11,"","@;IXIE","KP",.DGVAL,"","","","","DGOUT")
"RTN","DG575PST",27,0)
 I $D(DGOUT("DILIST",1)) D  Q
"RTN","DG575PST",28,0)
 .D MES^XPDUTL("     >>> Cross reference "_DGXR_" already exists, nothing filed.")
"RTN","DG575PST",29,0)
 .Q
"RTN","DG575PST",30,0)
 ;Create filer array
"RTN","DG575PST",31,0)
 S DGFDA(.11,"+1,",.01)=DGFILE                      ;FILE
"RTN","DG575PST",32,0)
 S DGFDA(.11,"+1,",.02)=DGXR                        ;NAME
"RTN","DG575PST",33,0)
 S DGFDA(.11,"+1,",.11)="This x-ref calls the DG FIELD MONITOR event point."     ;SHORT DESCRIPTION
"RTN","DG575PST",34,0)
 S DGFDA(.11,"+1,",.2)="MU"                         ;TYPE
"RTN","DG575PST",35,0)
 S DGFDA(.11,"+1,",.4)="F"                          ;EXECUTION
"RTN","DG575PST",36,0)
 S DGFDA(.11,"+1,",.41)="I"                         ;ACTIVITY
"RTN","DG575PST",37,0)
 S DGFDA(.11,"+1,",.5)="I"                          ;ROOT TYPE
"RTN","DG575PST",38,0)
 S DGFDA(.11,"+1,",.51)=DGFILE                      ;ROOT FILE
"RTN","DG575PST",39,0)
 S DGFDA(.11,"+1,",.42)="A"                         ;USE
"RTN","DG575PST",40,0)
 S DGFDA(.11,"+1,",1.1)="D FC^DGFCPROT(.DA,"_DGFILE_","_DGFLD_",""SET"",$H,$G(DUZ),.X,.X1,.X2,$G(XQY0)) Q"     ;SET LOGIC
"RTN","DG575PST",41,0)
 S DGFDA(.11,"+1,",2.1)="D FC^DGFCPROT(.DA,"_DGFILE_","_DGFLD_",""KILL"",$H,$G(DUZ),.X,.X1,.X2,$G(XQY0)) Q"     ;KILL LOGIC
"RTN","DG575PST",42,0)
 ;CROSS REFERENCE VALUES
"RTN","DG575PST",43,0)
 S DGFDA(.114,"+2,+1,",.01)=1                       ;ORDER NUMBER
"RTN","DG575PST",44,0)
 S DGFDA(.114,"+2,+1,",1)="F"                       ;TYPE OF VALUE
"RTN","DG575PST",45,0)
 S DGFDA(.114,"+2,+1,",2)=DGFILE                    ;FILE NUMBER
"RTN","DG575PST",46,0)
 S DGFDA(.114,"+2,+1,",3)=DGFLD                     ;FIELD NUMBER
"RTN","DG575PST",47,0)
 S DGFDA(.114,"+2,+1,",7)="F"                       ;COLLATION
"RTN","DG575PST",48,0)
 ;DESCRIPTION
"RTN","DG575PST",49,0)
 S DGWP(1)="This cross reference activates the DG FIELD MONITOR event point."
"RTN","DG575PST",50,0)
 S DGWP(2)="Applications that wish to monitor edit activity related to this field may"
"RTN","DG575PST",51,0)
 S DGWP(3)="subscribe to that event point and take action as indicated by the changes"
"RTN","DG575PST",52,0)
 S DGWP(4)="that occur.  Refer to the DG FIELD MONITOR protocol for a description of"
"RTN","DG575PST",53,0)
 S DGWP(5)="the information available at the time of the event."
"RTN","DG575PST",54,0)
 ;File INDEX record
"RTN","DG575PST",55,0)
 D UPDATE^DIE("","DGFDA","DGIEN","DGERR")
"RTN","DG575PST",56,0)
 I $D(DIERR) D  Q
"RTN","DG575PST",57,0)
 .N DGI S DGI=""
"RTN","DG575PST",58,0)
 .D MES^XPDUTL("     >>> A problem has occurred during the filing of x-ref. "_DGXR_"!")
"RTN","DG575PST",59,0)
 .D MES^XPDUTL("         Please contact Customer Support.")
"RTN","DG575PST",60,0)
 .F  S DGI=$O(DGERR("DIERR",1,"TEXT",DGI)) Q:DGI=""  D
"RTN","DG575PST",61,0)
 ..D MES^XPDUTL(DGERR("DIERR",1,"TEXT",DGI))
"RTN","DG575PST",62,0)
 ..Q
"RTN","DG575PST",63,0)
 .Q
"RTN","DG575PST",64,0)
 S DGFLD(DGFILE,DGFLD)=""  ;Create list to recompile templates
"RTN","DG575PST",65,0)
 D MES^XPDUTL("     >>> "_DGXR_" cross reference filed.")
"RTN","DG575PST",66,0)
 ;File DESCRIPTION field
"RTN","DG575PST",67,0)
 D WP^DIE(.11,DGIEN(1)_",",.1,"","DGWP")
"RTN","DG575PST",68,0)
 Q
"RTN","DG575PST",69,0)
TEMPL N GLOBAL,FIELD,NFIELD,FILE,CNT
"RTN","DG575PST",70,0)
 D BMES^XPDUTL("Beginning to compile templates on the PATIENT (#2) file.")
"RTN","DG575PST",71,0)
 ;
"RTN","DG575PST",72,0)
 S NFIELD=".302,1,2,6,994",FILE=2,FIELD="",CNT=1
"RTN","DG575PST",73,0)
 F  S FIELD=$P(NFIELD,",",CNT) Q:FIELD=""  D LOOP(FIELD,FILE) S CNT=CNT+1
"RTN","DG575PST",74,0)
 S NFIELD=.01,FILE=2.02 D LOOP(NFIELD,FILE)
"RTN","DG575PST",75,0)
 S NFIELD=.01,FILE=2.06 D LOOP(NFIELD,FILE)
"RTN","DG575PST",76,0)
 S NFIELD=.01,FILE=2.01 D LOOP(NFIELD,FILE)
"RTN","DG575PST",77,0)
 W !!
"RTN","DG575PST",78,0)
 S (X,Y)=""
"RTN","DG575PST",79,0)
 D BMES^XPDUTL("The following routine namespace was compiled:")
"RTN","DG575PST",80,0)
 F  S X=$O(CFIELD(X)) Q:X=""  S Y=$G(Y)+1 S PRINT(Y)=" "_X_"*"
"RTN","DG575PST",81,0)
 ;
"RTN","DG575PST",82,0)
 D MES^XPDUTL(.PRINT)
"RTN","DG575PST",83,0)
 K X,Y,PRINT,CFIELD
"RTN","DG575PST",84,0)
 Q
"RTN","DG575PST",85,0)
 ;
"RTN","DG575PST",86,0)
LOOP(FIELD,FILE) ;
"RTN","DG575PST",87,0)
 N GLOBAL,TEMPLATP,TEMPLATN,X,Y,DMAX
"RTN","DG575PST",88,0)
 F GLOBAL="^DIE","^DIPT" DO
"RTN","DG575PST",89,0)
 .I $D(@GLOBAL@("AF",FILE,FIELD)) D
"RTN","DG575PST",90,0)
 ..S TEMPLATP=0
"RTN","DG575PST",91,0)
 ..F  S TEMPLATP=$O(@GLOBAL@("AF",FILE,FIELD,TEMPLATP)) Q:'TEMPLATP  DO
"RTN","DG575PST",92,0)
 ...S TEMPLATN=$P($G(@GLOBAL@(TEMPLATP,0)),"^",1)
"RTN","DG575PST",93,0)
 ...I TEMPLATN="" D BMES^XPDUTL("Could not compile template "_TEMPLATN_$C(13,10)_"Please review!") Q
"RTN","DG575PST",94,0)
 ...S X=$P($G(@GLOBAL@(TEMPLATP,"ROUOLD")),"^")
"RTN","DG575PST",95,0)
 ...I X=""&($D(@GLOBAL@(TEMPLATP,"ROU"))'=0) D BMES^XPDUTL("Could not find routine for template "_TEMPLATN_$C(13,10)_"Please review!") Q
"RTN","DG575PST",96,0)
 ...I X=""&($D(@GLOBAL@(TEMPLATP,"ROU"))=0) Q
"RTN","DG575PST",97,0)
 ...I $D(CFIELD(X)) Q  ;already compiled
"RTN","DG575PST",98,0)
 ...S CFIELD(X)="" ;                remember the template was compiled
"RTN","DG575PST",99,0)
 ...S Y=TEMPLATP ;                 set up the call for fman
"RTN","DG575PST",100,0)
 ...S DMAX=$$ROUSIZE^DILF
"RTN","DG575PST",101,0)
 ...I GLOBAL="^DIE" D BMES^XPDUTL(" "),BMES^XPDUTL("   Compiling Input Templates") D EN^DIEZ Q
"RTN","DG575PST",102,0)
 ...I GLOBAL="^DIPT" D BMES^XPDUTL(" "),BMES^XPDUTL("   Compiling Print Templates") D EN^DIPZ Q
"RTN","DG575PST",103,0)
 Q
"RTN","VAFCQRY")
0^6^B10059825
"RTN","VAFCQRY",1,0)
VAFCQRY ;BIR/DLR-Query for patient demographics ;10/18/2000
"RTN","VAFCQRY",2,0)
 ;;5.3;Registration;**428,575**;Aug 13, 1993
"RTN","VAFCQRY",3,0)
IN ;process in the patient query
"RTN","VAFCQRY",4,0)
 N IEN,HLA,VAFCCNT,ICN,CLAIM,SG,VAFCER,VAFC,DFN,STATE,CITY,SUBCOMP,COMP,REP,LVL,LVL2,VAFC,SSN
"RTN","VAFCQRY",5,0)
 S VAFCCNT=1,VAFCER=1
"RTN","VAFCQRY",6,0)
 F VAFC=1:1 X HLNEXT Q:HLQUIT'>0  S SG=$E(HLNODE,1,3) D:$T(@SG)]"" @SG
"RTN","VAFCQRY",7,0)
 D CHKID^VAFCQRY2(.ICN,.SSN,.DFN)
"RTN","VAFCQRY",8,0)
 I $G(DFN)'>0 S VAFCER="-1^Unknown ICN#"_$G(ICN)_" and SSN#"_$G(SSN)
"RTN","VAFCQRY",9,0)
 S ^TMP("HLA",$J,VAFCCNT)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(VAFCER)'>0:$P(VAFCER,"^",2),1:""),VAFCCNT=VAFCCNT+1
"RTN","VAFCQRY",10,0)
 S ^TMP("HLA",$J,VAFCCNT)=VAFCQRD,VAFCCNT=VAFCCNT+1
"RTN","VAFCQRY",11,0)
 I $G(VAFCER)>0 D BLDRSP(DFN,.VAFCCNT)
"RTN","VAFCQRY",12,0)
 D LINK^HLUTIL3(SITE,.VAFC) S IEN=$O(VAFC(0)) S HLL("LINKS",1)="^"_VAFC(IEN)
"RTN","VAFCQRY",13,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"GM",1,.HLRESLTA,"",.HL)
"RTN","VAFCQRY",14,0)
 K VAFCER,VAFCID,COMP,SITE,VAFCFS,VAFCRCV,VAFCQRD,^TMP("HLA",$J)
"RTN","VAFCQRY",15,0)
 Q
"RTN","VAFCQRY",16,0)
RESP ;Response processing initiated from the MPI.
"RTN","VAFCQRY",17,0)
 Q
"RTN","VAFCQRY",18,0)
ROUTE ;Routine logic initiated from the MPI.
"RTN","VAFCQRY",19,0)
 Q
"RTN","VAFCQRY",20,0)
BLDRSP(DFN,VAFCCNT) ;
"RTN","VAFCQRY",21,0)
 N EVN,PID,PD1,SEQ,ERR,CNT,X
"RTN","VAFCQRY",22,0)
 ;construct EVN (for TF Event Type AND Last Treatment Date)
"RTN","VAFCQRY",23,0)
 S SEQ="1,2" D BLDEVN(DFN,.SEQ,.EVN,.HL,"A19",.ERR) S ^TMP("HLA",$J,VAFCCNT)=EVN(1) S VAFCCNT=VAFCCNT+1
"RTN","VAFCQRY",24,0)
 ;construct PID
"RTN","VAFCQRY",25,0)
 S SEQ="" D BLDPID(DFN,1,.SEQ,.PID,.HL,.ERR) S ^TMP("HLA",$J,VAFCCNT)=PID(1) S X=1,CNT=1 F  S X=$O(PID(X)) Q:'X  I $D(PID(X)) S ^TMP("HLA",$J,VAFCCNT,CNT)=PID(X),CNT=CNT+1
"RTN","VAFCQRY",26,0)
 S VAFCCNT=VAFCCNT+1
"RTN","VAFCQRY",27,0)
 ;construct PD1 (for CMOR)
"RTN","VAFCQRY",28,0)
 S SEQ="3" D BLDPD1(DFN,.SEQ,.PD1,.HL,.ERR) S ^TMP("HLA",$J,VAFCCNT)=PD1(1)
"RTN","VAFCQRY",29,0)
 S VAFCCNT=VAFCCNT+1
"RTN","VAFCQRY",30,0)
 ;** PATCH 575
"RTN","VAFCQRY",31,0)
 ;construct ZPD segment
"RTN","VAFCQRY",32,0)
 S SEQ="17"
"RTN","VAFCQRY",33,0)
 S ^TMP("HLA",$J,VAFCCNT)=$$EN1^VAFHLZPD(DFN,SEQ)
"RTN","VAFCQRY",34,0)
 S VAFCCNT=VAFCCNT+1
"RTN","VAFCQRY",35,0)
 Q
"RTN","VAFCQRY",36,0)
MSH ;process MSH segment
"RTN","VAFCQRY",37,0)
 S VAFCFS=HL("FS")
"RTN","VAFCQRY",38,0)
 S HLQ=HL("Q"),HLFS=HL("FS"),HLECH=HL("ECH")
"RTN","VAFCQRY",39,0)
 S VAFCID=HL("MID")
"RTN","VAFCQRY",40,0)
 S COMP=$E(HL("ECH"),1)
"RTN","VAFCQRY",41,0)
 S REP=$E(HL("ECH"),2)
"RTN","VAFCQRY",42,0)
 S SUBCOMP=$E(HL("ECH"),4)
"RTN","VAFCQRY",43,0)
 S SITE=$$LKUP^XUAF4($P($P(HLNODE,HL("FS"),4),COMP))
"RTN","VAFCQRY",44,0)
 Q
"RTN","VAFCQRY",45,0)
QRD ;process QRD segment
"RTN","VAFCQRY",46,0)
 N QRD,X,IDS,WSF,ID,QRDAA,QRDNTC
"RTN","VAFCQRY",47,0)
 S VAFCQRD=HLNODE
"RTN","VAFCQRY",48,0)
 S VAFCRCV=$P(VAFCQRD,HL("FS"),5)
"RTN","VAFCQRY",49,0)
 S IDS=$P(VAFCQRD,HL("FS"),9)
"RTN","VAFCQRY",50,0)
 F X=1:1:$L(IDS,REP) S WSF=$P(IDS,REP,X) D
"RTN","VAFCQRY",51,0)
 . ;get id, assigning authority, and name type code
"RTN","VAFCQRY",52,0)
 . S ID=$P(WSF,COMP),QRDAA=$P($P(WSF,COMP,9),SUBCOMP),QRDNTC=$P(WSF,COMP,10)
"RTN","VAFCQRY",53,0)
 . ;check assigning authority(0363) AND name type code(0203)
"RTN","VAFCQRY",54,0)
 . I QRDAA="USVHA" D
"RTN","VAFCQRY",55,0)
 .. I QRDNTC="NI" S ICN=ID  ;National unique individual identifier
"RTN","VAFCQRY",56,0)
 .. I QRDNTC="PI" S DFN=ID  ;Patient internal identifier
"RTN","VAFCQRY",57,0)
 . I QRDAA="USSSA" D
"RTN","VAFCQRY",58,0)
 .. I QRDNTC="SS" S SSN=ID  ;Social Security number
"RTN","VAFCQRY",59,0)
 Q
"RTN","VAFCQRY",60,0)
BLDEVN(DFN,SEQ,EVN,HL,EVR,ERR) ;build EVN for TF last treatment date and event reason
"RTN","VAFCQRY",61,0)
 ; At this point only sequence one and two are supported
"RTN","VAFCQRY",62,0)
 ; Variable list
"RTN","VAFCQRY",63,0)
 ;  DFN - internal PATIENT (#2) number
"RTN","VAFCQRY",64,0)
 ;  SEQ - variable consisting of sequence numbers delimited by commas
"RTN","VAFCQRY",65,0)
 ;        that will be used to build the message
"RTN","VAFCQRY",66,0)
 ;  EVN (passed by reference) - array location to place EVN segment result, the array can have existing values when passed.
"RTN","VAFCQRY",67,0)
 ;   HL - array that contains the necessary HL variables (init^hlsub)
"RTN","VAFCQRY",68,0)
 ;  EVR - event reason that triggered this message
"RTN","VAFCQRY",69,0)
 ;  ERR - array that is used to return an error
"RTN","VAFCQRY",70,0)
 ;
"RTN","VAFCQRY",71,0)
 D BLDEVN^VAFCQRY2(DFN,SEQ,.EVN,.HL,EVR,.ERR)
"RTN","VAFCQRY",72,0)
 Q
"RTN","VAFCQRY",73,0)
BLDPD1(DFN,SEQ,PD1,HL,ERR) ;
"RTN","VAFCQRY",74,0)
 ; At this point only sequence 3 is supported
"RTN","VAFCQRY",75,0)
 ; Variable list
"RTN","VAFCQRY",76,0)
 ;  DFN - internal PATIENT (#2) number
"RTN","VAFCQRY",77,0)
 ;  SEQ - variable consisting of sequence numbers delimited by commas
"RTN","VAFCQRY",78,0)
 ;        that will be used to build the message
"RTN","VAFCQRY",79,0)
 ;  PD1 (passed by reference) - array location to place PD1 segment result, the array can have existing values when passed.
"RTN","VAFCQRY",80,0)
 ;   HL - array that contains the necessary HL variables (init^hlsub)
"RTN","VAFCQRY",81,0)
 ;  ERR - array that is used to return an error
"RTN","VAFCQRY",82,0)
 ;
"RTN","VAFCQRY",83,0)
 D BLDPD1^VAFCQRY2(DFN,SEQ,.PD1,.HL,.ERR)
"RTN","VAFCQRY",84,0)
 Q
"RTN","VAFCQRY",85,0)
BLDPID(DFN,CNT,SEQ,PID,HL,ERR) ;build PID from File #2
"RTN","VAFCQRY",86,0)
 ;The required sequences 3 and 5 will be returned and at this point
"RTN","VAFCQRY",87,0)
 ;sequences 1-3,5-8,10-14,16,17,19,22-24 and 29 are supported
"RTN","VAFCQRY",88,0)
 ;
"RTN","VAFCQRY",89,0)
 ; At this point only sequence one and two are supported
"RTN","VAFCQRY",90,0)
 ; Variable list
"RTN","VAFCQRY",91,0)
 ;  DFN - internal PATIENT (#2) number
"RTN","VAFCQRY",92,0)
 ;  CNT - value to be place in PID seq#1 (SET ID)
"RTN","VAFCQRY",93,0)
 ;  SEQ - variable consisting of sequence numbers delimited by commas
"RTN","VAFCQRY",94,0)
 ;        that will be used to build the message
"RTN","VAFCQRY",95,0)
 ;  PID (passed by reference) - array location to place PID segment
"RTN","VAFCQRY",96,0)
 ;        result, the array can have existing values when passed.
"RTN","VAFCQRY",97,0)
 ;   HL - array that contains the necessary HL variables (init^hlsub)
"RTN","VAFCQRY",98,0)
 ;  ERR - array that is used to return an error
"RTN","VAFCQRY",99,0)
 ;
"RTN","VAFCQRY",100,0)
 ;if this is a mismatch a null or """" should be passed in, so that
"RTN","VAFCQRY",101,0)
 ;the ICN will be removed at the site
"RTN","VAFCQRY",102,0)
 ;
"RTN","VAFCQRY",103,0)
 D BLDPID^VAFCQRY1(DFN,CNT,SEQ,.PID,.HL,.ERR)
"RTN","VAFCQRY",104,0)
 Q
"RTN","VAFCQRY1")
0^1^B49608704
"RTN","VAFCQRY1",1,0)
VAFCQRY1 ;BIR/DLR-Query for patient demographics ;10/30/02  13:58
"RTN","VAFCQRY1",2,0)
 ;;5.3;Registration;**428,474,477,575**;Aug 13, 1993
"RTN","VAFCQRY1",3,0)
 ;
"RTN","VAFCQRY1",4,0)
 ;Reference to $$GETDFNS^MPIF002 supported by IA #3634.
"RTN","VAFCQRY1",5,0)
 ;
"RTN","VAFCQRY1",6,0)
BLDPID(DFN,CNT,SEQ,PID,HL,ERR)  ;build PID from File #2
"RTN","VAFCQRY1",7,0)
 ; Variable list
"RTN","VAFCQRY1",8,0)
 ;  DFN - internal PATIENT (#2) number
"RTN","VAFCQRY1",9,0)
 ;  CNT - value to be place in PID seq#1 (SET ID)
"RTN","VAFCQRY1",10,0)
 ;  SEQ - variable consisting of sequence numbers delimited by commas
"RTN","VAFCQRY1",11,0)
 ;        that will be used to build the message (default is ALL)
"RTN","VAFCQRY1",12,0)
 ;  PID (passed by reference) - array location to place PID segment
"RTN","VAFCQRY1",13,0)
 ;        result, the array can have existing values when passed.
"RTN","VAFCQRY1",14,0)
 ;   HL - array that contains the necessary HL variables (init^hlsub)
"RTN","VAFCQRY1",15,0)
 ;  ERR - array that is used to return an error
"RTN","VAFCQRY1",16,0)
 ;
"RTN","VAFCQRY1",17,0)
 N VAFCMN,VAFCMMN,SITE,VAFCZN,SSN,SITE,APID,HIST,HISTDT,VAFCHMN,NXT,NXTC,COMP,REP,SUBCOMP,STATE,CITY,CLAIM,HLECH,HLFS,HLQ,STATEIEN,SARY,LVL,LNGTH,X
"RTN","VAFCQRY1",18,0)
 I '$D(SEQ) S SEQ="ALL"
"RTN","VAFCQRY1",19,0)
 I SEQ="" S SEQ="ALL"
"RTN","VAFCQRY1",20,0)
 I SEQ'="ALL" D
"RTN","VAFCQRY1",21,0)
 .; setting up temp array to hold fields to be included in message
"RTN","VAFCQRY1",22,0)
 .N POS,EN S POS=1 F  S EN=$P(SEQ,",",POS) Q:EN=""  S SARY(EN)="",POS=POS+1
"RTN","VAFCQRY1",23,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),HLQ=HL("Q"),COMP=$E(HL("ECH"),1)
"RTN","VAFCQRY1",24,0)
 S SUBCOMP=$E(HL("ECH"),4),REP=$E(HL("ECH"),2)
"RTN","VAFCQRY1",25,0)
 ;get Patient File MPI node
"RTN","VAFCQRY1",26,0)
 S VAFCMN=$$MPINODE^MPIFAPI(DFN)
"RTN","VAFCQRY1",27,0)
 I +VAFCMN<0 S VAFCMN=""
"RTN","VAFCQRY1",28,0)
 S VAFCZN=^DPT(DFN,0),SSN=$P(^DPT(DFN,0),"^",9)
"RTN","VAFCQRY1",29,0)
 S SITE=$$SITE^VASITE
"RTN","VAFCQRY1",30,0)
 N TMP F TMP=1:1:31 S APID(TMP)=""
"RTN","VAFCQRY1",31,0)
 S APID(2)=CNT
"RTN","VAFCQRY1",32,0)
 ;repeat patient ID list including ICN (NI),SSN (SS),CLAIM# (PN) AND DFN (PI)
"RTN","VAFCQRY1",33,0)
 I $D(SARY(3))!(SEQ="ALL") D
"RTN","VAFCQRY1",34,0)
 .S APID(4)=""
"RTN","VAFCQRY1",35,0)
 .;National Identifier (ICN)
"RTN","VAFCQRY1",36,0)
 .I VAFCMN'="" I +VAFCMN>0 S APID(4)=$P(VAFCMN,"^")_"V"_$P(VAFCMN,"^",2)_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L" D
"RTN","VAFCQRY1",37,0)
 ..;Assumption that if this is a local ICN at this point send the message with an expiration date of today, so that it will be treated as a deprecated ID and stored on the MPI as such
"RTN","VAFCQRY1",38,0)
 ..I $E($P(VAFCMN,"^"),1,3)=$P($$SITE^VASITE,"^",3) S APID(4)=APID(4)_COMP_COMP_$$HLDATE^HLFNC(DT)
"RTN","VAFCQRY1",39,0)
 .I $G(SSN)'="" S APID(4)=APID(4)_$S(APID(4)'="":REP,1:"")_SSN_COMP_COMP_COMP_"USSSA"_SUBCOMP_SUBCOMP_"0363"_COMP_"SS"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"
"RTN","VAFCQRY1",40,0)
 .I $G(DFN)'="" S APID(4)=APID(4)_$S(APID(4)'="":REP,1:"")_DFN_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L" D
"RTN","VAFCQRY1",41,0)
 ..;CLAIM#
"RTN","VAFCQRY1",42,0)
 ..I $D(^DPT(DFN,.31)) S CLAIM=$P(^DPT(DFN,.31),"^",3) I +CLAIM>0 S APID(4)=APID(4)_REP_CLAIM_COMP_COMP_COMP_"USVBA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PN"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"
"RTN","VAFCQRY1",43,0)
 .I $D(^DPT(DFN,"MPIFHIS")) N HIST S NXTC=0,LVL=0,HIST=0  F  S HIST=$O(^DPT(DFN,"MPIFHIS",HIST)) Q:'HIST  S VAFCHMN=^DPT(DFN,"MPIFHIS",HIST,0) S HISTDT=$P(VAFCHMN,"^",4) D
"RTN","VAFCQRY1",44,0)
 ..;**477 due to a timing issue if checksum and D/T of deprication of ICN is not present hang two seconds and try again if still not able to get ICN set D/T to DT
"RTN","VAFCQRY1",45,0)
 ..I $G(HISTDT)="" H 2 S VAFCHMN=^DPT(DFN,"MPIFHIS",HIST,0) S HISTDT=$P(VAFCHMN,"^",4) I HISTDT="" S HISTDT=DT
"RTN","VAFCQRY1",46,0)
 ..I APID(4)'="" D
"RTN","VAFCQRY1",47,0)
 ...S NXT=$P(VAFCHMN,"^")_"V"_$P(VAFCHMN,"^",2)_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"_COMP_COMP_$$HLDATE^HLFNC(HISTDT)
"RTN","VAFCQRY1",48,0)
 ...I LVL=0 D
"RTN","VAFCQRY1",49,0)
 ....I $L(APID(4)_NXT)'>244 S APID(4)=APID(4)_REP_NXT Q
"RTN","VAFCQRY1",50,0)
 ....I $L(APID(4)_NXT)>244 S LVL=1 S LNGTH=244-$L(APID(4)),APID(4)=APID(4)_REP_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),NXTC=1
"RTN","VAFCQRY1",51,0)
 ...I LVL>0 D
"RTN","VAFCQRY1",52,0)
 ....I $L($G(APID(4,LVL))_NXT)'>245 S APID(4,LVL)=$G(APID(4,LVL))_$S(NXTC=0:REP,1:"")_NXT Q
"RTN","VAFCQRY1",53,0)
 ....I $L($G(APID(4,LVL))_NXT)>245 S LNGTH=244-$L(APID(4,LVL)),APID(4,LVL)=APID(4,LVL)_REP_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)) S LVL=LVL+1 S APID(4,LVL)=NXT
"RTN","VAFCQRY1",54,0)
 ..I NXTC=1 S NXTC=0
"RTN","VAFCQRY1",55,0)
 ..I APID(4)="" S APID(4)=$P(VAFCHMN,"^")_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"_COMP_COMP_$$HLDATE^HLFNC(HISTDT)
"RTN","VAFCQRY1",56,0)
 ;patient name (last^first^middle^suffix^prefix^^"L" for legal)
"RTN","VAFCQRY1",57,0)
 I $D(SARY(5))!(SEQ="ALL") D
"RTN","VAFCQRY1",58,0)
 .S APID(6)=$$HLNAME^XLFNAME($P(VAFCZN,"^"),"",$E(HL("ECH"),1)) I $P(APID(6),$E(HL("ECH"),1),7)'="L" S $P(APID(6),$E(HL("ECH"),1),7)="L"
"RTN","VAFCQRY1",59,0)
 .;patient alia (last^first^middle^suffice^prefix^^"A" for alias - can be multiple)
"RTN","VAFCQRY1",60,0)
 .N ALIAS,ALIEN,VAFCA D GETS^DIQ(2,DFN_",","1*","E","VAFCA")
"RTN","VAFCQRY1",61,0)
 .; VAFCA(2.01,"1,1",.01,"E")=Funky K
"RTN","VAFCQRY1",62,0)
 .I $O(VAFCA(2.01,0))'="" S ALIEN=0 F  S ALIEN=$O(VAFCA(2.01,ALIEN)) Q:'ALIEN  D
"RTN","VAFCQRY1",63,0)
 ..S ALIAS=$G(VAFCA(2.01,ALIEN,.01,"E"))
"RTN","VAFCQRY1",64,0)
 ..S ALIAS=$$HLNAME^XLFNAME(ALIAS,"",$E(HL("ECH"),1))
"RTN","VAFCQRY1",65,0)
 ..Q:ALIAS=""
"RTN","VAFCQRY1",66,0)
 ..S $P(ALIAS,$E(HL("ECH"),1),7)="A",APID(6)=APID(6)_REP_ALIAS
"RTN","VAFCQRY1",67,0)
 .I APID(6)="" S APID(6)=HL("Q")
"RTN","VAFCQRY1",68,0)
 ;mother's maiden name  (last^first^middle^suffix^prefix^^"M" for maiden name)
"RTN","VAFCQRY1",69,0)
 I $D(SARY(6))!(SEQ="ALL") D
"RTN","VAFCQRY1",70,0)
 .S APID(7)=HL("Q")
"RTN","VAFCQRY1",71,0)
 .I $D(^DPT(DFN,.24)) S VAFCMMN=$P(^DPT(DFN,.24),"^",3) D
"RTN","VAFCQRY1",72,0)
 ..S APID(7)=$$HLNAME^XLFNAME(VAFCMMN,"",$E(HL("ECH"),1)) I APID(7)="" S APID(7)=HL("Q")
"RTN","VAFCQRY1",73,0)
 ..I $P(APID(7),$E(HL("ECH"),1),7)'="M" S $P(APID(7),$E(HL("ECH"),1),7)="M"
"RTN","VAFCQRY1",74,0)
 .I APID(7)="" S APID(7)=HL("Q")
"RTN","VAFCQRY1",75,0)
 I $D(SARY(7))!(SEQ="ALL") S APID(8)=$$HLDATE^HLFNC($P(VAFCZN,"^",3)) I APID(8)="" S APID(8)=HL("Q") ;date/time of birth
"RTN","VAFCQRY1",76,0)
 I $D(SARY(8))!(SEQ="ALL") S APID(9)=$P(VAFCZN,"^",2) I APID(9)="" S APID(9)=HL("Q") ;sex
"RTN","VAFCQRY1",77,0)
 ;place of birth city and state
"RTN","VAFCQRY1",78,0)
ADDR ;
"RTN","VAFCQRY1",79,0)
 I $D(SARY(11))!(SEQ="ALL") S APID(12)="" D
"RTN","VAFCQRY1",80,0)
 .I $D(^DPT(DFN,0)) D
"RTN","VAFCQRY1",81,0)
 ..;address info
"RTN","VAFCQRY1",82,0)
 ..S $P(APID(12),COMP)=$$GET1^DIQ(2,DFN_",",.111) I $P(APID(12),COMP)="" S $P(APID(12),COMP)=HL("Q")
"RTN","VAFCQRY1",83,0)
 ..N LINE2 S LINE2=$$GET1^DIQ(2,DFN_",",.112) N LINE3 S LINE3=$$GET1^DIQ(2,DFN_",",.113)
"RTN","VAFCQRY1",84,0)
 ..S $P(APID(12),COMP,2)=LINE2 I $P(APID(12),COMP,2)="" S $P(APID(12),COMP,2)=HL("Q")
"RTN","VAFCQRY1",85,0)
 ..S $P(APID(12),COMP,8)=LINE3 I $P(APID(12),COMP,8)="" S $P(APID(12),COMP,8)=HL("Q")
"RTN","VAFCQRY1",86,0)
 ..S $P(APID(12),COMP,3)=$$GET1^DIQ(2,DFN_",",.114) I $P(APID(12),COMP,3)="" S $P(APID(12),COMP,3)=HL("Q")
"RTN","VAFCQRY1",87,0)
 ..S STATEIEN=$$GET1^DIQ(2,DFN_",",.115,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) S $P(APID(12),COMP,4)=$G(STATE) I $P(APID(12),COMP,4)="" S $P(APID(12),COMP,4)=HL("Q")
"RTN","VAFCQRY1",88,0)
 ..S $P(APID(12),COMP,5)=$$GET1^DIQ(2,DFN_",",.1112) I $P(APID(12),COMP,5)="" S $P(APID(12),COMP,5)=HL("Q")
"RTN","VAFCQRY1",89,0)
 ..S $P(APID(12),COMP,7)="P"
"RTN","VAFCQRY1",90,0)
 ..;place of birth information
"RTN","VAFCQRY1",91,0)
 ..S CITY=$$GET1^DIQ(2,DFN_",",.092) D
"RTN","VAFCQRY1",92,0)
 ...I $G(CITY)'="" S $P(X,COMP,3)=CITY
"RTN","VAFCQRY1",93,0)
 ...I $G(CITY)="" S $P(X,COMP,3)=HL("Q")
"RTN","VAFCQRY1",94,0)
 ...S STATEIEN=$$GET1^DIQ(2,DFN_",",.093,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) D
"RTN","VAFCQRY1",95,0)
 ....I $G(STATE)'="" S $P(X,COMP,4)=STATE
"RTN","VAFCQRY1",96,0)
 ....I $G(STATE)="" S $P(X,COMP,4)=HL("Q")
"RTN","VAFCQRY1",97,0)
 ... S $P(X,COMP,7)="N",APID(12)=$G(APID(12))_REP_X
"RTN","VAFCQRY1",98,0)
 I $D(SARY(12))!(SEQ="ALL") S APID(13)=$$GET1^DIQ(2,DFN_",",.117) I APID(13)="" S APID(13)=HL("Q")  ;county code
"RTN","VAFCQRY1",99,0)
 I $D(SARY(13))!($D(SARY(14)))!(SEQ="ALL") N PHONEN,HNUM,WNUM S PHONEN=$G(^DPT(DFN,.13)) S HNUM=$P(PHONEN,"^",1),WNUM=$P(PHONEN,"^",2)
"RTN","VAFCQRY1",100,0)
 I $D(SARY(13))!(SEQ="ALL") S APID(14)=$$HLPHONE^HLFNC(HNUM) I APID(14)="" S APID(14)=HL("Q")
"RTN","VAFCQRY1",101,0)
 I $D(SARY(14))!(SEQ="ALL") S APID(15)=$$HLPHONE^HLFNC(WNUM) I APID(15)="" S APID(15)=HL("Q")
"RTN","VAFCQRY1",102,0)
 I $D(SARY(19))!(SEQ="ALL") S APID(20)=SSN  ;ssn passed in PID-3
"RTN","VAFCQRY1",103,0)
 I $D(SARY(23))!(SEQ="ALL") D
"RTN","VAFCQRY1",104,0)
 .S CITY=$$GET1^DIQ(2,DFN_",",.092)
"RTN","VAFCQRY1",105,0)
 .S STATEIEN=$$GET1^DIQ(2,DFN_",",.093,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) D
"RTN","VAFCQRY1",106,0)
 .I CITY'=""&(STATE'="") S APID(24)=CITY_" "_STATE  ;place of birth (not used) use PID-11 with an 'N' instead
"RTN","VAFCQRY1",107,0)
 .I CITY=""&(STATE="") S APID(24)=HL("Q")
"RTN","VAFCQRY1",108,0)
 ;list of fields used for backwards compatibility with HDR
"RTN","VAFCQRY1",109,0)
 I $D(SARY(2))!(SEQ="ALL") S APID(3)=$P(VAFCMN,"^")_"V"_$P(VAFCMN,"^",2)  ;Patient ID
"RTN","VAFCQRY1",110,0)
 D CONT^VAFCQRY3(DFN,.APID,.PID,.HL,.SARY,SEQ,.ERR,REP,COMP)
"RTN","VAFCQRY1",111,0)
 D KVA^VADPT
"RTN","VAFCQRY1",112,0)
 Q
"RTN","VAFCQRY3")
0^7^B13092523
"RTN","VAFCQRY3",1,0)
VAFCQRY3 ;BIR/CMC-CONT TO BLD PID 2.4 SEGMENT ;3/2/04
"RTN","VAFCQRY3",2,0)
 ;;5.3;Registration;**575**;Aug 13, 1993
"RTN","VAFCQRY3",3,0)
 ;
"RTN","VAFCQRY3",4,0)
CONT(DFN,APID,PID,HL,SARY,SEQ,ERROR,REP,COMP) ; continue to bld pid segment
"RTN","VAFCQRY3",5,0)
 N X,LVL,LVL2,PDOD,NXT,LNGTH
"RTN","VAFCQRY3",6,0)
 D DEM^VADPT
"RTN","VAFCQRY3",7,0)
 I $D(SARY(10))!(SEQ="ALL") D
"RTN","VAFCQRY3",8,0)
 .N RACE,IEN
"RTN","VAFCQRY3",9,0)
 .;**575 ADDING RACE FROM THE NEW RACE INFORMATION MULTIPLE
"RTN","VAFCQRY3",10,0)
 .I VADM(12)>0 D
"RTN","VAFCQRY3",11,0)
 ..S RACE="",IEN=0
"RTN","VAFCQRY3",12,0)
 ..D SEQ10^VAFHLPI1("N",HL("Q"))
"RTN","VAFCQRY3",13,0)
 ..F  S IEN=$O(VAFY(10,IEN)) Q:IEN=""  D
"RTN","VAFCQRY3",14,0)
 ...I IEN>1 S RACE=RACE_REP
"RTN","VAFCQRY3",15,0)
 ...S RACE=RACE_VAFY(10,IEN,1)_COMP_VAFY(10,IEN,2)_COMP_VAFY(10,IEN,3)_COMP_$P(VAFY(10,IEN,1),"-",1,2)_COMP_COMP_"CDC"
"RTN","VAFCQRY3",16,0)
 .I VADM(12)=0 S RACE=HL("Q")
"RTN","VAFCQRY3",17,0)
 .K VAFY(10)
"RTN","VAFCQRY3",18,0)
 .S APID(11)=RACE
"RTN","VAFCQRY3",19,0)
 I $D(SARY(22))!(SEQ="ALL") D
"RTN","VAFCQRY3",20,0)
 .;**575 ADDING ETHNICITY FROM THE NEW ETHNICITY INFORMATION MULTIPLE
"RTN","VAFCQRY3",21,0)
 .I $G(VADM(11))'=0 D
"RTN","VAFCQRY3",22,0)
 ..D SEQ22^VAFHLPI1("N",HL("Q"))
"RTN","VAFCQRY3",23,0)
 ..S APID(23)=VAFY(22,1,1)_COMP_VAFY(22,1,2)_COMP_VAFY(22,1,3)_COMP_$P(VAFY(22,1,1),"-",1,2)_COMP_COMP_"CDC"
"RTN","VAFCQRY3",24,0)
 .I $G(VADM(11))=0 S APID(23)=HL("Q")  ;ethnic group
"RTN","VAFCQRY3",25,0)
 .K VAFY(22)
"RTN","VAFCQRY3",26,0)
 I $D(SARY(16))!(SEQ="ALL") D
"RTN","VAFCQRY3",27,0)
 .S APID(17)="" I +VADM(10)>0 S X=$P($G(^DIC(11,+VADM(10),0)),"^",3),APID(17)=$S(X="S":"A",X="N":"S",X="U":"",X="":HL("Q"),1:X) ;marital status (DHCP N=HL7 S, DHCP S=HL7 A, U="") ;**477 **575
"RTN","VAFCQRY3",28,0)
 .I APID(17)="" S APID(17)=HL("Q")
"RTN","VAFCQRY3",29,0)
 I $D(SARY(17))!(SEQ="ALL") D
"RTN","VAFCQRY3",30,0)
 .S APID(18)="" I +VADM(9)>0 S APID(18)=$P($G(^DIC(13,+VADM(9),0)),"^",4) I APID(18)="" S APID(18)=29  ;religious pref (if blank send 29 (UNKNOWN))
"RTN","VAFCQRY3",31,0)
 .I APID(18)="" S APID(18)=HL("Q")
"RTN","VAFCQRY3",32,0)
 I $D(SARY(29))!(SEQ="ALL") D
"RTN","VAFCQRY3",33,0)
 .S APID(30)="" I $D(^DPT(DFN,.35)) S PDOD=$P(^DPT(DFN,.35),"^") S APID(30)=$$HLDATE^HLFNC(PDOD)  ;date of death
"RTN","VAFCQRY3",34,0)
 .I APID(30)="" S APID(30)=HL("Q")
"RTN","VAFCQRY3",35,0)
 I $D(SARY(24))!(SEQ="ALL") S APID(25)=$P($G(^DPT(DFN,"MPIMB")),"^")  ;**575 multiple birth indicator
"RTN","VAFCQRY3",36,0)
 ;list of fields not currently used or supported (# is 1 more than seq)
"RTN","VAFCQRY3",37,0)
 I $D(SARY(4))!(SEQ="ALL") S APID(5)=""  ;Alternate Patient Identifier
"RTN","VAFCQRY3",38,0)
 I $D(SARY(9))!(SEQ="ALL") S APID(10)=""  ;patient alias
"RTN","VAFCQRY3",39,0)
 I $D(SARY(15))!(SEQ="ALL") S APID(16)=""  ;primary language
"RTN","VAFCQRY3",40,0)
 I $D(SARY(18))!(SEQ="ALL") S APID(19)=""  ;patient account #
"RTN","VAFCQRY3",41,0)
 I $D(SARY(20))!(SEQ="ALL") S APID(21)=""  ;drivers lic #
"RTN","VAFCQRY3",42,0)
 I $D(SARY(21))!(SEQ="ALL") S APID(22)=""  ;mother's id
"RTN","VAFCQRY3",43,0)
 I $D(SARY(25))!(SEQ="ALL") S APID(26)=""
"RTN","VAFCQRY3",44,0)
 I $D(SARY(26))!(SEQ="ALL") S APID(27)=""
"RTN","VAFCQRY3",45,0)
 I $D(SARY(27))!(SEQ="ALL") S APID(28)=""
"RTN","VAFCQRY3",46,0)
 I $D(SARY(28))!(SEQ="ALL") S APID(29)=""
"RTN","VAFCQRY3",47,0)
 I $D(SARY(30))!(SEQ="ALL") S APID(31)=""
"RTN","VAFCQRY3",48,0)
 S PID(1)="PID"_HL("FS")
"RTN","VAFCQRY3",49,0)
 S LVL=1,X=1 F  S X=$O(APID(X)) Q:'X  D
"RTN","VAFCQRY3",50,0)
 .S PID(LVL)=$G(PID(LVL))
"RTN","VAFCQRY3",51,0)
 .S NXT=APID(X) D
"RTN","VAFCQRY3",52,0)
 ..I '$O(APID(X,0)) S NXT=NXT_HL("FS")
"RTN","VAFCQRY3",53,0)
 ..I $L($G(PID(LVL))_NXT)>245 S LNGTH=245-$L(PID(LVL)),PID(LVL)=PID(LVL)_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),LVL=LVL+1
"RTN","VAFCQRY3",54,0)
 ..I $L($G(PID(LVL))_NXT)'>245 S PID(LVL)=$G(PID(LVL))_NXT
"RTN","VAFCQRY3",55,0)
 .S LVL2=0 F  S LVL2=$O(APID(X,LVL2)) Q:'LVL2  D
"RTN","VAFCQRY3",56,0)
 ..S NXT=APID(X,LVL2) D
"RTN","VAFCQRY3",57,0)
 ...I $L($G(PID(LVL))_NXT)>245 S LNGTH=245-$L(PID(LVL)),PID(LVL)=PID(LVL)_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),LVL=LVL+1
"RTN","VAFCQRY3",58,0)
 ...I $L($G(PID(LVL))_NXT)'>245 S PID(LVL)=$G(PID(LVL))_NXT
"RTN","VAFCQRY3",59,0)
 ...I '$O(APID(X,LVL2)) S PID(LVL)=PID(LVL)_HL("FS")
"RTN","VAFCQRY3",60,0)
 K VADM
"RTN","VAFCQRY3",61,0)
 Q
"RTN","VAFCTR")
0^4^B1104232
"RTN","VAFCTR",1,0)
VAFCTR ;BIR/CMC-Monitoring fields for MPI/PD via DG field monitoring ;9/25/2003
"RTN","VAFCTR",2,0)
 ;;5.3;Registration;**575**;Aug 13, 1993
"RTN","VAFCTR",3,0)
 Q  ; quit if called from the top
"RTN","VAFCTR",4,0)
 ;
"RTN","VAFCTR",5,0)
MPIPD ; protocol entry point for monitoring fields via DG field monitoring
"RTN","VAFCTR",6,0)
 ; Currently monitoring for fields:
"RTN","VAFCTR",7,0)
 ; 1 ALIAS - .01 of the multiple
"RTN","VAFCTR",8,0)
 ; 2 RACE INFORMATION - .01 of the multiple
"RTN","VAFCTR",9,0)
 ; 6 ETHNICITY INFORMATION - .01 of the multiple
"RTN","VAFCTR",10,0)
 ; 994 MULTIPLE BIRTH INDICATOR
"RTN","VAFCTR",11,0)
 ;
"RTN","VAFCTR",12,0)
 I $G(DGFILE)'=2&($G(DGFILE)'=2.01)&($G(DGFILE)'=2.02)&($G(DGFILE)'=2.06) Q
"RTN","VAFCTR",13,0)
 S DGFIELD=$G(DGFIELD)
"RTN","VAFCTR",14,0)
 I DGFIELD'=.01&(DGFIELD'=994) Q
"RTN","VAFCTR",15,0)
 I $T(AVAFC^VAFCDD01)="" Q
"RTN","VAFCTR",16,0)
 I (DGFIELD=994) S VAFCF=DGFIELD_";" D AVAFC^VAFCDD01(DGDA)
"RTN","VAFCTR",17,0)
 ; ^ MULTIPLE BIRTH INDICATOR
"RTN","VAFCTR",18,0)
 I DGFILE=2.01 S VAFCF="1;" D AVAFC^VAFCDD01(DGDA(1)) ;ALIAS
"RTN","VAFCTR",19,0)
 I DGFILE=2.02 S VAFCF="2.02,.01;" D AVAFC^VAFCDD01(DGDA(1))
"RTN","VAFCTR",20,0)
 ; ^ RACE INFORMATION
"RTN","VAFCTR",21,0)
 I DGFILE=2.06 S VAFCF="2.06,.01;" D AVAFC^VAFCDD01(DGDA(1))
"RTN","VAFCTR",22,0)
 ; ^ ETHNICITY INFORMATION
"RTN","VAFCTR",23,0)
 Q
"RTN","VAFHPIVT")
0^5^B21313463
"RTN","VAFHPIVT",1,0)
VAFHPIVT ;ALB/CM PIVOT FILE UTILITY FUNCTIONS ;5/5/95
"RTN","VAFHPIVT",2,0)
 ;;5.3;Registration;**91,179,575**;Jun 06, 1996
"RTN","VAFHPIVT",3,0)
 ;
"RTN","VAFHPIVT",4,0)
PIVNW(DFN,EVDT,EVTY,PTR) ;
"RTN","VAFHPIVT",5,0)
 ;function will return 0 node of pivot file and pivot file entry number
"RTN","VAFHPIVT",6,0)
 ;if no entry in pivot file, create one and return #:0 node
"RTN","VAFHPIVT",7,0)
 ;
"RTN","VAFHPIVT",8,0)
 Q:$G(DFN)=""!($G(EVDT)="")!($G(EVTY)="")!($G(PTR)="") "-1^Missing Parameters for PIVNW function"
"RTN","VAFHPIVT",9,0)
 I $G(^DPT(DFN,0))="" Q "-1^PATIENT WITH PASSED DFN DOES NOT EXIST"
"RTN","VAFHPIVT",10,0)
 N CROSS,DA,NODE,NEW,PIVOT,ERR,TNODE,NNODE,FCNT,FIELDS,FLD,X,STOP
"RTN","VAFHPIVT",11,0)
 I '$D(^VAT(391.71,"AKY",EVTY,EVDT,PTR)) D
"RTN","VAFHPIVT",12,0)
 .;not in pivot file
"RTN","VAFHPIVT",13,0)
 .S PIVOT=$$GETPIV^VAFHPIV2() ;get next pivot file number
"RTN","VAFHPIVT",14,0)
 .I +PIVOT=-1 S ERR="Y"
"RTN","VAFHPIVT",15,0)
 .I '$D(ERR) S NEW="Y"
"RTN","VAFHPIVT",16,0)
 ;
"RTN","VAFHPIVT",17,0)
 I $D(^VAT(391.71,"AKY",EVTY,EVDT,PTR)) D
"RTN","VAFHPIVT",18,0)
 .;check if it's been marked as deleted
"RTN","VAFHPIVT",19,0)
 .S DA=$O(^VAT(391.71,"AKY",EVTY,EVDT,PTR,""))
"RTN","VAFHPIVT",20,0)
 .I $P(^VAT(391.71,DA,0),"^",7)'="" D
"RTN","VAFHPIVT",21,0)
 ..S STOP="N"
"RTN","VAFHPIVT",22,0)
 ..F  S DA=$O(^VAT(391.71,"AKY",EVTY,EVDT,PTR,DA)) Q:DA=""  I $D(^VAT(391.71,DA)) S:$P(^VAT(391.71,DA,0),"^",7)="" STOP="Y" Q:STOP="Y"
"RTN","VAFHPIVT",23,0)
 ..I DA="" S PIVOT=$$GETPIV^VAFHPIV2() I +PIVOT>0 S NEW="Y"
"RTN","VAFHPIVT",24,0)
 .I '$D(PIVOT) S PIVOT=$P(^VAT(391.71,DA,0),"^",2)
"RTN","VAFHPIVT",25,0)
 .I $D(PIVOT) S:+PIVOT=-1 ERR="Y"
"RTN","VAFHPIVT",26,0)
 I $D(ERR) Q "-1^Can't get new pivot number"
"RTN","VAFHPIVT",27,0)
 I $D(NEW) D
"RTN","VAFHPIVT",28,0)
 .;Set up initial entry, get next internal entry number
"RTN","VAFHPIVT",29,0)
 .L +^VAT(391.71,0):5 I '$T S ERR="-1^Unable to lock Pivot file" Q
"RTN","VAFHPIVT",30,0)
 .S DA=$P(^VAT(391.71,0),"^",3)
"RTN","VAFHPIVT",31,0)
 .F  S DA=DA+1 Q:'$D(^VAT(391.71,DA))
"RTN","VAFHPIVT",32,0)
 .S ^VAT(391.71,DA,0)="" L +^VAT(391.71,DA,0):5 I '$T S ERR="-1^Unable to lock Pivot file entry" L -^VAT(391.71,0) Q
"RTN","VAFHPIVT",33,0)
 .S $P(^VAT(391.71,0),"^",3)=DA,$P(^VAT(391.71,0),"^",4)=$P(^VAT(391.71,0),"^",4)+1 L -^VAT(391.71,0)
"RTN","VAFHPIVT",34,0)
 .S ^VAT(391.71,DA,0)=EVDT,CROSS=0
"RTN","VAFHPIVT",35,0)
 .;Set cross references for .01
"RTN","VAFHPIVT",36,0)
 .F  S CROSS=$O(^DD(391.71,.01,1,CROSS)) Q:'CROSS  I $G(^(CROSS,0))'["TRIGGER"  D
"RTN","VAFHPIVT",37,0)
 ..S X=EVDT X ^DD(391.71,.01,1,CROSS,2) ;kill cross reference
"RTN","VAFHPIVT",38,0)
 ..S X=EVDT X ^DD(391.71,.01,1,CROSS,1) ;set cross reference
"RTN","VAFHPIVT",39,0)
 .L -^VAT(391.71,DA,0)
"RTN","VAFHPIVT",40,0)
 ;
"RTN","VAFHPIVT",41,0)
 I '$D(ERR) D
"RTN","VAFHPIVT",42,0)
 .L +^VAT(391.71,DA,0):5 I '$T S ERR="-1^Unable to lock Pivot file entry" Q
"RTN","VAFHPIVT",43,0)
 .S TNODE=$G(^VAT(391.71,DA,0))
"RTN","VAFHPIVT",44,0)
 .I '$D(DGUSER) S DGUSER=DUZ
"RTN","VAFHPIVT",45,0)
 .S ^VAT(391.71,DA,0)=EVDT_"^"_PIVOT_"^"_DFN_"^"_EVTY_"^"_PTR_"^^^^"_$G(DGUSER)
"RTN","VAFHPIVT",46,0)
 .S NNODE=$G(^VAT(391.71,DA,0))
"RTN","VAFHPIVT",47,0)
 .;set cross references for all fields .01,.02,.03,.04,.05
"RTN","VAFHPIVT",48,0)
 .S FIELDS=".01,.02,.03,.04,.05",FCNT=0
"RTN","VAFHPIVT",49,0)
 .F  S FCNT=FCNT+1,FLD=$P(FIELDS,",",FCNT) Q:FLD=""  D
"RTN","VAFHPIVT",50,0)
 ..S CROSS=0
"RTN","VAFHPIVT",51,0)
 ..F  S CROSS=$O(^DD(391.71,FLD,1,CROSS)) Q:'CROSS  I $G(^(CROSS,0))'["TRIGGER" D
"RTN","VAFHPIVT",52,0)
 ...I TNODE'="" S X=$P(TNODE,"^",FCNT) I X'="" X ^DD(391.71,FLD,1,CROSS,2) ;kill cross reference
"RTN","VAFHPIVT",53,0)
 ...S X=$P(NNODE,"^",FCNT) X ^DD(391.71,FLD,1,CROSS,1) ;set cross reference
"RTN","VAFHPIVT",54,0)
 .L -^VAT(391.71,DA,0)
"RTN","VAFHPIVT",55,0)
 I $D(ERR) Q ERR
"RTN","VAFHPIVT",56,0)
 I $D(^VAT(391.71,"AKY",EVTY,EVDT,PTR)) D
"RTN","VAFHPIVT",57,0)
 .;have entry in pivot file
"RTN","VAFHPIVT",58,0)
 .S DA=$O(^VAT(391.71,"AKY",EVTY,EVDT,PTR,"")) I DA="" S ERR="-1^Bad AKY Cross Reference"
"RTN","VAFHPIVT",59,0)
 .I '$D(ERR) S STOP="N" F  Q:DA=""!(STOP="Y")  D
"RTN","VAFHPIVT",60,0)
 ..I $D(^VAT(391.71,DA,0)) D
"RTN","VAFHPIVT",61,0)
 ...I $P(^VAT(391.71,DA,0),"^",7)'=1 S NODE=$G(^VAT(391.71,DA,0)),PIVOT=$P(NODE,"^",2),STOP="Y"
"RTN","VAFHPIVT",62,0)
 ...I $P(^VAT(391.71,DA,0),"^",7)=1 S DA=$O(^VAT(391.71,"AKY",EVTY,EVDT,PTR,DA))
"RTN","VAFHPIVT",63,0)
 I '$D(^VAT(391.71,"AKY",EVTY,EVDT,PTR)) S ERR="-1^ERROR NO AKY CROSS REFERENCE"
"RTN","VAFHPIVT",64,0)
 I $D(ERR) Q ERR
"RTN","VAFHPIVT",65,0)
 Q PIVOT_":"_NODE
"RTN","VAFHPIVT",66,0)
 ;
"RTN","VAFHPIVT",67,0)
PIVX(PIVOT,DFN,EVDT) ;
"RTN","VAFHPIVT",68,0)
 ;given pivot #, check for existence and compare the data in file to
"RTN","VAFHPIVT",69,0)
 ;parameters, return pivot number:0 node
"RTN","VAFHPIVT",70,0)
 I $G(PIVOT)="" Q "-1^Missing Parameters for PIVX function"
"RTN","VAFHPIVT",71,0)
 I '$D(^VAT(391.71,"D",PIVOT)) Q "-1^No entry in Pivot file"
"RTN","VAFHPIVT",72,0)
 N ENT,ERR S ENT=$O(^VAT(391.71,"D",PIVOT,""))
"RTN","VAFHPIVT",73,0)
 I ENT="" Q "-1^BAD 'D' CROSS REFERENCE"
"RTN","VAFHPIVT",74,0)
 S NODE=$G(^VAT(391.71,ENT,0))
"RTN","VAFHPIVT",75,0)
 I $D(DFN) I $P(NODE,"^",3)'=DFN S ERR="-1^PATIENTS DON'T MATCH"
"RTN","VAFHPIVT",76,0)
 I $D(EVDT) I $P(NODE,"^")'=EVDT S ERR="-1^DATE/TIME DOESN'T MATCH"
"RTN","VAFHPIVT",77,0)
 I $P(NODE,"^",7)'="" S ERR="-1^No entry in Pivot file"
"RTN","VAFHPIVT",78,0)
 I $D(ERR) Q ERR
"RTN","VAFHPIVT",79,0)
 Q PIVOT_":"_NODE
"RTN","VAFHPIVT",80,0)
 ;
"RTN","VAFHPIVT",81,0)
PIVCHK(DFN,EVDT,EVTY,PTR) ;
"RTN","VAFHPIVT",82,0)
 ;check for existence of pivot file entry.
"RTN","VAFHPIVT",83,0)
 ;If exist, return pivot number:0 node.  If not exist, return 0
"RTN","VAFHPIVT",84,0)
 I $G(DFN)=""!($G(EVDT)="")!($G(EVTY)="")!($G(PTR)="") Q "-1^Missing parameter for PIVCHK function"
"RTN","VAFHPIVT",85,0)
 I $G(^DPT(DFN,0))="" Q "-1^PATIENT WITH PASSED DFN DOES NOT EXIST"
"RTN","VAFHPIVT",86,0)
 ;
"RTN","VAFHPIVT",87,0)
 I '$D(^VAT(391.71,"AKY",EVTY,EVDT,PTR)) Q "-1^No Entry in Pivot File"
"RTN","VAFHPIVT",88,0)
 I $O(^VAT(391.71,"AKY",EVTY,EVDT,PTR,""))="" Q "-1^Bad AKY Cross Reference"
"RTN","VAFHPIVT",89,0)
 N DA,EVENT,NODE
"RTN","VAFHPIVT",90,0)
 S (DA,NODE,EVENT)=0
"RTN","VAFHPIVT",91,0)
 F  S DA=$O(^VAT(391.71,"AKY",EVTY,EVDT,PTR,DA)) Q:'DA  DO  Q:EVENT
"RTN","VAFHPIVT",92,0)
 . S NODE=$G(^VAT(391.71,DA,0))
"RTN","VAFHPIVT",93,0)
 . I $P(NODE,"^",7)=1 Q
"RTN","VAFHPIVT",94,0)
 . S EVENT=$P(NODE,"^",2)
"RTN","VAFHPIVT",95,0)
 ;
"RTN","VAFHPIVT",96,0)
 I 'EVENT Q "-1^NO Entry in Pivot File"
"RTN","VAFHPIVT",97,0)
 I $P(NODE,"^",3)'=DFN Q "-1^DFN DOES NOT MATCH PIVOT DFN"
"RTN","VAFHPIVT",98,0)
 Q EVENT_":"_NODE
"RTN","VAFHPIVT",99,0)
 ;
"RTN","VAFHPIVT",100,0)
 Q
"VER")
8.0^22.0
"^DD",2,2,.302,0)
SERVICE CONNECTED PERCENTAGE^NJ3,0Xa^^.3;2^S DFN=DA D EV^DGLOCK Q:'$D(X)  K:+X'=X!(X>100)!(X<0)!(X?.E1"."1N.N) X I $D(X),$D(^DPT(DA,.3)),$P(^(.3),U,1)'="Y" W !?4,*7,"Only applies to service-connected applicants." K X
"^DD",2,2,.302,1,0)
^.1
"^DD",2,2,.302,1,1,0)
2^ASCP^MUMPS
"^DD",2,2,.302,1,1,1)
Q
"^DD",2,2,.302,1,1,2)
Q
"^DD",2,2,.302,1,2,0)
2^AENR302^MUMPS
"^DD",2,2,.302,1,2,1)
D AUTOUPD^DGENA2(DA)
"^DD",2,2,.302,1,2,2)
D AUTOUPD^DGENA2(DA)
"^DD",2,2,.302,1,2,3)
DO NOT DELETE
"^DD",2,2,.302,1,2,"%D",0)
^^2^2^2970630^^
"^DD",2,2,.302,1,2,"%D",1,0)
This cross-reference is used to update the patient's current Patient Enrollment 
"^DD",2,2,.302,1,2,"%D",2,0)
record.
"^DD",2,2,.302,1,2,"DT")
2970630
"^DD",2,2,.302,1,3,0)
2^AR^MUMPS
"^DD",2,2,.302,1,3,1)
S DFN=DA D EN^DGMTR K DGREQF
"^DD",2,2,.302,1,3,2)
Q
"^DD",2,2,.302,1,3,3)
DO NOT DELETE!
"^DD",2,2,.302,1,3,"%D",0)
^^2^2^2990809^
"^DD",2,2,.302,1,3,"%D",1,0)
This MUMPS cross-reference is needed to determine whether a change in
"^DD",2,2,.302,1,3,"%D",2,0)
service connected percentage requires that a means test be done.
"^DD",2,2,.302,1,3,"DT")
2990809
"^DD",2,2,.302,1,991,0)
2^AVAFC302^MUMPS
"^DD",2,2,.302,1,991,1)
I ($T(AVAFC^VAFCDD01)'="") S VAFCF=".302;" D AVAFC^VAFCDD01(DA)
"^DD",2,2,.302,1,991,2)
I ($T(AVAFC^VAFCDD01)'="") S VAFCF=".302;" D AVAFC^VAFCDD01(DA)
"^DD",2,2,.302,1,991,"%D",0)
^^15^15^3030609^
"^DD",2,2,.302,1,991,"%D",1,0)
This cross reference is used to remember that changes were made to the
"^DD",2,2,.302,1,991,"%D",2,0)
PATIENT file (#2) outside of the Registration process.  Execution of this
"^DD",2,2,.302,1,991,"%D",3,0)
cross reference will create an entry in the ADT/HL7 PIVOT file (#391.71)
"^DD",2,2,.302,1,991,"%D",4,0)
and mark it as requiring transmission of an HL7 ADT-A08 message.
"^DD",2,2,.302,1,991,"%D",5,0)
 
"^DD",2,2,.302,1,991,"%D",6,0)
The local variable VAFCFLG will be set to 1 if the cross reference is
"^DD",2,2,.302,1,991,"%D",7,0)
not executed because the change is being made from within the Registration
"^DD",2,2,.302,1,991,"%D",8,0)
process.
"^DD",2,2,.302,1,991,"%D",9,0)
 
"^DD",2,2,.302,1,991,"%D",10,0)
Execution of this cross reference can be prevented by setting the local
"^DD",2,2,.302,1,991,"%D",11,0)
variable VAFCA08 equal to 1.
"^DD",2,2,.302,1,991,"%D",12,0)
 
"^DD",2,2,.302,1,991,"%D",13,0)
The local variable VAFCF is used to identify the field edited.  This data 
"^DD",2,2,.302,1,991,"%D",14,0)
is stored in the FIELD(S) EDITED (#2.1) field in the ADT/HL7 PIVOT file 
"^DD",2,2,.302,1,991,"%D",15,0)
(#391.71).
"^DD",2,2,.302,1,991,"DT")
3030609
"^DD",2,2,.302,1,992,0)
2^ADGRU302^MUMPS
"^DD",2,2,.302,1,992,1)
D:($T(ADGRU^DGRUDD01)'="") ADGRU^DGRUDD01(DA)
"^DD",2,2,.302,1,992,2)
D:($T(ADGRU^DGRUDD01)'="") ADGRU^DGRUDD01(DA)
"^DD",2,2,.302,1,992,"%D",0)
^^9^9^2990921^
"^DD",2,2,.302,1,992,"%D",1,0)
This cross reference is used to remember that changes were made to a 
"^DD",2,2,.302,1,992,"%D",2,0)
monitored data field in the PATIENT File (#2) required for a vendor
"^DD",2,2,.302,1,992,"%D",3,0)
RAI/MDS COTS system.  Execution of this cross reference will create
"^DD",2,2,.302,1,992,"%D",4,0)
an entry in the ADT/HL7 PIVOT file (#391.71) and mark it as requiring
"^DD",2,2,.302,1,992,"%D",5,0)
transmission of an HL7 demographic A08 update message to the COTS
"^DD",2,2,.302,1,992,"%D",6,0)
interface.
"^DD",2,2,.302,1,992,"%D",7,0)
 
"^DD",2,2,.302,1,992,"%D",8,0)
The local variable DGRUGA08 will be set to 1 if the cross reference is
"^DD",2,2,.302,1,992,"%D",9,0)
not to be executed as part of a re-indexing.
"^DD",2,2,.302,1,992,"DT")
2990921
"^DD",2,2,.302,3)
For this service connected applicant enter the percentage of service connection between 0 and 100%.
"^DD",2,2,.302,5,1,0)
2^.301^1
"^DD",2,2,.302,20,0)
^.3LA^1^1
"^DD",2,2,.302,20,1,0)
ECD
"^DD",2,2,.302,21,0)
^^5^5^2861007^^
"^DD",2,2,.302,21,1,0)
If this applicant is service connected (SERVICE CONNECTED prompt must
"^DD",2,2,.302,21,2,0)
be answered YES) enter the service connected percentage [a number
"^DD",2,2,.302,21,3,0)
between 0-100].  Once eligibility has been verified only users who hold
"^DD",2,2,.302,21,4,0)
the designated security key may enter/edit this field.  Field may not be
"^DD",2,2,.302,21,5,0)
deleted as long as service connection is indicated.
"^DD",2,2,.302,"AUDIT")
y
"^DD",2,2,.302,"DEL",1,0)
S DFN=DA D EV^DGLOCK Q:'$D(X)  I $D(^DPT(DFN,.3)),$P(^(.3),U,1)="Y" W !?4,*7,"Service Connected Applicant...CAN'T DELETE!!" K X
"^DD",2,2,.302,"DT")
3030609
**END**
**END**
