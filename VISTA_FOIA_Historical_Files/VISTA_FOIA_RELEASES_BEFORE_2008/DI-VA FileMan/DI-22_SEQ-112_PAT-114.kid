Released DI*22*114 SEQ #112
Extracted from mail message
**KIDS**:DI*22.0*114^

**INSTALL NAME**
DI*22.0*114
"BLD",468,0)
DI*22.0*114^VA FILEMAN^0^3030203^y
"BLD",468,1,0)
^^2^2^3021203^
"BLD",468,1,1,0)
See patch DI*22*114 in the National Patch Module on FORUM for complete
"BLD",468,1,2,0)
information on this patch.
"BLD",468,4,0)
^9.64PA^^
"BLD",468,"KRN",0)
^9.67PA^8989.52^17
"BLD",468,"KRN",.4,0)
.4
"BLD",468,"KRN",.401,0)
.401
"BLD",468,"KRN",.402,0)
.402
"BLD",468,"KRN",.403,0)
.403
"BLD",468,"KRN",.5,0)
.5
"BLD",468,"KRN",.84,0)
.84
"BLD",468,"KRN",3.6,0)
3.6
"BLD",468,"KRN",3.8,0)
3.8
"BLD",468,"KRN",9.2,0)
9.2
"BLD",468,"KRN",9.8,0)
9.8
"BLD",468,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",468,"KRN",9.8,"NM",1,0)
DICOMPV^^0^B14788727
"BLD",468,"KRN",9.8,"NM",2,0)
DICOMPX^^0^B5953691
"BLD",468,"KRN",9.8,"NM",3,0)
DICOMPY^^0^B6198892
"BLD",468,"KRN",9.8,"NM",4,0)
DICOMPZ^^0^B28081242
"BLD",468,"KRN",9.8,"NM",5,0)
DICOMP^^0^B23485207
"BLD",468,"KRN",9.8,"NM",6,0)
DICOMP0^^0^B14964350
"BLD",468,"KRN",9.8,"NM","B","DICOMP",5)

"BLD",468,"KRN",9.8,"NM","B","DICOMP0",6)

"BLD",468,"KRN",9.8,"NM","B","DICOMPV",1)

"BLD",468,"KRN",9.8,"NM","B","DICOMPX",2)

"BLD",468,"KRN",9.8,"NM","B","DICOMPY",3)

"BLD",468,"KRN",9.8,"NM","B","DICOMPZ",4)

"BLD",468,"KRN",19,0)
19
"BLD",468,"KRN",19.1,0)
19.1
"BLD",468,"KRN",101,0)
101
"BLD",468,"KRN",409.61,0)
409.61
"BLD",468,"KRN",8989.51,0)
8989.51
"BLD",468,"KRN",8989.52,0)
8989.52
"BLD",468,"KRN",8994,0)
8994
"BLD",468,"KRN","B",.4,.4)

"BLD",468,"KRN","B",.401,.401)

"BLD",468,"KRN","B",.402,.402)

"BLD",468,"KRN","B",.403,.403)

"BLD",468,"KRN","B",.5,.5)

"BLD",468,"KRN","B",.84,.84)

"BLD",468,"KRN","B",3.6,3.6)

"BLD",468,"KRN","B",3.8,3.8)

"BLD",468,"KRN","B",9.2,9.2)

"BLD",468,"KRN","B",9.8,9.8)

"BLD",468,"KRN","B",19,19)

"BLD",468,"KRN","B",19.1,19.1)

"BLD",468,"KRN","B",101,101)

"BLD",468,"KRN","B",409.61,409.61)

"BLD",468,"KRN","B",8989.51,8989.51)

"BLD",468,"KRN","B",8989.52,8989.52)

"BLD",468,"KRN","B",8994,8994)

"BLD",468,"QUES",0)
^9.62^^
"BLD",468,"REQB",0)
^9.611^1^1
"BLD",468,"REQB",1,0)
DI*22.0*76^2
"BLD",468,"REQB","B","DI*22.0*76",1)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
VA FILEMAN^DI^FM INIT
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
22.0^2990330^3030110^41
"PKG",5,22,1,"PAH",1,0)
114^3030203
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3030203
"PKG",5,22,1,"PAH",1,1,1,0)
See patch DI*22*114 in the National Patch Module on FORUM for complete
"PKG",5,22,1,"PAH",1,1,2,0)
information on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","DICOMP")
0^5^B23485207
"RTN","DICOMP",1,0)
DICOMP ;SFISC/GFT-EVALUATE COMPUTED FLD EXPR ;08:40 AM  3 Feb 2003
"RTN","DICOMP",2,0)
 ;;22.0;VA FileMan;**6,76,114**
"RTN","DICOMP",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICOMP",4,0)
 S DICOMP=$G(DICOMP) N DLV,K S K=0 F DLV=0:1 G A:'$D(J(DLV+1))
"RTN","DICOMP",5,0)
EN1 ;
"RTN","DICOMP",6,0)
 S K=0 F  S DLV=K,K=$O(I(K)) G A:K="",A:$D(J(K))[0!($D(I(K\100*100))[0)
"RTN","DICOMP",7,0)
EN ;
"RTN","DICOMP",8,0)
 S DLV=+DICOMP
"RTN","DICOMP",9,0)
A N DICO,DPUNC,DLV0,DIM,DIMW,DG,DBOOL,DICV,V,T,DICN,DICF,DIC,DATE,DPS,M,W,DICOMPQI,D,%,%Y,DS,DZ,%DT ;Don't NEW the variable A!
"RTN","DICOMP",10,0)
 I DICOMP'["?",'$D(DIQUIET) N DIQUIET S DIQUIET=1
"RTN","DICOMP",11,0)
K K K S K=0 I DLV F I=0:100 Q:I>DLV  S K=K+1,K(K)="",K(K,1)=I
"RTN","DICOMP",12,0)
 I '$D(DQI) N DQI S DQI="Y(",DICOMPQI=1
"RTN","DICOMP",13,0)
 S I=DLV F  S I=$O(J(I)),DICO(1)=DLV Q:I=""  K:DLV I(I),J(I)
"RTN","DICOMP",14,0)
 S DPUNC=",'+-():[]!&\/*_=<>",DLV0=DLV\100*100,I=X,DIMW="" K X
"RTN","DICOMP",15,0)
 S DIC(0)="ZFO",(M,DPS)=0,DICO=I,DICO(1)=DLV,DICO(0)=DLV\100*100 F %=0:100 Q:'$D(J(%))  S DG(%)=%
"RTN","DICOMP",16,0)
TOOEASY G 0:" "[I!(+I=I)!(I'?.ANP)!(I?."?")!($E(I,$L(I))=":")
"RTN","DICOMP",17,0)
G D I I X?.NP G:X="" N:I]"",^DICOMP1 I +X=X,X<1700!'$D(DATE(K-1))!'$G(DBOOL) G N:W'=":",N:$D(DPS($$NEST,"$S"))
"RTN","DICOMP",18,0)
 G E:$L(X)>30,FUNC:W="(",N:X?1"$"1U
"RTN","DICOMP",19,0)
V I $D(DICOMPX(X))#2 D DATE^DICOMP0:$D(DICOMPX(X,"DATE")) S T=X,X=DICOMPX(X) G N:'$D(DICOMPX(T,U)) S T=DICOMPX(T,U),DICN=$P(T,U,2),T=+T,Y(0)=^DD(T,DICN,0),D=$P(Y(0),U,2) D S^DICOMP0 G N
"RTN","DICOMP",20,0)
E K Y D ^DICOMP0 G N:+X=X,N:$D(Y),0:$D(DICO("BACK"))-10 S X=DICO,DLV=DICO(1),DICO("BACK")=1 S:$G(DICOMPX)]"" DICOMPX="" G K
"RTN","DICOMP",21,0)
N ;
"RTN","DICOMP",22,0)
 I X]"" S K=K+1,K(K)=X
"RTN","DICOMP",23,0)
 S I=$E(I,M,999),M=0 G G:$F(DPUNC,W)<2
"RTN","DICOMP",24,0)
 I W=":",'$D(DPS($$NEST,"$S")) S I=$E(I,2,999) D I,M^DICOMPX,M^DICOMPW:$D(X) S W="" G N:$D(X),0
"RTN","DICOMP",25,0)
 S X=W,W="",M=2 G N:X=""
"RTN","DICOMP",26,0)
 G DPS:X=")",C:",:"[X,0:"+-'"[X&'$L($E(I,M,999)) I X="(" D ST G N
"RTN","DICOMP",27,0)
 S DBOOL="><]['=!&"[X,Y="[]!&/\_><*="
"RTN","DICOMP",28,0)
NOT I X="'" S %=$E(I,2) I "_"""[% G 0
"RTN","DICOMP",29,0)
 G N:Y'[X
"RTN","DICOMP",30,0)
BINOP I $E(I,M,999)_W]"",$G(K(K))]"",'$D(K(K,2)),'$F($TR(DPUNC,")'"),K(K)),$F(Y,W)<2 D:X="_"  G N:K(K)'="'" S K(K)="'"_X,X="" G N:DBOOL
"RTN","DICOMP",31,0)
CONCAT .I $D(DATE(K)) K DATE(K) S X=" S Y=X X ^DD(""DD"") S X=Y_"
"RTN","DICOMP",32,0)
0 G 0^DICOMP1
"RTN","DICOMP",33,0)
 ;
"RTN","DICOMP",34,0)
I I $A(I,M+1)=34 S M=$F(I,"""",M+2)-1 G I:M>0 S W=0,M=999,X=U Q
"RTN","DICOMP",35,0)
MR F M=M+1:1 S W=$E(I,M) Q:DPUNC[W
"RTN","DICOMP",36,0)
 S X=$E(I,1,M-1) Q
"RTN","DICOMP",37,0)
 ;
"RTN","DICOMP",38,0)
C I $D(DPS($$NEST,"SETDATA")) D  G Q^DICOMP1:'$D(X)
"RTN","DICOMP",39,0)
 .N DIFILE,DIAC S DIAC="WR",DIFILE=J(DLV0) D ^DIAC
"RTN","DICOMP",40,0)
 .I $P($G(^DD(J(DLV0),0,"DI")),U,2)["Y"!(J(DLV0)=200&($P($G(^DIC(200,0)),U)="NEW PERSON"))!'DIAC W:DICOMP["?" "   "_$$EZBLD^DIALOG(405,J(DLV0)) K X Q
"RTN","DICOMP",41,0)
 .S %Y=+$P(DICOMPX,U,2),%=$P($G(^DD(+DICOMPX,%Y,0)),U,2),DIAC=$G(^(9)) I %["C"!%!(%="")!(DIAC]""&(DUZ(0)'="@")&($TR(DIAC,DUZ(0))=DIAC)) N XD S XD("FILE")=J(DLV0),XD("FIELD")=%Y W:DICOMP["?" "  "_$$EZBLD^DIALOG(710,.XD) K X Q
"RTN","DICOMP",42,0)
 .S DICF="" F %=DLV0:1:DLV S DICF="_D"_(%#100)_"_"","""_DICF
"RTN","DICOMP",43,0)
 .S DPS($$NEST)=" N DIFDA S DIFDA("_J(DLV0)_","_$E(DICF,2,999)_","_%Y_")=X D FILE^DIE("""",""DIFDA"") S X="""""
"RTN","DICOMP",44,0)
 S DICF=X D DG S K(K+1,2)=0
"RTN","DICOMP",45,0)
 I $O(DPS($$NEST,"$"))["$" S DPS($$NEST)=DPS($$NEST)_Y_DICF G N
"RTN","DICOMP",46,0)
 G 0:'$D(W($$NEST)) S (W,W($$NEST))=W($$NEST)-1 K:W<2 W($$NEST) S DPS($$NEST)=" S X"_W_"="_Y_DPS($$NEST) G N
"RTN","DICOMP",47,0)
 ;
"RTN","DICOMP",48,0)
DPS I $D(DPS(DPS,"ST")) D DPS^DICOMPW S:X]"" K=K+1,K(K)=X G DPS
"RTN","DICOMP",49,0)
 I DPS D DPS^DICOMPW G N:'$D(W(DPS+1))
"RTN","DICOMP",50,0)
 G 0
"RTN","DICOMP",51,0)
 ;
"RTN","DICOMP",52,0)
FUNC S Y=$O(^DD("FUNC","B",X,0)) S:Y="" Y=-1 I '$D(^DD("FUNC",Y,0)),X'?1N.N2A,X'?1"$"1U G V
"RTN","DICOMP",53,0)
 I Y=90!(Y=91)!(Y=92) D PRIOR^DICOMPZ G N:$D(Y),0
"RTN","DICOMP",54,0)
 S DICF=X,DBOOL=$G(DBOOL,0) D ST I $D(^DD("FUNC",Y,1)) D 1 G B
"RTN","DICOMP",55,0)
 I DICF'?1"$"1U.U D ^DICOMPY S W="" G DPS:DPS,0
"RTN","DICOMP",56,0)
 S DPS(DPS,DICF)=DPS(DPS),DPS(DPS)=" S X="_DICF_W
"RTN","DICOMP",57,0)
B S M=M+1,W="" G 0:$E(I,M)=")",N
"RTN","DICOMP",58,0)
 ;
"RTN","DICOMP",59,0)
2 ;
"RTN","DICOMP",60,0)
 D ST
"RTN","DICOMP",61,0)
1 S DPS(DPS,DICF)="",DPS(DPS)=" "_^(1)_DPS(DPS)_" S X=X" I $D(^(2)) S %=$P(^(2),U) I %]"" S DPS(DPS,%)=""
"RTN","DICOMP",62,0)
 I DPS=1,$G(^(10))]"" S DPS(^(10))=""
"RTN","DICOMP",63,0)
 S %=$G(^(3),0) D:%'?.N
"RTN","DICOMP",64,0)
 .S %=1 F %Y=M+1:1 S Y=$E(I,%Y) Q:")"[Y  S:Y="," %=%+1
"RTN","DICOMP",65,0)
 .S DPS(DPS)=" K X"_%_DPS(DPS)
"RTN","DICOMP",66,0)
 S:%>1 W(DPS)=% Q
"RTN","DICOMP",67,0)
 ;
"RTN","DICOMP",68,0)
ST ;
"RTN","DICOMP",69,0)
 N Y
"RTN","DICOMP",70,0)
 S DPS=DPS+1,%="",Y=K I $D(DBOOL) S DPS(DPS,"BOOL")=DBOOL K DBOOL
"RTN","DICOMP",71,0)
S I 'Y S X="",DPS(DPS)=$P(" S X="_%_"X",U,%]"") Q
"RTN","DICOMP",72,0)
 I K(Y)="" S Y=Y-1 G S
"RTN","DICOMP",73,0)
 I "'"[K(Y)!(K(Y)="+"),$S(Y=1:1,1:K(Y-1)?1P!(K(Y-1)="")) S %=K(Y)_%,K=K-1,Y=Y-1 G S
"RTN","DICOMP",74,0)
 D DG S DPS(DPS)="" I K(K)?1P!(K(K)?2P) S DPS(DPS)=" S Y="_%_"X,X="_Y_",X=X",DPS(DPS,U)=K(K)_"Y",K=K-1
"RTN","DICOMP",75,0)
 S:$D(DATE(K)) DPS(DPS,"DATE")=1
"RTN","DICOMP",76,0)
 S K(K+1,2)=0 Q
"RTN","DICOMP",77,0)
 ;
"RTN","DICOMP",78,0)
NEST() N I
"RTN","DICOMP",79,0)
 F I=DPS:-1 Q:'$D(DPS(I,"ST"))
"RTN","DICOMP",80,0)
 Q I
"RTN","DICOMP",81,0)
 ;
"RTN","DICOMP",82,0)
DG S Y=$$DGI,X=" S "_Y_"=$G(X)"
"RTN","DICOMP",83,0)
 Q
"RTN","DICOMP",84,0)
DGI() S DG(DLV0)=$G(DG(DLV0))+1 Q DQI_DG(DLV0)_")"
"RTN","DICOMP",85,0)
 ;
"RTN","DICOMP",86,0)
EXPR(FILE,DICOMP,I,SUBS) ;I=input expression; DICOMP=flags
"RTN","DICOMP",87,0)
 S X=$G(DUZ),DICOMP=$G(DICOMP)
"RTN","DICOMP",88,0)
 N DUZ,J,DICOMPX,DICOMPW,DQI,DA,DICMX S DUZ=X,DUZ(0)="@" ;pretend he's programmer
"RTN","DICOMP",89,0)
 K X S X=I
"RTN","DICOMP",90,0)
 I DICOMP["m" S DICMX="X DICMX" ;Flag 'm' = allow returning multiple values
"RTN","DICOMP",91,0)
 S DICOMPW="",DA="X("
"RTN","DICOMP",92,0)
 S DICOMPX="",DICOMP=$TR(DICOMP,"F")_"X" ;Why strip out "F"?  We don't allow MUMPS
"RTN","DICOMP",93,0)
 M DICOMPX=SUBS ;list of terms to substitute
"RTN","DICOMP",94,0)
 D IJ^DIUTL(FILE) S FILE=$O(I(""),-1) I FILE S DICOMP=FILE_DICOMP ;FILE may be down a level or 2
"RTN","DICOMP",95,0)
 K SUBS,FILE
"RTN","DICOMP",96,0)
 D DICOMP
"RTN","DICOMP",97,0)
 I '$D(X) Q
"RTN","DICOMP",98,0)
 S X("USED")=$G(DICOMPX)
"RTN","DICOMP",99,0)
 Q
"RTN","DICOMP0")
0^6^B14964350
"RTN","DICOMP0",1,0)
DICOMP0 ;SFISC/GFT-EVALUATE COMPUTED FLD EXPR ;06:55 PM  16 Jan 2003
"RTN","DICOMP0",2,0)
 ;;22.0;VA FileMan;**6,76,114**
"RTN","DICOMP0",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICOMP0",4,0)
 N DICOMPI
"RTN","DICOMP0",5,0)
SETFUNC I DPS,$D(DPS(DPS,"SET")),'$D(W(DPS)) S T="""",D=$P(X,T)_$P(X,T,2) G BAD:$L(D)+2\5-1!(D'?.UN)!(D?1"D".E)!(DUZ(0)'="@") S X=T_D_T,DICOMPX(D)=D,Y=0 Q
"RTN","DICOMP0",6,0)
LIT I X?1"""".E1"""" S Y=0,%=$E(X,2,$L(X)-1) K:%[""" X "!(%[""" D @") Y Q
"RTN","DICOMP0",7,0)
L S T=DLV,DICN=X G M:'$D(J(T))
"RTN","DICOMP0",8,0)
TRY S DIC="^DD("_J(T)_",",DG=$O(^DD(J(T),0,"NM",0))_" "
"RTN","DICOMP0",9,0)
 S DIC("S")=$S(W="["!($E(I,M,M+1)="'[")!$D(DICMX):"I ",1:"S %=$P(^(0),U,2) I '%,%'[""m"",")_"$$SCREEN^DICOMP0"
"RTN","DICOMP0",10,0)
 D DICS^DICOMPY:DUZ(0)'="@"
"RTN","DICOMP0",11,0)
R I X?1"#"1.NP S X=$E(X,2,99) D ^DIC G:Y>0 A:DLV,X S X="#"_X
"RTN","DICOMP0",12,0)
 D ^DIC G A:Y>0
"RTN","DICOMP0",13,0)
N I $P(X,DG)="",X=DICN S X=$P(X,DG,2,9) G R
"RTN","DICOMP0",14,0)
 I X="NUMBER" S Y=.001,Y(0)=0 G D
"RTN","DICOMP0",15,0)
 S T=T-1,X=DICN G M:T<0,TRY:$D(J(T)) F T=T-99:1 G TRY:'$D(J(T+1))
"RTN","DICOMP0",16,0)
 ;
"RTN","DICOMP0",17,0)
A F D=M:1:$L(I)+1 Q:$F(X,$E(I,1,D))-1-D  S W=$E(I,D+1)
"RTN","DICOMP0",18,0)
 I DICOMP["?",DICN'="#.01",$P(Y,U,2)'=DICN,DG_$P(Y,U,2)'=DICN D  G BAD:%<0,N:%-1
"RTN","DICOMP0",19,0)
 .W !?3,"By '"_DICN_"', do you mean "_DG_"'"_$P(Y,U,2)_"'" S %=1 D YN^DICN
"RTN","DICOMP0",20,0)
 E  S DICO("BACK",T)=+Y
"RTN","DICOMP0",21,0)
 S M=D
"RTN","DICOMP0",22,0)
X I $D(DICOMPX)#2 S %Y=J(T)_U_+Y_$E(";",1,$L(DICOMPX)) S:";"_DICOMPX_";"'[(";"_%Y) DICOMPX=%Y_DICOMPX
"RTN","DICOMP0",23,0)
D S D=$P(Y(0),"^",2),%=T\100*100,DICN=+Y,DICOMPI=W=")"&$D(DPS($$NEST^DICOMP,"INTERNAL")) D DATE:D["D"&'DICOMPI
"RTN","DICOMP0",24,0)
 I D["m"!D D MUL^DICOMPZ(D) Q
"RTN","DICOMP0",25,0)
 I $D(DICOMPX(1,J(T),+Y)) S X=DICOMPX(1,J(T),+Y) G O
"RTN","DICOMP0",26,0)
 I D["C" S:'$D(DG(%,T,+Y)) DG(%)=DG(%)+1,DG(%,T,+Y)=DG(%) S X=DQI_DG(%,T,+Y)_")" Q:D'["p"!DICOMPI  S DICN=+$P(D,"p",2),%Y=$G(^DIC(DICN,0,"GL")) Q:%Y=""  G POINT
"RTN","DICOMP0",27,0)
GET I DICOMP["G",T#100=0 S X="$$GET^DDSVAL("_J(T)_",D0,"_+Y_",,"""_$E("E",'DICOMPI)_""")" G O
"RTN","DICOMP0",28,0)
 D G^DICOMPY
"RTN","DICOMP0",29,0)
O Q:DICOMPI
"RTN","DICOMP0",30,0)
 S T=J(T)
"RTN","DICOMP0",31,0)
S ;
"RTN","DICOMP0",32,0)
 S %=DLV0,DG=W=":"&'$D(DPS(DPS,"$S"))
"RTN","DICOMP0",33,0)
 I D["O"&(D'["P"!'DG)!(D["V"&'$D(DPS(DPS,"FILE"))) S X="$$EXTERNAL^DIDU("_T_","_DICN_","""","_X_")" Q
"RTN","DICOMP0",34,0)
SET I D["S" S DG(%)=DG(%)+1,DG(%,DG(%))="$C(59)_$P($G(^DD("_T_","_DICN_",0)),U,3)",X="$P($P("_DQI_DG(%)_"),$C(59)_"_X_"_"":"",2),$C(59))"
"RTN","DICOMP0",35,0)
 Q:D'["P"  S %Y=U_$P(Y(0),U,3),DICN=+$P(@(%Y_"0)"),U,2)
"RTN","DICOMP0",36,0)
POINT I W=":" G MR:'$$OKFILE^DICOMPX(DICN,DICOMP)
"RTN","DICOMP0",37,0)
 I W'=":" S D=$P($G(^DD(DICN,.01,0)),U,2) I D'["V",D'["S",D'["P" D DATE:D["D" S X="$P($G("_%Y_"+"_X_",0)),U)" Q
"RTN","DICOMP0",38,0)
P G P^DICOMPX
"RTN","DICOMP0",39,0)
 ;
"RTN","DICOMP0",40,0)
M S T=$F(X," IN ") I T S X=$E(X,1,T-5),W=":",M=T-4,I=X_W_$E(I,T,999),T=$F(I," FILE",M) S:T&$F(DPUNC,$E(I,T)) I=$E(I,1,T-6)_$E(I,T,999) G DICOMP0
"RTN","DICOMP0",41,0)
 G MR:$L(X)>30 S DICF=X,T=$O(^DD("FUNC","B",X,0))
"RTN","DICOMP0",42,0)
 G LITDATE:'$D(^DD("FUNC",+T,3)),LITDATE:^(3)
"RTN","DICOMP0",43,0)
 I $D(^(1)) D 2^DICOMP S Y(0)=0,K=K+1,K(K)=X D DATE:$G(^(2))?1"D".E,DPS^DICOMPW Q
"RTN","DICOMP0",44,0)
 G MR:X'?1"PRIOR"4.U S Y=X,X="$P($$LAST^DIAUTL("_J(DLV0)_",D0,""*""),U)" I Y["USER",$D(^VA(200)) S $E(X,$L(X))=",2)",DICN=200,%Y="^VA(200," G POINT
"RTN","DICOMP0",45,0)
 G DATE
"RTN","DICOMP0",46,0)
 ;
"RTN","DICOMP0",47,0)
LITDATE S %DT="T" I $L(X)>2 D ^%DT I Y>0 S X=Y,Y(0)=0 D DATE Q  ;may be a literal date
"RTN","DICOMP0",48,0)
BACKPNT S T=$O(^DIC("B",X)) I T]"",$P(T,X)=""!$D(^(X)),$D(J(0)) S T=DLV0 D ^DICOMPV I D>0 Q  ;try backwards-pointer  TOOK OFF CHECK FOR DICOMPW VARIABLE 3/28/2000
"RTN","DICOMP0",49,0)
MR I M'>$L(I),+X'=X D MR^DICOMP G L:X]""
"RTN","DICOMP0",50,0)
BAD K Y Q
"RTN","DICOMP0",51,0)
 ;
"RTN","DICOMP0",52,0)
DATE ;
"RTN","DICOMP0",53,0)
 S DATE(K+1)=1 Q
"RTN","DICOMP0",54,0)
 ;
"RTN","DICOMP0",55,0)
SCREEN() ;Screen out certain fields as we process an atom
"RTN","DICOMP0",56,0)
 I $D(DICO("BACK"))=11,$G(DICO("BACK",T))=Y Q 0
"RTN","DICOMP0",57,0)
 I Y=DA,DICO(1)=T Q 0 ;Computed field cannot refer to itself!
"RTN","DICOMP0",58,0)
 I $P(^(0),U,2) Q '$G(DBOOL) ;A multiple cannot be manipulated as a Boolean!
"RTN","DICOMP0",59,0)
 I $P(^(0),U,2)'["P" Q 1
"RTN","DICOMP0",60,0)
 N P S P=$P(^(0),U,3) I P]"",$D(@(U_P_"0)")) Q 1 ;Only allow a pointer that points to an existing file!
"RTN","DICOMP0",61,0)
 Q 0
"RTN","DICOMPV")
0^1^B14788727
"RTN","DICOMPV",1,0)
DICOMPV ;SFISC/GFT  BACKWARD-POINTERS IN COMPUTED FIELDS ;01:55 PM  18 Nov 2002
"RTN","DICOMPV",2,0)
 ;;22.0;VA FileMan;**1,6,76,114**;Mar 30, 1999
"RTN","DICOMPV",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICOMPV",4,0)
 N DIX,DICOTRY,DICOLEV
"RTN","DICOMPV",5,0)
 D DRW^DICOMPX
"RTN","DICOMPV",6,0)
TRY F DICOTRY=1,2 S Y=$$BACK I Y[U D:$G(D)-.001 Y^DICOMPX G END
"RTN","DICOMPV",7,0)
 S D=0 ;'D' is a flag to the calling routine, DICOMP0
"RTN","DICOMPV",8,0)
END Q
"RTN","DICOMPV",9,0)
 ;
"RTN","DICOMPV",10,0)
BACK() N DICOB,DICODD
"RTN","DICOMPV",11,0)
 S DICOB=DLV0,DICODD=0
"RTN","DICOMPV",12,0)
DD S DICODD=$O(^DD(J(DICOB),0,"PT",DICODD)) I DICODD'>0 S DICOB=DICOB-100,DICODD=0 G DD:DICOB'<0 Q ""
"RTN","DICOMPV",13,0)
ARCH S Y=DICODD I DICOMP["W",$P($G(^DD(Y,0,"DI")),U,2)["Y" G DD ;No editing RESTRICTED or ARCHIVE file!
"RTN","DICOMPV",14,0)
 F DICOLEV=0:-1 G DD:'$D(^DD(Y,0)) Q:'$D(^(0,"UP"))  S Y=^("UP")
"RTN","DICOMPV",15,0)
 I $D(^DIC(Y,0)),$P(^(0),X)="" X DIC("S") I $T,$D(^DIC(Y,0,"GL")) S V=^("GL"),D=0 F  S D=$O(^DD(J(DICOB),0,"PT",DICODD,D)) Q:'D  D  G Y:Y[U
"RTN","DICOMPV",16,0)
DINUM .I DICODD=Y,D=.01&(DICOTRY=1)&($P($G(^DD(Y,.01,0)),U,5,99)["DINUM=X")!(D=.001&(DICOTRY=2)) D YN("") I %=1 S %Y=V,X="D0" S:$D(DIFG) DIFG=1 D X(Y,D),P^DICOMPX S D=.001,Y=Y_U Q
"RTN","DICOMPV",17,0)
 .Q:'$D(DICMX)
"RTN","DICOMPV",18,0)
 .F DIX=0:0 S DIX=$O(^DD(DICODD,D,1,DIX)) Q:DIX'>0  S J=$G(^(DIX,0)) I +J=Y S %=$P(J,U,3,9) I $S(DICOTRY=1:%="",1:%]""&("MUMPS"[%)) D YN("Cross-reference") G Q:%<1 I %=1 D MP G Q
"RTN","DICOMPV",19,0)
 .Q:DICOTRY=1
"RTN","DICOMPV",20,0)
INDEXES .F DIX=0:0 S DIX=$O(^DD("IX","F",DICODD,D,DIX)) Q:'DIX  I $P($G(^DD("IX",DIX,0)),U,4)="R",$P(^(0),U,9)=DICODD S J=$P(^(0),U,1,3) I +J=Y,$P($G(^(11.1,1,0)),U,2,4)=("F^"_DICODD_U_D) D YN("Index") G Q:%<1 I %=1 D MP G Q
"RTN","DICOMPV",21,0)
Q .Q
"RTN","DICOMPV",22,0)
 G DD
"RTN","DICOMPV",23,0)
 ;
"RTN","DICOMPV",24,0)
Y Q Y
"RTN","DICOMPV",25,0)
 ;
"RTN","DICOMPV",26,0)
 ;
"RTN","DICOMPV",27,0)
MP S DICN=$S(DA:DQI_(80+DICOB),1:"I("_DICOB_",0")_")",J=""""_$P(J,U,2)_"""",T=D S:$D(DIFG) DIFG=$P(J,"""",2)
"RTN","DICOMPV",28,0)
 I DICOMP'["W" D  G POP:$D(Y) S (Y,D)=0 Q
"RTN","DICOMPV",29,0)
 .N DICOMPIX S DICOMPIX=J
"RTN","DICOMPV",30,0)
 .S D=Y,I(DLV0+100)=V,J(DLV+100)=D
"RTN","DICOMPV",31,0)
RCR .D BACKPNT^DICOMPZ Q:'$D(Y)
"RTN","DICOMPV",32,0)
 .S Y=D,X=$P(^DD(D,.01,0),U,2) D X^DICOMPZ
"RTN","DICOMPV",33,0)
 .S D="S (D,D0)=$QS(DIMQ,$QL(DIMQ)" I DICOLEV S D=D_DICOLEV
"RTN","DICOMPV",34,0)
 .D DIMP^DICOMPZ(D_") I D,$D("_V_"D,0)) "_X_" "_DICMX)
"RTN","DICOMPV",35,0)
 .D DIMP^DICOMPZ("N DIMQ,DIMSTRT,DIMSCNT S (DIMQ,DIMSTRT)=$NA("_V_DICOMPIX_","_DICN_")),DIMSCNT=$QL(DIMQ) F  S DIMQ=$Q(@DIMQ) Q:DIMQ=""""  Q:$NA(@DIMQ,DIMSCNT)'=DIMSTRT  "_X_" Q:'$D(D)  S D=D0")
"RTN","DICOMPV",36,0)
 .S X=X_" S X="""""
"RTN","DICOMPV",37,0)
ASK D ASKE^DICOMPW I 'D,T-.01&'DS!(DICODD-Y) S D=0
"RTN","DICOMPV",38,0)
 E  S DZ=0 D ASK^DICOMPW:'D I D<0 K T Q
"RTN","DICOMPV",39,0)
 S %=D,D="N DIADD,DIC S DIC="_Y_$S(%=2:",DIADD=1",1:"")_",DIC(0)="""_$P("EQ",U,DS)_$E("L",D>0)_$E("W",$D(DICO(3)))
"RTN","DICOMPV",40,0)
CROSS I T-.01 S D=D_$P("AM",U,DS)_""",DIC(""S"")=""I $D("_V_""""_J_""","""_"_"_DICN_"_"_""",Y))"" D ^DIC S D0=+Y,DIC("_T_")="_DICN_",DIH="_Y_" D DICL^DICR:$P(Y,U,3)"
"RTN","DICOMPV",41,0)
 E  S D=D_"U"",X="_DICN_" D ^DIC S D0=+Y"
"RTN","DICOMPV",42,0)
DIM D DIMP^DICOMPZ(D) I '% S %=":$O(^(D0))>0",X=" S D0=$O("_V_J_","_DICN_",0))"_$S(DS:X_%,1:" S"_%_" D0=0")
"RTN","DICOMPV",43,0)
 S X=X_" S X=$S(D0>0:D0,1:"""")" S:$D(DICOMPX(0)) X=X_","_DICOMPX(0)_"0)=X"
"RTN","DICOMPV",44,0)
POP S Y=Y_U,D=1,DICO("PT")=+Y
"RTN","DICOMPV",45,0)
 D X(+Y,.01) Q
"RTN","DICOMPV",46,0)
 ;
"RTN","DICOMPV",47,0)
X(Y,D) S DICN=Y ;Remember that we have used this field
"RTN","DICOMPV",48,0)
 I $D(DICOMPX)#2 S DICOMPX=Y_U_D_$E(";",1,$L(DICOMPX))_DICOMPX
"RTN","DICOMPV",49,0)
 Q
"RTN","DICOMPV",50,0)
 ;
"RTN","DICOMPV",51,0)
YN(SHOW) N X
"RTN","DICOMPV",52,0)
 S X=$P(^DIC(Y,0),U)
"RTN","DICOMPV",53,0)
 S %=1 I DICOMP["?" D
"RTN","DICOMPV",54,0)
 .W !?3,"By '"_DICN_"', do you mean the "_X_" File,"
"RTN","DICOMPV",55,0)
 .W !?7,"pointing via its '"_$P(^DD(DICODD,D,0),U),"' Field" S DICV=$P(^(0),U,2)
"RTN","DICOMPV",56,0)
 .I SHOW]"" W " (""",$P(J,U,2),""" ",SHOW,")"
"RTN","DICOMPV",57,0)
 .D YN^DICN
"RTN","DICOMPV",58,0)
 I %=1 F M=M:1:$L(I)+1 Q:$F(X,$E(I,1,M))-1-M  S W=$E(I,M+1)
"RTN","DICOMPV",59,0)
 Q
"RTN","DICOMPX")
0^2^B5953691
"RTN","DICOMPX",1,0)
DICOMPX ;SFISC/GFT-EVALUATE COMPUTED FLD EXPR ;10:29 AM  22 Nov 2002
"RTN","DICOMPX",2,0)
 ;;22.0;VA FileMan;**6,76,114**;Mar 30, 1999
"RTN","DICOMPX",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICOMPX",4,0)
M ;
"RTN","DICOMPX",5,0)
 I '$D(J(0)) K X Q
"RTN","DICOMPX",6,0)
 S DIC("S")="I $P(^(0),U,2),$P(^DD(+$P(^(0),U,2),.01,0),U,2)'[""W"""
"RTN","DICOMPX",7,0)
MM S DICN=X,T=DLV S:X?1"#".NP X=$E(X,2,99)
"RTN","DICOMPX",8,0)
TRY S DIC="^DD("_J(T)_",",DG=$O(^DD(J(T),0,"NM",0))_" " D DICS^DICOMPY,^DIC G R:Y<0
"RTN","DICOMPX",9,0)
 F D=M:1:$L(I)+1 Q:$F(X,$E(I,1,D))-1-D  S W=$E(I,D+1)
"RTN","DICOMPX",10,0)
 I DICOMP["?",$P(Y,U,2)'=DICN W !?3,"By '"_DICN_"', do you mean the '"_$P(Y,U,2)_"' Subfield" S %=1 D YN^DICN I %-1 G R:%+1 K X Q
"RTN","DICOMPX",11,0)
 S M=D,Y=+$P(Y(0),U,2),X=$P($P(Y(0),U,4),";") I +X'=X S X=""""_X_""""
"RTN","DICOMPX",12,0)
 S (DLV,D)=DLV0+100 F %=T\100*100:1 Q:%>T  S J(DLV)=J(%),I(DLV)=I(%),DLV=DLV+1
"RTN","DICOMPX",13,0)
 S I(DLV)=X,X=I(D),J(DLV)=Y D QQ,REF S DLV0=DLV0+100 F DLV=D:1:DLV D SN
"RTN","DICOMPX",14,0)
 Q
"RTN","DICOMPX",15,0)
 ;
"RTN","DICOMPX",16,0)
REF F Y=D+1:1:DLV S V=Y#100-1,DICN=I(Y) S:DICN["""" DICN=""""_DICN_"""" S X=X_$S(T<DLV0:"I("_(T\100*100+V)_",0)",1:"D"_V)_","_DICN_","
"RTN","DICOMPX",17,0)
Q Q
"RTN","DICOMPX",18,0)
 ;
"RTN","DICOMPX",19,0)
R I X]"",$P(X,DG,1)="",X=DICN S X=$P(X,DG,2,9) G TRY
"RTN","DICOMPX",20,0)
 S T=T-1 I T'<0 G TRY:$D(J(T)) F T=T-99:1 G TRY:'$D(J(T+1))
"RTN","DICOMPX",21,0)
FILEQ S X=DICN,DIC=1 D DRW,^DIC I Y<0 K X Q
"RTN","DICOMPX",22,0)
 S X=^(0,"GL") D QQ
"RTN","DICOMPX",23,0)
Y ;
"RTN","DICOMPX",24,0)
 S DLV0=DLV0+100,I(DLV0)=^DIC(+Y,0,"GL"),J(DLV0)=+Y F DLV=DLV+100:-1:DLV0 D SN
"RTN","DICOMPX",25,0)
 Q
"RTN","DICOMPX",26,0)
 ;
"RTN","DICOMPX",27,0)
SN D SV(DLV0-100) S DG(DLV0)=DLV Q
"RTN","DICOMPX",28,0)
 ;
"RTN","DICOMPX",29,0)
SV(%X) ;also called from DICOMPY
"RTN","DICOMPX",30,0)
 S (T,DG(%X))=DG(%X)+1,%=DLV#100,K(K+2,1)=DLV0,DG(%X,T)=%,M(%,%X+%)=T Q
"RTN","DICOMPX",31,0)
 ;
"RTN","DICOMPX",32,0)
QQ F %=0:0 S %=$F(X,"""",%) G Q:%<1 S X=$E(X,1,%-1)_$E(X,%-1,999),%=%+1
"RTN","DICOMPX",33,0)
 ;
"RTN","DICOMPX",34,0)
OKFILE(Y,DICOMP) ;Called from DIR
"RTN","DICOMPX",35,0)
 ;DICOMP either does or doesn't contain "W"
"RTN","DICOMPX",36,0)
 N D,DIC,DIAC,DIFILE,%
"RTN","DICOMPX",37,0)
 D DRW I $D(^DIC(Y,0)) X DIC("S")
"RTN","DICOMPX",38,0)
 Q $T
"RTN","DICOMPX",39,0)
 ;
"RTN","DICOMPX",40,0)
DRW ;also called from DICOMPV, and DICOMPW to filter FILE names
"RTN","DICOMPX",41,0)
 S D=$S(DICOMP["W":"""WR""",1:"""RD""")
"RTN","DICOMPX",42,0)
 S DIC("S")="S DIAC="_D_",DIFILE=+Y D ^DIAC I %"
"RTN","DICOMPX",43,0)
 Q
"RTN","DICOMPX",44,0)
 ;
"RTN","DICOMPX",45,0)
P ;
"RTN","DICOMPX",46,0)
 S X=" S D0="_X_" S:'D0!'$D("_%Y_"+D0,0)) D0=-1"
"RTN","DICOMPX",47,0)
 I $D(DICOMPX(0)) S X=X_" S "_DICOMPX(0)_"0)=D0",DICOMPX(0,DICN)=""
"RTN","DICOMPX",48,0)
 D ST
"RTN","DICOMPX",49,0)
 I W=":" D
"RTN","DICOMPX",50,0)
 .S M=M+1,W="",%=$E(I,M,999) I %,+%=$P(%,")") S I=$E(I,1,M-1)_"#"_%
"RTN","DICOMPX",51,0)
 E  S I="#.01"_$E(I,M,999),M=1,W=""
"RTN","DICOMPX",52,0)
 S DLV0=DLV0+100,I(DLV0)=%Y,J(DLV0)=DICN F DLV=DLV+100:-1:DLV0 D SN
"RTN","DICOMPX",53,0)
 Q
"RTN","DICOMPX",54,0)
 ;
"RTN","DICOMPX",55,0)
ST N X D ST^DICOMP S DPS(DPS,"ST")=1,K=K+1,K(K)=X
"RTN","DICOMPX",56,0)
 Q
"RTN","DICOMPY")
0^3^B6198892
"RTN","DICOMPY",1,0)
DICOMPY ;SFISC/GFT-EVALUATE COMPUTED FLD EXPR ;10:22 AM  8 Jan 2003
"RTN","DICOMPY",2,0)
 ;;22.0;VA FileMan;**6,44,76,114**;Mar 30, 1999
"RTN","DICOMPY",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICOMPY",4,0)
 N DICOINS,DICOLEFT
"RTN","DICOMPY",5,0)
 S K(K+1)=X,I=$E(I,M+1,999)
"RTN","DICOMPY",6,0)
 I I'[")" K Y Q
"RTN","DICOMPY",7,0)
ARG D  S DICOLEFT=$E(I,%+1,999),I=$E(I,1,%-1)
"RTN","DICOMPY",8,0)
 .N C,S S S=0
"RTN","DICOMPY",9,0)
 .F %=1:1 S C=$E(I,%) D:C=""""  S:C="(" S=S+1 S:C=")" S=S-1 Q:S<0!(C="")
"RTN","DICOMPY",10,0)
 ..F %=%+1:1 Q:""""[$E(I,%)
"RTN","DICOMPY",11,0)
PREVNEXT I DICF="PREVIOUS"!(DICF="NEXT") N DICMX D  D RCR^DICOMPZ(I) G BAD:'$D(Y) S DICN=X,X=DICF G OK
"RTN","DICOMPY",12,0)
 .D SV^DICOMPX(DLV0)
"RTN","DICOMPY",13,0)
 .S %=DLV#100,DICF=" S D"_%_"=+$O("_$$REF^DICOMPZ(DLV)_")"_$P(",-1",U,DICF="PREVIOUS")_") "
"RTN","DICOMPY",14,0)
 D FUNC
"RTN","DICOMPY",15,0)
 N DICMX S DICMX=DICOINS
"RTN","DICOMPY",16,0)
 D RCR^DICOMPZ(I) I $G(Y)'["m" G BAD
"RTN","DICOMPY",17,0)
OK S K=K+1,K(K)=X,K(K,2)=0,K=K+1,K(K)=DICN I "TOTAL"=DICF!("COUNT"=DICF) K DATE(K-1)
"RTN","DICOMPY",18,0)
RES S I=DICOLEFT,M=0 Q
"RTN","DICOMPY",19,0)
 ;
"RTN","DICOMPY",20,0)
FUNC S DICN=$$DGI^DICOMP,W=DLV#100,K=K+2,K(K)=" S "_DICN_"="""""
"RTN","DICOMPY",21,0)
NUMBER I DICF S %X=$$DGI^DICOMP,K(K)=" S "_%X_"=0"_K(K) D L S DICOINS=DICOINS_" "_%X_"="_%X_"+1 I "_%X_"="_+DICF_",Y'?."" "" S "_DICN_"=Y Q  ",DPS(DPS,"O")="" Q
"RTN","DICOMPY",22,0)
 I $T(@DICF)]"" G @DICF
"RTN","DICOMPY",23,0)
BAD S DPS=0 Q
"RTN","DICOMPY",24,0)
 ;
"RTN","DICOMPY",25,0)
 ;
"RTN","DICOMPY",26,0)
MAXIMUM S %X="'>" G MM
"RTN","DICOMPY",27,0)
MINIMUM S %X="'<"
"RTN","DICOMPY",28,0)
MM D L S DICOINS=DICOINS_"&("_DICN_%X_"Y!'$L("_DICN_")) "_DICN_"=Y" Q
"RTN","DICOMPY",29,0)
TOTAL S DICOINS="S "_DICN_"="_DICN_"+X" Q
"RTN","DICOMPY",30,0)
COUNT S DICOINS="S:X'?."" "" "_DICN_"="_DICN_"+1",DICN="+"_DICN Q
"RTN","DICOMPY",31,0)
LAST D L S DICOINS=DICOINS_" "_DICN_"=Y" Q
"RTN","DICOMPY",32,0)
L S DICOINS="S Y=X S:Y'?."" """
"RTN","DICOMPY",33,0)
 Q
"RTN","DICOMPY",34,0)
 ;
"RTN","DICOMPY",35,0)
 ;
"RTN","DICOMPY",36,0)
W S X=$P(Y(0),U,4),Y=$P(X,";",1),X=$P(X,";",2) Q
"RTN","DICOMPY",37,0)
 ;
"RTN","DICOMPY",38,0)
DICS ;
"RTN","DICOMPY",39,0)
 S:DUZ(0)'="@" D=DICOMP["W"+8,DIC("S")=DIC("S")_" Q:'$L($G("_DIC_"Y,"_D_")))  I $TR(DUZ(0),^("_D_"))'=DUZ(0)" Q
"RTN","DICOMPY",40,0)
G ;
"RTN","DICOMPY",41,0)
 D W I X="" S Y=T#100,X=$S(T<DLV0&$D(M(Y,T))!(DICOMP["T"&(T<DICO(0))):$S(DA:DQI_(T+80)_")",1:"I("_T_",0)"),1:"$S('$D(D"_Y_"):"""",D"_Y_"<0:"""",1:D"_Y_")") Q
"RTN","DICOMPY",42,0)
 I '$D(DG(%,T_U_Y)) S (DG(%),DG(%,T_U_Y))=DG(%)+1
"RTN","DICOMPY",43,0)
 S Y="("_DQI_DG(%,T_U_Y)_"),"
"RTN","DICOMPY",44,0)
EP I X S X="$P"_Y_"U,"_X_")" Q
"RTN","DICOMPY",45,0)
 I X?1"E".E S X="$E"_Y_+$E(X,2,9)_","_$P(X,",",2)_")"
"RTN","DICOMPY",46,0)
 Q
"RTN","DICOMPZ")
0^4^B28081242
"RTN","DICOMPZ",1,0)
DICOMPZ ;SFISC/GFT-EVALUATE COMPUTED FLD EXPR ;05:07 PM  16 Jan 2003
"RTN","DICOMPZ",2,0)
 ;;22.0;VA FileMan;**6,76,114**;Mar 30, 1999
"RTN","DICOMPZ",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICOMPZ",4,0)
 ;
"RTN","DICOMPZ",5,0)
PRIOR ;from DICOMP -- PRIOR.. Functions get archived values
"RTN","DICOMPZ",6,0)
 N DIC,DICOMPSP,DICOMPXE,DICOPS
"RTN","DICOMPZ",7,0)
 S X=$E(X,6,99),DICOMPSP=$E("D",X="DATE"),DICOMPXE="D "_X_"^DIAUTL(",W=$F(I,")",M) S:X="USER"&$D(^VA(200)) DICO("PT")=200,DICOMPSP="p200" I 'W!'$D(DICMX)!'$D(J(0)) K Y Q
"RTN","DICOMPZ",8,0)
 S X=$E(I,M+1,W-2),M=W,W=$E(I,M) S:X?1"#"1.NP X=$E(X,2,999)
"RTN","DICOMPZ",9,0)
 S DIC="^DD("_J(DLV)_",",DIC(0)="",DIC("S")="I '$P(^(0),U,2),$P(^(0),U,2)'[""C""" D DICS^DICOMPY,^DIC K DIC I Y<0 K Y Q  ;Find Field that is the argument of PRIOR function
"RTN","DICOMPZ",10,0)
 S DICOMPXE=DICOMPXE_+J(DLV)_","_+Y_")"
"RTN","DICOMPZ",11,0)
 S DICOPS="><[]=",DIMW="m"
"RTN","DICOMPZ",12,0)
 G INSERT
"RTN","DICOMPZ",13,0)
 ;
"RTN","DICOMPZ",14,0)
BACKPNT ;from DICOMPV -- Backwards Pointer
"RTN","DICOMPZ",15,0)
 N DICOPS,D
"RTN","DICOMPZ",16,0)
 S DICOPS="><[]="
"RTN","DICOMPZ",17,0)
 G COLON
"RTN","DICOMPZ",18,0)
 ;
"RTN","DICOMPZ",19,0)
MUL(DICOMPSP) ;DICOMPSP is the SPECIFIER of the Field we have encountered
"RTN","DICOMPZ",20,0)
 N DICOXR,DICOMPXE,DICOPS S DICOPS="><][="
"RTN","DICOMPZ",21,0)
 I DICOMPSP S X=$P(^DD(+DICOMPSP,.01,0),U,2) G WP:X["W" D  S DLV=DLV+1,I(DLV)=""""_$P($P(Y(0),U,4),";")_"""",J(DLV)=+DICOMPSP D X G FOR
"RTN","DICOMPZ",22,0)
 .I T<DLV S DLV0=DLV0+100,%=DLV0-(T\100*100) F DLV=DLV0:1 S I(DLV)=I(DLV-%),J(DLV)=J(DLV-%),DG(DLV-%,DLV0-%)=DLV#100 I DLV-%=T S K(K+1,1)=DLV0,(T,DG(DLV0))=DLV Q
"RTN","DICOMPZ",23,0)
 S Y=+$P(DICOMPSP,"p",2),DIMW="m"_$E("w",DICOMPSP["w"),DICOMPXE=$P(Y(0),U,5,99)
"RTN","DICOMPZ",24,0)
 I Y S (%,DLV,DLV0)=DLV0+100,I(%)=^DIC(Y,0,"GL"),J(%)=Y D X^DICOMPV(Y,.01)
"RTN","DICOMPZ",25,0)
INSERT N DICOMX S D=DICOMPXE,DICOMX=DICMX D CONTAINS Q:'$D(Y)  I DICOMX=DICMX D
"RTN","DICOMPZ",26,0)
 .I DICOMPSP["D" S DICMX="S Y=X X ^DD(""DD"") S X=Y "_DICMX
"RTN","DICOMPZ",27,0)
 .I DICOMPSP["p" S DICMX="S X=$$CP^DIQ1("""_DICOMPSP_""",X) "_DICMX
"RTN","DICOMPZ",28,0)
 N F,Z,I S Z=""
"RTN","DICOMPZ",29,0)
 S F=$F(DICMX,"X DICMX") I F D
"RTN","DICOMPZ",30,0)
 .S Z="N DICOMPM S DICOMPM=$G(DICMX,""Q"") "
"RTN","DICOMPZ",31,0)
 .S DICMX=$E(DICMX,1,F-6)_"DICOMPM"_$E(DICMX,F,999)
"RTN","DICOMPZ",32,0)
 D DIMP(DICMX) S Z=Z_"N DICMX S DICMX="_$$DA_$$DIMC_")"
"RTN","DICOMPZ",33,0)
 D DIMP(D),DICOXR S Z=Z_X
"RTN","DICOMPZ",34,0)
 D DIMP(Z) S X=X_" S X=X" Q
"RTN","DICOMPZ",35,0)
 ;
"RTN","DICOMPZ",36,0)
WP S DIMW="m"_$E("w",X'["L"),DICOPS="["
"RTN","DICOMPZ",37,0)
M S X="S X=^(0)"
"RTN","DICOMPZ",38,0)
FOR N DICOR,DICOT
"RTN","DICOMPZ",39,0)
 S DICOMPXE=X,DICOT=Y(0) D CONTAINS Q:'$D(Y)
"RTN","DICOMPZ",40,0)
 S Y=T#100+1,D=$P($P(DICOT,U,4),";") I +D'=D S D=""""_D_""""
"RTN","DICOMPZ",41,0)
 S DICOMPXE="D,0))#2 "_DICOMPXE_" "_DICMX_" Q:'$D(D)  S D=D"_Y
"RTN","DICOMPZ",42,0)
 S DICOR=$$REF(T)_","_D_",",D="F D=0:0 S (D,D"_Y_")=$O("_DICOR
"RTN","DICOMPZ",43,0)
 S %=+$P(DICOT,U,2)
"RTN","DICOMPZ",44,0)
 I $P($G(^DD(%,.01,0)),U,2)["W"!'$D(^DD(%,0,"IX","B",%,.01))
"RTN","DICOMPZ",45,0)
 E  I '$D(^DD(%,.01,1,1,0))
"RTN","DICOMPZ",46,0)
 E  I $P(^(0),U,3)]""
"RTN","DICOMPZ",47,0)
 I  S D=D_"D)) Q:D'>0  I $D(^("_DICOMPXE ;We will go thru the muliple by ien
"RTN","DICOMPZ",48,0)
 E  D DIMP(D_"""B"",DICOB,D)) Q:D'>0  I $D("_DICOR_DICOMPXE) S D="N DICOB S DICOB="""" F  S DICOB=$O("_DICOR_"""B"",DICOB)) Q:DICOB=""""  "_X_" Q:'$D(D)" ;We will go thru the multiple using the B X-ref
"RTN","DICOMPZ",49,0)
 D DIMP($$I(Y)_D)
"RTN","DICOMPZ",50,0)
 S (T,DG(DLV0))=DG(DLV0)+1,K(K+1,2)=1,K(K+2,1)=DLV0,DG(DLV0,T)=Y,M(Y,DLV0+Y)=T
"RTN","DICOMPZ",51,0)
 S X=X_":D"_(Y-1)_">0"
"RTN","DICOMPZ",52,0)
DICOXR S X=X_" S X="_$S(DIMW["m"!'$D(DICOXR):"""""",1:DICOXR)
"RTN","DICOMPZ",53,0)
 Q
"RTN","DICOMPZ",54,0)
 ;
"RTN","DICOMPZ",55,0)
CONTAINS N DICON
"RTN","DICOMPZ",56,0)
 S DICON=W="'",%=$E(I,M+DICON) I %="" S Y=0 Q
"RTN","DICOMPZ",57,0)
 I DICOPS[% S DICOPS=% D R($E(I,M+DICON+1,999)) Q:'$D(Y)  D  Q
"RTN","DICOMPZ",58,0)
 .S DICOXR=$$DGI^DICOMP
"RTN","DICOMPZ",59,0)
 .D DIMP("S Y=X "_X_" I Y"_DICOPS_"X S "_DICOXR_"="_'DICON_" K D") S DICMX=X
"RTN","DICOMPZ",60,0)
 .S K(K+1)=" S "_DICOXR_"="_DICON,K=K+1
"RTN","DICOMPZ",61,0)
 .S DBOOL=1,DIMW=""
"RTN","DICOMPZ",62,0)
COLON I W'=":" Q:W=""  S DICOMPX("X")="X",I="X"_$E(I,M,999),M=0 I DICOPS="[" K Y Q
"RTN","DICOMPZ",63,0)
 N DQI D R($E(I,M+1,999)) Q:'$D(Y)  I '$D(DICO("RCR")) S DICO("RCR")=Y
"RTN","DICOMPZ",64,0)
 I Y#100=0 S W=$G(J(+Y)) I W S DICO("PT")=W
"RTN","DICOMPZ",65,0)
 S DICMX=X_" "_$G(DICMX) Q  ;The 'X" code that we got back from RCR becomes what we eXecute for every multiple!
"RTN","DICOMPZ",66,0)
 ;
"RTN","DICOMPZ",67,0)
R(DICORM) N DICOLEFT,DICOX S DICOLEFT="",DICOX=0 F %=1:1 S W=$E(DICORM,%) Q:W=""  S:W="(" DICOX=DICOX+1 I W=")" S DICOX=DICOX-1 I DICOX<0 S DICOLEFT=$E(DICORM,%,999),DICORM=$E(DICORM,1,%-1)
"RTN","DICOMPZ",68,0)
 S DICOX=$G(X) D RCR(DICORM)
"RTN","DICOMPZ",69,0)
 S W="",M=0,I=DICOLEFT S:'$D(Y) I=DICORM,X=DICOX Q
"RTN","DICOMPZ",70,0)
 ;
"RTN","DICOMPZ",71,0)
RCR(W) ;Tricky and important!  What we get from this recursion will be inserted into the larger expression.
"RTN","DICOMPZ",72,0)
 N D
"RTN","DICOMPZ",73,0)
 S:+W=W W=""""_W_"""" S D="ZXM"_$$DIMC_" S"_DICOMP D  ;Don't allow MUMPS. Remember where to start more nodes in X array.  Allow simple numeric.
"RTN","DICOMPZ",74,0)
 .N X,DICOMP,DLV,DICMXSV,K
"RTN","DICOMPZ",75,0)
 .S X=W,DICOMP=D I $D(DICMX) S DICMXSV=DICMX
"RTN","DICOMPZ",76,0)
DQI .I $D(DQI) S %=DQI N DQI S DQI=%_$$DIMC_","
"RTN","DICOMPZ",77,0)
 .D EN1^DICOMP ;Here is the recursion!  I & J, the context, will be preserved by this entry point
"RTN","DICOMPZ",78,0)
 .I '$D(X) K Y Q
"RTN","DICOMPZ",79,0)
 .K W M W=X
"RTN","DICOMPZ",80,0)
 .I Y["m" K DICMXSV
"RTN","DICOMPZ",81,0)
 .I $D(DICMXSV) S DICMX=DICMXSV
"RTN","DICOMPZ",82,0)
 I $D(Y) M X=W D DIMP(X),DATE^DICOMP0:Y["D" ;Remember if it's a DATE
"RTN","DICOMPZ",83,0)
 Q
"RTN","DICOMPZ",84,0)
 ;
"RTN","DICOMPZ",85,0)
DIMP(D) ;
"RTN","DICOMPZ",86,0)
 N DIM
"RTN","DICOMPZ",87,0)
 S DIM=$$DIMC,DIM=DIM+$S(DIM<9.8:.1,1:.01)
"RTN","DICOMPZ",88,0)
 S X(DIM)=D,X=" X "_$$DA_DIM_")" Q
"RTN","DICOMPZ",89,0)
 ;
"RTN","DICOMPZ",90,0)
DA() Q $S(DA:"^DD("_A_","_DA_",",1:DA)
"RTN","DICOMPZ",91,0)
 ;
"RTN","DICOMPZ",92,0)
DIMC() N DIM
"RTN","DICOMPZ",93,0)
 S DIM=$O(X(99),-1) I 'DIM S DIM=+$P(DICOMP,"M",2) I 'DIM S DIM=9.1
"RTN","DICOMPZ",94,0)
 Q DIM
"RTN","DICOMPZ",95,0)
 ;
"RTN","DICOMPZ",96,0)
X ;
"RTN","DICOMPZ",97,0)
 S X="S X=$P(^(0),U)"_$S(X["D"&'$D(DPS($$NEST^DICOMP,"INTERNAL")):",Y=X X ^DD(""DD"") S X=Y",X["P":" S:$D(^"_$P(^(0),U,3)_"+X,0)) X=$P(^(0),U)",X["S":",Y=$F(^DD("_+D_",.01,0),X_$C(58)) S:Y X=$P($E(^(0),Y,999),$C(59),1)",1:""),DIMW="m" Q
"RTN","DICOMPZ",98,0)
 ;
"RTN","DICOMPZ",99,0)
I(LEV) N S
"RTN","DICOMPZ",100,0)
 S S=DLV0+LEV I DICOMP'["I"!'$D(I(S)) Q ""
"RTN","DICOMPZ",101,0)
 Q "S I("_S_")="""_$$CONVQQ^DILIBF(I(S))_""",J("_S_")="_J(S)_" "
"RTN","DICOMPZ",102,0)
 ;
"RTN","DICOMPZ",103,0)
REF(T) ;
"RTN","DICOMPZ",104,0)
 N L,D,X,V
"RTN","DICOMPZ",105,0)
 F L=T\100*100:1:T S D=I(L) S X=$G(X)_D_$E(",",$D(X))_$S(L<DLV0:"I("_L_",0)",1:"D"_(L#100))_","
"RTN","DICOMPZ",106,0)
 Q $E(X,1,$L(X)-1)
"VER")
8.0^22.0
**END**
**END**
