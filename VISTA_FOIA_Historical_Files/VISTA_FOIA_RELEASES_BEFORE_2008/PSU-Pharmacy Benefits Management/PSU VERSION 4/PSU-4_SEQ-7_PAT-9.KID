Released PSU*4*9 SEQ #7
Extracted from mail message
**KIDS**:PSU*4.0*9^

**INSTALL NAME**
PSU*4.0*9
"BLD",6782,0)
PSU*4.0*9^PHARMACY BENEFITS MANAGEMENT^0^3070206^y
"BLD",6782,1,0)
^^1^1^3061115^^^
"BLD",6782,1,1,0)
PBM FIXES: MAPPED LOCATIONS/PHARM IEN/AMIS REPORT HEADER
"BLD",6782,4,0)
^9.64PA^^
"BLD",6782,6.3)
6
"BLD",6782,"ABPKG")
n
"BLD",6782,"KRN",0)
^9.67PA^8989.52^19
"BLD",6782,"KRN",.4,0)
.4
"BLD",6782,"KRN",.401,0)
.401
"BLD",6782,"KRN",.402,0)
.402
"BLD",6782,"KRN",.403,0)
.403
"BLD",6782,"KRN",.5,0)
.5
"BLD",6782,"KRN",.84,0)
.84
"BLD",6782,"KRN",3.6,0)
3.6
"BLD",6782,"KRN",3.8,0)
3.8
"BLD",6782,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",6782,"KRN",9.2,0)
9.2
"BLD",6782,"KRN",9.8,0)
9.8
"BLD",6782,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",6782,"KRN",9.8,"NM",1,0)
PSUMAPR^^0^B39582151
"BLD",6782,"KRN",9.8,"NM",2,0)
PSUOP2^^0^B46269069
"BLD",6782,"KRN",9.8,"NM",3,0)
PSUAMC^^0^B4026281
"BLD",6782,"KRN",9.8,"NM","B","PSUAMC",3)

"BLD",6782,"KRN",9.8,"NM","B","PSUMAPR",1)

"BLD",6782,"KRN",9.8,"NM","B","PSUOP2",2)

"BLD",6782,"KRN",19,0)
19
"BLD",6782,"KRN",19,"NM",0)
^9.68A^^
"BLD",6782,"KRN",19.1,0)
19.1
"BLD",6782,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",6782,"KRN",101,0)
101
"BLD",6782,"KRN",409.61,0)
409.61
"BLD",6782,"KRN",771,0)
771
"BLD",6782,"KRN",870,0)
870
"BLD",6782,"KRN",8989.51,0)
8989.51
"BLD",6782,"KRN",8989.52,0)
8989.52
"BLD",6782,"KRN",8994,0)
8994
"BLD",6782,"KRN","B",.4,.4)

"BLD",6782,"KRN","B",.401,.401)

"BLD",6782,"KRN","B",.402,.402)

"BLD",6782,"KRN","B",.403,.403)

"BLD",6782,"KRN","B",.5,.5)

"BLD",6782,"KRN","B",.84,.84)

"BLD",6782,"KRN","B",3.6,3.6)

"BLD",6782,"KRN","B",3.8,3.8)

"BLD",6782,"KRN","B",9.2,9.2)

"BLD",6782,"KRN","B",9.8,9.8)

"BLD",6782,"KRN","B",19,19)

"BLD",6782,"KRN","B",19.1,19.1)

"BLD",6782,"KRN","B",101,101)

"BLD",6782,"KRN","B",409.61,409.61)

"BLD",6782,"KRN","B",771,771)

"BLD",6782,"KRN","B",870,870)

"BLD",6782,"KRN","B",8989.51,8989.51)

"BLD",6782,"KRN","B",8989.52,8989.52)

"BLD",6782,"KRN","B",8994,8994)

"BLD",6782,"QUES",0)
^9.62^^
"BLD",6782,"REQB",0)
^9.611^2^2
"BLD",6782,"REQB",1,0)
PSU*4.0*7^2
"BLD",6782,"REQB",2,0)
PSU*4.0*8^2
"BLD",6782,"REQB","B","PSU*4.0*7",1)

"BLD",6782,"REQB","B","PSU*4.0*8",2)

"MBREQ")
0
"PKG",423,-1)
1^1
"PKG",423,0)
PHARMACY BENEFITS MANAGEMENT^PSU^PHARMACY BENEFITS MANAGEMENT
"PKG",423,20,0)
^9.402P^^
"PKG",423,22,0)
^9.49I^1^1
"PKG",423,22,1,0)
4.0^3050622^3050722^520645587
"PKG",423,22,1,"PAH",1,0)
9^3070206^520645556
"PKG",423,22,1,"PAH",1,1,0)
^^1^1^3070206
"PKG",423,22,1,"PAH",1,1,1,0)
PBM FIXES: MAPPED LOCATIONS/PHARM IEN/AMIS REPORT HEADER
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSUAMC")
0^3^B4026281^B3549679
"RTN","PSUAMC",1,0)
PSUAMC ;BIR/DAM - Combined AMIS Summary Report:21 APR 2004
"RTN","PSUAMC",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**9**;MARCH, 2005;Build 6
"RTN","PSUAMC",3,0)
 ;
"RTN","PSUAMC",4,0)
 ;This routine creates a combined AMIS summary report when
"RTN","PSUAMC",5,0)
 ;the following extracts are run either by the automatic
"RTN","PSUAMC",6,0)
 ;monthly extract or manual selection
"RTN","PSUAMC",7,0)
 ; 1. IV extract
"RTN","PSUAMC",8,0)
 ; 2. UD extract
"RTN","PSUAMC",9,0)
 ; 3. AR/WS extract
"RTN","PSUAMC",10,0)
 ; 4. Prescription extract
"RTN","PSUAMC",11,0)
 ; 6. CS extract
"RTN","PSUAMC",12,0)
 ;
"RTN","PSUAMC",13,0)
 ;
"RTN","PSUAMC",14,0)
EN ;Entry point.  Called from ^PSUCSR2
"RTN","PSUAMC",15,0)
 ;
"RTN","PSUAMC",16,0)
 K AMIS
"RTN","PSUAMC",17,0)
 ;
"RTN","PSUAMC",18,0)
 S Y=PSUSDT\1 X ^DD("DD") S PSUDTS=Y ;    start date
"RTN","PSUAMC",19,0)
 S Y=PSUEDT\1 X ^DD("DD") S PSUDTE=Y ;    end date
"RTN","PSUAMC",20,0)
 ; * PSU*4*9 - RESET THE PARENT FACILITY
"RTN","PSUAMC",21,0)
 S X=PSUSNDR,DIC=40.8,DIC(0)="X",D="C" D IX^DIC
"RTN","PSUAMC",22,0)
 K DIC,DIC(0),D
"RTN","PSUAMC",23,0)
 S X=+Y S PSUDIVNM=$$VAL^PSUTL(40.8,X,.01)
"RTN","PSUAMC",24,0)
        ;
"RTN","PSUAMC",25,0)
 S AMIS(1,1)="Monthly AMIS Summary for "_PSUDTS_" through "_PSUDTE_" for "_PSUDIVNM
"RTN","PSUAMC",26,0)
 S AMIS(1,2)=""
"RTN","PSUAMC",27,0)
 S AMIS(1,3)=""
"RTN","PSUAMC",28,0)
 ;
"RTN","PSUAMC",29,0)
 M AMIS(2)=^XTMP("PSU_"_PSUJOB,"OPCOMBO")
"RTN","PSUAMC",30,0)
 ;
"RTN","PSUAMC",31,0)
 M AMIS(3)=^XTMP("PSU_"_PSUJOB,"UDCOMBO")
"RTN","PSUAMC",32,0)
 ;
"RTN","PSUAMC",33,0)
 M AMIS(4)=^XTMP("PSU_"_PSUJOB,"ARCOMBO")
"RTN","PSUAMC",34,0)
 ;
"RTN","PSUAMC",35,0)
 M AMIS(5)=^XTMP("PSU_"_PSUJOB,"CSCOMBO")
"RTN","PSUAMC",36,0)
 ;
"RTN","PSUAMC",37,0)
 M AMIS(6)=^XTMP("PSU_"_PSUJOB,"IVCOMBO")
"RTN","PSUAMC",38,0)
 ;
"RTN","PSUAMC",39,0)
 ;Reorganize AMIS array
"RTN","PSUAMC",40,0)
 S C=1
"RTN","PSUAMC",41,0)
 S PSUCT=0
"RTN","PSUAMC",42,0)
 F  S PSUCT=$O(AMIS(PSUCT)) Q:PSUCT=""  D
"RTN","PSUAMC",43,0)
 .S PSULN=0
"RTN","PSUAMC",44,0)
 .F  S PSULN=$O(AMIS(PSUCT,PSULN)) Q:PSULN=""  D
"RTN","PSUAMC",45,0)
 ..S AMIS(C)=AMIS(PSUCT,PSULN)
"RTN","PSUAMC",46,0)
 ..S C=C+1
"RTN","PSUAMC",47,0)
 ;
"RTN","PSUAMC",48,0)
 D MAIL
"RTN","PSUAMC",49,0)
 Q
"RTN","PSUAMC",50,0)
 ;
"RTN","PSUAMC",51,0)
MAIL ;Mail combo message
"RTN","PSUAMC",52,0)
 ;
"RTN","PSUAMC",53,0)
 S PSUST=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)    ;Facility #
"RTN","PSUAMC",54,0)
 S PSUSTNM=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,2)  ;Facility name
"RTN","PSUAMC",55,0)
 ;
"RTN","PSUAMC",56,0)
 S XMSUB="V. 4.0 PBMAMIS "_PSUMON_" "_PSUST_" "_PSUSTNM
"RTN","PSUAMC",57,0)
 S XMTEXT="AMIS("
"RTN","PSUAMC",58,0)
 M ^XTMP("PSU_"_PSUJOB,"COMBOAMIS")=AMIS
"RTN","PSUAMC",59,0)
 S XMCHAN=1
"RTN","PSUAMC",60,0)
 M XMY=PSUXMYS2
"RTN","PSUAMC",61,0)
 D ^XMD
"RTN","PSUAMC",62,0)
 ;
"RTN","PSUAMC",63,0)
 Q
"RTN","PSUMAPR")
0^1^B39582151^B39581577
"RTN","PSUMAPR",1,0)
PSUMAPR ;BHM/PDW-REPORT OF MAP OAU,NAOU,DA LOCATION TO DIVISION/OUTPATIENT SITES ; 9SEP2003
"RTN","PSUMAPR",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**7,9**;MARCH, 2005;Build 6
"RTN","PSUMAPR",3,0)
 ;
"RTN","PSUMAPR",4,0)
 ;DBIA's
"RTN","PSUMAPR",5,0)
 ; Reference to file (#58.1) supported by DBIA 2515
"RTN","PSUMAPR",6,0)
 ; Reference to file (#58.8) supported by DBIA 2519
"RTN","PSUMAPR",7,0)
 ; Reference to file (#59.7)  supported by DBIA 2854
"RTN","PSUMAPR",8,0)
 ;
"RTN","PSUMAPR",9,0)
EN ; select Editing or Report of Mapping
"RTN","PSUMAPR",10,0)
 N C
"RTN","PSUMAPR",11,0)
 K PG,LINE,LINE2
"RTN","PSUMAPR",12,0)
 S PSQUIT=0,HDR="",$P(LINE,"=",79)="",$P(LINE2,"-",15)=""
"RTN","PSUMAPR",13,0)
 D PGH
"RTN","PSUMAPR",14,0)
AOU S HDR="AR/WS AOU" D PGH1
"RTN","PSUMAPR",15,0)
 S C=0
"RTN","PSUMAPR",16,0)
 S PSNM="" F  S PSNM=$O(^PSI(58.1,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",17,0)
 . S PSDA=0 F  S PSDA=$O(^PSI(58.1,"B",PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",18,0)
 .. D BRK Q:PSQUIT
"RTN","PSUMAPR",19,0)
 .. S C=C+1
"RTN","PSUMAPR",20,0)
 .. W !,PSNM
"RTN","PSUMAPR",21,0)
 .. S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79001,IEN,.02),PSOP=$$GET1^DIQ(59.79001,IEN,.03) W:$L(PSDIV) ?30,"Div: ",PSDIV W:$L(PSOP) ?30,"Op:  ",PSOP
"RTN","PSUMAPR",22,0)
 .. S PSINADT=$$GET1^DIQ(58.1,PSDA,3,"I") I PSINADT W ?60,$$FMTE^XLFDT(PSINADT,"D")
"RTN","PSUMAPR",23,0)
 W !
"RTN","PSUMAPR",24,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",25,0)
 ;
"RTN","PSUMAPR",26,0)
NAOU ;CS NAOU  Drug Accountability 'Primary
"RTN","PSUMAPR",27,0)
 Q:PSQUIT
"RTN","PSUMAPR",28,0)
 S HDR="CS NAOU" D PGH1
"RTN","PSUMAPR",29,0)
 S C=0
"RTN","PSUMAPR",30,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",31,0)
 . S PSDA=0 F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:PSDA'>0  D
"RTN","PSUMAPR",32,0)
 .. S PSN0=^PSD(58.8,PSDA,0),PSTYP=$P(PSN0,U,2),PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",33,0)
 .. I PSTYP="P" Q
"RTN","PSUMAPR",34,0)
 .. D BRK Q:PSQUIT
"RTN","PSUMAPR",35,0)
 .. S C=C+1
"RTN","PSUMAPR",36,0)
 .. W !,PSNM
"RTN","PSUMAPR",37,0)
 .. S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79002,IEN,.02),PSOP=$$GET1^DIQ(59.79002,IEN,.03) W:$L(PSDIV) ?30,"Div: ",PSDIV W:$L(PSOP) ?30,"Op:  ",PSOP
"RTN","PSUMAPR",38,0)
 .. S PSINADT=$$GET1^DIQ(58.8,PSDA,4,"I")
"RTN","PSUMAPR",39,0)
 .. I PSINADT W ?60,$$FMTE^XLFDT(PSINADT,"D")
"RTN","PSUMAPR",40,0)
 W !
"RTN","PSUMAPR",41,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",42,0)
 ;
"RTN","PSUMAPR",43,0)
DRACC ;
"RTN","PSUMAPR",44,0)
 Q:PSQUIT
"RTN","PSUMAPR",45,0)
 S HDR="DRUG ACCOUNTABILITY"
"RTN","PSUMAPR",46,0)
 D PGH1
"RTN","PSUMAPR",47,0)
 S C=0
"RTN","PSUMAPR",48,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",49,0)
 . S PSDA=0 F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:'PSDA  D
"RTN","PSUMAPR",50,0)
 .. S PSN0=^PSD(58.8,PSDA,0),PSTYP=$P(PSN0,U,2)
"RTN","PSUMAPR",51,0)
 .. S PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",52,0)
 .. I PSTYP'="P" Q
"RTN","PSUMAPR",53,0)
 .. D BRK Q:PSQUIT
"RTN","PSUMAPR",54,0)
 .. S C=C+1
"RTN","PSUMAPR",55,0)
 .. W !,PSNM
"RTN","PSUMAPR",56,0)
 .. S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79003,IEN,.02),PSOP=$$GET1^DIQ(59.79003,IEN,.03) W:$L(PSDIV) ?30,"Div: ",PSDIV W:$L(PSOP) ?30,"Op:  ",PSOP
"RTN","PSUMAPR",57,0)
 .. S PSINADT=$$GET1^DIQ(58.8,PSDA,4,"I")
"RTN","PSUMAPR",58,0)
 .. I PSINADT W ?60,$$FMTE^XLFDT(PSINADT,"D")
"RTN","PSUMAPR",59,0)
 ;
"RTN","PSUMAPR",60,0)
 I $E(IOST)="C" W !! K DIR S DIR(0)="EA",DIR("A")="Report Finished <cr>" D ^DIR
"RTN","PSUMAPR",61,0)
 Q
"RTN","PSUMAPR",62,0)
EN1 ;Scan for unmapped locations
"RTN","PSUMAPR",63,0)
 ;Called from PSUOP0
"RTN","PSUMAPR",64,0)
 ;
"RTN","PSUMAPR",65,0)
 N PSULOC,PSULOC1,PSULOC2
"RTN","PSUMAPR",66,0)
 S PSQUIT=0
"RTN","PSUMAPR",67,0)
 D AOU1       ;Look for AR/WS AOU's
"RTN","PSUMAPR",68,0)
 D NAOU1      ;Look for CS NAOU's
"RTN","PSUMAPR",69,0)
 D DRACC1     ;Look for Drug Accountability Pharmacy Locations
"RTN","PSUMAPR",70,0)
 D UNMAPD
"RTN","PSUMAPR",71,0)
 D MAPD
"RTN","PSUMAPR",72,0)
 Q
"RTN","PSUMAPR",73,0)
 ; 
"RTN","PSUMAPR",74,0)
AOU1 ;Find AR/WS AOU's and set unmapped locations into AOU array
"RTN","PSUMAPR",75,0)
 ;
"RTN","PSUMAPR",76,0)
 S PSULOC=" AR/WS AOU's "
"RTN","PSUMAPR",77,0)
 ;
"RTN","PSUMAPR",78,0)
 K AOU
"RTN","PSUMAPR",79,0)
 S PSNM="" F  S PSNM=$O(^PSI(58.1,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",80,0)
 .S PSDA=0 F  S PSDA=$O(^PSI(58.1,"B",PSNM,PSDA)) Q:PSDA'>0  D
"RTN","PSUMAPR",81,0)
 ..S IEN=PSDA_",1",PSDIV=$$GET1^DIQ(59.79001,IEN,.02)
"RTN","PSUMAPR",82,0)
 ..S PSOP=$$GET1^DIQ(59.79001,IEN,.03)
"RTN","PSUMAPR",83,0)
 ..I '$L(PSDIV),'$L(PSOP) S AOU(PSNM,PSDA)=$$GET1^DIQ(58.1,PSDA,3)
"RTN","PSUMAPR",84,0)
 Q
"RTN","PSUMAPR",85,0)
 ;
"RTN","PSUMAPR",86,0)
NAOU1 ;Find Controlled Substances AOU's and set unmapped locations
"RTN","PSUMAPR",87,0)
 ;into NAOU array
"RTN","PSUMAPR",88,0)
 ;
"RTN","PSUMAPR",89,0)
 S PSULOC1=" CS NAOUs "
"RTN","PSUMAPR",90,0)
 ;
"RTN","PSUMAPR",91,0)
 K NAOU
"RTN","PSUMAPR",92,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",93,0)
 .S PSDA=0
"RTN","PSUMAPR",94,0)
 .F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:PSDA'>0  D
"RTN","PSUMAPR",95,0)
 ..S PSN0=^PSD(58.8,PSDA,0)
"RTN","PSUMAPR",96,0)
 ..S PSTYP=$P(PSN0,U,2)
"RTN","PSUMAPR",97,0)
 ..S PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",98,0)
 ..I PSTYP="P" Q
"RTN","PSUMAPR",99,0)
 ..S IEN=PSDA_",1"
"RTN","PSUMAPR",100,0)
 ..S PSDIV=$$GET1^DIQ(59.79002,IEN,.02)
"RTN","PSUMAPR",101,0)
 ..S PSOP=$$GET1^DIQ(59.79002,IEN,.03)
"RTN","PSUMAPR",102,0)
 ..I '$L(PSDIV),'$L(PSOP) S NAOU(PSNM,PSDA)=$$GET1^DIQ(58.8,PSDA,4)
"RTN","PSUMAPR",103,0)
 Q
"RTN","PSUMAPR",104,0)
 ;
"RTN","PSUMAPR",105,0)
DRACC1 ;Find DA Pharmacy Locations and set unmapped locations into DRAC array
"RTN","PSUMAPR",106,0)
 ;
"RTN","PSUMAPR",107,0)
 S PSULOC2=" DA Pharmacy Locations "
"RTN","PSUMAPR",108,0)
 ;
"RTN","PSUMAPR",109,0)
 K DRAC
"RTN","PSUMAPR",110,0)
 S PSNM="" F  S PSNM=$O(^PSD(58.8,"B",PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",111,0)
 .S PSDA=0
"RTN","PSUMAPR",112,0)
 .F  S PSDA=$O(^PSD(58.8,"B",PSNM,PSDA)) Q:'PSDA  D
"RTN","PSUMAPR",113,0)
 ..S PSN0=^PSD(58.8,PSDA,0),PSTYP=$P(PSN0,U,2)
"RTN","PSUMAPR",114,0)
 ..S PSINADT=+$G(^PSD(58.8,PSDA,"I"))
"RTN","PSUMAPR",115,0)
 ..I PSTYP'="P" Q
"RTN","PSUMAPR",116,0)
 ..S IEN=PSDA_",1"
"RTN","PSUMAPR",117,0)
 ..S PSDIV=$$GET1^DIQ(59.79003,IEN,.02)
"RTN","PSUMAPR",118,0)
 ..S PSOP=$$GET1^DIQ(59.79003,IEN,.03)
"RTN","PSUMAPR",119,0)
 ..I '$L(PSDIV),'$L(PSOP) S DRAC(PSNM,PSDA)=$$GET1^DIQ(58.8,PSDA,4)
"RTN","PSUMAPR",120,0)
 Q
"RTN","PSUMAPR",121,0)
 ;
"RTN","PSUMAPR",122,0)
MAPD ;Display this if all locations are mapped
"RTN","PSUMAPR",123,0)
 ;
"RTN","PSUMAPR",124,0)
 I '$D(AOU),'$D(NAOU),'$D(DRAC) D  Q
"RTN","PSUMAPR",125,0)
 . W !!,?3,"All pharmacy dispensing/procurement locations are mapped.",!
"RTN","PSUMAPR",126,0)
 Q
"RTN","PSUMAPR",127,0)
 ;
"RTN","PSUMAPR",128,0)
UNMAPD ;Display this if unmapped locations exist
"RTN","PSUMAPR",129,0)
 ;
"RTN","PSUMAPR",130,0)
 N C
"RTN","PSUMAPR",131,0)
 W !
"RTN","PSUMAPR",132,0)
 I $D(AOU) S PSNM="" D            ;Unmapped AR/WS AOU's
"RTN","PSUMAPR",133,0)
 .S C=0
"RTN","PSUMAPR",134,0)
 .W !,?5,"The following"_PSULOC_"are not mapped:"
"RTN","PSUMAPR",135,0)
 .W !
"RTN","PSUMAPR",136,0)
 .F  S PSNM=$O(AOU(PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",137,0)
 ..S PSDA=0
"RTN","PSUMAPR",138,0)
 ..F  S PSDA=$O(AOU(PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",139,0)
 ...W !,?10,PSNM
"RTN","PSUMAPR",140,0)
 ...I AOU(PSNM,PSDA)'=""  W ?40,"**Inactive**"
"RTN","PSUMAPR",141,0)
 ...D BRK Q:PSQUIT
"RTN","PSUMAPR",142,0)
 ...I C=(IOSL-5) S C=0
"RTN","PSUMAPR",143,0)
 ...S C=C+1
"RTN","PSUMAPR",144,0)
 W !
"RTN","PSUMAPR",145,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",146,0)
 ;
"RTN","PSUMAPR",147,0)
 I $D(NAOU) S PSNM="" D           ;Unmapped CS NAOUs
"RTN","PSUMAPR",148,0)
 .S C=0
"RTN","PSUMAPR",149,0)
 .W !,?5,"The following"_PSULOC1_"are not mapped:"
"RTN","PSUMAPR",150,0)
 .W !
"RTN","PSUMAPR",151,0)
 .F  S PSNM=$O(NAOU(PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",152,0)
 ..S PSDA=0
"RTN","PSUMAPR",153,0)
 ..F  S PSDA=$O(NAOU(PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",154,0)
 ...W !,?10,PSNM
"RTN","PSUMAPR",155,0)
 ...I NAOU(PSNM,PSDA)'="" W ?40,"**Inactive**"
"RTN","PSUMAPR",156,0)
 ...D BRK Q:PSQUIT
"RTN","PSUMAPR",157,0)
 ...I C=(IOSL-5) S C=0
"RTN","PSUMAPR",158,0)
 ...S C=C+1
"RTN","PSUMAPR",159,0)
 W !
"RTN","PSUMAPR",160,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",161,0)
 ;
"RTN","PSUMAPR",162,0)
 I $D(DRAC) S PSNM="" D          ;Unmapped DA Pharmacy Locations
"RTN","PSUMAPR",163,0)
 .S C=0
"RTN","PSUMAPR",164,0)
 .W !,?5,"The following"_PSULOC2_"are not mapped:"
"RTN","PSUMAPR",165,0)
 .W !
"RTN","PSUMAPR",166,0)
 .F  S PSNM=$O(DRAC(PSNM)) Q:PSNM=""  D  Q:PSQUIT
"RTN","PSUMAPR",167,0)
 ..S PSDA=0
"RTN","PSUMAPR",168,0)
 ..F  S PSDA=$O(DRAC(PSNM,PSDA)) Q:PSDA'>0  D  Q:PSQUIT
"RTN","PSUMAPR",169,0)
 ...W !,?10,PSNM
"RTN","PSUMAPR",170,0)
 ...I DRAC(PSNM,PSDA)'="" W ?40,"**Inactive**"
"RTN","PSUMAPR",171,0)
 ...D BRK Q:PSQUIT
"RTN","PSUMAPR",172,0)
 ...I C=(IOSL-5) S C=0
"RTN","PSUMAPR",173,0)
 ...S C=C+1
"RTN","PSUMAPR",174,0)
 W !
"RTN","PSUMAPR",175,0)
 D PG Q:PSQUIT
"RTN","PSUMAPR",176,0)
 Q
"RTN","PSUMAPR",177,0)
 ;
"RTN","PSUMAPR",178,0)
BRK ;Page break. Occurs in the middle of a list
"RTN","PSUMAPR",179,0)
 ;
"RTN","PSUMAPR",180,0)
 I C=(IOSL-5) D
"RTN","PSUMAPR",181,0)
 .W !
"RTN","PSUMAPR",182,0)
 .K DIR I $E(IOST)="C" S DIR(0)="E" D ^DIR
"RTN","PSUMAPR",183,0)
 .I $D(Y),Y=0 S PSQUIT=1 Q
"RTN","PSUMAPR",184,0)
 .S PG=$G(PG)+1
"RTN","PSUMAPR",185,0)
 .W @IOF
"RTN","PSUMAPR",186,0)
 ;Q:$E(IOST,1,2)'="C-"!($D(IO("S")))
"RTN","PSUMAPR",187,0)
 ;K DIR W !
"RTN","PSUMAPR",188,0)
 ;S DIR(0)="E" D ^DIR K DIR
"RTN","PSUMAPR",189,0)
 ;I 'Y S PSQUIT=1 Q
"RTN","PSUMAPR",190,0)
 Q
"RTN","PSUMAPR",191,0)
 ;
"RTN","PSUMAPR",192,0)
PG ;Page break between headers
"RTN","PSUMAPR",193,0)
 ;
"RTN","PSUMAPR",194,0)
 K DIR I $E(IOST)="C" S DIR(0)="E" D ^DIR I Y=0 S PSQUIT=1 Q
"RTN","PSUMAPR",195,0)
 S PG=$G(PG)+1
"RTN","PSUMAPR",196,0)
 W @IOF
"RTN","PSUMAPR",197,0)
 Q
"RTN","PSUMAPR",198,0)
 ;
"RTN","PSUMAPR",199,0)
PGH W @IOF
"RTN","PSUMAPR",200,0)
 W !,"MAPPED/UNMAPPED LOCATIONS"
"RTN","PSUMAPR",201,0)
 W ?30,$$FMTE^XLFDT(DT)
"RTN","PSUMAPR",202,0)
 S PG=$G(PG)+1 W ?60,"PAGE: ",PG,!,LINE,!,"NAME",?30,"DIVISION/OUTPATIENT SITE",?60,"INACTIVE DATE"
"RTN","PSUMAPR",203,0)
PGH1 I $L(HDR) W !!,$G(HDR),!,LINE2
"RTN","PSUMAPR",204,0)
 Q
"RTN","PSUMAPR",205,0)
PGB I $Y<(IOSL-4) S PSQUIT=1 Q
"RTN","PSUMAPR",206,0)
PGHB W @IOF
"RTN","PSUMAPR",207,0)
 W !,"UNMAPPED LOCATIONS"
"RTN","PSUMAPR",208,0)
 W ?30,$$FMTE^XLFDT(DT)
"RTN","PSUMAPR",209,0)
 S PG=$G(PG)+1 W ?60,"PAGE: ",PG,!,LINE,!,"NAME",?40,"INACTIVE DATE"
"RTN","PSUMAPR",210,0)
PGH1B I $L(HDR) W !!,$G(HDR),!,LINE2
"RTN","PSUMAPR",211,0)
 Q
"RTN","PSUOP2")
0^2^B46269069^B45028652
"RTN","PSUOP2",1,0)
PSUOP2 ;BIR/CFL - PSU PBM Outpatient Pharmacy Data Collection for Version 7.0 ; 7/11/06 4:21pm
"RTN","PSUOP2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**6,8,9**;MARCH, 2005;Build 6
"RTN","PSUOP2",3,0)
 ;
"RTN","PSUOP2",4,0)
 ;DBIAs
"RTN","PSUOP2",5,0)
 ; Reference to ^PSRX( file # 52 supported by DBIAs 465, 2512
"RTN","PSUOP2",6,0)
 ; Reference to EN^PSOORDER      supported by DBIA 1878
"RTN","PSUOP2",7,0)
 ; 
"RTN","PSUOP2",8,0)
 ;
"RTN","PSUOP2",9,0)
EN ;Entry to data collection
"RTN","PSUOP2",10,0)
 D ALLOOP,AMLOOP
"RTN","PSUOP2",11,0)
 K ^TMP("PSOR",$J)
"RTN","PSUOP2",12,0)
 Q
"RTN","PSUOP2",13,0)
ALLOOP ;Loop through the AL cross refererence
"RTN","PSUOP2",14,0)
 N PSUDOC1,PSUCAN,PSUCL,PSUCMP,PSUFP,PSUORDT,PSUCO
"RTN","PSUOP2",15,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",16,0)
 F  S PSUFDT=$O(^PSRX("AL",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",17,0)
 .S PSURXIEN=""
"RTN","PSUOP2",18,0)
 .F  S PSURXIEN=$O(^PSRX("AL",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",19,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",20,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",21,0)
 ..S PSUCAN=$$GET1^DIQ(52,PSURXIEN,26.1,"I")   ;Cancel date
"RTN","PSUOP2",22,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;21;27","PSUOP","I")
"RTN","PSUOP2",23,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",24,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",25,0)
 ..;
"RTN","PSUOP2",26,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",27,0)
 ..D PID^VADPT
"RTN","PSUOP2",28,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",29,0)
 ..N PSUPSO S PSUPSO=1   ;flag to avoid a PSO error when SIG is too long
"RTN","PSUOP2",30,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",31,0)
 ..Q:'$D(^TMP("PSOR",$J))
"RTN","PSUOP2",32,0)
 ..D EN^PSUOPAM      ;Gather AMIS data
"RTN","PSUOP2",33,0)
 ..D CMOPA ; set array of CMOP recs
"RTN","PSUOP2",34,0)
 ..D NEW ; check ^TMP to see if New Rx is in time frame, if so create record.
"RTN","PSUOP2",35,0)
 ..D REF ; check ^TMP to see if refills are in time frame, if so create records
"RTN","PSUOP2",36,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",37,0)
 Q
"RTN","PSUOP2",38,0)
 ;
"RTN","PSUOP2",39,0)
AMLOOP ; loop through "AM", partials, cross reference to see if any were missed
"RTN","PSUOP2",40,0)
 S X1=PSUSDT,X2=-1
"RTN","PSUOP2",41,0)
 D C^%DTC K %,%H,%T
"RTN","PSUOP2",42,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",43,0)
 F  S PSUFDT=$O(^PSRX("AM",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",44,0)
 .S PSURXIEN=""
"RTN","PSUOP2",45,0)
 .F  S PSURXIEN=$O(^PSRX("AM",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",46,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",47,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",48,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;27","PSUOP","I")
"RTN","PSUOP2",49,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",50,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",51,0)
 ..; SCREEN OUT TEST PATIENTS
"RTN","PSUOP2",52,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",53,0)
 ..D PID^VADPT
"RTN","PSUOP2",54,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",55,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",56,0)
 ..D EN^PSUOPAM      ;Gather AMIS data   PSU*4*5 fix
"RTN","PSUOP2",57,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",58,0)
 Q
"RTN","PSUOP2",59,0)
 ;
"RTN","PSUOP2",60,0)
NEW ; New Rx
"RTN","PSUOP2",61,0)
 S PSUFD=$P(^TMP("PSOR",$J,PSURXIEN,0),U,2)
"RTN","PSUOP2",62,0)
 D COMVAR
"RTN","PSUOP2",63,0)
 S PSUTYP="N"
"RTN","PSUOP2",64,0)
 S PSUCMOP=$S($D(PSUCMA(0)):"Y",1:"N")
"RTN","PSUOP2",65,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",66,0)
 S PSUORDT=$P(PSUR0,U,17)     ;AMIS Original Login Date
"RTN","PSUOP2",67,0)
 S PSUQTY=+$P(PSUR0,U,6)
"RTN","PSUOP2",68,0)
 ;
"RTN","PSUOP2",69,0)
 ;
"RTN","PSUOP2",70,0)
 S PSUDS=$P(PSUR0,U,7)
"RTN","PSUOP2",71,0)
 S PSUDRCT=$P(PSUR0,U,10)
"RTN","PSUOP2",72,0)
 S PSURELDT=$P($P(PSUR0,U,13),".",1)
"RTN","PSUOP2",73,0)
 Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",74,0)
 S PSUWPC=$E($P(PSUR0,U,15))
"RTN","PSUOP2",75,0)
NEWX1 ;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",76,0)
NEWX2 ;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",77,0)
 S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",78,0)
 ; MOVE NEXT 2 LINES TO COMMON VARIABLE AREA
"RTN","PSUOP2",79,0)
 ;S PSUCLN=$P($P(PSUR1,U,4),";",2)          ;AMIS data clinic
"RTN","PSUOP2",80,0)
 ;S PSUFP=$P($P(PSUR1,U,9),";",1)           ;AMIS finishing person
"RTN","PSUOP2",81,0)
 S PSUPRID=$P($P(PSUR1,U,1),";",1)
"RTN","PSUOP2",82,0)
 S PSURXP=$P($P(PSUR1,U,5),";",1)
"RTN","PSUOP2",83,0)
 S PSUMW=$P($P(PSUR1,U,6),";",1)
"RTN","PSUOP2",84,0)
 S PSUDIVP=$P(PSUR1,U,7)
"RTN","PSUOP2",85,0)
 ;
"RTN","PSUOP2",86,0)
 S PSUNDC=""
"RTN","PSUOP2",87,0)
 I PSUCMOP="Y" S PSUNDC=PSUCMA(0)
"RTN","PSUOP2",88,0)
 I PSUNDC="" S PSUNDC=$S($L(PSUOP(27)):PSUOP(27),$L(PSUDRUG(31)):PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",89,0)
 D PROVDR^PSUOP3
"RTN","PSUOP2",90,0)
 D SETREC^PSUOP3
"RTN","PSUOP2",91,0)
NEWQ Q
"RTN","PSUOP2",92,0)
 ;
"RTN","PSUOP2",93,0)
REF ; Refills
"RTN","PSUOP2",94,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"REF"))
"RTN","PSUOP2",95,0)
 D COMVAR
"RTN","PSUOP2",96,0)
 S PSUFLN=""
"RTN","PSUOP2",97,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",98,0)
 .S PSUTYP="R"
"RTN","PSUOP2",99,0)
 .S PSUCMOP=$S($D(PSUCMA(PSUFLN)):"Y",1:"N")
"RTN","PSUOP2",100,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN,0)
"RTN","PSUOP2",101,0)
 .N PSUCLN,PSUR1
"RTN","PSUOP2",102,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",103,0)
 .S PSUCLN=$P($P(PSUR1,U,4),";",2)
"RTN","PSUOP2",104,0)
 .S PSUWPC="N"
"RTN","PSUOP2",105,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",106,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",107,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",108,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",109,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",110,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",111,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",112,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",113,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",114,0)
 .S PSUREDT=$P(PSUR0,U,12)     ;AMIS Refill Login Date
"RTN","PSUOP2",115,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",116,0)
 .;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",117,0)
 .;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",118,0)
 .S PSUNDC=""
"RTN","PSUOP2",119,0)
 .I PSUCMOP="Y" S PSUNDC=PSUCMA(PSUFLN)
"RTN","PSUOP2",120,0)
 .I PSUNDC="" S PSUNDC=$$VALI^PSUTL(52.1,PSURXIEN,11)
"RTN","PSUOP2",121,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",122,0)
 .;
"RTN","PSUOP2",123,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",124,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",125,0)
REFQ Q
"RTN","PSUOP2",126,0)
 ;
"RTN","PSUOP2",127,0)
PAR ; Partials
"RTN","PSUOP2",128,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"RPAR"))
"RTN","PSUOP2",129,0)
 D COMVAR
"RTN","PSUOP2",130,0)
 S PSUFLN=""
"RTN","PSUOP2",131,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",132,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN,0)
"RTN","PSUOP2",133,0)
 .N PSUCLN,PSUR1
"RTN","PSUOP2",134,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",135,0)
 .S PSUCLN=$P($P(PSUR1,U,4),";",2)
"RTN","PSUOP2",136,0)
 .S PSUTYP="P"
"RTN","PSUOP2",137,0)
 .S PSUCMOP="N"
"RTN","PSUOP2",138,0)
 .S PSUWPC="N"
"RTN","PSUOP2",139,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",140,0)
 .;I (PSUFD<PSUSDT)!(PSUFD\1>PSUEDT) Q
"RTN","PSUOP2",141,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",142,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",143,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",144,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",145,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",146,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",147,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",148,0)
 .S PSUPDT=$P(PSUR0,U,12)       ;AMIS Partial Login Date
"RTN","PSUOP2",149,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",150,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",151,0)
 .S PSUNDC=$$VALI^PSUTL(52.2,PSURXIEN,1)
"RTN","PSUOP2",152,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",153,0)
 .;
"RTN","PSUOP2",154,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",155,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",156,0)
PARQ Q
"RTN","PSUOP2",157,0)
 ;
"RTN","PSUOP2",158,0)
COMVAR ; set variables that are common between all record types
"RTN","PSUOP2",159,0)
 S PSUDR=$P($P(^TMP("PSOR",$J,PSURXIEN,"DRUG",0),U,1),";",1)
"RTN","PSUOP2",160,0)
 ;S CMOPID=$P($G(^PSDRUG(PSUDR,"ND")),U,10)     ;AMIS CMOP ID
"RTN","PSUOP2",161,0)
 S PSUSIG=$P($G(^TMP("PSOR",$J,PSURXIEN,"SIG",1,0)),U,1)
"RTN","PSUOP2",162,0)
 S PSURXP=$P($P(^TMP("PSOR",$J,PSURXIEN,1),U,5),";",1)
"RTN","PSUOP2",163,0)
 S PSURXN=$P(^TMP("PSOR",$J,PSURXIEN,0),U,5)
"RTN","PSUOP2",164,0)
 ; PSU*4*9 - INSERT NEXT 2 LINES
"RTN","PSUOP2",165,0)
 S PSUCLN=$P($P(^TMP("PSOR",$J,PSURXIEN,1),U,4),";",2)   ;AMIS CLINIC
"RTN","PSUOP2",166,0)
 S PSUFP=$P($P(^TMP("PSOR",$J,PSURXIEN,1),U,9),";",1)  ;FINISHING PERSON
"RTN","PSUOP2",167,0)
 D GETDRUG^PSUOP3 ; loads data from file #50 using PSUDR as ien
"RTN","PSUOP2",168,0)
COMVARQ Q
"RTN","PSUOP2",169,0)
 ;
"RTN","PSUOP2",170,0)
CMOPA ; set array of CMOP recs
"RTN","PSUOP2",171,0)
 K PSUCMA
"RTN","PSUOP2",172,0)
 N PSUR1,PSUX,PSUST,PSUFIL,PSUNDC
"RTN","PSUOP2",173,0)
 S PSUX=""
"RTN","PSUOP2",174,0)
 F  S PSUX=$O(^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX)) Q:PSUX=""  D
"RTN","PSUOP2",175,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX,0)
"RTN","PSUOP2",176,0)
 .F X="PSUFIL^3","PSUST^4","PSUNDC^6" D PIECE(X,PSUR1,U)
"RTN","PSUOP2",177,0)
 .S:+PSUST=1 PSUCMA(PSUFIL)=PSUNDC
"RTN","PSUOP2",178,0)
 .K:+PSUST=3 PSUCMA(PSUFIL)
"RTN","PSUOP2",179,0)
 .D:$D(PSUCMA(PSUFIL)) RTSTOCK
"RTN","PSUOP2",180,0)
CMOPAQ Q
"RTN","PSUOP2",181,0)
 ;
"RTN","PSUOP2",182,0)
RTSTOCK ; test for "AR" if none then unmark CMOP
"RTN","PSUOP2",183,0)
 ; needs PSURXIEN, PSUFIL, from CMOPA
"RTN","PSUOP2",184,0)
 N PSURELDT,PSUR0,PSURTSDT
"RTN","PSUOP2",185,0)
 I PSUFIL D  Q
"RTN","PSUOP2",186,0)
 . S PSUR0=$G(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFIL,0))
"RTN","PSUOP2",187,0)
 . F X="PSURELDT^8","PSURTSDT^9" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",188,0)
 . I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",189,0)
 . K PSUCMA(PSUFIL)
"RTN","PSUOP2",190,0)
 ;
"RTN","PSUOP2",191,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",192,0)
 F X="PSURELDT^13","PSURTSDT^14" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",193,0)
 I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",194,0)
 I $D(PSUCMA(PSUFIL)) K PSUCMA(PSUFIL)
"RTN","PSUOP2",195,0)
 Q
"RTN","PSUOP2",196,0)
PIECE(%,REC,DLM) ;Piece % from record REC using delimiter DLM
"RTN","PSUOP2",197,0)
 ; %="VARNAME^PIECE",REC=SOURCE,DLM=DELIMITER in REC
"RTN","PSUOP2",198,0)
 N Y,I S Y=$P(%,U,1),I=$P(%,U,2) S @Y=$P(REC,DLM,I)
"RTN","PSUOP2",199,0)
 Q
"RTN","PSUOP2",200,0)
 ;
"VER")
8.0^22.0
"BLD",6782,6)
^7
**END**
**END**
