Released DI*22*95 SEQ #109
Extracted from mail message
**KIDS**:DI*22.0*95^

**INSTALL NAME**
DI*22.0*95
"BLD",384,0)
DI*22.0*95^VA FILEMAN^0^3021101^y
"BLD",384,1,0)
^^2^2^3011217^
"BLD",384,1,1,0)
See patch DI*22*95 in the National Patch Module on FORUM for complete
"BLD",384,1,2,0)
information on this patch.
"BLD",384,4,0)
^9.64PA^^
"BLD",384,"INIT")
DIPS95
"BLD",384,"KRN",0)
^9.67PA^8989.52^17
"BLD",384,"KRN",.4,0)
.4
"BLD",384,"KRN",.401,0)
.401
"BLD",384,"KRN",.402,0)
.402
"BLD",384,"KRN",.403,0)
.403
"BLD",384,"KRN",.5,0)
.5
"BLD",384,"KRN",.84,0)
.84
"BLD",384,"KRN",3.6,0)
3.6
"BLD",384,"KRN",3.8,0)
3.8
"BLD",384,"KRN",9.2,0)
9.2
"BLD",384,"KRN",9.8,0)
9.8
"BLD",384,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",384,"KRN",9.8,"NM",1,0)
DIKC^^0^B61623191
"BLD",384,"KRN",9.8,"NM",2,0)
DIKCDD^^0^B1225005
"BLD",384,"KRN",9.8,"NM",3,0)
DIKCR^^0^B67682296
"BLD",384,"KRN",9.8,"NM",4,0)
DIKD^^0^B11219173
"BLD",384,"KRN",9.8,"NM",5,0)
DIKD2^^0^B5553526
"BLD",384,"KRN",9.8,"NM",6,0)
DDMOD^^0^B1174741
"BLD",384,"KRN",9.8,"NM",7,0)
DIKCBLD^^0^B39733013
"BLD",384,"KRN",9.8,"NM",8,0)
DIE2^^0^B21631586
"BLD",384,"KRN",9.8,"NM",9,0)
DIEZ2^^0^B47298614
"BLD",384,"KRN",9.8,"NM",10,0)
DIE^^0^B20904318
"BLD",384,"KRN",9.8,"NM","B","DDMOD",6)

"BLD",384,"KRN",9.8,"NM","B","DIE",10)

"BLD",384,"KRN",9.8,"NM","B","DIE2",8)

"BLD",384,"KRN",9.8,"NM","B","DIEZ2",9)

"BLD",384,"KRN",9.8,"NM","B","DIKC",1)

"BLD",384,"KRN",9.8,"NM","B","DIKCBLD",7)

"BLD",384,"KRN",9.8,"NM","B","DIKCDD",2)

"BLD",384,"KRN",9.8,"NM","B","DIKCR",3)

"BLD",384,"KRN",9.8,"NM","B","DIKD",4)

"BLD",384,"KRN",9.8,"NM","B","DIKD2",5)

"BLD",384,"KRN",19,0)
19
"BLD",384,"KRN",19.1,0)
19.1
"BLD",384,"KRN",101,0)
101
"BLD",384,"KRN",409.61,0)
409.61
"BLD",384,"KRN",8989.51,0)
8989.51
"BLD",384,"KRN",8989.52,0)
8989.52
"BLD",384,"KRN",8994,0)
8994
"BLD",384,"KRN","B",.4,.4)

"BLD",384,"KRN","B",.401,.401)

"BLD",384,"KRN","B",.402,.402)

"BLD",384,"KRN","B",.403,.403)

"BLD",384,"KRN","B",.5,.5)

"BLD",384,"KRN","B",.84,.84)

"BLD",384,"KRN","B",3.6,3.6)

"BLD",384,"KRN","B",3.8,3.8)

"BLD",384,"KRN","B",9.2,9.2)

"BLD",384,"KRN","B",9.8,9.8)

"BLD",384,"KRN","B",19,19)

"BLD",384,"KRN","B",19.1,19.1)

"BLD",384,"KRN","B",101,101)

"BLD",384,"KRN","B",409.61,409.61)

"BLD",384,"KRN","B",8989.51,8989.51)

"BLD",384,"KRN","B",8989.52,8989.52)

"BLD",384,"KRN","B",8994,8994)

"BLD",384,"PRE")
DIENVWRN
"BLD",384,"QUES",0)
^9.62^^
"BLD",384,"REQB",0)
^9.611^9^9
"BLD",384,"REQB",1,0)
DI*22.0*1^2
"BLD",384,"REQB",2,0)
DI*22.0*11^2
"BLD",384,"REQB",3,0)
DI*22.0*12^2
"BLD",384,"REQB",4,0)
DI*22.0*22^2
"BLD",384,"REQB",5,0)
DI*22.0*53^2
"BLD",384,"REQB",6,0)
DI*22.0*68^2
"BLD",384,"REQB",7,0)
DI*22.0*4^2
"BLD",384,"REQB",8,0)
DI*22.0*8^2
"BLD",384,"REQB",9,0)
DI*22.0*59^2
"BLD",384,"REQB","B","DI*22.0*1",1)

"BLD",384,"REQB","B","DI*22.0*11",2)

"BLD",384,"REQB","B","DI*22.0*12",3)

"BLD",384,"REQB","B","DI*22.0*22",4)

"BLD",384,"REQB","B","DI*22.0*4",7)

"BLD",384,"REQB","B","DI*22.0*53",5)

"BLD",384,"REQB","B","DI*22.0*59",9)

"BLD",384,"REQB","B","DI*22.0*68",6)

"BLD",384,"REQB","B","DI*22.0*8",8)

"INIT")
DIPS95
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
VA FILEMAN^DI^FM INIT
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
22.0^2990330^3020307^12
"PKG",5,22,1,"PAH",1,0)
95^3021101
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3021101
"PKG",5,22,1,"PAH",1,1,1,0)
See patch DI*22*95 in the National Patch Module on FORUM for complete
"PKG",5,22,1,"PAH",1,1,2,0)
information on this patch.
"PRE")
DIENVWRN
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","DDMOD")
0^6^B1174741
"RTN","DDMOD",1,0)
DDMOD ;SFISC/MKO-DD MODIFICATION APIS ;1:45 PM  11 Dec 2001
"RTN","DDMOD",2,0)
 ;;22.0;VA FileMan;**12,53,95**;Mar 30, 1999
"RTN","DDMOD",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DDMOD",4,0)
 ;
"RTN","DDMOD",5,0)
DELIX(DIFIL,DIFLD,DIXR,DIFLG,DIKDOUT,DIKDMSG) ;Delete traditional xref
"RTN","DDMOD",6,0)
 G DELIXX^DIKD
"RTN","DDMOD",7,0)
 ;
"RTN","DDMOD",8,0)
DELIXN(DIFIL,DIXR,DIFLG,DIKDOUT,DIKDMSG) ;Delete new-style index
"RTN","DDMOD",9,0)
 G DELIXNX^DIKD2
"RTN","DDMOD",10,0)
 ;
"RTN","DDMOD",11,0)
CREIXN(DIKCXREF,DIFLG,DIXR,DIKCOUT,DIKCMSG) ;Create new-style index
"RTN","DDMOD",12,0)
 G CREIXNX^DIKCR
"RTN","DDMOD",13,0)
 ;
"RTN","DDMOD",14,0)
FILESEC(DIFIL,DISEC,DIMSGA) ;Set File Security Codes
"RTN","DDMOD",15,0)
 ; DIFIL = File Number
"RTN","DDMOD",16,0)
 ; .DISEC = Is the array for each security node
"RTN","DDMOD",17,0)
 ; DIMSGA = If passed where the error message is placed
"RTN","DDMOD",18,0)
 I (('$D(^DIC(+$G(DIFIL),0))#2)!(+$G(DIFIL)<2)) D  Q
"RTN","DDMOD",19,0)
 . D CLEAN^DILF
"RTN","DDMOD",20,0)
 . I $G(DIMSGA)'="" D BLD^DIALOG(401,+$G(DIFIL),,DIMSGA,"F") Q
"RTN","DDMOD",21,0)
 . D BLD^DIALOG(401,+$G(DIFIL))
"RTN","DDMOD",22,0)
 I '$D(DISEC) Q
"RTN","DDMOD",23,0)
 N I
"RTN","DDMOD",24,0)
 ; DIC(DIFIL,0,"DD") 'Data Dictionary' Security
"RTN","DDMOD",25,0)
 ; DIC(DIFIL,0,"RD") 'Read' Security
"RTN","DDMOD",26,0)
 ; DIC(DIFIL,0,"WR") 'Write' Security
"RTN","DDMOD",27,0)
 ; DIC(DIFIL,0,"DEL") 'Delete' Security
"RTN","DDMOD",28,0)
 ; DIC(DIFIL,0,"LAYGO") 'Laygo' Security
"RTN","DDMOD",29,0)
 ; DIC(DIFIL,0,"AUDIT") 'Audit Security
"RTN","DDMOD",30,0)
 F I="DD","RD","WR","DEL","LAYGO","AUDIT" I $D(DISEC(I))#2 S ^DIC(DIFIL,0,I)=DISEC(I)
"RTN","DDMOD",31,0)
 Q
"RTN","DIE")
0^10^B20904318
"RTN","DIE",1,0)
DIE ;SFISC/GFT,XAK-PROC.DR-STR ;2:40 PM  17 Sep 2002
"RTN","DIE",2,0)
 ;;22.0;VA FileMan;**1,4,8,11,59,95**;Mar 30, 1999
"RTN","DIE",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIE",4,0)
 N DG,DNM,DICRREC K DB I DIE S DIE=^DIC(DIE,0,"GL")
"RTN","DIE",5,0)
 Q:$D(@(DIE_DA_",-9)"))  Q:'$D(@(DIE_"0)"))  S U="^",DP=+$P(^(0),U,2) Q:$P($G(^DD($$FNO^DILIBF(DP),0,"DI")),U,2)["Y"&'$D(DIOVRD)&'$G(DIFROM)
"RTN","DIE",6,0)
GO Q:DIE?1"^DIA(".E  K DE,DOV,DIOV,DIEC,DTOUT N DIEDA D
"RTN","DIE",7,0)
 . N %
"RTN","DIE",8,0)
 . F %=1:1 Q:'$G(DA(%))  S DIEDA(%)=DA(%)
"RTN","DIE",9,0)
 . S DIEDA=DA
"RTN","DIE",10,0)
 . Q
"RTN","DIE",11,0)
 I $D(DIETMP)[0 N DIETMP S DIETMP=$$GETTMP^DIKC1("DIE")
"RTN","DIE",12,0)
 N DIEFXREF,DIIENS K DIEFIRE,DIEBADK S DIIENS=$$IENS^DIKCU(DP,.DA)
"RTN","DIE",13,0)
 S DL=1,D0=DA,DI=DP,DR(1,DP)=DR D INI I $E(DR)'="[" D DR^DIE17
"RTN","DIE",14,0)
 S DP=DI,DA=D0,(DQ,DIEL,DK,DP(0))=0 K DIC("S")
"RTN","DIE",15,0)
MR S DK=DK+1,DH=$P(DR,";",DK) I +DH=DH S (DI,DM)=DH G S:$D(^DD(DP,DI)),MR
"RTN","DIE",16,0)
 S DI=$P(DH,":",1) I 'DI G K:DI=0,PB
"RTN","DIE",17,0)
J I DH["//" S DE(DQ+1,0)=$P(DH,"//",2,9),DI=$P(DI,"//",1),DH=""
"RTN","DIE",18,0)
 G K:+DI=DI S DM=+DI,Y=$P(DI,DM,2,99),DI=DM G MR:Y=""!'$D(^DD(DP,DI,0)) S DQ=DQ+1,(DZ,DQ(DQ))=^(0),DIFLD(DQ)=DI
"RTN","DIE",19,0)
 F %=1:1 S DIG=$P(Y,$C(126),%) Q:DIG=""  S DZ=$S(DIG="d"!(DIG="R"):$P(DZ,U,1,2)_DIG_U_$P(DZ,U,3,99),DIG="T":$S($D(^(.1)):^(.1),1:$P(DZ,U))_U_$P(DZ,U,2,99),1:DIG_U_$P(DZ,U,2,99))
"RTN","DIE",20,0)
 S:DH'[$C(126) DH=DH_$C(126) S DQ(DQ)=DZ K DZ,DIG G Y
"RTN","DIE",21,0)
K S DM=$P(DH,":",2),DM=$S(DM:DM,1:DI) I DI,$D(^DD(DP,DI)) G S
"RTN","DIE",22,0)
NX S DI=$O(^DD(DP,DI)) S:DI="" DI=-1 G MR:DI'>0,MR:DI>DM
"RTN","DIE",23,0)
S I DQ'<50,'$D(DE(DQ+1)) G H
"RTN","DIE",24,0)
 S DQ=DQ+1,DQ(DQ)=^(DI,0),DIFLD(DQ)=DI
"RTN","DIE",25,0)
Y S Y=$P(DQ(DQ),"^",4),DG=$P(Y,";",1)
"RTN","DIE",26,0)
 ;Determine whether field has a xref defined in the Index file
"RTN","DIE",27,0)
 S DIEXREF=0 F  S DIEXREF=$O(^DD("IX","F",DP,DI,DIEXREF)) Q:'DIEXREF  I $P($G(^DD("IX",DIEXREF,0)),U) S DIEXREF=1 Q
"RTN","DIE",28,0)
 I $D(^DD(DP,DI,1))!($P(DQ(DQ),U,2)["a")!DIEXREF S DE=0,DB=DM,DM=0,DE(Y)=DQ K DIEXREF F DW=1:1 S DE=$O(^DD(DP,DI,1,DE)) Q:DE<1  S DE(Y,DW,1)=^(DE,1),DE(Y,DW,2)=^(2)
"RTN","DIE",29,0)
 I  S:DE="" DE=-1
"RTN","DIE",30,0)
 I $P(DQ(DQ),U,2)["a" S DE(Y,DW,2)="S DIIX=2_U_DIFLD(DE(DQ)) D AUDIT^DIET",DE(Y,DW,1)="S DIIX=3_U_DIFLD(DE(DQ)) D AUDIT^DIET",DE(Y)=DQ I ^DD(DP,DI,"AUDIT")="e" S DE(Y,DW,1)="I $D(DE(DE(DQ)))#2 "_DE(Y,DW,1)
"RTN","DIE",31,0)
 S Y=$P(Y,";",2) I DU'=DG S D="",DU=DG,@DC G M:Y=0,B:DU=" ",EQ:DW[0 S D=^(DG)
"RTN","DIE",32,0)
 I Y S:$P(D,"^",Y)]"" DE(DQ)=$P(D,"^",Y)
"RTN","DIE",33,0)
 E  S Y=$E(D,+$E(Y,2,9),$P(Y,",",2)) S:Y'?." " DE(DQ)=Y
"RTN","DIE",34,0)
EQ G MR:DI=DM,NX:DM S DM=DB K DB G D
"RTN","DIE",35,0)
 ;
"RTN","DIE",36,0)
INI K DIC("S") S DIC=DIE,DU=-1,DC="DW=$D("_DIE_DA_",DG))"
"RTN","DIE",37,0)
Q Q
"RTN","DIE",38,0)
MORE ;
"RTN","DIE",39,0)
 D INI G MR:DI=DM,NX:DI'[U S DI=+DI G S:$D(^DD(DP,DI)),MR
"RTN","DIE",40,0)
JMP ;
"RTN","DIE",41,0)
 D INI G J
"RTN","DIE",42,0)
 ;
"RTN","DIE",43,0)
PB I DH="" G D:$D(DR(DL,DP))<9 S:'$D(DOV) DOV=0,DR(DL,DP)=DR S DOV=$O(DR(DL,DP,DOV)) S:DOV="" DOV=-1 G D:DOV'>0 S DR=DR(DL,DP,DOV),DK=0 G MR
"RTN","DIE",44,0)
 G MR:DH?1"@".N I 'DQ G TEM:DH?1"[".E S:"Q"'=DH DQ=1,DQ(0,1)=DH G MR:$A(DH)-94 S DC=$P(DH,U,1,4) X $P(DH,U,5,999) G O^DIE0
"RTN","DIE",45,0)
E S DK=DK-1,(DI,DM)=1
"RTN","DIE",46,0)
D G DQ^DIED
"RTN","DIE",47,0)
H S DI=DI_U G D
"RTN","DIE",48,0)
M S Y=$P(DQ(DQ),U,2)_U_DG G DC:DW<9
"RTN","DIE",49,0)
 I $D(DSC(+Y))#2,$P(DSC(+Y),"I $D(^UTILITY(",1)="" S D=DIEL+1 D D1 X DSC(+Y) S D=$O(^(0)) S:D="" D=-1 S @DC S DC=$O(^(DG,0)) S:DC="" DC=-1 G DE
"RTN","DIE",50,0)
 I $D(^(DG,0)) S D=$P(^(0),U,3,4) S:$P(^(0),U,2)'=$P(Y,U) $P(^(0),U,2)=$P(Y,U)
"RTN","DIE",51,0)
 E  S D=$O(^(0)) S:D="" D=-1
"RTN","DIE",52,0)
DE I D>0 S Y=Y_U_D I DP(0)-Y,$D(^(+D,0)) S DE(DQ)=$P(^(0),U,1)
"RTN","DIE",53,0)
DC S DC=$P(^DD(+Y,0),U,4)_U_Y,%=DQ(DQ),Y=^(.01,0) I $P(Y,U,2)'["W" S DQ(DQ)="Select "_$P(Y,U,1)_U_1_$P(Y,U,2,99) G D
"RTN","DIE",54,0)
 I DQ>1 K DQ(DQ) G E:$D(DE(DQ,0)),H
"RTN","DIE",55,0)
 D
"RTN","DIE",56,0)
 .Q:DH'[$C(126)
"RTN","DIE",57,0)
 .N DIEA S DIEA=$P($P(DH,+DH,2),$C(126)) Q:DIEA=""!(DIEA="d")!(DIEA="R")
"RTN","DIE",58,0)
 .S $P(%,U)=$S(DIEA="T"&$D(^DD(+$P(%,U,2),.01,.1)):^(.1),1:DIEA)
"RTN","DIE",59,0)
 .Q
"RTN","DIE",60,0)
 S Y=$P(%,U,1)_U_$P(Y,U,2) D DIEN^DIWE K DQ,DG,DE S DQ=0 G QY^DIE1:$D(DTOUT) G MORE
"RTN","DIE",61,0)
 ;
"RTN","DIE",62,0)
D1 Q:D'>0  S:'$D(@("D"_D)) @("D"_D)=0 S D=D-1 G D1
"RTN","DIE",63,0)
 ;
"RTN","DIE",64,0)
B K DQ(DQ) S DQ=DQ-1,DU=-9 G EQ
"RTN","DIE",65,0)
 ;
"RTN","DIE",66,0)
TEM K:$D(DIETMP)#2 @DIETMP,DIETMP
"RTN","DIE",67,0)
 S Y=0 F  S Y=$O(^DIE("B",$P($E(DR,2,99),"]",1),Y)) S:Y="" Y=-1 G Q:Y=-1,Q:'$D(^DIE(+Y,0)) Q:$P(^(0),U,4)=DP
"RTN","DIE",68,0)
 S $P(^(0),U,7)=DT I $G(^("ROU"))[U,$$ROUEXIST^DILIBF($P(^("ROU"),U,2)) G @^DIE(+Y,"ROU")
"RTN","DIE",69,0)
 S:$D(^("W")) DIE("W")=^("W") S %X="^DIE(+Y,""DR"",",%Y="DR(" D %XY^%RCR
"RTN","DIE",70,0)
 S DIE("^")=DR,DR=$S($D(^DIE(Y,"DR"))#2:^("DR"),1:DR(1,DP)) D DIE K DR S DR=DIE(U)
"RTN","DIE",71,0)
 Q
"RTN","DIE",72,0)
 ;
"RTN","DIE",73,0)
 ;Silent call concerning editing and filing of data.
"RTN","DIE",74,0)
 ;
"RTN","DIE",75,0)
FILE(DIEFFLAG,DIEFAR,DIEFOUT) ;
"RTN","DIE",76,0)
 G FILEX^DIEF
"RTN","DIE",77,0)
 ;
"RTN","DIE",78,0)
WP(DIEFF,DIEFIEN,DIEFFLD,DIEFWPFL,DIEFTSRC,DIEFOUT) ;
"RTN","DIE",79,0)
 G WPX^DIEFW
"RTN","DIE",80,0)
 ;
"RTN","DIE",81,0)
HELP(DIEHF,DIEHIEN,DIEHFLD,DIEHFLG,DIEHOUT) ;
"RTN","DIE",82,0)
 G GETX^DIEH
"RTN","DIE",83,0)
 ;
"RTN","DIE",84,0)
VAL(DIEVF,DIEVIEN,DIEVFLD,DIEVFLG,DIEVAL,DIEVANS,DIEVFAR,DIOUTAR) ;
"RTN","DIE",85,0)
 G VALX^DIEV
"RTN","DIE",86,0)
 ;
"RTN","DIE",87,0)
KEYVAL(DIVKFLAG,DIVKFDA,DIVKOUT) ;
"RTN","DIE",88,0)
 G KEYVALX^DIEVK
"RTN","DIE",89,0)
 ;
"RTN","DIE",90,0)
VALS(DIVSFLAG,DIVSEFDA,DIVSIFDA,DIVSMSG) ;
"RTN","DIE",91,0)
 G VALSX^DIEVS
"RTN","DIE",92,0)
 ;
"RTN","DIE",93,0)
CHK(DIEVF,DIEVFLD,DIEVFLG,DIEVAL,DIEVANS,DIOUTAR) ;
"RTN","DIE",94,0)
 G CHKX^DIEV
"RTN","DIE",95,0)
 ;
"RTN","DIE",96,0)
UPDATE(DIFLAGS,DIFDA,DIEN,DIMSGA) ;SEA/TOAD
"RTN","DIE",97,0)
 ; ENTRY POINT--update database
"RTN","DIE",98,0)
 ; procedure, all passed by value
"RTN","DIE",99,0)
 G ADDX^DICA
"RTN","DIE",100,0)
 ;
"RTN","DIE2")
0^8^B21631586
"RTN","DIE2",1,0)
DIE2 ;SFISC/GFT,XAK-DELETE AND ENTRY ;12:45 PM  17 Sep 2002
"RTN","DIE2",2,0)
 ;;22.0;VA FileMan;**4,11,95**;Mar 30, 1999
"RTN","DIE2",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIE2",4,0)
 D F,DL Q:$D(DTOUT)  G B^DIED:Y=2,A^DIED:Y,UP^DIE1:DL>1,Q^DIE1
"RTN","DIE2",5,0)
 ;
"RTN","DIE2",6,0)
F S D=$P(DQ(DQ),U,4) S:DP+1 D=DIFLD Q
"RTN","DIE2",7,0)
 ;
"RTN","DIE2",8,0)
Z S DIEZFLAG=1 D DL K DIEZFLAG S DU="" I Y=2 G @(DQ_U_DNM)
"RTN","DIE2",9,0)
 I Y D:$G(DE(DW,"INDEX")) SAVEVALS^@DNM G @("A^"_DNM)
"RTN","DIE2",10,0)
 G R^DIE9:DL>1,E^DIE9
"RTN","DIE2",11,0)
DL ;
"RTN","DIE2",12,0)
 S %=DP,X=D,Y=$P(DQ(DQ),U,4)="0;1"
"RTN","DIE2",13,0)
 G X:$D(DE(DQ))[0,X:DV["R"&'Y,X:$D(^DD("KEY","F",DP,D))&'Y,S:DP<0,DD:DUZ(0)="@" I DV S %=+$P(DC,U,2),X=.01
"RTN","DIE2",14,0)
 G DD:DP<2 I $D(DIDEL),DIDEL\1=(DP\1) G DD
"RTN","DIE2",15,0)
 I Y,$S($D(^VA(200,"AFOF")):1,1:$D(^DIC(3,"AFOF"))) G DD:$D(^DD(DP,0,"UP"))!DV,DAR:'$S($D(^VA(200,DUZ,"FOF",DP)):1,1:$D(^DIC(3,DUZ,"FOF",DP))),DAR:'$P(^(DP,0),U,3),DD
"RTN","DIE2",16,0)
 I Y,$D(^DIC(%,0,"DEL")) S X=^("DEL")
"RTN","DIE2",17,0)
 E  G DD:'$D(^DD(%,X,8.5)) S X=^(8.5)
"RTN","DIE2",18,0)
 G DD:X="" F %=1:1:$L(X) G DD:DUZ(0)[$E(X,%)
"RTN","DIE2",19,0)
DAR W !,"'DELETE ACCESS' REQUIRED!!"
"RTN","DIE2",20,0)
X I $D(DB(DQ)) D N G A
"RTN","DIE2",21,0)
 W:'$D(DIER) $C(7),"??" W:DV["R"&'$D(DIER) "  Required" W:$D(^DD("KEY","F",DP,D))&'$D(DIER) $S(DV'["R":"  Required",1:"")_" Key field" G R
"RTN","DIE2",22,0)
DD G MD:DV S DH=0,DU=0 F  S DH=$O(^DD(DP,D,"DEL",DH)) Q:DH=""  I $D(^(DH,0)) X ^(0) Q:$D(DTOUT)  G X:$T
"RTN","DIE2",23,0)
 S DH=-1,X=DQ(DQ) I Y,$E(@(DIE_"0)"))'=U S X=^(0)
"RTN","DIE2",24,0)
 D D G R:X I Y D FIREREC(DP) S X=DE(DQ) D DEL:$D(DIU(0)) K DE,DG,DQ,DB S DIK=DIE D ^DIK S Y=0 K:DL<2 DA Q
"RTN","DIE2",25,0)
S S X="",DG($P(DQ(DQ),U,4))="" D:'$G(DIEZFLAG) LOADXR^DIED
"RTN","DIE2",26,0)
A S Y=1 Q
"RTN","DIE2",27,0)
 ;
"RTN","DIE2",28,0)
D I $D(DB(DQ)) S X=0 Q
"RTN","DIE2",29,0)
 W $C(7),!?3,"SURE YOU WANT TO DELETE"
"RTN","DIE2",30,0)
 I Y W " THE ENTIRE " W:DV'["D"&(DV'["P")&(DV'["V") "'"_DE(DQ)_"' " W $P(X,U,1)
"RTN","DIE2",31,0)
 S %=0,X=0 D YN^DICN Q:%=1  S X=1 W:$X>55 !?9
"RTN","DIE2",32,0)
N I $D(DE(DQ))#2,'$D(DDS) W:'$D(ZTQUEUED) $C(7),"  <NOTHING DELETED>"
"RTN","DIE2",33,0)
 Q
"RTN","DIE2",34,0)
 ;
"RTN","DIE2",35,0)
MD G X:DV["R"&($P(DC,U,5)=1) S DH=0,DU=0 F  S DH=$O(^DD(+$P(DC,U,2),.01,"DEL",DH)) Q:DH=""  I $D(^(DH,0)) D DDA X ^(0) D UDA G X:$T
"RTN","DIE2",36,0)
 S DH=-1,Y=DC>1,X=$E(DQ(DQ),8,99) D D
"RTN","DIE2",37,0)
 I 'X D DDA D FIREREC(+$P(DC,U,2)) S DIK=DIC D ^DIK,UDA K DE(DQ) S X=$P(@(DIK_"0)"),U,3,4),DC=$P(DC,U,1,3)_U_X,DIC=DIE S:$D(^(+X,0)) DE(DQ)=$P(^(0),U,1)
"RTN","DIE2",38,0)
R S Y=2 Q
"RTN","DIE2",39,0)
 ;
"RTN","DIE2",40,0)
DDA N T,X
"RTN","DIE2",41,0)
 S T=$T
"RTN","DIE2",42,0)
 F X=+$O(DA(" "),-1):-1:1 K DA(X+1) S:$D(DA(X))#2 DA(X+1)=DA(X)
"RTN","DIE2",43,0)
 S:$D(DA)#2 DA(1)=DA
"RTN","DIE2",44,0)
 S DIC=DIE_DA_","""_$P(DC,U,3)_""",",DA=$P(DC,U,4)
"RTN","DIE2",45,0)
 S:$D(DIETMP)#2 DIIENS=DA_","_DIIENS
"RTN","DIE2",46,0)
 I T
"RTN","DIE2",47,0)
 Q
"RTN","DIE2",48,0)
 ;
"RTN","DIE2",49,0)
UDA N T,X
"RTN","DIE2",50,0)
 S T=$T
"RTN","DIE2",51,0)
 S DA=$G(DA(1)) ;K DA(1)
"RTN","DIE2",52,0)
 F X=2:1:+$O(DA(" "),-1) I $D(DA(X))#2 S DA(X-1)=DA(X) K DA(X)
"RTN","DIE2",53,0)
 S:$D(DIETMP)#2 DIIENS=$P(DIIENS,",",2,999)
"RTN","DIE2",54,0)
 I T
"RTN","DIE2",55,0)
 Q
"RTN","DIE2",56,0)
QS ;
"RTN","DIE2",57,0)
 G ^DIEQ
"RTN","DIE2",58,0)
QQ ;
"RTN","DIE2",59,0)
 G QQ^DIEQ
"RTN","DIE2",60,0)
 Q
"RTN","DIE2",61,0)
DEL I '$S($D(^VA(200,"AFOF",DA)):1,1:$D(^DIC(3,"AFOF",DA))) Q
"RTN","DIE2",62,0)
 S DA(1)="",DIFOF=DA
"RTN","DIE2",63,0)
 F P=0:0 S DA(1)=$S($D(^VA(200,"AFOF")):$O(^VA(200,"AFOF",DA,DA(1))),1:$O(^DIC(3,"AFOF",DA,DA(1)))) Q:'DA(1)  I $S($D(^VA(200,DA(1),"FOF",DA)):1,1:$D(^DIC(3,DA(1),"FOF",DA))) S DIK=$S($D(^VA(200)):"^VA(200,",1:"^DIC(3,")_DA(1)_",""FOF""," D ^DIK
"RTN","DIE2",64,0)
 K DA S DA=DIFOF K DIFOF
"RTN","DIE2",65,0)
 Q
"RTN","DIE2",66,0)
V ;
"RTN","DIE2",67,0)
 G ^DIE3
"RTN","DIE2",68,0)
 ;
"RTN","DIE2",69,0)
FIREREC(DIFILE) ;Fire record-level xrefs accumulated in ^TMP for file
"RTN","DIE2",70,0)
 ;or subfile DIFILE and all its subfiles
"RTN","DIE2",71,0)
 G:$G(DIEZFLAG) FIRERECZ
"RTN","DIE2",72,0)
 Q:$D(DIETMP)[0
"RTN","DIE2",73,0)
 Q:$D(@DIETMP@("R"))<2
"RTN","DIE2",74,0)
 ;
"RTN","DIE2",75,0)
 ;If we're at top level, fire all accumulated record-level xrefs
"RTN","DIE2",76,0)
 N X,Y
"RTN","DIE2",77,0)
 I '$G(^DD(DIFILE,0,"UP")) D FIREREC^DIE1 Q
"RTN","DIE2",78,0)
 ;
"RTN","DIE2",79,0)
 ;Save the DA array and DIIENS
"RTN","DIE2",80,0)
 N DASV,DIIENSSV
"RTN","DIE2",81,0)
 M DASV=DA S DIIENSSV=DIIENS
"RTN","DIE2",82,0)
 ;
"RTN","DIE2",83,0)
 ;Get list of subfiles under DIFILE
"RTN","DIE2",84,0)
 N DA,DIE,DIFLIST,DIIENS,DIPAT,DP
"RTN","DIE2",85,0)
 D SUBFILES^DIKCU(DIFILE,.DIFLIST)
"RTN","DIE2",86,0)
 S DIFLIST(DIFILE)=""
"RTN","DIE2",87,0)
 S DIPAT=".E1"""_DIIENSSV_""""
"RTN","DIE2",88,0)
 ;
"RTN","DIE2",89,0)
 ;Fire record-level cross references DIFILE and its subfiles
"RTN","DIE2",90,0)
 S DP=0 F  S DP=$O(DIFLIST(DP)) Q:'DP  D
"RTN","DIE2",91,0)
 . Q:'$D(@DIETMP@("R",DP))
"RTN","DIE2",92,0)
 . S DIIENS=" " F  S DIIENS=$O(@DIETMP@("R",DP,DIIENS)) Q:DIIENS=""  D
"RTN","DIE2",93,0)
 .. Q:DIIENS'?@DIPAT
"RTN","DIE2",94,0)
 .. S DIE=@DIETMP@("R",DP,DIIENS)
"RTN","DIE2",95,0)
 .. D DA^DILF(DIIENS,.DA)
"RTN","DIE2",96,0)
 .. D FIRE^DIKC(DP,.DA,"KS",$NA(@DIETMP@("R")),"F")
"RTN","DIE2",97,0)
 .. K @DIETMP@("R",DP,DIIENS),@DIETMP@("V",DP,DIIENS)
"RTN","DIE2",98,0)
 . K:'$D(@DIETMP@("V",DP)) @DIETMP@("R",DP)
"RTN","DIE2",99,0)
 Q
"RTN","DIE2",100,0)
 ;
"RTN","DIE2",101,0)
FIRERECZ ;Come here from FIREREC above, for compiled templates
"RTN","DIE2",102,0)
 Q:'$D(DIEZRXR)
"RTN","DIE2",103,0)
 ;
"RTN","DIE2",104,0)
 ;If we're at top level, fire all accumulated record-level xrefs
"RTN","DIE2",105,0)
 N X,Y
"RTN","DIE2",106,0)
 I '$G(^DD(DIFILE,0,"UP")) D FIREREC^DIE17 Q
"RTN","DIE2",107,0)
 ;
"RTN","DIE2",108,0)
 ;Save the DA array and DIIENS
"RTN","DIE2",109,0)
 N DASV,DIIENSSV
"RTN","DIE2",110,0)
 M DASV=DA S DIIENSSV=DIIENS
"RTN","DIE2",111,0)
 ;
"RTN","DIE2",112,0)
 ;Get list of subfiles under DIFILE
"RTN","DIE2",113,0)
 N DA,DIE,DIEZXR,DIFLIST,DIIENS,DIPAT,DP
"RTN","DIE2",114,0)
 D SUBFILES^DIKCU(DIFILE,.DIFLIST)
"RTN","DIE2",115,0)
 S DIFLIST(DIFILE)=""
"RTN","DIE2",116,0)
 S DIPAT=".E1"""_DIIENSSV_""""
"RTN","DIE2",117,0)
 ;
"RTN","DIE2",118,0)
 ;Fire record-level cross references DIFILE and its subfiles
"RTN","DIE2",119,0)
 S DP=0 F  S DP=$O(DIFLIST(DP)) Q:'DP  D
"RTN","DIE2",120,0)
 . Q:'$D(DIEZRXR(DP))
"RTN","DIE2",121,0)
 . S DIIENS=" " F  S DIIENS=$O(DIEZRXR(DP,DIIENS)) Q:DIIENS=""  D
"RTN","DIE2",122,0)
 .. Q:DIIENS'?@DIPAT
"RTN","DIE2",123,0)
 .. S DIE=DIEZRXR(DP,DIIENS)
"RTN","DIE2",124,0)
 .. D DA^DILF(DIIENS,.DA)
"RTN","DIE2",125,0)
 .. S DIEZXR=0 F  S DIEZXR=$O(DIEZRXR(DP,DIEZXR)) Q:DIEZXR'=+DIEZXR  D
"RTN","DIE2",126,0)
 ... D:$D(DIEZAR(DP,DIEZXR))#2 @DIEZAR(DP,DIEZXR)
"RTN","DIE2",127,0)
 .. K DIEZRXR(DP,DIIENS),@DIETMP@("V",DP,DIIENS)
"RTN","DIE2",128,0)
 . K:'$D(@DIETMP@("V",DP)) DIEZRXR(DP)
"RTN","DIE2",129,0)
 Q
"RTN","DIENVWRN")
0^^B3680036
"RTN","DIENVWRN",1,0)
DIENVWRN ;IRMFO-SF/FM STAFF-ENVIRONMENT CHECK ROUTINE ;6:50 AM  24 Mar 2000
"RTN","DIENVWRN",2,0)
 ;;22.0;VA FileMan;;Mar 30, 1999
"RTN","DIENVWRN",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIENVWRN",4,0)
 ;
"RTN","DIENVWRN",5,0)
 ; Check XPDENV 0 = Loading; 1 = Installing
"RTN","DIENVWRN",6,0)
 I 'XPDENV Q  ; Loading Distribution - No Check
"RTN","DIENVWRN",7,0)
 ;
"RTN","DIENVWRN",8,0)
INSCHK ; Do Checks During Install Only
"RTN","DIENVWRN",9,0)
 W $C(7)
"RTN","DIENVWRN",10,0)
 D MES^XPDUTL("** Although Queuing is allowed - it is HIGHLY recommended that ALL Users and")
"RTN","DIENVWRN",11,0)
 D MES^XPDUTL("VISTA Background jobs be STOPPED before installation of this patch.  Failure")
"RTN","DIENVWRN",12,0)
 D MES^XPDUTL("to do so may result in 'source routine edited' error(s). Edits will be")
"RTN","DIENVWRN",13,0)
 D MES^XPDUTL("lost and record(s) may be left in an inconsistent state, for example,")
"RTN","DIENVWRN",14,0)
 D MES^XPDUTL("not all Cross-Referencing completed; which in turn may cause FUTURE")
"RTN","DIENVWRN",15,0)
 D MES^XPDUTL("VistA/FileMan Hard Errors or corrupted Data. **")
"RTN","DIENVWRN",16,0)
 ;
"RTN","DIENVWRN",17,0)
TMCHK ; Check to see if TaskMan is still running
"RTN","DIENVWRN",18,0)
 S X=$$TM^%ZTLOAD
"RTN","DIENVWRN",19,0)
 I X,'$D(^%ZTSCH("WAIT")) D
"RTN","DIENVWRN",20,0)
 . W $C(7)
"RTN","DIENVWRN",21,0)
 . D BMES^XPDUTL("* Warning TaskMan Has NOT Been Stopped or Placed in a WAIT State!")
"RTN","DIENVWRN",22,0)
 ;
"RTN","DIENVWRN",23,0)
LINH ; Check to see if Logons are Inhibited
"RTN","DIENVWRN",24,0)
 D GETENV^%ZOSV  ; $P(Y,"^",2) = Installing Volume
"RTN","DIENVWRN",25,0)
 S X=+$G(^%ZIS(14.5,"LOGON",$P(Y,"^",2)))
"RTN","DIENVWRN",26,0)
 I 'X D
"RTN","DIENVWRN",27,0)
 . W $C(7)
"RTN","DIENVWRN",28,0)
 . D BMES^XPDUTL("* Warning Logons are NOT Inhibited!")
"RTN","DIENVWRN",29,0)
 Q
"RTN","DIEZ2")
0^9^B47298614
"RTN","DIEZ2",1,0)
DIEZ2 ;SFISC/GFT-COMPILE INPUT TEMPLATE ;12:45 PM  17 Sep 2002
"RTN","DIEZ2",2,0)
 ;;22.0;VA FileMan;**11,95**;Mar 30, 1999
"RTN","DIEZ2",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIEZ2",4,0)
 K DIEZAR D RECXR^DIEZ4(.DIEZAR)
"RTN","DIEZ2",5,0)
 K ^DIE(DIEZ,"AR") M:$D(DIEZAR) ^DIE(DIEZ,"AR")=DIEZAR
"RTN","DIEZ2",6,0)
 S %X="^UTILITY($J,""AF"",",%Y="^DIE(""AF""," D %XY^%RCR
"RTN","DIEZ2",7,0)
 K ^DIE(DIEZ,"AB") S %X="^UTILITY($J,""AB"",",%Y="^DIE(DIEZ,""AB""," D %XY^%RCR
"RTN","DIEZ2",8,0)
 S ^DIE(DIEZ,"ROUOLD")=DNM,^("ROU")=U_DNM
"RTN","DIEZ2",9,0)
K K ^DIBT(.402,1,DIEZ),^UTILITY($J)
"RTN","DIEZ2",10,0)
 K @DIEZTMP,DIEZTMP,DIEZAR
"RTN","DIEZ2",11,0)
 K DIE,DINC,DK,DL,DMAX,DNR,DP,DQ,DQFF,DRD,DS,DSN,DV,DW,DI,DH,%,%X,%Y,%H,X,Y
"RTN","DIEZ2",12,0)
 K DIEZ,DIEZDUP,DIEZR,Q,DPP,DPR,DM,DR,DU,T,F,DRN,DOV,DIEZL,DIEZP,DIEZAB
"RTN","DIEZ2",13,0)
 Q
"RTN","DIEZ2",14,0)
 ;
"RTN","DIEZ2",15,0)
XREF ;
"RTN","DIEZ2",16,0)
 N DIEZR,DIEZX,DIEZLN
"RTN","DIEZ2",17,0)
 S X="C"_DQ_" G C"_DQ_"S:$D(DE("_DQ_"))[0 K DB" D L
"RTN","DIEZ2",18,0)
 S DIEZX=L,DIEZLN=0 ;remember cross-refs will start after 'L'
"RTN","DIEZ2",19,0)
 F %=0:0 S %=$O(^DD(DP,DI,1,%)) Q:%'>0  S DW=^(%,2),X=" S X=DE("_DQ_"),DIC=DIE" D SK ;first build the KILL XREFS
"RTN","DIEZ2",20,0)
 I DV["a" S X=" S X=DE("_DQ_"),DIIX=2_U_DIFLD D AUDIT^DIET" D X
"RTN","DIEZ2",21,0)
 ;I X]"" S X="C"_DQ_" ;" D L
"RTN","DIEZ2",22,0)
 D OVERFLO
"RTN","DIEZ2",23,0)
 S X="C"_DQ_"S S X="""" G:DG(DQ)=X C"_DQ_"F1 K DB" D L S X=""
"RTN","DIEZ2",24,0)
 S DIEZX=L,DIEZLN=L
"RTN","DIEZ2",25,0)
 F %=0:0 S %=$O(^DD(DP,DI,1,%)) Q:%'>0  S DW=^(%,1),X=X_" S X=DG(DQ),DIC=DIE" D SK ;then the SET XREFS
"RTN","DIEZ2",26,0)
 I DV["a" S X=X_" I $D(DE("_DQ_"))'[0!(^DD(DP,DIFLD,""AUDIT"")'=""e"") S X=DG(DQ),DIIX=3_U_DIFLD D AUDIT^DIET" D X
"RTN","DIEZ2",27,0)
 D OVERFLO
"RTN","DIEZ2",28,0)
 ;Build index code and code to check key
"RTN","DIEZ2",29,0)
 D INDEX
"RTN","DIEZ2",30,0)
 S X=X_" Q" D L
"RTN","DIEZ2",31,0)
 I $D(DIEZKEY) D GETKEY^DIEZ3(DP,DI,.DIEZKEY,DQ) K DIEZKEY
"RTN","DIEZ2",32,0)
 Q
"RTN","DIEZ2",33,0)
 ;
"RTN","DIEZ2",34,0)
SK D X I "Q"[DW S X=" ;" G X
"RTN","DIEZ2",35,0)
 I DW["Q",^DD(DP,DI,1,%,0)["MUMPS" S Q=DW,F=0 D QFF S X=" X "_Q G X
"RTN","DIEZ2",36,0)
 S X=" "_DW
"RTN","DIEZ2",37,0)
X D L S DIEZLN=DIEZLN+$L(X),X="" Q
"RTN","DIEZ2",38,0)
 ;
"RTN","DIEZ2",39,0)
OVERFLO I DIEZLN+T+100<DMAX!'DIEZLN Q
"RTN","DIEZ2",40,0)
 K ^UTILITY($J,"DIEZXR") M ^UTILITY($J,"DIEZXR")=^UTILITY($J,0)
"RTN","DIEZ2",41,0)
 S DIEZR=DRN,(DIEZR(1),DRN)=$O(DRN(""),-1)+1 D
"RTN","DIEZ2",42,0)
 .N T,DQ,L
"RTN","DIEZ2",43,0)
 .D NEWROU^DIEZ ;make a new routine holding just the X-REFS
"RTN","DIEZ2",44,0)
 .F T=2:1 S DIEZX=DIEZX+1 Q:'$D(^UTILITY($J,"DIEZXR",DIEZX))  S ^UTILITY($J,0,T)=^(DIEZX) K ^UTILITY($J,"DIEZXR",DIEZX)
"RTN","DIEZ2",45,0)
 .F  K ^UTILITY($J,0,T) S T=$O(^(T)) Q:'T
"RTN","DIEZ2",46,0)
 .D SAVE^DIEZ1
"RTN","DIEZ2",47,0)
 K ^UTILITY($J,0) M ^UTILITY($J,0)=^UTILITY($J,"DIEZXR")
"RTN","DIEZ2",48,0)
 S DRN=DIEZR,T=T-DIEZLN,X=" D ^"_DNM_DIEZR(1) D L
"RTN","DIEZ2",49,0)
 Q
"RTN","DIEZ2",50,0)
 ;
"RTN","DIEZ2",51,0)
MUL ;
"RTN","DIEZ2",52,0)
 S DNR=%,DW=$P(DW,";",1),X=$P(^DD(+DV,0),U,4)_U_DV_U_DW_U,%=^(.01,0),DV=+DV_$P(%,U,2)
"RTN","DIEZ2",53,0)
 G 1:DV'["W" I DPR]"" S F=0,Q=DPR D QFF S X=" S DE(1,0)="_Q D L
"RTN","DIEZ2",54,0)
 S X=" S Y="""_$S(DIEZP]"":DIEZP_U_$P(%,U,2,9),1:%)_""",DG="""_DW_""",DC=""^"_+DV_""" D DIEN^DIWE K DE(1) G A" D L S X=" ;" D L,AF
"RTN","DIEZ2",55,0)
 S ^UTILITY($J,"AF",+DV,.01,DIEZ)="" D AB G NX^DIEZ0
"RTN","DIEZ2",56,0)
 ;
"RTN","DIEZ2",57,0)
1 S X=" S DIFLD="_DI_",DGO=""^"_DNM_DNR_""",DC="""_X_""",DV="""_DV_""",DW=""0;1"",DOW="""_$S(DIEZP]"":DIEZP,1:$P(^(0),U,1))_""",DLB=""Select ""_DOW S:D DC=DC_D",DPP=DV["M",DU=$P(^(0),U,3) D L,DU:DU]""
"RTN","DIEZ2",58,0)
 S X=$P(" G RE:D",U,DPP)_" I $D(DSC("_+DV_"))#2,$P(DSC("_+DV_"),""I $D(^UTILITY("",1)="""" X DSC("_+DV_") S D=$O(^(0)) S:D="""" D=-1 G M"_DQ D L
"RTN","DIEZ2",59,0)
 S:+DW'=DW DW=""""_DW_"""" S X=" S D=$S($D("_DIE_"DA,"_DW_",0)):$P(^(0),U,3,4),$O(^(0))'="""":$O(^(0)),1:-1)" D L
"RTN","DIEZ2",60,0)
 S X="M"_DQ_" I D>0 S DC=DC_D I $D("_DIE_"DA,"_DW_",+D,0)) S DE("_DQ_")=$P(^(0),U,1)" D L
"RTN","DIEZ2",61,0)
 D PR^DIEZ0 S X="R"_DQ_" D DE" D L
"RTN","DIEZ2",62,0)
 S X=$S(DPP:" S D=$S($D("_DIE_"DA,"_DW_",0)):$P(^(0),U,3,4),1:1) G "_DQ_"+1",1:" G A") D L S X=" ;" D L,AF
"RTN","DIEZ2",63,0)
 S DRN(DNR)=+DV_U_(DL+1)_DIE_"D"_DIEZL_","_DW_","_U_(DIEZL+1)_U_DQ_U_DRN G NX^DIEZ0
"RTN","DIEZ2",64,0)
 ;
"RTN","DIEZ2",65,0)
AF ;
"RTN","DIEZ2",66,0)
 S ^UTILITY($J,"AF",DP,DI,DIEZ)=""
"RTN","DIEZ2",67,0)
AB I '$D(^UTILITY($J,"AB",DIEZAB,DI)) S ^(DI)=DQ_U_DNM_DRN S:DPR?1"/".E ^(DI,"///")=""
"RTN","DIEZ2",68,0)
 Q
"RTN","DIEZ2",69,0)
 ;
"RTN","DIEZ2",70,0)
DU S F=0,Q=DU D QFF S X=" S DU="_Q,DU=""
"RTN","DIEZ2",71,0)
L S L=L+1,^UTILITY($J,0,L)=X,T=T+$L(X)+2 Q
"RTN","DIEZ2",72,0)
 ;
"RTN","DIEZ2",73,0)
O ;
"RTN","DIEZ2",74,0)
 S F=0,Q=^(2) D QFF S DIEZOT=" S DQ("_DQ_",2)="_Q Q
"RTN","DIEZ2",75,0)
 ;
"RTN","DIEZ2",76,0)
PR ;
"RTN","DIEZ2",77,0)
 F %=1,2,3 Q:$E(DPR,%)'="/"
"RTN","DIEZ2",78,0)
 S X=$E(DPR,%,999),Q=X,F=0 D QFF I $A(X)-94 S X=" S Y="_Q
"RTN","DIEZ2",79,0)
 E  S X=" "_$E(X,2,999) D L S X=" S Y=X"
"RTN","DIEZ2",80,0)
 D L S X=" G Y" I %>1 S DPP=0,X=" S X=Y,DB(DQ)=1"_$S(%=3:",DE(DW,""4/"")=""""",1:"")_" G:X="""" N^DIE17:DV,A I $D(DE(DQ)),DV[""I""!(DV[""#"") D E^DIE0 G A:'$D(X)" D L S X=" G "_$S(%=3:"RD:X=""@"",Z",1:"RD")
"RTN","DIEZ2",81,0)
 Q
"RTN","DIEZ2",82,0)
QF ;
"RTN","DIEZ2",83,0)
 S F=0,Q=DIE
"RTN","DIEZ2",84,0)
QFF ;
"RTN","DIEZ2",85,0)
 S F=$F(Q,"""",F) I F S Q=$E(Q,1,F-1)_$E(Q,F-1,999),F=F+1 G QFF
"RTN","DIEZ2",86,0)
 S Q=""""_Q_""""
"RTN","DIEZ2",87,0)
 Q
"RTN","DIEZ2",88,0)
 ;
"RTN","DIEZ2",89,0)
INDEX ;Build code field and record level cross references.
"RTN","DIEZ2",90,0)
 ;In:
"RTN","DIEZ2",91,0)
 ; DP = file #
"RTN","DIEZ2",92,0)
 ; DI = field #
"RTN","DIEZ2",93,0)
 ; DIEZKEY(xref#) = "" : for each xref that is a Uniqueness Index
"RTN","DIEZ2",94,0)
 ;                       for a simple (single-field key)
"RTN","DIEZ2",95,0)
 N DIEZCNT,DIEZFLST,DIEZI,DIEZRLST,DIEZXR,DIEZXREF
"RTN","DIEZ2",96,0)
 S DIEZCNT=0
"RTN","DIEZ2",97,0)
 ;
"RTN","DIEZ2",98,0)
 ;Get field- and record-level xrefs
"RTN","DIEZ2",99,0)
 D LOADFLD^DIKC1(DP,DI,"KS","","@DIEZTMP@(""V"",","DIEZXREF",$NA(@DIEZTMP@("R")),.DIEZFLST,.DIEZRLST)
"RTN","DIEZ2",100,0)
 I DIEZFLST="",DIEZRLST="" S X="C"_DQ_"F1" Q
"RTN","DIEZ2",101,0)
 ;
"RTN","DIEZ2",102,0)
 ;Build code for each field-level xref
"RTN","DIEZ2",103,0)
 ;Save DIEZKEY(uniquenessIndex)=index tag # (DIEZCNT)
"RTN","DIEZ2",104,0)
 I DIEZFLST]"" S DIEZXR=0 F  S DIEZXR=$O(DIEZXREF(DP,DIEZXR)) Q:'DIEZXR  D
"RTN","DIEZ2",105,0)
 . D GETXR(DIEZXR,.DIEZCNT)
"RTN","DIEZ2",106,0)
 . S:$D(DIEZKEY(DIEZXR))#2 DIEZKEY(DIEZXR)=DIEZCNT
"RTN","DIEZ2",107,0)
 ;
"RTN","DIEZ2",108,0)
 ;Build code to set the DIEZRXR array for each record-level xref
"RTN","DIEZ2",109,0)
 S X="C"_DQ_"F"_(DIEZCNT+1)
"RTN","DIEZ2",110,0)
 Q:DIEZRLST=""
"RTN","DIEZ2",111,0)
 S X=X_" S DIEZRXR("_DP_",DIIENS)=$$OREF^DILF($NA(@$$CREF^DILF(DIE)))" D L
"RTN","DIEZ2",112,0)
 S X=" F DIXR="_$TR(DIEZRLST,U,",")_" S DIEZRXR("_DP_",DIXR)=""""" D L
"RTN","DIEZ2",113,0)
 S DIEZI=0 F  S DIEZI=$O(DIEZRLST(DIEZI)) Q:'DIEZI  D
"RTN","DIEZ2",114,0)
 . S X=" F DIXR="_$TR(DIEZRLST(DIEZI),U,",")_" S DIEZRXR("_DP_",DIEZIENS)=""""" D L
"RTN","DIEZ2",115,0)
 ;
"RTN","DIEZ2",116,0)
 S X=""
"RTN","DIEZ2",117,0)
 Q
"RTN","DIEZ2",118,0)
 ;
"RTN","DIEZ2",119,0)
GETXR(DIEZXR,DIEZCNT) ;Get code for one index DIEZXR
"RTN","DIEZ2",120,0)
 N DIEZCOD,DIEZF,DIEZKLOG,DIEZNSS,DIEZSLOG,DIEZO
"RTN","DIEZ2",121,0)
 S DIEZCNT=$G(DIEZCNT)+1
"RTN","DIEZ2",122,0)
 ;
"RTN","DIEZ2",123,0)
 ;Build code to call subroutine to set X array
"RTN","DIEZ2",124,0)
 S X="C"_DQ_"F"_DIEZCNT_$S(DIEZCNT=1:" N X,X1,X2",1:"")_" S DIXR="_DIEZXR_" D C"_DQ_"X"_DIEZCNT_"(U) K X2 M X2=X D C"_DQ_"X"_DIEZCNT_"(""O"") K X1 M X1=X"
"RTN","DIEZ2",125,0)
 D L
"RTN","DIEZ2",126,0)
 ;
"RTN","DIEZ2",127,0)
 ;Build code to check for null subscripts
"RTN","DIEZ2",128,0)
 S DIEZNSS="",DIEZO=0
"RTN","DIEZ2",129,0)
 F  S DIEZO=$O(DIEZXREF(DP,DIEZXR,DIEZO)) Q:'DIEZO  D
"RTN","DIEZ2",130,0)
 . Q:'$G(DIEZXREF(DP,DIEZXR,DIEZO,"SS"))
"RTN","DIEZ2",131,0)
 . I DIEZNSS="" S DIEZNSS="$G(X("_DIEZO_"))]"""""
"RTN","DIEZ2",132,0)
 . E  S DIEZNSS=DIEZNSS_",$G(X("_DIEZO_"))]"""""
"RTN","DIEZ2",133,0)
 I DIEZNSS]"" S DIEZNSS=" I "_DIEZNSS_" D"
"RTN","DIEZ2",134,0)
 E  S DIEZNSS=" D"
"RTN","DIEZ2",135,0)
 ;
"RTN","DIEZ2",136,0)
 ;Get kill logic and condition
"RTN","DIEZ2",137,0)
 S DIEZKLOG=$G(DIEZXREF(DP,DIEZXR,"K"))
"RTN","DIEZ2",138,0)
 I DIEZKLOG'?."^" D
"RTN","DIEZ2",139,0)
 . S X=DIEZNSS D L
"RTN","DIEZ2",140,0)
 . ;Get kill condition code
"RTN","DIEZ2",141,0)
 . S DIEZCOD=$G(DIEZXREF(DP,DIEZXR,"KC"))
"RTN","DIEZ2",142,0)
 . I DIEZCOD'?."^" D
"RTN","DIEZ2",143,0)
 .. S X=" . N DIEXARR M DIEXARR=X S DIEZCOND=1" D L
"RTN","DIEZ2",144,0)
 .. S X=" . "_DIEZCOD D L
"RTN","DIEZ2",145,0)
 .. S X=" . S DIEZCOND=$G(X) K X M X=DIEXARR Q:'DIEZCOND" D L
"RTN","DIEZ2",146,0)
 . ;Get kill logic
"RTN","DIEZ2",147,0)
 . S X=" . "_DIEZKLOG D L
"RTN","DIEZ2",148,0)
 ;
"RTN","DIEZ2",149,0)
 ;Get set logic and condition
"RTN","DIEZ2",150,0)
 S DIEZSLOG=$G(DIEZXREF(DP,DIEZXR,"S"))
"RTN","DIEZ2",151,0)
 I DIEZSLOG'?."^" D
"RTN","DIEZ2",152,0)
 . S X=" K X M X=X2"_DIEZNSS D L
"RTN","DIEZ2",153,0)
 . ;Get set condition code
"RTN","DIEZ2",154,0)
 . S DIEZCOD=$G(DIEZXREF(DP,DIEZXR,"SC"))
"RTN","DIEZ2",155,0)
 . I DIEZCOD'?."^" D
"RTN","DIEZ2",156,0)
 .. S X=" . N DIEXARR M DIEXARR=X S DIEZCOND=1" D L
"RTN","DIEZ2",157,0)
 .. S X=" . "_DIEZCOD D L
"RTN","DIEZ2",158,0)
 .. S X=" . S DIEZCOND=$G(X) K X M X=DIEXARR Q:'DIEZCOND" D L
"RTN","DIEZ2",159,0)
 . ;Get set logic
"RTN","DIEZ2",160,0)
 . S X=" . "_DIEZSLOG D L
"RTN","DIEZ2",161,0)
 ;
"RTN","DIEZ2",162,0)
 S X=" G C"_DQ_"F"_(DIEZCNT+1) D L
"RTN","DIEZ2",163,0)
 ;
"RTN","DIEZ2",164,0)
 ;Build code to set X array
"RTN","DIEZ2",165,0)
 S DIEZF=$O(DIEZXREF(DP,DIEZXR,0))
"RTN","DIEZ2",166,0)
 S X="C"_DQ_"X"_DIEZCNT_"(DION) K X" D L
"RTN","DIEZ2",167,0)
 S DIEZO=0
"RTN","DIEZ2",168,0)
 F  S DIEZO=$O(DIEZXREF(DP,DIEZXR,DIEZO)) Q:'DIEZO  D
"RTN","DIEZ2",169,0)
 . D BLDDEC(DP,DIEZXR,DIEZO)
"RTN","DIEZ2",170,0)
 S X=" S X=$G(X("_DIEZF_"))" D L
"RTN","DIEZ2",171,0)
 S X=" Q" D L
"RTN","DIEZ2",172,0)
 Q
"RTN","DIEZ2",173,0)
 ;
"RTN","DIEZ2",174,0)
BLDDEC(DP,DIEZXR,DIEZO) ;Build data extraction code
"RTN","DIEZ2",175,0)
 N CODE,NODE,TRANS
"RTN","DIEZ2",176,0)
 ;
"RTN","DIEZ2",177,0)
 S CODE=$G(DIEZXREF(DP,DIEZXR,DIEZO)) Q:CODE?."^"
"RTN","DIEZ2",178,0)
 S TRANS=$G(DIEZXREF(DP,DIEZXR,DIEZO,"T"))
"RTN","DIEZ2",179,0)
 I TRANS'?."^" D
"RTN","DIEZ2",180,0)
 . S X=" "_CODE D L
"RTN","DIEZ2",181,0)
 . D DOTLINE(" I $D(X)#2 "_TRANS)
"RTN","DIEZ2",182,0)
 . S X=" S:$D(X)#2 X("_DIEZO_")=X" D L
"RTN","DIEZ2",183,0)
 E  I $D(DIEZXREF(DP,DIEZXR,DIEZO,"F"))#2,CODE?1"S X=".E D
"RTN","DIEZ2",184,0)
 . S X=" S X("_DIEZO_")"_$E(CODE,4,999) D L
"RTN","DIEZ2",185,0)
 E  D
"RTN","DIEZ2",186,0)
 . S X=" "_CODE D L
"RTN","DIEZ2",187,0)
 . S X=" S:$D(X)#2 X("_DIEZO_")=X" D L
"RTN","DIEZ2",188,0)
 Q
"RTN","DIEZ2",189,0)
 ;
"RTN","DIEZ2",190,0)
DOTLINE(CODE) ;
"RTN","DIEZ2",191,0)
 I CODE[" Q"!(CODE[" Q:") D
"RTN","DIEZ2",192,0)
 . S X=" D" D L
"RTN","DIEZ2",193,0)
 . S X=" ."_CODE D L
"RTN","DIEZ2",194,0)
 E  S X=CODE D L
"RTN","DIEZ2",195,0)
 Q
"RTN","DIKC")
0^1^B61623191
"RTN","DIKC",1,0)
DIKC ;SFISC/MKO-FIRE INDEX FILE CROSS REFERENCES ;1:41 PM  17 Dec 2001
"RTN","DIKC",2,0)
 ;;22.0;VA FileMan;**1,22,11,68,95**;Mar 30, 1999
"RTN","DIKC",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKC",4,0)
 ;
"RTN","DIKC",5,0)
INDEX(DIFILE,DIREC,DIFLD,DIXREF,DICTRL) ;Fire Index file xrefs
"RTN","DIKC",6,0)
 N DA,DIF,DIKACT,DIKCT,DIKERR,DIKLOCK,DIKLOG,DIKON,DIKRFIL
"RTN","DIKC",7,0)
 N DIKTMP,DIKVAL,DIMF,DIROOT
"RTN","DIKC",8,0)
 ;
"RTN","DIKC",9,0)
 ;Initialization
"RTN","DIKC",10,0)
 S DIF=$E("D",$G(DICTRL)["D")
"RTN","DIKC",11,0)
 I DIF["D",'$D(DIQUIET) N DIQUIET S DIQUIET=1
"RTN","DIKC",12,0)
 I DIF["D",'$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DIKC",13,0)
 ;
"RTN","DIKC",14,0)
 ;Check (and convert) input parameters
"RTN","DIKC",15,0)
 D CHK^DIKC2 G:$G(DIKERR)]"" EXIT
"RTN","DIKC",16,0)
 ;
"RTN","DIKC",17,0)
 ;Setup variables
"RTN","DIKC",18,0)
 S DIKCT=$E("C",$G(DICTRL)["C")_$E("T",$G(DICTRL)["T")
"RTN","DIKC",19,0)
 S DIKLOG=$E("K",$G(DICTRL)["K")_$E("S",$G(DICTRL)["S")
"RTN","DIKC",20,0)
 S:DIKLOG="" DIKLOG=$E("K",DIKCT'["C")_$E("S",DIKCT'["T")
"RTN","DIKC",21,0)
 S DIKACT=$E("R",$G(DICTRL)["R")_$E("I",$G(DICTRL)["I")
"RTN","DIKC",22,0)
 S DIKRFIL=$S($G(DICTRL)["W":+$P(DICTRL,"W",2),1:DIFILE)
"RTN","DIKC",23,0)
 I $G(DICTRL)["k" D
"RTN","DIKC",24,0)
 . S DIKLOCK=+$P(DICTRL,"k",2)\1
"RTN","DIKC",25,0)
 . S:DIKLOCK<0 DIKLOCK=-DIKLOCK
"RTN","DIKC",26,0)
 . S:$E($P(DICTRL,"k",2))="-" DIKLOCK("STOP")=1
"RTN","DIKC",27,0)
 E  S DIKLOCK=1
"RTN","DIKC",28,0)
 ;
"RTN","DIKC",29,0)
 ;Load xref information into @DIKTMP
"RTN","DIKC",30,0)
 S DIKTMP=$G(DICTRL("LOGIC"))
"RTN","DIKC",31,0)
 I $G(DIKTMP)="" D
"RTN","DIKC",32,0)
 . S DIKTMP=$$GETTMP^DIKC1("DIKC")
"RTN","DIKC",33,0)
 . I $G(DIXREF)?."^" D
"RTN","DIKC",34,0)
 .. I $G(DIFLD) D
"RTN","DIKC",35,0)
 ... D LOADFLD^DIKC1(DIKRFIL,DIFLD,DIKLOG_"W",DIKACT,DIKVAL,DIKTMP,DIKTMP,$E("i",$G(DICTRL)["i"))
"RTN","DIKC",36,0)
 .. E  D LOADALL^DIKC1(DIKRFIL,DIKLOG,DIKACT,DIKVAL,DIKTMP,$E("s",$G(DICTRL)["s")_$E("i",$G(DICTRL)["i"),.DIMF)
"RTN","DIKC",37,0)
 . E  D LOADXREF^DIKC1(DIKRFIL,$G(DIFLD),DIKLOG,.DIXREF,DIKVAL,DIKTMP)
"RTN","DIKC",38,0)
 ;
"RTN","DIKC",39,0)
 D:DIKRFIL'=DIFILE SBINFO^DIKCU(DIKRFIL,.DIMF)
"RTN","DIKC",40,0)
 ;
"RTN","DIKC",41,0)
 ;Fire the xrefs for all records or the record specified in DA
"RTN","DIKC",42,0)
 I 'DA D
"RTN","DIKC",43,0)
 . L +@DIROOT:DIKLOCK E  D  Q:$G(DIKLOCK("STOP"))
"RTN","DIKC",44,0)
 .. S DIKLOCK=""
"RTN","DIKC",45,0)
 .. D:DIF["D" ERR^DIKCU2(112,DIFILE)
"RTN","DIKC",46,0)
 . D FIREALL(DIFILE,.DA,DIROOT,DIKLOG,.DIMF,DIKTMP,DIKON,"",DIKCT)
"RTN","DIKC",47,0)
 . L:DIKLOCK]"" -@DIROOT
"RTN","DIKC",48,0)
 E  D
"RTN","DIKC",49,0)
 . L +@DIROOT@(DA):DIKLOCK E  D  Q:$G(DIKLOCK("STOP"))
"RTN","DIKC",50,0)
 .. S DIKLOCK=""
"RTN","DIKC",51,0)
 .. D:DIF["D" ERR^DIKCU2(110,DIFILE,$$IENS^DIKCU(DIFILE,.DA))
"RTN","DIKC",52,0)
 . D:$D(@DIKTMP@(DIFILE)) FIRE(DIFILE,.DA,DIKLOG,DIKTMP,DIKON,"",DIKCT)
"RTN","DIKC",53,0)
 . D:$D(DIMF(DIFILE)) FIRESUB(DIFILE,.DA,DIROOT,DIKLOG,.DIMF,DIKTMP,DIKON,"",DIKCT)
"RTN","DIKC",54,0)
 . L:DIKLOCK]"" -@DIROOT@(DA)
"RTN","DIKC",55,0)
 ;
"RTN","DIKC",56,0)
 ;Cleanup ^TMP
"RTN","DIKC",57,0)
 K @DIKTMP
"RTN","DIKC",58,0)
 ;
"RTN","DIKC",59,0)
EXIT ;Move error messages if necessary
"RTN","DIKC",60,0)
 I DIF["D",$G(DIERR),$G(DICTRL("MSG"))]"" D CALLOUT^DIEFU(DICTRL("MSG"))
"RTN","DIKC",61,0)
 Q
"RTN","DIKC",62,0)
 ;
"RTN","DIKC",63,0)
FIREALL(DIFILE,DA,DIROOT,DILOG,DIMF,DIKTMP,DIKON,DIKEY,DIKCT) ;Fire xrefs, all recs
"RTN","DIKC",64,0)
 N DICNT,DIIENS,DILAST,DIXR
"RTN","DIKC",65,0)
 S DILOG=$G(DILOG),DIKON=$G(DIKON)
"RTN","DIKC",66,0)
 S DIIENS=$$IENS^DIKCU(DIFILE,.DA)
"RTN","DIKC",67,0)
 ;
"RTN","DIKC",68,0)
 ;Kill entire indexes
"RTN","DIKC",69,0)
 I DILOG["K",$D(@DIKTMP@("KW",DIFILE)) D XECKW(DIFILE,.DA,$D(DIMF(DIFILE))>0)
"RTN","DIKC",70,0)
 I '$D(@DIKTMP@(DIFILE)),'$D(DIMF(DIFILE)) Q
"RTN","DIKC",71,0)
 ;
"RTN","DIKC",72,0)
 ;Loop through all records in the file
"RTN","DIKC",73,0)
 S (DICNT,DA)=0 F  S DA=$O(@DIROOT@(DA)) Q:DA'=+DA  D
"RTN","DIKC",74,0)
 . S $P(DIIENS,",")=DA
"RTN","DIKC",75,0)
 . S DICNT=DICNT+1
"RTN","DIKC",76,0)
 . D:$D(@DIKTMP@(DIFILE)) FIRE(DIFILE,.DA,DILOG,DIKTMP,DIKON,.DIKEY,DIKCT,DIIENS)
"RTN","DIKC",77,0)
 . D:$D(DIMF(DIFILE)) FIRESUB(DIFILE,.DA,DIROOT,DILOG,.DIMF,DIKTMP,DIKON,.DIKEY,DIKCT)
"RTN","DIKC",78,0)
 ;
"RTN","DIKC",79,0)
 ;Update header node
"RTN","DIKC",80,0)
 I $D(@DIROOT@(0))#2 D
"RTN","DIKC",81,0)
 . S DILAST=$O(@DIROOT@(" "),-1) S:'DILAST DILAST=""
"RTN","DIKC",82,0)
 . S:'DICNT DICNT=""
"RTN","DIKC",83,0)
 . S $P(@DIROOT@(0),U,3,4)=DILAST_U_DICNT
"RTN","DIKC",84,0)
 Q
"RTN","DIKC",85,0)
 ;
"RTN","DIKC",86,0)
FIRE(DIFILE,DA,DILOG,DIKTMP,DIKON,DIKEY,DIKCT,DIIENS) ;Fire xrefs, one record
"RTN","DIKC",87,0)
 N DI01,DIKCLOG,DINULL,DION,DIXR,I,J,X,X2,XN
"RTN","DIKC",88,0)
 S DILOG=$G(DILOG),DIKON=$G(DIKON)
"RTN","DIKC",89,0)
 S:$G(DIIENS)="" DIIENS=$$IENS^DIKCU(DIFILE,.DA)
"RTN","DIKC",90,0)
 ;
"RTN","DIKC",91,0)
 I DIKON="" S DIXR=0 F  S DIXR=$O(@DIKTMP@(DIFILE,DIXR)) Q:DIXR'=+DIXR  D
"RTN","DIKC",92,0)
 . D SETXARR(DIFILE,DIXR,DIKTMP,.DINULL) Q:DINULL
"RTN","DIKC",93,0)
 . I $G(DIKCT)="" D XECUTE(DIFILE,DIXR,DILOG,.X,.X,DIKTMP) Q
"RTN","DIKC",94,0)
 . ;
"RTN","DIKC",95,0)
 . K XN S XN="",I=0 F  S I=$O(X(I)) Q:'I  S XN(I)=""
"RTN","DIKC",96,0)
 . I $G(DIKCT)="C" D XECUTE(DIFILE,DIXR,"S",.XN,.X,DIKTMP) Q
"RTN","DIKC",97,0)
 . I $G(DIKCT)="T" D XECUTE(DIFILE,DIXR,"K",.X,.XN,DIKTMP) Q
"RTN","DIKC",98,0)
 ;
"RTN","DIKC",99,0)
 E  S DIXR=0 F  S DIXR=$O(@DIKTMP@(DIFILE,DIXR)) Q:DIXR'=+DIXR  D
"RTN","DIKC",100,0)
 . K DINFLD
"RTN","DIKC",101,0)
 . S DIKCLOG=""
"RTN","DIKC",102,0)
 . ;
"RTN","DIKC",103,0)
 . ;Set X2 array to new values
"RTN","DIKC",104,0)
 . S DION=$P(DIKON,U,2)
"RTN","DIKC",105,0)
 . D SETXARR(DIFILE,DIXR,DIKTMP,.DINULL,DION) M X2=X
"RTN","DIKC",106,0)
 . ;
"RTN","DIKC",107,0)
 . ;If SET requested, make sure no new values are null
"RTN","DIKC",108,0)
 . I DILOG["S" D
"RTN","DIKC",109,0)
 .. I 'DINULL S DIKCLOG="S"
"RTN","DIKC",110,0)
 .. E  I $P(DIKON,U,4)="N" S I=0 F  S I=$O(^DD("KEY","AU",DIXR,I)) Q:'I  D
"RTN","DIKC",111,0)
 ... S DIKEY(DIFILE,I,DIIENS)="n"
"RTN","DIKC",112,0)
 ... S J=0 F  S J=$O(DINULL(J)) Q:'J  S DIKEY(DIFILE,I,DIIENS,$P(DINULL(J),U),$P(DINULL(J),U,2))=$P(DINULL(J),U,3)
"RTN","DIKC",113,0)
 . ;
"RTN","DIKC",114,0)
 . ;Set X array to old values
"RTN","DIKC",115,0)
 . S DION=$P(DIKON,U)
"RTN","DIKC",116,0)
 . D SETXARR(DIFILE,DIXR,DIKTMP,.DINULL,DION,.DI01)
"RTN","DIKC",117,0)
 . ;
"RTN","DIKC",118,0)
 . ;If KILL requested, make sure no old values are null
"RTN","DIKC",119,0)
 . I DILOG["K",'DINULL S DIKCLOG="K"_DIKCLOG
"RTN","DIKC",120,0)
 . ;
"RTN","DIKC",121,0)
 . ;If "C" flag, set old .01 value to null
"RTN","DIKC",122,0)
 . I $G(DIKCT)="C",$D(DI01) D
"RTN","DIKC",123,0)
 .. S I=0 F  S I=$O(DI01(I)) Q:'I  S X(I)=""
"RTN","DIKC",124,0)
 .. S:$O(DI01(0))=$O(X(0)) X=""
"RTN","DIKC",125,0)
 .. S DIKCLOG=$TR(DIKCLOG,"K")
"RTN","DIKC",126,0)
 . ;
"RTN","DIKC",127,0)
 . ;If "T" flag, set all new values to null
"RTN","DIKC",128,0)
 . I $G(DIKCT)="T" S X2="",I=0 F  S I=$O(X2(I)) Q:'I  S X2(I)=""
"RTN","DIKC",129,0)
 . ;
"RTN","DIKC",130,0)
 . ;Execute the kill and set logic
"RTN","DIKC",131,0)
 . D XECUTE(DIFILE,DIXR,DIKCLOG,.X,.X2,DIKTMP)
"RTN","DIKC",132,0)
 . ;
"RTN","DIKC",133,0)
 . I DIKCLOG["S",$P(DIKON,U,3)="K",$D(^DD("KEY","AU",DIXR)) D
"RTN","DIKC",134,0)
 .. Q:$$UNIQUE^DIKK2(DIFILE,DIXR,.X2,.DA,DIKTMP)
"RTN","DIKC",135,0)
 .. S I=0 F  S I=$O(^DD("KEY","AU",DIXR,I)) Q:'I  S DIKEY(DIFILE,I,DIIENS)=""
"RTN","DIKC",136,0)
 Q
"RTN","DIKC",137,0)
 ;
"RTN","DIKC",138,0)
FIRESUB(DIFILE,DA,DIROOT,DILOG,DIMF,DIKTMP,DIKON,DIKEY,DIKCT) ;Fire xrefs for
"RTN","DIKC",139,0)
 ;all subfiles under DIFILE, for all subrecords under DA
"RTN","DIKC",140,0)
 Q:'$D(DIMF(DIFILE))
"RTN","DIKC",141,0)
 N DIMULTF,DISBFILE,DISBROOT,X
"RTN","DIKC",142,0)
 S DILOG=$G(DILOG),DIKON=$G(DIKON)
"RTN","DIKC",143,0)
 ;
"RTN","DIKC",144,0)
 ;Push down the DA array
"RTN","DIKC",145,0)
 D PUSHDA^DIKCU(.DA)
"RTN","DIKC",146,0)
 ;
"RTN","DIKC",147,0)
 ;Loop through DIMF array and fire xrefs for subfiles
"RTN","DIKC",148,0)
 S DIMULTF=0 F  S DIMULTF=$O(DIMF(DIFILE,DIMULTF)) Q:'DIMULTF  D
"RTN","DIKC",149,0)
 . S DISBROOT=$NA(@DIROOT@(DA(1),DIMF(DIFILE,DIMULTF))) Q:'$D(@DISBROOT)
"RTN","DIKC",150,0)
 . S DISBFILE=DIMF(DIFILE,DIMULTF,0)
"RTN","DIKC",151,0)
 . D FIREALL(DISBFILE,.DA,DISBROOT,DILOG,.DIMF,DIKTMP,DIKON,.DIKEY,DIKCT)
"RTN","DIKC",152,0)
 ;
"RTN","DIKC",153,0)
 ;Pop the DA array
"RTN","DIKC",154,0)
 D POPDA^DIKCU(.DA)
"RTN","DIKC",155,0)
 Q
"RTN","DIKC",156,0)
 ;
"RTN","DIKC",157,0)
XECUTE(DIFILE,DIXR,DILOG,DIKCX1,DIKCX2,DIKTMP) ;Xecute the logic in ^TMP
"RTN","DIKC",158,0)
 Q:$G(DILOG)=""
"RTN","DIKC",159,0)
 N DIKCOD,DIKCON,X,X1,X2
"RTN","DIKC",160,0)
 ;
"RTN","DIKC",161,0)
 ;Execute kill logic
"RTN","DIKC",162,0)
 I DILOG["K" D
"RTN","DIKC",163,0)
 . S DIKCOD=$G(@DIKTMP@(DIFILE,DIXR,"K")) Q:DIKCOD?."^"
"RTN","DIKC",164,0)
 . S DIKCON=$G(@DIKTMP@(DIFILE,DIXR,"KC"))
"RTN","DIKC",165,0)
 . I DIKCON'?."^" M X=DIKCX1,X1=DIKCX1,X2=DIKCX2 X DIKCON Q:'$G(X)  K X,X1,X2
"RTN","DIKC",166,0)
 . M X=DIKCX1,X1=DIKCX1,X2=DIKCX2
"RTN","DIKC",167,0)
 . X DIKCOD K X,X1,X2
"RTN","DIKC",168,0)
 ;
"RTN","DIKC",169,0)
 ;Execute set logic
"RTN","DIKC",170,0)
 I DILOG["S" D
"RTN","DIKC",171,0)
 . S DIKCOD=$G(@DIKTMP@(DIFILE,DIXR,"S")) Q:DIKCOD?."^"
"RTN","DIKC",172,0)
 . S DIKCON=$G(@DIKTMP@(DIFILE,DIXR,"SC"))
"RTN","DIKC",173,0)
 . I DIKCON'?."^" M X=DIKCX2,X1=DIKCX1,X2=DIKCX2 X DIKCON Q:'$G(X)  K X,X1,X2
"RTN","DIKC",174,0)
 . M X=DIKCX2,X1=DIKCX1,X2=DIKCX2
"RTN","DIKC",175,0)
 . X DIKCOD
"RTN","DIKC",176,0)
 Q
"RTN","DIKC",177,0)
 ;
"RTN","DIKC",178,0)
XECKW(DIFILE,DA,DIKSUB) ;Execute the logic to kill the entire index
"RTN","DIKC",179,0)
 N DIKFIL,DIKKW,DIKKW0,DIKLDIF,DIXR
"RTN","DIKC",180,0)
 ;
"RTN","DIKC",181,0)
 S DIXR=0 F  S DIXR=$O(@DIKTMP@("KW",DIFILE,DIXR)) Q:DIXR'=+DIXR  D
"RTN","DIKC",182,0)
 . S DIKKW=$G(@DIKTMP@("KW",DIFILE,DIXR)) Q:DIKKW?."^"
"RTN","DIKC",183,0)
 . S DIKKW0=$G(@DIKTMP@("KW",DIFILE,DIXR,0))
"RTN","DIKC",184,0)
 . ;
"RTN","DIKC",185,0)
 . ;If not a whole file xref, kill the entire index and quit
"RTN","DIKC",186,0)
 . I DIKKW0="" X DIKKW D  Q
"RTN","DIKC",187,0)
 .. I '$D(@DIKTMP@(DIFILE,DIXR,"S")) K @DIKTMP@(DIFILE,DIXR)
"RTN","DIKC",188,0)
 .. E  K @DIKTMP@(DIFILE,DIXR,"K"),@DIKTMP@(DIFILE,DIXR,"KC")
"RTN","DIKC",189,0)
 . ;
"RTN","DIKC",190,0)
 . ;Quit if this isn't a whole file xref or we're not doing subfiles
"RTN","DIKC",191,0)
 . Q:$P(DIKKW0,U)'="W"!'$G(DIKSUB)
"RTN","DIKC",192,0)
 . ;
"RTN","DIKC",193,0)
 . ;Kill the whole index after pushing DA the appropriate amount
"RTN","DIKC",194,0)
 . S DIKFIL=$P(DIKKW0,U,2),DIKLDIF=$P(DIKKW0,U,3)
"RTN","DIKC",195,0)
 . D PUSHDA^DIKCU(.DA,DIKLDIF)
"RTN","DIKC",196,0)
 . X DIKKW
"RTN","DIKC",197,0)
 . I '$D(@DIKTMP@(DIKFIL,DIXR,"S")) K @DIKTMP@(DIKFIL,DIXR)
"RTN","DIKC",198,0)
 . E  K @DIKTMP@(DIKFIL,DIXR,"K"),@DIKTMP@(DIKFIL,DIXR,"KC")
"RTN","DIKC",199,0)
 . D POPDA^DIKCU(.DA,DIKLDIF)
"RTN","DIKC",200,0)
 Q
"RTN","DIKC",201,0)
 ;
"RTN","DIKC",202,0)
SETXARR(DIFILE,DIXR,DIKTMP,DINULL,DION,DI01) ;Loop through DIKTMP and set X array.
"RTN","DIKC",203,0)
 ;If any values used as subscripts are null, return
"RTN","DIKC",204,0)
 ; DINULL=1
"RTN","DIKC",205,0)
 ; DINULL(order#) = ""
"RTN","DIKC",206,0)
 ;                  or file^field^levDiff (for field type subscripts)
"RTN","DIKC",207,0)
 ; DI01(order#) = "" if order # is .01 field
"RTN","DIKC",208,0)
 ;
"RTN","DIKC",209,0)
 N DIKCX,DIKF,DIKO,X1,X2
"RTN","DIKC",210,0)
 K X,DI01,DINULL
"RTN","DIKC",211,0)
 S DINULL=0,(DIKF,DIKO)=$O(@DIKTMP@(DIFILE,DIXR,0)) Q:'DIKF
"RTN","DIKC",212,0)
 ;
"RTN","DIKC",213,0)
 S:$G(DION)="" DION=U
"RTN","DIKC",214,0)
 F  D  S DIKO=$O(@DIKTMP@(DIFILE,DIXR,DIKO)) Q:'DIKO
"RTN","DIKC",215,0)
 . K DIKCX M DIKCX=X
"RTN","DIKC",216,0)
 . X $G(@DIKTMP@(DIFILE,DIXR,DIKO))
"RTN","DIKC",217,0)
 . I $G(X)]"",$D(@DIKTMP@(DIFILE,DIXR,DIKO,"T")) X @DIKTMP@(DIFILE,DIXR,DIKO,"T")
"RTN","DIKC",218,0)
 . S:$D(X)#2 (DIKCX,DIKCX(DIKO))=X K X M X=DIKCX
"RTN","DIKC",219,0)
 . S:$P($G(@DIKTMP@(DIFILE,DIXR,DIKO,"F")),U,2)=.01 DI01(DIKO)=""
"RTN","DIKC",220,0)
 . I $G(X(DIKO))="",$G(@DIKTMP@(DIFILE,DIXR,DIKO,"SS")) S DINULL=1 S:$G(@DIKTMP@(DIFILE,DIXR,DIKO,"F")) DINULL(DIKO)=@DIKTMP@(DIFILE,DIXR,DIKO,"F")
"RTN","DIKC",221,0)
 ;
"RTN","DIKC",222,0)
 S:$D(X(DIKF))#2 X=$G(X(DIKF))
"RTN","DIKC",223,0)
 Q
"RTN","DIKC",224,0)
 ;
"RTN","DIKC",225,0)
 ;#110  The record is currently locked.
"RTN","DIKC",226,0)
 ;#112  The file is currently locked.
"RTN","DIKCBLD")
0^7^B39733013
"RTN","DIKCBLD",1,0)
DIKCBLD ;SFISC/MKO-AUTOBUILD A ROUTINE THAT CALLS CREIXN^DDMOD ;11:30 AM  9 Jul 2002
"RTN","DIKCBLD",2,0)
 ;;22.0;VA FileMan;**95**;Mar 30, 1999
"RTN","DIKCBLD",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKCBLD",4,0)
 ;
"RTN","DIKCBLD",5,0)
MAIN ;Main process
"RTN","DIKCBLD",6,0)
 N DIKCRTN,DIKCNMSP,DIKCITL,DIKCXR,%
"RTN","DIKCBLD",7,0)
 ;
"RTN","DIKCBLD",8,0)
 ;Check save code
"RTN","DIKCBLD",9,0)
 D:'$D(DISYS) OS^DII
"RTN","DIKCBLD",10,0)
 I '$D(^DD("OS",DISYS,"ZS")) W $C(7),$$EZBLD^DIALOG(820) Q
"RTN","DIKCBLD",11,0)
 ;
"RTN","DIKCBLD",12,0)
 ;Gather information from user
"RTN","DIKCBLD",13,0)
Q1 S DIKCRTN=$$ASKRTN Q:U[DIKCRTN
"RTN","DIKCBLD",14,0)
Q2 S DIKCITL=$$ASKITL Q:DIKCITL[U  I DIKCITL="" W ! G Q1
"RTN","DIKCBLD",15,0)
Q3 S DIKCNMSP=$$ASKNMSP Q:DIKCNMSP[U  I DIKCNMSP="" W ! G Q2
"RTN","DIKCBLD",16,0)
Q4 S DIKCXR=$$ASKXR() I 'DIKCXR W ! G Q3
"RTN","DIKCBLD",17,0)
 ;
"RTN","DIKCBLD",18,0)
 ;Build and save routine
"RTN","DIKCBLD",19,0)
 D BUILD(DIKCRTN,DIKCITL,DIKCNMSP,DIKCXR)
"RTN","DIKCBLD",20,0)
 D SAVE(DIKCRTN)
"RTN","DIKCBLD",21,0)
 ;
"RTN","DIKCBLD",22,0)
 ;Final message and clean up
"RTN","DIKCBLD",23,0)
 W !!,"  Done!"
"RTN","DIKCBLD",24,0)
 W !!,"  Be sure to edit the routine to fill in the missing details,"
"RTN","DIKCBLD",25,0)
 W !,"  and to customize the call to CREIXN^DDMOD."
"RTN","DIKCBLD",26,0)
 W !
"RTN","DIKCBLD",27,0)
 K ^UTILITY($J)
"RTN","DIKCBLD",28,0)
 Q
"RTN","DIKCBLD",29,0)
 ;
"RTN","DIKCBLD",30,0)
BUILD(DIKCRTN,DIKCITL,NS,XR) ;Build routine DIKCRTN
"RTN","DIKCBLD",31,0)
 N CV
"RTN","DIKCBLD",32,0)
 K ^UTILITY($J)
"RTN","DIKCBLD",33,0)
 D AD(DIKCRTN_" ;xxxx/"_DIKCITL_"-CREATE NEW-STYLE XREF ;")
"RTN","DIKCBLD",34,0)
 D AD(" ;;1.0")
"RTN","DIKCBLD",35,0)
 D AD(" ;")
"RTN","DIKCBLD",36,0)
 D AD(" N "_NS_"XR,"_NS_"RES,"_NS_"OUT")
"RTN","DIKCBLD",37,0)
 D BC(NS,XR,"FILE",0,1)
"RTN","DIKCBLD",38,0)
 D:$P($G(^DD("IX",XR,0)),U,8)="W" BC(NS,XR,"ROOT FILE",0,9)
"RTN","DIKCBLD",39,0)
 D BC(NS,XR,"NAME",0,2)
"RTN","DIKCBLD",40,0)
 D BC(NS,XR,"TYPE",0,4)
"RTN","DIKCBLD",41,0)
 D BC(NS,XR,"USE",0,14)
"RTN","DIKCBLD",42,0)
 D BC(NS,XR,"EXECUTION",0,6)
"RTN","DIKCBLD",43,0)
 D BC(NS,XR,"ACTIVITY",0,7)
"RTN","DIKCBLD",44,0)
 D BC(NS,XR,"SHORT DESCR",0,3)
"RTN","DIKCBLD",45,0)
 D BCW(NS,XR,"DESCR",.1)
"RTN","DIKCBLD",46,0)
 D:$P($G(^DD("IX",XR,0)),U,4)="MU"
"RTN","DIKCBLD",47,0)
 . D BC(NS,XR,"SET",1)
"RTN","DIKCBLD",48,0)
 . D BC(NS,XR,"KILL",2)
"RTN","DIKCBLD",49,0)
 . D BC(NS,XR,"WHOLE KILL",2.5)
"RTN","DIKCBLD",50,0)
 D BC(NS,XR,"SET CONDITION",1.4)
"RTN","DIKCBLD",51,0)
 D BC(NS,XR,"KILL CONDITION",2.4)
"RTN","DIKCBLD",52,0)
 ;
"RTN","DIKCBLD",53,0)
 S CV=0 F  S CV=$O(^DD("IX",XR,11.1,CV)) Q:'CV  D
"RTN","DIKCBLD",54,0)
 . N ON,TP,VAL
"RTN","DIKCBLD",55,0)
 . S ON=$P($G(^DD("IX",XR,11.1,CV,0)),U) Q:'ON
"RTN","DIKCBLD",56,0)
 . S TP=$P($G(^DD("IX",XR,11.1,CV,0)),U,2)
"RTN","DIKCBLD",57,0)
 . I TP="F" D
"RTN","DIKCBLD",58,0)
 .. S VAL=$P($G(^DD("IX",XR,11.1,CV,0)),U,4) Q:'VAL
"RTN","DIKCBLD",59,0)
 .. D AD(" S "_NS_"XR(""VAL"","_ON_")="_VAL)
"RTN","DIKCBLD",60,0)
 . E  D
"RTN","DIKCBLD",61,0)
 .. S VAL=$G(^DD("IX",XR,11.1,CV,1.5)) Q:VAL=""
"RTN","DIKCBLD",62,0)
 .. D AD(" S "_NS_"XR(""VAL"","_ON_")="_$$QT(VAL))
"RTN","DIKCBLD",63,0)
 . D BCC(NS,XR,CV,ON,"SUBSCRIPT",0,6)
"RTN","DIKCBLD",64,0)
 . D BCC(NS,XR,CV,ON,"LENGTH",0,5)
"RTN","DIKCBLD",65,0)
 . D BCC(NS,XR,CV,ON,"COLLATION",0,7)
"RTN","DIKCBLD",66,0)
 . D BCC(NS,XR,CV,ON,"LOOKUP PROMPT",0,8)
"RTN","DIKCBLD",67,0)
 . D:TP="F"
"RTN","DIKCBLD",68,0)
 .. D BCC(NS,XR,CV,ON,"XFORM FOR STORAGE",2)
"RTN","DIKCBLD",69,0)
 .. D BCC(NS,XR,CV,ON,"XFORM FOR LOOKUP",4)
"RTN","DIKCBLD",70,0)
 .. D BCC(NS,XR,CV,ON,"XFORM FOR DISPLAY",3)
"RTN","DIKCBLD",71,0)
 ;
"RTN","DIKCBLD",72,0)
 D AD(" D CREIXN^DDMOD(."_NS_"XR,""SW"",."_NS_"RES,"""_NS_"OUT"")")
"RTN","DIKCBLD",73,0)
 D AD(" Q")
"RTN","DIKCBLD",74,0)
 ;
"RTN","DIKCBLD",75,0)
 Q
"RTN","DIKCBLD",76,0)
BC(NS,XR,SUB,ND,PC) ;Build code that sets an array element
"RTN","DIKCBLD",77,0)
 N VAL
"RTN","DIKCBLD",78,0)
 I $G(PC)="" S VAL=$G(^DD("IX",XR,ND))
"RTN","DIKCBLD",79,0)
 E  S VAL=$P($G(^DD("IX",XR,ND)),U,PC)
"RTN","DIKCBLD",80,0)
 Q:VAL=""
"RTN","DIKCBLD",81,0)
 D AD(" S "_NS_"XR("""_SUB_""")="_$$QT(VAL))
"RTN","DIKCBLD",82,0)
 Q
"RTN","DIKCBLD",83,0)
 ;
"RTN","DIKCBLD",84,0)
BCW(NS,XR,SUB,ND) ;Build code that sets array for wp field
"RTN","DIKCBLD",85,0)
 N I,VAL
"RTN","DIKCBLD",86,0)
 S I=0 F  S I=$O(^DD("IX",XR,ND,I)) Q:'I  D
"RTN","DIKCBLD",87,0)
 . S VAL=$G(^DD("IX",XR,ND,I,0)) S:VAL="" VAL=" "
"RTN","DIKCBLD",88,0)
 . D AD(" S "_NS_"XR("""_SUB_""","_I_")="_$$QT(VAL))
"RTN","DIKCBLD",89,0)
 Q
"RTN","DIKCBLD",90,0)
 ;
"RTN","DIKCBLD",91,0)
BCC(NS,XR,CV,ON,SUB,ND,PC) ;Build code that sets an array element
"RTN","DIKCBLD",92,0)
 N VAL
"RTN","DIKCBLD",93,0)
 I $G(PC)="" S VAL=$G(^DD("IX",XR,11.1,CV,ND))
"RTN","DIKCBLD",94,0)
 E  S VAL=$P($G(^DD("IX",XR,11.1,CV,ND)),U,PC)
"RTN","DIKCBLD",95,0)
 Q:VAL=""
"RTN","DIKCBLD",96,0)
 D AD(" S "_NS_"XR(""VAL"","_ON_","""_SUB_""")="_$$QT(VAL))
"RTN","DIKCBLD",97,0)
 Q
"RTN","DIKCBLD",98,0)
 ;
"RTN","DIKCBLD",99,0)
QT(X) ;Return string X quoted, if noncanonic
"RTN","DIKCBLD",100,0)
 Q:$G(X)="" """"""
"RTN","DIKCBLD",101,0)
 Q:X=+$E($P(X,"E"),1,15) X
"RTN","DIKCBLD",102,0)
 S X(X)="",X=$Q(X(""))
"RTN","DIKCBLD",103,0)
 Q $E(X,3,$L(X)-1)
"RTN","DIKCBLD",104,0)
 ;
"RTN","DIKCBLD",105,0)
AD(X) ;Add a routine line to ^UTILITY
"RTN","DIKCBLD",106,0)
 N LN
"RTN","DIKCBLD",107,0)
 S LN=$O(^UTILITY($J,0," "),-1)+1
"RTN","DIKCBLD",108,0)
 S ^UTILITY($J,0,LN)=X
"RTN","DIKCBLD",109,0)
 Q
"RTN","DIKCBLD",110,0)
 ;
"RTN","DIKCBLD",111,0)
SAVE(DIKCRTN) ;Save routine DIKCRTN
"RTN","DIKCBLD",112,0)
 N X,%Y
"RTN","DIKCBLD",113,0)
 S ^UTILITY($J,0,1)=^UTILITY($J,0,1)_$$NOW
"RTN","DIKCBLD",114,0)
 S X=DIKCRTN X ^DD("OS",DISYS,"ZS")
"RTN","DIKCBLD",115,0)
 W !!,$$EZBLD^DIALOG(8025,DIKCRTN)
"RTN","DIKCBLD",116,0)
 Q
"RTN","DIKCBLD",117,0)
 ;
"RTN","DIKCBLD",118,0)
ASKRTN() ;Prompt for routine name; return ^ if timeout, null, or ^
"RTN","DIKCBLD",119,0)
 N DIR,X,Y,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","DIKCBLD",120,0)
 S DIR(0)="FO^1:8^K:X?.E1.C.E!'(X?1""%""1.7AN!(X?1A1.7AN)) X"
"RTN","DIKCBLD",121,0)
 S DIR("A")="Routine name"
"RTN","DIKCBLD",122,0)
 S DIR("?",1)="  Enter the name of the routine, without the leading up-arrow, that"
"RTN","DIKCBLD",123,0)
 S DIR("?",2)="  should be built."
"RTN","DIKCBLD",124,0)
 S DIR("?",3)=""
"RTN","DIKCBLD",125,0)
 S DIR("?",4)="  Answer must be 1-8 characters in length. It must begin with % or a"
"RTN","DIKCBLD",126,0)
 S DIR("?")="  letter, followed by a combination of letters and numbers."
"RTN","DIKCBLD",127,0)
 F  D  Q:$G(DIKCRTN)]""
"RTN","DIKCBLD",128,0)
 . D ^DIR I $D(DIRUT) S DIKCRTN=U Q
"RTN","DIKCBLD",129,0)
 . S DIKCRTN=X
"RTN","DIKCBLD",130,0)
 . X ^%ZOSF("TEST") E  Q
"RTN","DIKCBLD",131,0)
 . Q:$$ASKREPL(DIKCRTN)
"RTN","DIKCBLD",132,0)
 . S DIKCRTN=""
"RTN","DIKCBLD",133,0)
 Q $G(DIKCRTN)
"RTN","DIKCBLD",134,0)
 ;
"RTN","DIKCBLD",135,0)
ASKREPL(DIKCRTN) ;Ask whether to replace the existing routine
"RTN","DIKCBLD",136,0)
 N DIR,X,Y,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","DIKCBLD",137,0)
 S DIR(0)="YO"
"RTN","DIKCBLD",138,0)
 S DIR("A")="  Do you wish to replace routine "_DIKCRTN
"RTN","DIKCBLD",139,0)
 S DIR("B")="NO"
"RTN","DIKCBLD",140,0)
 S DIR("?")="    Answer yes if you wish to replace routine "_DIKCRTN_" with a new version."
"RTN","DIKCBLD",141,0)
 W !!,"  Routine "_DIKCRTN_" already exists."
"RTN","DIKCBLD",142,0)
 D ^DIR W !
"RTN","DIKCBLD",143,0)
 Q Y
"RTN","DIKCBLD",144,0)
 ;
"RTN","DIKCBLD",145,0)
ASKITL() ;Ask for programmer initials
"RTN","DIKCBLD",146,0)
 N DIR,X,Y,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","DIKCBLD",147,0)
 S DIR(0)="FO^1:15"
"RTN","DIKCBLD",148,0)
 S DIR("A")="Programmer initials"
"RTN","DIKCBLD",149,0)
 S DIR("?",1)="  Enter your initials, which will appear on the first line of the"
"RTN","DIKCBLD",150,0)
 S DIR("?")="  routine."
"RTN","DIKCBLD",151,0)
 D ^DIR
"RTN","DIKCBLD",152,0)
 Q Y
"RTN","DIKCBLD",153,0)
 ;
"RTN","DIKCBLD",154,0)
ASKNMSP() ;Prompt for a namespace
"RTN","DIKCBLD",155,0)
 N DIR,X,Y,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","DIKCBLD",156,0)
 S DIR(0)="FO^1:4^K:X?.E1.C.E!'(X?1""%""1.3AN!(X?1A1.3AN)) X"
"RTN","DIKCBLD",157,0)
 S DIR("A")="Namespace to use for local variables"
"RTN","DIKCBLD",158,0)
 S DIR("?",1)="  All variables used in the generated routine will start with the namespace"
"RTN","DIKCBLD",159,0)
 S DIR("?",2)="  you choose."
"RTN","DIKCBLD",160,0)
 S DIR("?",3)=""
"RTN","DIKCBLD",161,0)
 S DIR("?",4)="  Answer must be 1-4 characters in length. It must begin with % or a"
"RTN","DIKCBLD",162,0)
 S DIR("?")="  letter, followed by a combination of letters and numbers."
"RTN","DIKCBLD",163,0)
 D ^DIR
"RTN","DIKCBLD",164,0)
 Q Y
"RTN","DIKCBLD",165,0)
 ;
"RTN","DIKCBLD",166,0)
ASKXR() ;Prompt for file/xref
"RTN","DIKCBLD",167,0)
 N DIKCCNT,DIKCROOT,DIKCTOP,DIKCFILE,DDS1,D,DIC,X,Y
"RTN","DIKCBLD",168,0)
 S DDS1="CROSS-REFERENCE FROM" D W^DICRW Q:Y<0 ""
"RTN","DIKCBLD",169,0)
 S DIKCTOP=+$P($G(@(DIC_"0)")),U,2) Q:'DIKCTOP ""
"RTN","DIKCBLD",170,0)
 S DIKCFILE=$$SUB^DIKCU(DIKCTOP)
"RTN","DIKCBLD",171,0)
 ;
"RTN","DIKCBLD",172,0)
 D GETXR^DIKCUTL2(DIKCFILE,.DIKCCNT)
"RTN","DIKCBLD",173,0)
 W ! D LIST^DIKCUTL2(.DIKCCNT)
"RTN","DIKCBLD",174,0)
 Q $$CHOOSE^DIKCUTL2(.DIKCCNT,"to build a routine for")
"RTN","DIKCBLD",175,0)
 ;
"RTN","DIKCBLD",176,0)
NOW() ;Return current time in external form
"RTN","DIKCBLD",177,0)
 N %,%I,%H,AP,HR,MIN,MON,TIM,X
"RTN","DIKCBLD",178,0)
 D NOW^%DTC
"RTN","DIKCBLD",179,0)
 S TIM=$P(%,".",2)
"RTN","DIKCBLD",180,0)
 S HR=$E(TIM,1,2)
"RTN","DIKCBLD",181,0)
 S AP=$S(HR<12:"AM",1:"PM")
"RTN","DIKCBLD",182,0)
 S HR=$S(HR<13:+HR,1:HR#12)
"RTN","DIKCBLD",183,0)
 S MIN=$E(TIM_"0000",3,4)
"RTN","DIKCBLD",184,0)
 ;
"RTN","DIKCBLD",185,0)
 S MON=$P("Jan^Feb^Mar^Apr^May^Jun^Jul^Aug^Sep^Oct^Nov^Dec",U,%I(1))
"RTN","DIKCBLD",186,0)
 Q HR_":"_MIN_" "_AP_"  "_%I(2)_" "_MON_" "_(%I(3)+1700)
"RTN","DIKCDD")
0^2^B1225005
"RTN","DIKCDD",1,0)
DIKCDD ;SFISC/MKO-DATA DICTIONARY CODE FOR INDEX AND KEY FILES ;3:02 PM  5 Dec 2001
"RTN","DIKCDD",2,0)
 ;;22.0;VA FileMan;**11,95**;Mar 30, 1999
"RTN","DIKCDD",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKCDD",4,0)
ITFLD ;Input transform for field
"RTN","DIKCDD",5,0)
 Q:'$D(DA)!'$D(DA(1))!'$D(DDS)
"RTN","DIKCDD",6,0)
 N DIKCFILE
"RTN","DIKCDD",7,0)
 S DIKCFILE=$$GETFILE(.DA) I 'DIKCFILE K X Q
"RTN","DIKCDD",8,0)
 ;
"RTN","DIKCDD",9,0)
 N %,D,D0,DA,DDD,DIC,DICR,DIX,DO,DP,DZ,Y
"RTN","DIKCDD",10,0)
 S DIC="^DD("_DIKCFILE_",",DIC(0)="EN"
"RTN","DIKCDD",11,0)
 S DIC("S")="I '$P(^(0),U,2)&($P(^(0),U,2)'[""C"")"
"RTN","DIKCDD",12,0)
 D ^DIC
"RTN","DIKCDD",13,0)
 I Y'>0 K X
"RTN","DIKCDD",14,0)
 E  S X=+$P(Y,"E")
"RTN","DIKCDD",15,0)
 Q
"RTN","DIKCDD",16,0)
 ;
"RTN","DIKCDD",17,0)
EHFLD ;Executable help for field
"RTN","DIKCDD",18,0)
 Q:'$D(DA)!'$D(DA(1))!'$D(DDS)
"RTN","DIKCDD",19,0)
 N DIKCFILE
"RTN","DIKCDD",20,0)
 S DIKCFILE=$$GETFILE(.DA) Q:'DIKCFILE
"RTN","DIKCDD",21,0)
 ;
"RTN","DIKCDD",22,0)
 N %,D,D0,DA,DDD,DIC,DICR,DIX,DO,DP,Y
"RTN","DIKCDD",23,0)
 S DIC="^DD("_DIKCFILE_",",DIC(0)="",D="B"
"RTN","DIKCDD",24,0)
 S DIC("S")="I '$P(^(0),U,2)&($P(^(0),U,2)'[""C"")"
"RTN","DIKCDD",25,0)
 S:$G(X)="??" DZ=X
"RTN","DIKCDD",26,0)
 D DQ^DICQ
"RTN","DIKCDD",27,0)
 Q
"RTN","DIKCDD",28,0)
 ;
"RTN","DIKCDD",29,0)
GETFILE(DA) ;
"RTN","DIKCDD",30,0)
 Q:'$D(DA)!'$D(DA(1))!'$D(DDS)
"RTN","DIKCDD",31,0)
 N DIKCFILE
"RTN","DIKCDD",32,0)
 S DIKCFILE=$$GET^DDSVAL(.114,.DA,2)
"RTN","DIKCDD",33,0)
 Q DIKCFILE
"RTN","DIKCR")
0^3^B67682296
"RTN","DIKCR",1,0)
DIKCR ;SFISC/MKO-API TO CREATE A NEW-STYLE XREF ;9:55 AM  1 Nov 2002
"RTN","DIKCR",2,0)
 ;;22.0;VA FileMan;**95**;Mar 30, 1999
"RTN","DIKCR",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKCR",4,0)
 ;
"RTN","DIKCR",5,0)
CREIXN(DIKCXREF,DIFLG,DIXR,DIKCOUT,DIKCMSG) ;Create a new-style index
"RTN","DIKCR",6,0)
 ;DIFLG:
"RTN","DIKCR",7,0)
 ; e : Throw away Dialog errors
"RTN","DIKCR",8,0)
 ; r : Don't recompile templates, xrefs
"RTN","DIKCR",9,0)
 ; W : Write messages to the current device
"RTN","DIKCR",10,0)
 ; S : Execute set logic of new xref
"RTN","DIKCR",11,0)
 ;
"RTN","DIKCR",12,0)
CREIXNX ;Entry point from DDMOD
"RTN","DIKCR",13,0)
 N DIKCDEL,DIKCXR,DIKCDMSG,DIKCERR,X,Y
"RTN","DIKCR",14,0)
 ;
"RTN","DIKCR",15,0)
 ;Init
"RTN","DIKCR",16,0)
 S DIFLG=$G(DIFLG)
"RTN","DIKCR",17,0)
 I DIFLG["e" S DIKCMSG="DIKCDMSG" N DIERR
"RTN","DIKCR",18,0)
 I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DIKCR",19,0)
 S DIKCDEL=$G(DIKCXREF("NAME"))]""
"RTN","DIKCR",20,0)
 M DIKCXR=DIKCXREF
"RTN","DIKCR",21,0)
 ;
"RTN","DIKCR",22,0)
 ;Check input, set defaults
"RTN","DIKCR",23,0)
 D CHK(.DIKCXR,.DIKCERR) G:DIKCERR EXIT
"RTN","DIKCR",24,0)
 D CHKVAL(.DIKCXR,.DIKCERR) G:DIKCERR EXIT
"RTN","DIKCR",25,0)
 ;
"RTN","DIKCR",26,0)
 ;Delete the old index of the same name
"RTN","DIKCR",27,0)
 D:DIKCDEL
"RTN","DIKCR",28,0)
 . N DIKCFLAG,DIERR,DIKCDMSG
"RTN","DIKCR",29,0)
 . S DIKCFLAG="d"_$E("W",DIFLG["W")_$E("K",DIFLG'["k")
"RTN","DIKCR",30,0)
 . D DELIXN^DDMOD(DIKCXR("FILE"),DIKCXR("NAME"),DIKCFLAG,"","DIKCDMSG")
"RTN","DIKCR",31,0)
 ;
"RTN","DIKCR",32,0)
 ;Create the index
"RTN","DIKCR",33,0)
 D UPDATE(.DIKCXR,.DIXR,DIFLG) I DIXR="" S DIKCERR=1 G EXIT
"RTN","DIKCR",34,0)
 ;
"RTN","DIKCR",35,0)
 ;Execute set logic
"RTN","DIKCR",36,0)
 D:DIFLG["S" SET(DIXR,DIFLG)
"RTN","DIKCR",37,0)
 ;
"RTN","DIKCR",38,0)
 ;Recompile templates and xrefs
"RTN","DIKCR",39,0)
 D:DIFLG'["r" RECOMP(DIXR,DIFLG)
"RTN","DIKCR",40,0)
 ;
"RTN","DIKCR",41,0)
EXIT ;Write and move error messages if necessary
"RTN","DIKCR",42,0)
 I $G(DIERR) D
"RTN","DIKCR",43,0)
 . D:DIFLG["W" MSG^DIALOG("WES")
"RTN","DIKCR",44,0)
 . D:$G(DIKCMSG)]"" CALLOUT^DIEFU(DIKCMSG)
"RTN","DIKCR",45,0)
 I $G(DIKCERR) S DIXR=""
"RTN","DIKCR",46,0)
 E  S DIXR=DIXR_U_DIKCXR("NAME")
"RTN","DIKCR",47,0)
 Q
"RTN","DIKCR",48,0)
 ;
"RTN","DIKCR",49,0)
UPDATE(DIKCXR,DIXR,DIFLG) ;Call Updater to create index, return DIXR=ien
"RTN","DIKCR",50,0)
 N DIKCFDA,DIKCIEN,IENS,ORD,R,SEQ,X
"RTN","DIKCR",51,0)
 W:$G(DIFLG)["W" !,"Creating index definition ..."
"RTN","DIKCR",52,0)
 ;
"RTN","DIKCR",53,0)
 ;Set FDA for top level Index file fields
"RTN","DIKCR",54,0)
 S DIKCFDA(.11,"+1,",.01)=DIKCXR("FILE")
"RTN","DIKCR",55,0)
 S DIKCFDA(.11,"+1,",.02)=DIKCXR("NAME")
"RTN","DIKCR",56,0)
 S DIKCFDA(.11,"+1,",.11)=DIKCXR("SHORT DESCR")
"RTN","DIKCR",57,0)
 S DIKCFDA(.11,"+1,",.2)=DIKCXR("TYPE")
"RTN","DIKCR",58,0)
 S DIKCFDA(.11,"+1,",.4)=DIKCXR("EXECUTION")
"RTN","DIKCR",59,0)
 S DIKCFDA(.11,"+1,",.41)=DIKCXR("ACTIVITY")
"RTN","DIKCR",60,0)
 S DIKCFDA(.11,"+1,",.42)=DIKCXR("USE")
"RTN","DIKCR",61,0)
 S DIKCFDA(.11,"+1,",.5)=DIKCXR("ROOT TYPE")
"RTN","DIKCR",62,0)
 S DIKCFDA(.11,"+1,",.51)=DIKCXR("ROOT FILE")
"RTN","DIKCR",63,0)
 S DIKCFDA(.11,"+1,",1.1)=$S($G(DIKCXR("SET"))]"":DIKCXR("SET"),1:"Q")
"RTN","DIKCR",64,0)
 S DIKCFDA(.11,"+1,",2.1)=$S($G(DIKCXR("KILL"))]"":DIKCXR("KILL"),1:"Q")
"RTN","DIKCR",65,0)
 S:$G(DIKCXR("SET CONDITION"))]"" DIKCFDA(.11,"+1,",1.4)=DIKCXR("SET CONDITION")
"RTN","DIKCR",66,0)
 S:$G(DIKCXR("KILL CONDITION"))]"" DIKCFDA(.11,"+1,",2.4)=DIKCXR("KILL CONDITION")
"RTN","DIKCR",67,0)
 S:$G(DIKCXR("WHOLE KILL"))]"" DIKCFDA(.11,"+1,",2.5)=DIKCXR("WHOLE KILL")
"RTN","DIKCR",68,0)
 ;
"RTN","DIKCR",69,0)
 ;Set FDA for Values multiple
"RTN","DIKCR",70,0)
 S ORD=0 F SEQ=2:1 S ORD=$O(DIKCXR("VAL",ORD)) Q:'ORD  D
"RTN","DIKCR",71,0)
 . S IENS="+"_SEQ_",+1,"
"RTN","DIKCR",72,0)
 . S R=$NA(DIKCXR("VAL",ORD))
"RTN","DIKCR",73,0)
 . S DIKCFDA(.114,IENS,.01)=ORD
"RTN","DIKCR",74,0)
 . S DIKCFDA(.114,IENS,1)=@R@("TYPE")
"RTN","DIKCR",75,0)
 . ;
"RTN","DIKCR",76,0)
 . I @R@("TYPE")="C" S DIKCFDA(.114,IENS,4.5)=@R
"RTN","DIKCR",77,0)
 . E  D
"RTN","DIKCR",78,0)
 .. S DIKCFDA(.114,IENS,2)=DIKCXR("ROOT FILE")
"RTN","DIKCR",79,0)
 .. S DIKCFDA(.114,IENS,3)=@R
"RTN","DIKCR",80,0)
 .. S X=$G(@R@("XFORM FOR STORAGE")) S:X]"" DIKCFDA(.114,IENS,5)=X
"RTN","DIKCR",81,0)
 .. S X=$G(@R@("XFORM FOR LOOKUP")) S:X]"" DIKCFDA(.114,IENS,5.3)=X
"RTN","DIKCR",82,0)
 .. S X=$G(@R@("XFORM FOR DISPLAY")) S:X]"" DIKCFDA(.114,IENS,5.5)=X
"RTN","DIKCR",83,0)
 . ;
"RTN","DIKCR",84,0)
 . S X=$G(@R@("SUBSCRIPT")) S:X]"" DIKCFDA(.114,IENS,.5)=X
"RTN","DIKCR",85,0)
 . S X=$G(@R@("LENGTH")) S:X]"" DIKCFDA(.114,IENS,6)=X
"RTN","DIKCR",86,0)
 . S X=$G(@R@("COLLATION")) S:X]"" DIKCFDA(.114,IENS,7)=X
"RTN","DIKCR",87,0)
 . S X=$G(@R@("LOOKUP PROMPT")) S:X]"" DIKCFDA(.114,IENS,8)=X
"RTN","DIKCR",88,0)
 ;
"RTN","DIKCR",89,0)
 ;Call Updater
"RTN","DIKCR",90,0)
 D UPDATE^DIE("E","DIKCFDA","DIKCIEN")
"RTN","DIKCR",91,0)
 K DIXR I $G(DIERR) S DIXR="" Q
"RTN","DIKCR",92,0)
 S DIXR=DIKCIEN(1)
"RTN","DIKCR",93,0)
 ;
"RTN","DIKCR",94,0)
 ;Add Description
"RTN","DIKCR",95,0)
 D:$O(DIKCXR("DESCR",0)) WP^DIE(.11,DIXR_",",.1,"",$NA(DIKCXR("DESCR")))
"RTN","DIKCR",96,0)
 Q
"RTN","DIKCR",97,0)
 ;
"RTN","DIKCR",98,0)
RECOMP(DIXR,DIFLG) ;Recompile templates and xrefs, update triggering fields
"RTN","DIKCR",99,0)
 N DIKCFLIS,DIKCI,DIKCTLIS,DIKCTOP,DIKTEML
"RTN","DIKCR",100,0)
 ;
"RTN","DIKCR",101,0)
 ;Get top level file number
"RTN","DIKCR",102,0)
 S DIKCTOP=$$FNO^DILIBF($P($G(^DD("IX",DIXR,0)),U)) Q:'DIKCTOP
"RTN","DIKCR",103,0)
 ;
"RTN","DIKCR",104,0)
 ;Get list of fields in xref
"RTN","DIKCR",105,0)
 D GETFLIST^DIKCUTL(DIXR,.DIKCFLIS) Q:'$D(DIKCFLIS)
"RTN","DIKCR",106,0)
 ;
"RTN","DIKCR",107,0)
 ;Recompile input templates and xrefs
"RTN","DIKCR",108,0)
 D DIEZ^DIKD2(.DIKCFLIS,DIFLG,$G(DIKCOUT))
"RTN","DIKCR",109,0)
 D DIKZ^DIKD(DIKCTOP,DIFLG,$G(DIKCOUT)) S DIKCTOP(DIKCTOP)=""
"RTN","DIKCR",110,0)
 ;
"RTN","DIKCR",111,0)
 ;Also update triggering fields, and their compiled templates and xrefs
"RTN","DIKCR",112,0)
 D TRIG^DICR(.DIKCFLIS,.DIKCTLIS)
"RTN","DIKCR",113,0)
 I $D(DIKCTLIS) D
"RTN","DIKCR",114,0)
 . D DIEZ^DIKD2(.DIKCTLIS,DIFLG,$G(DIKCOUT))
"RTN","DIKCR",115,0)
 . S DIKCI=0 F  S DIKCI=$O(DIKCTLIS(DIKCI)) Q:'DIKCI  D
"RTN","DIKCR",116,0)
 .. S DIKCTOP=+$$FNO^DILIBF(DIKCI) Q:$D(DIKCTOP(DIKCTOP))#2!'DIKCTOP
"RTN","DIKCR",117,0)
 .. S DIKCTOP(DIKCTOP)=""
"RTN","DIKCR",118,0)
 .. D DIKZ^DIKD(DIKCTOP,DIFLG,$G(DIKCOUT))
"RTN","DIKCR",119,0)
 Q
"RTN","DIKCR",120,0)
 ;
"RTN","DIKCR",121,0)
CHK(DIKCXR,DIKCERR) ;Check/default input array
"RTN","DIKCR",122,0)
 N FIL,NAM,RFIL,TYP,USE
"RTN","DIKCR",123,0)
 S DIKCERR=0
"RTN","DIKCR",124,0)
 ;
"RTN","DIKCR",125,0)
 ;Check FILE
"RTN","DIKCR",126,0)
 S FIL=$G(DIKCXR("FILE")) I 'FIL D ER202("FILE") Q
"RTN","DIKCR",127,0)
 I '$$VFNUM^DIKCU1(FIL,"D") S DIKCERR=1 Q
"RTN","DIKCR",128,0)
 ;
"RTN","DIKCR",129,0)
 ;Check Type, get internal form
"RTN","DIKCR",130,0)
 S TYP=$G(DIKCXR("TYPE")) I TYP="" D ER202("TYPE") Q
"RTN","DIKCR",131,0)
 D CHK^DIE(.11,.2,"",TYP,.TYP) I TYP=U S DIKCERR=1 Q
"RTN","DIKCR",132,0)
 S DIKCXR("TYPE")=TYP
"RTN","DIKCR",133,0)
 ;
"RTN","DIKCR",134,0)
 ;Check USE, get internal form.
"RTN","DIKCR",135,0)
 S USE=$G(DIKCXR("USE"))
"RTN","DIKCR",136,0)
 I USE]"" D CHK^DIE(.11,.42,"",USE,.USE) I USE=U S DIKCERR=1 Q
"RTN","DIKCR",137,0)
 S DIKCXR("USE")=USE
"RTN","DIKCR",138,0)
 ;
"RTN","DIKCR",139,0)
 S NAM=$G(DIKCXR("NAME"))
"RTN","DIKCR",140,0)
 S RFIL=$G(DIKCXR("ROOT FILE"))
"RTN","DIKCR",141,0)
 ;
"RTN","DIKCR",142,0)
 ;Check Root File, set Root Type
"RTN","DIKCR",143,0)
 S:'RFIL (RFIL,DIKCXR("ROOT FILE"))=FIL
"RTN","DIKCR",144,0)
 I FIL=RFIL S DIKCXR("ROOT TYPE")="I"
"RTN","DIKCR",145,0)
 E  D  Q:DIKCERR
"RTN","DIKCR",146,0)
 . I $$FLEVDIFF^DIKCU(FIL,RFIL)="" D ER202("ROOT FILE") Q
"RTN","DIKCR",147,0)
 . I '$$VFNUM^DIKCU1(RFIL,"D") S DIKCERR=1 Q
"RTN","DIKCR",148,0)
 . S DIKCXR("ROOT TYPE")="W"
"RTN","DIKCR",149,0)
 ;
"RTN","DIKCR",150,0)
 ;Check USE, NAME, TYPE
"RTN","DIKCR",151,0)
 I NAM="",USE="" D ER202("NAME/USE") Q
"RTN","DIKCR",152,0)
 I $E(NAM)="A",USE="LS" D ER202("NAME/USE") Q
"RTN","DIKCR",153,0)
 I USE="A",TYP'="MU" D ER202("TYPE/USE") Q
"RTN","DIKCR",154,0)
 ;
"RTN","DIKCR",155,0)
 ;Default NAM based on USE and FILE
"RTN","DIKCR",156,0)
 ; or USE based on NAME and TYPE
"RTN","DIKCR",157,0)
 I NAM="" S DIKCXR("NAME")=$$GETNAM(FIL,USE)
"RTN","DIKCR",158,0)
 E  I USE="" S DIKCXR("USE")=$S($E(NAM)="A":$S(TYP="MU":"A",1:"S"),1:"LS")
"RTN","DIKCR",159,0)
 ;
"RTN","DIKCR",160,0)
 ;Check SHORT DESCRIPTION'=null', if null set default Activity
"RTN","DIKCR",161,0)
 I $G(DIKCXR("SHORT DESCR"))="" D ER202("SHORT DESCR") Q
"RTN","DIKCR",162,0)
 S:$D(DIKCXR("ACTIVITY"))[0 DIKCXR("ACTIVITY")="IR"
"RTN","DIKCR",163,0)
 Q
"RTN","DIKCR",164,0)
 ;
"RTN","DIKCR",165,0)
CHKVAL(DIKCXR,DIKCERR) ;Check values, build logic for regular indexes
"RTN","DIKCR",166,0)
 N CNT,FCNT,FIL,KILL,L,LEV,LDIF,MAXL,NAM,ORD,RFIL,ROOT,SBSC,SEQ,SET,TYP,VAL,WKIL
"RTN","DIKCR",167,0)
 ;
"RTN","DIKCR",168,0)
 S FIL=DIKCXR("FILE")
"RTN","DIKCR",169,0)
 S NAM=DIKCXR("NAME")
"RTN","DIKCR",170,0)
 S RFIL=DIKCXR("ROOT FILE")
"RTN","DIKCR",171,0)
 S TYP=DIKCXR("TYPE")
"RTN","DIKCR",172,0)
 S DIKCERR=0
"RTN","DIKCR",173,0)
 ;
"RTN","DIKCR",174,0)
 ;Begin building logic for regular indexes
"RTN","DIKCR",175,0)
 I TYP="R" D  Q:DIKCERR
"RTN","DIKCR",176,0)
 . I FIL'=RFIL S LDIF=$$FLEVDIFF^DIKCU(FIL,RFIL)
"RTN","DIKCR",177,0)
 . E  S LDIF=0
"RTN","DIKCR",178,0)
 . S ROOT=$$FROOTDA^DIKCU(FIL,LDIF_"O",.LEV)_""""_NAM_""""
"RTN","DIKCR",179,0)
 . I $D(DIERR) S DIKCERR=1 Q
"RTN","DIKCR",180,0)
 . S WKIL="K "_ROOT_")"
"RTN","DIKCR",181,0)
 ;
"RTN","DIKCR",182,0)
 ;Build list of subscripts, count #values and #fields
"RTN","DIKCR",183,0)
 S ORD=0 F  S ORD=$O(DIKCXR("VAL",ORD)) Q:'ORD  D  Q:DIKCERR
"RTN","DIKCR",184,0)
 . I $G(DIKCXR("VAL",ORD))="" K DIKCXR("VAL",ORD) Q
"RTN","DIKCR",185,0)
 . S CNT=$G(CNT)+1
"RTN","DIKCR",186,0)
 . ;
"RTN","DIKCR",187,0)
 . ;Get type of value; if field, increment field count
"RTN","DIKCR",188,0)
 . I DIKCXR("VAL",ORD) S DIKCXR("VAL",ORD,"TYPE")="F",FCNT=$G(FCNT)+1
"RTN","DIKCR",189,0)
 . E  S DIKCXR("VAL",ORD,"TYPE")="C"
"RTN","DIKCR",190,0)
 . ;
"RTN","DIKCR",191,0)
 . ;Set subscript array; error if duplicate subscript #
"RTN","DIKCR",192,0)
 . S SBSC=$G(DIKCXR("VAL",ORD,"SUBSCRIPT")) Q:'SBSC
"RTN","DIKCR",193,0)
 . I $D(SBSC(SBSC))#2 D ER202("SUBSCRIPT") Q
"RTN","DIKCR",194,0)
 . S SBSC(SBSC)=ORD_U_$G(DIKCXR("VAL",ORD,"LENGTH"))
"RTN","DIKCR",195,0)
 . ;
"RTN","DIKCR",196,0)
 . ;Set default collation
"RTN","DIKCR",197,0)
 . S:$G(DIKCXR("VAL",ORD,"COLLATION"))="" DIKCXR("VAL",ORD,"COLLATION")="F"
"RTN","DIKCR",198,0)
 Q:DIKCERR
"RTN","DIKCR",199,0)
 ;
"RTN","DIKCR",200,0)
 S SBSC=0 F SEQ=1:1 S SBSC=$O(SBSC(SBSC)) Q:'SBSC  D  Q:DIKCERR
"RTN","DIKCR",201,0)
 . ;Check that subscripts are consecutive from 1
"RTN","DIKCR",202,0)
 . I SEQ'=SBSC D ER202("SUBSCRIPTS") Q
"RTN","DIKCR",203,0)
 . Q:TYP="MU"
"RTN","DIKCR",204,0)
 . ;
"RTN","DIKCR",205,0)
 . ;Continue building logic for regular indexes
"RTN","DIKCR",206,0)
 . S ORD=$P(SBSC(SBSC),U),MAXL=$P(SBSC(SBSC),U,2)
"RTN","DIKCR",207,0)
 . I $G(CNT)=1 S VAL=$S(MAXL:"$E(X,1,"_MAXL_")",1:"X")
"RTN","DIKCR",208,0)
 . E  S VAL=$S(MAXL:"$E(X("_ORD_"),1,"_MAXL_")",1:"X("_ORD_")")
"RTN","DIKCR",209,0)
 . S ROOT=ROOT_","_VAL
"RTN","DIKCR",210,0)
 ;
"RTN","DIKCR",211,0)
 ;If null, default Execution based on #fields
"RTN","DIKCR",212,0)
 S:$G(DIKCXR("EXECUTION"))="" DIKCXR("EXECUTION")=$S($G(FCNT)>1:"R",1:"F")
"RTN","DIKCR",213,0)
 ;
"RTN","DIKCR",214,0)
 ;We're done for MUMPS xrefs
"RTN","DIKCR",215,0)
 Q:TYP="MU"
"RTN","DIKCR",216,0)
 ;
"RTN","DIKCR",217,0)
 ;Continue building logic for regular indexes
"RTN","DIKCR",218,0)
 F L=LDIF:-1:1 S ROOT=ROOT_",DA("_L_")"
"RTN","DIKCR",219,0)
 S ROOT=ROOT_",DA)"
"RTN","DIKCR",220,0)
 ;
"RTN","DIKCR",221,0)
 I '$O(SBSC(0)) S (SET,KILL)="Q",WKIL=""
"RTN","DIKCR",222,0)
 E  S SET="S "_ROOT_"=""""",KILL="K "_ROOT
"RTN","DIKCR",223,0)
 S DIKCXR("SET")=SET
"RTN","DIKCR",224,0)
 S DIKCXR("KILL")=KILL
"RTN","DIKCR",225,0)
 S DIKCXR("WHOLE KILL")=WKIL
"RTN","DIKCR",226,0)
 Q
"RTN","DIKCR",227,0)
 ;
"RTN","DIKCR",228,0)
GETNAM(F01,USE) ;Get next available index name
"RTN","DIKCR",229,0)
 N ASC,STRT,NAME,I
"RTN","DIKCR",230,0)
 S STRT=$S(USE="LS":"",1:"A")
"RTN","DIKCR",231,0)
 F ASC=67:1:89 D  Q:NAME]""
"RTN","DIKCR",232,0)
 . S NAME=STRT_$C(ASC)
"RTN","DIKCR",233,0)
 . I $D(^DD("IX","BB",F01,NAME)) S NAME="" Q
"RTN","DIKCR",234,0)
 . I $D(^DD(F01,0,"IX",NAME)) S NAME="" Q
"RTN","DIKCR",235,0)
 Q:NAME]"" NAME
"RTN","DIKCR",236,0)
 ;
"RTN","DIKCR",237,0)
 F I=1:1 D  Q:NAME]""
"RTN","DIKCR",238,0)
 . S NAME=STRT_"C"_I
"RTN","DIKCR",239,0)
 . I $D(^DD("IX","BB",F01,NAME)) S NAME="" Q
"RTN","DIKCR",240,0)
 . I $D(^DD(F01,0,"IX",NAME)) S NAME="" Q
"RTN","DIKCR",241,0)
 Q NAME
"RTN","DIKCR",242,0)
 ;
"RTN","DIKCR",243,0)
SET(DIXR,DIFLG) ;Execute set logic
"RTN","DIKCR",244,0)
 N DIKCRFIL,DIKCTOP,DIKCTRL,DIKCTYP
"RTN","DIKCR",245,0)
 ;
"RTN","DIKCR",246,0)
 S DIKCTOP=$$FNO^DILIBF($P($G(^DD("IX",DIXR,0)),U)) Q:'DIKCTOP
"RTN","DIKCR",247,0)
 S DIKCRFIL=$P($G(^DD("IX",DIXR,0)),U,9) Q:'DIKCRFIL
"RTN","DIKCR",248,0)
 S DIKCTYP=$P($G(^DD("IX",DIXR,0)),U,4)
"RTN","DIKCR",249,0)
 ;
"RTN","DIKCR",250,0)
 I $G(DIFLG)["W" D
"RTN","DIKCR",251,0)
 . I DIKCTYP="R" W !,"Building index ..."
"RTN","DIKCR",252,0)
 . E  W !,"Executing set logic ..."
"RTN","DIKCR",253,0)
 ;
"RTN","DIKCR",254,0)
 ;Call INDEX^DIKC to execute the set logic
"RTN","DIKCR",255,0)
 S DIKCTRL="S"_$S(DIKCTOP'=DIKCRFIL:"W"_DIKCRFIL,1:"")
"RTN","DIKCR",256,0)
 D INDEX^DIKC(DIKCTOP,"","",DIXR,.DIKCTRL)
"RTN","DIKCR",257,0)
 Q
"RTN","DIKCR",258,0)
 ;
"RTN","DIKCR",259,0)
ER202(DIKCP1) ;;The input variable or parameter that identifies the |1| is missing or invalid.
"RTN","DIKCR",260,0)
 D ERR^DIKCU2(202,"","","",DIKCP1)
"RTN","DIKCR",261,0)
 S DIKCERR=1
"RTN","DIKCR",262,0)
 Q
"RTN","DIKD")
0^4^B11219173
"RTN","DIKD",1,0)
DIKD ;SFISC/MKO-DELETE A CROSS REFERENCE ;9:14 AM  19 Dec 2001
"RTN","DIKD",2,0)
 ;;22.0;VA FileMan;**12,68,95**;Mar 30, 1999
"RTN","DIKD",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKD",4,0)
 ;
"RTN","DIKD",5,0)
DELIX(DIFIL,DIFLD,DIXR,DIFLG,DIKDOUT,DIKDMSG) ;Delete traditional xref
"RTN","DIKD",6,0)
DELIXX ;Come here from DELIX^DDMOD
"RTN","DIKD",7,0)
 N %,DIC,X,Y,DIF,DIFINFO,DIQUIT
"RTN","DIKD",8,0)
 ;
"RTN","DIKD",9,0)
 ;Init
"RTN","DIKD",10,0)
 I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DIKD",11,0)
 S DIFLG=$G(DIFLG)
"RTN","DIKD",12,0)
 S DIF=$E("D",DIFLG'["d")
"RTN","DIKD",13,0)
 I DIFLG'["c" D CHK G:$G(DIQUIT) END
"RTN","DIKD",14,0)
 D FINFO^DIKCU1(DIFIL,.DIFINFO)
"RTN","DIKD",15,0)
 ;
"RTN","DIKD",16,0)
 ;Delete data in index
"RTN","DIKD",17,0)
 D:DIFLG["K" KILL^DIKD1(DIFIL,DIFLD,DIXR,$E("W",DIFLG["W")_DIF_"c")
"RTN","DIKD",18,0)
 ;
"RTN","DIKD",19,0)
 ;Audit, delete xref, recompile
"RTN","DIKD",20,0)
 D:$G(^DD(+DIFINFO(0),0,"DDA"))["Y" AUDIT
"RTN","DIKD",21,0)
 D DELDEF(DIFIL,DIFLD,DIXR,DIFLG)
"RTN","DIKD",22,0)
 D DIEZ(DIFIL,DIFLD,DIFLG,$G(DIKDOUT))
"RTN","DIKD",23,0)
 D DIKZ(+DIFINFO(0),DIFLG,$G(DIKDOUT))
"RTN","DIKD",24,0)
 ;
"RTN","DIKD",25,0)
END ;Move error message if necessary and quit
"RTN","DIKD",26,0)
 D:$G(DIKDMSG)]"" CALLOUT^DIEFU(DIKDMSG)
"RTN","DIKD",27,0)
 Q
"RTN","DIKD",28,0)
 ;
"RTN","DIKD",29,0)
DELDEF(DIFIL,DIFLD,DIXR,DIFLG) ;Delete index definition
"RTN","DIKD",30,0)
 N DIK,DA,DITYP
"RTN","DIKD",31,0)
 S DITYP=$P($G(^DD(DIFIL,DIFLD,1,DIXR,0)),U,3)
"RTN","DIKD",32,0)
 K:DITYP="SOUNDEX" ^DD(DIFIL,0,"LOOK"),^("QUES")
"RTN","DIKD",33,0)
 ;
"RTN","DIKD",34,0)
 W:$G(DIFLG)["W" !,"Deleting cross-reference definition ..."
"RTN","DIKD",35,0)
 S ^DD(DIFIL,DIFLD,1,0)="^.1"
"RTN","DIKD",36,0)
 S DIK="^DD("_DIFIL_","_DIFLD_",1,"
"RTN","DIKD",37,0)
 S DA(2)=DIFIL,DA(1)=DIFLD,DA=DIXR
"RTN","DIKD",38,0)
 D ^DIK
"RTN","DIKD",39,0)
 Q
"RTN","DIKD",40,0)
 ;
"RTN","DIKD",41,0)
DIEZ(DIFIL,DIFLD,DIFLG,DIKDOUT,DIKTEML) ;Recompile input templates containing field
"RTN","DIKD",42,0)
 N DIERR,DITEM,DIMAX,DIRNM
"RTN","DIKD",43,0)
 S DIMAX=$$ROUSIZE^DILF
"RTN","DIKD",44,0)
 S DITEM=0 F  S DITEM=$O(^DIE("AF",DIFIL,DIFLD,DITEM)) Q:'DITEM  D
"RTN","DIKD",45,0)
 . N DIERR,DIEZMSG
"RTN","DIKD",46,0)
 . Q:$D(DIKTEML(DITEM))#2  S DIKTEML(DITEM)=""
"RTN","DIKD",47,0)
 . K ^DIE("AF",DIFIL,DIFLD,DITEM),^DIE(DITEM,"ROU")
"RTN","DIKD",48,0)
 . S DIRNM=$G(^DIE(DITEM,"ROUOLD")) Q:DIRNM=""
"RTN","DIKD",49,0)
 . D EN2^DIEZ(DITEM,$E("T",$G(DIFLG)["W"),DIRNM,"","DIEZMSG")
"RTN","DIKD",50,0)
 . I '$G(DIERR),$G(DIKDOUT)]"" D
"RTN","DIKD",51,0)
 .. S @DIKDOUT@("DIEZ",DITEM)=$P(^DIE(DITEM,0),U)_U_$P(^(0),U,4)_U_DIRNM
"RTN","DIKD",52,0)
 Q
"RTN","DIKD",53,0)
 ;
"RTN","DIKD",54,0)
DIKZ(Y,DIFLG,DIKDOUT) ;Recompile xrefs
"RTN","DIKD",55,0)
 Q:'$G(Y)
"RTN","DIKD",56,0)
 N DIERR,DIKZMSG,DMAX,DIRNM
"RTN","DIKD",57,0)
 S DIRNM=$G(^DD(Y,0,"DIK")) Q:DIRNM=""
"RTN","DIKD",58,0)
 S DMAX=$$ROUSIZE^DILF
"RTN","DIKD",59,0)
 D EN2^DIKZ(Y,$E("T",$G(DIFLG)["W"),DIRNM,"","DIKZMSG")
"RTN","DIKD",60,0)
 I '$G(DIERR),$G(DIKDOUT)]"" S @DIKDOUT@("DIKZ")=DIRNM
"RTN","DIKD",61,0)
 Q
"RTN","DIKD",62,0)
 ;
"RTN","DIKD",63,0)
AUDIT ;Audit DD change
"RTN","DIKD",64,0)
 N %,%D,%T,A0,A1,A2,B0,B1,B2,B3,DA,DDA,DL,DQ,J,N
"RTN","DIKD",65,0)
 S DDA="D",N=DIFINFO,J(0)=+DIFINFO(0),J(N)=DIFIL,DL=DIFLD,DQ=DIXR
"RTN","DIKD",66,0)
 D XA^DICATTA
"RTN","DIKD",67,0)
 S:$G(DIKDOUT)]"" @DIKDOUT@("DDAUD")=1
"RTN","DIKD",68,0)
 Q
"RTN","DIKD",69,0)
 ;
"RTN","DIKD",70,0)
CHK ;Check input parameters
"RTN","DIKD",71,0)
 I '$G(DIFIL) D:DIF["D" ERR^DIKCU2(202,"","","","FILE") D QUIT
"RTN","DIKD",72,0)
 I '$G(DIFLD) D:DIF["D" ERR^DIKCU2(202,"","","","FIELD") D QUIT
"RTN","DIKD",73,0)
 I '$G(DIQUIT),'$$VFNUM^DIKCU1(DIFIL,DIF) D QUIT
"RTN","DIKD",74,0)
 I '$G(DIQUIT),'$$VFLD^DIKCU1($G(DIFIL),$G(DIFLD),DIF) D QUIT
"RTN","DIKD",75,0)
 ;
"RTN","DIKD",76,0)
 I $G(DIXR)="" D
"RTN","DIKD",77,0)
 . D:DIF["D" ERR^DIKCU2(202,"","","","CROSS-REFERENCE") D QUIT
"RTN","DIKD",78,0)
 E  I '$G(DIQUIT) D
"RTN","DIKD",79,0)
 . I DIXR=+DIXR D
"RTN","DIKD",80,0)
 .. I $D(^DD(DIFIL,DIFLD,1,DIXR,0))[0 D:DIF["D" ERR^DIKCU2(202,"","","","CROSS-REFERENCE") D QUIT
"RTN","DIKD",81,0)
 . E  D
"RTN","DIKD",82,0)
 .. N I,XR
"RTN","DIKD",83,0)
 .. S I=0 F  S I=$O(^DD(DIFIL,DIFLD,1,I)) Q:'I  S:$P($G(^(I,0)),U,2)=DIXR XR=$G(XR)+1,XR(XR)=I
"RTN","DIKD",84,0)
 .. I $G(XR)=1 S DIXR=XR(XR)
"RTN","DIKD",85,0)
 .. E  D:DIF["D" ERR^DIKCU2(202,"","","","CROSS-REFERENCE") D QUIT
"RTN","DIKD",86,0)
 ;
"RTN","DIKD",87,0)
 D:'$$VFLAG^DIKCU1(DIFLG,"KWcd",DIF) QUIT
"RTN","DIKD",88,0)
 Q
"RTN","DIKD",89,0)
 ;
"RTN","DIKD",90,0)
QUIT ;Set flag to quit
"RTN","DIKD",91,0)
 S DIQUIT=1
"RTN","DIKD",92,0)
 Q
"RTN","DIKD2")
0^5^B5553526
"RTN","DIKD2",1,0)
DIKD2 ;SFISC/MKO-DELETE A NEW-STYLE INDEX ;10:28 AM  1 Nov 2002
"RTN","DIKD2",2,0)
 ;;22.0;VA FileMan;**12,95**;Mar 30, 1999
"RTN","DIKD2",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKD2",4,0)
 ;
"RTN","DIKD2",5,0)
DELIXN(DIFIL,DIXR,DIFLG,DIKDOUT,DIKDMSG) ;Delete new-style index
"RTN","DIKD2",6,0)
DELIXNX ;Come here from DELIXN^DDMOD
"RTN","DIKD2",7,0)
 N %,DIC,DIF,DIFLIST,DIINDEX,DIQUIT,DITOP,X,Y
"RTN","DIKD2",8,0)
 ;
"RTN","DIKD2",9,0)
 ;Init
"RTN","DIKD2",10,0)
 I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DIKD2",11,0)
 S DIFLG=$G(DIFLG)
"RTN","DIKD2",12,0)
 S DIF=$E("D",DIFLG'["d")
"RTN","DIKD2",13,0)
 I DIFLG'["c" D CHK G:$G(DIQUIT) END
"RTN","DIKD2",14,0)
 S DITOP=DIFIL F  Q:'$D(^DD(DITOP,0,"UP"))  S DITOP=^("UP")
"RTN","DIKD2",15,0)
 D GETFLIST^DIKCUTL(DIXR,.DIFLIST)
"RTN","DIKD2",16,0)
 D LOADXREF^DIKC1("","","K",DIXR,"","DIINDEX")
"RTN","DIKD2",17,0)
 ;
"RTN","DIKD2",18,0)
 ;Delete data in index
"RTN","DIKD2",19,0)
 D:DIFLG["K" KILL(DITOP,.DIINDEX,DIFLG)
"RTN","DIKD2",20,0)
 ;
"RTN","DIKD2",21,0)
 ;Delete index, recompile
"RTN","DIKD2",22,0)
 D DELDEF(DIXR)
"RTN","DIKD2",23,0)
 D DIEZ(.DIFLIST,DIFLG,$G(DIKDOUT))
"RTN","DIKD2",24,0)
 D DIKZ^DIKD(DITOP,DIFLG,$G(DIKDOUT))
"RTN","DIKD2",25,0)
 ;
"RTN","DIKD2",26,0)
END ;Move error message if necessary and quit
"RTN","DIKD2",27,0)
 D:$G(DIKDMSG)]"" CALLOUT^DIEFU(DIKDMSG)
"RTN","DIKD2",28,0)
 Q
"RTN","DIKD2",29,0)
 ;
"RTN","DIKD2",30,0)
DELDEF(DIXR) ;Delete index definition
"RTN","DIKD2",31,0)
 N DIK,DA
"RTN","DIKD2",32,0)
 W:$G(DIFLG)["W" !,"Deleting index definition ..."
"RTN","DIKD2",33,0)
 S DIK="^DD(""IX"",",DA=DIXR D ^DIK
"RTN","DIKD2",34,0)
 Q
"RTN","DIKD2",35,0)
 ;
"RTN","DIKD2",36,0)
DIEZ(DIFLIST,DIFLG,DIKDOUT) ;Recompile input templates containing field
"RTN","DIKD2",37,0)
 N DIFIL,DIFLD,DIKTEML
"RTN","DIKD2",38,0)
 S DIFIL=0 F  S DIFIL=$O(DIFLIST(DIFIL)) Q:'DIFIL  D
"RTN","DIKD2",39,0)
 . S DIFLD=0 F  S DIFLD=$O(DIFLIST(DIFIL,DIFLD)) Q:'DIFLD  D
"RTN","DIKD2",40,0)
 .. D DIEZ^DIKD(DIFIL,DIFLD,DIFLG,$G(DIKDOUT),.DIKTEML)
"RTN","DIKD2",41,0)
 Q
"RTN","DIKD2",42,0)
 ;
"RTN","DIKD2",43,0)
CHK ;Check input parameters
"RTN","DIKD2",44,0)
 I '$G(DIFIL) D:DIF["D" ERR^DIKCU2(202,"","","","FILE") D QUIT
"RTN","DIKD2",45,0)
 I $G(DIXR)="" D:DIF["D" ERR^DIKCU2(202,"","","","CROSS-REFERENCE") D QUIT
"RTN","DIKD2",46,0)
 D:'$$VFLAG^DIKCU1(DIFLG,"KWcd",DIF) QUIT
"RTN","DIKD2",47,0)
 ;
"RTN","DIKD2",48,0)
 S DIXR=$O(^DD("IX","BB",DIFIL,DIXR,0))
"RTN","DIKD2",49,0)
 D:'DIXR QUIT
"RTN","DIKD2",50,0)
 Q
"RTN","DIKD2",51,0)
 ;
"RTN","DIKD2",52,0)
QUIT ;Set flag to quit
"RTN","DIKD2",53,0)
 S DIQUIT=1
"RTN","DIKD2",54,0)
 Q
"RTN","DIKD2",55,0)
 ;
"RTN","DIKD2",56,0)
KILL(DITOP,DIINDEX,DIFLG) ;Delete index data
"RTN","DIKD2",57,0)
 N DIFIL,DITYP,DICTRL,DIXR
"RTN","DIKD2",58,0)
 ;
"RTN","DIKD2",59,0)
 Q:'$D(DIINDEX)
"RTN","DIKD2",60,0)
 S DIFIL=$O(DIINDEX(0)) Q:'DIFIL
"RTN","DIKD2",61,0)
 S DIXR=$O(DIINDEX(DIFIL,0)) Q:'DIXR
"RTN","DIKD2",62,0)
 S DITYP=$P(DIINDEX(DIFIL,DIXR),U,4)
"RTN","DIKD2",63,0)
 ;
"RTN","DIKD2",64,0)
 I $G(DIFLG)["W" D
"RTN","DIKD2",65,0)
 . I DITYP="R" W !,"Removing index ..."
"RTN","DIKD2",66,0)
 . E  W !,"Executing kill logic ..."
"RTN","DIKD2",67,0)
 ;
"RTN","DIKD2",68,0)
 ;Call INDEX^DIKC to execute the kill logic
"RTN","DIKD2",69,0)
 S DICTRL="K"_$S(DITOP'=DIFIL:"W"_DIFIL,1:"")
"RTN","DIKD2",70,0)
 S DICTRL("LOGIC")="DIINDEX"
"RTN","DIKD2",71,0)
 D INDEX^DIKC(DITOP,"","",DIXR,.DICTRL)
"RTN","DIKD2",72,0)
 Q
"RTN","DIPS95")
0^^B1649314
"RTN","DIPS95",1,0)
DIPS95 ;SFISC/MKO-POST INSTALL ROUTINE FOR PATCH DI*22*95 ;8:38 AM  18 Sep 2002
"RTN","DIPS95",2,0)
 ;;22.0;VA FileMan;**95**;Mar 30, 1999
"RTN","DIPS95",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIPS95",4,0)
 ;
"RTN","DIPS95",5,0)
 ;Recompile all input templates that contain fields with new-style
"RTN","DIPS95",6,0)
 ;cross-references defined on them.
"RTN","DIPS95",7,0)
RECOMP N CNT,FIL,FLD,NAM,TEM
"RTN","DIPS95",8,0)
 K ^TMP("DIPS95",$J)
"RTN","DIPS95",9,0)
 D BMES^XPDUTL("Recompiling input templates...")
"RTN","DIPS95",10,0)
 S FIL=.9999 F  S FIL=$O(^DD("IX","F",FIL)) Q:'FIL  D
"RTN","DIPS95",11,0)
 . S FLD=0 F  S FLD=$O(^DD("IX","F",FIL,FLD)) Q:'FLD  D
"RTN","DIPS95",12,0)
 .. S TEM=0 F  S TEM=$O(^DIE("AF",FIL,FLD,TEM)) Q:'TEM  D
"RTN","DIPS95",13,0)
 ... Q:$D(^TMP("DIPS95",$J,"TEM",TEM))  S ^(TEM)=""
"RTN","DIPS95",14,0)
 ... S NAM=$G(^DIE(TEM,"ROUOLD")) Q:NAM=""
"RTN","DIPS95",15,0)
 ... S CNT=$G(CNT)+1
"RTN","DIPS95",16,0)
 ... D MES^XPDUTL("  #"_TEM_"    "_$P($G(^DIE(TEM,0)),U)_"    File #"_$P($G(^DIE(TEM,0)),U,4)_"    ^"_NAM)
"RTN","DIPS95",17,0)
 ... D EN2^DIEZ(TEM,"",NAM)
"RTN","DIPS95",18,0)
 D:'$G(CNT) MES^XPDUTL("  -- No input template needed to be recompiled.")
"RTN","DIPS95",19,0)
 K ^TMP("DIPS95",$J)
"RTN","DIPS95",20,0)
 Q
"VER")
8.0^22.0
**END**
**END**
