Released DI*22*133 SEQ #123
Extracted from mail message
**KIDS**:DI*22.0*133^

**INSTALL NAME**
DI*22.0*133
"BLD",525,0)
DI*22.0*133^VA FILEMAN^0^3031124^y
"BLD",525,1,0)
^^2^2^3031118^
"BLD",525,1,1,0)
See patch DI*22*133 in the National Patch Module on FORUM for complete
"BLD",525,1,2,0)
information on this patch.
"BLD",525,4,0)
^9.64PA^^
"BLD",525,"KRN",0)
^9.67PA^8989.52^19
"BLD",525,"KRN",.4,0)
.4
"BLD",525,"KRN",.401,0)
.401
"BLD",525,"KRN",.402,0)
.402
"BLD",525,"KRN",.403,0)
.403
"BLD",525,"KRN",.5,0)
.5
"BLD",525,"KRN",.84,0)
.84
"BLD",525,"KRN",3.6,0)
3.6
"BLD",525,"KRN",3.8,0)
3.8
"BLD",525,"KRN",9.2,0)
9.2
"BLD",525,"KRN",9.8,0)
9.8
"BLD",525,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",525,"KRN",9.8,"NM",1,0)
DIQ^^0^B37013741
"BLD",525,"KRN",9.8,"NM",2,0)
DIQG^^0^B35600880
"BLD",525,"KRN",9.8,"NM",3,0)
DIQ1^^0^B6672194
"BLD",525,"KRN",9.8,"NM","B","DIQ",1)

"BLD",525,"KRN",9.8,"NM","B","DIQ1",3)

"BLD",525,"KRN",9.8,"NM","B","DIQG",2)

"BLD",525,"KRN",19,0)
19
"BLD",525,"KRN",19.1,0)
19.1
"BLD",525,"KRN",101,0)
101
"BLD",525,"KRN",409.61,0)
409.61
"BLD",525,"KRN",771,0)
771
"BLD",525,"KRN",870,0)
870
"BLD",525,"KRN",8989.51,0)
8989.51
"BLD",525,"KRN",8989.52,0)
8989.52
"BLD",525,"KRN",8994,0)
8994
"BLD",525,"KRN","B",.4,.4)

"BLD",525,"KRN","B",.401,.401)

"BLD",525,"KRN","B",.402,.402)

"BLD",525,"KRN","B",.403,.403)

"BLD",525,"KRN","B",.5,.5)

"BLD",525,"KRN","B",.84,.84)

"BLD",525,"KRN","B",3.6,3.6)

"BLD",525,"KRN","B",3.8,3.8)

"BLD",525,"KRN","B",9.2,9.2)

"BLD",525,"KRN","B",9.8,9.8)

"BLD",525,"KRN","B",19,19)

"BLD",525,"KRN","B",19.1,19.1)

"BLD",525,"KRN","B",101,101)

"BLD",525,"KRN","B",409.61,409.61)

"BLD",525,"KRN","B",771,771)

"BLD",525,"KRN","B",870,870)

"BLD",525,"KRN","B",8989.51,8989.51)

"BLD",525,"KRN","B",8989.52,8989.52)

"BLD",525,"KRN","B",8994,8994)

"BLD",525,"QUES",0)
^9.62^^
"BLD",525,"REQB",0)
^9.611^2^2
"BLD",525,"REQB",1,0)
DI*22.0*99^2
"BLD",525,"REQB",2,0)
DI*22.0*118^2
"BLD",525,"REQB","B","DI*22.0*118",2)

"BLD",525,"REQB","B","DI*22.0*99",1)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
VA FILEMAN^DI^FM INIT
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
22.0^2990330^3030110^41
"PKG",5,22,1,"PAH",1,0)
133^3031124
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3031124
"PKG",5,22,1,"PAH",1,1,1,0)
See patch DI*22*133 in the National Patch Module on FORUM for complete
"PKG",5,22,1,"PAH",1,1,2,0)
information on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","DIQ")
0^1^B37013741
"RTN","DIQ",1,0)
DIQ ;SFISC/GFT-CAPTIONED TEMPLATE ;05:55 PM  17 Apr 2003
"RTN","DIQ",2,0)
 ;;22.0;VA FileMan;**19,64,74,81,99,133**;Mar 30, 1999
"RTN","DIQ",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIQ",4,0)
 G INQ^DII
"RTN","DIQ",5,0)
 ;
"RTN","DIQ",6,0)
GET1(DIQGR,DA,DR,DIQGPARM,DIQGETA,DIQGERRA,DIQGIPAR) ;Extrinsic Function
"RTN","DIQ",7,0)
 ; file,record,field,parm,targetarray,errortargetarray,internal
"RTN","DIQ",8,0)
 I '$D(DIQUIET) N DIQUIET S DIQUIET=1
"RTN","DIQ",9,0)
 I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DIQ",10,0)
 G DDENTRY^DIQG
"RTN","DIQ",11,0)
 ;
"RTN","DIQ",12,0)
GETS(DIQGR,DA,DR,DIQGPARM,DIQGTA,DIQGERRA,DIQGIPAR) ;Procedure Call
"RTN","DIQ",13,0)
 ; file,record,field,parm,targetarray,errortargetarray,internal
"RTN","DIQ",14,0)
 I '$D(DIQUIET) N DIQUIET S DIQUIET=1
"RTN","DIQ",15,0)
 I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DIQ",16,0)
 N DIQGQERR
"RTN","DIQ",17,0)
 D DDENTRY^DIQGQ
"RTN","DIQ",18,0)
 I $G(DIQGQERR)]"" S DIERR=DIQGQERR
"RTN","DIQ",19,0)
 D:$G(DIQGERRA)]"" CALLOUT^DIEFU(DIQGERRA)
"RTN","DIQ",20,0)
 Q
"RTN","DIQ",21,0)
 ;
"RTN","DIQ",22,0)
 ;
"RTN","DIQ",23,0)
CAPTION(DD,DA,A,N,E) ;
"RTN","DIQ",24,0)
 ; Newing of Line Counter 'S' needs to be before call
"RTN","DIQ",25,0)
 N D0,DIQ,DIC,DIQS
"RTN","DIQ",26,0)
 S DIQ(0)=$G(A),DIC=^DIC(DD,0,"GL") I $G(DIA),DD=.6!(DD=1.1) S DIC=DIC_DIA_"," ;In DIQ(0), 'A' means AUDIT, 'R' means SHOW RECORD NUMBER
"RTN","DIQ",27,0)
 S E=$S($G(E)="":"N<0",1:"N]]"""_E_"""")
"RTN","DIQ",28,0)
 S N=$S($G(N)="":-1,1:$O(@(DIC_"DA,N)"),-1))
"RTN","DIQ",29,0)
 D R
"RTN","DIQ",30,0)
 S X=""
"RTN","DIQ",31,0)
 Q
"RTN","DIQ",32,0)
 ;
"RTN","DIQ",33,0)
GUY ;from DII
"RTN","DIQ",34,0)
 N N S N=-1
"RTN","DIQ",35,0)
R S:'$G(IOM) IOM=80 S:'$G(IOSL) IOSL=24,IOST="C-OTHER"
"RTN","DIQ",36,0)
 S:'$D(DTIME) DTIME=300 K DTOUT,DUOUT,DIRUT,DIR
"RTN","DIQ",37,0)
 N DIQDD,DIQAUDD,DIQZ,D,DL,D1,D2,D3,D4,D5,D6,D7,D8,D9
"RTN","DIQ",38,0)
 S D0=DA,D=DIC_DA_",",DL=1,DIQDD=DD S:'$G(S) S=3
"RTN","DIQ",39,0)
 I '$D(DIQS) W !
"RTN","DIQ",40,0)
 E  D
"RTN","DIQ",41,0)
 .S DIQZ=0,A=0 F  S @("DIQZ=$O("_DIQS_"DIQZ))") Q:DIQZ=""  S @(DIQS_"DIQZ)=""""")
"RTN","DIQ",42,0)
 D 1(DA)
"RTN","DIQ",43,0)
 G Q
"RTN","DIQ",44,0)
 ;
"RTN","DIQ",45,0)
1(DA) ;recursive, for 1 entry or subentry
"RTN","DIQ",46,0)
 N DIQAUD,DIQAUDE
"RTN","DIQ",47,0)
 I $D(DIQS) D  ;old parameter -- undocumented
"RTN","DIQ",48,0)
 .S DIQZ=0,A=0 F  S @("DIQZ=$O("_DIQS_"DIQZ))") Q:DIQZ=""  D
"RTN","DIQ",49,0)
 ..S A=$O(^DD(DD,"B",DIQZ,0)) Q:'A
"RTN","DIQ",50,0)
 ..I $D(^DD(DD,A,0)) S C=$P(^(0),U,2) I C["C" D COM S @(DIQS_"DIQZ)=X")
"RTN","DIQ",51,0)
 I N<0,$D(^DD(DD,.001,0)) S W=.001,A=-1,Y=@("D"_(DL\2)) D W Q:'S  G A
"RTN","DIQ",52,0)
 I $G(DIQ(0))["R",DL=1 S W=.001,A=-1,O="NUMBER",Y=D0 D W2 Q:'S
"RTN","DIQ",53,0)
A I DIQ(0)["A" D
"RTN","DIQ",54,0)
 .N Z,D,SUB
"RTN","DIQ",55,0)
 .S DIQAUDD="",DIQAUDE=D0 F A=3:2:DL S DIQAUDE=DIQAUDE_","_(@("D"_(A\2))),DIQAUDD=DIQAUDD_DIQAUDD(A-1)_","
"RTN","DIQ",56,0)
 .F Z=0:0 S Z=$O(^DIA(DIQDD,"B",DIQAUDE,Z)) Q:'Z  D
"RTN","DIQ",57,0)
 ..S D=$P($G(^DIA(DIQDD,Z,0)),U,3) Q:'D  ;get field number
"RTN","DIQ",58,0)
 ..I DL>1 S D=$P(D,DIQAUDD,2,9)
"RTN","DIQ",59,0)
 ..E  I E["]]"!(N]]0) S SUB=$P($P($G(^DD(DIQDD,+D,0)),U,4),";") D
"RTN","DIQ",60,0)
 ...I N]]SUB S D=0 Q
"RTN","DIQ",61,0)
 ...N N S N=SUB I @E S D=0 Q
"RTN","DIQ",62,0)
 ..I D S DIQAUD(D,Z)="" Q
"RTN","DIQ",63,0)
 ;..S DIQAUDR(Z)=""
"RTN","DIQ",64,0)
N S @("N=$O("_D_"N))") I N="" S N=-1 G END:DL#2,UP
"RTN","DIQ",65,0)
 I DL=1,@E G END
"RTN","DIQ",66,0)
 S DIQZ=$G(^(N)) I DIQZ]"" S A="" F  S A=$O(^DD(DD,"GL",N,A)) G N:A="" D  G Q:'S ;write out what's on one data node
"RTN","DIQ",67,0)
 .S W=$O(^(A,0)) Q:'W  I A S Y=$P(DIQZ,U,A) Q:Y=""
"RTN","DIQ",68,0)
 .E  S Y=$E(DIQZ,+$E(A,2,9),$P(A,",",2)) Q:Y?." "
"RTN","DIQ",69,0)
 .D W
"RTN","DIQ",70,0)
 I DL#2 S DIQZ=$O(^DD(DD,"GL",N,0,0)) G N:DIQZ="" S O=0,X=+$P(^DD(DD,DIQZ,0),U,2) X:$D(DICS) DICS E  G N
"RTN","DIQ",71,0)
 E  G UP:N'>0 S X=DD,O=-1,@("D"_(DL\2)_"=N") Q:$$STOP  I $D(DSC(X)) X DSC(X) E  G N ;we've found a new sub-entry
"RTN","DIQ",72,0)
 S DD(DL)=DD,D(DL)=D,N(DL)=N,DL=DL+1,DIQAUDD(DL)=DIQZ S:+N'=N N=""""_N_"""" S D=D_N_",",N=O,DD=X ;down a level
"RTN","DIQ",73,0)
 I DL#2=0 S N=0 N DIQAUDR G N ;let's look for the 1st multiple
"RTN","DIQ",74,0)
WP I '$D(DIQS),$P(^DD(DD,.01,0),U,2)["W" S O=$P(^(0),U),C=$P(^(0),U,2) D  S DL=DL-1 G UP:S Q
"RTN","DIQ",75,0)
 .N DIWF,DIWL,DIWR,DN,N,DD ;Word-processing field
"RTN","DIQ",76,0)
 .D DIQ^DIWW I $D(DN),'DN S S=0
"RTN","DIQ",77,0)
 S N=-1 D 1(DA) Q:'S
"RTN","DIQ",78,0)
UP S DL=DL-1,D=D(DL),DD=DD(DL),N=N(DL) Q:$$STOP  G N ;go back UP a level
"RTN","DIQ",79,0)
 ;
"RTN","DIQ",80,0)
END Q:$$STOP
"RTN","DIQ",81,0)
 I $O(DIQAUD(0)) D  ;write out audited DELETED fields
"RTN","DIQ",82,0)
 .N D F DIQZ=0:0 S DIQZ=$O(DIQAUD(DIQZ)) Q:'DIQZ  W ?2,$P($G(^DD(DD,DIQZ,0)),U),":" D PRINTAUD(DIQZ) Q:$$STOP
"RTN","DIQ",83,0)
 I S,$G(DIQ(0))["C",$D(@(D_"0)")) D ^DIQ1 ;Computed fields at this level -- ONLY IF ENTRY EXISTS
"RTN","DIQ",84,0)
 Q
"RTN","DIQ",85,0)
 ;
"RTN","DIQ",86,0)
W S O=$P(^DD(DD,W,0),U),C=$P(^(0),U,2) I $D(DICS) X DICS E  Q
"RTN","DIQ",87,0)
 D Y
"RTN","DIQ",88,0)
 I $D(DIQS) S:$D(@(DIQS_"O)")) @(DIQS_"O)=Y") S:$D(^(W)) @(DIQS_"W)=Y") Q
"RTN","DIQ",89,0)
W2 ;from DIQ1
"RTN","DIQ",90,0)
 N DIQX
"RTN","DIQ",91,0)
 S O=$E(O,1,253-$L(Y))_": "_Y
"RTN","DIQ",92,0)
 D  I $L(O)+DIQX>IOM!$D(DIQAUD(W)) Q:$$STOP  D
"RTN","DIQ",93,0)
 .S DIQX=$S($X:$X+1\40+1*40,W=.01!(W=.001):0,1:2)
"RTN","DIQ",94,0)
 W ?DIQX
"RTN","DIQ",95,0)
 D WRITE(O) D:$D(DIQAUD(W)) PRINTAUD(W) Q
"RTN","DIQ",96,0)
 ;
"RTN","DIQ",97,0)
PRINTAUD(FLD) N E,O,Z,W,N
"RTN","DIQ",98,0)
 S E=""
"RTN","DIQ",99,0)
 F  S E=$O(DIQAUD(FLD,E),-1) Q:'E  Q:$$STOP  D
"RTN","DIQ",100,0)
 .;K DIQAUDR(E)
"RTN","DIQ",101,0)
 .S O=$G(^DIA(DIQDD,E,2)),N=$G(^(3))
"RTN","DIQ",102,0)
 .I N="" S W="Deleted """_O_""""
"RTN","DIQ",103,0)
 .E  S W=$S(O]"":"Changed from """_O_"""",1:"Created")
"RTN","DIQ",104,0)
 .I $D(^(0)) S Z=$P(^(0),U,4),W=W_" on "_$$FMTE^DILIBF($P(^(0),U,2),"IL") I Z]"" S W=W_" by User #"_Z
"RTN","DIQ",105,0)
 .S Z=$G(^(4.1)),O=$P(Z,U),Z=$P(Z,U,2) I O,$D(^DIC(19,O,0)) S W=W_"  ("_$P(^(0),U)_" Option)"
"RTN","DIQ",106,0)
 .I Z S O=+Z,Z=$P(Z,";",2) I Z]"",$D(@(U_Z_O_",0)")) S W=W_"  ("_$P(^(0),U)_" Protocol)"
"RTN","DIQ",107,0)
 .W ?4 D WRITE(W)
"RTN","DIQ",108,0)
 K DIQAUD(FLD)
"RTN","DIQ",109,0)
 D LF Q
"RTN","DIQ",110,0)
WRITE(DIQW) N DIQWL
"RTN","DIQ",111,0)
 F  S DIQWL=IOM-$X W $E(DIQW,1,DIQWL) S DIQW=$E(DIQW,DIQWL+1,999) Q:DIQW=""  Q:$$STOP
"RTN","DIQ",112,0)
 Q
"RTN","DIQ",113,0)
 ;
"RTN","DIQ",114,0)
Y I C["O",$D(^(2)) X ^(2) Q  ;NAKED REFERENCE IS TO ^DD(FILE#,FIELD#,0)
"RTN","DIQ",115,0)
S I C["S" S C=";"_$P(^(0),U,3),%=$F(C,";"_Y_":") S:% Y=$P($E(C,%,999),";",1) Q
"RTN","DIQ",116,0)
 I C["P",$D(@("^"_$P(^(0),U,3)_"0)")) S C=$P(^(0),U,2) Q:'$D(^(+Y,0))  S Y=$P(^(0),U) I $D(^DD(+C,.01,0)) S C=$P(^(0),U,2) G S
"RTN","DIQ",117,0)
 I C["V",+Y,$D(@("^"_$P(Y,";",2)_"0)")) S C=$P(^(0),U,2) Q:'$D(^(+Y,0))  S Y=$P(^(0),U) I $D(^DD(+C,.01,0)) S C=$P(^(0),U,2) G S
"RTN","DIQ",118,0)
 Q:C'["D"  Q:'Y
"RTN","DIQ",119,0)
D S Y=$$FMTE^DILIBF(Y,"1U") Q
"RTN","DIQ",120,0)
 ;
"RTN","DIQ",121,0)
DT D D:Y W Y Q
"RTN","DIQ",122,0)
H G H^DIO2
"RTN","DIQ",123,0)
 ;
"RTN","DIQ",124,0)
STOP() D LF Q 'S
"RTN","DIQ",125,0)
LF I '$D(DIQS),$X W ! S S=S+1
"RTN","DIQ",126,0)
 I '$D(DIOT(2)),$G(IOSL),$S('$D(DIWF):1,$P(DIWF,"B",2):$P(DIWF,"B",2),1:1)+$Y'<IOSL D
"RTN","DIQ",127,0)
 .I '$D(DX(0)),$G(IOST)?1"C".E D:S>21  Q
"RTN","DIQ",128,0)
 ..N X,Y,DIR S DIR(0)="E" D ^DIR W ! S S='$D(DIRUT)
"RTN","DIQ",129,0)
 .I $G(^UTILITY($J,1))?1U1P1E.E D  S:Y=U!($D(DTOUT))!($D(DUOUT)) S=0
"RTN","DIQ",130,0)
 ..N S X ^(1)
"RTN","DIQ",131,0)
 .S $Y=0
"RTN","DIQ",132,0)
 Q
"RTN","DIQ",133,0)
 ;
"RTN","DIQ",134,0)
EN1 S DRX=DR
"RTN","DIQ",135,0)
EN2 S DR=$P(DRX,";",1),DRX=$P(DRX,";",2,999) D EN W ! G EN2:DRX]""&S
"RTN","DIQ",136,0)
 K DRX Q
"RTN","DIQ",137,0)
EN ;
"RTN","DIQ",138,0)
 N C,O,W,N,E,Z,D,DD S S=0 S:$D(DICSS) DICS=DICSS
"RTN","DIQ",139,0)
 I '$D(IOST)!'$D(IOSL)!'$D(IOM) S IOP="HOME" D ^%ZIS Q:POP  S:'$G(IOM) IOM=80
"RTN","DIQ",140,0)
 G Q:'$D(@(DIC_"0)")) S U="^",DD=+$P(^(0),U,2),DK=DD
"RTN","DIQ",141,0)
 I '$D(DR) S N=-1,O=""
"RTN","DIQ",142,0)
 E  S N=$P(DR,":"),N=$S(0[N:-1,+N=N:N-.000001,1:$E(N,1,$L(N)-1)_$C($A(N,$L(N))-1)),O=$P(DR,":",DR[":"+1) G EN1:DR[";"
"RTN","DIQ",143,0)
 S E="N<0" I O]"" S E=E_"!(N]"""_$S(+O=O:"?"")!(N>"_O_")",1:O_""")")
"RTN","DIQ",144,0)
 I '$D(DIQ(0)) N DIQ S DIQ(0)=""
"RTN","DIQ",145,0)
 D R S DA=D0
"RTN","DIQ",146,0)
Q K C,O,W,N,E,Z,D,DD,IOP Q
"RTN","DIQ",147,0)
 ;
"RTN","DIQ",148,0)
COM X $P(^(0),U,5,99) S C=$P($P(C,"J",2),",",2) I C?1N.E,X S X=$J(X,0,C)
"RTN","DIQ1")
0^3^B6672194
"RTN","DIQ1",1,0)
DIQ1 ;SFISC/XAK-INQUIRY WITH COMPUTED FIELDS ;6:09 AM  24 Nov 2003
"RTN","DIQ1",2,0)
 ;;22.0;VA FileMan;**19,64,76,133**;Mar 30, 1999
"RTN","DIQ1",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIQ1",4,0)
 ;
"RTN","DIQ1",5,0)
A S DIDQ=DD S:'$D(DICMX) DICMX="W !,O,"": "",X"
"RTN","DIQ1",6,0)
 N W,DD,D,Z
"RTN","DIQ1",7,0)
 F W=0:0 S W=$O(^DD(DIDQ,W)) Q:W'>0  I $D(^(W,0))#2 S Z=^(0),C=$P(Z,U,2),O=$P(Z,U)_" (c)" I C["C" X $P(Z,U,5,99) I X]"" D  Q:'S
"RTN","DIQ1",8,0)
 .N Y S Y=X
"RTN","DIQ1",9,0)
 .I C["p",Y S Y=$$CP(C,Y)
"RTN","DIQ1",10,0)
 .E  I C["D" X ^DD("DD")
"RTN","DIQ1",11,0)
 .D W2^DIQ
"RTN","DIQ1",12,0)
 K DIDQ,DICMX Q
"RTN","DIQ1",13,0)
 ;
"RTN","DIQ1",14,0)
CP(C,X) ;
"RTN","DIQ1",15,0)
 S:C["p" C=+$P(C,"p",2) I C,$D(^DIC(C,0,"GL")),$D(@(^("GL")_"0)")),$D(^(X,0)) S X=$$EXTERNAL^DIDU(C,.01,"",$P(^(0),U))
"RTN","DIQ1",16,0)
 Q X
"RTN","DIQ1",17,0)
 ;
"RTN","DIQ1",18,0)
EN ;
"RTN","DIQ1",19,0)
 Q:'$D(DIC)!($D(DA)[0)!($D(DR)[0)  S DIL=0,(DA(0),D0)=DA,DIQ0=""
"RTN","DIQ1",20,0)
 I $D(DIQ)#2 G Q:DIQ["^"!($E(DIQ,1,2)="DI") S:DIQ'["(" DIQ=DIQ_"("
"RTN","DIQ1",21,0)
 S:'$D(DIQ(0)) DIQ(0)="",DIQ0="DIQ(0),"
"RTN","DIQ1",22,0)
 I $D(DIQ)[0 S DIQ="^UTILITY(""DIQ1"",$J,",DIQ0="DIQ,"
"RTN","DIQ1",23,0)
 S DIQ0=DIQ0_"DIQ0"
"RTN","DIQ1",24,0)
 I DIC S DIC=$S($D(^DIC(DIC,0,"GL")):^("GL"),1:"") G:DIC="" Q
"RTN","DIQ1",25,0)
L G Q:'$D(@(DIC_"0)")) S DI=+$P(^(0),U,2) G Q:'$D(^(DA,0))
"RTN","DIQ1",26,0)
 N DII F DII=1:1 S DIQ1=$P(DR,";",DII) Q:DIQ1=""  D C:DIQ1[":",F:DIQ1>0
"RTN","DIQ1",27,0)
Q Q:DIL  K %,I,J,X,Y,C,DA(0),DRS,DIL,DI,DIQ1 K:DIQ0]"" @DIQ0 K:$D(DIQ0) DIQ0
"RTN","DIQ1",28,0)
 Q
"RTN","DIQ1",29,0)
 ;
"RTN","DIQ1",30,0)
C S DIQ2=$P(DIQ1,":",2)
"RTN","DIQ1",31,0)
 F DIQ1=DIQ1:0 D F S DIQ1=$O(^DD(DI,DIQ1)) I DIQ1'>0!(DIQ1'<DIQ2) S:DIQ1'=DIQ2 DIQ1=0 Q
"RTN","DIQ1",32,0)
 Q
"RTN","DIQ1",33,0)
F Q:'$D(^DD(DI,DIQ1,0))
"RTN","DIQ1",34,0)
 S Y=^(0),C=$P(Y,U,4),X=$P(C,";",2),C=$P(C,";"),J=$P(Y,U,2) G P:J["C"
"RTN","DIQ1",35,0)
 I +C'=C S C=""""_C_""""
"RTN","DIQ1",36,0)
 I X=0,$D(^DD(+J,.01,0)) G WD:$P(^(0),U,2)["W",S
"RTN","DIQ1",37,0)
 S C=$G(@(DIC_DA_","_C_")")),Y=$S(X["E":$E(C,+$P(X,"E",2),+$P(X,",",2)),1:$P(C,U,X))
"RTN","DIQ1",38,0)
 I DIQ(0)["I",(DIQ(0)["N"&(Y]"")!(DIQ(0)'["N")) S @(DIQ_"DI,DA,DIQ1,""I"")")=Y
"RTN","DIQ1",39,0)
P Q:DIQ(0)'["E"&(DIQ(0)["I")
"RTN","DIQ1",40,0)
 I J["C" X $P(Y,U,5,999) K Y S Y=X D:J["D" D^DIQ
"RTN","DIQ1",41,0)
 I J'["C" S C=$P(^DD(DI,DIQ1,0),U,2) D:Y]"" Y^DIQ
"RTN","DIQ1",42,0)
 Q:Y=""&(DIQ(0)["N")
"RTN","DIQ1",43,0)
 S @(DIQ_"DI,DA,DIQ1"_$S(DIQ(0)'["E":"",1:",""E""")_")")=Y
"RTN","DIQ1",44,0)
 Q
"RTN","DIQ1",45,0)
WD F X=0:0 S X=$O(@(DIC_"DA,"_C_",X)")) Q:X'>0  S @(DIQ_"DI,DA,DIQ1,X)")=^(X,0)
"RTN","DIQ1",46,0)
 Q
"RTN","DIQ1",47,0)
S ;
"RTN","DIQ1",48,0)
 Q:'$D(DR(+J))  Q:'$D(DA(+J))  N DIQ1,I,DI S DIL=DIL+1
"RTN","DIQ1",49,0)
 S DRS(DIL)=DR,DIC(DIL)=DIC,DR=DR(+J),DA(DIL)=DA
"RTN","DIQ1",50,0)
 S DI=+J,DIC=DIC_DA_","_C_",",DA=DA(+J),@("D"_DIL)=DA
"RTN","DIQ1",51,0)
 D L S DR=DRS(DIL),DA=DA(DIL),DIC=DIC(DIL)
"RTN","DIQ1",52,0)
 K DRS(DIL),DIC(DIL),DA(DIL),@("D"_DIL)
"RTN","DIQ1",53,0)
 S DIL=DIL-1 Q
"RTN","DIQG")
0^2^B35600880
"RTN","DIQG",1,0)
DIQG ;SFISC/DCL-DATA RETRIEVAL PRIMITIVE ;5:44 AM  24 Nov 2003
"RTN","DIQG",2,0)
 ;;22.0;VA FileMan;**76,118,133**;Mar 30, 1999
"RTN","DIQG",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIQG",4,0)
GET(DIQGR,DA,DR,DIQGPARM,DIQGETA,DIQGERRA,DIQGIPAR) ; file,rec,fld,parm,targetarray,errarray,int
"RTN","DIQG",5,0)
DDENTRY I $G(U)'="^" N U S U="^"
"RTN","DIQG",6,0)
 I '$G(DA) N X S X(1)="RECORD" Q $$F(.X,2)
"RTN","DIQG",7,0)
 S DIQGIPAR=$G(DIQGIPAR),DIQGPARM=$G(DIQGPARM)
"RTN","DIQG",8,0)
 I 'DIQGIPAR N DIQGAUDR,DIQGAUDD S DIQGAUDD=+$P(DIQGPARM,"A",2) I DIQGAUDD D GET^DIAUTL(DIQGR,DA,DIQGAUDD,"DIQGAUDR")
"RTN","DIQG",9,0)
 N DFF,DIQGSI,DIQGDD,DIQGWPB,DIQGWPO S DIQGDD=DIQGPARM["D",DIQGWPB=DIQGPARM["B"
"RTN","DIQG",10,0)
 S DIQGWPO=1
"RTN","DIQG",11,0)
 N DIQGEY S DIQGEY("FILE")=$G(DIQGR),DIQGEY("RECORD")=$G(DA),DIQGEY("FIELD")=$G(DR)
"RTN","DIQG",12,0)
 I '$D(DIQGR) N X S X(1)="FILE" Q $$F(.X,1)
"RTN","DIQG",13,0)
 I 'DIQGR,'DIQGIPAR N X S X(1)="FILE" Q $$F(.X,12)
"RTN","DIQG",14,0)
DA D:$G(DA)["," IEN(DA,.DA)
"RTN","DIQG",15,0)
 I $G(DR)="" N X S X(1)="FIELD" Q $$F(.X,10)
"RTN","DIQG",16,0)
 I 'DIQGIPAR,'DIQGDD Q:$$N9^DIQGU(DIQGR,.DA) $$F(.DIQGEY,16) I '$D(^DD(DIQGR)) N X S X(1)="FILE" Q $$F(.X,18)
"RTN","DIQG",17,0)
 S DIQGETA=$G(DIQGETA) I DIQGETA["("&(DIQGETA'[")") N X S X(1)="TARGET ARRAY" Q $$F(.X,14)
"RTN","DIQG",18,0)
 I DIQGR S DFF=DIQGR,DIQGR=$S(DIQGDD:$$DDROOT(DIQGR),1:$$ROOT^DIQGU(DIQGR,.DA)) I DIQGR="" N X S X(1)="FILE and/or IEN" Q $$F(.X,4)
"RTN","DIQG",19,0)
DFF S DIQGSI=$$CREF(DIQGR) I '$D(DFF) S DFF=+$P($G(@DIQGSI@(0)),U,2) I 'DFF,DIQGPARM'["D" N X S X("FILE")=DIQGSI Q $$F(.X,6)  ;does the file exist?
"RTN","DIQG",20,0)
 I '$D(@DIQGSI@(DA)),'DIQGIPAR,DIQGPARM'["A" Q $$F(.DIQGEY,19)  ;Entry may have existed audited in the past
"RTN","DIQG",21,0)
 I '$G(DT) N DT S DT=$$DT^DIQGU($H)
"RTN","DIQG",22,0)
 N DIQGPI,DIQGZN S DIQGPI=DIQGPARM["I",DIQGZN=DIQGPARM["Z"
"RTN","DIQG",23,0)
 N %,%H,%T,I,J,N,X
"RTN","DIQG",24,0)
D0 S X=0,N="D0" F  S X=$O(DA(X)) Q:X'>0  S I=X,N=N_",D"_X
"RTN","DIQG",25,0)
 N @N
"RTN","DIQG",26,0)
 S @("D"_+$G(I)_"=DA") I $G(I) F J=I-1:-1:0 S @("D"_J_"=DA(I-J)")
"RTN","DIQG",27,0)
 N C,P,Y,DIQGDN,DIQGD4,DIQGDRN
"RTN","DIQG",28,0)
 S (X,Y)="",DIQGDRN=DR
"RTN","DIQG",29,0)
DD S DIQGDN="^DD("_$S(DIQGPARM["D":0,1:DFF)_")" ;name of ^DD
"RTN","DIQG",30,0)
FIELD I DR'?.N,$D(@DIQGDN@("B",DR)) S DIQGDRN=$O(^(DR,"")) I $O(^(DIQGDRN)) N X S X("FILE")=DIQGDN,X(1)=DR Q $$F(.X,15)
"RTN","DIQG",31,0)
 I DIQGDD,DIQGDRN'>0 D  I $E(DIQGDRN,1,6)="$$$ NO" N X S X(1)="ATTRIBUTE" Q $$F(.X,17)
"RTN","DIQG",32,0)
 .S DIQGDRN=$$DDN^DIQGU0(DR) Q:$E(DIQGDRN,1,6)="$$$ NO"
"RTN","DIQG",33,0)
 .S DIQGDN="^DD("_$P(DIQGDRN,"^")_")",DIQGDRN=$P(DIQGDRN,"^",2)
"RTN","DIQG",34,0)
 I DIQGDRN>0,$D(@DIQGDN@(DIQGDRN,0)) S DIQGD4=$P(^(0),"^",4),C=$P(^(0),"^",2),P=$P(DIQGD4,";") G:$P(DIQGD4,";",2)'>0 DIQ S Y=$P($G(@DIQGSI@(DA,P)),"^",$P(DIQGD4,";",2)) G DIQ
"RTN","DIQG",35,0)
TRYCOMP N X,DIQGS I 'DIQGIPAR D EXPR(DFF,DR) ;DON'T ALLOW COMPUTED EXPRESSIONS EXCEPT FROM $$GET1^DIQ
"RTN","DIQG",36,0)
 I $D(X) S C=Y G C:C["m" D CMPAUD(DR,$G(X("USED"))) I $D(X) X X Q X
"RTN","DIQG",37,0)
GIVEUP Q $$F(.DIQGEY,7)
"RTN","DIQG",38,0)
 ;
"RTN","DIQG",39,0)
DIQ I DIQGDRN=.001 S Y=DA
"RTN","DIQG",40,0)
 G BMW:C,REAL:C'["C"
"RTN","DIQG",41,0)
C I C["m" N X S X(1)="MULTILINE COMPUTED" Q $$F(.X,3)
"RTN","DIQG",42,0)
 ;I DIQGPI Q "" MAR2001 GFT
"RTN","DIQG",43,0)
 I DIQGDN="^DD(1.005)",DIQGDRN=1 S X=@DIQGSI@(DA,0)
"RTN","DIQG",44,0)
 N DCC,DIQGH,X,DFF S DIQGH=$G(DIERR),DCC=DIQGR,DFF=+$P(DCC,"(",2)
"RTN","DIQG",45,0)
 I $D(@DIQGDN@(DIQGDRN,9.01)),$D(^(9.1)) D CMPAUD(^(9.1),^(9.01)) I $D(X) X X I 1
"RTN","DIQG",46,0)
 E  S X="" X $P(@DIQGDN@(DIQGDRN,0),"^",5,999) ;HELLEVI
"RTN","DIQG",47,0)
 D:DIQGH'=$G(DIERR)
"RTN","DIQG",48,0)
 .N X
"RTN","DIQG",49,0)
 .D BLD^DIALOG(120,"FIELD")
"RTN","DIQG",50,0)
 I $G(X)=""!DIQGPI Q $G(X)
"RTN","DIQG",51,0)
CP I C["p",X S C=+$P(C,"p",2) I C,$D(^DIC(C,0,"GL")),$D(@(^("GL")_"0)")),$D(^(X,0)) Q $$EXTERNAL^DIDU(C,.01,"",$P(^(0),U))
"RTN","DIQG",52,0)
 Q $S(C["D":$$FMTE^DILIBF(X,"1U"),1:X)
"RTN","DIQG",53,0)
 ;
"RTN","DIQG",54,0)
REAL I $E($P(DIQGD4,";",2))="E" S Y=$E($G(@DIQGSI@(DA,P)),$E($P($P(DIQGD4,";",2),","),2,99),$P($P(DIQGD4,";",2),",",2)) S:Y?." " Y=""
"RTN","DIQG",55,0)
AUDIT I $G(DIQGAUDD) D  ;Is there an AUDIT TRAIL for the field?
"RTN","DIQG",56,0)
 .I $G(DIQGAUDR(DFF,$$DA^DIQGQ(.DA))) S Y="" Q  ;If entry was created after DIQGAUDD, we know there were no FIELD values!
"RTN","DIQG",57,0)
 .S P=$G(DIQGAUDR(DFF,$$DA^DIQGQ(.DA),DIQGDRN))
"RTN","DIQG",58,0)
 .I P S Y=$$DIA^DIAUTL(DIQGAUDD,DIQGAUDR,P)
"RTN","DIQG",59,0)
 .Q:C'["P"!'Y  N F S F=+$P(C,"P",2) Q:F=DIQGEY("FILE")&(Y=DA)
"RTN","DIQG",60,0)
 .S Y=$$GET1^DIQ(F,Y_",",.01,"A"_DIQGAUDD),C=$TR(C,"PO") ;Recurse to get old POINTER value (as long as recursion isn't infinite!)
"RTN","DIQG",61,0)
 I 'DIQGPI&(C["O"!(C["S")!(C["P")!(C["V")!(C["D"))&($D(@DIQGDN@(DIQGDRN,0))) S C=$P(^(0),"^",2) Q $$EXTERNAL^DIDU(+$P(DIQGDN,"(",2),DIQGDRN,"",Y)
"RTN","DIQG",62,0)
 Q $G(Y)
"RTN","DIQG",63,0)
 ;
"RTN","DIQG",64,0)
BMW I C,$P(^DD(+C,.01,0),"^",2)["W" Q:DIQGWPB "$CREF$"_DIQGR_DA_","_$$Q^DIQGU(P)_")" D  G:X="" FE Q:DIQGWPO $NA(@DIQGETA) Q:DIQGIPAR "$WP$" Q ""
"RTN","DIQG",65,0)
 .I DIQGETA']"" K X S X(1)="TARGET ARRAY" D BLD^DIALOG(202,.X) S X="" Q
"RTN","DIQG",66,0)
 .S X=DIQGR_DA_","_$$Q^DIQGU(P)_")"
"RTN","DIQG",67,0)
 .I '$P($G(@X@(0)),"^",3) S X="" Q
"RTN","DIQG",68,0)
 .I DIQGZN M @DIQGETA=@X K @DIQGETA@(0) Q
"RTN","DIQG",69,0)
 .S Y=0 F  S Y=$O(@X@(Y)) Q:Y'>0  I $D(^(Y,0)) S @DIQGETA@(Y)=^(0)
"RTN","DIQG",70,0)
 .Q
"RTN","DIQG",71,0)
 I C,$P(^DD(+C,.01,0),"^",2)["M" Q $$F(.DIQGEY,11)
"RTN","DIQG",72,0)
 I DIQGPI!(DIQGDD) Q $G(Y)
"RTN","DIQG",73,0)
 Q $$F(.DIQGEY,8)
"RTN","DIQG",74,0)
CREF(X) N L,X1,X2,X3 S X1=$P(X,"("),X2=$P(X,"(",2,99),L=$L(X2),X3=$TR($E(X2,L),",)"),X2=$E(X2,1,(L-1))_X3 Q X1_$S(X2]"":"("_X2_")",1:"")
"RTN","DIQG",75,0)
WP(DIQGSA,DIQGTA,DIQGZN,DIQGP) N DIQG S DIQG=0 F  S DIQG=$O(@DIQGSA@(DIQG)) Q:DIQG'>0  I $D(^(DIQG,0)) S @$S(DIQGZN:"@DIQGTA@(DIQG,0)",1:"@DIQGTA@(DIQG)")=^(0)
"RTN","DIQG",76,0)
 Q:DIQGP "$WP$" Q ""
"RTN","DIQG",77,0)
DY(Y) Q $$FMTE^DILIBF(Y,"1U")
"RTN","DIQG",78,0)
IEN(IEN,DA) S DA=$P(IEN,",") N I F I=2:1 Q:$P(IEN,",",I)=""  S DA(I-1)=$P(IEN,",",I)
"RTN","DIQG",79,0)
 Q
"RTN","DIQG",80,0)
DDROOT(X) Q:'$D(^DD(X)) "" Q "^DD("_X_","
"RTN","DIQG",81,0)
 ;
"RTN","DIQG",82,0)
CMPAUD(DEXPR,DIQGS) ;DEXPR is Expression, DIQGS is string of Fields used
"RTN","DIQG",83,0)
 Q:'$G(DIQGAUDD)
"RTN","DIQG",84,0)
 N I,F,FD,A
"RTN","DIQG",85,0)
 F I=1:1 S F=$P(DIQGS,";",I) Q:F=""  D
"RTN","DIQG",86,0)
 .S A=$G(DIQGAUDR(+F,$$DA^DIQGQ(.DA),$P(F,U,2)))
"RTN","DIQG",87,0)
 .I A S DIQGS(1,+F,$P(F,U,2))=""""_$$CONVQQ^DILIBF($$DIA^DIAUTL(DIQGAUDD,+F,A))_""""
"RTN","DIQG",88,0)
 S DIQGS("TODAY")=DIQGAUDD\1,DIQGS("TODAY","DATE")=1,DIQGS("NOW")=DIQGAUDD,DIQGS("NOW","DATE")=1 ;'TODAY' is the old date!
"RTN","DIQG",89,0)
 ;now we call DICOMP with old (audit) values plugged in to the field's Computed Expression --
"RTN","DIQG",90,0)
 D EXPR(DIQGAUDR,DEXPR)
"RTN","DIQG",91,0)
 Q
"RTN","DIQG",92,0)
EXPR(DIFILE,DIEXPR) I DIQGPI S DIEXPR="INTERNAL("_DIEXPR_")"
"RTN","DIQG",93,0)
 D EXPR^DICOMP(DIFILE,"",DIEXPR,.DIQGS)
"RTN","DIQG",94,0)
 I 'DIQGPI,$G(Y)["D",Y'["m",$D(X)#2 S X=X_" S X=$$FMTE^DILIBF(X,""5U"")"
"RTN","DIQG",95,0)
 Q
"RTN","DIQG",96,0)
 ;
"RTN","DIQG",97,0)
F(DIQGEY,X) D BLD^DIALOG($P($T(TXT+X),";",4),.DIQGEY)
"RTN","DIQG",98,0)
FE I $G(DIQGERRA)]"" D CALLOUT^DIEFU(DIQGERRA)
"RTN","DIQG",99,0)
 Q ""
"RTN","DIQG",100,0)
TXT ;;
"RTN","DIQG",101,0)
 ;;file root/ref invalid;202;1
"RTN","DIQG",102,0)
 ;;record invalid;202;2
"RTN","DIQG",103,0)
 ;;multiline computed;520;3
"RTN","DIQG",104,0)
 ;;file ref invalid;202;4
"RTN","DIQG",105,0)
 ;;field name/number invalid;202;5
"RTN","DIQG",106,0)
 ;;DD ref for file/field invalid;401;6
"RTN","DIQG",107,0)
 ;;unable to find field name;200;7
"RTN","DIQG",108,0)
 ;;unable to identify type of data in DD;510;8
"RTN","DIQG",109,0)
 ;;unable to resolve extended ref;501;9
"RTN","DIQG",110,0)
 ;;field ref missing;202;10
"RTN","DIQG",111,0)
 ;;multiple field - invalid parameters;309;11
"RTN","DIQG",112,0)
 ;;file number not passed or invalid;202;12
"RTN","DIQG",113,0)
 ;;;;13
"RTN","DIQG",114,0)
 ;;invalid target array;202;14
"RTN","DIQG",115,0)
 ;;ambiguous field name;505;15
"RTN","DIQG",116,0)
 ;;record unavailable;602;16
"RTN","DIQG",117,0)
 ;;invalid attribute;202;17
"RTN","DIQG",118,0)
 ;;file not found;202;18
"RTN","DIQG",119,0)
 ;;record entry does not exist;601;19
"RTN","DIQG",120,0)
 ;;;;20
"VER")
8^22.0
**END**
**END**
