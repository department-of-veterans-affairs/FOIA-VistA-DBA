Released PSJ*5*129 SEQ #139
Extracted from mail message
**KIDS**:PSJ*5.0*129^

**INSTALL NAME**
PSJ*5.0*129
"BLD",5279,0)
PSJ*5.0*129^INPATIENT MEDICATIONS^0^3051109^y
"BLD",5279,1,0)
^^15^15^3051109^
"BLD",5279,1,1,0)
 1. When finishing a pending renewal order, if the order is edited
"BLD",5279,1,2,0)
 such that the number of dispense drugs associated with the order after
"BLD",5279,1,3,0)
 verification is less than the number of dispense drugs associated with
"BLD",5279,1,4,0)
 the order prior to renew, an index used by the pick list incorrectly
"BLD",5279,1,5,0)
 retains entries associated with the old dispense drugs. This may cause
"BLD",5279,1,6,0)
 problems with pick lists and extracts. With this patch, the correct
"BLD",5279,1,7,0)
 number of dispense drugs will be stored with renewal orders for which the
"BLD",5279,1,8,0)
 number of dispense drugs was reduced during the finish of the order.
"BLD",5279,1,9,0)
 AMA-1204-71370.
"BLD",5279,1,10,0)
 
"BLD",5279,1,11,0)
 2. Updated pick lists display doses for renewed orders that may already
"BLD",5279,1,12,0)
 have been dispensed prior to the renewal. With this patch, doses for a
"BLD",5279,1,13,0)
 renewed order will appear on the pick list update beginning with doses
"BLD",5279,1,14,0)
 due after the latter of the renew date and the order's stop date prior
"BLD",5279,1,15,0)
 to renewal. TNV-0205-31276.
"BLD",5279,4,0)
^9.64PA^^
"BLD",5279,6)
12^
"BLD",5279,"ABPKG")
n
"BLD",5279,"KRN",0)
^9.67PA^8989.52^19
"BLD",5279,"KRN",.4,0)
.4
"BLD",5279,"KRN",.401,0)
.401
"BLD",5279,"KRN",.402,0)
.402
"BLD",5279,"KRN",.403,0)
.403
"BLD",5279,"KRN",.5,0)
.5
"BLD",5279,"KRN",.84,0)
.84
"BLD",5279,"KRN",3.6,0)
3.6
"BLD",5279,"KRN",3.8,0)
3.8
"BLD",5279,"KRN",9.2,0)
9.2
"BLD",5279,"KRN",9.8,0)
9.8
"BLD",5279,"KRN",9.8,"NM",0)
^9.68A^7^6
"BLD",5279,"KRN",9.8,"NM",2,0)
PSGPL0^^0^B34905695
"BLD",5279,"KRN",9.8,"NM",3,0)
PSGPLUP^^0^B25061652
"BLD",5279,"KRN",9.8,"NM",4,0)
PSGOTR^^0^B10174903
"BLD",5279,"KRN",9.8,"NM",5,0)
PSGPEN^^0^B39805137
"BLD",5279,"KRN",9.8,"NM",6,0)
PSGPLUP0^^0^B22975359
"BLD",5279,"KRN",9.8,"NM",7,0)
PSGPLR^^0^B38211452
"BLD",5279,"KRN",9.8,"NM","B","PSGOTR",4)

"BLD",5279,"KRN",9.8,"NM","B","PSGPEN",5)

"BLD",5279,"KRN",9.8,"NM","B","PSGPL0",2)

"BLD",5279,"KRN",9.8,"NM","B","PSGPLR",7)

"BLD",5279,"KRN",9.8,"NM","B","PSGPLUP",3)

"BLD",5279,"KRN",9.8,"NM","B","PSGPLUP0",6)

"BLD",5279,"KRN",19,0)
19
"BLD",5279,"KRN",19.1,0)
19.1
"BLD",5279,"KRN",101,0)
101
"BLD",5279,"KRN",409.61,0)
409.61
"BLD",5279,"KRN",771,0)
771
"BLD",5279,"KRN",870,0)
870
"BLD",5279,"KRN",8989.51,0)
8989.51
"BLD",5279,"KRN",8989.52,0)
8989.52
"BLD",5279,"KRN",8994,0)
8994
"BLD",5279,"KRN","B",.4,.4)

"BLD",5279,"KRN","B",.401,.401)

"BLD",5279,"KRN","B",.402,.402)

"BLD",5279,"KRN","B",.403,.403)

"BLD",5279,"KRN","B",.5,.5)

"BLD",5279,"KRN","B",.84,.84)

"BLD",5279,"KRN","B",3.6,3.6)

"BLD",5279,"KRN","B",3.8,3.8)

"BLD",5279,"KRN","B",9.2,9.2)

"BLD",5279,"KRN","B",9.8,9.8)

"BLD",5279,"KRN","B",19,19)

"BLD",5279,"KRN","B",19.1,19.1)

"BLD",5279,"KRN","B",101,101)

"BLD",5279,"KRN","B",409.61,409.61)

"BLD",5279,"KRN","B",771,771)

"BLD",5279,"KRN","B",870,870)

"BLD",5279,"KRN","B",8989.51,8989.51)

"BLD",5279,"KRN","B",8989.52,8989.52)

"BLD",5279,"KRN","B",8994,8994)

"BLD",5279,"QUES",0)
^9.62^^
"BLD",5279,"REQB",0)
^9.611^3^2
"BLD",5279,"REQB",2,0)
PSJ*5.0*125^2
"BLD",5279,"REQB",3,0)
PSJ*5.0*133^2
"BLD",5279,"REQB","B","PSJ*5.0*125",2)

"BLD",5279,"REQB","B","PSJ*5.0*133",3)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
129^3051109^10000000009
"PKG",197,22,1,"PAH",1,1,0)
^^15^15^3051109
"PKG",197,22,1,"PAH",1,1,1,0)
 1. When finishing a pending renewal order, if the order is edited
"PKG",197,22,1,"PAH",1,1,2,0)
 such that the number of dispense drugs associated with the order after
"PKG",197,22,1,"PAH",1,1,3,0)
 verification is less than the number of dispense drugs associated with
"PKG",197,22,1,"PAH",1,1,4,0)
 the order prior to renew, an index used by the pick list incorrectly
"PKG",197,22,1,"PAH",1,1,5,0)
 retains entries associated with the old dispense drugs. This may cause
"PKG",197,22,1,"PAH",1,1,6,0)
 problems with pick lists and extracts. With this patch, the correct
"PKG",197,22,1,"PAH",1,1,7,0)
 number of dispense drugs will be stored with renewal orders for which the
"PKG",197,22,1,"PAH",1,1,8,0)
 number of dispense drugs was reduced during the finish of the order.
"PKG",197,22,1,"PAH",1,1,9,0)
 AMA-1204-71370.
"PKG",197,22,1,"PAH",1,1,10,0)
 
"PKG",197,22,1,"PAH",1,1,11,0)
 2. Updated pick lists display doses for renewed orders that may already
"PKG",197,22,1,"PAH",1,1,12,0)
 have been dispensed prior to the renewal. With this patch, doses for a
"PKG",197,22,1,"PAH",1,1,13,0)
 renewed order will appear on the pick list update beginning with doses
"PKG",197,22,1,"PAH",1,1,14,0)
 due after the latter of the renew date and the order's stop date prior
"PKG",197,22,1,"PAH",1,1,15,0)
 to renewal. TNV-0205-31276.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","PSGOTR")
0^4^B10174903
"RTN","PSGOTR",1,0)
PSGOTR ;BIR/CML3-TRANSFERS RENEW DATA FROM 53.1 TO 55 ;23 SEP 03 / 7:54 AM
"RTN","PSGOTR",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**110,127,133,129**;16 DEC 97
"RTN","PSGOTR",3,0)
 ;
"RTN","PSGOTR",4,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOTR",5,0)
 ;
"RTN","PSGOTR",6,0)
START(ODA,DA) ; lock record, and write
"RTN","PSGOTR",7,0)
 N OFD,PVND4 S OFD=""
"RTN","PSGOTR",8,0)
 S OFD=$P($G(^PS(55,PSGP,5,DA,2)),"^",4) K:OFD ^PS(55,"AUD",+OFD,PSGP,+DA)
"RTN","PSGOTR",9,0)
 S ND2=^PS(53.1,+ODA,2) S ^PS(55,"AUD",+$P(ND2,"^",4),PSGP,DA)=""
"RTN","PSGOTR",10,0)
 F X=6,7 I $D(^PS(53.1,+ODA,X)) S ^PS(55,PSGP,5,DA,X)=^(X)
"RTN","PSGOTR",11,0)
 I $O(^PS(53.1,+ODA,1,0)) D
"RTN","PSGOTR",12,0)
 .K ^PS(55,PSGP,5,DA,1)
"RTN","PSGOTR",13,0)
 .S (C,X)=0 F  S X=$O(^PS(53.1,+ODA,1,X)) Q:'X  S:$D(^(X,0)) C=C+1,^PS(55,PSGP,5,DA,1,C,0)=^(0),^PS(55,PSGP,5,DA,1,"B",+$P($G(^(0)),U),C)=""
"RTN","PSGOTR",14,0)
 .S ^PS(55,PSGP,5,DA,1,0)="^55.07P^"_C_"^"_C
"RTN","PSGOTR",15,0)
 F X=3,12 D  S ^PS(55,PSGP,5,DA,X,0)="^55.0"_$S(X=3:8,1:612)_U_CNT_U_CNT
"RTN","PSGOTR",16,0)
 .S CNT=0 F C=0:0 S C=$O(^PS(53.1,+ODA,X,C)) Q:'C  I $D(^(C,0)) S ^PS(55,PSGP,5,DA,X,C,0)=^(0),CNT=CNT+1
"RTN","PSGOTR",17,0)
 S $P(^PS(53.1,+ODA,0),"^",19)=DA
"RTN","PSGOTR",18,0)
 S $P(^PS(55,PSGP,5,DA,0),"^",7)=$P(^PS(53.1,+ODA,0),"^",7)
"RTN","PSGOTR",19,0)
 N PSGPND0,PSGPND2,RDUZ,OND14 S PSGPND0=^PS(53.1,+ODA,0),PSGPND2=^(2) S RNWDT=$P(PSGPND0,"^",16),PSGOEPR=$P(PSGPND0,"^",2)
"RTN","PSGOTR",20,0)
 S PSGFD=$P(PSGPND2,"^",4),PSJNOO=$P(^PS(53.1,+ODA,.2),"^",3) S OND14=$$LASTREN^PSJLMPRI(PSGP,+ODA_"P") S RDUZ=$P(OND14,"^",2) S:$P(OND14,"^",3) PSGOEPR=$P(OND14,"^",3)
"RTN","PSGOTR",21,0)
 I '$G(DUOUT) D
"RTN","PSGOTR",22,0)
 .I $G(PSJORD)["P" N PSGFDO S PSGFDO=$$LASTREN^PSJLMPRI(PSGP,PSJORD),PSGFDO=$P(PSGFDO,"^",4)
"RTN","PSGOTR",23,0)
 .D UPDREN^PSGOER(DA_"U",RNWDT,PSGOEPR,$S($G(PSGFDO):PSGFDO,1:PSGFD),PSJNOO,RDUZ)
"RTN","PSGOTR",24,0)
 S PVND4=$G(^PS(53.1,+ODA,4)) I $P(PVND4,"^"),$P(PVND4,"^",2) D
"RTN","PSGOTR",25,0)
 .N RNDT S RNDT=$$LASTREN^PSJLMPRI(DFN,+ODA_"P") Q:RNDT>$P(PVND4,"^",2)
"RTN","PSGOTR",26,0)
 .S $P(^PS(55,DFN,5,DA,4),"^")=$P(PVND4,"^"),$P(^PS(55,DFN,5,DA,4),"^",2)=$P(PVND4,"^",2)
"RTN","PSGOTR",27,0)
CR ; set x-refs
"RTN","PSGOTR",28,0)
 I $D(^PS(55,PSGP,5.1)),$P(^(5.1),"^",6) S X=$P(^(5.1),"^",6) I $P(ND2,"^",3),$P(ND2,"^",6)'>X S $P(^(5.1),"^",6)=$P(ND2,"^",3)
"RTN","PSGOTR",29,0)
 S ^PS(55,PSGP,5,"B",+ODA,DA)="",^PS(55,"AUE",PSGP,DA)=""
"RTN","PSGOTR",30,0)
 F S="C","O","P","R","OC" K ^PS(55,PSGP,5,"AU",S,+$P(PSGPND2,"^",4),DA)
"RTN","PSGOTR",31,0)
 S ^PS(55,PSGP,5,"AU",$P(PSGPND0,"^",7),+$P(PSGPND2,"^",4),DA)=""
"RTN","PSGOTR",32,0)
 S ^PS(55,PSGP,5,"AUS",+$P(ND2,"^",4),DA)="" I OFD,OFD'=$P(ND2,"^",4) K ^PS(55,PSGP,5,"AUS",+OFD,DA)
"RTN","PSGOTR",33,0)
 I $$PATCH^XPDUTL("PXRM*1.5*12") S X(1)=+$P(ND2,"^",2),X(2)=+$P(ND2,"^",4),DA(1)=PSGP D SPSPA^PSJXRFS(.X,.DA,"UD")
"RTN","PSGOTR",34,0)
 K DIK S DA(1)=PSGP S DIK="^PS(55,"_DA(1)_",5,",DIK(1)=125 D EN1^DIK K DIK
"RTN","PSGOTR",35,0)
 S PSGTOL=2,PSGTOO=1 F PSGUOW=0:0 S PSGUOW=$O(^PS(53.41,2,1,PSGUOW)) Q:'PSGUOW  I $D(^(PSGUOW,1,PSGP,1,2,1,+ODA)) K ^(+ODA) D ENL^PSGVDS
"RTN","PSGOTR",36,0)
DONE I $D(PSGOE2),PSGOE2]"",$D(^TMP("PSJON",$J,PSGOE2)) S ^(PSGOE2)=DA_"U"
"RTN","PSGOTR",37,0)
 S PSGODA=ODA,PSGORD=DA_"U"
"RTN","PSGOTR",38,0)
 F Q=0:0 S Q=$O(^PS(53.44,Q)) Q:'Q  I $D(^(Q,1,PSGP,+ODA,0)) S $P(^(0),"^",2)=DA
"RTN","PSGOTR",39,0)
 L -^PS(53.1,ODA) L -^PS(55,DFN,5,+PSGORD) K CNT,ND,ODA,XX,ZND Q
"RTN","PSGPEN")
0^5^B39805137
"RTN","PSGPEN",1,0)
PSGPEN ;BIR/CML3-FIND DEFAULT FOR PRE-EXCHANGE NEEDS ;03 Feb 99 / 9:13 AM
"RTN","PSGPEN",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**30,37,50,58,115,110,127,129**;16 DEC 97
"RTN","PSGPEN",3,0)
 ;
"RTN","PSGPEN",4,0)
 ; References to ^PSD(58.8 supported by DBIA #2283.
"RTN","PSGPEN",5,0)
 ; References to ^PSI(58.1 supported by DBIA #2284.
"RTN","PSGPEN",6,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSGPEN",7,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSGPEN",8,0)
 ; Reference to ^PS(59.7 is supported by DBIA #2181.
"RTN","PSGPEN",9,0)
 ;
"RTN","PSGPEN",10,0)
EN(PSGPENO) ;
"RTN","PSGPEN",11,0)
 S PSGPENO=+PSGPENO
"RTN","PSGPEN",12,0)
 N PSJSITE,PSJPRN S PSJSITE=0,PSJSITE=$O(^PS(59.7,PSJSITE)) I $P($G(^(PSJSITE,26)),U,5)=1 S PSJPRN=1
"RTN","PSGPEN",13,0)
 D NOW^%DTC S PSGDT=%,DT=$$DT^XLFDT,PSGPEN="" S ND=$G(^PS(55,PSGP,5,PSGPENO,0))
"RTN","PSGPEN",14,0)
 S PSGPENWS=0 I PSJPWD F Q=0:0 S Q=$O(^PS(55,PSGP,5,PSGPENO,1,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3),($D(^PSI(58.1,"D",+ND,PSJPWD))!$D(^PSD(58.8,"D",+ND,PSJPWD))) S PSGPENWS=1 Q
"RTN","PSGPEN",15,0)
 I PSGPENWS F  S Q=$O(^PS(55,PSGP,5,PSGPENO,1,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3) S:'$D(^PSI(58.1,"D",+ND,PSJPWD))&'$D(^PSD(58.8,"D",+ND,PSJPWD)) PSGPENWS=0 Q:'PSGPENWS  S $P(PSGPENWS,"^",2)=1
"RTN","PSGPEN",16,0)
 I PSGPENWS W !!,"The dispense drug",$E("s",$P(PSGPENWS,"^",2))," for this order ",$S($P(PSGPENWS,"^",2):"are",1:"is a")," WARD STOCK item",$E("s",$P(PSGPENWS,"^",2)),"." S PSGPEN=0
"RTN","PSGPEN",17,0)
 I 'PSGPENWS,PSJPWD S WG=+$O(^PS(57.5,"AB",PSJPWD,0)),PSGPLS=$P($G(^PS(55,PSGP,5,PSGPENO,2)),"^",2) I PSGPLS D
"RTN","PSGPEN",18,0)
 .S PSGPLF=$O(^PS(53.5,"AB",WG,PSGDT))
"RTN","PSGPEN",19,0)
 .N RNDT,PSJRNOS S RNDT=$$LASTREN^PSJLMPRI(PSGP,$S($G(PSJORD)["P":PSJORD,1:"")),PSJRNOS=$P(RNDT,"^",4) I PSJRNOS,'$G(PSJREN) S PSGPLS=PSJRNOS
"RTN","PSGPEN",20,0)
 .I $G(PSJREN),$G(PSJORD)["U" S PSJRNOS=$P(^PS(55,PSGP,5,+PSJORD,2),"^",4) S PSGPLS=$S(PSJRNOS>PSGDT:PSJRNOS,1:$$DATE2^PSJUTL2(PSGDT))
"RTN","PSGPEN",21,0)
 .D:'PSGPLF GF I PSGPLF S PSGPLO=PSGPENO D NCE,^PSGPL0 S:PSGPLC'<0 PSGPEN=PSGPLC
"RTN","PSGPEN",22,0)
 I $G(PSGPRIO)="DONE" S PSGPEN=0
"RTN","PSGPEN",23,0)
 ;
"RTN","PSGPEN",24,0)
UPDD ;
"RTN","PSGPEN",25,0)
 N DIR S DIR(0)="NOA^0:9999:0",DIR("A")="Pre-Exchange DOSES: ",DIR("?")="^D DH^PSGPEN" S:PSGPEN]"" DIR("B")=PSGPEN W ! D ^DIR G:'Y DONE S PSGY=+Y W !!,"...updating dispense drug(s)..."
"RTN","PSGPEN",26,0)
 F FQ=0:0 S FQ=$O(^PS(55,PSGP,5,PSGPENO,1,FQ)) Q:'FQ  S ND=$G(^(FQ,0)),$P(^(0),"^",9)="" I ND,'$P(ND,"^",3) D DD
"RTN","PSGPEN",27,0)
 ;
"RTN","PSGPEN",28,0)
DONE ;
"RTN","PSGPEN",29,0)
 I $P(PSJSYSW0,"^",29)="",$$DEFON^PSGPER1 S $P(PSJSYSW0,"^",29)=0
"RTN","PSGPEN",30,0)
 K PSGID,PSGMAR,PSGOD,PSGPLC,PSGPLF,PSGPLO,PSGPLS,PSGPLUD,WG S:$G(PSJREN) DUOUT=0 Q
"RTN","PSGPEN",31,0)
 ;
"RTN","PSGPEN",32,0)
NCE ;
"RTN","PSGPEN",33,0)
 W !!,"The next cart exchange is ",$$ENDTC^PSGMI(PSGPLF),! Q
"RTN","PSGPEN",34,0)
 ;
"RTN","PSGPEN",35,0)
GF ;
"RTN","PSGPEN",36,0)
 S QQ=0 F Q=0:0 S Q=$O(^PS(53.5,"AB",WG,Q)) Q:'Q  S QQ=Q
"RTN","PSGPEN",37,0)
 I QQ S QQ=$O(^PS(53.5,"AB",WG,QQ,0)) I QQ,$D(^PS(53.5,QQ,0)) S QQ=$P(^(0),"^",4) I QQ>PSGDT S PSGPLF=QQ
"RTN","PSGPEN",38,0)
 Q
"RTN","PSGPEN",39,0)
 ;
"RTN","PSGPEN",40,0)
DD ;
"RTN","PSGPEN",41,0)
 N DA S DRG=$S($P(ND,"^")="":"NOT FOUND",'$D(^PSDRUG(+ND,0)):"NOT FOUND ("_$P(ND,"^")_")",$P(^(0),"^")]"":$P(^(0),"^"),1:$P(ND,"^")_";PSDRUG("),UD=$S('$P(ND,"^",2):1,1:$P(ND,"^",2))
"RTN","PSGPEN",42,0)
 W !,"...",DRG,?45,"U/D: ",UD,"..."
"RTN","PSGPEN",43,0)
 S PSGDA=PSGY I 'PSGPENWS,ND,PSJPWD,($D(^PSI(58.1,"D",+ND,PSJPWD))!$D(^PSD(58.8,"D",+ND,PSJPWD))) D PSGPENWS Q:'PSGDA
"RTN","PSGPEN",44,0)
 K DA,DR S PSGDA=$S(UD#1:(PSGDA*((UD\1)+1)),1:PSGDA*UD)
"RTN","PSGPEN",45,0)
 S DIE="^PS(55,"_PSGP_",5,"_PSGPENO_",1,",DA(2)=PSGP,DA(1)=PSGPENO,DA=FQ,DR=".09////"_PSGDA D ^DIE
"RTN","PSGPEN",46,0)
 S PSGPXN=$G(PSGPXN)
"RTN","PSGPEN",47,0)
 D:'PSGPXN
"RTN","PSGPEN",48,0)
 .D NOW^%DTC L +^PS(53.4,0):0 S ND=$G(^PS(53.4,0)) S:ND="" ND="PRE-EXCHANGE NEEDS^53.4P" F PSGPXN=$P(ND,"^",3)+1:1 I '$D(^PS(53.4,PSGPXN)) L +^PS(53.4,PSGPXN):0 I  S ^PS(53.4,0)=$P(ND,"^",1,2)_"^"_PSGPXN_"^"_($P(ND,"^",4)+1) L -^PS(53.4,0) Q
"RTN","PSGPEN",49,0)
 .S ^PS(53.4,PSGPXN,0)=DUZ_"^"_%,^PS(53.4,"B",DUZ,PSGPXN)="",^PS(53.4,"AUD",DUZ,%,PSGPXN)="" L -^PS(53.4,PSGPXN) Q
"RTN","PSGPEN",50,0)
 I $D(^PS(53.4,PSGPXN,1,PSGP,1,PSGPENO,1,FQ,0)) S $P(^(0),"^",2)=$P(^(0),"^",2)+PSGDA Q
"RTN","PSGPEN",51,0)
 ; naked reference below refers to line above
"RTN","PSGPEN",52,0)
 S ^(0)=FQ_"^"_PSGDA I $D(^PS(53.4,PSGPXN,1,PSGP,1,PSGPENO,1,0)) S $P(^(0),"^",3,4)=FQ_"^"_($P(^(0),"^",4)+1) Q
"RTN","PSGPEN",53,0)
 ; naked reference below refers to line above
"RTN","PSGPEN",54,0)
 S ^(0)="^53.401101A^"_FQ_"^1" Q:$D(^PS(53.4,PSGPXN,1,PSGP,1,PSGPENO,0))  S ^(0)=PSGPENO
"RTN","PSGPEN",55,0)
 I $D(^PS(53.4,PSGPXN,1,PSGP,1,0)) S $P(^(0),"^",3,4)=PSGPENO_"^"_($P(^(0),"^",4)+1) Q
"RTN","PSGPEN",56,0)
 ; naked reference below is from line above
"RTN","PSGPEN",57,0)
 S ^(0)="^53.4011A^"_PSGPENO_"^1" Q:$D(^PS(53.4,PSGPXN,1,PSGP,0))  S ^(0)=PSGP
"RTN","PSGPEN",58,0)
 I $D(^PS(53.4,PSGPXN,1,0)) S $P(^(0),"^",3,4)=PSGP_"^"_($P(^(0),"^",4)+1) Q
"RTN","PSGPEN",59,0)
 ; naked reference below is from line above
"RTN","PSGPEN",60,0)
 S ^(0)="^53.401PA^"_PSGP_"^1" Q
"RTN","PSGPEN",61,0)
 ;
"RTN","PSGPEN",62,0)
DH ;
"RTN","PSGPEN",63,0)
 W !!?2,"Enter a number from 0 to 9999, 0 decimal digits."
"RTN","PSGPEN",64,0)
 W !!?2,"Enter the number DOSES needed for this order until the next cart exchange.",!,"This will be the number of times the order will be administered to the patient",!,"from the start of the order until the next cart exchange."
"RTN","PSGPEN",65,0)
 W !!?2,"PLEASE NOTE that this is DOSES, and NOT UNITS.  The doses entered will be",!,"converted to units for each dispense drug of this order, as each dispense drug",!,"may have a different units per dose." Q
"RTN","PSGPEN",66,0)
 ;
"RTN","PSGPEN",67,0)
PSGPENWS ;
"RTN","PSGPEN",68,0)
 W !,"This dispense drug is a WARD STOCK item."
"RTN","PSGPEN",69,0)
 W !,"Would you like to:",!?3,"1 - Enter 0 (no) doses needed for this dispense drug.",!?3,"2 - Enter ",PSGDA," doses needed for this dispense drug.",!?3,"3 - Enter another amount as the doses needed for this dispense drug."
"RTN","PSGPEN",70,0)
 K DIR S DIR(0)="SA^1:0 (no) doses;2:"_PSGDA_" doses;3:another amount",DIR("A")="Select ACTION: ",DIR("?")="^D WH^PSGPEN" W ! D ^DIR I Y=1!'Y S PSGDA=0 Q
"RTN","PSGPEN",71,0)
 Q:Y=2  K DIR S DIR(0)="NA^0:9999:0",DIR("A")="Pre-Exchange DOSES for this dispense drug: ",DIR("?")="^D WDH^PSGPEN" W ! D ^DIR S PSGDA=+Y Q
"RTN","PSGPEN",72,0)
 ;
"RTN","PSGPEN",73,0)
WH ;
"RTN","PSGPEN",74,0)
 S Q="This dispense drug ("_DRG_") is a ward stock item.  Select:"
"RTN","PSGPEN",75,0)
 W !! F Q1=1:1:$L(Q," ") S Q2=$P(Q," ",Q1) W:$X+$L(Q2)>78 ! W Q2," "
"RTN","PSGPEN",76,0)
 W !?3,"1 to enter 0 (no) pre-exchange doses for this dispense drug.",!?3,"2 to enter ",PSGDA," doses for this dispense drug.",!?3,"3 to enter another amount for this dispense drug." Q
"RTN","PSGPEN",77,0)
 ;
"RTN","PSGPEN",78,0)
WDH ;
"RTN","PSGPEN",79,0)
 W !!?2,"Enter a number from 0 to 9999, 0 decimal digits.  If you enter an '^' to exit",!,"NO pre-exchange doses will be entered for this dispense drug." Q
"RTN","PSGPL0")
0^2^B34905695
"RTN","PSGPL0",1,0)
PSGPL0 ;BIR/CML3-GETS UNITS COUNT FOR PSGPL & PSGPEN ;29 OCT 96 / 8:31 PM
"RTN","PSGPL0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**50,83,110,125,129**;16 DEC 97
"RTN","PSGPL0",3,0)
 ;
"RTN","PSGPL0",4,0)
 ; Reference to ^PS(51.1 supported by DBIA #2177.
"RTN","PSGPL0",5,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSGPL0",6,0)
 ;
"RTN","PSGPL0",7,0)
EN ;
"RTN","PSGPL0",8,0)
 K PSGMAR S PSGPLC=0 D RUN
"RTN","PSGPL0",9,0)
 ;
"RTN","PSGPL0",10,0)
DONE K HCD,HM,I,J,PSGD,PLSD,CD,M,MID,MN,ND,ND1,PREX,OD,ST,QD1,QD2,QQ,TS,UD,WDT,WS,WS1,X,X1,X2 Q
"RTN","PSGPL0",11,0)
 ;
"RTN","PSGPL0",12,0)
RUN ; quit if fill on request prn or stop date not found
"RTN","PSGPL0",13,0)
 S ND1=$P($G(^PS(55,PSGP,5,PSGPLO,0)),"^",7) Q:('$D(PSGMFOR)&(ND1="R"))  I $F("OCP",ND1)-1'>0,('$D(PSGMFOR)) S PSGPLC="OI" Q
"RTN","PSGPL0",14,0)
 S ND=$G(^PS(55,PSGP,5,PSGPLO,2)) Q:($P(ND,"^")["PRN")&('$D(PSJPRN))  Q:$P(ND,"^")="PRN"
"RTN","PSGPL0",15,0)
 S ST=$P(ND,"^",2) N RNDT S RNDT=$$LASTREN^PSJLMPRI(PSGP,+PSGPLO_"U")
"RTN","PSGPL0",16,0)
 I RNDT N OSTOP S OSTOP=$P(RNDT,"^",4) I $D(PSGPENO) S ST=$S((((RNDT<OSTOP))!$G(PSJREN)):+OSTOP,1:+RNDT)
"RTN","PSGPL0",17,0)
 I $G(PSJREN)&$G(PSJRNOS) S:PSJRNOS>$G(PSGDT) ST=PSJRNOS S:$G(PSGFD) $P(ND,"^",4)=PSGFD
"RTN","PSGPL0",18,0)
 S PLSD=$P(ND,"^",4),TS=$P(ND,"^",5)
"RTN","PSGPL0",19,0)
 S MN=$P(ND,"^",6),ND=$P(ND,"^") D:ND["PRN" SETMN I $S(ST'?7N1"."1N.E:1,1:PLSD'?7N1"."1N.E) S PSGPLC="OI" Q
"RTN","PSGPL0",20,0)
 ;Quit if One Time order and dosage was given through "PRE-EXCHANGE".
"RTN","PSGPL0",21,0)
 S PREX=$G(^PS(55,PSGP,5,PSGPLO,1,1,0)) I $$ONE^PSJBCMA(PSGP,PSGPLO_"U",$P(ND,"^",1))="O",$P(PREX,"^",12)'="",$P(PREX,"^",2)'="",$P(PREX,"^",2)'>$P(PREX,"^",12) Q
"RTN","PSGPL0",22,0)
ENIV ;*** Entry to be called from ^PSGMIV (24 HOUR MAR IV).
"RTN","PSGPL0",23,0)
 Q:ST'<PSGPLF  I ND1="O"!(ND1="OC")!(MN="O") S PSGPLC=PLSD'<PSGPLS S:ND1'["C"&PSGPLC PSGMAR($E(+$P(ST,".",2)_"0",1,2))="" Q
"RTN","PSGPL0",24,0)
 I (TS'>0!("24"'[$L($P(TS,"-")))),MN="",ND'["@" S PSGPLC="OI" Q
"RTN","PSGPL0",25,0)
 S CD=$S(PSGPLF>PLSD:PLSD,1:PSGPLF),OD=$S(ST>PSGPLS:ST,1:PSGPLS),MID=1 I ND["@"!(MN="D") G MWF
"RTN","PSGPL0",26,0)
 I MN>1440,TS,'(MN#1440) G TSFMN
"RTN","PSGPL0",27,0)
 I TS>0,"24"[$L($P(TS,"-")) S:PSGPLS>ST ST=PSGPLS G TS
"RTN","PSGPL0",28,0)
 ;
"RTN","PSGPL0",29,0)
MN ; if only minutes (MN) are found
"RTN","PSGPL0",30,0)
 I MN'>0 S PSGPLC="OI" Q
"RTN","PSGPL0",31,0)
 S (OD,X1)=PSGPLS,HM=MN,X2=ST D ^%DTC I X>1 S AM=X-1*1440\HM*HM D ADD S ST=X
"RTN","PSGPL0",32,0)
 S (CML,X)=ST F I=0:1 S AM=HM*I,ST=CML D:AM ADD Q:X>CD!(CD=PLSD&(X'<CD))  I X'<OD S PSGPLC=PSGPLC+1,PSGMAR($E($P(X,".",2)_"0",1,2))=""
"RTN","PSGPL0",33,0)
 S ST=CML Q
"RTN","PSGPL0",34,0)
 ;
"RTN","PSGPL0",35,0)
TSFMN ;if admin times exist and minutes#1440=0
"RTN","PSGPL0",36,0)
 S X=$P(ST,"."),MID=MN\1440 F I=0:1 S X1=$P(ST,"."),X2=MID*I D:X2 C^%DTC Q:X'<CD  I X'<(PSGPLS\1) S ST=$S(PSGPLS\1=X:$S(PSGPLS#1<(ST#1):ST,1:PSGPLS),PSGPLS\1<X:ST,1:PSGPLS) G TS
"RTN","PSGPL0",37,0)
 Q
"RTN","PSGPL0",38,0)
 ;
"RTN","PSGPL0",39,0)
TS ; admin times
"RTN","PSGPL0",40,0)
 F Q=1:1 S XX=$P(TS,"-",Q) Q:XX=""!(("."_XX)'<(ST#1))
"RTN","PSGPL0",41,0)
TS1 X:XX="" "S X1=ST\1,X2=MID D C^%DTC S ST=X,Q=1" F QQ=Q:1 S XX=$P(TS,"-",QQ) G:XX="" TS1 S ST=$P(ST,".")_"."_XX Q:ST>CD!(CD=PLSD&(ST'<CD))  S:PSGPLS'>ST PSGPLC=PSGPLC+1,PSGMAR($E(XX_"0",1,2))=""
"RTN","PSGPL0",42,0)
 Q
"RTN","PSGPL0",43,0)
 ;
"RTN","PSGPL0",44,0)
MWF ; schedule in form of WD-WD-WD@TS
"RTN","PSGPL0",45,0)
 S:ND["@" ND=$P(ND,"@") S:'TS TS=$E($P(ST,".",2)_"0000",1,4) S HCD=CD,X=$P(OD,".")
"RTN","PSGPL0",46,0)
 S MN="-" I ND'["-",ND?.E1P.E F FQ=1:1:$L(ND) I $E(ND,FQ)?1P S MN=$E(ND,FQ) Q
"RTN","PSGPL0",47,0)
 F FQ=0:1 S X1=$P(OD,"."),X2=FQ D:X2 C^%DTC Q:X>$P(HCD,".")  S CD=$S($P(HCD,".")>X:X_.24,1:HCD),ST=$S($P(OD,".")<X:X_.0001,1:OD) D DW^%DTC S X=X_"S" F FQ1=1:1:$L(ND,MN) I $P(X,$P(ND,MN,FQ1))="" D TS Q
"RTN","PSGPL0",48,0)
 Q
"RTN","PSGPL0",49,0)
 ;
"RTN","PSGPL0",50,0)
ADD ; ST=start date/time   AM=minutes (+ or -)  X=new date/time
"RTN","PSGPL0",51,0)
 S:'AM X=ST Q:'AM  S T=1 S:AM<0 T=-1,AM=-AM S X2=AM\1440,AM=AM-(X2*1440),H=AM\60,M=AM#60,HRS=+$E(ST_"00",9,10),MN=+$E(ST_"0000",11,12),X=ST\1
"RTN","PSGPL0",52,0)
 I M S MN=MN+(M*T) S:MN>59 MN=MN-60,H=H+1 S:MN<0 MN=MN+60,H=H+1
"RTN","PSGPL0",53,0)
 I H S HRS=HRS+(H*T) S:HRS>24!(HRS=24&MN) HRS=HRS-24,X2=X2+1 S:HRS<0 HRS=HRS+24,X2=X2+1
"RTN","PSGPL0",54,0)
 I X2 S X1=$P(X,"."),X2=X2*T D C^%DTC
"RTN","PSGPL0",55,0)
 S X=+(X_"."_$E(0,HRS<10)_HRS_$E(0,MN<10)_MN) K AM,H,HRS,M,MN,T Q
"RTN","PSGPL0",56,0)
 ;
"RTN","PSGPL0",57,0)
SETMN ; Set MN for PRN orders
"RTN","PSGPL0",58,0)
 Q:($G(MN)]"")!($G(TS)]"")!(ND["Q0")  S MNFL=0,MN="",TS="" F XX=0:0 S XX=$O(^PS(51.1,"AC","PSJ",ND,XX)) Q:'XX!(MNFL)  D
"RTN","PSGPL0",59,0)
 .S:$P($G(^PS(51.1,XX,0)),"^",3)'="" MN=$P($G(^(0)),"^",3),MNFL=1 S:$P($G(^(0)),"^",2)'="" TS=$P($G(^(0)),"^",2),MNFL=1 Q
"RTN","PSGPL0",60,0)
 I 'MNFL,$E(ND,1,3)'="PRN" D
"RTN","PSGPL0",61,0)
 .S PRND=$P(ND,"PRN") D:$E(PRND,$L(PRND))=" "  F XX=0:0 S XX=$O(^PS(51.1,"AC","PSJ",PRND,XX)) Q:'XX!(MNFL)  S:$P($G(^PS(51.1,XX,0)),"^",3)'="" MN=$P($G(^(0)),"^",3),MNFL=1 S:$P($G(^(0)),"^",2)'="" TS=$P($G(^(0)),"^",2),MNFL=1
"RTN","PSGPL0",62,0)
 ..F  S PRND=$E(PRND,1,$L(PRND)-1) Q:$E(PRND,$L(PRND))'=" "
"RTN","PSGPL0",63,0)
 I 'MNFL,$E(ND,1,3)="PRN" S PRND=$P(ND,"PRN",2) D:$E(PRND)=" "  F XX=0:0 S XX=$O(^PS(51.1,"AC","PSJ",PRND,XX)) Q:'XX!(MNFL)  S:$P($G(^PS(51.1,XX,0)),"^",3)'="" MN=$P($G(^(0)),"^",3),MNFL=1 S:$P($G(^(0)),"^",2)'="" TS=$P($G(^(0)),"^",2),MNFL=1
"RTN","PSGPL0",64,0)
 .F  S PRND=$E(PRND,2,$L(PRND)) Q:$E(PRND)'=" "
"RTN","PSGPL0",65,0)
 I 'MNFL D
"RTN","PSGPL0",66,0)
 .I PRND["@" D DW S:$D(PRND) TS=$P(PRND,"@",2) Q
"RTN","PSGPL0",67,0)
 .I $E(PRND,1,2)="AD" Q
"RTN","PSGPL0",68,0)
 .I $E(PRND,1,3)="BID"!($E(PRND,1,3)="TID")!($E(PRND,1,3)="QID") S MN=1440/$F("BTQ",$E(PRND)) Q
"RTN","PSGPL0",69,0)
 .S:$E(PRND)="Q" PRND=$E(PRND,2,99) S:'PRND PRND="1"_PRND S PRND1=+PRND,PRND=$P(PRND,+PRND,2),PRND2=0 S:PRND1<0 PRND1=-PRND1 S:$E(PRND)="X" PRND2=1,PRND=$E(PRND,2,99)
"RTN","PSGPL0",70,0)
 .S MN=$S((PRND["D"&(PRND'["AD"))!(PRND["AM")!(PRND["PM")!((PRND["HS")&(PRND'["THS")):1440,((PRND["H")&(PRND'["TH")):60,PRND["AC"!(PRND["PC"):480,PRND["W":10080,PRND["M":40320,1:-1) I MN>0 S:PRND["QO" MN=MN*2 S MN=MN*PRND1 Q:MN>0
"RTN","PSGPL0",71,0)
QUIT K XX,MNFL,PRND,PRND1,PRND2,QX,SDW,SWD,Z Q
"RTN","PSGPL0",72,0)
 ;
"RTN","PSGPL0",73,0)
DW ;
"RTN","PSGPL0",74,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=PRND,PRND=$P(PRND,"@",2) D ENCHK Q:'$D(PRND)  S PRND=$P(SDW,"@"),PRND(1)="-" I PRND?.E1P.E,PRND'["-" F QX=1:1:$L(PRND) I $E(PRND,QX)?1P S PRND(1)=$E(PRND,QX) Q
"RTN","PSGPL0",75,0)
 F Q=1:1:$L(PRND,PRND(1)) K:SWD="" PRND Q:SWD=""  S Z=$P(PRND,PRND(1),Q) D DWC Q:'$D(PRND)
"RTN","PSGPL0",76,0)
 K PRND(1) S:$D(PRND) PRND=SDW Q
"RTN","PSGPL0",77,0)
DWC I $L(Z)<2 K PRND Q
"RTN","PSGPL0",78,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSGPL0",79,0)
 E  K PRND
"RTN","PSGPL0",80,0)
 Q
"RTN","PSGPL0",81,0)
 ;
"RTN","PSGPL0",82,0)
ENCHK ;
"RTN","PSGPL0",83,0)
 I $S($L($P(PRND,"-"))>4:1,$L(PRND)>119:1,$L(PRND)<2:1,PRND'>0:1,1:PRND'?.ANP) K PRND Q
"RTN","PSGPL0",84,0)
 S PRND(1)=$P(PRND,"-") I PRND(1)'?2N,PRND(1)'?4N K PRND Q
"RTN","PSGPL0",85,0)
 S PRND(1)=$L(PRND(1)) I PRND'["-",PRND>$E(2400,1,PRND(1)) K PRND Q
"RTN","PSGPL0",86,0)
 F PRND(2)=2:1:$L(PRND,"-") S PRND(3)=$P(PRND,"-",PRND(2)) I $S($L(PRND(3))'=PRND(1):1,PRND(3)>$E(2400,1,PRND(1)):1,1:PRND(3)'>$P(PRND,"-",PRND(2)-1)) K PRND Q
"RTN","PSGPL0",87,0)
 K:$D(PRND) PRND(1),PRND(2),PRND(3) Q
"RTN","PSGPL0",88,0)
  
"RTN","PSGPL0",89,0)
  
"RTN","PSGPLR")
0^7^B38211452
"RTN","PSGPLR",1,0)
PSGPLR ;BIR/CML3-PRINTS PICK LIST REPORT ;04 May 98 / 11:23 AM
"RTN","PSGPLR",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**10,50,67,119,129**;16 DEC 97
"RTN","PSGPLR",3,0)
 ;
"RTN","PSGPLR",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGPLR",5,0)
 ; Reference to ^PS(59.7 is supported by DBIA# 2181.
"RTN","PSGPLR",6,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSGPLR",7,0)
 ; Reference to ^%DTC is supported by DBIA# 10000.
"RTN","PSGPLR",8,0)
 ; Reference to ^VADPT is supported by DBIA# 10061.
"RTN","PSGPLR",9,0)
 ;
"RTN","PSGPLR",10,0)
 N PSGY,OLDWARD,STPDT D NOW^%DTC S PSGDT=+$E(%,1,12),PPLD=$$ENDTC^PSGMI(PSGDT),$P(OLINE,"-",75)="",PSGPLXR=$S($G(PSGPLUPF)=1:"AU",1:"AC")
"RTN","PSGPLR",11,0)
 S PGN=0,(FACL,LINE)="",$P(LINE,"-",81)="",$P(FACL,"_",31)="",TND=$G(^PS(53.5,PSGPLG,0)),PSD=$P(TND,"^",3),PFD=$P(TND,"^",4),WSF=$P(TND,"^",7),WGPN=$S('$D(^PS(57.5,PSGPLWG,0)):"N/F",$P(^(0),"^")]"":$P(^(0),"^"),1:"N/F")
"RTN","PSGPLR",12,0)
 S FFF=$S($P(PSGPLWGP,"^",4):2,$P(PSGPLWGP,"^",5):1,1:0),CML=IO'=IO(0)!($E(IOST,1,2)'="C-")
"RTN","PSGPLR",13,0)
 F X="PSD","PFD" S @X=$$ENDTC^PSGMI(@X)
"RTN","PSGPLR",14,0)
 U IO
"RTN","PSGPLR",15,0)
 I '$D(^PS(53.5,$S($D(PSGPLUPF):"AU",1:"AC"),PSGPLG)) S NPLF=0 D HEADER W !!?25,"*** No orders to fill ***" W:(IO'=IO(0)!(IOST'["C-"))&($Y) @IOF G DONE
"RTN","PSGPLR",16,0)
 ;
"RTN","PSGPLR",17,0)
BEGIN ;
"RTN","PSGPLR",18,0)
 I '$$LOCK^PSGPLUTL(PSGPLG,"PSGPLR") H 60 G BEGIN
"RTN","PSGPLR",19,0)
 S NPLF=1,TM=0 F  S TM=$O(^PS(53.5,PSGPLXR,PSGPLG,TM)) Q:TM=""!(TM["~")  S (DDRG,PDRG,PN,PST,RM,WDN)="" D HEADER:'FFF,^PSGPLR0 I CML,'FFF D PAGECK W !!?25,"FILLED BY: ",FACL,!!?25,"CHECKED BY: ",FACL
"RTN","PSGPLR",20,0)
 I CML,FFF D PAGECK W !!?25,"FILLED BY: ",FACL,!!?25,"CHECKED BY: ",FACL W:$Y @IOF
"RTN","PSGPLR",21,0)
 ;
"RTN","PSGPLR",22,0)
DONE ;
"RTN","PSGPLR",23,0)
 D UNLOCK^PSGPLUTL(PSGPLG,"PSGPLR")
"RTN","PSGPLR",24,0)
 K AT,ATC,CML,DDRG,DIS,DND,DO,DR,DRN,DRG,FACL,FD,FFF,FQC,LINE,ND,ND0,ND1,ND2,ND6,NEED,NPLF,OLINE,PSGPLDC,PSGPLXR,PSGPLXRX
"RTN","PSGPLR",25,0)
 K PSJJORD,PSJORDN,PFD,PGN,PN,POP,PPLD,PPN,PRM,PSD,PSGID,PSGOD,PSGP,PST,PW,RM,RTE,SCH,SD,SM,PSSN,TD,TM,TND,WDN,WL,WG,WSF,WGPN,X
"RTN","PSGPLR",26,0)
 Q
"RTN","PSGPLR",27,0)
 ;
"RTN","PSGPLR",28,0)
DD ;
"RTN","PSGPLR",29,0)
 N PSJRNW,CNT
"RTN","PSGPLR",30,0)
 I $D(PSGPLREN("B",$G(PSGP),$G(PSJJORD))),$G(PSGPLUP) D
"RTN","PSGPLR",31,0)
 .N OSTOP,DRGND S (DDRG,OLDWARD)="" S DRGND=$O(PSGPLREN("B",PSGP,PSJJORD,0)) Q:'DRGND  S OSTOP=PSGPLREN("B",PSGP,PSJJORD,DRGND) Q:'OSTOP
"RTN","PSGPLR",32,0)
 .N ST,TMPDRG S CNT=0,ST=$P(ND0,"^",7) S TMPDRG=0 S TMPDRG=$O(PSGPLREN("B",PSGP,PSJJORD,TMPDRG)) S TMPDRG=$P(DRG,"^")_"^"_TMPDRG
"RTN","PSGPLR",33,0)
 .F PSGPLXRX="AU","AC" Q:CNT  F  S DDRG=$O(PSGPLREN(53.5,PSGPLXRX,PSGPLG,TM,WDN,RM,PN,PST,TMPDRG,DDRG)) Q:(DDRG="")!(DDRG="NO DISPENSE DRUG")  D
"RTN","PSGPLR",34,0)
 ..S X=$G(PSGPLREN(53.5,PSGPLG,1,PSGP,1,+DRGND,1,$P(DDRG,"^",2),0)) S DR=+X,DND=$P(X,U,2,4) Q:'X
"RTN","PSGPLR",35,0)
 ..S DRN=$G(^PS(55,PSGP,5,PSJJORD,1,DR,0)),DR=$$ENDDN^PSGMI($P(DRN,"^")) I DND?7N1"DI" S DND=$E($$ENDTC^PSGMI(+DND),1,8)
"RTN","PSGPLR",36,0)
 ..S DIS=$P(DND,"^",2),NEED=$S($P(DND,"^")]"":$P(DND,"^"),1:0)
"RTN","PSGPLR",37,0)
 ..S PSJRNW=1_"^"_+NEED
"RTN","PSGPLR",38,0)
 ..Q
"RTN","PSGPLR",39,0)
 .K PSGPLREN("B",PSGP,PSJJORD),PSGPLREN(53.5,PSGPLG,1,PSGP,1,+DRGND) W !!
"RTN","PSGPLR",40,0)
 ;
"RTN","PSGPLR",41,0)
 S CNT=0
"RTN","PSGPLR",42,0)
 S (DDRG,OLDWARD)="" N ST S ST=$P(ND0,"^",7) F  S DDRG=$O(^PS(53.5,PSGPLXR,PSGPLG,TM,WDN,RM,PN,PST,DRG,DDRG)) Q:(DDRG="")!(DDRG="NO DISPENSE DRUG")  S X=$G(^PS(53.5,PSGPLG,1,+$P(PN,U,2),1,+$P(DRG,U,2),1,+$P(DDRG,U,2),0)),DR=+X,DND=$P(X,U,2,4) D
"RTN","PSGPLR",43,0)
 .S DRN=$G(^PS(55,PSGP,5,PSJJORD,1,DR,0)),DR=$$ENDDN^PSGMI($P(DRN,"^")) I DND?7N1"DI" S DND=$E($$ENDTC^PSGMI(+DND),1,8) W !?6,DR,?48,ST,?51,"(DI "_DND_")",?66,"Returns: ____" Q
"RTN","PSGPLR",44,0)
 .S UD=$P(DRN,"^",2),ATC=$P($G(^PSDRUG(+DRN,8.5)),"^",2)]"" S:ATC ATC=$D(^(212,"AC",PSGPLWG))
"RTN","PSGPLR",45,0)
 .S DIS=$P(DND,"^",2),NEED=$S($P(DND,"^")]"":$P(DND,"^"),1:0) I ATC S ATCFF=+$P($G(^PS(59.7,1,26)),"^",7),ATC=$S(ATCFF:NEED,UD#1:0,DIS]"":+DIS,1:NEED) I ATC,$S(ATC<1:1,ATC'?1.3N:1,1:ATC#1) S ATC=0
"RTN","PSGPLR",46,0)
 .I ATC S X=0,X=$O(^PS(59.7,X)) I $P($G(^(X,26)),U,2)=1,PST="OC" S ATC=0
"RTN","PSGPLR",47,0)
 .S UD=$S('UD:1,UD=.5:"1/2",UD=.25:"1/4",UD<1:"0"_UD,1:UD)
"RTN","PSGPLR",48,0)
 .I $G(PSJRNW),'CNT W !?35,"**** RENEWAL ****" S CNT=CNT+1,NEED=NEED-$P(PSJRNW,"^",2) S:NEED<0 NEED=0
"RTN","PSGPLR",49,0)
 .W !?6,DR,?48,ST W:(ATC)&(NEED>0) ?57,"ATC" W ?61,$J(UD,4),?68,$J(NEED,4),?75,$S(DIS]"":$J(DIS,4),1:"____")
"RTN","PSGPLR",50,0)
 .S:ST="DISCONTINUED" OLDWARD=1 S ST=""
"RTN","PSGPLR",51,0)
 I DDRG="NO DISPENSE DRUG" W !?6,PDRG,?48,ST,?57,"OI" S:ST="DISCONTINUED" OLDWARD=1 S ST=""
"RTN","PSGPLR",52,0)
 N GIVSTR S GIVSTR=$S(DO]"":DO_" ",1:"")_RTE_" "_SCH D
"RTN","PSGPLR",53,0)
 .N MARX,I,Y,X D TXT^PSGMUTL(GIVSTR,60)
"RTN","PSGPLR",54,0)
 .F I=1:1:MARX W:I=1 !?10,"Give: ",MARX(1) W:I>1 !?16,MARX(I)
"RTN","PSGPLR",55,0)
 D:OLDWARD WARDCHK W:AT]"" !,?65-$L(AT),AT W !?7,"Start: ",SD,?37,"Stop: ",FD
"RTN","PSGPLR",56,0)
 I Y]"" W !?10 F Q=1:1:$L(Y," ") S X=$P(Y," ",Q) W:$X+$L(X)>65 !?10 W X_" "
"RTN","PSGPLR",57,0)
 K ST
"RTN","PSGPLR",58,0)
 Q
"RTN","PSGPLR",59,0)
 ;
"RTN","PSGPLR",60,0)
EXDD ;
"RTN","PSGPLR",61,0)
 W ! S (DDRG,OLDWARD)="" F  S DDRG=$O(^PS(53.5,PSGPLXR,PSGPLG,TM,WDN,RM,PN,PST,DRG,DDRG)) Q:(DDRG="")!(DDRG="NO DISPENSE DRUG")  S DND=^(DDRG) D
"RTN","PSGPLR",62,0)
 .S DR=$P(DDRG,"^",2),DRN=$G(^PS(55,PSGP,5,PSJJORD,1,DR,0)),ID=$P(DRN,"^",3),DR=$$ENDDN^PSGMI($P(DRN,"^")) W !?6,DR,?48,DIS,?66,"Returns: ____" S:DIS="DISCONTINUED" OLDWARD=1 S DIS=""
"RTN","PSGPLR",63,0)
 I DDRG="NO DISPENSE DRUG" S ND1=$G(^PS(55,PSGP,5,PSJJORD,.2)),PDRG=$$ENPDN^PSGMI($P(ND1,"^")) W !?6,PDRG,?48,DIS,?66,"Returns: ____" S:DIS="DISCONTINUED" OLDWARD=1 S DIS=""
"RTN","PSGPLR",64,0)
 W !?10,"Give: ",$S(DO]"":DO_" ",1:""),RTE," ",SCH D:OLDWARD WARDCHK W !?7,"Start: ",SD,?37,"Stop: ",FD
"RTN","PSGPLR",65,0)
 Q
"RTN","PSGPLR",66,0)
 ;
"RTN","PSGPLR",67,0)
FCL ;
"RTN","PSGPLR",68,0)
 I PGN,CML,$P(PSGPLWGP,"^",6) W !!?25,"FILLED BY: ",FACL,!!?25,"CHECKED BY: "_FACL
"RTN","PSGPLR",69,0)
 ;
"RTN","PSGPLR",70,0)
HEADER ;
"RTN","PSGPLR",71,0)
 S PGN=PGN+1 W:$Y @IOF
"RTN","PSGPLR",72,0)
 W ?1,"(",PSGPLG,")",?$S($D(PSGPLUPF):27,1:32),"PICK LIST REPORT" W:$D(PSGPLUPF) " (UPDATE)" W ?64,PPLD,!,"Ward group: ",WGPN,?73-$L(PGN),"Page: ",PGN,!?18,"For ",PSD," through ",PFD W:NPLF !,"Team: ",$S(TM'["zz":TM,1:"** N/F **")
"RTN","PSGPLR",73,0)
 W !!,$S($P(TND,"^",6)&'$P(TND,"^",8):"Bed-Room",1:"Room-Bed"),?15,"Patient",?67,"Units",?74,"Units",!?9,"Medication",?48,"ST",?62,"U/D",?66,"Needed",?74,"Disp'd",!,LINE Q
"RTN","PSGPLR",74,0)
 ;
"RTN","PSGPLR",75,0)
PAGECK ;
"RTN","PSGPLR",76,0)
 S PSGPY=$Y,PSGPY=$Y+4 I PSGPY+4>IOSL W @IOF
"RTN","PSGPLR",77,0)
 Q
"RTN","PSGPLR",78,0)
 ;
"RTN","PSGPLR",79,0)
WARDCHK ;  if patient has discontinued orders from a different ward, print the ward and room/bed that the orders were discontinued from.
"RTN","PSGPLR",80,0)
 Q:'$G(STPDT)
"RTN","PSGPLR",81,0)
 S VAINDT=$$MINUTES(STPDT,5)
"RTN","PSGPLR",82,0)
 S DFN=PSGP D INP^VADPT I PW'=$P(VAIN(4),"^",2) W ?48,$E("(from "_$P(VAIN(4),"^",2)_" "_VAIN(5)_")",1,31)
"RTN","PSGPLR",83,0)
 S OLDWARD="" Q
"RTN","PSGPLR",84,0)
 ;
"RTN","PSGPLR",85,0)
MINUTES(STPDT,LESS)     ; pass in a FM date/time and the number of minutes (9 or less) to subtract from it
"RTN","PSGPLR",86,0)
 S VAINDT=$S($E(STPDT,9,12)<LESS:($E(STPDT,1,7)-1)_"."_(($E(STPDT,9,12)+2360)-LESS),$E(STPDT,11,12)<5:$E(STPDT,1,8)_$S($E(STPDT,9,10)="10":"09",$E(STPDT,9,10)="20":"19",1:$E(STPDT,9)_($E(STPDT,10)-1))_(60+$E(STPDT,12)-LESS),1:STPDT-(LESS*.0001))
"RTN","PSGPLR",87,0)
 Q VAINDT
"RTN","PSGPLUP")
0^3^B25061652
"RTN","PSGPLUP",1,0)
PSGPLUP ;BIR/CML3-UPDATE A PICK LIST ;28 JUN 96 / 9:24 AM
"RTN","PSGPLUP",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**50,129**;16 DEC 97
"RTN","PSGPLUP",3,0)
 ;
"RTN","PSGPLUP",4,0)
 D ENCV^PSGSETU I $D(XQUIT) Q
"RTN","PSGPLUP",5,0)
 ;
"RTN","PSGPLUP",6,0)
CHK ;
"RTN","PSGPLUP",7,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSGPLUP",8,0)
 F Q=0:0 S Q=$O(^PS(53.5,"AB",Q)) Q:'Q  I $O(^(Q,PSGDT)) Q
"RTN","PSGPLUP",9,0)
 E  W !,"THERE ARE CURRENTLY NO PICK LISTS TO UPDATE." K DIR S DIR(0)="E" D ^DIR K DIR G DONE
"RTN","PSGPLUP",10,0)
 ;
"RTN","PSGPLUP",11,0)
ASK ;
"RTN","PSGPLUP",12,0)
 S PSGPLGF="U",PSGPLG="" R !!,"Select WARD GROUP or PICK LIST: ",X:DTIME W:'$T $C(7) S:'$T X="^" G:"^"[X DONE I X=+X D NL I Y D UP G CHK
"RTN","PSGPLUP",13,0)
 I X?1."?" W !!?2,"Select a Ward Group for which a pick list has been run that you wish to",!,"update.",!?2,"You may also select a Pick List by number, which prints in the upper left",!,"corner of each pick list."
"RTN","PSGPLUP",14,0)
 D DIC,^DIC K DIC G:Y'>0 ASK S PSGPLWG=+Y,PSGPLWGP=$G(^PS(57.5,+Y,5)) D ^PSGPLG I "^"'[PSGPLG D UP D ^%ZISC
"RTN","PSGPLUP",15,0)
 G CHK
"RTN","PSGPLUP",16,0)
 ;
"RTN","PSGPLUP",17,0)
DONE ;
"RTN","PSGPLUP",18,0)
 D ^%ZISC D ENKV^PSGSETU K CML,FD,FFF,FQ,GRP,PSGPLF,PSGPLG,PSGPLGF,PSGPLREN,PSGPLS,PSGPLUPR,PSGPLTND,PSGPLUPD,PSGPLUPF,PSGPLWG,PSGPLWGN,PSGMAR,PSGPLC,SD,TS,UP,WD,XX,PDRG,PSGPLWGP,PSGPLUP Q
"RTN","PSGPLUP",19,0)
 ;
"RTN","PSGPLUP",20,0)
UP ;
"RTN","PSGPLUP",21,0)
 I $D(^PS(53.5,PSGPLG,0)),'$P(^(0),"^",9) W $C(7),$C(7),!!?33,"*** WARNING ***",!,"THIS PICK LIST STARTED TO RUN ",$$ENDTC^PSGMI($P(^(0),"^",10)),", BUT HAS NOT RUN TO COMPLETION."
"RTN","PSGPLUP",22,0)
 I '$$LOCK^PSGPLUTL(PSGPLG,"PSGPL") W $C(7),$C(7),!!?33,"*** WARNING ***",!!?15,"THIS PICK LIST IS CURRENTLY LOCKED BY ANOTHER JOB."
"RTN","PSGPLUP",23,0)
 E  D UNLOCK^PSGPLUTL(PSGPLG,"PSGPL")
"RTN","PSGPLUP",24,0)
 F  R !!,"PRINT THE ENTIRE PICK LIST (P), OR ONLY THE UPDATE (U)? ",UP:DTIME W:'$T $C(7) S:'$T UP="^" D:UP'="^" UPC Q:UP]""
"RTN","PSGPLUP",25,0)
 I UP="^" W !!,"Update terminated." Q
"RTN","PSGPLUP",26,0)
 N PSGPLUP S:$G(UP)="U" PSGPLUP=1
"RTN","PSGPLUP",27,0)
 D DEV Q:POP!$D(IO("Q"))  W !,"...this may take a few minutes..." D QUEUE
"RTN","PSGPLUP",28,0)
 ;
"RTN","PSGPLUP",29,0)
ENQ ;
"RTN","PSGPLUP",30,0)
 N PSGPLREN
"RTN","PSGPLUP",31,0)
 I '$D(PSGPLUPQ) S PSGPLUPD=IO=IO(0)&($E(IOST)'="C") I PSGPLUPD S $P(PSGPLUPD,"^",2)=$G(ION)
"RTN","PSGPLUP",32,0)
 S:$G(UP)="U" PSGPLUP=1
"RTN","PSGPLUP",33,0)
 S PSGPLTND=$G(^PS(53.5,PSGPLG,0)) Q:'PSGPLTND  S PSGPLS=$P(PSGPLTND,"^",3),PSGPLF=$P(PSGPLTND,"^",4),WSF=$P(PSGPLTND,"^",7),PSGPLUPF=$S(UP="U":1,1:"")
"RTN","PSGPLUP",34,0)
 D ENQ^PSGPLUP0
"RTN","PSGPLUP",35,0)
 D ^PSGPLR,^%ZISC I UP="P" Q
"RTN","PSGPLUP",36,0)
 I '$D(PSGPLUPQ) S PSGPLUPR=1 F  W !!,"DO YOU NEED A REPRINT OF THIS UPDATE" S %=2 D YN^DICN Q:%<0  Q:%=2  D:'% RP I % S:PSGPLUPD IOP=$P(PSGPLUPD,"^",2) D DEV Q:POP  I '$D(IO("Q")) U IO D ^PSGPLR D ^%ZISC
"RTN","PSGPLUP",37,0)
 D DONE
"RTN","PSGPLUP",38,0)
 Q
"RTN","PSGPLUP",39,0)
 ;
"RTN","PSGPLUP",40,0)
UPC ;
"RTN","PSGPLUP",41,0)
 I UP?1."?" S UP="" W !!," Enter a 'U' if you wish to print only the new and edited (updated) orders for  this pick list.  Enter a 'P' to print the entire pick list, including the up-   dated orders.  Enter a '^' to terminate this update now." Q
"RTN","PSGPLUP",42,0)
 I UP="U" W "PDATE" Q
"RTN","PSGPLUP",43,0)
 I UP="P" W "ICK LIST" Q
"RTN","PSGPLUP",44,0)
 W $C(7),"  ??" S UP="" Q
"RTN","PSGPLUP",45,0)
 ;
"RTN","PSGPLUP",46,0)
DEV ;
"RTN","PSGPLUP",47,0)
 K PSGPLUPQ,IOP,IO("Q"),%ZIS S PSGION=ION,%ZIS="Q",%ZIS("A")="Print on Device: ",%ZIS("B")="" W ! D ^%ZIS K %ZIS I POP S IOP=PSGION D ^%ZIS K IOP S POP=1 W !,"No device chosen." Q
"RTN","PSGPLUP",48,0)
 ;
"RTN","PSGPLUP",49,0)
QUEUE ;
"RTN","PSGPLUP",50,0)
 Q:'$D(IO("Q"))
"RTN","PSGPLUP",51,0)
 K ZTSAVE S PSGTIR=$S($D(PSGPLUPR):"^PSGPLR",1:"ENQ^PSGPLUP"),ZTDESC="PICK LIST UPDATE",PSGPLUPQ=1
"RTN","PSGPLUP",52,0)
 F X="PSGPLWG","PSGPLWGP","PSGPLG","UP","PSGPLUPF","PSGPLUPQ","PSGPLUP" S ZTSAVE(X)="" S:$D(PSJPRN) ZTSAVE("PSJPRN")=""
"RTN","PSGPLUP",53,0)
 D ENTSK^PSGTI I $D(ZTSK) W !,"Pick list update queued!" K PSGPLUPQ Q
"RTN","PSGPLUP",54,0)
 D ENQ^PSGPLUP
"RTN","PSGPLUP",55,0)
 ;
"RTN","PSGPLUP",56,0)
RP ;
"RTN","PSGPLUP",57,0)
 W !!,"Enter a 'Y' to reprint this update.  Enter an 'N' (or '^') if you do not want to reprint this update." Q
"RTN","PSGPLUP",58,0)
 ;
"RTN","PSGPLUP",59,0)
DIC K DIC S DIC="^PS(57.5,",DIC(0)="EIMQ",DIC("S")="I $D(^PS(57.5,+Y,0)),$P(^(0),""^"",2)=""P"",$O(^PS(53.5,""AB"",+Y,"_PSGDT_"))" Q
"RTN","PSGPLUP",60,0)
 ;
"RTN","PSGPLUP",61,0)
NL ; numeric look-up
"RTN","PSGPLUP",62,0)
 S Y=$G(^PS(53.5,X,0)) I $S('$P(Y,"^",3):1,$P(Y,"^",3)<PSGDT:1,1:'$D(^PS(53.5,"AB",$P(Y,"^",2),+$P(Y,"^",3),X))) S Y=0 Q
"RTN","PSGPLUP",63,0)
 S (GRP,PSGPLG)=X,X=Y,PSGID=$P(X,"^",3),PSGPLWG=$P(X,"^",2),PSGPLWGN=$P($G(^PS(57.5,PSGPLWG,0)),"^"),PSGPLWGP=$G(^(5)) S:PSGPLWGN="" PSGPLWGN=PSGPLWG_";PS(57.5," S Y=$$ENDTC^PSGMI($P(X,"^",3)),PSGOD=$$ENDTC^PSGMI($P(X,"^",4))
"RTN","PSGPLUP",64,0)
 W "  ",PSGPLWGN,!?$L(GRP)+21,Y,"  thru  ",PSGOD S Y=1 Q
"RTN","PSGPLUP0")
0^6^B22975359
"RTN","PSGPLUP0",1,0)
PSGPLUP0 ;BIR/CML3-UPDATING FOR PSGPLUP OCCURS HERE ;06 AUG 96 / 10:53 PM
"RTN","PSGPLUP0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**50,129**;16 DEC 97
"RTN","PSGPLUP0",3,0)
 ;
"RTN","PSGPLUP0",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSGPLUP0",5,0)
 ; Reference to ^PS(59.7 is supported by DBIA #2181
"RTN","PSGPLUP0",6,0)
 ; Reference to ^DIC(42 is supported by DBIA #1377.
"RTN","PSGPLUP0",7,0)
 ; Reference to ^DPT( is supported by DBIA #10035.     
"RTN","PSGPLUP0",8,0)
 ;
"RTN","PSGPLUP0",9,0)
ENQ ; check for a previous update, if there is one "unflag" updated orders.
"RTN","PSGPLUP0",10,0)
 ;
"RTN","PSGPLUP0",11,0)
 I '$$LOCK^PSGPLUTL(PSGPLG,"PSGPL") H 60 G ENQ
"RTN","PSGPLUP0",12,0)
 D NOW^%DTC S PSJACNWP=1,PSGAU="",PSGDT=%,(PDRG,PN,PST,RB,TM,WDN)="",EST=$S($P(PSGPLTND,"^",13):"A",1:"Z"),PSJACNWP=1
"RTN","PSGPLUP0",13,0)
 F  S PSGX=$Q(^PS(53.5,"AU",PSGPLG)),PSGXP=$P(PSGX,"53.5",2) Q:$P(PSGXP,",",2,3)'=("""AU"","_PSGPLG)  D UNFLAG
"RTN","PSGPLUP0",14,0)
 K PSGP,PSGORD,I,X,PSGX,PSGXP
"RTN","PSGPLUP0",15,0)
 ;
"RTN","PSGPLUP0",16,0)
 ; check each patient in the ward group
"RTN","PSGPLUP0",17,0)
 ;
"RTN","PSGPLUP0",18,0)
 S X1=$P(PSGPLS,"."),X2=-1 D C^%DTC S PSGPLUPO=X_(PSGPLS#1)
"RTN","PSGPLUP0",19,0)
 F PSGPLWD=0:0 S (WD,PSGPLWD)=$O(^PS(57.5,"AC",PSGPLWG,PSGPLWD)) Q:'PSGPLWD  S WDN=$P($G(^DIC(42,WD,0)),"^") I WDN]"" S PSGPLWDN=$S('WSF:WDN,1:"zns") F PSGP=0:0 S PSGP=$O(^DPT("CN",WDN,PSGP)) Q:'PSGP  D UP
"RTN","PSGPLUP0",20,0)
 ;
"RTN","PSGPLUP0",21,0)
 ; check each patient on original Pick List (to catch any that have since moved to a different ward group but had action, for example orders DC'd)
"RTN","PSGPLUP0",22,0)
 S PSGX="",PSGX=$Q(^PS(53.5,"AC",PSGPLG)),PSGXP=$P(PSGX,"53.5",2) Q:$P(PSGXP,",",2,3)'=("""AC"","_PSGPLG)  S PSGP=+$P(PSGX,"^",3) D:$D(^PS(55,"AUE",PSGP)) UP
"RTN","PSGPLUP0",23,0)
 F  S PSGX=$Q(@PSGX) Q:$P(PSGX,",",2,3)'=("""AC"","_PSGPLG)  S PSGP=+$P(PSGX,"^",3) D:$D(^PS(55,"AUE",PSGP)) UP
"RTN","PSGPLUP0",24,0)
 K ^PS(53.5,"AC",PSGPLG) F PSG=.01,.02,.05 K DA,DIK S DIK="^PS(53.5,",DIK(1)=PSG,DA=PSGPLG D EN1^DIK
"RTN","PSGPLUP0",25,0)
 D NOW^%DTC S $P(^PS(53.5,PSGPLG,0),"^",10)=%
"RTN","PSGPLUP0",26,0)
 ;
"RTN","PSGPLUP0",27,0)
DONE ;
"RTN","PSGPLUP0",28,0)
 D UNLOCK^PSGPLUTL(PSGPLG,"PSGPL") K %,%X,%Y,DA,DIK,DRG,EST,NST,PSJJORD,PN,PSGPLO,PSGAU,PSGNDATE,PSGPLS,PSGPLUPO,PSGPLWD
"RTN","PSGPLUP0",29,0)
 K PSGPLWDN,PSGX,PSGXP,PST,PSGUP,PSGORD,PSJACNWP,RB,SD,TM,X,X1,X2 Q
"RTN","PSGPLUP0",30,0)
 ;
"RTN","PSGPLUP0",31,0)
UP ; if patient has an update (AUE xref on UD subfile), add order and drug multiples to Pick List and flag as updated.
"RTN","PSGPLUP0",32,0)
 ; if patient not on last pick list (i.e., transferred or admitted
"RTN","PSGPLUP0",33,0)
 ; and has no orders, add to Pick List patient multiple and flag as updated (do PATIENT^PSGPL1).
"RTN","PSGPLUP0",34,0)
 D ^PSJAC,ENUNM^PSGOU
"RTN","PSGPLUP0",35,0)
 S DFN=PSGP,WD=0,WDN=$G(^DPT(PSGP,.1)),RB=$G(^DPT(PSGP,.101)) S:WDN]"" WD=+$O(^DIC(42,"B",WDN,0))
"RTN","PSGPLUP0",36,0)
 S TM=$S(RB="":"",1:$P($G(^PS(57.7,WD,1,+$O(^PS(57.7,"AWRT",WD,RB,0)),0)),"^"))
"RTN","PSGPLUP0",37,0)
 F X="RB","TM","WDN" S:@X="" @X="zz"
"RTN","PSGPLUP0",38,0)
 ; check to see if pat has moved to a new ward group, if so leave location alone on this PL and print only orders newly DC'd
"RTN","PSGPLUP0",39,0)
 ; Determine if patient is on the same or different ward group
"RTN","PSGPLUP0",40,0)
 ; (GRP=1:Same,GRP=0:Different)
"RTN","PSGPLUP0",41,0)
 S GRP=1 I WD S GRP=$O(^PS(57.5,"AB",WD,0)) Q:'GRP  S GRP=GRP=$P(^PS(53.5,PSGPLG,0),U,2)
"RTN","PSGPLUP0",42,0)
 S PN=$P(PSGP(0),"^"),PN=$S(PN]"":$E(PN,1,12),1:PSGP)_"^"_PSGP
"RTN","PSGPLUP0",43,0)
 I WD,GRP,$G(^PS(53.5,PSGPLG,1,PSGP,0)) S $P(^PS(53.5,PSGPLG,1,PSGP,0),U,2,4)=TM_U_WDN_U_RB
"RTN","PSGPLUP0",44,0)
 I GRP,'$G(^PS(53.5,PSGPLG,1,PSGP,0)) S PSGAU=1 D PATIENT^PSGPL1
"RTN","PSGPLUP0",45,0)
 ;
"RTN","PSGPLUP0",46,0)
 ;Update orders already on PL for this patient.
"RTN","PSGPLUP0",47,0)
 N PSJSITE,PSJPRN S PSJSITE=0,PSJSITE=$O(^PS(59.7,PSJSITE)) I $P($G(^(PSJSITE,26)),U,5)=1 S PSJPRN=1
"RTN","PSGPLUP0",48,0)
 I GRP F PSJJORD=0:0 S PSJJORD=$O(^PS(55,"AUE",PSGP,PSJJORD)) Q:'PSJJORD  I $D(^PS(55,PSGP,5,PSJJORD,0)),$D(^(2)) S SD=$P(^(2),"^",4) I (SD'<PSGPLUPO)!($D(^PS(53.5,PSGPLG,1,PSGP,1,"B",PSJJORD))) D UP1
"RTN","PSGPLUP0",49,0)
 ;
"RTN","PSGPLUP0",50,0)
 ;If patient is on a different WG update only DE orders.
"RTN","PSGPLUP0",51,0)
 I 'GRP D NOW^%DTC S PSGDT=%,X1=$P(PSGPLS,"."),X2=-1 D C^%DTC S PSGPLD=X_(PSGPLS#1) D
"RTN","PSGPLUP0",52,0)
 .F PST="C","O","OC","P","R" F SD=PSGPLD:0 S SD=$O(^PS(55,PSGP,5,"AU",PST,SD)) Q:'SD  F PSJJORD=0:0 S PSJJORD=$O(^PS(55,PSGP,5,"AU",PST,SD,PSJJORD)) Q:'PSJJORD  D
"RTN","PSGPLUP0",53,0)
 ..I $D(^PS(53.5,PSGPLG,1,PSGP,1,"B",PSJJORD)) S PSGNDATE=$S($P(^PS(53.5,PSGPLG,0),"^",10)]"":$P(^PS(53.5,PSGPLG,0),"^",10),1:$P(^PS(53.5,PSGPLG,0),"^",9)) I SD>PSGNDATE D UP1
"RTN","PSGPLUP0",54,0)
 Q
"RTN","PSGPLUP0",55,0)
 ;
"RTN","PSGPLUP0",56,0)
UP1 ;
"RTN","PSGPLUP0",57,0)
 S (NST,PST)=$P(^PS(55,PSGP,5,PSJJORD,0),"^",7) Q:(NST="")!(('GRP)&("DE"'[$P(^PS(55,PSGP,5,PSJJORD,0),"^",9)))  S PSGPLO=PSJJORD D ENASET Q
"RTN","PSGPLUP0",58,0)
 Q
"RTN","PSGPLUP0",59,0)
 ;
"RTN","PSGPLUP0",60,0)
ENASET ; 
"RTN","PSGPLUP0",61,0)
 ; if you're adding an order that is already on the PL, delete the old one first
"RTN","PSGPLUP0",62,0)
 I $D(^PS(53.5,PSGPLG,1,PSGP,1,"B",PSJJORD)) D  D ^DIK K DIK
"RTN","PSGPLUP0",63,0)
 .N PSGOST S PSGOST=$P($$LASTREN^PSJLMPRI(PSGP,PSJJORD_"U"),"^",4) I PSGOST D
"RTN","PSGPLUP0",64,0)
 ..N PSGPLS,PSGPLF S PSGPLS=$P(PSGPLTND,"^",3),PSGPLF=$P(PSGPLTND,"^",4) I PSGOST>PSGPLS&(PSGOST<PSGPLF) D
"RTN","PSGPLUP0",65,0)
 ...N PSGPLO S PSGPLO=$O(^PS(53.5,PSGPLG,1,PSGP,1,"B",PSJJORD,999),-1)
"RTN","PSGPLUP0",66,0)
 ...M PSGPLREN(53.5,PSGPLG,1,PSGP,1,PSGPLO)=^PS(53.5,PSGPLG,1,PSGP,1,PSGPLO) S PSGPLREN("B",PSGP,PSJJORD,PSGPLO)=PSGOST
"RTN","PSGPLUP0",67,0)
 ...N PSGPLX F PSGPLX="AC","AU" M PSGPLREN(53.5,PSGPLX,PSGPLG)=^PS(53.5,PSGPLX,PSGPLG)
"RTN","PSGPLUP0",68,0)
 .K DA,DIK S DA=$O(^PS(53.5,PSGPLG,1,PSGP,1,"B",PSJJORD,0)),DA(2)=PSGPLG,DA(1)=PSGP,DIK="^PS(53.5,"_PSGPLG_",1,"_PSGP_",1,"
"RTN","PSGPLUP0",69,0)
 .S:$D(^PS(53.5,DA(2),1,DA(1),0)) $P(^(0),U,5)=""
"RTN","PSGPLUP0",70,0)
 .S:$D(^PS(53.5,DA(2),1,DA(1),1,DA,0)) $P(^(0),U,5)=""
"RTN","PSGPLUP0",71,0)
 ; go to ^PSGPL1 to add new orders to the PL. (unless the patient has no ward, in which case he's probably discharged)
"RTN","PSGPLUP0",72,0)
 N PSGPLWD S PSGPLWD=WD
"RTN","PSGPLUP0",73,0)
 S (DDC,PSGAU)=1 D ENASET^PSGPL1 S DR=".05////1",DIE="^PS(53.5,"_PSGPLG_",1,"_PSGP_",1,",DA(2)=PSGPLG,DA(1)=PSGP,DA=PSGORD D ^DIE K DIE
"RTN","PSGPLUP0",74,0)
 Q
"RTN","PSGPLUP0",75,0)
UNFLAG ; unset "old" update flag
"RTN","PSGPLUP0",76,0)
 ;
"RTN","PSGPLUP0",77,0)
 S PSGP=+$P(PSGX,"^",3),PSGORD=+$P(PSGX,"^",4)
"RTN","PSGPLUP0",78,0)
 S $P(^PS(53.5,PSGPLG,1,PSGP,0),"^",5)="" K @PSGX
"RTN","PSGPLUP0",79,0)
 S:PSGORD $P(^PS(53.5,PSGPLG,1,PSGP,1,PSGORD,0),"^",5)=""
"RTN","PSGPLUP0",80,0)
 Q
"VER")
8.0^22.0
"BLD",5279,6)
^139
**END**
**END**
