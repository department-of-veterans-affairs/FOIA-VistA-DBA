EMERGENCY Released MPIF*1*16 SEQ #14
Extracted from mail message
**KIDS**:MPIF*1.0*16^

**INSTALL NAME**
MPIF*1.0*16
"BLD",1974,0)
MPIF*1.0*16^MASTER PATIENT INDEX VISTA^0^3010613^y
"BLD",1974,4,0)
^9.64PA^^
"BLD",1974,"ABNS",0)
^9.66A^^
"BLD",1974,"ABPKG")
n^^
"BLD",1974,"KRN",0)
^9.67PA^19^17
"BLD",1974,"KRN",.4,0)
.4
"BLD",1974,"KRN",.401,0)
.401
"BLD",1974,"KRN",.402,0)
.402
"BLD",1974,"KRN",.403,0)
.403
"BLD",1974,"KRN",.5,0)
.5
"BLD",1974,"KRN",.84,0)
.84
"BLD",1974,"KRN",3.6,0)
3.6
"BLD",1974,"KRN",3.8,0)
3.8
"BLD",1974,"KRN",9.2,0)
9.2
"BLD",1974,"KRN",9.8,0)
9.8
"BLD",1974,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1974,"KRN",9.8,"NM",1,0)
MPIFAPI^^0^B17543213
"BLD",1974,"KRN",9.8,"NM",2,0)
MPIF001^^0^B47176048
"BLD",1974,"KRN",9.8,"NM",3,0)
MPIFQ0^^0^B76457139
"BLD",1974,"KRN",9.8,"NM",4,0)
MPIFQ1^^0^B35761933
"BLD",1974,"KRN",9.8,"NM","B","MPIF001",2)

"BLD",1974,"KRN",9.8,"NM","B","MPIFAPI",1)

"BLD",1974,"KRN",9.8,"NM","B","MPIFQ0",3)

"BLD",1974,"KRN",9.8,"NM","B","MPIFQ1",4)

"BLD",1974,"KRN",19,0)
19
"BLD",1974,"KRN",19.1,0)
19.1
"BLD",1974,"KRN",101,0)
101
"BLD",1974,"KRN",409.61,0)
409.61
"BLD",1974,"KRN",771,0)
771
"BLD",1974,"KRN",870,0)
870
"BLD",1974,"KRN",8994,0)
8994
"BLD",1974,"KRN","B",.4,.4)

"BLD",1974,"KRN","B",.401,.401)

"BLD",1974,"KRN","B",.402,.402)

"BLD",1974,"KRN","B",.403,.403)

"BLD",1974,"KRN","B",.5,.5)

"BLD",1974,"KRN","B",.84,.84)

"BLD",1974,"KRN","B",3.6,3.6)

"BLD",1974,"KRN","B",3.8,3.8)

"BLD",1974,"KRN","B",9.2,9.2)

"BLD",1974,"KRN","B",9.8,9.8)

"BLD",1974,"KRN","B",19,19)

"BLD",1974,"KRN","B",19.1,19.1)

"BLD",1974,"KRN","B",101,101)

"BLD",1974,"KRN","B",409.61,409.61)

"BLD",1974,"KRN","B",771,771)

"BLD",1974,"KRN","B",870,870)

"BLD",1974,"KRN","B",8994,8994)

"BLD",1974,"QUES",0)
^9.62^^
"BLD",1974,"REQB",0)
^9.611^4^4
"BLD",1974,"REQB",1,0)
MPIF*1.0*14^1
"BLD",1974,"REQB",2,0)
MPIF*1.0*12^1
"BLD",1974,"REQB",3,0)
MPIF*1.0*13^1
"BLD",1974,"REQB",4,0)
MPIF*1.0*9^1
"BLD",1974,"REQB","B","MPIF*1.0*12",2)

"BLD",1974,"REQB","B","MPIF*1.0*13",3)

"BLD",1974,"REQB","B","MPIF*1.0*14",1)

"BLD",1974,"REQB","B","MPIF*1.0*9",4)

"MBREQ")
0
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
16^3010613^9119
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","MPIF001")
0^2^B47176048
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,16**;30 Apr 99
"RTN","MPIF001",3,0)
GETICN(DFN) ;
"RTN","MPIF001",4,0)
 ; This function returns the ICN, including checksum for a given DFN
"RTN","MPIF001",5,0)
 ; or -1^error message
"RTN","MPIF001",6,0)
 ; DFN - ien in Patient file
"RTN","MPIF001",7,0)
 ;
"RTN","MPIF001",8,0)
 N RETURN,NODE
"RTN","MPIF001",9,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",10,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",11,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",12,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",13,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",14,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",15,0)
EXIT1 ;
"RTN","MPIF001",16,0)
 Q RETURN
"RTN","MPIF001",17,0)
 ;
"RTN","MPIF001",18,0)
GETDFN(ICN) ;
"RTN","MPIF001",19,0)
 ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",20,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",21,0)
 N RETURN,DFN
"RTN","MPIF001",22,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",23,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",24,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",25,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",26,0)
 S RETURN=DFN
"RTN","MPIF001",27,0)
EXIT2 ;
"RTN","MPIF001",28,0)
 Q RETURN
"RTN","MPIF001",29,0)
 ;
"RTN","MPIF001",30,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",31,0)
 ; a Local ICN and update the appropriate fields if a Local was created
"RTN","MPIF001",32,0)
 ; DFN= Patient IEN
"RTN","MPIF001",33,0)
 ; Returns ICN (local or National including checksum)
"RTN","MPIF001",34,0)
 ; can also return -1^Problem creating Local ICN or -1^ZZd or 5 leading 0s
"RTN","MPIF001",35,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",36,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",37,0)
 I '$D(ICN) S ICN=$$GETICN(DFN)
"RTN","MPIF001",38,0)
 I +ICN=-1&(+$$SEND2^VAFCUTL1(DFN,"T")=0) D
"RTN","MPIF001",39,0)
 .;no icn create a Local ICN
"RTN","MPIF001",40,0)
 .; don't create Local if ZZ'd or 5 leading 0s
"RTN","MPIF001",41,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",42,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",43,0)
 .S NOLOCK=""
"RTN","MPIF001",44,0)
 .I ICNX="" K NOLOCK S ICN="-1^PROBLEM CREATING LOCAL ICN" Q
"RTN","MPIF001",45,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",46,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",47,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",48,0)
 .K NOLOCK
"RTN","MPIF001",49,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",50,0)
 I +ICN=-1 S ICN="-1^ZZd or 5 leading 0s"
"RTN","MPIF001",51,0)
 Q ICN
"RTN","MPIF001",52,0)
 ;
"RTN","MPIF001",53,0)
CMOR2(DFN) ;
"RTN","MPIF001",54,0)
 ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",55,0)
 ; DFN = Patient IEN
"RTN","MPIF001",56,0)
 N NODE
"RTN","MPIF001",57,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",58,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",59,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",60,0)
 ;
"RTN","MPIF001",61,0)
CMORNAME(CIEN) ;
"RTN","MPIF001",62,0)
 ; Returns CMOR site name or -1^error message
"RTN","MPIF001",63,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",64,0)
 ;
"RTN","MPIF001",65,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",66,0)
 N INST
"RTN","MPIF001",67,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",68,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",69,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",70,0)
 Q $P(INST,"^")
"RTN","MPIF001",71,0)
 ;
"RTN","MPIF001",72,0)
GETVCCI(DFN) ;
"RTN","MPIF001",73,0)
 ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",74,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",75,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",76,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",77,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",78,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",79,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",80,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",81,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",82,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",83,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",84,0)
 S RETURN=STANUM
"RTN","MPIF001",85,0)
EXIT3 ;
"RTN","MPIF001",86,0)
 Q RETURN
"RTN","MPIF001",87,0)
 ;
"RTN","MPIF001",88,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",89,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",90,0)
 ;
"RTN","MPIF001",91,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",92,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",93,0)
 ; VCCI = CMOR ien from the institution file
"RTN","MPIF001",94,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",95,0)
 ;             1 - successful
"RTN","MPIF001",96,0)
 ; Exception will be generated if Update to File Fails only
"RTN","MPIF001",97,0)
 N RETURN,DIQUIET,DIE,DA,DR,Y,X,DIC
"RTN","MPIF001",98,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",99,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",100,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",101,0)
 I $G(VCCI)="" S RETURN="-1^NO CMOR PASSED" G EXIT4
"RTN","MPIF001",102,0)
 I $E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S VCCI=$P($$SITE^VASITE(),"^")
"RTN","MPIF001",103,0)
 ; ^ to be sure site is self for a local icn
"RTN","MPIF001",104,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",105,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",106,0)
 S DIQUIET=1,CNT=0
"RTN","MPIF001",107,0)
REP S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",108,0)
 D ^DIE
"RTN","MPIF001",109,0)
 S CNT=CNT+1
"RTN","MPIF001",110,0)
 S TIEN=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIF001",111,0)
 I "`"_TIEN'=VCCI&(CNT<4) G REP
"RTN","MPIF001",112,0)
 I "`"_TIEN'=VCCI&(CNT>3) D
"RTN","MPIF001",113,0)
 .S RETURN="-1^Couldn't Update CMOR"
"RTN","MPIF001",114,0)
 .D START^RGHLLOG(0)
"RTN","MPIF001",115,0)
 .D EXC^RGHLLOG(221,"Unable to update CMOR to "_$P(^DIC(4,TIEN,0),"^")_" for patient DFN= "_DFN,DFN)
"RTN","MPIF001",116,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",117,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",118,0)
EXIT4 ;
"RTN","MPIF001",119,0)
 Q RETURN
"RTN","MPIF001",120,0)
 ;
"RTN","MPIF001",121,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",122,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",123,0)
 ;
"RTN","MPIF001",124,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",125,0)
 ; file for a given patient.
"RTN","MPIF001",126,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",127,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",128,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",129,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",130,0)
 ;          1 - successful
"RTN","MPIF001",131,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y,ERR
"RTN","MPIF001",132,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",133,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",134,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",135,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",136,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",137,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)'=$E(ICN,1,3) G EXIT5
"RTN","MPIF001",138,0)
 ; ^ stop local from overwriting a national ICN
"RTN","MPIF001",139,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S RETURN="-1^ZZ'd or 5 leading 0s" G EXIT5
"RTN","MPIF001",140,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",141,0)
 .Q:DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIF001",142,0)
 .N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",143,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIF001",144,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",145,0)
 .S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",146,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",147,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",148,0)
 S DIQUIET=1
"RTN","MPIF001",149,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",150,0)
 D ^DIE
"RTN","MPIF001",151,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",152,0)
 I +RETURN>0 D
"RTN","MPIF001",153,0)
 .K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",154,0)
 .I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,1)
"RTN","MPIF001",155,0)
 .I $E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",156,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",157,0)
EXIT5 ;
"RTN","MPIF001",158,0)
 Q RETURN
"RTN","MPIF001",159,0)
 ;
"RTN","MPIF001",160,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",161,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",162,0)
 ;
"RTN","MPIF001",163,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",164,0)
 ; for the given patient
"RTN","MPIF001",165,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",166,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",167,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",168,0)
 ;
"RTN","MPIF001",169,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",170,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",171,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",172,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",173,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",174,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",175,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",176,0)
 D ^DIE
"RTN","MPIF001",177,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",178,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",179,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",180,0)
EXIT6 ;
"RTN","MPIF001",181,0)
 Q RETURN
"RTN","MPIF001",182,0)
 ;
"RTN","MPIF001",183,0)
IFLOCAL(DFN) ;
"RTN","MPIF001",184,0)
 ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",185,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",186,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",187,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",188,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",189,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",190,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",191,0)
 Q:$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE,"^",3) 1
"RTN","MPIF001",192,0)
 Q 0
"RTN","MPIF001",193,0)
 ;
"RTN","MPIF001",194,0)
IFVCCI(DFN) ;
"RTN","MPIF001",195,0)
 ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",196,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",197,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",198,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",199,0)
 N VCCI,SITE
"RTN","MPIF001",200,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",201,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",202,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",203,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",204,0)
 Q 1
"RTN","MPIF001",205,0)
 ;
"RTN","MPIF001",206,0)
HL7CMOR(DFN,SEP) ;
"RTN","MPIF001",207,0)
 ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",208,0)
 ; the given patient.
"RTN","MPIF001",209,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",210,0)
 ; SEP = delimiter to separate station number and name
"RTN","MPIF001",211,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",212,0)
 ;            -1^error message
"RTN","MPIF001",213,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",214,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",215,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",216,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",217,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",218,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",219,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",220,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",221,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",222,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",223,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",224,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",225,0)
EXIT7 ;
"RTN","MPIF001",226,0)
 Q RETURN
"RTN","MPIF001",227,0)
 ;
"RTN","MPIF001",228,0)
LOCK ;
"RTN","MPIF001",229,0)
 L +^DPT(DFN,"MPI"):10 I '$T G LOCK
"RTN","MPIF001",230,0)
 Q
"RTN","MPIF001",231,0)
 ;
"RTN","MPIF001",232,0)
UNLOCK ;
"RTN","MPIF001",233,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",234,0)
 Q
"RTN","MPIFAPI")
0^1^B17543213
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14,16**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ;original 1st line ARS/SLC - API for local ICNs ;04-FEB-97
"RTN","MPIFAPI",4,0)
 ;
"RTN","MPIFAPI",5,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",6,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",7,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",8,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",9,0)
 S MPINUM=0
"RTN","MPIFAPI",10,0)
 S X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",11,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",12,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",13,0)
 S MPINUM=MPINUM1_"V"_MPICHK
"RTN","MPIFAPI",14,0)
 S MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",15,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",16,0)
 D ^DIE
"RTN","MPIFAPI",17,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",18,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",19,0)
 Q MPINUM
"RTN","MPIFAPI",20,0)
SETUP ;
"RTN","MPIFAPI",21,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",22,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",23,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",24,0)
 S NUM=SITE_"0000000"
"RTN","MPIFAPI",25,0)
 S CHK=$$CHECKDG^MPIFSPC(NUM)
"RTN","MPIFAPI",26,0)
 S MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",27,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",28,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",29,0)
 K DD,D0
"RTN","MPIFAPI",30,0)
 D FILE^DICN
"RTN","MPIFAPI",31,0)
 K DIC,X,Y
"RTN","MPIFAPI",32,0)
 Q MPINUM
"RTN","MPIFAPI",33,0)
 ;
"RTN","MPIFAPI",34,0)
MPILINK() ;returns MPI logical Link
"RTN","MPIFAPI",35,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",36,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",37,0)
 I '$D(MPIL) Q "-1^NOT DEFINED"
"RTN","MPIFAPI",38,0)
 S MPILINK=$O(MPIL(0))
"RTN","MPIFAPI",39,0)
 I MPILINK="" Q "-1^NOT DEFINED"
"RTN","MPIFAPI",40,0)
 S MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",41,0)
 Q MPILINK
"RTN","MPIFAPI",42,0)
 ;
"RTN","MPIFAPI",43,0)
SUBNUM(DFN) ; returns Subscription Control Number from MPI node for given DFN
"RTN","MPIFAPI",44,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",45,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",46,0)
 ;           Subscription Control Number
"RTN","MPIFAPI",47,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",48,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",49,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",50,0)
 N NODE,SUB
"RTN","MPIFAPI",51,0)
 S NODE=$$MPINODE(DFN)
"RTN","MPIFAPI",52,0)
 S SUB=$P(NODE,"^",5)
"RTN","MPIFAPI",53,0)
 I SUB="" S SUB="-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",54,0)
 Q SUB
"RTN","MPIFAPI",55,0)
 ;
"RTN","MPIFAPI",56,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",57,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",58,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",59,0)
 ;           MPI node from patient file
"RTN","MPIFAPI",60,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",61,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",62,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",63,0)
 N NODE
"RTN","MPIFAPI",64,0)
 S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",65,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",66,0)
 Q NODE
"RTN","MPIFAPI",67,0)
 ;
"RTN","MPIFAPI",68,0)
UPDATE(DFN,ARR) ; updates fields on MPI node passed in ARR(field number) for
"RTN","MPIFAPI",69,0)
 ;patient DFN.  Fields 991.01-991.05 only
"RTN","MPIFAPI",70,0)
 ;ARR - array of values for each field to be updated where subscript
"RTN","MPIFAPI",71,0)
 ; is the field number to be updated
"RTN","MPIFAPI",72,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",73,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",74,0)
 ;          0 if successfully updated fields
"RTN","MPIFAPI",75,0)
 ;
"RTN","MPIFAPI",76,0)
 N FLD,DR,DIE,DA,LOC,SCN,ICN,CMOR
"RTN","MPIFAPI",77,0)
 Q:'$D(^DPT(DFN,0)) "-1^No Entry in Patient file"
"RTN","MPIFAPI",78,0)
 S DIE="^DPT(",DA=DFN,RGRSICN=""
"RTN","MPIFAPI",79,0)
 L +^DPT(DFN,"MPI"):10
"RTN","MPIFAPI",80,0)
 I $G(@ARR@(991.01))'=""&($G(@ARR@(991.02))'="") S ICN=$$SETICN^MPIF001(DFN,@ARR@(991.01),@ARR@(991.02))
"RTN","MPIFAPI",81,0)
 I $G(@ARR@(991.03))'="" S CMOR=$$CHANGE^MPIF001(DFN,$$LKUP^XUAF4(@ARR@(991.03)))
"RTN","MPIFAPI",82,0)
 I $G(@ARR@(991.04))'="" S LOC=$$SETLOC^MPIF001(DFN,@ARR@(991.04))
"RTN","MPIFAPI",83,0)
 I $G(@ARR@(991.05))'=""&($G(@ARR@(991.05))="@") D
"RTN","MPIFAPI",84,0)
 .S SCN=$$SUBNUM(DFN)
"RTN","MPIFAPI",85,0)
 .S DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA
"RTN","MPIFAPI",86,0)
 .S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI",87,0)
 .K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI",88,0)
 I $G(@ARR@(991.05))'=""&($G(@ARR@(991.05))'="@") S DIE="^DPT(",DR="991.05///"_@ARR@(991.05),DA=DFN D ^DIE
"RTN","MPIFAPI",89,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFAPI",90,0)
 I ICN'="",$E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S LOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFAPI",91,0)
 I ICN'="",$E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S LOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFAPI",92,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIFAPI",93,0)
 K ^DPT("AMPIMIS",DFN)
"RTN","MPIFAPI",94,0)
 K RGRSICN
"RTN","MPIFAPI",95,0)
 Q 0
"RTN","MPIFAPI",96,0)
 ;
"RTN","MPIFAPI",97,0)
MPIQ(MDFN) ;
"RTN","MPIFAPI",98,0)
 ;MPI QUERY
"RTN","MPIFAPI",99,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",100,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",101,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",102,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",103,0)
 .N ICN,ERR
"RTN","MPIFAPI",104,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",105,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",106,0)
 .S ERR=$$SETICN^MPIF001(MDFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",107,0)
 .S ERR=$$SETLOC^MPIF001(MDFN,1)
"RTN","MPIFAPI",108,0)
 .S ERR=$$CHANGE^MPIF001(MDFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",109,0)
 K MPIFRTN
"RTN","MPIFAPI",110,0)
 Q
"RTN","MPIFAPI",111,0)
 ;
"RTN","MPIFAPI",112,0)
MPIQQ(PDFN) ; Entry point for queuing d/c
"RTN","MPIFAPI",113,0)
 ; DFN should already exist before making this call
"RTN","MPIFAPI",114,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",115,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",116,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",117,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",118,0)
 S ZTSAVE("PDFN")=PDFN
"RTN","MPIFAPI",119,0)
 S ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",120,0)
 ; ^ silent flag
"RTN","MPIFAPI",121,0)
 S ZTIO=""
"RTN","MPIFAPI",122,0)
 S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",123,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",124,0)
 D HOME^ZIS K IO("Q")
"RTN","MPIFAPI",125,0)
 N TSK
"RTN","MPIFAPI",126,0)
 S TSK=ZTSK
"RTN","MPIFAPI",127,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",128,0)
 Q TSK
"RTN","MPIFQ0")
0^3^B76457139
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-CIRN QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",5,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",6,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",7,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",8,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",9,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",10,0)
 W !
"RTN","MPIFQ0",11,0)
CIRNEXC ; CIRN Exception Entry Point
"RTN","MPIFQ0",12,0)
 I $$SEND^RGJUSITE'>0 W !,"CIRN Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",13,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",14,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",15,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",16,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",17,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",18,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S TDOB=""
"RTN","MPIFQ0",19,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",20,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",21,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",22,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",23,0)
 G JUMP
"RTN","MPIFQ0",24,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",25,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",26,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",27,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",28,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",29,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",30,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S TDOB=""
"RTN","MPIFQ0",31,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",32,0)
 ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",33,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END
"RTN","MPIFQ0",34,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",35,0)
JUMP N TIME,%
"RTN","MPIFQ0",36,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFQ0",37,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",38,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,RGDC
"RTN","MPIFQ0",39,0)
 ;If the HLP("ACKTIME") is not already set for the 
"RTN","MPIFQ0",40,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30
"RTN","MPIFQ0",41,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",42,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",43,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",44,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",45,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",46,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",47,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",48,0)
 . I '$D(MPIFS) W !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",49,0)
 ;Create MSH
"RTN","MPIFQ0",50,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFQ0",51,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",52,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",53,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",54,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",55,0)
 I '$D(MPIFS) D
"RTN","MPIFQ0",56,0)
 .W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFQ0",57,0)
 .W !,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",58,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","RGDC")
"RTN","MPIFQ0",59,0)
 ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",60,0)
 K HLP("ACKTIME")
"RTN","MPIFQ0",61,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and continue with Registration
"RTN","MPIFQ0",62,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",63,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",64,0)
 . I '$D(MPIFS) W !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",65,0)
 . D LOCAL(DFN)
"RTN","MPIFQ0",66,0)
 . S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",67,0)
 ;this is the array the data is parsed into for display in list manager
"RTN","MPIFQ0",68,0)
 K ^TMP("MPIFQ0",$J)
"RTN","MPIFQ0",69,0)
INIPARS N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",70,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",71,0)
PARSE S SEG=$$SEG^RGRSUTIL("RDT",1,"RDT")
"RTN","MPIFQ0",72,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",73,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN
"RTN","MPIFQ0",74,0)
 . N HEREICN,HERESSN,MIDDLE,IEN,F
"RTN","MPIFQ0",75,0)
 . S STRING=""
"RTN","MPIFQ0",76,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFQ0",77,0)
 . S MIDDLE=$P(SEG,HL("FS"),10),SUFF=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",78,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFQ0",79,0)
 . S NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",80,0)
 . I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",81,0)
 . I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",82,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",83,0)
 . I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN
"RTN","MPIFQ0",84,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",85,0)
 . S FIRST=FIRST+1
"RTN","MPIFQ0",86,0)
 . S CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",87,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",88,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFQ0",89,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",90,0)
 . ;Same patient just adding TF's
"RTN","MPIFQ0",91,0)
 . I TF'="",ICN=FICN,FIRST'=2 D
"RTN","MPIFQ0",92,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFQ0",93,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF
"RTN","MPIFQ0",94,0)
 . Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",95,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",96,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFQ0",97,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFQ0",98,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFQ0",99,0)
 . . S BIRTHDAY=$$IN2EXDT^VAFCMGU0(BIRTHDAY,0)
"RTN","MPIFQ0",100,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",101,0)
 . S INDEX=INDEX+1,COUNTER=1,HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",102,0)
 . I HEREICN D
"RTN","MPIFQ0",103,0)
 . . S STRING=$$SETSTR^VALM1("*",STRING,1,1)
"RTN","MPIFQ0",104,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",105,0)
 . S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4)
"RTN","MPIFQ0",106,0)
 . S STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",107,0)
 . S STRING=$$SETSTR^VALM1(SSN,STRING,30,9)
"RTN","MPIFQ0",108,0)
 . S STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",109,0)
 . S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",110,0)
 . S ^TMP("MPIFQ0",$J,INDEX,0)=STRING
"RTN","MPIFQ0",111,0)
 . S ^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",112,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_CCMOR
"RTN","MPIFQ0",113,0)
 . S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",114,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",115,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",116,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",117,0)
 . I '$D(MPIFS) W !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",118,0)
 . D A28(DFN)
"RTN","MPIFQ0",119,0)
 . S MPIFRTN="DID A28"
"RTN","MPIFQ0",120,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to see if it's definitely the same patient.
"RTN","MPIFQ0",121,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",122,0)
 . N CMOR,ICN,DATA,TICN
"RTN","MPIFQ0",123,0)
 . S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA"),CMOR=CCMOR,ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",124,0)
 . D START^RGHLLOG(0)
"RTN","MPIFQ0",125,0)
 . S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",126,0)
 . I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",127,0)
 . I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",128,0)
 . ; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",129,0)
 . I $P(DATA,"^")'=LOCDATA(2,DFN,.01) D  Q
"RTN","MPIFQ0",130,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",131,0)
 ..I '$D(MPIFINIT) D LOC2(DFN) Q
"RTN","MPIFQ0",132,0)
 . I '$D(MPIFS) W !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",133,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ0",134,0)
 . D UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",135,0)
 . S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",136,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",137,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",138,0)
 .I '$D(MPIFS) W !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",139,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",140,0)
 .D EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN)
"RTN","MPIFQ0",141,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ0",142,0)
 .D LOCAL(DFN)
"RTN","MPIFQ0",143,0)
 .S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",144,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",145,0)
EXIT ;
"RTN","MPIFQ0",146,0)
 I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",147,0)
 K CCMOR,FICN H 3 W !!
"RTN","MPIFQ0",148,0)
END ;
"RTN","MPIFQ0",149,0)
 Q
"RTN","MPIFQ0",150,0)
A28(DFN) ;
"RTN","MPIFQ0",151,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",152,0)
 I +ICN>0 I '$D(MPIFS) W !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",153,0)
 ;ASSIGN LOCAL ICN
"RTN","MPIFQ0",154,0)
 I '$D(MPIFS) W !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",155,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",156,0)
 Q
"RTN","MPIFQ0",157,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",158,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",159,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",160,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ0",161,0)
 S ICN=$P(ICN,"V",1)
"RTN","MPIFQ0",162,0)
 S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",163,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",164,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",165,0)
 I +SETICN'>0 D  Q
"RTN","MPIFQ0",166,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0"
"RTN","MPIFQ0",167,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",168,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",169,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",170,0)
 I +SETLOC'>0 D  Q
"RTN","MPIFQ0",171,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0"
"RTN","MPIFQ0",172,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",173,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",174,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",175,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",176,0)
 I +CHANGE'>0 D  Q
"RTN","MPIFQ0",177,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0"
"RTN","MPIFQ0",178,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",179,0)
 N HERE S HERE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFQ0",180,0)
 I '$$PATCH^XPDUTL("DG*5.3*261") D
"RTN","MPIFQ0",181,0)
 .I CMOR=HERE D TFLIST^MPIFBT2(CMOR,DFN)
"RTN","MPIFQ0",182,0)
 .; ^ add CMOR to treating facility list
"RTN","MPIFQ0",183,0)
 .I CMOR'=HERE D TFLIST^MPIFBT2(HERE,DFN),TFUPDT^MPIFBT2(DFN,0,0),INSERT^RGJCTS01(DFN)
"RTN","MPIFQ0",184,0)
 .; ^ not CMOR add site to Treating Facility list, add pivot file treating facility message and add subscription control message to event queue.
"RTN","MPIFQ0",185,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",186,0)
 Q
"RTN","MPIFQ0",187,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",188,0)
 N ICN
"RTN","MPIFQ0",189,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",190,0)
 ;don't assign local if one already exists
"RTN","MPIFQ0",191,0)
 S ICN=$$ICNLC^MPIF001(DFN)
"RTN","MPIFQ0",192,0)
 Q
"RTN","MPIFQ0",193,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",194,0)
 N DFN
"RTN","MPIFQ0",195,0)
 I $G(ICN)="" Q 0
"RTN","MPIFQ0",196,0)
 S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",197,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",198,0)
 Q DFN
"RTN","MPIFQ0",199,0)
TEST(SSN) ;
"RTN","MPIFQ0",200,0)
 N DFN
"RTN","MPIFQ0",201,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ0",202,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ0",203,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ0",204,0)
 Q DFN
"RTN","MPIFQ0",205,0)
HERESSN(X) ;
"RTN","MPIFQ0",206,0)
 N DFN,X,Y,DIC,D
"RTN","MPIFQ0",207,0)
 I $G(X)="" Q 0
"RTN","MPIFQ0",208,0)
 S DIC="^DPT(",D="SSN",DIC(0)="X"
"RTN","MPIFQ0",209,0)
 D MIX^DIC1
"RTN","MPIFQ0",210,0)
 Q:$G(Y)=-1 0
"RTN","MPIFQ0",211,0)
 Q $P(Y,"^",1)
"RTN","MPIFQ0",212,0)
GETDATA(DIC,DA,ARRAY,DR,EI) ;
"RTN","MPIFQ0",213,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",214,0)
 ;DIC is the file reference
"RTN","MPIFQ0",215,0)
 ;DA is the file entry IEN
"RTN","MPIFQ0",216,0)
 ;ARRAY is the storage array for the values to be stored in
"RTN","MPIFQ0",217,0)
 ;DR are the fields requested
"RTN","MPIFQ0",218,0)
 ;EI is external/internal values of the fields or don't return null values
"RTN","MPIFQ0",219,0)
 N DIQ
"RTN","MPIFQ0",220,0)
 S DIQ=ARRAY
"RTN","MPIFQ0",221,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",222,0)
 D EN^DIQ1
"RTN","MPIFQ0",223,0)
 Q
"RTN","MPIFQ0",224,0)
LOC2(DFN) ;
"RTN","MPIFQ0",225,0)
 W !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",226,0)
 D START^RGHLLOG()
"RTN","MPIFQ0",227,0)
 D EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN)
"RTN","MPIFQ0",228,0)
 D STOP^RGHLLOG()
"RTN","MPIFQ0",229,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",230,0)
 Q
"RTN","MPIFQ1")
0^4^B35761933
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16**;30 Apr 99
"RTN","MPIFQ1",3,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",4,0)
 ; It is started from outside of the template.
"RTN","MPIFQ1",5,0)
 Q
"RTN","MPIFQ1",6,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",7,0)
 N SSN,DOB,MPIFQ1,NAME1
"RTN","MPIFQ1",8,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09","EI")
"RTN","MPIFQ1",9,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",10,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",11,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I"))
"RTN","MPIFQ1",12,0)
 I DOB]"" S DOB=$$IN2EXDT^VAFCMGU0(DOB,0)
"RTN","MPIFQ1",13,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",14,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",15,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",16,0)
 Q
"RTN","MPIFQ1",17,0)
START(INDEX) ;
"RTN","MPIFQ1",18,0)
 ;Starting entry point for Invoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",19,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",20,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",21,0)
 Q
"RTN","MPIFQ1",22,0)
SELECT ;
"RTN","MPIFQ1",23,0)
 N VALMY
"RTN","MPIFQ1",24,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",25,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",26,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2,HERESSN
"RTN","MPIFQ1",27,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",28,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",29,0)
 S NODE2=$G(^TMP("MPIFQ0",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",30,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",31,0)
 S DATA(.03)=$P(DATA,"^",3) ;DOB
"RTN","MPIFQ1",32,0)
 S DATA(.09)=$P(DATA,"^",2) ;SSN
"RTN","MPIFQ1",33,0)
 S ICN=$P(DATA,"^",4)
"RTN","MPIFQ1",34,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",35,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",36,0)
 S DATA(991.01)=ICN
"RTN","MPIFQ1",37,0)
 S DATA(991.02)=CHKSUM ;CHKSUM
"RTN","MPIFQ1",38,0)
 S DATA(991.03)=$P(DATA,"^",7) ;CMOR
"RTN","MPIFQ1",39,0)
 ;
"RTN","MPIFQ1",40,0)
 ;If NODE2["*" it means we got a match on ICN for a patient in our
"RTN","MPIFQ1",41,0)
 ;list, with a patient in our local database. Since we don't allow more 
"RTN","MPIFQ1",42,0)
 ;than one patient to have the same ICN, we log an Exception and assign 
"RTN","MPIFQ1",43,0)
 ;a Local ICN for this patient.
"RTN","MPIFQ1",44,0)
 ;
"RTN","MPIFQ1",45,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",46,0)
 . D CLEAR^VALM1
"RTN","MPIFQ1",47,0)
 . D MSG1
"RTN","MPIFQ1",48,0)
 . D START^RGHLLOG()
"RTN","MPIFQ1",49,0)
 . D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",50,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ1",51,0)
 . W !!,"Assigning Local ICN"
"RTN","MPIFQ1",52,0)
 . D LOCAL^MPIFQ0(DFN)
"RTN","MPIFQ1",53,0)
 . D PROMPT
"RTN","MPIFQ1",54,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",55,0)
 ;
"RTN","MPIFQ1",56,0)
 ;User selected one from the list that doesn't exist already in this
"RTN","MPIFQ1",57,0)
 ; Patient file. 
"RTN","MPIFQ1",58,0)
 ;Does SSN and Name match?  If no - ask if they are sure before 
"RTN","MPIFQ1",59,0)
 ;updating ICN and CMOR fields
"RTN","MPIFQ1",60,0)
 ;
"RTN","MPIFQ1",61,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09","EI")
"RTN","MPIFQ1",62,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",63,0)
 ;SSN and Name both match on site and MPI -- Update ICN and CMOR
"RTN","MPIFQ1",64,0)
 I DATA(.09)=SSN,DATA(.01)=NAME  K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3,PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",65,0)
 ;
"RTN","MPIFQ1",66,0)
 ;SSN and/or Name doesn't match
"RTN","MPIFQ1",67,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",68,0)
 D MSG2
"RTN","MPIFQ1",69,0)
 D MSG(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",70,0)
 N ANS
"RTN","MPIFQ1",71,0)
 S ANS=$$PROMPT1()
"RTN","MPIFQ1",72,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",73,0)
 D MSG5,PROMPT
"RTN","MPIFQ1",74,0)
 S VALMBCK="R"
"RTN","MPIFQ1",75,0)
 ;
"RTN","MPIFQ1",76,0)
 Q
"RTN","MPIFQ1",77,0)
 ;
"RTN","MPIFQ1",78,0)
 ;
"RTN","MPIFQ1",79,0)
ADD ;
"RTN","MPIFQ1",80,0)
 ;Add List Manager Action (MPIF REAL-TIME QUERY (ADD PATIENT)) to add
"RTN","MPIFQ1",81,0)
 ; patient to the MPI Austin.
"RTN","MPIFQ1",82,0)
 D A28^MPIFQ0(DFN)
"RTN","MPIFQ1",83,0)
 D MSG3,PROMPT
"RTN","MPIFQ1",84,0)
 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",85,0)
 Q
"RTN","MPIFQ1",86,0)
 ;
"RTN","MPIFQ1",87,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",88,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",89,0)
 D MSG4
"RTN","MPIFQ1",90,0)
 D PROMPT
"RTN","MPIFQ1",91,0)
 S VALMBCK="R"
"RTN","MPIFQ1",92,0)
 Q
"RTN","MPIFQ1",93,0)
 ;
"RTN","MPIFQ1",94,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME) ;
"RTN","MPIFQ1",95,0)
 ;
"RTN","MPIFQ1",96,0)
 W !!!,"Local SSN = "_LOCSSN,?35,"MPI SSN = "_MPISSN
"RTN","MPIFQ1",97,0)
 W !,"Local NAME = "_LOCNAME,?40,"MPI NAME = "_MPINAME
"RTN","MPIFQ1",98,0)
 Q
"RTN","MPIFQ1",99,0)
 ;
"RTN","MPIFQ1",100,0)
MSG3 ;
"RTN","MPIFQ1",101,0)
 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ1",102,0)
 Q
"RTN","MPIFQ1",103,0)
MSG1 ;
"RTN","MPIFQ1",104,0)
 W !!,"You are attempting to assign an ICN that has already been assigned"
"RTN","MPIFQ1",105,0)
 W !,"to another patient in your Patient file."
"RTN","MPIFQ1",106,0)
 W !,"An Exception will be recorded noting that these 2 patients "
"RTN","MPIFQ1",107,0)
 W !,"need to be reviewed to determine in they are a duplicate."
"RTN","MPIFQ1",108,0)
 Q
"RTN","MPIFQ1",109,0)
MSG2 ;
"RTN","MPIFQ1",110,0)
 W !!,"You have selected a patient from the list of potential matches"
"RTN","MPIFQ1",111,0)
 W !," where the SSN and/or the Name is different than what the MPI has."
"RTN","MPIFQ1",112,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ1",113,0)
 Q
"RTN","MPIFQ1",114,0)
 ;
"RTN","MPIFQ1",115,0)
MSG5 ;
"RTN","MPIFQ1",116,0)
 W !!,"No Action Taken"
"RTN","MPIFQ1",117,0)
 Q
"RTN","MPIFQ1",118,0)
MSG4 ;
"RTN","MPIFQ1",119,0)
 W !!,"When you have reached MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ1",120,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ1",121,0)
 W !,"you are adding, or selected (pre-existing record)."
"RTN","MPIFQ1",122,0)
 W !!,"The MPI has returned a list of possible matches for that patient"
"RTN","MPIFQ1",123,0)
 W !,"An '*' indicates the Integration Control Number of a patient"
"RTN","MPIFQ1",124,0)
 W !,"on the list, matches one in your Patient file already."
"RTN","MPIFQ1",125,0)
 W !,"To select a patient from the list, choose SP."
"RTN","MPIFQ1",126,0)
 W !,"If the patients listed as potential matches aren't the same patient"
"RTN","MPIFQ1",127,0)
 W !,"select ADD to create a new entry on the MPI for this patient"
"RTN","MPIFQ1",128,0)
 Q
"RTN","MPIFQ1",129,0)
 ;
"RTN","MPIFQ1",130,0)
PROMPT ;
"RTN","MPIFQ1",131,0)
 W !!
"RTN","MPIFQ1",132,0)
 S DIR("A")="Hit the Enter key, to Continue "
"RTN","MPIFQ1",133,0)
 S DIR(0)="EA"
"RTN","MPIFQ1",134,0)
 D ^DIR
"RTN","MPIFQ1",135,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",136,0)
 Q
"RTN","MPIFQ1",137,0)
PROMPT1() ;
"RTN","MPIFQ1",138,0)
 N DIR,X,Y
"RTN","MPIFQ1",139,0)
 W !
"RTN","MPIFQ1",140,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO "
"RTN","MPIFQ1",141,0)
 S DIR(0)="YA"
"RTN","MPIFQ1",142,0)
 D ^DIR
"RTN","MPIFQ1",143,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",144,0)
 Q Y
"RTN","MPIFQ1",145,0)
HERESSN(SSN) ;
"RTN","MPIFQ1",146,0)
 N DFN
"RTN","MPIFQ1",147,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ1",148,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ1",149,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ1",150,0)
 Q DFN
"RTN","MPIFQ1",151,0)
 ;
"RTN","MPIFQ1",152,0)
CHECK(DFN) ;
"RTN","MPIFQ1",153,0)
 N CHECK
"RTN","MPIFQ1",154,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ1",155,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ1",156,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ1",157,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ1",158,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ1",159,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ1",160,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ1",161,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ1",162,0)
 Q 1
"RTN","MPIFQ1",163,0)
 ;
"RTN","MPIFQ1",164,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",165,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",166,0)
 Q
"RTN","MPIFQ1",167,0)
 ;
"RTN","MPIFQ1",168,0)
TF(DFN,ARR) ;Add you to TF list and trigger TF and Sub msgs
"RTN","MPIFQ1",169,0)
 N SITE
"RTN","MPIFQ1",170,0)
 S SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFQ1",171,0)
 I SITE=ARR(991.03) D TFLIST^MPIFBT2(SITE,DFN) Q
"RTN","MPIFQ1",172,0)
 I '$$PATCH^XPDUTL("DG*5.3*261") D
"RTN","MPIFQ1",173,0)
 .D TFLIST^MPIFBT2(HERE,DFN),TFUPDT^MPIFBT2(DFN,0,0),INSERT^RGJCTS01(DFN)
"RTN","MPIFQ1",174,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ1",175,0)
 Q
"VER")
8.0^22.0
**END**
**END**
