Released DG*5.3*513 SEQ #446
Extracted from mail message
**KIDS**:DG*5.3*513^

**INSTALL NAME**
DG*5.3*513
"BLD",4682,0)
DG*5.3*513^REGISTRATION^0^3030513^y
"BLD",4682,1,0)
^^1^1^3030424^
"BLD",4682,1,1,0)
Fix Patient Look-Up Problem
"BLD",4682,4,0)
^9.64PA^^
"BLD",4682,"KRN",0)
^9.67PA^8989.52^19
"BLD",4682,"KRN",.4,0)
.4
"BLD",4682,"KRN",.401,0)
.401
"BLD",4682,"KRN",.402,0)
.402
"BLD",4682,"KRN",.403,0)
.403
"BLD",4682,"KRN",.5,0)
.5
"BLD",4682,"KRN",.84,0)
.84
"BLD",4682,"KRN",3.6,0)
3.6
"BLD",4682,"KRN",3.8,0)
3.8
"BLD",4682,"KRN",9.2,0)
9.2
"BLD",4682,"KRN",9.8,0)
9.8
"BLD",4682,"KRN",9.8,"NM",0)
^9.68A^13^13
"BLD",4682,"KRN",9.8,"NM",1,0)
DPTLK^^0^B56493435
"BLD",4682,"KRN",9.8,"NM",2,0)
DGENRPT1^^0^B20019601
"BLD",4682,"KRN",9.8,"NM",3,0)
DGENRPT2^^0^B40344748
"BLD",4682,"KRN",9.8,"NM",4,0)
DGENRPT3^^0^B29803264
"BLD",4682,"KRN",9.8,"NM",5,0)
DGENRPT4^^0^B52820281
"BLD",4682,"KRN",9.8,"NM",6,0)
DGENUPL7^^0^B27511259
"BLD",4682,"KRN",9.8,"NM",7,0)
DGENEGT1^^0^B23812740
"BLD",4682,"KRN",9.8,"NM",8,0)
DGRPTU^^0^B6454885
"BLD",4682,"KRN",9.8,"NM",9,0)
DG10^^0^B16395397
"BLD",4682,"KRN",9.8,"NM",10,0)
DGREG^^0^B33365966
"BLD",4682,"KRN",9.8,"NM",11,0)
DGMTREM^^0^B4246677
"BLD",4682,"KRN",9.8,"NM",12,0)
DGENA6^^0^B19201879
"BLD",4682,"KRN",9.8,"NM",13,0)
DGRPD^^0^B51763780
"BLD",4682,"KRN",9.8,"NM","B","DG10",9)

"BLD",4682,"KRN",9.8,"NM","B","DGENA6",12)

"BLD",4682,"KRN",9.8,"NM","B","DGENEGT1",7)

"BLD",4682,"KRN",9.8,"NM","B","DGENRPT1",2)

"BLD",4682,"KRN",9.8,"NM","B","DGENRPT2",3)

"BLD",4682,"KRN",9.8,"NM","B","DGENRPT3",4)

"BLD",4682,"KRN",9.8,"NM","B","DGENRPT4",5)

"BLD",4682,"KRN",9.8,"NM","B","DGENUPL7",6)

"BLD",4682,"KRN",9.8,"NM","B","DGMTREM",11)

"BLD",4682,"KRN",9.8,"NM","B","DGREG",10)

"BLD",4682,"KRN",9.8,"NM","B","DGRPD",13)

"BLD",4682,"KRN",9.8,"NM","B","DGRPTU",8)

"BLD",4682,"KRN",9.8,"NM","B","DPTLK",1)

"BLD",4682,"KRN",19,0)
19
"BLD",4682,"KRN",19,"NM",0)
^9.68A^^
"BLD",4682,"KRN",19.1,0)
19.1
"BLD",4682,"KRN",101,0)
101
"BLD",4682,"KRN",409.61,0)
409.61
"BLD",4682,"KRN",771,0)
771
"BLD",4682,"KRN",870,0)
870
"BLD",4682,"KRN",8989.51,0)
8989.51
"BLD",4682,"KRN",8989.52,0)
8989.52
"BLD",4682,"KRN",8994,0)
8994
"BLD",4682,"KRN","B",.4,.4)

"BLD",4682,"KRN","B",.401,.401)

"BLD",4682,"KRN","B",.402,.402)

"BLD",4682,"KRN","B",.403,.403)

"BLD",4682,"KRN","B",.5,.5)

"BLD",4682,"KRN","B",.84,.84)

"BLD",4682,"KRN","B",3.6,3.6)

"BLD",4682,"KRN","B",3.8,3.8)

"BLD",4682,"KRN","B",9.2,9.2)

"BLD",4682,"KRN","B",9.8,9.8)

"BLD",4682,"KRN","B",19,19)

"BLD",4682,"KRN","B",19.1,19.1)

"BLD",4682,"KRN","B",101,101)

"BLD",4682,"KRN","B",409.61,409.61)

"BLD",4682,"KRN","B",771,771)

"BLD",4682,"KRN","B",870,870)

"BLD",4682,"KRN","B",8989.51,8989.51)

"BLD",4682,"KRN","B",8989.52,8989.52)

"BLD",4682,"KRN","B",8994,8994)

"BLD",4682,"QUES",0)
^9.62^^
"BLD",4682,"REQB",0)
^9.611^7^5
"BLD",4682,"REQB",1,0)
DG*5.3*326^2
"BLD",4682,"REQB",3,0)
DG*5.3*431^2
"BLD",4682,"REQB",5,0)
DG*5.3*491^2
"BLD",4682,"REQB",6,0)
DG*5.3*498^2
"BLD",4682,"REQB",7,0)
DG*5.3*244^2
"BLD",4682,"REQB","B","DG*5.3*244",7)

"BLD",4682,"REQB","B","DG*5.3*326",1)

"BLD",4682,"REQB","B","DG*5.3*431",3)

"BLD",4682,"REQB","B","DG*5.3*491",5)

"BLD",4682,"REQB","B","DG*5.3*498",6)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
513^3030513
"PKG",5,22,1,"PAH",1,1,0)
^^1^1^3030513
"PKG",5,22,1,"PAH",1,1,1,0)
Fix Patient Look-Up Problem
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
13
"RTN","DG10")
0^9^B16395397
"RTN","DG10",1,0)
DG10 ;ALB/MRL,DAK,AEG-LOAD/EDIT PATIENT DATA ; 04/24/2003  9:07 PM
"RTN","DG10",2,0)
 ;;5.3;Registration;**32,109,139,149,182,326,513**;Aug 13, 1993
"RTN","DG10",3,0)
START ;
"RTN","DG10",4,0)
 D LO^DGUTL
"RTN","DG10",5,0)
 I $G(DGPRFLG)=1,$G(DGPLOC)=1 D  G A1
"RTN","DG10",6,0)
 . D EN^DGRPD,REG^IVMCQ($G(DFN))
"RTN","DG10",7,0)
 . D HINQ
"RTN","DG10",8,0)
 ;
"RTN","DG10",9,0)
A W !! K VET,DIE,DIC,CARD S DIC=2,DLAYGO=2,DIC(0)="ALEQM" K DIC("S") D ^DIC G Q:Y<0 S (DFN,DA)=+Y,DGNEW=$P(Y,"^",3) K DLAYGO
"RTN","DG10",10,0)
 N Y D PAUSE I DGNEW D NEW^DGRP S DA=DFN,VET=$S($D(^DPT(DFN,"VET")):^("VET")'="Y",1:0)
"RTN","DG10",11,0)
 ;
"RTN","DG10",12,0)
 ;MPI QUERY
"RTN","DG10",13,0)
 ;check to see if CIRN PD/MPI is installed
"RTN","DG10",14,0)
 N X S X="MPIFAPI" X ^%ZOSF("TEST") G:'$T SKIP
"RTN","DG10",15,0)
 K MPIFRTN
"RTN","DG10",16,0)
 D MPIQ^MPIFAPI(DFN)
"RTN","DG10",17,0)
 K MPIFRTN
"RTN","DG10",18,0)
 ;
"RTN","DG10",19,0)
SKIP ;
"RTN","DG10",20,0)
 S DGELVER=0 D EN^DGRPD I $D(DGRPOUT) K DGRPOUT G A
"RTN","DG10",21,0)
 D HINQ,REG^IVMCQ($G(DFN)) G A1
"RTN","DG10",22,0)
 ;
"RTN","DG10",23,0)
HINQ ;
"RTN","DG10",24,0)
 S Y=$S($D(^DG(43,1,0)):^(0),1:0) I $P(Y,U,27) S X="DVBHQZ4" X ^%ZOSF("TEST") I $T D
"RTN","DG10",25,0)
 .N DGROUT
"RTN","DG10",26,0)
 .S DGROUT=X
"RTN","DG10",27,0)
 .I $G(DFN) D
"RTN","DG10",28,0)
 ..N X,Y,DGRP
"RTN","DG10",29,0)
 ..F X=.3,.32 S DGRP(X)=$G(^DPT(DFN,X))
"RTN","DG10",30,0)
 ..W !,"     Money Verified: " S Y=$P(DGRP(.3),"^",6) X:Y]"" ^DD("DD") W $S(Y]"":Y,1:"NOT VERIFIED")
"RTN","DG10",31,0)
 ..W ?40,"   Service Verified: " S Y=$P(DGRP(.32),"^",2) X:Y]"" ^DD("DD") W $S(Y]"":Y,1:"NOT VERIFIED")
"RTN","DG10",32,0)
 .D @("EN^"_DGROUT) K Y Q  ;from dgdem0
"RTN","DG10",33,0)
 Q
"RTN","DG10",34,0)
 ;
"RTN","DG10",35,0)
 ;   SDIEMM is used as a flag by AMBCARE Incomplete Encounter Management 
"RTN","DG10",36,0)
 ;   to bypass the embossing routines when calling load/edit from IEMM
"RTN","DG10",37,0)
 ;
"RTN","DG10",38,0)
A1 W !,"Do you want to ",$S(DGNEW:"enter",1:"edit")," Patient Data" S %=1 D YN^DICN G H:'%,CK:%'=1 S DGRPV=0 D EN1^DGRP,MT(DFN),CP G Q:$G(DGPRFLG)=1 G Q:$G(SDIEMM) G Q:'$D(DA),EMBOS
"RTN","DG10",39,0)
 ;
"RTN","DG10",40,0)
H W !?5,"Enter 'YES' to enter/edit registration data or 'NO' to continue without",!?5,"editing."
"RTN","DG10",41,0)
 G A1
"RTN","DG10",42,0)
 ;
"RTN","DG10",43,0)
CK S DGEDCN=1 D ^DGRPC,MT(DFN),CP
"RTN","DG10",44,0)
 G Q:$G(DGPRFLG)=1 G Q:$G(SDIEMM)
"RTN","DG10",45,0)
 I $G(DGER)[55 K DIR S DIR(0)="Y",DIR("A")="Do you wish to return to Screen #9 to enter missing Income Data? " D ^DIR K DIR
"RTN","DG10",46,0)
 ;G:Y ^DGRP9
"RTN","DG10",47,0)
 ;
"RTN","DG10",48,0)
EMBOS W ! D EMBOS^DGQEMA G A
"RTN","DG10",49,0)
 ;
"RTN","DG10",50,0)
 ;
"RTN","DG10",51,0)
Q K X,Y,Z,DIC,DGELVER,DGNEW,DGRPV,VET Q
"RTN","DG10",52,0)
 ;
"RTN","DG10",53,0)
MT(DFN) ; Check if user requires a means test.  Ask user if they want to proceedif
"RTN","DG10",54,0)
 ; one is required
"RTN","DG10",55,0)
 I '$D(SDIEMM) DO
"RTN","DG10",56,0)
 .N DGREQF,DIV
"RTN","DG10",57,0)
 .D EN^DGMTR
"RTN","DG10",58,0)
 .I DGREQF D EDT^DGMTU(DFN,DT):$P($$MTS^DGMTU(DFN),U,2)="R"
"RTN","DG10",59,0)
 .Q
"RTN","DG10",60,0)
 I $D(SDIEMM) DO
"RTN","DG10",61,0)
 .N DGMTI
"RTN","DG10",62,0)
 .S DGMTI=$$LST^DGMTU(DFN,SCINF("ENCOUNTER"),1)
"RTN","DG10",63,0)
 .I $P(DGMTI,U,4)="R" D  I 1
"RTN","DG10",64,0)
 ..S DGMT0=$G(^DGMT(408.31,+DGMTI,0)),DGMTDT=$P(DGMT0,"^")
"RTN","DG10",65,0)
 ..I '$$OKTOCONT(DGMTDT) Q
"RTN","DG10",66,0)
 ..S DGMTI=+DGMTI,DGMTYPT=1,DGMTACT="COM",DGMTROU="COM^DGMTEO" D EN^DGMTSC
"RTN","DG10",67,0)
 .E  D WARNING
"RTN","DG10",68,0)
 .Q
"RTN","DG10",69,0)
 Q
"RTN","DG10",70,0)
 ;
"RTN","DG10",71,0)
WARNING ;
"RTN","DG10",72,0)
 ;prints a warning to the screen about means test
"RTN","DG10",73,0)
 ;
"RTN","DG10",74,0)
 W !!,"A means test for this encounter date was not found and may be required!"
"RTN","DG10",75,0)
 W !,"Further investigation will be needed."
"RTN","DG10",76,0)
 W !
"RTN","DG10",77,0)
 D PAUSE
"RTN","DG10",78,0)
 Q
"RTN","DG10",79,0)
 ;
"RTN","DG10",80,0)
PAUSE ;
"RTN","DG10",81,0)
 N DIR
"RTN","DG10",82,0)
 S DIR(0)="FAO",DIR("A")="Press ENTER to continue " D ^DIR
"RTN","DG10",83,0)
 Q
"RTN","DG10",84,0)
 ;
"RTN","DG10",85,0)
OKTOCONT(Y) ;
"RTN","DG10",86,0)
 ;
"RTN","DG10",87,0)
 N DIR
"RTN","DG10",88,0)
 W !!,"Patient Requires a means Test"
"RTN","DG10",89,0)
 X ^DD("DD")
"RTN","DG10",90,0)
 W !,"Primary Means Test Required from '",Y,"'",!
"RTN","DG10",91,0)
 ;
"RTN","DG10",92,0)
 I $D(SDIEMM),'$D(^XUSEC("SCENI MEANS TEST EDIT",DUZ)) DO  G OKQ
"RTN","DG10",93,0)
 .W !,$C(7),"You do not have the appropriate IEMM Security Key.  Contact your supervisor.",!
"RTN","DG10",94,0)
 .D PAUSE
"RTN","DG10",95,0)
 .S Y=0
"RTN","DG10",96,0)
 ;
"RTN","DG10",97,0)
 S DIR("A")="Do you wish to proceed with the means test at this time"
"RTN","DG10",98,0)
 S DIR("B")="YES"
"RTN","DG10",99,0)
 S DIR(0)="Y"
"RTN","DG10",100,0)
 D ^DIR
"RTN","DG10",101,0)
OKQ Q $S(Y=1:1,1:0)
"RTN","DG10",102,0)
 ;
"RTN","DG10",103,0)
CP ; If not (autoexempt or MTested) & no CP test this year then
"RTN","DG10",104,0)
 ; prompt for add/edit cp test
"RTN","DG10",105,0)
 N DIV,DGIB,DGIBDT,DGX,X,DIRUT,DTOUT
"RTN","DG10",106,0)
 G:'$P($G(^DG(43,1,0)),U,41) QTCP ;USE CP FLAG
"RTN","DG10",107,0)
 S DGIBDT=$S($D(DFN1):9999999-DFN1,1:DT)
"RTN","DG10",108,0)
 D EN^DGMTCOR
"RTN","DG10",109,0)
 I +$G(DGNOCOPF) S DGMTCOR=0
"RTN","DG10",110,0)
 I DGMTCOR D THRESH^DGMTCOU1(DGIBDT) D EDT^DGMTCOU(DFN,DT)
"RTN","DG10",111,0)
 K DGNOCOPF
"RTN","DG10",112,0)
QTCP Q
"RTN","DGENA6")
0^12^B19201879
"RTN","DGENA6",1,0)
DGENA6 ;ALB/CJM,ISA,KWP,RTK,LBD - Enrollment API to create enrollment record; 04/24/03 ; 11/1/01 3:26pm
"RTN","DGENA6",2,0)
 ;;5.3;Registration;**232,327,417,491,513**;Aug 13, 1993
"RTN","DGENA6",3,0)
 ;
"RTN","DGENA6",4,0)
 ;CREATE line tag moved from DGENA in DG*5.3*232.;MM  
"RTN","DGENA6",5,0)
 ;
"RTN","DGENA6",6,0)
CREATE(DFN,APP,EFFDATE,REASON,REMARKS,DGENR,ENRDATE,END) ;
"RTN","DGENA6",7,0)
 ;Description: Creates a local enrollment as a local array.
"RTN","DGENA6",8,0)
 ;Input :
"RTN","DGENA6",9,0)
 ;  DFN- Patient IEN
"RTN","DGENA6",10,0)
 ;  APP - the Enrollment Application Date to use
"RTN","DGENA6",11,0)
 ;  EFFDATE - the Effective Date, if  NULL assume the same as the
"RTN","DGENA6",12,0)
 ;     Enrollment Date
"RTN","DGENA6",13,0)
 ;  REASON - used to create an enrollment with CANCELLED/DECLINED status,
"RTN","DGENA6",14,0)
 ;     pass in the code for REASON CANCELED/DECLINED
"RTN","DGENA6",15,0)
 ;  REMARKS - if creating an enrollment with CANCELLED/DECLINED status,
"RTN","DGENA6",16,0)
 ;     and the reason is can optionally pass in textual remarks for
"RTN","DGENA6",17,0)
 ;     CANCELED/DECLINED REMARKS 
"RTN","DGENA6",18,0)
 ;  ENRDATE - the Enrollment Date to use (optional)
"RTN","DGENA6",19,0)
 ;  END - the Enrollment End Date to use (optional)
"RTN","DGENA6",20,0)
 ;Output:
"RTN","DGENA6",21,0)
 ;  Function Value - returns 1 if successful, 0 otherwise
"RTN","DGENA6",22,0)
 ;  DGENR - a local array where the enrollment object will be stored,
"RTN","DGENA6",23,0)
 ;     pass by reference
"RTN","DGENA6",24,0)
 ;
"RTN","DGENA6",25,0)
 K DGENR
"RTN","DGENA6",26,0)
 S DGENR=""
"RTN","DGENA6",27,0)
 N DGELGSUB,PRIORITY,DEATH,PRIGRP
"RTN","DGENA6",28,0)
 ;Re-Enrollment - var PRIGRP contains priority and subgroup
"RTN","DGENA6",29,0)
 S PRIGRP=$$PRIORITY^DGENELA4(DFN,,.DGELGSUB,$G(ENRDATE),$G(APP))
"RTN","DGENA6",30,0)
 S PRIORITY=$P(PRIGRP,"^")  ; Re-Enrollment - Priority is first piece
"RTN","DGENA6",31,0)
 S DGENR("APP")=$G(APP)
"RTN","DGENA6",32,0)
 S DGENR("DATE")=$G(ENRDATE)
"RTN","DGENA6",33,0)
 S DGENR("END")=$G(END)
"RTN","DGENA6",34,0)
 S DGENR("DFN")=DFN
"RTN","DGENA6",35,0)
 S DGENR("SOURCE")=1
"RTN","DGENA6",36,0)
 D  ;drops out of block when status is determined
"RTN","DGENA6",37,0)
 .I $G(REASON) D  Q
"RTN","DGENA6",38,0)
 ..S DGENR("STATUS")=7,DGENR("REMARKS")=$G(REMARKS),DGENR("REASON")=REASON ;CANCELED/DECLINED
"RTN","DGENA6",39,0)
 .E  S DGENR("REMARKS")="",DGENR("REASON")=""
"RTN","DGENA6",40,0)
 .S DEATH=$$DEATH^DGENPTA(DFN)
"RTN","DGENA6",41,0)
 .I DEATH D  Q
"RTN","DGENA6",42,0)
 ..S DGENR("STATUS")=6 ;DECEASED
"RTN","DGENA6",43,0)
 ..S DGENR("END")=DEATH
"RTN","DGENA6",44,0)
 ..S EFFDATE=DEATH
"RTN","DGENA6",45,0)
 ..;Find patient's current enrollment record
"RTN","DGENA6",46,0)
 ..N DGENRIEN,DGENRC
"RTN","DGENA6",47,0)
 ..S DGENRIEN=$$FINDCUR^DGENA(DFN)
"RTN","DGENA6",48,0)
 ..S DGENRC=$$GET^DGENA(DGENRIEN,.DGENRC)
"RTN","DGENA6",49,0)
 ..S DGENR("DATE")=$S($G(DGENRC("DATE"))'="":DGENRC("DATE"),1:"")  ;enrollment date
"RTN","DGENA6",50,0)
 .I '$$VET^DGENPTA(DFN) D  Q  ;NOT ELIGIBLE
"RTN","DGENA6",51,0)
 ..N DGPAT,DGENRIEN,DGENRC
"RTN","DGENA6",52,0)
 ..S DGENR("STATUS")=20 ;new status for Ineligible Project
"RTN","DGENA6",53,0)
 ..;Find patient's current enrollment record
"RTN","DGENA6",54,0)
 ..S DGENRIEN=$$FINDCUR^DGENA(DFN)
"RTN","DGENA6",55,0)
 ..S DGENRC=$$GET^DGENA(DGENRIEN,.DGENRC)
"RTN","DGENA6",56,0)
 ..S DGENR("DATE")=$S($G(DGENRC("DATE"))'="":DGENRC("DATE"),1:"")  ;enrollment date
"RTN","DGENA6",57,0)
 ..;Phase II The TESTVAL was moved from DGENA1 to DGENA3 (SRS 6.5.2.1)
"RTN","DGENA6",58,0)
 ..;if vet has an Ineligible Date then the Effective Date should be the later of the Ineligible Date or App Date
"RTN","DGENA6",59,0)
 ..I $$GET^DGENPTA(DFN,.DGENPTA),DGENPTA("INELDATE"),$$TESTVAL^DGENA3("EFFDATE",DGENPTA("INELDATE")),DGENRC=1 S EFFDATE=$G(DGENPTA("INELDATE"))
"RTN","DGENA6",60,0)
 ..I '$G(EFFDATE) S EFFDATE=$G(APP)
"RTN","DGENA6",61,0)
 ..;If currently enrolled, set end date = ineligible date
"RTN","DGENA6",62,0)
 ..I DGENRC=1 S DGENR("END")=$G(DGENPTA("INELDATE"))
"RTN","DGENA6",63,0)
 ..;If not currently enrolled or no ineligible date, set end date = application date
"RTN","DGENA6",64,0)
 ..I '$G(DGENR("END")) S DGENR("END")=$G(APP)
"RTN","DGENA6",65,0)
 .;Determine preliminary enrollment status based on enrollment group threshold
"RTN","DGENA6",66,0)
 .;Get enrollment group threshold
"RTN","DGENA6",67,0)
 .N DGEGTIEN,DGEGT,DGENRC,DGENRIEN
"RTN","DGENA6",68,0)
 .S DGEGTIEN=$$FINDCUR^DGENEGT
"RTN","DGENA6",69,0)
 .S DGEGT=$$GET^DGENEGT(DGEGTIEN,.DGEGT)
"RTN","DGENA6",70,0)
 .;If patient's enrollment status not above enrollment group threshold 
"RTN","DGENA6",71,0)
 .;set status to Rejected:  Initial Application by VAMC)
"RTN","DGENA6",72,0)
 .I $G(PRIORITY)'="",'$$ABOVE2^DGENEGT1(DFN,$G(APP),PRIORITY,$P(PRIGRP,U,2)) D  Q
"RTN","DGENA6",73,0)
 ..;Find patient's current enrollment record
"RTN","DGENA6",74,0)
 ..S DGENRIEN=$$FINDCUR^DGENA(DFN)
"RTN","DGENA6",75,0)
 ..S DGENRC=$$GET^DGENA(DGENRIEN,.DGENRC)
"RTN","DGENA6",76,0)
 ..S DGENR("DATE")=$S($G(DGENRC("DATE"))'="":DGENRC("DATE"),1:"")  ;enrollment date
"RTN","DGENA6",77,0)
 ..S DGENR("END")=$G(APP)  ;enrollment end date = application date
"RTN","DGENA6",78,0)
 ..S EFFDATE=$G(APP)  ; effective date = application date
"RTN","DGENA6",79,0)
 ..S DGENR("STATUS")=14  ;Rejected: Initial Application by VAMC
"RTN","DGENA6",80,0)
 .S DGENR("STATUS")=1 Q  ;UNVERIFIED
"RTN","DGENA6",81,0)
 S DGENR("FACREC")=$$INST^DGENU()
"RTN","DGENA6",82,0)
 S DGENR("PRIORITY")=PRIORITY
"RTN","DGENA6",83,0)
 ;Phase II add subgroup (SRS 6.4)
"RTN","DGENA6",84,0)
 S DGENR("SUBGRP")=$P(PRIGRP,"^",2)
"RTN","DGENA6",85,0)
 S DGENR("EFFDATE")=$S($G(EFFDATE):EFFDATE,$G(ENRDATE):$G(ENRDATE),1:$G(APP))
"RTN","DGENA6",86,0)
 S DGENR("USER")=$G(DUZ)
"RTN","DGENA6",87,0)
 S DGENR("DATETIME")=$$NOW^XLFDT
"RTN","DGENA6",88,0)
 S DGENR("PRIORREC")=""
"RTN","DGENA6",89,0)
 M DGENR("ELIG")=DGELGSUB
"RTN","DGENA6",90,0)
 ;
"RTN","DGENA6",91,0)
 Q 1
"RTN","DGENEGT1")
0^7^B23812740
"RTN","DGENEGT1",1,0)
DGENEGT1 ;ALB/KCL,ISA/KWP,LBD - Enrollment Group Threshold API's ; 04/24/03 1:30pm
"RTN","DGENEGT1",2,0)
 ;;5.3;Registration;**232,417,454,491,513**;Aug 13, 1993
"RTN","DGENEGT1",3,0)
 ;
"RTN","DGENEGT1",4,0)
 ;
"RTN","DGENEGT1",5,0)
NOTIFY(DGEGT,OLDEGT) ;
"RTN","DGENEGT1",6,0)
 ; Description: This is used to send a message to local mail group.
"RTN","DGENEGT1",7,0)
 ; The notification is used to communicate changes in the Enrollment
"RTN","DGENEGT1",8,0)
 ; Group Threshold (EGT) setting to users at the local site.
"RTN","DGENEGT1",9,0)
 ;
"RTN","DGENEGT1",10,0)
 ;  Input:
"RTN","DGENEGT1",11,0)
 ;    DGEGT - the new Enrollment Group Threshold array, passed by reference
"RTN","DGENEGT1",12,0)
 ;   OLDEGT - the previous Enrollment Group Threshold array, passed by reference
"RTN","DGENEGT1",13,0)
 ;
"RTN","DGENEGT1",14,0)
 ; Output: None
"RTN","DGENEGT1",15,0)
 ;
"RTN","DGENEGT1",16,0)
 N TEXT,XMDUN,XMDUZ,XMTEXT,XMROU,XMSTRIP,XMSUB,XMY,XMZ,OLDPRI
"RTN","DGENEGT1",17,0)
 ;
"RTN","DGENEGT1",18,0)
 ; init subject and sender
"RTN","DGENEGT1",19,0)
 S XMSUB="Enrollment Group Threshold (EGT) Changed"
"RTN","DGENEGT1",20,0)
 S (XMDUN,XMDUZ)="Registration Enrollment Module"
"RTN","DGENEGT1",21,0)
 ;
"RTN","DGENEGT1",22,0)
 ; recipient
"RTN","DGENEGT1",23,0)
 S XMY("G.DGEN EGT UPDATES")=""
"RTN","DGENEGT1",24,0)
 ;
"RTN","DGENEGT1",25,0)
 ; get old EGT priority
"RTN","DGENEGT1",26,0)
 S OLDPRI=$G(OLDEGT("PRIORITY"))
"RTN","DGENEGT1",27,0)
 ;
"RTN","DGENEGT1",28,0)
 S XMTEXT="TEXT("
"RTN","DGENEGT1",29,0)
 S TEXT(1)="The Secretary of the VA has officially changed the enrollment priority"
"RTN","DGENEGT1",30,0)
 S TEXT(2)="grouping of veterans who shall receive care.  This change may place"
"RTN","DGENEGT1",31,0)
 S TEXT(3)="veterans under your facilities care into a 'Not Enrolled' category."
"RTN","DGENEGT1",32,0)
 S TEXT(4)=""
"RTN","DGENEGT1",33,0)
 S TEXT(5)=""
"RTN","DGENEGT1",34,0)
 S TEXT(6)="           Prior EGT Priority:  "_$S($G(OLDPRI):$$EXTERNAL^DILFD(27.16,.02,"F",OLDPRI),1:"N/A")_$S($G(OLDEGT("SUBGRP")):$$EXTERNAL^DILFD(27.16,.03,"F",OLDEGT("SUBGRP")),1:"")
"RTN","DGENEGT1",35,0)
 S TEXT(7)=""
"RTN","DGENEGT1",36,0)
 S TEXT(8)=""
"RTN","DGENEGT1",37,0)
 S TEXT(9)="  New Enrollment Group Threshold (EGT) Settings:"
"RTN","DGENEGT1",38,0)
 S TEXT(10)=""
"RTN","DGENEGT1",39,0)
 S TEXT(11)="                 EGT Priority:  "_$$EXTERNAL^DILFD(27.16,.02,"F",DGEGT("PRIORITY"))_$S($G(DGEGT("SUBGRP")):$$EXTERNAL^DILFD(27.16,.03,"F",DGEGT("SUBGRP")),1:"")
"RTN","DGENEGT1",40,0)
 S TEXT(12)="                     EGT Type:  "_$$EXTERNAL^DILFD(27.16,.04,"F",DGEGT("TYPE"))
"RTN","DGENEGT1",41,0)
 S TEXT(13)="           EGT Effective Date:  "_$$EXTERNAL^DILFD(27.16,.01,"F",DGEGT("EFFDATE"))
"RTN","DGENEGT1",42,0)
 ;
"RTN","DGENEGT1",43,0)
 ; mailman deliverey
"RTN","DGENEGT1",44,0)
 D ^XMD
"RTN","DGENEGT1",45,0)
 ;
"RTN","DGENEGT1",46,0)
 Q
"RTN","DGENEGT1",47,0)
 ;
"RTN","DGENEGT1",48,0)
 ;
"RTN","DGENEGT1",49,0)
DISPLAY() ;
"RTN","DGENEGT1",50,0)
 ; Description: Display Enrollment Group Threshold (EGT) settings.
"RTN","DGENEGT1",51,0)
 ;
"RTN","DGENEGT1",52,0)
 ;  Input: None
"RTN","DGENEGT1",53,0)
 ;
"RTN","DGENEGT1",54,0)
 ; Output: None
"RTN","DGENEGT1",55,0)
 ;
"RTN","DGENEGT1",56,0)
 N DGEGT
"RTN","DGENEGT1",57,0)
 ;
"RTN","DGENEGT1",58,0)
 W !
"RTN","DGENEGT1",59,0)
 I '$$GET^DGENEGT($$FINDCUR^DGENEGT(),.DGEGT) W !,"Enrollment Group Threshold (EGT) settings not found."
"RTN","DGENEGT1",60,0)
 E  D
"RTN","DGENEGT1",61,0)
 .W !,?3,"Enrollment Group Threshold (EGT) Settings"
"RTN","DGENEGT1",62,0)
 .W !,?3,"========================================="
"RTN","DGENEGT1",63,0)
 .W !
"RTN","DGENEGT1",64,0)
 .W !?5,"Date Entered",?25,": ",$S('$G(DGEGT("ENTERED")):"-none-",1:$$EXTERNAL^DILFD(27.16,.01,"F",DGEGT("ENTERED")))
"RTN","DGENEGT1",65,0)
 .W !?5,"EGT Priority",?25,": ",$S('$G(DGEGT("PRIORITY")):"-none-",1:$$EXTERNAL^DILFD(27.16,.02,"F",DGEGT("PRIORITY")))_$S($G(DGEGT("SUBGRP"))="":"",1:$$EXTERNAL^DILFD(27.16,.03,"F",DGEGT("SUBGRP")))
"RTN","DGENEGT1",66,0)
 .W !?5,"EGT Type",?25,": ",$S($G(DGEGT("TYPE"))="":"-none-",1:$$EXTERNAL^DILFD(27.16,.04,"F",DGEGT("TYPE")))
"RTN","DGENEGT1",67,0)
 .W !?5,"EGT Effective Date",?25,": ",$S('$G(DGEGT("EFFDATE")):"-none-",1:$$EXTERNAL^DILFD(27.16,.05,"F",DGEGT("EFFDATE")))
"RTN","DGENEGT1",68,0)
 ;
"RTN","DGENEGT1",69,0)
 Q
"RTN","DGENEGT1",70,0)
 ;
"RTN","DGENEGT1",71,0)
ABOVE(DPTDFN,ENRPRI,ENRGRP,EGTPRI,EGTGRP,EGTFLG) ;
"RTN","DGENEGT1",72,0)
 ; Description: This function will determine if the enrollment is above
"RTN","DGENEGT1",73,0)
 ; the threshold.
"RTN","DGENEGT1",74,0)
 ;
"RTN","DGENEGT1",75,0)
 ;Input:
"RTN","DGENEGT1",76,0)
 ; DPTDFN - Patient File IEN
"RTN","DGENEGT1",77,0)
 ; ENRPRI - Enrollment Priority
"RTN","DGENEGT1",78,0)
 ; ENRGRP - Enrollment Sub-Group
"RTN","DGENEGT1",79,0)
 ; EGTPRI - EGT Priority (optional) - not used
"RTN","DGENEGT1",80,0)
 ; EGTGRP - EGT Sub-Group (optional) - not used
"RTN","DGENEGT1",81,0)
 ; EGTFLG - Flag to bypass additional EGT type 2 check (optional)
"RTN","DGENEGT1",82,0)
 ;          It is used by $$ABOVE2 to prevent re-entering the
"RTN","DGENEGT1",83,0)
 ;          sub-priority API ($$SUBPRI^DGENELA4)
"RTN","DGENEGT1",84,0)
 ; Output:
"RTN","DGENEGT1",85,0)
 ; Returns 1 if above 0 below. 
"RTN","DGENEGT1",86,0)
 ;
"RTN","DGENEGT1",87,0)
 I $G(ENRGRP)="" S ENRGRP=""
"RTN","DGENEGT1",88,0)
 I $G(ENRPRI)="" S ENRPRI=""
"RTN","DGENEGT1",89,0)
 N ABOVE,EGT,TODAY,X
"RTN","DGENEGT1",90,0)
 I '$$GET^DGENEGT($$FINDCUR^DGENEGT(),.EGT) Q 1
"RTN","DGENEGT1",91,0)
 D NOW^%DTC S TODAY=X
"RTN","DGENEGT1",92,0)
 I TODAY<EGT("EFFDATE") Q 1
"RTN","DGENEGT1",93,0)
 ;
"RTN","DGENEGT1",94,0)
 ;EGT type 2 - Stop New Enrollments
"RTN","DGENEGT1",95,0)
 ; or EGT type 4 - Enrollment Decision (ESP DG*5.3*491)
"RTN","DGENEGT1",96,0)
 I EGT("TYPE")=2!(EGT("TYPE")=4) D  Q ABOVE
"RTN","DGENEGT1",97,0)
 .S ABOVE=0
"RTN","DGENEGT1",98,0)
 .;do check for priorities 7 and 8
"RTN","DGENEGT1",99,0)
 .I ENRPRI>6&(ENRPRI=EGT("PRIORITY")) D  Q
"RTN","DGENEGT1",100,0)
 ..I ENRGRP'>EGT("SUBGRP") S ABOVE=1
"RTN","DGENEGT1",101,0)
 ..Q:$G(EGTFLG)
"RTN","DGENEGT1",102,0)
 ..I EGT("TYPE")=4,ENRPRI=EGT("PRIORITY"),ENRGRP'=$$SUBPRI^DGENELA4(DPTDFN,ENRPRI,ENRGRP) S ABOVE=0 Q
"RTN","DGENEGT1",103,0)
 ..I ENRGRP=EGT("SUBGRP"),ENRGRP'=$$SUBPRI^DGENELA4(DPTDFN,ENRPRI,ENRGRP) S ABOVE=0
"RTN","DGENEGT1",104,0)
 .I ENRPRI'>EGT("PRIORITY") S ABOVE=1 Q
"RTN","DGENEGT1",105,0)
 ;
"RTN","DGENEGT1",106,0)
 ;EGT types 1 & 3
"RTN","DGENEGT1",107,0)
 ;do check for priorities 7 and 8
"RTN","DGENEGT1",108,0)
 I ENRPRI>6&(ENRPRI=EGT("PRIORITY")) S ABOVE=0 D  Q ABOVE
"RTN","DGENEGT1",109,0)
 .I ENRGRP'>(EGT("SUBGRP")) S ABOVE=1
"RTN","DGENEGT1",110,0)
 I ENRPRI'>(EGT("PRIORITY")) Q 1
"RTN","DGENEGT1",111,0)
 Q 0
"RTN","DGENEGT1",112,0)
 ;
"RTN","DGENEGT1",113,0)
ABOVE2(DPTDFN,ENRDT,PRIORITY,SUBGRP) ;
"RTN","DGENEGT1",114,0)
 ;
"RTN","DGENEGT1",115,0)
 ; Input: DPTDFN    - Patient File IEN
"RTN","DGENEGT1",116,0)
 ;        ENRDT     - enrollment effective date
"RTN","DGENEGT1",117,0)
 ;        PRIORITY  - enrollment priority
"RTN","DGENEGT1",118,0)
 ;        SUBGRP    - enrollment sub-priority (internal numeric value)
"RTN","DGENEGT1",119,0)
 ;
"RTN","DGENEGT1",120,0)
 ; Output: 1 or 0 for above or below EGT threshold
"RTN","DGENEGT1",121,0)
 ;
"RTN","DGENEGT1",122,0)
 N ABOVE,TODAY,X,EGT
"RTN","DGENEGT1",123,0)
 S ABOVE=1
"RTN","DGENEGT1",124,0)
 S:'$G(SUBGRP) SUBGRP=""
"RTN","DGENEGT1",125,0)
 S:'$G(PRIORITY) PRIORITY=""
"RTN","DGENEGT1",126,0)
 S:'$G(ENRDT) ENRDT=""
"RTN","DGENEGT1",127,0)
 D NOW^%DTC S TODAY=X
"RTN","DGENEGT1",128,0)
 Q:'$$GET^DGENEGT($$FINDCUR^DGENEGT(),.EGT) 1
"RTN","DGENEGT1",129,0)
 Q:'$G(EGT("EFFDATE")) 1
"RTN","DGENEGT1",130,0)
 Q:TODAY<EGT("EFFDATE") 1
"RTN","DGENEGT1",131,0)
 Q:EGT("TYPE")#2 $$ABOVE(DPTDFN,PRIORITY,SUBGRP,"","",1)  ;If EGT type 1 or 3
"RTN","DGENEGT1",132,0)
 I '$$ABOVE(DPTDFN,PRIORITY,SUBGRP,"","",1) Q 0
"RTN","DGENEGT1",133,0)
 I PRIORITY=EGT("PRIORITY"),ENRDT,ENRDT'<EGT("EFFDATE") D
"RTN","DGENEGT1",134,0)
 .I EGT("TYPE")=4 S ABOVE=0 Q
"RTN","DGENEGT1",135,0)
 .I SUBGRP=EGT("SUBGRP") S ABOVE=0
"RTN","DGENEGT1",136,0)
 Q ABOVE
"RTN","DGENRPT1")
0^2^B20019601
"RTN","DGENRPT1",1,0)
DGENRPT1 ;ALB/DW,LBD - EGT Preliminary Summary Impact Report ; 04/24/03 2:32pm ; 07/22/02 9:40am
"RTN","DGENRPT1",2,0)
 ;;5.3;Registration;**232,306,417,456,491,513**;Aug 13,1993
"RTN","DGENRPT1",3,0)
 ;
"RTN","DGENRPT1",4,0)
 ;
"RTN","DGENRPT1",5,0)
ENPT ;Preliminary Summary Report selected.
"RTN","DGENRPT1",6,0)
 K ^TMP($J,"SS1"),^TMP($J,"RT1")
"RTN","DGENRPT1",7,0)
 I $$FINDCUR^DGENEGT()=0 W !,"No EGT setting on file." Q
"RTN","DGENRPT1",8,0)
 D PRINT
"RTN","DGENRPT1",9,0)
 Q
"RTN","DGENRPT1",10,0)
 ;
"RTN","DGENRPT1",11,0)
GETEGTS ;First get the current EGT parameters from file #27.16.
"RTN","DGENRPT1",12,0)
 N GETEGTS,REC,TP S (GETEGTS,REC,TP)=""
"RTN","DGENRPT1",13,0)
 S REC=$$FINDCUR^DGENEGT() I REC=0 Q
"RTN","DGENRPT1",14,0)
 S TP=$$GET^DGENEGT(REC,.GETEGTS)
"RTN","DGENRPT1",15,0)
 ;Get EGT Prioity.
"RTN","DGENRPT1",16,0)
 S EGT=GETEGTS("PRIORITY")
"RTN","DGENRPT1",17,0)
 S EGTSUB=GETEGTS("SUBGRP")
"RTN","DGENRPT1",18,0)
 ;Get EGT Effective Date.
"RTN","DGENRPT1",19,0)
 S EGTEDT=GETEGTS("EFFDATE") I EGTEDT S EGTEDT=$$FMTE^XLFDT(EGTEDT)
"RTN","DGENRPT1",20,0)
 ;Get last EGT setting Date/Time.
"RTN","DGENRPT1",21,0)
 S EGTLDT=GETEGTS("ENTDATE") I EGTLDT S EGTLDT=$$FMTE^XLFDT(EGTLDT)
"RTN","DGENRPT1",22,0)
 ;Get EGT Type.
"RTN","DGENRPT1",23,0)
 S EGTTP=GETEGTS("TYPE")
"RTN","DGENRPT1",24,0)
 S EGTTP=$$EXTERNAL^DILFD(27.16,.04,"F",EGTTP) S:EGTTP="" EGTTP="UNSPECIFIED"
"RTN","DGENRPT1",25,0)
 Q
"RTN","DGENRPT1",26,0)
 ;
"RTN","DGENRPT1",27,0)
PRESRT1 ;Sort for patient's current record and get the potentially affected.
"RTN","DGENRPT1",28,0)
 N IND,PRT,DFN,INPT,PSSN,TMP,ABV,PRTSUB
"RTN","DGENRPT1",29,0)
 S (IND,PRT,DFN,PSSN,TMP,ABV,PRTSUB)="",INPT="OUT"
"RTN","DGENRPT1",30,0)
 K ^TMP($J,"SS1"),^TMP($J,"RT1")
"RTN","DGENRPT1",31,0)
 F  S DFN=$O(^DGEN(27.11,"C",DFN)) Q:DFN=""  D
"RTN","DGENRPT1",32,0)
 . S IND=$$FINDCUR^DGENA(DFN)
"RTN","DGENRPT1",33,0)
 . I IND D EGTP I ABV=0 D
"RTN","DGENRPT1",34,0)
 .. K VAIP(2) S INPT="OUT" D IN5^VADPT S TMP=$P($G(VAIP(2)),U) I TMP=1!(TMP=2)!(TMP=6) S INPT="IN"
"RTN","DGENRPT1",35,0)
 .. K VADM(2) D DEM^VADPT S PSSN=$P($G(VADM(2)),U)
"RTN","DGENRPT1",36,0)
 .. S ^TMP($J,"RT1",PRT,PSSN)=PRT_"^"_INPT
"RTN","DGENRPT1",37,0)
 ;
"RTN","DGENRPT1",38,0)
PRESRT2 ;Sort the sorted.
"RTN","DGENRPT1",39,0)
 N CNT,ICNT,OCNT,J,K
"RTN","DGENRPT1",40,0)
 S (J,K)=""
"RTN","DGENRPT1",41,0)
 F  S J=$O(^TMP($J,"RT1",J)) Q:J=""  D
"RTN","DGENRPT1",42,0)
 . S (CNT,ICNT,OCNT)=0
"RTN","DGENRPT1",43,0)
 . F  S K=$O(^TMP($J,"RT1",J,K)) Q:K=""  D
"RTN","DGENRPT1",44,0)
   .. S INPT=$P($G(^TMP($J,"RT1",J,K)),U,2)
"RTN","DGENRPT1",45,0)
   .. S CNT=CNT+1 S:INPT="IN" ICNT=ICNT+1 S:INPT="OUT" OCNT=OCNT+1
"RTN","DGENRPT1",46,0)
   .. S ^TMP($J,"SS1",J)=CNT_"^"_ICNT_"^"_OCNT
"RTN","DGENRPT1",47,0)
 K ^TMP($J,"RT1")
"RTN","DGENRPT1",48,0)
 Q
"RTN","DGENRPT1",49,0)
 ;
"RTN","DGENRPT1",50,0)
EGTP ;Decide if the patient is above EGT.
"RTN","DGENRPT1",51,0)
 S (PRT,PRTSUB,ABV,ENRDT)=""
"RTN","DGENRPT1",52,0)
 S PRT=$P($G(^DGEN(27.11,IND,0)),U,7)
"RTN","DGENRPT1",53,0)
 S:((PRT=7)!(PRT=8)) PRTSUB=$P($G(^DGEN(27.11,IND,0)),U,12)
"RTN","DGENRPT1",54,0)
 S ENRDT=$P($G(^DGEN(27.11,IND,0)),U,10)
"RTN","DGENRPT1",55,0)
 S:'ENRDT ENRDT=$P($G(^DGEN(27.11,IND,0)),U)
"RTN","DGENRPT1",56,0)
 S ABV=$$ABOVE^DGENEGT1(DFN,PRT,PRTSUB)
"RTN","DGENRPT1",57,0)
 I PRT=7!(PRT=8) D
"RTN","DGENRPT1",58,0)
 . S PRTSUB=$$EXTERNAL^DILFD(27.11,.12,"F",PRTSUB)
"RTN","DGENRPT1",59,0)
 . S:PRTSUB="" PRTSUB="ER"
"RTN","DGENRPT1",60,0)
 S PRT=PRT_PRTSUB
"RTN","DGENRPT1",61,0)
 Q
"RTN","DGENRPT1",62,0)
 ;
"RTN","DGENRPT1",63,0)
PRINT ;Print the report.
"RTN","DGENRPT1",64,0)
 N POP,IO,IOBS,IOF,IOHG,IOM,ION,IOPAR,IOS,IOSL,IOST,IOT,IOUPAR,IOXY,ZTSAVE,TSK,%ZIS,ZTRTN,ZTDESC
"RTN","DGENRPT1",65,0)
 S %ZIS="QM" D ^%ZIS G EXIT:POP
"RTN","DGENRPT1",66,0)
 I $D(IO("Q")) D  G EXIT
"RTN","DGENRPT1",67,0)
 . S ZTRTN="WRITER^DGENRPT1",ZTDESC="DG EGT Preliminary Summary Report."
"RTN","DGENRPT1",68,0)
 . D ^%ZTLOAD
"RTN","DGENRPT1",69,0)
 . S TSK=$S($D(ZTSK)=0:"C",1:"Y")
"RTN","DGENRPT1",70,0)
 . I TSK="Y" W !!,"Report queued! Task number: ",ZTSK
"RTN","DGENRPT1",71,0)
 . D HOME^%ZIS
"RTN","DGENRPT1",72,0)
 ;
"RTN","DGENRPT1",73,0)
WRITER ;Write out the report.
"RTN","DGENRPT1",74,0)
 U IO
"RTN","DGENRPT1",75,0)
 I $E(IOST,1,2)="C-" W @IOF
"RTN","DGENRPT1",76,0)
 N EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,ENRDT
"RTN","DGENRPT1",77,0)
 S (EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP)=""
"RTN","DGENRPT1",78,0)
 D GETEGTS
"RTN","DGENRPT1",79,0)
 D PRESRT1
"RTN","DGENRPT1",80,0)
 D PSHEAD
"RTN","DGENRPT1",81,0)
 D DATA
"RTN","DGENRPT1",82,0)
 D ^%ZISC
"RTN","DGENRPT1",83,0)
EXIT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","DGENRPT1",84,0)
 D KVA^VADPT
"RTN","DGENRPT1",85,0)
 K ^TMP($J,"SS1")
"RTN","DGENRPT1",86,0)
 Q
"RTN","DGENRPT1",87,0)
 ;
"RTN","DGENRPT1",88,0)
PSHEAD ;Header for the Preliminary Detailed Report.
"RTN","DGENRPT1",89,0)
 ;Get the date/time the report is run.
"RTN","DGENRPT1",90,0)
 N RDT,Y S (RDT,Y)=""
"RTN","DGENRPT1",91,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","DGENRPT1",92,0)
 S RDT=$P(Y,"@",1)_" @ "_$P($P(Y,"@",2),":",1,2)
"RTN","DGENRPT1",93,0)
 S EGTSUB=$$EXTERNAL^DILFD(27.16,.03,"F",EGTSUB)
"RTN","DGENRPT1",94,0)
 I ((EGT=7)!(EGT=8)),EGTSUB="" S EGTSUB="ER"
"RTN","DGENRPT1",95,0)
 ;Write the header.
"RTN","DGENRPT1",96,0)
 W !,?((IOM-38)\2),"EGT Preliminary Summary Impact Report"
"RTN","DGENRPT1",97,0)
 W !,?((IOM-22-$L(RDT))\2),"Date/Time Report Run: ",RDT
"RTN","DGENRPT1",98,0)
 W !,?((IOM-45-$L(EGT_EGTSUB_EGTTP_EGTEDT))\2),"EGT Setting: ",EGT_EGTSUB," EGT Type: ",EGTTP," EGT Effective Date: ",EGTEDT
"RTN","DGENRPT1",99,0)
 W !,?((IOM-28-$L(EGTLDT))\2),"Date/Time Last EGT Setting: ",EGTLDT
"RTN","DGENRPT1",100,0)
 W !!,"IMPORTANT NOTE:",!,"Preliminary report is based on a comparison of the EGT setting to the veterans current enrollment priority as shown in VISTA."
"RTN","DGENRPT1",101,0)
 W !!,"ENROLLMENT PRIORITY",?23,"TOTAL (UNIQUE SSN)",?43,"# INPATIENT",?57,"# OUTPATIENT",!
"RTN","DGENRPT1",102,0)
 Q
"RTN","DGENRPT1",103,0)
 ;
"RTN","DGENRPT1",104,0)
DATA ;Get all the data for the report.
"RTN","DGENRPT1",105,0)
 N T,EP,TLT,INPT,OPT,COUNT S (T,EP,TLT,INPT,OPT)="",COUNT=0
"RTN","DGENRPT1",106,0)
 F  S T=$O(^TMP($J,"SS1",T)) Q:T=""  D
"RTN","DGENRPT1",107,0)
 . S EP=T,TLT=$P($G(^TMP($J,"SS1",T)),U),INPT=$P($G(^TMP($J,"SS1",T)),U,2),OPT=$P($G(^TMP($J,"SS1",T)),U,3)
"RTN","DGENRPT1",108,0)
 . S COUNT=COUNT+TLT
"RTN","DGENRPT1",109,0)
 . W !,EP,?25,TLT,?45,INPT,?59,OPT
"RTN","DGENRPT1",110,0)
 W !,"TOTAL PATIENTS (UNIQUE SSNS) FOR THIS FACILITY:     ",COUNT
"RTN","DGENRPT1",111,0)
 Q
"RTN","DGENRPT2")
0^3^B40344748
"RTN","DGENRPT2",1,0)
DGENRPT2 ;ALB/DW,LBD - EGT Preliminary Detailed Impact Report ; 04/24/03 10:21am ; 07/22/02 9:40am
"RTN","DGENRPT2",2,0)
 ;;5.3;Registration;**232,306,417,456,491,513**;Aug 13,1993
"RTN","DGENRPT2",3,0)
 ;
"RTN","DGENRPT2",4,0)
 ;
"RTN","DGENRPT2",5,0)
ENPT ;Preliminary Detailed Report selected.
"RTN","DGENRPT2",6,0)
 K ^TMP($J,"BY2"),^TMP($J,"CNT2")
"RTN","DGENRPT2",7,0)
 I $$FINDCUR^DGENEGT()=0 W !,"No EGT setting on file." Q
"RTN","DGENRPT2",8,0)
 N INFAP S INFAP=""
"RTN","DGENRPT2",9,0)
 D INFAP I INFAP="^"!($D(DTOUT)) Q
"RTN","DGENRPT2",10,0)
 N EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,L,BY,DIC,FLDS,DHD,DIOEND,X,DFN,PSSN,FCTY,TOTAL,DIOBEG,VASD,VAERR,ENRDT
"RTN","DGENRPT2",11,0)
 S (EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,FCTY)="",TOTAL=0
"RTN","DGENRPT2",12,0)
 W !!,"*** This report requires a 132 column printer. ***",!!
"RTN","DGENRPT2",13,0)
 S DIC="^DGEN(27.11,"
"RTN","DGENRPT2",14,0)
 S BY(0)="^TMP($J,""BY2""",L(0)=3,L=0
"RTN","DGENRPT2",15,0)
 S DIOBEG="D PRESORT^DGENRPT2"
"RTN","DGENRPT2",16,0)
 S FLDS="D PT^DGENRPT2 W X;C0;L20,W PSSN;C22;L10,D EP^DGENRPT2 W X;C33;L2,D ENRED^DGENRPT2 W X;C37;L10,D ENRST^DGENRPT2 W X;C49;L12"
"RTN","DGENRPT2",17,0)
 I INFAP=1 D
"RTN","DGENRPT2",18,0)
 . S FLDS(2)="D WRD^DGENRPT2 W X;C63;L15;""WARD"",D FAP1^DGENRPT2 W X;C80;L31,D PCPVD^DGENRPT2 W X;C110;L10,D PFCLTY^DGENRPT2 W X;C121;L11"
"RTN","DGENRPT2",19,0)
 . S DHD="W ?0 D DETHD1^DGENRPT2"
"RTN","DGENRPT2",20,0)
 I INFAP=0 D
"RTN","DGENRPT2",21,0)
 . S FLDS(2)="D WRD^DGENRPT2 W X;C63;L15;""WARD"",D FAP0^DGENRPT2 W X;C80;L31,D PCPVD^DGENRPT2 W X;C88;L10,D PFCLTY^DGENRPT2 W X;C100;L12"
"RTN","DGENRPT2",22,0)
 . S DHD="W ?0 D DETHD0^DGENRPT2"
"RTN","DGENRPT2",23,0)
 S DIOEND="D END^DGENRPT2"
"RTN","DGENRPT2",24,0)
 D EN1^DIP
"RTN","DGENRPT2",25,0)
 D EXIT
"RTN","DGENRPT2",26,0)
 Q
"RTN","DGENRPT2",27,0)
 ;
"RTN","DGENRPT2",28,0)
INFAP ;Ask the user if Future Appointments is wanted on the report.
"RTN","DGENRPT2",29,0)
 N DIR,X,Y
"RTN","DGENRPT2",30,0)
 S DIR(0)="Y^1:3"
"RTN","DGENRPT2",31,0)
 S DIR("A")="Do you want to include Future Appointments"
"RTN","DGENRPT2",32,0)
 D ^DIR S INFAP=Y
"RTN","DGENRPT2",33,0)
 I ($D(DTOUT)) W *7
"RTN","DGENRPT2",34,0)
 Q
"RTN","DGENRPT2",35,0)
 ;
"RTN","DGENRPT2",36,0)
PRESORT ;First get the current EGT Setting from file #27.16.
"RTN","DGENRPT2",37,0)
 N GETEGTS,REC,TP S (GETEGTS,REC,TP)=""
"RTN","DGENRPT2",38,0)
 S REC=$$FINDCUR^DGENEGT()
"RTN","DGENRPT2",39,0)
 I REC=0 Q
"RTN","DGENRPT2",40,0)
 S TP=$$GET^DGENEGT(REC,.GETEGTS)
"RTN","DGENRPT2",41,0)
 ;Get EGT Priority.
"RTN","DGENRPT2",42,0)
 S EGT=GETEGTS("PRIORITY")
"RTN","DGENRPT2",43,0)
 S EGTSUB=GETEGTS("SUBGRP")
"RTN","DGENRPT2",44,0)
 ;Get EGT Effective Date.
"RTN","DGENRPT2",45,0)
 S EGTEDT=GETEGTS("EFFDATE") I EGTEDT S EGTEDT=$$FMTE^XLFDT(EGTEDT)
"RTN","DGENRPT2",46,0)
 ;Get last EGT setting Date/Time.
"RTN","DGENRPT2",47,0)
 S EGTLDT=GETEGTS("ENTDATE") I EGTLDT S EGTLDT=$$FMTE^XLFDT(EGTLDT)
"RTN","DGENRPT2",48,0)
 ;Get EGT Type.
"RTN","DGENRPT2",49,0)
 S EGTTP=GETEGTS("TYPE")
"RTN","DGENRPT2",50,0)
 S EGTTP=$$EXTERNAL^DILFD(27.16,.04,"F",EGTTP) S:EGTTP="" EGTTP="UNSPECIFIED"
"RTN","DGENRPT2",51,0)
 ;Sort for patient's current record and get the potentially affected.
"RTN","DGENRPT2",52,0)
 N IND,PRT,DFN,NM,PSSN,PRTSUB,ABV
"RTN","DGENRPT2",53,0)
 S (IND,PRT,DFN,NM,PSSN,PRTSUB,ABV)=""
"RTN","DGENRPT2",54,0)
 K ^TMP($J,"BY2"),^TMP($J,"CNT2")
"RTN","DGENRPT2",55,0)
 F  S DFN=$O(^DGEN(27.11,"C",DFN)) Q:DFN=""  D
"RTN","DGENRPT2",56,0)
 . S IND=$$FINDCUR^DGENA(DFN)
"RTN","DGENRPT2",57,0)
 . I IND D EGTP I ABV=0 D
"RTN","DGENRPT2",58,0)
 .. K VADM(1),VADM(2) D DEM^VADPT S NM=VADM(1) D BYSRT
"RTN","DGENRPT2",59,0)
 .. S PSSN=$P($G(VADM(2)),U),^TMP($J,"CNT2",PRT,PSSN)=""
"RTN","DGENRPT2",60,0)
 I EGTSUB>4 S EGTSUB="ER" Q
"RTN","DGENRPT2",61,0)
 S EGTSUB=$$EXTERNAL^DILFD(27.16,.03,"F",EGTSUB)
"RTN","DGENRPT2",62,0)
 Q
"RTN","DGENRPT2",63,0)
 ;
"RTN","DGENRPT2",64,0)
EGTP ;Get patients EGT Priority.
"RTN","DGENRPT2",65,0)
 S (PRT,PRTSUB,ABV,ENRDT)=""
"RTN","DGENRPT2",66,0)
 S PRT=$P($G(^DGEN(27.11,IND,0)),U,7)
"RTN","DGENRPT2",67,0)
 S:((PRT=7)!(PRT=8)) PRTSUB=$P($G(^DGEN(27.11,IND,0)),U,12)
"RTN","DGENRPT2",68,0)
 S ENRDT=$P($G(^DGEN(27.11,IND,0)),U,10)
"RTN","DGENRPT2",69,0)
 S:'ENRDT ENRDT=$P($G(^DGEN(27.11,IND,0)),U)
"RTN","DGENRPT2",70,0)
 S ABV=$$ABOVE^DGENEGT1(DFN,PRT,PRTSUB)
"RTN","DGENRPT2",71,0)
 I PRT=7!(PRT=8) D
"RTN","DGENRPT2",72,0)
 . S PRTSUB=$$EXTERNAL^DILFD(27.11,.12,"F",PRTSUB)
"RTN","DGENRPT2",73,0)
 . S:PRTSUB="" PRTSUB="ER"
"RTN","DGENRPT2",74,0)
 S PRT=PRT_PRTSUB
"RTN","DGENRPT2",75,0)
 Q
"RTN","DGENRPT2",76,0)
 ;
"RTN","DGENRPT2",77,0)
BYSRT ;Sort patients by last name for "BY(0)".
"RTN","DGENRPT2",78,0)
 S ^TMP($J,"BY2",NM,DFN,IND)=""
"RTN","DGENRPT2",79,0)
 Q
"RTN","DGENRPT2",80,0)
 ;
"RTN","DGENRPT2",81,0)
PT ;Get the patient NAME and SSN
"RTN","DGENRPT2",82,0)
 S (X,DFN,PSSN)="" K VADM(1),VADM(2)
"RTN","DGENRPT2",83,0)
 S DFN=$P($G(^DGEN(27.11,D0,0)),U,2)
"RTN","DGENRPT2",84,0)
 I DFN D DEM^VADPT S X=$E(VADM(1),1,20),PSSN=$P(VADM(2),U)
"RTN","DGENRPT2",85,0)
 Q
"RTN","DGENRPT2",86,0)
 ;
"RTN","DGENRPT2",87,0)
EP ;Get the patient EGT Priority.
"RTN","DGENRPT2",88,0)
 S X=""
"RTN","DGENRPT2",89,0)
 N PRT,PRTSUB S (PRT,PRTSUB)=""
"RTN","DGENRPT2",90,0)
 S PRT=$P($G(^DGEN(27.11,D0,0)),U,7)
"RTN","DGENRPT2",91,0)
 I PRT=7!(PRT=8) D
"RTN","DGENRPT2",92,0)
 .S PRTSUB=$P($G(^DGEN(27.11,D0,0)),U,12)
"RTN","DGENRPT2",93,0)
 .S PRTSUB=$$EXTERNAL^DILFD(27.11,.12,"F",PRTSUB)
"RTN","DGENRPT2",94,0)
 .S:PRTSUB="" PRTSUB="ER"
"RTN","DGENRPT2",95,0)
 .S PRT=PRT_PRTSUB
"RTN","DGENRPT2",96,0)
 S X=PRT
"RTN","DGENRPT2",97,0)
 Q
"RTN","DGENRPT2",98,0)
 ;
"RTN","DGENRPT2",99,0)
ENRED ;Get the patient ENROLLMENT END DATE.
"RTN","DGENRPT2",100,0)
 S X=""
"RTN","DGENRPT2",101,0)
 S X=$P($G(^DGEN(27.11,D0,0)),U,11)
"RTN","DGENRPT2",102,0)
 I X="" S X="N/A" Q
"RTN","DGENRPT2",103,0)
 S X=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3))
"RTN","DGENRPT2",104,0)
 Q
"RTN","DGENRPT2",105,0)
 ;
"RTN","DGENRPT2",106,0)
ENRST ;Get the patient ENROLLMENT STATUS.
"RTN","DGENRPT2",107,0)
 S X=""
"RTN","DGENRPT2",108,0)
 S X=$P($G(^DGEN(27.11,D0,0)),U,4)
"RTN","DGENRPT2",109,0)
 S X=$P($G(^DGEN(27.15,X,0)),U,1),X=$E(X,1,12)
"RTN","DGENRPT2",110,0)
 Q
"RTN","DGENRPT2",111,0)
 ;
"RTN","DGENRPT2",112,0)
WRD ;Get the patient WARD.
"RTN","DGENRPT2",113,0)
 S X="" K VAIP(5)
"RTN","DGENRPT2",114,0)
 D IN5^VADPT S X=$P($G(VAIP(5)),U,2),X=$E(X,1,15)
"RTN","DGENRPT2",115,0)
 I X="" S X="N/A"
"RTN","DGENRPT2",116,0)
 Q
"RTN","DGENRPT2",117,0)
 ;
"RTN","DGENRPT2",118,0)
FAP1 ;Get the patient FUTURE APPOINTMENTS.
"RTN","DGENRPT2",119,0)
 N J,POP,ADT S (X,ADT)="",POP=0,J=0
"RTN","DGENRPT2",120,0)
 K ^UTILITY("VASD",$J)
"RTN","DGENRPT2",121,0)
 D CALSDA
"RTN","DGENRPT2",122,0)
 I VAERR=1 S X="N/A" Q
"RTN","DGENRPT2",123,0)
 F  S J=$O(^UTILITY("VASD",$J,J)) Q:J=""!POP  D
"RTN","DGENRPT2",124,0)
 . S X=$P($G(^UTILITY("VASD",$J,J,"E")),U,2),X=$E(X,1,20)
"RTN","DGENRPT2",125,0)
 . S ADT=$P($G(^UTILITY("VASD",$J,J,"I")),U),ADT=$P(ADT,".",1)
"RTN","DGENRPT2",126,0)
 . S ADT=$E(ADT,4,5)_"/"_$E(ADT,6,7)_"/"_(1700+$E(ADT,1,3))
"RTN","DGENRPT2",127,0)
 . S X=ADT_" "_X
"RTN","DGENRPT2",128,0)
 . I J=1 W X S X=""
"RTN","DGENRPT2",129,0)
 . I J>1&(J<6) W !,?79,X S X=""
"RTN","DGENRPT2",130,0)
 . I J=6 S X="" W !,?79,"More Appts" S POP=1 Q
"RTN","DGENRPT2",131,0)
 I $D(^UTILITY("VASD",$J))=0 S X="NONE"
"RTN","DGENRPT2",132,0)
 Q
"RTN","DGENRPT2",133,0)
 ;
"RTN","DGENRPT2",134,0)
FAP0 ;See if the patient has future appointment.
"RTN","DGENRPT2",135,0)
 S X="NO"
"RTN","DGENRPT2",136,0)
 K ^UTILITY("VASD",$J)
"RTN","DGENRPT2",137,0)
 D CALSDA
"RTN","DGENRPT2",138,0)
 I VAERR=1 S X="N/A" Q
"RTN","DGENRPT2",139,0)
 I $G(^UTILITY("VASD",$J,1,"I"))'="" S X="YES"
"RTN","DGENRPT2",140,0)
 Q
"RTN","DGENRPT2",141,0)
 ;
"RTN","DGENRPT2",142,0)
CALSDA ;Use API to get appointments.
"RTN","DGENRPT2",143,0)
 N X
"RTN","DGENRPT2",144,0)
 S VASD("F")=DT,VASD("W")=12 D SDA^VADPT
"RTN","DGENRPT2",145,0)
 Q
"RTN","DGENRPT2",146,0)
 ;
"RTN","DGENRPT2",147,0)
PCPVD ;Get the patient PC PROVIDER.
"RTN","DGENRPT2",148,0)
 ;;Site must use PCMM module.
"RTN","DGENRPT2",149,0)
 S X=""
"RTN","DGENRPT2",150,0)
 S X=$$OUTPTPR^SDUTL3(DFN)
"RTN","DGENRPT2",151,0)
 I X="" S X="N/A" Q
"RTN","DGENRPT2",152,0)
 S X=$P(X,U,2),X=$E(X,1,10)
"RTN","DGENRPT2",153,0)
 Q
"RTN","DGENRPT2",154,0)
 ;
"RTN","DGENRPT2",155,0)
PFCLTY ;Get the patient PREFFERED FACILITY.
"RTN","DGENRPT2",156,0)
 S (X,FCTY)=""
"RTN","DGENRPT2",157,0)
 S X=$$PREF^DGENPTA(DFN,.FCTY),X=$E(FCTY,1,10)
"RTN","DGENRPT2",158,0)
 I X="" S X="N/A"
"RTN","DGENRPT2",159,0)
 Q
"RTN","DGENRPT2",160,0)
 ;
"RTN","DGENRPT2",161,0)
DETHD ;General header for the Preliminary Detailed Report.
"RTN","DGENRPT2",162,0)
 ;Get the date/time the report is run.
"RTN","DGENRPT2",163,0)
 N RDT,Y S (RDT,Y)=""
"RTN","DGENRPT2",164,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","DGENRPT2",165,0)
 S RDT=$P(Y,"@",1)_" @ "_$P($P(Y,"@",2),":",1,2)
"RTN","DGENRPT2",166,0)
 ;Write the header.
"RTN","DGENRPT2",167,0)
 W !,?((IOM-38)\2),"EGT Preliminary Detailed Impact Report"
"RTN","DGENRPT2",168,0)
 W !,?((IOM-22-$L(RDT))\2),"Date/Time Report Run: ",RDT
"RTN","DGENRPT2",169,0)
 W !,?((IOM-45-$L(EGT_EGTSUB_EGTTP_EGTEDT))\2),"EGT Setting: ",EGT_EGTSUB," EGT Type: ",EGTTP," EGT Effective Date: ",EGTEDT
"RTN","DGENRPT2",170,0)
 W !,?((IOM-28-$L(EGTLDT))\2),"Date/Time Last EGT Setting: ",EGTLDT
"RTN","DGENRPT2",171,0)
 W !!,"IMPORTANT NOTE:",!,"Preliminary report is based on a comparison of the EGT setting to the veterans current enrollment priority as shown in VISTA."
"RTN","DGENRPT2",172,0)
 Q
"RTN","DGENRPT2",173,0)
 ;
"RTN","DGENRPT2",174,0)
DETHD1 ;Header for the Preliminary Detailed Report, with Future Appointments.
"RTN","DGENRPT2",175,0)
 D DETHD
"RTN","DGENRPT2",176,0)
 W !!,"NAME",?21,"SSN",?32,"EP",?36,"ENROLLMENT",?48,"ENROLLMENT",?62,"WARD",?79,"FUTURE",?109,"PC",?120,"PREF"
"RTN","DGENRPT2",177,0)
 W !,?36,"END DATE",?48,"STATUS",?79,"APPOINTMENTS",?109,"PROVIDER",?120,"FACILITY",!!
"RTN","DGENRPT2",178,0)
 Q
"RTN","DGENRPT2",179,0)
 ;
"RTN","DGENRPT2",180,0)
DETHD0 ;Header for the Preliminary Detailed Report, no Future Appointments.
"RTN","DGENRPT2",181,0)
 D DETHD
"RTN","DGENRPT2",182,0)
 W !!,"NAME",?21,"SSN",?32,"EP",?36,"ENROLLMENT",?48,"ENROLLMENT",?62,"WARD",?79,"FUTURE",?87,"PC",?99,"PREF"
"RTN","DGENRPT2",183,0)
 W !,?36,"END DATE",?48,"STATUS",?79,"APPTS",?87,"PROVIDER",?99,"FACILITY",!!
"RTN","DGENRPT2",184,0)
 Q
"RTN","DGENRPT2",185,0)
 ;
"RTN","DGENRPT2",186,0)
END ;At the end of the display.
"RTN","DGENRPT2",187,0)
 N PSSN,J S (PSSN,J)=""
"RTN","DGENRPT2",188,0)
 F  S J=$O(^TMP($J,"CNT2",J)) Q:J=""  D
"RTN","DGENRPT2",189,0)
 . F  S PSSN=$O(^TMP($J,"CNT2",J,PSSN)) Q:PSSN=""  D
"RTN","DGENRPT2",190,0)
   ..S TOTAL=TOTAL+1
"RTN","DGENRPT2",191,0)
 W !,"TOTAL PATIENTS (UNIQUE SSNS) FOR THIS FACILITY:     ",TOTAL
"RTN","DGENRPT2",192,0)
 Q
"RTN","DGENRPT2",193,0)
 ;
"RTN","DGENRPT2",194,0)
EXIT ;Clean up upon exit of the routine.
"RTN","DGENRPT2",195,0)
 D KVA^VADPT
"RTN","DGENRPT2",196,0)
 K ^TMP($J,"BY2"),^TMP($J,"CNT2")
"RTN","DGENRPT2",197,0)
 Q
"RTN","DGENRPT3")
0^4^B29803264
"RTN","DGENRPT3",1,0)
DGENRPT3 ;ALB/DW,LBD - EGT Actual Summary Impact Report ; 04/24/03 2:40pm ; 07/22/02 9:40am
"RTN","DGENRPT3",2,0)
 ;;5.3;Registration;**232,306,417,456,491,513**;Aug 13,1993
"RTN","DGENRPT3",3,0)
 ;
"RTN","DGENRPT3",4,0)
 ;
"RTN","DGENRPT3",5,0)
ENPT ;Actual Summary Report selected.
"RTN","DGENRPT3",6,0)
 K ^TMP($J,"SS3"),^TMP($J,"RT3")
"RTN","DGENRPT3",7,0)
 N BDT,EDT S (BDT,EDT)=""
"RTN","DGENRPT3",8,0)
 D RPDT I BDT="^"!(EDT="^")!($D(DTOUT)) Q
"RTN","DGENRPT3",9,0)
 D PRINT
"RTN","DGENRPT3",10,0)
 Q
"RTN","DGENRPT3",11,0)
 ;
"RTN","DGENRPT3",12,0)
RPDT ;Ask the user the Report Begin Date and Report End Date.
"RTN","DGENRPT3",13,0)
 N DIR,X,Y
"RTN","DGENRPT3",14,0)
 S DIR(0)="DA^::E"
"RTN","DGENRPT3",15,0)
 S DIR("A")="Report Begin Date: "
"RTN","DGENRPT3",16,0)
 S DIR("?")="Please enter the Enrollment End Date as the beginning date that will be reported on."
"RTN","DGENRPT3",17,0)
 D ^DIR S BDT=Y
"RTN","DGENRPT3",18,0)
 I BDT="^" Q
"RTN","DGENRPT3",19,0)
 I ($D(DTOUT)) W *7 Q
"RTN","DGENRPT3",20,0)
 ;
"RTN","DGENRPT3",21,0)
RPDT2 S DIR(0)="DA^::E"
"RTN","DGENRPT3",22,0)
 S DIR("A")="Report End Date: "
"RTN","DGENRPT3",23,0)
 S DIR("?")="Please enter the Enrollment End Date as the end date that will be reported on. Report End Date cannot be earlier than Report Begin Date."
"RTN","DGENRPT3",24,0)
 D ^DIR S EDT=Y
"RTN","DGENRPT3",25,0)
 I EDT="^" Q
"RTN","DGENRPT3",26,0)
 I ($D(DTOUT)) W *7 Q
"RTN","DGENRPT3",27,0)
 I EDT<BDT G RPDT2
"RTN","DGENRPT3",28,0)
 Q
"RTN","DGENRPT3",29,0)
 ;
"RTN","DGENRPT3",30,0)
GETEGTS ;First get the current EGT parameters from file #27.16.
"RTN","DGENRPT3",31,0)
 N GETEGTS,REC,TP S (GETEGTS,REC,TP)=""
"RTN","DGENRPT3",32,0)
 S REC=$$FINDCUR^DGENEGT() I REC=0 Q
"RTN","DGENRPT3",33,0)
 S TP=$$GET^DGENEGT(REC,.GETEGTS)
"RTN","DGENRPT3",34,0)
 ;Get EGT Priority.
"RTN","DGENRPT3",35,0)
 S EGT=GETEGTS("PRIORITY"),RLEGT=EGT
"RTN","DGENRPT3",36,0)
 I EGT="" W !,"No EGT setting on file.",! S EGT=0
"RTN","DGENRPT3",37,0)
 S EGTSUB=GETEGTS("SUBGRP")
"RTN","DGENRPT3",38,0)
 ;Get EGT Effective Date.
"RTN","DGENRPT3",39,0)
 S EGTEDT=GETEGTS("EFFDATE") I EGTEDT S EGTEDT=$$FMTE^XLFDT(EGTEDT)
"RTN","DGENRPT3",40,0)
 ;Get last EGT setting Date/Time.
"RTN","DGENRPT3",41,0)
 S EGTLDT=GETEGTS("ENTDATE") I EGTLDT S EGTLDT=$$FMTE^XLFDT(EGTLDT)
"RTN","DGENRPT3",42,0)
 ;Get EGT Type.
"RTN","DGENRPT3",43,0)
 S EGTTP=GETEGTS("TYPE")
"RTN","DGENRPT3",44,0)
 S EGTTP=$$EXTERNAL^DILFD(27.16,.04,"F",EGTTP) S:EGTTP="" EGTTP="UNSPECIFIED"
"RTN","DGENRPT3",45,0)
 Q
"RTN","DGENRPT3",46,0)
 ;
"RTN","DGENRPT3",47,0)
PRESRT1 ;Sort for patient's current record and get the potentially affected.
"RTN","DGENRPT3",48,0)
 N IND,PRT,DFN,INPT,PSSN,PEDT,PCTRY,TMP,PRTSUB,ABV
"RTN","DGENRPT3",49,0)
 S (IND,PRT,DFN,PSSN,PEDT,PCTRY,TMP,PRTSUB,ABV)="",INPT="OUT"
"RTN","DGENRPT3",50,0)
 K ^TMP($J,"SS3"),^TMP($J,"RT3")
"RTN","DGENRPT3",51,0)
 F  S DFN=$O(^DGEN(27.11,"C",DFN)) Q:DFN=""  D
"RTN","DGENRPT3",52,0)
 . S IND=$$FINDCUR^DGENA(DFN) I IND D
"RTN","DGENRPT3",53,0)
 .. D EGTP
"RTN","DGENRPT3",54,0)
 .. S PEDT=$P($G(^DGEN(27.11,IND,0)),U,11)
"RTN","DGENRPT3",55,0)
 .. S PCTRY=$$CATEGORY^DGENA4(DFN)
"RTN","DGENRPT3",56,0)
 .. I ABV=0&(PCTRY="N")&(PEDT'<BDT)&(PEDT'>EDT) D
"RTN","DGENRPT3",57,0)
 ... K VAIP(2) S INPT="OUT" D IN5^VADPT S TMP=$P($G(VAIP(2)),U) I TMP=1!(TMP=2)!(TMP=6) S INPT="IN"
"RTN","DGENRPT3",58,0)
 ... K VADM(2) D DEM^VADPT S PSSN=$P($G(VADM(2)),U)
"RTN","DGENRPT3",59,0)
 ... S ^TMP($J,"RT3",PRT,PSSN)=PRT_"^"_INPT
"RTN","DGENRPT3",60,0)
 ;
"RTN","DGENRPT3",61,0)
PRESRT2 ;Sort the sorted.
"RTN","DGENRPT3",62,0)
 N CNT,ICNT,OCNT,J,K
"RTN","DGENRPT3",63,0)
 S (J,K)=""
"RTN","DGENRPT3",64,0)
 F  S J=$O(^TMP($J,"RT3",J)) Q:J=""  D
"RTN","DGENRPT3",65,0)
 . S (CNT,ICNT,OCNT)=0
"RTN","DGENRPT3",66,0)
 . F  S K=$O(^TMP($J,"RT3",J,K)) Q:K=""  D
"RTN","DGENRPT3",67,0)
   .. S INPT=$P($G(^TMP($J,"RT3",J,K)),U,2)
"RTN","DGENRPT3",68,0)
   .. S CNT=CNT+1 S:INPT="IN" ICNT=ICNT+1 S:INPT="OUT" OCNT=OCNT+1
"RTN","DGENRPT3",69,0)
   .. S ^TMP($J,"SS3",J)=CNT_"^"_ICNT_"^"_OCNT
"RTN","DGENRPT3",70,0)
 K ^TMP($J,"RT3")
"RTN","DGENRPT3",71,0)
 Q
"RTN","DGENRPT3",72,0)
 ;
"RTN","DGENRPT3",73,0)
EGTP ;Get patients EGT Priority.
"RTN","DGENRPT3",74,0)
 S (PRT,PRTSUB,ABV,ENRDT)=""
"RTN","DGENRPT3",75,0)
 S PRT=$P($G(^DGEN(27.11,IND,0)),U,7)
"RTN","DGENRPT3",76,0)
 S:((PRT=7)!(PRT=8)) PRTSUB=$P($G(^DGEN(27.11,IND,0)),U,12)
"RTN","DGENRPT3",77,0)
 S ENRDT=$P($G(^DGEN(27.11,IND,0)),U,10)
"RTN","DGENRPT3",78,0)
 S:'ENRDT ENRDT=$P($G(^DGEN(27.11,IND,0)),U)
"RTN","DGENRPT3",79,0)
 S ABV=$$ABOVE^DGENEGT1(DFN,PRT,PRTSUB)
"RTN","DGENRPT3",80,0)
 I PRT=7!(PRT=8) D
"RTN","DGENRPT3",81,0)
 . S PRTSUB=$$EXTERNAL^DILFD(27.11,.12,"F",PRTSUB)
"RTN","DGENRPT3",82,0)
 . S:PRTSUB="" PRTSUB="ER"
"RTN","DGENRPT3",83,0)
 S PRT=PRT_PRTSUB
"RTN","DGENRPT3",84,0)
 Q
"RTN","DGENRPT3",85,0)
 ;
"RTN","DGENRPT3",86,0)
PRINT ;Print the report.
"RTN","DGENRPT3",87,0)
 N POP,IO,IOBS,IOF,IOHG,IOM,ION,IOPAR,IOS,IOSL,IOST,IOT,IOUPAR,IOXY,ZTSAVE,TSK,%ZIS,ZTRTN,ZTDESC
"RTN","DGENRPT3",88,0)
 S %ZIS="QM" D ^%ZIS G EXIT:POP
"RTN","DGENRPT3",89,0)
 I $D(IO("Q")) D  G EXIT
"RTN","DGENRPT3",90,0)
 . S ZTRTN="WRITER^DGENRPT3",ZTDESC="DG EGT Actual Summary Report."
"RTN","DGENRPT3",91,0)
 . S ZTSAVE("BDT")="",ZTSAVE("EDT")=""
"RTN","DGENRPT3",92,0)
 . D ^%ZTLOAD
"RTN","DGENRPT3",93,0)
 . S TSK=$S($D(ZTSK)=0:"C",1:"Y")
"RTN","DGENRPT3",94,0)
 . I TSK="Y" W !!,"Report queued! Task number: ",ZTSK
"RTN","DGENRPT3",95,0)
 . D HOME^%ZIS
"RTN","DGENRPT3",96,0)
 ;
"RTN","DGENRPT3",97,0)
WRITER ;Write out the report.
"RTN","DGENRPT3",98,0)
 U IO
"RTN","DGENRPT3",99,0)
 I $E(IOST,1,2)="C-" W @IOF
"RTN","DGENRPT3",100,0)
 N EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,COUNT,RLEGT,ENRDT
"RTN","DGENRPT3",101,0)
 S (EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,RLEGT)="",COUNT=0
"RTN","DGENRPT3",102,0)
 I $$FINDCUR^DGENEGT()=0 W !,"No EGT setting on file.",! S EGT=0
"RTN","DGENRPT3",103,0)
 I $$FINDCUR^DGENEGT()'=0 D GETEGTS
"RTN","DGENRPT3",104,0)
 D PRESRT1
"RTN","DGENRPT3",105,0)
 D PSHEAD
"RTN","DGENRPT3",106,0)
 D DATA
"RTN","DGENRPT3",107,0)
 D ^%ZISC
"RTN","DGENRPT3",108,0)
EXIT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","DGENRPT3",109,0)
 D KVA^VADPT
"RTN","DGENRPT3",110,0)
 K ^TMP($J,"SS3")
"RTN","DGENRPT3",111,0)
 Q
"RTN","DGENRPT3",112,0)
 ;
"RTN","DGENRPT3",113,0)
PSHEAD ;Header for the Preliminary Detailed Report.
"RTN","DGENRPT3",114,0)
 ;Get the date/time the report is run.
"RTN","DGENRPT3",115,0)
 N RDT,Y,DT1,DT2 S (RDT,Y,DT1,DT2)=""
"RTN","DGENRPT3",116,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","DGENRPT3",117,0)
 S RDT=$P(Y,"@",1)_" @ "_$P($P(Y,"@",2),":",1,2)
"RTN","DGENRPT3",118,0)
 S DT1=$$FMTE^XLFDT(BDT),DT2=$$FMTE^XLFDT(EDT)
"RTN","DGENRPT3",119,0)
 S EGTSUB=$$EXTERNAL^DILFD(27.16,.03,"F",EGTSUB)
"RTN","DGENRPT3",120,0)
 I ((EGT=7)!(EGT=8)),EGTSUB="" S EGTSUB="ER"
"RTN","DGENRPT3",121,0)
 ;Write the header.
"RTN","DGENRPT3",122,0)
 W !,?((IOM-32)\2),"EGT Actual Summary Impact Report"
"RTN","DGENRPT3",123,0)
 W !,?((IOM-62)\2),"Date Range of Enrollment End Date: ",DT1," - ",DT2
"RTN","DGENRPT3",124,0)
 W !,?((IOM-41)\2),"Date/Time Report Run: ",RDT
"RTN","DGENRPT3",125,0)
 W !,?((IOM-45-$L(RLEGT_EGTSUB_EGTTP_EGTEDT))\2),"EGT Setting: ",RLEGT_EGTSUB," EGT Type: ",EGTTP," EGT Effective Date: ",EGTEDT
"RTN","DGENRPT3",126,0)
 W !,?((IOM-28-$L(EGTLDT))\2),"Date/Time Last EGT Setting: ",EGTLDT
"RTN","DGENRPT3",127,0)
 W !!,"IMPORTANT NOTE:  Actual report is based on a comparison of the EGT Setting and the Enrollment Category as provided by HEC."
"RTN","DGENRPT3",128,0)
 W !!,"ENROLLMENT PRIORITY",?23,"TOTAL (UNIQUE SSN)",?43,"# INPATIENT",?57,"# OUTPATIENT",!
"RTN","DGENRPT3",129,0)
 Q
"RTN","DGENRPT3",130,0)
 ;
"RTN","DGENRPT3",131,0)
DATA ;Get all the data for the report.
"RTN","DGENRPT3",132,0)
 N T,EP,TLT,INPT,OPT S (T,EP,TLT,INPT,OPT)=""
"RTN","DGENRPT3",133,0)
 F  S T=$O(^TMP($J,"SS3",T)) Q:T=""  D
"RTN","DGENRPT3",134,0)
 . S EP=T,TLT=$P($G(^TMP($J,"SS3",T)),U),INPT=$P($G(^TMP($J,"SS3",T)),U,2),OPT=$P($G(^TMP($J,"SS3",T)),U,3)
"RTN","DGENRPT3",135,0)
 . S COUNT=COUNT+TLT
"RTN","DGENRPT3",136,0)
 . W !,EP,?25,TLT,?45,INPT,?59,OPT
"RTN","DGENRPT3",137,0)
 W !,"TOTAL PATIENTS (UNIQUE SSNS) FOR THIS FACILITY:     ",COUNT
"RTN","DGENRPT3",138,0)
 Q
"RTN","DGENRPT4")
0^5^B52820281
"RTN","DGENRPT4",1,0)
DGENRPT4 ;ALB/DW,LBD - EGT Actual Detailed Impact Report ; 11/2/01 10:23am ;07/22/02 9:40am
"RTN","DGENRPT4",2,0)
 ;;5.3;Registration;**232,306,417,456,491,513**;Aug 13,1993
"RTN","DGENRPT4",3,0)
 ;
"RTN","DGENRPT4",4,0)
 ;
"RTN","DGENRPT4",5,0)
ENPT ;Actual Detailed Report selected.
"RTN","DGENRPT4",6,0)
 K ^TMP($J,"BY4"),^TMP($J,"CNT4")
"RTN","DGENRPT4",7,0)
 N INFAP,BDT,EDT S (INFAP,BDT,EDT)=""
"RTN","DGENRPT4",8,0)
 D RPDT I BDT="^"!(EDT="^")!($D(DTOUT)) Q
"RTN","DGENRPT4",9,0)
 D INFAP I INFAP="^"!($D(DTOUT)) Q
"RTN","DGENRPT4",10,0)
 N EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,L,BY,DIC,FLDS,DHD,DIOEND,X,DFN,PSSN,FCTY,DIOBEG,VASD,VAERR,RLEGT,ENRDT
"RTN","DGENRPT4",11,0)
 S (EGT,EGTSUB,EGTEDT,EGTLDT,EGTTP,FCTY,RLEGT)=""
"RTN","DGENRPT4",12,0)
 W !!,"*** This report requires a 132 column printer. ***",!!
"RTN","DGENRPT4",13,0)
 S DIC="^DGEN(27.11,"
"RTN","DGENRPT4",14,0)
 S DIOBEG="D PRESORT^DGENRPT4"
"RTN","DGENRPT4",15,0)
 S BY(0)="^TMP($J,""BY4"",",L(0)=3,L=0
"RTN","DGENRPT4",16,0)
 S FLDS="D PT^DGENRPT4 W X;C0;L20,W PSSN;C22;L10,D EP^DGENRPT4 W X;C33;L2,D ENRED^DGENRPT4 W X;C37;L10,D ENRST^DGENRPT4 W X;C49;L12"
"RTN","DGENRPT4",17,0)
 I INFAP=1 D
"RTN","DGENRPT4",18,0)
 . S FLDS(2)="D WRD^DGENRPT4 W X;C63;L15;""WARD"",D FAP1^DGENRPT4 W X;C80;L31,D PCPVD^DGENRPT4 W X;C110;L10,D PFCLTY^DGENRPT4 W X;C121;L11"
"RTN","DGENRPT4",19,0)
 . S DHD="W ?0 D DETHD1^DGENRPT4"
"RTN","DGENRPT4",20,0)
 I INFAP=0 D
"RTN","DGENRPT4",21,0)
 . S FLDS(2)="D WRD^DGENRPT4 W X;C63;L15;""WARD"",D FAP0^DGENRPT4 W X;C80;L31,D PCPVD^DGENRPT4 W X;C88;L10,D PFCLTY^DGENRPT4 W X;C100;L12"
"RTN","DGENRPT4",22,0)
 . S DHD="W ?0 D DETHD0^DGENRPT4"
"RTN","DGENRPT4",23,0)
 S DIOEND="D END^DGENRPT4"
"RTN","DGENRPT4",24,0)
 D EN1^DIP
"RTN","DGENRPT4",25,0)
 D EXIT
"RTN","DGENRPT4",26,0)
 Q
"RTN","DGENRPT4",27,0)
 ;
"RTN","DGENRPT4",28,0)
INFAP ;Ask the user if Future Appointments is wanted on the report.
"RTN","DGENRPT4",29,0)
 N DIR,X,Y
"RTN","DGENRPT4",30,0)
 S DIR(0)="Y^1:3"
"RTN","DGENRPT4",31,0)
 S DIR("A")="Do you want to include Future Appointments"
"RTN","DGENRPT4",32,0)
 D ^DIR S INFAP=Y
"RTN","DGENRPT4",33,0)
 I ($D(DTOUT)) W *7
"RTN","DGENRPT4",34,0)
 Q
"RTN","DGENRPT4",35,0)
 ;
"RTN","DGENRPT4",36,0)
RPDT ;Ask the user the Report Begin Date and Report End Date.
"RTN","DGENRPT4",37,0)
 N DIR,X,Y
"RTN","DGENRPT4",38,0)
 S DIR(0)="DA^::E"
"RTN","DGENRPT4",39,0)
 S DIR("A")="Report Begin Date: "
"RTN","DGENRPT4",40,0)
 S DIR("?")="Please enter the Enrollment End Date as the beginning date that will be reported on."
"RTN","DGENRPT4",41,0)
 D ^DIR S BDT=Y
"RTN","DGENRPT4",42,0)
 I BDT="^" Q
"RTN","DGENRPT4",43,0)
 I ($D(DTOUT)) W *7 Q
"RTN","DGENRPT4",44,0)
 ;
"RTN","DGENRPT4",45,0)
RPDT2 S DIR(0)="DA^::E"
"RTN","DGENRPT4",46,0)
 S DIR("A")="Report End Date: "
"RTN","DGENRPT4",47,0)
 S DIR("?")="Please enter the Enrollment End Date as the end date that will be reported on. Report End Date cannot be earlier than Report Begin Date."
"RTN","DGENRPT4",48,0)
 D ^DIR S EDT=Y
"RTN","DGENRPT4",49,0)
 I EDT="^" Q
"RTN","DGENRPT4",50,0)
 I ($D(DTOUT)) W *7 Q
"RTN","DGENRPT4",51,0)
 I EDT<BDT G RPDT2
"RTN","DGENRPT4",52,0)
 Q
"RTN","DGENRPT4",53,0)
 ;
"RTN","DGENRPT4",54,0)
PRESORT ;First get the current EGT Setting from file #27.16.
"RTN","DGENRPT4",55,0)
 N GETEGTS,REC,TP S (GETEGTS,REC,TP)=""
"RTN","DGENRPT4",56,0)
 S REC=$$FINDCUR^DGENEGT()
"RTN","DGENRPT4",57,0)
 ;If no EGT setting on file, print patient of all enrollment priorities.
"RTN","DGENRPT4",58,0)
 I REC=0 W !,"No EGT setting on file.",! S EGT=0 G PRESRT1
"RTN","DGENRPT4",59,0)
 S TP=$$GET^DGENEGT(REC,.GETEGTS)
"RTN","DGENRPT4",60,0)
 ;Get EGT Priority.
"RTN","DGENRPT4",61,0)
 S EGT=GETEGTS("PRIORITY"),RLEGT=EGT
"RTN","DGENRPT4",62,0)
 I EGT="" W !,"No EGT setting on file.",! S EGT=0
"RTN","DGENRPT4",63,0)
 S EGTSUB=GETEGTS("SUBGRP")
"RTN","DGENRPT4",64,0)
 ;Get EGT Effective Date.
"RTN","DGENRPT4",65,0)
 S EGTEDT=GETEGTS("EFFDATE") I EGTEDT S EGTEDT=$$FMTE^XLFDT(EGTEDT)
"RTN","DGENRPT4",66,0)
 ;Get last EGT setting Date/Time.
"RTN","DGENRPT4",67,0)
 S EGTLDT=GETEGTS("ENTDATE") I EGTLDT S EGTLDT=$$FMTE^XLFDT(EGTLDT)
"RTN","DGENRPT4",68,0)
 ;Get EGT Type.
"RTN","DGENRPT4",69,0)
 S EGTTP=GETEGTS("TYPE")
"RTN","DGENRPT4",70,0)
 S EGTTP=$$EXTERNAL^DILFD(27.16,.04,"F",EGTTP) S:EGTTP="" EGTTP="UNSPECIFIED"
"RTN","DGENRPT4",71,0)
 ;
"RTN","DGENRPT4",72,0)
PRESRT1 ;Sort for patient's current record and get the potentially affected.
"RTN","DGENRPT4",73,0)
 N IND,PRT,DFN,NM,PSSN,PEDT,PCTRY,PRTSUB,ABV
"RTN","DGENRPT4",74,0)
 S (IND,PRT,DFN,NM,PSSN,PEDT,PCTRY,PRTSUB,ABV)=""
"RTN","DGENRPT4",75,0)
 K ^TMP($J,"BY4"),^TMP($J,"CNT4")
"RTN","DGENRPT4",76,0)
 F  S DFN=$O(^DGEN(27.11,"C",DFN)) Q:DFN=""  D
"RTN","DGENRPT4",77,0)
 . S IND=$$FINDCUR^DGENA(DFN)
"RTN","DGENRPT4",78,0)
 . I IND D
"RTN","DGENRPT4",79,0)
 .. D EGTP
"RTN","DGENRPT4",80,0)
 .. S PEDT=$P($G(^DGEN(27.11,IND,0)),U,11)
"RTN","DGENRPT4",81,0)
 .. S PCTRY=$$CATEGORY^DGENA4(DFN)
"RTN","DGENRPT4",82,0)
 .. I ABV=0&(PCTRY="N")&(PEDT'<BDT)&(PEDT'>EDT) D
"RTN","DGENRPT4",83,0)
 ... K VADM(1),VADM(2) D DEM^VADPT S NM=VADM(1) D BYSRT
"RTN","DGENRPT4",84,0)
 ... S PSSN=$P($G(VADM(2)),U),^TMP($J,"CNT4",PRT,PSSN)=""
"RTN","DGENRPT4",85,0)
 I EGTSUB>4 S EGTSUB="ER" Q
"RTN","DGENRPT4",86,0)
 S EGTSUB=$$EXTERNAL^DILFD(27.16,.03,"F",EGTSUB)
"RTN","DGENRPT4",87,0)
 Q
"RTN","DGENRPT4",88,0)
 ;
"RTN","DGENRPT4",89,0)
EGTP ;Get patients EGT Priority.
"RTN","DGENRPT4",90,0)
 S (PRT,PRTSUB,ABV,ENRDT)=""
"RTN","DGENRPT4",91,0)
 S PRT=$P($G(^DGEN(27.11,IND,0)),U,7)
"RTN","DGENRPT4",92,0)
 S:((PRT=7)!(PRT=8)) PRTSUB=$P($G(^DGEN(27.11,IND,0)),U,12)
"RTN","DGENRPT4",93,0)
 S ENRDT=$P($G(^DGEN(27.11,IND,0)),U,10)
"RTN","DGENRPT4",94,0)
 S:'ENRDT ENRDT=$P($G(^DGEN(27.11,IND,0)),U)
"RTN","DGENRPT4",95,0)
 S ABV=$$ABOVE^DGENEGT1(DFN,PRT,PRTSUB)
"RTN","DGENRPT4",96,0)
 I PRT=7!(PRT=8) D
"RTN","DGENRPT4",97,0)
 . S PRTSUB=$$EXTERNAL^DILFD(27.11,.12,"F",PRTSUB)
"RTN","DGENRPT4",98,0)
 . S:PRTSUB="" PRTSUB="ER"
"RTN","DGENRPT4",99,0)
 S PRT=PRT_PRTSUB
"RTN","DGENRPT4",100,0)
 Q
"RTN","DGENRPT4",101,0)
 ;
"RTN","DGENRPT4",102,0)
BYSRT ;Sort patients by last name for "BY(0)".
"RTN","DGENRPT4",103,0)
 S ^TMP($J,"BY4",NM,DFN,IND)=""
"RTN","DGENRPT4",104,0)
 Q
"RTN","DGENRPT4",105,0)
 ;
"RTN","DGENRPT4",106,0)
PT ;Get the patient NAME and SSN
"RTN","DGENRPT4",107,0)
 S (X,DFN,PSSN)="" K VADM(1),VADM(2)
"RTN","DGENRPT4",108,0)
 S DFN=$P($G(^DGEN(27.11,D0,0)),U,2)
"RTN","DGENRPT4",109,0)
 I DFN D DEM^VADPT S X=$E(VADM(1),1,20),PSSN=$P(VADM(2),U)
"RTN","DGENRPT4",110,0)
 Q
"RTN","DGENRPT4",111,0)
 ;
"RTN","DGENRPT4",112,0)
EP ;Get the patient EGT Priority.
"RTN","DGENRPT4",113,0)
 S X=""
"RTN","DGENRPT4",114,0)
 N PRT,PRTSUB S (PRT,PRTSUB)=""
"RTN","DGENRPT4",115,0)
 S PRT=$P($G(^DGEN(27.11,D0,0)),U,7)
"RTN","DGENRPT4",116,0)
 I PRT=7!(PRT=8) D
"RTN","DGENRPT4",117,0)
 .S PRTSUB=$P($G(^DGEN(27.11,D0,0)),U,12)
"RTN","DGENRPT4",118,0)
 .S PRTSUB=$$EXTERNAL^DILFD(27.11,.12,"F",PRTSUB)
"RTN","DGENRPT4",119,0)
 .S:PRTSUB="" PRTSUB="ER"
"RTN","DGENRPT4",120,0)
 .S PRT=PRT_PRTSUB
"RTN","DGENRPT4",121,0)
 S X=PRT
"RTN","DGENRPT4",122,0)
 Q
"RTN","DGENRPT4",123,0)
 ;
"RTN","DGENRPT4",124,0)
ENRED ;Get the patient ENROLLMENT END DATE.
"RTN","DGENRPT4",125,0)
 S X=""
"RTN","DGENRPT4",126,0)
 S X=$P($G(^DGEN(27.11,D0,0)),U,11)
"RTN","DGENRPT4",127,0)
 I X="" S X="N/A" Q
"RTN","DGENRPT4",128,0)
 S X=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3))
"RTN","DGENRPT4",129,0)
 Q
"RTN","DGENRPT4",130,0)
 ;
"RTN","DGENRPT4",131,0)
ENRST ;Get the patient ENROLLMENT STATUS.
"RTN","DGENRPT4",132,0)
 S X=""
"RTN","DGENRPT4",133,0)
 S X=$P($G(^DGEN(27.11,D0,0)),U,4)
"RTN","DGENRPT4",134,0)
 S X=$P($G(^DGEN(27.15,X,0)),U,1),X=$E(X,1,12)
"RTN","DGENRPT4",135,0)
 Q
"RTN","DGENRPT4",136,0)
 ;
"RTN","DGENRPT4",137,0)
WRD ;Get the patient WARD.
"RTN","DGENRPT4",138,0)
 S X="" K VAIP(5)
"RTN","DGENRPT4",139,0)
 D IN5^VADPT S X=$P($G(VAIP(5)),U,2),X=$E(X,1,15)
"RTN","DGENRPT4",140,0)
 I X="" S X="N/A"
"RTN","DGENRPT4",141,0)
 Q
"RTN","DGENRPT4",142,0)
 ;
"RTN","DGENRPT4",143,0)
FAP1 ;Get the patient FUTURE APPOINTMENTS.
"RTN","DGENRPT4",144,0)
 N J,POP,ADT S (X,J,ADT)="",POP=0
"RTN","DGENRPT4",145,0)
 K ^UTILITY("VASD",$J)
"RTN","DGENRPT4",146,0)
 D CALSDA
"RTN","DGENRPT4",147,0)
 I VAERR=1 S X="N/A" Q
"RTN","DGENRPT4",148,0)
 F  S J=$O(^UTILITY("VASD",$J,J)) Q:J=""!POP  D
"RTN","DGENRPT4",149,0)
 . S X=$P($G(^UTILITY("VASD",$J,J,"E")),U,2),X=$E(X,1,20)
"RTN","DGENRPT4",150,0)
 . S ADT=$P($G(^UTILITY("VASD",$J,J,"I")),U),ADT=$P(ADT,".",1)
"RTN","DGENRPT4",151,0)
 . S ADT=$E(ADT,4,5)_"/"_$E(ADT,6,7)_"/"_(1700+$E(ADT,1,3))
"RTN","DGENRPT4",152,0)
 . S X=ADT_" "_X
"RTN","DGENRPT4",153,0)
 . I J=1 W X S X=""
"RTN","DGENRPT4",154,0)
 . I J>1&(J<6) W !,?79,X S X=""
"RTN","DGENRPT4",155,0)
 . I J=6 S X="" W !,?79,"More Appts" S POP=1 Q
"RTN","DGENRPT4",156,0)
 I $D(^UTILITY("VASD",$J))=0 S X="NONE"
"RTN","DGENRPT4",157,0)
 Q
"RTN","DGENRPT4",158,0)
 ;
"RTN","DGENRPT4",159,0)
FAP0 ;See if the patient has future appointment.
"RTN","DGENRPT4",160,0)
 S X="NO"
"RTN","DGENRPT4",161,0)
 K ^UTILITY("VASD",$J)
"RTN","DGENRPT4",162,0)
 D CALSDA
"RTN","DGENRPT4",163,0)
 I VAERR=1 S X="N/A" Q
"RTN","DGENRPT4",164,0)
 I $G(^UTILITY("VASD",$J,1,"I"))'="" S X="YES"
"RTN","DGENRPT4",165,0)
 Q
"RTN","DGENRPT4",166,0)
 ;
"RTN","DGENRPT4",167,0)
CALSDA ;Call API to get patient appoinments.
"RTN","DGENRPT4",168,0)
 N X
"RTN","DGENRPT4",169,0)
 S VASD("F")=DT,VASD("W")=12 D SDA^VADPT
"RTN","DGENRPT4",170,0)
 Q
"RTN","DGENRPT4",171,0)
 ;
"RTN","DGENRPT4",172,0)
PCPVD ;Get the patient PC PROVIDER.
"RTN","DGENRPT4",173,0)
 ;;Site must use PCMM module.
"RTN","DGENRPT4",174,0)
 S X=""
"RTN","DGENRPT4",175,0)
 S X=$$OUTPTPR^SDUTL3(DFN)
"RTN","DGENRPT4",176,0)
 I X="" S X="N/A" Q
"RTN","DGENRPT4",177,0)
 S X=$P(X,U,2),X=$E(X,1,10)
"RTN","DGENRPT4",178,0)
 Q
"RTN","DGENRPT4",179,0)
 ;
"RTN","DGENRPT4",180,0)
PFCLTY ;Get the patient PREFFERED FACILITY.
"RTN","DGENRPT4",181,0)
 S (X,FCTY)=""
"RTN","DGENRPT4",182,0)
 S X=$$PREF^DGENPTA(DFN,.FCTY),X=$E(FCTY,1,11)
"RTN","DGENRPT4",183,0)
 I X="" S X="N/A"
"RTN","DGENRPT4",184,0)
 Q
"RTN","DGENRPT4",185,0)
 ;
"RTN","DGENRPT4",186,0)
DETHD ;General header for the Preliminary Detailed Report.
"RTN","DGENRPT4",187,0)
 ;Get the date/time the report is run.
"RTN","DGENRPT4",188,0)
 N RDT,Y,DT1,DT2 S (RDT,Y,DT1,DT2)=""
"RTN","DGENRPT4",189,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","DGENRPT4",190,0)
 S RDT=$P(Y,"@",1)_" @ "_$P($P(Y,"@",2),":",1,2)
"RTN","DGENRPT4",191,0)
 S DT1=$$FMTE^XLFDT(BDT),DT2=$$FMTE^XLFDT(EDT)
"RTN","DGENRPT4",192,0)
 ;Write the header.
"RTN","DGENRPT4",193,0)
 W !,?((IOM-33)\2),"EGT Actual Detailed Impact Report"
"RTN","DGENRPT4",194,0)
 W !,?((IOM-38-$L(DT1_DT2))\2),"Date Range of Enrollment End Date: ",DT1," - ",DT2
"RTN","DGENRPT4",195,0)
 W !,?((IOM-22-$L(RDT))\2),"Date/Time Report Run: ",RDT
"RTN","DGENRPT4",196,0)
 W !,?((IOM-45-$L(RLEGT_EGTSUB_EGTTP_EGTEDT))\2),"EGT Setting: ",RLEGT_EGTSUB," EGT Type: ",EGTTP," EGT Effective Date: ",EGTEDT
"RTN","DGENRPT4",197,0)
 W !,?((IOM-28-$L(EGTLDT))\2),"Date/Time Last EGT Setting: ",EGTLDT
"RTN","DGENRPT4",198,0)
 W !!,"IMPORTANT NOTE:  Actual report is based on a comparison of the EGT Setting and the Enrollment Category as provided by HEC."
"RTN","DGENRPT4",199,0)
 Q
"RTN","DGENRPT4",200,0)
 ;
"RTN","DGENRPT4",201,0)
DETHD1 ;Header for the Preliminary Detailed Report, with Future Appointments.
"RTN","DGENRPT4",202,0)
 D DETHD
"RTN","DGENRPT4",203,0)
 W !!,"NAME",?21,"SSN",?32,"EP",?36,"ENROLLMENT",?48,"ENROLLMENT",?62,"WARD",?79,"FUTURE",?109,"PC",?120,"PREF"
"RTN","DGENRPT4",204,0)
 W !,?36,"END DATE",?48,"STATUS",?79,"APPOINTMENTS",?109,"PROVIDER",?120,"FACILITY",!!
"RTN","DGENRPT4",205,0)
 Q
"RTN","DGENRPT4",206,0)
 ;
"RTN","DGENRPT4",207,0)
DETHD0 ;Header for the Preliminary Detailed Report, no Future Appointments.
"RTN","DGENRPT4",208,0)
 D DETHD
"RTN","DGENRPT4",209,0)
 W !!,"NAME",?21,"SSN",?32,"EP",?36,"ENROLLMENT",?48,"ENROLLMENT",?62,"WARD",?79,"FUTURE",?87,"PC",?99,"PREF"
"RTN","DGENRPT4",210,0)
 W !,?36,"END DATE",?48,"STATUS",?79,"APPTS",?87,"PROVIDER",?99,"FACILITY",!!
"RTN","DGENRPT4",211,0)
 Q
"RTN","DGENRPT4",212,0)
 ;
"RTN","DGENRPT4",213,0)
END ;At the end of the display.
"RTN","DGENRPT4",214,0)
 N PSSN,J,COUNT S (PSSN,J)="",COUNT=0
"RTN","DGENRPT4",215,0)
 F  S J=$O(^TMP($J,"CNT4",J)) Q:J=""  D
"RTN","DGENRPT4",216,0)
 . F  S PSSN=$O(^TMP($J,"CNT4",J,PSSN)) Q:PSSN=""  S COUNT=COUNT+1
"RTN","DGENRPT4",217,0)
 W !,"TOTAL PATIENTS (UNIQUE SSNS) FOR THIS FACILITY:     ",COUNT
"RTN","DGENRPT4",218,0)
 Q
"RTN","DGENRPT4",219,0)
 ;
"RTN","DGENRPT4",220,0)
EXIT ;Clean up upon exit of the routine.
"RTN","DGENRPT4",221,0)
 D KVA^VADPT
"RTN","DGENRPT4",222,0)
 K ^TMP($J,"BY4"),^TMP($J,"CNT4")
"RTN","DGENRPT4",223,0)
 Q
"RTN","DGENUPL7")
0^6^B27511259
"RTN","DGENUPL7",1,0)
DGENUPL7 ;ISA/KWP/CKN - PROCESS INCOMING (Z11 EVENT TYPE) HL7 MESSAGES ; 04/24/023
"RTN","DGENUPL7",2,0)
 ;;5.3;REGISTRATION;**232,367,397,417,379,431,513**;Aug 13,1993
"RTN","DGENUPL7",3,0)
 ;Phase II split from DGENUPL
"RTN","DGENUPL7",4,0)
Z11(MSGIEN,MSGID,CURLINE,DFN,ERRCOUNT) ;
"RTN","DGENUPL7",5,0)
 ;Description:  This is used to process a single ORU~Z11 or ORF~Z11 msg. 
"RTN","DGENUPL7",6,0)
 ;Input:
"RTN","DGENUPL7",7,0)
 ;  MSGIEN - the internal entry number of the HL7 message in the
"RTN","DGENUPL7",8,0)
 ;      HL7 MESSAGE TEXT file (772)
"RTN","DGENUPL7",9,0)
 ;  MSGID -message control id of HL7 msg in the MSH segment
"RTN","DGENUPL7",10,0)
 ;  CURLINE - the subscript of the MSH segment of the current message (pass by reference)
"RTN","DGENUPL7",11,0)
 ;  DFN - identifies the patient, is the ien of a record in the PATIENT file.
"RTN","DGENUPL7",12,0)
 ;  ERRCOUNT - is a count of the number of messages in the batch that can not be processed (pass by reference)
"RTN","DGENUPL7",13,0)
 ;
"RTN","DGENUPL7",14,0)
 ;Output:
"RTN","DGENUPL7",15,0)
 ;  CURLINE - upon leaving the procedure this parameter should be set to the end of the current message. (pass by reference)
"RTN","DGENUPL7",16,0)
 ;  ERRCOUNT - set to count of messages that were not processed due to errors encountered  (pass by reference)
"RTN","DGENUPL7",17,0)
 ;
"RTN","DGENUPL7",18,0)
 N DGELG,DGENR,DGPAT,DGCDIS,ERROR,ERRMSG,MSGS,DGELGSUB,DGENUPLD,DGCON
"RTN","DGENUPL7",19,0)
 N DGNEWVAL,DIV,SUB,OLDELG,OLDPAT,OLDDCDIS,DGSEC,OLDSEC,DGNTR,DGMST,DGPHINC
"RTN","DGENUPL7",20,0)
 ;
"RTN","DGENUPL7",21,0)
 ;some process is killing these HL7 variables, so need to protect them
"RTN","DGENUPL7",22,0)
 S SUB=HLFS
"RTN","DGENUPL7",23,0)
 S DIV=HLECH
"RTN","DGENUPL7",24,0)
 N HLDA,HLDAN,HLDAP,HLDT,HLDT1,HLECH,HLFS,HLNDAP,HLNDAP0,HLPID,HLQ,HLVER,HLERR,HLMTN,HLSDT
"RTN","DGENUPL7",25,0)
 S HLFS=SUB
"RTN","DGENUPL7",26,0)
 S HLECH=DIV
"RTN","DGENUPL7",27,0)
 K DIV,SUB
"RTN","DGENUPL7",28,0)
 ;
"RTN","DGENUPL7",29,0)
 ;drops out of block on error
"RTN","DGENUPL7",30,0)
 D
"RTN","DGENUPL7",31,0)
 .Q:'$$PARSE^DGENUPL1(MSGIEN,MSGID,.CURLINE,.ERRCOUNT,.DGPAT,.DGELG,.DGENR,.DGCDIS,.DGSEC,.DGNTR,.DGMST)
"RTN","DGENUPL7",32,0)
 .D GETLOCKS^DGENUPL5(DFN)
"RTN","DGENUPL7",33,0)
 .;
"RTN","DGENUPL7",34,0)
 .;Used by cross-references to determine if an upload is in progress.
"RTN","DGENUPL7",35,0)
 .S DGENUPLD="ENROLLMENT/ELIGIBILITY UPLOAD IN PROGRESS"
"RTN","DGENUPL7",36,0)
 .;
"RTN","DGENUPL7",37,0)
 .;Update the PATIENT, ELIGIBILITY, CATASTROPHIC DISABILITY objects in memory
"RTN","DGENUPL7",38,0)
 .Q:'$$UOBJECTS^DGENUPL4(DFN,.DGPAT,.DGELG,.DGCDIS,MSGID,.ERRCOUNT,.MSGS,.OLDPAT,.OLDELG,.OLDCDIS)
"RTN","DGENUPL7",39,0)
 .S ERROR=0
"RTN","DGENUPL7",40,0)
 .;if the msg contains patient security, process it
"RTN","DGENUPL7",41,0)
 .I $D(DGSEC) D  Q:ERROR
"RTN","DGENUPL7",42,0)
 ..S DGSEC("DFN")=DFN
"RTN","DGENUPL7",43,0)
 ..S DGSEC("USER")=.5
"RTN","DGENUPL7",44,0)
 ..S DGSEC("DATETIME")=$$NOW^XLFDT
"RTN","DGENUPL7",45,0)
 ..;
"RTN","DGENUPL7",46,0)
 ..; check consistency of patient security record
"RTN","DGENUPL7",47,0)
 ..I '$$CHECK^DGENSEC(.DGSEC,.ERRMSG) D  Q
"RTN","DGENUPL7",48,0)
 ...S ERROR=1
"RTN","DGENUPL7",49,0)
 ...D ADDERROR^DGENUPL(MSGID,DGPAT("SSN"),ERRMSG,.ERRCOUNT)
"RTN","DGENUPL7",50,0)
 ..;
"RTN","DGENUPL7",51,0)
 ..; upload patient security, consistency checks passed
"RTN","DGENUPL7",52,0)
 ..D SECUPLD^DGENUPL5(DFN,.DGSEC,.OLDSEC)
"RTN","DGENUPL7",53,0)
 .;
"RTN","DGENUPL7",54,0)
 .;if the msg has an enrollment process it
"RTN","DGENUPL7",55,0)
 .I DGENR("STATUS")!DGENR("APP") D  Q:ERROR
"RTN","DGENUPL7",56,0)
 ..;use $$PRIORITY to get the eligibility data used to compute priority
"RTN","DGENUPL7",57,0)
 ..I $$PRIORITY^DGENELA4(DFN,.DGELG,.DGELGSUB,DGENR("DATE"),DGENR("APP"))
"RTN","DGENUPL7",58,0)
 ..;
"RTN","DGENUPL7",59,0)
 ..;store the eligibility data in the enrollment record and other missing fields
"RTN","DGENUPL7",60,0)
 ..M DGENR("ELIG")=DGELGSUB
"RTN","DGENUPL7",61,0)
 ..S DGENR("DFN")=DFN
"RTN","DGENUPL7",62,0)
 ..S DGENR("PRIORREC")=""
"RTN","DGENUPL7",63,0)
 ..S DGENR("USER")=.5
"RTN","DGENUPL7",64,0)
 ..S DGENR("DATETIME")=$$NOW^XLFDT
"RTN","DGENUPL7",65,0)
 ..;
"RTN","DGENUPL7",66,0)
 ..;Allow null overwrites of Ineligible data (Ineligible Project):
"RTN","DGENUPL7",67,0)
 ..I $D(DGENR("DATE")),DGENR("DATE")="" S DGENR("DATE")="@"
"RTN","DGENUPL7",68,0)
 ..I $D(DGENR("FACREC")),DGENR("FACREC")="" S DGENR("FACREC")="@"
"RTN","DGENUPL7",69,0)
 ..;
"RTN","DGENUPL7",70,0)
 ..;check the consistency of the enrollment record
"RTN","DGENUPL7",71,0)
 ..I '$$CHECK^DGENA3(.DGENR,.DGPAT,.ERRMSG) D  Q
"RTN","DGENUPL7",72,0)
 ...S ERROR=1
"RTN","DGENUPL7",73,0)
 ...D ADDERROR^DGENUPL(MSGID,DGPAT("SSN"),ERRMSG,.ERRCOUNT)
"RTN","DGENUPL7",74,0)
 ..;Phase II EGT consistency checks (SRS 6.5.1.3)
"RTN","DGENUPL7",75,0)
 ..;Only do the EGT consistency checks for Rejected-Fiscal Year (11),Rejected-Mid Cycle (12),Rejected-Stop enrolling new apps (13),Rejected-Initil App by VAMC (14),Rejected below EGT threshold (22)
"RTN","DGENUPL7",76,0)
 ..I "^11^12^13^14^22^"[("^"_DGENR("STATUS")_"^"),$$ABOVE^DGENEGT1(DGENR("DFN"),DGENR("PRIORITY"),DGENR("SUBGRP"),"","",1) D  Q
"RTN","DGENUPL7",77,0)
 ...S ERROR=1
"RTN","DGENUPL7",78,0)
 ...S ERRMSG="THE ENROLLMENT RECORD DID NOT PASS THE EGT CONSISTENCY CHECKS."
"RTN","DGENUPL7",79,0)
 ...D ADDERROR^DGENUPL(MSGID,DGPAT("SSN"),ERRMSG,.ERRCOUNT)
"RTN","DGENUPL7",80,0)
 ..;Allow null overwrites for Ineligible vets (Ineligible Project):
"RTN","DGENUPL7",81,0)
 ..I $G(DGPAT("INELDATE"))'="" S (DGENR("PRIORITY"),DGENR("SUBGRP"))=""
"RTN","DGENUPL7",82,0)
 ..I DGENR("DATE")="@" S DGENR("DATE")=""
"RTN","DGENUPL7",83,0)
 ..I DGENR("FACREC")="@" S DGENR("FACREC")=""
"RTN","DGENUPL7",84,0)
 ..;
"RTN","DGENUPL7",85,0)
 ..D ENRUPLD^DGENUPL8(.DGENR,.DGPAT)
"RTN","DGENUPL7",86,0)
 .;
"RTN","DGENUPL7",87,0)
 .;Store the PATIENT, ELIGIBILITY, & CAT. DISB. objects
"RTN","DGENUPL7",88,0)
 .I $$STORE^DGENPTA1(.DGPAT,,1)
"RTN","DGENUPL7",89,0)
 .I $$STORE^DGENELA1(.DGELG,.DGPAT,.DGCDIS,,1)
"RTN","DGENUPL7",90,0)
 .I $G(DGCDIS("VCD"))'="",$$STORE^DGENCDA2(DFN,.DGCDIS) ;checks first if there is catastrophic disability information
"RTN","DGENUPL7",91,0)
 .;
"RTN","DGENUPL7",92,0)
 .;Call PIMS api to file NTR data.
"RTN","DGENUPL7",93,0)
 .I $D(DGNTR),$$ENRUPD^DGNTAPI1(DFN,.DGNTR)
"RTN","DGENUPL7",94,0)
 .;
"RTN","DGENUPL7",95,0)
 .;Call PIMS api to file MST data.
"RTN","DGENUPL7",96,0)
 .I DGMST("MSTSTAT")'="",DGMST("MSTDT")'="",DGMST("MSTST")'="" D
"RTN","DGENUPL7",97,0)
 ..I $$NEWSTAT^DGMSTAPI(DFN,DGMST("MSTSTAT"),DGMST("MSTDT"),".5",DGMST("MSTST"),0)
"RTN","DGENUPL7",98,0)
 .;
"RTN","DGENUPL7",99,0)
 .;if the current enrollment is a local then log patient for transmission
"RTN","DGENUPL7",100,0)
 .I $$SOURCE^DGENA(DFN)=1!$G(DGPHINC) K DGENUPLD,DGPHINC D EVENT^IVMPLOG(DFN)
"RTN","DGENUPL7",101,0)
 .;
"RTN","DGENUPL7",102,0)
 .;create the audit trail
"RTN","DGENUPL7",103,0)
 .I $$AUDIT^DGENUPA1(,MSGID,.OLDPAT,.DGPAT,.OLDELG,.DGELG,.OLDCDIS,.DGCDIS,.DGSEC,.OLDSEC)
"RTN","DGENUPL7",104,0)
 .;send notifications
"RTN","DGENUPL7",105,0)
 .D NOTIFY^DGENUPL3(.DGPAT,.MSGS)
"RTN","DGENUPL7",106,0)
 .;
"RTN","DGENUPL7",107,0)
 .;invoke registration consistency checker
"RTN","DGENUPL7",108,0)
 .D REGCHECK^DGENUPL2(DFN)
"RTN","DGENUPL7",109,0)
 ;
"RTN","DGENUPL7",110,0)
 D UNLOCK^DGENUPL5(DFN)
"RTN","DGENUPL7",111,0)
 Q
"RTN","DGMTREM")
0^11^B4246677
"RTN","DGMTREM",1,0)
DGMTREM ;ALB/CAW - Comments for Means Test ; 04/28/2003 2:00 pm
"RTN","DGMTREM",2,0)
 ;;5.3;Registration;**45,182,513**;Aug 13, 1993
"RTN","DGMTREM",3,0)
 ;
"RTN","DGMTREM",4,0)
EN ;Entry point to place comments concerning a means test
"RTN","DGMTREM",5,0)
 I DGMTYPT=1 S DIC("S")="I $P(^(0),U,14)"
"RTN","DGMTREM",6,0)
 I DGMTYPT=2 S DIC("S")="I $D(^DGMT(408.31,""AID"",DGMTYPT,+Y))"
"RTN","DGMTREM",7,0)
 S DIC="^DPT(",DIC(0)="AEMQ" W ! D ^DIC K DIC G Q:Y<0 S DFN=+Y
"RTN","DGMTREM",8,0)
 ;
"RTN","DGMTREM",9,0)
DT S DIC("A")="Select DATE OF TEST: "
"RTN","DGMTREM",10,0)
 I $D(^DGMT(408.31,+$$LST^DGMTU(DFN,"",DGMTYPT),0)) S DIC("B")=$P(^(0),"^")
"RTN","DGMTREM",11,0)
 S DIC("S")="I $P(^(0),U,2)=DFN,$P(^(0),U,19)=DGMTYPT S MTDT=X,MTIEN=Y I $$PRIM^DGMTREM(MTDT,MTIEN)"
"RTN","DGMTREM",12,0)
 S DIC="^DGMT(408.31,",DIC(0)="EQZ" W ! D EN^DGMTLK K DIC G Q:Y<0
"RTN","DGMTREM",13,0)
 S DGMTI=+Y,DGMTDT=$P(Y,"^",2),DGMT0=Y(0)
"RTN","DGMTREM",14,0)
 ;
"RTN","DGMTREM",15,0)
 ;
"RTN","DGMTREM",16,0)
 I '$P($G(^DG(408.34,+$P(Y(0),U,23),0)),U,2) D  G:$G(DGERR) Q
"RTN","DGMTREM",17,0)
 .W !!?3,*7,"Warning: Uneditable "_$S(DGMTYPT=1:"means",1:"copay")_" test.  The source of this test is "_$S($$SR^DGMTAUD1(Y(0))]"":$$SR^DGMTAUD1(Y(0)),1:"UNKNOWN")
"RTN","DGMTREM",18,0)
 .W !?12,"which has been flagged as an uneditable source.",! S DGERR=1
"RTN","DGMTREM",19,0)
 D DISPLAY^DGMTU23(DGMTI,DGMTYPT),PAUSE I $D(DTOUT)!($D(DUOUT)) K DTOUT,DUOUT G EN
"RTN","DGMTREM",20,0)
 ; Comment enter/edit
"RTN","DGMTREM",21,0)
 S DA=DGMTI,DR="[DGMT COMMENTS]",DIE="^DGMT(408.31," D ^DIE
"RTN","DGMTREM",22,0)
 ;
"RTN","DGMTREM",23,0)
Q K DFN,DGMTACT,DGMTDT,DGMTERR,DGMT0,DGMTI,DGMTROU,DGMTYPT,DGMTX,DTOUT,DUOUT,X,Y
"RTN","DGMTREM",24,0)
 Q
"RTN","DGMTREM",25,0)
 ;
"RTN","DGMTREM",26,0)
PAUSE S DIR(0)="E" D ^DIR
"RTN","DGMTREM",27,0)
 Q
"RTN","DGMTREM",28,0)
 ;
"RTN","DGMTREM",29,0)
PRIM(DGMTDT,DGMTIEN) ;
"RTN","DGMTREM",30,0)
 ; Find Primary Test for Income Year, and allow for a Future Dated Test
"RTN","DGMTREM",31,0)
 ;
"RTN","DGMTREM",32,0)
 I ^DGMT(408.31,DGMTIEN,"PRIM")=1 Q 1
"RTN","DGMTREM",33,0)
 I DGMTDT>DT,$O(^DGMT(408.31,"AD",1,DFN,DGMTDT,""),-1)=DGMTIEN Q 1
"RTN","DGMTREM",34,0)
 ;
"RTN","DGMTREM",35,0)
 Q 0
"RTN","DGREG")
0^10^B33365966
"RTN","DGREG",1,0)
DGREG ;ALB/JDS,MRL-REGISTER PATIENT ; 04/25/2003 1:12pm
"RTN","DGREG",2,0)
 ;;5.3;Registration;**1,32,108,147,149,182,245,250,513**;Aug 13, 1993
"RTN","DGREG",3,0)
START ;
"RTN","DGREG",4,0)
EN D LO^DGUTL S DGCLPR=""
"RTN","DGREG",5,0)
 N DGDIV
"RTN","DGREG",6,0)
 S DGDIV=$$PRIM^VASITE
"RTN","DGREG",7,0)
 S:DGDIV %ZIS("B")=$P($G(^DG(40.8,+DGDIV,"DEV")),U,1)
"RTN","DGREG",8,0)
 I $P(^DG(43,1,0),U,39) S %ZIS="NQ",%ZIS("A")="Select 1010 printer: " D ^%ZIS Q:POP  S (DGIO(10),DGIO("PRF"),DGIO("RT"),DGIO("HS"))=ION,DGASKDEV="" I $E(IOST,1,2)'["P-" W !,$C(7),"Not a printer" G DGREG
"RTN","DGREG",9,0)
 K %ZIS("B")
"RTN","DGREG",10,0)
 I '$D(DGIO),$P(^DG(43,1,0),U,30) S %ZIS="N",IOP="HOME" D ^%ZIS I $D(IOS),IOS,$D(^%ZIS(1,+IOS,99)),$D(^%ZIS(1,+^(99),0)) S Y=$P(^(0),U,1) W !,"Using closest printer ",Y,! F I=10,"PRF","RT","HS" S DGIO(I)=Y
"RTN","DGREG",11,0)
A D ENDREG($G(DFN)) I '$G(DG1010TF) W !! S DIC=2,DIC(0)="ALEQM",DLAYGO=2 K DIC("S") D ^DIC K DLAYGO G Q1:Y<0 S (DFN,DA)=+Y,DGNEW=$P(Y,"^",3) N Y D PAUSE^DG10 D BEGINREG(DFN) I DGNEW D NEW^DGRP
"RTN","DGREG",12,0)
 ;
"RTN","DGREG",13,0)
 D CIRN
"RTN","DGREG",14,0)
 ;
"RTN","DGREG",15,0)
 S (DGFC,CURR)=0
"RTN","DGREG",16,0)
 D:'$G(DGNEW) WARN S DA=DFN,DGFC="^1",VET=$S($D(^DPT(DFN,"VET")):^("VET")'="Y",1:0)
"RTN","DGREG",17,0)
 I '$G(DG1010TF) S %ZIS="N",IOP="HOME" D ^%ZIS S DGELVER=0 D EN^DGRPD I $D(DGRPOUT) D ENDREG($G(DFN)) D HL7A08^VAFCDD01 K DFN,DGRPOUT G A
"RTN","DGREG",18,0)
 I '$G(DG1010TF) D HINQ^DG10
"RTN","DGREG",19,0)
 I $D(^DIC(195.4,1,"UP")) I ^("UP") D ADM^RTQ3
"RTN","DGREG",20,0)
 D REG^IVMCQ($G(DFN))  ; send financial query  
"RTN","DGREG",21,0)
 G A1
"RTN","DGREG",22,0)
 ;
"RTN","DGREG",23,0)
RT I $D(^DIC(195.4,1,"UP")) I ^("UP") S $P(DGFC,U,1)=DIV D ADM^RTQ3
"RTN","DGREG",24,0)
 Q
"RTN","DGREG",25,0)
 ;
"RTN","DGREG",26,0)
A1 I '$G(DG1010TF) W !,"Do you want to ",$S(DGNEW:"enter",1:"edit")," Patient Data" S %=1 D YN^DICN G H:'%,CK:%'=1 S DGRPV=0 D EN1^DGRP G Q:'$D(DA)
"RTN","DGREG",27,0)
 G CH
"RTN","DGREG",28,0)
PR W !!,"Is the patient currently being followed in a clinic for the same condition" S %=0 D YN^DICN G Q:%=-1
"RTN","DGREG",29,0)
 I '% W !?4,$C(7),"Enter 'Y' if the patient is being followed in clinic for condition for which",!?6,"registered, 'N' if not." G PR
"RTN","DGREG",30,0)
 S CURR=% G SEEN
"RTN","DGREG",31,0)
 ;
"RTN","DGREG",32,0)
CK S DGEDCN=1 D ^DGRPC
"RTN","DGREG",33,0)
CH S X=$S('$D(^DPT(DFN,.36)):1,$P(^(.36),"^",1)']"":1,1:0),X1=$S('$D(^DPT(DFN,.32)):1,$P(^(.32),"^",3)']"":1,1:0) I 'X,'X1 G CH1
"RTN","DGREG",34,0)
CH1 S DA=DFN G PR:'$D(^DPT("ADA",1,DA)) W !!,"There is still an open disposition--register aborted.",$C(7),$C(7) G Q
"RTN","DGREG",35,0)
SEEN W !!,"Is the patient to be examined in the medical center today" S %=1 D YN^DICN S SEEN=% G:%<0 Q I %'>0 W !!,"Enter 'Y' if the patient is to be examined today, 'N' if not.",$C(7) G SEEN
"RTN","DGREG",36,0)
ABIL D ^DGREGG
"RTN","DGREG",37,0)
ENR ; next line appears to be dead code.  left commented just to test.  mli 4/28/94
"RTN","DGREG",38,0)
 ;S DE=0 F I=0:0 S I=$O(^DPT(DA,"DE",I)) Q:'I  I $P(^(I,0),"^",3)'?7N Q  D PR:'DE S L=+$P($S($D(^SC(L,0)):^(0),1:""),"^",1)
"RTN","DGREG",39,0)
REG S (DIE,DIC)="^DPT("_DFN_",""DIS"",",%DT="PTEX",%DT("A")="Registration login date/time: NOW// "
"RTN","DGREG",40,0)
 W !,%DT("A") R ANS:DTIME S:'$T ANS="^" S:ANS="" ANS="N" S X=ANS G Q:ANS="^" S DA(1)=DFN D CHK^DIE(2.101,.01,"E",X,.RESULT) G REG:RESULT="^"!('$D(RESULT)),PR3:'(RESULT#1) S Y=RESULT
"RTN","DGREG",41,0)
 I (RESULT'="^") W "  ("_RESULT(0)_")"
"RTN","DGREG",42,0)
 S DINUM=9999999-RESULT
"RTN","DGREG",43,0)
 S (DFN1,Y1)=DINUM,APD=Y I $D(^DPT(DFN,"DIS",Y1)) W !!,"You must enter a date that does not exist.",$C(7),$C(7) G REG
"RTN","DGREG",44,0)
 G:$D(^DPT("ADA",1,DA)) CH1 L @(DIE_DINUM_")"):2 G:'$T MSG S:'($D(^DPT(DA(1),"DIS",0))#2) ^(0)="^2.101D^^" S DIC(0)="L",X=+Y D ^DIC
"RTN","DGREG",45,0)
 ;
"RTN","DGREG",46,0)
 ;SAVE OFF DATE/TIME OF REGISTRATION FOR HL7 V2.3 MESSAGING, IN VAFCDDT
"RTN","DGREG",47,0)
 S VAFCDDT=X
"RTN","DGREG",48,0)
 ;
"RTN","DGREG",49,0)
 S DA=DFN1,DIE("NO^")="",DA(1)=DFN,DP=2.101,DR="1///"_$S(SEEN=2:2,CURR=1:1,1:0)_";Q;2"_$S(CURR=1:"///3",1:"")_";2.1;3//"_$S($P(^DG(43,1,"GL"),"^",2):"",1:"/")_$S($D(^DG(40.8,+$P(^DG(43,1,"GL"),"^",3),0)):$P(^(0),"^",1),1:"")_";4////"_DUZ
"RTN","DGREG",50,0)
 I $G(DG1010TF) S DR=DR_";.2///1"
"RTN","DGREG",51,0)
 D EL K DIC("A") N DGNDLOCK S DGNDLOCK=DIE_DFN1_")" L +@DGNDLOCK:2 G:'$T MSG D ^DIE L -@DGNDLOCK
"RTN","DGREG",52,0)
 I $D(DTOUT) D  G Q
"RTN","DGREG",53,0)
 .K DTOUT
"RTN","DGREG",54,0)
 .N DA,DIK
"RTN","DGREG",55,0)
 .S DA(1)=DFN,DA=DFN1,DIK="^DPT("_DFN_",""DIS"","
"RTN","DGREG",56,0)
 .D ^DIK
"RTN","DGREG",57,0)
 .W !!?5,"User Time-out.  Required registration data could be missing."
"RTN","DGREG",58,0)
 .W !,?5,"This registration has been deleted."
"RTN","DGREG",59,0)
 S DGXXXD=1 D EL^DGREGE I $P(^DPT(DFN,"DIS",DFN1,0),"^",3)=4 S DA=DFN,DIE="^DPT(",DR=".368;.369" D ^DIE S DIE="^DPT("_DFN_",""DIS"",",DA(1)=DFN,DA=DFN1
"RTN","DGREG",60,0)
 S DA=DFN,DR="[DGREG]",DIE="^DPT(" D ^DIE K DIE("NO^")
"RTN","DGREG",61,0)
 I $D(^DPT(DFN,"DIS",DFN1,2)),$P(^(2),"^",1)="Y" S DIE="^DPT(",DR="[DG EMPLOYER]",DA=DFN D ^DIE
"RTN","DGREG",62,0)
 G ^DGREG0
"RTN","DGREG",63,0)
PR2 W !!,"You can only enter new registrations through this option.",$C(7),$C(7) G REG
"RTN","DGREG",64,0)
PR3 W !!,"Time is required to register the patient.",!!,$C(7),$C(7) G REG
"RTN","DGREG",65,0)
H W !?5,"Enter 'YES' to enter/edit registration data or 'NO' to continue." G A1
"RTN","DGREG",66,0)
Q K DG,DQ G Q1^DGREG0
"RTN","DGREG",67,0)
Q1 K DGIO,DGASKDEV,DGFC,DGCLRP,CURR,DGELVER,DGNEW Q
"RTN","DGREG",68,0)
EL S DR=DR_";13//" I $D(^DPT(DFN,.36)),$D(^DIC(8,+^(.36),0)) S DR=DR_$P(^(0),"^",1) Q
"RTN","DGREG",69,0)
 S DR=DR_"HUMANITARIAN EMERGENCY" Q
"RTN","DGREG",70,0)
FEE S DGRPFEE=1 D DGREG K DGRPFEE G Q1
"RTN","DGREG",71,0)
 ;
"RTN","DGREG",72,0)
EN1010T(DFN,DGNEWPF,DGDIV,DGIO,DGASKDEV,DG1010TF) ;Registration entry point for 10-10T
"RTN","DGREG",73,0)
 S DGNEW=DGNEWPF ;set new patient flag
"RTN","DGREG",74,0)
 I $G(DGASKDF) S DGASKDEV="" ;ask device flag
"RTN","DGREG",75,0)
 D A
"RTN","DGREG",76,0)
 K DFN1,DG1,DGMT,DGMTCOR,DGRGAUTO,DGWRT
"RTN","DGREG",77,0)
 G Q1
"RTN","DGREG",78,0)
 ;
"RTN","DGREG",79,0)
WARN I $S('$D(^DPT(DFN,.1)):0,$P(^(.1),"^",1)']"":0,1:1) W !,$C(7),"***PATIENT IS CURRENTLY AN INPATIENT***",! H 2
"RTN","DGREG",80,0)
 I $S('$D(^DPT(DFN,.107)):0,$P(^(.107),"^",1)']"":0,1:1) W !,$C(7),"***PATIENT IS CURRENTLY A LODGER***",! H 2
"RTN","DGREG",81,0)
 Q
"RTN","DGREG",82,0)
MSG W !,"Another user is editing, try later ..." G Q
"RTN","DGREG",83,0)
 ;
"RTN","DGREG",84,0)
BEGINREG(DFN) ;
"RTN","DGREG",85,0)
 ;Description: This is called at the begining of the registration process.
"RTN","DGREG",86,0)
 ;Concurrent processes can check the lock to determine if the patient is
"RTN","DGREG",87,0)
 ;currently being registered.
"RTN","DGREG",88,0)
 ;
"RTN","DGREG",89,0)
 Q:'$G(DFN) 0
"RTN","DGREG",90,0)
 I $$QRY^DGENQRY(DFN) W !!,"Enrollment/Eligibility Query sent ...",!!
"RTN","DGREG",91,0)
 L +^TMP(DFN,"REGISTRATION IN PROGRESS"):1
"RTN","DGREG",92,0)
 I $$LOCK^DGENPTA1(DFN) ;try to lock the patient record
"RTN","DGREG",93,0)
 Q
"RTN","DGREG",94,0)
 ;
"RTN","DGREG",95,0)
ENDREG(DFN) ;
"RTN","DGREG",96,0)
 ;Description: releases the lock obtained by calling BEGINREG.
"RTN","DGREG",97,0)
 ;
"RTN","DGREG",98,0)
 Q:'$G(DFN)
"RTN","DGREG",99,0)
 L -^TMP(DFN,"REGISTRATION IN PROGRESS")
"RTN","DGREG",100,0)
 D UNLOCK^DGENPTA1(DFN)
"RTN","DGREG",101,0)
 Q
"RTN","DGREG",102,0)
 ;
"RTN","DGREG",103,0)
IFREG(DFN) ;
"RTN","DGREG",104,0)
 ;Description: tests whether the lock set by BEGINREG is set
"RTN","DGREG",105,0)
 ;
"RTN","DGREG",106,0)
 ;Input:  DFN
"RTN","DGREG",107,0)
 ;Output:
"RTN","DGREG",108,0)
 ;      Function Value = 1 if lock is set, 0 otherwise
"RTN","DGREG",109,0)
 ;
"RTN","DGREG",110,0)
 N RETURN
"RTN","DGREG",111,0)
 Q:'$G(DFN) 0
"RTN","DGREG",112,0)
 L +^TMP(DFN,"REGISTRATION IN PROGRESS"):1
"RTN","DGREG",113,0)
 S RETURN='$T
"RTN","DGREG",114,0)
 L -^TMP(DFN,"REGISTRATION IN PROGRESS")
"RTN","DGREG",115,0)
 Q RETURN
"RTN","DGREG",116,0)
 Q
"RTN","DGREG",117,0)
CIRN ;MPI QUERY
"RTN","DGREG",118,0)
 ;check to see if CIRN PD/MPI is installed
"RTN","DGREG",119,0)
 N X S X="MPIFAPI" X ^%ZOSF("TEST") Q:'$T
"RTN","DGREG",120,0)
 K MPIFRTN
"RTN","DGREG",121,0)
 D MPIQ^MPIFAPI(DFN)
"RTN","DGREG",122,0)
 K MPIFRTN
"RTN","DGREG",123,0)
 Q
"RTN","DGRPD")
0^13^B51763780
"RTN","DGRPD",1,0)
DGRPD ;ALB/MRL/MLR/JAN-PATIENT INQUIRY (NEW) ; 05/12/2003 4:05pm
"RTN","DGRPD",2,0)
 ;;5.3;Registration;**109,124,121,57,161,149,286,358,436,445,489,498,506,513**;Aug 13, 1993
"RTN","DGRPD",3,0)
 ;  *286*  Newing variables X,Y in OKLINE subroutine
"RTN","DGRPD",4,0)
 ;  *358*  If a patient is on a domiciliary ward, don't display MEANS
"RTN","DGRPD",5,0)
 ;         TEST required/Medication Copayment Exemption messages
"RTN","DGRPD",6,0)
 ;  *436*  If an inpatient is not on a domiciliary ward, don't display
"RTN","DGRPD",7,0)
 ;         Medication Copayment Exemption message
"RTN","DGRPD",8,0)
 ;
"RTN","DGRPD",9,0)
SEL K DFN,DGRPOUT W ! S DIC="^DPT(",DIC(0)="AEQMZ" D ^DIC G Q:Y'>0 S DFN=+Y N Y W ! S DIR(0)="E" D ^DIR G SEL:$D(DTOUT)!($D(DUOUT)) D EN G SEL
"RTN","DGRPD",10,0)
 ;
"RTN","DGRPD",11,0)
EN ;call to display patient inquiry - input DFN
"RTN","DGRPD",12,0)
 ;MPI/PD CHANGE
"RTN","DGRPD",13,0)
 S DGCMOR="UNSPECIFIED",DGMPI=$G(^DPT(+DFN,"MPI"))
"RTN","DGRPD",14,0)
 S DGLOCATN=$$FIND1^DIC(4,"","MX","`"_+$P(DGMPI,U,3)),DGLOCATN=$S(+DGLOCATN>0:$P($$NS^XUAF4(DGLOCATN),U),1:"NOT LISTED")
"RTN","DGRPD",15,0)
 I $D(DGMPI),$D(DGLOCATN) S DGCMOR=$P(DGLOCATN,"^")
"RTN","DGRPD",16,0)
 ;END MPI/PD CHANGE
"RTN","DGRPD",17,0)
 K DGRPOUT,DGHOW S DGABBRV=$S($D(^DG(43,1,0)):+$P(^(0),"^",38),1:0),DGRPU="UNSPECIFIED" D DEM^VADPT,HDR F I=0,.11,.13,.121,.31,.32,.36,.361,.141 S DGRP(I)=$S($D(^DPT(DFN,I)):^(I),1:"")
"RTN","DGRPD",18,0)
 S DGAD=.11,(DGA1,DGA2)=1 D A^DGRPU S DGTMPAD=0 I $P(DGRP(.121),"^",9)="Y" S DGTMPAD=$S('$P(DGRP(.121),"^",8):1,$P(DGRP(.121),"^",8)'<DT:1,1:0) I DGTMPAD S DGAD=.121,DGA1=1,DGA2=2 D A^DGRPU
"RTN","DGRPD",19,0)
 W ?1,"Address: ",$S($D(DGA(1)):DGA(1),1:"NONE ON FILE"),?40,"Temporary: ",$S($D(DGA(2)):DGA(2),1:"NO TEMPORARY ADDRESS")
"RTN","DGRPD",20,0)
 S I=2 F I1=0:0 S I=$O(DGA(I)) Q:I=""  W:(I#2)!($X>50) !?10 W:'(I#2) ?51 W DGA(I)
"RTN","DGRPD",21,0)
 S DGCC=+$P(DGRP(.11),U,7),DGST=+$P(DGRP(.11),U,5),DGCC=$S($D(^DIC(5,DGST,1,DGCC,0)):$E($P(^(0),U,1),1,20)_$S($P(^(0),U,3)]"":" ("_$P(^(0),U,3)_")",1:""),1:DGRPU) W !?2,"County: ",DGCC
"RTN","DGRPD",22,0)
 S X="NOT APPLICABLE" I DGTMPAD S Y=$P(DGRP(.121),U,7) X:Y]"" ^DD("DD") S X=$S(Y]"":Y,1:DGRPU)_"-",Y=$P(DGRP(.121),U,8) X:Y]"" ^DD("DD") S X=X_$S(Y]"":Y,1:DGRPU)
"RTN","DGRPD",23,0)
 W ?42,"From/To: ",X,!?3,"Phone: ",$S($P(DGRP(.13),U,1)]"":$P(DGRP(.13),U,1),1:DGRPU),?44,"Phone: ",$S('DGTMPAD:X,$P(DGRP(.121),U,10)]"":$P(DGRP(.121),U,10),1:DGRPU) K DGTMPAD
"RTN","DGRPD",24,0)
 W !?2,"Office: ",$S($P(DGRP(.13),U,2)]"":$P(DGRP(.13),U,2),1:DGRPU)
"RTN","DGRPD",25,0)
 W !,"Bad Addr: ",$$EXTERNAL^DILFD(2,.121,"",$$BADADR^DGUTL3(+DFN))
"RTN","DGRPD",26,0)
 D CA
"RTN","DGRPD",27,0)
 I 'DGABBRV W !!?4,"POS: ",$S($D(^DIC(21,+$P(DGRP(.32),"^",3),0)):$P(^(0),"^",1),1:DGRPU),?42,"Claim #: ",$S($P(DGRP(.31),"^",3)]"":$P(DGRP(.31),"^",3),1:"UNSPECIFIED")
"RTN","DGRPD",28,0)
 I 'DGABBRV W !?2,"Relig: ",$S($D(^DIC(13,+$P(DGRP(0),"^",8),0)):$P(^(0),"^",1),1:DGRPU),?46,"Sex: ",$S($P(VADM(5),"^",2)]"":$P(VADM(5),"^",2),1:"UNSPECIFIED")
"RTN","DGRPD",29,0)
 I 'DGABBRV W ! D
"RTN","DGRPD",30,0)
 .N RACE,ETHNIC,PTR,VAL,X,DIWL,DIWR,DIWF
"RTN","DGRPD",31,0)
 .K ^UTILITY($J,"W")
"RTN","DGRPD",32,0)
 .S PTR=0 F  S PTR=+$O(^DPT(DFN,.02,PTR)) Q:'PTR  D
"RTN","DGRPD",33,0)
 ..S VAL=+$G(^DPT(DFN,.02,PTR,0))
"RTN","DGRPD",34,0)
 ..Q:$$INACTIVE^DGUTL4(VAL,1)
"RTN","DGRPD",35,0)
 ..S VAL=$$PTR2TEXT^DGUTL4(VAL,1) S:+$O(^DPT(DFN,.02,PTR)) VAL=VAL_", "
"RTN","DGRPD",36,0)
 ..S X=VAL,DIWL=0,DIWR=30,DIWF="" D ^DIWP
"RTN","DGRPD",37,0)
 .M RACE=^UTILITY($J,"W",0) S:$G(RACE(1,0))="" RACE(1,0)="UNANSWERED"
"RTN","DGRPD",38,0)
 .K ^UTILITY($J,"W")
"RTN","DGRPD",39,0)
 .S PTR=0 F  S PTR=+$O(^DPT(DFN,.06,PTR)) Q:'PTR  D
"RTN","DGRPD",40,0)
 ..S VAL=+$G(^DPT(DFN,.06,PTR,0))
"RTN","DGRPD",41,0)
 ..Q:$$INACTIVE^DGUTL4(VAL,2)
"RTN","DGRPD",42,0)
 ..S VAL=$$PTR2TEXT^DGUTL4(VAL,2) S:+$O(^DPT(DFN,.06,PTR)) VAL=VAL_", "
"RTN","DGRPD",43,0)
 ..S X=VAL,DIWL=0,DIWR=30,DIWF="" D ^DIWP
"RTN","DGRPD",44,0)
 .M ETHNIC=^UTILITY($J,"W",0) S:$G(ETHNIC(1,0))="" ETHNIC(1,0)="UNANSWERED"
"RTN","DGRPD",45,0)
 .K ^UTILITY($J,"W")
"RTN","DGRPD",46,0)
 .W ?3,"Race: ",RACE(1,0),?40,"Ethnicity: ",ETHNIC(1,0)
"RTN","DGRPD",47,0)
 .F X=2:1 Q:'$D(RACE(X,0))&'$D(ETHNIC(X,0))  W !,?9,$G(RACE(X,0)),?51,$G(ETHNIC(X,0))
"RTN","DGRPD",48,0)
 I '$$OKLINE(16) G Q
"RTN","DGRPD",49,0)
 S X1=DGRP(.36),X=$P(DGRP(.361),"^",1) W !!,"Primary Eligibility: ",$S($D(^DIC(8,+X1,0)):$P(^(0),"^",1)_" ("_$S(X="V":"VERIFIED",X="P":"PENDING VERIFICATION",X="R":"PENDING REVERIFICATION",1:"NOT VERIFIED")_")",1:DGRPU)
"RTN","DGRPD",50,0)
 W !,"Other Eligibilities: " F I=0:0 S I=$O(^DIC(8,I)) Q:'I  I $D(^DIC(8,I,0)),I'=+X1 S X=$P(^(0),"^",1)_", " I $D(^DPT("AEL",DFN,I)) W:$X+$L(X)>79 !?21 W X
"RTN","DGRPD",51,0)
 ;
"RTN","DGRPD",52,0)
 ;display the catastrophic disability review date if there is one
"RTN","DGRPD",53,0)
 D CATDIS
"RTN","DGRPD",54,0)
 ;
"RTN","DGRPD",55,0)
 I $G(DGPRFLG)=1 G Q:'$$OKLINE(19) D
"RTN","DGRPD",56,0)
 . N DGPDT,DGPTM
"RTN","DGRPD",57,0)
 . W !,$$REPEAT^XLFSTR("-",78)
"RTN","DGRPD",58,0)
 . S DGPDT="",DGPDT=$O(^DGS(41.41,"ADC",DFN,DGPDT),-1)
"RTN","DGRPD",59,0)
 . W !,"[PRE-REGISTER DATE:]  "_$S(DGPDT]"":$$FMTE^XLFDT(DGPDT,"1D"),1:"NONE ON FILE")
"RTN","DGRPD",60,0)
 . S DGPTM=$$OUTPTTM^SDUTL3(DFN)
"RTN","DGRPD",61,0)
 . I $P(DGPTM,U,2)]"" W !,"[PRIMARY CARE TEAM:] "_$P(DGPTM,U,2)
"RTN","DGRPD",62,0)
 . W !,$$REPEAT^XLFSTR("-",78)
"RTN","DGRPD",63,0)
 ; Check if patient is an inpatient and on a DOM ward
"RTN","DGRPD",64,0)
 ; If inpatient is on a DOM ward, don't display MT or CP messages
"RTN","DGRPD",65,0)
 ; If inpatient is NOT on a DOM ward, don't display CP message
"RTN","DGRPD",66,0)
 N DGDOM,DGDOM1,VAHOW,VAROOT,VAINDT,VAIP,VAERR
"RTN","DGRPD",67,0)
 G Q:'$$OKLINE(14)
"RTN","DGRPD",68,0)
 D DOM^DGMTR
"RTN","DGRPD",69,0)
 I '$G(DGDOM) D
"RTN","DGRPD",70,0)
 .D DIS^DGMTU(DFN)
"RTN","DGRPD",71,0)
 .D IN5^VADPT
"RTN","DGRPD",72,0)
 .I $G(VAIP(1))="" D DISP^IBARXEU(DFN,DT,3,1)
"RTN","DGRPD",73,0)
 ;I 'DGABBRV,$E(IOST,1,2)="C-" F I=$Y:1:20 W !
"RTN","DGRPD",74,0)
 S VAIP("L")=""
"RTN","DGRPD",75,0)
 I $$OKLINE(14) D INP
"RTN","DGRPD",76,0)
 I '$G(DGRPOUT),($$OKLINE(17)) D SA
"RTN","DGRPD",77,0)
 ;MPI/PD CHANGE
"RTN","DGRPD",78,0)
Q D KVA^VADPT K %DT,D0,D1,DGA,DGA1,DGA2,DGABBRV,DGAD,DGCC,DGCMOR,DGDOM,DGLOCATN,DGMPI,DGRP,DGRPU,DGS,DGST,DGXFR0,DIC,DIR,DTOUT,DUOUT,DIRUT,DIROUT,I,I1,L,LDM,POP,SDCT,VA,X,X1,Y Q
"RTN","DGRPD",79,0)
CA ;Confidential Address
"RTN","DGRPD",80,0)
 W !!?1,"Confidential Address:  ",?44,"Confidential Address Categories:"
"RTN","DGRPD",81,0)
 N DGCABEG,DGCAEND,DGA,DGARRAY,DGERROR
"RTN","DGRPD",82,0)
 S DGCABEG=$P(DGRP(.141),U,7),DGCAEND=$P(DGRP(.141),U,8)
"RTN","DGRPD",83,0)
 I 'DGCABEG!(DGCABEG>DT)!(DGCAEND&(DGCAEND<DT)) D  Q
"RTN","DGRPD",84,0)
 .W !?9,"NO CONFIDENTIAL ADDRESS"
"RTN","DGRPD",85,0)
 .W !?1,"From/To: NOT APPLICABLE"
"RTN","DGRPD",86,0)
 S DGAD=.141,(DGA1,DGA2)=1
"RTN","DGRPD",87,0)
 D AL^DGRPU(30)
"RTN","DGRPD",88,0)
 D GETS^DIQ(2,DFN,".141*,","E","DGARRAY","DGERROR")
"RTN","DGRPD",89,0)
 ;Format Confidential Address categories
"RTN","DGRPD",90,0)
 N DGIEN,DGCAST
"RTN","DGRPD",91,0)
 S DGIEN=0
"RTN","DGRPD",92,0)
 S DGA2=2
"RTN","DGRPD",93,0)
 F  S DGIEN=$O(DGARRAY(2.141,DGIEN)) Q:'DGIEN  D
"RTN","DGRPD",94,0)
 .S DGA(DGA2)=DGARRAY(2.141,DGIEN,.01,"E")
"RTN","DGRPD",95,0)
 .S DGCAST=DGARRAY(2.141,DGIEN,1,"E")
"RTN","DGRPD",96,0)
 .S DGA(DGA2)=DGA(DGA2)_"("_$S(DGCAST="YES":"Active",1:"Inactive")_")"
"RTN","DGRPD",97,0)
 .S DGA2=DGA2+2
"RTN","DGRPD",98,0)
 S I=0 F I1=0:0 S I=$O(DGA(I)) Q:I=""  W:(I#2)!($X>43) !?9 W:'(I#2) ?44 W DGA(I)
"RTN","DGRPD",99,0)
 W !?1,"From/To:  ",$$FMTE^XLFDT(DGCABEG)_"-"_$S(DGCAEND'="":$$FMTE^XLFDT(DGCAEND),1:"UNANSWERED")
"RTN","DGRPD",100,0)
 Q
"RTN","DGRPD",101,0)
HDR I '$D(IOF) S IOP="HOME" D ^%ZIS K IOP
"RTN","DGRPD",102,0)
 ;MPI/PD CHANGE
"RTN","DGRPD",103,0)
 W @IOF,!,$P(VADM(1),"^",1),?40,$P(VADM(2),"^",2),?65,$P(VADM(3),"^",2) S X="",$P(X,"=",78)="" W !,X,!?15,"COORDINATING MASTER OF RECORD: ",DGCMOR,! Q
"RTN","DGRPD",104,0)
 ;END MPI/PD CHANGE
"RTN","DGRPD",105,0)
INP S VAIP("D")="L" D INP^DGPMV10
"RTN","DGRPD",106,0)
 S DGPMT=0
"RTN","DGRPD",107,0)
 D CS^DGPMV10 K DGPMT,DGPMIFN K:'$D(DGSWITCH) DGPMVI,DGPMDCD Q
"RTN","DGRPD",108,0)
SA F I=0:0 S I=$O(^DGS(41.1,"B",DFN,I)) G CL:'I S X=^DGS(41.1,I,0) I $P(X,"^",2)>(DT-1),$P(X,"^",13)']"",'$P(X,"^",17) S L=$P(X,"^",2) D:$$OKLINE(17) SAA Q:$G(DGRPOUT)
"RTN","DGRPD",109,0)
 Q
"RTN","DGRPD",110,0)
SAA ;Scheduled Admit Data
"RTN","DGRPD",111,0)
 W !!?14,"Scheduled Admit"
"RTN","DGRPD",112,0)
 W:$D(^DIC(42,+$P(X,U,8),0)) " on ward "_$P(^(0),U)
"RTN","DGRPD",113,0)
 W:$D(^DIC(45.7,+$P(X,U,9),0)) " for treating specialty "_$P(^(0),U)
"RTN","DGRPD",114,0)
 W " on "_$$FMTE^XLFDT(L,"5DZ")
"RTN","DGRPD",115,0)
 Q  ;SAA
"RTN","DGRPD",116,0)
 ;
"RTN","DGRPD",117,0)
CL G FA:$O(^DPT(DFN,"DE",0))="" S SDCT=0 F I=0:0 S I=$O(^DPT(DFN,"DE",I)) Q:'I  I $D(^(I,0)),$P(^(0),"^",2)'="I",$O(^(0)) S SDCT=SDCT+1 W:SDCT=1 !!,"Currently enrolled in " W:$X>50 !?22 W $S($D(^SC(+^(0),0)):$P(^(0),"^",1)_", ",1:"")
"RTN","DGRPD",118,0)
 ;
"RTN","DGRPD",119,0)
FA G:'$$OKLINE(20) RMK
"RTN","DGRPD",120,0)
 S CT=0 W !!,"Future Appointments: " I $O(^DPT(DFN,"S",DT))'>0 W "NONE" G RMK
"RTN","DGRPD",121,0)
 W ?22,"Date",?33,"Time",?39,"Clinic",!?22 F I=22:1:75 W "="
"RTN","DGRPD",122,0)
 F FA=DT:0 S FA=$O(^DPT(DFN,"S",FA)) G RMK:'FA S L=^(FA,0),C=+L I $P(L,"^",2)'["C" D COV D  Q:CT>5
"RTN","DGRPD",123,0)
 .N DGAPPT
"RTN","DGRPD",124,0)
 .S DGAPPT=$$FMTE^XLFDT($E(FA,1,12),"5Z")
"RTN","DGRPD",125,0)
 .W !?22,$P(DGAPPT,"@")
"RTN","DGRPD",126,0)
 .W ?33,$P(DGAPPT,"@",2)
"RTN","DGRPD",127,0)
 .W ?39,$P($S($D(^SC(C,0)):^(0),1:""),"^")," ",COV
"RTN","DGRPD",128,0)
 .Q
"RTN","DGRPD",129,0)
 I $O(^DPT(DFN,"S",FA))>0 W !,"See Scheduling options for additional appointments."
"RTN","DGRPD",130,0)
RMK I '$G(DGRPOUT),($$OKLINE(21)) W !!,"Remarks: ",$P(^DPT(DFN,0),"^",10)
"RTN","DGRPD",131,0)
 K ADM,L,TRN,DIS,SSN,FA,C,COV,NOW,CT,DGD,DGD1,I ;Y killed after dghinqky 
"RTN","DGRPD",132,0)
 Q
"RTN","DGRPD",133,0)
COV S COV=$S($P(L,"^",7)=7:" (Collateral) ",1:""),COV=COV_$S($P(L,"^",2)["NT":" * NO ACTION TAKEN *",$P(L,"^",2)["N":" * NO-SHOW *",1:""),CT=CT+1 Q
"RTN","DGRPD",134,0)
 Q
"RTN","DGRPD",135,0)
 ;
"RTN","DGRPD",136,0)
OREN S XQORQUIT=1 Q:'$D(ORVP)  S DFN=+ORVP D EN R !!,"Press RETURN to CONTINUE: ",X:DTIME
"RTN","DGRPD",137,0)
 Q
"RTN","DGRPD",138,0)
OKLINE(DGLINE) ;DOES PAUSE/HEADER IF $Y EXCEEDS DGLINE
"RTN","DGRPD",139,0)
 ;
"RTN","DGRPD",140,0)
 ;IN:   DGLINE --MAX LINE COUNT W/O PAUSE
"RTN","DGRPD",141,0)
 ;OUT:  DGLINE[RETURNED] -- 0 IF TIMEOUT/UP ARROW
"RTN","DGRPD",142,0)
 ;      DGRPOUT[SET]     -- 1 IF "
"RTN","DGRPD",143,0)
 N X,Y  ;**286** MLR 09/25/00  Newing X & Y variables prior to ^DIR
"RTN","DGRPD",144,0)
 I $G(IOST)["P-" Q DGLINE ; if printer, quit
"RTN","DGRPD",145,0)
 I $Y>DGLINE N DIR S DIR(0)="E" D ^DIR D:Y HDR I 'Y S DGRPOUT=1,DGLINE=0
"RTN","DGRPD",146,0)
 Q DGLINE
"RTN","DGRPD",147,0)
 ;
"RTN","DGRPD",148,0)
CATDIS ;
"RTN","DGRPD",149,0)
 ;displays catastrophic disabity review date if there is one
"RTN","DGRPD",150,0)
 N DGCDIS
"RTN","DGRPD",151,0)
 I $$GET^DGENCDA(DFN,.DGCDIS) D
"RTN","DGRPD",152,0)
 .Q:'DGCDIS("REVDTE")
"RTN","DGRPD",153,0)
 .W !!,"Catastrophically Disabled Review Date: ",$$FMTE^XLFDT(DGCDIS("REVDTE"),1)
"RTN","DGRPD",154,0)
 Q
"RTN","DGRPD",155,0)
 ;
"RTN","DGRPTU")
0^8^B6454885
"RTN","DGRPTU",1,0)
DGRPTU ;ALB/RMO - 10-10T Registration - Utilities; 04/25/2003
"RTN","DGRPTU",2,0)
 ;;5.3;Registration;**108,513**;08/13/93
"RTN","DGRPTU",3,0)
 ;
"RTN","DGRPTU",4,0)
GETPAT(DGHOWPT,DGADDF,DFN,DGNEWPF) ;Look-up patient
"RTN","DGRPTU",5,0)
 ; Input  -- DGHOWPT  How was patient entered
"RTN","DGRPTU",6,0)
 ;                    1   =10-10T registration
"RTN","DGRPTU",7,0)
 ;           DGADDF   Add new entry flag       (optional)
"RTN","DGRPTU",8,0)
 ;                    1   =Allow new patient
"RTN","DGRPTU",9,0)
 ; Output -- DFN      Patient IEN
"RTN","DGRPTU",10,0)
 ;                    #   =Patient IEN
"RTN","DGRPTU",11,0)
 ;                    -1  =No patient selected
"RTN","DGRPTU",12,0)
 ;           DGNEWPF  New patient added flag
"RTN","DGRPTU",13,0)
 ;                    1   =New patient added
"RTN","DGRPTU",14,0)
 ;                    Null=Existing patient
"RTN","DGRPTU",15,0)
 N DD,DIC,DINUM,DLAYGO,DO,X,Y
"RTN","DGRPTU",16,0)
 S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","DGRPTU",17,0)
 I $G(DGADDF) S DIC(0)=DIC(0)_"L",DLAYGO=2
"RTN","DGRPTU",18,0)
 W !! D ^DIC S DFN=+Y,DGNEWPF=$P(Y,U,3) N Y W ! D PAUSE^DG10
"RTN","DGRPTU",19,0)
 ;If new patient
"RTN","DGRPTU",20,0)
 I DGNEWPF D
"RTN","DGRPTU",21,0)
 . N DA,DIE,DR
"RTN","DGRPTU",22,0)
 . ;Set 'how was patient entered' field
"RTN","DGRPTU",23,0)
 . I $G(DGHOWPT) S DA=DFN,DIE="^DPT(",DR=".098////"_DGHOWPT D ^DIE
"RTN","DGRPTU",24,0)
 . ;Invoke code to execute new patient DR string for patient type
"RTN","DGRPTU",25,0)
 . D NEW^DGRP
"RTN","DGRPTU",26,0)
 Q
"RTN","DGRPTU",27,0)
 ;
"RTN","DGRPTU",28,0)
SETPAR(DGDIV,DGIO,DGASKDEV,DGRPTOUT) ;Set up registration parameters
"RTN","DGRPTU",29,0)
 ; Input  -- None
"RTN","DGRPTU",30,0)
 ; Output -- DGDIV    Primary Medical Center Division IEN
"RTN","DGRPTU",31,0)
 ;           DGIO     Registration printer array
"RTN","DGRPTU",32,0)
 ;           DGASKDEV Registration ask device flag
"RTN","DGRPTU",33,0)
 ;           DGRPTOUT Quit flag
"RTN","DGRPTU",34,0)
 ;                    1   =Timeout or User up-arrow
"RTN","DGRPTU",35,0)
 ;Check ADT parameter set-up and user
"RTN","DGRPTU",36,0)
 D LO^DGUTL
"RTN","DGRPTU",37,0)
 ;Get primary medical center division IEN
"RTN","DGRPTU",38,0)
 S DGDIV=$$PRIM^VASITE
"RTN","DGRPTU",39,0)
 ;Get 1010 printer
"RTN","DGRPTU",40,0)
 D GETPRT(DGDIV,.DGIO,.DGASKDEV,.DGRPTOUT)
"RTN","DGRPTU",41,0)
SETPARQ Q
"RTN","DGRPTU",42,0)
 ;
"RTN","DGRPTU",43,0)
GETPRT(DGDIV,DGIO,DGASKDEV,DGRPTOUT) ;Get registration printer defaults
"RTN","DGRPTU",44,0)
 ; Input  -- DGDIV    Primary Medical Center Division IEN
"RTN","DGRPTU",45,0)
 ; Output -- DGIO     Registration printer array
"RTN","DGRPTU",46,0)
 ;           DGASKDEV Registration ask device flag
"RTN","DGRPTU",47,0)
 ;           DGRPTOUT Quit flag
"RTN","DGRPTU",48,0)
 ;                    -1  =User entered up-arrow
"RTN","DGRPTU",49,0)
 ;                    -2  =Timeout
"RTN","DGRPTU",50,0)
 N DGASK,DTOUT,DUOUT,I,POP,Y
"RTN","DGRPTU",51,0)
ASK ;Ask device in registration
"RTN","DGRPTU",52,0)
 I $P(^DG(43,1,0),U,39) D  G GETPRTQ:$G(DGRPTOUT),ASK:$G(DGASK)
"RTN","DGRPTU",53,0)
 . S DGASK=0
"RTN","DGRPTU",54,0)
 . S:DGDIV %ZIS("B")=$P($G(^DG(40.8,+DGDIV,"DEV")),U,1)
"RTN","DGRPTU",55,0)
 . S %ZIS="NQ",%ZIS("A")="Select 1010 printer: "
"RTN","DGRPTU",56,0)
 . W ! D ^%ZIS I POP S DGRPTOUT=$S($D(DTOUT):-2,1:-1) Q
"RTN","DGRPTU",57,0)
 . I $E(IOST,1,2)'["P-" W !,*7,"Not a printer" S DGASK=1 Q
"RTN","DGRPTU",58,0)
 . S (DGIO(10),DGIO("PRF"),DGIO("RT"),DGIO("HS"))=ION,DGASKDEV=1
"RTN","DGRPTU",59,0)
 ;Use closest printer
"RTN","DGRPTU",60,0)
 I '$D(DGIO),$P(^DG(43,1,0),U,30) D
"RTN","DGRPTU",61,0)
 . S %ZIS="N",IOP="HOME"
"RTN","DGRPTU",62,0)
 . D ^%ZIS
"RTN","DGRPTU",63,0)
 . I $D(IOS),IOS,$D(^%ZIS(1,+IOS,99)),$D(^%ZIS(1,+^(99),0)) S Y=$P(^(0),U,1) D
"RTN","DGRPTU",64,0)
 . . W !,"Using closest printer ",Y,!
"RTN","DGRPTU",65,0)
 . . F I=10,"PRF","RT","HS" S DGIO(I)=Y
"RTN","DGRPTU",66,0)
 ;Use 10-10 printer for division
"RTN","DGRPTU",67,0)
 I '$D(DGIO),$P($G(^DG(40.8,DGDIV,"DEV")),U,1)'="" S DGIO(10)=$P(^("DEV"),U,1)
"RTN","DGRPTU",68,0)
 ;Reset home device
"RTN","DGRPTU",69,0)
 D HOME^%ZIS
"RTN","DGRPTU",70,0)
GETPRTQ K IO("Q"),%ZIS("B")
"RTN","DGRPTU",71,0)
 Q
"RTN","DGRPTU",72,0)
 ;
"RTN","DGRPTU",73,0)
ELGCHK(DFN) ;Eligibility check for editing
"RTN","DGRPTU",74,0)
 ; Input  -- DFN      Patient IEN
"RTN","DGRPTU",75,0)
 ; Output -- 0=No and 1=Yes
"RTN","DGRPTU",76,0)
 N Y
"RTN","DGRPTU",77,0)
 ;If the elig is not verified, the user can edit
"RTN","DGRPTU",78,0)
 I $P($G(^DPT(DFN,.361)),U,1)'="V" S Y=1
"RTN","DGRPTU",79,0)
 ;If the elig is verified the user must hold the DG ELIGIBILITY key
"RTN","DGRPTU",80,0)
 ;to edit
"RTN","DGRPTU",81,0)
 I '$G(Y),$S('($D(DUZ)#2):0,'$D(^XUSEC("DG ELIGIBILITY",DUZ)):0,1:1) S Y=1
"RTN","DGRPTU",82,0)
 Q +$G(Y)
"RTN","DPTLK")
0^1^B56493435
"RTN","DPTLK",1,0)
DPTLK ;ALB/RMO,RTK - MAS Patient Look-up Main Routine ; 05/13/2003  2:20 PM
"RTN","DPTLK",2,0)
 ;;5.3;Registration;**32,72,93,73,136,157,197,232,265,277,223,327,244,513**;Aug 13, 1993
"RTN","DPTLK",3,0)
 ;
"RTN","DPTLK",4,0)
 ; mods made for magstripe read 12/96 - JFP
"RTN","DPTLK",5,0)
 ;
"RTN","DPTLK",6,0)
 ;Optional input: DPTNOFZY='1' to suppress fuzzy lookups implemented
"RTN","DPTLK",7,0)
 ;                by patch DG*5.3*244
"RTN","DPTLK",8,0)
 ;
"RTN","DPTLK",9,0)
EN ; -- Entry point
"RTN","DPTLK",10,0)
 K DPTX,DPTDFN,DPTSAVX I $D(DIC(0)) G QK:DIC(0)["I"!(DIC(0)'["A"&('$D(X)))
"RTN","DPTLK",11,0)
 I '$D(^DD("VERSION")) W !!?3,"Unable to proceed. Fileman version node ^DD(""VERSION"") is undefined." G QK
"RTN","DPTLK",12,0)
 I '$D(^DPT(0))!(^DD("VERSION")<17.2) W !!?3,"Unable to proceed. ",$S('$D(^DPT(0)):"0th node of ^DPT missing",^DD("VERSION")<17.2:"Fileman version must be at least 17.2",1:""),"." G QK
"RTN","DPTLK",13,0)
EN2 K DO,DUOUT,DTOUT S U="^",DIC="^DPT(",DIC(0)=$S($D(DIC(0)):DIC(0),1:"AELMQ") S:DIC(0)'["A" (DPTX,DPTSAVX)=X
"RTN","DPTLK",14,0)
 S DPTSZ=1000 I $D(^DD("OS"))#2 S DPTSZ=$S(+$P(^DD("OS",^("OS"),0),U,2):$P(^(0),U,2),1:DPTSZ)
"RTN","DPTLK",15,0)
 ;
"RTN","DPTLK",16,0)
ASKPAT ; -- Prompt for patient
"RTN","DPTLK",17,0)
 I DIC(0)["A" D   G QK:'$T!($E(DPTX)["^")!(DPTX="")
"RTN","DPTLK",18,0)
 .K DTOUT,DUOUT
"RTN","DPTLK",19,0)
 .W !,$S($D(DIC("A")):DIC("A"),1:"Select PATIENT NAME: ") W:$D(DIC("B")) DIC("B"),"// "
"RTN","DPTLK",20,0)
 .R X:DTIME
"RTN","DPTLK",21,0)
 .S DPTX=X S:'$T DTOUT=1 S:$T&(DPTX="")&($D(DIC("B"))) DPTX=DIC("B") S:DPTX["^" DUOUT=1
"RTN","DPTLK",22,0)
 ; -- Check for the IATA magnetic stripe input
"RTN","DPTLK",23,0)
 N MAG,GCHK
"RTN","DPTLK",24,0)
 S MAG=0
"RTN","DPTLK",25,0)
 I $E(DPTX)="%"!($E(DPTX)=";"),DPTX["?" S MAG=1,(X,DPTX)=$$IATA(DPTX)
"RTN","DPTLK",26,0)
 ;
"RTN","DPTLK",27,0)
CHKPAT ; -- Custom Patient Lookup
"RTN","DPTLK",28,0)
 D DO^DIC1
"RTN","DPTLK",29,0)
 S DIC("W")=$S($D(DIC("W")):DIC("W"),1:"")
"RTN","DPTLK",30,0)
 K DPTIFNS,DPTS,DPTSEL
"RTN","DPTLK",31,0)
 S DPTCNT=0
"RTN","DPTLK",32,0)
 ; -- Check input for format an length
"RTN","DPTLK",33,0)
 G CHKDFN:DPTX?1A!(DPTX'?.ANP)!($L(DPTX)>30)
"RTN","DPTLK",34,0)
 ; -- Check for null response or abort
"RTN","DPTLK",35,0)
 I DPTX=""!(DPTX["^") G ASKPAT:DIC(0)["A",QK
"RTN","DPTLK",36,0)
 ; -- Check for question mark
"RTN","DPTLK",37,0)
 I DPTX["?" D  G ASKPAT:DIC(0)["A",QK
"RTN","DPTLK",38,0)
 .S D="B"
"RTN","DPTLK",39,0)
 .S DZ=$S(DPTX?1"?":"",1:"??")
"RTN","DPTLK",40,0)
 .G CHKPAT1:DZ="??"
"RTN","DPTLK",41,0)
 .N %
"RTN","DPTLK",42,0)
 .W !,?1,"Answer with PATIENT NAME, or SOCIAL SECURITY NUMBER, or last 4 digits",!,?4,"of SOCIAL SECURITY NUMBER, or first initial of"
"RTN","DPTLK",43,0)
 .W " last name with last",!,?4,"4 digits of SOCIAL SECURITY NUMBER"
"RTN","DPTLK",44,0)
 .W !,?1,"Do you want the entire ",+$P($G(^DPT(0)),"^",4),"-Entry PATIENT List" S %=0 D YN^DICN
"RTN","DPTLK",45,0)
 .Q:%'=1
"RTN","DPTLK",46,0)
 .S DZ="??"
"RTN","DPTLK",47,0)
CHKPAT1 .S X=DPTX
"RTN","DPTLK",48,0)
 .D DQ^DICQ
"RTN","DPTLK",49,0)
 ; -- Check for space bar, return
"RTN","DPTLK",50,0)
 I DPTX=" " D  G CHKDFN
"RTN","DPTLK",51,0)
 .S Y=$S('($D(DUZ)#2):-1,$D(^DISV(DUZ,"^DPT(")):^("^DPT("),1:-1)
"RTN","DPTLK",52,0)
 .D SETDPT^DPTLK1:Y>0
"RTN","DPTLK",53,0)
 .S DPTDFN=$S($D(DPTS(Y)):Y,1:-1)
"RTN","DPTLK",54,0)
 ; -- Check for DFN look up
"RTN","DPTLK",55,0)
 I $E(DPTX)="`" D  G CHKDFN
"RTN","DPTLK",56,0)
 .S Y=$S($D(^DPT(+$P(DPTX,"`",2),0)):+$P(DPTX,"`",2),1:-1)
"RTN","DPTLK",57,0)
 .D SETDPT^DPTLK1:Y>0
"RTN","DPTLK",58,0)
 .S DPTDFN=$S($D(DPTS(Y)):Y,1:-1)
"RTN","DPTLK",59,0)
 ; -- Puts input in correct format
"RTN","DPTLK",60,0)
 G CHKDFN:DPTX=""
"RTN","DPTLK",61,0)
 ; -- Force new entry
"RTN","DPTLK",62,0)
 I $E(DPTX)="""",$E(DPTX,$L(DPTX))="""" G NOPAT
"RTN","DPTLK",63,0)
 ; -- Check for index lookups
"RTN","DPTLK",64,0)
 D ^DPTLK1 G QK:$D(DTOUT)!($D(DUOUT)&(DIC(0)'["A")),ASKPAT:$D(DUOUT),CHKPAT:DPTDFN<0,CHKDFN:DPTDFN>0 I DIC(0)["N",$D(^DPT(DPTX,0)) S Y=X D SETDPT^DPTLK1 S DPTDFN=$S($D(DPTS(Y)):Y,1:-1) G CHKDFN
"RTN","DPTLK",65,0)
MAG ; -- No patient found, check for mag stripe input, create stub
"RTN","DPTLK",66,0)
 I 'MAG G NOPAT
"RTN","DPTLK",67,0)
 ; -- Check for ADT option(s) only
"RTN","DPTLK",68,0)
 N DGOPT
"RTN","DPTLK",69,0)
 S DGOPT=$P($G(XQY0),"^",2)
"RTN","DPTLK",70,0)
 I DGOPT'="Load/Edit Patient Data",DGOPT'="Register a Patient" D  G EN2
"RTN","DPTLK",71,0)
 .W !,"    ...Patient not in database, use ADT options to load patient" D Q1
"RTN","DPTLK",72,0)
 ; -- Prompt for creation of stub
"RTN","DPTLK",73,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Patient not found...Create stub entry: "
"RTN","DPTLK",74,0)
 S GCHK=$D(^TMP("DGVIC"))
"RTN","DPTLK",75,0)
 D ^DIR
"RTN","DPTLK",76,0)
 K DIR
"RTN","DPTLK",77,0)
 I 'Y D Q1 G EN2
"RTN","DPTLK",78,0)
 ; -- Parse IATA fields
"RTN","DPTLK",79,0)
 D FIELDS(IATA)
"RTN","DPTLK",80,0)
 ; -- Check for Duplicates
"RTN","DPTLK",81,0)
 D EP2^DPTLK3
"RTN","DPTLK",82,0)
 I DPTDFN<0 D Q1 G EN2
"RTN","DPTLK",83,0)
 ; -- Creates Stub entry in patient file
"RTN","DPTLK",84,0)
 S Y=$$FILE^DPTLK4(DGFLDS)
"RTN","DPTLK",85,0)
 I $P(Y,"^",3)'=1 W !,"Could not add patient to patient file" D QK1 Q
"RTN","DPTLK",86,0)
 D QK1
"RTN","DPTLK",87,0)
 Q
"RTN","DPTLK",88,0)
 ;
"RTN","DPTLK",89,0)
NOPAT ; -- No patient found, ask to add new
"RTN","DPTLK",90,0)
 I DIC(0)["L" D ^DPTLK2 S Y=DPTDFN G ASKPAT:DIC(0)["A"&(Y<0)&('$G(DTOUT)),QK1
"RTN","DPTLK",91,0)
 ;
"RTN","DPTLK",92,0)
CHKDFN ; -- 
"RTN","DPTLK",93,0)
 S:'$D(DPTDFN) DPTDFN=-1 I DPTDFN'>0!('$D(DPTS(+DPTDFN))) W:DIC(0)["Q" *7," ??" G ASKPAT:DIC(0)["A",QK
"RTN","DPTLK",94,0)
 I DIC(0)["E" D  W $S('$D(DPTSEL)&('$D(DIVP)):$P(DPTS(DPTDFN),U,2)_"  "_$P(DPTS(DPTDFN),U)_"  ",$D(^DPT(DPTDFN,0)):"  "_$P(^(0),U)_"  ",1:"") S Y=DPTDFN X:$D(^DPT(DPTDFN,0)) "N DDS X DIC(""W"")"
"RTN","DPTLK",95,0)
 .I $D(DDS) D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY
"RTN","DPTLK",96,0)
 ;
"RTN","DPTLK",97,0)
 ; check for other patients in "BS5" xref on Patient file
"RTN","DPTLK",98,0)
 I '$G(DICR),DPTDFN>0,DIC(0)["E",$$BS5^DPTLK5(+DPTDFN) D  G ASKPAT:DIC(0)["A"&(%'=1),QK:DPTDFN<0
"RTN","DPTLK",99,0)
 .N DPTZERO,DPTLSNME,DPTSSN S DPTZERO=$G(^DPT(+DPTDFN,0)),DPTLSNME=$P($P(DPTZERO,U),","),DPTSSN=$E($P(DPTZERO,U,9),6,9)
"RTN","DPTLK",100,0)
 .W $C(7),!!,"There is more than one patient whose last name is '",DPTLSNME,"' and"
"RTN","DPTLK",101,0)
 .W !,"whose social security number ends with '",DPTSSN,"'."
"RTN","DPTLK",102,0)
 .W !,"Are you sure you wish to continue (Y/N)" S %=0 D YN^DICN
"RTN","DPTLK",103,0)
 .I %'=1 S DPTDFN=-1
"RTN","DPTLK",104,0)
 ;
"RTN","DPTLK",105,0)
 I '$G(DICR),DPTDFN>0 S Y=DPTDFN D ^DGSEC S DPTDFN=Y G ASKPAT:DIC(0)["A"&(DPTDFN<0),QK:DPTDFN<0
"RTN","DPTLK",106,0)
 S DPTX=DPTX_$P(DPTS(DPTDFN),U,2),DPTDFN=DPTDFN_U_$P(^DPT(DPTDFN,0),U)
"RTN","DPTLK",107,0)
 ;
"RTN","DPTLK",108,0)
Q ; -- 
"RTN","DPTLK",109,0)
 S Y=$S('$D(DPTDFN):-1,'$D(DPTS(+DPTDFN)):-1,1:DPTDFN),X=$S($D(DPTX)&(+Y>0):DPTX,$D(DPTSAVX):DPTSAVX,$D(DPTX):DPTX,1:"")
"RTN","DPTLK",110,0)
 I Y>0 S:DIC(0)'["F" ^DISV($S($D(DUZ)#2:DUZ,1:0),"^DPT(")=+Y S:DIC(0)["Z" Y(0)=^DPT(+Y,0),Y(0,0)=$P(^(0),U,1)
"RTN","DPTLK",111,0)
 I DIC(0)["E",$P($G(^DPT(+Y,0)),U,21) W *7,!,"Warning : You have selected a test patient."
"RTN","DPTLK",112,0)
 ;Display enrollment information
"RTN","DPTLK",113,0)
 I Y>0,DIC(0)["E" D ENR
"RTN","DPTLK",114,0)
 ;
"RTN","DPTLK",115,0)
 ; check whether to display Means Test Required message
"RTN","DPTLK",116,0)
 D
"RTN","DPTLK",117,0)
 .N DPTDIV
"RTN","DPTLK",118,0)
 .I '$G(DUZ(2)) Q
"RTN","DPTLK",119,0)
 .I Y>0,DIC(0)["E" S DPTDIV=$$DMT^DPTLK5(+Y,DUZ(2)) I DPTDIV D
"RTN","DPTLK",120,0)
 ..W $C(7),!!,"MEANS TEST REQUIRED"
"RTN","DPTLK",121,0)
 ..W !,?3,$P($G(^DG(40.8,DPTDIV,"MT")),U,2)
"RTN","DPTLK",122,0)
 ..H 2
"RTN","DPTLK",123,0)
 ;
"RTN","DPTLK",124,0)
Q1 ; -- Clean up variables
"RTN","DPTLK",125,0)
 K D,DIC("W"),DO,DPTCNT,DPTDFN,DPTIFNS,DPTIX,DPTS
"RTN","DPTLK",126,0)
 K DPTSAVX,DPTSEL,DPTSZ,DPTX
"RTN","DPTLK",127,0)
 ;
"RTN","DPTLK",128,0)
 K:$D(IATA) IATA
"RTN","DPTLK",129,0)
 K:$D(DGFLDS) @DGFLDS,DGFLDS
"RTN","DPTLK",130,0)
 Q
"RTN","DPTLK",131,0)
 ;
"RTN","DPTLK",132,0)
QK K DPTNOFZY G Q
"RTN","DPTLK",133,0)
 ;
"RTN","DPTLK",134,0)
QK1 K DPTNOFZY G Q1
"RTN","DPTLK",135,0)
 ;
"RTN","DPTLK",136,0)
IX ; --
"RTN","DPTLK",137,0)
 I $D(D),$D(^DD(2,0,"IX",D)),($E(D)'="A") S DPTIX=D
"RTN","DPTLK",138,0)
 G DPTLK
"RTN","DPTLK",139,0)
 ;
"RTN","DPTLK",140,0)
IATA(X) ; --
"RTN","DPTLK",141,0)
 ;This function pulls off ssn from the IATA track
"RTN","DPTLK",142,0)
 ;
"RTN","DPTLK",143,0)
 ;Input:  X   -  what was read in
"RTN","DPTLK",144,0)
 ;Output: SSN -  social security number
"RTN","DPTLK",145,0)
 ;          Q -  quit
"RTN","DPTLK",146,0)
 ;
"RTN","DPTLK",147,0)
 ; Track            Start Sent     End Sent      Field Separator
"RTN","DPTLK",148,0)
 ; -----            ----------     --------      ---------------
"RTN","DPTLK",149,0)
 ;  IATA (alphanum)      %             ?          {   (Note: VA used ^)
"RTN","DPTLK",150,0)
 ;  ABA (numeric)        ;             ?          =    
"RTN","DPTLK",151,0)
 ;
"RTN","DPTLK",152,0)
 ;N IATA
"RTN","DPTLK",153,0)
 S (IATA)=""
"RTN","DPTLK",154,0)
 I $E(X)'="%" Q X ; no start sentinel
"RTN","DPTLK",155,0)
 I X'["?" Q "Q"
"RTN","DPTLK",156,0)
 ; -- Extract data from track
"RTN","DPTLK",157,0)
 S IATA=$$TRACK(X,"%","?")
"RTN","DPTLK",158,0)
 ; -- checks for no data
"RTN","DPTLK",159,0)
 I IATA="" Q "Q"
"RTN","DPTLK",160,0)
 ; -- Returns SSN
"RTN","DPTLK",161,0)
 I IATA'="" Q $P(IATA,"^")
"RTN","DPTLK",162,0)
 Q "Q"
"RTN","DPTLK",163,0)
 ;
"RTN","DPTLK",164,0)
TRACK(X,START,END) ; find track where start/end are sentinels
"RTN","DPTLK",165,0)
 ;
"RTN","DPTLK",166,0)
 Q $P($P($G(X),START,2),END,1)
"RTN","DPTLK",167,0)
 ;
"RTN","DPTLK",168,0)
FIELDS(IATA) ; -- Sets fields
"RTN","DPTLK",169,0)
 Q:'$D(IATA)
"RTN","DPTLK",170,0)
 N CNT,FIELD
"RTN","DPTLK",171,0)
 S DGFLDS="^TMP(""DGVIC"","_$J_")",CNT=1
"RTN","DPTLK",172,0)
 K @DGFLDS
"RTN","DPTLK",173,0)
 F  S FIELD=$P($G(IATA),"^",CNT)  Q:FIELD=""  D
"RTN","DPTLK",174,0)
 .S @DGFLDS@(CNT)=FIELD
"RTN","DPTLK",175,0)
 .S CNT=CNT+1
"RTN","DPTLK",176,0)
 ; -- Define fields for duplicate checker
"RTN","DPTLK",177,0)
 S DPTX=$G(@DGFLDS@(2)) ;NAME
"RTN","DPTLK",178,0)
 S DPTIDS(.03)=$G(@DGFLDS@(3)) ;DOB
"RTN","DPTLK",179,0)
 S DPTIDS(.09)=$G(@DGFLDS@(1)) ;SSN
"RTN","DPTLK",180,0)
 Q
"RTN","DPTLK",181,0)
ENR ;Display Enrollment information after patient selection
"RTN","DPTLK",182,0)
 N DGENCAT,DGENDFN,DGENR,DGEGTIEN,DGEGT
"RTN","DPTLK",183,0)
 I '$$GET^DGENA($$FINDCUR^DGENA(+DPTDFN),.DGENR) Q
"RTN","DPTLK",184,0)
 S DGENCAT=$$CATEGORY^DGENA4(+DPTDFN)
"RTN","DPTLK",185,0)
 S DGENCAT=$$EXTERNAL^DILFD(27.15,.02,"",DGENCAT)
"RTN","DPTLK",186,0)
 W !?1,"Enrollment Priority: ",$S($G(DGENR("PRIORITY")):$$EXT^DGENU("PRIORITY",DGENR("PRIORITY")),1:""),$S($G(DGENR("SUBGRP"))="":"",1:$$EXT^DGENU("SUBGRP",$G(DGENR("SUBGRP"))))
"RTN","DPTLK",187,0)
 W ?33,"Category: ",DGENCAT
"RTN","DPTLK",188,0)
 W ?57,"End Date: ",$S($G(DGENR("END")):$$FMTE^XLFDT(DGENR("END"),"5DZ"),1:""),!
"RTN","DPTLK",189,0)
 ;If patient is NOT ELIGIBLE, display Enrollment Status (Ineligible Project Phase I)
"RTN","DPTLK",190,0)
 I $G(DGENR("STATUS"))=10!($G(DGENR("STATUS"))=19)!($G(DGENR("STATUS"))=20) D
"RTN","DPTLK",191,0)
 . W ?1,"Enrollment Status: ",$S($G(DGENR("STATUS")):$$EXT^DGENU("STATUS",DGENR("STATUS")),1:"") ;H 5
"RTN","DPTLK",192,0)
 ;Get Enrollment Group Threshold Priority and Subgroup
"RTN","DPTLK",193,0)
 S DGEGTIEN=$$FINDCUR^DGENEGT
"RTN","DPTLK",194,0)
 S DGEGT=$$GET^DGENEGT(DGEGTIEN,.DGEGT)
"RTN","DPTLK",195,0)
 Q:$G(DGENR("PRIORITY"))=""!($G(DGEGT("PRIORITY"))="")
"RTN","DPTLK",196,0)
 ;Compare Patient's Enrollment Priority to Enrollment Group Threshold
"RTN","DPTLK",197,0)
 I '$$ABOVE^DGENEGT1(+DPTDFN,DGENR("PRIORITY"),$G(DGENR("SUBGRP")),DGEGT("PRIORITY"),DGEGT("SUBGRP")) D
"RTN","DPTLK",198,0)
 .N X,IORVOFF,IORVON
"RTN","DPTLK",199,0)
 .S X="IORVOFF;IORVON"
"RTN","DPTLK",200,0)
 .D ENDR^%ZISS
"RTN","DPTLK",201,0)
 .W !?32 W:$D(IORVON) IORVON  W "*** WARNING ***" W:$D(IORVOFF) IORVOFF
"RTN","DPTLK",202,0)
 .I DGENR("END")'="" W !?14 W:$D(IORVON) IORVON W "*** PATIENT ENROLLMENT END",$S(DT>+DGENR("END"):"ED",1:"S")," EFFECTIVE ",$$FMTE^XLFDT(DGENR("END"),"5DZ")," ***" W:$D(IORVOFF) IORVOFF Q
"RTN","DPTLK",203,0)
 .W !?5 W:$D(IORVON) IORVON W "*** PATIENT ENROLLMENT ENDING.  ENROLLMENT END DATE IS NOT KNOWN. ***" W:$D(IORVOFF) IORVOFF
"RTN","DPTLK",204,0)
 Q
"RTN","DPTLK",205,0)
 ;
"VER")
8.0^22
**END**
**END**
