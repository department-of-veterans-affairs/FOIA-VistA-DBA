Released PSJ*5*173 SEQ #176
Extracted from mail message
**KIDS**:PSJ*5.0*173^

**INSTALL NAME**
PSJ*5.0*173
"BLD",5679,0)
PSJ*5.0*173^INPATIENT MEDICATIONS^0^3070730^y
"BLD",5679,1,0)
^^11^11^3070730^
"BLD",5679,1,1,0)
During testing of the Bar Code Medication Administration (BCMA) project 
"BLD",5679,1,2,0)
BCMA-HSC Phase III, an issue was discovered with the order flag comments 
"BLD",5679,1,3,0)
for unit dose orders. There is not enough space to store the entire 
"BLD",5679,1,4,0)
comment, so the text is truncated. This patch corrects this problem for 
"BLD",5679,1,5,0)
BCMA by storing the most recent text in an additional location. The 
"BLD",5679,1,6,0)
comment will still be stored in the current location. It will also be in 
"BLD",5679,1,7,0)
the MOST RECEMT FLAG COMMENT field (#129) of the NON-VERIFIED/PENDING file
"BLD",5679,1,8,0)
(#53.1) which is exported in this patch. For active unit dose orders, it
"BLD",5679,1,9,0)
will be stored in the MOST RECENT FLAG COMMENT field (#128) of the UNIT
"BLD",5679,1,10,0)
DOSE sub-file (#55.06) of the PHARMACY PATIENT file (#55) which will be 
"BLD",5679,1,11,0)
exported in a Pharmacy Data Management V1.0 patch.
"BLD",5679,4,0)
^9.64PA^53.1^1
"BLD",5679,4,53.1,0)
53.1
"BLD",5679,4,53.1,2,0)
^9.641^53.1^1
"BLD",5679,4,53.1,2,53.1,0)
NON-VERIFIED ORDERS  (File-top level)
"BLD",5679,4,53.1,2,53.1,1,0)
^9.6411^129^1
"BLD",5679,4,53.1,2,53.1,1,129,0)
MOST RECENT FLAG COMMENT
"BLD",5679,4,53.1,222)
y^y^p^^^^n^^n
"BLD",5679,4,53.1,224)

"BLD",5679,4,"APDD",53.1,53.1)

"BLD",5679,4,"APDD",53.1,53.1,129)

"BLD",5679,4,"B",53.1,53.1)

"BLD",5679,6)
2^136
"BLD",5679,6.3)
4
"BLD",5679,"ABPKG")
n
"BLD",5679,"KRN",0)
^9.67PA^8989.52^19
"BLD",5679,"KRN",.4,0)
.4
"BLD",5679,"KRN",.401,0)
.401
"BLD",5679,"KRN",.402,0)
.402
"BLD",5679,"KRN",.403,0)
.403
"BLD",5679,"KRN",.5,0)
.5
"BLD",5679,"KRN",.84,0)
.84
"BLD",5679,"KRN",3.6,0)
3.6
"BLD",5679,"KRN",3.8,0)
3.8
"BLD",5679,"KRN",9.2,0)
9.2
"BLD",5679,"KRN",9.8,0)
9.8
"BLD",5679,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",5679,"KRN",9.8,"NM",1,0)
PSGOT^^0^B13106682
"BLD",5679,"KRN",9.8,"NM",2,0)
PSJBCMA^^0^B69975181
"BLD",5679,"KRN",9.8,"NM",3,0)
PSJBCMA1^^0^B70492057
"BLD",5679,"KRN",9.8,"NM",4,0)
PSJHL5^^0^B30798054
"BLD",5679,"KRN",9.8,"NM","B","PSGOT",1)

"BLD",5679,"KRN",9.8,"NM","B","PSJBCMA",2)

"BLD",5679,"KRN",9.8,"NM","B","PSJBCMA1",3)

"BLD",5679,"KRN",9.8,"NM","B","PSJHL5",4)

"BLD",5679,"KRN",19,0)
19
"BLD",5679,"KRN",19.1,0)
19.1
"BLD",5679,"KRN",101,0)
101
"BLD",5679,"KRN",409.61,0)
409.61
"BLD",5679,"KRN",771,0)
771
"BLD",5679,"KRN",870,0)
870
"BLD",5679,"KRN",8989.51,0)
8989.51
"BLD",5679,"KRN",8989.52,0)
8989.52
"BLD",5679,"KRN",8994,0)
8994
"BLD",5679,"KRN","B",.4,.4)

"BLD",5679,"KRN","B",.401,.401)

"BLD",5679,"KRN","B",.402,.402)

"BLD",5679,"KRN","B",.403,.403)

"BLD",5679,"KRN","B",.5,.5)

"BLD",5679,"KRN","B",.84,.84)

"BLD",5679,"KRN","B",3.6,3.6)

"BLD",5679,"KRN","B",3.8,3.8)

"BLD",5679,"KRN","B",9.2,9.2)

"BLD",5679,"KRN","B",9.8,9.8)

"BLD",5679,"KRN","B",19,19)

"BLD",5679,"KRN","B",19.1,19.1)

"BLD",5679,"KRN","B",101,101)

"BLD",5679,"KRN","B",409.61,409.61)

"BLD",5679,"KRN","B",771,771)

"BLD",5679,"KRN","B",870,870)

"BLD",5679,"KRN","B",8989.51,8989.51)

"BLD",5679,"KRN","B",8989.52,8989.52)

"BLD",5679,"KRN","B",8994,8994)

"BLD",5679,"QUES",0)
^9.62^^
"BLD",5679,"REQB",0)
^9.611^2^2
"BLD",5679,"REQB",1,0)
PSJ*5.0*159^2
"BLD",5679,"REQB",2,0)
PSS*1.0*109^2
"BLD",5679,"REQB","B","PSJ*5.0*159",1)

"BLD",5679,"REQB","B","PSS*1.0*109",2)

"FIA",53.1)
NON-VERIFIED ORDERS
"FIA",53.1,0)
^PS(53.1,
"FIA",53.1,0,0)
53.1I
"FIA",53.1,0,1)
y^y^p^^^^n^^n
"FIA",53.1,0,10)

"FIA",53.1,0,11)

"FIA",53.1,0,"RLRO")

"FIA",53.1,0,"VR")
5.0^PSJ
"FIA",53.1,53.1)
1
"FIA",53.1,53.1,129)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
173^3070730^11881
"PKG",197,22,1,"PAH",1,1,0)
^^11^11^3070730
"PKG",197,22,1,"PAH",1,1,1,0)
During testing of the Bar Code Medication Administration (BCMA) project 
"PKG",197,22,1,"PAH",1,1,2,0)
BCMA-HSC Phase III, an issue was discovered with the order flag comments 
"PKG",197,22,1,"PAH",1,1,3,0)
for unit dose orders. There is not enough space to store the entire 
"PKG",197,22,1,"PAH",1,1,4,0)
comment, so the text is truncated. This patch corrects this problem for 
"PKG",197,22,1,"PAH",1,1,5,0)
BCMA by storing the most recent text in an additional location. The 
"PKG",197,22,1,"PAH",1,1,6,0)
comment will still be stored in the current location. It will also be in 
"PKG",197,22,1,"PAH",1,1,7,0)
the MOST RECEMT FLAG COMMENT field (#129) of the NON-VERIFIED/PENDING file
"PKG",197,22,1,"PAH",1,1,8,0)
(#53.1) which is exported in this patch. For active unit dose orders, it
"PKG",197,22,1,"PAH",1,1,9,0)
will be stored in the MOST RECENT FLAG COMMENT field (#128) of the UNIT
"PKG",197,22,1,"PAH",1,1,10,0)
DOSE sub-file (#55.06) of the PHARMACY PATIENT file (#55) which will be 
"PKG",197,22,1,"PAH",1,1,11,0)
exported in a Pharmacy Data Management V1.0 patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSGOT")
0^1^B13106682^B13094729
"RTN","PSGOT",1,0)
PSGOT ;BIR/CML3-TRANSFERS DATA FROM 53.1 TO 55 ;24 SEP 97 / 7:54 AM
"RTN","PSGOT",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**13,68,90,110,173**;16 DEC 97;Build 4
"RTN","PSGOT",3,0)
 ;
"RTN","PSGOT",4,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOT",5,0)
 ;
"RTN","PSGOT",6,0)
START ; get internal record number, lock record, and write
"RTN","PSGOT",7,0)
 S ODA=+PSGORD S:$D(^PS(55,PSGP,0))[0 ^(0)=PSGP,^PS(55,"B",PSGP,PSGP)="",$P(^PS(55,0),U,3,4)=PSGP_U_($P($G(^PS(55,0)),U,4)+1) F  L +^PS(55,PSGP,5,0):1 I  Q
"RTN","PSGOT",8,0)
 S ZND=$G(^PS(55,PSGP,5,0)) S:ZND="" ZND="^55.06IA" F DA=$P(ZND,"^",3)+1:1 I '$D(^PS(55,PSGP,5,DA)),'$D(^("B",DA)) L +^PS(55,PSGP,5,DA):1 I  S $P(ZND,"^",3)=DA,$P(ZND,"^",4)=$P(ZND,"^",4)+1,^PS(55,PSGP,5,0)=ZND Q
"RTN","PSGOT",9,0)
 L -^PS(55,PSGP,5,0) S ND0=^PS(53.1,ODA,0),$P(ND0,"^",23)=PSJPWD,^PS(55,PSGP,5,DA,0)=ND0
"RTN","PSGOT",10,0)
 S (ND1,^PS(55,PSGP,5,DA,.2))=$G(^PS(53.1,ODA,.2)),^PS(55,PSGP,5,DA,.3)=$G(^PS(53.1,ODA,.3)),(ND2,^PS(55,PSGP,5,DA,2))=^PS(53.1,ODA,2),^PS(55,PSGP,5,DA,4)=$G(^PS(53.1,ODA,4)),^PS(55,"AUD",+$P(ND2,"^",4),PSGP,DA)=""
"RTN","PSGOT",11,0)
 S X=^PS(55,PSGP,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(ND0,"^",16),"."),$P(X,"^",8)="A",^(0)=X
"RTN","PSGOT",12,0)
 F X=6,7,13 I $D(^PS(53.1,ODA,X)) S ^PS(55,PSGP,5,DA,X)=^(X)
"RTN","PSGOT",13,0)
 I $D(^PS(53.1,ODA,"DSS")) S ^PS(55,PSGP,5,DA,8)=^("DSS")
"RTN","PSGOT",14,0)
 I $O(^PS(53.1,ODA,1,0)) S (C,X)=0 F  S X=$O(^PS(53.1,ODA,1,X)) Q:'X  S:$D(^(X,0)) C=C+1,^PS(55,PSGP,5,DA,1,C,0)=^(0),^PS(55,PSGP,5,DA,1,"B",+$P($G(^(0)),U),C)=""
"RTN","PSGOT",15,0)
 ;F C=0:0 S C=$O(^PS(55,PSGP,5,DA,1,C)) Q:'C  S X=+$G(^(C,0)) S:X ^PS(55,PSGP,5,DA,1,"B",X,C)=""
"RTN","PSGOT",16,0)
 I $O(^PS(53.1,ODA,1,0)) S ^PS(55,PSGP,5,DA,1,0)="^55.07P^"_C_"^"_C
"RTN","PSGOT",17,0)
 F X=3,12 D  S ^PS(55,PSGP,5,DA,X,0)="^55.0"_$S(X=3:8,1:612)_U_CNT_U_CNT
"RTN","PSGOT",18,0)
 .S CNT=0 F C=0:0 S C=$O(^PS(53.1,ODA,X,C)) Q:'C  I $D(^(C,0)) S ^PS(55,PSGP,5,DA,X,C,0)=^(0),CNT=CNT+1
"RTN","PSGOT",19,0)
 ;F X=3,12 I $O(^PS(53.1,ODA,X,0)) S ^PS(55,PSGP,5,DA,X,0)=^(0) F C=0:0 S C=$O(^PS(53.1,ODA,X,C)) Q:'C  I $D(^(C,0)) S ^PS(55,PSGP,5,DA,X,C,0)=^(0)
"RTN","PSGOT",20,0)
 S $P(^PS(53.1,ODA,0),"^",19)=DA
"RTN","PSGOT",21,0)
CR ; set x-refs
"RTN","PSGOT",22,0)
 N A
"RTN","PSGOT",23,0)
 I $D(^PS(55,PSGP,5.1)),$P(^(5.1),"^",6) S X=$P(^(5.1),"^",6) I $P(ND2,"^",3),$P(ND2,"^",6)'>X S $P(^(5.1),"^",6)=$P(ND2,"^",3)
"RTN","PSGOT",24,0)
 S ^PS(55,PSGP,5,"B",+ODA,DA)="",^PS(55,PSGP,5,"AU",$P(ND0,"^",7),+$P(ND2,"^",4),DA)=""
"RTN","PSGOT",25,0)
 S ^PS(55,PSGP,5,"AUS",+$P(ND2,"^",4),DA)=""
"RTN","PSGOT",26,0)
 S ^PS(55,PSGP,5,"C",+ND1,DA)="",^PS(55,"AUE",PSGP,DA)=""
"RTN","PSGOT",27,0)
 S ^PS(55,"AUDS",+$P(ND2,"^",2),PSGP,DA)=""
"RTN","PSGOT",28,0)
 I $D(^PS(55,PSGP,5,DA,8)) S A=^(8),^PS(55,"AUDC",+$P(ND2,"^",4),+A,PSGP,DA)=""
"RTN","PSGOT",29,0)
 I $$PATCH^XPDUTL("PXRM*1.5*12") S X(1)=+$P(ND2,"^",2),X(2)=+$P(ND2,"^",4),DA(1)=PSGP D SPSPA^PSJXRFS(.X,.DA,"UD")
"RTN","PSGOT",30,0)
 K DIK S DA(1)=PSGP S DIK="^PS(55,"_DA(1)_",5,",DIK(1)=125 D EN1^DIK K DIK
"RTN","PSGOT",31,0)
 S PSGTOL=2,PSGTOO=1 F PSGUOW=0:0 S PSGUOW=$O(^PS(53.41,2,1,PSGUOW)) Q:'PSGUOW  I $D(^(PSGUOW,1,PSGP,1,2,1,ODA)) K ^(ODA) D ENL^PSGVDS
"RTN","PSGOT",32,0)
DONE I $D(PSGOE2),PSGOE2]"",$D(^TMP("PSJON",$J,PSGOE2)) S ^(PSGOE2)=DA_"U"
"RTN","PSGOT",33,0)
 S PSGODA=ODA,PSGORD=DA_"U"
"RTN","PSGOT",34,0)
 S PSGNODE=$G(^PS(55,PSGP,5,DA,0)),PSG25=$P(PSGNODE,"^",25),PSG26=$P(PSGNODE,"^",26)
"RTN","PSGOT",35,0)
 I PSG25 S X=$S(PSG25["V":"^PS(55,"_PSGP_",""IV"",",PSG25["U"!(PSG25["A"):"^PS(55,"_PSGP_",5,",1:"^PS(53.1,")_+PSG25_","_$E("02",PSG25["V"+1)_")" I $D(@X) S $P(@X,"^",$S(PSG25["V":6,1:26))=DA_"U"
"RTN","PSGOT",36,0)
 I $P(PSGNODE,"^",26),$P(PSGNODE,"^",26)'["V",$D(^PS(55,PSGP,5,+$P(PSGNODE,"^",26),0)) S $P(^(0),"^",25)=DA_"U"
"RTN","PSGOT",37,0)
 ;I $P(PSGNODE,"^",21) S X=$O(^ORD(101,"B","PS EVSEND OR",0))_";ORD(101,",PSOC="SC",PSJORDER=$$ORDER^PSJHLU(PSGORD) D EN1^XQOR:X K X
"RTN","PSGOT",38,0)
 F Q=0:0 S Q=$O(^PS(53.44,Q)) Q:'Q  I $D(^(Q,1,PSGP,ODA,0)) S $P(^(0),"^",2)=DA
"RTN","PSGOT",39,0)
 L -^PS(53.1,ODA) L -^PS(55,DFN,5,+PSGORD) K CNT,ND,ODA,XX,ZND Q
"RTN","PSJBCMA")
0^2^B69975181^B70029264
"RTN","PSJBCMA",1,0)
PSJBCMA ;BIR/MV-RETURN INPATIENT ACTIVE MEDS (CONDENSED) ;16 Mar 99 / 10:13 AM
"RTN","PSJBCMA",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,69,58,81,91,104,111,112,186,159,173**;16 DEC 97;Build 4
"RTN","PSJBCMA",3,0)
 ;
"RTN","PSJBCMA",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA",5,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSJBCMA",6,0)
 ; Reference to ^PS(51.1 is supported by DIBA 2177.
"RTN","PSJBCMA",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA",8,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA",9,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA",10,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA",11,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA",12,0)
 ; Usage of this routine by BCMA is supported by DBIA 2828.
"RTN","PSJBCMA",13,0)
 ;
"RTN","PSJBCMA",14,0)
EN(DFN,BDT,OTDATE)         ; return condensed list of inpat meds
"RTN","PSJBCMA",15,0)
 NEW CNT,DN,F,FON,ON,PST,WBDT,X,X1,X2,Y,%
"RTN","PSJBCMA",16,0)
 D:+$G(DFN) ORDER
"RTN","PSJBCMA",17,0)
 I '$D(^TMP("PSJ",$J,1,0)) S ^(0)=-1
"RTN","PSJBCMA",18,0)
 K PSJINX
"RTN","PSJBCMA",19,0)
 Q
"RTN","PSJBCMA",20,0)
ORDER ;Loop thru orders.
"RTN","PSJBCMA",21,0)
 I '+$G(BDT) D NOW^%DTC S BDT=%
"RTN","PSJBCMA",22,0)
 I BDT'["." S BDT=BDT_".0001"
"RTN","PSJBCMA",23,0)
 S PSJINX=0
"RTN","PSJBCMA",24,0)
 ;U/D orders
"RTN","PSJBCMA",25,0)
 S F="^PS(55,DFN,5,",WBDT=BDT
"RTN","PSJBCMA",26,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",27,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S FON=ON_"U",PSJON(FON)="" D UDVAR
"RTN","PSJBCMA",28,0)
 ;IV orders
"RTN","PSJBCMA",29,0)
 S F="^PS(55,DFN,""IV"",",WBDT=BDT
"RTN","PSJBCMA",30,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",31,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S FON=ON_"V",PSJON(FON)="" D IVVAR
"RTN","PSJBCMA",32,0)
 ;Pending orders
"RTN","PSJBCMA",33,0)
 S F="^PS(53.1,"
"RTN","PSJBCMA",34,0)
 F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  D
"RTN","PSJBCMA",35,0)
 . S FON=ON_"P"
"RTN","PSJBCMA",36,0)
 . S X=$P($G(^PS(53.1,+ON,0)),U,4) D @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA",37,0)
 ;When a one-time order is found, check against PSJON(FON) array to
"RTN","PSJBCMA",38,0)
 ;make sure no duplicate orders is return on ^TMP.
"RTN","PSJBCMA",39,0)
 I '+$G(OTDATE) D NOW^%DTC S X1=$E(%,1,12),X2=-30 D C^%DTC S OTDATE=X
"RTN","PSJBCMA",40,0)
 I OTDATE'["." S OTDATE=OTDATE_".0001"
"RTN","PSJBCMA",41,0)
 Q:BDT'>OTDATE
"RTN","PSJBCMA",42,0)
 S F="^PS(55,DFN,5,",WBDT=OTDATE
"RTN","PSJBCMA",43,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AU","O",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",44,0)
 .  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AU","O",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",45,0)
 .. S FON=ON_"U" D:'$D(PSJON(FON)) UDVAR
"RTN","PSJBCMA",46,0)
 S F="^PS(55,DFN,""IV"",",WBDT=OTDATE
"RTN","PSJBCMA",47,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",48,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",49,0)
 .. S X=$P($G(^PS(55,DFN,"IV",ON,0)),U,9)
"RTN","PSJBCMA",50,0)
 .. I X]"",$$ONE(DFN,ON_"V",X,$P(X,"^",2),$P(X,"^",3))="O" D
"RTN","PSJBCMA",51,0)
 ... S FON=ON_"V" D:'$D(PSJON(FON)) IVVAR
"RTN","PSJBCMA",52,0)
 K PSJON
"RTN","PSJBCMA",53,0)
 Q
"RTN","PSJBCMA",54,0)
 ;
"RTN","PSJBCMA",55,0)
UDVAR ;Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA",56,0)
 D UDPEND Q:'$$CLINICS($G(CLINIC)) 
"RTN","PSJBCMA",57,0)
 D TMP
"RTN","PSJBCMA",58,0)
 ;Setup Dispense drug for ^TMP
"RTN","PSJBCMA",59,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA",60,0)
 F X=0:0 S X=$O(@(F_ON_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA",61,0)
 . S PSJDD=@(F_ON_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA",62,0)
 . S CNT=CNT+1
"RTN","PSJBCMA",63,0)
 . S ^TMP("PSJ",$J,PSJINX,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((FON["U")&($P(PSJDD,U,2)=""):1,(FON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA",64,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,700,0)=CNT
"RTN","PSJBCMA",65,0)
 K PSJ,PSJDD
"RTN","PSJBCMA",66,0)
 Q
"RTN","PSJBCMA",67,0)
IVVAR ;Set variables for IV and pending orders
"RTN","PSJBCMA",68,0)
 NEW ND,X,Y
"RTN","PSJBCMA",69,0)
 I FON["P" D UDPEND Q:'$$CLINICS(CLINIC)  S PSJ("INFRATE")=$P($G(^PS(53.1,ON,8)),U,5)
"RTN","PSJBCMA",70,0)
 I FON["V" D  Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",71,0)
 . S X=$G(^PS(55,DFN,"IV",ON,0)),CLINIC=$G(^("DSS")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",72,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA",73,0)
 . S PSJ("INFRATE")=$P(X,U,8),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA",74,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA",75,0)
 . S PSJ("IVTYPE")=$P(X,U,4),PSJ("INSYR")=$P(X,U,5)
"RTN","PSJBCMA",76,0)
 . S PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA",77,0)
 . S X=$G(^PS(55,DFN,"IV",ON,.2))
"RTN","PSJBCMA",78,0)
 . S PSJ("DO")="",PSJ("MR")=$P(X,U,3),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA",79,0)
 . I PSJ("FLG") D
"RTN","PSJBCMA",80,0)
 .. N S1,A,B,C
"RTN","PSJBCMA",81,0)
 .. S S1="" F  S S1=$O(^PS(55,DFN,"IV",ON,"A",S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,2),B=$P(C,U,4) Q:A="UG"  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA",82,0)
 ... Q:A'="G"
"RTN","PSJBCMA",83,0)
 ... S PSJ("SRC")=$S(B["FLAGGED BY PHARM":"PHARMACIST",B["FLAGGED BY CPRS":"CPRS",1:"")
"RTN","PSJBCMA",84,0)
 ... S PSJ("COM")=$P(B," ",4,99)
"RTN","PSJBCMA",85,0)
 . S PSJ("OI")=+X
"RTN","PSJBCMA",86,0)
 . S X=$G(^PS(55,DFN,"IV",ON,2))
"RTN","PSJBCMA",87,0)
 . S PSJ("PREV")=$P(X,U,5) I PSJ("PREV")["V",(+PSJ("PREV")=+ON) S PSJ("PREV")=""
"RTN","PSJBCMA",88,0)
 . S PSJ("FOLLOW")=$P(X,U,6),PSJ("RFO")=$P(X,U,9) I PSJ("FOLLOW")["V",(+PSJ("FOLLOW")=+ON) S (PSJ("FOLLOW"),PSJ("RFO"))=""
"RTN","PSJBCMA",89,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA",90,0)
 . N SCHD S SCHD=PSJ("SCHD")
"RTN","PSJBCMA",91,0)
 . S PSJ("STC")=$$ONE(DFN,ON_"V",SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA",92,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA",93,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S(SCHD["ON CALL":"OC",SCHD["ON-CALL":"OC",SCHD["ONCALL":"OC",1:"C")
"RTN","PSJBCMA",94,0)
 D TMP
"RTN","PSJBCMA",95,0)
 S CNT=0
"RTN","PSJBCMA",96,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA",97,0)
 . S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0))
"RTN","PSJBCMA",98,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3)
"RTN","PSJBCMA",99,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,850,0)=CNT,CNT=0
"RTN","PSJBCMA",100,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA",101,0)
 . S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0))
"RTN","PSJBCMA",102,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4)
"RTN","PSJBCMA",103,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,950,0)=CNT
"RTN","PSJBCMA",104,0)
 K PSJ
"RTN","PSJBCMA",105,0)
 S X1=0
"RTN","PSJBCMA",106,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA",107,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:ON'=$P(XX,"^",2)  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA",108,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  S X=^(X2,0),^TMP("PSJ",$J,PSJINX,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",109,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,800,PSJBCID,0)=I-1
"RTN","PSJBCMA",110,0)
 . S X2=0
"RTN","PSJBCMA",111,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  S X=^(X2,0),^TMP("PSJ",$J,PSJINX,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",112,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,900,PSJBCID,0)=I-1
"RTN","PSJBCMA",113,0)
 Q
"RTN","PSJBCMA",114,0)
UDPEND ;
"RTN","PSJBCMA",115,0)
 S X=$G(@(F_ON_",0)")) I $P(F,",")[53.1 S CLINIC=$G(@(F_ON_",""DSS"")")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",116,0)
 I $P(F,",")[55 S CLINIC=$G(@(F_ON_",8)")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",117,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA",118,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA",119,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26),PSJ("RFO")=$P(X,U,27)
"RTN","PSJBCMA",120,0)
 S:FON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA",121,0)
 S X=$G(@(F_ON_",.2)"))
"RTN","PSJBCMA",122,0)
 S PSJ("DO")=$P(X,U,2),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA",123,0)
 I PSJ("FLG") D
"RTN","PSJBCMA",124,0)
 . N S1,A,B,C
"RTN","PSJBCMA",125,0)
 . S S1="" F  S S1=$O(^PS(55,DFN,5,ON,9,S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,3),B=$P(C,U,4) Q:A=7010!(A=7030)  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA",126,0)
 .. Q:A'=7000&(A'=7020)
"RTN","PSJBCMA",127,0)
 .. S PSJ("SRC")=$S(A=7000:"PHARMACIST",A=7020:"CPRS",1:"")
"RTN","PSJBCMA",128,0)
 .. S PSJ("COM")=$G(@(F_ON_",13)"))
"RTN","PSJBCMA",129,0)
 S PSJ("OI")=+X
"RTN","PSJBCMA",130,0)
 S X=$G(@(F_ON_",2)"))
"RTN","PSJBCMA",131,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA",132,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA",133,0)
 S X=$G(@(F_ON_",4)"))
"RTN","PSJBCMA",134,0)
 S PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA",135,0)
 ;naked reference on line below refers to  full reference created by indirect reference to F_ON, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA",136,0)
 S PSJ("SIOPI")=$S($P($G(@(F_ON_",6)")),"^",2)&($P($G(@(F_ON_",6)")),"^")'=""):"!",1:"")_$$ENSET($P($G(^(6)),"^"))
"RTN","PSJBCMA",137,0)
 D SIOPI
"RTN","PSJBCMA",138,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA",139,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P","^ONCALL^ON-CALL^ON CALL^"[("^"_PSJ("SCHD")_"^"):"OC",$$ONE(DFN,FON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA",140,0)
 Q 
"RTN","PSJBCMA",141,0)
TMP ;Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA",142,0)
 N A
"RTN","PSJBCMA",143,0)
 S PSJINX=PSJINX+1
"RTN","PSJBCMA",144,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA",145,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA",146,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA",147,0)
 S A=$G(^PS(51.2,+PSJ("MR"),0)),PSJ("MRABB")=$P(A,U,3),PSJ("MRNM")=$P(A,U)
"RTN","PSJBCMA",148,0)
 S ^TMP("PSJ",$J,PSJINX,0)=DFN_U_+ON_U_FON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")_U_$G(PSJ("RFO"))
"RTN","PSJBCMA",149,0)
 S ^TMP("PSJ",$J,PSJINX,1)=PSJ("MRABB")_U_PSJ("STC")_U_$G(PSJ("SCHD"))_U_PSJ("STARTDT")_U_PSJ("STOPDT")_U_PSJ("ADM")_U_PSJ("STATUS")_U_$G(PSJ("NGIVEN"))_U_$G(PSJ("ST"))_U_$G(PSJ("AUTO"))
"RTN","PSJBCMA",150,0)
 S ^TMP("PSJ",$J,PSJINX,1,0)=$P(A,U,8)_U_PSJ("MRNM")_U_$P(A,U,9)
"RTN","PSJBCMA",151,0)
 S ^TMP("PSJ",$J,PSJINX,2)=PSJ("DO")_U_$G(PSJ("INFRATE"))_U_$G(PSJ("SM"))_U_$G(PSJ("HSM"))
"RTN","PSJBCMA",152,0)
 S ^TMP("PSJ",$J,PSJINX,3)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("OIDF")
"RTN","PSJBCMA",153,0)
 S ^TMP("PSJ",$J,PSJINX,4)=PSJ("SIOPI")
"RTN","PSJBCMA",154,0)
 S A=$$SNDTSTA^PSJHL4A(PSJ("PRI"),PSJ("SCHD"))
"RTN","PSJBCMA",155,0)
 S ^TMP("PSJ",$J,PSJINX,5)=$S(A=1:0,1:1)_U_PSJ("FLG")_U_PSJ("SRC")_U_PSJ("COM")
"RTN","PSJBCMA",156,0)
 Q
"RTN","PSJBCMA",157,0)
SIOPI ; Use provider comments if order is pending and there is no SI
"RTN","PSJBCMA",158,0)
 NEW X,Y,Z
"RTN","PSJBCMA",159,0)
 I FON["P",(PSJ("SIOPI")=""),$O(^PS(53.1,+ON,12,0)) D
"RTN","PSJBCMA",160,0)
 . F X=0:0 S X=$O(^PS(53.1,+ON,12,X)) Q:'X  S Z=$G(^(X,0)) D
"RTN","PSJBCMA",161,0)
 .. S Y=$L(PSJ("SIOPI"))
"RTN","PSJBCMA",162,0)
 .. S:Y+$L(Z)'>179 PSJ("SIOPI")=PSJ("SIOPI")_Z_""
"RTN","PSJBCMA",163,0)
 . I Y+$L(Z)>179 S PSJ("SIOPI")="SEE PROVIDER COMMENTS"
"RTN","PSJBCMA",164,0)
 Q
"RTN","PSJBCMA",165,0)
ENSET(X) ; expands SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSJBCMA",166,0)
 N X1,X2,Y S Y=""
"RTN","PSJBCMA",167,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) I X2]"" S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSJBCMA",168,0)
 S Y=$E(Y,1,$L(Y)-1)
"RTN","PSJBCMA",169,0)
 Q Y
"RTN","PSJBCMA",170,0)
ONE(DFN,ORD,SCH,START,STOP) ;determine if order is a one-time
"RTN","PSJBCMA",171,0)
 ; Input:  DFN - patient's internal entry number
"RTN","PSJBCMA",172,0)
 ;         ORD - order number to check (must contain U or V)
"RTN","PSJBCMA",173,0)
 ;         SCH - schedule text (required)
"RTN","PSJBCMA",174,0)
 ;         START - order start date (optional)
"RTN","PSJBCMA",175,0)
 ;         STOP - order stop date (optional)
"RTN","PSJBCMA",176,0)
 N X
"RTN","PSJBCMA",177,0)
 I $G(PSJ("PREV")),$G(PSJ("FOLLOW")) I +PSJ("PREV")=+PSJ("FOLLOW") S (PSJ("PREV"),PSJ("FOLLOW"))=""
"RTN","PSJBCMA",178,0)
 I $G(DFN)]"",$G(ORD)]"",ORD["U",$P(^PS(55,DFN,5,+ORD,0),"^",7)'="R" Q $P(^PS(55,DFN,5,+ORD,0),"^",7)
"RTN","PSJBCMA",179,0)
 I $G(SCH)="" Q ""
"RTN","PSJBCMA",180,0)
 I SCH="TODAY"!(SCH="ONCE")!(SCH="NOW")!(SCH="ONE TIME")!(SCH="ONETIME")!(SCH="ONE-TIME")!(SCH="1TIME")!(SCH="1 TIME")!(SCH="1-TIME")!(SCH="STAT") Q "O"
"RTN","PSJBCMA",181,0)
 I $D(^PS(51.1,"AC","PSJ",SCH)) S X=$O(^(SCH,"")) S X=$P(^PS(51.1,X,0),"^",5) Q $S(X="D":"C",1:X)
"RTN","PSJBCMA",182,0)
 I $G(START)]"",$G(STOP)]"",START=STOP Q "O"
"RTN","PSJBCMA",183,0)
 Q ""
"RTN","PSJBCMA",184,0)
CLINIC(CL) ;
"RTN","PSJBCMA",185,0)
 I $P(CL,"^",2)?7N!($P(CL,"^",2)?7N1".".N) Q 1
"RTN","PSJBCMA",186,0)
 Q 0
"RTN","PSJBCMA",187,0)
CLINICS(CL) ;
"RTN","PSJBCMA",188,0)
 Q:'$$CLINIC(CL) 1
"RTN","PSJBCMA",189,0)
 Q:'$D(^PS(53.46,"B",+CL)) 1
"RTN","PSJBCMA",190,0)
 N A
"RTN","PSJBCMA",191,0)
 S A=$O(^PS(53.46,"B",+CL,"")) Q:'A 1
"RTN","PSJBCMA",192,0)
 Q $P(^PS(53.46,A,0),"^",4)
"RTN","PSJBCMA1")
0^3^B70492057^B70574949
"RTN","PSJBCMA1",1,0)
PSJBCMA1 ;BIR/MV-RETURN INFORMATION FOR AN ORDER ;16 Mar 99 / 10:59 AM
"RTN","PSJBCMA1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,58,81,91,104,186,159,173**;16 DEC 97;Build 4
"RTN","PSJBCMA1",3,0)
 ;
"RTN","PSJBCMA1",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA1",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA1",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA1",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA1",8,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA1",9,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA1",10,0)
 ; Reference to ^DIC is supported by DBIA 10006.
"RTN","PSJBCMA1",11,0)
 ; Reference to ^DIQ is supported by DBIA 2056.
"RTN","PSJBCMA1",12,0)
 ; Usage of this routine by BCMA is supported by DBIA 2829.
"RTN","PSJBCMA1",13,0)
 ;
"RTN","PSJBCMA1",14,0)
EN(DFN,ON,PSJTMP)         ; return detail data for Inpatient Meds.
"RTN","PSJBCMA1",15,0)
 NEW F,A
"RTN","PSJBCMA1",16,0)
 S PSJTMP=$S($G(PSJTMP)=1:"PSJ1",1:"PSJ")
"RTN","PSJBCMA1",17,0)
 I $G(ON)["U" S F="^PS(55,+$G(DFN),5,+ON" D:$D(@(F_")")) UDVAR
"RTN","PSJBCMA1",18,0)
 I $G(ON)["V" S F="^PS(55,+$G(DFN),""IV"",+ON" D:$D(@(F_")")) IVVAR
"RTN","PSJBCMA1",19,0)
 I $G(ON)["P" S F="^PS(53.1,+ON",X=$P($G(^PS(53.1,+ON,0)),U,4) D:$D(@(F_")")) @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA1",20,0)
 I '$D(^TMP(PSJTMP,$J,0)) S ^(0)=-1
"RTN","PSJBCMA1",21,0)
 Q
"RTN","PSJBCMA1",22,0)
 ;
"RTN","PSJBCMA1",23,0)
UDVAR ;* Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA1",24,0)
 NEW CNT,X
"RTN","PSJBCMA1",25,0)
 D UDPEND
"RTN","PSJBCMA1",26,0)
 D TMP
"RTN","PSJBCMA1",27,0)
 ;* Setup Dispense drug for ^TMP
"RTN","PSJBCMA1",28,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA1",29,0)
 F X=0:0 S X=$O(@(F_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA1",30,0)
 . S PSJDD=@(F_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA1",31,0)
 . S CNT=CNT+1
"RTN","PSJBCMA1",32,0)
 . S ^TMP(PSJTMP,$J,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((ON["U")&($P(PSJDD,U,2)=""):1,(ON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA1",33,0)
 S:CNT ^TMP(PSJTMP,$J,700,0)=CNT
"RTN","PSJBCMA1",34,0)
 K PSJ,PSJDD,PSJDN
"RTN","PSJBCMA1",35,0)
 Q
"RTN","PSJBCMA1",36,0)
IVVAR ;* Set variables for IV and pending orders
"RTN","PSJBCMA1",37,0)
 NEW CNT,DN,ND,X,Y
"RTN","PSJBCMA1",38,0)
 I ON["P" D UDPEND S PSJ("INFRATE")=$P($G(^PS(53.1,ON,8)),U,5)
"RTN","PSJBCMA1",39,0)
 I ON["V" D
"RTN","PSJBCMA1",40,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,0))
"RTN","PSJBCMA1",41,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA1",42,0)
 . S PSJ("PROVIDER")=$P(X,U,6)
"RTN","PSJBCMA1",43,0)
 . S PSJ("INFRATE")=$P(X,U,8),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA1",44,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA1",45,0)
 . S PSJ("FREQ")=$P(X,U,15),PSJ("IVTYPE")=$P(X,U,4)
"RTN","PSJBCMA1",46,0)
 . S PSJ("INSYR")=$P(X,U,5),PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA1",47,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,.2))
"RTN","PSJBCMA1",48,0)
 . S PSJ("OI")=$P(X,U),PSJ("DO")="",PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA1",49,0)
 . I PSJ("FLG") D
"RTN","PSJBCMA1",50,0)
 .. N S1,A,B,C
"RTN","PSJBCMA1",51,0)
 .. S S1="" F  S S1=$O(^PS(55,DFN,"IV",+ON,"A",S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,2),B=$P(C,U,4) Q:A="UG"  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA1",52,0)
 ... Q:A'="G"
"RTN","PSJBCMA1",53,0)
 ... S PSJ("SRC")=$S(B["FLAGGED BY PHARM":"PHARMACIST",B["FLAGGED BY CPRS":"CPRS",1:"")
"RTN","PSJBCMA1",54,0)
 ... S PSJ("COM")=$P(B," ",4,99)
"RTN","PSJBCMA1",55,0)
 . S PSJ("MR")=$P(X,U,3)
"RTN","PSJBCMA1",56,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,4))
"RTN","PSJBCMA1",57,0)
 . S PSJ("NURSE")=$P(X,U)
"RTN","PSJBCMA1",58,0)
 . S PSJ("PHARM")=$P(X,U,4)
"RTN","PSJBCMA1",59,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,2))
"RTN","PSJBCMA1",60,0)
 . S PSJ("LDT")=$P(X,U)
"RTN","PSJBCMA1",61,0)
 . S PSJ("PREV")=$P(X,U,5),PSJ("FOLLOW")=$P(X,U,6)
"RTN","PSJBCMA1",62,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA1",63,0)
 . N SCHD S SCHD=PSJ("SCHD")  ; SCHD var required to shorten $Select
"RTN","PSJBCMA1",64,0)
 . S PSJ("STC")=$$ONE^PSJBCMA(DFN,ON,SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA1",65,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA1",66,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S(SCHD["ON CALL":"OC",SCHD["ON-CALL":"OC",SCHD["ONCALL":"OC",1:"C")
"RTN","PSJBCMA1",67,0)
 . S PSJ("NURSE")=$P($G(^PS(55,DFN,"IV",+ON,4)),U)
"RTN","PSJBCMA1",68,0)
 D TMP
"RTN","PSJBCMA1",69,0)
 S X=$P($G(^PS(55,DFN,"IV",+ON,1)),U) S:X]"" ^TMP(PSJTMP,$J,6)=X
"RTN","PSJBCMA1",70,0)
 S CNT=0
"RTN","PSJBCMA1",71,0)
 F X=0:0 S X=$O(@(F_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA1",72,0)
 . S ND=$G(@(F_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0)) ;,AOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I AOINAME["NOTFOUND" S AOINAME=""
"RTN","PSJBCMA1",73,0)
 . ;S AOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I AOINAME="" S AOIDF=""
"RTN","PSJBCMA1",74,0)
 . S CNT=CNT+1,^TMP(PSJTMP,$J,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3) ;_U_U_$P(DN,U,11)_U_AOINAME_U_AOIDF
"RTN","PSJBCMA1",75,0)
 S:CNT ^TMP(PSJTMP,$J,850,0)=CNT,CNT=0
"RTN","PSJBCMA1",76,0)
 F X=0:0 S X=$O(@(F_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA1",77,0)
 . S ND=$G(@(F_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)) ;,SOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I SOINAME["NOTFOUND" S SOINAME=""
"RTN","PSJBCMA1",78,0)
 . ;S SOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I SOINAME="" S SOIDF=""
"RTN","PSJBCMA1",79,0)
 . S CNT=CNT+1,^TMP(PSJTMP,$J,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4) ;_U_U_$P(DN,U,11)_U_SOINAME_U_SOIDF
"RTN","PSJBCMA1",80,0)
 S:CNT ^TMP(PSJTMP,$J,950,0)=CNT
"RTN","PSJBCMA1",81,0)
 K PSJ
"RTN","PSJBCMA1",82,0)
 S X1=0
"RTN","PSJBCMA1",83,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA1",84,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:$P(XX,"^",2)'=+ON  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA1",85,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  S X=^(X2,0),^TMP(PSJTMP,$J,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA1",86,0)
 . I I>1 S ^TMP(PSJTMP,$J,800,PSJBCID,0)=I-1
"RTN","PSJBCMA1",87,0)
 . S X2=0
"RTN","PSJBCMA1",88,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  S X=^(X2,0),^TMP(PSJTMP,$J,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA1",89,0)
 . I I>1 S ^TMP(PSJTMP,$J,900,PSJBCID,0)=I-1
"RTN","PSJBCMA1",90,0)
 . S ^TMP(PSJTMP,$J,1000,PSJBCID)=$P(XX,"^",6)_"^"_$P(XX,"^",8)_"^"_$P(XX,"^",7)
"RTN","PSJBCMA1",91,0)
 Q
"RTN","PSJBCMA1",92,0)
UDPEND ;
"RTN","PSJBCMA1",93,0)
 S X=$G(@(F_",0)"))
"RTN","PSJBCMA1",94,0)
 S PSJ("PROVIDER")=$P(X,U,2)
"RTN","PSJBCMA1",95,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA1",96,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA1",97,0)
 S PSJ("LDT")=$P(X,U,16)
"RTN","PSJBCMA1",98,0)
 S:ON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA1",99,0)
 S PSJ("SMYN")=$S(+PSJ("SM"):"YES",1:"NO")
"RTN","PSJBCMA1",100,0)
 S PSJ("HSMYN")=$S(+PSJ("HSM"):"YES",1:"NO")
"RTN","PSJBCMA1",101,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26)
"RTN","PSJBCMA1",102,0)
 S X=$G(@(F_",.2)"))
"RTN","PSJBCMA1",103,0)
 S PSJ("OI")=$P(X,U),PSJ("DO")=$P(X,U,2),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA1",104,0)
 I PSJ("FLG") D
"RTN","PSJBCMA1",105,0)
 . N S1,A,B,C
"RTN","PSJBCMA1",106,0)
 . S S1="" F  S S1=$O(^PS(55,DFN,5,+ON,9,S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,3),B=$P(C,U,4) Q:A=7010!(A=7030)  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA1",107,0)
 .. Q:A'=7000&(A'=7020)
"RTN","PSJBCMA1",108,0)
 .. S PSJ("SRC")=$S(A=7000:"PHARMACIST",A=7020:"CPRS",1:"")
"RTN","PSJBCMA1",109,0)
 .. S PSJ("COM")=$G(@(F_",13)"))
"RTN","PSJBCMA1",110,0)
 S X=$G(@(F_",2)"))
"RTN","PSJBCMA1",111,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA1",112,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA1",113,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P","^ONCALL^ON-CALL^ON CALL^"[("^"_PSJ("SCHD")_"^"):"OC",$$ONE^PSJBCMA(DFN,ON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA1",114,0)
 I PSJ("STC")="O" S PSJ("ST")="O"
"RTN","PSJBCMA1",115,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA1",116,0)
 S PSJ("FREQ")=$P(X,U,6)
"RTN","PSJBCMA1",117,0)
 S X=$G(@(F_",4)"))
"RTN","PSJBCMA1",118,0)
 S PSJ("NURSE")=$P(X,U),PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA1",119,0)
 S:ON["U" PSJ("PHARM")=+$P(X,U,3)
"RTN","PSJBCMA1",120,0)
 ; the naked reference on the line below refers to the full reference created by indirect reference to F, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA1",121,0)
 S PSJ("SIOPI")=$S($P($G(@(F_",6)")),"^",2)&($P($G(@(F_",6)")),"^")'=""):"!",1:"")_$$ENSET^PSJBCMA($P($G(^(6)),"^"))
"RTN","PSJBCMA1",122,0)
 NEW FON S FON=ON D SIOPI^PSJBCMA
"RTN","PSJBCMA1",123,0)
 Q 
"RTN","PSJBCMA1",124,0)
 ;
"RTN","PSJBCMA1",125,0)
TMP ;* Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA1",126,0)
 D NAME(PSJ("PROVIDER"),.PSJNAME,"","")
"RTN","PSJBCMA1",127,0)
 S PSJ("PRONAME")=PSJNAME K PSJNAME
"RTN","PSJBCMA1",128,0)
 I $D(PSJ("PHARM")) D
"RTN","PSJBCMA1",129,0)
 . D NAME(PSJ("PHARM"),.PSJNAME,.PSJINIT,.PSJPIEN)
"RTN","PSJBCMA1",130,0)
 . S PSJ("PHARM")=PSJPIEN,PSJ("PNAME")=PSJNAME,PSJ("PINIT")=PSJINIT K PSJNAME,PSJINIT,PSJPIEN
"RTN","PSJBCMA1",131,0)
 I +PSJ("NURSE") D
"RTN","PSJBCMA1",132,0)
 . D NAME(PSJ("NURSE"),.PSJNAME,.PSJINIT,"")
"RTN","PSJBCMA1",133,0)
 . S PSJ("NNAME")=PSJNAME,PSJ("NINIT")=PSJINIT K PSJNAME,PSJINIT
"RTN","PSJBCMA1",134,0)
 S A=$G(^PS(51.2,+PSJ("MR"),0)),PSJ("MRNM")=$P(A,U),PSJ("MRABB")=$P(A,U,3),PSJ("MRPIJ")=$P(A,U,8),PSJ("MRIVP")=$P(A,U,9)
"RTN","PSJBCMA1",135,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA1",136,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA1",137,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA1",138,0)
 S PSJ("LDTN")=$$DATE(PSJ("LDT"))
"RTN","PSJBCMA1",139,0)
 S PSJ("STARTDTN")=$$DATE(PSJ("STARTDT"))
"RTN","PSJBCMA1",140,0)
 S PSJ("STOPDTN")=$$DATE(PSJ("STOPDT"))
"RTN","PSJBCMA1",141,0)
 S X=$S(ON["V":PSJ("STC"),1:PSJ("ST"))
"RTN","PSJBCMA1",142,0)
 S PSJ("STNAME")=$S(X="C":"CONTINUOUS",X="O":"ONE TIME",X="P":"PRN",X="R":"FILL ON REQUEST",X="OC":"ON CALL",1:"NOT FOUND")
"RTN","PSJBCMA1",143,0)
 ;
"RTN","PSJBCMA1",144,0)
 S ^TMP(PSJTMP,$J,0)=DFN_U_+ON_U_ON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")
"RTN","PSJBCMA1",145,0)
 S ^TMP(PSJTMP,$J,1)=PSJ("PROVIDER")_U_PSJ("PRONAME")_U_PSJ("MR")_U_PSJ("MRABB")_U_$G(PSJ("SM"))_U_$G(PSJ("SMYN"))_U_$G(PSJ("HSM"))_U_$G(PSJ("HSMYN"))_U_$G(PSJ("NGIVEN"))_U_PSJ("STATUS")
"RTN","PSJBCMA1",146,0)
 S ^TMP(PSJTMP,$J,1)=^TMP(PSJTMP,$J,1)_U_$$STATUS(ON,PSJ("STATUS"))_U_$G(PSJ("AUTO"))_U_$G(PSJ("MRNM"))
"RTN","PSJBCMA1",147,0)
 S ^TMP(PSJTMP,$J,1,0)=PSJ("MRPIJ")_U_$G(PSJ("MRIVP"))
"RTN","PSJBCMA1",148,0)
 S ^TMP(PSJTMP,$J,2)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("DO")_U_$G(PSJ("INFRATE"))_U_$G(PSJ("SCHD"))_U_PSJ("OIDF")
"RTN","PSJBCMA1",149,0)
 S ^TMP(PSJTMP,$J,3)=PSJ("SIOPI")
"RTN","PSJBCMA1",150,0)
 S ^TMP(PSJTMP,$J,4)=PSJ("STC")_U_$G(PSJ("STNAME"))_U_PSJ("LDT")_U_PSJ("LDTN")_U_PSJ("STARTDT")_U_PSJ("STARTDTN")_U_PSJ("STOPDT")_U_PSJ("STOPDTN")_U_$$ADMIN(PSJ("ADM"))_U_$G(PSJ("ST"))_U_$G(PSJ("FREQ"))
"RTN","PSJBCMA1",151,0)
 S ^TMP(PSJTMP,$J,5)=$G(PSJ("NURSE"))_U_$G(PSJ("NNAME"))_U_$G(PSJ("NINIT"))_U_$G(PSJ("PHARM"))_U_$G(PSJ("PNAME"))_U_$G(PSJ("PINIT"))
"RTN","PSJBCMA1",152,0)
 S A=$$SNDTSTA^PSJHL4A(PSJ("PRI"),PSJ("SCHD"))
"RTN","PSJBCMA1",153,0)
 S ^TMP(PSJTMP,$J,7)=$S(A=1:0,1:1)_U_PSJ("FLG")_U_PSJ("SRC")_U_PSJ("COM")
"RTN","PSJBCMA1",154,0)
 Q
"RTN","PSJBCMA1",155,0)
 ;
"RTN","PSJBCMA1",156,0)
NAME(X,NAME,INIT,IEN)  ;Lookup in ^VA(200.
"RTN","PSJBCMA1",157,0)
 ;X = IEN or Name in ^VA(200
"RTN","PSJBCMA1",158,0)
 ;IEN = Return IEN in ^VA(200
"RTN","PSJBCMA1",159,0)
 ;NAME = Return the name in 200
"RTN","PSJBCMA1",160,0)
 ;INIT = Return the initial
"RTN","PSJBCMA1",161,0)
 NEW DIC,Y
"RTN","PSJBCMA1",162,0)
 S DIC="^VA(200,",DIC(0)="NZ" D ^DIC
"RTN","PSJBCMA1",163,0)
 S IEN=+Y
"RTN","PSJBCMA1",164,0)
 S NAME=$G(Y(0,0))
"RTN","PSJBCMA1",165,0)
 S INIT=$P($G(Y(0)),U,2)
"RTN","PSJBCMA1",166,0)
 Q
"RTN","PSJBCMA1",167,0)
 ;
"RTN","PSJBCMA1",168,0)
DATE(Y) ; FM internal date/time to user readable, 4 digit year
"RTN","PSJBCMA1",169,0)
 ; Y - date in FileMan internal format
"RTN","PSJBCMA1",170,0)
 I $G(Y) S Y=Y_$E(".",Y'[".")_"0000" Q $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_($E(Y,1,3)+1700)_"  "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSJBCMA1",171,0)
 Q "********"
"RTN","PSJBCMA1",172,0)
 ;
"RTN","PSJBCMA1",173,0)
STATUS(ON,X)          ;
"RTN","PSJBCMA1",174,0)
 ; ON = IEN_"I/U/P"
"RTN","PSJBCMA1",175,0)
 ; X  = STATUS
"RTN","PSJBCMA1",176,0)
 I X="P" Q $S(ON["P":"PENDING",ON["V":"PURGE",1:"NOT FOUND")
"RTN","PSJBCMA1",177,0)
 Q $S(X="A":"ACTIVE",X="D":"DISCONTINUED",X="E":"EXPIRED",X="H":"HOLD",X="R":"RENEWED",X="RE":"REINSTATED",X="N":"NON-VERFIED",X="DE":"DISCONTINUED (EDIT)",X="O":"ON CALL",1:"NOT FOUND")
"RTN","PSJBCMA1",178,0)
 ;
"RTN","PSJBCMA1",179,0)
ADMIN(X) ;
"RTN","PSJBCMA1",180,0)
 NEW Y,PSJADM,PSJX S PSJADM=""
"RTN","PSJBCMA1",181,0)
 I X="" Q ""
"RTN","PSJBCMA1",182,0)
 F Y=1:1:$L(X,"-") S PSJX=$E($P(X,"-",Y)_"0000",1,4) D
"RTN","PSJBCMA1",183,0)
 . S PSJADM=PSJADM_$S(PSJADM]"":"-",1:"")_PSJX
"RTN","PSJBCMA1",184,0)
 Q PSJADM
"RTN","PSJBCMA1",185,0)
 ;
"RTN","PSJHL5")
0^4^B30798054^B31745316
"RTN","PSJHL5",1,0)
PSJHL5 ;BIR/LDT-ACTIONS ON HL7 MESSAGES FROM OE/RR ;28 Jan 98 / 3:34 PM
"RTN","PSJHL5",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**1,28,39,40,42,84,85,95,80,173**;16 DEC 97;Build 4
"RTN","PSJHL5",3,0)
 ;
"RTN","PSJHL5",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL5",5,0)
 ; Reference to EN^ORERR is supported by DBIA# 2187.
"RTN","PSJHL5",6,0)
 ; Reference to NURV^ALPBCBU is supported by DBIA# 4120.
"RTN","PSJHL5",7,0)
 ;
"RTN","PSJHL5",8,0)
ASSIGN ; number assigned, update ORDERS FILE ENTRY
"RTN","PSJHL5",9,0)
 S RXORDER=RXORDER_"0)"
"RTN","PSJHL5",10,0)
 I '$P($G(@RXORDER),U) S ORDCON="Invalid Pharmacy order number/Number Assign Msg" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG) Q
"RTN","PSJHL5",11,0)
 Q:'$P($G(@RXORDER),U)
"RTN","PSJHL5",12,0)
 I RXON["P",PSJHLDFN'=$P($G(@(RXORDER)),U,15) S ORDCON="Patient does not match/Number Assign Msg" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG) Q
"RTN","PSJHL5",13,0)
 I RXON["P",PSJHLDFN'=$P($G(@(RXORDER)),U,15) Q
"RTN","PSJHL5",14,0)
 S $P(@RXORDER,"^",21)=PSJORDER
"RTN","PSJHL5",15,0)
 Q
"RTN","PSJHL5",16,0)
 ;
"RTN","PSJHL5",17,0)
NURSEACK ;Nurse Acknowledgement of Pending Orders
"RTN","PSJHL5",18,0)
 I '$P($G(@(RXORDER_"0)")),U) S ORDCON="Invalid Pharmacy order number/Nurse Acknowledgement Msg" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG) Q
"RTN","PSJHL5",19,0)
 Q:'$P($G(@(RXORDER_"0)")),U)
"RTN","PSJHL5",20,0)
 I RXON["P",PSJHLDFN'=$P($G(@(RXORDER_"0)")),U,15) S ORDCON="Patient does not match/Nurse Acknowledgement Msg" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG) Q
"RTN","PSJHL5",21,0)
 I RXON["P",PSJHLDFN'=$P($G(@(RXORDER_"0)")),U,15) Q
"RTN","PSJHL5",22,0)
 I RXON["P" N STATUS S STATUS=$P($G(@(RXORDER_"0)")),U,9) D:STATUS="N" EN^PSJHLV(PSJHLDFN,RXON)
"RTN","PSJHL5",23,0)
 I RXON["P" N STATUS S STATUS=$P($G(@(RXORDER_"0)")),U,9) Q:STATUS="A"
"RTN","PSJHL5",24,0)
 N DIE,DA
"RTN","PSJHL5",25,0)
 S DIE=$S(RXON["N"!(RXON["P"):"^PS(53.1,",RXON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,"),DA=+RXON,DA(1)=PSJHLDFN
"RTN","PSJHL5",26,0)
 S DR="16////"_NURSEACK_";17////"_ACKDATE S:RXON["U" DR=DR_";51////1" S:RXON["V" DR=DR_";143////1",PSIVACT=""
"RTN","PSJHL5",27,0)
 I RXON["U" D NEWUDAL^PSGAL5(PSJHLDFN,RXON,22010)
"RTN","PSJHL5",28,0)
 I RXON["P" D NEWNVAL^PSGAL5(RXON,22010)
"RTN","PSJHL5",29,0)
 S PSGNVF=1 D ^DIE
"RTN","PSJHL5",30,0)
 I RXON["V" NEW ON55,DFN,PSIVAL,PSIVREA,PSIVLN K PSIVACT D
"RTN","PSJHL5",31,0)
 . S ON55=RXON,DFN=PSJHLDFN,PSIVAL="ORDER VERIFIED BY NURSE",PSIVALT="",PSIVREA="V"
"RTN","PSJHL5",32,0)
 . D LOG^PSIVORAL
"RTN","PSJHL5",33,0)
 D:RXON["P" EN^PSJLOI(PSJHLDFN,RXON) D:RXON["U" EN2^PSJLOI(PSJHLDFN,RXON)
"RTN","PSJHL5",34,0)
 K:RXON["U" ^PS(55,"ANV",PSJHLDFN,+RXON)
"RTN","PSJHL5",35,0)
 I $T(NURV^ALPBCBU)'="" D NURV^ALPBCBU(PSJHLDFN,RXON)
"RTN","PSJHL5",36,0)
 Q
"RTN","PSJHL5",37,0)
 ;
"RTN","PSJHL5",38,0)
EDIT ;Edit orders thru OE/RR
"RTN","PSJHL5",39,0)
 N DA,DR,DIE,PREORDER,STPDT,PSIVACT,PSIVALT,ON55,PSIVREA,PSIVALCK,P
"RTN","PSJHL5",40,0)
 S PREORDER=$S((PREON["N")!(PREON["P"):"^PS(53.1,"_+PREON_",2)",PREON["V":"^PS(55,"_PSJHLDFN_",""IV"","_+PREON_",0)",1:"^PS(55,"_PSJHLDFN_",5,"_+PREON_",2)")
"RTN","PSJHL5",41,0)
 S STPDT=$S(PREON["V":$P($G(@PREORDER),"^",3),1:$P($G(@PREORDER),"^",4))
"RTN","PSJHL5",42,0)
 D NOW^%DTC
"RTN","PSJHL5",43,0)
 S DIE=$S(PREON["N"!(PREON["P"):"^PS(53.1,",PREON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,"),DA=+PREON,DA(1)=+PSJHLDFN
"RTN","PSJHL5",44,0)
 S DR=$S(PREON["V":"100////D;116////^S X=STPDT;123////E;114////"_PSJORDER_";.03////"_%,((PREON["P")!(PREON["N")):"25////"_%_";28////DE;107////E;105////"_PSJORDER_";32////"_STPDT,1:"25////"_STPDT_";28////DE;107////E;105////"_PSJORDER_";34////"_%)
"RTN","PSJHL5",45,0)
 I PREON["U"!(PREON["A") S PSGAL("C")=4100 D ^PSGAL5
"RTN","PSJHL5",46,0)
 I PREON["V" S PSIVACT=1,PSIVALT=2,ON55=PREON,PSIVREA="D",PSIVALCK="STOP",P(3)=STPDT
"RTN","PSJHL5",47,0)
 D ^DIE,AUE^PSJHL6(PSJHLDFN,PREON)
"RTN","PSJHL5",48,0)
 I PREON["V" N DFN S DFN=PSJHLDFN D LOG^PSIVORAL
"RTN","PSJHL5",49,0)
 S PSJHLMTN="ORM",PSOC=$S((PREON["N")!(PREON["P"):"OC",1:"OD") D EN1^PSJHL2(PSJHLDFN,PSOC,PREON) S PSJHLMTN="ORR",PSOC="XO"
"RTN","PSJHL5",50,0)
 Q
"RTN","PSJHL5",51,0)
 ;
"RTN","PSJHL5",52,0)
EDITCK ;Check to see if PSJHLDFN passed matches PSJHLDFN in pending order.
"RTN","PSJHL5",53,0)
 I (PREON["N")!(PREON["P"),PSJHLDFN'=$P($G(^PS(53.1,+PREON,0)),U,15) D
"RTN","PSJHL5",54,0)
 . S ORDCON="Patient does not match/Edit Msg" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG)
"RTN","PSJHL5",55,0)
 . D EN1^PSJHLERR(PSJHLDFN,"UX",$P(ORDER,"^"),ORDCON) S QFLG=1
"RTN","PSJHL5",56,0)
 Q
"RTN","PSJHL5",57,0)
 ;        
"RTN","PSJHL5",58,0)
STATUS ;Check status of an order in response to a send order status request from CPRS.
"RTN","PSJHL5",59,0)
 N STATUS,STPDT,NODE,NODE2
"RTN","PSJHL5",60,0)
 S NODE=$G(@(RXORDER_"0)")),NODE2=$G(@(RXORDER_"2)"))
"RTN","PSJHL5",61,0)
 I 'NODE S PSREASON="Invalid Pharmacy order number" D  Q
"RTN","PSJHL5",62,0)
 .S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON_"/Status Check",.PSJMSG)
"RTN","PSJHL5",63,0)
 .D EN1^PSJHLERR(PSJHLDFN,"DE",$P(ORDER,U),PSREASON)
"RTN","PSJHL5",64,0)
 S $P(@(RXORDER_"0)"),"^",21)=$P(ORDER,"^")
"RTN","PSJHL5",65,0)
 S STATUS=$S(RXON["V":$P(NODE,"^",17),1:$P(NODE,"^",9))
"RTN","PSJHL5",66,0)
 S STPDT=$S(RXON["V":$P(NODE,"^",3),1:$P(NODE2,"^",4))
"RTN","PSJHL5",67,0)
 D NOW^%DTC I RXON'["P" I "DEH"'[STATUS I STPDT<% D EXPIR^PSJHL6 Q
"RTN","PSJHL5",68,0)
 D EN1^PSJHL2(PSJHLDFN,"SC",RXON)
"RTN","PSJHL5",69,0)
 Q
"RTN","PSJHL5",70,0)
 ;
"RTN","PSJHL5",71,0)
FLAG ;Flag/Unflag orders
"RTN","PSJHL5",72,0)
 I '$P($G(@(RXORDER_"0)")),U) S ORDCON="Invalid Pharmacy order number/Flag Msg" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG) Q
"RTN","PSJHL5",73,0)
 Q:'$P($G(@(RXORDER_"0)")),U)
"RTN","PSJHL5",74,0)
 S DIE=$S(RXON["N"!(RXON["P"):"^PS(53.1,",RXON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,"),DA=+RXON,DA(1)=PSJHLDFN
"RTN","PSJHL5",75,0)
 S DR=$S(PSJFLAG="FL":$S(RXON["V":"148////1",1:"124////1"),1:$S(RXON["V":"148////@",1:"124////@"))
"RTN","PSJHL5",76,0)
 D ^DIE
"RTN","PSJHL5",77,0)
 I RXON["U" D
"RTN","PSJHL5",78,0)
 . S ^PS(55,PSJHLDFN,5,+RXON,13)=FLCMNT
"RTN","PSJHL5",79,0)
 . S FLCMNT="COMMENTS: "_FLCMNT S:$L(FLCMNT)>52 FLCMNT=$E(FLCMNT,1,49)_"..."
"RTN","PSJHL5",80,0)
 . D NEWUDAL^PSGAL5(PSJHLDFN,+RXON,$S((PSJFLAG="FL")&(PSJYN="PHR"):7000,(PSJFLAG="UF")&(PSJYN="PHR"):7010,(PSJFLAG="FL")&(PSJYN=""):7020,1:7030),FLCMNT)
"RTN","PSJHL5",81,0)
 I RXON["V" N DFN,ON55,PSIVREA,PSIVAL S DFN=PSJHLDFN S PSIVALT="",ON55=RXON,PSIVREA=$S(PSJFLAG="FL":"G",1:"UG"),PSIVAL=$S(PSJYN="PHR":"FLAGGED BY PHARMICIST ",1:"FLAGGED BY CPRS ")_FLCMNT D LOG^PSIVORAL
"RTN","PSJHL5",82,0)
 I RXON["P" D
"RTN","PSJHL5",83,0)
 . S ^PS(53.1,+RXON,13)=FLCMNT
"RTN","PSJHL5",84,0)
 . S FLCMNT="COMMENTS: "_FLCMNT S:$L(FLCMNT)>52 FLCMNT=$E(FLCMNT,1,49)_"..."
"RTN","PSJHL5",85,0)
 . D NEWNVAL^PSGAL5(+RXON,$S((PSJFLAG="FL")&(PSJYN="PHR"):7000,(PSJFLAG="UF")&(PSJYN="PHR"):7010,(PSJFLAG="FL")&(PSJYN=""):7020,1:7030),FLCMNT)
"RTN","PSJHL5",86,0)
 ;The ... on Unit Dose and Pending orders is because of the limitations in the DD of 53.1.
"RTN","PSJHL5",87,0)
 Q
"VER")
8.0^22.0
"^DD",53.1,53.1,129,0)
MOST RECENT FLAG COMMENT^F^^13;1^K:$L(X)>80!($L(X)<1) X
"^DD",53.1,53.1,129,3)
Answer must be 1-80 characters in length
"^DD",53.1,53.1,129,"DT")
3070730
"BLD",5679,6)
^176
**END**
**END**
