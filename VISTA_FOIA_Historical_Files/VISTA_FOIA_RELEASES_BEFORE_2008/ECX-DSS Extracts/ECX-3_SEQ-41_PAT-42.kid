Released ECX*3*42 SEQ #41
Extracted from mail message
**KIDS**:ECX*3.0*42^

**INSTALL NAME**
ECX*3.0*42
"BLD",3468,0)
ECX*3.0*42^DSS EXTRACTS^0^3020405^y
"BLD",3468,1,0)
^^2^2^3020328^^
"BLD",3468,1,1,0)
Please see the patch description in the NPM for complete details of this
"BLD",3468,1,2,0)
patch.
"BLD",3468,4,0)
^9.64PA^^
"BLD",3468,"INIT")
POST^ECX342P
"BLD",3468,"KRN",0)
^9.67PA^8989.52^19
"BLD",3468,"KRN",.4,0)
.4
"BLD",3468,"KRN",.401,0)
.401
"BLD",3468,"KRN",.402,0)
.402
"BLD",3468,"KRN",.403,0)
.403
"BLD",3468,"KRN",.5,0)
.5
"BLD",3468,"KRN",.84,0)
.84
"BLD",3468,"KRN",3.6,0)
3.6
"BLD",3468,"KRN",3.8,0)
3.8
"BLD",3468,"KRN",9.2,0)
9.2
"BLD",3468,"KRN",9.8,0)
9.8
"BLD",3468,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",3468,"KRN",9.8,"NM",1,0)
ECXMOV^^0^B15735113
"BLD",3468,"KRN",9.8,"NM",2,0)
ECXLABN^^0^B23448448
"BLD",3468,"KRN",9.8,"NM",3,0)
ECXSURG^^0^B34041117
"BLD",3468,"KRN",9.8,"NM",4,0)
ECXUTL3^^0^B51859947
"BLD",3468,"KRN",9.8,"NM","B","ECXLABN",2)

"BLD",3468,"KRN",9.8,"NM","B","ECXMOV",1)

"BLD",3468,"KRN",9.8,"NM","B","ECXSURG",3)

"BLD",3468,"KRN",9.8,"NM","B","ECXUTL3",4)

"BLD",3468,"KRN",19,0)
19
"BLD",3468,"KRN",19.1,0)
19.1
"BLD",3468,"KRN",101,0)
101
"BLD",3468,"KRN",409.61,0)
409.61
"BLD",3468,"KRN",771,0)
771
"BLD",3468,"KRN",870,0)
870
"BLD",3468,"KRN",8989.51,0)
8989.51
"BLD",3468,"KRN",8989.52,0)
8989.52
"BLD",3468,"KRN",8994,0)
8994
"BLD",3468,"KRN","B",.4,.4)

"BLD",3468,"KRN","B",.401,.401)

"BLD",3468,"KRN","B",.402,.402)

"BLD",3468,"KRN","B",.403,.403)

"BLD",3468,"KRN","B",.5,.5)

"BLD",3468,"KRN","B",.84,.84)

"BLD",3468,"KRN","B",3.6,3.6)

"BLD",3468,"KRN","B",3.8,3.8)

"BLD",3468,"KRN","B",9.2,9.2)

"BLD",3468,"KRN","B",9.8,9.8)

"BLD",3468,"KRN","B",19,19)

"BLD",3468,"KRN","B",19.1,19.1)

"BLD",3468,"KRN","B",101,101)

"BLD",3468,"KRN","B",409.61,409.61)

"BLD",3468,"KRN","B",771,771)

"BLD",3468,"KRN","B",870,870)

"BLD",3468,"KRN","B",8989.51,8989.51)

"BLD",3468,"KRN","B",8989.52,8989.52)

"BLD",3468,"KRN","B",8994,8994)

"BLD",3468,"PRE")
ECX342P
"BLD",3468,"QUES",0)
^9.62^^
"BLD",3468,"REQB",0)
^9.611^2^2
"BLD",3468,"REQB",1,0)
ECX*3.0*41^2
"BLD",3468,"REQB",2,0)
ECX*3.0*39^2
"BLD",3468,"REQB","B","ECX*3.0*39",2)

"BLD",3468,"REQB","B","ECX*3.0*41",1)

"INIT")
POST^ECX342P
"MBREQ")
0
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010109^3010108^100867
"PKG",513,22,1,"PAH",1,0)
42^3020405
"PKG",513,22,1,"PAH",1,1,0)
^^2^2^3020405
"PKG",513,22,1,"PAH",1,1,1,0)
Please see the patch description in the NPM for complete details of this
"PKG",513,22,1,"PAH",1,1,2,0)
patch.
"PRE")
ECX342P
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","ECX342P")
0^^B8989969
"RTN","ECX342P",1,0)
ECX342P ;ALB/ESD - Patch ECX*3.0*40 Post-Install Utility Routine ; 01/24/02
"RTN","ECX342P",2,0)
 ;;3.0;DSS EXTRACTS;**42**;Dec 22, 1997
"RTN","ECX342P",3,0)
 ;
"RTN","ECX342P",4,0)
 ;
"RTN","ECX342P",5,0)
ENV ;- Main entry point for environment check
"RTN","ECX342P",6,0)
 ;
"RTN","ECX342P",7,0)
 S XPDABORT=""
"RTN","ECX342P",8,0)
 ;
"RTN","ECX342P",9,0)
 ;- Checks programmer variables
"RTN","ECX342P",10,0)
 D PROGCHK(.XPDABORT)
"RTN","ECX342P",11,0)
 I XPDABORT="" K XPDABORT
"RTN","ECX342P",12,0)
 Q
"RTN","ECX342P",13,0)
 ;
"RTN","ECX342P",14,0)
 ;
"RTN","ECX342P",15,0)
PRE ;- Main entry point for pre-init items
"RTN","ECX342P",16,0)
 Q
"RTN","ECX342P",17,0)
 ;
"RTN","ECX342P",18,0)
 ;
"RTN","ECX342P",19,0)
POST ;- Main entry point for post-init items
"RTN","ECX342P",20,0)
 ;
"RTN","ECX342P",21,0)
 ;- Add new entries to DSS PRODUCTION UNIT (#729) file
"RTN","ECX342P",22,0)
 D POST1
"RTN","ECX342P",23,0)
 Q
"RTN","ECX342P",24,0)
 ;
"RTN","ECX342P",25,0)
 ;
"RTN","ECX342P",26,0)
PROGCHK(XPDABORT) ;Checks for necessary programmer variables
"RTN","ECX342P",27,0)
 ;
"RTN","ECX342P",28,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^") D
"RTN","ECX342P",29,0)
 .D BMES^XPDUTL("******** ERROR ********")
"RTN","ECX342P",30,0)
 .D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","ECX342P",31,0)
 .D MES^XPDUTL("Installation aborted.")
"RTN","ECX342P",32,0)
 .D MES^XPDUTL("************************")
"RTN","ECX342P",33,0)
 .S XPDABORT=2
"RTN","ECX342P",34,0)
 Q
"RTN","ECX342P",35,0)
 ;
"RTN","ECX342P",36,0)
 ;
"RTN","ECX342P",37,0)
POST1 ;
"RTN","ECX342P",38,0)
 ;
"RTN","ECX342P",39,0)
 ;- This procedure will add new entries to the DSS PRODUCTION UNIT
"RTN","ECX342P",40,0)
 ;  (#729) file.
"RTN","ECX342P",41,0)
 ;
"RTN","ECX342P",42,0)
 N ECXFDA,ECXERR,ECXCODE,ECXREC,I
"RTN","ECX342P",43,0)
 ;
"RTN","ECX342P",44,0)
 D BMES^XPDUTL(">>> Updating DSS PRODUCTION UNIT (#729) file...")
"RTN","ECX342P",45,0)
 S $P(^DD(729,.01,0),U,5)=""
"RTN","ECX342P",46,0)
 ;
"RTN","ECX342P",47,0)
 ;- Get DSS Production Unit text
"RTN","ECX342P",48,0)
 F I=1:1 S ECXREC=$P($T(PROUNIT+I),";;",2) Q:ECXREC="QUIT"  D
"RTN","ECX342P",49,0)
 .;
"RTN","ECX342P",50,0)
 .;- Production Unit code
"RTN","ECX342P",51,0)
 .S ECXCODE=$P(ECXREC,"^")
"RTN","ECX342P",52,0)
 .;
"RTN","ECX342P",53,0)
 .;- Quit w/error message if entry already exists in file #729
"RTN","ECX342P",54,0)
 .I $$FIND1^DIC(729,"","X",ECXCODE) D  Q
"RTN","ECX342P",55,0)
 ..D BMES^XPDUTL(">>>...."_ECXCODE_"  "_$P(ECXREC,U,2)_" not added, entry already exists.")
"RTN","ECX342P",56,0)
 ..D MES^XPDUTL(">>>        Delete entry and reinstall patch if this entry was not created by a")
"RTN","ECX342P",57,0)
 ..D MES^XPDUTL(">>>        previous installation of this patch.")
"RTN","ECX342P",58,0)
 .;
"RTN","ECX342P",59,0)
 .;- Setup field values of new entry
"RTN","ECX342P",60,0)
 .S ECXFDA(729,"+1,",.01)=ECXCODE
"RTN","ECX342P",61,0)
 .S ECXFDA(729,"+1,",1)=$P(ECXREC,"^",2)
"RTN","ECX342P",62,0)
 .S ECXFDA(729,"+1,",2)=$P(ECXREC,"^",3)
"RTN","ECX342P",63,0)
 .;
"RTN","ECX342P",64,0)
 .;- Add new entry to file #729
"RTN","ECX342P",65,0)
 .D UPDATE^DIE("E","ECXFDA","","ECXERR")
"RTN","ECX342P",66,0)
 .;
"RTN","ECX342P",67,0)
 .I '$D(ECXERR) D BMES^XPDUTL(">>>...."_ECXCODE_"  "_$P(ECXREC,U,2)_" added to file.")
"RTN","ECX342P",68,0)
 .I $D(ECXERR) D BMES^XPDUTL(">>>....Unable to add "_ECXCODE_"  "_$P(ECXREC,U,2)_" to file.")
"RTN","ECX342P",69,0)
 ;
"RTN","ECX342P",70,0)
 D BMES^XPDUTL(">>> Update completed.")
"RTN","ECX342P",71,0)
 S $P(^DD(729,.01,0),U,5)="K X"
"RTN","ECX342P",72,0)
 ;
"RTN","ECX342P",73,0)
 Q
"RTN","ECX342P",74,0)
 ;
"RTN","ECX342P",75,0)
 ;
"RTN","ECX342P",76,0)
PROUNIT ;- Contains the DSS Production Units to be added
"RTN","ECX342P",77,0)
 ;;24^Geropsych Ward 2^GERPSYWRD2
"RTN","ECX342P",78,0)
 ;;25^Geropsych Ward 3^GERPSYWRD3
"RTN","ECX342P",79,0)
 ;;26^Geropsych Ward 4^GERPSYWRD4
"RTN","ECX342P",80,0)
 ;;27^Geropsych Ward 5^GERPSYWRD5
"RTN","ECX342P",81,0)
 ;;QUIT
"RTN","ECXLABN")
0^2^B23448448
"RTN","ECXLABN",1,0)
ECXLABN ;ALB/JAP,BIR/CML-Lab Extract for DSS (New Format - With LMIP Codes) ; [ 11/22/96  5:14 PM ]
"RTN","ECXLABN",2,0)
 ;;3.0;DSS EXTRACTS;**1,11,8,13,28,24,30,31,32,33,39,42**;Dec 22, 1997
"RTN","ECXLABN",3,0)
BEG ;entry point
"RTN","ECXLABN",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXLABN",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXLABN",6,0)
 Q
"RTN","ECXLABN",7,0)
 ;
"RTN","ECXLABN",8,0)
START ; entry when queued
"RTN","ECXLABN",9,0)
 K ^LRO(64.03),^TMP($J,"ECXP")
"RTN","ECXLABN",10,0)
 S LRSDT=ECSD,LREDT=ECED,QFLG=0
"RTN","ECXLABN",11,0)
 D ^LRCAPDSS
"RTN","ECXLABN",12,0)
 ;quit if no completion date for API compile
"RTN","ECXLABN",13,0)
 I '$P($G(^LRO(64.03,1,1,1,0)),U,4) Q
"RTN","ECXLABN",14,0)
 ;quit if tasked and user sends stop request
"RTN","ECXLABN",15,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD D  Q
"RTN","ECXLABN",16,0)
 .S QFLG=1
"RTN","ECXLABN",17,0)
 .K ^LRO(64.03) S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",18,0)
 ;otherwise, continue
"RTN","ECXLABN",19,0)
 K ECXDD D FIELD^DID(64.03,1,,"SPECIFIER","ECXDD")
"RTN","ECXLABN",20,0)
 S ECPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)),ECLRN=1 K ECXDD
"RTN","ECXLABN",21,0)
 F  S ECLRN=$O(^LRO(64.03,ECLRN)) Q:'ECLRN  D  Q:QFLG
"RTN","ECXLABN",22,0)
 .Q:'$D(^LRO(64.03,ECLRN,0))
"RTN","ECXLABN",23,0)
 .S EC1=^LRO(64.03,ECLRN,0),ECDOC=ECPROF_$P(EC1,U,2),ECDOCNPI=""
"RTN","ECXLABN",24,0)
 .S ECLOC=$P(EC1,U,15),EC=$P(EC1,U,3)
"RTN","ECXLABN",25,0)
 .I EC]"" D GET
"RTN","ECXLABN",26,0)
 K ^LRO(64.03),^TMP($J,"ECXP") S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",27,0)
 K ECDOCNPI,ECXAGC,ECXL1,ECXL2
"RTN","ECXLABN",28,0)
 Q
"RTN","ECXLABN",29,0)
 ;
"RTN","ECXLABN",30,0)
GET ;get data
"RTN","ECXLABN",31,0)
 N X,ECXSTN
"RTN","ECXLABN",32,0)
 S ECF=$S($P(EC,";",2)="DPT(":2,$P(EC,";",2)="LRT(67,":67,1:0) Q:'ECF
"RTN","ECXLABN",33,0)
 S ECIFN=$P(EC,";")
"RTN","ECXLABN",34,0)
 ;resolve ecloc
"RTN","ECXLABN",35,0)
 S ECXL1=+$P(ECLOC,";",1),ECXL2=$P(ECLOC,";",2)
"RTN","ECXLABN",36,0)
 I ECF=2 S ECLOC=$S(ECXL1>0:ECXL1,1:"") I ECXL2]"",ECXL2'="SC(" S ECLOC=""
"RTN","ECXLABN",37,0)
 I ECF=67 D  S ECLOC=ECXSTN
"RTN","ECXLABN",38,0)
 .S (ECXSTN,ECXAGC)=""
"RTN","ECXLABN",39,0)
 .I (ECXL2'="DIC(4,")!('$D(^DIC(4,ECXL1))) S ECXSTN="XXXXX",ECXAGC="XX" Q
"RTN","ECXLABN",40,0)
 .S ECXSTN=$P(^DIC(4,ECXL1,"99"),U,1),ECXAGC=$E($P(^(99),U,5),1,2)
"RTN","ECXLABN",41,0)
 .S:ECXSTN="" ECXSTN="ZZZZZ" S:ECXAGC="" ECXAGC="ZZ"
"RTN","ECXLABN",42,0)
 S ECDT=$P(EC1,U,13),ECD=$P(ECDT,"."),ECTM=$$ECXTIME^ECXUTL(ECDT)
"RTN","ECXLABN",43,0)
 S ECWKLD=$P(EC1,U,11),ECWK="" I $D(^LAM(ECWKLD,0)) S ECWK=$P(^(0),U,2)
"RTN","ECXLABN",44,0)
 S (ECXADMDT,ECTREAT,ECNA,ECSN,ECMN,ECPTTM,ECPTPR,ECCLAS)="",ECA="O",ECXERR=0
"RTN","ECXLABN",45,0)
 S (ECPTNPI,ECASPR,ECCLAS2,ECASNPI)=""
"RTN","ECXLABN",46,0)
 ;get the patient data if record is in file #2
"RTN","ECXLABN",47,0)
 I ECF=2 D PAT(ECIFN,ECDT,.ECXERR)
"RTN","ECXLABN",48,0)
 Q:ECXERR
"RTN","ECXLABN",49,0)
 ;get patient data if record is in file #67
"RTN","ECXLABN",50,0)
 I ECF=67 S ECSN="000123456",ECNA="RFRL" I $D(^LRT(67,ECIFN,0)) D
"RTN","ECXLABN",51,0)
 .S ECXMPI="",EC0=^LRT(67,ECIFN,0),ECNA=$E($P($P(EC0,U),",")_"    ",1,4)
"RTN","ECXLABN",52,0)
 .S ECSN=$P(EC0,U,9) D
"RTN","ECXLABN",53,0)
 ..S ECNA=$TR(ECNA,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ECXLABN",54,0)
 ..I ECSN="" S ECSN="000123456" Q
"RTN","ECXLABN",55,0)
 ..S ECSN=$TR(ECSN," "),ECSN=$TR(ECSN,"-")
"RTN","ECXLABN",56,0)
 ..I ($L(ECSN)<9)!($L(ECSN)>10) S ECSN="000123456" Q
"RTN","ECXLABN",57,0)
 ..I $L(ECSN)=9,ECSN'?9N S ECSN="000123456" Q
"RTN","ECXLABN",58,0)
 ..I $L(ECSN)=10,ECSN'?9N1"P" S ECSN="000123456"
"RTN","ECXLABN",59,0)
 ;
"RTN","ECXLABN",60,0)
 ;- Only set treating spec (TS) to TS in file #64.03 if it does not exist
"RTN","ECXLABN",61,0)
 I ECTREAT="" S ECTREAT=$P($G(^DIC(45.7,+$P(EC1,U,10),0)),U,2)
"RTN","ECXLABN",62,0)
 S (ECXDOM,ECXDSSD)=""
"RTN","ECXLABN",63,0)
 S X=$G(^ECX(727.831,+ECTREAT,0)) S:X'="" ECXDOM=$P(X,U,2)
"RTN","ECXLABN",64,0)
 ;
"RTN","ECXLABN",65,0)
 ;- Get ordering stop code and ordering date
"RTN","ECXLABN",66,0)
 S ECXORDST=+$P(EC1,U,15),ECXORDST=$S(ECXORDST:$P($G(^ECX(728.44,ECXORDST,0)),U,2),1:"")
"RTN","ECXLABN",67,0)
 S ECXORDDT=$S($P(EC1,U,14):$$ECXDATE^ECXUTL($P(EC1,U,14),ECXYM),1:"")
"RTN","ECXLABN",68,0)
 ;
"RTN","ECXLABN",69,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXLABN",70,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECA,ECTREAT)
"RTN","ECXLABN",71,0)
 ;
"RTN","ECXLABN",72,0)
 ;- If no encounter number don't file record
"RTN","ECXLABN",73,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECA,ECSN,ECXADMDT,ECD,ECTREAT,ECXOBS,ECHEAD,,) Q:ECXENC=""
"RTN","ECXLABN",74,0)
 ;create extract record only if patient name and accession area exist
"RTN","ECXLABN",75,0)
 I ECNA]"" S ECT=$P(EC1,U,8),ECURG=$P(EC1,U,9),EC=+$P(EC1,U,7) I EC D
"RTN","ECXLABN",76,0)
 .S:ECF=2 ECACA=EC_U_$P($G(^LRO(68,EC,0)),U,11)
"RTN","ECXLABN",77,0)
 .S:ECF=67 ECACA=ECXAGC_U_$P($G(^LRO(68,EC,0)),U,11)
"RTN","ECXLABN",78,0)
 .D FILE
"RTN","ECXLABN",79,0)
 Q
"RTN","ECXLABN",80,0)
 ;
"RTN","ECXLABN",81,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get/set patient data
"RTN","ECXLABN",82,0)
 N X,OK,PT
"RTN","ECXLABN",83,0)
 ;get data
"RTN","ECXLABN",84,0)
 I $D(^TMP($J,"ECXP",ECXDFN)) D
"RTN","ECXLABN",85,0)
 .S PT=^TMP($J,"ECXP",ECXDFN),ECNA=$P(PT,U)
"RTN","ECXLABN",86,0)
 .S ECSN=$P(PT,U,2),ECXMPI=$P(PT,U,3)
"RTN","ECXLABN",87,0)
 ;set data and save for later
"RTN","ECXLABN",88,0)
 I '$D(^TMP($J,"ECXP",ECXDFN)) D  Q:'OK
"RTN","ECXLABN",89,0)
 .K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECSD,"."),"1;",.ECXPAT)
"RTN","ECXLABN",90,0)
 .I 'OK S ECXERR=1 Q
"RTN","ECXLABN",91,0)
 .S ECNA=ECXPAT("NAME"),ECSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXLABN",92,0)
 .S ^TMP($J,"ECXP",ECXDFN)=ECNA_U_ECSN_U_ECXMPI
"RTN","ECXLABN",93,0)
 ;get date specific data
"RTN","ECXLABN",94,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECA=$P(X,U),ECMN=$P(X,U,2),ECTREAT=$P(X,U,3),ECXADMDT=$P(X,U,4)
"RTN","ECXLABN",95,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."),ECPROF)
"RTN","ECXLABN",96,0)
 S ECPTTM=$P(X,U,1),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3),ECPTNPI=$P(X,U,4)
"RTN","ECXLABN",97,0)
 S ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6),ECASNPI=$P(X,U,7)
"RTN","ECXLABN",98,0)
 Q
"RTN","ECXLABN",99,0)
 ;
"RTN","ECXLABN",100,0)
FILE ;file record
"RTN","ECXLABN",101,0)
 ;node0
"RTN","ECXLABN",102,0)
 ;facility^patient number^SSN (or equivalent)^name^in/out ECA^
"RTN","ECXLABN",103,0)
 ;day^accession area^abbreviation^test^urgency^treating spec^
"RTN","ECXLABN",104,0)
 ;location^provider and file^
"RTN","ECXLABN",105,0)
 ;movement number^file^time^workload code^primary care team^
"RTN","ECXLABN",106,0)
 ;primary care provider
"RTN","ECXLABN",107,0)
 ;node1
"RTN","ECXLABN",108,0)
 ;mpi^dss dept^provider npi^pc provider npi^pc prov person class^
"RTN","ECXLABN",109,0)
 ;assoc pc prov^assoc pc prov person class^assoc pc prov npi^
"RTN","ECXLABN",110,0)
 ;dom ECXDOM^observ pat ind ECXOBS^encounter num ECXENC^
"RTN","ECXLABN",111,0)
 ;ord stop code ECXORDST^ord date ECXORDDT
"RTN","ECXLABN",112,0)
 N DA,DIK
"RTN","ECXLABN",113,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXLABN",114,0)
 S ECODE=EC7_U_EC23_U_ECINST_U_ECIFN_U_ECSN_U_ECNA_U_ECA_U
"RTN","ECXLABN",115,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_ECACA_U_ECT_U_ECURG_U
"RTN","ECXLABN",116,0)
 S ECODE=ECODE_ECTREAT_U_ECLOC_U_ECDOC_U_ECMN_U_ECF_U_ECTM_U_ECWK_U
"RTN","ECXLABN",117,0)
 S ECODE=ECODE_ECPTTM_U_ECPTPR_U
"RTN","ECXLABN",118,0)
 ;(ECACA=acc area^abbreviation)
"RTN","ECXLABN",119,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECDOCNPI_U_ECPTNPI_U_ECCLAS_U_ECASPR_U
"RTN","ECXLABN",120,0)
 S ECODE1=ECODE1_ECCLAS2_U_ECASNPI_U_ECXDOM_U_ECXOBS_U_ECXENC_U
"RTN","ECXLABN",121,0)
 S ECODE1=ECODE1_ECXORDST_U_ECXORDDT
"RTN","ECXLABN",122,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXLABN",123,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXLABN",124,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXLABN",125,0)
 Q
"RTN","ECXLABN",126,0)
 ;
"RTN","ECXLABN",127,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXLABN",128,0)
 S ECHEAD="LAB"
"RTN","ECXLABN",129,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXLABN",130,0)
 Q
"RTN","ECXLABN",131,0)
 ;
"RTN","ECXLABN",132,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLABN",133,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXMOV")
0^1^B15735113
"RTN","ECXMOV",1,0)
ECXMOV ;ALB/JAP,BIR/DMA,PTD-Transfer and Discharge Extract ; 10/29/96 13:36
"RTN","ECXMOV",2,0)
 ;;3.0;DSS EXTRACTS;**8,24,33,39,41,42**;Dec 22, 1997
"RTN","ECXMOV",3,0)
BEG ;entry point from option
"RTN","ECXMOV",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXMOV",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXMOV",6,0)
 Q
"RTN","ECXMOV",7,0)
 ;
"RTN","ECXMOV",8,0)
START ; start package specific extract
"RTN","ECXMOV",9,0)
 N ECXDSC,W,WTO,X1,X2,X
"RTN","ECXMOV",10,0)
 K ECXDD D FIELD^DID(405,.19,,"SPECIFIER","ECXDD")
"RTN","ECXMOV",11,0)
 S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXMOV",12,0)
 S ECED=ECED+.3,QFLG=0
"RTN","ECXMOV",13,0)
 F ECM=2,3 S ECARG="ATT"_ECM,ECD=ECSD1 D  Q:QFLG
"RTN","ECXMOV",14,0)
 .F  S ECD=$O(^DGPM(ECARG,ECD)),ECDA=0 Q:('ECD)!(ECD>ECED)  D  Q:QFLG
"RTN","ECXMOV",15,0)
 ..F  S ECDA=$O(^DGPM(ECARG,ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXMOV",16,0)
 ...Q:'$D(^DGPM(ECDA,0))  S EC=^(0)
"RTN","ECXMOV",17,0)
 ...S ECXDFN=+$P(EC,U,3),ECMT=$P(EC,U,18),ECXDATE=ECD
"RTN","ECXMOV",18,0)
 ...K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECXDATE,"."),"1;",.ECXPAT)
"RTN","ECXMOV",19,0)
 ...I 'OK K ECXPAT Q
"RTN","ECXMOV",20,0)
 ...S ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXMOV",21,0)
 ...S ECTM=$$ECXTIME^ECXUTL(ECD)
"RTN","ECXMOV",22,0)
 ...S WTO=$P(EC,U,6),ECXWTO=$P($G(^DIC(42,+WTO,44)),U)
"RTN","ECXMOV",23,0)
 ...;
"RTN","ECXMOV",24,0)
 ...;reset EC to admission movement
"RTN","ECXMOV",25,0)
 ...S ECCA=$P(EC,U,14),EC=^DGPM(ECCA,0),ECA=$P(EC,U)
"RTN","ECXMOV",26,0)
 ...;
"RTN","ECXMOV",27,0)
 ...;-If transact=Transfer,ECD (time)=ASIH (7chars) and >0, set ECXDATE
"RTN","ECXMOV",28,0)
 ...;-to Admit DT/time before calling funct to get inpat/outpat stat & TS
"RTN","ECXMOV",29,0)
 ...I ECM=2,$L($P(ECD,".",2))=7,+$E($P(ECD,".",2),7)>0 S ECXDATE=ECA
"RTN","ECXMOV",30,0)
 ...;
"RTN","ECXMOV",31,0)
 ...;-Subtract 1 second from dischg DT so IN5^VADPT call (in ECXUTL2 API)
"RTN","ECXMOV",32,0)
 ...;-will pick up discharge movmement record
"RTN","ECXMOV",33,0)
 ...I ECM=3 S ECXDATE=$$FMADD^XLFDT(ECXDATE,,,,-1)
"RTN","ECXMOV",34,0)
 ...;
"RTN","ECXMOV",35,0)
 ...;-Gets inpat/outpat status, DOM, Treating Spec (TS)
"RTN","ECXMOV",36,0)
 ...S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECXA=$P(X,U),ECXDOM=$P(X,U,10),ECXTS=$P(X,U,3)
"RTN","ECXMOV",37,0)
 ...;if date of previous xfer movement is greater than admit date,
"RTN","ECXMOV",38,0)
 ...;then reset EC to that previous xfer movement
"RTN","ECXMOV",39,0)
 ...S ECDL=9999999.9999999-ECD,ECDL=+$O(^DGPM("ATID2",ECXDFN,ECDL))
"RTN","ECXMOV",40,0)
 ...S ECDAL=+$O(^DGPM("ATID2",ECXDFN,ECDL,0))
"RTN","ECXMOV",41,0)
 ...I $D(^DGPM(ECDAL,0)),$P(^(0),U)>$P(EC,U) S EC=^(0)
"RTN","ECXMOV",42,0)
 ...;losing ward is either previous xfer ward or admission ward
"RTN","ECXMOV",43,0)
 ...S (ECXWRD,ECXFAC,ECXDSSD)=""
"RTN","ECXMOV",44,0)
 ...S W=$P(EC,U,6) I W'="" D
"RTN","ECXMOV",45,0)
 ....S ECXWRD=$P($G(^DIC(42,W,44)),U),ECXFAC=$P($G(^DIC(42,W,0)),U,11)
"RTN","ECXMOV",46,0)
 ....S ECXDSSD=$P($G(^ECX(727.4,W,0)),U,2)
"RTN","ECXMOV",47,0)
 ...S ECDI=$S(ECM=2:"",1:$$ECXDATE^ECXUTL(ECD,ECXYM))
"RTN","ECXMOV",48,0)
 ...S X1=ECD,X2=$P(EC,U) D ^%DTC S ECXLOS=X
"RTN","ECXMOV",49,0)
 ...;
"RTN","ECXMOV",50,0)
 ...;- Get discharge PC Team, Primary and Assoc Primary Provider
"RTN","ECXMOV",51,0)
 ...S (ECXDPCT,ECXDPR,ECXDAPR)=""
"RTN","ECXMOV",52,0)
 ...I ECM=3 D
"RTN","ECXMOV",53,0)
 ....S ECXDSC=$$PRIMARY^ECXUTL2(ECXDFN,ECD)
"RTN","ECXMOV",54,0)
 ....S ECXDPCT=$P(ECXDSC,U),ECXDPR=$P(ECXDSC,U,2),ECXDAPR=$P(ECXDSC,U,5)
"RTN","ECXMOV",55,0)
 ...;
"RTN","ECXMOV",56,0)
 ...;- Observation patient indicator (YES/NO)
"RTN","ECXMOV",57,0)
 ...S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS)
"RTN","ECXMOV",58,0)
 ...;
"RTN","ECXMOV",59,0)
 ...;- If no encounter number, don't file record
"RTN","ECXMOV",60,0)
 ...S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECA,,ECXTS,ECXOBS,ECHEAD,,)
"RTN","ECXMOV",61,0)
 ...D:ECXENC'="" FILE
"RTN","ECXMOV",62,0)
 Q
"RTN","ECXMOV",63,0)
 ;
"RTN","ECXMOV",64,0)
FILE ;file the extract record
"RTN","ECXMOV",65,0)
 ;node0
"RTN","ECXMOV",66,0)
 ;fac ECXFAC^dfn ECXDFN^ssn ECXSSN^name ECXPNM^in/out ECXA^
"RTN","ECXMOV",67,0)
 ;day (ECD)^^adm date (ECA)^disc date ECDI^mov # ECDA^
"RTN","ECXMOV",68,0)
 ;type ECM^losing ward ECXWARD^treat spec ^los ECXLOS^^
"RTN","ECXMOV",69,0)
 ;movement type ECMT^mov time ECTM^gaining ward ECXWTO^
"RTN","ECXMOV",70,0)
 ;adm time (ECA)^^^
"RTN","ECXMOV",71,0)
 ;node1
"RTN","ECXMOV",72,0)
 ;mpi ECXMPI^dss dept ECXDSSD^dom ECXDOM^observ pat ind ECXOBS^
"RTN","ECXMOV",73,0)
 ;encounter num ECXENC^disch prim prov ECXDPR^disch PC team ECXDPCT^
"RTN","ECXMOV",74,0)
 ;disch assoc prim prov ECXDAPR
"RTN","ECXMOV",75,0)
 N DA,DIK
"RTN","ECXMOV",76,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXMOV",77,0)
 S ECODE=EC7_U_EC23_U_ECXFAC_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXMOV",78,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_U
"RTN","ECXMOV",79,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECA,ECXYM)_U_ECDI_U_ECDA_U_ECM_U_ECXWRD_U
"RTN","ECXMOV",80,0)
 S ECODE=ECODE_U_ECXLOS_U_U_ECMT_U_ECTM_U_ECXWTO_U
"RTN","ECXMOV",81,0)
 S ECODE=ECODE_$$ECXTIME^ECXUTL(ECA)_U_U_U
"RTN","ECXMOV",82,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXDOM_U_ECXOBS_U_ECXENC_U_ECXDPR_U
"RTN","ECXMOV",83,0)
 S ECODE1=ECODE1_ECXDPCT_U_ECXDAPR
"RTN","ECXMOV",84,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXMOV",85,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXMOV",86,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXMOV",87,0)
 Q
"RTN","ECXMOV",88,0)
 ;
"RTN","ECXMOV",89,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXMOV",90,0)
 S ECHEAD="MOV"
"RTN","ECXMOV",91,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXMOV",92,0)
 Q
"RTN","ECXMOV",93,0)
 ;
"RTN","ECXMOV",94,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXMOV",95,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSURG")
0^3^B34041117
"RTN","ECXSURG",1,0)
ECXSURG ;ALB/JAP,BIR/DMA,PTD-Surgery Extract for DSS ; [ 03/20/97  3:04 PM ]
"RTN","ECXSURG",2,0)
 ;;3.0;DSS EXTRACTS;**1,11,8,13,25,24,33,39,41,42**;Dec 22, 1997
"RTN","ECXSURG",3,0)
BEG ;entry point from option
"RTN","ECXSURG",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXSURG",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXSURG",6,0)
 Q
"RTN","ECXSURG",7,0)
 ;
"RTN","ECXSURG",8,0)
START ;
"RTN","ECXSURG",9,0)
 S QFLG=0,ECED=ECED+.3,ECD=ECSD1
"RTN","ECXSURG",10,0)
 F  S ECD=$O(^SRF("AC",ECD)),ECD0=0 Q:('ECD)!(ECD>ECED)!(QFLG)  D
"RTN","ECXSURG",11,0)
 .F  S ECD0=$O(^SRF("AC",ECD,ECD0)) Q:'ECD0  D
"RTN","ECXSURG",12,0)
 ..I $D(^SRF(ECD0,0)) S ECXDFN=+$P(^(0),U,1) D STUFF Q:QFLG
"RTN","ECXSURG",13,0)
 Q
"RTN","ECXSURG",14,0)
 ;
"RTN","ECXSURG",15,0)
STUFF ;gather data
"RTN","ECXSURG",16,0)
 N J,X,Y,PP,DATA1,DATA2,DATAOP,ARR,ERR,SUB,MOD,ECXNONL,ECXSTOP,TIMEDIF
"RTN","ECXSURG",17,0)
 S ECXDATE=ECD,ECXERR=0
"RTN","ECXSURG",18,0)
 Q:'$$PATDEM^ECXUTL2(ECXDFN,ECXDATE,"1;2;3;5;")
"RTN","ECXSURG",19,0)
 S ECXADD=$$ECXDATE^ECXUTL(ECXADMDT,ECXYM),EC0=^SRF(ECD0,0)
"RTN","ECXSURG",20,0)
 S DATA1=$S($D(^SRF(ECD0,.1)):^(.1),1:"")
"RTN","ECXSURG",21,0)
 S DATA2=$S($D(^SRF(ECD0,.2)):^(.2),1:"")
"RTN","ECXSURG",22,0)
 S DATAOP=$S($D(^SRF(ECD0,"OP")):^("OP"),1:"")
"RTN","ECXSURG",23,0)
 S ECNO=$G(^SRF(ECD0,"NON"))
"RTN","ECXSURG",24,0)
 ;get data
"RTN","ECXSURG",25,0)
 S ECSR=$P(DATA1,U,4),(ECATNPI,ECSANPI,ECSRNPI)="",ECAT=$P(DATA1,U,13)
"RTN","ECXSURG",26,0)
 S ECXTM=$$ECXTIME^ECXUTL($P(DATA2,U,10))
"RTN","ECXSURG",27,0)
 S ECXDIV=$S($D(^SRF(ECD0,8)):^(8),1:ECINST)
"RTN","ECXSURG",28,0)
 S ECSA=$P($G(^SRF(ECD0,.3)),U,4),ECO=$P(EC0,U,2)
"RTN","ECXSURG",29,0)
 S ECORTY=$P($G(^SRS(+ECO,2)),U),ECO=$P($G(^SRS(+ECO,0)),U)
"RTN","ECXSURG",30,0)
 S ECSS=$P($G(^SRO(137.45,+$P(EC0,U,4),0)),U,2)
"RTN","ECXSURG",31,0)
 S ECSS=$$RJ^XLFSTR($P($G(^DIC(45.3,+ECSS,0)),U),3,0)
"RTN","ECXSURG",32,0)
 S:ECSS="000" ECSS="999"
"RTN","ECXSURG",33,0)
 ;look for non-OR
"RTN","ECXSURG",34,0)
 S (ECNT,ECNL,ECXDSSD,ECXNONL,ECXSTOP)=""
"RTN","ECXSURG",35,0)
 I $P(ECNO,U)="Y" D
"RTN","ECXSURG",36,0)
 .S ECSR=$P(ECNO,U,6),ECAT=$P(ECNO,U,7)
"RTN","ECXSURG",37,0)
 .S ECXTM=$$ECXTIME^ECXUTL($P(ECNO,U,4))
"RTN","ECXSURG",38,0)
 .S A1=$P(ECNO,U,5),A2=$P(ECNO,U,4),TIME="##" D:(A1&A2) TIME S ECNT=TIME
"RTN","ECXSURG",39,0)
 .S (ECXNONL,ECNL)=+$P(ECNO,U,2),ECNL=$P($G(^ECX(728.44,ECNL,0)),U,9)
"RTN","ECXSURG",40,0)
 .S:ECNL="" ECNL="UNKNOWN"
"RTN","ECXSURG",41,0)
 .;
"RTN","ECXSURG",42,0)
 .;- Get DSS Stop Code to use in encounter number
"RTN","ECXSURG",43,0)
 .S ECXSTOP=$P($G(^ECX(728.44,ECXNONL,0)),U,4)
"RTN","ECXSURG",44,0)
 ;
"RTN","ECXSURG",45,0)
 ;- Cancelled/aborted surgery indicator (C/A)
"RTN","ECXSURG",46,0)
 S ECCAN=$P($G(^SRF(ECD0,30)),U)
"RTN","ECXSURG",47,0)
 I +ECCAN S ECCAN=$$CANC^ECXUTL4(ECNL,$P(DATA2,U,10))
"RTN","ECXSURG",48,0)
 ;get service of attending surgeon
"RTN","ECXSURG",49,0)
 S ECATSV=$P($G(^DIC(49,+$G(^VA(200,+ECAT,5)),730)),U)
"RTN","ECXSURG",50,0)
 ;add leading 2s for pointer to 200
"RTN","ECXSURG",51,0)
 S:ECAT ECAT="2"_ECAT S:ECSR ECSR="2"_ECSR S:ECSA ECSA="2"_ECSA
"RTN","ECXSURG",52,0)
 ;anesthesia technique
"RTN","ECXSURG",53,0)
 S ECANE="",PP=""
"RTN","ECXSURG",54,0)
 I $D(^SRF(ECD0,6,0)) S ECXJ=0 D
"RTN","ECXSURG",55,0)
 .F  S ECXJ=$O(^SRF(ECD0,6,ECXJ)) Q:('ECXJ)!(ECANE]"")  D
"RTN","ECXSURG",56,0)
 ..S PP=$P($G(^(ECXJ,0)),U,3) S:PP="Y" ECANE=$P(^(0),U,1)
"RTN","ECXSURG",57,0)
 .I ECANE="" S ECXJ=$O(^SRF(ECD0,6,0)) I ECXJ S ECANE=$P(^SRF(ECD0,6,ECXJ,0),U,1)
"RTN","ECXSURG",58,0)
 ;get primary procedure
"RTN","ECXSURG",59,0)
 ;ecode0=p^cpt code^^patient time^operation time^anesthesia time
"RTN","ECXSURG",60,0)
 S ECPT=+$P(DATAOP,U,2),ECXCMOD=""
"RTN","ECXSURG",61,0)
 K ARR,ERR D FIELD^DID(130,28,,"LABEL","ARR","ERR") I $D(ARR("LABEL")) D
"RTN","ECXSURG",62,0)
 .K ARR,ERR D FIELD^DID(130,28,,"GLOBAL SUBSCRIPT LOCATION","ARR","ERR")
"RTN","ECXSURG",63,0)
 .Q:$D(ERR("DIERR"))
"RTN","ECXSURG",64,0)
 .S SUB=$P(ARR("GLOBAL SUBSCRIPT LOCATION"),";"),MOD=0
"RTN","ECXSURG",65,0)
 .F  S MOD=$O(^SRF(ECD0,SUB,MOD)) Q:MOD'>0  D
"RTN","ECXSURG",66,0)
 ..S ECXCMOD=ECXCMOD_$P(^(MOD,0),U)_";"
"RTN","ECXSURG",67,0)
 S ECXCPT=$$CPT^ECXUTL3(ECPT,ECXCMOD)
"RTN","ECXSURG",68,0)
 S ECODE0="P"_U_U  ;ECPT_U
"RTN","ECXSURG",69,0)
 F J="10,12","2,3","1,4" D
"RTN","ECXSURG",70,0)
 .S A2=$P(DATA2,U,$P(J,",")),A1=$P(DATA2,U,$P(J,",",2)),TIME="##"
"RTN","ECXSURG",71,0)
 .I (A1&A2)&(+J'=2) D TIME
"RTN","ECXSURG",72,0)
 .I (A1&A2)&(+J=2) D
"RTN","ECXSURG",73,0)
 ..;
"RTN","ECXSURG",74,0)
 ..;-Operation Time
"RTN","ECXSURG",75,0)
 ..;-Get time diff (in secs) & set to .5 if < 7.5 minutes (rounds to 1)
"RTN","ECXSURG",76,0)
 ..S TIMEDIF=$$FMDIFF^XLFDT(A1,A2,2)/900
"RTN","ECXSURG",77,0)
 ..S TIMEDIF=$S(TIMEDIF>0&(TIMEDIF<.5):.5,1:TIMEDIF)
"RTN","ECXSURG",78,0)
 ..S TIME=$TR($J(TIMEDIF,4,0)," ")
"RTN","ECXSURG",79,0)
 ..S:TIME<0 TIME="###"
"RTN","ECXSURG",80,0)
 .S ECODE0=ECODE0_U_TIME K TIME
"RTN","ECXSURG",81,0)
 S ECRR=""
"RTN","ECXSURG",82,0)
 I $D(^SRF(ECD0,1.1)) D
"RTN","ECXSURG",83,0)
 .S A1=$P(^(1.1),U,8),A2=$P(^(1.1),U,7),TIME="##" D:(A1&A2) TIME
"RTN","ECXSURG",84,0)
 .S ECRR=TIME K TIME
"RTN","ECXSURG",85,0)
 I ECNL]"" S $P(ECODE0,U,5)=ECNT
"RTN","ECXSURG",86,0)
 ;
"RTN","ECXSURG",87,0)
 ;- Observation Patient Indicator (yes/no)
"RTN","ECXSURG",88,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECNL)
"RTN","ECXSURG",89,0)
 ;
"RTN","ECXSURG",90,0)
 ;- If no encounter number don't file record
"RTN","ECXSURG",91,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXSTOP,ECSS) Q:ECXENC=""
"RTN","ECXSURG",92,0)
 D FILE
"RTN","ECXSURG",93,0)
 ;get secondary procedures
"RTN","ECXSURG",94,0)
 ;ecode0=s^cpt code
"RTN","ECXSURG",95,0)
 S ECXJ=0
"RTN","ECXSURG",96,0)
 F  S ECXJ=$O(^SRF(ECD0,13,ECXJ)) Q:'ECXJ  I $D(^(ECXJ,0)),$D(^(2)),$P(^(2),U)]"" D
"RTN","ECXSURG",97,0)
 .S ECPT=$P(^SRF(ECD0,13,ECXJ,2),U),ECXCMOD=""
"RTN","ECXSURG",98,0)
 .K ARR,ERR
"RTN","ECXSURG",99,0)
 .D FIELD^DID(130.16,4,,"LABEL","ARR","ERR") I $D(ARR("LABEL")) D
"RTN","ECXSURG",100,0)
 ..K ARR,ERR
"RTN","ECXSURG",101,0)
 ..D FIELD^DID(130.16,4,,"GLOBAL SUBSCRIPT LOCATION","ARR","ERR")
"RTN","ECXSURG",102,0)
 ..Q:$D(ERR("DIERR"))
"RTN","ECXSURG",103,0)
 ..S SUB=$P(ARR("GLOBAL SUBSCRIPT LOCATION"),";"),MOD=0
"RTN","ECXSURG",104,0)
 ..F  S MOD=$O(^SRF(ECD0,13,ECXJ,SUB,MOD)) Q:MOD'>0  S ECXCMOD=ECXCMOD_$P(^(MOD,0),U)_";"
"RTN","ECXSURG",105,0)
 .S ECXCPT=$$CPT^ECXUTL3(ECPT,ECXCMOD)
"RTN","ECXSURG",106,0)
 .S ECODE0="S"_U   ;_ECPT
"RTN","ECXSURG",107,0)
 .D FILE
"RTN","ECXSURG",108,0)
 ;get prostheses
"RTN","ECXSURG",109,0)
 ;ecode0=i^^^^^^prosthesis^quantity
"RTN","ECXSURG",110,0)
 S ECXJ=0
"RTN","ECXSURG",111,0)
 F  S ECXJ=$O(^SRF(ECD0,1,ECXJ)) Q:'ECXJ  I $D(^(ECXJ,0)) D
"RTN","ECXSURG",112,0)
 .S ECXP=+^SRF(ECD0,1,ECXJ,0),ECXQ=$P($G(^(1)),U,2) S:'ECXQ ECXQ=1
"RTN","ECXSURG",113,0)
 .S ECODE0="I"_U_U_U_U_U_U_ECXP_U_ECXQ
"RTN","ECXSURG",114,0)
 .D FILE
"RTN","ECXSURG",115,0)
 Q
"RTN","ECXSURG",116,0)
 ;
"RTN","ECXSURG",117,0)
FILE ;file record
"RTN","ECXSURG",118,0)
 ;node0
"RTN","ECXSURG",119,0)
 ;division^dfn^ssn^name^in/out (ECXA)^day^case #^
"RTN","ECXSURG",120,0)
 ;surg specialty^or room #^
"RTN","ECXSURG",121,0)
 ;surgeon^attending^anesthesia supervisor^anesthesia technique^
"RTN","ECXSURG",122,0)
 ;primary/secondary/prostheses^cpt^^pt time^op time^anes time^
"RTN","ECXSURG",123,0)
 ;prostheses^qty^^
"RTN","ECXSURG",124,0)
 ;movement number^treating specialty^cancel/abort (ECCAN)^time^or type^
"RTN","ECXSURG",125,0)
 ;attending's service^non-or dss id^recovery room time^^
"RTN","ECXSURG",126,0)
 ;primary care team^primary care provider^admission date
"RTN","ECXSURG",127,0)
 ;node1
"RTN","ECXSURG",128,0)
 ;mpi^dss dept^surgeon npi^attending npi^anes supervisor npi^
"RTN","ECXSURG",129,0)
 ;pc provider npi^pc prov person class^
"RTN","ECXSURG",130,0)
 ;assoc pc provider^assoc pc prov person class^assoc pc prov npi^
"RTN","ECXSURG",131,0)
 ;cpt&modifiers ECXCPT^dom ECXDOM^enrollment category ECXCAT^
"RTN","ECXSURG",132,0)
 ;enrollment status ECXSTAT^enrollment priority ECXPRIOR^
"RTN","ECXSURG",133,0)
 ;period of service ECXPOS^purple heart indicator ECXPHI^
"RTN","ECXSURG",134,0)
 ;observ pat ind ECXOBS^encounter num ECXENC^ao loc ECXAOL
"RTN","ECXSURG",135,0)
 N DA,DIK,STR
"RTN","ECXSURG",136,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXSURG",137,0)
 S ECODE=EC7_U_EC23_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXSURG",138,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECD0_U_ECSS_U_ECO_U
"RTN","ECXSURG",139,0)
 S ECODE=ECODE_ECSR_U_ECAT_U_ECSA_U_ECANE_U_ECODE0_U
"RTN","ECXSURG",140,0)
 S STR=ECXMN_U_ECXTS_U_$S(ECCAN'="":ECCAN,1:"")_U_ECXTM_U_ECORTY_U
"RTN","ECXSURG",141,0)
 S STR=STR_ECATSV_U_ECNL_U_ECRR_U_U_ECPTTM_U_ECPTPR_U_ECXADD_U
"RTN","ECXSURG",142,0)
 S $P(ECODE,U,26,38)=STR
"RTN","ECXSURG",143,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECSRNPI_U_ECATNPI_U_ECSANPI_U_ECPTNPI_U
"RTN","ECXSURG",144,0)
 S ECODE1=ECODE1_ECCLAS_U_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXCPT_U_ECXDOM_U
"RTN","ECXSURG",145,0)
 S ECODE1=ECODE1_ECXCAT_U_ECXSTAT_U_ECXPRIOR_U_ECXPOS_U_ECXPHI_U
"RTN","ECXSURG",146,0)
 S ECODE1=ECODE1_ECXOBS_U_ECXENC_U_ECXAOL
"RTN","ECXSURG",147,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXSURG",148,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXSURG",149,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSURG",150,0)
 ;
"RTN","ECXSURG",151,0)
TIME ; given date/time get increment
"RTN","ECXSURG",152,0)
 ;A1=later, A2=earlier, TIME=difference
"RTN","ECXSURG",153,0)
 N CON,TIMEDIF
"RTN","ECXSURG",154,0)
 S CON=$P($G(^SRF(ECD0,"CON")),U)
"RTN","ECXSURG",155,0)
 ;
"RTN","ECXSURG",156,0)
 ;-Get time diff (in secs) & set to .5 if < 7.5 minutes (rounds to 1)
"RTN","ECXSURG",157,0)
 S TIMEDIF=$$FMDIFF^XLFDT(A1,A2,2)/900
"RTN","ECXSURG",158,0)
 S TIMEDIF=$S(TIMEDIF>0&(TIMEDIF<.5):.5,1:TIMEDIF)
"RTN","ECXSURG",159,0)
 I 'CON D
"RTN","ECXSURG",160,0)
 .S TIME=$J($TR($J(TIMEDIF,4,0)," "),2,1)
"RTN","ECXSURG",161,0)
 .S:TIME>"99.0" TIME="99.0"
"RTN","ECXSURG",162,0)
 I CON D
"RTN","ECXSURG",163,0)
 .S TIME=$J(($TR($J(TIMEDIF,4,0)," ")/2),2,1)
"RTN","ECXSURG",164,0)
 .S:TIME>"99.5" TIME="99.5"
"RTN","ECXSURG",165,0)
 S:TIME<0 TIME="###"
"RTN","ECXSURG",166,0)
 Q
"RTN","ECXSURG",167,0)
 ;
"RTN","ECXSURG",168,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXSURG",169,0)
 S ECHEAD="SUR"
"RTN","ECXSURG",170,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXSURG",171,0)
 Q
"RTN","ECXSURG",172,0)
 ;
"RTN","ECXSURG",173,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSURG",174,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXUTL3")
0^4^B51859947
"RTN","ECXUTL3",1,0)
ECXUTL3 ;ALB/GTS - Utilities for DSS Extracts ; 8/1/01 9:47am
"RTN","ECXUTL3",2,0)
 ;;3.0;DSS EXTRACTS;**11,24,32,33,35,37,39,42**;Dec 22,1997
"RTN","ECXUTL3",3,0)
 ;
"RTN","ECXUTL3",4,0)
OUTPTTM(ECXDFN,ECXDT) ;* Return PC Team from PCMM files or DPT
"RTN","ECXUTL3",5,0)
 ; Variables -
"RTN","ECXUTL3",6,0)
 ;            ECXDFN - IEN from Patient file (Required)
"RTN","ECXUTL3",7,0)
 ;            ECXDT  - Relevant Date for Primary Care Team
"RTN","ECXUTL3",8,0)
 ;                      (Defaults to DT)
"RTN","ECXUTL3",9,0)
 ;
"RTN","ECXUTL3",10,0)
 ; Returned: ECXTM -
"RTN","ECXUTL3",11,0)
 ;            Pointer to team file (#404.51)
"RTN","ECXUTL3",12,0)
 ;            or, if error or none defined, returns 0
"RTN","ECXUTL3",13,0)
 ;
"RTN","ECXUTL3",14,0)
 Q:'$G(ECXDFN) 0 ;** Quit if ECXDFN not defined
"RTN","ECXUTL3",15,0)
 N ECXTM
"RTN","ECXUTL3",16,0)
 S:'$D(ECXDT) ECXDT=DT
"RTN","ECXUTL3",17,0)
 I $T(OUTPTTM^SDUTL3)[",SCDATE" D
"RTN","ECXUTL3",18,0)
 .S ECXTM=+$$OUTPTTM^SDUTL3(ECXDFN,ECXDT)
"RTN","ECXUTL3",19,0)
 I $T(OUTPTTM^SDUTL3)'[",SCDATE" D
"RTN","ECXUTL3",20,0)
 .S ECXTM=+$$OUTPTTM^SDUTL3(ECXDFN)
"RTN","ECXUTL3",21,0)
 I ECXTM=0 D
"RTN","ECXUTL3",22,0)
 .S ECXTM=+$P($G(^DPT(+ECXDFN,"PC")),U,2)
"RTN","ECXUTL3",23,0)
 Q ECXTM
"RTN","ECXUTL3",24,0)
 ;
"RTN","ECXUTL3",25,0)
OUTPTPR(ECXDFN,ECXDT) ;* Return PC Provider from PCMM files or DPT
"RTN","ECXUTL3",26,0)
 ; Variables -
"RTN","ECXUTL3",27,0)
 ;            ECXDFN - IEN from Patient file (Required)
"RTN","ECXUTL3",28,0)
 ;            ECXDT  - Relevant Date for Primary Care Provider
"RTN","ECXUTL3",29,0)
 ;                      (Defaults to DT)
"RTN","ECXUTL3",30,0)
 ;
"RTN","ECXUTL3",31,0)
 ; Returned: ECXPR -
"RTN","ECXUTL3",32,0)
 ;            Pointer to file #200 
"RTN","ECXUTL3",33,0)
 ;            or, if error or none defined, returns a 0
"RTN","ECXUTL3",34,0)
 ;
"RTN","ECXUTL3",35,0)
 Q:'$G(ECXDFN) 0 ;** Quit if ECXDFN not defined
"RTN","ECXUTL3",36,0)
 N ECXPR
"RTN","ECXUTL3",37,0)
 S:'$D(ECXDT) ECXDT=DT
"RTN","ECXUTL3",38,0)
 I $T(OUTPTPR^SDUTL3)[",SCDATE" D
"RTN","ECXUTL3",39,0)
 .S ECXPR=+$$OUTPTPR^SDUTL3(ECXDFN,ECXDT)
"RTN","ECXUTL3",40,0)
 I $T(OUTPTPR^SDUTL3)'[",SCDATE" D
"RTN","ECXUTL3",41,0)
 .S ECXPR=+$$OUTPTPR^SDUTL3(ECXDFN)
"RTN","ECXUTL3",42,0)
 I ECXPR=0 D
"RTN","ECXUTL3",43,0)
 .S ECXPR=+$G(^DPT(+ECXDFN,"PC"))
"RTN","ECXUTL3",44,0)
 Q ECXPR
"RTN","ECXUTL3",45,0)
 ;
"RTN","ECXUTL3",46,0)
PAT(ECXDFN,ECXDATE,ECXDATA,ECXPAT) ;Return basic patient data for extract
"RTN","ECXUTL3",47,0)
 ; Will not return data associated with test patients (SSN begin w 00000)
"RTN","ECXUTL3",48,0)
 ; Variables -
"RTN","ECXUTL3",49,0)
 ;  Input  ECXDFN - Patient internal entry number, DFN file#2; required
"RTN","ECXUTL3",50,0)
 ;         ECXDATE- Date used to get specific data from GETSTAT^DGMSTAPI
"RTN","ECXUTL3",51,0)
 ;                  for MST. If no date, defaults to today's date,
"RTN","ECXUTL3",52,0)
 ;                  standard FM format, optional
"RTN","ECXUTL3",53,0)
 ;         ECXDATA- Code indicating which data to return, optional.
"RTN","ECXUTL3",54,0)
 ;                  If code not specified then returns all. Codes are:
"RTN","ECXUTL3",55,0)
 ;                  1 - DEM^VADPT (demographic data)
"RTN","ECXUTL3",56,0)
 ;                  2 - ADD^VADPT (current address)
"RTN","ECXUTL3",57,0)
 ;                  3 - ELIG^VADPT (eligibility & enrollment location)
"RTN","ECXUTL3",58,0)
 ;                  4 - OPD^VADPT (other patient data)
"RTN","ECXUTL3",59,0)
 ;                  5 - SVC^VADPT & GETSTAT^DGMSTAPI (service & MST inf)
"RTN","ECXUTL3",60,0)
 ;         ECXPAT(- Passed by referece; required
"RTN","ECXUTL3",61,0)
 ;
"RTN","ECXUTL3",62,0)
 ;  Output:
"RTN","ECXUTL3",63,0)
 ;         ECXPAT   0 error or test patient no data in ECXPAT array
"RTN","ECXUTL3",64,0)
 ;                  1 data returneed in ECXPAT array
"RTN","ECXUTL3",65,0)
 ;         ECXPAT(  Local array with patient data.
"RTN","ECXUTL3",66,0)
 ;
"RTN","ECXUTL3",67,0)
 N SSN,I,ECXCOD,ECXDAT,DFN,VAPA,VADM,VAEL,VAPD,VASV,STR,ECXAR,DIC,DIQ
"RTN","ECXUTL3",68,0)
 N DA,DR,PELG,MELIG,ZIP,MPI
"RTN","ECXUTL3",69,0)
 I ECXDFN="" Q 0
"RTN","ECXUTL3",70,0)
 S SSN=$$GET1^DIQ(2,ECXDFN,.09,"I"),DFN=ECXDFN,ECXPAT=0
"RTN","ECXUTL3",71,0)
 I $E(SSN,1,5)="00000"!(SSN="") K ECXPAT Q 0  ;test patient
"RTN","ECXUTL3",72,0)
 S STR="NAME;SSN;DOB;SEX;RACE;RELIGION;STATE;COUNTY;ZIP;SC%;MEANS;ELIG;"
"RTN","ECXUTL3",73,0)
 S STR=STR_"EMPLOY;AO STAT;IR STAT;EC STAT;POW STAT;POW LOC;MST STAT;"
"RTN","ECXUTL3",74,0)
 S STR=STR_"ENROLL LOC;MPI;VIETNAM;POS;MARITAL"
"RTN","ECXUTL3",75,0)
 ;initialize return array values
"RTN","ECXUTL3",76,0)
 F I=1:1 S ECXDAT=$P(STR,";",I) Q:ECXDAT=""  S ECXPAT(ECXDAT)=""
"RTN","ECXUTL3",77,0)
 F I=1:1:$L(ECXDATA,";") S ECXDAT=$P(ECXDATA,";",I) I ECXDAT'="" D
"RTN","ECXUTL3",78,0)
 . S ECXCOD(ECXDAT)=""
"RTN","ECXUTL3",79,0)
 ;
"RTN","ECXUTL3",80,0)
 ;- Get ICN if MPI installed
"RTN","ECXUTL3",81,0)
 S X="MPIF001" X ^%ZOSF("TEST") I $T D
"RTN","ECXUTL3",82,0)
 .;
"RTN","ECXUTL3",83,0)
 .;- Get 1st piece (either ICN # or -1 if error)
"RTN","ECXUTL3",84,0)
 . S MPI=+$$GETICN^MPIF001(DFN)
"RTN","ECXUTL3",85,0)
 .;
"RTN","ECXUTL3",86,0)
 .;- If error, set to null
"RTN","ECXUTL3",87,0)
 . S ECXPAT("MPI")=$S(MPI>0:MPI,1:"")
"RTN","ECXUTL3",88,0)
 D  ;get demographic data
"RTN","ECXUTL3",89,0)
 . I ECXDATA'="",'$D(ECXCOD(1)) Q
"RTN","ECXUTL3",90,0)
 . D DEM^VADPT
"RTN","ECXUTL3",91,0)
 . S ECXPAT("NAME")=$E($P(VADM(1),",")_"    ",1,4)
"RTN","ECXUTL3",92,0)
 . S ECXPAT("SSN")=$P(VADM(2),U),ECXPAT("MARITAL")=$P(VADM(10),U)
"RTN","ECXUTL3",93,0)
 . S ECXPAT("DOB")=$$ECXDOB^ECXUTL($P(VADM(3),U))
"RTN","ECXUTL3",94,0)
 . S ECXPAT("SEX")=$P(VADM(5),U),ECXPAT("RELIGION")=$P(VADM(9),U)
"RTN","ECXUTL3",95,0)
 . S DIC=10,DR=2,DA=+VADM(8),DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",96,0)
 . S ECXPAT("RACE")=$G(ECXAR(10,DA,DR,"I")),ECXPAT=1
"RTN","ECXUTL3",97,0)
 D  ;get address information
"RTN","ECXUTL3",98,0)
 . I ECXDATA'="",'$D(ECXCOD(2)) Q
"RTN","ECXUTL3",99,0)
 . D ADD^VADPT
"RTN","ECXUTL3",100,0)
 . S DIC=5,DR=2,DA=+VAPA(5),DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",101,0)
 . S ECXPAT("STATE")=$G(ECXAR(5,DA,DR,"I"))
"RTN","ECXUTL3",102,0)
 . S DIC=5,DA=+VAPA(5),DR=3,DR(5.01)=2,DA(5.01)=+VAPA(7),DIQ="ECXAR"
"RTN","ECXUTL3",103,0)
 . S DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",104,0)
 . S ECXPAT("COUNTY")=$G(ECXAR(5.01,DA(5.01),2,"I"))
"RTN","ECXUTL3",105,0)
 . S ECXPAT("ZIP")=$P(VAPA(11),U,2),ECXPAT=1
"RTN","ECXUTL3",106,0)
 D  ;get eligibility information
"RTN","ECXUTL3",107,0)
 . I ECXDATA'="",'$D(ECXCOD(3)) Q
"RTN","ECXUTL3",108,0)
 . D ELIG^VADPT
"RTN","ECXUTL3",109,0)
 . S PELG=$P(VAEL(1),U),MELIG=$S(PELG="":"",1:$$GET1^DIQ(8,PELG,8,"I"))
"RTN","ECXUTL3",110,0)
 . S ECXPAT("POS")=$P($G(^DIC(21,+VAEL(2),0)),U,3)
"RTN","ECXUTL3",111,0)
 . S ECXPAT("SC STAT")=$S(+VAEL(3):"Y",+VAEL(3)=0:"N",1:"")
"RTN","ECXUTL3",112,0)
 . S ECXPAT("SC%")=$P(VAEL(3),U,2)
"RTN","ECXUTL3",113,0)
 . S ECXPAT("VET")=$S(VAEL(4):"Y",VAEL(4)=0:"N",1:"")
"RTN","ECXUTL3",114,0)
 . S ECXPAT("MEANS")=$P(VAEL(9),U),ECXPAT=1
"RTN","ECXUTL3",115,0)
 . S ECXPAT("ELIG")=$$ELIG(MELIG,ECXPAT("SC%"))
"RTN","ECXUTL3",116,0)
 . ;get enrollment location
"RTN","ECXUTL3",117,0)
 . S DIC=2,DR=27.02,DA=ECXDFN,DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",118,0)
 . S ECXDAT=$G(ECXAR(2,ECXDFN,DR,"I")) I ECXDAT K ECXAR D
"RTN","ECXUTL3",119,0)
 . . S DIC=4,DA=ECXDAT,DR=99,DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",120,0)
 . . S ECXPAT("ENROLL LOC")=ECXAR(4,ECXDAT,DR,"I")
"RTN","ECXUTL3",121,0)
 D  ;get other patient information
"RTN","ECXUTL3",122,0)
 . I ECXDATA'="",'$D(ECXCOD(4)) Q
"RTN","ECXUTL3",123,0)
 . D OPD^VADPT
"RTN","ECXUTL3",124,0)
 . S ECXPAT("EMPLOY")=$P(VAPD(7),U),ECXPAT=1
"RTN","ECXUTL3",125,0)
 D  ;get service information
"RTN","ECXUTL3",126,0)
 . I ECXDATA'="",'$D(ECXCOD(5)) Q
"RTN","ECXUTL3",127,0)
 . D SVC^VADPT
"RTN","ECXUTL3",128,0)
 . S ECXPAT("VIETNAM")=$S(VASV(1):"Y",VASV(2)=0:"N",1:"U")
"RTN","ECXUTL3",129,0)
 . S ECXPAT("AO STAT")=$S(VASV(2):"Y",VASV(2)=0:"N",1:"U")
"RTN","ECXUTL3",130,0)
 . S ECXPAT("IR STAT")=$S(VASV(3):"Y",VASV(3)=0:"N",1:"U")
"RTN","ECXUTL3",131,0)
 . S ECXPAT("EC STAT")=$$GET1^DIQ(2,ECXDFN,.322013,"I")
"RTN","ECXUTL3",132,0)
 . S ECXPAT("POW STAT")=$S(VASV(4):"Y",VASV(4)=0:"N",1:"U")
"RTN","ECXUTL3",133,0)
 . S ECXPAT("POW LOC")=$P(VASV(4,3),U),ECXPAT=1
"RTN","ECXUTL3",134,0)
 . S ECXPAT("PHI")=$S(VASV(9)=1:"Y",VASV(9)=0:"N",1:"")
"RTN","ECXUTL3",135,0)
 . ;
"RTN","ECXUTL3",136,0)
 . ;- Agent Orange Location (K=Korean DMZ,V=Vietnam)
"RTN","ECXUTL3",137,0)
 . S ECXPAT("AOL")=$P($G(VASV(2,5)),U)
"RTN","ECXUTL3",138,0)
 . ;get patient current MST status
"RTN","ECXUTL3",139,0)
 . I ECXDATE'="",ECXDATE'["." S ECXDATE=ECXDATE+.9
"RTN","ECXUTL3",140,0)
 . S X="DGMSTAPI" X ^%ZOSF("TEST") I $T D
"RTN","ECXUTL3",141,0)
 . . S ECXDAT=$$GETSTAT^DGMSTAPI(DFN,ECXDATE)
"RTN","ECXUTL3",142,0)
 . . S ECXPAT("MST STAT")=$S(+ECXDAT>0:$P(ECXDAT,U,2),1:"")
"RTN","ECXUTL3",143,0)
 I 'ECXPAT K ECXPAT Q 0
"RTN","ECXUTL3",144,0)
 Q 1
"RTN","ECXUTL3",145,0)
 ;
"RTN","ECXUTL3",146,0)
ELIG(ECXELIG,ECXSVCP) ;Converts veteran eligibility code to NPCD code
"RTN","ECXUTL3",147,0)
 ; Variables -
"RTN","ECXUTL3",148,0)
 ;  Input  ECXELIG - Pointer to MAS ELIGIBILITY CODE file #8.1
"RTN","ECXUTL3",149,0)
 ;         ECXSVCP - Number value rep. service connected percentage.
"RTN","ECXUTL3",150,0)
 ;
"RTN","ECXUTL3",151,0)
 ;  Output:
"RTN","ECXUTL3",152,0)
 ;         ECXNCPD  NPCD Eligibility Code
"RTN","ECXUTL3",153,0)
 ;
"RTN","ECXUTL3",154,0)
 N TEXT,IEN,SCPER,FND,NPCD,I,ECXBG,ECXEN,ECXNPCD
"RTN","ECXUTL3",155,0)
 I ECXELIG="" Q ""
"RTN","ECXUTL3",156,0)
 F I=1:1 S TEXT=$P($T(ELGTXT+I),";",3,999) Q:TEXT="END"  D  I $D(NPCD) Q
"RTN","ECXUTL3",157,0)
 . S IEN=$P(TEXT,";"),SCPER=$P(TEXT,";",2)
"RTN","ECXUTL3",158,0)
 . I ECXELIG=IEN D
"RTN","ECXUTL3",159,0)
 . . I SCPER="" S NPCD=$P(TEXT,";",3) Q
"RTN","ECXUTL3",160,0)
 . . S ECXBG=$S($E(SCPER)="<":0,$E(SCPER)=">":$P(SCPER,">",2)+1,SCPER["-":+SCPER,1:"")
"RTN","ECXUTL3",161,0)
 . . S ECXEN=$S($E(SCPER)="<":$P(SCPER,"<",2),$E(SCPER)=">":100,SCPER["-":$P(SCPER,"-",2),1:"")
"RTN","ECXUTL3",162,0)
 . . I ECXSVCP'<ECXBG,ECXSVCP'>ECXEN S NPCD=$P(TEXT,";",3)
"RTN","ECXUTL3",163,0)
 S ECXNPCD=$G(NPCD)
"RTN","ECXUTL3",164,0)
 Q ECXNPCD
"RTN","ECXUTL3",165,0)
ELGTXT ;Eligibility codes
"RTN","ECXUTL3",166,0)
 ;;1;>49;10;SC 50-100%
"RTN","ECXUTL3",167,0)
 ;;2;;20;Aid & Attendance
"RTN","ECXUTL3",168,0)
 ;;15;;21;Housebound
"RTN","ECXUTL3",169,0)
 ;;16;;22;Mexican Border War
"RTN","ECXUTL3",170,0)
 ;;17;;23;WWI
"RTN","ECXUTL3",171,0)
 ;;18;;24;POW
"RTN","ECXUTL3",172,0)
 ;;3;40-49;30;SC 40-49%
"RTN","ECXUTL3",173,0)
 ;;3;30-39;31;SC 30-39%
"RTN","ECXUTL3",174,0)
 ;;3;20-29;32;SC 20-29%
"RTN","ECXUTL3",175,0)
 ;;3;10-19;33;SC 10-19%
"RTN","ECXUTL3",176,0)
 ;;3;<10;34;SC less than 10%
"RTN","ECXUTL3",177,0)
 ;;4;;40;NSC - VA Pension
"RTN","ECXUTL3",178,0)
 ;;5;;50;NSC
"RTN","ECXUTL3",179,0)
 ;;21;;60;Catastrophic Disability
"RTN","ECXUTL3",180,0)
 ;;12;;101;CHAMPVA
"RTN","ECXUTL3",181,0)
 ;;13;;102;Collateral of Veteran
"RTN","ECXUTL3",182,0)
 ;;14;;103;Employee
"RTN","ECXUTL3",183,0)
 ;;6;;104;Other Federal Agency
"RTN","ECXUTL3",184,0)
 ;;7;;105;Allied Veteran
"RTN","ECXUTL3",185,0)
 ;;8;;106;Humanitarian Emergency
"RTN","ECXUTL3",186,0)
 ;;9;;107;Sharing Agreement
"RTN","ECXUTL3",187,0)
 ;;10;;108;Reimbursable Insurance
"RTN","ECXUTL3",188,0)
 ;;19;;109;TRICARE/CHAMPUS
"RTN","ECXUTL3",189,0)
 ;;22;;25;Purple Heart Recipient
"RTN","ECXUTL3",190,0)
 ;;END
"RTN","ECXUTL3",191,0)
 ;
"RTN","ECXUTL3",192,0)
CPT(ECXCPT,ECXMOD,ECXQUA) ;Returns a str with CPT code and modifier codes
"RTN","ECXUTL3",193,0)
 ;Return string is composed of a 5 character CPT code 2 character quanity
"RTN","ECXUTL3",194,0)
 ;plus up to 5 modifier codes, 2 characters each.
"RTN","ECXUTL3",195,0)
 ; Variables -
"RTN","ECXUTL3",196,0)
 ;  Input  ECXCPT  - Pointer value to the CPT file (#81)
"RTN","ECXUTL3",197,0)
 ;         ECXMOD - A string with pointer values to the CPT
"RTN","ECXUTL3",198,0)
 ;                   MODIFIER file (#81.3) separated by ";"
"RTN","ECXUTL3",199,0)
 ;         ECXQUA  - Number of time this procedure performed
"RTN","ECXUTL3",200,0)
 ;
"RTN","ECXUTL3",201,0)
 ;  Output:
"RTN","ECXUTL3",202,0)
 ;         CPTMOD  - String of up to 17 characters, 5 character CPT
"RTN","ECXUTL3",203,0)
 ;                   code 2 character quanity plus up to 5 2-character
"RTN","ECXUTL3",204,0)
 ;                   code modifiers.
"RTN","ECXUTL3",205,0)
 ;
"RTN","ECXUTL3",206,0)
 N CPT,MOD,I,CPTMOD
"RTN","ECXUTL3",207,0)
 S ECXQUA=$G(ECXQUA,"01"),ECXMOD=$G(ECXMOD)
"RTN","ECXUTL3",208,0)
 S:$L(ECXQUA)'=2 ECXQUA="0"_ECXQUA
"RTN","ECXUTL3",209,0)
 S CPT=$$CPT^ICPTCOD(ECXCPT,"") I +CPT=-1 Q ""
"RTN","ECXUTL3",210,0)
 S CPT=$P(CPT,U,2)_ECXQUA
"RTN","ECXUTL3",211,0)
 F I=1:1:99 I $P(ECXMOD,";",I)'="" D
"RTN","ECXUTL3",212,0)
 . S MOD=$$MOD^ICPTMOD($P(ECXMOD,";",I),"I","")
"RTN","ECXUTL3",213,0)
 . I +MOD>0,$P(MOD,U,2)'="99" S CPT=CPT_$P(MOD,U,2)
"RTN","ECXUTL3",214,0)
 S CPTMOD=$TR($E(CPT,1,17)," ")
"RTN","ECXUTL3",215,0)
 Q CPTMOD
"RTN","ECXUTL3",216,0)
 ;
"RTN","ECXUTL3",217,0)
CPTOUT(ECXCPT) ;output transform for CPT code plus modifiers
"RTN","ECXUTL3",218,0)
 ;input  ECXCPT  - character string of CPT code plus modifiers (required)
"RTN","ECXUTL3",219,0)
 ;
"RTN","ECXUTL3",220,0)
 N J,CPTX,MOD,MODS,MODX,CPTMOD
"RTN","ECXUTL3",221,0)
 Q:$G(ECXCPT)="" ""
"RTN","ECXUTL3",222,0)
 S (CPTMOD,MODX)=""
"RTN","ECXUTL3",223,0)
 S CPTX="("_+$E(ECXCPT,6,7)_") "_$E(ECXCPT,1,5),MODS=$E(ECXCPT,8,17)
"RTN","ECXUTL3",224,0)
 F J=1:2:9 S MOD=$E(MODS,J,J+1) Q:MOD=""  D
"RTN","ECXUTL3",225,0)
 .I J>1 S MODX=MODX_", "_MOD Q
"RTN","ECXUTL3",226,0)
 .S MODX=MODX_"-"_MOD
"RTN","ECXUTL3",227,0)
 S:$L(CPTX)>3 CPTMOD=CPTMOD_CPTX_MODX
"RTN","ECXUTL3",228,0)
 Q CPTMOD
"VER")
8.0^22.0
**END**
**END**
