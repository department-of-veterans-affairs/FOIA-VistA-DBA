Released ECX*3*30 SEQ #30
Extracted from mail message
**KIDS**:ECX*3.0*30^

**INSTALL NAME**
ECX*3.0*30
"BLD",2583,0)
ECX*3.0*30^DSS EXTRACTS^0^3000104^y
"BLD",2583,4,0)
^9.64PA^^
"BLD",2583,"ABPKG")
n
"BLD",2583,"INIT")
ECX3P30P
"BLD",2583,"KRN",0)
^9.67PA^19^18
"BLD",2583,"KRN",.4,0)
.4
"BLD",2583,"KRN",.4,"NM",0)
^9.68A^^
"BLD",2583,"KRN",.401,0)
.401
"BLD",2583,"KRN",.402,0)
.402
"BLD",2583,"KRN",.403,0)
.403
"BLD",2583,"KRN",.5,0)
.5
"BLD",2583,"KRN",.84,0)
.84
"BLD",2583,"KRN",3.6,0)
3.6
"BLD",2583,"KRN",3.8,0)
3.8
"BLD",2583,"KRN",9.2,0)
9.2
"BLD",2583,"KRN",9.8,0)
9.8
"BLD",2583,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",2583,"KRN",9.8,"NM",1,0)
ECXSCXN^^0^B65550962
"BLD",2583,"KRN",9.8,"NM",2,0)
ECXSCX1^^0^B69413442
"BLD",2583,"KRN",9.8,"NM",3,0)
ECXTRAC^^0^B52493798
"BLD",2583,"KRN",9.8,"NM",4,0)
ECX3P30P^^0^B154008
"BLD",2583,"KRN",9.8,"NM",5,0)
ECXSCNS^^0^B20939929
"BLD",2583,"KRN",9.8,"NM",6,0)
ECXMTL^^0^B15225211
"BLD",2583,"KRN",9.8,"NM",7,0)
ECXOPRX^^0^B41474273
"BLD",2583,"KRN",9.8,"NM",8,0)
ECXLABN^^0^B19472996
"BLD",2583,"KRN",9.8,"NM",9,0)
ECXSCLD^^0^B37439246
"BLD",2583,"KRN",9.8,"NM","B","ECX3P30P",4)

"BLD",2583,"KRN",9.8,"NM","B","ECXLABN",8)

"BLD",2583,"KRN",9.8,"NM","B","ECXMTL",6)

"BLD",2583,"KRN",9.8,"NM","B","ECXOPRX",7)

"BLD",2583,"KRN",9.8,"NM","B","ECXSCLD",9)

"BLD",2583,"KRN",9.8,"NM","B","ECXSCNS",5)

"BLD",2583,"KRN",9.8,"NM","B","ECXSCX1",2)

"BLD",2583,"KRN",9.8,"NM","B","ECXSCXN",1)

"BLD",2583,"KRN",9.8,"NM","B","ECXTRAC",3)

"BLD",2583,"KRN",19,0)
19
"BLD",2583,"KRN",19.1,0)
19.1
"BLD",2583,"KRN",101,0)
101
"BLD",2583,"KRN",409.61,0)
409.61
"BLD",2583,"KRN",771,0)
771
"BLD",2583,"KRN",869.2,0)
869.2
"BLD",2583,"KRN",870,0)
870
"BLD",2583,"KRN",8994,0)
8994
"BLD",2583,"KRN","B",.4,.4)

"BLD",2583,"KRN","B",.401,.401)

"BLD",2583,"KRN","B",.402,.402)

"BLD",2583,"KRN","B",.403,.403)

"BLD",2583,"KRN","B",.5,.5)

"BLD",2583,"KRN","B",.84,.84)

"BLD",2583,"KRN","B",3.6,3.6)

"BLD",2583,"KRN","B",3.8,3.8)

"BLD",2583,"KRN","B",9.2,9.2)

"BLD",2583,"KRN","B",9.8,9.8)

"BLD",2583,"KRN","B",19,19)

"BLD",2583,"KRN","B",19.1,19.1)

"BLD",2583,"KRN","B",101,101)

"BLD",2583,"KRN","B",409.61,409.61)

"BLD",2583,"KRN","B",771,771)

"BLD",2583,"KRN","B",869.2,869.2)

"BLD",2583,"KRN","B",870,870)

"BLD",2583,"KRN","B",8994,8994)

"BLD",2583,"QUES",0)
^9.62^^
"BLD",2583,"REQB",0)
^9.611^2^2
"BLD",2583,"REQB",1,0)
ECX*3.0*29^2
"BLD",2583,"REQB",2,0)
ECX*3.0*24^2
"BLD",2583,"REQB","B","ECX*3.0*24",2)

"BLD",2583,"REQB","B","ECX*3.0*29",1)

"INIT")
ECX3P30P
"MBREQ")
0
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^2971222^2980112^11714
"PKG",513,22,1,"PAH",1,0)
30^3000104
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","ECX3P30P")
0^4^B154008
"RTN","ECX3P30P",1,0)
ECX3P30P ;ALB/JAP  Clinic Extract ; 12/16/99
"RTN","ECX3P30P",2,0)
 ;;3.0;DSS EXTRACTS;**30**;Dec 22, 1997
"RTN","ECX3P30P",3,0)
 ;
"RTN","ECX3P30P",4,0)
 S ^ECX(727.1,11,"ROU")="ECXMTL"
"RTN","ECX3P30P",5,0)
 S ^ECX(727.812,0)="MENTAL HEALTH EXTRACT^727.812^0^0"
"RTN","ECX3P30P",6,0)
 Q
"RTN","ECXLABN")
0^8^B19472996
"RTN","ECXLABN",1,0)
ECXLABN ;ALB/JAP,BIR/CML-Lab Extract for DSS (New Format - With LMIP Codes) ; [ 11/22/96  5:14 PM ]
"RTN","ECXLABN",2,0)
 ;;3.0;DSS EXTRACTS;**1,11,8,13,28,24,30**;Dec 22, 1997
"RTN","ECXLABN",3,0)
BEG ;entry point
"RTN","ECXLABN",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXLABN",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXLABN",6,0)
 Q
"RTN","ECXLABN",7,0)
 ;
"RTN","ECXLABN",8,0)
START ; entry when queued
"RTN","ECXLABN",9,0)
 S QFLG=0
"RTN","ECXLABN",10,0)
 K ^LRO(64.03),^TMP($J,"ECXP")
"RTN","ECXLABN",11,0)
 S LRSDT=ECSD,LREDT=ECED
"RTN","ECXLABN",12,0)
 D ^LRCAPDSS
"RTN","ECXLABN",13,0)
 ;quit if no completion date for API compile
"RTN","ECXLABN",14,0)
 I '$P($G(^LRO(64.03,1,1,1,0)),U,4) Q
"RTN","ECXLABN",15,0)
 ;quit if tasked and user sends stop request
"RTN","ECXLABN",16,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD D  Q
"RTN","ECXLABN",17,0)
 .S QFLG=1
"RTN","ECXLABN",18,0)
 .K ^LRO(64.03) S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",19,0)
 ;otherwise, continue
"RTN","ECXLABN",20,0)
 K ECXDD D FIELD^DID(64.03,1,,"SPECIFIER","ECXDD") S ECPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXLABN",21,0)
 S ECLRN=1
"RTN","ECXLABN",22,0)
 F  S ECLRN=$O(^LRO(64.03,ECLRN)) Q:'ECLRN  D  Q:QFLG
"RTN","ECXLABN",23,0)
 .Q:'$D(^LRO(64.03,ECLRN,0))
"RTN","ECXLABN",24,0)
 .S EC1=^LRO(64.03,ECLRN,0)
"RTN","ECXLABN",25,0)
 .S ECDOC=ECPROF_$P(EC1,U,2),ECDOCNPI=""
"RTN","ECXLABN",26,0)
 .S ECLOC=$P(EC1,U,15),EC=$P(EC1,U,3)
"RTN","ECXLABN",27,0)
 .I EC]"" D GET
"RTN","ECXLABN",28,0)
 K ^LRO(64.03),^TMP($J,"ECXP") S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",29,0)
 Q
"RTN","ECXLABN",30,0)
 ;
"RTN","ECXLABN",31,0)
GET ;get data
"RTN","ECXLABN",32,0)
 N X
"RTN","ECXLABN",33,0)
 S ECF=$S($P(EC,";",2)="DPT(":2,$P(EC,";",2)="LRT(67,":67,1:0) Q:'ECF
"RTN","ECXLABN",34,0)
 S ECIFN=$P(EC,";")
"RTN","ECXLABN",35,0)
 ;resolve ecloc
"RTN","ECXLABN",36,0)
 S ECXL1=+$P(ECLOC,";",1),ECXL2=$P(ECLOC,";",2)
"RTN","ECXLABN",37,0)
 I ECF=2 S ECLOC=$S(ECXL1>0:ECXL1,1:"") I ECXL2]"",ECXL2'="SC(" S ECLOC=""
"RTN","ECXLABN",38,0)
 I ECF=67 D  S ECLOC=ECXSTN
"RTN","ECXLABN",39,0)
 .S (ECXSTN,ECXAGC)=""
"RTN","ECXLABN",40,0)
 .I ECXL2'="DIC(4," S ECXSTN="XXXXX",ECXAGC="XX" Q
"RTN","ECXLABN",41,0)
 .I '$D(^DIC(4,ECXL1)) S ECXSTN="XXXXX",ECXAGC="XX" Q
"RTN","ECXLABN",42,0)
 .I $D(^DIC(4,ECXL1)) S ECXSTN=$P(^DIC(4,ECXL1,"99"),U,1),ECXAGC=$E($P(^(99),U,5),1,2) S:ECXSTN="" ECXSTN="ZZZZZ" S:ECXAGC="" ECXAGC="ZZ"
"RTN","ECXLABN",43,0)
 S ECDT=$P(EC1,U,13),ECD=$P(ECDT,"."),ECTM=$$ECXTIME^ECXUTL(ECDT)
"RTN","ECXLABN",44,0)
 S ECWKLD=$P(EC1,U,11),ECWK="" I $D(^LAM(ECWKLD,0)) S ECWK=$P(^(0),U,2)
"RTN","ECXLABN",45,0)
 S ECTREAT=$P(EC1,U,10) I ECTREAT S ECTREAT=$P($G(^DIC(45.7,+ECTREAT,0)),U,2)
"RTN","ECXLABN",46,0)
 S (ECNA,ECSN,ECMN,ECPTTM,ECPTPR,ECCLAS)="",ECA=1,ECXERR=0
"RTN","ECXLABN",47,0)
 ;get the patient data if record is in file #2
"RTN","ECXLABN",48,0)
 I ECF=2 D PAT(ECIFN,$P(ECD,"."),.ECXERR)
"RTN","ECXLABN",49,0)
 Q:ECXERR
"RTN","ECXLABN",50,0)
 ;get patient data if record is in file #67
"RTN","ECXLABN",51,0)
 I ECF=67 S ECSN="000123456",ECNA="RFRL" I $D(^LRT(67,ECIFN,0)) D
"RTN","ECXLABN",52,0)
 .S EC0=^LRT(67,ECIFN,0),ECNA=$E($P($P(EC0,U),",")_"    ",1,4),ECSN=$P(EC0,U,9) D
"RTN","ECXLABN",53,0)
 ..S ECNA=$TR(ECNA,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ECXLABN",54,0)
 ..I ECSN="" S ECSN="000123456" Q
"RTN","ECXLABN",55,0)
 ..S ECSN=$TR(ECSN," "),ECSN=$TR(ECSN,"-")
"RTN","ECXLABN",56,0)
 ..I ($L(ECSN)<9)!($L(ECSN)>10) S ECSN="000123456" Q
"RTN","ECXLABN",57,0)
 ..I $L(ECSN)=9,ECSN'?9N S ECSN="000123456" Q
"RTN","ECXLABN",58,0)
 ..I $L(ECSN)=10,ECSN'?9N1"P" S ECSN="000123456"
"RTN","ECXLABN",59,0)
 ;create extract record only if patient name and accession area exist
"RTN","ECXLABN",60,0)
 S ECXDSSD=""
"RTN","ECXLABN",61,0)
 I ECNA]"" S ECT=$P(EC1,U,8),ECURG=$P(EC1,U,9),EC=+$P(EC1,U,7) I EC D
"RTN","ECXLABN",62,0)
 .S:ECF=2 ECACA=EC_U_$P($G(^LRO(68,EC,0)),U,11) S:ECF=67 ECACA=ECXAGC_U_$P($G(^LRO(68,EC,0)),U,11)
"RTN","ECXLABN",63,0)
 .D FILE
"RTN","ECXLABN",64,0)
 Q
"RTN","ECXLABN",65,0)
 ;
"RTN","ECXLABN",66,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get/set patient data
"RTN","ECXLABN",67,0)
 N X,OK,PT
"RTN","ECXLABN",68,0)
 ;get data
"RTN","ECXLABN",69,0)
 I $D(^TMP($J,"ECXP",ECXDFN)) D
"RTN","ECXLABN",70,0)
 .S PT=^TMP($J,"ECXP",ECXDFN)
"RTN","ECXLABN",71,0)
 .S ECNA=$P(PT,U,1)
"RTN","ECXLABN",72,0)
 .S ECSN=$P(PT,U,2)
"RTN","ECXLABN",73,0)
 .S ECXMPI=$P(PT,U,3)
"RTN","ECXLABN",74,0)
 ;set data and save for later
"RTN","ECXLABN",75,0)
 I '$D(^TMP($J,"ECXP",ECXDFN)) D  Q:'OK
"RTN","ECXLABN",76,0)
 .K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECSD,"."),"1;",.ECXPAT)
"RTN","ECXLABN",77,0)
 .I 'OK S ECXERR=1 Q
"RTN","ECXLABN",78,0)
 .S ECNA=ECXPAT("NAME"),ECSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXLABN",79,0)
 .S ^TMP($J,"ECXP",ECXDFN)=ECNA_U_ECSN_U_ECXMPI
"RTN","ECXLABN",80,0)
 ;get date specific data
"RTN","ECXLABN",81,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECA=$P(X,U,1),ECMN=$P(X,U,2)
"RTN","ECXLABN",82,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."),ECPROF)
"RTN","ECXLABN",83,0)
 S ECPTTM=$P(X,U,1),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3),ECPTNPI=$P(X,U,4),ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6),ECASNPI=$P(X,U,7)
"RTN","ECXLABN",84,0)
 Q
"RTN","ECXLABN",85,0)
 ;
"RTN","ECXLABN",86,0)
FILE ;file record
"RTN","ECXLABN",87,0)
 ;node0
"RTN","ECXLABN",88,0)
 ;facility^patient number^SSN (or equivalent)^name^in/out^day^accession area^abbreviation^test^urgency^treating spec^location^provider and file^
"RTN","ECXLABN",89,0)
 ;movement number^file^time^workload code^primary care team^primary care provider
"RTN","ECXLABN",90,0)
 ;node1
"RTN","ECXLABN",91,0)
 ;mpi^dss dept^provider npi^pc provider npi^pc prov person class^assoc pc prov^assoc pc prov person class^assoc pc prov npi
"RTN","ECXLABN",92,0)
 N DA,DIK
"RTN","ECXLABN",93,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXLABN",94,0)
 S ECODE=EC7_U_EC23
"RTN","ECXLABN",95,0)
 S ECODE=ECODE_U_ECINST_U_ECIFN_U_ECSN_U_ECNA_U_ECA_U_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_ECACA_U_ECT_U_ECURG_U_ECTREAT_U_ECLOC_U_ECDOC_U_ECMN_U_ECF_U_ECTM_U_ECWK_U_ECPTTM_U_ECPTPR
"RTN","ECXLABN",96,0)
 ;(ECACA=acc area^abbreviation)
"RTN","ECXLABN",97,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECDOCNPI_U_ECPTNPI_U_ECCLAS_U_ECASPR_U_ECCLAS2_U_ECASNPI
"RTN","ECXLABN",98,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXLABN",99,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXLABN",100,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXLABN",101,0)
 Q
"RTN","ECXLABN",102,0)
 ;
"RTN","ECXLABN",103,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXLABN",104,0)
 S ECHEAD="LAB"
"RTN","ECXLABN",105,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXLABN",106,0)
 Q
"RTN","ECXLABN",107,0)
 ;
"RTN","ECXLABN",108,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLABN",109,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXMTL")
0^6^B15225211
"RTN","ECXMTL",1,0)
ECXMTL ;ALB/JAP - DSS Mental Health Extract ; 05/26/1999
"RTN","ECXMTL",2,0)
 ;;3.0;DSS EXTRACTS;**24,30**;Dec 22, 1997
"RTN","ECXMTL",3,0)
 ;
"RTN","ECXMTL",4,0)
BEG ;entry point from option
"RTN","ECXMTL",5,0)
 D SETUP I ECFILE="" Q
"RTN","ECXMTL",6,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXMTL",7,0)
 Q
"RTN","ECXMTL",8,0)
 ;
"RTN","ECXMTL",9,0)
START ;entry point from tasked job
"RTN","ECXMTL",10,0)
 S QFLG=0
"RTN","ECXMTL",11,0)
 ;get first record #
"RTN","ECXMTL",12,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1)
"RTN","ECXMTL",13,0)
 ;call mh/dss api for extract record creation
"RTN","ECXMTL",14,0)
 ;variables ecfile,ecxym,ecinst,ecsd,eced passed in by taskmanager
"RTN","ECXMTL",15,0)
 S ECXSEQ=EC7,ECXECX=$P(EC23,U,2),ECXERR=0
"RTN","ECXMTL",16,0)
 ;call mh api to create extract records
"RTN","ECXMTL",17,0)
 S X="YSDSS" X ^%ZOSF("TEST") I '$T S QFLG=1 Q
"RTN","ECXMTL",18,0)
 D UPD^YSDSS(ECFILE,.ECXSEQ,ECXYM,ECXECX,ECINST,ECSD,ECED,.ECXERR)
"RTN","ECXMTL",19,0)
 Q:ECXERR
"RTN","ECXMTL",20,0)
 Q:QFLG
"RTN","ECXMTL",21,0)
 ;if no error, continue
"RTN","ECXMTL",22,0)
 D UPDATE
"RTN","ECXMTL",23,0)
 Q
"RTN","ECXMTL",24,0)
 ;
"RTN","ECXMTL",25,0)
UPDATE ;add non-mh data to each record created by mh api
"RTN","ECXMTL",26,0)
 N JJ
"RTN","ECXMTL",27,0)
 S EC7=EC7+1
"RTN","ECXMTL",28,0)
 F JJ=EC7:1:ECXSEQ Q:QFLG  D
"RTN","ECXMTL",29,0)
 .Q:'$D(^ECX(ECFILE,JJ,0))
"RTN","ECXMTL",30,0)
 .S ECXDFN=$P(^ECX(ECFILE,JJ,0),U,5),ECXDATE=$P(^ECX(ECFILE,JJ,0),U,9),ECXPRV=$P(^ECX(ECFILE,JJ,0),U,18)
"RTN","ECXMTL",31,0)
 .S ECXSCNUM=$P(^ECX(ECFILE,JJ,0),U,23),ECXSCNAM=$P(^ECX(ECFILE,JJ,0),U,24)
"RTN","ECXMTL",32,0)
 .D PAT(ECXDFN,ECXDATE)
"RTN","ECXMTL",33,0)
 .S (ECXPRCLS,ECXPRNPI,ECXDIV)="" I ECXPRV D PROV(.ECXPRV,ECXDATE)
"RTN","ECXMTL",34,0)
 .S ECXDSSI=""
"RTN","ECXMTL",35,0)
 .S ECXDATE=$$ECXDATE^ECXUTL(ECXDATE,ECXYM)
"RTN","ECXMTL",36,0)
 .;adjust scale name & scale number
"RTN","ECXMTL",37,0)
 .S ECXSCNAM=$E(ECXSCNAM,1,10)
"RTN","ECXMTL",38,0)
 .I ECXSCNUM]"",ECXSCNUM'=+ECXSCNUM S ECXSCNUM=+$E(ECXSCNUM,2,99)
"RTN","ECXMTL",39,0)
 .D FILE
"RTN","ECXMTL",40,0)
 Q
"RTN","ECXMTL",41,0)
 ;
"RTN","ECXMTL",42,0)
PAT(ECXDFN,ECXDATE) ;determine in/outpatient status, demographics, primary care
"RTN","ECXMTL",43,0)
 N OK
"RTN","ECXMTL",44,0)
 S (ECXPNM,ECXSSN,ECXMPI)=""
"RTN","ECXMTL",45,0)
 K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,ECXDATE,"1;",.ECXPAT)
"RTN","ECXMTL",46,0)
 S ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXMTL",47,0)
 ;get primary care data
"RTN","ECXMTL",48,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,ECXDATE)
"RTN","ECXMTL",49,0)
 S ECPTTM=$P(X,U,1)
"RTN","ECXMTL",50,0)
 S ECPTPR=$P(X,U,2)
"RTN","ECXMTL",51,0)
 S ECCLAS=$P(X,U,3)
"RTN","ECXMTL",52,0)
 S ECPTNPI=$P(X,U,4)
"RTN","ECXMTL",53,0)
 S ECASPR=$P(X,U,5)
"RTN","ECXMTL",54,0)
 S ECCLAS2=$P(X,U,6)
"RTN","ECXMTL",55,0)
 S ECASNPI=$P(X,U,7)
"RTN","ECXMTL",56,0)
 ;get inpatient data
"RTN","ECXMTL",57,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE)
"RTN","ECXMTL",58,0)
 S ECXA=$P(X,U,1),ECXADMDT=$P($P(X,U,4),"."),ECXDCDT=$P($P(X,U,6),".")
"RTN","ECXMTL",59,0)
 S ECXWPRV=$P(X,U,7),ECXATT=$P(X,U,8)
"RTN","ECXMTL",60,0)
 I ECXADMDT S ECXADMDT=$$ECXDATE^ECXUTL(ECXADMDT,ECXYM)
"RTN","ECXMTL",61,0)
 I ECXDCDT S ECXDCDT=$$ECXDATE^ECXUTL(ECXDCDT,ECXYM)
"RTN","ECXMTL",62,0)
 Q
"RTN","ECXMTL",63,0)
 ;
"RTN","ECXMTL",64,0)
PROV(ECXPRV,ECXDATE) ;get provider data
"RTN","ECXMTL",65,0)
 N INST,DGIEN,ARR,DIC,DR,DA,DIQ
"RTN","ECXMTL",66,0)
 S ECXPRCLS=$$PRVCLASS^ECXUTL(ECXPRV,ECXDATE)
"RTN","ECXMTL",67,0)
 S ECXPRNPI=""
"RTN","ECXMTL",68,0)
 ;get division identifier using provider
"RTN","ECXMTL",69,0)
 S ECXDIV=""
"RTN","ECXMTL",70,0)
 S IEN=0 F  D  Q:'IEN  Q:'INST  Q:ECXDIV
"RTN","ECXMTL",71,0)
 .;get pointer to file #4 from provider record
"RTN","ECXMTL",72,0)
 .I '$D(^VA(200,ECXPRV,0)) Q
"RTN","ECXMTL",73,0)
 .S IEN=$O(^VA(200,ECXPRV,2,IEN))
"RTN","ECXMTL",74,0)
 .Q:'IEN
"RTN","ECXMTL",75,0)
 .S DIC="^VA(200,",DR="16",DA=ECXPRV
"RTN","ECXMTL",76,0)
 .S DR(200.02)=".01",DA(200.02)=IEN,DIQ="ARR",DIQ(0)="I"
"RTN","ECXMTL",77,0)
 .D EN^DIQ1
"RTN","ECXMTL",78,0)
 .S INST=$G(ARR(200.02,IEN,.01,"I"))
"RTN","ECXMTL",79,0)
 .Q:'INST
"RTN","ECXMTL",80,0)
 .;get medical center division
"RTN","ECXMTL",81,0)
 .S DGIEN=$O(^DG(40.8,"AD",INST,0)) I DGIEN D
"RTN","ECXMTL",82,0)
 ..S ECXDIV=$P($G(^ECX(727.3,DGIEN,0)),U,2)
"RTN","ECXMTL",83,0)
 S ECXPRV="2"_ECXPRV
"RTN","ECXMTL",84,0)
 Q
"RTN","ECXMTL",85,0)
 ;
"RTN","ECXMTL",86,0)
FILE ;file record in #727.812
"RTN","ECXMTL",87,0)
 ;node0
"RTN","ECXMTL",88,0)
 ;facility^dfn^ssn^name^i/o status^day^division^admit date^d/c date^dss id^pc team^pc provider^pc provider npi^pc prov person class^
"RTN","ECXMTL",89,0)
 ;provider^provider npi^prov person class^test name^test ien^scale number^scale name^test score^scale score^attend phys^ward provider
"RTN","ECXMTL",90,0)
 ;node1
"RTN","ECXMTL",91,0)
 ;mpi^assoc pc provider^assoc pc provider npi^assoc pc prov person class^asi class^asi special
"RTN","ECXMTL",92,0)
 N DA,DIK
"RTN","ECXMTL",93,0)
 S $P(^ECX(ECFILE,JJ,0),U,6,9)=ECXSSN_U_ECXPNM_U_ECXA_U_ECXDATE
"RTN","ECXMTL",94,0)
 S $P(^ECX(ECFILE,JJ,0),U,10,17)=ECXDIV_U_ECXADMDT_U_ECXDCDT_U_ECXDSSI_U_ECPTTM_U_ECPTPR_U_ECPTNPI_U_ECCLAS
"RTN","ECXMTL",95,0)
 S $P(^ECX(ECFILE,JJ,0),U,18,20)=ECXPRV_U_ECXPRNPI_U_ECXPRCLS
"RTN","ECXMTL",96,0)
 S $P(^ECX(ECFILE,JJ,0),U,23,24)=ECXSCNUM_U_ECXSCNAM
"RTN","ECXMTL",97,0)
 S $P(^ECX(ECFILE,JJ,0),U,27,28)=ECXATT_U_ECXWPRV
"RTN","ECXMTL",98,0)
 I '$D(^ECX(ECFILE,JJ,1)) S ^ECX(727.812,JJ,1)="^^^^^"
"RTN","ECXMTL",99,0)
 S $P(^ECX(ECFILE,JJ,1),U,1,4)=ECXMPI_U_ECASPR_U_ECASNPI_U_ECCLAS2
"RTN","ECXMTL",100,0)
 S DA=JJ,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXMTL",101,0)
 S ECRN=ECRN+1
"RTN","ECXMTL",102,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXMTL",103,0)
 Q
"RTN","ECXMTL",104,0)
 ;
"RTN","ECXMTL",105,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXMTL",106,0)
 S ECHEAD="MTL"
"RTN","ECXMTL",107,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXMTL",108,0)
 Q
"RTN","ECXMTL",109,0)
 ;
"RTN","ECXMTL",110,0)
QUE ;Entry point for the background requeuing handled by ECXTAUTO.
"RTN","ECXMTL",111,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL
"RTN","ECXMTL",112,0)
 Q
"RTN","ECXOPRX")
0^7^B41474273
"RTN","ECXOPRX",1,0)
ECXOPRX ;ALB/JAP,BIR/DMA,CML,PTD-Prescription Extract for DSS ; [ 03/26/97  2:09 PM ]
"RTN","ECXOPRX",2,0)
 ;;3.0;DSS EXTRACTS;**10,11,8,13,24,30**;Dec 22, 1997
"RTN","ECXOPRX",3,0)
 ;
"RTN","ECXOPRX",4,0)
BEG ;entry point from option
"RTN","ECXOPRX",5,0)
 D SETUP I ECFILE="" Q
"RTN","ECXOPRX",6,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXOPRX",7,0)
 Q
"RTN","ECXOPRX",8,0)
START ;entry when queued
"RTN","ECXOPRX",9,0)
 N X,DA,DIC,DIQ,DR
"RTN","ECXOPRX",10,0)
 S QFLG=0
"RTN","ECXOPRX",11,0)
 I '$D(ECINST) D
"RTN","ECXOPRX",12,0)
 .S ECINST=+$P(^ECX(728,1,0),U) K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXOPRX",13,0)
 .D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXOPRX",14,0)
 ;before V6
"RTN","ECXOPRX",15,0)
 S ECPROF=6
"RTN","ECXOPRX",16,0)
 S ECD=$O(^PSRX("AL",0)) I ECD,ECD<ECSD1 G V6
"RTN","ECXOPRX",17,0)
 S ECED=ECED+.3,ECREF=1,ECD=ECSD1
"RTN","ECXOPRX",18,0)
 F  S ECD=$O(^PSRX("AD",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:QFLG  F  S ECRX=$O(^PSRX("AD",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AD",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",19,0)
 Q
"RTN","ECXOPRX",20,0)
 ;
"RTN","ECXOPRX",21,0)
V6 ;version 6 or better
"RTN","ECXOPRX",22,0)
 K ^TMP($J,"ECXP")
"RTN","ECXOPRX",23,0)
 S ECPROF=2
"RTN","ECXOPRX",24,0)
 S ECED=ECED+.3,ECREF=1,ECD=ECSD1
"RTN","ECXOPRX",25,0)
 F  S ECD=$O(^PSRX("AL",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:QFLG  F  S ECRX=$O(^PSRX("AL",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AL",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",26,0)
 Q:QFLG
"RTN","ECXOPRX",27,0)
 S ECREF="P",ECD=ECSD1
"RTN","ECXOPRX",28,0)
 F  S ECD=$O(^PSRX("AM",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:QFLG  F  S ECRX=$O(^PSRX("AM",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AM",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",29,0)
 K ^TMP($J,"ECXP")
"RTN","ECXOPRX",30,0)
 Q
"RTN","ECXOPRX",31,0)
 ;
"RTN","ECXOPRX",32,0)
STUFF ;get data
"RTN","ECXOPRX",33,0)
 S ECDATA=^PSRX(ECRX,0)
"RTN","ECXOPRX",34,0)
 I ECRFL S ECDATA1=$G(^PSRX(ECRX,ECREF,ECRFL,0)) I ECDATA1="" Q
"RTN","ECXOPRX",35,0)
 ;ecref set to 1 in extract+5 and v6+1 and to "P" in v6+2
"RTN","ECXOPRX",36,0)
 ;refill nodes and partial nodes are identical in layout
"RTN","ECXOPRX",37,0)
 ;fills (ie., ecrfl=0) and refills (ie.,ecrfl>0) from the "AL" cross-reference, partials from the "AM"
"RTN","ECXOPRX",38,0)
 S ECXDATE=ECD
"RTN","ECXOPRX",39,0)
 S ECXPROV=$P(ECDATA,U,4),ECDRG=+$P(ECDATA,U,6)
"RTN","ECXOPRX",40,0)
 ;get patient specific data
"RTN","ECXOPRX",41,0)
 S ECXDFN=$P(ECDATA,U,2),ECXERR=0
"RTN","ECXOPRX",42,0)
 D PAT(ECXDFN,ECXDATE,.ECXERR)
"RTN","ECXOPRX",43,0)
 Q:ECXERR
"RTN","ECXOPRX",44,0)
 I 'ECRFL D
"RTN","ECXOPRX",45,0)
 .S ECMW=$P(ECDATA,U,11),ECQTY=+$P(ECDATA,U,7),ECXDIV=$S($D(^PSRX(ECRX,2)):$P(^(2),U,9),1:1)
"RTN","ECXOPRX",46,0)
 .S ECPRC=+$P(ECDATA,U,17),ECOPAY=$P($G(^PSRX(ECRX,"IB")),U,2)]""
"RTN","ECXOPRX",47,0)
 .S ECXPROV="" S:$P(ECDATA,U,4)]"" ECXPROV=$P(ECDATA,U,4)
"RTN","ECXOPRX",48,0)
 I ECRFL D
"RTN","ECXOPRX",49,0)
 .S ECMW=$P(ECDATA1,U,2),ECQTY=+$P(ECDATA1,U,4),ECXDIV=$S(+$P(ECDATA1,U,9):$P(ECDATA1,U,9),1:1)
"RTN","ECXOPRX",50,0)
 .S ECPRC=+$P(ECDATA1,U,11),ECOPAY=$P($G(^PSRX(ECRX,1,ECRFL,"IB")),U)]""
"RTN","ECXOPRX",51,0)
 .S ECXPROV="" S:$P(ECDATA1,U,17)]"" ECXPROV=$P(ECDATA1,U,17)
"RTN","ECXOPRX",52,0)
 S (ECXPROVN,ECXPROVP)="" I ECXPROV]"" D
"RTN","ECXOPRX",53,0)
 .S ECXPROVP=$$PRVCLASS^ECXUTL(ECXPROV,ECSD1),ECXPROVN=""
"RTN","ECXOPRX",54,0)
 .S ECXPROV=ECPROF_ECXPROV
"RTN","ECXOPRX",55,0)
 S ECXCOST=$J((ECQTY*ECPRC),1,2)
"RTN","ECXOPRX",56,0)
 S ECDS=$S(ECRFL:$P(ECDATA1,U,10),1:$P(ECDATA,U,8))
"RTN","ECXOPRX",57,0)
 S ECCAT=$P(^PSDRUG(ECDRG,0),U,2),ECINV=$P(^(0),U,3)["I",ECINV=$S(ECINV:"I",1:"")
"RTN","ECXOPRX",58,0)
 S ECUI=$P($G(^PSDRUG(ECDRG,660)),U,8)
"RTN","ECXOPRX",59,0)
 S ECNDC=$P($G(^PSDRUG(ECDRG,2)),U,4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXOPRX",60,0)
 S ECNDF=$G(^PSDRUG(ECDRG,"ND")),P1=$P(ECNDF,U),P3=$P(ECNDF,U,3)
"RTN","ECXOPRX",61,0)
 S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXOPRX",62,0)
 I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXOPRX",63,0)
 S ECXDSSD=""
"RTN","ECXOPRX",64,0)
 I ECMW="M" S ECMW=1 I $D(^PSRX("AR",ECD,ECRX)) S ECMW=2
"RTN","ECXOPRX",65,0)
 I ECMW="W" S ECMW=""
"RTN","ECXOPRX",66,0)
 S ECXNEW="" I ECRFL=0 S ECXNEW=1
"RTN","ECXOPRX",67,0)
 D FILE
"RTN","ECXOPRX",68,0)
 Q
"RTN","ECXOPRX",69,0)
 ;
"RTN","ECXOPRX",70,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;Determine in/outpatient status, movement number, primary care team and provider.
"RTN","ECXOPRX",71,0)
 N OK,X,PT
"RTN","ECXOPRX",72,0)
 ;get patient data if saved
"RTN","ECXOPRX",73,0)
 I $D(^TMP($J,"ECXP",ECXDFN)) D
"RTN","ECXOPRX",74,0)
 .S PT=^TMP($J,"ECXP",ECXDFN)
"RTN","ECXOPRX",75,0)
 .S ECXSSN=$P(PT,U,1)
"RTN","ECXOPRX",76,0)
 .S ECXPNM=$P(PT,U,2)
"RTN","ECXOPRX",77,0)
 .S ECXMPI=$P(PT,U,3)
"RTN","ECXOPRX",78,0)
 .S ECXSEX=$P(PT,U,4)
"RTN","ECXOPRX",79,0)
 .S ECXDOB=$P(PT,U,5)
"RTN","ECXOPRX",80,0)
 .S ECXELIG=$P(PT,U,6)
"RTN","ECXOPRX",81,0)
 .S ECXVET=$P(PT,U,7)
"RTN","ECXOPRX",82,0)
 .S ECXRACE=$P(PT,U,8)
"RTN","ECXOPRX",83,0)
 .S ECXPST=$P(PT,U,9)
"RTN","ECXOPRX",84,0)
 .S ECXPLOC=$P(PT,U,10)
"RTN","ECXOPRX",85,0)
 .S ECXRST=$P(PT,U,11)
"RTN","ECXOPRX",86,0)
 .S ECXAST=$P(PT,U,12)
"RTN","ECXOPRX",87,0)
 .S ECXMST=$P(PT,U,13)
"RTN","ECXOPRX",88,0)
 .S ECXSTATE=$P(PT,U,14)
"RTN","ECXOPRX",89,0)
 .S ECXCNTY=$P(PT,U,15)
"RTN","ECXOPRX",90,0)
 .S ECXZIP=$P(PT,U,16)
"RTN","ECXOPRX",91,0)
 .S ECXENRL=$P(PT,U,17)
"RTN","ECXOPRX",92,0)
 .S ECXPAYOR=$P(PT,U,18)
"RTN","ECXOPRX",93,0)
 .S ECXSAI=$P(PT,U,19)
"RTN","ECXOPRX",94,0)
 ;set patient data
"RTN","ECXOPRX",95,0)
 I '$D(^TMP($J,"ECXP",ECXDFN)) D  Q:'OK
"RTN","ECXOPRX",96,0)
 .K ECXPAT
"RTN","ECXOPRX",97,0)
 .S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECSD1,"."),"1;2;3;5",.ECXPAT)
"RTN","ECXOPRX",98,0)
 .I 'OK S ECXERR=1 Q
"RTN","ECXOPRX",99,0)
 .S ECXSSN=ECXPAT("SSN")
"RTN","ECXOPRX",100,0)
 .S ECXPNM=ECXPAT("NAME")
"RTN","ECXOPRX",101,0)
 .S ECXMPI=ECXPAT("MPI")
"RTN","ECXOPRX",102,0)
 .S ECXSEX=ECXPAT("SEX")
"RTN","ECXOPRX",103,0)
 .S ECXDOB=ECXPAT("DOB")
"RTN","ECXOPRX",104,0)
 .S ECXELIG=ECXPAT("ELIG")
"RTN","ECXOPRX",105,0)
 .S ECXVET=ECXPAT("VET")
"RTN","ECXOPRX",106,0)
 .S ECXRACE=ECXPAT("RACE")
"RTN","ECXOPRX",107,0)
 .S ECXPST=ECXPAT("POW STAT")
"RTN","ECXOPRX",108,0)
 .S ECXPLOC=ECXPAT("POW LOC")
"RTN","ECXOPRX",109,0)
 .S ECXRST=ECXPAT("IR STAT")
"RTN","ECXOPRX",110,0)
 .S ECXAST=ECXPAT("AO STAT")
"RTN","ECXOPRX",111,0)
 .S ECXMST=ECXPAT("MST STAT")
"RTN","ECXOPRX",112,0)
 .S ECXSTATE=ECXPAT("STATE")
"RTN","ECXOPRX",113,0)
 .S ECXCNTY=ECXPAT("COUNTY")
"RTN","ECXOPRX",114,0)
 .S ECXZIP=ECXPAT("ZIP")
"RTN","ECXOPRX",115,0)
 .S ECXENRL=ECXPAT("ENROLL LOC")
"RTN","ECXOPRX",116,0)
 .;get sharing agreement data
"RTN","ECXOPRX",117,0)
 .S (ECXPAYOR,ECXSAI)=""
"RTN","ECXOPRX",118,0)
 .D VISN19^ECXUTL2(ECXDFN,.ECXPAYOR,.ECXSAI)
"RTN","ECXOPRX",119,0)
 .;save for later
"RTN","ECXOPRX",120,0)
 .S ^TMP($J,"ECXP",ECXDFN)=ECXSSN_U_ECXPNM_U_ECXMPI_U_ECXSEX_U_ECXDOB_U_ECXELIG_U_ECXVET_U_ECXRACE_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST_U_ECXMST_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXENRL_U_ECXPAYOR_U_ECXSAI
"RTN","ECXOPRX",121,0)
 ;get inpatient data
"RTN","ECXOPRX",122,0)
 S ECXA=1,ECXMN="",ECXTS=""
"RTN","ECXOPRX",123,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE) D
"RTN","ECXOPRX",124,0)
 .Q:$P($P(X,U,6),".")=ECXDATE
"RTN","ECXOPRX",125,0)
 .S ECXA=$P(X,U,1),ECXMN=$P(X,U,2),ECXTS=$P(X,U,3)
"RTN","ECXOPRX",126,0)
 ;get primary care data
"RTN","ECXOPRX",127,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."))
"RTN","ECXOPRX",128,0)
 S ECPTTM=$P(X,U,1)
"RTN","ECXOPRX",129,0)
 S ECPTPR=$P(X,U,2)
"RTN","ECXOPRX",130,0)
 S ECCLAS=$P(X,U,3)
"RTN","ECXOPRX",131,0)
 S ECPTNPI=$P(X,U,4)
"RTN","ECXOPRX",132,0)
 S ECASPR=$P(X,U,5)
"RTN","ECXOPRX",133,0)
 S ECCLAS2=$P(X,U,6)
"RTN","ECXOPRX",134,0)
 S ECASNPI=$P(X,U,7)
"RTN","ECXOPRX",135,0)
 Q
"RTN","ECXOPRX",136,0)
 ;
"RTN","ECXOPRX",137,0)
FILE ;file record
"RTN","ECXOPRX",138,0)
 ;node0
"RTN","ECXOPRX",139,0)
 ;inst^dfn^ssn^name^in/out^day^division^provider^drug category^mail^placeholder1^new^placeholder2^qty^cost^placeholder3^
"RTN","ECXOPRX",140,0)
 ;mov #^treat spec^placeholder4^unit of issue^dob^elig^vet^copay^feeder key^investigational^days supply^primary care team^primary care provider^time^race
"RTN","ECXOPRX",141,0)
 ;node1
"RTN","ECXOPRX",142,0)
 ;mpi^dss dept^sex^zip+4^provider npi^pc provider npi^state^county^pc prov person class^pow status^pow location^
"RTN","ECXOPRX",143,0)
 ;ir status^ao status^sharing agree. payor^sharing agree. ins.^mst status^enroll loc^assoc pc provider^assoc pc prov person class^assoc pc prov npi
"RTN","ECXOPRX",144,0)
 N DA,DIK
"RTN","ECXOPRX",145,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXOPRX",146,0)
 S ECODE=EC7_U_EC23
"RTN","ECXOPRX",147,0)
 S ECODE=ECODE_U_ECINST_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECXDIV
"RTN","ECXOPRX",148,0)
 S ECODE=ECODE_U_ECXPROV_U_ECCAT_U_ECMW_U_ECXPROVP_U_ECXNEW_U_U_ECQTY_U_ECXCOST_U_U_ECXMN_U_ECXTS_U_U_ECUI_U_ECXDOB
"RTN","ECXOPRX",149,0)
 S ECODE=ECODE_U_ECXELIG_U_ECXVET_U_ECOPAY_U_ECNFC_U_ECINV_U_ECDS_U_ECPTTM_U_ECPTPR_U_$$ECXTIME^ECXUTL(ECXDATE)_U_ECXRACE
"RTN","ECXOPRX",150,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXSEX_U_ECXZIP_U_ECXPROVN_U_ECPTNPI_U_ECXSTATE_U_ECXCNTY_U_ECCLAS_U_ECXPST_U_ECXPLOC
"RTN","ECXOPRX",151,0)
 S ECODE1=ECODE1_U_ECXRST_U_ECXAST_U_ECXPAYOR_U_ECXSAI_U_ECXMST_U_ECXENRL_U_ECASPR_U_ECCLAS2_U_ECASNPI
"RTN","ECXOPRX",152,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXOPRX",153,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXOPRX",154,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXOPRX",155,0)
 Q
"RTN","ECXOPRX",156,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXOPRX",157,0)
 S ECHEAD="PRE"
"RTN","ECXOPRX",158,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXOPRX",159,0)
 Q
"RTN","ECXOPRX",160,0)
 ;
"RTN","ECXOPRX",161,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXOPRX",162,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSCLD")
0^9^B37439246
"RTN","ECXSCLD",1,0)
ECXSCLD ;BIR/DMA,CML-Enter, Print and Edit Entries in 728.44 ; [ 12/12/96  4:14 PM ]
"RTN","ECXSCLD",2,0)
 ;;3.0;DSS EXTRACTS;**2,8,24,30**;Dec 22, 1997
"RTN","ECXSCLD",3,0)
EN ;entry point from option
"RTN","ECXSCLD",4,0)
 ;load entries
"RTN","ECXSCLD",5,0)
 W !!,"This option creates local entries in the DSS CLINIC AND STOP CODES file.",!
"RTN","ECXSCLD",6,0)
 I '$D(^ECX(728.44)) W !,"DSS Clinic stop code file does not exist",!! R X:5 K X Q
"RTN","ECXSCLD",7,0)
 K ZTSAVE S ZTDESC="Gather Clinic stop codes for DSS",ZTRTN="START^ECXSCLD",ZTIO="" D ^%ZTLOAD
"RTN","ECXSCLD",8,0)
 Q
"RTN","ECXSCLD",9,0)
START ; entry point
"RTN","ECXSCLD",10,0)
 S EC=0,ECNT=0 F  S EC=$O(^SC(EC)) Q:'EC  I $D(^(EC,0)) S ECD=^(0),DAT=$G(^("I")) I $P(ECD,U,3)="C" D FIX
"RTN","ECXSCLD",11,0)
 K DIK S DIK="^ECX(728.44,",DIK(1)=".01^B" D ENALL^DIK
"RTN","ECXSCLD",12,0)
 ;S $P(^ECX(728.44,0),U,3,4)=ECL_U_ECNT
"RTN","ECXSCLD",13,0)
 K ZTDESC,EC,J,ECD,ECD2,ECL,ECS,ECS2,ECP
"RTN","ECXSCLD",14,0)
 S ZTREQ="@" Q
"RTN","ECXSCLD",15,0)
 ;
"RTN","ECXSCLD",16,0)
FIX ; get stop codes and default style for feeder key
"RTN","ECXSCLD",17,0)
 ; 1 if no credit stop code - 5 if credit stop code exists
"RTN","ECXSCLD",18,0)
 K ECD2,ECS2 I $D(^ECX(728.44,EC,0)) S ECD2=^(0) F ECS=2,3 S ECS2(ECS)=$P(ECD2,U,ECS)
"RTN","ECXSCLD",19,0)
 S ID=+DAT,RD=$P(DAT,U,2)
"RTN","ECXSCLD",20,0)
 I $D(ECD2) D
"RTN","ECXSCLD",21,0)
 .I ID,ID'>DT I 'RD!(RD>DT) S:$P(ECD2,U,10)'=ID $P(ECD2,U,7)="" S $P(ECD2,U,10)=ID
"RTN","ECXSCLD",22,0)
 .I ID,RD,RD'>DT S:$P(ECD2,U,10) $P(ECD2,U,7)="" S $P(ECD2,U,10)=""
"RTN","ECXSCLD",23,0)
 .I ID,ID>DT S:$P(ECD2,U,10) $P(ECD2,U,7)="" S $P(ECD2,U,10)=""
"RTN","ECXSCLD",24,0)
 .I 'ID,$P(ECD2,U,10) S $P(ECD2,U,7)="",$P(ECD2,U,10)=""
"RTN","ECXSCLD",25,0)
 F ECS=7,18 S ECP=+$P(ECD,U,ECS),ECS(ECS)=$P($G(^DIC(40.7,ECP,0)),U,2)
"RTN","ECXSCLD",26,0)
 S ECDF=$S(ECS(18)]"":5,1:1) S:$P(ECD,U,17)="Y" ECDF=6 S:$G(^SC(EC,"OOS")) ECDF=6
"RTN","ECXSCLD",27,0)
 S ECL=EC,ECD=EC_U_ECS(7)_U_ECS(18)
"RTN","ECXSCLD",28,0)
 I '$D(ECD2) D
"RTN","ECXSCLD",29,0)
 .S $P(^ECX(728.44,EC,0),U,1,5)=ECD_U_ECS(7)_U_ECS(18),ECNT=ECNT+1,$P(^(0),U,6)=ECDF
"RTN","ECXSCLD",30,0)
 I $D(ECD2) D
"RTN","ECXSCLD",31,0)
 .S $P(ECD2,U,1,3)=ECD
"RTN","ECXSCLD",32,0)
 .I +ECS(7)'=+ECS2(2)!(+ECS(18)'=+ECS2(3)) S $P(ECD2,U,7)=""
"RTN","ECXSCLD",33,0)
 .S ^ECX(728.44,EC,0)=ECD2
"RTN","ECXSCLD",34,0)
 Q
"RTN","ECXSCLD",35,0)
 ;
"RTN","ECXSCLD",36,0)
PRINT ; print worksheet for updates
"RTN","ECXSCLD",37,0)
 I '$O(^ECX(728.44,0)) W !,"DSS Clinic stop code file does not exist",!! R X:5 K X Q
"RTN","ECXSCLD",38,0)
 W !!,"This option produces a worksheet of (A)ll DSS Clinic Stops or only the",!,"(U)nreviewed Clinic Stops that are awaiting approval.  Clinics that were"
"RTN","ECXSCLD",39,0)
 W !,"defined as ""inactive"" by MAS the last time the option ""Create DSS Clinic",!,"Stop Code File"" was run will be indicated with an ""*"".",!
"RTN","ECXSCLD",40,0)
 S DIR(0)="S^A:ALL;U:UNREVIEWED",DIR("A")="Enter ""A"" or ""U""",DIR("?",1)="Enter: ""A"" to print a worksheet of all DSS Clinic Stops,",DIR("?")="       ""U"" to print only the Clinic Stops that have not been approved."
"RTN","ECXSCLD",41,0)
 D ^DIR K DIR G END:$D(DIRUT) S ECALL=$E(Y)
"RTN","ECXSCLD",42,0)
 S %ZIS="Q" D ^%ZIS Q:POP
"RTN","ECXSCLD",43,0)
 I $D(IO("Q")) K ZTSAVE S ZTDESC="DSS clinic stop code work sheet",ZTRTN="SPRINT^ECXSCLD",ZTSAVE("ECALL")="" D ^%ZTLOAD,HOME^%ZIS Q
"RTN","ECXSCLD",44,0)
 U IO
"RTN","ECXSCLD",45,0)
SPRINT ; queued entry to print work sheet
"RTN","ECXSCLD",46,0)
 S QFLG=0,$P(LN,"-",81)="",PG=0
"RTN","ECXSCLD",47,0)
 S ECDATE=$O(^ECX(728.44,"A1","")) I ECDATE S ECDATE=-ECDATE,ECDATE=$$FMTE^XLFDT(ECDATE,"5DF"),ECDATE=$TR(ECDATE," ","0")
"RTN","ECXSCLD",48,0)
 K ^TMP("EC",$J) F J=0:0 S J=$O(^ECX(728.44,J)) Q:'J  I $D(^ECX(728.44,J,0)),$S(ECALL="A":1,1:$P(^(0),U,7)="") S ECSD=^(0) I $D(^SC(J,0)) S ECSC=$P(^(0),U),^TMP("EC",$J,ECSC)=$P(ECSD,U,2,200)
"RTN","ECXSCLD",49,0)
 D HEAD S ECSC="" I $O(^TMP("EC",$J,ECSC))="" W !!,"NO DATA FOUND FOR WORKSHEET.",! G END
"RTN","ECXSCLD",50,0)
 F J=1:1 S ECSC=$O(^TMP("EC",$J,ECSC)) Q:ECSC=""  S ECD=^(ECSC) D SHOWEM Q:QFLG
"RTN","ECXSCLD",51,0)
 I $E(IOST)="C",'QFLG D SS
"RTN","ECXSCLD",52,0)
 K ^TMP("EC",$J),J,ECSC,ECSD,ECDATE,QFLG,PG,LN,SS
"RTN","ECXSCLD",53,0)
 W:$Y @IOF D ^%ZISC S ZTREQ="@"
"RTN","ECXSCLD",54,0)
 Q
"RTN","ECXSCLD",55,0)
 ;
"RTN","ECXSCLD",56,0)
HEAD ; header for worksheet
"RTN","ECXSCLD",57,0)
 D SS Q:QFLG
"RTN","ECXSCLD",58,0)
 S PG=PG+1 W:$Y!($E(IOST)="C") @IOF W !,"WORKSHEET FOR DSS CLINIC STOPS",?72,"Page: ",PG
"RTN","ECXSCLD",59,0)
 I ECDATE]"" W !,"(last reviewed on ",ECDATE,")"
"RTN","ECXSCLD",60,0)
 E  W !,"(NEVER REVIEWED)"
"RTN","ECXSCLD",61,0)
 W !
"RTN","ECXSCLD",62,0)
 W !!,?1,"CLINIC",?33,"STOP",?40,"CREDIT",?49,"DSS",?56,"DSS",?65,"ACTION",?73,"NAT'L"
"RTN","ECXSCLD",63,0)
 W !,?33,"CODE",?40,"STOP",?49,"STOP",?56,"CREDIT",?73,"CODE",!,?1,"(* - currently inactive)",?40,"CODE",?49,"CODE",?56,"CODE",!,LN Q
"RTN","ECXSCLD",64,0)
 ;
"RTN","ECXSCLD",65,0)
SHOWEM ; list clinics for worksheet
"RTN","ECXSCLD",66,0)
 I $Y+4>IOSL D HEAD Q:QFLG
"RTN","ECXSCLD",67,0)
 W !!,$E(ECSC,1,30) W:$P(ECD,U,9)]"" "*" F J=1:1:5 W ?$P("33,40,49,56,68",",",J),$S($P(ECD,U,J):$P(ECD,U,J),J<3:"",1:"_____")
"RTN","ECXSCLD",68,0)
 S ECN=$P($G(^ECX(728.441,+$P(ECD,U,7),0)),U) W ?73,$S(ECN]"":ECN,1:"____")
"RTN","ECXSCLD",69,0)
 Q
"RTN","ECXSCLD",70,0)
SS ;SCROLL STOPS
"RTN","ECXSCLD",71,0)
 I $E(IOST)="C" S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXSCLD",72,0)
 I $E(IOST)="C",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXSCLD",73,0)
 Q
"RTN","ECXSCLD",74,0)
 ;
"RTN","ECXSCLD",75,0)
EDIT ; put in DSS stopcodes and which one to send
"RTN","ECXSCLD",76,0)
 I '$O(^ECX(728.44,0)) W !,"DSS Clinic stop code file does not exist",!! R X:5 K X Q
"RTN","ECXSCLD",77,0)
 W ! S DIC=728.44,DIC(0)="QEAMZ" D ^DIC G END:Y<0 W !,"STOP CODE : ",$P(Y(0),U,2),!,"CREDIT STOP CODE : ",$P(Y(0),U,3)
"RTN","ECXSCLD",78,0)
 S DIE=DIC,DA=+Y,DR="3;4;5//1;S:X'=4 Y=6;7;6///"_DT_";8" D ^DIE S:$P(^ECX(728.44,DA,0),U,6)'=4 $P(^(0),U,8)="" S $P(^(0),U,7)="" K DIC,DIE,DA G EDIT
"RTN","ECXSCLD",79,0)
 ;
"RTN","ECXSCLD",80,0)
APPROVE ; approve current DSS Stop and Credit Stop codes
"RTN","ECXSCLD",81,0)
 W !!,"This option allows you to mark the current clinic entries in the CLINICS AND",!,"STOP CODES file (#728.44) as ""reviewed"".  Those entries will then be omitted"
"RTN","ECXSCLD",82,0)
 W !,"from the list printed from the ""Clinic and DSS Stop Codes Print"" when you",!,"choose to print only ""unreviewed"" clinics.",!
"RTN","ECXSCLD",83,0)
 K DIR S DIR(0)="Y",DIR("A",1)="Are you ready to approve the reviewed information provided by the",DIR("A")="""Clinic and DSS Stop Codes Print""",DIR("B")="NO"
"RTN","ECXSCLD",84,0)
 S DIR("?",1)="   Enter:"
"RTN","ECXSCLD",85,0)
 S DIR("?",2)="     ""YES"" if you concur with the ""Clinic and DSS Stop Codes Print"","
"RTN","ECXSCLD",86,0)
 S DIR("?",3)="     ""NO"" or <RET> if you do not want to approve the current information,"
"RTN","ECXSCLD",87,0)
 S DIR("?")="     ""^"" to exit option."
"RTN","ECXSCLD",88,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) G END
"RTN","ECXSCLD",89,0)
 W ! S ZTRTN="APPLOOP^ECXSCLD",ZTIO="",ZTDESC="Approve DSS stop codes for clinic extract" D ^%ZTLOAD W !!,"...approval queued" G END
"RTN","ECXSCLD",90,0)
 ;
"RTN","ECXSCLD",91,0)
APPLOOP ; queued entry to approve action codes
"RTN","ECXSCLD",92,0)
 F EC=0:0 S EC=$O(^ECX(728.44,EC)) Q:'EC  I $D(^(EC,0)) S DA=EC,DIE="^ECX(728.44,",DR="6///"_DT D ^DIE
"RTN","ECXSCLD",93,0)
 S ZTREQ="@" G END
"RTN","ECXSCLD",94,0)
END K X,Y,DA,DR,DIC,DIE,QFLG,PG,LN
"RTN","ECXSCLD",95,0)
 Q
"RTN","ECXSCLD",96,0)
 ;
"RTN","ECXSCLD",97,0)
LOOK ;queued entry to check for new clinics
"RTN","ECXSCLD",98,0)
 S ECD=$E(DT,1,5)-1-($E(DT,4,5)="01"*8800),ECD0=ECD_"00",ECXMISS=10,ECGRP="SCX" K ^TMP("ECXS",$J)
"RTN","ECXSCLD",99,0)
 F EC=0:0 S EC=$O(^SC(EC)) Q:'EC  I $D(^(EC,0)),$P(^(0),U,3)="C",'$D(^ECX(728.44,EC)) S DAT=$G(^SC(EC,"I")) D
"RTN","ECXSCLD",100,0)
 .S ID=+DAT,RD=$P(DAT,U,2) I ID,ID<DT I 'RD!(RD>DT) Q
"RTN","ECXSCLD",101,0)
 .S ^TMP("ECXS",$J,ECXMISS,0)=$J(EC,6)_"    "_$$LJ^XLFSTR($P(^SC(EC,0),U),40),ECXMISS=ECXMISS+1
"RTN","ECXSCLD",102,0)
 D ^ECXSCX1
"RTN","ECXSCLD",103,0)
 Q
"RTN","ECXSCNS")
0^5^B20939929
"RTN","ECXSCNS",1,0)
ECXSCNS ;ALB/JAP,BIR/DMA,PTD-No Show Clinic Extract ; [ 11/22/96  5:48 PM ]
"RTN","ECXSCNS",2,0)
 ;;3.0;DSS EXTRACTS;**11,8,13,20,24,30**;Dec 22, 1997
"RTN","ECXSCNS",3,0)
BEG ;entry point from option
"RTN","ECXSCNS",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXSCNS",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXSCNS",6,0)
 Q
"RTN","ECXSCNS",7,0)
 ;
"RTN","ECXSCNS",8,0)
START ;start package specific extract
"RTN","ECXSCNS",9,0)
 N DIC,DA,DIQ,SC,ECD,ECDA,LOCARR,JI,X,Y
"RTN","ECXSCNS",10,0)
 K ^TMP($J,"ECXS"),^TMP($J,"ECXCL")
"RTN","ECXSCNS",11,0)
 S QFLG=0
"RTN","ECXSCNS",12,0)
 S ECED=ECED+.3
"RTN","ECXSCNS",13,0)
 ;get clinics - default appt length, type, division, provider, etc.
"RTN","ECXSCNS",14,0)
 S SC=0
"RTN","ECXSCNS",15,0)
 F  S SC=$O(^SC(SC)) Q:'SC  D
"RTN","ECXSCNS",16,0)
 .K LOCARR S DIC=44,DA=SC,DR="2;3.5;16;1912",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCNS",17,0)
 .S ALEN=+$G(LOCARR(44,SC,1912,"I")),^TMP($J,"ECXCL",SC)=ALEN,ALEN=$$RJ^XLFSTR(ALEN,3,0)
"RTN","ECXSCNS",18,0)
 .S ^TMP($J,"ECXCL",SC)=^TMP($J,"ECXCL",SC)_"^"_ALEN_"^"_$G(LOCARR(44,SC,2,"I"))_"^"_+$G(LOCARR(44,SC,3.5,"I"))
"RTN","ECXSCNS",19,0)
 .S ECXPROV=LOCARR(44,SC,16,"I"),ECXPROVP="",ECXPROVN="" I ECXPROV D
"RTN","ECXSCNS",20,0)
 ..S ECXPROVP=$$PRVCLASS^ECXUTL(ECXPROV,ECSD1)
"RTN","ECXSCNS",21,0)
 ..S ECXPROV="2"_ECXPROV
"RTN","ECXSCNS",22,0)
 .S ^TMP($J,"ECXCL",SC)=^TMP($J,"ECXCL",SC)_"^"_ECXPROV_"^"_ECXPROVP_"^"_ECXPROVN
"RTN","ECXSCNS",23,0)
 .D FEEDER^ECXSCX1(SC,ECSD1,.ECXP1,.ECXP2,.ECXP3,.ECXSEND,.ECXDIV)
"RTN","ECXSCNS",24,0)
 .K ECXP1,ECXP2,ECXP3,ECXSEND,ECXDIV
"RTN","ECXSCNS",25,0)
 ;extract
"RTN","ECXSCNS",26,0)
 S SC=0
"RTN","ECXSCNS",27,0)
 F  S SC=$O(^SC(SC)) Q:('SC)!(QFLG)  I $D(^TMP($J,"ECXCL",SC)) S EC=^TMP($J,"ECXCL",SC) I $P(EC,U,3)="C" D  Q:QFLG
"RTN","ECXSCNS",28,0)
 .D FEEDER^ECXSCX1(SC,ECSD1,.ECXP1,.ECXP2,.ECXP3,.ECXSEND,.ECXDIV)
"RTN","ECXSCNS",29,0)
 .Q:ECXSEND=6
"RTN","ECXSCNS",30,0)
 .S ECXDSS=ECXP1_ECXP2,ECXDSSD=""
"RTN","ECXSCNS",31,0)
 .;get default provider for clinic
"RTN","ECXSCNS",32,0)
 .S (ECXPROV,ECXPROVP,ECXPROVN)=""
"RTN","ECXSCNS",33,0)
 .S ECXPROV=$P($G(^TMP($J,"ECXCL",SC)),U,5) I ECXPROV D
"RTN","ECXSCNS",34,0)
 ..S ECXPROVP=$P(^TMP($J,"ECXCL",SC),U,6),ECXPROVN=$P(^TMP($J,"ECXCL",SC),U,7)
"RTN","ECXSCNS",35,0)
 .;find appts in date range
"RTN","ECXSCNS",36,0)
 .S ECD=ECSD1
"RTN","ECXSCNS",37,0)
 .F  S ECD=$O(^SC(SC,"S",ECD)) Q:'ECD  Q:ECD>ECED  D  Q:QFLG
"RTN","ECXSCNS",38,0)
 ..;get noshows only - no data in check-in/check-out node
"RTN","ECXSCNS",39,0)
 ..S JI=0 F  S JI=$O(^SC(SC,"S",ECD,JI)) Q:'JI  S ECDA=0 F  S ECDA=$O(^SC(SC,"S",ECD,JI,ECDA)) Q:'ECDA  I $D(^(ECDA,0)),$S('$D(^("C")):1,1:^("C")="") D
"RTN","ECXSCNS",40,0)
 ...S ECXDFN=$P(^SC(SC,"S",ECD,JI,ECDA,0),U),ECXDATE=ECD,ECXERR=0
"RTN","ECXSCNS",41,0)
 ...I $D(^DPT(ECXDFN,"S",ECD,0)) D
"RTN","ECXSCNS",42,0)
 ....Q:$P(^DPT(ECXDFN,"S",ECD,0),U)'=SC  Q:$P(^(0),U,2)'["N"
"RTN","ECXSCNS",43,0)
 ....D PAT(ECXDFN,ECXDATE,.ECXERR)
"RTN","ECXSCNS",44,0)
 ....Q:ECXERR
"RTN","ECXSCNS",45,0)
 ....;log noshows only for outpatients
"RTN","ECXSCNS",46,0)
 ....I ECXA=1 D FILE
"RTN","ECXSCNS",47,0)
 K ^TMP($J,"ECXS"),^TMP($J,"ECXCL")
"RTN","ECXSCNS",48,0)
 Q
"RTN","ECXSCNS",49,0)
 ;
"RTN","ECXSCNS",50,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get patient demographic data
"RTN","ECXSCNS",51,0)
 N OK,X
"RTN","ECXSCNS",52,0)
 ;set patient data
"RTN","ECXSCNS",53,0)
 S OK=1
"RTN","ECXSCNS",54,0)
 K ECXPAT
"RTN","ECXSCNS",55,0)
 S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECXDATE,"."),"1;2;3;5",.ECXPAT)
"RTN","ECXSCNS",56,0)
 I 'OK S ECXERR=1 Q
"RTN","ECXSCNS",57,0)
 S ECXSSN=ECXPAT("SSN")
"RTN","ECXSCNS",58,0)
 S ECXPNM=ECXPAT("NAME")
"RTN","ECXSCNS",59,0)
 S ECXMPI=ECXPAT("MPI")
"RTN","ECXSCNS",60,0)
 S ECXSEX=ECXPAT("SEX")
"RTN","ECXSCNS",61,0)
 S ECXDOB=ECXPAT("DOB")
"RTN","ECXSCNS",62,0)
 S ECXELIG=ECXPAT("ELIG")
"RTN","ECXSCNS",63,0)
 S ECXVET=ECXPAT("VET")
"RTN","ECXSCNS",64,0)
 S ECXRACE=ECXPAT("RACE")
"RTN","ECXSCNS",65,0)
 S ECXPST=ECXPAT("POW STAT")
"RTN","ECXSCNS",66,0)
 S ECXPLOC=ECXPAT("POW LOC")
"RTN","ECXSCNS",67,0)
 S ECXRST=ECXPAT("IR STAT")
"RTN","ECXSCNS",68,0)
 S ECXAST=ECXPAT("AO STAT")
"RTN","ECXSCNS",69,0)
 S ECXMST=ECXPAT("MST STAT")
"RTN","ECXSCNS",70,0)
 S ECXSTATE=ECXPAT("STATE")
"RTN","ECXSCNS",71,0)
 S ECXCNTY=ECXPAT("COUNTY")
"RTN","ECXSCNS",72,0)
 S ECXZIP=ECXPAT("ZIP")
"RTN","ECXSCNS",73,0)
 S ECXENRL=ECXPAT("ENROLL LOC")
"RTN","ECXSCNS",74,0)
 ;get sharing agreement data
"RTN","ECXSCNS",75,0)
 S (ECXPAYOR,ECXSAI)=""
"RTN","ECXSCNS",76,0)
 D VISN19^ECXUTL2(ECXDFN,.ECXPAYOR,.ECXSAI)
"RTN","ECXSCNS",77,0)
 ;get inpatient data
"RTN","ECXSCNS",78,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE)
"RTN","ECXSCNS",79,0)
 S ECXA=$P(X,U,1),ECXMN=$P(X,U,2),ECXTS=$P(X,U,3)
"RTN","ECXSCNS",80,0)
 Q:ECXA'=1
"RTN","ECXSCNS",81,0)
 ;get primary care data
"RTN","ECXSCNS",82,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."))
"RTN","ECXSCNS",83,0)
 S ECPTTM=$P(X,U,1)
"RTN","ECXSCNS",84,0)
 S ECPTPR=$P(X,U,2)
"RTN","ECXSCNS",85,0)
 S ECCLAS=$P(X,U,3)
"RTN","ECXSCNS",86,0)
 S ECPTNPI=$P(X,U,4)
"RTN","ECXSCNS",87,0)
 S ECASPR=$P(X,U,5)
"RTN","ECXSCNS",88,0)
 S ECCLAS2=$P(X,U,6)
"RTN","ECXSCNS",89,0)
 S ECASNPI=$P(X,U,7)
"RTN","ECXSCNS",90,0)
 Q
"RTN","ECXSCNS",91,0)
 ;
"RTN","ECXSCNS",92,0)
FILE ;file record
"RTN","ECXSCNS",93,0)
 ;node0
"RTN","ECXSCNS",94,0)
 ;fac^dfn^ssn^name^in/out^day^^mov #^treat spec^dob^elig^vet^time^primary care team^primary care provider^provider^race^dss identifier
"RTN","ECXSCNS",95,0)
 ;node1
"RTN","ECXSCNS",96,0)
 ;mpi^dss dept^pc provider npi^provider npi^pc prov person class^provider person class^pow status^pow loc^ir status^ao status
"RTN","ECXSCNS",97,0)
 ;sharing agree payor^sharing agree ins^mst status^enroll loc^state^county^zip^sex^assoc pc prov^assoc pc prov person class^assoc pc prov npi
"RTN","ECXSCNS",98,0)
 N DA,DIK
"RTN","ECXSCNS",99,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXSCNS",100,0)
 S ECODE=EC7_U_EC23
"RTN","ECXSCNS",101,0)
 S ECODE=ECODE_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)
"RTN","ECXSCNS",102,0)
 S ECODE=ECODE_U_U_ECXMN_U_ECXTS_U_ECXDOB_U_ECXELIG_U_ECXVET_U_$$ECXTIME^ECXUTL(ECXDATE)_U_ECPTTM_U_ECPTPR_U_ECXPROV_U_ECXRACE_U_ECXDSS
"RTN","ECXSCNS",103,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECPTNPI_U_ECXPROVN_U_ECCLAS_U_ECXPROVP_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST
"RTN","ECXSCNS",104,0)
 S ECODE1=ECODE1_U_ECXPAYOR_U_ECXSAI_U_ECXMST_U_ECXENRL_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXSEX_U_ECASPR_U_ECCLAS2_U_ECASNPI
"RTN","ECXSCNS",105,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXSCNS",106,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSCNS",107,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSCNS",108,0)
 Q
"RTN","ECXSCNS",109,0)
 ;
"RTN","ECXSCNS",110,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXSCNS",111,0)
 S ECHEAD="NOS"
"RTN","ECXSCNS",112,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXSCNS",113,0)
 Q
"RTN","ECXSCNS",114,0)
 ;
"RTN","ECXSCNS",115,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSCNS",116,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSCX1")
0^2^B69413442
"RTN","ECXSCX1",1,0)
ECXSCX1 ;ALB/JAP,BIR/DMA-Clinic Extract Message ; 20 Mar 95 / 11:10 AM [ 12/03/96  1:32 PM ]
"RTN","ECXSCX1",2,0)
 ;;3.0;DSS EXTRACTS;**8,28,24,27,29,30**;Dec 22, 1997
"RTN","ECXSCX1",3,0)
EN ;entry point from ecxscx
"RTN","ECXSCX1",4,0)
 N ECX
"RTN","ECXSCX1",5,0)
 ;send missing clinic message
"RTN","ECXSCX1",6,0)
 S ECX=$O(^TMP($J,"ECXS","MISS",0)) D
"RTN","ECXSCX1",7,0)
 .Q:ECX=""
"RTN","ECXSCX1",8,0)
 .S XMSUB="MISSING CLINICS in File #728.44",XMDUZ="DSS SYSTEM"
"RTN","ECXSCX1",9,0)
 .K XMY S XMY("G.DSS-"_ECGRP_"@"_^XMB("NETNAME"))=""
"RTN","ECXSCX1",10,0)
 .F ECX=1:1:5 S ^TMP($J,"ECXS","MISS",ECX,0)=$P($T(MSG+ECX),";;",2)
"RTN","ECXSCX1",11,0)
 .S XMTEXT="^TMP($J,""ECXS"",""MISS""," D ^XMD
"RTN","ECXSCX1",12,0)
 ;send no division message
"RTN","ECXSCX1",13,0)
 S ECX=$O(^TMP($J,"ECXS","DIV",0)) D
"RTN","ECXSCX1",14,0)
 .Q:ECX=""
"RTN","ECXSCX1",15,0)
 .S XMSUB="CLINICS w/o DIVISION Data",XMDUZ="DSS SYSTEM"
"RTN","ECXSCX1",16,0)
 .K XMY S XMY("G.DSS-"_ECGRP_"@"_^XMB("NETNAME"))=""
"RTN","ECXSCX1",17,0)
 .F ECX=1:1:5 S ^TMP($J,"ECXS","DIV",ECX,0)=$P($T(MSG2+ECX),";;",2)
"RTN","ECXSCX1",18,0)
 .S XMTEXT="^TMP($J,""ECXS"",""DIV""," D ^XMD
"RTN","ECXSCX1",19,0)
 ;cleanup
"RTN","ECXSCX1",20,0)
 K ^TMP($J,"ECXS")
"RTN","ECXSCX1",21,0)
 Q
"RTN","ECXSCX1",22,0)
MSG ;text for missing clinic
"RTN","ECXSCX1",23,0)
 ;;The following clinics have not been entered into the CLINIC AND
"RTN","ECXSCX1",24,0)
 ;;STOP CODES file (#728.44).  If any listed clinic is currently
"RTN","ECXSCX1",25,0)
 ;;active, please use the options 'Create DSS Clinic Stop Code File'
"RTN","ECXSCX1",26,0)
 ;;and 'Enter/Edit DSS Stop Codes for Clinics' to update this file.
"RTN","ECXSCX1",27,0)
 ;;  
"RTN","ECXSCX1",28,0)
 ;
"RTN","ECXSCX1",29,0)
MSG2 ;text for missing division
"RTN","ECXSCX1",30,0)
 ;;The following clinics in the HOSPITAL LOCATION file (#44) have not
"RTN","ECXSCX1",31,0)
 ;;been assigned to a division from the MEDICAL CENTER DIVISION file 
"RTN","ECXSCX1",32,0)
 ;;(#40.8).  CLI extract records associated with these clinics have
"RTN","ECXSCX1",33,0)
 ;;been given a default Division identifier of "1".
"RTN","ECXSCX1",34,0)
 ;;
"RTN","ECXSCX1",35,0)
 ;
"RTN","ECXSCX1",36,0)
MISS ;load ^tmp if clinic missing from #728.44
"RTN","ECXSCX1",37,0)
 N DAT,ID,RD
"RTN","ECXSCX1",38,0)
 S (ID,RD)=""
"RTN","ECXSCX1",39,0)
 S DAT=$G(^SC(SC,"I")) I DAT]"" S ID=+DAT,RD=$P(DAT,U,2)
"RTN","ECXSCX1",40,0)
 ;ignore inactive clinics
"RTN","ECXSCX1",41,0)
 I ID,ID<DT I 'RD!(RD>DT) Q
"RTN","ECXSCX1",42,0)
 I '$D(ECXMISS) S ECXMISS=10
"RTN","ECXSCX1",43,0)
 S ^TMP($J,"ECXS","MISS",ECXMISS,0)=$J(SC,6)_"    "_$$LJ^XLFSTR($P(^SC(SC,0),U),40)_ECSC_"/"_ECCSC,ECXMISS=ECXMISS+1
"RTN","ECXSCX1",44,0)
 Q
"RTN","ECXSCX1",45,0)
 ;
"RTN","ECXSCX1",46,0)
NODIV ;load ^tmp if clinic w/o division
"RTN","ECXSCX1",47,0)
 N DAT,ID,RD
"RTN","ECXSCX1",48,0)
 S (ID,RD)=""
"RTN","ECXSCX1",49,0)
 S DAT=$G(^SC(SC,"I")) I DAT]"" S ID=+DAT,RD=$P(DAT,U,2)
"RTN","ECXSCX1",50,0)
 ;ignore inactive clinics
"RTN","ECXSCX1",51,0)
 I ID,ID<DT I 'RD!(RD>DT) Q
"RTN","ECXSCX1",52,0)
 I '$D(ECXMISS) S ECXMISS=10
"RTN","ECXSCX1",53,0)
 S ^TMP($J,"ECXS","DIV",ECXMISS,0)=$J(SC,6)_"    "_$$LJ^XLFSTR($P(^SC(SC,0),U),40),ECXMISS=ECXMISS+1
"RTN","ECXSCX1",54,0)
 Q
"RTN","ECXSCX1",55,0)
 ;
"RTN","ECXSCX1",56,0)
FEEDER(ECXSC,ECXSD,ECXP1,ECXP2,ECXP3,ECXSEND,ECXDIV) ;get transmission style and feeder key variables
"RTN","ECXSCX1",57,0)
 ;feeder key = primary stop code_secondary stop code_length of appointment_national clinic code_noshow indicator
"RTN","ECXSCX1",58,0)
 ;   input
"RTN","ECXSCX1",59,0)
 ;   ECXSC = ien of clinic in file #44 (required)
"RTN","ECXSCX1",60,0)
 ;   ECXSD  = start date of extract date range (required)
"RTN","ECXSCX1",61,0)
 ;   ECXP1,ECXP2,ECXP3,ECXSEND passed by reference (required)
"RTN","ECXSCX1",62,0)
 ;   output (passed-by-reference variables)
"RTN","ECXSCX1",63,0)
 ;   ECXP1  = primary stop code
"RTN","ECXSCX1",64,0)
 ;   ECXP2  = secondary stop code
"RTN","ECXSCX1",65,0)
 ;   ECXP3  = field #7 of file #728.44
"RTN","ECXSCX1",66,0)
 ;   ECXSEND = field #5 of file #728.44
"RTN","ECXSCX1",67,0)
 ;   ECXDIV  = field #3.5 of file #44
"RTN","ECXSCX1",68,0)
 N ECSC,ECCSC,ECSD1,ECXNC,ECXMISS,CLIN,SC
"RTN","ECXSCX1",69,0)
 S (ECXP1,ECXP2)="000",ECXP3="0000"
"RTN","ECXSCX1",70,0)
 S ECXSEND=1,ECXDIV=0
"RTN","ECXSCX1",71,0)
 Q:+ECXSC=0
"RTN","ECXSCX1",72,0)
 ;get needed data from ^tmp
"RTN","ECXSCX1",73,0)
 I $D(^TMP($J,"ECXS","SC",ECXSC)) D
"RTN","ECXSCX1",74,0)
 .S CLIN=^TMP($J,"ECXS","SC",ECXSC)
"RTN","ECXSCX1",75,0)
 .S ECXP1=$P(CLIN,U),ECXP2=$P(CLIN,U,2),ECXP3=$P(CLIN,U,3),ECXSEND=$P(CLIN,U,4),ECXDIV=$P(CLIN,U,5)
"RTN","ECXSCX1",76,0)
 .S ECXDIV=+$P($G(^TMP($J,"ECXCL",ECXSC)),U,4) S:ECXDIV=0 ECXDIV=1
"RTN","ECXSCX1",77,0)
 ;otherwise, set needed data in ^tmp
"RTN","ECXSCX1",78,0)
 I '$D(^TMP($J,"ECXS","SC",ECXSC)) D
"RTN","ECXSCX1",79,0)
 .;get division or send no division msg
"RTN","ECXSCX1",80,0)
 .S ECXDIV=+$P($G(^TMP($J,"ECXCL",ECXSC)),U,4) I ECXDIV=0 S SC=ECXSC D NODIV S ECXDIV=1
"RTN","ECXSCX1",81,0)
 .;get other data from file #44 if no #727.44 record; send missing clinic msg
"RTN","ECXSCX1",82,0)
 .I '$D(^ECX(728.44,ECXSC,0)) D
"RTN","ECXSCX1",83,0)
 ..S ECSC=+$P($G(^SC(ECXSC,0)),U,7),ECCSC=+$P(^(0),U,18)
"RTN","ECXSCX1",84,0)
 ..S SC=ECXSC,ECSD1=ECXSD D MISS
"RTN","ECXSCX1",85,0)
 ..I ECSC S ECXP1=$P($G(^DIC(40.7,ECSC,0)),U,2),ECXP1=$$RJ^XLFSTR(+ECXP1,3,0)
"RTN","ECXSCX1",86,0)
 .;otherwise get other data from file #728.44
"RTN","ECXSCX1",87,0)
 .S EC=$G(^ECX(728.44,ECXSC,0)) D
"RTN","ECXSCX1",88,0)
 ..Q:EC=""
"RTN","ECXSCX1",89,0)
 ..S ECXSEND=$P(EC,U,6)
"RTN","ECXSCX1",90,0)
 ..Q:ECXSEND=6
"RTN","ECXSCX1",91,0)
 ..S ECSC=+$P(EC,U,4),ECCSC=+$P(EC,U,5)
"RTN","ECXSCX1",92,0)
 ..I 'ECSC S ECSC=+$P(EC,U,2),ECCSC=+$P(EC,U,3)
"RTN","ECXSCX1",93,0)
 ..I ECSC S ECXP1=$$RJ^XLFSTR(ECSC,3,0),ECXP2=$$RJ^XLFSTR(ECCSC,3,0)
"RTN","ECXSCX1",94,0)
 ..;if primary stop not valid, use file #44 record
"RTN","ECXSCX1",95,0)
 ..I 'ECSC S ECSC=+$P($G(^SC(ECXSC,0)),U,7),ECCSC=+$P($G(^(0)),U,18) I ECSC D
"RTN","ECXSCX1",96,0)
 ...S ECXP1=+$P($G(^DIC(40.7,ECSC,0)),U,2) S:ECCSC ECXP2=+$P($G(^DIC(40.7,ECCSC,0)),U,2)
"RTN","ECXSCX1",97,0)
 ...S ECXP1=$$RJ^XLFSTR(ECXP1,3,0),ECXP2=$$RJ^XLFSTR(ECXP2,3,0)
"RTN","ECXSCX1",98,0)
 .;for action code=1, secondary stop code is always "000"
"RTN","ECXSCX1",99,0)
 .I ECXSEND=1 S ECXP2="000"
"RTN","ECXSCX1",100,0)
 .;action code of 2 or 3 should not be used, but continue to follow v2t11 logic
"RTN","ECXSCX1",101,0)
 .I ECXSEND=2 S ECXP1=ECXP2,ECXP2="000"
"RTN","ECXSCX1",102,0)
 .;for action code=4, need to get national clinic code
"RTN","ECXSCX1",103,0)
 .I ECXSEND=4 D
"RTN","ECXSCX1",104,0)
 ..S ECXNC=+$P($G(^ECX(728.44,ECXSC,0)),U,8)
"RTN","ECXSCX1",105,0)
 ..I ECXNC S ECXNC=$P($G(^ECX(728.441,ECXNC,0)),U),ECXP3=$$RJ^XLFSTR(ECXNC,4,0)
"RTN","ECXSCX1",106,0)
 .;set data in ^tmp
"RTN","ECXSCX1",107,0)
 .S ^TMP($J,"ECXS","SC",ECXSC)=ECXP1_U_ECXP2_U_ECXP3_U_ECXSEND
"RTN","ECXSCX1",108,0)
 Q
"RTN","ECXSCX1",109,0)
 ;
"RTN","ECXSCX1",110,0)
CLINII(ECXRECS,ECXED) ;update file #727.818 0-node & file #728 for CLJ
"RTN","ECXSCX1",111,0)
 ;input ECXRECS = total # records created in file #727.818
"RTN","ECXSCX1",112,0)
 ;      ECXED   = end date for extract
"RTN","ECXSCX1",113,0)
 N HEAD,PACK,GROUP,FILE,ROUTINE,PIECE,VERSION,LAST,TOTAL
"RTN","ECXSCX1",114,0)
 S HEAD="CLJ"
"RTN","ECXSCX1",115,0)
 D ECXDEF^ECXUTL2(HEAD,.PACK,.GROUP,.FILE,.ROUTINE,.PIECE,.VERSION)
"RTN","ECXSCX1",116,0)
 S LAST=$O(^ECX(FILE,99999999),-1)
"RTN","ECXSCX1",117,0)
 S TOTAL=$P(^ECX(FILE,0),U,4)+ECXRECS
"RTN","ECXSCX1",118,0)
 S $P(^ECX(FILE,0),U,3,4)=LAST_U_TOTAL
"RTN","ECXSCX1",119,0)
 S $P(^ECX(728,1,7),U,PIECE)=ECXED
"RTN","ECXSCX1",120,0)
 S $P(^ECX(728,1,7.1),U,PIECE)=""
"RTN","ECXSCX1",121,0)
 Q
"RTN","ECXSCX1",122,0)
 ;
"RTN","ECXSCX1",123,0)
VISIT(ECXDFN,ECXVISIT,ECXVIST,ECXERR) ;get visit specific data
"RTN","ECXSCX1",124,0)
 ;input  ECXVISIT  = pointer to file #9000010
"RTN","ECXSCX1",125,0)
 ;       ECXSVC  = sc percentage
"RTN","ECXSCX1",126,0)
 ;output ECXVSIT = data array
"RTN","ECXSCX1",127,0)
 ;       ECXERR  = 1 indicates error; otherwise, 0 
"RTN","ECXSCX1",128,0)
 N DIC,DA,DIQ,X,Y,ARRAY,VISIT,REC,VAL,ICD9,DATE,PROV,CPT,MOD,AO,IR,MST
"RTN","ECXSCX1",129,0)
 S ECXERR=0,VISIT=ECXVISIT
"RTN","ECXSCX1",130,0)
 S ECXVIST("CPT")="",ECXVIST("ICD9")="",ECXVIST("AO")="",ECXVIST("IR")="",ECXVIST("MST")=""
"RTN","ECXSCX1",131,0)
 S ECXVIST("PROV")="",ECXVIST("PROV CLASS")="",ECXVIST("PROV NPI")="",ECXVIST("SOURCE")=""
"RTN","ECXSCX1",132,0)
 D ENCEVENT^PXAPI(VISIT)
"RTN","ECXSCX1",133,0)
 I $O(^TMP("PXKENC",$J,VISIT,""))']"" K ECXVIST S ECXERR=1
"RTN","ECXSCX1",134,0)
 Q:ECXERR
"RTN","ECXSCX1",135,0)
 S DATE=$P($P(^TMP("PXKENC",$J,VISIT,"VST",VISIT,0),U,1),".",1)
"RTN","ECXSCX1",136,0)
 S ECXVIST("SOURCE")=$P($G(^TMP("PXKENC",$J,VISIT,"VST",VISIT,812)),U,3)
"RTN","ECXSCX1",137,0)
 ;get icd9 codes upto 9; else use 799.9
"RTN","ECXSCX1",138,0)
 S ECXVIST("ICD9")=""
"RTN","ECXSCX1",139,0)
 I $O(^TMP("PXKENC",$J,VISIT,"POV",0)) D
"RTN","ECXSCX1",140,0)
 .S (REC,VAL)=0
"RTN","ECXSCX1",141,0)
 .F  S REC=$O(^TMP("PXKENC",$J,VISIT,"POV",REC)) Q:'REC  D
"RTN","ECXSCX1",142,0)
 ..S VAL=+^TMP("PXKENC",$J,VISIT,"POV",REC,0)
"RTN","ECXSCX1",143,0)
 ..Q:'VAL
"RTN","ECXSCX1",144,0)
 ..K ARRAY S DIC=80,DA=VAL,DR=".01",DIQ(0)="E",DIQ="ARRAY" D EN^DIQ1
"RTN","ECXSCX1",145,0)
 ..S ICD9=ARRAY(80,VAL,.01,"E"),LEN=$L(ICD9)
"RTN","ECXSCX1",146,0)
 ..F L=LEN+1:1:7 S ICD9=ICD9_" "
"RTN","ECXSCX1",147,0)
 ..I $P(^TMP("PXKENC",$J,VISIT,"POV",REC,0),U,12)="P" S ECXVIST("ICD9")=ICD9_ECXVIST("ICD9")
"RTN","ECXSCX1",148,0)
 ..E  S ECXVIST("ICD9")=ECXVIST("ICD9")_ICD9
"RTN","ECXSCX1",149,0)
 I ECXVIST("ICD9")="" S ECXVIST("ICD9")="799.9  "
"RTN","ECXSCX1",150,0)
 I $L(ECXVIST("ICD9"))<63 S LEN=$L(ECXVIST("ICD9")) F L=LEN+1:1:63 S ECXVIST("ICD9")=ECXVIST("ICD9")_" "
"RTN","ECXSCX1",151,0)
 S ECXVIST("ICD9")=$E(ECXVIST("ICD9"),1,63)
"RTN","ECXSCX1",152,0)
 ;get first provider designated as primary
"RTN","ECXSCX1",153,0)
 ;if no primary, then get first physician provider
"RTN","ECXSCX1",154,0)
 ;if no physician, then get first provider
"RTN","ECXSCX1",155,0)
 S (PROV,PROVPC)=""
"RTN","ECXSCX1",156,0)
 I $O(^TMP("PXKENC",$J,VISIT,"PRV",0)) D
"RTN","ECXSCX1",157,0)
 .S (REC,VAL)=0 D
"RTN","ECXSCX1",158,0)
 ..F  S REC=$O(^TMP("PXKENC",$J,VISIT,"PRV",REC)) Q:'REC  Q:VAL  S:($P(^(REC,0),U,4)="P") VAL=+^(0) D
"RTN","ECXSCX1",159,0)
 ..S PROV=VAL,PROVPC=$$PRVCLASS^ECXUTL(PROV,DATE)
"RTN","ECXSCX1",160,0)
 .I 'VAL S (REC,VAL)=0 D
"RTN","ECXSCX1",161,0)
 ..F  S REC=$O(^TMP("PXKENC",$J,VISIT,"PRV",REC)) Q:'REC  Q:VAL  S VAL=+^(REC,0) D
"RTN","ECXSCX1",162,0)
 ...S PROV=VAL,PROVPC=$$PRVCLASS^ECXUTL(PROV,DATE) Q:PROVPC=""
"RTN","ECXSCX1",163,0)
 ...S NUM=$E(PROVPC,2,7) S:(NUM<110000)!(NUM>119999) VAL=0,PROVPC=""
"RTN","ECXSCX1",164,0)
 .I 'VAL D
"RTN","ECXSCX1",165,0)
 ..S REC=$O(^TMP("PXKENC",$J,VISIT,"PRV",0)) Q:'REC  Q:VAL  S VAL=+^(REC,0) D
"RTN","ECXSCX1",166,0)
 ...S PROV=VAL,PROVPC=$$PRVCLASS^ECXUTL(PROV,DATE)
"RTN","ECXSCX1",167,0)
 .S:PROV]"" PROV="2"_PROV
"RTN","ECXSCX1",168,0)
 S ECXVIST("PROV")=PROV,ECXVIST("PROV CLASS")=PROVPC,ECXVIST("PROV NPI")=""
"RTN","ECXSCX1",169,0)
 ;get cpt codes upto 8 & modifiers upto 5
"RTN","ECXSCX1",170,0)
 I $O(^TMP("PXKENC",$J,VISIT,"CPT",0)) D
"RTN","ECXSCX1",171,0)
 .S REC="",ECXVIST("CPT")=""
"RTN","ECXSCX1",172,0)
 .;if there's a primary provider, get cpt codes associated with that provider
"RTN","ECXSCX1",173,0)
 .I ECXVIST("PROV")]"" D
"RTN","ECXSCX1",174,0)
 ..S PROV=$E(ECXVIST("PROV"),2,99)
"RTN","ECXSCX1",175,0)
 ..F  S REC=$O(^TMP("PXKENC",$J,VISIT,"CPT",REC)) Q:'REC  S (CPT,MOD)="" D
"RTN","ECXSCX1",176,0)
 ...Q:'$D(^TMP("PXKENC",$J,VISIT,"CPT",REC,12)) 
"RTN","ECXSCX1",177,0)
 ...I $P(^TMP("PXKENC",$J,VISIT,"CPT",REC,12),U,4)=PROV S CPT=+^TMP("PXKENC",$J,VISIT,"CPT",REC,0)
"RTN","ECXSCX1",178,0)
 ...Q:'CPT
"RTN","ECXSCX1",179,0)
 ...S MOD="" I $D(^TMP("PXKENC",$J,VISIT,"CPT",REC,1)) S M=0 D
"RTN","ECXSCX1",180,0)
 ....F  S M=$O(^TMP("PXKENC",$J,VISIT,"CPT",REC,1,M)) Q:'M  S CM=+^TMP("PXKENC",$J,VISIT,"CPT",REC,1,M,0) I CM S MOD=MOD_CM_";"
"RTN","ECXSCX1",181,0)
 ...I $L(ECXVIST("CPT"))<120 S CPT=$$CPT^ECXUTL3(CPT,MOD),ECXVIST("CPT")=ECXVIST("CPT")_CPT
"RTN","ECXSCX1",182,0)
 ...K ^TMP("PXKENC",$J,VISIT,"CPT",REC)
"RTN","ECXSCX1",183,0)
 .;get more cpt codes if needed
"RTN","ECXSCX1",184,0)
 .I $L(ECXVIST("CPT"))<120 S REC="" D
"RTN","ECXSCX1",185,0)
 ..F  S REC=$O(^TMP("PXKENC",$J,VISIT,"CPT",REC)) Q:'REC  S (CPT,MOD)="" D
"RTN","ECXSCX1",186,0)
 ...S CPT=+^TMP("PXKENC",$J,VISIT,"CPT",REC,0)
"RTN","ECXSCX1",187,0)
 ...Q:'CPT
"RTN","ECXSCX1",188,0)
 ...S MOD="" I $D(^TMP("PXKENC",$J,VISIT,"CPT",REC,1)) S M=0 D
"RTN","ECXSCX1",189,0)
 ....F  S M=$O(^TMP("PXKENC",$J,VISIT,"CPT",REC,1,M)) Q:'M  S CM=+^TMP("PXKENC",$J,VISIT,"CPT",REC,1,M,0) I CM S MOD=MOD_CM_";"
"RTN","ECXSCX1",190,0)
 ...I $L(ECXVIST("CPT"))<120 S CPT=$$CPT^ECXUTL3(CPT,MOD),ECXVIST("CPT")=ECXVIST("CPT")_CPT
"RTN","ECXSCX1",191,0)
 .I ECXVIST("CPT")="" S ECXVIST("CPT")="99199"
"RTN","ECXSCX1",192,0)
 .S ECXVIST("CPT")=$E(ECXVIST("CPT"),1,120)
"RTN","ECXSCX1",193,0)
 .I $L(ECXVIST("CPT"))<120 S LEN=$L(ECXVIST("CPT")) F L=LEN+1:1:120 S ECXVIST("CPT")=ECXVIST("CPT")_" "
"RTN","ECXSCX1",194,0)
 ;ao, ir, mst
"RTN","ECXSCX1",195,0)
 S (AO,IR,MST)=""
"RTN","ECXSCX1",196,0)
 I $D(^TMP("PXKENC",$J,VISIT,"VST",VISIT,800)) D
"RTN","ECXSCX1",197,0)
 .S AO=$P(^TMP("PXKENC",$J,VISIT,"VST",VISIT,800),U,2),IR=$P(^(800),U,3),MST=$P(^(800),U,5)
"RTN","ECXSCX1",198,0)
 .S ECXVIST("AO")=$S(AO=0:"N",AO=1:"Y",1:"")
"RTN","ECXSCX1",199,0)
 .S ECXVIST("IR")=$S(IR=0:"N",IR=1:"Y",1:"")
"RTN","ECXSCX1",200,0)
 .S ECXVIST("MST")=$S(MST=0:"N",MST=1:"Y",1:"")
"RTN","ECXSCX1",201,0)
 Q
"RTN","ECXSCXN")
0^1^B65550962
"RTN","ECXSCXN",1,0)
ECXSCXN ;ALB/JAP  Clinic Extract ; 05/14/99
"RTN","ECXSCXN",2,0)
 ;;3.0;DSS EXTRACTS;**24,27,29,30**;Dec 22, 1997
"RTN","ECXSCXN",3,0)
 ;
"RTN","ECXSCXN",4,0)
BEG ;entry point from option
"RTN","ECXSCXN",5,0)
 D SETUP I ECFILE="" Q
"RTN","ECXSCXN",6,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXSCXN",7,0)
 Q
"RTN","ECXSCXN",8,0)
 ;
"RTN","ECXSCXN",9,0)
START ;entry point from taskmgr
"RTN","ECXSCXN",10,0)
 N DIC,OUT,TIU,LOCARR,PROCESS,STOP,STATUS,P1,P2,P3,TOSEND,SOURCE,EXNUM,X,Y
"RTN","ECXSCXN",11,0)
 S OUT=0,QFLG=0,ECRN=0
"RTN","ECXSCXN",12,0)
 K ^TMP($J,"ECXS"),^TMP($J,"ECXCL")
"RTN","ECXSCXN",13,0)
 ;get ien for tiu in file #839.7
"RTN","ECXSCXN",14,0)
 S DIC="^PX(839.7,",DIC(0)="X",X="TEXT INTEGRATION UTILITIES" D ^DIC S TIU=+Y K DIC,Y
"RTN","ECXSCXN",15,0)
 S ECED=ECED+.3
"RTN","ECXSCXN",16,0)
 ;get clinic default appt length, type, division
"RTN","ECXSCXN",17,0)
 S ECXCLIN=0 F  S ECXCLIN=$O(^SC(ECXCLIN)) Q:'ECXCLIN  D
"RTN","ECXSCXN",18,0)
 .K LOCARR S DIC=44,DA=ECXCLIN,DR="2;3.5;1912",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCXN",19,0)
 .S ALEN=+$G(LOCARR(44,ECXCLIN,1912,"I")),^TMP($J,"ECXCL",ECXCLIN)=ALEN,ALEN=$$RJ^XLFSTR(ALEN,3,0)
"RTN","ECXSCXN",20,0)
 .S ^TMP($J,"ECXCL",ECXCLIN)=^TMP($J,"ECXCL",ECXCLIN)_"^"_ALEN_"^"_$G(LOCARR(44,ECXCLIN,2,"I"))_"^"_+$G(LOCARR(44,ECXCLIN,3.5,"I"))
"RTN","ECXSCXN",21,0)
 .D FEEDER^ECXSCX1(ECXCLIN,ECSD1,.P1,.P2,.P3,.TOSEND,.ECXDIV)
"RTN","ECXSCXN",22,0)
 .K P1,P2,P3,TOSEND,ECXDIV
"RTN","ECXSCXN",23,0)
 ;pass thru file #2 to pick-up any no-shows & get encounters
"RTN","ECXSCXN",24,0)
 S ECXDFN=0 F  S ECXDFN=$O(^DPT(ECXDFN)) Q:'ECXDFN  D
"RTN","ECXSCXN",25,0)
 .S ECXERR=0
"RTN","ECXSCXN",26,0)
 .S (ECXSSN,ECXPNM,ECPTPR,ECCLAS,ECPTNPI,ECASPR,ECCLAS2,ECASNPI,ECPTTM,ECXPAYOR,ECXSAI,ECXVET,ECXRACE)=""
"RTN","ECXSCXN",27,0)
 .S (ECXENRL,ECXMPI,ECXSEX,ECXDOB,ECXELIG,ECXPST,ECXPLOC,ECXRST,ECXAST,ECXMST,ECXSTATE,ECXCNTY,ECXZIP)=""
"RTN","ECXSCXN",28,0)
 .D PAT1(ECXDFN,ECSD1,.ECXERR)
"RTN","ECXSCXN",29,0)
 .Q:ECXERR
"RTN","ECXSCXN",30,0)
 .D NOSHOW(ECXDFN,ECSD1,ECED)
"RTN","ECXSCXN",31,0)
 .D ENCNTR(ECXDFN,ECSD1,ECED)
"RTN","ECXSCXN",32,0)
 ;update for CLJ extract
"RTN","ECXSCXN",33,0)
 D CLINII^ECXSCX1(ECRN,$P(ECED,"."))
"RTN","ECXSCXN",34,0)
 ;send missing clinic msg
"RTN","ECXSCXN",35,0)
 D:$D(^TMP($J,"ECXS")) EN^ECXSCX1
"RTN","ECXSCXN",36,0)
 K ^TMP($J,"ECXS"),^TMP($J,"ECXCL")
"RTN","ECXSCXN",37,0)
 Q
"RTN","ECXSCXN",38,0)
 ;
"RTN","ECXSCXN",39,0)
ENCNTR(ECXDFN,ECSD1,ECED) ;search file #409.68 for encounter data
"RTN","ECXSCXN",40,0)
 N OUT,J,PP
"RTN","ECXSCXN",41,0)
 S ECD=ECSD1
"RTN","ECXSCXN",42,0)
 F  S ECD=$O(^SCE("ADFN",ECXDFN,ECD)) Q:'ECD!(ECD>ECED)  Q:QFLG  S ECXIEN=0 F  S ECXIEN=$O(^SCE("ADFN",ECXDFN,ECD,ECXIEN)) Q:'ECXIEN  D  Q:QFLG
"RTN","ECXSCXN",43,0)
 .Q:'$D(^SCE(ECXIEN,0))
"RTN","ECXSCXN",44,0)
 .K LOCARR S DIC=409.68,DA=ECXIEN,DR=".01;.02;.03;.04;.05;.06;.07;.08;.12;.13",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCXN",45,0)
 .S STOP=+$G(LOCARR(409.68,ECXIEN,.03,"I")),CHKOUT=+$G(LOCARR(409.68,ECXIEN,.07,"I")),PROCESS=+$G(LOCARR(409.68,ECXIEN,.08,"I")),STATUS=$G(LOCARR(409.68,ECXIEN,.12,"I"))
"RTN","ECXSCXN",46,0)
 .Q:ECXDFN'=+$G(LOCARR(409.68,ECXIEN,.02,"I"))
"RTN","ECXSCXN",47,0)
 .Q:'CHKOUT
"RTN","ECXSCXN",48,0)
 .S:STATUS="" STATUS="ZZ" S STATUS=";"_STATUS_";"
"RTN","ECXSCXN",49,0)
 .Q:";3;4;5;6;7;9;10;13;"[STATUS
"RTN","ECXSCXN",50,0)
 .Q:'STOP
"RTN","ECXSCXN",51,0)
 .Q:PROCESS=4
"RTN","ECXSCXN",52,0)
 .Q:+$G(LOCARR(409.68,ECXIEN,.06,"I"))
"RTN","ECXSCXN",53,0)
 .S ECXDATE=+$G(LOCARR(409.68,ECXIEN,.01,"I")),ECXCLIN=+$G(LOCARR(409.68,ECXIEN,.04,"I"))
"RTN","ECXSCXN",54,0)
 .Q:$P($G(^TMP($J,"ECXCL",ECXCLIN)),U,3)'="C"
"RTN","ECXSCXN",55,0)
 .S ECXVISIT=+$G(LOCARR(409.68,ECXIEN,.05,"I")),ECXENEL=+$G(LOCARR(409.68,ECXIEN,.13,"I"))
"RTN","ECXSCXN",56,0)
 .Q:'ECXVISIT
"RTN","ECXSCXN",57,0)
 .D FEEDER^ECXSCX1(ECXCLIN,ECSD1,.P1,.P2,.P3,.TOSEND,.ECXDIV)
"RTN","ECXSCXN",58,0)
 .K LOCARR S DIC=40.7,DA=STOP,DR="1",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCXN",59,0)
 .S ECXSTOP=$$RJ^XLFSTR($G(LOCARR(40.7,STOP,1,"I")),3,0)
"RTN","ECXSCXN",60,0)
 .;get date specific patient data
"RTN","ECXSCXN",61,0)
 .D PAT2(ECXDFN,ECXDATE)
"RTN","ECXSCXN",62,0)
 .;get visit specific data
"RTN","ECXSCXN",63,0)
 .S ECXERR=0 D VISIT^ECXSCX1(ECXDFN,ECXVISIT,.ECXVIST,.ECXERR)
"RTN","ECXSCXN",64,0)
 .Q:ECXERR
"RTN","ECXSCXN",65,0)
 .S ECXCPT=ECXVIST("CPT"),ECXICD9=ECXVIST("ICD9"),SOURCE=ECXVIST("SOURCE")
"RTN","ECXSCXN",66,0)
 .S ECXAO=ECXVIST("AO"),ECXIR=ECXVIST("IR"),ECXMIL=ECXVIST("MST")
"RTN","ECXSCXN",67,0)
 .S ECXPROV=ECXVIST("PROV"),ECXPROVP=ECXVIST("PROV CLASS"),ECXPROVN=ECXVIST("PROV NPI")
"RTN","ECXSCXN",68,0)
 .K LOCARR S DIC=8,DA=ECXENEL,DR="8",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCXN",69,0)
 .S ECXENEL=+$G(LOCARR(8,ECXENEL,8,"I")) I ECXENEL S ECXENEL=$$ELIG^ECXUTL3(ECXENEL,ECXSVC)
"RTN","ECXSCXN",70,0)
 .;setup feeder key and file in extract records
"RTN","ECXSCXN",71,0)
 .S (ECXKEY,ECXDSSD)=""
"RTN","ECXSCXN",72,0)
 .;xray (105) or lab (108)
"RTN","ECXSCXN",73,0)
 .I (ECXSTOP=105)!(ECXSTOP=108) D  Q
"RTN","ECXSCXN",74,0)
 ..S ECXKEY=ECXSTOP_"00003000000"
"RTN","ECXSCXN",75,0)
 ..D FILE
"RTN","ECXSCXN",76,0)
 .;appointments
"RTN","ECXSCXN",77,0)
 .I PROCESS=1 D  Q
"RTN","ECXSCXN",78,0)
 ..Q:TOSEND=6
"RTN","ECXSCXN",79,0)
 ..;get appt length
"RTN","ECXSCXN",80,0)
 ..S ALEN=0,J=0,OUT=0
"RTN","ECXSCXN",81,0)
 ..F  S J=$O(^SC(ECXCLIN,"S",ECXDATE,J)) Q:'J  Q:OUT  S K=0 F  S K=$O(^SC(ECXCLIN,"S",ECXDATE,J,K)) Q:'K  Q:OUT  D
"RTN","ECXSCXN",82,0)
 ...S PP=$P($G(^SC(ECXCLIN,"S",ECXDATE,J,K,0)),U) I PP=ECXDFN S OUT=1,ALEN=$P(^(0),U,2),ALEN=$$RJ^XLFSTR(ALEN,3,0)
"RTN","ECXSCXN",83,0)
 ..S:+ALEN=0 ALEN=$P($G(^TMP($J,"ECXCL",ECXCLIN)),U,2)
"RTN","ECXSCXN",84,0)
 ..S ECXSTOP=P1
"RTN","ECXSCXN",85,0)
 ..I TOSEND'=3 S ECXKEY=P1_P2_ALEN_P3_"0" D FILE
"RTN","ECXSCXN",86,0)
 ..I TOSEND=3 S ECXKEY=P1_"000"_ALEN_P3_"0" D FILE
"RTN","ECXSCXN",87,0)
 ..I TOSEND=3 S ECXKEY=P2_"000"_ALEN_P3_"0" D FILE
"RTN","ECXSCXN",88,0)
 ..;create a record for appended ekg
"RTN","ECXSCXN",89,0)
 ..S PNODE=$G(^DPT(ECXDFN,"S",ECXDATE,0)) I $P(PNODE,U,1)=ECXCLIN,$P(PNODE,U,5) D
"RTN","ECXSCXN",90,0)
 ...S ECXKEY="10700003000000",ECXSTOP="107" D FILE
"RTN","ECXSCXN",91,0)
 .;stop code additions
"RTN","ECXSCXN",92,0)
 .I PROCESS=2 D  Q
"RTN","ECXSCXN",93,0)
 ..Q:TOSEND=6
"RTN","ECXSCXN",94,0)
 ..S ALEN=0
"RTN","ECXSCXN",95,0)
 ..I SOURCE=TIU S ALEN=$P($G(^TMP($J,"ECXCL",ECXCLIN)),U,2)
"RTN","ECXSCXN",96,0)
 ..S:+ALEN=0 ALEN="030"
"RTN","ECXSCXN",97,0)
 ..S ECXKEY=P1_P2_ALEN_P3_"0",ECXSTOP=P1
"RTN","ECXSCXN",98,0)
 ..D FILE
"RTN","ECXSCXN",99,0)
 .;dispositions
"RTN","ECXSCXN",100,0)
 .I PROCESS=3 D  Q
"RTN","ECXSCXN",101,0)
 ..S ECXKEY=ECXSTOP_"47906000000"
"RTN","ECXSCXN",102,0)
 ..D FILE
"RTN","ECXSCXN",103,0)
 Q
"RTN","ECXSCXN",104,0)
 ;
"RTN","ECXSCXN",105,0)
PAT1(ECXDFN,ECXDATE,ECXERR) ;get patient demographic data
"RTN","ECXSCXN",106,0)
 N OK,X
"RTN","ECXSCXN",107,0)
 K ECXPAT
"RTN","ECXSCXN",108,0)
 S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECXDATE,"."),"1;2;3;4;5",.ECXPAT)
"RTN","ECXSCXN",109,0)
 I 'OK S ECXERR=1 K ECXPAT Q
"RTN","ECXSCXN",110,0)
 S ECXSSN=ECXPAT("SSN")
"RTN","ECXSCXN",111,0)
 S ECXPNM=ECXPAT("NAME")
"RTN","ECXSCXN",112,0)
 S ECXMPI=ECXPAT("MPI")
"RTN","ECXSCXN",113,0)
 S ECXSEX=ECXPAT("SEX")
"RTN","ECXSCXN",114,0)
 S ECXDOB=ECXPAT("DOB")
"RTN","ECXSCXN",115,0)
 S ECXELIG=ECXPAT("ELIG")
"RTN","ECXSCXN",116,0)
 S ECXVET=ECXPAT("VET")
"RTN","ECXSCXN",117,0)
 S ECXSVC=ECXPAT("SC%")
"RTN","ECXSCXN",118,0)
 S ECXRACE=ECXPAT("RACE")
"RTN","ECXSCXN",119,0)
 S ECXPST=ECXPAT("POW STAT")
"RTN","ECXSCXN",120,0)
 S ECXPLOC=ECXPAT("POW LOC")
"RTN","ECXSCXN",121,0)
 S ECXRST=ECXPAT("IR STAT")
"RTN","ECXSCXN",122,0)
 S ECXAST=ECXPAT("AO STAT")
"RTN","ECXSCXN",123,0)
 S ECXMST=ECXPAT("MST STAT")
"RTN","ECXSCXN",124,0)
 S ECXSTATE=ECXPAT("STATE")
"RTN","ECXSCXN",125,0)
 S ECXCNTY=ECXPAT("COUNTY")
"RTN","ECXSCXN",126,0)
 S ECXZIP=ECXPAT("ZIP")
"RTN","ECXSCXN",127,0)
 S ECXENRL=ECXPAT("ENROLL LOC")
"RTN","ECXSCXN",128,0)
 ;get sharing agreement data
"RTN","ECXSCXN",129,0)
 S (ECXPAYOR,ECXSAI)=""
"RTN","ECXSCXN",130,0)
 D VISN19^ECXUTL2(ECXDFN,.ECXPAYOR,.ECXSAI)
"RTN","ECXSCXN",131,0)
 Q
"RTN","ECXSCXN",132,0)
 ;
"RTN","ECXSCXN",133,0)
PAT2(ECXDFN,ECXDATE) ;get date specific patient data
"RTN","ECXSCXN",134,0)
 N X
"RTN","ECXSCXN",135,0)
 ;get primary care data
"RTN","ECXSCXN",136,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."))
"RTN","ECXSCXN",137,0)
 S ECPTTM=$P(X,U,1)
"RTN","ECXSCXN",138,0)
 S ECPTPR=$P(X,U,2)
"RTN","ECXSCXN",139,0)
 S ECCLAS=$P(X,U,3)
"RTN","ECXSCXN",140,0)
 S ECPTNPI=$P(X,U,4)
"RTN","ECXSCXN",141,0)
 S ECASPR=$P(X,U,5)
"RTN","ECXSCXN",142,0)
 S ECCLAS2=$P(X,U,6)
"RTN","ECXSCXN",143,0)
 S ECASNPI=$P(X,U,7)
"RTN","ECXSCXN",144,0)
 ;get inpatient data
"RTN","ECXSCXN",145,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECXA=$P(X,U,1),ECXTS=$P(X,U,3)
"RTN","ECXSCXN",146,0)
 Q
"RTN","ECXSCXN",147,0)
 ;
"RTN","ECXSCXN",148,0)
NOSHOW(ECXDFN,ECXSD,ECXED) ;file noshow data in file #2
"RTN","ECXSCXN",149,0)
 ;input ECXDFN = ien in file #2
"RTN","ECXSCXN",150,0)
 ;      ECXSD  = start date
"RTN","ECXSCXN",151,0)
 ;      ECXED  = end date
"RTN","ECXSCXN",152,0)
 N J,PP,JDATE,NODE,STATUS,CLIN,ALEN,OUT
"RTN","ECXSCXN",153,0)
 S JDATE=ECXSD
"RTN","ECXSCXN",154,0)
 F  S JDATE=$O(^DPT(ECXDFN,"S",JDATE)) Q:'JDATE  Q:JDATE>ECED  S NODE=^(JDATE,0) D
"RTN","ECXSCXN",155,0)
 .S CLIN=+$P(NODE,U,1),STATUS=$P(NODE,U,2),ECXDATE=JDATE
"RTN","ECXSCXN",156,0)
 .S NOSHOW=$S(STATUS="N":"N",STATUS="NA":"N",1:"")
"RTN","ECXSCXN",157,0)
 .Q:NOSHOW=""
"RTN","ECXSCXN",158,0)
 .Q:$P($G(^TMP($J,"ECXCL",CLIN)),U,3)'="C"
"RTN","ECXSCXN",159,0)
 .S (P1,P2,P3)="" D FEEDER^ECXSCX1(CLIN,ECXSD,.P1,.P2,.P3,.TOSEND,.ECXDIV)
"RTN","ECXSCXN",160,0)
 .Q:TOSEND=6
"RTN","ECXSCXN",161,0)
 .;get date specific patient data
"RTN","ECXSCXN",162,0)
 .D PAT2(ECXDFN,ECXDATE)
"RTN","ECXSCXN",163,0)
 .;get appt length
"RTN","ECXSCXN",164,0)
 .S ALEN=0,J=0,OUT=0
"RTN","ECXSCXN",165,0)
 .F  S J=$O(^SC(CLIN,"S",JDATE,J)) Q:'J  Q:OUT  S K=0 F  S K=$O(^SC(CLIN,"S",JDATE,J,K)) Q:'K  Q:OUT  D
"RTN","ECXSCXN",166,0)
 ..S PP=$P($G(^SC(CLIN,"S",JDATE,J,K,0)),U) I PP=ECXDFN S OUT=1,ALEN=$P(^(0),U,2),ALEN=$$RJ^XLFSTR(ALEN,3,0)
"RTN","ECXSCXN",167,0)
 .S:+ALEN=0 ALEN=$P($G(^TMP($J,"ECXCL",CLIN)),U,2)
"RTN","ECXSCXN",168,0)
 .S ECXCLIN=CLIN,ECXSTOP=P1
"RTN","ECXSCXN",169,0)
 .S ECXCPT="99199" F L=6:1:120 S ECXCPT=ECXCPT_" "
"RTN","ECXSCXN",170,0)
 .S ECXICD9="799.9" F L=6:1:63 S ECXICD9=ECXICD9_" "
"RTN","ECXSCXN",171,0)
 .S (ECXDSSD,ECXENEL,ECXIR,ECXAO,ECXMIL,ECXPROV,ECXPROVP,ECXPROVN)=""
"RTN","ECXSCXN",172,0)
 .I TOSEND'=3 S ECXKEY=P1_P2_ALEN_P3_NOSHOW D FILE
"RTN","ECXSCXN",173,0)
 .I TOSEND=3 S ECXKEY=P1_"000"_ALEN_P3_NOSHOW D FILE
"RTN","ECXSCXN",174,0)
 .I TOSEND=3 S ECXKEY=P2_"000"_ALEN_P3_NOSHOW D FILE
"RTN","ECXSCXN",175,0)
 .;create a record for noshow appended ekg
"RTN","ECXSCXN",176,0)
 .I $P(NODE,U,5) S ECXKEY="1070000300000N",ECXSTOP="107" D FILE
"RTN","ECXSCXN",177,0)
 Q
"RTN","ECXSCXN",178,0)
 ;
"RTN","ECXSCXN",179,0)
FILE ;record setup for files #727.816 & #727.818
"RTN","ECXSCXN",180,0)
 ;file #727.816 record
"RTN","ECXSCXN",181,0)
 ;node0
"RTN","ECXSCXN",182,0)
 ;facility^dfn^ssn^name^in/out status^day^feeder key^treat spec^encounter elig^pc provider^pc provider person class^pc prov npi
"RTN","ECXSCXN",183,0)
 ;assoc pc provider^assoc pc prov person class^assoc pc prov npi^clinic
"RTN","ECXSCXN",184,0)
 ;node1
"RTN","ECXSCXN",185,0)
 ;cpt&modifiers^pc team
"RTN","ECXSCXN",186,0)
 S EC7=$O(^ECX(727.816,999999999),-1),EC7=EC7+1
"RTN","ECXSCXN",187,0)
 S ECODE=EC7_U_EC23
"RTN","ECXSCXN",188,0)
 S ECODE=ECODE_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECXKEY
"RTN","ECXSCXN",189,0)
 S ECODE=ECODE_U_ECXTS_U_ECXENEL_U_ECPTPR_U_ECCLAS_U_ECPTNPI_U_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXCLIN
"RTN","ECXSCXN",190,0)
 S ECODE1=ECXCPT_U_ECPTTM
"RTN","ECXSCXN",191,0)
 D FILE2(727.816,EC7,ECODE,ECODE1)
"RTN","ECXSCXN",192,0)
 ;
"RTN","ECXSCXN",193,0)
 ;file #727.818 record
"RTN","ECXSCXN",194,0)
 ;node0
"RTN","ECXSCXN",195,0)
 ;facility^dfn^ssn^name^in/out status^day^primary stop^mpi^sex^dob^elig^vet^race^pow status^pow loc^ir status^ao status^mst status^
"RTN","ECXSCXN",196,0)
 ;state^county^zip^enroll loc^^provider^prov person class^prov npi^sa payor^sa insurance^ir encounter^ao encounter^mst encounter^dss dept
"RTN","ECXSCXN",197,0)
 ;node1
"RTN","ECXSCXN",198,0)
 ;icd9
"RTN","ECXSCXN",199,0)
 ;be sure that stop matches feeder key
"RTN","ECXSCXN",200,0)
 S ECXSTOP=$E(ECXKEY,1,3)
"RTN","ECXSCXN",201,0)
 S ECODE=EC7_U_EC23
"RTN","ECXSCXN",202,0)
 S ECODE=ECODE_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECXSTOP_U_ECXMPI
"RTN","ECXSCXN",203,0)
 S ECODE=ECODE_U_ECXSEX_U_ECXDOB_U_ECXELIG_U_ECXVET_U_ECXRACE_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST_U_ECXMST
"RTN","ECXSCXN",204,0)
 S ECODE=ECODE_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXENRL_U_U_ECXPROV_U_ECXPROVP_U_ECXPROVN_U_ECXPAYOR_U_ECXSAI_U_ECXIR_U_ECXAO_U_ECXMIL_U_ECXDSSD
"RTN","ECXSCXN",205,0)
 S ECODE1=ECXICD9
"RTN","ECXSCXN",206,0)
 D FILE2(727.818,EC7,ECODE,ECODE1)
"RTN","ECXSCXN",207,0)
 S ECRN=ECRN+1
"RTN","ECXSCXN",208,0)
 Q
"RTN","ECXSCXN",209,0)
 ;
"RTN","ECXSCXN",210,0)
FILE2(ECXFILE,EC7,ECODE,ECODE1) ;file record
"RTN","ECXSCXN",211,0)
 N DA,DIK,QFLG
"RTN","ECXSCXN",212,0)
 S ^ECX(ECXFILE,EC7,0)=ECODE,^ECX(ECXFILE,EC7,1)=ECODE1
"RTN","ECXSCXN",213,0)
 S DA=EC7,DIK="^ECX("_ECXFILE_"," D IX^DIK K DIK,DA
"RTN","ECXSCXN",214,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSCXN",215,0)
 Q
"RTN","ECXSCXN",216,0)
 ;
"RTN","ECXSCXN",217,0)
SETUP ;set required input for ECXTRAC
"RTN","ECXSCXN",218,0)
 S ECHEAD="CLI"
"RTN","ECXSCXN",219,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXSCXN",220,0)
 Q
"RTN","ECXTRAC")
0^3^B52493798
"RTN","ECXTRAC",1,0)
ECXTRAC ;ALB/GTS,JAP,BIR/DMA,CML-Package Extracts for DSS ; 11/08/96 15:37
"RTN","ECXTRAC",2,0)
 ;;3.0;DSS EXTRACTS;**9,8,14,24,30**;Dec 22, 1997
"RTN","ECXTRAC",3,0)
 ;Date range, queuing and message sending for package extracts
"RTN","ECXTRAC",4,0)
 ;Input ECPACK   printed name of package (e.g. Lab, Prescriptions)
"RTN","ECXTRAC",5,0)
 ;      ECNODE   in file 728 where last date is stored
"RTN","ECXTRAC",6,0)
 ;      ECPIECE  piece of node where last date is stored
"RTN","ECXTRAC",7,0)
 ;      ECRTN    in the form of START^ROUTINE
"RTN","ECXTRAC",8,0)
 ;      ECGRP    name of local mail group to receive summary message
"RTN","ECXTRAC",9,0)
 ;               (MUST BE 1 TO 5 UPPER CASE ALPHA - NO SPACES)
"RTN","ECXTRAC",10,0)
 ;      ECFILE   file number of the local editing file
"RTN","ECXTRAC",11,0)
 ; generates EC23=2nd and 3rd piece of zero node in local editing file
"RTN","ECXTRAC",12,0)
 ;               =YYMM of end date^pointer to 727
"RTN","ECXTRAC",13,0)
 ;
"RTN","ECXTRAC",14,0)
EN ;entry point
"RTN","ECXTRAC",15,0)
 N OUT,CHKFLG
"RTN","ECXTRAC",16,0)
 I '$D(ECNODE) S ECNODE=7
"RTN","ECXTRAC",17,0)
 I '$D(ECHEAD) S ECHEAD=" "
"RTN","ECXTRAC",18,0)
 I $P($G(^ECX(728,1,ECNODE+.1)),U,ECPIECE)]"" D  Q
"RTN","ECXTRAC",19,0)
 .W !!,$C(7),ECPACK," extract is already scheduled to run",!!
"RTN","ECXTRAC",20,0)
 .D PAUSE
"RTN","ECXTRAC",21,0)
 W @IOF,!,"Extract ",ECPACK," Information for DSS",!!
"RTN","ECXTRAC",22,0)
 S:'$D(ECINST) ECINST=+$P(^ECX(728,1,0),U)
"RTN","ECXTRAC",23,0)
 S ECXINST=ECINST
"RTN","ECXTRAC",24,0)
 K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXTRAC",25,0)
 D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXTRAC",26,0)
 ;* get last date for all extracts except prosthetics
"RTN","ECXTRAC",27,0)
 I ECGRP'="PRO" D
"RTN","ECXTRAC",28,0)
 .S ECLDT=$S($D(^ECX(728,1,ECNODE)):$P(^(ECNODE),U,ECPIECE),1:2610624)
"RTN","ECXTRAC",29,0)
 .S:ECLDT="" ECLDT=2610624
"RTN","ECXTRAC",30,0)
 ;* get last date for prosthetics
"RTN","ECXTRAC",31,0)
 I ECGRP="PRO" D
"RTN","ECXTRAC",32,0)
 .N ECXDA1
"RTN","ECXTRAC",33,0)
 .S ECXDA1=$O(^ECX(728,0))
"RTN","ECXTRAC",34,0)
 .I $D(^ECX(728,ECXDA1,1,ECXINST,0)) D
"RTN","ECXTRAC",35,0)
 ..S ECLDT=$P(^ECX(728,ECXDA1,1,ECXINST,0),U,2)
"RTN","ECXTRAC",36,0)
 .I '$D(^ECX(728,ECXDA1,1,ECXINST,0)) D
"RTN","ECXTRAC",37,0)
 ..S DA(1)=ECXDA1
"RTN","ECXTRAC",38,0)
 ..S DIC(0)="L" K ECXDD
"RTN","ECXTRAC",39,0)
 ..D FIELD^DID(728,59,,"SPECIFIER","ECXDD")
"RTN","ECXTRAC",40,0)
 ..S DIC("P")=ECXDD("SPECIFIER") K ECXDD
"RTN","ECXTRAC",41,0)
 ..S DIC="^ECX(728,"_DA(1)_",1,",X=ECXINST,DINUM=X
"RTN","ECXTRAC",42,0)
 ..K DD,DO D FILE^DICN
"RTN","ECXTRAC",43,0)
 ..K DIC,X,DINUM,Y,DA
"RTN","ECXTRAC",44,0)
 ..S ECLDT=2610624
"RTN","ECXTRAC",45,0)
 S OUT=0
"RTN","ECXTRAC",46,0)
 F  S (ECED,ECSD)="" D  Q:OUT
"RTN","ECXTRAC",47,0)
 .K %DT S %DT="AEX",%DT("A")="Starting with Date: " D ^%DT
"RTN","ECXTRAC",48,0)
 .I Y<0 S OUT=1 Q
"RTN","ECXTRAC",49,0)
 .S ECSD=Y
"RTN","ECXTRAC",50,0)
 .K %DT S %DT="AEX",%DT("A")="Ending with Date: " D ^%DT
"RTN","ECXTRAC",51,0)
 .I Y<0 S OUT=1 Q
"RTN","ECXTRAC",52,0)
 .I Y<ECSD D  Q
"RTN","ECXTRAC",53,0)
 ..W !!,"The ending date cannot be earlier than the starting date."
"RTN","ECXTRAC",54,0)
 ..W !,"Please try again.",!!
"RTN","ECXTRAC",55,0)
 .I $E(Y,1,5)'=$E(ECSD,1,5) D  Q
"RTN","ECXTRAC",56,0)
 ..W !!,"Beginning and ending dates must be in the same month and year."
"RTN","ECXTRAC",57,0)
 ..W !,"Please try again.",!!
"RTN","ECXTRAC",58,0)
 .S ECED=Y
"RTN","ECXTRAC",59,0)
 .I ECLDT'<ECSD D  Q
"RTN","ECXTRAC",60,0)
 ..W !!,"The ",ECPACK," information has already been extracted through ",$$FMTE^XLFDT(ECLDT),"."
"RTN","ECXTRAC",61,0)
 ..W !,"Please enter a new date range.",!!
"RTN","ECXTRAC",62,0)
 .S OUT=1
"RTN","ECXTRAC",63,0)
 I ECED]"",ECSD]"" D QUE
"RTN","ECXTRAC",64,0)
 Q
"RTN","ECXTRAC",65,0)
 ;
"RTN","ECXTRAC",66,0)
QUE ;queue extract
"RTN","ECXTRAC",67,0)
 N CHKFLG
"RTN","ECXTRAC",68,0)
 ;if extract is ivp (i.e., file=727.819) and data in the intermediate file use new format
"RTN","ECXTRAC",69,0)
 I ECFILE=727.819 D  Q:CHKFLG
"RTN","ECXTRAC",70,0)
 .S CHKFLG=0
"RTN","ECXTRAC",71,0)
 .S X="PSIVSTAT" X ^%ZOSF("TEST") I '$T Q
"RTN","ECXTRAC",72,0)
 .I '$D(^ECX(728.113,"A")) S CHKFLG=1 D NOIVP Q
"RTN","ECXTRAC",73,0)
 .S DATE=$O(^ECX(728.113,"A",ECED+1),-1) I DATE<ECSD S CHKFLG=1 D NOIVP Q
"RTN","ECXTRAC",74,0)
 .D CHK^ECXDIVIV Q:CHKFLG
"RTN","ECXTRAC",75,0)
 .D CHK2
"RTN","ECXTRAC",76,0)
 .S ECRTN="START^ECXPIVDN",ECVER=7
"RTN","ECXTRAC",77,0)
 I '$D(ECNODE) S ECNODE=7
"RTN","ECXTRAC",78,0)
 I '$D(ECHEAD) S ECHEAD=""
"RTN","ECXTRAC",79,0)
 S ECSDN=$$FMTE^XLFDT(ECSD),ECEDN=$$FMTE^XLFDT(ECED),ECSD1=ECSD-.1
"RTN","ECXTRAC",80,0)
 K ZTSAVE
"RTN","ECXTRAC",81,0)
 S (ZTSAVE("ECINST"),ZTSAVE("ECED"),ZTSAVE("ECSD"),ZTSAVE("ECSD1"),ZTSAVE("ECEDN"),ZTSAVE("ECSDN"))=""
"RTN","ECXTRAC",82,0)
 S (ZTSAVE("ECPACK"),ZTSAVE("ECPIECE"),ZTSAVE("ECRTN"),ZTSAVE("ECGRP"),ZTSAVE("ECNODE"),ZTSAVE("ECFILE"),ZTSAVE("ECHEAD"),ZTSAVE("ECVER"))=""
"RTN","ECXTRAC",83,0)
 S (ZTSAVE("ECINST"),ZTSAVE("ECXINST"))=""
"RTN","ECXTRAC",84,0)
 S ZTDESC=ECPACK_" EXTRACT: "_ECSDN_" TO "_ECEDN,ZTRTN="START^ECXTRAC",ZTIO=""
"RTN","ECXTRAC",85,0)
 D ^%ZTLOAD
"RTN","ECXTRAC",86,0)
 I $D(ZTSK) D
"RTN","ECXTRAC",87,0)
 .S $P(^ECX(728,1,ECNODE+.1),U,ECPIECE)="R"
"RTN","ECXTRAC",88,0)
 .W !,"Request queued as Task #",ZTSK,".",!
"RTN","ECXTRAC",89,0)
 .D PAUSE
"RTN","ECXTRAC",90,0)
 Q
"RTN","ECXTRAC",91,0)
 ;
"RTN","ECXTRAC",92,0)
NOIVP ;cannot generate ivp message
"RTN","ECXTRAC",93,0)
 W !!,?5,"There does not appear to be any data in the IV EXTRACT DATA"
"RTN","ECXTRAC",94,0)
 W !,?5,"file (#728.113) for the selected date range."
"RTN","ECXTRAC",95,0)
 W !!,?5,"The IVP extract cannot be generated."
"RTN","ECXTRAC",96,0)
 D PAUSE
"RTN","ECXTRAC",97,0)
 Q
"RTN","ECXTRAC",98,0)
 ;
"RTN","ECXTRAC",99,0)
START ; entry when queued
"RTN","ECXTRAC",100,0)
 S QFLG=0
"RTN","ECXTRAC",101,0)
 L +^ECX(727,0) S EC=$P(^ECX(727,0),U,3)+1,$P(^(0),U,3,4)=EC_U_EC L -^ECX(727,0)
"RTN","ECXTRAC",102,0)
 S ^ECX(727,EC,0)=EC_U_DT_U_ECPACK_U_ECSD_U_$E(ECED,1,7)
"RTN","ECXTRAC",103,0)
 S ^ECX(727,EC,"HEAD")=ECHEAD
"RTN","ECXTRAC",104,0)
 S ^ECX(727,EC,"FILE")=ECFILE
"RTN","ECXTRAC",105,0)
 S ^ECX(727,EC,"GRP")=ECGRP
"RTN","ECXTRAC",106,0)
 I $D(ECVER) S ^ECX(727,EC,"VER")=ECVER
"RTN","ECXTRAC",107,0)
 S ^ECX(727,EC,"DIV")=ECXINST
"RTN","ECXTRAC",108,0)
 S DA=EC,DIK="^ECX(727," D IX^DIK K DIK,DA
"RTN","ECXTRAC",109,0)
 S ECRN=0,ECXYM=$$ECXYM^ECXUTL(ECED),EC23=ECXYM_U_EC
"RTN","ECXTRAC",110,0)
 S ECXSTART=$P($$HTE^XLFDT($H),":",1,2),ECXNOW=$H
"RTN","ECXTRAC",111,0)
 ;do specific extract
"RTN","ECXTRAC",112,0)
 D @ECRTN
"RTN","ECXTRAC",113,0)
 ;if task gets stop request, set ztstop and quit
"RTN","ECXTRAC",114,0)
 I QFLG D  Q
"RTN","ECXTRAC",115,0)
 .S $P(^ECX(728,1,ECNODE+.1),U,ECPIECE)="",ZTSTOP=1
"RTN","ECXTRAC",116,0)
 .D QKILL
"RTN","ECXTRAC",117,0)
 .D QMSG
"RTN","ECXTRAC",118,0)
 .D ^ECXKILL
"RTN","ECXTRAC",119,0)
 ;* set last date for all extracts except prosthetics
"RTN","ECXTRAC",120,0)
 S:(ECGRP'="PRO") $P(^ECX(728,1,ECNODE),U,ECPIECE)=$P(ECED,".")
"RTN","ECXTRAC",121,0)
 ;* set last date for prosthetics
"RTN","ECXTRAC",122,0)
 I ECGRP="PRO" D
"RTN","ECXTRAC",123,0)
 .N ECXDA1
"RTN","ECXTRAC",124,0)
 .S ECXDA1=$O(^ECX(728,0))
"RTN","ECXTRAC",125,0)
 .S $P(^ECX(728,ECXDA1,1,ECXINST,0),U,2)=$P(ECED,".")
"RTN","ECXTRAC",126,0)
 S TIME=$P($$HTE^XLFDT($H),":",1,2)
"RTN","ECXTRAC",127,0)
 S $P(^ECX(727,$P(EC23,U,2),0),U,6)=ECRN
"RTN","ECXTRAC",128,0)
 ;set piece 3 and 4 of the zero node
"RTN","ECXTRAC",129,0)
 S ECLAST=$O(^ECX(ECFILE,99999999),-1),ECTOTAL=$P(^ECX(ECFILE,0),U,4)+ECRN,$P(^(0),U,3,4)=ECLAST_U_ECTOTAL K ECLAST,ECTOTAL
"RTN","ECXTRAC",130,0)
 D MSG
"RTN","ECXTRAC",131,0)
 S $P(^ECX(728,1,ECNODE+.1),U,ECPIECE)=""
"RTN","ECXTRAC",132,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","ECXTRAC",133,0)
 Q
"RTN","ECXTRAC",134,0)
 ;
"RTN","ECXTRAC",135,0)
MSG ; send message to mail group 'DSS-ECGRP'
"RTN","ECXTRAC",136,0)
 S XMSUB=ECINST_" - "_ECPACK_" EXTRACT FOR DSS",XMDUZ="DSS SYSTEM"
"RTN","ECXTRAC",137,0)
 K XMY S XMY("G.DSS-"_ECGRP_"@"_^XMB("NETNAME"))=""
"RTN","ECXTRAC",138,0)
 S ECMSG(1,0)="The DSS-"_ECPACK_" extract (#"_$P(EC23,U,2)_") for "_ECSDN
"RTN","ECXTRAC",139,0)
 S ECMSG(2,0)="through "_ECEDN_" was begun on "_$P(ECXSTART,"@")_" at "_$P(ECXSTART,"@",2)
"RTN","ECXTRAC",140,0)
 S ECMSG(3,0)="and completed on "_$P(TIME,"@")_" at "_$P(TIME,"@",2)_"."
"RTN","ECXTRAC",141,0)
 S ECMSG(4,0)=" "
"RTN","ECXTRAC",142,0)
 S ECMSG(5,0)="A total of "_ECRN_" records were written."
"RTN","ECXTRAC",143,0)
 S ECMSG(6,0)=" "
"RTN","ECXTRAC",144,0)
 S ECMSG(7,0)="Extract time was [HH:MM:SS] "_$$HDIFF^XLFDT($H,ECXNOW,3)
"RTN","ECXTRAC",145,0)
 S ECMSG(8,0)=" "
"RTN","ECXTRAC",146,0)
 S XMTEXT="ECMSG("
"RTN","ECXTRAC",147,0)
 D ^XMD
"RTN","ECXTRAC",148,0)
 Q
"RTN","ECXTRAC",149,0)
 ;
"RTN","ECXTRAC",150,0)
QMSG ; send abort message to mail group 'DSS-ECGRP'
"RTN","ECXTRAC",151,0)
 S XMSUB=ECINST_" - "_ECPACK_" EXTRACT FOR DSS",XMDUZ="DSS SYSTEM"
"RTN","ECXTRAC",152,0)
 K XMY S XMY("G.DSS-"_ECGRP_"@"_^XMB("NETNAME"))=""
"RTN","ECXTRAC",153,0)
 S ECMSG(1,0)="The DSS-"_ECPACK_" extract (#"_$P(EC23,U,2)_") for "_ECSDN
"RTN","ECXTRAC",154,0)
 S ECMSG(2,0)="through "_ECEDN_" was begun on "_$P(ECXSTART,"@")_" at "_$P(ECXSTART,"@",2)_"."
"RTN","ECXTRAC",155,0)
 S ECMSG(3,0)=" "
"RTN","ECXTRAC",156,0)
 S ECMSG(4,0)="A user stop request was received by Taskmanager which caused processing"
"RTN","ECXTRAC",157,0)
 S ECMSG(5,0)="to terminate before completion.  Any records which may have been created"
"RTN","ECXTRAC",158,0)
 I ECFILE'=727.816 S ECMSG(6,0)="in file #"_ECFILE_" for this extract have been deleted."
"RTN","ECXTRAC",159,0)
 I ECFILE=727.816 S ECMSG(6,0)="in files #"_ECFILE_" & #727.818 for this extract have been deleted."
"RTN","ECXTRAC",160,0)
 S ECMSG(7,0)=" "
"RTN","ECXTRAC",161,0)
 S XMTEXT="ECMSG("
"RTN","ECXTRAC",162,0)
 D ^XMD
"RTN","ECXTRAC",163,0)
 Q
"RTN","ECXTRAC",164,0)
 ;
"RTN","ECXTRAC",165,0)
QKILL ;delete records created for any extract stopped at user request
"RTN","ECXTRAC",166,0)
 N ECX,FILE,IEN,DA,DIK
"RTN","ECXTRAC",167,0)
 S FILE="^ECX("_ECFILE_","
"RTN","ECXTRAC",168,0)
 S ECX=$P(EC23,U,2)
"RTN","ECXTRAC",169,0)
 F  S IEN=$O(^ECX(ECFILE,999999999),-1) Q:($P(^ECX(ECFILE,IEN,0),U,3)'=ECX)  D
"RTN","ECXTRAC",170,0)
 .S DIK=FILE,DA=IEN D ^DIK
"RTN","ECXTRAC",171,0)
 ;if records in file #727.816 are deleted, do same for file #727.818
"RTN","ECXTRAC",172,0)
 I ECFILE=727.816,ECHEAD="SCX" D
"RTN","ECXTRAC",173,0)
 .F  S IEN=$O(^ECX(727.818,999999999),-1) Q:($P(^ECX(727.818,IEN,0),U,3)'=ECX)  D
"RTN","ECXTRAC",174,0)
 ..S DIK="^ECX(727.818,",DA=IEN D ^DIK
"RTN","ECXTRAC",175,0)
 Q
"RTN","ECXTRAC",176,0)
 ;
"RTN","ECXTRAC",177,0)
CHK2 ;iv extract check - all active iv rooms to have a division
"RTN","ECXTRAC",178,0)
 S EC=0
"RTN","ECXTRAC",179,0)
 F  S EC=$O(^PS(59.5,EC)) Q:'EC  I '$P(^PS(59.5,EC,0),U,4) D  Q:CHKFLG
"RTN","ECXTRAC",180,0)
 .S CHKFLG=$S('$G(^PS(59.5,EC,"I")):1,$G(^PS(59.5,EC,"I"))>DT:1,1:0)
"RTN","ECXTRAC",181,0)
 .I CHKFLG D
"RTN","ECXTRAC",182,0)
 ..W !!,"All active IV Rooms in the IV Room file (#59.5) must have a ""DIVISION""",!,"assigned to run this extract!"
"RTN","ECXTRAC",183,0)
 ..W !!,"This information can be entered using the DSS Extract Manager's Maintenance ",!,"option ""Enter/Edit IV Room Division""."
"RTN","ECXTRAC",184,0)
 ..D PAUSE
"RTN","ECXTRAC",185,0)
 Q
"RTN","ECXTRAC",186,0)
 ;
"RTN","ECXTRAC",187,0)
PAUSE ;pause screen
"RTN","ECXTRAC",188,0)
 S OUT=0
"RTN","ECXTRAC",189,0)
 I $E(IOST)="C" D
"RTN","ECXTRAC",190,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXTRAC",191,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXTRAC",192,0)
 I 'Y S OUT=1
"RTN","ECXTRAC",193,0)
 W !!
"RTN","ECXTRAC",194,0)
 Q
"VER")
8.0^22.0
**END**
**END**
