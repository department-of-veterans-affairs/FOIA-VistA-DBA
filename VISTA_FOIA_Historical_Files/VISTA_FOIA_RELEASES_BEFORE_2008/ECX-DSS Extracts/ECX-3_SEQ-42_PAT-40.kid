Released ECX*3*40 SEQ #42
Extracted from mail message
**KIDS**:ECX*3.0*40^

**INSTALL NAME**
ECX*3.0*40
"BLD",3695,0)
ECX*3.0*40^DSS EXTRACTS^0^3020412^y
"BLD",3695,4,0)
^9.64PA^^
"BLD",3695,"KRN",0)
^9.67PA^19^17
"BLD",3695,"KRN",.4,0)
.4
"BLD",3695,"KRN",.401,0)
.401
"BLD",3695,"KRN",.402,0)
.402
"BLD",3695,"KRN",.403,0)
.403
"BLD",3695,"KRN",.5,0)
.5
"BLD",3695,"KRN",.84,0)
.84
"BLD",3695,"KRN",3.6,0)
3.6
"BLD",3695,"KRN",3.8,0)
3.8
"BLD",3695,"KRN",9.2,0)
9.2
"BLD",3695,"KRN",9.8,0)
9.8
"BLD",3695,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",3695,"KRN",9.8,"NM",1,0)
ECXAPHA^^0^B28872178
"BLD",3695,"KRN",9.8,"NM",2,0)
ECXAPHA2^^0^B20019330
"BLD",3695,"KRN",9.8,"NM",3,0)
ECXDRUG1^^0^B30533740
"BLD",3695,"KRN",9.8,"NM",4,0)
ECXDRUG2^^0^B14790508
"BLD",3695,"KRN",9.8,"NM",5,0)
ECXFEKEY^^0^B41289219
"BLD",3695,"KRN",9.8,"NM",6,0)
ECXFEKE1^^0^B31398027
"BLD",3695,"KRN",9.8,"NM","B","ECXAPHA",1)

"BLD",3695,"KRN",9.8,"NM","B","ECXAPHA2",2)

"BLD",3695,"KRN",9.8,"NM","B","ECXDRUG1",3)

"BLD",3695,"KRN",9.8,"NM","B","ECXDRUG2",4)

"BLD",3695,"KRN",9.8,"NM","B","ECXFEKE1",6)

"BLD",3695,"KRN",9.8,"NM","B","ECXFEKEY",5)

"BLD",3695,"KRN",19,0)
19
"BLD",3695,"KRN",19,"NM",0)
^9.68A^5^3
"BLD",3695,"KRN",19,"NM",3,0)
ECX PHA VOL^^0^
"BLD",3695,"KRN",19,"NM",4,0)
ECX PHA FKEY^^0^
"BLD",3695,"KRN",19,"NM",5,0)
ECX MAINTENANCE^^2
"BLD",3695,"KRN",19,"NM","B","ECX MAINTENANCE",5)

"BLD",3695,"KRN",19,"NM","B","ECX PHA FKEY",4)

"BLD",3695,"KRN",19,"NM","B","ECX PHA VOL",3)

"BLD",3695,"KRN",19.1,0)
19.1
"BLD",3695,"KRN",101,0)
101
"BLD",3695,"KRN",409.61,0)
409.61
"BLD",3695,"KRN",771,0)
771
"BLD",3695,"KRN",870,0)
870
"BLD",3695,"KRN",8994,0)
8994
"BLD",3695,"KRN","B",.4,.4)

"BLD",3695,"KRN","B",.401,.401)

"BLD",3695,"KRN","B",.402,.402)

"BLD",3695,"KRN","B",.403,.403)

"BLD",3695,"KRN","B",.5,.5)

"BLD",3695,"KRN","B",.84,.84)

"BLD",3695,"KRN","B",3.6,3.6)

"BLD",3695,"KRN","B",3.8,3.8)

"BLD",3695,"KRN","B",9.2,9.2)

"BLD",3695,"KRN","B",9.8,9.8)

"BLD",3695,"KRN","B",19,19)

"BLD",3695,"KRN","B",19.1,19.1)

"BLD",3695,"KRN","B",101,101)

"BLD",3695,"KRN","B",409.61,409.61)

"BLD",3695,"KRN","B",771,771)

"BLD",3695,"KRN","B",870,870)

"BLD",3695,"KRN","B",8994,8994)

"BLD",3695,"QUES",0)
^9.62^^
"BLD",3695,"REQB",0)
^9.611^1^1
"BLD",3695,"REQB",1,0)
ECX*3.0*8^2
"BLD",3695,"REQB","B","ECX*3.0*8",1)

"KRN",19,10161,-1)
2^5
"KRN",19,10161,0)
ECX MAINTENANCE^Maintenance^^M^11714^ECXMGR^^^^^^513
"KRN",19,10161,10,0)
^19.01IP^14^14
"KRN",19,10161,10,13,0)
12024^11^60
"KRN",19,10161,10,13,"^")
ECX PHA FKEY
"KRN",19,10161,10,14,0)
12023^12^65
"KRN",19,10161,10,14,"^")
ECX PHA VOL
"KRN",19,10161,"U")
MAINTENANCE
"KRN",19,12023,-1)
0^3
"KRN",19,12023,0)
ECX PHA VOL^Pharmacy Extracts Unusual Volume Report^^R^^^^^^^^DSS EXTRACTS
"KRN",19,12023,25)
EN^ECXAPHA
"KRN",19,12023,"U")
PHARMACY EXTRACTS UNUSUAL VOLU
"KRN",19,12024,-1)
0^4
"KRN",19,12024,0)
ECX PHA FKEY^Pharmacy Extracts Incomplete Feeder Key Report^^R^^^^^^^^DSS EXTRACTS
"KRN",19,12024,25)
EN^ECXDRUG1
"KRN",19,12024,"U")
PHARMACY EXTRACTS INCOMPLETE F
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010618^2980112^11714
"PKG",513,22,1,"PAH",1,0)
40^3020412
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","ECXAPHA")
0^1^B28872178
"RTN","ECXAPHA",1,0)
ECXAPHA ;ALB/TMD-Pharmacy Extracts Unusual Volumes Report ; 4/12/02 9:14am
"RTN","ECXAPHA",2,0)
 ;;3.0;DSS EXTRACTS;**40**;Dec 22, 1997
"RTN","ECXAPHA",3,0)
 ;
"RTN","ECXAPHA",4,0)
EN ; entry point
"RTN","ECXAPHA",5,0)
 N X,Y,DATE,ECRUN,ECXOPT,ECXDESC,ECXSAVE,ECXTL,ECTHLD,ECSD,ECSD1,ECSTART,ECED,ECEND,ECXERR,QFLG
"RTN","ECXAPHA",6,0)
 S QFLG=0
"RTN","ECXAPHA",7,0)
 ; get today's date
"RTN","ECXAPHA",8,0)
 D NOW^%DTC S DATE=X,Y=$E(%,1,12) D DD^%DT S ECRUN=$P(Y,"@") K %DT
"RTN","ECXAPHA",9,0)
 D BEGIN Q:QFLG
"RTN","ECXAPHA",10,0)
 D SELECT Q:QFLG
"RTN","ECXAPHA",11,0)
 S ECXDESC=ECXTL_" Extract Unusual Volume Report"
"RTN","ECXAPHA",12,0)
 S ECXSAVE("EC*")=""
"RTN","ECXAPHA",13,0)
 W !!,"This report requires 132 column format."
"RTN","ECXAPHA",14,0)
 D EN^XUTMDEVQ("PROCESS^ECXAPHA",ECXDESC,.ECXSAVE)
"RTN","ECXAPHA",15,0)
 I POP W !!,"No device selected...exiting.",! Q
"RTN","ECXAPHA",16,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXAPHA",17,0)
 D HOME^%ZIS
"RTN","ECXAPHA",18,0)
 D AUDIT^ECXKILL
"RTN","ECXAPHA",19,0)
 Q
"RTN","ECXAPHA",20,0)
 ;
"RTN","ECXAPHA",21,0)
BEGIN ; display report description
"RTN","ECXAPHA",22,0)
 W @IOF,!,"This report prints a listing of unusual volumes that would be generated by the",!,"pharmacy extracts (PRE, IVP and UDP) as determined by a user defined threshold"
"RTN","ECXAPHA",23,0)
 W !,"value.  It shoud be run prior to the generation of the actual extract(s) to",!,"identify and fix as necessary any volumes determined to be erroneous."
"RTN","ECXAPHA",24,0)
 W !!,"Unusual volumes are defined as follows:"
"RTN","ECXAPHA",25,0)
 W !!,"PRE Extract:  Quantity field greater than the threshold value."
"RTN","ECXAPHA",26,0)
 W !,"IVP Extract:  Total Doses Per Day field greater than the threshold",!,?14,"or less than the negative of the threshold value."
"RTN","ECXAPHA",27,0)
 W !,"UDP Extract:  Quantity field greater than threshold value."
"RTN","ECXAPHA",28,0)
 W !!,"Note: The threshold can be set after a report is selected."
"RTN","ECXAPHA",29,0)
 W !!,"Run times for this report will vary depending upon the size of the extract and",!,"could take as long as 30 minutes or more to complete.  This report has no effect",!,"on the actual extracts and can be run as needed."
"RTN","ECXAPHA",30,0)
 W !!,"The report is sorted by Feeder Key, then by descending Volume and SSN."
"RTN","ECXAPHA",31,0)
 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXAPHA",32,0)
 W:$Y!($E(IOST)="C") @IOF,!!
"RTN","ECXAPHA",33,0)
 Q
"RTN","ECXAPHA",34,0)
 ;
"RTN","ECXAPHA",35,0)
SELECT ; user inputs for report option, threshold volume and date range
"RTN","ECXAPHA",36,0)
 N DONE,OUT
"RTN","ECXAPHA",37,0)
 ; allow user to select report option (PRE,IVP or PRE)
"RTN","ECXAPHA",38,0)
 W "Choose the report you would like to run."
"RTN","ECXAPHA",39,0)
 S DIR(0)="S^1:PRE;2:IVP;3:UDP",DIR("A")="Selection",DIR("B")=1 D ^DIR K DIR S ECXOPT=Y I X["^" S QFLG=1 Q
"RTN","ECXAPHA",40,0)
 S ECXTL=$S(ECXOPT=1:"Prescription",ECXOPT=2:"IV Detail",ECXOPT=3:"Unit Dose Local",1:"")
"RTN","ECXAPHA",41,0)
 ; allow user to set threshold volume
"RTN","ECXAPHA",42,0)
 S ECTHLD=$S(ECXOPT=2:1000,1:500)
"RTN","ECXAPHA",43,0)
 W !!,"The default threshold volume for the ",ECXTL," extract is ",ECTHLD,"."
"RTN","ECXAPHA",44,0)
 S DIR(0)="Y",DIR("A")="Would you like to change the threshold",DIR("B")="NO" D ^DIR K DIR I X["^" S QFLG=1 Q
"RTN","ECXAPHA",45,0)
 I Y D
"RTN","ECXAPHA",46,0)
 .W !!,$S(ECXOPT=2:"threshold > Total Doses Per Day < -threshold",1:"Quantity > threshold")
"RTN","ECXAPHA",47,0)
 .S DIR(0)="N^0:100000:0",DIR("A")="Enter the new threshold volume" D ^DIR K DIR S ECTHLD=Y I X["^" S QFLG=1 Q
"RTN","ECXAPHA",48,0)
 ; get date range from user
"RTN","ECXAPHA",49,0)
 W !!,"Enter the date range for which you would like to scan the ",ECXTL,!,"Extract records."
"RTN","ECXAPHA",50,0)
 S DONE=0 F  S (ECED,ECSD)="" D  Q:QFLG!DONE
"RTN","ECXAPHA",51,0)
 .K %DT S %DT="AEX",%DT("A")="Starting with Date: ",%DT(0)=-DATE D ^%DT
"RTN","ECXAPHA",52,0)
 .I Y<0 S QFLG=1 Q
"RTN","ECXAPHA",53,0)
 .S ECSD=Y,ECSD1=ECSD-.1
"RTN","ECXAPHA",54,0)
 .D DD^%DT S ECSTART=Y
"RTN","ECXAPHA",55,0)
 .K %DT S %DT="AEX",%DT("A")="Ending with Date: ",%DT(0)=-DATE D ^%DT
"RTN","ECXAPHA",56,0)
 .I Y<0 S QFLG=1 Q
"RTN","ECXAPHA",57,0)
 .I Y<ECSD D  Q
"RTN","ECXAPHA",58,0)
 ..W !!,"The ending date cannot be earlier than the starting date."
"RTN","ECXAPHA",59,0)
 ..W !,"Please try again.",!!
"RTN","ECXAPHA",60,0)
 .I $E(Y,1,5)'=$E(ECSD,1,5) D  Q
"RTN","ECXAPHA",61,0)
 ..W !!,"Beginning and ending dates must be in the same month and year."
"RTN","ECXAPHA",62,0)
 ..W !,"Please try again.",!!
"RTN","ECXAPHA",63,0)
 .S ECED=Y
"RTN","ECXAPHA",64,0)
 .D DD^%DT S ECEND=Y
"RTN","ECXAPHA",65,0)
 .S DONE=1
"RTN","ECXAPHA",66,0)
 Q
"RTN","ECXAPHA",67,0)
 ;
"RTN","ECXAPHA",68,0)
PROCESS ; entry point for queued report
"RTN","ECXAPHA",69,0)
 S ZTREQ="@"
"RTN","ECXAPHA",70,0)
 S ECXERR=0 D EN^ECXAPHA2 Q:ECXERR
"RTN","ECXAPHA",71,0)
 S QFLG=0 D PRINT
"RTN","ECXAPHA",72,0)
 Q
"RTN","ECXAPHA",73,0)
 ;
"RTN","ECXAPHA",74,0)
PRINT ; process temp file and print report
"RTN","ECXAPHA",75,0)
 N PG,QFLG,GTOT,LN,COUNT,FKEY,QTY,SSN,REC
"RTN","ECXAPHA",76,0)
 U IO
"RTN","ECXAPHA",77,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXAPHA",78,0)
 S (PG,QFLG,GTOT)=0,$P(LN,"-",132)=""
"RTN","ECXAPHA",79,0)
 D HEADER Q:QFLG
"RTN","ECXAPHA",80,0)
 S COUNT=0,FKEY="" F  S FKEY=$O(^TMP($J,FKEY)) Q:FKEY=""!QFLG  D
"RTN","ECXAPHA",81,0)
 .S QTY="" F  S QTY=$O(^TMP($J,FKEY,QTY)) Q:QTY=""!QFLG  D
"RTN","ECXAPHA",82,0)
 ..S SSN="" F  S SSN=$O(^TMP($J,FKEY,QTY,SSN)) Q:SSN=""!QFLG  S REC=^(SSN)  D
"RTN","ECXAPHA",83,0)
 ...S COUNT=COUNT+1
"RTN","ECXAPHA",84,0)
 ...I $Y+3>IOSL D HEADER Q:QFLG
"RTN","ECXAPHA",85,0)
 ...W !,$P(REC,U),?8,$P(REC,U,2),?21,$P(REC,U,3),?29,$P(REC,U,4),?76,$P(REC,U,5),?95,$$RJ^XLFSTR($P(REC,U,6),11),?107,$P(REC,U,7),?117,$$RJ^XLFSTR($P(REC,U,8),14)
"RTN","ECXAPHA",86,0)
 Q:QFLG
"RTN","ECXAPHA",87,0)
 I COUNT=0 W !!,?8,"No unusual volumes to report for this extract"
"RTN","ECXAPHA",88,0)
CLOSE ;
"RTN","ECXAPHA",89,0)
 I $E(IOST)="C",'QFLG D
"RTN","ECXAPHA",90,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAPHA",91,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXAPHA",92,0)
 Q
"RTN","ECXAPHA",93,0)
 ;
"RTN","ECXAPHA",94,0)
HEADER ;header and page control
"RTN","ECXAPHA",95,0)
 N SS,JJ
"RTN","ECXAPHA",96,0)
 I $E(IOST)="C" D
"RTN","ECXAPHA",97,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAPHA",98,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXAPHA",99,0)
 Q:QFLG
"RTN","ECXAPHA",100,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXAPHA",101,0)
 W !,ECXTL_" Extract Unusual Volume Report",?124,"Page: "_PG
"RTN","ECXAPHA",102,0)
 W !,"Start Date: ",ECSTART,?97,"Report Run Date/Time:  "_ECRUN
"RTN","ECXAPHA",103,0)
 W !,"End Date:   ",ECEND,?97,"Threshold Value = ",ECTHLD
"RTN","ECXAPHA",104,0)
 W !!,"Name",?8,"SSN",?21,"Day",?29,"Generic Name",?76,"Feeder Key"
"RTN","ECXAPHA",105,0)
 I ECXOPT=2 W ?96,"Total Doses",?120,"Total Cost",!,?96,"Per Day"
"RTN","ECXAPHA",106,0)
 I ECXOPT'=2 W ?99,"Quantity",?120,"Total Cost"
"RTN","ECXAPHA",107,0)
 W !,LN,!
"RTN","ECXAPHA",108,0)
 Q
"RTN","ECXAPHA",109,0)
 ;
"RTN","ECXAPHA2")
0^2^B20019330
"RTN","ECXAPHA2",1,0)
ECXAPHA2 ;ALB/TMD-Pharmacy Extracts Unusual Volumes Report ; 3/8/02 11:12am
"RTN","ECXAPHA2",2,0)
 ;;3.0;DSS EXTRACTS;**40**;Dec 22, 1997
"RTN","ECXAPHA2",3,0)
 ;
"RTN","ECXAPHA2",4,0)
EN ; entry point
"RTN","ECXAPHA2",5,0)
 N COUNT,ECUNIT,LINE,ECDFN,ECD,ECDRG,ECDAY,ECDFN,ECQTY,ECUNIT,ECCOST
"RTN","ECXAPHA2",6,0)
 K ^TMP($J)
"RTN","ECXAPHA2",7,0)
 S COUNT=0,ECUNIT=""
"RTN","ECXAPHA2",8,0)
 S ECD=ECSD1,ECED=ECED+.3
"RTN","ECXAPHA2",9,0)
 S LINE=$S(ECXOPT=1:"PRE",ECXOPT=2:"IVP",ECXOPT=3:"UDP",1:"EXIT")
"RTN","ECXAPHA2",10,0)
 D @LINE
"RTN","ECXAPHA2",11,0)
 Q
"RTN","ECXAPHA2",12,0)
 ;
"RTN","ECXAPHA2",13,0)
PRE ; entry point for PRE data
"RTN","ECXAPHA2",14,0)
 ; order through fills, refills and partial refills
"RTN","ECXAPHA2",15,0)
 N ECRFL,ECRX,ECREF,ECDATA,ECDATA1,ECPRC
"RTN","ECXAPHA2",16,0)
 S ECREF=1
"RTN","ECXAPHA2",17,0)
 F  S ECD=$O(^PSRX("AL",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:ECXERR  F  S ECRX=$O(^PSRX("AL",ECD,ECRX)),ECRFL="" Q:'ECRX  Q:ECXERR  F  S ECRFL=$O(^PSRX("AL",ECD,ECRX,ECRFL)) Q:ECRFL=""  Q:ECXERR  D PRE2
"RTN","ECXAPHA2",18,0)
 S ECD=ECSD1,ECREF="P"
"RTN","ECXAPHA2",19,0)
 F  S ECD=$O(^PSRX("AM",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:ECXERR  F  S ECRX=$O(^PSRX("AM",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AM",ECD,ECRX,ECRFL)) Q:ECRFL=""  Q:ECXERR  D PRE2
"RTN","ECXAPHA2",20,0)
 Q
"RTN","ECXAPHA2",21,0)
 ;
"RTN","ECXAPHA2",22,0)
PRE2 ; get Prescription data
"RTN","ECXAPHA2",23,0)
 S ECDATA=$G(^PSRX(ECRX,0))
"RTN","ECXAPHA2",24,0)
 I ECRFL D
"RTN","ECXAPHA2",25,0)
 .S ECDATA1=$G(^PSRX(ECRX,ECREF,ECRFL,0))
"RTN","ECXAPHA2",26,0)
 .S ECQTY=+$P(ECDATA1,U,4),ECPRC=+$P(ECDATA1,U,11)
"RTN","ECXAPHA2",27,0)
 I 'ECRFL S ECQTY=+$P(ECDATA,U,7),ECPRC=+$P(ECDATA,U,17)
"RTN","ECXAPHA2",28,0)
 ;check to see if quantity>threshold
"RTN","ECXAPHA2",29,0)
 I ECQTY>ECTHLD D
"RTN","ECXAPHA2",30,0)
 .S ECDAY=ECD
"RTN","ECXAPHA2",31,0)
 .S ECDFN=$P(ECDATA,U,2),ECDRG=+$P(ECDATA,U,6)
"RTN","ECXAPHA2",32,0)
 .S ECCOST=ECQTY*ECPRC
"RTN","ECXAPHA2",33,0)
 .D FILE Q:ECXERR
"RTN","ECXAPHA2",34,0)
 Q
"RTN","ECXAPHA2",35,0)
 ;
"RTN","ECXAPHA2",36,0)
IVP ; entry point for IVP Data
"RTN","ECXAPHA2",37,0)
 N DFN,ON,DA,SA,ECCOUNT
"RTN","ECXAPHA2",38,0)
 F  S ECD=$O(^ECX(728.113,"A",ECD)),DFN=0 Q:'ECD  Q:ECD>ECED  Q:ECXERR  F  S DFN=$O(^ECX(728.113,"A",ECD,DFN)),ON=0  Q:'DFN  F  S ON=$O(^ECX(728.113,"A",ECD,DFN,ON)),DA=0 Q:'ON  K ^TMP($J,"A"),^("S") D  Q:ECXERR
"RTN","ECXAPHA2",39,0)
 .F  S DA=$O(^ECX(728.113,"A",ECD,DFN,ON,DA)) Q:'DA  Q:ECXERR  I $D(^ECX(728.113,DA,0)) S EC=^(0) Q:ECXERR  D
"RTN","ECXAPHA2",40,0)
 ..S ECDRG=$P(EC,U,4)
"RTN","ECXAPHA2",41,0)
 ..S SA=$S($P(EC,U,8)]"":"A",$P(EC,U,9):"S",1:"")
"RTN","ECXAPHA2",42,0)
 ..; set up new record for first DA for this drug
"RTN","ECXAPHA2",43,0)
 ..I '$D(^TMP($J,SA,ECDRG)) D
"RTN","ECXAPHA2",44,0)
 ...S ECQTY=+$S(SA="A":+$P(EC,U,7),SA="S":+$P(EC,U,9),1:0)
"RTN","ECXAPHA2",45,0)
 ...S ECUNIT=$S(SA="A":$P(EC,U,8),SA="S":"ML",1:"")
"RTN","ECXAPHA2",46,0)
 ...S ECCOST=$P(EC,U,12),ECDFN=DFN
"RTN","ECXAPHA2",47,0)
 ...S ^TMP($J,SA,ECDRG)=ECUNIT_U_ECD_U_ECDFN_U_ECCOST_U_ECQTY,^(ECDRG,1)=0
"RTN","ECXAPHA2",48,0)
 ..; add to qty (0,1, or -1) to total
"RTN","ECXAPHA2",49,0)
 ..S ^TMP($J,SA,ECDRG,1)=^TMP($J,SA,ECDRG,1)+$S($P(EC,U,6)=1:1,$P(EC,U,6)=4:0,1:-1)
"RTN","ECXAPHA2",50,0)
 .; looped thru all DAs for this order - now check for unusual volumes
"RTN","ECXAPHA2",51,0)
 .F SA="S","A" S ECDRG="" F  S ECDRG=$O(^TMP($J,SA,ECDRG)) Q:ECDRG=""  Q:ECXERR  D
"RTN","ECXAPHA2",52,0)
 ..S ECQTY=$P(^TMP($J,SA,ECDRG),U,5),ECCOUNT=^(ECDRG,1)
"RTN","ECXAPHA2",53,0)
 ..S ECQTY=ECQTY*ECCOUNT
"RTN","ECXAPHA2",54,0)
 ..; check to see if quantity is outside of threshold range
"RTN","ECXAPHA2",55,0)
 ..I (ECQTY>ECTHLD)!(ECQTY<-ECTHLD) D
"RTN","ECXAPHA2",56,0)
 ...S ECUNIT=$P(^TMP($J,SA,ECDRG),U),ECDAY=$P(^(ECDRG),U,2),ECDFN=$P(^(ECDRG),U,3),ECCOST=$P(^(ECDRG),U,4)*ECCOUNT
"RTN","ECXAPHA2",57,0)
 ...D FILE Q:ECXERR
"RTN","ECXAPHA2",58,0)
 K ^TMP($J,"A"),^("S")
"RTN","ECXAPHA2",59,0)
 Q
"RTN","ECXAPHA2",60,0)
 ;
"RTN","ECXAPHA2",61,0)
UDP ; entry point for UDP data
"RTN","ECXAPHA2",62,0)
 N ECXJ,ECDATA
"RTN","ECXAPHA2",63,0)
 F  S ECD=$O(^ECX(728.904,"A",ECD)) Q:'ECD  Q:ECD>ECED  Q:ECXERR  D
"RTN","ECXAPHA2",64,0)
 .S ECXJ=0 F  S ECXJ=$O(^ECX(728.904,"A",ECD,ECXJ)) Q:'ECXJ  Q:ECXERR  I $D(^ECX(728.904,ECXJ,0)) D
"RTN","ECXAPHA2",65,0)
 ..S DATA=^ECX(728.904,ECXJ,0),ECQTY=$P(DATA,U,5)
"RTN","ECXAPHA2",66,0)
 ..;check to see if quantity>threshold
"RTN","ECXAPHA2",67,0)
 ..I ECQTY>ECTHLD D
"RTN","ECXAPHA2",68,0)
 ...S ECDFN=$P(DATA,U,2),ECDRG=$P(DATA,U,4),ECCOST=$P(DATA,U,8),ECDAY=ECD
"RTN","ECXAPHA2",69,0)
 ...D FILE Q:ECXERR
"RTN","ECXAPHA2",70,0)
 Q
"RTN","ECXAPHA2",71,0)
 ;
"RTN","ECXAPHA2",72,0)
FILE ; put records in temp file to print later
"RTN","ECXAPHA2",73,0)
 N OK,ECXPAT,ECNAME,ECSSN,ECGNAME,ECNDC,ECPROD,ECFKEY
"RTN","ECXAPHA2",74,0)
 ; get demographics
"RTN","ECXAPHA2",75,0)
 S OK=$$PAT^ECXUTL3(ECDFN,$P(ECD,"."),"1;",.ECXPAT)
"RTN","ECXAPHA2",76,0)
 I 'OK Q
"RTN","ECXAPHA2",77,0)
 S ECNAME=ECXPAT("NAME"),ECSSN=ECXPAT("SSN")
"RTN","ECXAPHA2",78,0)
 ; get drug file data
"RTN","ECXAPHA2",79,0)
 S ECGNAME=$P($G(^PSDRUG(ECDRG,0)),U)
"RTN","ECXAPHA2",80,0)
 S ECNDC=$P($G(^PSDRUG(ECDRG,2)),U,4)
"RTN","ECXAPHA2",81,0)
 S ECNDC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNDC=$TR(ECNDC,"*",0)
"RTN","ECXAPHA2",82,0)
 S ECPROD=$P($G(^PSDRUG(ECDRG,"ND")),U,3),ECPROD=$$RJ^XLFSTR(ECPROD,5,0)
"RTN","ECXAPHA2",83,0)
 S ECFKEY=ECPROD_ECNDC
"RTN","ECXAPHA2",84,0)
 I ECXOPT'=2 S ECUNIT=$P($G(^PSDRUG(ECDRG,660)),U,8)
"RTN","ECXAPHA2",85,0)
 ; get month and day
"RTN","ECXAPHA2",86,0)
 S ECDAY=$E(ECDAY,4,5)_"/"_$E(ECDAY,6,7)
"RTN","ECXAPHA2",87,0)
 ; file 
"RTN","ECXAPHA2",88,0)
 S ^TMP($J,+ECFKEY,-ECQTY,+ECSSN)=ECNAME_U_ECSSN_U_ECDAY_U_ECGNAME_U_ECFKEY_U_ECQTY_U_ECUNIT_U_"$"_$FNUMBER(ECCOST,",",2)
"RTN","ECXAPHA2",89,0)
 S COUNT=COUNT+1
"RTN","ECXAPHA2",90,0)
 I COUNT#100=0 I $$S^ZTLOAD S (ZSTOP,ECXERR)=1
"RTN","ECXAPHA2",91,0)
 Q
"RTN","ECXAPHA2",92,0)
 ;
"RTN","ECXAPHA2",93,0)
EXIT S ECXERR=1 Q
"RTN","ECXDRUG1")
0^3^B30533740
"RTN","ECXDRUG1",1,0)
ECXDRUG1 ;ALB/TMD-Pharmacy Extracts Incomplete Feeder Key Report ; 4/4/02 1:10pm
"RTN","ECXDRUG1",2,0)
 ;;3.0;DSS EXTRACTS;**40**;Dec 22, 1997
"RTN","ECXDRUG1",3,0)
 ;
"RTN","ECXDRUG1",4,0)
EN ; entry point
"RTN","ECXDRUG1",5,0)
 N X,Y,DATE,ECRUN,ECXTL,ECSTART,ECEND,ECXDESC,ECXSAVE,ECXOPT,ECSD1,ECED,ECXERR,QFLG
"RTN","ECXDRUG1",6,0)
 S QFLG=0
"RTN","ECXDRUG1",7,0)
 ; get today's date
"RTN","ECXDRUG1",8,0)
 D NOW^%DTC S DATE=X,Y=$E(%,1,12) D DD^%DT S ECRUN=$P(Y,"@") K %DT
"RTN","ECXDRUG1",9,0)
 D BEGIN Q:QFLG
"RTN","ECXDRUG1",10,0)
 D SELECT Q:QFLG
"RTN","ECXDRUG1",11,0)
 S ECXDESC=ECXTL_" Extract Incomplete Feeder Key Report"
"RTN","ECXDRUG1",12,0)
 S ECXSAVE("EC*")=""
"RTN","ECXDRUG1",13,0)
 W !!,"This report requires 132 column format."
"RTN","ECXDRUG1",14,0)
 D EN^XUTMDEVQ("PROCESS^ECXDRUG1",ECXDESC,.ECXSAVE)
"RTN","ECXDRUG1",15,0)
 I POP W !!,"No device selected...exiting.",! Q
"RTN","ECXDRUG1",16,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXDRUG1",17,0)
 D HOME^%ZIS
"RTN","ECXDRUG1",18,0)
 D AUDIT^ECXKILL
"RTN","ECXDRUG1",19,0)
 Q
"RTN","ECXDRUG1",20,0)
 ;
"RTN","ECXDRUG1",21,0)
BEGIN ; display report description
"RTN","ECXDRUG1",22,0)
 W @IOF,!,"This report prints a listing of Drug File (#50) entries that will generate",!,"incomplete Feeder keys in the three Pharmacy Extracts.  This listing",!,"can be used to identify and fix Drug File entries.  "
"RTN","ECXDRUG1",23,0)
 W "The number of extract",!,"records, total, quantity, unit price and total cost for each drug are",!,"included to aid in determining the impact of the incomplete Feeder Keys."
"RTN","ECXDRUG1",24,0)
 W !!,"This report is broken into 3 sections as follows:"
"RTN","ECXDRUG1",25,0)
 W !!,"Section 1:  No PSNDF VA Product Name Entry (first 5 digits are zero)."
"RTN","ECXDRUG1",26,0)
 W !,"Section 2:  No National Drug Code (NDC) (last 12 digits are zero)."
"RTN","ECXDRUG1",27,0)
 W !,"Section 3:  No PSNDF VA Product Name Entry or NDC (all 17 digits are zero)."
"RTN","ECXDRUG1",28,0)
 W !!,"Run times for this report will vary depending upon the size of the extract and",!,"could take as long as 30 minutes or more to complete.  This report has no effect",!,"on the actual extracts and can be run as needed."
"RTN","ECXDRUG1",29,0)
 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXDRUG1",30,0)
 W:$Y!($E(IOST)="C") @IOF,!!
"RTN","ECXDRUG1",31,0)
 Q
"RTN","ECXDRUG1",32,0)
 ;
"RTN","ECXDRUG1",33,0)
SELECT ; user inputs for report option and date range
"RTN","ECXDRUG1",34,0)
 N DONE,OUT
"RTN","ECXDRUG1",35,0)
 ; allow user to select report option (PRE,IVP or UDP)
"RTN","ECXDRUG1",36,0)
 W "Choose the report you would like to run."
"RTN","ECXDRUG1",37,0)
 S DIR(0)="S^1:PRE;2:IVP;3:UDP",DIR("A")="Selection",DIR("B")=1 D ^DIR K DIR S ECXOPT=Y I X["^" S QFLG=1 Q
"RTN","ECXDRUG1",38,0)
 S ECXTL=$S(ECXOPT=1:"Prescription",ECXOPT=2:"IV Detail",ECXOPT=3:"Unit Dose Local",1:"")
"RTN","ECXDRUG1",39,0)
 ; allow user to select date range for report records
"RTN","ECXDRUG1",40,0)
 W !!,"Enter the date range for which you would like to scan the ",ECXTL,!,"Extract records."
"RTN","ECXDRUG1",41,0)
 S DONE=0 F  S (ECED,ECSD)="" D  Q:QFLG!DONE
"RTN","ECXDRUG1",42,0)
 .K %DT S %DT="AEX",%DT("A")="Starting with Date: ",%DT(0)=-DATE D ^%DT
"RTN","ECXDRUG1",43,0)
 .I Y<0 S QFLG=1 Q
"RTN","ECXDRUG1",44,0)
 .S ECSD=Y,ECSD1=ECSD-.1
"RTN","ECXDRUG1",45,0)
 .D DD^%DT S ECSTART=Y
"RTN","ECXDRUG1",46,0)
 .K %DT S %DT="AEX",%DT("A")="Ending with Date: ",%DT(0)=-DATE D ^%DT
"RTN","ECXDRUG1",47,0)
 .I Y<0 S QFLG=1 Q
"RTN","ECXDRUG1",48,0)
 .I Y<ECSD D  Q
"RTN","ECXDRUG1",49,0)
 ..W !!,"The ending date cannot be earlier than the starting date."
"RTN","ECXDRUG1",50,0)
 ..W !,"Please try again.",!!
"RTN","ECXDRUG1",51,0)
 .I $E(Y,1,5)'=$E(ECSD,1,5) D  Q
"RTN","ECXDRUG1",52,0)
 ..W !!,"Beginning and ending dates must be in the same month and year."
"RTN","ECXDRUG1",53,0)
 ..W !,"Please try again.",!!
"RTN","ECXDRUG1",54,0)
 .S ECED=Y
"RTN","ECXDRUG1",55,0)
 .D DD^%DT S ECEND=Y
"RTN","ECXDRUG1",56,0)
 .S DONE=1
"RTN","ECXDRUG1",57,0)
 Q
"RTN","ECXDRUG1",58,0)
 ;
"RTN","ECXDRUG1",59,0)
PROCESS ; entry point for queued report
"RTN","ECXDRUG1",60,0)
 S ZTREQ="@"
"RTN","ECXDRUG1",61,0)
 S ECXERR=0 D EN^ECXDRUG2 Q:ECXERR
"RTN","ECXDRUG1",62,0)
 S QFLG=0 D PRINT
"RTN","ECXDRUG1",63,0)
 Q
"RTN","ECXDRUG1",64,0)
 ;
"RTN","ECXDRUG1",65,0)
PRINT ; process temp file and print report
"RTN","ECXDRUG1",66,0)
 N PG,GTOT,LN,S,COUNT,SUBTOT,DR,ECTYPE,REC,STATS,ECCOUNT,ECQTY,ECPRC,ECCOST
"RTN","ECXDRUG1",67,0)
 U IO
"RTN","ECXDRUG1",68,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXDRUG1",69,0)
 S (PG,QFLG,GTOT)=0,$P(LN,"-",132)=""
"RTN","ECXDRUG1",70,0)
 F S=1:1:3  Q:QFLG  D HEADER Q:QFLG  D
"RTN","ECXDRUG1",71,0)
 .S (COUNT,SUBTOT)=0,DR="" F  S DR=$O(^TMP($J,DR)) Q:DR=""!QFLG  S ECTYPE=$P(^(DR),U,4) I ECTYPE=S D
"RTN","ECXDRUG1",72,0)
 ..S REC=^TMP($J,DR),STATS=^(DR,0)
"RTN","ECXDRUG1",73,0)
 ..S COUNT=COUNT+1
"RTN","ECXDRUG1",74,0)
 ..S ECCOUNT=$FNUMBER($P(STATS,U),",")
"RTN","ECXDRUG1",75,0)
 ..S ECQTY=$FNUMBER($P(STATS,U,2),",")
"RTN","ECXDRUG1",76,0)
 ..S ECPRC="$"_$FNUMBER($P(REC,U,3),",",4)
"RTN","ECXDRUG1",77,0)
 ..S ECCOST="$"_$FNUMBER($P(STATS,U,3),",",2)
"RTN","ECXDRUG1",78,0)
 ..S SUBTOT=SUBTOT+$P(STATS,U,3)
"RTN","ECXDRUG1",79,0)
 ..W !,$$RJ^XLFSTR(DR,5),?8,$P(REC,U),?60,$P(REC,U,2),?79,$$RJ^XLFSTR(ECCOUNT,5),?87,$$RJ^XLFSTR(ECQTY,10),?99,$$RJ^XLFSTR(ECPRC,16),?117,$$RJ^XLFSTR(ECCOST,13)
"RTN","ECXDRUG1",80,0)
 ..I $Y+2>IOSL D HEADER
"RTN","ECXDRUG1",81,0)
 .Q:QFLG
"RTN","ECXDRUG1",82,0)
 .I COUNT=0 W !!,?8,"No drugs to report for this section"
"RTN","ECXDRUG1",83,0)
 .; print sub total
"RTN","ECXDRUG1",84,0)
 .I COUNT D
"RTN","ECXDRUG1",85,0)
 ..I $Y+3>IOSL D HEADER Q:QFLG
"RTN","ECXDRUG1",86,0)
 ..S GTOT=GTOT+SUBTOT
"RTN","ECXDRUG1",87,0)
 ..S SUBTOT="$"_$FNUMBER(SUBTOT,",",2)
"RTN","ECXDRUG1",88,0)
 ..W !!,?110,"TOTAL",?116,$$RJ^XLFSTR(SUBTOT,14)
"RTN","ECXDRUG1",89,0)
 ; print grand total
"RTN","ECXDRUG1",90,0)
 I GTOT,'QFLG D
"RTN","ECXDRUG1",91,0)
 .I $Y+3>IOSL D HEADER Q:QFLG
"RTN","ECXDRUG1",92,0)
 .S GTOT="$"_$FNUMBER(GTOT,",",2)
"RTN","ECXDRUG1",93,0)
 .W !!,?104,"GRAND TOTAL",?116,$$RJ^XLFSTR(GTOT,14)
"RTN","ECXDRUG1",94,0)
 ;
"RTN","ECXDRUG1",95,0)
CLOSE ;
"RTN","ECXDRUG1",96,0)
 I $E(IOST)="C",'QFLG D
"RTN","ECXDRUG1",97,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXDRUG1",98,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXDRUG1",99,0)
 Q
"RTN","ECXDRUG1",100,0)
 ;
"RTN","ECXDRUG1",101,0)
HEADER ; header and page control
"RTN","ECXDRUG1",102,0)
 N SS,JJ
"RTN","ECXDRUG1",103,0)
 I $E(IOST)="C" D
"RTN","ECXDRUG1",104,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXDRUG1",105,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXDRUG1",106,0)
 Q:QFLG
"RTN","ECXDRUG1",107,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXDRUG1",108,0)
 W !,ECXTL_" Extract Incomplete Feeder Key Report",?124,"Page: "_PG
"RTN","ECXDRUG1",109,0)
 W !,"Start Date: ",ECSTART
"RTN","ECXDRUG1",110,0)
 W !,"End Date:   ",ECEND,?97,"Report Run Date/Time:  "_ECRUN
"RTN","ECXDRUG1",111,0)
 W !!,"Drug",?8,"Generic Name",?60,"Feeder Key",?79,"# of",?89,"Total",?107,"Unit",?122,"Total"
"RTN","ECXDRUG1",112,0)
 W !,"Entry",?79,"Records",?89,"Quantity",?107,"Price",?122,"Cost"
"RTN","ECXDRUG1",113,0)
 W !,LN
"RTN","ECXDRUG1",114,0)
 I S=1 W !!,"No PSNDF VA Product Name Entry (Five leading zeros)",!
"RTN","ECXDRUG1",115,0)
 I S=2 W !!,"No National Drug Code (NDC) (Last 12 zeros or 'N/A')",!
"RTN","ECXDRUG1",116,0)
 I S=3 W !!,"No PSNDF VA Product Name Entry or National Drug Code (NDC) (All 17 zeros)",!
"RTN","ECXDRUG1",117,0)
 Q
"RTN","ECXDRUG1",118,0)
 ;
"RTN","ECXDRUG2")
0^4^B14790508
"RTN","ECXDRUG2",1,0)
ECXDRUG2 ;ALB/TMD-Pharmacy Extracts Incomplete Feeder Key Report ; 3/8/02 11:14am
"RTN","ECXDRUG2",2,0)
 ;;3.0;DSS EXTRACTS;**40**;Dec 22, 1997
"RTN","ECXDRUG2",3,0)
 ;
"RTN","ECXDRUG2",4,0)
EN ; entry point
"RTN","ECXDRUG2",5,0)
 N ECD,LINE,ECDRG,ECQTY,ECPRC
"RTN","ECXDRUG2",6,0)
 K ^TMP($J)
"RTN","ECXDRUG2",7,0)
 S ECD=ECSD1,ECED=ECED+.3
"RTN","ECXDRUG2",8,0)
 S LINE=$S(ECXOPT=1:"PRE",ECXOPT=2:"IVP",ECXOPT=3:"UDP",1:"EXIT")
"RTN","ECXDRUG2",9,0)
 D @LINE
"RTN","ECXDRUG2",10,0)
 Q
"RTN","ECXDRUG2",11,0)
 ;
"RTN","ECXDRUG2",12,0)
PRE ; entry point for PRE data
"RTN","ECXDRUG2",13,0)
 ; order through fills, refills and partial refills
"RTN","ECXDRUG2",14,0)
 N ECRFL,ECRX,ECREF,ECDATA,ECDATA1
"RTN","ECXDRUG2",15,0)
 S ECREF=1
"RTN","ECXDRUG2",16,0)
 F  S ECD=$O(^PSRX("AL",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED   Q:ECXERR  F  S ECRX=$O(^PSRX("AL",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AL",ECD,ECRX,ECRFL)) Q:ECRFL=""  Q:ECXERR  D PRE2
"RTN","ECXDRUG2",17,0)
 S ECD=ECSD1,ECREF="P"
"RTN","ECXDRUG2",18,0)
 F  S ECD=$O(^PSRX("AM",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:ECXERR  F  S ECRX=$O(^PSRX("AM",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AM",ECD,ECRX,ECRFL)) Q:ECRFL=""  D PRE2
"RTN","ECXDRUG2",19,0)
 Q
"RTN","ECXDRUG2",20,0)
 ;
"RTN","ECXDRUG2",21,0)
PRE2 ; get Prescription data
"RTN","ECXDRUG2",22,0)
 S ECDATA=$G(^PSRX(ECRX,0))
"RTN","ECXDRUG2",23,0)
 S ECDRG=+$P(ECDATA,U,6)
"RTN","ECXDRUG2",24,0)
 I ECRFL D
"RTN","ECXDRUG2",25,0)
 .S ECDATA1=$G(^PSRX(ECRX,ECREF,ECRFL,0))
"RTN","ECXDRUG2",26,0)
 .S ECQTY=+$P(ECDATA1,U,4),ECPRC=+$P(ECDATA1,U,11)
"RTN","ECXDRUG2",27,0)
 I 'ECRFL S ECQTY=+$P(ECDATA,U,7),ECPRC=+$P(ECDATA,U,17)
"RTN","ECXDRUG2",28,0)
 D TEST
"RTN","ECXDRUG2",29,0)
 Q
"RTN","ECXDRUG2",30,0)
 ;
"RTN","ECXDRUG2",31,0)
IVP ; entry point for IVP data
"RTN","ECXDRUG2",32,0)
 N ON,DFN,DA,SA
"RTN","ECXDRUG2",33,0)
 F  S ECD=$O(^ECX(728.113,"A",ECD)),DFN=0 Q:'ECD  Q:ECXERR  Q:ECD>ECED  F  S DFN=$O(^ECX(728.113,"A",ECD,DFN)),ON=0  Q:'DFN  Q:ECXERR  F  S ON=$O(^ECX(728.113,"A",ECD,DFN,ON)),DA=0 Q:'ON  K ^TMP($J,"A"),^("S") D
"RTN","ECXDRUG2",34,0)
 .F  S DA=$O(^ECX(728.113,"A",ECD,DFN,ON,DA)) Q:'DA  I $D(^ECX(728.113,DA,0)) S EC=^(0) D
"RTN","ECXDRUG2",35,0)
 ..S ECDRG=$P(EC,U,4)
"RTN","ECXDRUG2",36,0)
 ..S SA=$S($P(EC,U,8)]"":"A",$P(EC,U,9):"S",1:"")
"RTN","ECXDRUG2",37,0)
 ..I SA'="" D
"RTN","ECXDRUG2",38,0)
 ...I '$D(^TMP($J,SA,ECDRG)) S ^(ECDRG)=0,$P(^(ECDRG),U,2)=$P(EC,U,12)
"RTN","ECXDRUG2",39,0)
 ...S $P(^TMP($J,SA,ECDRG),U)=$P(^TMP($J,SA,ECDRG),U)+$S($P(EC,U,6)=1:1,$P(EC,U,6)=4:0,1:-1)
"RTN","ECXDRUG2",40,0)
 .;looped thru all DAs for this order - now put it together
"RTN","ECXDRUG2",41,0)
 .F SA="S","A" S ECDRG="" F  S ECDRG=$O(^TMP($J,SA,ECDRG)) Q:ECDRG=""  D
"RTN","ECXDRUG2",42,0)
 ..S ECQTY=$P(^TMP($J,SA,ECDRG),U),ECPRC=$P(^(ECDRG),U,2)
"RTN","ECXDRUG2",43,0)
 ..D TEST
"RTN","ECXDRUG2",44,0)
 K ^TMP($J,"A"),^TMP($J,"S")
"RTN","ECXDRUG2",45,0)
 Q
"RTN","ECXDRUG2",46,0)
 ;
"RTN","ECXDRUG2",47,0)
UDP ; entry point for UDP data
"RTN","ECXDRUG2",48,0)
 N ECXJ,ECDATA
"RTN","ECXDRUG2",49,0)
 F  S ECD=$O(^ECX(728.904,"A",ECD)) Q:'ECD  Q:ECD>ECED  Q:ECXERR  D
"RTN","ECXDRUG2",50,0)
 .S ECXJ=0 F  S ECXJ=$O(^ECX(728.904,"A",ECD,ECXJ)) Q:'ECXJ  Q:ECXERR  I $D(^ECX(728.904,ECXJ,0)) D
"RTN","ECXDRUG2",51,0)
 ..S DATA=^ECX(728.904,ECXJ,0)
"RTN","ECXDRUG2",52,0)
 ..S ECDRG=$P(DATA,U,4),ECQTY=$P(DATA,U,5),ECCOST=$P(DATA,U,8)
"RTN","ECXDRUG2",53,0)
 ..S ECPRC=ECCOST/ECQTY
"RTN","ECXDRUG2",54,0)
 ..D TEST
"RTN","ECXDRUG2",55,0)
 Q
"RTN","ECXDRUG2",56,0)
 ;
"RTN","ECXDRUG2",57,0)
TEST ; retrieve NDC and PSNDF VA Product Code Entry and test for missing NDC or VA Prod Code
"RTN","ECXDRUG2",58,0)
 N ECTYPE,ECNDC,ZERO,K,ECPROD
"RTN","ECXDRUG2",59,0)
 S ECTYPE=0
"RTN","ECXDRUG2",60,0)
 S ECNDC=$P($G(^PSDRUG(ECDRG,2)),U,4)
"RTN","ECXDRUG2",61,0)
 S ECNDC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNDC=$TR(ECNDC,"*",0)
"RTN","ECXDRUG2",62,0)
 S ZERO=1 F K=1:1:$L(ECNDC) I $E(ECNDC,K)'=0 S ZERO=0 Q
"RTN","ECXDRUG2",63,0)
 I ZERO!(ECNDC["N/A") S ECTYPE=2
"RTN","ECXDRUG2",64,0)
 S ECPROD=$P($G(^PSDRUG(ECDRG,"ND")),U,3),ECPROD=$$RJ^XLFSTR(ECPROD,5,0)
"RTN","ECXDRUG2",65,0)
 I ECTYPE,'ECPROD S ECTYPE=3
"RTN","ECXDRUG2",66,0)
 I 'ECTYPE,'ECPROD S ECTYPE=1
"RTN","ECXDRUG2",67,0)
 I ECTYPE D FILE
"RTN","ECXDRUG2",68,0)
 Q
"RTN","ECXDRUG2",69,0)
 ;
"RTN","ECXDRUG2",70,0)
FILE ; file record
"RTN","ECXDRUG2",71,0)
 N ECFKEY,ECGNAME,STATS,ECCOUNT,QTY,COST,ECCOST
"RTN","ECXDRUG2",72,0)
 ; create new record if none exists for this drug
"RTN","ECXDRUG2",73,0)
 I '$D(^TMP($J,ECDRG)) D
"RTN","ECXDRUG2",74,0)
 .S ECFKEY=ECPROD_ECNDC
"RTN","ECXDRUG2",75,0)
 .S ECGNAME=$P($G(^PSDRUG(ECDRG,0)),U)
"RTN","ECXDRUG2",76,0)
 .S ^TMP($J,ECDRG)=ECGNAME_U_ECFKEY_U_ECPRC_U_ECTYPE
"RTN","ECXDRUG2",77,0)
 .S ^TMP($J,ECDRG,0)="0^0^0"
"RTN","ECXDRUG2",78,0)
 ; add stats to record
"RTN","ECXDRUG2",79,0)
 S STATS=^TMP($J,ECDRG,0)
"RTN","ECXDRUG2",80,0)
 S ECCOUNT=$P(STATS,U),QTY=$P(STATS,U,2),COST=$P(STATS,U,3)
"RTN","ECXDRUG2",81,0)
 S ECCOUNT=ECCOUNT+1
"RTN","ECXDRUG2",82,0)
 S ECCOST=ECQTY*ECPRC
"RTN","ECXDRUG2",83,0)
 S ECQTY=ECQTY+QTY,ECCOST=ECCOST+COST
"RTN","ECXDRUG2",84,0)
 S ^TMP($J,ECDRG,0)=ECCOUNT_U_ECQTY_U_ECCOST
"RTN","ECXDRUG2",85,0)
 Q
"RTN","ECXDRUG2",86,0)
 ;
"RTN","ECXDRUG2",87,0)
EXIT S ECXERR=1 Q
"RTN","ECXFEKE1")
0^6^B31398027
"RTN","ECXFEKE1",1,0)
ECXFEKE1 ;BIR/DMA,CML-Print Feeder Keys (CONTINUED); [ 03/28/96  5:44 PM ] ; 4/3/02 2:45pm
"RTN","ECXFEKE1",2,0)
 ;;3.0;DSS EXTRACTS;**11,8,40**;Dec 22, 1997
"RTN","ECXFEKE1",3,0)
 ;
"RTN","ECXFEKE1",4,0)
SELLABKE() ;** Function to prompt user selection of type of Lab Feeder Key
"RTN","ECXFEKE1",5,0)
 ;
"RTN","ECXFEKE1",6,0)
 ;** Variable Definitions
"RTN","ECXFEKE1",7,0)
 ;**  ECXKEY    - Value of user selection returned to calling code
"RTN","ECXFEKE1",8,0)
 ;**                Returns  N - LMIP Code formated feeder keys
"RTN","ECXFEKE1",9,0)
 ;**                         O - Locally formated feeder keys
"RTN","ECXFEKE1",10,0)
 ;**                        -1 - User uparrow (^) or Time out
"RTN","ECXFEKE1",11,0)
 ;
"RTN","ECXFEKE1",12,0)
 N ECXKEY
"RTN","ECXFEKE1",13,0)
 W !!,"The Feeder Key List for the Feeder System LAB can be printed by:"
"RTN","ECXFEKE1",14,0)
 W !,?5,"(O)ld Feeder Key sort by Local Feeder Key values"
"RTN","ECXFEKE1",15,0)
 W !,?5,"(N)ew Feeder Key sort by LMIP Codes"
"RTN","ECXFEKE1",16,0)
 S DIR(0)="S^O:OLD;N:NEW"
"RTN","ECXFEKE1",17,0)
 S:$D(^ECX(728,1,"LMIP")) DIR("B")="NEW"
"RTN","ECXFEKE1",18,0)
 S:'$D(^ECX(728,1,"LMIP")) DIR("B")="OLD"
"RTN","ECXFEKE1",19,0)
 D ^DIR
"RTN","ECXFEKE1",20,0)
 S:$D(DIRUT) ECXKEY=-1
"RTN","ECXFEKE1",21,0)
 S:'$D(DIRUT) ECXKEY=Y
"RTN","ECXFEKE1",22,0)
 K Y,DIR,DIRUT,DTOUT,DUOUT
"RTN","ECXFEKE1",23,0)
 Q ECXKEY
"RTN","ECXFEKE1",24,0)
 ;
"RTN","ECXFEKE1",25,0)
SUR F EC=1:1:16 S EC1=$P($T(@("S"_EC)),";",3),EC2=$P(EC1,U),ECD=$P(EC1,U,2),^TMP($J,"SUR",EC2_"-10",EC)=ECD_" PATIENT TIME",^TMP($J,"SUR",EC2_"-40",EC)=ECD_" SURGEON TIME" D
"RTN","ECXFEKE1",26,0)
 .S ^TMP($J,"SUR",EC2_"-60",EC)=ECD_" RECOVERY ROOM TIME",^TMP($J,"SUR",EC2_"-70",EC)=ECD_" TECHNICIAN TIME",^TMP($J,"SUR",EC2_"-30",EC)=ECD_" CLEANUP TIME"
"RTN","ECXFEKE1",27,0)
 .S ^TMP($J,"SUR",EC2_"-22",1)=ECD_" ANESTHESIA TIME (SPECIAL)"
"RTN","ECXFEKE1",28,0)
 .S ^TMP($J,"SUR",EC2_"-21",1)=ECD_" ANESTHESIA TIME (GENERAL)"
"RTN","ECXFEKE1",29,0)
 .S ^TMP($J,"SUR",EC2_"-23",1)=ECD_" ANESTHESIA TIME (LOCAL)"
"RTN","ECXFEKE1",30,0)
 .S ^TMP($J,"SUR",EC2_"-24",1)=ECD_" ANESTHESIA TIME (SPI/EPI)"
"RTN","ECXFEKE1",31,0)
 .S ^TMP($J,"SUR",EC2_"-25",1)=ECD_" ANESTHESIA TIME (OTHER)"
"RTN","ECXFEKE1",32,0)
 .S ^TMP($J,"SUR",EC2_"-26",1)=ECD_" ANESTHESIA TIME (UNKNOWN)"
"RTN","ECXFEKE1",33,0)
 .S ^TMP($J,"SUR",EC2_"-27",1)=ECD_" ANESTHESIA TIME (MONITORED)"
"RTN","ECXFEKE1",34,0)
 S EC=0 F  S EC=$O(^SRO(131.9,EC)) Q:'EC  I $D(^(EC,0)) S ECD=$P(^(0),U),^TMP($J,"SUR",$$RJ^XLFSTR(EC,5,0),EC)=ECD
"RTN","ECXFEKE1",35,0)
 Q
"RTN","ECXFEKE1",36,0)
S1 ;;050^GENERAL(OR WHEN NOT DEFINED BELOW)
"RTN","ECXFEKE1",37,0)
S2 ;;051^GYNECOLOGY
"RTN","ECXFEKE1",38,0)
S3 ;;052^NEUROSURGERY
"RTN","ECXFEKE1",39,0)
S4 ;;053^OPHTHALMOLOGY
"RTN","ECXFEKE1",40,0)
S5 ;;054^ORTHOPEDICS
"RTN","ECXFEKE1",41,0)
S6 ;;055^OTORHINOLARYNGOLOGY (ENT)
"RTN","ECXFEKE1",42,0)
S7 ;;056^PLASTIC SURGERY (INCLUDES HEAD AND NECK)
"RTN","ECXFEKE1",43,0)
S8 ;;057^PROCTOLOGY
"RTN","ECXFEKE1",44,0)
S9 ;;058^THORACIC SURGERY (INC. CARDIAC SURG.)
"RTN","ECXFEKE1",45,0)
S10 ;;059^UROLOGY
"RTN","ECXFEKE1",46,0)
S11 ;;060^ORAL SURGERY (DENTAL)
"RTN","ECXFEKE1",47,0)
S12 ;;061^PODIATRY
"RTN","ECXFEKE1",48,0)
S13 ;;062^PERIPHERAL VASCULAR
"RTN","ECXFEKE1",49,0)
S14 ;;500^CARDIAC SURGERY
"RTN","ECXFEKE1",50,0)
S15 ;;501^TRANSPLANTATION
"RTN","ECXFEKE1",51,0)
S16 ;;502^ANESTHESIOLOGY
"RTN","ECXFEKE1",52,0)
 ;
"RTN","ECXFEKE1",53,0)
DEN F EC=3:1 S EC1=$T(DEN+EC) Q:EC1'?1"D"2N.E  S ECD=$P(EC1,";",3),EC1=$P(EC1," "),^TMP($J,"DEN",EC1,EC)=ECD
"RTN","ECXFEKE1",54,0)
 Q
"RTN","ECXFEKE1",55,0)
 ;
"RTN","ECXFEKE1",56,0)
D08C ;;COMPLETE EXAM
"RTN","ECXFEKE1",57,0)
D08S ;;SCREENING EXAM
"RTN","ECXFEKE1",58,0)
D09 ;;ADMIN PROCEDURE
"RTN","ECXFEKE1",59,0)
D10 ;;X-RAYS EXTRAORAL #
"RTN","ECXFEKE1",60,0)
D11 ;;X-RAYS INTRAORAL #
"RTN","ECXFEKE1",61,0)
D12 ;;PROPHY NATURAL DENTITION
"RTN","ECXFEKE1",62,0)
D13 ;;PROPHY DENTURE
"RTN","ECXFEKE1",63,0)
D14 ;;OPERATING ROOM
"RTN","ECXFEKE1",64,0)
D15 ;;NEOPLASM CONFIRMED MALIGNANT #
"RTN","ECXFEKE1",65,0)
D16 ;;NEOPLASM REMOVED #
"RTN","ECXFEKE1",66,0)
D17 ;;BIOPSY/SMEAR #
"RTN","ECXFEKE1",67,0)
D18 ;;FRACTURE #
"RTN","ECXFEKE1",68,0)
D20 ;;OTHER SIGNIF. SURG. (CTV)
"RTN","ECXFEKE1",69,0)
D21 ;;SURFACES RESTORED #
"RTN","ECXFEKE1",70,0)
D22 ;;ROOT CANAL THERAPY #
"RTN","ECXFEKE1",71,0)
D23 ;;PERIDONTAL QUADS (SURGICAL) #
"RTN","ECXFEKE1",72,0)
D24 ;;PERIO QUADS (ROOT PLANE) #
"RTN","ECXFEKE1",73,0)
D25G ;;PATIENT ED (CTV) GROUP
"RTN","ECXFEKE1",74,0)
D25I ;;PATIENT ED (CTV) INDIVIDUAL
"RTN","ECXFEKE1",75,0)
D26S ;;SPOT CHECK EXAM (STAFF)
"RTN","ECXFEKE1",76,0)
D26F ;;SPOT CHECK EXAM (FEE)
"RTN","ECXFEKE1",77,0)
D27 ;;INDIVIDUAL CROWNS #
"RTN","ECXFEKE1",78,0)
D28 ;;POST & CORES #
"RTN","ECXFEKE1",79,0)
D29 ;;FIXED PARTIALS (ABUT) #
"RTN","ECXFEKE1",80,0)
D30 ;;FIXED PARTIALS (PONT ONLY) #
"RTN","ECXFEKE1",81,0)
D31 ;;REMOVABLE PARTIALS #
"RTN","ECXFEKE1",82,0)
D32 ;;COMPLETE DENTURES #
"RTN","ECXFEKE1",83,0)
D33 ;;PROSTHETIC REPAIR #
"RTN","ECXFEKE1",84,0)
D34 ;;SPLINT AND SPEC. PROCESS (CTV)
"RTN","ECXFEKE1",85,0)
D35 ;;EXTRACTIONS #
"RTN","ECXFEKE1",86,0)
D36 ;;SURGICAL EXTRACTIONS #
"RTN","ECXFEKE1",87,0)
D37 ;;OTHER SIG TREATMENT (CTV)
"RTN","ECXFEKE1",88,0)
D38 ;;DIVISION (STATION DIVISION)
"RTN","ECXFEKE1",89,0)
D39C ;;COMPLETIONS
"RTN","ECXFEKE1",90,0)
D39T ;;TERMINATIONS
"RTN","ECXFEKE1",91,0)
D40 ;;INTERDISCIPLINARY CONSULT
"RTN","ECXFEKE1",92,0)
D41 ;;EVALUATIONS
"RTN","ECXFEKE1",93,0)
D42 ;;PRE AUTHORIZATION/2ND OPINION
"RTN","ECXFEKE1",94,0)
D43M ;;SPOT CHECK DISCREPANCY (STAFF)
"RTN","ECXFEKE1",95,0)
D43R ;;SPOT CHECK DISCREPANCY (FEE)
"RTN","ECXFEKE1",96,0)
 ;
"RTN","ECXFEKE1",97,0)
PRINT ;
"RTN","ECXFEKE1",98,0)
 ;setting EC9=EC1 is just for the benefit of the new ECS feeder key list - don't want to mess-up the other lists
"RTN","ECXFEKE1",99,0)
 S (QFLG,PG)=0,$P(LN,"-",81)=""
"RTN","ECXFEKE1",100,0)
 S EC="" F  S EC=$O(^TMP($J,EC)),EC1="" Q:EC=""  Q:QFLG  D HEAD F  S EC1=$O(^TMP($J,EC,EC1)),EC9=EC1,EC2=""  Q:EC1=""  Q:QFLG  D
"RTN","ECXFEKE1",101,0)
 .I EC="CLI" S EC9=$P(EC9,";",2)
"RTN","ECXFEKE1",102,0)
 .I EC="ECS",$G(ECECS)="N" S EC9=$P(EC9,";",2)
"RTN","ECXFEKE1",103,0)
 .I EC="LAB",EC9[".8" S EC9=$$ADD0(EC9)
"RTN","ECXFEKE1",104,0)
 .F  S EC2=$O(^TMP($J,EC,EC1,EC2)) Q:EC2=""  D
"RTN","ECXFEKE1",105,0)
 ..D:($Y+3>IOSL) HEAD Q:QFLG
"RTN","ECXFEKE1",106,0)
 ..I EC="PHA" W !,?2,$E(EC9,2,99),?24,$E($P(^TMP($J,EC,EC1,EC2),U),1,40),?67,$$RJ^XLFSTR($P(^(EC2),U,2),12) Q
"RTN","ECXFEKE1",107,0)
 ..W !,?5,EC9,?27,^TMP($J,EC,EC1,EC2)
"RTN","ECXFEKE1",108,0)
 I $E(IOST)="C"&('QFLG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","ECXFEKE1",109,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXFEKE1",110,0)
 K EC,EC1,EC2,EC3,EC9,ECCSC,ECD,ECLIST,ECNDC,ECNDF,ECNFC,ECPHA,ECECS,ECLAB,ECSC,ECST,ECY,JJ,LN,P1,P2,P3,PG,POP,QFLG,SC,SS,X,Y,^TMP($J),DIR,DIRUT,DUOUT
"RTN","ECXFEKE1",111,0)
 W:$E(IOST)'="C" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECXFEKE1",112,0)
 Q
"RTN","ECXFEKE1",113,0)
HEAD ;
"RTN","ECXFEKE1",114,0)
 I $E(IOST)="C" S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXFEKE1",115,0)
 I $E(IOST)="C",PG>0 S DIR(0)="E" D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXFEKE1",116,0)
 W:$Y!($E(IOST)="C") @IOF
"RTN","ECXFEKE1",117,0)
 S PG=PG+1 W !,?21,"Feeder Key List For Feeder System ",EC,?70,"Page: ",PG
"RTN","ECXFEKE1",118,0)
 I EC="PHA" W !,?22,"(NEW Feeder Key from NDF Match)",!!,?2,"Feeder Key",?24,"Description",?66,"Price Per",!,?66,"Dispense Unit",!,LN,! Q
"RTN","ECXFEKE1",119,0)
 I $D(ECECS)&(EC="ECS") W !?21,$S(ECECS="O":"(OLD Feeder Key sorted by Category-Procedure)",1:"(NEW Feeder Key sorted by Procedure-CPT Code)")
"RTN","ECXFEKE1",120,0)
 I $D(ECLAB)&(EC="LAB") W !?15,$S(ECLAB="O":"(OLD Feeder Key sorted by Local Feeder Key values)",1:"      (NEW Feeder Key sorted by LMIP Codes)")
"RTN","ECXFEKE1",121,0)
 W !!,?5,"Feeder Key",?27,"Description",!,LN,!
"RTN","ECXFEKE1",122,0)
 Q
"RTN","ECXFEKE1",123,0)
ADD0(ECXFKEY) ;** Append zeros to decimal place on feeder key
"RTN","ECXFEKE1",124,0)
 ;
"RTN","ECXFEKE1",125,0)
 ;** Variable Definitions
"RTN","ECXFEKE1",126,0)
 ;**  ECXFKEY   - Value of Feeder Key
"RTN","ECXFEKE1",127,0)
 ;**                Returns  feeder key with zeros appended to make a
"RTN","ECXFEKE1",128,0)
 ;**                          four place decimal.
"RTN","ECXFEKE1",129,0)
 ;
"RTN","ECXFEKE1",130,0)
 N ECXD,LPCNT,LPEND,ECXFEKEY,ECXDEC
"RTN","ECXFEKE1",131,0)
 S ECXDEC=$P(ECXFKEY,".",2)
"RTN","ECXFEKE1",132,0)
 S LPEND=4-$L(ECXDEC)
"RTN","ECXFEKE1",133,0)
 F LPCNT=1:1:LPEND S ECXDEC=ECXDEC_"0"
"RTN","ECXFEKE1",134,0)
 S ECXFEKEY=$P(ECXFKEY,".",1)_"."_ECXDEC
"RTN","ECXFEKE1",135,0)
 Q ECXFEKEY
"RTN","ECXFEKE1",136,0)
 ;
"RTN","ECXFEKEY")
0^5^B41289219
"RTN","ECXFEKEY",1,0)
ECXFEKEY ;BIR/DMA,CML-Print Feeder Keys; [ 05/15/96  9:44 AM ] ; 4/3/02 2:44pm
"RTN","ECXFEKEY",2,0)
 ;;3.0;DSS EXTRACTS;**10,11,8,40**;Dec 22, 1997
"RTN","ECXFEKEY",3,0)
EN ;entry point from option
"RTN","ECXFEKEY",4,0)
 W !!,"Print list of Feeder Keys:",!
"RTN","ECXFEKEY",5,0)
 W !,"Select : 1. CLI",!,?9,"2. DEN",!,?9,"3. ECS",!,?9,"4. LAB",!,?9,"5. NUR",!,?9,"6. PHA",!,?9,"7. RAD",!,?9,"8. SUR",! S DIR(0)="L^1:8" D ^DIR Q:$D(DIRUT)
"RTN","ECXFEKEY",6,0)
 S ECY=Y
"RTN","ECXFEKEY",7,0)
 I ECY["3" D
"RTN","ECXFEKEY",8,0)
 .W !!,"The Feeder Key List for the Feeder System ECS can be printed by:",!?5,"(O)ld Feeder Key sort by Category-Procedure",!?5,"(N)ew Feeder Key sort by Procedure-CPT Code"
"RTN","ECXFEKEY",9,0)
 .S DIR(0)="S^O:OLD;N:NEW",DIR("B")="NEW" D ^DIR K DIR Q:$D(DIRUT)  S ECECS=Y
"RTN","ECXFEKEY",10,0)
 S:ECY["4" ECLAB=$$SELLABKE^ECXFEKE1() ;**Prompt to select Lab Feeder key
"RTN","ECXFEKEY",11,0)
 G:($G(ECLAB)=-1) QUIT ;**GOTO Exit point
"RTN","ECXFEKEY",12,0)
 G:$D(DIRUT) QUIT
"RTN","ECXFEKEY",13,0)
 K %ZIS,IOP S %ZIS="QM",%ZIS("B")="" D ^%ZIS
"RTN","ECXFEKEY",14,0)
 I POP W !,"NO DEVICE SELECTED!!" G QUIT
"RTN","ECXFEKEY",15,0)
 I $D(IO("Q")) K IO("Q") D  G QUIT
"RTN","ECXFEKEY",16,0)
 .S ZTRTN="START^ECXFEKEY",ZTDESC="Feeder Key List (DSS)"
"RTN","ECXFEKEY",17,0)
 .S ZTSAVE("ECY")="",ZTSAVE("ECPHA")="",ZTSAVE("ECPHA2")="",ZTSAVE("ECECS")="",ZTSAVE("ECLAB")=""
"RTN","ECXFEKEY",18,0)
 .D ^%ZTLOAD I $D(ZTSK) W !,"Queued Task #: "_ZTSK
"RTN","ECXFEKEY",19,0)
 .D HOME^%ZIS K ZTSK
"RTN","ECXFEKEY",20,0)
 ;
"RTN","ECXFEKEY",21,0)
START ;queued entry point
"RTN","ECXFEKEY",22,0)
 I '$D(DT) S DT=$$HTFM^XLFDT(+$H)
"RTN","ECXFEKEY",23,0)
 K ^TMP($J)
"RTN","ECXFEKEY",24,0)
 F ECLIST=1:1 S EC=$P(ECY,",",ECLIST) Q:EC=""  D:EC=1 CLI D:EC=2 DEN^ECXFEKE1 D:EC=3 ECS D:EC=4 LAB D:EC=5 NUR D:EC=6 PHA D:EC=7 RAD D:EC=8 SUR^ECXFEKE1
"RTN","ECXFEKEY",25,0)
 U IO D PRINT^ECXFEKE1
"RTN","ECXFEKEY",26,0)
 Q
"RTN","ECXFEKEY",27,0)
LAB S EC=0
"RTN","ECXFEKEY",28,0)
 ;
"RTN","ECXFEKEY",29,0)
 ;** OLD Feeder Key format
"RTN","ECXFEKEY",30,0)
 I $G(ECLAB)="O" DO
"RTN","ECXFEKEY",31,0)
 .F  S EC=$O(^LAB(60,EC)) Q:'EC  I $D(^(EC,0)) S EC1=$P(^(0),U),^TMP($J,"LAB",EC,EC)=EC1
"RTN","ECXFEKEY",32,0)
 ;
"RTN","ECXFEKEY",33,0)
 ;** NEW Feeder key format (LMIP Code)
"RTN","ECXFEKEY",34,0)
 I $G(ECLAB)="N" DO
"RTN","ECXFEKEY",35,0)
 .N EC2
"RTN","ECXFEKEY",36,0)
 .F  S EC=$O(^LAM(EC)) Q:'EC  DO
"RTN","ECXFEKEY",37,0)
 ..I $D(^LAM(EC,0)) DO
"RTN","ECXFEKEY",38,0)
 ...S EC1=$P(^LAM(EC,0),U,1),EC1=$P(EC1,"~",1)
"RTN","ECXFEKEY",39,0)
 ...S EC2=$P(^LAM(EC,0),U,2)
"RTN","ECXFEKEY",40,0)
 ...I EC2'[".9999",(EC2'[".8") S EC2=EC2\1
"RTN","ECXFEKEY",41,0)
 ...S ^TMP($J,"LAB",+EC2,+EC2)=EC1
"RTN","ECXFEKEY",42,0)
 Q
"RTN","ECXFEKEY",43,0)
ECS ;old ECS feeder key list for pre-FY97 data
"RTN","ECXFEKEY",44,0)
 G:$G(ECECS)="N" ECS2
"RTN","ECXFEKEY",45,0)
 S EC=0 I $P($G(^EC(720.1,1,0)),U,2) D  G ECQ
"RTN","ECXFEKEY",46,0)
 .F  S EC=$O(^ECJ(EC)) Q:'EC  I $D(^(EC,0)) D
"RTN","ECXFEKEY",47,0)
 ..S EC1=$P($P(^(0),U),"-",3,4),EC2=$P(EC1,"-"),EC2=$S(+EC2:EC2,1:"***"),EC4=$S($P($G(^EC(726,+EC2,0)),U)]"":$P(^(0),U),1:"***")
"RTN","ECXFEKEY",48,0)
 ..S EC3=$P(EC1,"-",2) Q:'+EC3  S EC3=$S(EC3["ICPT":$P($G(^ICPT(+EC3,0)),U),+EC3<90000:$P($G(^EC(725,+EC3,0)),U,2)_"N",1:$P($G(^EC(725,+EC3,0)),U,2)_"L")
"RTN","ECXFEKEY",49,0)
 ..S EC5=$P(EC1,"-",2),EC5=$S(EC5["ICPT":$E($P($G(^ICPT(+EC5,0)),U,2),1,25),EC5["EC":$E($P($G(^EC(725,+EC5,0)),U),1,25),1:"UNKNOWN")
"RTN","ECXFEKEY",50,0)
 ..S ^TMP($J,"ECS",EC2_" - "_EC3,EC3)=EC4_" - "_EC5
"RTN","ECXFEKEY",51,0)
 F  S EC=$O(^ECK(EC)) Q:'EC  I $D(^(EC,0)) S EC1=$P($P(^(0),U),"-",3,4),EC2=$E($P($G(^ECP(+EC1,0)),U),1,25),EC3=$E($P($G(^ECP(+$P(EC1,"-",2),0)),U),1,25),^TMP($J,"ECS",EC1,EC1)=EC2_" - "_EC3
"RTN","ECXFEKEY",52,0)
ECQ K EC1,EC2,EC3,EC4,EC5,EC6,EC7,EC8,EC9,EC10 Q
"RTN","ECXFEKEY",53,0)
ECS2 ;new ECS feeder key list for FY97 data
"RTN","ECXFEKEY",54,0)
 ;feeder key is <Procedure> if PCE CPT code is same or null;
"RTN","ECXFEKEY",55,0)
 ;feeder is <Procedure-PCE CPT> otherwise;
"RTN","ECXFEKEY",56,0)
 ;the description column of list shows procedure (EC5) in lowercase and CPT code (EC8) in uppercase;
"RTN","ECXFEKEY",57,0)
 ;but if procedure (EC3) is itself a CPT Code, convert EC5 to uppercase
"RTN","ECXFEKEY",58,0)
 ;concatenation of "A;" and "B;" are for proper sorting - CPT codes 1st, then other procedures
"RTN","ECXFEKEY",59,0)
 S EC=0 I $P($G(^EC(720.1,1,0)),U,2) D  G ECQ
"RTN","ECXFEKEY",60,0)
 .F  S EC=$O(^ECJ(EC)) Q:'EC  I $D(^ECJ(EC,0)) D
"RTN","ECXFEKEY",61,0)
 ..S EC1=$P($P(^ECJ(EC,0),U),"-",3,4)
"RTN","ECXFEKEY",62,0)
 ..S EC3=$P(EC1,"-",2) Q:'+EC3  S EC3=$S(EC3["ICPT":$P($G(^ICPT(+EC3,0)),U),+EC3<90000:$P($G(^EC(725,+EC3,0)),U,2)_"N",1:$P($G(^EC(725,+EC3,0)),U,2)_"L")
"RTN","ECXFEKEY",63,0)
 ..S EC5=$P(EC1,"-",2),EC5=$S(EC5["ICPT":$E($P($G(^ICPT(+EC5,0)),U,2),1,25),EC5["EC":$E($P($G(^EC(725,+EC5,0)),U),1,25),1:"UNKNOWN")
"RTN","ECXFEKEY",64,0)
 ..S EC5=$$LOW(EC5)
"RTN","ECXFEKEY",65,0)
 ..I EC1["ICPT" S EC5=$$UPP(EC5),EC3="A;"_EC3
"RTN","ECXFEKEY",66,0)
 ..S EC6=$P(EC1,"-",2),EC7="",EC8=""
"RTN","ECXFEKEY",67,0)
 ..I EC6["EC(725," D
"RTN","ECXFEKEY",68,0)
 ...S EC6=$S(+EC6>0:$P($G(^EC(725,+EC6,0)),U,5),1:"") S EC7=$S(+EC6>0:$P($G(^ICPT(+EC6,0)),U),1:"")
"RTN","ECXFEKEY",69,0)
 ...S EC8=$S(+EC6>0:$E($P($G(^ICPT(+EC6,0)),U,2),1,25),1:"")
"RTN","ECXFEKEY",70,0)
 ...S EC8=$$UPP(EC8),EC3="B;"_EC3
"RTN","ECXFEKEY",71,0)
 ..S EC9=$S(EC7'="":EC3_"-"_EC7,1:EC3),EC10=$S(EC8'="":EC5_" - "_EC8,1:EC5)
"RTN","ECXFEKEY",72,0)
 ..S ^TMP($J,"ECS",EC9,EC3)=EC10
"RTN","ECXFEKEY",73,0)
 G ECQ
"RTN","ECXFEKEY",74,0)
LOW(X) ;convert string to lowercase
"RTN","ECXFEKEY",75,0)
 F %=2:1:$L(X) I $E(X,%)?1U,$E(X,%-1)?1A S X=$E(X,0,%-1)_$C($A(X,%)+32)_$E(X,%+1,999)
"RTN","ECXFEKEY",76,0)
 Q X
"RTN","ECXFEKEY",77,0)
UPP(X) ;convert string to uppercase
"RTN","ECXFEKEY",78,0)
 F %=1:1:$L(X) S:$E(X,%)?1L X=$E(X,0,%-1)_$C($A(X,%)-32)_$E(X,%+1,999)
"RTN","ECXFEKEY",79,0)
 Q X
"RTN","ECXFEKEY",80,0)
 ;
"RTN","ECXFEKEY",81,0)
PHA ;NEW PHA Feeder Key List sorted by NDF Match
"RTN","ECXFEKEY",82,0)
 N ECPPDU
"RTN","ECXFEKEY",83,0)
 S ECXYM=$$ECXYM^ECXUTL(DT)
"RTN","ECXFEKEY",84,0)
 S EC=0 F  S EC=$O(^PSDRUG(EC)) Q:'EC  I $D(^PSDRUG(EC,0)) D
"RTN","ECXFEKEY",85,0)
 .S ECD=$P(^PSDRUG(EC,0),U),ECNDC=$P($G(^PSDRUG(EC,2)),U,4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXFEKEY",86,0)
 .S ECNDF=$G(^PSDRUG(EC,"ND")),P1=$P(ECNDF,U),P3=$P(ECNDF,U,3)
"RTN","ECXFEKEY",87,0)
 .;get the 17 character key
"RTN","ECXFEKEY",88,0)
 .S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXFEKEY",89,0)
 .Q:+ECNFC=0
"RTN","ECXFEKEY",90,0)
 .S ECNFC="A"_ECNFC
"RTN","ECXFEKEY",91,0)
 .S ECPPDU=$FNUMBER($P($G(^PSDRUG(EC,660)),U,6),"P",4)
"RTN","ECXFEKEY",92,0)
 .S ^TMP($J,"PHA",ECNFC,0)=ECD_U_ECPPDU
"RTN","ECXFEKEY",93,0)
 Q
"RTN","ECXFEKEY",94,0)
CLI S SC=0 F  S SC=$O(^SC(SC)) Q:'SC  I $D(^(SC,0)) S EC=^(0),ECD=$P(EC,U) I $P(EC,U,3)="C" D  S ^TMP($J,"CLI","A;"_P1_P2_ECLEN_P3_"0",SC)=ECD
"RTN","ECXFEKEY",95,0)
 .S ECSC=$P($G(^DIC(40.7,+$P(EC,U,7),0)),U,2),ECCSC=$P($G(^DIC(40.7,+$P(EC,U,18),0)),U,2)
"RTN","ECXFEKEY",96,0)
 .S ECLEN="NNN" I $D(^SC(SC,"SL")),$P(^("SL"),U,2)'="V" S ECLEN=$S($P(^("SL"),U):$P(^("SL"),U),1:"NNN"),ECLEN=$E("000"_ECLEN,$L(ECLEN)+1,$L(ECLEN)+3)
"RTN","ECXFEKEY",97,0)
 .S (P1,P2)="000",P3="0000" I '$D(^ECX(728.44,SC,0)),ECCSC]"" S ECST=5,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3),P2=$E("000"_ECCSC,$L(ECCSC)+1,$L(ECCSC)+3) Q
"RTN","ECXFEKEY",98,0)
 .I '$D(^ECX(728.44,SC,0)) S ECST=1,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3) Q
"RTN","ECXFEKEY",99,0)
 .S EC=^ECX(728.44,SC,0),ECST=$P(EC,U,6)
"RTN","ECXFEKEY",100,0)
 .I ECST=6 Q
"RTN","ECXFEKEY",101,0)
 .;action code 6 means ignore
"RTN","ECXFEKEY",102,0)
 .I $P(EC,U,4)]"" S ECSC=$P(EC,U,4)
"RTN","ECXFEKEY",103,0)
 .I $P(EC,U,5)]"" S ECCSC=$P(EC,U,5)
"RTN","ECXFEKEY",104,0)
 .I ECST="" S ECST=4,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3),P3=$E("0000"_SC,$L(SC)+1,$L(SC)+4) S:ECCSC P2=$E("000"_ECCSC,$L(ECCSC)+1,$L(ECCSC)+3) Q
"RTN","ECXFEKEY",105,0)
 .I ECST<2 S P1=ECSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3) Q
"RTN","ECXFEKEY",106,0)
 .I ECST=2 S P1=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3) Q
"RTN","ECXFEKEY",107,0)
 .I ECST=3 S P1=ECSC,P11=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3),P11=$E("000"_P11,$L(P11)+1,$L(P11)+3) Q
"RTN","ECXFEKEY",108,0)
 .I ECST>3,ECST<7 S P1=ECSC,P2=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3),P2=$E("000"_P2,$L(P2)+1,$L(P2)+3) S:ECST=4 P3=$P($G(^ECX(728.441,+$P(^ECX(728.44,SC,0),U,8),0)),U) I P3="" S P3=$E("0000"_SC,$L(SC)+1,$L(SC)+4)
"RTN","ECXFEKEY",109,0)
 K ECLEN Q
"RTN","ECXFEKEY",110,0)
RAD S EC=0 F  S EC=$O(^RAMIS(71,EC)) Q:'EC  I $D(^(EC,0)) S EC1=^(0),ECD=$P(EC1,U),EC2=$P($G(^ICPT(+$P(EC1,U,9),0)),U) S:EC2="" EC2="Unknown" S ^TMP($J,"RAD",EC2,EC)=ECD
"RTN","ECXFEKEY",111,0)
 S ^TMP($J,"RAD",88888,88888)="Portable procedure",^TMP($J,"RAD",99999,99999)="OR procedure"
"RTN","ECXFEKEY",112,0)
 Q
"RTN","ECXFEKEY",113,0)
NUR F EC=1:1:11 S EC1=$P($T(@EC),";",3) F EC2=0:1:5 S ^TMP($J,"NUR",$P(EC1,U)_"-"_EC2,EC2)=$P(EC1,U,2)_" LEVEL "_EC2
"RTN","ECXFEKEY",114,0)
1 ;;PSI^PSYCHIATRIC
"RTN","ECXFEKEY",115,0)
2 ;;SUR^SURGICAL
"RTN","ECXFEKEY",116,0)
3 ;;MED^MEDICAL (EXCLUDE SCI)
"RTN","ECXFEKEY",117,0)
4 ;;SCI^MEDICAL (SCI)
"RTN","ECXFEKEY",118,0)
5 ;;NUR^NURSING HOME CARE UNIT
"RTN","ECXFEKEY",119,0)
6 ;;REC^RECOVERY ROOM
"RTN","ECXFEKEY",120,0)
7 ;;ITN^INTENSIVE CARE
"RTN","ECXFEKEY",121,0)
8 ;;HEM^HEMODIALYSIS
"RTN","ECXFEKEY",122,0)
9 ;;INT^INTERMEDIATE CARE
"RTN","ECXFEKEY",123,0)
10 ;;DOM^DOMICILIARY
"RTN","ECXFEKEY",124,0)
11 ;;ALC^ALCOHOL AND DRUG TREATMENT
"RTN","ECXFEKEY",125,0)
 Q
"RTN","ECXFEKEY",126,0)
QUIT ;
"RTN","ECXFEKEY",127,0)
 K ECY,ECPHA,ECECS,ECLAB,ECPPDU,DIR,DIRUT,DUOUT,X,Y
"RTN","ECXFEKEY",128,0)
 Q
"VER")
8.0^22.0
**END**
**END**
