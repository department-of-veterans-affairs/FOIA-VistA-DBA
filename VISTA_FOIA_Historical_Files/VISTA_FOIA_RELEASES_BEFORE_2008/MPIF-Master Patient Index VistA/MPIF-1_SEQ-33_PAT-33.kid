Released MPIF*1*33 SEQ #33
Extracted from mail message
**KIDS**:MPIF*1.0*33^

**INSTALL NAME**
MPIF*1.0*33
"BLD",1974,0)
MPIF*1.0*33^MASTER PATIENT INDEX VISTA^0^3040628^y
"BLD",1974,1,0)
^^3^3^3040521^
"BLD",1974,1,1,0)
REMOVE SOME MPI SCREENS - MPI CHANGES ITERATION 2
"BLD",1974,1,2,0)
Refer to patch MPIF*1.0*33 in the FORUM Patch Module for a complete
"BLD",1974,1,3,0)
description.
"BLD",1974,4,0)
^9.64PA^^0
"BLD",1974,"ABNS",0)
^9.66A^^
"BLD",1974,"ABPKG")
^^
"BLD",1974,"INID")
^y
"BLD",1974,"INIT")
MPIFP33
"BLD",1974,"KRN",0)
^9.67PA^8989.52^19
"BLD",1974,"KRN",.4,0)
.4
"BLD",1974,"KRN",.401,0)
.401
"BLD",1974,"KRN",.402,0)
.402
"BLD",1974,"KRN",.403,0)
.403
"BLD",1974,"KRN",.5,0)
.5
"BLD",1974,"KRN",.84,0)
.84
"BLD",1974,"KRN",3.6,0)
3.6
"BLD",1974,"KRN",3.8,0)
3.8
"BLD",1974,"KRN",9.2,0)
9.2
"BLD",1974,"KRN",9.8,0)
9.8
"BLD",1974,"KRN",9.8,"NM",0)
^9.68A^16^11
"BLD",1974,"KRN",9.8,"NM",1,0)
MPIFVTQ^^0^B29440956
"BLD",1974,"KRN",9.8,"NM",5,0)
MPIFQ0^^0^B65454705
"BLD",1974,"KRN",9.8,"NM",8,0)
MPIF001^^0^B53337977
"BLD",1974,"KRN",9.8,"NM",9,0)
MPIFRPC2^^0^B11239382
"BLD",1974,"KRN",9.8,"NM",10,0)
MPIFBT3^^0^B38598569
"BLD",1974,"KRN",9.8,"NM",11,0)
MPIFAPI^^0^B68215248
"BLD",1974,"KRN",9.8,"NM",12,0)
MPIFP33^^0^B4547615
"BLD",1974,"KRN",9.8,"NM",13,0)
MPIFBT1^^0^B34877706
"BLD",1974,"KRN",9.8,"NM",14,0)
MPIF002^^0^B21350253
"BLD",1974,"KRN",9.8,"NM",15,0)
MPIFRES^^0^B15482474
"BLD",1974,"KRN",9.8,"NM",16,0)
MPIFQ1^^0^B39645920
"BLD",1974,"KRN",9.8,"NM","B","MPIF001",8)

"BLD",1974,"KRN",9.8,"NM","B","MPIF002",14)

"BLD",1974,"KRN",9.8,"NM","B","MPIFAPI",11)

"BLD",1974,"KRN",9.8,"NM","B","MPIFBT1",13)

"BLD",1974,"KRN",9.8,"NM","B","MPIFBT3",10)

"BLD",1974,"KRN",9.8,"NM","B","MPIFP33",12)

"BLD",1974,"KRN",9.8,"NM","B","MPIFQ0",5)

"BLD",1974,"KRN",9.8,"NM","B","MPIFQ1",16)

"BLD",1974,"KRN",9.8,"NM","B","MPIFRES",15)

"BLD",1974,"KRN",9.8,"NM","B","MPIFRPC2",9)

"BLD",1974,"KRN",9.8,"NM","B","MPIFVTQ",1)

"BLD",1974,"KRN",19,0)
19
"BLD",1974,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",1974,"KRN",19,"NM",1,0)
MPIF PAT INACT^^1^
"BLD",1974,"KRN",19,"NM","B","MPIF PAT INACT",1)

"BLD",1974,"KRN",19.1,0)
19.1
"BLD",1974,"KRN",101,0)
101
"BLD",1974,"KRN",409.61,0)
409.61
"BLD",1974,"KRN",771,0)
771
"BLD",1974,"KRN",870,0)
870
"BLD",1974,"KRN",8989.51,0)
8989.51
"BLD",1974,"KRN",8989.52,0)
8989.52
"BLD",1974,"KRN",8994,0)
8994
"BLD",1974,"KRN","B",.4,.4)

"BLD",1974,"KRN","B",.401,.401)

"BLD",1974,"KRN","B",.402,.402)

"BLD",1974,"KRN","B",.403,.403)

"BLD",1974,"KRN","B",.5,.5)

"BLD",1974,"KRN","B",.84,.84)

"BLD",1974,"KRN","B",3.6,3.6)

"BLD",1974,"KRN","B",3.8,3.8)

"BLD",1974,"KRN","B",9.2,9.2)

"BLD",1974,"KRN","B",9.8,9.8)

"BLD",1974,"KRN","B",19,19)

"BLD",1974,"KRN","B",19.1,19.1)

"BLD",1974,"KRN","B",101,101)

"BLD",1974,"KRN","B",409.61,409.61)

"BLD",1974,"KRN","B",771,771)

"BLD",1974,"KRN","B",870,870)

"BLD",1974,"KRN","B",8989.51,8989.51)

"BLD",1974,"KRN","B",8989.52,8989.52)

"BLD",1974,"KRN","B",8994,8994)

"BLD",1974,"PRET")

"BLD",1974,"QUES",0)
^9.62^^
"BLD",1974,"REQB",0)
^9.611^6^6
"BLD",1974,"REQB",1,0)
DG*5.3*589^1
"BLD",1974,"REQB",2,0)
MPIF*1.0*27^1
"BLD",1974,"REQB",3,0)
MPIF*1.0*28^1
"BLD",1974,"REQB",4,0)
MPIF*1.0*31^1
"BLD",1974,"REQB",5,0)
MPIF*1.0*24^1
"BLD",1974,"REQB",6,0)
RG*1.0*35^1
"BLD",1974,"REQB","B","DG*5.3*589",1)

"BLD",1974,"REQB","B","MPIF*1.0*24",5)

"BLD",1974,"REQB","B","MPIF*1.0*27",2)

"BLD",1974,"REQB","B","MPIF*1.0*28",3)

"BLD",1974,"REQB","B","MPIF*1.0*31",4)

"BLD",1974,"REQB","B","RG*1.0*35",6)

"INIT")
MPIFP33
"KRN",19,6963,-1)
1^1
"KRN",19,6963,0)
MPIF PAT INACT
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
33^3040628
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3040628
"PKG",282,22,1,"PAH",1,1,1,0)
REMOVE SOME MPI SCREENS - MPI CHANGES ITERATION 2
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*33 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","MPIF001")
0^8^B53337977
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,16,18,21,27,33**;30 Apr 99
"RTN","MPIF001",3,0)
 ;
"RTN","MPIF001",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIF001",5,0)
 ;  ^DPT( - #2070
"RTN","MPIF001",6,0)
 ; ^DPT("AICN" - #2070
"RTN","MPIF001",7,0)
 ; ^DPT("AMPIMIS" - #2070
"RTN","MPIF001",8,0)
 ; EXC^RGHLLOG - #2796
"RTN","MPIF001",9,0)
 ; START^RGHLLOG - #2796
"RTN","MPIF001",10,0)
 ; STOP^RGHLLOG - #2796
"RTN","MPIF001",11,0)
 ;
"RTN","MPIF001",12,0)
GETICN(DFN) ; This function returns the ICN, including checksum for a given
"RTN","MPIF001",13,0)
 ; DFN or -1^error message
"RTN","MPIF001",14,0)
 ; INPUT: DFN - ien in Patient file
"RTN","MPIF001",15,0)
 ;
"RTN","MPIF001",16,0)
 N RETURN,NODE
"RTN","MPIF001",17,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",18,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",19,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",20,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",21,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",22,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",23,0)
 I '$D(^DPT("AICN",$P(NODE,"^"),DFN)) S ^DPT("AICN",$P(NODE,"^"),DFN)=""
"RTN","MPIF001",24,0)
 ; ^ set AICN x-ref if missing one
"RTN","MPIF001",25,0)
EXIT1 ;
"RTN","MPIF001",26,0)
 Q RETURN
"RTN","MPIF001",27,0)
 ;
"RTN","MPIF001",28,0)
GETDFN(ICN) ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",29,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",30,0)
 N RETURN,DFN
"RTN","MPIF001",31,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",32,0)
 I ICN["V" S ICN=+ICN
"RTN","MPIF001",33,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",34,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",35,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",36,0)
 S RETURN=DFN
"RTN","MPIF001",37,0)
EXIT2 ;
"RTN","MPIF001",38,0)
 Q RETURN
"RTN","MPIF001",39,0)
 ;
"RTN","MPIF001",40,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",41,0)
 ; a Local ICN and update the appropriate fields if a Local was created
"RTN","MPIF001",42,0)
 ; DFN= Patient IEN
"RTN","MPIF001",43,0)
 ; Returns ICN (local or National including checksum) or -1^error msg
"RTN","MPIF001",44,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",45,0)
 I $G(DFN)'>0 Q "-1^No DFN Passed"
"RTN","MPIF001",46,0)
 D LOCK
"RTN","MPIF001",47,0)
 S ICN=$$GETICN(DFN)
"RTN","MPIF001",48,0)
 I +ICN=-1 D
"RTN","MPIF001",49,0)
 .;no icn create a Local ICN
"RTN","MPIF001",50,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",51,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",52,0)
 .S NOLOCK=""
"RTN","MPIF001",53,0)
 .I ICNX="" K NOLOCK S ICN="-1^PROBLEM CREATING LOCAL ICN" Q
"RTN","MPIF001",54,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",55,0)
 .I +TMP=-1 K NOLOCK Q
"RTN","MPIF001",56,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",57,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",58,0)
 .K NOLOCK
"RTN","MPIF001",59,0)
 D UNLOCK
"RTN","MPIF001",60,0)
 Q ICN
"RTN","MPIF001",61,0)
 ;
"RTN","MPIF001",62,0)
CMOR2(DFN) ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",63,0)
 ; DFN = Patient IEN
"RTN","MPIF001",64,0)
 I $G(DFN)'>0 Q "-1^No DFN Passed"
"RTN","MPIF001",65,0)
 N NODE
"RTN","MPIF001",66,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",67,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",68,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",69,0)
 ;
"RTN","MPIF001",70,0)
CMORNAME(CIEN) ; Returns CMOR site name or -1^error message
"RTN","MPIF001",71,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",72,0)
 ;
"RTN","MPIF001",73,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",74,0)
 N INST
"RTN","MPIF001",75,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",76,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",77,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",78,0)
 Q $P(INST,"^")
"RTN","MPIF001",79,0)
 ;
"RTN","MPIF001",80,0)
GETVCCI(DFN) ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",81,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",82,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",83,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",84,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",85,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",86,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",87,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",88,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",89,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",90,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",91,0)
 S RETURN=STANUM
"RTN","MPIF001",92,0)
EXIT3 ;
"RTN","MPIF001",93,0)
 Q RETURN
"RTN","MPIF001",94,0)
 ;
"RTN","MPIF001",95,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",96,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",97,0)
 ;
"RTN","MPIF001",98,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",99,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",100,0)
 ; VCCI = CMOR ien from the institution file
"RTN","MPIF001",101,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",102,0)
 ;             1 - successful
"RTN","MPIF001",103,0)
 ; Exception will be generated if Update to File Fails only
"RTN","MPIF001",104,0)
 N RETURN,DIQUIET,DIE,DA,DR,Y,X,DIC
"RTN","MPIF001",105,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",106,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",107,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",108,0)
 I $G(VCCI)="" S RETURN="-1^NO CMOR PASSED" G EXIT4
"RTN","MPIF001",109,0)
 N CNT,TIEN S DIQUIET=1,CNT=0
"RTN","MPIF001",110,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",111,0)
 ; moved to here to fix problem with timing
"RTN","MPIF001",112,0)
 I $E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S VCCI=$P($$SITE^VASITE(),"^")
"RTN","MPIF001",113,0)
 ; ^ to be sure site is self for a local icn
"RTN","MPIF001",114,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",115,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",116,0)
REP S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",117,0)
 D ^DIE
"RTN","MPIF001",118,0)
 S CNT=CNT+1
"RTN","MPIF001",119,0)
 S TIEN=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIF001",120,0)
 I "`"_TIEN'=VCCI&(CNT<4) G REP
"RTN","MPIF001",121,0)
 I "`"_TIEN'=VCCI&(CNT>3) D
"RTN","MPIF001",122,0)
 .S RETURN="-1^Couldn't Update CMOR"
"RTN","MPIF001",123,0)
 .D START^RGHLLOG(0)
"RTN","MPIF001",124,0)
 .D EXC^RGHLLOG(221,"Unable to update CMOR to "_$$STA^XUAF4(TIEN)_" for patient DFN= "_DFN,DFN)
"RTN","MPIF001",125,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",126,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",127,0)
EXIT4 ;
"RTN","MPIF001",128,0)
 Q RETURN
"RTN","MPIF001",129,0)
 ;
"RTN","MPIF001",130,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",131,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",132,0)
 ;
"RTN","MPIF001",133,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",134,0)
 ; file for a given patient.
"RTN","MPIF001",135,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",136,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",137,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",138,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",139,0)
 ;          1 - successful
"RTN","MPIF001",140,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y,ERR
"RTN","MPIF001",141,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",142,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",143,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",144,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",145,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",146,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)'=$E(ICN,1,3) S RETURN="-1^Don't overwrite national with local" G EXIT5
"RTN","MPIF001",147,0)
 ; ^ stop local from overwriting a national ICN
"RTN","MPIF001",148,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S RETURN="-1^Don't overwrite local ICN with another Local ICN" G EXIT5
"RTN","MPIF001",149,0)
 ; ^ STOP LOCAL FROM OVERWRITING ANOTHER LOCAL ICN
"RTN","MPIF001",150,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",151,0)
 .Q:DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIF001",152,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D
"RTN","MPIF001",153,0)
 ..N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",154,0)
 ..D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that's already in use for Pt dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if Duplicate.",DFN)
"RTN","MPIF001",155,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIF001",156,0)
 ..S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",157,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",158,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",159,0)
 S DIQUIET=1
"RTN","MPIF001",160,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",161,0)
 D ^DIE
"RTN","MPIF001",162,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",163,0)
 I +RETURN>0 D
"RTN","MPIF001",164,0)
 .K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",165,0)
 .I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,1)
"RTN","MPIF001",166,0)
 .I $E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",167,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",168,0)
EXIT5 ;
"RTN","MPIF001",169,0)
 Q RETURN
"RTN","MPIF001",170,0)
 ;
"RTN","MPIF001",171,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",172,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",173,0)
 ;
"RTN","MPIF001",174,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",175,0)
 ; for the given patient
"RTN","MPIF001",176,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",177,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",178,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",179,0)
 ;
"RTN","MPIF001",180,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",181,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",182,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",183,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",184,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",185,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",186,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",187,0)
 D ^DIE
"RTN","MPIF001",188,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",189,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",190,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",191,0)
EXIT6 ;
"RTN","MPIF001",192,0)
 Q RETURN
"RTN","MPIF001",193,0)
 ;
"RTN","MPIF001",194,0)
IFLOCAL(DFN) ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",195,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",196,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",197,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",198,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",199,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",200,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",201,0)
 Q:$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE,"^",3) 1
"RTN","MPIF001",202,0)
 Q 0
"RTN","MPIF001",203,0)
 ;
"RTN","MPIF001",204,0)
IFVCCI(DFN) ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",205,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",206,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",207,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",208,0)
 ;          0^ERROR MSG
"RTN","MPIF001",209,0)
 N VCCI,SITE
"RTN","MPIF001",210,0)
 I $G(DFN)'>0 Q "0^No DFN Passed"
"RTN","MPIF001",211,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",212,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",213,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",214,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",215,0)
 Q 1
"RTN","MPIF001",216,0)
 ;
"RTN","MPIF001",217,0)
HL7CMOR(DFN,SEP) ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",218,0)
 ; the given patient.
"RTN","MPIF001",219,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",220,0)
 ; SEP = delimiter to separate station number and name
"RTN","MPIF001",221,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",222,0)
 ;            -1^error message
"RTN","MPIF001",223,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",224,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",225,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",226,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",227,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",228,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",229,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",230,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",231,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",232,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",233,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",234,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",235,0)
EXIT7 ;
"RTN","MPIF001",236,0)
 Q RETURN
"RTN","MPIF001",237,0)
 ;
"RTN","MPIF001",238,0)
LOCK ;
"RTN","MPIF001",239,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",240,0)
 Q
"RTN","MPIF001",241,0)
 ;
"RTN","MPIF001",242,0)
UNLOCK ;
"RTN","MPIF001",243,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",244,0)
 Q
"RTN","MPIF002")
0^14^B21350253
"RTN","MPIF002",1,0)
MPIF002 ;CIOFOSF/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF002",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20,27,33**;30 Apr 99
"RTN","MPIF002",3,0)
 ;
"RTN","MPIF002",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIF002",5,0)
 ;  ^DPT( - #2070
"RTN","MPIF002",6,0)
 ;
"RTN","MPIF002",7,0)
GETICNH(DFN,ICNHA) ;
"RTN","MPIF002",8,0)
 ;Return all ICNs (including checksum) in ICN History for patient DFN
"RTN","MPIF002",9,0)
 ; DFN = IEN of patient in the Patient (#2) file
"RTN","MPIF002",10,0)
 ; ICNHA - array where ICN History will be returned.
"RTN","MPIF002",11,0)
 N IEN,ICN,CNT,RET
"RTN","MPIF002",12,0)
 I '$D(^DPT(DFN)) S ICNHA="-1^NO SUCH DFN" Q
"RTN","MPIF002",13,0)
 I '$D(^DPT(DFN,"MPIFHIS")) S ICNHA="-1^NO ICN HISTORY" Q
"RTN","MPIF002",14,0)
 S (IEN,CNT)=0,RET=""
"RTN","MPIF002",15,0)
 F  S IEN=$O(^DPT(DFN,"MPIFHIS",IEN)) Q:IEN=""  D
"RTN","MPIF002",16,0)
 .S ICN=$P($G(^DPT(DFN,"MPIFHIS",IEN,0)),"^")_"V"_$P($G(^DPT(DFN,"MPIFHIS",IEN,0)),"^",2)
"RTN","MPIF002",17,0)
 .I ICN'="" S CNT=CNT+1,ICNHA(CNT)=""""_ICN_""""
"RTN","MPIF002",18,0)
 I CNT=0 S ICNHA="-1^NO ICN HISTORY" Q
"RTN","MPIF002",19,0)
 S ICNHA=CNT
"RTN","MPIF002",20,0)
 Q
"RTN","MPIF002",21,0)
 ;
"RTN","MPIF002",22,0)
GETCMORH(DFN,CMORHA) ;
"RTN","MPIF002",23,0)
 ;Return all CMORs in CMOR History for patient DFN
"RTN","MPIF002",24,0)
 ; DFN = IEN of patient in the Patient (#2) file
"RTN","MPIF002",25,0)
 ; CMORHA - array where CMOR history will be returned
"RTN","MPIF002",26,0)
 ;
"RTN","MPIF002",27,0)
 N IEN,CMOR,CNT,RET
"RTN","MPIF002",28,0)
 I '$D(^DPT(DFN)) S CMORHA="-1^NO SUCH DFN" Q
"RTN","MPIF002",29,0)
 I '$D(^DPT(DFN,"MPICMOR")) S CMORHA="-1^NO CMOR HISTORY" Q
"RTN","MPIF002",30,0)
 S (IEN,CNT)=0,RET=""
"RTN","MPIF002",31,0)
 F  S IEN=$O(^DPT(DFN,"MPICMOR",IEN)) Q:IEN=""  D
"RTN","MPIF002",32,0)
 .S CMOR=$P($G(^DPT(DFN,"MPICMOR",IEN,0)),"^")
"RTN","MPIF002",33,0)
 .I CMOR'="" S CMOR=$P($$NNT^XUAF4(CMOR),"^",2)
"RTN","MPIF002",34,0)
 .I CMOR'="" S CNT=CNT+1,CMORHA(CNT)=""""_CMOR_""""
"RTN","MPIF002",35,0)
 I CNT=0 S CMORHA="-1^NO CMOR HISTORY" Q
"RTN","MPIF002",36,0)
 S CMORHA=CNT
"RTN","MPIF002",37,0)
 Q
"RTN","MPIF002",38,0)
 ;
"RTN","MPIF002",39,0)
GETDFNS(SSN) ;
"RTN","MPIF002",40,0)
 ; Find DFN for a given SSN - all if there are more than one
"RTN","MPIF002",41,0)
 ; SSN - SSN for patient attempted to be found in the Patient file (#2)
"RTN","MPIF002",42,0)
 ; Return - list of DFNs or -1^error msg
"RTN","MPIF002",43,0)
 ;
"RTN","MPIF002",44,0)
 N DFN,LIST,CNT,NODE
"RTN","MPIF002",45,0)
 I '$D(^DPT("SSN",SSN)) Q "-1^No such SSN"
"RTN","MPIF002",46,0)
 S (DFN,LIST)="",CNT=0
"RTN","MPIF002",47,0)
 F  S DFN=$O(^DPT("SSN",SSN,DFN)) Q:DFN=""  D
"RTN","MPIF002",48,0)
 .I $D(^DPT(DFN)) D
"RTN","MPIF002",49,0)
 ..S LIST=LIST_DFN_"^",CNT=CNT+1
"RTN","MPIF002",50,0)
 ..S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF002",51,0)
 ..S ICN=$P($G(^DPT(DFN,"MPI")),"^")
"RTN","MPIF002",52,0)
 ..I ICN'="",'$D(^DPT("AICN",ICN,DFN)) S ^DPT("AICN",ICN,DFN)=""
"RTN","MPIF002",53,0)
 ..; check if missing AICN x-ref and set if missing
"RTN","MPIF002",54,0)
 I CNT=0 Q "-1^No such SSN"
"RTN","MPIF002",55,0)
 Q LIST
"RTN","MPIF002",56,0)
 ;
"RTN","MPIF002",57,0)
GETICNS(SSN) ;
"RTN","MPIF002",58,0)
 ; Find all ICNs for a given SSN -- all if there are more than one
"RTN","MPIF002",59,0)
 ; patient with that SSN
"RTN","MPIF002",60,0)
 ; SSN - SSN for patient attempted to be found in the Patient file (#2)
"RTN","MPIF002",61,0)
 ; Returned is a list of ICNs for this SSN
"RTN","MPIF002",62,0)
 ;
"RTN","MPIF002",63,0)
 N XX,DFNS,DFN,LIST,ICN,NODE
"RTN","MPIF002",64,0)
 S LIST=""
"RTN","MPIF002",65,0)
 I $G(SSN)'="" S DFNS=$$GETDFNS(SSN)
"RTN","MPIF002",66,0)
 I +DFNS=-1 Q DFNS
"RTN","MPIF002",67,0)
 F XX=1:1 S DFN=$P(DFNS,"^",XX) Q:DFN=""  D
"RTN","MPIF002",68,0)
 .S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIF002",69,0)
 .I +ICN>0 S LIST=LIST_ICN_"^"
"RTN","MPIF002",70,0)
 .I +ICN<0 S NODE=$$MPINODE^MPIFAPI(DFN),ICN=$P(NODE,"^") I ICN'="",'$D(^DPT("AICN",ICN,DFN)) S ^DPT("AICN",ICN,DFN)=""
"RTN","MPIF002",71,0)
 Q LIST
"RTN","MPIF002",72,0)
 ;
"RTN","MPIF002",73,0)
TWODFNS(DFN1,DFN2,ICN) ;
"RTN","MPIF002",74,0)
 ;Logging Exceptions when there are two DFNs trying to have the same
"RTN","MPIF002",75,0)
 ; ICN, which isn't allowed.
"RTN","MPIF002",76,0)
 ;
"RTN","MPIF002",77,0)
 N ARR1,ARR2,NAME1,NAME2,SSN1,SSN2,TEXT
"RTN","MPIF002",78,0)
 I $G(DFN1)=""!($G(DFN2)="") Q
"RTN","MPIF002",79,0)
 I '$D(^DPT(DFN1))!('$D(^DPT(DFN2))) Q
"RTN","MPIF002",80,0)
 D GETDATA^MPIFQ0("^DPT(",DFN1,"MPIFD1",".01;.09","EI")
"RTN","MPIF002",81,0)
 S NAME1=$G(MPIFD1(2,DFN1,.01,"E")),SSN1=$G(MPIFD1(2,DFN1,.09,"E"))
"RTN","MPIF002",82,0)
 D GETDATA^MPIFQ0("^DPT(",DFN2,"MPIFD2",".01;.09","EI")
"RTN","MPIF002",83,0)
 S NAME2=$G(MPIFD2(2,DFN2,.01,"E")),SSN2=$G(MPIFD2(2,DFN2,.09,"E"))
"RTN","MPIF002",84,0)
 D START^RGHLLOG()
"RTN","MPIF002",85,0)
 D EXC^RGHLLOG(227,"Patient DFN="_DFN2_"is trying to be assigned ICN "_ICN_" which is already in use for DFN="_DFN1,DFN2)
"RTN","MPIF002",86,0)
 D STOP^RGHLLOG()
"RTN","MPIF002",87,0)
 ; send format e-mail to RG CIRN DEMOGRAPHICS MAIL GROUP
"RTN","MPIF002",88,0)
 N MPIF,XMDUZ,XMSUB,XMY,XMTEXT
"RTN","MPIF002",89,0)
 S MPIF(1,1)="Multiple ICN Conflict"
"RTN","MPIF002",90,0)
 S MPIF(1,2)=""
"RTN","MPIF002",91,0)
 S MPIF(1,3)="Record for Patient "_NAME2_" SSN= "_SSN2_" DFN= "_DFN2
"RTN","MPIF002",92,0)
 S MPIF(1,4)="returned ICN "_ICN_" which is already in use by Patient"
"RTN","MPIF002",93,0)
 S MPIF(1,5)=NAME1_" SSN= "_SSN1_" DFN= "_DFN1_". This may"
"RTN","MPIF002",94,0)
 S MPIF(1,6)="indicate duplicate patients on your system.  Check pair"
"RTN","MPIF002",95,0)
 S MPIF(1,7)="to determine if a duplicate record exists. If records are"
"RTN","MPIF002",96,0)
 S MPIF(1,8)="found to be duplicates they will need to be merged using"
"RTN","MPIF002",97,0)
 S MPIF(1,9)="the Duplicate Record Merge software."
"RTN","MPIF002",98,0)
 S MPIF(1,10)=""
"RTN","MPIF002",99,0)
 S MPIF(1,11)="Please log a NOIS or contact the MPI Data Quality Management"
"RTN","MPIF002",100,0)
 S MPIF(1,12)="Team if you are unable to resolve the conflict."
"RTN","MPIF002",101,0)
 S XMDUZ="MPI/PD VISTA PACKAGE"
"RTN","MPIF002",102,0)
 S XMSUB="MPI/PD Exception: Multiple ICNs"
"RTN","MPIF002",103,0)
 S XMY("G.RG CIRN DEMOGRAPHIC ISSUES")="",XMTEXT="MPIF(1,"
"RTN","MPIF002",104,0)
 D ^XMD
"RTN","MPIF002",105,0)
 K MPIFD1,MPIFD2
"RTN","MPIF002",106,0)
 Q
"RTN","MPIF002",107,0)
CLEAN(DFN,ARR,MPIRETN) ; clean up MPI data from DPT for "stub" records
"RTN","MPIF002",108,0)
 ; called from UPDATE^MPIFAPI
"RTN","MPIF002",109,0)
 N ICN,CMOR
"RTN","MPIF002",110,0)
 S ICN=+$$GETICN^MPIF001(DFN),CMOR=$$SITE^VASITE()
"RTN","MPIF002",111,0)
 I +ICN<0 S MPIRETN="-1^PT HAS NO ICN" Q
"RTN","MPIF002",112,0)
 I $E(ICN,1,3)'=$P(CMOR,"^",3) S MPIRETN="-1^not a local ICN not cleaned up" Q
"RTN","MPIF002",113,0)
 S CMOR=$P(CMOR,"^",1)
"RTN","MPIF002",114,0)
 S ^DPT(DFN,"MPI")=""
"RTN","MPIF002",115,0)
 K ^DPT("AICNL",1,ICN),^DPT("AICN",ICN),^DPT("ACMOR",CMOR,DFN)
"RTN","MPIF002",116,0)
 S MPIRETN=0
"RTN","MPIF002",117,0)
 Q
"RTN","MPIFAPI")
0^11^B68215248
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14,16,17,21,27,28,33**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ; Integration Agreements Utilized:
"RTN","MPIFAPI",4,0)
 ;   ^DPT( - #2070 and #4079
"RTN","MPIFAPI",5,0)
 ;   ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFAPI",6,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFAPI",7,0)
 ;   $$NCEDIT^DPTNAME - #4116
"RTN","MPIFAPI",8,0)
 ;
"RTN","MPIFAPI",9,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",10,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",11,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",12,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",13,0)
 S MPINUM=0,X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",14,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",15,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",16,0)
 S MPINUM=MPINUM1_"V"_MPICHK,MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",17,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",18,0)
 D ^DIE
"RTN","MPIFAPI",19,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",20,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",21,0)
 Q MPINUM
"RTN","MPIFAPI",22,0)
SETUP ;
"RTN","MPIFAPI",23,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",24,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",25,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",26,0)
 S NUM=SITE_"0000000",CHK=$$CHECKDG^MPIFSPC(NUM),MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",27,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",28,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",29,0)
 K DD,D0
"RTN","MPIFAPI",30,0)
 D FILE^DICN
"RTN","MPIFAPI",31,0)
 K DIC,X,Y
"RTN","MPIFAPI",32,0)
 Q MPINUM
"RTN","MPIFAPI",33,0)
 ;
"RTN","MPIFAPI",34,0)
MPILINK() ;returns MPI logical Link
"RTN","MPIFAPI",35,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",36,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",37,0)
 I '$D(MPIL) Q "-1^NOT DEFINED"
"RTN","MPIFAPI",38,0)
 S MPILINK=$O(MPIL(0))
"RTN","MPIFAPI",39,0)
 I MPILINK="" Q "-1^NOT DEFINED"
"RTN","MPIFAPI",40,0)
 S MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",41,0)
 Q MPILINK
"RTN","MPIFAPI",42,0)
 ;
"RTN","MPIFAPI",43,0)
SUBNUM(DFN) ; returns SCN from MPI node for given DFN
"RTN","MPIFAPI",44,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",45,0)
 ; returns:  -1^error message << always returns.
"RTN","MPIFAPI",46,0)
 ;*** Subscription control numbers no longer exist
"RTN","MPIFAPI",47,0)
 Q "-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",48,0)
 ;
"RTN","MPIFAPI",49,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",50,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",51,0)
 ; returns:  -1^error message or MPI node from patient file
"RTN","MPIFAPI",52,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",53,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",54,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",55,0)
 N NODE S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",56,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",57,0)
 Q NODE
"RTN","MPIFAPI",58,0)
 ;
"RTN","MPIFAPI",59,0)
GETADFN(ICN) ; return DFN ONLY if ICN is the active ICN
"RTN","MPIFAPI",60,0)
 ; ICN - Integration Control Number for patient to be returned
"RTN","MPIFAPI",61,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",62,0)
 ;           DFN - IEN for the patient entry in the Patient file (#2)
"RTN","MPIFAPI",63,0)
 N RETURN,DFN
"RTN","MPIFAPI",64,0)
 I $G(ICN)'>0 Q "-1^NO ICN"
"RTN","MPIFAPI",65,0)
 I '$D(^DPT("AICN",ICN)) Q "-1^ICN NOT IN DATABASE"
"RTN","MPIFAPI",66,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIFAPI",67,0)
 I $G(DFN)'>0 Q "-1^BAD AICN CROSS-REFERENCE"
"RTN","MPIFAPI",68,0)
 I $P($G(^DPT(DFN,"MPI")),"^")'=ICN Q "-1^ICN is not Active one"
"RTN","MPIFAPI",69,0)
 Q DFN
"RTN","MPIFAPI",70,0)
 ;
"RTN","MPIFAPI",71,0)
UPDATE(DFN,ARR,MPISILNT,REMOVE) ;api to edit 'mpi','mpifhis' and 'mpicmor' nodes
"RTN","MPIFAPI",72,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",73,0)
 ;ARR - array in the format listed below
"RTN","MPIFAPI",74,0)
 ; MPI node by passing in ARR(field#)=value
"RTN","MPIFAPI",75,0)
 ;  **NOTE:  991.04 is only edited based on the edit of 991.01
"RTN","MPIFAPI",76,0)
 ;           991.03 should be passed with either "@" or IEN in File 4
"RTN","MPIFAPI",77,0)
 ; MPIFHIS node by passing ARR(992)=old ICN to remove from multiple
"RTN","MPIFAPI",78,0)
 ; MPICMOR node by passing ARR(993)=old CMOR to remove from multiple
"RTN","MPIFAPI",79,0)
 ;MPISILNT(optional) - 0 to not suppress exceptions (default)
"RTN","MPIFAPI",80,0)
 ;                     1 to suppress exceptions
"RTN","MPIFAPI",81,0)
 ;REMOVE (optional) - 0 default - use FM to delete MPI values
"RTN","MPIFAPI",82,0)
 ;    1 to delete outside FM the MPI fields -- should only be used to clean up the stub record's mpi data, including history for icn and cmor
"RTN","MPIFAPI",83,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",84,0)
 ;          0 if successfully updated fields
"RTN","MPIFAPI",85,0)
 ;
"RTN","MPIFAPI",86,0)
 N MPIRETN,MPIX,VALUE,ICN,SCN,ICN2
"RTN","MPIFAPI",87,0)
 I DFN'>0 Q "-1^DFN passed into UPDATE^MPIFAPI not greater than 0"
"RTN","MPIFAPI",88,0)
 Q:'$D(^DPT(DFN,0)) "-1^DFN "_DFN_" does not exist"
"RTN","MPIFAPI",89,0)
 S MPIRETN=0,RGRSICN=""
"RTN","MPIFAPI",90,0)
 F  L +^DPT("MPI",DFN):10 Q:$T
"RTN","MPIFAPI",91,0)
 I $D(REMOVE) D CLEAN^MPIF002(DFN,.ARR,.MPIRETN) L -^DPT("MPI",DFN) Q MPIRETN
"RTN","MPIFAPI",92,0)
 I $D(@ARR@(991.01)) D
"RTN","MPIFAPI",93,0)
 .I '$D(@ARR@(991.02)) S MPIRETN="-1^ICN "_ICN_", passed without checksum" Q
"RTN","MPIFAPI",94,0)
 .;quit if local is going to overwrite national
"RTN","MPIFAPI",95,0)
 .S ICN=+$$GETICN^MPIF001(DFN) I ICN>0 I $E(@ARR@(991.01),1,3)=$P($$SITE^VASITE(),"^",3),$E(ICN,1,3)'=$E(@ARR@(991.01),1,3) S MPIRETN="-1^Overwriting the National ICN, "_ICN_", with a local, "_@ARR@(991.01)_", isn't allowed" Q
"RTN","MPIFAPI",96,0)
 .; quit if ICN has already been assigned to another patient in your data base
"RTN","MPIFAPI",97,0)
 .S ICN2=@ARR@(991.01)
"RTN","MPIFAPI",98,0)
 .I $D(^DPT("AICN",ICN2)),DFN'=$O(^DPT("AICN",ICN2,"")) D
"RTN","MPIFAPI",99,0)
 ..I DFN'=($O(^DPT("AICN",ICN2,""))) D 
"RTN","MPIFAPI",100,0)
 ..N RGLOG D START^RGHLLOG(0)
"RTN","MPIFAPI",101,0)
 ..D EXC^RGHLLOG(227,"Pt dfn "_DFN_"returned ICN "_ICN_" that's already in use for Pt dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if Duplicate.",DFN)
"RTN","MPIFAPI",102,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFAPI",103,0)
 ..S MPIRETN="-1^ICN "_ICN2_" is already in use for pt DFN "_DFN
"RTN","MPIFAPI",104,0)
 .Q:+MPIRETN=-1
"RTN","MPIFAPI",105,0)
 .K FDA S FDA(1,2,DFN_",",991.01)=@ARR@(991.01)
"RTN","MPIFAPI",106,0)
 .K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to update pt's ICN (DFN="_DFN_") ICN to "_@ARR@(991.01)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",107,0)
 .I +MPIRETN'=0 Q
"RTN","MPIFAPI",108,0)
 .K FDA S FDA(1,2,DFN_",",991.02)=@ARR@(991.02)
"RTN","MPIFAPI",109,0)
 .K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to update pt's ("_DFN_") ICN Checksum to "_@ARR@(991.02)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",110,0)
 .I +MPIRETN'=0 Q
"RTN","MPIFAPI",111,0)
 .K FDA S FDA(1,2,DFN_",",991.04)="@"
"RTN","MPIFAPI",112,0)
 .K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_" LOCALLY ASSIGNED ICN field because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",113,0)
 I MPIRETN=0 I $D(@ARR@(991.03)) D
"RTN","MPIFAPI",114,0)
 .I @ARR@(991.03)="@" K FDA S FDA(1,2,DFN_",",991.03)="@"
"RTN","MPIFAPI",115,0)
 .I @ARR@(991.03)'="@" I @ARR@(991.03)>0 I $$STA^XUAF4(@ARR@(991.03))'="" S FDA(1,2,DFN_",",991.03)="`"_@ARR@(991.03)
"RTN","MPIFAPI",116,0)
 .D FILE^DIE("E","FDA(1)","MPIERR") I $D(MPIERR("DIERR")) D
"RTN","MPIFAPI",117,0)
 ..S MPIRETN="-1^Unable to update pt's ("_DFN_") CMOR to "_@ARR@(991.03)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",118,0)
 ..I +$G(MPISILNT)=0 N RGLOG D START^RGHLLOG(0) D EXC^RGHLLOG(221,"Unable to update CMOR to "_@ARR@(991.03)_" for DFN="_DFN,DFN) D STOP^RGHLLOG(0)
"RTN","MPIFAPI",119,0)
 I MPIRETN=0 I $D(@ARR@(991.05)) D
"RTN","MPIFAPI",120,0)
 .I @ARR@(991.05)="@" D
"RTN","MPIFAPI",121,0)
 ..S SCN=$$SUBNUM(DFN),DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA
"RTN","MPIFAPI",122,0)
 ..S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI",123,0)
 ..K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI",124,0)
 .I @ARR@(991.05)'="@" D
"RTN","MPIFAPI",125,0)
 ..;do edit and return result
"RTN","MPIFAPI",126,0)
 ..S DIE="^DPT(",DA=DFN,DR="991.05///^S X=@ARR@(991.05)" D ^DIE
"RTN","MPIFAPI",127,0)
 I MPIRETN=0 I $D(@ARR@(992)) D
"RTN","MPIFAPI",128,0)
 .;delete old value from history multiple
"RTN","MPIFAPI",129,0)
 .S MPIX=0 F  S MPIX=$O(^DPT(DFN,"MPIFHIS",MPIX)) Q:'MPIX  S VALUE=^DPT(DFN,"MPIFHIS",MPIX,0) I $P(VALUE,"^")=@ARR@(992) D
"RTN","MPIFAPI",130,0)
 ..K ^DPT("AICN",@ARR@(992),DFN),MPIERR,FDA
"RTN","MPIFAPI",131,0)
 ..S FDA(1,2.0992,MPIX_","_DFN_",",.01)="@" D FILE^DIE("","FDA(1)","MPIERR")
"RTN","MPIFAPI",132,0)
 ..I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_")  ICN "_@ARR@(992)_" from ICN HISTORY because "_MPIERR("DIERR",1,"TEXT",1) K MPIERR,FDA
"RTN","MPIFAPI",133,0)
 I MPIRETN=0 I $D(@ARR@(993)) D
"RTN","MPIFAPI",134,0)
 .;delete old value from history multiple
"RTN","MPIFAPI",135,0)
 .S MPIX=0 F  S MPIX=$O(^DPT(DFN,"MPICMOR",MPIX)) Q:'MPIX  S VALUE=^DPT(DFN,"MPICMOR",MPIX,0) I $P(VALUE,"^")=@ARR@(993) D
"RTN","MPIFAPI",136,0)
 ..K FDA,MPIERR S FDA(1,2.0993,MPIX_","_DFN_",",.01)="@" D FILE^DIE("","FDA(1)","MPIERR")
"RTN","MPIFAPI",137,0)
 ..I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_") CMOR "_@ARR@(993)_" from CMOR HISTORY because "_MPIERR("DIERR",1,"TEXT",1) K MPIERR,FDA
"RTN","MPIFAPI",138,0)
 K ^DPT("AMPIMIS",DFN),RGRSICN
"RTN","MPIFAPI",139,0)
 L -^DPT("MPI",DFN)
"RTN","MPIFAPI",140,0)
 Q MPIRETN
"RTN","MPIFAPI",141,0)
 ;
"RTN","MPIFAPI",142,0)
MPIQ(DFN) ;MPI QUERY
"RTN","MPIFAPI",143,0)
 L +^DPT(DFN):2 I '$T,'$D(MPIFS) W $C(7),!!,"Patient is being edited. No attempt will be made to connect to the MPI." H 2 Q
"RTN","MPIFAPI",144,0)
 I '$D(MPIFS) D  ;Not from SmartCard background job, so ask fields.
"RTN","MPIFAPI",145,0)
 .W !!,"Please verify or update the following information:",!
"RTN","MPIFAPI",146,0)
 .S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",147,0)
 .I $G(DGNEW)=1 S DR=".2403;.092;.093;1",DR(2,2.01)=".01" D ^DIE K DIE,DA,DR Q
"RTN","MPIFAPI",148,0)
 .I $G(DGNEW)="" D  ;existing patient
"RTN","MPIFAPI",149,0)
 ..S MPIFBFR=$$GET1^DIQ(2,+DFN_",",.01)
"RTN","MPIFAPI",150,0)
 ..S DR=".01" D ^DIE K DIE,DA,DR ;prompt for name 
"RTN","MPIFAPI",151,0)
 ..S MPIFAFT=$$GET1^DIQ(2,+DFN_",",.01)
"RTN","MPIFAPI",152,0)
 ..I MPIFBFR'=MPIFAFT D  ;if name has been edited
"RTN","MPIFAPI",153,0)
 ...S X="DPTNAME" X ^%ZOSF("TEST") I $T D
"RTN","MPIFAPI",154,0)
 ....K MPIF20,MPIFNV S DIE="^DPT(",DA=DFN,DR=".01///^S (X,MPIFNV)=$$NCEDIT^DPTNAME(DA,1,.MPIF20)" D ^DIE K DIE,DA,DR,MPIF20,MPIFNV
"RTN","MPIFAPI",155,0)
 ..S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",156,0)
 ..S DR=".03;.02;.09;994;.2403;.092;.093;1",DR(2,2.01)=".01"
"RTN","MPIFAPI",157,0)
 ..D ^DIE K DIE,DA,DR,MPIFBFR,MPIFAFT
"RTN","MPIFAPI",158,0)
 L -^DPT(DFN)
"RTN","MPIFAPI",159,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFAPI",160,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",161,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",162,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",163,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",164,0)
 .N ICN,ERR
"RTN","MPIFAPI",165,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",166,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",167,0)
 .S ERR=$$SETICN^MPIF001(DFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",168,0)
 .Q:+ERR=-1
"RTN","MPIFAPI",169,0)
 .; ^ couldn't set ICN don't set other fields
"RTN","MPIFAPI",170,0)
 .S ERR=$$SETLOC^MPIF001(DFN,1),ERR=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",171,0)
 K MPIFRTN,ZTREQ
"RTN","MPIFAPI",172,0)
 Q
"RTN","MPIFAPI",173,0)
MPIQQ(PDFN) ; Entry point for queuing d/c
"RTN","MPIFAPI",174,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",175,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",176,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",177,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",178,0)
 S ZTSAVE("PDFN")=PDFN,ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",179,0)
 ; ^ silent flag
"RTN","MPIFAPI",180,0)
 S ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",181,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",182,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFAPI",183,0)
 N TSK S TSK=ZTSK
"RTN","MPIFAPI",184,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",185,0)
 Q TSK
"RTN","MPIFBT1")
0^13^B34877706
"RTN","MPIFBT1",1,0)
MPIFBT1 ;SLC/ARS/SFCIO/CMC-BATCH QUERY TO MPI ;FEB 4, 1997
"RTN","MPIFBT1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**17,28,33**;30 Apr 99
"RTN","MPIFBT1",3,0)
 ;
"RTN","MPIFBT1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT1",5,0)
 ;  EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFBT1",6,0)
 ;  ^DPT("ACMORS" - #2070
"RTN","MPIFBT1",7,0)
 ;  ^RGSITE(991.8,1,"CMOR" - #2746
"RTN","MPIFBT1",8,0)
 ;
"RTN","MPIFBT1",9,0)
GOBKG ;
"RTN","MPIFBT1",10,0)
 K STOP
"RTN","MPIFBT1",11,0)
 ;make sure only one job will run
"RTN","MPIFBT1",12,0)
 L +^XTMP("MPIF BATCH LOAD"):3 E  W !,"JOB ALREADY RUNNING" Q
"RTN","MPIFBT1",13,0)
 ;
"RTN","MPIFBT1",14,0)
 I '$D(^RGSITE(991.8,1,"CMOR")) W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",15,0)
 I $D(^RGSITE(991.8,1,"CMOR")),$P($G(^RGSITE(991.8,1,"CMOR")),"^",7)'="SN" W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",16,0)
 ;
"RTN","MPIFBT1",17,0)
 ;Check to see if job had STOPed -start where left off, start over or quit
"RTN","MPIFBT1",18,0)
 I $P($G(^MPIF(984.8,1,0)),"^",6)'="" D AGAIN
"RTN","MPIFBT1",19,0)
 I $D(STOP) W !,"Job NOT Started" K STOP G EXIT
"RTN","MPIFBT1",20,0)
 D BEG
"RTN","MPIFBT1",21,0)
 I $D(STOP) K STOP G EXIT
"RTN","MPIFBT1",22,0)
 S ZTRTN="GO^MPIFBT1",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFBT1",23,0)
 S ZTIO="",ZTDTH=START
"RTN","MPIFBT1",24,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFBT1",25,0)
 I $D(ORDER) S ZTSAVE("ORDER")=ORDER
"RTN","MPIFBT1",26,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"TASK #: ",ZTSK
"RTN","MPIFBT1",27,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFBT1",28,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,ORDER,START,ENDT
"RTN","MPIFBT1",29,0)
 Q
"RTN","MPIFBT1",30,0)
EXIT ;
"RTN","MPIFBT1",31,0)
 L -^XTMP("MPIF BATCH LOAD")
"RTN","MPIFBT1",32,0)
 Q
"RTN","MPIFBT1",33,0)
 ;
"RTN","MPIFBT1",34,0)
BEG K DIR,DIE,DR,DA,X,Y
"RTN","MPIFBT1",35,0)
 S DIR(0)="D^::AEFT",DIR("B")="NOW",DIR("A")="START TIME"
"RTN","MPIFBT1",36,0)
 D ^DIR
"RTN","MPIFBT1",37,0)
 I $D(DTOUT)!($D(DUOUT)) W !,"Job NOT Scheduled" K DTOUT,DUOUT,DIR,DA,X,Y S STOP="" Q
"RTN","MPIFBT1",38,0)
 S START=Y
"RTN","MPIFBT1",39,0)
 D DD^%DT
"RTN","MPIFBT1",40,0)
 S ENDT=Y
"RTN","MPIFBT1",41,0)
TRY K DIR,DIE,DR,DA,X,Y
"RTN","MPIFBT1",42,0)
 S DIR(0)="D^::AEFT",DIR("B")=ENDT,DIR("A")="STOP TIME"
"RTN","MPIFBT1",43,0)
 D ^DIR
"RTN","MPIFBT1",44,0)
 I $D(DTOUT)!($D(DUOUT)) W !,"Job NOT Scheduled" K DTOUT,DUOUT,DIR,DA,X,Y S STOP="" Q
"RTN","MPIFBT1",45,0)
 I Y'>START W !,"Stop Time must be greater than Start Time" G TRY
"RTN","MPIFBT1",46,0)
 D DD^%DT
"RTN","MPIFBT1",47,0)
 S ENDT=Y
"RTN","MPIFBT1",48,0)
 K DIR,DIE,DR,DA,X,Y
"RTN","MPIFBT1",49,0)
 S DIE="^MPIF(984.8,",DR="9///"_ENDT,DA=1 D ^DIE
"RTN","MPIFBT1",50,0)
 K DIE,X,Y,DA,DR
"RTN","MPIFBT1",51,0)
 I $D(DTOUT)!($D(DUOUT)) W !,"Job NOT Scheduled" K DTOUT,DUOUT,DIR,DA,X,Y S STOP="" Q
"RTN","MPIFBT1",52,0)
 Q
"RTN","MPIFBT1",53,0)
 ;
"RTN","MPIFBT1",54,0)
GO ;ENTRY POINT
"RTN","MPIFBT1",55,0)
 I '$D(ZTQUEUED) L +^XTMP("MPIF BATCH LOAD"):3 E  W !,"JOB ALREADY RUNNING" Q
"RTN","MPIFBT1",56,0)
 I '$D(ZTQUEUED),('$D(^RGSITE(991.8,1,"CMOR"))) W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",57,0)
 I '$D(ZTQUEUED),$D(^RGSITE(991.8,1,"CMOR")),$P($G(^RGSITE(991.8,1,"CMOR")),"^",7)'="SN" W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",58,0)
 K STOP
"RTN","MPIFBT1",59,0)
 ;Check to see if job had STOPed-start where left off, start over or quit
"RTN","MPIFBT1",60,0)
 I '$D(ZTQUEUED),$P($G(^MPIF(984.8,1,0)),"^",6)'="" D AGAIN
"RTN","MPIFBT1",61,0)
 I $D(STOP) W !,"Job NOT Started" K STOP G EXIT
"RTN","MPIFBT1",62,0)
 I '$D(ZTQUEUED) D BEG
"RTN","MPIFBT1",63,0)
 I $D(STOP) K STOP G EXIT
"RTN","MPIFBT1",64,0)
GO1 K ^TMP("HLS",$J)
"RTN","MPIFBT1",65,0)
 N MPIMORE,MPITOT
"RTN","MPIFBT1",66,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFBT1",67,0)
 S QUITIME=$P(^MPIF(984.8,1,0),"^",10)
"RTN","MPIFBT1",68,0)
 I '$D(ORDER) S ORDER=0
"RTN","MPIFBT1",69,0)
 ;
"RTN","MPIFBT1",70,0)
 K ^TMP("HLS",$J)
"RTN","MPIFBT1",71,0)
 S MPICNT=$S($P(^MPIF(984.8,1,0),"^",9)>1:$P(^MPIF(984.8,1,0),"^",9),1:1)
"RTN","MPIFBT1",72,0)
 I +ORDER<1 S ORDER=0
"RTN","MPIFBT1",73,0)
 D WORK
"RTN","MPIFBT1",74,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFBT1",75,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFBT1",76,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIMIDT,MPIMSH
"RTN","MPIFBT1",77,0)
 K MPIOUT,MPIQRYNM,MPISEQ,ORDER,QCNT,QUITIME,MPIMCNT,MPIMTX,ORDER,START
"RTN","MPIFBT1",78,0)
 K ENDT
"RTN","MPIFBT1",79,0)
 L -^XTMP("MPIF BATCH LOAD")
"RTN","MPIFBT1",80,0)
 Q
"RTN","MPIFBT1",81,0)
WORK ;
"RTN","MPIFBT1",82,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",83,0)
 D NOW^%DTC
"RTN","MPIFBT1",84,0)
 S $P(^MPIF(984.8,1,0),"^",2)=%
"RTN","MPIFBT1",85,0)
 I %>QUITIME Q
"RTN","MPIFBT1",86,0)
 S MPIMCNT="",MPIMTX=""
"RTN","MPIFBT1",87,0)
 D HLRDF,LOOP
"RTN","MPIFBT1",88,0)
 Q
"RTN","MPIFBT1",89,0)
 ;
"RTN","MPIFBT1",90,0)
HLRDF ;
"RTN","MPIFBT1",91,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFBT1",92,0)
 S HL("ECH")="^~\&"
"RTN","MPIFBT1",93,0)
 S HL("FS")="|"
"RTN","MPIFBT1",94,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.HL)
"RTN","MPIFBT1",95,0)
 I $O(HL("")) S ^TMP($J,"MPIF","ERR")=HL
"RTN","MPIFBT1",96,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFBT1",97,0)
 D START^RGHLLOG()
"RTN","MPIFBT1",98,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",99,0)
 S $P(^MPIF(984.8,1,0),"^",7)=MPIMCNT
"RTN","MPIFBT1",100,0)
 S $P(^MPIF(984.8,1,0),"^",8)=MPIMTX
"RTN","MPIFBT1",101,0)
 Q
"RTN","MPIFBT1",102,0)
LOOP ;
"RTN","MPIFBT1",103,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",104,0)
 S MPIDNUM=1
"RTN","MPIFBT1",105,0)
 D MAKE
"RTN","MPIFBT1",106,0)
 Q
"RTN","MPIFBT1",107,0)
SEND ;ready to send
"RTN","MPIFBT1",108,0)
 S $P(^MPIF(984.8,1,0),"^",5)="GENERATE TAG"
"RTN","MPIFBT1",109,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFBT1",110,0)
 I +MPIEROR=0 S ^TMP($J,"MPIF","ERR")=MPIEROR
"RTN","MPIFBT1",111,0)
 D NOW^%DTC
"RTN","MPIFBT1",112,0)
 S $P(^MPIF(984.8,1,0),"^",3)=%
"RTN","MPIFBT1",113,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFBT1",114,0)
 K ^TMP("HLS",$J)
"RTN","MPIFBT1",115,0)
 Q
"RTN","MPIFBT1",116,0)
MAKE ;
"RTN","MPIFBT1",117,0)
 F  S ORDER=$O(^DPT("ACMORS",ORDER)) Q:ORDER=""!($P(^MPIF(984.8,1,0),"^",6)="STOP")  D
"RTN","MPIFBT1",118,0)
 .S MPIIT=0
"RTN","MPIFBT1",119,0)
 .F  S MPIIT=$O(^DPT("ACMORS",ORDER,MPIIT)) Q:MPIIT=""!($P(^MPIF(984.8,1,0),"^",6)="STOP")  D
"RTN","MPIFBT1",120,0)
 ..D MAKE3
"RTN","MPIFBT1",121,0)
 ..D NOW^%DTC
"RTN","MPIFBT1",122,0)
 ..I %>QUITIME S $P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",123,0)
 Q
"RTN","MPIFBT1",124,0)
MAKE3 ;
"RTN","MPIFBT1",125,0)
 K MPIOUT
"RTN","MPIFBT1",126,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",127,0)
 S $P(^MPIF(984.8,1,0),"^",5)="LOOPING: "_MPIDNUM
"RTN","MPIFBT1",128,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFBT1",129,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.HL,.MPIQRYNM)
"RTN","MPIFBT1",130,0)
 I $P(MPIOUT(0),"^",1)<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFBT1",131,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFBT1",132,0)
 ;I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" D EXC^RGHLLOG(209,"DFN - "_MPIIT_" Missing Required Field(s)",MPIIT) Q
"RTN","MPIFBT1",133,0)
 Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFBT1",134,0)
 ;call for HL7 header
"RTN","MPIFBT1",135,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFBT1",136,0)
 D MSH^HLFNC2(.HL,MPIMIDT,.MPIMSH)
"RTN","MPIFBT1",137,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFBT1",138,0)
 ;MESSAGE BUILT
"RTN","MPIFBT1",139,0)
 S MPISEQ=0
"RTN","MPIFBT1",140,0)
 F  S MPISEQ=$O(MPIOUT(MPISEQ)) Q:MPISEQ'>0  D
"RTN","MPIFBT1",141,0)
 .S ^TMP("HLS",$J,MPICNT)=MPIOUT(MPISEQ)
"RTN","MPIFBT1",142,0)
 .S MPICNT=MPICNT+1
"RTN","MPIFBT1",143,0)
 S $P(^MPIF(984.8,1,0),"^",11)=ORDER
"RTN","MPIFBT1",144,0)
 S $P(^MPIF(984.8,1,0),"^",9)=MPICNT
"RTN","MPIFBT1",145,0)
 S $P(^MPIF(984.8,1,0),"^",4)=MPIIT
"RTN","MPIFBT1",146,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFBT1",147,0)
 I MPIDNUM>100 D
"RTN","MPIFBT1",148,0)
 .D SEND
"RTN","MPIFBT1",149,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFBT1",150,0)
 .D HLRDF
"RTN","MPIFBT1",151,0)
 Q
"RTN","MPIFBT1",152,0)
 ;
"RTN","MPIFBT1",153,0)
AGAIN ;job started before
"RTN","MPIFBT1",154,0)
 W !,"Job was started before and has Stopped"
"RTN","MPIFBT1",155,0)
 K DIR,DR
"RTN","MPIFBT1",156,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Begin Where Left Off? ",DIR("?")="Y for yes to start where job left off, N for no"
"RTN","MPIFBT1",157,0)
 D ^DIR
"RTN","MPIFBT1",158,0)
 I Y=1 S ORDER=$P(^MPIF(984.8,1,0),"^",11),$P(^MPIF(984.8,1,0),"^",6)="" G END
"RTN","MPIFBT1",159,0)
 ;job started but used doesn't want to start where job left off
"RTN","MPIFBT1",160,0)
 W !,"'E' - Exit or 'O' - Start over from the Beginning"
"RTN","MPIFBT1",161,0)
 K DIR,DR
"RTN","MPIFBT1",162,0)
 S DIR(0)="S^E:EXIT;O:OVER",DIR("?")="E for Exit, O to Start Over from the Beginning"
"RTN","MPIFBT1",163,0)
 S DIR("A")="What would you like to do?"
"RTN","MPIFBT1",164,0)
 D ^DIR
"RTN","MPIFBT1",165,0)
 S:Y="E" STOP=""
"RTN","MPIFBT1",166,0)
 S:Y="O" ORDER=0,$P(^MPIF(984.8,1,0),"^",6)=""
"RTN","MPIFBT1",167,0)
END ;
"RTN","MPIFBT1",168,0)
 K DIR,Y,DR,X
"RTN","MPIFBT1",169,0)
 ; wants to start over or from where job left off if '$d(stop)
"RTN","MPIFBT1",170,0)
 Q
"RTN","MPIFBT3")
0^10^B38598569
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21,24,28,31,33**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;
"RTN","MPIFBT3",10,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",11,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",12,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",13,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",14,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",15,0)
 Q
"RTN","MPIFBT3",16,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",17,0)
 N MPIY,IEN,MPICMOR,MPICOMP S DGSENFLG=""
"RTN","MPIFBT3",18,0)
 S MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFBT3",19,0)
 D RDT^MPIFSA3(.CNTR,.HL,.ACK4)
"RTN","MPIFBT3",20,0)
 D FINDHM(PATID,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",21,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",22,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF,RESLT
"RTN","MPIFBT3",23,0)
 S MPINUM=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",24,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",25,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",26,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",27,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",28,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient "_$O(^DPT("AICN",MPINUM,""))_".  Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",29,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",30,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",31,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",32,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",33,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",34,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",35,0)
 S MPIIPPF=""
"RTN","MPIFBT3",36,0)
 S MPIPPF=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",37,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",38,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",39,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",40,0)
 I $D(^TMP("MPIFVQQ",$J,CNTR,"TF")) D
"RTN","MPIFBT3",41,0)
 . N MPINTFI,MPINTF,TFSTRG,TFIEN
"RTN","MPIFBT3",42,0)
 . S MPINTFI=0,MPINTF="",TFIEN="",TFSTRG=""
"RTN","MPIFBT3",43,0)
 . F  S MPINTFI=$O(^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)) Q:'MPINTFI  D
"RTN","MPIFBT3",44,0)
 .. S MPINTF=^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)
"RTN","MPIFBT3",45,0)
 .. S TFIEN=$$IEN^XUAF4($P(MPINTF,MPICOMP,1))
"RTN","MPIFBT3",46,0)
 .. Q:'TFIEN
"RTN","MPIFBT3",47,0)
 .. S TFSTRG=TFIEN_"^"_$$FMDATE^HLFNC($P(MPINTF,MPICOMP,2))_"^"_$P(MPINTF,MPICOMP,3)
"RTN","MPIFBT3",48,0)
 .. D FILE^VAFCTFU(PATID,TFSTRG,1)
"RTN","MPIFBT3",49,0)
 S RESLT=$$A24^MPIFA24B(PATID)
"RTN","MPIFBT3",50,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_PATID,PATID)
"RTN","MPIFBT3",51,0)
 K RESLT N RESLT
"RTN","MPIFBT3",52,0)
 S RESLT=$$A31^MPIFA31B(PATID)
"RTN","MPIFBT3",53,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A31 for DFN= "_PATID,PATID)
"RTN","MPIFBT3",54,0)
 K ^TMP("MPIFVQQ",$J)
"RTN","MPIFBT3",55,0)
 Q
"RTN","MPIFBT3",56,0)
FINDHM(PATID,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",57,0)
 N DIC,X,Y,NM,YTMP,MPIN
"RTN","MPIFBT3",58,0)
 Q:'$D(^TMP("MPIFVQQ",$J,CNTR,"DATA"))
"RTN","MPIFBT3",59,0)
 ;added I to DIC(0) allow processing of sensitive patients when DUZ=0
"RTN","MPIFBT3",60,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC
"RTN","MPIFBT3",61,0)
 S YTMP=Y
"RTN","MPIFBT3",62,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",63,0)
 Q:YTMP=-1
"RTN","MPIFBT3",64,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",65,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",66,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",67,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",68,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",69,0)
 ;;;Q:$P(Y(0),"^",9)["P"&($P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)="")
"RTN","MPIFBT3",70,0)
 I $P(Y(0),"^",9)'=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3) D
"RTN","MPIFBT3",71,0)
 .Q:$P(Y(0),"^",9)["P"&($P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)="")
"RTN","MPIFBT3",72,0)
 .S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",73,0)
 .D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",74,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",75,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",76,0)
 D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",77,0)
 S MPIN=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",2)_","_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",7)
"RTN","MPIFBT3",78,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)
"RTN","MPIFBT3",79,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)
"RTN","MPIFBT3",80,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)
"RTN","MPIFBT3",81,0)
 D NAME^VAFCPID2(0,.MPIN,0)
"RTN","MPIFBT3",82,0)
 I NM'=MPIN D
"RTN","MPIFBT3",83,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",84,0)
 .D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",85,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",86,0)
 ;check to see if SEX on MPI and local site match - no exception
"RTN","MPIFBT3",87,0)
 I $P($G(^DPT(PATID,0)),"^",2)'=$P($G(^TMP("MPIFVQQ",$J,CNTR,"DATA")),"^",11) D
"RTN","MPIFBT3",88,0)
 .S ^XTMP($J,"MPIF","MSHERR")="SEX MISMATCH"
"RTN","MPIFBT3",89,0)
 .D EXC^RGHLLOG(209,"PT on MPI "_MPIN_" has gender as "_$P($G(^TMP("MPIFVQQ",$J,CNTR,"DATA")),"^",10)_" While the Patient DFN= "_PATID_" has "_$P($G(^DPT(PATID,0)),"^",2)_" msg # "_MPIMSG_" about line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",90,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",91,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",92,0)
 N MPIDTH,VISTDTH K %DT
"RTN","MPIFBT3",93,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9)'="" S X=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9) D ^%DT S MPIDTH=Y
"RTN","MPIFBT3",94,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",95,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",96,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",97,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",98,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",99,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",100,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",101,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",102,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",103,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",104,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",105,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",106,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",107,0)
 Q
"RTN","MPIFP33")
0^12^B4547615
"RTN","MPIFP33",1,0)
MPIFP33 ;ALB/CMC-MPIF*1*33 PATCH POST INSTALL ROUTINE ;03/08/04
"RTN","MPIFP33",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**33**;30 Apr 99
"RTN","MPIFP33",3,0)
 ;
"RTN","MPIFP33",4,0)
 ;Update exception text 209 to be more generic and
"RTN","MPIFP33",5,0)
 ;delete mail group field for exception 227
"RTN","MPIFP33",6,0)
POST ;
"RTN","MPIFP33",7,0)
 D MES^XPDUTL("     >>> Removing the MAIL GROUP from exception 227")
"RTN","MPIFP33",8,0)
 D MES^XPDUTL("         in the CIRN HL7 EXCEPTION TYPE (#991.11) file.")
"RTN","MPIFP33",9,0)
 N DIE,DIC,DR,DA,Y,X,IEN
"RTN","MPIFP33",10,0)
 S IEN=$O(^RGHL7(991.11,"B",227,""))
"RTN","MPIFP33",11,0)
 I +IEN<0 D MES^XPDUTL("  >>> No entry exists for exception type 227.  Please log a NOIS for assistance.") D NEXT Q
"RTN","MPIFP33",12,0)
 ;
"RTN","MPIFP33",13,0)
 L +^RGHL7(991.11,IEN):10
"RTN","MPIFP33",14,0)
 S DA=IEN,DIE="^RGHL7(991.11,",DR="6///@"
"RTN","MPIFP33",15,0)
 D ^DIE
"RTN","MPIFP33",16,0)
 L -^RGHL7(991.11,IEN)
"RTN","MPIFP33",17,0)
 K IEN
"RTN","MPIFP33",18,0)
NEXT ;
"RTN","MPIFP33",19,0)
 D MES^XPDUTL("")
"RTN","MPIFP33",20,0)
 D MES^XPDUTL("     >>> Updating exception text for exception 209 in the")
"RTN","MPIFP33",21,0)
 D MES^XPDUTL("         CIRN HL7 EXCEPTION TYPE (#991.11) file to be more generic.")
"RTN","MPIFP33",22,0)
 S IEN=$O(^RGHL7(991.11,"B",209,""))
"RTN","MPIFP33",23,0)
 I +IEN<0 D MES^XPDUTL("  >>> No entry exists for exception type 209.  Please log a NOIS for assistance.") Q
"RTN","MPIFP33",24,0)
 ;
"RTN","MPIFP33",25,0)
 L +^RGHL7(991.11,IEN):10
"RTN","MPIFP33",26,0)
 S DA=IEN,DIE="^RGHL7(991.11,",DR="10///Required field(s) missing for patient sent to MPI"
"RTN","MPIFP33",27,0)
 D ^DIE
"RTN","MPIFP33",28,0)
 S ^TMP("MPIFWP",1)="Required fields: Name, date of birth, sex or SSN"
"RTN","MPIFP33",29,0)
 S ^TMP("MPIFWP",2)="are missing for the patient sent to the MPI for ICN assignment."
"RTN","MPIFP33",30,0)
 D WP^DIE(991.11,IEN,99,,"^TMP(""MPIFWP"")")
"RTN","MPIFP33",31,0)
 K ^TMP("MPIFWP")
"RTN","MPIFP33",32,0)
 L -^RGHL7(991.11,IEN)
"RTN","MPIFP33",33,0)
 Q
"RTN","MPIFQ0")
0^5^B65454705
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17,21,20,24,26,28,31,33**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",9,0)
 ;
"RTN","MPIFQ0",10,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",11,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",12,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",13,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",14,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W:'$D(MPIFRPC) !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",15,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",16,0)
 W:'$D(MPIFRPC) !
"RTN","MPIFQ0",17,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",18,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",19,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",20,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",21,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",22,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",23,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",24,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",25,0)
 G JUMP
"RTN","MPIFQ0",26,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",27,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",28,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",29,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",30,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",31,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",32,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",33,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC,SSN
"RTN","MPIFQ0",34,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",35,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",36,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",37,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",38,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM) ; **33 remove field list to get all now
"RTN","MPIFQ0",39,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",40,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",41,0)
 ;Create MSH
"RTN","MPIFQ0",42,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",43,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",44,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",45,0)
 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",46,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",47,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",48,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",49,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",50,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",51,0)
 .D LOCAL^MPIFQ3(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",52,0)
 K ^TMP("MPIFVQQ",$J),^TMP("MPIFQ0",$J) ;array data is parsed into for display in LM
"RTN","MPIFQ0",53,0)
INIPARS ;
"RTN","MPIFQ0",54,0)
 N SEG,INDEX,SKIP,CHECK,AL,TTF2,TFLL,TF,TF2,MPIREP,MPICOMP
"RTN","MPIFQ0",55,0)
 S INDEX=0 K CHECK
"RTN","MPIFQ0",56,0)
LOOP1 ;
"RTN","MPIFQ0",57,0)
 ;process in ADT type messages
"RTN","MPIFQ0",58,0)
 N MPIX S MPIX=0 N REP,SG,MSG,MPIQUIT,MPINODE
"RTN","MPIFQ0",59,0)
 K TWODFN S MPIQUIT=0
"RTN","MPIFQ0",60,0)
 F MPIX=0:1 X "D LOOP2" D  K MPINODE,MSG Q:MPIQUIT'>0
"RTN","MPIFQ0",61,0)
 . I $D(MPINODE(1)) S SG=$E(MPINODE(1),1,3) S MSG(1)=MPINODE(1) D
"RTN","MPIFQ0",62,0)
 .. S MPIJ=1 F  S MPIJ=$O(MPINODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=MPINODE(MPIJ)
"RTN","MPIFQ0",63,0)
 .. D:SG?2A1(1A,1N) @SG
"RTN","MPIFQ0",64,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI w/VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",65,0)
 N EXC,TEXT,EXACT,EXACT2
"RTN","MPIFQ0",66,0)
 I '$D(^TMP("MPIFVQQ",$J)) D  G EXIT
"RTN","MPIFQ0",67,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",68,0)
 .D A28^MPIFQ3(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",69,0)
 ;If INDEX=1 it means we got 1 match check SSN see if definitely same pt
"RTN","MPIFQ0",70,0)
 I (INDEX=1)&(TSSN=SSN) D  G EXIT
"RTN","MPIFQ0",71,0)
 .N CCMOR,ICN,DATA,TICN,SNM,SNM2,IEN
"RTN","MPIFQ0",72,0)
 .S DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA"),CMOR=$P(DATA,"^",5),ICN=$P(DATA,"^",6),IEN=$$IEN^XUAF4(CMOR)
"RTN","MPIFQ0",73,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",74,0)
 .S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",75,0)
 .I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a duplicate.",DFN)
"RTN","MPIFQ0",76,0)
 .I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",77,0)
 .; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",78,0)
 .S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",79,0)
 .S SNM2=$P(DATA,"^") D NAME^VAFCPID2(0,.SNM2,0) S $P(DATA,"^")=SNM2
"RTN","MPIFQ0",80,0)
 .I $P($G(^DPT(DFN,0)),"^",2)'=$P(DATA,"^",11) S EXC=209,TEXT="Gender fields don't match between site and MPI for DFN "_DFN S EXACT2=1
"RTN","MPIFQ0",81,0)
 .I SNM2'=SNM!($D(EXACT2)) D  Q
"RTN","MPIFQ0",82,0)
 ..I '$D(EXC) S EXC=214,TEXT="Name fields don't match between site and MPI for DFN "_DFN
"RTN","MPIFQ0",83,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",84,0)
 ..I '$D(MPIFINT) D LOC2^MPIFQ3(DFN) Q
"RTN","MPIFQ0",85,0)
 .I '$D(MPIFS)&('$D(TWODFN)) W:'$D(MPIFRPC) !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" on MPI",!,"  Updating ICN to "_+ICN_" and CMOR to "_$P($$NS^XUAF4(IEN),"^")_" ("_CMOR_")  - just a minute..."
"RTN","MPIFQ0",86,0)
 .D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR) S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",87,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",88,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",89,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",90,0)
 .I '$D(EXC) S EXC=218,TEXT="Potential matches found for patient DFN= "_DFN_" Use Single Patient Initialization to MPI option to manually process."
"RTN","MPIFQ0",91,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(EXC,TEXT,DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",92,0)
 .D LOCAL^MPIFQ3(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",93,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",94,0)
EXIT I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",95,0)
 K VALMCNT,VALMLST,CCMOR,FICN H 3 W:'$D(MPIFRPC) !!
"RTN","MPIFQ0",96,0)
END K ^TMP("MPIFVQQ",$J),^TMP("MPIFQ0",$J) Q
"RTN","MPIFQ0",97,0)
 ;
"RTN","MPIFQ0",98,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",99,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",100,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",101,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",102,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",103,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",104,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",105,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",106,0)
 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S LOCAL="Y"
"RTN","MPIFQ0",107,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",108,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",109,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",110,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",111,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",112,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",113,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",114,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",115,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",116,0)
 N RESLT S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFQ0",117,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFQ0",118,0)
 ; Added for patch 31, create treating facility list
"RTN","MPIFQ0",119,0)
 I $D(^TMP("MPIFVQQ",$J,INDEX,"TF")) D
"RTN","MPIFQ0",120,0)
 . N MPINTFI,MPINTF,TFSTRG,TFIEN,MPIFMDT
"RTN","MPIFQ0",121,0)
 . S MPINTFI=0
"RTN","MPIFQ0",122,0)
 . F  S MPINTFI=$O(^TMP("MPIFVQQ",$J,INDEX,"TF",MPINTFI)) Q:'MPINTFI  D
"RTN","MPIFQ0",123,0)
 .. S MPINTF=^TMP("MPIFVQQ",$J,INDEX,"TF",MPINTFI)
"RTN","MPIFQ0",124,0)
 .. S TFIEN=$$IEN^XUAF4($P(MPINTF,"^",1))
"RTN","MPIFQ0",125,0)
 .. S MPIFMDT=$$HL7TFM^XLFDT($P(MPINTF,"^",2)) I MPIFMDT<0 S MPIFMDT=""
"RTN","MPIFQ0",126,0)
 .. S TFSTRG=TFIEN_"^"_$G(MPIFMDT)_"^"_$P(MPINTF,"^",3)
"RTN","MPIFQ0",127,0)
 .. D FILE^VAFCTFU(DFN,TFSTRG,1)
"RTN","MPIFQ0",128,0)
 Q
"RTN","MPIFQ0",129,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFQ0",130,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",131,0)
 ;DIC=file reference, DA=IEN in file, ARRAY=array for the values to be stored in, DR=fields requested, EI=external/internal values
"RTN","MPIFQ0",132,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFQ0",133,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",134,0)
 D EN^DIQ1
"RTN","MPIFQ0",135,0)
 Q
"RTN","MPIFQ0",136,0)
LOOP2 ;
"RTN","MPIFQ0",137,0)
 N MPIDONE,MPII,MPIJ
"RTN","MPIFQ0",138,0)
 S MPII=0,MPIDONE=0
"RTN","MPIFQ0",139,0)
 F  S MPIQUIT=$O(MPIDC(MPIQUIT)) Q:'MPIQUIT  D  Q:MPIDONE
"RTN","MPIFQ0",140,0)
 . I MPIDC(MPIQUIT)="" S MPIDONE=1 Q
"RTN","MPIFQ0",141,0)
 . S MPII=MPII+1,MPINODE(MPII)=$G(MPIDC(MPIQUIT)) Q
"RTN","MPIFQ0",142,0)
 Q
"RTN","MPIFQ0",143,0)
MSH ;
"RTN","MPIFQ0",144,0)
 S MPIREP=$E(HL("ECH"),2),MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFQ0",145,0)
 Q
"RTN","MPIFQ0",146,0)
MSA ;
"RTN","MPIFQ0",147,0)
 Q
"RTN","MPIFQ0",148,0)
RDF ;
"RTN","MPIFQ0",149,0)
 Q
"RTN","MPIFQ0",150,0)
QAK ;
"RTN","MPIFQ0",151,0)
 Q
"RTN","MPIFQ0",152,0)
RDT ;
"RTN","MPIFQ0",153,0)
 N NAME,ICN,BIRTHDAY,CMOR,IEN,SEG,HEREICN,STRING,LASTNAME,FRSTNAME,MIDDLE,SUFF,SEX
"RTN","MPIFQ0",154,0)
 S STRING="",INDEX=$G(INDEX)+1
"RTN","MPIFQ0",155,0)
 D RDT^MPIFSA3(.INDEX,.HL,.MSG)
"RTN","MPIFQ0",156,0)
 S SEG=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ0",157,0)
 S FRSTNAME=$P(SEG,"^",7),LASTNAME=$P(SEG,"^",2),MIDDLE=$P(SEG,"^",10),SUFF=$P(SEG,"^",15)
"RTN","MPIFQ0",158,0)
 S SSN=$P(SEG,"^",3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",159,0)
 I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",160,0)
 I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",161,0)
 S SEX=$P(SEG,"^",11)
"RTN","MPIFQ0",162,0)
 S ICN=$P(SEG,"^",6)
"RTN","MPIFQ0",163,0)
 S BIRTHDAY=$P(SEG,"^",4)
"RTN","MPIFQ0",164,0)
 S CMOR=$P(SEG,"^",5),IEN=$$IEN^XUAF4(CMOR)
"RTN","MPIFQ0",165,0)
 S CMOR=$P($$NS^XUAF4(IEN),"^")
"RTN","MPIFQ0",166,0)
 S HEREICN=$$HEREICN^MPIFQ3($P(ICN,"V",1))
"RTN","MPIFQ0",167,0)
 I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFVQQ",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",168,0)
 S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",169,0)
 S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",170,0)
 S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",171,0)
 S ^TMP("MPIFVQQ",$J,INDEX,0)=STRING,^TMP("MPIFVQQ",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",172,0)
 Q
"RTN","MPIFQ1")
0^16^B39645920
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16,17,21,23,24,28,31,33**;30 Apr 99
"RTN","MPIFQ1",3,0)
 ;
"RTN","MPIFQ1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQ1",5,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFQ1",6,0)
 ;   FILE^VAFCTFU - #2988
"RTN","MPIFQ1",7,0)
 ;   ^DPT("AICN" - #2070
"RTN","MPIFQ1",8,0)
 ;   NAME^VAFCPID2 - #3492
"RTN","MPIFQ1",9,0)
 ;   EN1^XWB2HL7 - #3144
"RTN","MPIFQ1",10,0)
 ;   RTNDATA^XWBDRPC - #3149
"RTN","MPIFQ1",11,0)
 ;   VAFC REMOTE PDAT (RPC) - #3496
"RTN","MPIFQ1",12,0)
 ;
"RTN","MPIFQ1",13,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",14,0)
 Q
"RTN","MPIFQ1",15,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",16,0)
 N SSN,DOB,MPIFQ1,NAME1,SEX
"RTN","MPIFQ1",17,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09;.02","EI")
"RTN","MPIFQ1",18,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E")),SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",19,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I")),SEX=$G(MPIFQ1(2,DFN,.02,"E"))
"RTN","MPIFQ1",20,0)
 I DOB]"" S DOB=$TR($$FMTE^XLFDT(DOB,"5D"),"/","-")
"RTN","MPIFQ1",21,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",22,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",23,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",24,0)
 S VALMHDR(4)="                              SEX: "_IOINHI_SEX_IOINORM,VALMHDR(5)=" "
"RTN","MPIFQ1",25,0)
 Q
"RTN","MPIFQ1",26,0)
START(INDEX) ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",27,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",28,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",29,0)
 Q
"RTN","MPIFQ1",30,0)
SELECT N VALMY
"RTN","MPIFQ1",31,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",32,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",33,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2
"RTN","MPIFQ1",34,0)
 S INDEX=$O(VALMY(0)),DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ1",35,0)
 S NODE2=$G(^TMP("MPIFVQQ",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",36,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",37,0)
 S DATA(.03)=$P(DATA,"^",4),DATA(.09)=$P(DATA,"^",3),DATA(.02)=$P(DATA,"^",11) ;DOB, SSN, SEX
"RTN","MPIFQ1",38,0)
 S ICN=$P(DATA,"^",6),CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),DATA(991.01)=ICN,DATA(991.02)=CHKSUM,DATA(991.03)=$$LKUP^XUAF4($P(DATA,"^",5))
"RTN","MPIFQ1",39,0)
 ;If NODE2["*" we have a pt in our list whose ICN is already at this site
"RTN","MPIFQ1",40,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",41,0)
 .D CLEAR^VALM1,MSG1^MPIFQ3
"RTN","MPIFQ1",42,0)
 .N DFN2 S DFN2=$O(^DPT("AICN",ICN,""))
"RTN","MPIFQ1",43,0)
 .D TWODFNS^MPIF002(DFN2,DFN,ICN)
"RTN","MPIFQ1",44,0)
 .W !!,"Assigning Local ICN" D LOCAL^MPIFQ3(DFN),PROMPT^MPIFQ3 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",45,0)
 ;User selected from list, does SSN & Name match?  no-ask if sure
"RTN","MPIFQ1",46,0)
 N SSN,NAME,SEX
"RTN","MPIFQ1",47,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09;.02","EI")
"RTN","MPIFQ1",48,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E")),SEX=$G(MPIFQ1(2,DFN,.02,"I"))
"RTN","MPIFQ1",49,0)
 ; if sex doesn't match -- not allowed to update ICN
"RTN","MPIFQ1",50,0)
 I DATA(.02)'=SEX W !!,"Sex for these two patients doesn't match -- Can't select this patient until",!,"Sex matches between the MPI and your site.  No action will be taken." D PROMPT^MPIFQ3 S VALMBCK="R" Q
"RTN","MPIFQ1",51,0)
 I SSN["P" S SSN=""
"RTN","MPIFQ1",52,0)
 I DATA(.09)'=SSN W !!,"SSN for these two patients doesn't match -- Can't select this patient until",!,"SSN matches between the MPI and your site.  No action will be taken." D PROMPT^MPIFQ3 S VALMBCK="R" Q
"RTN","MPIFQ1",53,0)
 D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFQ1",54,0)
 N NAME3 S NAME3=DATA(.01) D NAME^VAFCPID2(0,.NAME3,0) S DATA(.01)=NAME3 ;reformat name into DG 149 format
"RTN","MPIFQ1",55,0)
 I DATA(.01)=NAME K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3^MPIFQ3,PROMPT^MPIFQ3,TF^MPIFQ3(DFN,.DATA) Q
"RTN","MPIFQ1",56,0)
 ;Name doesn't match exactly - ask if sure
"RTN","MPIFQ1",57,0)
 D CLEAR^VALM1,MSG2^MPIFQ3,MSG^MPIFQ3(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",58,0)
 N ANS S ANS=$$PROMPT1^MPIFQ3()
"RTN","MPIFQ1",59,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT^MPIFQ3,TF^MPIFQ3(DFN,.DATA) Q
"RTN","MPIFQ1",60,0)
 D MSG5^MPIFQ3,PROMPT^MPIFQ3 S VALMBCK="R"
"RTN","MPIFQ1",61,0)
 Q
"RTN","MPIFQ1",62,0)
ADD ;Add (MPIF REAL-TIME QUERY (ADD PATIENT)) add pt to MPI Austin.
"RTN","MPIFQ1",63,0)
 D A28^MPIFQ3(DFN),PROMPT^MPIFQ3 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",64,0)
 Q
"RTN","MPIFQ1",65,0)
MPIPD ; MPI PDAT CALL
"RTN","MPIFQ1",66,0)
 N VALMY,CNT,Y
"RTN","MPIFQ1",67,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",68,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",69,0)
 N DATA,INDEX,ICN,CHKSUM,CMOR,CASE,CMOR3,TTF,ALIAS,POW,TAL,TMP
"RTN","MPIFQ1",70,0)
 S INDEX=$O(VALMY(0)),Y="" D CLEAR^VALM1
"RTN","MPIFQ1",71,0)
 S DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ1",72,0)
 S CMOR=$P(DATA,"^",5),CMOR3=CMOR,CMOR=$P($$NS^XUAF4($$LKUP^XUAF4(CMOR)),"^")
"RTN","MPIFQ1",73,0)
 W !,"MPI Data:",!!!,?3,"ICN: ",+$P(DATA,"^",6),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFQ1",74,0)
 W !,?2,"NAME: ",$P(DATA,"^")
"RTN","MPIFQ1",75,0)
 W !,?3,"SSN: ",$P(DATA,"^",3),?30,"SEX: ",$P(DATA,"^",11)
"RTN","MPIFQ1",76,0)
 W !,?3,"DOB: ",$P(DATA,"^",4)
"RTN","MPIFQ1",77,0)
 W ?30,"DOD: ",$P(DATA,"^",9)
"RTN","MPIFQ1",78,0)
 I $P(DATA,"^",20)="Y" W !?3,"Multiple Birth Indicator:  Yes"
"RTN","MPIFQ1",79,0)
 I ($P(DATA,"^",12)='"")&($P(DATA,"^",13)'="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,"^",12),", ",$P(DATA,"^",13)
"RTN","MPIFQ1",80,0)
 I $P(DATA,"^",12)=""!($P(DATA,"^",13)="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,"^",12)," ",$P(DATA,"^",13)
"RTN","MPIFQ1",81,0)
 W !,?2,"MOTHER'S MAIDEN NAME: ",$P(DATA,"^",16)
"RTN","MPIFQ1",82,0)
 W !,?2,"CLAIM NUMBER: ",$P(DATA,"^",17)
"RTN","MPIFQ1",83,0)
 S POW=$P(DATA,"^",19) I POW'="" W !,?2,"POW STATUS: ",POW
"RTN","MPIFQ1",84,0)
 S CASE=$P(DATA,"^",18)
"RTN","MPIFQ1",85,0)
 I CASE'="" W !,?2,"Open Data Management Case",!,?5,"CASE#: ",$P(CASE,"/")_"   NOIS#: ",$P(CASE,"/",2),!,?5,"CASE WORKER: ",$P(CASE,"/",3)
"RTN","MPIFQ1",86,0)
 I $D(^TMP("MPIFVQQ",$J,INDEX,"ALIAS")) W !,?2,"Alias(es): " D
"RTN","MPIFQ1",87,0)
 .N XX S XX=0 F  S XX=$O(^TMP("MPIFVQQ",$J,INDEX,"ALIAS",XX)) Q:'XX  W !?10,^(XX)
"RTN","MPIFQ1",88,0)
 I $D(^TMP("MPIFVQQ",$J,INDEX,"TF"))&($O(^TMP("MPIFVQQ",$J,INDEX,"TF",1))'="") D
"RTN","MPIFQ1",89,0)
 .W !,?2,"TREATING FACILITY LIST:"
"RTN","MPIFQ1",90,0)
 .N XX S XX=0 F  S XX=$O(^TMP("MPIFVQQ",$J,INDEX,"TF",XX)) Q:'XX  S TMP=$P($G(^(XX)),MPICOMP) I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFQ1",91,0)
 D PROMPT^MPIFQ3
"RTN","MPIFQ1",92,0)
 S VALMBCK="R"
"RTN","MPIFQ1",93,0)
 Q
"RTN","MPIFQ1",94,0)
CMOR ; CMOR PDAT CALL
"RTN","MPIFQ1",95,0)
 N VALMY,DATA,INDEX,ICN,CHKSUM,CMOR
"RTN","MPIFQ1",96,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",97,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",98,0)
 S INDEX=$O(VALMY(0)),DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ1",99,0)
 S ICN=$P(DATA,"^",6),CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),CMOR=$P(DATA,"^",5)
"RTN","MPIFQ1",100,0)
 I CMOR=$P($$SITE^VASITE(),"^",3) W !!,"CMOR is your site" G END
"RTN","MPIFQ1",101,0)
 W !,"Please be patient while the data is being retrieved from the CMOR."
"RTN","MPIFQ1",102,0)
 D EN1^XWB2HL7(.RETURN,CMOR,"VAFC REMOTE PDAT",1,ICN,"")  ; Request 
"RTN","MPIFQ1",103,0)
 S ^XTMP("MPIFPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY",^XTMP("MPIFPDAT"_ICN,1)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","MPIFQ1",104,0)
 S CNT=0
"RTN","MPIFQ1",105,0)
AGAIN1 H 2 K RES1 D RTNDATA^XWBDRPC(.RES1,RETURN(0)) S CNT=CNT+1
"RTN","MPIFQ1",106,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT<11 G AGAIN1
"RTN","MPIFQ1",107,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",108,0)
 I RES1(0)="0^New" I CNT<11 G AGAIN1
"RTN","MPIFQ1",109,0)
 I RES1(0)="0^New" I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",110,0)
 I +RES1(0)=-1 W !!,$P(RES1(0),"^",2) G END
"RTN","MPIFQ1",111,0)
 I RES1'="" I CNT<11 G AGAIN1
"RTN","MPIFQ1",112,0)
 I RES1'="" I CNT>10 W !,"Unable to get data" Q
"RTN","MPIFQ1",113,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",114,0)
 N NUM S NUM="",CNT=0
"RTN","MPIFQ1",115,0)
 F  S NUM=$O(RES1(NUM)) Q:NUM=""  D
"RTN","MPIFQ1",116,0)
 .I CNT>20 D PROMPT^MPIFQ3,CLEAR^VALM1 S CNT=0
"RTN","MPIFQ1",117,0)
 .I RES1(NUM)["Additional" W !! S CNT=CNT+2
"RTN","MPIFQ1",118,0)
 .I CNT<21 W !,RES1(NUM) S CNT=CNT+1
"RTN","MPIFQ1",119,0)
END D PROMPT^MPIFQ3 S VALMBCK="R" K CNT,RETURN,RES1
"RTN","MPIFQ1",120,0)
 Q
"RTN","MPIFQ1",121,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",122,0)
 D CLEAR^VALM1,MSG4^MPIFQ3,PROMPT^MPIFQ3 S VALMBCK="R"
"RTN","MPIFQ1",123,0)
 Q
"RTN","MPIFQ1",124,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",125,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",126,0)
 Q
"RTN","MPIFRES")
0^15^B15482474
"RTN","MPIFRES",1,0)
MPIFRES ;SF/CMC-LOCAL AND MISSING ICN RESOLUTION ;JUL 13, 1998
"RTN","MPIFRES",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,7,10,15,17,21,26,28,33**;30 Apr 99
"RTN","MPIFRES",3,0)
 ;
"RTN","MPIFRES",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFRES",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFRES",6,0)
 ;  ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFRES",7,0)
 ;  ^RGHL7(991.1 - #3259
"RTN","MPIFRES",8,0)
 ;  ^RGSITE - #2746
"RTN","MPIFRES",9,0)
 ;
"RTN","MPIFRES",10,0)
BKG ;
"RTN","MPIFRES",11,0)
 S ZTRTN="GO^MPIFRES",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFRES",12,0)
 D NOW^%DTC
"RTN","MPIFRES",13,0)
 S ZTIO="",ZTDTH=%
"RTN","MPIFRES",14,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFRES",15,0)
 D ^%ZTLOAD
"RTN","MPIFRES",16,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFRES",17,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFRES",18,0)
 Q
"RTN","MPIFRES",19,0)
 ;
"RTN","MPIFRES",20,0)
GO ;ENTRY POINT
"RTN","MPIFRES",21,0)
 N MPIMORE,MPITOT
"RTN","MPIFRES",22,0)
 L +^XTMP("MPIF RESOLUTION"):3 E  Q
"RTN","MPIFRES",23,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFRES",24,0)
 ;
"RTN","MPIFRES",25,0)
 K ^TMP("HLS",$J),STOP
"RTN","MPIFRES",26,0)
 D START^RGHLLOG()
"RTN","MPIFRES",27,0)
 D HLRDF
"RTN","MPIFRES",28,0)
 I $D(STOP) K STOP Q  ;patch 7 added to quit if init returned an error
"RTN","MPIFRES",29,0)
 D LOOP
"RTN","MPIFRES",30,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFRES",31,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFRES",32,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIMIDT,MPIMSH
"RTN","MPIFRES",33,0)
 K MPIOUT,MPIQRYNM,MPISEQ,QCNT,MPIMCNT,MPIMTX,ENDT,MPIFRES
"RTN","MPIFRES",34,0)
 L -^XTMP("MPIF RESOLUTION")
"RTN","MPIFRES",35,0)
 ; mark job completion date/time
"RTN","MPIFRES",36,0)
 S $P(^RGSITE(991.8,1,0),"^",4)=$$NOW^XLFDT
"RTN","MPIFRES",37,0)
 Q
"RTN","MPIFRES",38,0)
 ;
"RTN","MPIFRES",39,0)
HLRDF ;
"RTN","MPIFRES",40,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFRES",41,0)
 S HL("ECH")="^~\&"
"RTN","MPIFRES",42,0)
 S HL("FS")="|"
"RTN","MPIFRES",43,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.HL)
"RTN","MPIFRES",44,0)
 I $O(HL("")) D EXC^RGHLLOG(220,"INIT^HLFNC2 call error returned") S STOP="" Q
"RTN","MPIFRES",45,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFRES",46,0)
 Q
"RTN","MPIFRES",47,0)
LOOP ;
"RTN","MPIFRES",48,0)
 S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",49,0)
 D MAKE
"RTN","MPIFRES",50,0)
 Q
"RTN","MPIFRES",51,0)
SEND ;ready to send
"RTN","MPIFRES",52,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFRES",53,0)
 I +MPIEROR=0 D EXC^RGHLLOG(220,"GENERATE^HLMA call returned error") Q
"RTN","MPIFRES",54,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFRES",55,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",56,0)
 Q
"RTN","MPIFRES",57,0)
MAKE ;
"RTN","MPIFRES",58,0)
 N LOCAL,MPIIT,TICN,STOP,X,Y,%,%H,%I,TODAY,SITE,XX
"RTN","MPIFRES",59,0)
 S LOCAL="",MPIIT=0,MPIFRES="",SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFRES",60,0)
 D NOW^%DTC S TODAY=X
"RTN","MPIFRES",61,0)
 ;local ICNs
"RTN","MPIFRES",62,0)
 F  S MPIIT=$O(^DPT("AICNL",1,MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",63,0)
 .; LINE BELOW ADDED FOR PATCH 26 TO CLEANUP AICNL X-REF WHEN LEFT AROUND
"RTN","MPIFRES",64,0)
 .I $E($$GETICN^MPIF001(MPIIT),1,3)'=SITE S XX=$$SETLOC^MPIF001(MPIIT,0) K ^DPT("AICNL",1,MPIIT) Q
"RTN","MPIFRES",65,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=1
"RTN","MPIFRES",66,0)
 .; ^ only send patient to MPI for Local ICN resolution 1 time
"RTN","MPIFRES",67,0)
 .I $D(^RGHL7(991.1,"ADFN",218,MPIIT)) S ^DPT("AICNL",1,MPIIT)="1^"_TODAY Q
"RTN","MPIFRES",68,0)
 .; ^ checking if potential match exception
"RTN","MPIFRES",69,0)
 .D MAKE3
"RTN","MPIFRES",70,0)
 ;missing ICNs
"RTN","MPIFRES",71,0)
 S MPIIT=0
"RTN","MPIFRES",72,0)
 F  S MPIIT=$O(^DPT("AMPIMIS",MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",73,0)
 .K STOP
"RTN","MPIFRES",74,0)
 .S TICN=+$$GETICN^MPIF001(MPIIT)
"RTN","MPIFRES",75,0)
 .I TICN<0,'$D(STOP) D MAKE3
"RTN","MPIFRES",76,0)
 .I TICN>0 K ^DPT("AMPIMIS",MPIIT)
"RTN","MPIFRES",77,0)
 Q
"RTN","MPIFRES",78,0)
MAKE3 ;
"RTN","MPIFRES",79,0)
 K MPIOUT
"RTN","MPIFRES",80,0)
 S MPIFRES=""
"RTN","MPIFRES",81,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFRES",82,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.HL,.MPIQRYNM)
"RTN","MPIFRES",83,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFRES",84,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFRES",85,0)
 ;I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" Q
"RTN","MPIFRES",86,0)
 Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFRES",87,0)
 S ^DPT("AICNL",1,MPIIT)="1^"_TODAY
"RTN","MPIFRES",88,0)
 ; ^ mark Local ICN as having been sent to MPI for resolution
"RTN","MPIFRES",89,0)
 ;call for HL7 header
"RTN","MPIFRES",90,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFRES",91,0)
 D MSH^HLFNC2(.HL,MPIMIDT,.MPIMSH)
"RTN","MPIFRES",92,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFRES",93,0)
 S ^TMP("HLS",$J,MPICNT)=MPIOUT(1)
"RTN","MPIFRES",94,0)
 S MPICNT=MPICNT+1
"RTN","MPIFRES",95,0)
 ;MESSAGE BUILT
"RTN","MPIFRES",96,0)
 S MPISEQ=0
"RTN","MPIFRES",97,0)
 ;setup VTQ segment in HL array
"RTN","MPIFRES",98,0)
 S ^TMP("HLS",$J,MPICNT)=MPIOUT(2)
"RTN","MPIFRES",99,0)
 S MPICNT=MPICNT+1
"RTN","MPIFRES",100,0)
 ;setup RDF segment in HL array
"RTN","MPIFRES",101,0)
 S ^TMP("HLS",$J,MPICNT)=MPIOUT(3)
"RTN","MPIFRES",102,0)
 ;loop through and add the additional RDF continuations
"RTN","MPIFRES",103,0)
 N SCNT,Y S Y=3,SCNT=1 F  S Y=$O(MPIOUT(Y)) Q:'Y  D
"RTN","MPIFRES",104,0)
 .S ^TMP("HLS",$J,MPICNT,SCNT)=MPIOUT(Y),SCNT=SCNT+1
"RTN","MPIFRES",105,0)
 S MPICNT=MPICNT+1
"RTN","MPIFRES",106,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFRES",107,0)
 I MPIDNUM>100 D
"RTN","MPIFRES",108,0)
 .D SEND
"RTN","MPIFRES",109,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",110,0)
 .D HLRDF
"RTN","MPIFRES",111,0)
 Q
"RTN","MPIFRPC2")
0^9^B11239382
"RTN","MPIFRPC2",1,0)
MPIFRPC2 ;SFCIO/CMC-MPIF RPC APIS ;24 OCT 01
"RTN","MPIFRPC2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20,24,33**;30 Apr 99
"RTN","MPIFRPC2",3,0)
 ;
"RTN","MPIFRPC2",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFRPC2",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFRPC2",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFRPC2",7,0)
 ;  AVAFC^VAFCDD01 - #3493
"RTN","MPIFRPC2",8,0)
 ;  START, STOP, EXC^RGHLLOG - #2070
"RTN","MPIFRPC2",9,0)
 ;
"RTN","MPIFRPC2",10,0)
SPI(RETURN,SSN,DFN1) ;
"RTN","MPIFRPC2",11,0)
 ;RPC to Single Patient Initialization on patient with SSN
"RTN","MPIFRPC2",12,0)
 ; RETURN - 1 for successful inactivation or -1^error msg
"RTN","MPIFRPC2",13,0)
 ; SSN = is the SSN for the patient that is to be SPI'd
"RTN","MPIFRPC2",14,0)
 ; DFN1 = is the IEN for the patient that is to be SPI'd
"RTN","MPIFRPC2",15,0)
 ;
"RTN","MPIFRPC2",16,0)
 N RES,XX,DFN,ICN,TICN,MPIFA
"RTN","MPIFRPC2",17,0)
 I SSN=""&($G(DFN1)="") S RETURN="-1^No SSN or DFN Passed" Q
"RTN","MPIFRPC2",18,0)
 I SSN'="",SSN'?9N S RETURN="-1^Invalid SSN" Q
"RTN","MPIFRPC2",19,0)
 I SSN'="",'$D(^DPT("SSN",SSN)) S RETURN="-1^No such SSN" Q
"RTN","MPIFRPC2",20,0)
 I SSN'="" D
"RTN","MPIFRPC2",21,0)
 .S RETURN(0)="SSN USED "_SSN
"RTN","MPIFRPC2",22,0)
 .S RES=$$GETDFNS^MPIF002(SSN)
"RTN","MPIFRPC2",23,0)
 I SSN="",DFN1'?1N.N S RETURN="-1^Invalid DFN" Q
"RTN","MPIFRPC2",24,0)
 I SSN="",'$D(^DPT(DFN1,0)) S RETURN="-1^No such DFN" Q
"RTN","MPIFRPC2",25,0)
 I SSN="" D
"RTN","MPIFRPC2",26,0)
 .S RETURN(0)="DFN USED "_DFN1
"RTN","MPIFRPC2",27,0)
 .S RES=DFN1
"RTN","MPIFRPC2",28,0)
 I +RES=-1 S RETURN=RES Q
"RTN","MPIFRPC2",29,0)
 F XX=1:1 S DFN=$P(RES,"^",XX) Q:DFN=""  D
"RTN","MPIFRPC2",30,0)
 .; can be multiple entries with same SSN
"RTN","MPIFRPC2",31,0)
 .S TICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC2",32,0)
 .I +TICN'=-1&($P($$SITE^VASITE,"^",3)'=$E(TICN,1,3)) S RETURN(XX,0)="DFN= "_DFN_" already has an ICN, ICN="_TICN Q
"RTN","MPIFRPC2",33,0)
 .S MPIFS=1,HLP("ACKTIME")=300,MPIFRES=1,MPIFRPC=1
"RTN","MPIFRPC2",34,0)
 .D GETS^DIQ(2,DFN_",",".01","IE","MPIFA")
"RTN","MPIFRPC2",35,0)
 .D CIRNEXC^MPIFQ0
"RTN","MPIFRPC2",36,0)
 .K MPIFS,MPIFRES,MPIFRPC
"RTN","MPIFRPC2",37,0)
 .S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC2",38,0)
 .I +ICN=-1 S RETURN(XX,0)="DFN "_DFN_" problem getting ICN assinged "_$P(ICN,"^",2),RETURN="-1^Unable to get ICN" Q
"RTN","MPIFRPC2",39,0)
 .K RET S RET=""
"RTN","MPIFRPC2",40,0)
 .I $P($$SITE^VASITE,"^",3)=$E(+ICN,1,3) D  Q
"RTN","MPIFRPC2",41,0)
 ..D EXC^MPIFRPC(DFN,.RET,XX)
"RTN","MPIFRPC2",42,0)
 ..S RET(XX,"EXCEPTIONS")=$TR($G(RET(XX,"EXCEPTIONS")),"""","")
"RTN","MPIFRPC2",43,0)
 ..S RETURN(XX,0)="DFN "_DFN_" Local ICN assigned "_ICN_" EXCEPTIONS: "_$G(RET(XX,"EXCEPTIONS")),RETURN="-1^Local ICN assigned" Q
"RTN","MPIFRPC2",44,0)
 .S RETURN(XX)=ICN
"RTN","MPIFRPC2",45,0)
 Q
"RTN","MPIFRPC2",46,0)
 ;
"RTN","MPIFRPC2",47,0)
UPDATE(RET,SSN,ICN,CHK,CMOR,A08) ;
"RTN","MPIFRPC2",48,0)
 ; update fields 991.01,991.02 and 991.03 remotely
"RTN","MPIFRPC2",49,0)
 I SSN=""!(ICN="")!(CHK="")!(CMOR="") S RET="-1^Missing required parameter" Q
"RTN","MPIFRPC2",50,0)
 I '$D(^DPT("SSN",SSN)) S RET="-1^No patient has that SSN at this site" Q
"RTN","MPIFRPC2",51,0)
 N DFN,MPIFA,TMP,RESLT
"RTN","MPIFRPC2",52,0)
 S DFN=$O(^DPT("SSN",SSN,""))
"RTN","MPIFRPC2",53,0)
 I $O(^DPT("SSN",SSN,DFN))'="" S RET="-1^More than one patient has that SSN at this site" Q
"RTN","MPIFRPC2",54,0)
 S TMP=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFRPC2",55,0)
 I +TMP'=-1,$E(TMP,1,3)'=$P($$SITE^VASITE(),"^",3) S RET="-1^Patient has a national ICN, ICN="_TMP Q
"RTN","MPIFRPC2",56,0)
 S MPIFA(991.01)=ICN,MPIFA(991.02)=CHK,MPIFA(991.03)=$$LKUP^XUAF4(CMOR)
"RTN","MPIFRPC2",57,0)
 S RET=$$UPDATE^MPIFAPI(DFN,"MPIFA")
"RTN","MPIFRPC2",58,0)
 S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFRPC2",59,0)
 I +RESLT<0 D START^RGHLLOG(),EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN),STOP^RGHLLOG() S RET="-1^Problem building A24 (ADD TF) for Pt" Q
"RTN","MPIFRPC2",60,0)
 I A08=1 D AVAFC^VAFCDD01(DFN) ; trigger A08 msg
"RTN","MPIFRPC2",61,0)
 I A08=1 S RET=RET_"^and A08 triggered"
"RTN","MPIFRPC2",62,0)
 Q
"RTN","MPIFVTQ")
0^1^B29440956
"RTN","MPIFVTQ",1,0)
MPIFVTQ ;SLC/ARS-BUILD DATA TO QUERY MPI RESPONSE PROCESS (ADDPAT) ;JUL 16, 1997
"RTN","MPIFVTQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,9,17,21,23,28,33**;30 Apr 99
"RTN","MPIFVTQ",3,0)
 ;
"RTN","MPIFVTQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFVTQ",5,0)
 ;  ^DPT( -9 node check - #2762
"RTN","MPIFVTQ",6,0)
 ;  ^DPT( "MPI" node - #2070
"RTN","MPIFVTQ",7,0)
 ;  EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFVTQ",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFVTQ",9,0)
 ;
"RTN","MPIFVTQ",10,0)
 Q  ;NOT an entry point
"RTN","MPIFVTQ",11,0)
 ;
"RTN","MPIFVTQ",12,0)
VTQ1(MPIIT,MPIOUT,HL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",13,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",14,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",15,0)
 ;HL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",16,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",17,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",18,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",19,0)
 ;  POB-CITY;POB-STATE;MIDDLE NAME
"RTN","MPIFVTQ",20,0)
 ;
"RTN","MPIFVTQ",21,0)
 ;If invalid DFN, Patient Merged, if ICN already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",22,0)
 ;
"RTN","MPIFVTQ",23,0)
 ;If DOB does not contain a 7 digit date OR if name is not present, -1^Missing Required fields will be returned in MPIOUT(0).
"RTN","MPIFVTQ",24,0)
 ;
"RTN","MPIFVTQ",25,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",26,0)
 ;
"RTN","MPIFVTQ",27,0)
 N MPITEST,MPISSN,MPIDTH,MPINM,MPIDOB,ERR
"RTN","MPIFVTQ",28,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",29,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00108.4;00126.1;00126.2;00108.3"
"RTN","MPIFVTQ",30,0)
 ;validation check
"RTN","MPIFVTQ",31,0)
 I '$D(HL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",32,0)
 I $G(HL("FS"))=""!($G(HL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",33,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",34,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",35,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",36,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1)
"RTN","MPIFVTQ",37,0)
 I '$D(MPIFRES),$G(MPIZICN)'="" S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",38,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",39,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",40,0)
 I $P(MPITEST,"^")=""&($P(MPITEST,"^",2)="")&($P(MPITEST,"^",3)="")&($P(MPITEST,"^",9)="") D  Q
"RTN","MPIFVTQ",41,0)
 .K MPIARR
"RTN","MPIFVTQ",42,0)
 .S MPIOUT(0)="-1^stub entry in DPT"
"RTN","MPIFVTQ",43,0)
 .S MPIARR(991.01)="@",MPIARR(991.02)="@",MPIARR(991.03)="@",MPIARR(991.05)="@",MPIARR(992)=MPIZICN,MPIARR(993)=+$$SITE^VASITE()
"RTN","MPIFVTQ",44,0)
 .S ERR=$$DELALLTF^VAFCTFU(MPIZICN) ;clean up tf list
"RTN","MPIFVTQ",45,0)
 .S ERR=$$UPDATE^MPIFAPI(MPIIT,"MPIARR",1,1) K MPIARR
"RTN","MPIFVTQ",46,0)
 .;PATCH 33 - stub entry with local, remove local and don't send to MPI
"RTN","MPIFVTQ",47,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",48,0)
 S MPIDTH=""
"RTN","MPIFVTQ",49,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",50,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",51,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.HL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",52,0)
 Q
"RTN","MPIFVTQ",53,0)
EXC(IEN) ;
"RTN","MPIFVTQ",54,0)
 Q:'$D(^DPT(IEN))
"RTN","MPIFVTQ",55,0)
 D LOCAL^MPIFQ3(IEN)
"RTN","MPIFVTQ",56,0)
 D START^RGHLLOG()
"RTN","MPIFVTQ",57,0)
 D EXC^RGHLLOG(209,"DFN= "_IEN_" is Missing Required Field(s)",IEN)
"RTN","MPIFVTQ",58,0)
 D STOP^RGHLLOG()
"RTN","MPIFVTQ",59,0)
 Q
"RTN","MPIFVTQ",60,0)
 ;
"RTN","MPIFVTQ",61,0)
VTQC(MPISSN,MPIDTH,MPISND,HL,MPIQRYNM,MPIOUT,MPIIT) ;
"RTN","MPIFVTQ",62,0)
 N MPIPOB,MPIPOBS,MPINM,MPI2MN,MPI1NM,QUERY,MPIDOB,RDF,MPIMOD
"RTN","MPIFVTQ",63,0)
 N MPIHDTH,MPIZDOB,MPIXDOB,MPIMPI,MPIZICN,QUEDOB,MPI2NM,MPICS,MPIESC,MPIHDOB,MPIMNM,MPIMN
"RTN","MPIFVTQ",64,0)
 N MPINMSFX,MPIRS,MPISCS,MPISEX,MPIZLOC
"RTN","MPIFVTQ",65,0)
 I $G(MPIQRYNM)="" S MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFVTQ",66,0)
 S MPICS=$E(HL("ECH"),1)
"RTN","MPIFVTQ",67,0)
 S MPIRS=$E(HL("ECH"),2)
"RTN","MPIFVTQ",68,0)
 S MPISCS=$E(HL("ECH"),4)
"RTN","MPIFVTQ",69,0)
 S MPIESC=$E(HL("ECH"),3)
"RTN","MPIFVTQ",70,0)
 ;build RDF as the third segment
"RTN","MPIFVTQ",71,0)
 D BLDRDF^MPIFSA2(.MPIOUT,3,MPIRS,MPICS)
"RTN","MPIFVTQ",72,0)
 S QUERY="VTQ"_HL("FS")_MPIIT_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFVTQ",73,0)
 ;
"RTN","MPIFVTQ",74,0)
 I MPISND["00108" S MPINM=$P(MPITEST,"^") D NAME^VAFCPID2(MPIIT,.MPINM) ;agressive name reformatting
"RTN","MPIFVTQ",75,0)
 ; ^ sending all or part of name
"RTN","MPIFVTQ",76,0)
 I MPISND["00108.1" S MPI2NM=$P(MPINM,",",1) I MPI2NM'="" S QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFVTQ",77,0)
 ; ^ sending last name
"RTN","MPIFVTQ",78,0)
 I MPISND["00122"&(MPISSN'="")&(MPISSN'["P") S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_MPISSN
"RTN","MPIFVTQ",79,0)
 ; ^ sending SSN
"RTN","MPIFVTQ",80,0)
 I MPISND["00108.2" S MPI1NM=$P(MPINM,",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFVTQ",81,0)
 ; ^ sending first name
"RTN","MPIFVTQ",82,0)
 I MPISND["00110" D
"RTN","MPIFVTQ",83,0)
 .S MPIDOB=$P(MPITEST,"^",3)
"RTN","MPIFVTQ",84,0)
 .Q:MPIDOB=""
"RTN","MPIFVTQ",85,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIDOB)
"RTN","MPIFVTQ",86,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFVTQ",87,0)
 .S MPIMOD=MPIDOB#100
"RTN","MPIFVTQ",88,0)
 .I MPIQRYNM'="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"GN"_MPICS_MPIHDOB
"RTN","MPIFVTQ",89,0)
 .I MPIQRYNM="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",90,0)
 .S MPIXDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",91,0)
 .S QUEDOB=$S(MPIMOD>0:MPIXDOB,1:MPIZDOB)
"RTN","MPIFVTQ",92,0)
 .S QUERY=QUERY_QUEDOB
"RTN","MPIFVTQ",93,0)
 ; ^ sending date of birth
"RTN","MPIFVTQ",94,0)
 I $D(MPIDTH),(MPISND["00740")&(MPIDTH'="") S MPIHDTH=$$HLDATE^HLFNC(MPIDTH),QUERY=QUERY_MPICS_"AND"_MPIRS_"@00740"_MPICS_"EQ"_MPICS_MPIHDTH
"RTN","MPIFVTQ",95,0)
 ; ^ sending date of death
"RTN","MPIFVTQ",96,0)
 I MPISND["00111" S:$G(^DPT(MPIIT,0))'="" MPISEX=$P(^DPT(MPIIT,0),"^",2) I MPISEX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_MPISEX
"RTN","MPIFVTQ",97,0)
 ; ^ sending Sex
"RTN","MPIFVTQ",98,0)
 I MPISND["00108.4" S MPI1NM=$P(MPINM,",",2),MPINMSFX=$P(MPI1NM," ",3) I MPINMSFX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPINMSFX
"RTN","MPIFVTQ",99,0)
 ; ^ sending suffix name
"RTN","MPIFVTQ",100,0)
 I MPISND["00126.1" S MPIPOB=$P(^DPT(MPIIT,0),"^",11) I MPIPOB'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_MPIPOB
"RTN","MPIFVTQ",101,0)
 ; send place of birth - city
"RTN","MPIFVTQ",102,0)
 I MPISND["00126.2" S MPIPOBS=$P(^DPT(MPIIT,0),"^",12) I MPIPOBS'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_$P($G(^DIC(5,+MPIPOBS,0)),"^",2)
"RTN","MPIFVTQ",103,0)
 ; send place of birth - state
"RTN","MPIFVTQ",104,0)
 I MPISND["00108.3" S MPIMN=$P($P(MPINM,",",2)," ",2) I MPIMN'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.3"_MPICS_"EQ"_MPICS_MPIMN
"RTN","MPIFVTQ",105,0)
 ; send middle name
"RTN","MPIFVTQ",106,0)
 ;
"RTN","MPIFVTQ",107,0)
 I $G(MPIOUT(0))="" S MPIOUT(0)="1^good data"
"RTN","MPIFVTQ",108,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFVTQ",109,0)
 Q
"VER")
8.0^22.0
**END**
**END**
