Released EC*2*91 SEQ #83
Extracted from mail message
**KIDS**:EC*2.0*91^

**INSTALL NAME**
EC*2.0*91
"BLD",7092,0)
EC*2.0*91^EVENT CAPTURE^0^3070213^y
"BLD",7092,1,0)
^^1^1^3070124^
"BLD",7092,1,1,0)
This patch provides a fix to the EC Procedure Reason Report.
"BLD",7092,4,0)
^9.64PA^^
"BLD",7092,6)
1^
"BLD",7092,6.3)
2
"BLD",7092,"KRN",0)
^9.67PA^8989.52^19
"BLD",7092,"KRN",.4,0)
.4
"BLD",7092,"KRN",.401,0)
.401
"BLD",7092,"KRN",.402,0)
.402
"BLD",7092,"KRN",.403,0)
.403
"BLD",7092,"KRN",.5,0)
.5
"BLD",7092,"KRN",.84,0)
.84
"BLD",7092,"KRN",3.6,0)
3.6
"BLD",7092,"KRN",3.8,0)
3.8
"BLD",7092,"KRN",9.2,0)
9.2
"BLD",7092,"KRN",9.8,0)
9.8
"BLD",7092,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",7092,"KRN",9.8,"NM",1,0)
ECRPRSN^^0^B80981844
"BLD",7092,"KRN",9.8,"NM","B","ECRPRSN",1)

"BLD",7092,"KRN",19,0)
19
"BLD",7092,"KRN",19.1,0)
19.1
"BLD",7092,"KRN",101,0)
101
"BLD",7092,"KRN",409.61,0)
409.61
"BLD",7092,"KRN",771,0)
771
"BLD",7092,"KRN",870,0)
870
"BLD",7092,"KRN",8989.51,0)
8989.51
"BLD",7092,"KRN",8989.52,0)
8989.52
"BLD",7092,"KRN",8994,0)
8994
"BLD",7092,"KRN","B",.4,.4)

"BLD",7092,"KRN","B",.401,.401)

"BLD",7092,"KRN","B",.402,.402)

"BLD",7092,"KRN","B",.403,.403)

"BLD",7092,"KRN","B",.5,.5)

"BLD",7092,"KRN","B",.84,.84)

"BLD",7092,"KRN","B",3.6,3.6)

"BLD",7092,"KRN","B",3.8,3.8)

"BLD",7092,"KRN","B",9.2,9.2)

"BLD",7092,"KRN","B",9.8,9.8)

"BLD",7092,"KRN","B",19,19)

"BLD",7092,"KRN","B",19.1,19.1)

"BLD",7092,"KRN","B",101,101)

"BLD",7092,"KRN","B",409.61,409.61)

"BLD",7092,"KRN","B",771,771)

"BLD",7092,"KRN","B",870,870)

"BLD",7092,"KRN","B",8989.51,8989.51)

"BLD",7092,"KRN","B",8989.52,8989.52)

"BLD",7092,"KRN","B",8994,8994)

"BLD",7092,"QUES",0)
^9.62^^
"BLD",7092,"REQB",0)
^9.611^1^1
"BLD",7092,"REQB",1,0)
EC*2.0*72^2
"BLD",7092,"REQB","B","EC*2.0*72",1)

"MBREQ")
0
"PKG",486,-1)
1^1
"PKG",486,0)
EVENT CAPTURE^EC^Event Capture Workload Capture System^
"PKG",486,20,0)
^9.402P^^
"PKG",486,22,0)
^9.49I^1^1
"PKG",486,22,1,0)
2.0^2960508^2981027^66481
"PKG",486,22,1,"PAH",1,0)
91^3070213^101035
"PKG",486,22,1,"PAH",1,1,0)
^^1^1^3070213
"PKG",486,22,1,"PAH",1,1,1,0)
This patch provides a fix to the EC Procedure Reason Report.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","ECRPRSN")
0^1^B80981844^B81423223
"RTN","ECRPRSN",1,0)
ECRPRSN ;ALB/JAP - Procedure Reasons Report;24 JAN 07
"RTN","ECRPRSN",2,0)
 ;;2.0; EVENT CAPTURE ;**5,18,47,63,72,91**;8 May 96;Build 2
"RTN","ECRPRSN",3,0)
EN ;entry point from menu option
"RTN","ECRPRSN",4,0)
 N JJ
"RTN","ECRPRSN",5,0)
 W ! S JJ=$$ASKLOC^ECRUTL I 'JJ G EXIT
"RTN","ECRPRSN",6,0)
 W ! S JJ=$$ASKDSS^ECRUTL I 'JJ G EXIT
"RTN","ECRPRSN",7,0)
 W ! S JJ=$$ASKREAS() I 'JJ G EXIT
"RTN","ECRPRSN",8,0)
 W !
"RTN","ECRPRSN",9,0)
 D RANGE
"RTN","ECRPRSN",10,0)
 I '$G(ECLOOP)!'$G(ECSD)!'$G(ECED) G EXIT
"RTN","ECRPRSN",11,0)
 W ! D DEVICE I POP G EXIT
"RTN","ECRPRSN",12,0)
 I $G(ZTSK) G EXIT
"RTN","ECRPRSN",13,0)
 I $G(IO("Q")),'$G(ZTSK) G EXIT
"RTN","ECRPRSN",14,0)
 D START,HOME^%ZIS
"RTN","ECRPRSN",15,0)
 G EXIT
"RTN","ECRPRSN",16,0)
 Q
"RTN","ECRPRSN",17,0)
START ;queued entry point or continuation
"RTN","ECRPRSN",18,0)
 D PROCESS
"RTN","ECRPRSN",19,0)
 U IO D PRINT Q:$D(ECGUI)
"RTN","ECRPRSN",20,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECRPRSN",21,0)
 I $D(ZTQUEUED) S ZTREQ="@" D EXIT
"RTN","ECRPRSN",22,0)
 Q
"RTN","ECRPRSN",23,0)
ASKREAS()        ; Ask reasons
"RTN","ECRPRSN",24,0)
 ;   output: ECREAS array; contains set of reason iens
"RTN","ECRPRSN",25,0)
 N DIRUT,DUOUT,DTOUT,Y,DIR,A,P,R,S,JJ,KK,NLOC,NUNIT,LINK,ECREAS,E
"RTN","ECRPRSN",26,0)
 ;setup array of associated reason iens for the locations/units included
"RTN","ECRPRSN",27,0)
 W !!,"Just a moment please..."
"RTN","ECRPRSN",28,0)
 W !,?5,"...finding Procedure Reasons related to the"
"RTN","ECRPRSN",29,0)
 W !,?5,"   Location(s) and DSS Unit(s) you selected...",!
"RTN","ECRPRSN",30,0)
 S JJ="" F  S JJ=$O(ECLOC(JJ)) Q:JJ=""  D
"RTN","ECRPRSN",31,0)
 .S NLOC=$P(ECLOC(JJ),"^",1)
"RTN","ECRPRSN",32,0)
 .S KK="" F  S KK=$O(ECDSSU(KK)) Q:KK=""  S NUNIT=$P(ECDSSU(KK),"^",1),A(NLOC_"-"_NUNIT)=""
"RTN","ECRPRSN",33,0)
 S P=""
"RTN","ECRPRSN",34,0)
 F  S P=$O(^ECJ("B",P)) Q:P=""  I $D(A($P(P,"-",1,2))) S I=$O(^ECJ("B",P,"")),S(I)=""
"RTN","ECRPRSN",35,0)
 K A S P="" F  S P=$O(^ECL("AD",P)) Q:P=""  I $D(S(P)) S R="" D
"RTN","ECRPRSN",36,0)
 .F  S R=$O(^ECL("AD",P,R)) Q:R=""  D
"RTN","ECRPRSN",37,0)
 ..S LINK=$O(^ECL("AD",P,R,"")),ECLINK(LINK)=R
"RTN","ECRPRSN",38,0)
 ..S ECREAS(R)=$P($G(^ECR(R,0)),"^",1)
"RTN","ECRPRSN",39,0)
 ..I ECREAS(R)="" K ECREAS(R),ECLINK(LINK)
"RTN","ECRPRSN",40,0)
 K S
"RTN","ECRPRSN",41,0)
 ;ask the user to include all reasons or selected reasons
"RTN","ECRPRSN",42,0)
 S ASK=1
"RTN","ECRPRSN",43,0)
 S DIR(0)="YA",DIR("A")="Do you want to print this report for all Procedure Reasons? "
"RTN","ECRPRSN",44,0)
 S DIR("B")="YES" W ! D ^DIR K DIR I Y=0,'$G(DIRUT) D SPECR
"RTN","ECRPRSN",45,0)
 I $G(DIRUT)!(Y=0) S ASK=0 K ECREAS
"RTN","ECRPRSN",46,0)
 ;display user selections
"RTN","ECRPRSN",47,0)
 I $D(ECREAS)>1 D
"RTN","ECRPRSN",48,0)
 .W @IOF S E=0 W !,"Selected Procedure Reasons --",!
"RTN","ECRPRSN",49,0)
 .S R="" F  S R=$O(ECREAS(R)) Q:R=""  D  I E Q
"RTN","ECRPRSN",50,0)
 ..I $Y+3>IOSL S DIR(0)="E" D ^DIR K DIR S:'Y E=1 Q:'Y  D
"RTN","ECRPRSN",51,0)
 ...W @IOF,!,"Selected Procedure Reasons (cont.) --",!
"RTN","ECRPRSN",52,0)
 ..W !,?5,ECREAS(R)
"RTN","ECRPRSN",53,0)
 .Q:E  S DIR(0)="E" D  D ^DIR K DIR
"RTN","ECRPRSN",54,0)
 ..S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECRPRSN",55,0)
 Q ASK
"RTN","ECRPRSN",56,0)
SPECR ;specific reasons
"RTN","ECRPRSN",57,0)
 N R,DUOUT,DTOUT
"RTN","ECRPRSN",58,0)
 K DIRUT,Y
"RTN","ECRPRSN",59,0)
 S DIR(0)="YA",DIR("A")="Do you want to include only specific Procedure Reasons in this report? ",DIR("B")="YES"
"RTN","ECRPRSN",60,0)
 S DIR("?")="Enter YES to select specific Procedure Reasons or NO to quit."
"RTN","ECRPRSN",61,0)
 W ! D ^DIR K DIR Q:$G(DIRUT)!(Y=0)
"RTN","ECRPRSN",62,0)
 ;select subset of possible reasons
"RTN","ECRPRSN",63,0)
 K DIRUT,DTOUT,DUOUT,Y
"RTN","ECRPRSN",64,0)
 F  D  Q:$G(DIRUT)!(Y=-1)
"RTN","ECRPRSN",65,0)
 .S DIC=720.4,DIC("A")="Select a Procedure Reason to include: ",DIC(0)="QAEM"
"RTN","ECRPRSN",66,0)
 .S DIC("S")="I $D(ECREAS(+Y))"
"RTN","ECRPRSN",67,0)
 .W ! D ^DIC Q:$G(DUOUT)!$G(DTOUT)!(Y=-1)
"RTN","ECRPRSN",68,0)
 .S R(+Y)=""
"RTN","ECRPRSN",69,0)
 S:$G(DTOUT)!($G(DUOUT)) DIRUT=1
"RTN","ECRPRSN",70,0)
 Q:$G(DIRUT)
"RTN","ECRPRSN",71,0)
 ;delete reasons from ecreas array which were not selected
"RTN","ECRPRSN",72,0)
 I $D(R)<10 S Y=0 Q
"RTN","ECRPRSN",73,0)
 S R="" F  S R=$O(ECREAS(R)) Q:R=""  I '$D(R(R)) K ECREAS(R)
"RTN","ECRPRSN",74,0)
 ;delete links from eclink array for reasons not selected
"RTN","ECRPRSN",75,0)
 S LINK="" F  S LINK=$O(ECLINK(LINK)) Q:LINK=""  S R=ECLINK(LINK) I '$D(ECREAS(R)) K ECLINK(LINK)
"RTN","ECRPRSN",76,0)
 S Y=1
"RTN","ECRPRSN",77,0)
 Q
"RTN","ECRPRSN",78,0)
RANGE ;get any date range
"RTN","ECRPRSN",79,0)
 N ECSTDT,ECENDDT
"RTN","ECRPRSN",80,0)
 W !!!,?5,"Enter a Begin Date and End Date for the Event Capture "
"RTN","ECRPRSN",81,0)
 W !,?5,"Procedure Reason Report.",!
"RTN","ECRPRSN",82,0)
 S (ECSD,ECED)=0
"RTN","ECRPRSN",83,0)
 F  D  Q:ECSD>0  Q:'$G(ECLOOP)
"RTN","ECRPRSN",84,0)
 .S ECLOOP=$$STDT^ECRUTL() I 'ECLOOP Q
"RTN","ECRPRSN",85,0)
 .S ECSD=ECSTDT
"RTN","ECRPRSN",86,0)
 Q:'$G(ECLOOP)!'$G(ECSD)
"RTN","ECRPRSN",87,0)
 F  D  Q:ECED>0  Q:'$G(ECLOOP)
"RTN","ECRPRSN",88,0)
 .S ECLOOP=$$ENDDT^ECRUTL(ECSTDT) I 'ECLOOP Q
"RTN","ECRPRSN",89,0)
 .S ECED=ECENDDT
"RTN","ECRPRSN",90,0)
 .I ECED>(DT+1) D
"RTN","ECRPRSN",91,0)
 ..W !!,?15,"The End Date for this report may not be"
"RTN","ECRPRSN",92,0)
 ..W !,?15,"a future date.  Try again...",!
"RTN","ECRPRSN",93,0)
 ..S ECED=0
"RTN","ECRPRSN",94,0)
 Q 
"RTN","ECRPRSN",95,0)
 ;
"RTN","ECRPRSN",96,0)
DEVICE ;select output device
"RTN","ECRPRSN",97,0)
 W ! K IOP,ZTSK S %ZIS="QM" D ^%ZIS
"RTN","ECRPRSN",98,0)
 I POP W !!,"No device selected.  Exiting...",!! S DIR(0)="E" W ! D ^DIR K DIR Q
"RTN","ECRPRSN",99,0)
 I $D(IO("Q")) D
"RTN","ECRPRSN",100,0)
 .S ZTRTN="START^ECRPRSN",ZTDESC="EC Procedure Reason Report"
"RTN","ECRPRSN",101,0)
 .S ZTSAVE("ECSD")="",ZTSAVE("ECED")="",ZTSAVE("ECLOC(")="",ZTSAVE("ECDSSU(")="",ZTSAVE("ECLINK(")=""
"RTN","ECRPRSN",102,0)
 .D ^%ZTLOAD D HOME^%ZIS
"RTN","ECRPRSN",103,0)
 .I '$G(ZTSK) W !,"Report canceled..." S DIR(0)="E" W ! D ^DIR K DIR Q
"RTN","ECRPRSN",104,0)
 .W !,"Report queued as Task #: ",ZTSK S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECRPRSN",105,0)
 Q
"RTN","ECRPRSN",106,0)
 ;
"RTN","ECRPRSN",107,0)
PROCESS ;get data to print
"RTN","ECRPRSN",108,0)
 N EC,ECD,ECDA,ECPA,ECR,ECRL,ECRN,ECPATN,ECSS,ECSSN,ECP,ECPN,ECLOCA
"RTN","ECRPRSN",109,0)
 N ECUNIT,ECCAT,ECFILE,ECPSY,ECPSYN,ECPRV,ECPRVN,ECDFN,ECCPT,ECDESC
"RTN","ECRPRSN",110,0)
 N NLOC,NUNIT,JJ,ECMOD,ECMD,ECMODF,EC725
"RTN","ECRPRSN",111,0)
 K ^TMP("ECREAS",$J)
"RTN","ECRPRSN",112,0)
 ;if ecreas array doesn't exist, quit
"RTN","ECRPRSN",113,0)
 I $D(ECLINK)<10 Q
"RTN","ECRPRSN",114,0)
 ;put locations and units into ien subscripted arrays
"RTN","ECRPRSN",115,0)
 S JJ="" F  S JJ=$O(ECLOC(JJ)) Q:JJ=""  D
"RTN","ECRPRSN",116,0)
 .S NLOC($P(ECLOC(JJ),"^",1))=$P(ECLOC(JJ),"^",2)
"RTN","ECRPRSN",117,0)
 S JJ="" F  S JJ=$O(ECDSSU(JJ)) Q:JJ=""  D
"RTN","ECRPRSN",118,0)
 .S NUNIT($P(ECDSSU(JJ),"^",1))=$P(ECDSSU(JJ),"^",2)
"RTN","ECRPRSN",119,0)
 S ECD=ECSD F  S ECD=$O(^ECH("AC",ECD)) Q:'ECD  Q:ECD>ECED  D
"RTN","ECRPRSN",120,0)
 .S ECDA="" F  S ECDA=$O(^ECH("AC",ECD,ECDA)) Q:'ECDA  S EC=$G(^ECH(ECDA,0))  I $P(EC,"^",23)'="" D
"RTN","ECRPRSN",121,0)
 ..S ECDFN=$P(EC,"^")
"RTN","ECRPRSN",122,0)
 ..I $P(EC,"^",3)<ECSD!($P(EC,"^",3)>ECED) Q  ;file or x-ref problem
"RTN","ECRPRSN",123,0)
 ..S ECLOCA=+$P(EC,U,4),ECUNIT=+$P(EC,U,7)
"RTN","ECRPRSN",124,0)
 ..I '$D(NLOC(ECLOCA))!('$D(NUNIT(ECUNIT))) Q
"RTN","ECRPRSN",125,0)
 ..S ECRL=$P(EC,"^",23) Q:'$D(ECLINK(ECRL))  S ECR=ECLINK(ECRL),ECRN=$P($G(^ECR(ECR,0)),"^") Q:ECRN']""
"RTN","ECRPRSN",126,0)
 ..S ECP=$P(EC,U,9) Q:ECP']""
"RTN","ECRPRSN",127,0)
 ..S ECCAT=+$P(EC,U,8),ECPSY=+$O(^ECJ("AP",ECLOCA,ECUNIT,ECCAT,ECP,""))
"RTN","ECRPRSN",128,0)
 ..S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2),ECPI=""
"RTN","ECRPRSN",129,0)
 ..S ECFILE=$P(ECP,";",2),ECFILE=$S($E(ECFILE)="I":81,$E(ECFILE)="E":725,1:"UNKNOWN")
"RTN","ECRPRSN",130,0)
 ..S ECCPT=$S(ECFILE=81:+ECP,1:$P($G(^EC(725,+ECP,0)),"^",5))
"RTN","ECRPRSN",131,0)
 ..I ECCPT'="" D
"RTN","ECRPRSN",132,0)
 ...S ECPI=$$CPT^ICPTCOD(ECCPT,$P(ECED,".")) I +ECPI>1 S ECCPT=$P(ECPI,"^",2)_" "
"RTN","ECRPRSN",133,0)
 ..I ECFILE="UNKNOWN" S ECPN="UNKNOWN"
"RTN","ECRPRSN",134,0)
 ..I ECFILE=81 S ECPN=$S($P(ECPI,"^",3)]"":$P(ECPI,"^",3),1:"UNKNOWN")
"RTN","ECRPRSN",135,0)
 ..I ECFILE=725 S EC725=$G(^EC(725,+ECP,0)),ECPN=$P(EC725,"^",2)_" "_$P(EC725,"^")
"RTN","ECRPRSN",136,0)
 ..Q:ECPN=""
"RTN","ECRPRSN",137,0)
 ..S ECDESC=$J(ECCPT_" ",6)_$E(ECPN,1,40)_$S(ECPSYN]"":" ["_ECPSYN_"] ",1:"")
"RTN","ECRPRSN",138,0)
 ..S (ECPA,ECPATN,ECSS)="",ECPA=$G(^DPT(+$P(EC,"^",2),0)) Q:ECPA=""
"RTN","ECRPRSN",139,0)
 ..S ECPATN=$E($P(ECPA,"^",1),1,24),ECSS=$P(ECPA,"^",9)
"RTN","ECRPRSN",140,0)
 ..S:+ECSS ECSSN=$E(ECSS,6,9) S:ECSS="" ECSSN="UNKNOWN"
"RTN","ECRPRSN",141,0)
 ..S:ECPATN="" ECPATN="UNKNOWN" S ECPATN=ECPATN_"^"_ECSSN
"RTN","ECRPRSN",142,0)
 ..S (ECPRV,ECPRVN)="",ECPRV=$$GETPPRV^ECPRVMUT(ECDA,.ECPRVN),ECPRVN=$S(ECPRV:"UNKNOWN",1:ECPRVN)
"RTN","ECRPRSN",143,0)
 ..S ECMD="" I $O(^ECH(ECDA,"MOD",0))'="" D  ;ALB/JAM - Get CPT modifiers
"RTN","ECRPRSN",144,0)
 ...K ECMOD S ECMODF=$$MOD^ECUTL(ECDA,"I",.ECMOD),SEQ="" I 'ECMODF Q
"RTN","ECRPRSN",145,0)
 ...F  S SEQ=$O(ECMOD(SEQ)) Q:SEQ=""  S ECMD=ECMD_$S(ECMD="":"",1:";")_$P(ECMOD(SEQ),"^",2)
"RTN","ECRPRSN",146,0)
 ..I ECMD="" S ECMD="NOMOD"
"RTN","ECRPRSN",147,0)
 ..S ^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECRN,$E(ECPN,1,15))=ECDESC
"RTN","ECRPRSN",148,0)
 ..S ^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECRN,$E(ECPN,1,15),ECMD,ECDFN,ECD)=ECPRVN_"^"_ECPATN
"RTN","ECRPRSN",149,0)
 ..;where ecloca, ecunit,ecdfn are iens, ecdt is internal format
"RTN","ECRPRSN",150,0)
 Q
"RTN","ECRPRSN",151,0)
PRINT ;output report
"RTN","ECRPRSN",152,0)
 N ECLOCA,ECUNIT,ECREASN,ECDT,ECED2,ECSD2,ECPATN,ECPN,ECPRVN,SEQ,X,Y,SSN
"RTN","ECRPRSN",153,0)
 N PAGE,QFLAG,DASH,PRNTDT,JJ,SS,ALOC,AUNIT,DATE,LOC,UNIT,PTNAME,PROVN,ECDESC
"RTN","ECRPRSN",154,0)
 S (PAGE,QFLAG)=0 S $P(DASH,"-",80)=""
"RTN","ECRPRSN",155,0)
 S Y=$P(ECSD,".",1)+1 D DD^%DT S ECSD2=Y S Y=$P(ECED,".",1) D DD^%DT S ECED2=Y
"RTN","ECRPRSN",156,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S PRNTDT=Y
"RTN","ECRPRSN",157,0)
 ;if no data exists then print the header and quit
"RTN","ECRPRSN",158,0)
 I '$D(^TMP("ECREAS",$J)) D  Q
"RTN","ECRPRSN",159,0)
 .S (LOC,UNIT)="" D HEAD
"RTN","ECRPRSN",160,0)
 .W !!,?6,"No data for the date range specified.",!!
"RTN","ECRPRSN",161,0)
 .I $E(IOST)="C"&('QFLAG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","ECRPRSN",162,0)
 ..S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECRPRSN",163,0)
 .W:$E(IOST)'="C" @IOF
"RTN","ECRPRSN",164,0)
 ;if there's data in ^TMP then need to present the data alphabetically;
"RTN","ECRPRSN",165,0)
 ;put locations and units in alpha ordered array
"RTN","ECRPRSN",166,0)
 S JJ="" F  S JJ=$O(ECLOC(JJ)) Q:JJ=""  D
"RTN","ECRPRSN",167,0)
 .S ALOC($P(ECLOC(JJ),"^",2))=$P(ECLOC(JJ),"^",1)
"RTN","ECRPRSN",168,0)
 S JJ="" F  S JJ=$O(ECDSSU(JJ)) Q:JJ=""  D
"RTN","ECRPRSN",169,0)
 .S AUNIT($P(ECDSSU(JJ),"^",2))=$P(ECDSSU(JJ),"^",1)
"RTN","ECRPRSN",170,0)
 ;process the ^TMP global data in alpha order for location and unit
"RTN","ECRPRSN",171,0)
 S LOC="" F  S LOC=$O(ALOC(LOC)) Q:LOC=""  S ECLOCA=ALOC(LOC) D  Q:QFLAG
"RTN","ECRPRSN",172,0)
 .S UNIT="" F  S UNIT=$O(AUNIT(UNIT)) Q:UNIT=""  S ECUNIT=AUNIT(UNIT) D  Q:QFLAG
"RTN","ECRPRSN",173,0)
 ..;always start a location at top of page
"RTN","ECRPRSN",174,0)
 ..I $D(^TMP("ECREAS",$J,ECLOCA,ECUNIT)) D HEAD D LOOP
"RTN","ECRPRSN",175,0)
 ;all done
"RTN","ECRPRSN",176,0)
 I $E(IOST)="C"&('QFLAG) S DIR(0)="E" D  D ^DIR W @IOF
"RTN","ECRPRSN",177,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECRPRSN",178,0)
 W:$E(IOST)'="C" @IOF
"RTN","ECRPRSN",179,0)
 Q
"RTN","ECRPRSN",180,0)
LOOP ;print the section of the ^tmp global for a specific location/unit
"RTN","ECRPRSN",181,0)
 S ECREASN=""
"RTN","ECRPRSN",182,0)
 F  S ECREASN=$O(^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECREASN)) Q:ECREASN=""  Q:QFLAG  D
"RTN","ECRPRSN",183,0)
 .D:($Y+3>IOSL) HEAD Q:QFLAG  W !!,"Reason: ",ECREASN,! S ECPN=""
"RTN","ECRPRSN",184,0)
 .F  S ECPN=$O(^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECREASN,ECPN)) Q:ECPN=""  Q:QFLAG  D
"RTN","ECRPRSN",185,0)
 ..S ECDESC=$G(^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECREASN,ECPN)),ECMOD=""
"RTN","ECRPRSN",186,0)
 ..F  S ECMOD=$O(^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECREASN,ECPN,ECMOD)) Q:ECMOD=""  D  Q:QFLAG
"RTN","ECRPRSN",187,0)
 ...W !,?3,"Procedure: ",ECDESC D:ECMOD'="NOMOD" MODPRT Q:QFLAG  D LOOP1
"RTN","ECRPRSN",188,0)
 Q
"RTN","ECRPRSN",189,0)
LOOP1 S ECPATN="" F  S ECPATN=$O(^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECREASN,ECPN,ECMOD,ECPATN)) Q:ECPATN=""  Q:QFLAG  D
"RTN","ECRPRSN",190,0)
 .S ECDT="" F  S ECDT=$O(^TMP("ECREAS",$J,ECLOCA,ECUNIT,ECREASN,ECPN,ECMOD,ECPATN,ECDT)) Q:ECDT=""  Q:QFLAG  D
"RTN","ECRPRSN",191,0)
 ..S ECPRVN=^(ECDT),PTNAME=$P(ECPRVN,"^",3),PTNAME=$E(PTNAME,1,22)
"RTN","ECRPRSN",192,0)
 ..S SSN=$P(ECPRVN,"^",4),ECPRVN=$P(ECPRVN,"^",2)
"RTN","ECRPRSN",193,0)
 ..S Y=ECDT D DD^%DT S DATE=$E(Y,1,18),PROVN=$E(ECPRVN,1,22)
"RTN","ECRPRSN",194,0)
 ..D:($Y+3>IOSL) HEAD Q:QFLAG  W !,?6,PTNAME,?30,SSN,?37,DATE,?57,PROVN
"RTN","ECRPRSN",195,0)
 W !
"RTN","ECRPRSN",196,0)
 Q
"RTN","ECRPRSN",197,0)
MODPRT ;ALB/JAM - print CPT procedure modifiers
"RTN","ECRPRSN",198,0)
 N MOD,I,MODESC,IEN,MODI
"RTN","ECRPRSN",199,0)
 W !?4,"Modifier: "
"RTN","ECRPRSN",200,0)
 F I=1:1 S IEN=$P(ECMOD,";",I) Q:IEN=""  D  I QFLAG Q
"RTN","ECRPRSN",201,0)
 . S MODI=$$MOD^ICPTMOD(IEN,"E",$P(ECED,".")),MOD=$P(MODI,"^",2) I MOD="" Q
"RTN","ECRPRSN",202,0)
 . S MODESC=$P(MODI,"^",3) I MODESC="UNKNOWN" Q
"RTN","ECRPRSN",203,0)
 . W:I>1 ! W ?18,"- ",MOD," ",MODESC I ($Y+3)>IOSL D HEAD
"RTN","ECRPRSN",204,0)
 Q
"RTN","ECRPRSN",205,0)
HEAD ;header
"RTN","ECRPRSN",206,0)
 I $E(IOST)="C" S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECRPRSN",207,0)
 I $E(IOST)="C",PAGE>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLAG=1 Q
"RTN","ECRPRSN",208,0)
 W:$Y!($E(IOST)="C") @IOF
"RTN","ECRPRSN",209,0)
 S PAGE=PAGE+1
"RTN","ECRPRSN",210,0)
 W !,?12,"Event Capture Procedure Reason Report"
"RTN","ECRPRSN",211,0)
 W !,?12,"for the Date Range ",$$FMTE^XLFDT(ECSD2)," to ",$$FMTE^XLFDT(ECED2),!
"RTN","ECRPRSN",212,0)
 W !,?3,"DSS Unit: ",UNIT,?55,"Page: ",PAGE
"RTN","ECRPRSN",213,0)
 W !,?3,"Location: ",LOC,?52,"Printed: "_PRNTDT,!
"RTN","ECRPRSN",214,0)
 W !?6,"Patient",?30,"SSN",?37,"Date/Time",?57,"Provider"
"RTN","ECRPRSN",215,0)
 W !,DASH
"RTN","ECRPRSN",216,0)
 Q
"RTN","ECRPRSN",217,0)
EXIT ;common exit point
"RTN","ECRPRSN",218,0)
 D ^ECKILL D:'$D(ECGUI) ^%ZISC
"RTN","ECRPRSN",219,0)
 K ^TMP("ECREAS",$J) K JJ,X,Y,ZTSK,IO("Q"),DIR,DIRUT,DTOUT,DUOUT,ECSD
"RTN","ECRPRSN",220,0)
 K ECED,ECLOOP,ECLOC,ECDSSU,ECLINK,ASK,DIC
"RTN","ECRPRSN",221,0)
 Q
"VER")
8.0^22.0
"BLD",7092,6)
^83
**END**
**END**
