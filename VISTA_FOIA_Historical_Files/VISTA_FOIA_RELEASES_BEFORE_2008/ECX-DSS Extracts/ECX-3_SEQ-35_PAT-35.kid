Released ECX*3*35 SEQ #35
Extracted from mail message
**KIDS**:ECX*3.0*35^

**INSTALL NAME**
ECX*3.0*35
"BLD",3325,0)
ECX*3.0*35^DSS EXTRACTS^0^3010406^y
"BLD",3325,1,0)
^^1^1^3010319^
"BLD",3325,1,1,0)
Miscellaneous fixes
"BLD",3325,4,0)
^9.64PA^^
"BLD",3325,"ABPKG")
n
"BLD",3325,"INIT")
ECX335PT
"BLD",3325,"KRN",0)
^9.67PA^19^17
"BLD",3325,"KRN",.4,0)
.4
"BLD",3325,"KRN",.401,0)
.401
"BLD",3325,"KRN",.402,0)
.402
"BLD",3325,"KRN",.403,0)
.403
"BLD",3325,"KRN",.5,0)
.5
"BLD",3325,"KRN",.84,0)
.84
"BLD",3325,"KRN",3.6,0)
3.6
"BLD",3325,"KRN",3.8,0)
3.8
"BLD",3325,"KRN",9.2,0)
9.2
"BLD",3325,"KRN",9.8,0)
9.8
"BLD",3325,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",3325,"KRN",9.8,"NM",1,0)
ECXPURG^^0^B14952621
"BLD",3325,"KRN",9.8,"NM",2,0)
ECXAECQ^^0^B32812856
"BLD",3325,"KRN",9.8,"NM",3,0)
ECXUTL2^^0^B55669430
"BLD",3325,"KRN",9.8,"NM",4,0)
ECXUTL3^^0^B49806168
"BLD",3325,"KRN",9.8,"NM",5,0)
ECXTRT^^0^B33893183
"BLD",3325,"KRN",9.8,"NM","B","ECXAECQ",2)

"BLD",3325,"KRN",9.8,"NM","B","ECXPURG",1)

"BLD",3325,"KRN",9.8,"NM","B","ECXTRT",5)

"BLD",3325,"KRN",9.8,"NM","B","ECXUTL2",3)

"BLD",3325,"KRN",9.8,"NM","B","ECXUTL3",4)

"BLD",3325,"KRN",19,0)
19
"BLD",3325,"KRN",19,"NM",0)
^9.68A^^
"BLD",3325,"KRN",19.1,0)
19.1
"BLD",3325,"KRN",101,0)
101
"BLD",3325,"KRN",409.61,0)
409.61
"BLD",3325,"KRN",771,0)
771
"BLD",3325,"KRN",870,0)
870
"BLD",3325,"KRN",8994,0)
8994
"BLD",3325,"KRN","B",.4,.4)

"BLD",3325,"KRN","B",.401,.401)

"BLD",3325,"KRN","B",.402,.402)

"BLD",3325,"KRN","B",.403,.403)

"BLD",3325,"KRN","B",.5,.5)

"BLD",3325,"KRN","B",.84,.84)

"BLD",3325,"KRN","B",3.6,3.6)

"BLD",3325,"KRN","B",3.8,3.8)

"BLD",3325,"KRN","B",9.2,9.2)

"BLD",3325,"KRN","B",9.8,9.8)

"BLD",3325,"KRN","B",19,19)

"BLD",3325,"KRN","B",19.1,19.1)

"BLD",3325,"KRN","B",101,101)

"BLD",3325,"KRN","B",409.61,409.61)

"BLD",3325,"KRN","B",771,771)

"BLD",3325,"KRN","B",870,870)

"BLD",3325,"KRN","B",8994,8994)

"BLD",3325,"QUES",0)
^9.62^^
"BLD",3325,"REQB",0)
^9.611^1^1
"BLD",3325,"REQB",1,0)
ECX*3.0*33^1
"BLD",3325,"REQB","B","ECX*3.0*33",1)

"INIT")
ECX335PT
"MBREQ")
0
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010108^2980112^11714
"PKG",513,22,1,"PAH",1,0)
35^3010406
"PKG",513,22,1,"PAH",1,1,0)
^^1^1^3010406
"PKG",513,22,1,"PAH",1,1,1,0)
Miscellaneous fixes
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","ECX335PT")
0^^B2347310
"RTN","ECX335PT",1,0)
ECX335PT ;ALB/DKK/ESD - PATCH ECX*3.0*35 Post-Init ; 01/15/01
"RTN","ECX335PT",2,0)
 ;;3.0;DSS EXTRACTS;**35**;Jan 15, 2001
"RTN","ECX335PT",3,0)
 ;
"RTN","ECX335PT",4,0)
 ; This cleanup routine will delete records in the CLINIC II (CLJ) 
"RTN","ECX335PT",5,0)
 ; Extract file (#727.818) if corresponding entries in the CLINIC I 
"RTN","ECX335PT",6,0)
 ; (CLI) Extract file (#727.816) do not exist as a result of an
"RTN","ECX335PT",7,0)
 ; incomplete CLJ extract purge.
"RTN","ECX335PT",8,0)
 ;
"RTN","ECX335PT",9,0)
EN ;- Entry point for cleanup
"RTN","ECX335PT",10,0)
 ;
"RTN","ECX335PT",11,0)
 N ZTRTN,ZTDESC,ZTIO
"RTN","ECX335PT",12,0)
 D BMES^XPDUTL(">>> Searching for incomplete purged CLJ extracts. If found, the incomplete")
"RTN","ECX335PT",13,0)
 D MES^XPDUTL(">>> purged CLJ extract records will be deleted from file #727.818.")
"RTN","ECX335PT",14,0)
 D MES^XPDUTL(">>> This purge will be queued.")
"RTN","ECX335PT",15,0)
 D MES^XPDUTL("")
"RTN","ECX335PT",16,0)
 ;
"RTN","ECX335PT",17,0)
 ;- Task job
"RTN","ECX335PT",18,0)
 S ZTRTN="DEL818^ECX335PT"
"RTN","ECX335PT",19,0)
 S ZTDESC="Deleting incomplete purged CLJ Extract records (#727.818)"
"RTN","ECX335PT",20,0)
 S ZTIO=""
"RTN","ECX335PT",21,0)
 D ^%ZTLOAD
"RTN","ECX335PT",22,0)
 D BMES^XPDUTL($S(+ZTSK:">>> Queued: Task# "_ZTSK,1:">>> Not Queued!"))
"RTN","ECX335PT",23,0)
 Q
"RTN","ECX335PT",24,0)
 ;
"RTN","ECX335PT",25,0)
 ;
"RTN","ECX335PT",26,0)
DEL818 ;- Compare CLJ with CLI extract log number and delete CLJ record if no
"RTN","ECX335PT",27,0)
 ;  matching CLI record is found
"RTN","ECX335PT",28,0)
 ;
"RTN","ECX335PT",29,0)
 N BAT,DA,DIK,ECJ
"RTN","ECX335PT",30,0)
 S BAT=0
"RTN","ECX335PT",31,0)
 F  S BAT=$O(^ECX(727.818,"AC",BAT)) Q:'BAT  D
"RTN","ECX335PT",32,0)
 . Q:$D(^ECX(727.816,"AC",BAT))
"RTN","ECX335PT",33,0)
 . S ECJ=0
"RTN","ECX335PT",34,0)
 . F  S ECJ=$O(^ECX(727.818,"AC",BAT,ECJ)) Q:'ECJ  D
"RTN","ECX335PT",35,0)
 .. S DIK="^ECX(727.818,",DA=ECJ D ^DIK
"RTN","ECX335PT",36,0)
 Q
"RTN","ECXAECQ")
0^2^B32812856
"RTN","ECXAECQ",1,0)
ECXAECQ ;ALB/JAP - ECQ Extract Audit Report ;Oct 16, 1997
"RTN","ECXAECQ",2,0)
 ;;3.0;DSS EXTRACTS;**8,33,35**;Dec 22, 1997
"RTN","ECXAECQ",3,0)
 ;
"RTN","ECXAECQ",4,0)
EN ;entry point for ECQ extract audit report
"RTN","ECXAECQ",5,0)
 N %X,%Y,X,Y,DIC,DA,DR,DIQ,DIR
"RTN","ECXAECQ",6,0)
 S ECXERR=0
"RTN","ECXAECQ",7,0)
 ;ecxaud=0 for 'extract' audit
"RTN","ECXAECQ",8,0)
 S ECXHEAD="ECQ",ECXAUD=0
"RTN","ECXAECQ",9,0)
 W !!,"Setup for ",ECXHEAD," Extract Audit Report --",!!
"RTN","ECXAECQ",10,0)
 ;select extract
"RTN","ECXAECQ",11,0)
 D AUDIT^ECXUTLA(ECXHEAD,.ECXERR,.ECXARRAY,ECXAUD)
"RTN","ECXAECQ",12,0)
 Q:ECXERR
"RTN","ECXAECQ",13,0)
 ;currently, quasar does not accommodate multi-divisional sites
"RTN","ECXAECQ",14,0)
 S ECXALL=0
"RTN","ECXAECQ",15,0)
 D ECQ^ECXDVSN1(.ECXDIV,ECXALL,.ECXERR)
"RTN","ECXAECQ",16,0)
 I ECXERR=1 D  Q
"RTN","ECXAECQ",17,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXAECQ",18,0)
 .D AUDIT^ECXKILL
"RTN","ECXAECQ",19,0)
 ;determine output device and queue if requested
"RTN","ECXAECQ",20,0)
 W !
"RTN","ECXAECQ",21,0)
 S ECXPGM="PROCESS^ECXAECQ",ECXDESC="ECQ Extract Audit Report"
"RTN","ECXAECQ",22,0)
 S ECXSAVE("ECXHEAD")="",ECXSAVE("ECXALL")="",ECXSAVE("ECXDIV(")="",ECXSAVE("ECXARRAY(")=""
"RTN","ECXAECQ",23,0)
 W !
"RTN","ECXAECQ",24,0)
 D DEVICE^ECXUTLA(ECXPGM,ECXDESC,.ECXSAVE)
"RTN","ECXAECQ",25,0)
 I ECXSAVE("POP")=1 D  Q
"RTN","ECXAECQ",26,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXAECQ",27,0)
 .D AUDIT^ECXKILL
"RTN","ECXAECQ",28,0)
 I ECXSAVE("ZTSK")=0 D
"RTN","ECXAECQ",29,0)
 .K ECXSAVE,ECXPGM,ECXDESC
"RTN","ECXAECQ",30,0)
 .D PROCESS^ECXAECQ
"RTN","ECXAECQ",31,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXAECQ",32,0)
 D HOME^%ZIS
"RTN","ECXAECQ",33,0)
 D AUDIT^ECXKILL
"RTN","ECXAECQ",34,0)
 Q
"RTN","ECXAECQ",35,0)
 ;
"RTN","ECXAECQ",36,0)
PROCESS ;process data in file #727.825
"RTN","ECXAECQ",37,0)
 N X,Y,W,ADIV,DATA,DATE,DIV,DIVACK,IEN,LOC
"RTN","ECXAECQ",38,0)
 N UNIT,UNITN,VOL,PROC,PROCN,SDIV,QQFLG,CNT
"RTN","ECXAECQ",39,0)
 K ^TMP($J,"ECXAUD"),^TMP($J,"ECXPROC")
"RTN","ECXAECQ",40,0)
 S (CNT,QQFLG)=0,ECXEXT=ECXARRAY("EXTRACT"),ECXDEF=ECXARRAY("DEF")
"RTN","ECXAECQ",41,0)
 S X=ECXARRAY("START") D ^%DT S ECXSTART=Y,X=ECXARRAY("END")
"RTN","ECXAECQ",42,0)
 D ^%DT S ECXEND=Y
"RTN","ECXAECQ",43,0)
 ;get run date in external format
"RTN","ECXAECQ",44,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S ECXRUN=Y
"RTN","ECXAECQ",45,0)
 ;get the dss unit links for this division/site
"RTN","ECXAECQ",46,0)
 S DIV=0
"RTN","ECXAECQ",47,0)
 F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  D
"RTN","ECXAECQ",48,0)
 .S DIVACK=$P(ECXDIV(DIV),U,1),ECXLINK(DIV)=^ACK(509850.8,DIVACK,"DSS")
"RTN","ECXAECQ",49,0)
 ;get extract records in date range
"RTN","ECXAECQ",50,0)
 S IEN=""
"RTN","ECXAECQ",51,0)
 F  S IEN=$O(^ECX(727.825,"AC",ECXEXT,IEN)) Q:IEN=""  D  Q:QQFLG
"RTN","ECXAECQ",52,0)
 .S DATA=^ECX(727.825,IEN,0),DIV=$P(DATA,U,4),DATE=$P(DATA,U,9)
"RTN","ECXAECQ",53,0)
 .S ADIV=$P(^ECX(727.825,IEN,1),U,11) S:ADIV="" ADIV="UNK"
"RTN","ECXAECQ",54,0)
 .I +ADIV S X=^DG(40.8,ADIV,0),ADIV=$P(X,U)_" ("_$P(X,U,2)_")"
"RTN","ECXAECQ",55,0)
 .;convert free text date to fm internal format date
"RTN","ECXAECQ",56,0)
 .S $E(DATE,1,2)=$E(DATE,1,2)-17
"RTN","ECXAECQ",57,0)
 .Q:$L(DATE)<7  Q:(DATE<ECXSTART)  Q:(DATE>ECXEND)
"RTN","ECXAECQ",58,0)
 .;if location is among those selected, then tally event capture data
"RTN","ECXAECQ",59,0)
 .I $D(ECXDIV(DIV)) D  Q:QQFLG
"RTN","ECXAECQ",60,0)
 ..;any quasar site that doesn't have links to dss is identified by "xx"
"RTN","ECXAECQ",61,0)
 ..S UNIT=$P(DATA,U,10)
"RTN","ECXAECQ",62,0)
 ..S LOC=$S(UNIT=$P(ECXLINK(DIV),U,1):"A",UNIT=$P(ECXLINK(DIV),U,2):"S",1:"XX")
"RTN","ECXAECQ",63,0)
 ..;any invalid cpt code is identified as "xxxxx"
"RTN","ECXAECQ",64,0)
 ..S PROC=$E($P(DATA,U,29),1,5),VOL=$P(DATA,U,13)
"RTN","ECXAECQ",65,0)
 ..S PROCN=$P($G(^ICPT(+PROC,0)),U,2),PROC="A"_PROC S:VOL="" VOL=1
"RTN","ECXAECQ",66,0)
 ..S:PROCN="" PROCN="Unknown"
"RTN","ECXAECQ",67,0)
 ..I '$D(^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC)) S ^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC)=0_U_PROCN
"RTN","ECXAECQ",68,0)
 ..S $P(^(PROC),U,1)=$P(^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC),U,1)+VOL,CNT=CNT+1
"RTN","ECXAECQ",69,0)
 ..I $D(ZTQUEUED),(CNT>499),'(CNT#500),$$S^%ZTLOAD S QQFLG=1,ZTSTOP=1 K ZTREQ
"RTN","ECXAECQ",70,0)
 ;print the report
"RTN","ECXAECQ",71,0)
 D PRINT
"RTN","ECXAECQ",72,0)
 D AUDIT^ECXKILL
"RTN","ECXAECQ",73,0)
 Q
"RTN","ECXAECQ",74,0)
 ;
"RTN","ECXAECQ",75,0)
PRINT ;print quasar data by site and dss unit order
"RTN","ECXAECQ",76,0)
 N JJ,SS,LN,P,LOC,UNITN,PG,QFLG,GTOT,STOT,TOT,PROC,PROCN
"RTN","ECXAECQ",77,0)
 N DIR,DIRUT,DIV,DIVNM,DTOUT,DUOUT
"RTN","ECXAECQ",78,0)
 U IO
"RTN","ECXAECQ",79,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXAECQ",80,0)
 S (QFLG,PG)=0,$P(LN,"-",80)="",DIV=""
"RTN","ECXAECQ",81,0)
 F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  D  Q:QFLG
"RTN","ECXAECQ",82,0)
 .S DIVNM=$P(ECXDIV(DIV),U,2)_" ("_$P(ECXDIV(DIV),U,3)_")"
"RTN","ECXAECQ",83,0)
 .D HEADER Q:QFLG
"RTN","ECXAECQ",84,0)
 .S GTOT=0,STOT("A")=0,STOT("S")=0,STOT("XX")=0
"RTN","ECXAECQ",85,0)
 .I '$D(^TMP($J,"ECXAUD",DIV)) D  Q
"RTN","ECXAECQ",86,0)
 ..W !!,?5,"No data available for this QUASAR site.",!!
"RTN","ECXAECQ",87,0)
 .I $D(^TMP($J,"ECXAUD",DIV)) S ADIV="" D
"RTN","ECXAECQ",88,0)
 ..F  S ADIV=$O(^TMP($J,"ECXAUD",DIV,ADIV)) Q:ADIV=""  S LOC="" D  Q:QFLG
"RTN","ECXAECQ",89,0)
 ...F  S LOC=$O(^TMP($J,"ECXAUD",DIV,ADIV,LOC)) Q:LOC=""  D  Q:QFLG
"RTN","ECXAECQ",90,0)
 ....;write the unit name
"RTN","ECXAECQ",91,0)
 ....S UNITN=$S(LOC="A":"Audiology",LOC="S":"Speech Pathology",1:"Unknown"),PROC=""
"RTN","ECXAECQ",92,0)
 ....D:($Y+2>IOSL) HEADER Q:QFLG  W !,"Division: ("_ADIV_")",!?20,UNITN
"RTN","ECXAECQ",93,0)
 ....F  S PROC=$O(^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC)) Q:PROC=""  D  Q:QFLG
"RTN","ECXAECQ",94,0)
 .....S TOT=+^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC),PROCN=$P(^(PROC),U,2),P=$E(PROC,2,99)
"RTN","ECXAECQ",95,0)
 .....S SDIV(ADIV,LOC)=$G(SDIV(ADIV,LOC))+TOT
"RTN","ECXAECQ",96,0)
 .....S STOT(LOC)=STOT(LOC)+TOT,GTOT=GTOT+TOT
"RTN","ECXAECQ",97,0)
 .....D:($Y+3>IOSL) HEADER Q:QFLG  W !,?25,P,?35,$E(PROCN,1,30),?68,$$RJ^XLFSTR(TOT,5," ")
"RTN","ECXAECQ",98,0)
 ....;write the unit subtotal
"RTN","ECXAECQ",99,0)
 ....D:($Y+4>IOSL) HEADER Q:QFLG
"RTN","ECXAECQ",100,0)
 ....W !,?25,$E(LN,1,54)
"RTN","ECXAECQ",101,0)
 ....W !,"Volume for "_UNITN_":",?68,$$RJ^XLFSTR(+$G(SDIV(ADIV,LOC)),5," "),!!
"RTN","ECXAECQ",102,0)
 .;write the division grandtotal
"RTN","ECXAECQ",103,0)
 .D:($Y+5>IOSL) HEADER Q:QFLG
"RTN","ECXAECQ",104,0)
 .W !!,"Total Volume for Audiology:",?68,$$RJ^XLFSTR(STOT("A"),5," ")
"RTN","ECXAECQ",105,0)
 .W !,"Total Volume for Speech Pathology:",?68,$$RJ^XLFSTR(STOT("S"),5," ")
"RTN","ECXAECQ",106,0)
 .W !!,"Grand Total for Site "_DIVNM_":",?68,$$RJ^XLFSTR(GTOT,5," ")
"RTN","ECXAECQ",107,0)
 ;print the audit descriptive narrative
"RTN","ECXAECQ",108,0)
 I $E(IOST)'="C" D
"RTN","ECXAECQ",109,0)
 .W @IOF S PG=PG+1
"RTN","ECXAECQ",110,0)
 .W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXAECQ",111,0)
 .W !,"DSS Extract Log #:       "_ECXEXT
"RTN","ECXAECQ",112,0)
 .W !,"Date Range of Audit:     "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXAECQ",113,0)
 .W !,"Report Run Date/Time:    "_ECXRUN,?68,"Page: ",PG
"RTN","ECXAECQ",114,0)
 .W !!,LN,!!
"RTN","ECXAECQ",115,0)
 .S DIC="^ECX(727.1,",DA=ECXARRAY("DEF"),DR="1" D EN^DIQ
"RTN","ECXAECQ",116,0)
 I ($E(IOST)="C"),('QFLG) D
"RTN","ECXAECQ",117,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAECQ",118,0)
 .S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXAECQ",119,0)
 Q
"RTN","ECXAECQ",120,0)
 ;
"RTN","ECXAECQ",121,0)
HEADER ;header and page control
"RTN","ECXAECQ",122,0)
 N JJ,SS
"RTN","ECXAECQ",123,0)
 I ($E(IOST)="C"),('QFLG) D
"RTN","ECXAECQ",124,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAECQ",125,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXAECQ",126,0)
 Q:QFLG
"RTN","ECXAECQ",127,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXAECQ",128,0)
 W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXAECQ",129,0)
 W !,"DSS Extract Log #:    "_ECXARRAY("EXTRACT")
"RTN","ECXAECQ",130,0)
 W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXAECQ",131,0)
 W !,"Report Run Date/Time: "_ECXRUN
"RTN","ECXAECQ",132,0)
 W !,"QUASAR Site:         "_$P(ECXDIV(DIV),U,2)_"("_$P(ECXDIV(DIV),U,3)_")",?68,"Page: "_PG
"RTN","ECXAECQ",133,0)
 W !!,"DSS Unit",?25,"Procedure",?68,"Volume"
"RTN","ECXAECQ",134,0)
 W !,LN
"RTN","ECXAECQ",135,0)
 Q
"RTN","ECXPURG")
0^1^B14952621
"RTN","ECXPURG",1,0)
ECXPURG ;BIR/CML-Driver for Purge of DSS Data from Local Extract & Holding Files ; [ 12/03/96  5:19 PM ]
"RTN","ECXPURG",2,0)
 ;;3.0;DSS EXTRACTS;**9,24,33,35**;Dec 22, 1997
"RTN","ECXPURG",3,0)
EN ;entry point from option
"RTN","ECXPURG",4,0)
 W @IOF,!!,"This option will allow you to purge:"
"RTN","ECXPURG",5,0)
 W !,"1. individual or a range of DSS extracts, or"
"RTN","ECXPURG",6,0)
 W !,"2. data that resides in the ""holding files"" for the IVP and UDP extracts."
"RTN","ECXPURG",7,0)
 W !!,"Care must be taken for several reasons:"
"RTN","ECXPURG",8,0)
 W !!,"-  You can purge ANY existing extract.  This includes transmitted and non-"
"RTN","ECXPURG",9,0)
 W !,"   transmitted extracts as well as extracts that did not run to completion"
"RTN","ECXPURG",10,0)
 W !,"   due to errors or system problems."
"RTN","ECXPURG",11,0)
 W !,"-  Choosing a range of extracts (or a broad date range for the ""holding"
"RTN","ECXPURG",12,0)
 W !,"   files"") could mean an excessively large number of records and be very"
"RTN","ECXPURG",13,0)
 W !,"   CPU intensive.  Please be sure to queue this purge for off-hours and"
"RTN","ECXPURG",14,0)
 W !,"   limit the number of extracts to be purged per a single queued session."
"RTN","ECXPURG",15,0)
 W !,"-  The IVP and UDP ""holding"" files are intermediate files that are"
"RTN","ECXPURG",16,0)
 W !,"   populated ""realtime"" by inpatient pharmacy activity.  These files are"
"RTN","ECXPURG",17,0)
 W !,"   then used to generate the IVP and UDP extracts and CANNOT be recreated."
"RTN","ECXPURG",18,0)
 W !,"   Once they are purged for a date range, extracts can no longer be"
"RTN","ECXPURG",19,0)
 W !,"   generated for that time period."
"RTN","ECXPURG",20,0)
 ;
"RTN","ECXPURG",21,0)
 K DIR W !
"RTN","ECXPURG",22,0)
 S DIR(0)="SAM^E:Extract Files;I:IVP Holding File;U:UDP Holding File"
"RTN","ECXPURG",23,0)
 S DIR("A")="Purge (E)xtract files, (I)VP data, or (U)DP data? "
"RTN","ECXPURG",24,0)
 D ^DIR K DIR G:$D(DIRUT) QUIT S ECY=Y
"RTN","ECXPURG",25,0)
 I ECY="E" D ^ECXPURG1 I $D(ECLOC) S ZTSAVE("ECLOC(")="",ZTIO="",ZTRTN="PUR1^ECXPURG",ZTDESC="DSS - Purge of Extract Files" D QUE
"RTN","ECXPURG",26,0)
 I ECY="I" D DATES^ECXPURG1 I $D(ECBDT)&($D(ECEDT)) S (ZTSAVE("ECBDT"),ZTSAVE("ECEDT"))="",ZTIO="",ZTRTN="PUR2^ECXPURG",ZTDESC="DSS - Purge of IVP Holding File" D QUE
"RTN","ECXPURG",27,0)
 I ECY="U" D DATES^ECXPURG1 I $D(ECBDT)&($D(ECEDT)) S (ZTSAVE("ECBDT"),ZTSAVE("ECEDT"))="",ZTIO="",ZTRTN="PUR3^ECXPURG",ZTDESC="DSS - Purge of UDP Holding File" D QUE
"RTN","ECXPURG",28,0)
QUIT ;
"RTN","ECXPURG",29,0)
 K %X,%Y,EC,ECBDT,ECDATE,ECDT,ECEDT,ECEX,ECFR,ECLOC,ECRC,ECTO,ECTRN,ECTYP,ECY,HDT,HI,JJ,LN,LO,PG,QFLG,SS,X,Y,ZTSK
"RTN","ECXPURG",30,0)
 K ECXDIV
"RTN","ECXPURG",31,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECXPURG",32,0)
 Q
"RTN","ECXPURG",33,0)
QUE W $C(7),$C(7),!!?3,"<<This purge should be queued to run during non-peak hours.>>",!
"RTN","ECXPURG",34,0)
 D ^%ZTLOAD
"RTN","ECXPURG",35,0)
 I $D(ZTSK) W !,"Request queued as Task #",ZTSK,".",!
"RTN","ECXPURG",36,0)
 Q
"RTN","ECXPURG",37,0)
 ;
"RTN","ECXPURG",38,0)
PUR1 ; entry point for queued purge job of extract files
"RTN","ECXPURG",39,0)
 S ECDA=0 F  S ECDA=$O(ECLOC(ECDA)) Q:'ECDA  D
"RTN","ECXPURG",40,0)
 .S ECFILE=^ECX(727,ECDA,"FILE"),ECJ=0
"RTN","ECXPURG",41,0)
 .F  S ECJ=$O(^ECX(ECFILE,"AC",ECDA,ECJ)) Q:'ECJ  D
"RTN","ECXPURG",42,0)
 ..S DIK="^ECX("_ECFILE_",",DA=ECJ D ^DIK K DIK,DA
"RTN","ECXPURG",43,0)
 .I ECFILE=727.816 S ECFILE=727.818,ECJ=0 D
"RTN","ECXPURG",44,0)
 ..F  S ECJ=$O(^ECX(ECFILE,"AC",ECDA,ECJ)) Q:'ECJ  D
"RTN","ECXPURG",45,0)
 ...S DIK="^ECX("_ECFILE_",",DA=ECJ D ^DIK K DIK,DA
"RTN","ECXPURG",46,0)
 .S ^ECX(727,ECDA,"PURG")=DT
"RTN","ECXPURG",47,0)
 D QUIT
"RTN","ECXPURG",48,0)
 Q
"RTN","ECXPURG",49,0)
 ;
"RTN","ECXPURG",50,0)
PUR2 ; entry point for queued purge job of IVP holding file (#728.113)
"RTN","ECXPURG",51,0)
 F ECDT=ECBDT-1:0 S ECDT=$O(^ECX(728.113,"A",ECDT)) Q:'ECDT  Q:ECDT>ECEDT  S ECPT=0 F  S ECPT=$O(^ECX(728.113,"A",ECDT,ECPT)) Q:'ECPT  D
"RTN","ECXPURG",52,0)
 .S ECOR=0 F  S ECOR=$O(^ECX(728.113,"A",ECDT,ECPT,ECOR)) Q:'ECOR  D
"RTN","ECXPURG",53,0)
 ..S ECREC=0 F  S ECREC=$O(^ECX(728.113,"A",ECDT,ECPT,ECOR,ECREC)) Q:'ECREC  D
"RTN","ECXPURG",54,0)
 ...S DIK="^ECX(728.113,",DA=ECREC D ^DIK K DIK,DA
"RTN","ECXPURG",55,0)
 D QUIT
"RTN","ECXPURG",56,0)
 Q
"RTN","ECXPURG",57,0)
 ;
"RTN","ECXPURG",58,0)
PUR3 ; entry point for queued purge job of UDP holding file (#728.904)
"RTN","ECXPURG",59,0)
 F ECDT=ECBDT-1:0 S ECDT=$O(^ECX(728.904,"A",ECDT)) Q:'ECDT  Q:ECDT>ECEDT  D
"RTN","ECXPURG",60,0)
 .S ECREC=0 F  S ECREC=$O(^ECX(728.904,"A",ECDT,ECREC)) Q:'ECREC  D
"RTN","ECXPURG",61,0)
 ..S DIK="^ECX(728.904,",DA=ECREC D ^DIK K DIK,DA
"RTN","ECXPURG",62,0)
 D QUIT
"RTN","ECXPURG",63,0)
 Q
"RTN","ECXTRT")
0^5^B33893183
"RTN","ECXTRT",1,0)
ECXTRT ;ALB/JAP,BIR/DMA,CML,PTD-Treating Specialty Change Extract ; [ 01/10/97  4:33 PM ]
"RTN","ECXTRT",2,0)
 ;;3.0;DSS EXTRACTS;**1,8,17,24,33,35**;Dec 22, 1997
"RTN","ECXTRT",3,0)
BEG ;entry point from option
"RTN","ECXTRT",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXTRT",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXTRT",6,0)
 Q
"RTN","ECXTRT",7,0)
 ;
"RTN","ECXTRT",8,0)
START ; start package specific extract
"RTN","ECXTRT",9,0)
 N LOC,SPC,TRT
"RTN","ECXTRT",10,0)
 S QFLG=0
"RTN","ECXTRT",11,0)
 K ECXDD D FIELD^DID(405,.19,,"SPECIFIER","ECXDD")
"RTN","ECXTRT",12,0)
 S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXTRT",13,0)
 K ^TMP($J,"ECXTMP") S TRT=0
"RTN","ECXTRT",14,0)
 F  S TRT=$O(^DIC(45.7,TRT)) Q:+TRT=0  S SPC=$P(^DIC(45.7,TRT,0),U,2),^TMP($J,"ECXTMP",TRT)=SPC
"RTN","ECXTRT",15,0)
 S ECED=ECED+.3,ECD=ECSD1
"RTN","ECXTRT",16,0)
 ;loop through type 6 movements to get treating specialty and provider changes
"RTN","ECXTRT",17,0)
 F  S ECD=$O(^DGPM("ATT6",ECD)),ECDA=0 Q:('ECD)!(ECD>ECED)!(QFLG)  F  S ECDA=$O(^DGPM("ATT6",ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXTRT",18,0)
 .I $D(^DGPM(ECDA,0)) S EC=^(0),ECXDFN=+$P(EC,U,3) D  Q:QFLG
"RTN","ECXTRT",19,0)
 ..S ECXMVD1=$P(EC,U,1)
"RTN","ECXTRT",20,0)
 ..Q:'$$PATDEM^ECXUTL2(ECXDFN,ECXMVD1,"1;",13)
"RTN","ECXTRT",21,0)
 ..S ECMT=$P(EC,U,18),ECXADM=$P(EC,U,14),ECXADT=$P($G(^DGPM(ECXADM,0)),U)
"RTN","ECXTRT",22,0)
 ..;skip the record if its the admission treat. spec. change for this episode of care
"RTN","ECXTRT",23,0)
 ..Q:ECXADM=$P(EC,U,24)
"RTN","ECXTRT",24,0)
 ..S (ECXLOS,ECXLOSA,ECXLOSP)="" S ECXDSSD=""
"RTN","ECXTRT",25,0)
 ..K LOC D SETLOC(ECXDFN,ECXADM,ECPRO,.LOC)
"RTN","ECXTRT",26,0)
 ..;get data for current (new) ts movement
"RTN","ECXTRT",27,0)
 ..S ECD1=9999999.9999999-ECXMVD1
"RTN","ECXTRT",28,0)
 ..D FINDLOC(ECD1,.LOC,.ECXSPCN,.ECXPRVN,.ECXATTN,.ECXMOVN,.ECXTRTN)
"RTN","ECXTRT",29,0)
 ..Q:ECXSPCN=""
"RTN","ECXTRT",30,0)
 ..S ECD2=$O(LOC(ECD1)) Q:ECD2=""
"RTN","ECXTRT",31,0)
 ..S ECXMVD2=9999999.9999999-ECD2
"RTN","ECXTRT",32,0)
 ..;get data for previous (losing) ts movement
"RTN","ECXTRT",33,0)
 ..D FINDLOC(ECD2,.LOC,.ECXSPCL,.ECXPRVL,.ECXATTL,.ECXMOVL,.ECXTRTL)
"RTN","ECXTRT",34,0)
 ..;if ts has changed, find los on losing ts
"RTN","ECXTRT",35,0)
 ..D:ECXTRTL'=ECXTRTN PREVTRT^ECXTRT1(.LOC,ECD1,ECD2,ECXTRTL,.ECXLOS)
"RTN","ECXTRT",36,0)
 ..;whether ts has changed or not, see if primary provider has changed
"RTN","ECXTRT",37,0)
 ..;dont bother if there's no data on current primary provider or no change in provider
"RTN","ECXTRT",38,0)
 ..D:(ECXPRVN'="")&(ECXPRVN'=ECXPRVL) PREVPRV^ECXTRT1(.LOC,ECD1,ECXPRVN,ECD2,.ECXPRVL,.ECXLOSP)
"RTN","ECXTRT",39,0)
 ..;whether ts has changed or not, see if attending physician has changed
"RTN","ECXTRT",40,0)
 ..;dont bother if theres no data on current attending physician or no change in attending
"RTN","ECXTRT",41,0)
 ..D:(ECXATTN'="")&(ECXATTN'=ECXATTL) PREVATT^ECXTRT1(.LOC,ECD1,ECXATTN,ECD2,.ECXATTL,.ECXLOSA)
"RTN","ECXTRT",42,0)
 ..S ECXDATE=$$ECXDATE^ECXUTL(ECXMVD1,ECXYM),ECXTIME=$$ECXTIME^ECXUTL(ECXMVD1)
"RTN","ECXTRT",43,0)
 ..S ECXADMDT=$$ECXDATE^ECXUTL(ECXADT,ECXYM),ECXADMTM=$$ECXTIME^ECXUTL(ECXADT),ECXDCDT=""
"RTN","ECXTRT",44,0)
 ..S (ECXALNPI,ECXANNPI,ECXPLNPI,ECXPNNPI)=""
"RTN","ECXTRT",45,0)
 ..D FILE
"RTN","ECXTRT",46,0)
 ;for nhcu episodes with intervening asih stays, the los calculated here is not accurate,
"RTN","ECXTRT",47,0)
 ;but it never has been; this is best solution within current extract framework;
"RTN","ECXTRT",48,0)
 ;at discharge the los calculated for nhcu apisodes will be the los since admission w/o asih los subtracted;
"RTN","ECXTRT",49,0)
 ;
"RTN","ECXTRT",50,0)
 ;loop through discharges to get last treating specialty
"RTN","ECXTRT",51,0)
 S ECD=ECSD1
"RTN","ECXTRT",52,0)
 F  S ECD=$O(^DGPM("ATT3",ECD)),ECDA=0 Q:'ECD  Q:ECD>ECED  F  S ECDA=$O(^DGPM("ATT3",ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXTRT",53,0)
 .I $D(^DGPM(ECDA,0)) S EC=^(0),ECXDFN=+$P(EC,U,3) D  Q:QFLG
"RTN","ECXTRT",54,0)
 ..S ECXMVD1=$P(EC,U,1)
"RTN","ECXTRT",55,0)
 ..Q:'$$PATDEM^ECXUTL2(ECXDFN,"1;")
"RTN","ECXTRT",56,0)
 ..S (ECXDATE,ECXDCDT)=$$ECXDATE^ECXUTL(ECXMVD1,ECXYM),ECXTIME=$$ECXTIME^ECXUTL(ECXMVD1)
"RTN","ECXTRT",57,0)
 ..S ECMT=$P(EC,U,18),ECXADM=$P(EC,U,14),ECXADT=$P($G(^DGPM(ECXADM,0)),U,1)
"RTN","ECXTRT",58,0)
 ..S ECXADMDT=$$ECXDATE^ECXUTL(ECXADT,ECXYM),ECXADMTM=$$ECXTIME^ECXUTL(ECXADT)
"RTN","ECXTRT",59,0)
 ..S (ECXTRTN,ECXSPCN,ECXPRVN,ECXATTN)="" S (ECXLOS,ECXLOSA,ECXLOSP)="" S ECXDSSD=""
"RTN","ECXTRT",60,0)
 ..K LOC D SETLOC(ECXDFN,ECXADM,ECPRO,.LOC)
"RTN","ECXTRT",61,0)
 ..S ECD1=9999999.9999999-ECXMVD1
"RTN","ECXTRT",62,0)
 ..;get ts change just before d/c
"RTN","ECXTRT",63,0)
 ..S ECD2=$O(LOC(ECD1)),ECXMVD2=9999999.9999999-ECD2
"RTN","ECXTRT",64,0)
 ..D FINDLOC(ECD2,.LOC,.ECXSPCL,.ECXPRVL,.ECXATTL,.ECXMOVL,.ECXTRTL)
"RTN","ECXTRT",65,0)
 ..;if closest ts change is admission ts, cant go back any further
"RTN","ECXTRT",66,0)
 ..S TRT=$O(LOC(ECD2,0)),REC=$O(LOC(ECD2,TRT,0))
"RTN","ECXTRT",67,0)
 ..I REC=ECXADM D
"RTN","ECXTRT",68,0)
 ...S X1=ECXMVD1,X2=ECXMVD2 D ^%DTC S ECXLOS=X
"RTN","ECXTRT",69,0)
 ...I ECXPRVL'="" S X1=ECXMVD1,X2=ECXMVD2 D ^%DTC S ECXLOSP=X
"RTN","ECXTRT",70,0)
 ...I ECXATTL'="" S X1=ECXMVD1,X2=ECXMVD2 D ^%DTC S ECXLOSA=X
"RTN","ECXTRT",71,0)
 ..;otherwise, need to find when change to last ts occurred
"RTN","ECXTRT",72,0)
 ..I REC'=ECXADM D
"RTN","ECXTRT",73,0)
 ...D PREVTRT^ECXTRT1(.LOC,ECD1,ECD2,ECXTRTL,.ECXLOS)
"RTN","ECXTRT",74,0)
 ...D PREVPRV^ECXTRT1(.LOC,ECD1,ECXPRVN,ECD2,.ECXPRVL,.ECXLOSP)
"RTN","ECXTRT",75,0)
 ...D PREVATT^ECXTRT1(.LOC,ECD1,ECXATTN,ECD2,.ECXATTL,.ECXLOSA)
"RTN","ECXTRT",76,0)
 ..S:ECXLOS>9999 ECXLOS=9999 S:ECXLOSA>9999 ECXLOSA=9999
"RTN","ECXTRT",77,0)
 ..S:ECXLOSP>9999 ECXLOSP=9999
"RTN","ECXTRT",78,0)
 ..S (ECXALNPI,ECXANNPI,ECXPLNPI,ECXPNNPI)=""
"RTN","ECXTRT",79,0)
 ..D FILE
"RTN","ECXTRT",80,0)
 D KPATDEM^ECXUTL2
"RTN","ECXTRT",81,0)
 Q
"RTN","ECXTRT",82,0)
 ;
"RTN","ECXTRT",83,0)
SETLOC(ECXDFN,ECXADM,ECXPRO,ECXLOC) ;setup the local array from the ATS index
"RTN","ECXTRT",84,0)
 ; output
"RTN","ECXTRT",85,0)
 ; ECXLOC = local array (passed by reference)
"RTN","ECXTRT",86,0)
 ;
"RTN","ECXTRT",87,0)
 N SUB3,SUB4,SUB5,SPC,PRV,ATT,MOV
"RTN","ECXTRT",88,0)
 S SUB3=0
"RTN","ECXTRT",89,0)
 F  S SUB3=$O(^DGPM("ATS",ECXDFN,ECXADM,SUB3)) Q:SUB3=""  D
"RTN","ECXTRT",90,0)
 .S (SUB4,SUB5)=0
"RTN","ECXTRT",91,0)
 .S SUB4=$O(^DGPM("ATS",ECXDFN,ECXADM,SUB3,SUB4))
"RTN","ECXTRT",92,0)
 .S SUB5=$O(^DGPM("ATS",ECXDFN,ECXADM,SUB3,SUB4,SUB5))
"RTN","ECXTRT",93,0)
 .S ECXLOC(SUB3,SUB4,SUB5)="",SPC=$G(^TMP($J,"ECXTMP",SUB4))
"RTN","ECXTRT",94,0)
 .S DATA=$G(^DGPM(SUB5,0)),PRV=$P(DATA,U,8),ATT=$P(DATA,U,19)
"RTN","ECXTRT",95,0)
 .S MOV=$P(DATA,U,14)
"RTN","ECXTRT",96,0)
 .S:PRV]"" PRV=ECXPRO_PRV S:ATT]"" ATT=ECXPRO_ATT
"RTN","ECXTRT",97,0)
 .S ECXLOC(SUB3,SUB4,SUB5)=SPC_U_PRV_U_ATT_U_MOV
"RTN","ECXTRT",98,0)
 Q
"RTN","ECXTRT",99,0)
 ;
"RTN","ECXTRT",100,0)
FINDLOC(ECXTSD,ECXLOC,ECXSPC,ECXPRV,ECXATT,ECXMOV,ECXTRT) ;find local array node for current ts movement
"RTN","ECXTRT",101,0)
 ;   input
"RTN","ECXTRT",102,0)
 ;   ECXTSD = inverse date/time for current ts movement; required
"RTN","ECXTRT",103,0)
 ;   ECXLOC = local array; passed by reference; required
"RTN","ECXTRT",104,0)
 ;   output; data from record contained in MOVE
"RTN","ECXTRT",105,0)
 ;   ECXSPC = piece 1 of LOC (passed by reference)
"RTN","ECXTRT",106,0)
 ;   ECXPRV = piece 2 of LOC concatenated to PRO (passed by reference)
"RTN","ECXTRT",107,0)
 ;   ECXATT = piece 3 of LOC concatenated to PRO (passed by reference)
"RTN","ECXTRT",108,0)
 ;   ECXMOV = piece 4 of LOC (passed by reference)
"RTN","ECXTRT",109,0)
 ;   ECXTRT = pointer to file #45.7
"RTN","ECXTRT",110,0)
 ;
"RTN","ECXTRT",111,0)
 N SUB3,SUB4,SUB5,LOC
"RTN","ECXTRT",112,0)
 S (ECXSPC,ECXPRV,ECXATT,ECXMOV)=""
"RTN","ECXTRT",113,0)
 S SUB3=ECXTSD
"RTN","ECXTRT",114,0)
 I $D(ECXLOC(SUB3)) D
"RTN","ECXTRT",115,0)
 .S SUB4=$O(ECXLOC(SUB3,0)),SUB5=$O(ECXLOC(SUB3,SUB4,0))
"RTN","ECXTRT",116,0)
 .S LOC=ECXLOC(SUB3,SUB4,SUB5),ECXTRT=SUB4,ECXSPC=$P(LOC,U)
"RTN","ECXTRT",117,0)
 .S ECXPRV=$P(LOC,U,2),ECXATT=$P(LOC,U,3),ECXMOV=$P(LOC,U,4)
"RTN","ECXTRT",118,0)
 Q
"RTN","ECXTRT",119,0)
 ;
"RTN","ECXTRT",120,0)
FILE ;file the extract record
"RTN","ECXTRT",121,0)
 ;node0
"RTN","ECXTRT",122,0)
 ;^dfn^ssn^name^i/o (ECXA)^date^product^adm date^d/c date^
"RTN","ECXTRT",123,0)
 ;mov#^type^new ts^losing ts^losing ts los^
"RTN","ECXTRT",124,0)
 ;losing attending^movement type^time^adm time^new provider^
"RTN","ECXTRT",125,0)
 ;new attending^losing provider
"RTN","ECXTRT",126,0)
 ;node1
"RTN","ECXTRT",127,0)
 ;mpi^dss dept^losing attending npi^new provider npi^new attending npi^
"RTN","ECXTRT",128,0)
 ;losing provider npi^losing attending los^losing provider los^dom^
"RTN","ECXTRT",129,0)
 ;extended outpatient
"RTN","ECXTRT",130,0)
 ;
"RTN","ECXTRT",131,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXTRT",132,0)
 S ECODE=EC7_U_EC23_U_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_3_U_ECXDATE_U_U
"RTN","ECXTRT",133,0)
 S ECODE=ECODE_ECXADMDT_U_ECXDCDT_U_ECDA_U_6_U_ECXSPCN_U_ECXSPCL_U
"RTN","ECXTRT",134,0)
 S ECODE=ECODE_ECXLOS_U_ECXATTL_U_ECMT_U_ECXTIME_U_ECXADMTM_U_ECXPRVN_U
"RTN","ECXTRT",135,0)
 S ECODE=ECODE_ECXATTN_U_ECXPRVL_U
"RTN","ECXTRT",136,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXALNPI_U_ECXPNNPI_U_ECXANNPI_U_ECXPLNPI_U
"RTN","ECXTRT",137,0)
 S ECODE1=ECODE1_ECXLOSA_U_ECXLOSP_U_ECXDOM_U_$G(ECXEOP)
"RTN","ECXTRT",138,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXTRT",139,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXTRT",140,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXTRT",141,0)
 Q
"RTN","ECXTRT",142,0)
 ;
"RTN","ECXTRT",143,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXTRT",144,0)
 S ECHEAD="TRT"
"RTN","ECXTRT",145,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXTRT",146,0)
 Q
"RTN","ECXTRT",147,0)
 ;
"RTN","ECXTRT",148,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXTRT",149,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL
"RTN","ECXTRT",150,0)
 Q
"RTN","ECXUTL2")
0^3^B55669430
"RTN","ECXUTL2",1,0)
ECXUTL2 ;ALB/JAP - Utilities for DSS Extracts (cont.) ;Aug 5, 1998
"RTN","ECXUTL2",2,0)
 ;;3.0;DSS EXTRACTS;**8,13,23,24,33,35**;Dec 22, 1997
"RTN","ECXUTL2",3,0)
 ;
"RTN","ECXUTL2",4,0)
ECXDEF(ECXHEAD,ECXPACK,ECXGRP,ECXFILE,ECXRTN,ECXPIECE,ECXVER) ;variables specific to extract from file #727.1
"RTN","ECXUTL2",5,0)
 ;   input 
"RTN","ECXUTL2",6,0)
 ;   ECXHEAD = extract header code
"RTN","ECXUTL2",7,0)
 ;   all other formal list parameters passed by reference
"RTN","ECXUTL2",8,0)
 ;   output
"RTN","ECXUTL2",9,0)
 ;   ECXPACK = type field (#7)
"RTN","ECXUTL2",10,0)
 ;   ECXGRP  = group field (#9)
"RTN","ECXUTL2",11,0)
 ;   ECXFILE = file number field (#1)
"RTN","ECXUTL2",12,0)
 ;   ECXRTN  = routine field (#4)
"RTN","ECXUTL2",13,0)
 ;   ECXPIECE= running piece field (#11)
"RTN","ECXUTL2",14,0)
 ;   ECXVER  = dss version
"RTN","ECXUTL2",15,0)
 ;
"RTN","ECXUTL2",16,0)
 N ECXIEN,ECXARR,DIC,DA,DR,DIQ
"RTN","ECXUTL2",17,0)
 S (ECXPACK,ECXGRP,ECXFILE,ECXRTN,ECXPIECE,ECXVER)="",ECXIEN=0
"RTN","ECXUTL2",18,0)
 S ECXIEN=+$O(^ECX(727.1,"C",ECXHEAD,ECXIEN))
"RTN","ECXUTL2",19,0)
 I ECXIEN=0 D  Q
"RTN","ECXUTL2",20,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",21,0)
 .D MES^XPDUTL(" It appears that you may have a problem with File #727.1 --")
"RTN","ECXUTL2",22,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",23,0)
 .D MES^XPDUTL(" The "_ECHEAD_" Extract is not properly defined.")
"RTN","ECXUTL2",24,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",25,0)
 .D MES^XPDUTL(" Contact National VISTA Support for further assistance.")
"RTN","ECXUTL2",26,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",27,0)
 .I $E(IOST)="C" D
"RTN","ECXUTL2",28,0)
 ..S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXUTL2",29,0)
 ..S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXUTL2",30,0)
 .W !!
"RTN","ECXUTL2",31,0)
 S DIC="^ECX(727.1,",DA=ECXIEN,DR=".01;1;4;7;9;11",DIQ="ECXARR"
"RTN","ECXUTL2",32,0)
 D EN^DIQ1
"RTN","ECXUTL2",33,0)
 S ECXPACK=ECXARR(727.1,ECXIEN,7)
"RTN","ECXUTL2",34,0)
 ;if this is an inactive extract type, skip it
"RTN","ECXUTL2",35,0)
 I ECXPACK["Inactive" D  Q
"RTN","ECXUTL2",36,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",37,0)
 .D MES^XPDUTL(" The "_ECHEAD_" Extract is no longer active/valid.")
"RTN","ECXUTL2",38,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",39,0)
 .D MES^XPDUTL(" Contact National VISTA Support for further assistance.")
"RTN","ECXUTL2",40,0)
 .D MES^XPDUTL(" ")
"RTN","ECXUTL2",41,0)
 .I $E(IOST)="C" D
"RTN","ECXUTL2",42,0)
 ..S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXUTL2",43,0)
 ..S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXUTL2",44,0)
 .W !!
"RTN","ECXUTL2",45,0)
 S ECXGRP=ECXARR(727.1,ECXIEN,9)
"RTN","ECXUTL2",46,0)
 S ECXFILE=ECXARR(727.1,ECXIEN,1)
"RTN","ECXUTL2",47,0)
 S ECXRTN="START^"_ECXARR(727.1,ECXIEN,4)
"RTN","ECXUTL2",48,0)
 S ECXPIECE=ECXARR(727.1,ECXIEN,11)
"RTN","ECXUTL2",49,0)
 ;version of dss/tsi in Austin as specified by btso
"RTN","ECXUTL2",50,0)
 S ECXVER=7
"RTN","ECXUTL2",51,0)
 Q
"RTN","ECXUTL2",52,0)
 ;
"RTN","ECXUTL2",53,0)
PATDEM(DFN,DT1,PAR,FLG) ; determine patient information
"RTN","ECXUTL2",54,0)
 ;  DFN   =
"RTN","ECXUTL2",55,0)
 ;  DT    =
"RTN","ECXUTL2",56,0)
 ;  PAR   =
"RTN","ECXUTL2",57,0)
 ;  FLG   =
"RTN","ECXUTL2",58,0)
 N DT2,PAT,OK,X
"RTN","ECXUTL2",59,0)
 D KPATDEM
"RTN","ECXUTL2",60,0)
 S FLG=$G(FLG),PAR=$S($D(PAR):PAR,1:"1;2;3;4;5;"),DT2=$P(DT1,".")
"RTN","ECXUTL2",61,0)
 Q:'$$PAT^ECXUTL3(DFN,DT2,PAR,.PAT) 0
"RTN","ECXUTL2",62,0)
 S ECXMPI=PAT("MPI")
"RTN","ECXUTL2",63,0)
 I PAR["1" D
"RTN","ECXUTL2",64,0)
 .S ECXSSN=PAT("SSN"),ECXPNM=PAT("NAME"),ECXDOB=PAT("DOB")
"RTN","ECXUTL2",65,0)
 .S ECXSEX=PAT("SEX"),ECXREL=PAT("RELIGION"),ECXRACE=PAT("RACE")
"RTN","ECXUTL2",66,0)
 .S ECXMAR=PAT("MARITAL")
"RTN","ECXUTL2",67,0)
 I PAR["2" D
"RTN","ECXUTL2",68,0)
 .S ECXCNTY=PAT("COUNTY"),ECXSTATE=PAT("STATE"),ECXZIP=PAT("ZIP")
"RTN","ECXUTL2",69,0)
 I PAR["3" D
"RTN","ECXUTL2",70,0)
 .S ECXPOS=PAT("POS"),ECSC=PAT("SC STAT"),ECXSVC=PAT("SC%")
"RTN","ECXUTL2",71,0)
 .S ECXVET=PAT("VET"),ECXMEAN=PAT("MEANS"),ECXELIG=PAT("ELIG")
"RTN","ECXUTL2",72,0)
 .S ECXENRL=PAT("ENROLL LOC")
"RTN","ECXUTL2",73,0)
 I PAR["4" S ECXEMP=PAT("EMPLOY")
"RTN","ECXUTL2",74,0)
 I PAR["5" D
"RTN","ECXUTL2",75,0)
 .S ECXVIET=PAT("VIETNAM"),ECXAST=PAT("AO STAT"),ECXRST=PAT("IR STAT")
"RTN","ECXUTL2",76,0)
 .S ECXEST=PAT("EC STAT"),ECXPST=PAT("POW STAT"),ECXPLOC=PAT("POW LOC")
"RTN","ECXUTL2",77,0)
 .S ECXPHI=PAT("PHI"),ECXMST=PAT("MST STAT")
"RTN","ECXUTL2",78,0)
 I PAR["6" D
"RTN","ECXUTL2",79,0)
 .S (ECXPAYOR,ECXSAI)="" D VISN19(DFN,.ECXPAYOR,.ECXSAI)
"RTN","ECXUTL2",80,0)
 S ECXCNHU=$P($G(^DPT(DFN,"NHC")),U)
"RTN","ECXUTL2",81,0)
 I FLG'[3 D
"RTN","ECXUTL2",82,0)
 .S X=$$PRIMARY(DFN,DT2),ECPTTM=$P(X,U),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3)
"RTN","ECXUTL2",83,0)
 .S ECPTNPI=$P(X,U,4),ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6)
"RTN","ECXUTL2",84,0)
 .S ECASNPI=$P(X,U,7)
"RTN","ECXUTL2",85,0)
 I FLG'[2 D
"RTN","ECXUTL2",86,0)
 .S ECXINP=$$INP^ECXUTL2(DFN,DT1),ECXA=$P(ECXINP,U),ECXMN=$P(ECXINP,U,2)
"RTN","ECXUTL2",87,0)
 .S ECXTS=$P(ECXINP,U,3),ECXDOM=$P(ECXINP,U,10)
"RTN","ECXUTL2",88,0)
 I FLG'[1 S X=$$ENROLLM(DFN)
"RTN","ECXUTL2",89,0)
 Q 1
"RTN","ECXUTL2",90,0)
 ;
"RTN","ECXUTL2",91,0)
KPATDEM ;
"RTN","ECXUTL2",92,0)
 K ECAO,ECASNPI,ECASPR,ECCLAS,ECCLAS2,ECENV,ECPTNPI,ECPTPR,ECPTTM
"RTN","ECXUTL2",93,0)
 K ECRE,ECSC,ECXA,ECXAST,ECXCAT,ECXCNTY,ECXCNHU,ECXEST,ECXENRL,ECXDOB
"RTN","ECXUTL2",94,0)
 K ECXDOM,ECXELIG,ECXINP,ECXMPI,ECXMN,ECXNM,ECXPHI,ECXPLOC,ECXMEAN,ECXMST
"RTN","ECXUTL2",95,0)
 K ECXPAYOR,ECXPNM,ECXPOS,ECXPRIOR,ECXPST,ECXRACE,ECXREL,ECXRST,ECXSAI
"RTN","ECXUTL2",96,0)
 K ECXSEX,ECXSSN,ECXSTAT,ECXSTATE,ECXSVC,ECXTS,ECXVIET,ECXZIP,VA,VAERR
"RTN","ECXUTL2",97,0)
 Q
"RTN","ECXUTL2",98,0)
 ;
"RTN","ECXUTL2",99,0)
ENROLLM(DFN,RNDT) ;determines enrollment status, category and priority
"RTN","ECXUTL2",100,0)
 ; input
"RTN","ECXUTL2",101,0)
 ;    DFN      = IEN from Patient file (Required)
"RTN","ECXUTL2",102,0)
 ;    RNDT     = Entract Run Date
"RTN","ECXUTL2",103,0)
 ; output
"RTN","ECXUTL2",104,0)
 ;    ECXSTAT  = Enrollment status
"RTN","ECXUTL2",105,0)
 ;    ECXPRIOR = Enrollment priority
"RTN","ECXUTL2",106,0)
 ;    ECXCAT   = Enrollment priority
"RTN","ECXUTL2",107,0)
 ;    return value 0 if no data found, 1 if data found
"RTN","ECXUTL2",108,0)
 ;
"RTN","ECXUTL2",109,0)
 N CAT,PRIOR,STAT,X,X1,X2,ENRIEN,ENR,FL
"RTN","ECXUTL2",110,0)
 S (ECXCAT,ECXPRIOR,ECXSTAT)=""
"RTN","ECXUTL2",111,0)
 I $G(DFN)="" Q 0
"RTN","ECXUTL2",112,0)
 ;find current enrollment when status=2 or 19
"RTN","ECXUTL2",113,0)
 S STAT=$$STATUS^DGENA(DFN),PRIOR=$$PRIORITY^DGENA(DFN)
"RTN","ECXUTL2",114,0)
 S CAT=$$CATEGORY^DGENA4(DFN,STAT)
"RTN","ECXUTL2",115,0)
 I "^2^19^"[("^"_STAT_"^") S ECXSTAT=STAT,ECXPRIOR=PRIOR,ECXCAT=CAT Q 1
"RTN","ECXUTL2",116,0)
 ;find previous enrollment
"RTN","ECXUTL2",117,0)
 S ENRIEN=$$FINDCUR^DGENA(DFN) I ENRIEN="" Q 0
"RTN","ECXUTL2",118,0)
 I $G(RNDT)="" D NOW^%DTC S RNDT=X
"RTN","ECXUTL2",119,0)
 S RNDT=($E(RNDT,1,3)-1)_$E(RNDT,4,7),FL=0
"RTN","ECXUTL2",120,0)
 F  S ENRIEN=$$FINDPRI^DGENA(ENRIEN) Q:'ENRIEN  D  Q:FL
"RTN","ECXUTL2",121,0)
 . S ENR=$$GET^DGENA(ENRIEN,.ENR)
"RTN","ECXUTL2",122,0)
 . I "^2^19^"[("^"_ENR("STATUS")_"^"),ENR("EFFDATE")>RNDT D
"RTN","ECXUTL2",123,0)
 . . S ECXSTAT=ENR("STATUS"),ECXPRIOR=ENR("PRIORITY"),FL=1
"RTN","ECXUTL2",124,0)
 . . S ECXCAT=$$CATEGORY^DGENA4(DFN,ECXSTAT)
"RTN","ECXUTL2",125,0)
 I FL Q 1
"RTN","ECXUTL2",126,0)
 ;no enrollment status found =2 or 19
"RTN","ECXUTL2",127,0)
 S ECXSTAT=STAT,ECXPRIOR=PRIOR,ECXCAT=CAT
"RTN","ECXUTL2",128,0)
 Q 1
"RTN","ECXUTL2",129,0)
 ;
"RTN","ECXUTL2",130,0)
PRIMARY(ECXDFN,ECXDATE,ECXPREFX) ;determine patient's pc team and pc provider
"RTN","ECXUTL2",131,0)
 ; input
"RTN","ECXUTL2",132,0)
 ; ECXDFN    = file #2 ien (required)
"RTN","ECXUTL2",133,0)
 ; ECXDATE   = date of interest (required)
"RTN","ECXUTL2",134,0)
 ; ECXPREFX  = prefix for provider data (optional)
"RTN","ECXUTL2",135,0)
 ;             defaults to "2" if not specified otherwise
"RTN","ECXUTL2",136,0)
 ; output
"RTN","ECXUTL2",137,0)
 ; ECXPRIME  = pc team ien^prefix_pc provider ien^pc provider person class^pc provider npi
"RTN","ECXUTL2",138,0)
 ;             ^prefix_assoc pc provider ien^assoc pc provider person class^assoc pc provider npi
"RTN","ECXUTL2",139,0)
 ;
"RTN","ECXUTL2",140,0)
 N ECPTTM,ECPTPR,ECCLAS,ECPRIME,ECASPR,ECCLAS2
"RTN","ECXUTL2",141,0)
 S:'$D(ECXPREFX) ECXPREFX=2 S:(+ECXPREFX=0) ECXPREFX=2
"RTN","ECXUTL2",142,0)
 ;get pc team data
"RTN","ECXUTL2",143,0)
 S ECPTTM=+$$OUTPTTM^SDUTL3(ECXDFN,ECXDATE) S:ECPTTM=0 ECPTTM=""
"RTN","ECXUTL2",144,0)
 ;get primary pc provider data
"RTN","ECXUTL2",145,0)
 S ECPTPR=+$$OUTPTPR^SDUTL3(ECXDFN,ECXDATE)
"RTN","ECXUTL2",146,0)
 S ECCLAS="" I ECPTPR>0 S ECCLAS=$$PRVCLASS^ECXUTL(ECPTPR,ECXDATE)
"RTN","ECXUTL2",147,0)
 S:ECPTPR=0 ECPTPR="" S:ECPTPR]"" ECPTPR=ECXPREFX_ECPTPR
"RTN","ECXUTL2",148,0)
 S ECPTNPI=""
"RTN","ECXUTL2",149,0)
 ;assoc pc provider call ok if routine scapmca from patch177 is present
"RTN","ECXUTL2",150,0)
 S ECASPR=""
"RTN","ECXUTL2",151,0)
 S X="SCAPMCA" X ^%ZOSF("TEST") I $T D
"RTN","ECXUTL2",152,0)
 .S ECASPR=+$$OUTPTAP^SDUTL3(ECXDFN,ECXDATE)
"RTN","ECXUTL2",153,0)
 S ECCLAS2="" I ECASPR>0 S ECCLAS2=$$PRVCLASS^ECXUTL(ECASPR,ECXDATE)
"RTN","ECXUTL2",154,0)
 S:ECASPR=0 ECASPR="" S:ECASPR]"" ECASPR=ECXPREFX_ECASPR
"RTN","ECXUTL2",155,0)
 S ECASNPI=""
"RTN","ECXUTL2",156,0)
 ;assemble
"RTN","ECXUTL2",157,0)
 S ECXPRIME=ECPTTM_U_ECPTPR_U_ECCLAS_U_ECPTNPI_U_ECASPR_U_ECCLAS2_U_ECASNPI
"RTN","ECXUTL2",158,0)
 Q ECXPRIME
"RTN","ECXUTL2",159,0)
 ;
"RTN","ECXUTL2",160,0)
INP(ECXDFN,ECXDATE) ; check for inpatient status
"RTN","ECXUTL2",161,0)
 ; input
"RTN","ECXUTL2",162,0)
 ; ECXDFN  = file #2 ien (required)
"RTN","ECXUTL2",163,0)
 ; ECXDATE = date of interest (required)
"RTN","ECXUTL2",164,0)
 ; output
"RTN","ECXUTL2",165,0)
 ; ECXINP  = patient status^movment # (file #405 ien)
"RTN","ECXUTL2",166,0)
 ;       current treat. spec. (file #42.4 ien)^admission date/time^
"RTN","ECXUTL2",167,0)
 ;       current ward (file #42 ien)^discharge date/time^
"RTN","ECXUTL2",168,0)
 ;       ward provider^attending phys.^ward (file #44 ien);facility
"RTN","ECXUTL2",169,0)
 ;       (file #40.8 ien);dss dept^dom
"RTN","ECXUTL2",170,0)
 ;           where patient status = 3 for inpatient
"RTN","ECXUTL2",171,0)
 ;                                = 1 for outpatient
"RTN","ECXUTL2",172,0)
 ;
"RTN","ECXUTL2",173,0)
 N DFN,DSSDEPT,ECA,ECADM,ECMN,ECTS,ECWARD,ECDC,ECXINP,ECXPRO
"RTN","ECXUTL2",174,0)
 N ECXATP,ECXDD,ECXDOM,ECXPROF,ECXPWP,ECXWW,FAC,VAIP,WRD
"RTN","ECXUTL2",175,0)
 D FIELD^DID(405,.19,,"SPECIFIER","ECXDD")
"RTN","ECXUTL2",176,0)
 S ECXPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXUTL2",177,0)
 S DFN=ECXDFN,ECA=1
"RTN","ECXUTL2",178,0)
 S (DSSDEPT,ECMN,ECTS,ECADM,ECWARD,ECDC,ECXATP,ECXPWP,ECXWW,WRD,FAC)=""
"RTN","ECXUTL2",179,0)
 S VAIP("D")=ECXDATE D IN5^VADPT
"RTN","ECXUTL2",180,0)
 S ECMN=$G(VAIP(1))
"RTN","ECXUTL2",181,0)
 I ECMN D
"RTN","ECXUTL2",182,0)
 .S ECA=3,ECTS=+$P($G(^DIC(45.7,+VAIP(8),0)),U,2) S:ECTS=0 ECTS=""
"RTN","ECXUTL2",183,0)
 .S ECADM=+$G(VAIP(13,1)) S:ECADM=0 ECADM=""
"RTN","ECXUTL2",184,0)
 .S ECWARD=+$G(VAIP(5)) S:ECWARD=0 ECWARD=""
"RTN","ECXUTL2",185,0)
 .I ECWARD D
"RTN","ECXUTL2",186,0)
 ..S WRD=+$P($G(^DIC(42,+ECWARD,44)),U)
"RTN","ECXUTL2",187,0)
 ..S FAC=$P($G(^DIC(42,+ECWARD,0)),U,11)
"RTN","ECXUTL2",188,0)
 ..S DSSDEPT=$P($G(^ECX(727.4,ECWARD,0)),U,2)
"RTN","ECXUTL2",189,0)
 .S ECXWW=WRD_";"_FAC_";"_DSSDEPT,ECDC=+$G(VAIP(17,1)) S:ECDC=0 ECDC=""
"RTN","ECXUTL2",190,0)
 .S ECXPWP=+VAIP(7) S:ECXPWP=0 ECXPWP=""
"RTN","ECXUTL2",191,0)
 .S ECXATP=+VAIP(18) S:ECXATP=0 ECXATP=""
"RTN","ECXUTL2",192,0)
 .;prefix file #200 iens
"RTN","ECXUTL2",193,0)
 .S:ECXPWP ECXPWP=ECXPROF_ECXPWP S:ECXATP ECXATP=ECXPROF_ECXATP
"RTN","ECXUTL2",194,0)
 S ECXDOM=$G(^ECX(727.831,+ECTS,0))
"RTN","ECXUTL2",195,0)
 S:ECXDOM'="" ECXA=$P(ECXDOM,U,3),ECXDOM=$P(ECXDOM,U,2)
"RTN","ECXUTL2",196,0)
 S ECXINP=ECA_U_ECMN_U_ECTS_U_ECADM_U_ECWARD_U_ECDC_U_ECXPWP_U_ECXATP_U_ECXWW_U_ECXDOM
"RTN","ECXUTL2",197,0)
 Q ECXINP
"RTN","ECXUTL2",198,0)
 ;
"RTN","ECXUTL2",199,0)
VISN19(ECXDFN,ECXPAYOR,ECXSAI) ;visn 19 sharing agreement data
"RTN","ECXUTL2",200,0)
 ; input  ECXDFN = patient file ien
"RTN","ECXUTL2",201,0)
 ; output ECXPAYOR, ECXSAI (passed by reference)
"RTN","ECXUTL2",202,0)
 ;
"RTN","ECXUTL2",203,0)
 N JJ,ALIAS,INSUR,DIC,DIQ,DA,DR,ECXARY,ECXERR,ECXDA
"RTN","ECXUTL2",204,0)
 S (ECXPAYOR,ECXSAI)=""
"RTN","ECXUTL2",205,0)
 D GETS^DIQ(2,ECXDFN,"1*,","I","ECXARY","ECXERR")
"RTN","ECXUTL2",206,0)
 I $D(ECXERR) Q
"RTN","ECXUTL2",207,0)
 S JJ=0 F  S JJ=$O(ECXARY(2.01,JJ)) Q:JJ=""  D  I ECXPAYOR]"" Q
"RTN","ECXUTL2",208,0)
 . S ALIAS=$G(ECXARY(2.01,JJ,.01,"I"))
"RTN","ECXUTL2",209,0)
 . S ECXPAYOR=$S(ALIAS="SHARING AGREEMENT":"A",ALIAS="TRICARE":"B",ALIAS="CAT C":"C",ALIAS="CATEGORY C":"C",ALIAS="CHAMPVA":"D",ALIAS="CHAMPUS":"E",1:"")
"RTN","ECXUTL2",210,0)
 K ECXARY,ECXERR
"RTN","ECXUTL2",211,0)
 I ECXPAYOR]"" D GETS^DIQ(2,ECXDFN,".3121*,","I","ECXARY","ECXERR") D
"RTN","ECXUTL2",212,0)
 . I $D(ECXERR) Q
"RTN","ECXUTL2",213,0)
 . S JJ=0,ECXDA=$O(ECXARY(2.312,JJ)) I ECXDA="" Q
"RTN","ECXUTL2",214,0)
 . S DA=$G(ECXARY(2.312,ECXDA,.01,"I")) I DA="" Q
"RTN","ECXUTL2",215,0)
 . S INSUR=$$GET1^DIQ(36,DA,".01","I","","ECXERR")
"RTN","ECXUTL2",216,0)
 . I '$D(ECXERR) S ECXSAI=$E(ECXARY(2.312,ECXDA,.01,"I"),1,11)
"RTN","ECXUTL2",217,0)
 Q
"RTN","ECXUTL3")
0^4^B49806168
"RTN","ECXUTL3",1,0)
ECXUTL3 ;ALB/GTS - Utilities for DSS Extracts ;October 2, 1998
"RTN","ECXUTL3",2,0)
 ;;3.0;DSS EXTRACTS;**11,24,32,33,35**;Dec 22,1997
"RTN","ECXUTL3",3,0)
 ;
"RTN","ECXUTL3",4,0)
OUTPTTM(ECXDFN,ECXDT) ;* Return PC Team from PCMM files or DPT
"RTN","ECXUTL3",5,0)
 ; Variables -
"RTN","ECXUTL3",6,0)
 ;            ECXDFN - IEN from Patient file (Required)
"RTN","ECXUTL3",7,0)
 ;            ECXDT  - Relevant Date for Primary Care Team
"RTN","ECXUTL3",8,0)
 ;                      (Defaults to DT)
"RTN","ECXUTL3",9,0)
 ;
"RTN","ECXUTL3",10,0)
 ; Returned: ECXTM -
"RTN","ECXUTL3",11,0)
 ;            Pointer to team file (#404.51)
"RTN","ECXUTL3",12,0)
 ;            or, if error or none defined, returns 0
"RTN","ECXUTL3",13,0)
 ;
"RTN","ECXUTL3",14,0)
 Q:'$G(ECXDFN) 0 ;** Quit if ECXDFN not defined
"RTN","ECXUTL3",15,0)
 N ECXTM
"RTN","ECXUTL3",16,0)
 S:'$D(ECXDT) ECXDT=DT
"RTN","ECXUTL3",17,0)
 I $T(OUTPTTM^SDUTL3)[",SCDATE" D
"RTN","ECXUTL3",18,0)
 .S ECXTM=+$$OUTPTTM^SDUTL3(ECXDFN,ECXDT)
"RTN","ECXUTL3",19,0)
 I $T(OUTPTTM^SDUTL3)'[",SCDATE" D
"RTN","ECXUTL3",20,0)
 .S ECXTM=+$$OUTPTTM^SDUTL3(ECXDFN)
"RTN","ECXUTL3",21,0)
 I ECXTM=0 D
"RTN","ECXUTL3",22,0)
 .S ECXTM=+$P($G(^DPT(+ECXDFN,"PC")),U,2)
"RTN","ECXUTL3",23,0)
 Q ECXTM
"RTN","ECXUTL3",24,0)
 ;
"RTN","ECXUTL3",25,0)
OUTPTPR(ECXDFN,ECXDT) ;* Return PC Provider from PCMM files or DPT
"RTN","ECXUTL3",26,0)
 ; Variables -
"RTN","ECXUTL3",27,0)
 ;            ECXDFN - IEN from Patient file (Required)
"RTN","ECXUTL3",28,0)
 ;            ECXDT  - Relevant Date for Primary Care Provider
"RTN","ECXUTL3",29,0)
 ;                      (Defaults to DT)
"RTN","ECXUTL3",30,0)
 ;
"RTN","ECXUTL3",31,0)
 ; Returned: ECXPR -
"RTN","ECXUTL3",32,0)
 ;            Pointer to file #200 
"RTN","ECXUTL3",33,0)
 ;            or, if error or none defined, returns a 0
"RTN","ECXUTL3",34,0)
 ;
"RTN","ECXUTL3",35,0)
 Q:'$G(ECXDFN) 0 ;** Quit if ECXDFN not defined
"RTN","ECXUTL3",36,0)
 N ECXPR
"RTN","ECXUTL3",37,0)
 S:'$D(ECXDT) ECXDT=DT
"RTN","ECXUTL3",38,0)
 I $T(OUTPTPR^SDUTL3)[",SCDATE" D
"RTN","ECXUTL3",39,0)
 .S ECXPR=+$$OUTPTPR^SDUTL3(ECXDFN,ECXDT)
"RTN","ECXUTL3",40,0)
 I $T(OUTPTPR^SDUTL3)'[",SCDATE" D
"RTN","ECXUTL3",41,0)
 .S ECXPR=+$$OUTPTPR^SDUTL3(ECXDFN)
"RTN","ECXUTL3",42,0)
 I ECXPR=0 D
"RTN","ECXUTL3",43,0)
 .S ECXPR=+$G(^DPT(+ECXDFN,"PC"))
"RTN","ECXUTL3",44,0)
 Q ECXPR
"RTN","ECXUTL3",45,0)
 ;
"RTN","ECXUTL3",46,0)
PAT(ECXDFN,ECXDATE,ECXDATA,ECXPAT) ;Return basic patient data for extract
"RTN","ECXUTL3",47,0)
 ; Will not return data associated with test patients (SSN begin w 00000)
"RTN","ECXUTL3",48,0)
 ; Variables -
"RTN","ECXUTL3",49,0)
 ;  Input  ECXDFN - Patient internal entry number, DFN file#2; required
"RTN","ECXUTL3",50,0)
 ;         ECXDATE- Date used to get specific data from GETSTAT^DGMSTAPI
"RTN","ECXUTL3",51,0)
 ;                  for MST. If no date, defaults to today's date,
"RTN","ECXUTL3",52,0)
 ;                  standard FM format, optional
"RTN","ECXUTL3",53,0)
 ;         ECXDATA- Code indicating which data to return, optional.
"RTN","ECXUTL3",54,0)
 ;                  If code not specified then returns all. Codes are:
"RTN","ECXUTL3",55,0)
 ;                  1 - DEM^VADPT (demographic data)
"RTN","ECXUTL3",56,0)
 ;                  2 - ADD^VADPT (current address)
"RTN","ECXUTL3",57,0)
 ;                  3 - ELIG^VADPT (eligibility & enrollment location)
"RTN","ECXUTL3",58,0)
 ;                  4 - OPD^VADPT (other patient data)
"RTN","ECXUTL3",59,0)
 ;                  5 - SVC^VADPT & GETSTAT^DGMSTAPI (service & MST inf)
"RTN","ECXUTL3",60,0)
 ;         ECXPAT(- Passed by referece; required
"RTN","ECXUTL3",61,0)
 ;
"RTN","ECXUTL3",62,0)
 ;  Output:
"RTN","ECXUTL3",63,0)
 ;         ECXPAT   0 error or test patient no data in ECXPAT array
"RTN","ECXUTL3",64,0)
 ;                  1 data returneed in ECXPAT array
"RTN","ECXUTL3",65,0)
 ;         ECXPAT(  Local array with patient data.
"RTN","ECXUTL3",66,0)
 ;
"RTN","ECXUTL3",67,0)
 N SSN,I,ECXCOD,ECXDAT,DFN,VAPA,VADM,VAEL,VAPD,VASV,STR,ECXAR,DIC,DIQ
"RTN","ECXUTL3",68,0)
 N DA,DR,PELG,MELIG,ZIP,MPI
"RTN","ECXUTL3",69,0)
 I ECXDFN="" Q 0
"RTN","ECXUTL3",70,0)
 S SSN=$$GET1^DIQ(2,ECXDFN,.09,"I"),DFN=ECXDFN,ECXPAT=0
"RTN","ECXUTL3",71,0)
 I $E(SSN,1,5)="00000"!(SSN="") K ECXPAT Q 0  ;test patient
"RTN","ECXUTL3",72,0)
 S STR="NAME;SSN;DOB;SEX;RACE;RELIGION;STATE;COUNTY;ZIP;SC%;MEANS;ELIG;"
"RTN","ECXUTL3",73,0)
 S STR=STR_"EMPLOY;AO STAT;IR STAT;EC STAT;POW STAT;POW LOC;MST STAT;"
"RTN","ECXUTL3",74,0)
 S STR=STR_"ENROLL LOC;MPI;VIETNAM;POS;MARITAL"
"RTN","ECXUTL3",75,0)
 ;initialize return array values
"RTN","ECXUTL3",76,0)
 F I=1:1 S ECXDAT=$P(STR,";",I) Q:ECXDAT=""  S ECXPAT(ECXDAT)=""
"RTN","ECXUTL3",77,0)
 F I=1:1:$L(ECXDATA,";") S ECXDAT=$P(ECXDATA,";",I) I ECXDAT'="" D
"RTN","ECXUTL3",78,0)
 . S ECXCOD(ECXDAT)=""
"RTN","ECXUTL3",79,0)
 ;
"RTN","ECXUTL3",80,0)
 ;- Get ICN if MPI installed
"RTN","ECXUTL3",81,0)
 S X="MPIF001" X ^%ZOSF("TEST") I $T D
"RTN","ECXUTL3",82,0)
 .;
"RTN","ECXUTL3",83,0)
 .;- Get 1st piece (either ICN # or -1 if error)
"RTN","ECXUTL3",84,0)
 . S MPI=+$$GETICN^MPIF001(DFN)
"RTN","ECXUTL3",85,0)
 .;
"RTN","ECXUTL3",86,0)
 .;- If error, set to null
"RTN","ECXUTL3",87,0)
 . S ECXPAT("MPI")=$S(MPI>0:MPI,1:"")
"RTN","ECXUTL3",88,0)
 D  ;get demographic data
"RTN","ECXUTL3",89,0)
 . I ECXDATA'="",'$D(ECXCOD(1)) Q
"RTN","ECXUTL3",90,0)
 . D DEM^VADPT
"RTN","ECXUTL3",91,0)
 . S ECXPAT("NAME")=$E($P(VADM(1),",")_"    ",1,4)
"RTN","ECXUTL3",92,0)
 . S ECXPAT("SSN")=$P(VADM(2),U),ECXPAT("MARITAL")=$P(VADM(10),U)
"RTN","ECXUTL3",93,0)
 . S ECXPAT("DOB")=$$ECXDOB^ECXUTL($P(VADM(3),U))
"RTN","ECXUTL3",94,0)
 . S ECXPAT("SEX")=$P(VADM(5),U),ECXPAT("RELIGION")=$P(VADM(9),U)
"RTN","ECXUTL3",95,0)
 . S DIC=10,DR=2,DA=+VADM(8),DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",96,0)
 . S ECXPAT("RACE")=$G(ECXAR(10,DA,DR,"I")),ECXPAT=1
"RTN","ECXUTL3",97,0)
 D  ;get address information
"RTN","ECXUTL3",98,0)
 . I ECXDATA'="",'$D(ECXCOD(2)) Q
"RTN","ECXUTL3",99,0)
 . D ADD^VADPT
"RTN","ECXUTL3",100,0)
 . S DIC=5,DR=2,DA=+VAPA(5),DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",101,0)
 . S ECXPAT("STATE")=$G(ECXAR(5,DA,DR,"I"))
"RTN","ECXUTL3",102,0)
 . S DIC=5,DA=+VAPA(5),DR=3,DR(5.01)=2,DA(5.01)=+VAPA(7),DIQ="ECXAR"
"RTN","ECXUTL3",103,0)
 . S DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",104,0)
 . S ECXPAT("COUNTY")=$G(ECXAR(5.01,DA(5.01),2,"I"))
"RTN","ECXUTL3",105,0)
 . S ECXPAT("ZIP")=$P(VAPA(11),U,2),ECXPAT=1
"RTN","ECXUTL3",106,0)
 D  ;get eligibility information
"RTN","ECXUTL3",107,0)
 . I ECXDATA'="",'$D(ECXCOD(3)) Q
"RTN","ECXUTL3",108,0)
 . D ELIG^VADPT
"RTN","ECXUTL3",109,0)
 . S PELG=$P(VAEL(1),U),MELIG=$S(PELG="":"",1:$$GET1^DIQ(8,PELG,8,"I"))
"RTN","ECXUTL3",110,0)
 . S ECXPAT("POS")=$P($G(^DIC(21,+VAEL(2),0)),U,3)
"RTN","ECXUTL3",111,0)
 . S ECXPAT("SC STAT")=$S(+VAEL(3):"Y",+VAEL(3)=0:"N",1:"")
"RTN","ECXUTL3",112,0)
 . S ECXPAT("SC%")=$P(VAEL(3),U,2)
"RTN","ECXUTL3",113,0)
 . S ECXPAT("VET")=$S(VAEL(4):"Y",VAEL(4)=0:"N",1:"")
"RTN","ECXUTL3",114,0)
 . S ECXPAT("MEANS")=$P(VAEL(9),U),ECXPAT=1
"RTN","ECXUTL3",115,0)
 . S ECXPAT("ELIG")=$$ELIG(MELIG,ECXPAT("SC%"))
"RTN","ECXUTL3",116,0)
 . ;get enrollment location
"RTN","ECXUTL3",117,0)
 . S DIC=2,DR=27.02,DA=ECXDFN,DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",118,0)
 . S ECXDAT=$G(ECXAR(2,ECXDFN,DR,"I")) I ECXDAT K ECXAR D
"RTN","ECXUTL3",119,0)
 . . S DIC=4,DA=ECXDAT,DR=99,DIQ="ECXAR",DIQ(0)="I" D EN^DIQ1
"RTN","ECXUTL3",120,0)
 . . S ECXPAT("ENROLL LOC")=ECXAR(4,ECXDAT,DR,"I")
"RTN","ECXUTL3",121,0)
 D  ;get other patient information
"RTN","ECXUTL3",122,0)
 . I ECXDATA'="",'$D(ECXCOD(4)) Q
"RTN","ECXUTL3",123,0)
 . D OPD^VADPT
"RTN","ECXUTL3",124,0)
 . S ECXPAT("EMPLOY")=$P(VAPD(7),U),ECXPAT=1
"RTN","ECXUTL3",125,0)
 D  ;get service information
"RTN","ECXUTL3",126,0)
 . I ECXDATA'="",'$D(ECXCOD(5)) Q
"RTN","ECXUTL3",127,0)
 . D SVC^VADPT
"RTN","ECXUTL3",128,0)
 . S ECXPAT("VIETNAM")=$S(VASV(1):"Y",VASV(2)=0:"N",1:"U")
"RTN","ECXUTL3",129,0)
 . S ECXPAT("AO STAT")=$S(VASV(2):"Y",VASV(2)=0:"N",1:"U")
"RTN","ECXUTL3",130,0)
 . S ECXPAT("IR STAT")=$S(VASV(3):"Y",VASV(3)=0:"N",1:"U")
"RTN","ECXUTL3",131,0)
 . S ECXPAT("EC STAT")=$$GET1^DIQ(2,ECXDFN,.322013,"I")
"RTN","ECXUTL3",132,0)
 . S ECXPAT("POW STAT")=$S(VASV(4):"Y",VASV(4)=0:"N",1:"U")
"RTN","ECXUTL3",133,0)
 . S ECXPAT("POW LOC")=$P(VASV(4,3),U),ECXPAT=1
"RTN","ECXUTL3",134,0)
 . S ECXPAT("PHI")=""  ; PURPLE HEART INDICATOR
"RTN","ECXUTL3",135,0)
 . ;get patient current MST status
"RTN","ECXUTL3",136,0)
 . I ECXDATE'="",ECXDATE'["." S ECXDATE=ECXDATE+.9
"RTN","ECXUTL3",137,0)
 . S X="DGMSTAPI" X ^%ZOSF("TEST") I $T D
"RTN","ECXUTL3",138,0)
 . . S ECXDAT=$$GETSTAT^DGMSTAPI(DFN,ECXDATE)
"RTN","ECXUTL3",139,0)
 . . S ECXPAT("MST STAT")=$S(+ECXDAT>0:$P(ECXDAT,U,2),1:"")
"RTN","ECXUTL3",140,0)
 I 'ECXPAT K ECXPAT Q 0
"RTN","ECXUTL3",141,0)
 Q 1
"RTN","ECXUTL3",142,0)
 ;
"RTN","ECXUTL3",143,0)
ELIG(ECXELIG,ECXSVCP) ;Converts veteran eligibility code to NPCD code
"RTN","ECXUTL3",144,0)
 ; Variables -
"RTN","ECXUTL3",145,0)
 ;  Input  ECXELIG - Pointer to MAS ELIGIBILITY CODE file #8.1
"RTN","ECXUTL3",146,0)
 ;         ECXSVCP - Number value rep. service connected percentage.
"RTN","ECXUTL3",147,0)
 ;
"RTN","ECXUTL3",148,0)
 ;  Output:
"RTN","ECXUTL3",149,0)
 ;         ECXNCPD  NPCD Eligibility Code
"RTN","ECXUTL3",150,0)
 ;
"RTN","ECXUTL3",151,0)
 N TEXT,IEN,SCPER,FND,NPCD,I,ECXBG,ECXEN,ECXNPCD
"RTN","ECXUTL3",152,0)
 I ECXELIG="" Q ""
"RTN","ECXUTL3",153,0)
 F I=1:1 S TEXT=$P($T(ELGTXT+I),";",3,999) Q:TEXT="END"  D  I $D(NPCD) Q
"RTN","ECXUTL3",154,0)
 . S IEN=$P(TEXT,";"),SCPER=$P(TEXT,";",2)
"RTN","ECXUTL3",155,0)
 . I ECXELIG=IEN D
"RTN","ECXUTL3",156,0)
 . . I SCPER="" S NPCD=$P(TEXT,";",3) Q
"RTN","ECXUTL3",157,0)
 . . S ECXBG=$S($E(SCPER)="<":0,$E(SCPER)=">":$P(SCPER,">",2)+1,SCPER["-":+SCPER,1:"")
"RTN","ECXUTL3",158,0)
 . . S ECXEN=$S($E(SCPER)="<":$P(SCPER,"<",2),$E(SCPER)=">":100,SCPER["-":$P(SCPER,"-",2),1:"")
"RTN","ECXUTL3",159,0)
 . . I ECXSVCP'<ECXBG,ECXSVCP'>ECXEN S NPCD=$P(TEXT,";",3)
"RTN","ECXUTL3",160,0)
 S ECXNPCD=$G(NPCD)
"RTN","ECXUTL3",161,0)
 Q ECXNPCD
"RTN","ECXUTL3",162,0)
ELGTXT ;Eligibility codes
"RTN","ECXUTL3",163,0)
 ;;1;>49;10;SC 50-100%
"RTN","ECXUTL3",164,0)
 ;;2;;20;Aid & Attendance
"RTN","ECXUTL3",165,0)
 ;;15;;21;Housebound
"RTN","ECXUTL3",166,0)
 ;;16;;22;Mexican Border War
"RTN","ECXUTL3",167,0)
 ;;17;;23;WWI
"RTN","ECXUTL3",168,0)
 ;;18;;24;POW
"RTN","ECXUTL3",169,0)
 ;;3;40-49;30;SC 40-49%
"RTN","ECXUTL3",170,0)
 ;;3;30-39;31;SC 30-39%
"RTN","ECXUTL3",171,0)
 ;;3;20-29;32;SC 20-29%
"RTN","ECXUTL3",172,0)
 ;;3;10-19;33;SC 10-19%
"RTN","ECXUTL3",173,0)
 ;;3;<10;34;SC less than 10%
"RTN","ECXUTL3",174,0)
 ;;4;;40;NSC - VA Pension
"RTN","ECXUTL3",175,0)
 ;;5;;50;NSC
"RTN","ECXUTL3",176,0)
 ;;21;;60;Catastrophic Disability
"RTN","ECXUTL3",177,0)
 ;;12;;101;CHAMPVA
"RTN","ECXUTL3",178,0)
 ;;13;;102;Collateral of Veteran
"RTN","ECXUTL3",179,0)
 ;;14;;103;Employee
"RTN","ECXUTL3",180,0)
 ;;6;;104;Other Federal Agency
"RTN","ECXUTL3",181,0)
 ;;7;;105;Allied Veteran
"RTN","ECXUTL3",182,0)
 ;;8;;106;Humanitarian Emergency
"RTN","ECXUTL3",183,0)
 ;;9;;107;Sharing Agreement
"RTN","ECXUTL3",184,0)
 ;;10;;108;;Reimbursable Insurance
"RTN","ECXUTL3",185,0)
 ;;19;;109;;TRICARE/CHAMPUS
"RTN","ECXUTL3",186,0)
 ;;END
"RTN","ECXUTL3",187,0)
 ;
"RTN","ECXUTL3",188,0)
CPT(ECXCPT,ECXMOD,ECXQUA) ;Returns a str with CPT code and modifier codes
"RTN","ECXUTL3",189,0)
 ;Return string is composed of a 5 character CPT code 2 character quanity
"RTN","ECXUTL3",190,0)
 ;plus up to 5 modifier codes, 2 characters each.
"RTN","ECXUTL3",191,0)
 ; Variables -
"RTN","ECXUTL3",192,0)
 ;  Input  ECXCPT  - Pointer value to the CPT file (#81)
"RTN","ECXUTL3",193,0)
 ;         ECXMOD - A string with pointer values to the CPT
"RTN","ECXUTL3",194,0)
 ;                   MODIFIER file (#81.3) separated by ";"
"RTN","ECXUTL3",195,0)
 ;         ECXQUA  - Number of time this procedure performed
"RTN","ECXUTL3",196,0)
 ;
"RTN","ECXUTL3",197,0)
 ;  Output:
"RTN","ECXUTL3",198,0)
 ;         CPTMOD  - String of up to 17 characters, 5 character CPT
"RTN","ECXUTL3",199,0)
 ;                   code 2 character quanity plus up to 5 2-character
"RTN","ECXUTL3",200,0)
 ;                   code modifiers.
"RTN","ECXUTL3",201,0)
 ;
"RTN","ECXUTL3",202,0)
 N CPT,MOD,I,CPTMOD
"RTN","ECXUTL3",203,0)
 S ECXQUA=$G(ECXQUA,"01"),ECXMOD=$G(ECXMOD)
"RTN","ECXUTL3",204,0)
 S:$L(ECXQUA)'=2 ECXQUA="0"_ECXQUA
"RTN","ECXUTL3",205,0)
 S CPT=$$CPT^ICPTCOD(ECXCPT,"") I +CPT=-1 Q ""
"RTN","ECXUTL3",206,0)
 S CPT=$P(CPT,U,2)_ECXQUA
"RTN","ECXUTL3",207,0)
 F I=1:1:99 I $P(ECXMOD,";",I)'="" D
"RTN","ECXUTL3",208,0)
 . S MOD=$$MOD^ICPTMOD($P(ECXMOD,";",I),"I","")
"RTN","ECXUTL3",209,0)
 . I +MOD>0,$P(MOD,U,2)'="99" S CPT=CPT_$P(MOD,U,2)
"RTN","ECXUTL3",210,0)
 S CPTMOD=$TR($E(CPT,1,17)," ")
"RTN","ECXUTL3",211,0)
 Q CPTMOD
"RTN","ECXUTL3",212,0)
 ;
"RTN","ECXUTL3",213,0)
CPTOUT(ECXCPT) ;output transform for CPT code plus modifiers
"RTN","ECXUTL3",214,0)
 ;input  ECXCPT  - character string of CPT code plus modifiers (required)
"RTN","ECXUTL3",215,0)
 ;
"RTN","ECXUTL3",216,0)
 N J,CPTX,MOD,MODS,MODX,CPTMOD
"RTN","ECXUTL3",217,0)
 Q:$G(ECXCPT)="" ""
"RTN","ECXUTL3",218,0)
 S (CPTMOD,MODX)=""
"RTN","ECXUTL3",219,0)
 S CPTX="("_+$E(ECXCPT,6,7)_") "_$E(ECXCPT,1,5),MODS=$E(ECXCPT,8,17)
"RTN","ECXUTL3",220,0)
 F J=1:2:9 S MOD=$E(MODS,J,J+1) Q:MOD=""  D
"RTN","ECXUTL3",221,0)
 .I J>1 S MODX=MODX_", "_MOD Q
"RTN","ECXUTL3",222,0)
 .S MODX=MODX_"-"_MOD
"RTN","ECXUTL3",223,0)
 S:$L(CPTX)>3 CPTMOD=CPTMOD_CPTX_MODX
"RTN","ECXUTL3",224,0)
 Q CPTMOD
"VER")
8.0^22.0
**END**
**END**
