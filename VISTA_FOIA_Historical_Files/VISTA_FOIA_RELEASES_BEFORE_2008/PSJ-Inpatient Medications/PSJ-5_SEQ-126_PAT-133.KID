EMERGENCY Released PSJ*5*133 SEQ #126
Extracted from mail message
**KIDS**:PSJ*5.0*133^

**INSTALL NAME**
PSJ*5.0*133
"BLD",4891,0)
PSJ*5.0*133^INPATIENT MEDICATIONS^0^3050620^y
"BLD",4891,1,0)
^^63^63^3050602^
"BLD",4891,1,1,0)
 1. A site reported an error that occurred during Speed Finish of pending 
"BLD",4891,1,2,0)
 renewals orders. The error occurred after an unsuccessful lock of the
"BLD",4891,1,3,0)
 original renewed order. This patch will prevent this error by ensuring a 
"BLD",4891,1,4,0)
 graceful exit when a lock is not successful. CLE-1204-41459
"BLD",4891,1,5,0)
 
"BLD",4891,1,6,0)
 2. The administration schedule validation process causes an error if a 
"BLD",4891,1,7,0)
 day-of-week PRN schedule is used that contains days that are out of 
"BLD",4891,1,8,0)
 order, for example, "WE-MO PRN". This patch will prevent this error and 
"BLD",4891,1,9,0)
 make the validation of this type of schedule consistent with non-PRN
"BLD",4891,1,10,0)
 day-of-week schedules.
"BLD",4891,1,11,0)
 
"BLD",4891,1,12,0)
 3. An undefined error may occur when viewing a pending IV renewal order
"BLD",4891,1,13,0)
 from the Medications Tab in Computerized Patient Record System (CPRS) V.
"BLD",4891,1,14,0)
 1.0. This patch will correct the problem by preventing the error from
"BLD",4891,1,15,0)
 occurring. MIN-1204-41611.
"BLD",4891,1,16,0)
 
"BLD",4891,1,17,0)
 4. When renewing an Inpatient IV order from the Inpatient Order Entry
"BLD",4891,1,18,0)
 [PSJ OE] option, an edit to the Provider is not reflected in the order
"BLD",4891,1,19,0)
 when viewed from CPRS V.1.0. This patch will correct the problem by
"BLD",4891,1,20,0)
 ensuring the updated provider information is transmitted to CPRS V.1.0.
"BLD",4891,1,21,0)
 IND-0105-40153.
"BLD",4891,1,22,0)
 
"BLD",4891,1,23,0)
 5. There is no prompt for output device for the PRE-EXCHANGE UNITS REPORT
"BLD",4891,1,24,0)
 after copying a Unit Dose order using the CO Copy action in Inpatient
"BLD",4891,1,25,0)
 Order Entry [PSJ OE] option. This patch will add a device prompt for the
"BLD",4891,1,26,0)
 Pre-Exchange Units Report to the Unit Dose copy action. HWH-1204-41654.
"BLD",4891,1,27,0)
 
"BLD",4891,1,28,0)
 6. When finishing a pending unit dose renewal order, the default 
"BLD",4891,1,29,0)
 administration times associated with the administration schedule will 
"BLD",4891,1,30,0)
 always default into the order, overwriting the order's existing
"BLD",4891,1,31,0)
 administration time. With this patch, renewal orders will retain the
"BLD",4891,1,32,0)
 original order's administration times. BHS-0105-10562.
"BLD",4891,1,33,0)
 
"BLD",4891,1,34,0)
 7. When the schedule type is edited during the finish of a unit dose
"BLD",4891,1,35,0)
 order that was renewed from CPRS V.1.0, the order appears twice in the
"BLD",4891,1,36,0)
 Patient Profile (Unit Dose) [PSJU PR] option. This patch corrects the
"BLD",4891,1,37,0)
 problem by removing the display associated with the previous schedule
"BLD",4891,1,38,0)
 type before adding the display associated with the new schedule type.
"BLD",4891,1,39,0)
 FRE-0105-60387, MAC-0205-61020.
"BLD",4891,1,40,0)
 
"BLD",4891,1,41,0)
 8. Multiple identically named schedules in the ADMINISTRATION SCHEDULE
"BLD",4891,1,42,0)
 file (#51.1) may cause an invalid schedule warning message to appear
"BLD",4891,1,43,0)
 inappropriately. This patch corrects the problem by preventing the
"BLD",4891,1,44,0)
 invalid warning message from appearing if the schedule name is defined in
"BLD",4891,1,45,0)
 the file, even if duplicates are present. HD0000000085881.
"BLD",4891,1,46,0)
 
"BLD",4891,1,47,0)
 9. A non-standard Day of Week schedule entered without administration
"BLD",4891,1,48,0)
 times using the schedule builder in CPRS V. 3.0 may default to a
"BLD",4891,1,49,0)
 different schedule in Inpatient Medications V. 5.0 if the non-standard
"BLD",4891,1,50,0)
 schedule is a partial match to a unique Day of Week schedule in the
"BLD",4891,1,51,0)
 ADMINISTRATION SCHEDULE file (#51.1). For example, if the non-standard
"BLD",4891,1,52,0)
 schedule SU-MO-TU-WE is entered without admin times using the CPRS V.
"BLD",4891,1,53,0)
 3.0 schedule builder, and the schedule SU-MO-TU-WE-TH@09 exists in the
"BLD",4891,1,54,0)
 ADMINISTRATION SCHEDULE file (#51.1), and there are no other schedules in
"BLD",4891,1,55,0)
 the ADMINISTRATION SCHEDULE file (#51.1) that begin with SU-MO-TU-WE, the
"BLD",4891,1,56,0)
 order's schedule will default to SU-MO-TU-WE-TH@09 when the order is
"BLD",4891,1,57,0)
 selected for finishing.  HD0000000087120, PSI-05-025.
"BLD",4891,1,58,0)
 
"BLD",4891,1,59,0)
 10. A non-standard Day of Week schedule entered using the schedule
"BLD",4891,1,60,0)
 builder in CPRS V. 3.0 defaults to the wrong Expected First Dose if the
"BLD",4891,1,61,0)
 schedule is a partial match to exactly one schedule in the ADMINISTRATION
"BLD",4891,1,62,0)
 SCHEDULE file (#51.1), and that schedule that was found contains an
"BLD",4891,1,63,0)
 administration time. HD0000000087028 PSI-05-026.
"BLD",4891,4,0)
^9.64PA^^0
"BLD",4891,"ABPKG")
n
"BLD",4891,"KRN",0)
^9.67PA^8989.52^19
"BLD",4891,"KRN",.4,0)
.4
"BLD",4891,"KRN",.401,0)
.401
"BLD",4891,"KRN",.402,0)
.402
"BLD",4891,"KRN",.403,0)
.403
"BLD",4891,"KRN",.5,0)
.5
"BLD",4891,"KRN",.84,0)
.84
"BLD",4891,"KRN",3.6,0)
3.6
"BLD",4891,"KRN",3.8,0)
3.8
"BLD",4891,"KRN",9.2,0)
9.2
"BLD",4891,"KRN",9.8,0)
9.8
"BLD",4891,"KRN",9.8,"NM",0)
^9.68A^34^30
"BLD",4891,"KRN",9.8,"NM",1,0)
PSGS0^^0^B43785743
"BLD",4891,"KRN",9.8,"NM",2,0)
PSIVUTL^^0^B27771040
"BLD",4891,"KRN",9.8,"NM",4,0)
PSGOTR^^0^B9642115
"BLD",4891,"KRN",9.8,"NM",5,0)
PSJLMPRI^^0^B17650009
"BLD",4891,"KRN",9.8,"NM",6,0)
PSJOE^^0^B80533601
"BLD",4891,"KRN",9.8,"NM",7,0)
PSGOD^^0^B19402686
"BLD",4891,"KRN",9.8,"NM",9,0)
PSJHL7^^0^B50036131
"BLD",4891,"KRN",9.8,"NM",10,0)
PSGVBW^^0^B57698798
"BLD",4891,"KRN",9.8,"NM",11,0)
PSGOE^^0^B25900556
"BLD",4891,"KRN",9.8,"NM",12,0)
PSGOEV^^0^B63457017
"BLD",4891,"KRN",9.8,"NM",13,0)
PSIVOPT2^^0^B32615251
"BLD",4891,"KRN",9.8,"NM",14,0)
PSGOEF^^0^B54376800
"BLD",4891,"KRN",9.8,"NM",16,0)
PSIVSP^^0^B34083635
"BLD",4891,"KRN",9.8,"NM",17,0)
PSJOE0^^0^B27877210
"BLD",4891,"KRN",9.8,"NM",18,0)
PSGSETU^^0^B13119552
"BLD",4891,"KRN",9.8,"NM",19,0)
PSIVORE^^0^B41019563
"BLD",4891,"KRN",9.8,"NM",20,0)
PSIVORE1^^0^B25223179
"BLD",4891,"KRN",9.8,"NM",21,0)
PSIVOREN^^0^B27037299
"BLD",4891,"KRN",9.8,"NM",22,0)
PSGOE1^^0^B29854333
"BLD",4891,"KRN",9.8,"NM",23,0)
PSJHLV^^0^B21285520
"BLD",4891,"KRN",9.8,"NM",24,0)
PSGPER^^0^B11838843
"BLD",4891,"KRN",9.8,"NM",25,0)
PSJDCU^^0^B4000752
"BLD",4891,"KRN",9.8,"NM",26,0)
PSGOER^^0^B72070079
"BLD",4891,"KRN",9.8,"NM",27,0)
PSJORPOE^^0^B33672695
"BLD",4891,"KRN",9.8,"NM",28,0)
PSGOESF^^0^B25954410
"BLD",4891,"KRN",9.8,"NM",30,0)
PSIVEDT^^0^B39067377
"BLD",4891,"KRN",9.8,"NM",31,0)
PSJOEA^^0^B28156504
"BLD",4891,"KRN",9.8,"NM",32,0)
PSJOEA1^^0^B29163507
"BLD",4891,"KRN",9.8,"NM",33,0)
PSJOEA2^^0^B27419272
"BLD",4891,"KRN",9.8,"NM",34,0)
PSJORP2^^0^B19054632
"BLD",4891,"KRN",9.8,"NM","B","PSGOD",7)

"BLD",4891,"KRN",9.8,"NM","B","PSGOE",11)

"BLD",4891,"KRN",9.8,"NM","B","PSGOE1",22)

"BLD",4891,"KRN",9.8,"NM","B","PSGOEF",14)

"BLD",4891,"KRN",9.8,"NM","B","PSGOER",26)

"BLD",4891,"KRN",9.8,"NM","B","PSGOESF",28)

"BLD",4891,"KRN",9.8,"NM","B","PSGOEV",12)

"BLD",4891,"KRN",9.8,"NM","B","PSGOTR",4)

"BLD",4891,"KRN",9.8,"NM","B","PSGPER",24)

"BLD",4891,"KRN",9.8,"NM","B","PSGS0",1)

"BLD",4891,"KRN",9.8,"NM","B","PSGSETU",18)

"BLD",4891,"KRN",9.8,"NM","B","PSGVBW",10)

"BLD",4891,"KRN",9.8,"NM","B","PSIVEDT",30)

"BLD",4891,"KRN",9.8,"NM","B","PSIVOPT2",13)

"BLD",4891,"KRN",9.8,"NM","B","PSIVORE",19)

"BLD",4891,"KRN",9.8,"NM","B","PSIVORE1",20)

"BLD",4891,"KRN",9.8,"NM","B","PSIVOREN",21)

"BLD",4891,"KRN",9.8,"NM","B","PSIVSP",16)

"BLD",4891,"KRN",9.8,"NM","B","PSIVUTL",2)

"BLD",4891,"KRN",9.8,"NM","B","PSJDCU",25)

"BLD",4891,"KRN",9.8,"NM","B","PSJHL7",9)

"BLD",4891,"KRN",9.8,"NM","B","PSJHLV",23)

"BLD",4891,"KRN",9.8,"NM","B","PSJLMPRI",5)

"BLD",4891,"KRN",9.8,"NM","B","PSJOE",6)

"BLD",4891,"KRN",9.8,"NM","B","PSJOE0",17)

"BLD",4891,"KRN",9.8,"NM","B","PSJOEA",31)

"BLD",4891,"KRN",9.8,"NM","B","PSJOEA1",32)

"BLD",4891,"KRN",9.8,"NM","B","PSJOEA2",33)

"BLD",4891,"KRN",9.8,"NM","B","PSJORP2",34)

"BLD",4891,"KRN",9.8,"NM","B","PSJORPOE",27)

"BLD",4891,"KRN",19,0)
19
"BLD",4891,"KRN",19,"NM",0)
^9.68A^^
"BLD",4891,"KRN",19.1,0)
19.1
"BLD",4891,"KRN",101,0)
101
"BLD",4891,"KRN",409.61,0)
409.61
"BLD",4891,"KRN",771,0)
771
"BLD",4891,"KRN",870,0)
870
"BLD",4891,"KRN",8989.51,0)
8989.51
"BLD",4891,"KRN",8989.52,0)
8989.52
"BLD",4891,"KRN",8994,0)
8994
"BLD",4891,"KRN","B",.4,.4)

"BLD",4891,"KRN","B",.401,.401)

"BLD",4891,"KRN","B",.402,.402)

"BLD",4891,"KRN","B",.403,.403)

"BLD",4891,"KRN","B",.5,.5)

"BLD",4891,"KRN","B",.84,.84)

"BLD",4891,"KRN","B",3.6,3.6)

"BLD",4891,"KRN","B",3.8,3.8)

"BLD",4891,"KRN","B",9.2,9.2)

"BLD",4891,"KRN","B",9.8,9.8)

"BLD",4891,"KRN","B",19,19)

"BLD",4891,"KRN","B",19.1,19.1)

"BLD",4891,"KRN","B",101,101)

"BLD",4891,"KRN","B",409.61,409.61)

"BLD",4891,"KRN","B",771,771)

"BLD",4891,"KRN","B",870,870)

"BLD",4891,"KRN","B",8989.51,8989.51)

"BLD",4891,"KRN","B",8989.52,8989.52)

"BLD",4891,"KRN","B",8994,8994)

"BLD",4891,"QUES",0)
^9.62^^
"BLD",4891,"REQB",0)
^9.611^2^2
"BLD",4891,"REQB",1,0)
PSJ*5.0*111^2
"BLD",4891,"REQB",2,0)
PSJ*5.0*127^2
"BLD",4891,"REQB","B","PSJ*5.0*111",1)

"BLD",4891,"REQB","B","PSJ*5.0*127",2)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
133^3050620^10000000009
"PKG",197,22,1,"PAH",1,1,0)
^^63^63^3050620
"PKG",197,22,1,"PAH",1,1,1,0)
 1. A site reported an error that occurred during Speed Finish of pending 
"PKG",197,22,1,"PAH",1,1,2,0)
 renewals orders. The error occurred after an unsuccessful lock of the
"PKG",197,22,1,"PAH",1,1,3,0)
 original renewed order. This patch will prevent this error by ensuring a 
"PKG",197,22,1,"PAH",1,1,4,0)
 graceful exit when a lock is not successful. CLE-1204-41459
"PKG",197,22,1,"PAH",1,1,5,0)
 
"PKG",197,22,1,"PAH",1,1,6,0)
 2. The administration schedule validation process causes an error if a 
"PKG",197,22,1,"PAH",1,1,7,0)
 day-of-week PRN schedule is used that contains days that are out of 
"PKG",197,22,1,"PAH",1,1,8,0)
 order, for example, "WE-MO PRN". This patch will prevent this error and 
"PKG",197,22,1,"PAH",1,1,9,0)
 make the validation of this type of schedule consistent with non-PRN
"PKG",197,22,1,"PAH",1,1,10,0)
 day-of-week schedules.
"PKG",197,22,1,"PAH",1,1,11,0)
 
"PKG",197,22,1,"PAH",1,1,12,0)
 3. An undefined error may occur when viewing a pending IV renewal order
"PKG",197,22,1,"PAH",1,1,13,0)
 from the Medications Tab in Computerized Patient Record System (CPRS) V.
"PKG",197,22,1,"PAH",1,1,14,0)
 1.0. This patch will correct the problem by preventing the error from
"PKG",197,22,1,"PAH",1,1,15,0)
 occurring. MIN-1204-41611.
"PKG",197,22,1,"PAH",1,1,16,0)
 
"PKG",197,22,1,"PAH",1,1,17,0)
 4. When renewing an Inpatient IV order from the Inpatient Order Entry
"PKG",197,22,1,"PAH",1,1,18,0)
 [PSJ OE] option, an edit to the Provider is not reflected in the order
"PKG",197,22,1,"PAH",1,1,19,0)
 when viewed from CPRS V.1.0. This patch will correct the problem by
"PKG",197,22,1,"PAH",1,1,20,0)
 ensuring the updated provider information is transmitted to CPRS V.1.0.
"PKG",197,22,1,"PAH",1,1,21,0)
 IND-0105-40153.
"PKG",197,22,1,"PAH",1,1,22,0)
 
"PKG",197,22,1,"PAH",1,1,23,0)
 5. There is no prompt for output device for the PRE-EXCHANGE UNITS REPORT
"PKG",197,22,1,"PAH",1,1,24,0)
 after copying a Unit Dose order using the CO Copy action in Inpatient
"PKG",197,22,1,"PAH",1,1,25,0)
 Order Entry [PSJ OE] option. This patch will add a device prompt for the
"PKG",197,22,1,"PAH",1,1,26,0)
 Pre-Exchange Units Report to the Unit Dose copy action. HWH-1204-41654.
"PKG",197,22,1,"PAH",1,1,27,0)
 
"PKG",197,22,1,"PAH",1,1,28,0)
 6. When finishing a pending unit dose renewal order, the default 
"PKG",197,22,1,"PAH",1,1,29,0)
 administration times associated with the administration schedule will 
"PKG",197,22,1,"PAH",1,1,30,0)
 always default into the order, overwriting the order's existing
"PKG",197,22,1,"PAH",1,1,31,0)
 administration time. With this patch, renewal orders will retain the
"PKG",197,22,1,"PAH",1,1,32,0)
 original order's administration times. BHS-0105-10562.
"PKG",197,22,1,"PAH",1,1,33,0)
 
"PKG",197,22,1,"PAH",1,1,34,0)
 7. When the schedule type is edited during the finish of a unit dose
"PKG",197,22,1,"PAH",1,1,35,0)
 order that was renewed from CPRS V.1.0, the order appears twice in the
"PKG",197,22,1,"PAH",1,1,36,0)
 Patient Profile (Unit Dose) [PSJU PR] option. This patch corrects the
"PKG",197,22,1,"PAH",1,1,37,0)
 problem by removing the display associated with the previous schedule
"PKG",197,22,1,"PAH",1,1,38,0)
 type before adding the display associated with the new schedule type.
"PKG",197,22,1,"PAH",1,1,39,0)
 FRE-0105-60387, MAC-0205-61020.
"PKG",197,22,1,"PAH",1,1,40,0)
 
"PKG",197,22,1,"PAH",1,1,41,0)
 8. Multiple identically named schedules in the ADMINISTRATION SCHEDULE
"PKG",197,22,1,"PAH",1,1,42,0)
 file (#51.1) may cause an invalid schedule warning message to appear
"PKG",197,22,1,"PAH",1,1,43,0)
 inappropriately. This patch corrects the problem by preventing the
"PKG",197,22,1,"PAH",1,1,44,0)
 invalid warning message from appearing if the schedule name is defined in
"PKG",197,22,1,"PAH",1,1,45,0)
 the file, even if duplicates are present. HD0000000085881.
"PKG",197,22,1,"PAH",1,1,46,0)
 
"PKG",197,22,1,"PAH",1,1,47,0)
 9. A non-standard Day of Week schedule entered without administration
"PKG",197,22,1,"PAH",1,1,48,0)
 times using the schedule builder in CPRS V. 3.0 may default to a
"PKG",197,22,1,"PAH",1,1,49,0)
 different schedule in Inpatient Medications V. 5.0 if the non-standard
"PKG",197,22,1,"PAH",1,1,50,0)
 schedule is a partial match to a unique Day of Week schedule in the
"PKG",197,22,1,"PAH",1,1,51,0)
 ADMINISTRATION SCHEDULE file (#51.1). For example, if the non-standard
"PKG",197,22,1,"PAH",1,1,52,0)
 schedule SU-MO-TU-WE is entered without admin times using the CPRS V.
"PKG",197,22,1,"PAH",1,1,53,0)
 3.0 schedule builder, and the schedule SU-MO-TU-WE-TH@09 exists in the
"PKG",197,22,1,"PAH",1,1,54,0)
 ADMINISTRATION SCHEDULE file (#51.1), and there are no other schedules in
"PKG",197,22,1,"PAH",1,1,55,0)
 the ADMINISTRATION SCHEDULE file (#51.1) that begin with SU-MO-TU-WE, the
"PKG",197,22,1,"PAH",1,1,56,0)
 order's schedule will default to SU-MO-TU-WE-TH@09 when the order is
"PKG",197,22,1,"PAH",1,1,57,0)
 selected for finishing.  HD0000000087120, PSI-05-025.
"PKG",197,22,1,"PAH",1,1,58,0)
 
"PKG",197,22,1,"PAH",1,1,59,0)
 10. A non-standard Day of Week schedule entered using the schedule
"PKG",197,22,1,"PAH",1,1,60,0)
 builder in CPRS V. 3.0 defaults to the wrong Expected First Dose if the
"PKG",197,22,1,"PAH",1,1,61,0)
 schedule is a partial match to exactly one schedule in the ADMINISTRATION
"PKG",197,22,1,"PAH",1,1,62,0)
 SCHEDULE file (#51.1), and that schedule that was found contains an
"PKG",197,22,1,"PAH",1,1,63,0)
 administration time. HD0000000087028 PSI-05-026.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
30
"RTN","PSGOD")
0^7^B19402686
"RTN","PSGOD",1,0)
PSGOD ;BIR/CML3-CREATES NEW ORDER FROM OLD ONE ;22 SEP 97 / 2:56 PM 
"RTN","PSGOD",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**67,58,111,133**;16 DEC 97
"RTN","PSGOD",3,0)
 ;
"RTN","PSGOD",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOD",5,0)
 ;
"RTN","PSGOD",6,0)
 I $P($G(^PS(55,PSGP,5,+PSJORD,0)),"^",22) D  Q
"RTN","PSGOD",7,0)
 .W !,"This order is marked 'Not To Be Given' and can't be copied!" H 2
"RTN","PSGOD",8,0)
 F  W !!,"Do you want to copy this order" S %=2 D YN^DICN Q:%  D CH
"RTN","PSGOD",9,0)
 G:%'=1 DONE
"RTN","PSGOD",10,0)
 ;
"RTN","PSGOD",11,0)
 W !!,"...copying..." N OLDON
"RTN","PSGOD",12,0)
 N PSGPDRG
"RTN","PSGOD",13,0)
 S PSGOEPR=$P($G(^PS(55,PSGP,5.1)),"^",2),OLDON=PSGORD
"RTN","PSGOD",14,0)
 ;K PSGODN S F=$S((PSGORD["N")!(PSGORD["P"):"^PS(53.1,"_+PSGORD_",",1:"^PS(55,"_PSGP_",5,"_+PSGORD_",") F N=0,.2,2,6 S PSGODN(N)=$G(@(F_N_")"))
"RTN","PSGOD",15,0)
 K PSGODN S F=$S(PSGORD["P":"^PS(53.1,"_+PSGORD_",",1:"^PS(55,"_PSGP_",5,"_+PSGORD_",") F N=0,.2,2,6 S PSGODN(N)=$G(@(F_N_")"))
"RTN","PSGOD",16,0)
 S PSGPR=$P(PSGODN(0),"^",2),PSGMR=$P(PSGODN(0),"^",3),PSGSM=$P(PSGODN(0),"^",5),PSGHSM=$P(PSGODN(0),"^",6),PSGST=$P(PSGODN(0),"^",7)
"RTN","PSGOD",17,0)
 S PSGPDRG=+PSGODN(.2),PSGDO=$P(PSGODN(.2),"^",2)
"RTN","PSGOD",18,0)
 S PSGSI=PSGODN(6)
"RTN","PSGOD",19,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD
"RTN","PSGOD",20,0)
 S PSGODN(3)=0 F Q=0:0 S Q=$O(@(F_"3,"_Q_")")) Q:'Q  I $D(^(Q,0)) S PSGODN(3,Q)=^(0),PSGODN(3)=PSGODN(3)+1 S ^PS(53.45,PSJSYSP,1,Q,0)=^(0)
"RTN","PSGOD",21,0)
 ;S:PSGODN(12)>0 ^PS(53.45,PSJSYSP,4,0)="^53.4504" S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",22,0)
 S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",23,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD  
"RTN","PSGOD",24,0)
 S (PSGODN(1),Q)=0 F  S Q=$O(@(F_"1,"_Q_")")) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3) S PSGODN(1)=PSGODN(1)+1,PSGODN(1,PSGODN(1))=$P(ND,"^",1,2) S ^PS(53.45,PSJSYSP,2,PSGODN(1),0)=^(0)
"RTN","PSGOD",25,0)
 S PSGS0Y=$P(PSGODN(2),"^",5),PSGS0XT=$P(PSGODN(2),"^",6),PSGNESD="",PSGSCH=$P(PSGODN(2),U)
"RTN","PSGOD",26,0)
 S PSGODF=1,PSGNEDFD=$P($$GTNEDFD^PSGOE7("U",+PSGPDRG),U)_"^^"_PSGST_"^"_PSGSCH
"RTN","PSGOD",27,0)
 W "." D ^PSGNE3
"RTN","PSGOD",28,0)
 K PSGEFN,PSGOEEF,PSGOEE,PSGOEOS S PSGEFN="1:13" F X=1:1:13 S PSGEFN(X)=""
"RTN","PSGOD",29,0)
 S PSGPDN=$$OINAME^PSJLMUTL(PSGPDRG),PSGOINST="",PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSGOD",30,0)
 S PSGAT=PSGS0Y,PSGEBN=DUZ,PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGEBN=$$ENNPN^PSGMI(DUZ),PSGSTAT=$S(PSGOEAV:"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOD",31,0)
 W "." D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSGOD",32,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOD",33,0)
 .N X S X=PSGSCH N SWD,SDW,XABB,QX D ENOS^PSGS0 I $G(X)=""!$G(PSJNSS) S CHK=1 K PSJNSS Q
"RTN","PSGOD",34,0)
 .I $G(PSGAT)="",$G(PSGS0Y) S PSGAT=PSGS0Y
"RTN","PSGOD",35,0)
 .I $G(PSGAT),($G(PSGS0Y)="") S PSGS0Y=PSGAT
"RTN","PSGOD",36,0)
 .I $G(PSGS0XT)="D",$G(PSGS0Y)="" S CHK=1 D  K PSJNSS
"RTN","PSGOD",37,0)
 ..W ! K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules    " D ^DIR K DIR
"RTN","PSGOD",38,0)
 S PSGSD=PSGNESD,PSGFD=PSGNEFD
"RTN","PSGOD",39,0)
 K PSJACEPT S VALMBCK="Q" D:$D(Y) EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOD",40,0)
 I $G(PSJACEPT)=1 S VALMBCK="",PSJNOO=$$ENNOO^PSJUTL5("N")
"RTN","PSGOD",41,0)
 I '$G(PSJACEPT)!($G(PSJNOO)<0) W !!,"Order not copied." D PAUSE^VALM1 G ORIG
"RTN","PSGOD",42,0)
 S PSGNESD=PSGSD,PSGNEFD=PSGFD
"RTN","PSGOD",43,0)
 K PSGOEE D ^PSGOETO S PSJORD=PSGORD I PSGOEAV D
"RTN","PSGOD",44,0)
 .I '$D(PSGOEE),+PSJSYSU=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOD",45,0)
 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),^PSGOE1,EN^VALM("PSJ LM UD ACTION")
"RTN","PSGOD",46,0)
 ;
"RTN","PSGOD",47,0)
 S PSGCANFL=0,(PSGORD,PSJORD)=OLDON W !!,"You are finished with the new order.",!,"The following ACTION prompt is for the original order."
"RTN","PSGOD",48,0)
 K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOD",49,0)
ORIG ;Redisplay original order
"RTN","PSGOD",50,0)
 D GETUD^PSJLMGUD(PSGP,OLDON),INIT^PSJLMUDE(PSGP,OLDON)
"RTN","PSGOD",51,0)
DONE ;
"RTN","PSGOD",52,0)
 K %,%H,%I,DA,F,N,PSGODN,PSGODF,PSGS0XT,PSGS0Y,PSGNESD,PSGTOL,PSGTOO,PSGUOW,X,Y,^PS(53.45,PSJSYSP,1),^PS(53.45,PSJSYSP,2)
"RTN","PSGOD",53,0)
 K PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGPDRG,PSGDO,PSGNEDFD,PSGSCH,PSGNEFD
"RTN","PSGOD",54,0)
 Q
"RTN","PSGOD",55,0)
 ;
"RTN","PSGOD",56,0)
CH ;
"RTN","PSGOD",57,0)
 W !!?2,"Answer 'YES' to have a new, non-verified order created for this patient,",!,"using the information from this order.  (The START and STOP dates will be",!,"recalculated.)  Enter 'NO' (or '^') to stop now." Q
"RTN","PSGOD",58,0)
 ;
"RTN","PSGOD",59,0)
WH ;
"RTN","PSGOD",60,0)
 W !!?2,"Answer 'YES' to take action on this new order.  Enter 'NO' (or '^') to return",!,"to the original order now." Q
"RTN","PSGOE")
0^11^B25900556
"RTN","PSGOE",1,0)
PSGOE ;BIR/CML3-PROFILE AND ORDER ENTRY (MAIN DRIVER) ;24 Feb 99 / 10:40 AM
"RTN","PSGOE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**22,29,56,72,95,80,133**;16 DEC 97
"RTN","PSGOE",3,0)
 ;
"RTN","PSGOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOE",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSGOE",6,0)
 ;
"RTN","PSGOE",7,0)
 ;N PSJNEW,PSGPTMP,PPAGE S PSJNEW=1
"RTN","PSGOE",8,0)
 ;
"RTN","PSGOE",9,0)
EN ;
"RTN","PSGOE",10,0)
 N PSJLK,PSJPROT,XQORS,VALMEVL,PSJSYSO D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGOE",11,0)
 S (PSGOL,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" I $P(PSJSYSU,";",2)&($P(PSJSYSU,";")'=3) S PSGION=ION D DDEV D ^%ZISC I DDEV="^" G DONE
"RTN","PSGOE",12,0)
 K PSGVBY L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE
"RTN","PSGOE",13,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ENDPT^PSGP,HK Q:PSGP'>0  D   I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSGOE",14,0)
 .K ^TMP("PSJ",$J)
"RTN","PSGOE",15,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSGOE",16,0)
 .N NXTPT S NXTPT=0  ;NXTPT=1 indicates OE is complete for this patient
"RTN","PSGOE",17,0)
 .K PSJLMPRO S PSJLMCON=0
"RTN","PSGOE",18,0)
 .S PSJPROT=1,DFN=PSGP D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSGOE",19,0)
 .F  Q:$G(NXTPT)  D
"RTN","PSGOE",20,0)
 ..K PSGRDTX
"RTN","PSGOE",21,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSGOE",22,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSGOE",23,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJU LM OE")
"RTN","PSGOE",24,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSGOE",25,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSGOE",26,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSGOE",27,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSGOE",28,0)
 ...S NXTPT=1
"RTN","PSGOE",29,0)
 ..S NXTPT=1,PSJNEWOE=0 ; Go on to next patient
"RTN","PSGOE",30,0)
 .I $G(PSGPXN),$P(PSJSYSW0,U,29)]"" S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSGOE",31,0)
 ..N DFN,PSGP S (PSGP,DFN)=PSGPXPT D ^PSGPER
"RTN","PSGOE",32,0)
 .D ENCV^PSGSETU
"RTN","PSGOE",33,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSGOE",34,0)
 ;
"RTN","PSGOE",35,0)
DONE ;
"RTN","PSGOE",36,0)
 I PSGOP,$P(PSJSYSL,"^",2)]"" D ENQL^PSGLW
"RTN","PSGOE",37,0)
 I $D(PSJSYSO),PSGOP,$O(^PS(53.44,DUZ,1,PSGOP,1,0)) S PSGOEPOF="" D ^PSGOEPO
"RTN","PSGOE",38,0)
 K D0,DDEV,FQC,J,MRN,ND,ND2,PSGNEF,PSGNEFDO,PSGNESDO,PSGOE,PSGOEA,PSGOEAV,PSGOEDMR,PSGOENOF,PSGOEPOF,PSGOL,PSGOP,PSGPX,PSGTOL,PSGTOO,PSGUOW,PSJOPC,PSJORTOU,PSJORVP,PRI,PX,XX L -^PS(53.45,PSJSYSP)
"RTN","PSGOE",39,0)
 K PSGOEORF,ORIFN,ORETURN,PSJORL,PSJORPCL,PSJORPV,PSJNOO,DDH,DDN,DRGI,FQ,HF,I1,ND1,NF,PDRG,PSGACTO,PSGAL,PSGCANFL,PSGDA,PSGPEN,PSGPENWS,PSGY
"RTN","PSGOE",40,0)
 G:$G(PSGPXN) ^PSGPER1 D ENKV^PSGSETU K ND1,PSG25,PSG26,PSGEB,PSBEBN,PSGNODE,PSGOAT,PSGSTAT,DDN,I2 Q
"RTN","PSGOE",41,0)
 Q
"RTN","PSGOE",42,0)
 ;
"RTN","PSGOE",43,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSGOE",44,0)
 S PSGOENOF=0 I +PSJSYSU=1 D NOW^%DTC F Q=%:0 Q:PSGOENOF  S Q=$O(^PS(55,PSGP,5,"AUS",Q)) Q:'Q  F QQ=0:0 S QQ=$O(^PS(55,PSGP,5,"AUS",Q,QQ)) Q:'QQ  I $D(^PS(55,PSGP,5,QQ,4)),$P(^(4),"^",10) S PSGOENOF=1 Q
"RTN","PSGOE",45,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSGOE",46,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSGOE",47,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSGOE",48,0)
 I $D(PSJSYSO),PSGOP,PSGOP'=PSGP S PSGOEPOF="" D ^PSGOEPO
"RTN","PSGOE",49,0)
 S:PSGP>0 PSJORVP=PSGP_";DPT(",PSJORL=$$ENORL^PSJUTL(PSJPWD),PSGOP=PSGP,X=""
"RTN","PSGOE",50,0)
 Q
"RTN","PSGOE",51,0)
 ;
"RTN","PSGOE",52,0)
ORSU ; Oe/Rr Set-Up ;Not used anymore
"RTN","PSGOE",53,0)
 ;K %ZIS,IO("Q") S IOP="HOME" D ^%ZIS
"RTN","PSGOE",54,0)
 ;S PSGOEORF=$O(^DIC(9.4,"B","INPATIENT MEDICATIONS",0)) I PSGOEORF S PSGOEORF=$S($D(^ORD(100.99,1,20,PSGOEORF,0)):$P(^(0),"^",2),1:0)
"RTN","PSGOE",55,0)
 ;I PSGOEORF S PSJORTOU=$O(^ORD(100.98,"B","INPATIENT MEDICATIONS",0)),PSJORPCL=$O(^ORD(101,"B","PSJ OR PAT OE",0)),PSJORPCL=PSJORPCL_";ORD(101,"
"RTN","PSGOE",56,0)
 Q
"RTN","PSGOE",57,0)
 ;
"RTN","PSGOE",58,0)
DDEV ;
"RTN","PSGOE",59,0)
 F  S POP=1 R !!,"Select Device to print ORDERS (10-1158): ",DDEV:DTIME W:'$T $C(7) S:'$T DDEV="^" Q:DDEV="^"!(DDEV=".")  D:DDEV?1."?" DDH K %ZIS,IO("Q") S %ZIS="NQ",IOP=DDEV D ^%ZIS Q:'POP
"RTN","PSGOE",60,0)
 S:DDEV="^" %=-1 Q:POP  I $E(IOST)'="P"!(PSGION=ION) W $C(7),!!?2,"The device you have selected is not a printer.  You must select a printer." W:PSGION=ION !,"You cannot print the orders to your terminal." G DDEV
"RTN","PSGOE",61,0)
 S PSJSYSO=ION_"^"_IO W:$S(DDEV=" ":1,$L(DDEV)'<$L(ION):0,1:DDEV=$E(ION,1,$L(DDEV))) $S(DDEV=" ":"  "_ION,1:$E(ION,$L(DDEV)+1,$L(ION)))
"RTN","PSGOE",62,0)
 F Q=0:0 S Q=$O(^PS(53.44,DUZ,1,Q)) Q:'Q  I $O(^(Q,1,0)) Q
"RTN","PSGOE",63,0)
 Q:'Q  W !!?2,"You have unprinted orders.  If you do not print them now, you will not be",!,"able to print them from here later."
"RTN","PSGOE",64,0)
 F  W !!,"Do you want to print them now" S %=1 D YN^DICN Q:%  W !!?2,"Enter 'YES' to print the orders now.  If you enter 'NO', you will not be",!,"able to print them from here later.  (Enter '^' to exit this option.)"
"RTN","PSGOE",65,0)
 Q:%<0  I %=1 S PSGOEPOF="A" D ^PSGOEPO S %=0 Q
"RTN","PSGOE",66,0)
 S DA=DUZ,DIK="^PS(53.44," D ^DIK S %=0 Q
"RTN","PSGOE",67,0)
 ;
"RTN","PSGOE",68,0)
DDH ;
"RTN","PSGOE",69,0)
 W !!?2,"Select a device to print each patient's orders (VA Form 10-1158) after you",!,"have entered them.  If you do not select a device, no orders will print." Q
"RTN","PSGOE",70,0)
 ;
"RTN","PSGOE",71,0)
CHUCK ;
"RTN","PSGOE",72,0)
 D ENCV^PSGSETU Q:$D(XQUIT)  R !!,"PSJSYSU: ",PSJSYSU:DTIME S:'$T PSJSYSU="^" I "^"'[PSJSYSU G EN
"RTN","PSGOE",73,0)
 Q
"RTN","PSGOE1")
0^22^B29854333
"RTN","PSGOE1",1,0)
PSGOE1 ;BIR/CML3-ACTION ON INPATIENT ORDERS ;10 Mar 99 / 10:54 AM
"RTN","PSGOE1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,19,26,39,58,85,80,110,127,133**;16 DEC 97
"RTN","PSGOE1",3,0)
 ;
"RTN","PSGOE1",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSGOE1",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA #2192.
"RTN","PSGOE1",6,0)
 ; Reference to EN1^ORCFLAG is supported by DBIA #3620.
"RTN","PSGOE1",7,0)
 ; Reference to AND^ORX8 is supported by DBIA #3632.
"RTN","PSGOE1",8,0)
EN ;       
"RTN","PSGOE1",9,0)
 K PSGDFLG,PSGPFLG S PSGOEA="^",PSGACT="",(PSGDI,PSGOENG,PSGPI,PSGRRF)=0
"RTN","PSGOE1",10,0)
 Q:'$G(DUZ)
"RTN","PSGOE1",11,0)
 D @$S(PSGORD["P":"NON",1:"ACT")
"RTN","PSGOE1",12,0)
GO ;
"RTN","PSGOE1",13,0)
 K A,ND,PSGE,PSGR,ST,X,X1,X2,Y I $D(ORACTION) K PSGDI,PSGOENG,PSGPI Q
"RTN","PSGOE1",14,0)
 ;W:$G(PSGPFLG) !!?3,"(THE ORDERABLE ITEM IS CURRENTLY LISTED AS INACTIVE.)" W:$G(PSGDFLG) !!?3,"(ONE OR ALL DISPENSE DRUGS ARE CURRENTLY LISTED AS INACTIVE OR DO NOT MATCH",!?3,"THE ORDERABLE ITEM FOR THIS ORDER.)"
"RTN","PSGOE1",15,0)
 ;I $G(PSGPFLG)!$G(PSGDFLG) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOE1",16,0)
 ;S PSGCANFL=0 ;F  D ACTO W !!,"ACTION"_$S(PSGACTO]"":" ("_PSGACTO_")",1:"")_"? " R PSGOEA:DTIME W:'$T $C(7) S:'$T PSGOEA="^" Q:"^"[PSGOEA  D CHK D:C @PSGOEA Q:PSGCANFL
"RTN","PSGOE1",17,0)
 Q
"RTN","PSGOE1",18,0)
ENACTION(PSGP,PSGORD)        ;
"RTN","PSGOE1",19,0)
 ;Returns string identifying the actions allowed on this order.
"RTN","PSGOE1",20,0)
 D EN
"RTN","PSGOE1",21,0)
 Q PSGACT
"RTN","PSGOE1",22,0)
DONE ;
"RTN","PSGOE1",23,0)
 I PSGORD["U"!(PSGORD["O") L -^PS(55,PSGP,5,+PSGORD)
"RTN","PSGOE1",24,0)
 E  L -^PS(53.1,+PSGORD)
"RTN","PSGOE1",25,0)
 K C,PSGACT,PSGDFLG,PSGPFLG,PSGDI,PSGOENG,PSGPI,PSGRRF Q
"RTN","PSGOE1",26,0)
B ; bypass
"RTN","PSGOE1",27,0)
 S PSGCANFL=1
"RTN","PSGOE1",28,0)
 Q
"RTN","PSGOE1",29,0)
C ; copy an order (does NOT discontinue original order)
"RTN","PSGOE1",30,0)
 D ^PSGOD Q
"RTN","PSGOE1",31,0)
D ; discontinue (or delete) an order
"RTN","PSGOE1",32,0)
 I PSGOEAV,'$D(PSGODF) D ENDS^PSGPO Q
"RTN","PSGOE1",33,0)
 D ENO^PSGOEC(PSGP,PSGORD) Q
"RTN","PSGOE1",34,0)
E ; edit orders
"RTN","PSGOE1",35,0)
 D ^PSGOEE Q
"RTN","PSGOE1",36,0)
F ; finish released orders
"RTN","PSGOE1",37,0)
 D ^PSGOEF Q
"RTN","PSGOE1",38,0)
H(PSGP,PSGORD) ; hold
"RTN","PSGOE1",39,0)
 S X=$G(^PS(55,PSGP,5,+PSGORD,4)) I $P(X,U,12),$P(X,U,13) W $C(7),!!,"WARNING!  THIS ORDER HAS BEEN MARKED FOR CANCELLATION."
"RTN","PSGOE1",40,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,0)),"^",9)="H" D ^PSGOEH0 Q
"RTN","PSGOE1",41,0)
 D ^PSGOEH1 Q
"RTN","PSGOE1",42,0)
I ; mark (or unmark) a non-verified order as 'incomplete'
"RTN","PSGOE1",43,0)
 D ^PSGOEI Q
"RTN","PSGOE1",44,0)
L ; display logs
"RTN","PSGOE1",45,0)
 D ^PSGOEL Q
"RTN","PSGOE1",46,0)
N ; mark order as 'not to be given'
"RTN","PSGOE1",47,0)
 D ^PSGOENG Q
"RTN","PSGOE1",48,0)
O ; Outpatient (discharge) med
"RTN","PSGOE1",49,0)
 W !!,"UNDER DEVELOPMENT, NOT CURRENTLY AVAILABLE."
"RTN","PSGOE1",50,0)
 Q
"RTN","PSGOE1",51,0)
P ; print expanded view
"RTN","PSGOE1",52,0)
 D ^PSGVWP Q
"RTN","PSGOE1",53,0)
R ; renew an order
"RTN","PSGOE1",54,0)
 I 'PSJSYSU,$D(^PS(55,PSGP,5,+PSGORD,4)),$P(^(4),"^",15),$P(^(4),"^",16) W !!,"THIS ORDER IS ALREADY MARKED FOR RENEWAL!" Q
"RTN","PSGOE1",55,0)
 I 'PSGRRF D ^PSGOER Q
"RTN","PSGOE1",56,0)
 D ^PSGOERI Q
"RTN","PSGOE1",57,0)
S ; show the order again
"RTN","PSGOE1",58,0)
 D EN2^PSGVW Q
"RTN","PSGOE1",59,0)
V ; verify an order
"RTN","PSGOE1",60,0)
 D EN^PSGOEV Q
"RTN","PSGOE1",61,0)
ACT ;
"RTN","PSGOE1",62,0)
 S X=$G(^PS(55,PSGP,5,+PSGORD,0)),ND0=X,ND=$G(^(4)),ND2=$G(^(2)),PSGOENG=$P(X,"^",22),PSGR=$E("R",'PSGOENG),PSJCOM=$P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,8)
"RTN","PSGOE1",63,0)
 I 'PSGOENG,PSJCOM S PSGR=$E("R",$$AND^ORX8(PSJCOM)) S:PSGR="R" PSGR=$E("R",$$RNEWOK^PSJUTL2(PSJCOM,PSGP))
"RTN","PSGOE1",64,0)
 S PSGR=$E("R",'$$EXPIRED^PSGOER(PSGP,PSGORD)) S PSGR=$E("R",$P(ND0,"^",7)'="O")
"RTN","PSGOE1",65,0)
 I $P(ND2,U,4)'>PSGDT D OLD Q
"RTN","PSGOE1",66,0)
 S PSGE="E" I '$D(PSGOETOF) S (PSGDFLG,PSGDI)='$$DDOK^PSGOE2("^PS(55,"_PSGP_",5,"_+PSGORD_",1,",+$G(^PS(55,PSGP,5,+PSGORD,.2))),PSGPFLG='$$OIOK^PSGOE2(+$G(^PS(55,PSGP,5,+PSGORD,.2)))
"RTN","PSGOE1",67,0)
 S:$P(X,"^",26) (PSGE,PSGR)=""
"RTN","PSGOE1",68,0)
 I '$D(PSGOETOF) S PSGPI=$P(X,"^",2) I PSGPI S PSGPI=$P($G(^VA(200,PSGPI,"PS")),"^",4) S:PSGPI PSGPI=PSGPI'>DT
"RTN","PSGOE1",69,0)
 S ST=$P(X,"^",9)="H"*4 S:ST (PSGE,PSGR)=""
"RTN","PSGOE1",70,0)
 ;S PSGACT="D"_$S(+$P(^PS(55,PSGP,5,+PSGORD,.2),"^",8):"",1:PSGE)_$S($P(ND,"^",18+ST)&'$P(ND,"^",19+ST)&'$P(ND,"^",PSJSYSU):"",1:"H")_"L"_$S(ST:"",1:PSGR)
"RTN","PSGOE1",71,0)
 N CMPOK S CMPOK=1 I $$COMPLEX^PSJOE(PSGP,PSGORD) S CMPOK=+$P(^PS(55,PSGP,5,+PSGORD,.2),"^",8)
"RTN","PSGOE1",72,0)
 S PSGACT="D"_$S('$G(CMPOK):"",1:PSGE)_$S($P(ND,"^",18+ST)&'$P(ND,"^",19+ST)&'$P(ND,"^",PSJSYSU):"",1:"H")_"L"_$S(ST:"",1:PSGR)
"RTN","PSGOE1",73,0)
 I PSJSYSU,'$P(ND,"^",+PSJSYSU) S PSGACT=PSGACT_"V"
"RTN","PSGOE1",74,0)
 I +PSJSYSU=3,$L($T(EN1^ORCFLAG)) S PSGACT=PSGACT_"G"
"RTN","PSGOE1",75,0)
 Q
"RTN","PSGOE1",76,0)
OLD ;
"RTN","PSGOE1",77,0)
 S A=$P(ND0,"^",9),PSGACT=$E("H",A="H")_"L" I A'["D",A'["E" Q
"RTN","PSGOE1",78,0)
 I 'PSGOENG,($D(^XUSEC("PSJU MGR",DUZ))!$D(^XUSEC("PSJ RPHARM",DUZ))) S PSGACT="LN"
"RTN","PSGOE1",79,0)
 I PSJSYSU,'$P(ND,"^",+PSJSYSU) S:(A'["D")&($G(PSGPRIO)'="DONE") PSGACT="D"_PSGACT S PSGACT=PSGACT_"V" Q
"RTN","PSGOE1",80,0)
 Q:PSGR=""!'PSJPCAF  D NOW^%DTC S (PSGDT,X1)=+$E(%,1,12),X2=-4 D C^%DTC I $S('$P(ND2,"^",4):1,1:$P(ND2,"^",4)'>X) Q
"RTN","PSGOE1",81,0)
 I A="E",$G(PSJPRI)'="D" S PSGACT=PSGACT_PSGR Q
"RTN","PSGOE1",82,0)
 I PSJSYSU,$P(ND,"^",11) S PSGACT=PSGACT_PSGR,PSGRRF=1
"RTN","PSGOE1",83,0)
 Q
"RTN","PSGOE1",84,0)
NON ;
"RTN","PSGOE1",85,0)
 N XND,DRGPT,XND2
"RTN","PSGOE1",86,0)
 S (X,XND)=$G(^PS(53.1,+PSGORD,0)) I $P(X,"^",19),$D(^PS(55,PSGP,5,$P(X,"^",19))) L -^PS(53.1,+PSGORD) S PSGORD=$P(X,"^",19)_"U" G ACT
"RTN","PSGOE1",87,0)
 I $S($P(X,"^",26):1,$P(X,"^",9)["D":1,1:$P(X,"^",9)["E") S:$P(X,U,9)="P"&($P(X,U,26)) PSGACT="D" S:(+PSJSYSU=3)&($L($T(EN1^ORCFLAG))) PSGACT=PSGACT_"G" Q
"RTN","PSGOE1",88,0)
 I PSGORD["U" S PSGACT="DE" S:(+PSJSYSU=3)&($L($T(EN1^ORCFLAG))) PSGACT=PSGACT_"G" Q
"RTN","PSGOE1",89,0)
 I '$D(PSGOETOF) S (PSGDFLG,PSGDI)='$$DDOK^PSGOE2("^PS(53.1,"_+PSGORD_",1,",+$G(^PS(53.1,+PSGORD,.2))),PSGPFLG='$$OIOK^PSGOE2(+$G(^PS(53.1,+PSGORD,.2)))
"RTN","PSGOE1",90,0)
 S DRG=$$STUFFDD^PSGOE2 S:DRG ^PS(53.1,+PSGORD,1,0)="^53.11P^1^1",^PS(53.1,+PSGORD,1,1,0)=DRG,^PS(53.1,+PSGORD,1,"B",DRG,1)=""
"RTN","PSGOE1",91,0)
 F DRG=0:0 S DRG=$O(^PS(53.1,+PSGORD,1,DRG)) Q:'DRG  S DRGPT=^(DRG,0) S INACTDT=$G(^PSDRUG(+DRGPT,"I")) I INACTDT,(INACTDT'>DT) S PSGDFLG=1
"RTN","PSGOE1",92,0)
 I $P(XND,U,9)="P" S PSGACT=$S(+PSJSYSU=3:"BDEF",$G(PSJRNF):"BDEF",1:"") S:(+PSJSYSU=3)&($L($T(EN1^ORCFLAG))) PSGACT=PSGACT_"G" Q
"RTN","PSGOE1",93,0)
 I '$D(PSGOETOF) S PSGPI=$P(XND,"^",2) I PSGPI S PSGPI=$P($G(^VA(200,PSGPI,"PS")),"^",4) S:PSGPI PSGPI=PSGPI'>DT
"RTN","PSGOE1",94,0)
 S PSGACT="DEI" I PSJSYSU,'PSGPI,$P(XND,"^",9)'="I" S PSGACT=PSGACT_"V"
"RTN","PSGOE1",95,0)
 ;* S PSGACT="DEI" I PSJSYSU,'PSGDI,'PSGPI,$P(X,"^",9)'="I" S PSGACT=PSGACT_"V"
"RTN","PSGOE1",96,0)
 S XND2=$G(^PS(53.1,+PSGORD,.2)) I $P(XND2,"^",8),$P(XND,"^",9)="P" S PSGACT=$TR(PSGACT,"V")
"RTN","PSGOE1",97,0)
 I +PSJSYSU=3,$L($T(EN1^ORCFLAG)) S PSGACT=PSGACT_"G"
"RTN","PSGOE1",98,0)
 I $P($G(PSGRDTX),U,2)]"",'$D(^PS(53.1,+PSGORD,2.5)) S $P(^PS(53.1,+PSGORD,2.5),U,2)=$P(PSGRDTX,U,2)
"RTN","PSGOE1",99,0)
 Q
"RTN","PSGOE1",100,0)
ACTO ;
"RTN","PSGOE1",101,0)
 S PSGACTO="" I $G(PSGACT)]"" F X=1:1:$L(PSGACT) S PSGACTO=PSGACTO_$S($E(PSGACT,X)="D":"DC",1:$E(PSGACT,X))_" "
"RTN","PSGOE1",102,0)
 S:PSGACTO]"" PSGACTO=$E(PSGACTO,1,$L(PSGACTO)-1) Q
"RTN","PSGOEF")
0^14^B54376800
"RTN","PSGOEF",1,0)
PSGOEF ;BIR/CML3-FINISH ORDERS ENTERED THROUGH OE/RR ;14 May 98 / 2:17 PM
"RTN","PSGOEF",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,30,29,35,39,47,50,56,80,116,110,111,133**;16 DEC 97
"RTN","PSGOEF",3,0)
 ;
"RTN","PSGOEF",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOEF",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192
"RTN","PSGOEF",6,0)
 ; Reference to DOSE^PSSORPH is supported by DBIA 3234.
"RTN","PSGOEF",7,0)
 ;
"RTN","PSGOEF",8,0)
START ;
"RTN","PSGOEF",9,0)
 I '$D(^PS(53.1,+PSGORD)) W $C(7),!?3,"Cannot find this pending order (#",+PSGORD,")." Q
"RTN","PSGOEF",10,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12) K PSGFDX,PSGEFN,PSGOEEF,PSGOES,PSGONF,PSGRDTX S PSGOES=1,(PSGOEF,PSGOEEF)=0,PSGOEEG=3
"RTN","PSGOEF",11,0)
 I $D(PSJTUD) S PSGDO=$P($G(^PS(53.1,+PSGORD,.3)),U),(PSGPDRG,PSGPD)=PSJCOI,(PSGPDRGN,PSGPDN)=$$OINAME^PSJLMUTL(PSGPD)
"RTN","PSGOEF",12,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S X=PSGSCH D EN^PSGORS0 S:$D(X) PSGAT=PSGS0Y D
"RTN","PSGOEF",13,0)
 . NEW PSJDOX,PSJDOSE,PSJPIECE,PSJUNIT,PSJX,X
"RTN","PSGOEF",14,0)
 . S X=$G(^PS(53.1,+PSGORD,1,1,0)) Q:'+X
"RTN","PSGOEF",15,0)
 . D DOSE^PSSORPH(.PSJDOX,+X,"U")
"RTN","PSGOEF",16,0)
 . I $S('$D(PSJDOX):1,1:+PSJDOX(1)=-1) Q
"RTN","PSGOEF",17,0)
 . S PSJPIECE=$S($P(PSJDOX(1),U)="":3,1:1)
"RTN","PSGOEF",18,0)
 . S X=^PS(53.1,+PSGORD,.2)
"RTN","PSGOEF",19,0)
 . S:PSJPIECE=3 PSJDOSE=$P(X,U,2)
"RTN","PSGOEF",20,0)
 . S:PSJPIECE=1 PSJDOSE=$P(X,U,5),PSJUNIT=$P(X,U,6)
"RTN","PSGOEF",21,0)
 . F X=0:0 S X=$O(PSJDOX(X)) Q:+$G(PSJX)!'X  D
"RTN","PSGOEF",22,0)
 .. I PSJPIECE=3,($P(PSJDOX(X),U,3)'=PSJDOSE) Q
"RTN","PSGOEF",23,0)
 .. I PSJPIECE=1,($P(PSJDOX(X),U,1)_$P(PSJDOX(X),U,2)'=(PSJDOSE_PSJUNIT)) Q
"RTN","PSGOEF",24,0)
 .. S:+$P(PSJDOX(X),U,12) $P(^PS(53.45,PSJSYSP,2,1,0),U,2)=+$P(PSJDOX(X),U,12),PSJX=1
"RTN","PSGOEF",25,0)
 I PSGEB'=PSGOPR F X=7,11 S Y=$T(@(3_X)),@("PSGEFN("_X_")="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))="",PSGOEEF=PSGOEEF+1
"RTN","PSGOEF",26,0)
 D GTST^PSGOE6(+PSGORD)
"RTN","PSGOEF",27,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S PSGSD="" D:PSGS0Y]""
"RTN","PSGOEF",28,0)
 .N PSJX S PSJX=$P($G(^PS(53.1,+PSGORD,0)),U,25) I PSJX="" Q
"RTN","PSGOEF",29,0)
 .I PSJX["U" S PSGSD=$P($G(^PS(55,DFN,5,+PSJX,2)),U,2) Q
"RTN","PSGOEF",30,0)
 .I PSJX["V" S PSGSD=$P($G(^PS(55,DFN,"IV",+PSJX,0)),U,2) Q
"RTN","PSGOEF",31,0)
 .I PSJX["P" S PSGSD=$P($G(^PS(53.1,+PSJX,2)),U,2)
"RTN","PSGOEF",32,0)
 S:PSGSD="" PSGSD=PSGLI
"RTN","PSGOEF",33,0)
 S PSGNEDFD=$$GTNEDFD^PSGOE7("U",+PSGPD)
"RTN","PSGOEF",34,0)
 S:$P($G(PSGNEDFD),U,3)="" $P(PSGNEDFD,U,3)=PSGST  ; N PSGOEA S PSGOEA="R"
"RTN","PSGOEF",35,0)
 S (PSGNESD,PSGSD)=$$ENSD^PSGNE3(PSGSCH,PSGS0Y,PSGLI,PSGSD)
"RTN","PSGOEF",36,0)
 ;if this is a renewal order, ignore any 'requested start date' received.  Use the system calculated start date.
"RTN","PSGOEF",37,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" D
"RTN","PSGOEF",38,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEF",39,0)
 E  D
"RTN","PSGOEF",40,0)
 . S X=$$DSTART^PSJDCU(DFN,$P(^PS(53.1,+PSGORD,0),U,25)) I X]"" S (PSGNESD,PSGSD)=X K PSGRSD
"RTN","PSGOEF",41,0)
 D ENFD^PSGNE3(PSGLI) S PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGFD")):PSGRDTX(+PSGORD,"PSGFD"),1:PSGNEFD)
"RTN","PSGOEF",42,0)
 N DUR,PSGRNSD S PSGRNSD=+$$LASTREN^PSJLMPRI(DFN,PSGORD) I PSGRNSD S DUR=$$GETDUR^PSJLIVMD(DFN,PSGORD,"P",1) I DUR]"" D
"RTN","PSGOEF",43,0)
 . N DURMIN S DURMIN=$$DURMIN^PSJLIVMD(DUR) I DURMIN S PSGFD=$$FMADD^XLFDT(PSGRNSD,,,DURMIN)
"RTN","PSGOEF",44,0)
 S PSGOFD="",PSGSDN=$$ENDD^PSGMI(PSGSD)_U_$$ENDTC^PSGMI(PSGSD),PSGFDN=$$ENDD^PSGMI(PSGFD)_U_$$ENDTC^PSGMI(PSGFD)
"RTN","PSGOEF",45,0)
 S PSGLIN=$$ENDD^PSGMI(PSGLI)_U_$$ENDTC^PSGMI(PSGLI)
"RTN","PSGOEF",46,0)
 I '$O(^PS(53.45,PSJSYSP,2,0)) N DRG,DRGCNT S DRGCNT=0 D
"RTN","PSGOEF",47,0)
 .F X=0:0 S X=$O(^PSDRUG("ASP",+PSGPD,X)) Q:'X!(DRGCNT>1)  S:$P($G(^PSDRUG(+X,2)),U,3)["U" DRGCNT=DRGCNT+1,DRG=+X
"RTN","PSGOEF",48,0)
 .I DRGCNT=1 K ^PS(53.45,PSJSYSP,2) S ^PS(53.45,PSJSYSP,2,1,0)=DRG_U_1,^PS(53.45,PSJSYSP,2,0)="^53.4502^1^1",PS(53.45,PSJSYSP,2,"B",+DRG,1)=""
"RTN","PSGOEF",49,0)
 Q
"RTN","PSGOEF",50,0)
FINISH ;
"RTN","PSGOEF",51,0)
 ; force display of second screen if CPRS order checks exist
"RTN","PSGOEF",52,0)
 N NSFF,PSGOEF39 S NSFF=1 K PSJNSS
"RTN","PSGOEF",53,0)
 I $G(PSGORD),$D(PSGRDTX(+PSGORD)) D  K PSGRDTX
"RTN","PSGOEF",54,0)
 . S:$G(PSGRDTX(+PSGORD,"PSGRSD")) PSGSD=PSGRDTX(+PSGORD,"PSGRSD")
"RTN","PSGOEF",55,0)
 . S:$G(PSGRDTX(+PSGORD,"PSGRFD")) PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGRFD")):PSGRDTX(+PSGORD,"PSGRFD"),1:$G(PSGNEFD))
"RTN","PSGOEF",56,0)
 N PSJCOM S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8)
"RTN","PSGOEF",57,0)
 I $O(^PS(53.1,+PSGORD,12,0))!$O(^PS(53.1,+PSGORD,10,0)) D
"RTN","PSGOEF",58,0)
 .Q:$G(PSJLMX)=1  ; there's no second screen to display
"RTN","PSGOEF",59,0)
 .S VALMBG=16 D RE^VALM4,PAUSE^VALM1
"RTN","PSGOEF",60,0)
 D FULL^VALM1
"RTN","PSGOEF",61,0)
 I $G(PSJPROT)=3,'$D(PSJTUD),'$$ENIVUD^PSGOEF1(PSGORD) Q
"RTN","PSGOEF",62,0)
 S CHK=0 S:$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" PSGSI=$$ENPC^PSJUTL("U",+PSJSYSP,180,PSGSI)
"RTN","PSGOEF",63,0)
 I $G(PSGOSCH)]"" D  S:$G(PSGS0XT)'<0 $P(^PS(53.1,+PSGORD,2),"^",6)=PSGS0XT
"RTN","PSGOEF",64,0)
 .N PSGOES,PSGS0Y,PSGSCH S X=PSGOSCH K:$G(PSJTUD) NSFF D ENOS^PSGS0 I '($G(PSGORD)["P"&($P($G(^PS(53.1,+PSGORD,0)),"^",24)="R")) I $G(X)]""&$G(PSGS0Y) S PSGAT=PSGS0Y
"RTN","PSGOEF",65,0)
 .I $G(PSJNSS) S PSGOSCH="" K PSJNSS
"RTN","PSGOEF",66,0)
 I '$G(PSJTUD),$G(PSJNSS),($G(PSGOSCH)]"") D NSSCONT^PSGS0(PSGOSCH,PSGS0XT) K PSJNSS S PSGOSCH=""
"RTN","PSGOEF",67,0)
 S PSGOEFF=PSGOSCH=""+('$O(^PS(53.45,PSJSYSP,2,0))*10)
"RTN","PSGOEF",68,0)
 I PSGOEFF S X=$S(PSGOEFF#2:" a SCHEDULE",1:"")_$S(PSGOEFF=11:" and",1:"")_$S(PSGOEFF>9:" at least one DISPENSE DRUG",1:"")
"RTN","PSGOEF",69,0)
 I 'PSGOEFF I (($G(PSGS0XT)="D")&($G(PSGAT)="")) S X=" Admin Times",PSGOEFF=1,PSGOEF39=1
"RTN","PSGOEF",70,0)
 I PSGOEFF,X]"" S X=X_" before it can be finished."
"RTN","PSGOEF",71,0)
 I PSGOEFF S CHK=1 W $C(7),!!,"PLEASE NOTE: This order must have" F Q=1:1:$L(X," ") S Y=$P(X," ",Q) W:$L(Y)+$X>78 ! W Y," "
"RTN","PSGOEF",72,0)
 I $G(PSGOEF39) S PSGOEE=0,PSGOEFF=0 D  I 'PSGOEE D REFRESH^VALM G DONE
"RTN","PSGOEF",73,0)
 .S F1=53.1,MSG=0,Y=$T(39),@("PSGFN(39)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEEF,PSGOEE)=1 W ! D @$P($T(39),";",3) S CHK=0
"RTN","PSGOEF",74,0)
 I PSGOEFF=1 S F1=53.1,MSG=0,Y=$T(38),@("PSGFN(38)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(38),";",3) S CHK=0 G:'PSGOEE DONE
"RTN","PSGOEF",75,0)
 I PSGOEFF=11 S F1=53.1,MSG=0,Y=$T(32),@("PSGFN(32)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(32),";",3) D  G:'PSGOEE DONE
"RTN","PSGOEF",76,0)
 .S F1=53.1,MSG=0,Y=$T(38),@("PSGFN(38)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(38),";",3) S CHK=0
"RTN","PSGOEF",77,0)
 I PSGOEFF>9 S CHK=7 D ENDRG^PSGOEF1(+PSGPD,0) I CHK D ABORTACC Q
"RTN","PSGOEF",78,0)
 I 'PSGOEFF D OC531^PSGOESF ; check every dispense drug from CPRS
"RTN","PSGOEF",79,0)
 S VALMBG=1
"RTN","PSGOEF",80,0)
 I 'PSGOEFF&($D(PSGORQF)) D RE^VALM4 Q
"RTN","PSGOEF",81,0)
 I $G(MSG) K DIR S DIR(0)="E" W !! D ^DIR
"RTN","PSGOEF",82,0)
 I PSGOEFF D:PSGST="" GTST^PSGOE6(+PSGORD)
"RTN","PSGOEF",83,0)
 S PSJLMFIN=1
"RTN","PSGOEF",84,0)
 K PSJACEPT I $O(^PS(53.1,+PSGORD,12,0)) S PSJLMP2=1
"RTN","PSGOEF",85,0)
 S PSGOEENO=0,PSGSTAT=$S($P(PSJSYSP0,U,9):"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOEF",86,0)
 NEW PSJDOSE,PSJDOX,PSJDSFLG
"RTN","PSGOEF",87,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEF",88,0)
 S:+$G(PSJDSFLG) VALMSG="Dosage Ordered & Dispense Drug are not compatible"
"RTN","PSGOEF",89,0)
 I PSGODO=PSGDO S PSGOEEF(109)=""
"RTN","PSGOEF",90,0)
 I PSGODO'=PSGDO S PSGOEENO=1,VALMSG="This change will cause a new order to be created  "
"RTN","PSGOEF",91,0)
 D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEF",92,0)
 I $G(PSJNSS) D  S PSGOEEF(26)="" K PSJACEPT,PSJNSS
"RTN","PSGOEF",93,0)
 .K DIR S DIR(0)="FOA",DIR("A")="Invalid Schedule" D ^DIR K DIR
"RTN","PSGOEF",94,0)
 I $G(PSGS0XT)="D",'$G(PSGS0Y),'$G(PSGAT),((",P,R,")'[(","_$G(PSGST)_",")) D  S PSGOEEF(39)="" K PSJACEPT
"RTN","PSGOEF",95,0)
 .K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules  " D ^DIR K DIR
"RTN","PSGOEF",96,0)
 I '$G(PSJACEPT) D ABORTACC Q
"RTN","PSGOEF",97,0)
 I $G(PSJRNF),$G(^PS(53.1,+PSGORD,4)) D
"RTN","PSGOEF",98,0)
 . W $C(7),!!,"ACCEPTING THIS ORDER WILL CHANGE THE STATUS TO ACTIVE."
"RTN","PSGOEF",99,0)
 . S DIR(0)="Y",DIR("A")="Do you wish to make this order Active",DIR("?",1)="Enter ""N"" if you wish to exit without Activating this order,"
"RTN","PSGOEF",100,0)
 . S DIR("?")="or ""Y"" to continue with the Activation process." D ^DIR S:'Y Y=-1 K DIR
"RTN","PSGOEF",101,0)
 I $G(PSJRNF),$G(Y)=-1 S PSJACEPT=0 D ABORTACC Q
"RTN","PSGOEF",102,0)
 I $G(PSJRNF),$G(Y)=1 S PSGOEAV=1
"RTN","PSGOEF",103,0)
 I PSGOEENO S PSJNOO=$$ENNOO^PSJUTL5("E"),PSJACEPT=$S(PSJNOO<0:0,1:1)
"RTN","PSGOEF",104,0)
ACCEPT ;
"RTN","PSGOEF",105,0)
 S VALMBCK=$S($G(PSJACEPT):"Q",1:"R")
"RTN","PSGOEF",106,0)
 I '$G(PSJACEPT) D ABORTACC Q
"RTN","PSGOEF",107,0)
 K PSGOES,PSGRSD,PSGRSDN D:PSGOEENO NEW3^PSGOEE D:'PSGOEENO UPD^PSGOEF1 I $D(PSGOEF)!PSGOEENO S PSGCANFL=-1
"RTN","PSGOEF",108,0)
 D DONE1^PSGOEE
"RTN","PSGOEF",109,0)
 D DONE
"RTN","PSGOEF",110,0)
 Q
"RTN","PSGOEF",111,0)
BYPASS ;
"RTN","PSGOEF",112,0)
 S PSGCANFL=1
"RTN","PSGOEF",113,0)
 ;
"RTN","PSGOEF",114,0)
DONE ;
"RTN","PSGOEF",115,0)
 K CHK,DA,DIE,DR,DRG,MSG,Q1,Q2 ;PSGND,PSGOEE,PSGOEEF,PSGOEEND,PSGOEEG,PSGOEF,PSGOEFF,PSGOES,PSGOPD,PSGOPDN,PSGOPR,PSGOSCH,PSGPDRG,PSGDRGN,PSG0XT,PSGS0Y,OSGSD,Q1,Q2
"RTN","PSGOEF",116,0)
 Q
"RTN","PSGOEF",117,0)
ABORTACC ; Abort Accept process.
"RTN","PSGOEF",118,0)
 D ABORT^PSGOEE K PSGOEEF D GETUD^PSJLMGUD(PSGP,PSGORD),^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),INIT^PSJLMUDE(PSGP,PSGORD) S VALMBCK="R",PSGSD=PSGNESD,PSGFD=PSGNEFD Q
"RTN","PSGOEF",119,0)
 ;
"RTN","PSGOEF",120,0)
 ;
"RTN","PSGOEF",121,0)
31 ;;101^PSGOE8;PSGOPD;PSGPD;101;1
"RTN","PSGOEF",122,0)
32 ;;109^PSGOE8;PSGODO;PSGDO;109;PSGODO]""
"RTN","PSGOEF",123,0)
33 ;;10^PSGOE81;PSGOSD;PSGSD;10;0
"RTN","PSGOEF",124,0)
34 ;;3^PSGOE8;PSGOMR;PSGMR;3;1
"RTN","PSGOEF",125,0)
35 ;;25^PSGOE81;PSGOFD;PSGFD;25;0
"RTN","PSGOEF",126,0)
36 ;;7^PSGOE8;PSGOST;PSGST;7;0
"RTN","PSGOEF",127,0)
37 ;;5^PSGOE82;PSGOSM;PSGSM;5;0
"RTN","PSGOEF",128,0)
38 ;;26^PSGOE8;PSGOSCH;PSGSCH;26;1      
"RTN","PSGOEF",129,0)
39 ;;39^PSGOE81;PSGOAT;PSGAT;39;0
"RTN","PSGOEF",130,0)
310 ;;1^PSGOE82;PSGOPR;PSGPR;1;1
"RTN","PSGOEF",131,0)
311 ;;8^PSGOE81;PSGOSI;PSGSI;8;0
"RTN","PSGOEF",132,0)
312 ;;2^PSGOE82;;;2;0
"RTN","PSGOEF",133,0)
313 ;;40^PSGOE82;;;40;0
"RTN","PSGOEF",134,0)
 ;
"RTN","PSGOEF",135,0)
AH ;
"RTN","PSGOEF",136,0)
 W !!?2,"Answer 'YES' to accept this order as a NON-VERIFIED UNIT DOSE order.  Answer",!,"'NO' to edit this order now.  Enter '^' to BYPASS this order, leaving it as",!,"a PENDING INPATIENT order."
"RTN","PSGOEF",137,0)
 Q
"RTN","PSGOER")
0^26^B72070079
"RTN","PSGOER",1,0)
PSGOER ;BIR/CML3-RENEW A SINGLE ORDER ;07 MAR 96 / 1:23 PM
"RTN","PSGOER",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**11,30,29,35,70,58,95,110,111,133**;16 DEC 97
"RTN","PSGOER",3,0)
 ;
"RTN","PSGOER",4,0)
 ; Reference to ^PS(51.1 supported by DBIA 2177.
"RTN","PSGOER",5,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOER",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOER",7,0)
 ; Reference to ^PSBAPIPM is supported by DBIA 3564.
"RTN","PSGOER",8,0)
 ; Reference to ^PS(59.7 is supported by DBIA 2181.
"RTN","PSGOER",9,0)
 ;
"RTN","PSGOER",10,0)
 ; renew a single order
"RTN","PSGOER",11,0)
 I $G(PSJCOM) D ^PSJCOMR Q
"RTN","PSGOER",12,0)
 N PSJEXPIR S PSJEXPIR=$$EXPIRED(PSGP,PSGORD) I PSJEXPIR D  Q
"RTN","PSGOER",13,0)
 .W !!?3,"  THIS ORDER" W:PSJEXPIR'=2 " HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED",!?8," ADMINISTRATIONS AND"
"RTN","PSGOER",14,0)
 .W " CANNOT BE RENEWED!" D PAUSE^VALM1
"RTN","PSGOER",15,0)
 I $G(PSGSCH)]"",($G(PSGS0XT)="D"),($G(PSGAT)="") D  Q
"RTN","PSGOER",16,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOER",17,0)
 .Q:((",P,R,")[(","_$G(PSGST)_","))
"RTN","PSGOER",18,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!?3,"This order contains a 'DAY OF THE WEEK' schedule without admin times"
"RTN","PSGOER",19,0)
 .W !?11," and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",20,0)
 I $G(PSGSCH)]"",'$$DOW^PSIVUTL(PSGSCH),'$$PRNOK^PSGS0(PSGSCH) I '$D(^PS(51.1,"AC","PSJ",PSGSCH)) D  Q
"RTN","PSGOER",21,0)
 .W !!?3,"This order contains an invalid schedule and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",22,0)
 W !! K DIR S DIR(0)="Y",DIR("A")=$S($P(PSJSYSP0,"^",3):"RENEW THIS ORDER",1:"MARK THIS ORDER FOR RENEWAL"),DIR("B")="YES"
"RTN","PSGOER",23,0)
 S DIR("?")="Answer 'YES' to "_$S($P(PSJSYSP0,"^",3):"renew this order",1:"mark this order for renewal")_".  Answer 'NO' (or '^') to stop now." D ^DIR
"RTN","PSGOER",24,0)
 I '$D(DIRUT),Y D NEW S PSGCANFL=1 D DONE Q
"RTN","PSGOER",25,0)
 I '$D(DIRUT),PSJSYSU S PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I $P(PSGND4,"^",15),$P(PSGND4,"^",16) D UNMARK,DONE Q
"RTN","PSGOER",26,0)
 D DONE,ABORT^PSGOEE
"RTN","PSGOER",27,0)
 Q
"RTN","PSGOER",28,0)
 ;
"RTN","PSGOER",29,0)
UNMARK ;  
"RTN","PSGOER",30,0)
 W !!,"THIS ORDER HAS BEEN 'MARKED FOR RENEWAL'.",! K DIR S DIR(0)="Y",DIR("A")="DO YOU WANT TO 'UNMARK IT'",DIR("B")="NO"
"RTN","PSGOER",31,0)
 S DIR("?",1)="  Answer 'YES' to unmark this order.  Answer 'NO' (or '^') to leave the order",DIR("?")="marked.  (An answer is required.)" D ^DIR
"RTN","PSGOER",32,0)
 I 'Y D ABORT^PSGOEE G DONE
"RTN","PSGOER",33,0)
 S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=21180+PSJSYSU D ^PSGAL5 S $P(PSGND4,"^",15,17)="^^",^PS(55,PSGP,5,DA,4)=PSGND4 W "...DONE!"
"RTN","PSGOER",34,0)
 ;
"RTN","PSGOER",35,0)
DONE ;
"RTN","PSGOER",36,0)
 K %DT,DA,DIE,DIR,DR,FDSD,PSGAL,PSGALR,PSGDL,PSGDLS,PSGFD,PSGFOK,PSGND4,PSGOEE,PSGOER0,PSGOER1,PSGOER2,PSGOERDP,PSGOPR,PSGOSD,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGRD,PSGSD,PSGTOL,PSGTOO,PSGUOW,PSGWLL,RF Q
"RTN","PSGOER",37,0)
 ;
"RTN","PSGOER",38,0)
NEW ; get info, write record
"RTN","PSGOER",39,0)
EXTEND ; extend stop date on renewal order
"RTN","PSGOER",40,0)
 N DUOUT,PSJABT,PSGDRG,PSJREN,PSGOREAS S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^"),PSJREN=1
"RTN","PSGOER",41,0)
 I $G(PSGST)="O" N ACT S ACT=$$EN^PSBAPIPM(PSGP,PSGORD) I $P(ACT,"^",2),($P(ACT,"^",3)="G") I $P(ACT,"^",2)>$P($G(^PS(55,PSGP,5,+PSGORD,2)),"^",2) D  Q
"RTN","PSGOER",42,0)
 . W !!?5,"THIS ONE-TIME ORDER HAS ALREADY BEEN GIVEN AND CANNOT BE RENEWED",! S (DIRUT,PSGORQF)=1 D READ
"RTN","PSGOER",43,0)
 D OC55
"RTN","PSGOER",44,0)
 Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSGOER",45,0)
 D NOW^%DTC S PSGDT=%,PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I '$P(PSJSYSP0,"^",3) D MARK Q
"RTN","PSGOER",46,0)
 S PSGWLL=$S('$P(PSJSYSW0,"^",4):0,1:+$G(^PS(55,PSGP,5.1))),PSGOEE="R" K PSGOEOS
"RTN","PSGOER",47,0)
 K ^PS(53.45,PSJSYSP,1),^(2) D MOVE(3,1),MOVE(1,2)
"RTN","PSGOER",48,0)
 D DATE^PSGOER0(PSGP,PSGORD,PSGDT) I ($G(X)="^")!'$D(PSGFOK(106))!$G(DUOUT) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",49,0)
SPEED ;
"RTN","PSGOER",50,0)
 I +$G(PSJSYSU)=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOER",51,0)
 Q:$G(DUOUT)
"RTN","PSGOER",52,0)
 N PSGOEAV S PSGOEAV=+PSJSYSU
"RTN","PSGOER",53,0)
 W !!,"...updating order..." K DA S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5 W "."
"RTN","PSGOER",54,0)
 I $$LS^PSSLOCK(PSGP,PSGORD) D UPDREN(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO),UPDRENOE(PSGP,PSGORD,PSGDT) D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOER",55,0)
 ;
"RTN","PSGOER",56,0)
 I 'PSGOERDP,$P(PSJSYSW0,"^",4),PSGFD'<PSGWLL S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSGOER",57,0)
 W ".DONE!" S VALMBCK="Q" Q
"RTN","PSGOER",58,0)
 ;
"RTN","PSGOER",59,0)
MARK ;
"RTN","PSGOER",60,0)
 I $P(PSGND4,"^",15),$P(PSGND4,"^",16) W $C(7),!!?3,"...THIS ORDER IS ALREADY MARKED FOR RENEWAL!..." Q
"RTN","PSGOER",61,0)
 K DA S $P(PSGND4,"^",15,17)="1^"_DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=PSGND4,PSGAL("C")=13180,DA(1)=PSGP,DA=+PSGORD W "." D ^PSGAL5
"RTN","PSGOER",62,0)
 I $D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="R",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOER",63,0)
 Q
"RTN","PSGOER",64,0)
MOVE(X,Y) ; Move comments/dispense drugs from 55 to 53.45.
"RTN","PSGOER",65,0)
 S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,X,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,Y,Q,0)=$G(^(Q,0))
"RTN","PSGOER",66,0)
 S:Q ^PS(53.45,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSGOER",67,0)
 Q
"RTN","PSGOER",68,0)
OC55 ;* Order checks for Speed finish and regular finish
"RTN","PSGOER",69,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG
"RTN","PSGOER",70,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOER",71,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,+$G(^PS(55,PSGP,5,+PSGORD,1,1,0)))
"RTN","PSGOER",72,0)
 I '$D(PSGORQF) K PSGORQF,^TMP($J,"DI") D
"RTN","PSGOER",73,0)
 . F PSGDDI=1:0 S PSGDDI=$O(^PS(55,PSGP,5,+PSGORD,1,PSGDDI)) Q:'PSGDDI  S PSJDD=+$G(^PS(55,PSGP,5,+PSGORD,1,PSGDDI,0)) K PSJPDRG D IVSOL^PSGSICHK
"RTN","PSGOER",74,0)
 Q
"RTN","PSGOER",75,0)
UPDREN(PSGORD,RNWDT,PSGOEPR,PSGOFD,PSJNOO,RDUZ) ; update renewed order
"RTN","PSGOER",76,0)
 N DR,DA,DIC,DIE,DD,DO,PSGRZERO,PSGRFOUR,PSGOORD
"RTN","PSGOER",77,0)
 S DR="",PSGOEENO=0,PSGOORD=PSGORD,PSGNESD=PSGSD Q:'PSGORD!'RNWDT!'PSGOEPR!'PSGOFD  S PSJNOO=$S($G(PSJNOO)]"":$G(PSJNOO),1:"E")
"RTN","PSGOER",78,0)
 S PSGRZERO="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGOEORD=$P(@PSGRZERO,"^",21)
"RTN","PSGOER",79,0)
 S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5," S DR="34////^S X=PSGFD" S:$G(PSGOEPR) DR=DR_";1////"_PSGOEPR_";110////"_PSJNOO D ^DIE
"RTN","PSGOER",80,0)
 K DR,DA,DIC,DIE,DD,DO S DIC="^PS(55,"_PSGP_",5,"_+PSGORD_",14,",DIC(0)="L",DIC("P")="55.6114DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=PSGP,DA(1)=+PSGORD D
"RTN","PSGOER",81,0)
 . S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$S($G(RDUZ):RDUZ,1:$G(DUZ))_";2////"_$G(PSGOEPR)_";3////"_$G(PSGOFD)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSGOER",82,0)
 K DR,DA,DIC,DIE,DD,DO S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="28////A;105////@;107////@"
"RTN","PSGOER",83,0)
 S PSGRFOUR="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGRFOUR=@PSGRFOUR I $P(PSGRFOUR,"^",2)<RNWDT S DR=DR_";16////@;17////@"
"RTN","PSGOER",84,0)
 I '$G(PSJSPEED) I $G(PSGAT)]"",$G(PSGAT)'=$P($G(@(DIE_+PSGORD_",2)")),"^",5) S DR=DR_";41////"_PSGAT
"RTN","PSGOER",85,0)
 D ^DIE
"RTN","PSGOER",86,0)
 Q
"RTN","PSGOER",87,0)
UPDRENOE(PSGP,PSGORD,RDATE) ;
"RTN","PSGOER",88,0)
 D EXPOE(PSGP,PSGORD,$G(RDATE)) ; expire original Orders File order
"RTN","PSGOER",89,0)
 I PSGORD'["P" K DA,DR,DIE S DA(1)=DFN,DA=+PSGORD,DIE="^PS(55,"_DFN_$S(PSGORD="U":",5,",1:",""IV"","),DR=$S(DIE["IV":110,1:66)_"////@" D ^DIE
"RTN","PSGOER",90,0)
 D ENUDTX^PSJOREN(PSGP,PSGORD,"NR")
"RTN","PSGOER",91,0)
 D EN1^PSJHL2(PSGP,"SN",PSGORD,"ORDER RENEWED")
"RTN","PSGOER",92,0)
 Q
"RTN","PSGOER",93,0)
READ ; hold screen
"RTN","PSGOER",94,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","PSGOER",95,0)
 W !?5,"Press return to continue  " R X:$S($D(DTIME):DTIME,1:300)
"RTN","PSGOER",96,0)
 Q
"RTN","PSGOER",97,0)
EXPOE(DFN,PSJORDER,EXPDT) ; expire old Orders File entry
"RTN","PSGOER",98,0)
 I PSJORDER["P" S FILE="^PS(53.1,"_+PSJORDER_",0)",PSJORDER=$P(@FILE,"^",25)
"RTN","PSGOER",99,0)
 I (PSJORDER'["U"),(PSJORDER'["V") Q
"RTN","PSGOER",100,0)
 N CURDAT D NOW^%DTC S CURDAT=$$DATE2^PSJUTL2(%)
"RTN","PSGOER",101,0)
 S PSJEXPOE=$S($G(EXPDT):EXPDT,1:CURDAT) D EN1^PSJHL2(DFN,"SC",PSJORDER) K PSJEXPOE
"RTN","PSGOER",102,0)
 Q
"RTN","PSGOER",103,0)
EXPIRED(PSJX,PSJY) ;
"RTN","PSGOER",104,0)
 ; INPUT 
"RTN","PSGOER",105,0)
 ;       PSJX - Pharmacy Patient, pointer to ^PS(55
"RTN","PSGOER",106,0)
 ;       PSJY - Inpatient Order Number, pointer to IV or UD multiple of Pharmacy Patient file (appended with "V" or "U")
"RTN","PSGOER",107,0)
 ; OUTPUT
"RTN","PSGOER",108,0)
 ;   0  -  Order has not exceeded the Expired Time Limit 
"RTN","PSGOER",109,0)
 ;   1  -  Order has exceeded the Expired Time Limit
"RTN","PSGOER",110,0)
 N STOP,STATUS,NOW,CUTOFF,FREQ,LAST,ST,X,DFN,U,PSGDT,SD,WD,PSJPSTO,PSGDW,PSGOC,ZZND,LASTAT,LSTSTR,PSBCNT S DFN=PSJX,U="^",CUTOFF=0
"RTN","PSGOER",111,0)
 S STATUS=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,0)),"^",9),PSJY["V":$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",17),1:"")
"RTN","PSGOER",112,0)
 S NOW=$S($G(PSGDT):PSGDT,1:$$DATE^PSJUTL2())
"RTN","PSGOER",113,0)
 S STOP=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,2)),U,4),1:$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",3))
"RTN","PSGOER",114,0)
 I NOW<STOP Q 0
"RTN","PSGOER",115,0)
 I PSJY["U" N ND2,ND0 S ND0=$G(^PS(55,PSJX,5,+PSJY,0)),ND2=$G(^PS(55,PSJX,5,+PSJY,2)),FREQ=$P(ND2,"^",6) D
"RTN","PSGOER",116,0)
 .N SCHED S SCHED=$P($G(^PS(55,PSJX,5,+PSJY,2)),"^") I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED)
"RTN","PSGOER",117,0)
 .S LSTSTR=$P(ND2,"^",2)_"^"_$P(ND2,"^",4)_"^"_SCHED_"^"_$P(ND0,"^",7)_"^^"_$P(ND2,"^",5)
"RTN","PSGOER",118,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,($P(ND0,"^",7)="O"),($P(LAST,"^",3)="G") I LAST>$P(ND2,"^",2) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",119,0)
 .I 'LAST!(LAST>$P(ND2,"^",4)) S LAST=$$LASTAT^PSJORP2(DFN,LSTSTR) S:LAST CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",120,0)
 .I SCHED["PRN",($P(LSTSTR,"^",6)="") S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",121,0)
 .I $$DOW^PSIVUTL(SCHED) S CUTOFF=$$NXTDOW(DFN,$P(LSTSTR,"^"),$P(LSTSTR,"^",2),$P(LSTSTR,"^",3),$P(LSTSTR,"^",6)) Q
"RTN","PSGOER",122,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND2,"^",4)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",123,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,,,FREQ) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",124,0)
 I PSJY["V" N LIMIT S LIMIT=$P($G(^PS(59.7,1,31)),"^",4) S LIMIT=$S((LIMIT]""):+LIMIT,1:24) S CUTOFF=$$FMADD^XLFDT(STOP,,LIMIT) D
"RTN","PSGOER",125,0)
 .I '($G(P(4))]"") N P,YP,XP S YP=$G(^PS(55,DFN,"IV",+PSJY,0)) F XP=1:1:23 S P(XP)=$P(YP,U,XP)
"RTN","PSGOER",126,0)
 .Q:'($G(P(4))]"")
"RTN","PSGOER",127,0)
 .Q:'$$SCHREQ^PSJLIVFD(.P)
"RTN","PSGOER",128,0)
 .N INTERVAL,LSTSTR,ND0,SCHED,IVSTYP S ND0=$G(^PS(55,PSJX,"IV",+PSJY,0)),INTERVAL=$P(ND0,"^",15),SCHED=$P(ND0,"^",9) Q:SCHED=""
"RTN","PSGOER",129,0)
 .S IVSTYP=$S($$DOW^PSIVUTL(SCHED):"D",INTERVAL="O":"O",1:"C"),LSTSTR=$P(ND0,"^",2)_"^"_$P(ND0,"^",3)_"^"_SCHED_"^"_IVSTYP_"^^"_$P(ND0,"^",11)
"RTN","PSGOER",130,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,IVSTYP="O",LAST>$P(ND0,"^",2),($P(LAST,"^",3)="G") S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",131,0)
 .I 'LAST!(LAST>$P(ND0,"^",3))!(LAST&(IVSTYP="O")) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",132,0)
 .I IVSTYP="D" S CUTOFF=$$NXTDOW(LAST,SCHED,$G(P(2)),$P($G(P(9)),"@"),$G(P(11))) Q
"RTN","PSGOER",133,0)
 .I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED) S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",134,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND0,"^",3)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",135,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,31) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",136,0)
 K LYN,PSBDT,PSBFLAG,PSBSTR
"RTN","PSGOER",137,0)
 Q $S(CUTOFF<NOW:1,1:0)
"RTN","PSGOER",138,0)
 ;
"RTN","PSGOER",139,0)
NXTDOW(DOWDFN,DOWSD,DOWFD,DOWSCH,DOWAT) ;
"RTN","PSGOER",140,0)
 N NXTADM,DOWSTR S DOWSTR=$$FMADD^XLFDT(DOWFD,,,,1)_"^"_$$FMADD^XLFDT(DOWFD,7)_"^"_DOWSCH_"^D^^"_DOWAT S NXTADM=$$ENQ^PSJORP2(DOWDFN,DOWSTR)
"RTN","PSGOER",141,0)
 Q $S(NXTADM:NXTADM,1:DOWSD)
"RTN","PSGOER",142,0)
 ;
"RTN","PSGOER",143,0)
PRNFREQ(SCHED) ;
"RTN","PSGOER",144,0)
 N ZZND,D,DA,X,PSGAT,PSGOES,PSGST,PSJNSS,PSJPWD,TEST,VALMBCK,PSGS0XT,PSGS0Y,PSGDT
"RTN","PSGOER",145,0)
 F X=$P(SCHED,"PRN"),$P(SCHED,"PRN",2),$P(SCHED," PRN"),$P(SCHED,"PRN ",2) Q:$P($G(ZZND),"^",4)  D ADMIN^PSJORPOE
"RTN","PSGOER",146,0)
 Q $S($G(PSGS0XT):PSGS0XT,1:1440)
"RTN","PSGOESF")
0^28^B25954410
"RTN","PSGOESF",1,0)
PSGOESF ;BIR/MLM-SPEED FINISH ORDERS ENTERED THROUGH OE/RR ;10 Mar 98 / 2:35 PM
"RTN","PSGOESF",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,11,29,35,127,133**;16 DEC 97
"RTN","PSGOESF",3,0)
 ;
"RTN","PSGOESF",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOESF",5,0)
 ; Reference to ^TMP is supported by DBIA 2190
"RTN","PSGOESF",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSGOESF",7,0)
 ;
"RTN","PSGOESF",8,0)
EN ;
"RTN","PSGOESF",9,0)
 I '$$HIDDEN^PSJLMUTL("SPEED") S VALMBCK="R" Q
"RTN","PSGOESF",10,0)
 N CODE,ST,DRG,ON,PSGONF,PSGONF2,PSGSFD
"RTN","PSGOESF",11,0)
 D FULL^VALM1 S PSGLMT=PSJOCNT,(PSGONF,PSGONF2)=0
"RTN","PSGOESF",12,0)
 S CODE="" F  S CODE=$O(^TMP("PSJ",$J,CODE)) Q:CODE=""  D
"RTN","PSGOESF",13,0)
 .S ST="" F  S ST=$O(^TMP("PSJ",$J,CODE,ST)) Q:ST=""  D
"RTN","PSGOESF",14,0)
 ..S DRG="" F  S DRG=$O(^TMP("PSJ",$J,CODE,ST,DRG)) Q:DRG=""  D
"RTN","PSGOESF",15,0)
 ...S ON="" F  S ON=$O(^TMP("PSJ",$J,CODE,ST,DRG,ON)) Q:ON=""  S PSGONF=PSGONF+1 D
"RTN","PSGOESF",16,0)
 ....I CODE="CC" S:$G(PSGONF2)=0 PSGONF2=PSGONF S PSGRLAST=PSGONF ;gets first renewal #
"RTN","PSGOESF",17,0)
 I PSGONF2'>0 W !,"There are no orders which can be Speed Finished at this time.",!,"Only PENDING RENEWALS can be Speed Finished." D PAUSE^VALM1 Q
"RTN","PSGOESF",18,0)
 S PSGONF=PSGONF2_"^"_PSGRLAST
"RTN","PSGOESF",19,0)
 N DIR,L1,L2 S L1=+PSGONF,L2=$P(PSGONF,U,2),DIR(0)="LAO^"_L1_":"_L2,DIR("A")="FINISH which orders ("_L1_"-"_L2_"): ",DIR("?",1)="Select order"_$E("s",L1'=L2)_"to finish: ",DIR("??")="^D HELP^PSGOESF"
"RTN","PSGOESF",20,0)
 D ^DIR K DIR I $D(DIRUT) K X G DONE
"RTN","PSGOESF",21,0)
 I X?1N1"-" Q:$P(PSGONF,U,2)<X  S Y="" F L1=+X:1 S Y=Y_L1_"," Q:L1=$P(PSGONF,U,2)
"RTN","PSGOESF",22,0)
 I 'Y W $C(7),!!,"??" G EN
"RTN","PSGOESF",23,0)
ENCHK ;
"RTN","PSGOESF",24,0)
 S PSJSPEED=1
"RTN","PSGOESF",25,0)
 K PSGODDD S PSGODDD=1,PSGODDD(1)="" F Q=1:1:$L(Y,",") S X1=$P(Y,",",Q) D SET^PSGON Q:'$D(X)
"RTN","PSGOESF",26,0)
 S PSGOSD=0 F PSGOERS=1:1:PSGODDD F PSGOERS1=1:1 S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1) Q:'PSGOERS2  S Y=+^TMP("PSJON",$J,PSGOERS2),F=$G(^PS(53.1,Y,0)),D=$G(^(.2)) D HMSG^PSGOERS I F G EN
"RTN","PSGOESF",27,0)
 I $P(PSJSYSP0,"^",3) D  I '$D(PSGFOK) S X="" G DONE
"RTN","PSGOESF",28,0)
 .S PSGORD=^TMP("PSJON",$J,+PSGODDD(1)),PSGOFD=$P($G(^PS(53.1,+PSGORD,2)),U,4),DA=+PSGORD,DA(1)=PSGP,PSGSFD=$P($G(^PS(53.1,+PSGORD,0)),U,16)
"RTN","PSGOESF",29,0)
 .S PSGORD=$P(^PS(53.1,+PSGORD,0),U,25)
"RTN","PSGOESF",30,0)
 .S PSGWLL=$S($P(PSJSYSW0,"^",4):+$G(^PS(55,PSGP,5.1)),1:0),PSGOEE="R" W ! D DATE^PSGOER0(PSGP,PSGORD,PSGSFD)
"RTN","PSGOESF",31,0)
 .I '$D(PSGFOK(1)) W $C(7),!,"...order",$E("s",$L(PSGODDD(1),",")>2)," NOT finished..." K PSGFOK Q
"RTN","PSGOESF",32,0)
 .I 'PSGNEDFD,$P(PSJSYSW0,"^",4) D ENWALL^PSGNE3(PSGSD,PSGFD,PSGP)
"RTN","PSGOESF",33,0)
 W ! F PSGOERS=1:1:PSGODDD F PSGOERS1=1:1 S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1) Q:'PSGOERS2  S PSGORD=^TMP("PSJON",$J,PSGOERS2),PSGOEFF=0 D
"RTN","PSGOESF",34,0)
 .I '$$LS^PSSLOCK(PSGP,PSGORD) W !,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," ",$P($G(^PS(53.1,+PSGORD,.2)),"^",2),!,"...No action taken on this order...",! H 1 Q
"RTN","PSGOESF",35,0)
 .;K PSGORQF D ENDDC^PSGSICHK(PSGP,+$G(^PS(53.1,+PSGORD,1,1,0)))
"RTN","PSGOESF",36,0)
 .;I '$D(PSGORQF) K PSGORQF,^TMP($J,"DI") D
"RTN","PSGOESF",37,0)
 .;. F PSGDDI=1:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0)) D IVSOL^PSGSICHK
"RTN","PSGOESF",38,0)
 .D OC531
"RTN","PSGOESF",39,0)
 .I 'PSGOEFF&($D(PSGORQF)) W !!,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," ",$P($G(^PS(53.1,+PSGORD,.2)),"^",2),!,"...No action taken on this order...",! H 1 Q
"RTN","PSGOESF",40,0)
 .S X=$G(^PS(53.1,+PSGORD,.2)),PSGPDRGN=$$ENPDN^PSGMI(+X),PSGDO=$P(X,U,2),X=$G(^PS(53.1,+PSGORD,0)),PSGMRN=$$ENMRN^PSGMI($P(X,U,3)),PSGST=$P(X,U,7)
"RTN","PSGOESF",41,0)
 .S PSGSCH=$P($G(^PS(53.1,+PSGORD,2)),U),PSGSI=$G(^(6))
"RTN","PSGOESF",42,0)
 .S $P(^PS(53.1,+PSGORD,2),U,2)=PSGSD,$P(^(2),U,4)=PSGFD,X=+$P($G(^PS(53.1,+PSGORD,0)),U,25)
"RTN","PSGOESF",43,0)
 .I $P($G(^PS(55,PSGP,5,+X,2)),U,4)>PSGSD S $P(^(2),U,3)=$P(^(2),U,4) K DA,DIE,DR S DA(1)=PSGP,DA=X,DR="34////"_PSGSD,DIE="^PS(55,"_DA(1)_",5," D ^DIE
"RTN","PSGOESF",44,0)
 .W !,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," "
"RTN","PSGOESF",45,0)
 .W $P($G(^PS(53.1,+PSGORD,.2)),"^",2)
"RTN","PSGOESF",46,0)
 .D UPDATE
"RTN","PSGOESF",47,0)
 .D EN^PSGOEV(PSGORD)
"RTN","PSGOESF",48,0)
 .D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOESF",49,0)
 ;
"RTN","PSGOESF",50,0)
DONE ; Kill and exit.
"RTN","PSGOESF",51,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOESF",52,0)
 I $G(PSGPXN) D ^PSGPER1
"RTN","PSGOESF",53,0)
 K PSJSPEED,PSGODDD,PSGOERS,PSGORD,PSGOERS2,PSGPDRGN,PSGDO,PSGSCH,PSGSI,NF,Y,PSGRLAST
"RTN","PSGOESF",54,0)
 Q
"RTN","PSGOESF",55,0)
HELP    ; Display help text for select order to be finished prompt."
"RTN","PSGOESF",56,0)
 W !!,"  Select the orders to be speed finished. Only orders listed under the PENDING",!,"RENEWALS heading are selectable. The start and stop date/times specified will"
"RTN","PSGOESF",57,0)
  W !,"be used for all orders selected to be finished using this function.",!
"RTN","PSGOESF",58,0)
 Q
"RTN","PSGOESF",59,0)
UPDATE        ;
"RTN","PSGOESF",60,0)
 N LOOP K ^PS(53.45,PSJSYSP,2)
"RTN","PSGOESF",61,0)
 F LOOP=0:0 S LOOP=$O(^PS(53.1,+PSGORD,1,LOOP)) Q:'LOOP  D
"RTN","PSGOESF",62,0)
 .S ^PS(53.45,PSJSYSP,2,LOOP,0)=^PS(53.1,+PSGORD,1,LOOP,0)
"RTN","PSGOESF",63,0)
 .S PSJJDRUG=$P(^PS(53.1,+PSGORD,1,LOOP,0),"^")
"RTN","PSGOESF",64,0)
 .S ^PS(53.45,PSJSYSP,2,"B",PSJJDRUG,LOOP)=""
"RTN","PSGOESF",65,0)
 .S ^PS(53.45,PSJSYSP,2,0)="^53.4502P"_"^"_LOOP_"^"_LOOP K PSJJDRUG
"RTN","PSGOESF",66,0)
 Q
"RTN","PSGOESF",67,0)
OC531 ;* Order checks for Speed finish and regular finish
"RTN","PSGOESF",68,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG
"RTN","PSGOESF",69,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOESF",70,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,+$G(^PS(53.1,+PSGORD,1,1,0)))
"RTN","PSGOESF",71,0)
 I '$D(PSGORQF) K PSGORQF,^TMP($J,"DI") D
"RTN","PSGOESF",72,0)
 . F PSGDDI=1:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0)) K PSJPDRG D IVSOL^PSGSICHK
"RTN","PSGOESF",73,0)
 Q
"RTN","PSGOEV")
0^12^B63457017
"RTN","PSGOEV",1,0)
PSGOEV ;BIR/CML3-VERIFY (MAKE ACTIVE) ORDERS ;4/8/99  08:16
"RTN","PSGOEV",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**5,7,15,28,33,50,64,58,77,78,80,110,111,133**;16 DEC 97
"RTN","PSGOEV",3,0)
 ;
"RTN","PSGOEV",4,0)
 ; Reference to ^ORD(101 supported by DBIA #872.
"RTN","PSGOEV",5,0)
 ; Reference to ^PS(50.7 supported by DBIA #2180.
"RTN","PSGOEV",6,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGOEV",7,0)
 ; Reference to ^PSSLOCK supported by DBIA #2789.
"RTN","PSGOEV",8,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA #2410.
"RTN","PSGOEV",9,0)
 ;
"RTN","PSGOEV",10,0)
EN(PSGORD) ;
"RTN","PSGOEV",11,0)
ENSF ; This entry point is used by Speed finish only.
"RTN","PSGOEV",12,0)
 ; Send SN update to CPRS if auto-verify off and from Order Set entry
"RTN","PSGOEV",13,0)
 S:'$D(PSGOEAV) PSGOEAV=$P($G(PSJSYSP0),"^",9)&$G(PSJSYSU)
"RTN","PSGOEV",14,0)
 I $D(PSGOES),'PSGOEAV,PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSGOEV",15,0)
 D FULL^VALM1 I 'PSJSYSU W $C(7),$C(7),!!," THIS FUNCTION NOT AVAILABLE TO WARD STAFF." Q
"RTN","PSGOEV",16,0)
 S CHK=0 I PSGORD["P" S X=$P($G(^PS(53.1,+PSGORD,0)),"^",19) I X,$D(^PS(55,PSGP,5,$P(^(0),"^",19))) S CHK=+PSGORD,PSGORD=X_"U" L -^PS(53.1,CHK) L +^PS(55,PSGP,5,+PSGORD):1 E  W !!,"Another terminal is editing this order." G DONE
"RTN","PSGOEV",17,0)
 I +PSJSYSU=3 D DDCHK G:CHK DONE
"RTN","PSGOEV",18,0)
 I PSGORD["P" D CHK($G(^PS(53.1,+PSGORD,0)),$G(^(.2)),$G(^(2)))
"RTN","PSGOEV",19,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOEV",20,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=1 S X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",21,0)
 I $G(CHK) Q:$D(PSJSPEED)  D EN^VALM("PSJU LM ACCEPT") G:'$G(PSJACEPT) DONE ;G VFY
"RTN","PSGOEV",22,0)
 I PSGORD["U" G:'$D(^PS(55,PSGP,5,+PSGORD,4)) VFY I +PSJSYSU=3,$P(^(4),"^",3) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A PHARMACIST." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",23,0)
 I PSGORD["U" I +PSJSYSU=1,+^PS(55,PSGP,5,+PSGORD,4) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A NURSE." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",24,0)
 ;
"RTN","PSGOEV",25,0)
VFY ; change status, move to 55, and change label record
"RTN","PSGOEV",26,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D VFY^PSJCOM Q
"RTN","PSGOEV",27,0)
 NEW PSJDOSE,PSJDSFLG
"RTN","PSGOEV",28,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEV",29,0)
 I +$G(PSJDSFLG) D SETVAR^PSJDOSE W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1") I '$$CONT() W !,"...order was not verified..." D PAUSE^VALM1 D  Q:'$G(PSJACEPT)
"RTN","PSGOEV",30,0)
 . S PSGOEEF(109)=1
"RTN","PSGOEV",31,0)
 . S PSJACEPT=0
"RTN","PSGOEV",32,0)
 . ;D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEV",33,0)
 D DDCHK G:CHK DONE
"RTN","PSGOEV",34,0)
 I $G(PSGSCH)]"",((",P,R,")'[(","_PSGST_",")) D  I CHK G DONE
"RTN","PSGOEV",35,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOEV",36,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!,"This is a 'DAY OF WEEK' schedule and MUST have admin times.",! D PAUSE^VALM1
"RTN","PSGOEV",37,0)
 I $G(PSGSCH)]"" D  I CHK G DONE
"RTN","PSGOEV",38,0)
 .N X,Y,PSGS0XT,PSGS0Y,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",39,0)
 W !,"...a few moments, please..."
"RTN","PSGOEV",40,0)
 I PSGORD["P" D
"RTN","PSGOEV",41,0)
 . N PND0,PSGORDR,PSJPRIO,PSJSCHED S PND0=^PS(53.1,+PSGORD,0) I $P(PND0,U,24)="R" S PSGORDR=$P(PND0,U,25) D  Q
"RTN","PSGOEV",42,0)
 .. N OEORD,OOEORD,FILE55,FILE55N0 S FILE55="^PS(55,"_DFN_$S($P(PND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSGOEV",43,0)
 .. S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,PSGORD,+$$LASTREN^PSJLMPRI(DFN,PSGORD))
"RTN","PSGOEV",44,0)
 .. S PSGORDP=PSGORD,DIE="^PS(53.1,",DA=+PSGORD,DR="28////A;104////@" W "." D ^DIE
"RTN","PSGOEV",45,0)
 .. D START^PSGOTR(PSGORD,+PSGORDR) I OEORD D
"RTN","PSGOEV",46,0)
 ... K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSGOEV",47,0)
 ... D EN1^PSJHL2(DFN,"SC",PSGORDR),EN^PSGPEN(PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSGOEV",48,0)
 . S PSGORDP=PSGORD ;Used in ACTLOG to update activity log in 55
"RTN","PSGOEV",49,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEV",50,0)
 . S DIE="^PS(53.1,",DA=+PSGORD,DR="28////A" W "." D ^DIE,^PSGOT
"RTN","PSGOEV",51,0)
 . S PSJPRIO=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,.2)),"^",4),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,.2)),"^",4),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,.2)),"^",4))
"RTN","PSGOEV",52,0)
 . S PSJSCHED=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,2)),"^"),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,2)),"^"),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,0)),"^",15))
"RTN","PSGOEV",53,0)
 . I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCHED)="NOW")!($G(PSJSCHED)["STAT") D NOTIFY^PSJHL4(PSGORD,DFN,$G(PSJPRIO),$G(PSJSCHED))
"RTN","PSGOEV",54,0)
 S DA=+PSGORD,DA(1)=PSGP,PSGAL("C")=PSJSYSU*10+22000 D ^PSGAL5 W "." S VND4=$G(^PS(55,PSGP,5,DA,4))
"RTN","PSGOEV",55,0)
 I $G(PSGRDTX) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Start Date",+$G(PSGRDTX))
"RTN","PSGOEV",56,0)
 I $P($G(PSGRDTX),U,3) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Stop Date",+$P($G(PSGRDTX),U,3))
"RTN","PSGOEV",57,0)
 N DUR,DURON S DURON=$S($G(PSGORD):$G(PSGORD),1:"") I DURON D
"RTN","PSGOEV",58,0)
 . S DUR=$S($P($G(PSGRDTX),U,2)]"":$P($G(PSGRDTX),U,2),1:$$GETDUR^PSJLIVMD(PSGP,+DURON,$S($G(DURON)["P":"P",1:5),1),1:"")
"RTN","PSGOEV",59,0)
 I $G(DUR)]"" S $P(^PS(55,PSGP,5,+PSGORD,2.5),"^",2)=DUR
"RTN","PSGOEV",60,0)
 D:$D(PSGORDP) ACTLOG(PSGORDP,PSGP,PSGORD)
"RTN","PSGOEV",61,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSGOEV",62,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSGOEV",63,0)
 I +PSJSYSU=3,PSGORD'["O",$S(X:0,'$P(VND4,"^",9):1,1:$P(VND4,"^",15)) D EN^PSGPEN(+PSGORD)
"RTN","PSGOEV",64,0)
 S $P(VND4,"^",+PSJSYSU=1+9)=1 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSGOEV",65,0)
 ;S $P(VND4,"^",+PSJSYSU=1+9)=1,$P(VND4,U,+PSJSYSU=3+9)=0
"RTN","PSGOEV",66,0)
 I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOEV",67,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSGOEV",68,0)
 I '$P(VND4,U,9) S ^PS(55,"APV",PSGP,+PSGORD)=""
"RTN","PSGOEV",69,0)
 I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSGOEV",70,0)
 I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSGOEV",71,0)
 I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSGOEV",72,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSGOEV",73,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOEV",74,0)
 S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)="" S PSGACT="C"_$S('$D(^PS(55,PSGP,5,+PSGORD,4)):"E",$P(^(4),"^",16):"",1:"E")_"RS",PSGCANFL=2
"RTN","PSGOEV",75,0)
 S VALMBCK="Q" D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSGOEV",76,0)
 D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U")
"RTN","PSGOEV",77,0)
DONE ;
"RTN","PSGOEV",78,0)
 W:CHK !!,"...order NOT verified..."
"RTN","PSGOEV",79,0)
 I '$D(PSJSPEED),'CHK,+PSJSYSU=3,$G(PSJPRI)="D" D
"RTN","PSGOEV",80,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSGOEV",81,0)
 .Q:Y="N"
"RTN","PSGOEV",82,0)
 .D MAIN^TIUEDIT(3,.TIUDA,PSGP,"","","","",1)
"RTN","PSGOEV",83,0)
 S VALMBCK="Q" K CHK,DA,DIE,F,DP,DR,ND,PSGAL,PSGODA,PSJDOSE,PSJVAR,VND4,X Q
"RTN","PSGOEV",84,0)
 ;
"RTN","PSGOEV",85,0)
LBL ;
"RTN","PSGOEV",86,0)
 Q
"RTN","PSGOEV",87,0)
 ;
"RTN","PSGOEV",88,0)
CHK(ND,DRG,ND2) ; checks for data in required fields
"RTN","PSGOEV",89,0)
 ; Input: ND  - ^(PS(53.1,PSGORD,0)
"RTN","PSGOEV",90,0)
 ;        DRG - ^(.2)
"RTN","PSGOEV",91,0)
 ;        ND2 - ^(2)
"RTN","PSGOEV",92,0)
 S CHK="" I DRG,$D(^PS(50.7,+DRG,0))
"RTN","PSGOEV",93,0)
 E  S CHK=1
"RTN","PSGOEV",94,0)
 I ND="" S CHK=CHK_23
"RTN","PSGOEV",95,0)
 E  S CHK=CHK_$S($P(ND,"^",3):"",1:2)_$S($P(ND,"^",7)]"":"",1:3)
"RTN","PSGOEV",96,0)
 ;The naked reference on the line below refers to the variable ND which is ^PS(53.1,PSGORD,0).
"RTN","PSGOEV",97,0)
 I ND2="" S CHK=CHK_$S('$D(^(0)):4,$P(^(0),"^",7)="OC":"",1:4)_56
"RTN","PSGOEV",98,0)
 E  S CHK=CHK_$S($P(ND2,"^")]"":"",ND="":4,$P(ND,"^",7)="OC":"",1:4)_$S($P(ND2,"^",2):"",1:5)_$S($P(ND2,"^",4):"",1:6)
"RTN","PSGOEV",99,0)
 I $$CHECK^PSGOE8(PSJSYSP),$P(DRG,U,2)="" S CHK=CHK_8
"RTN","PSGOEV",100,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSGOEV",101,0)
 S:'$$DDOK^PSGOE2("^PS(53.45,"_PSJSYSP_",2,",+DRG) CHK=CHK_7,(PSGDFLG,PSGDI)=1
"RTN","PSGOEV",102,0)
 S:'$$OIOK^PSGOE2(+DRG) PSGPFLG=1
"RTN","PSGOEV",103,0)
 I 'CHK,$G(PSGSCH)]"" D
"RTN","PSGOEV",104,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",105,0)
 Q:'CHK
"RTN","PSGOEV",106,0)
 W $C(7)
"RTN","PSGOEV",107,0)
 ;
"RTN","PSGOEV",108,0)
CHKM ;
"RTN","PSGOEV",109,0)
 D FULL^VALM1
"RTN","PSGOEV",110,0)
 ; changed to remove ^DD ref
"RTN","PSGOEV",111,0)
 W !!,"THE FOLLOWING ",$S($L(CHK)>1:"ARE",1:"IS")," EITHER INVALID OR MISSING FROM THIS ORDER:" F X=1:1:7 W:CHK[X !?5,$P("ORDERABLE ITEM^MED ROUTE^SCHEDULE TYPE^SCHEDULE^START DATE/TIME^STOP DATE/TIME^DISPENSE DRUG","^",X)
"RTN","PSGOEV",112,0)
 I CHK=7 W !,"Orders with no dispense drugs or multiple dispense drugs",!,"require dosage ordered"
"RTN","PSGOEV",113,0)
 W:CHK]"" !!,$S($L(CHK)>1:"THESE FIELDS ARE",1:"THIS FIELD IS")," NECESSARY FOR VERIFICATION."
"RTN","PSGOEV",114,0)
 N DIR S DIR(0)="E" D ^DIR I $D(DUOUT)!$D(DTOUT) S CHK=1 Q
"RTN","PSGOEV",115,0)
 Q
"RTN","PSGOEV",116,0)
 ;
"RTN","PSGOEV",117,0)
CONT() ;
"RTN","PSGOEV",118,0)
 NEW DIR,DIRUT,Y
"RTN","PSGOEV",119,0)
 W ! K DIR,DIRUT
"RTN","PSGOEV",120,0)
 S DIR(0)="Y",DIR("A")="Would you like to continue verifying the order",DIR("B")="Yes"
"RTN","PSGOEV",121,0)
 D ^DIR
"RTN","PSGOEV",122,0)
 Q Y
"RTN","PSGOEV",123,0)
 ;
"RTN","PSGOEV",124,0)
DDCHK ; dispense drug check
"RTN","PSGOEV",125,0)
 S DRGF="^PS("_$S(PSGORD["P":"53.1,"_+PSGORD,1:"55,"_PSGP_",5,"_+PSGORD)_",",CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSGOEV",126,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSGOEV",127,0)
 S CHK=$S('$$DDOK^PSGOE2(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSGOEV",128,0)
 Q:CHK=0
"RTN","PSGOEV",129,0)
 W $C(7),!!,"This order must have at least one valid, active dispense drug to be verified."
"RTN","PSGOEV",130,0)
 ;
"RTN","PSGOEV",131,0)
DDEDIT ;
"RTN","PSGOEV",132,0)
 ;*** Remove all dispense drug for this order
"RTN","PSGOEV",133,0)
 K @(DRGF_"1)")
"RTN","PSGOEV",134,0)
 ; The naked reference below refers to the indirect full reference in DRGF_"1,"_Q_")", which is either ^PS(53.1,+PSGORD,Q) or ^PS(55,DFN,5,+PSGORD,Q)
"RTN","PSGOEV",135,0)
 K ^PS(53.45,PSJSYSP,2) S (X,Q)=0 F  S Q=$O(@(DRGF_"1,"_Q_")")) Q:'Q  S Y=$G(^(Q,0)),X=Q S ^PS(53.45,PSJSYSP,2,Q,0)=Y I Y S ^PS(53.45,PSJSYSP,2,"B",+Y,Q)=""
"RTN","PSGOEV",136,0)
 I X S ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_X_"^"_X
"RTN","PSGOEV",137,0)
 D ENDRG^PSGOEF1(PSGPD,X)
"RTN","PSGOEV",138,0)
 I 'CHK S %X="^PS(53.45,"_PSJSYSP_",2,",%Y=DRGF_"1," D %XY^%RCR S $P(@(DRGF_"1,0)"),"^",2)=$S(DRGF[53.1:"53.11P",1:"55.07P")
"RTN","PSGOEV",139,0)
 K DRG,DRGF Q
"RTN","PSGOEV",140,0)
 ;
"RTN","PSGOEV",141,0)
AESCREEN() ;
"RTN","PSGOEV",142,0)
 ; Output: 0 - Required fields missing and DON'T allow accept
"RTN","PSGOEV",143,0)
 ;         1 - Required fields found.
"RTN","PSGOEV",144,0)
 Q:'$G(CHK) 1
"RTN","PSGOEV",145,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSGOEV",146,0)
 I Y="PSJU LM ACCEPT EDIT" Q 1
"RTN","PSGOEV",147,0)
 Q 0
"RTN","PSGOEV",148,0)
ACTLOG(PSGORDP,DFN,PSGORD)  ;Store 53.1 activity log in local array to be moved to 55
"RTN","PSGOEV",149,0)
 ;PSGORDP: IEN from 53.1
"RTN","PSGOEV",150,0)
 ;PSGORD : IEN from 55
"RTN","PSGOEV",151,0)
 NEW PSGX,PSGXDA,PSGAL531,Q,QQ
"RTN","PSGOEV",152,0)
 F PSGX=0:0 S PSGX=$O(^PS(53.1,+PSGORDP,"A",PSGX)) Q:'PSGX  D
"RTN","PSGOEV",153,0)
 . S PSGAL531=$G(^PS(53.1,+PSGORDP,"A",PSGX,0))
"RTN","PSGOEV",154,0)
 . S QQ=$G(^PS(55,DFN,5,+PSGORD,9,0)) S:QQ="" QQ="^55,09D" F Q=$P(QQ,U,3)+1:1 I '$D(^(Q)) S $P(QQ,U,3,4)=Q_U_Q,^(0)=QQ,PSGXDA=Q Q
"RTN","PSGOEV",155,0)
 . S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,0)=PSGAL531
"RTN","PSGOEV",156,0)
 Q
"RTN","PSGOTR")
0^4^B9642115
"RTN","PSGOTR",1,0)
PSGOTR ;BIR/TRANSFERS RENEW DATA FROM 53.1 TO 55 ;23 SEP 03 / 7:54 AM
"RTN","PSGOTR",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**110,127,133**;16 DEC 97
"RTN","PSGOTR",3,0)
 ;
"RTN","PSGOTR",4,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOTR",5,0)
 ; Reference to SPSPA^PSJXRFS is supported by DBIA 4264.
"RTN","PSGOTR",6,0)
 ;
"RTN","PSGOTR",7,0)
START(ODA,DA) ; lock record, and write
"RTN","PSGOTR",8,0)
 N OFD,PVND4 S OFD=""
"RTN","PSGOTR",9,0)
 S OFD=$P($G(^PS(55,PSGP,5,DA,2)),"^",4) K:OFD ^PS(55,"AUD",+OFD,PSGP,+DA)
"RTN","PSGOTR",10,0)
 S ND2=^PS(53.1,+ODA,2) S ^PS(55,"AUD",+$P(ND2,"^",4),PSGP,DA)=""
"RTN","PSGOTR",11,0)
 F X=6,7 I $D(^PS(53.1,+ODA,X)) S ^PS(55,PSGP,5,DA,X)=^(X)
"RTN","PSGOTR",12,0)
 I $O(^PS(53.1,+ODA,1,0)) D
"RTN","PSGOTR",13,0)
 .K ^PS(55,PSGP,5,DA,1)
"RTN","PSGOTR",14,0)
 .S (C,X)=0 F  S X=$O(^PS(53.1,+ODA,1,X)) Q:'X  S:$D(^(X,0)) C=C+1,^PS(55,PSGP,5,DA,1,C,0)=^(0),^PS(55,PSGP,5,DA,1,"B",+$P($G(^(0)),U),C)=""
"RTN","PSGOTR",15,0)
 .S ^PS(55,PSGP,5,DA,1,0)="^55.07P^"_C_"^"_C
"RTN","PSGOTR",16,0)
 F X=3,12 D  S ^PS(55,PSGP,5,DA,X,0)="^55.0"_$S(X=3:8,1:612)_U_CNT_U_CNT
"RTN","PSGOTR",17,0)
 .S CNT=0 F C=0:0 S C=$O(^PS(53.1,+ODA,X,C)) Q:'C  I $D(^(C,0)) S ^PS(55,PSGP,5,DA,X,C,0)=^(0),CNT=CNT+1
"RTN","PSGOTR",18,0)
 S $P(^PS(53.1,+ODA,0),"^",19)=DA
"RTN","PSGOTR",19,0)
 S $P(^PS(55,PSGP,5,DA,0),"^",7)=$P(^PS(53.1,+ODA,0),"^",7)
"RTN","PSGOTR",20,0)
 N PSGPND0,PSGPND2,RDUZ,OND14 S PSGPND0=^PS(53.1,+ODA,0),PSGPND2=^(2) S RNWDT=$P(PSGPND0,"^",16),PSGOEPR=$P(PSGPND0,"^",2)
"RTN","PSGOTR",21,0)
 S PSGFD=$P(PSGPND2,"^",4),PSJNOO=$P(^PS(53.1,+ODA,.2),"^",3) S OND14=$$LASTREN^PSJLMPRI(PSGP,+ODA_"P") S RDUZ=$P(OND14,"^",2) S:$P(OND14,"^",3) PSGOEPR=$P(OND14,"^",3)
"RTN","PSGOTR",22,0)
 I '$G(DUOUT) D UPDREN^PSGOER(DA_"U",RNWDT,PSGOEPR,PSGFD,PSJNOO,RDUZ)
"RTN","PSGOTR",23,0)
 S PVND4=$G(^PS(53.1,+ODA,4)) I $P(PVND4,"^"),$P(PVND4,"^",2) D
"RTN","PSGOTR",24,0)
 .N RNDT S RNDT=$$LASTREN^PSJLMPRI(DFN,+ODA_"P") Q:RNDT>$P(PVND4,"^",2)
"RTN","PSGOTR",25,0)
 .S $P(^PS(55,DFN,5,DA,4),"^")=$P(PVND4,"^"),$P(^PS(55,DFN,5,DA,4),"^",2)=$P(PVND4,"^",2)
"RTN","PSGOTR",26,0)
CR ; set x-refs
"RTN","PSGOTR",27,0)
 I $D(^PS(55,PSGP,5.1)),$P(^(5.1),"^",6) S X=$P(^(5.1),"^",6) I $P(ND2,"^",3),$P(ND2,"^",6)'>X S $P(^(5.1),"^",6)=$P(ND2,"^",3)
"RTN","PSGOTR",28,0)
 S ^PS(55,PSGP,5,"B",+ODA,DA)="",^PS(55,"AUE",PSGP,DA)=""
"RTN","PSGOTR",29,0)
 F S="C","O","P","R","OC" K ^PS(55,PSGP,5,"AU",S,+$P(PSGPND2,"^",4),DA)
"RTN","PSGOTR",30,0)
 S ^PS(55,PSGP,5,"AU",$P(PSGPND0,"^",7),+$P(PSGPND2,"^",4),DA)=""
"RTN","PSGOTR",31,0)
 S ^PS(55,PSGP,5,"AUS",+$P(ND2,"^",4),DA)="" I OFD,OFD'=$P(ND2,"^",4) K ^PS(55,PSGP,5,"AUS",+OFD,DA)
"RTN","PSGOTR",32,0)
 I $$PATCH^XPDUTL("PXRM*1.5*12") S X(1)=+$P(ND2,"^",2),X(2)=+$P(ND2,"^",4),DA(1)=PSGP D SPSPA^PSJXRFS(.X,.DA,"UD")
"RTN","PSGOTR",33,0)
 K DIK S DA(1)=PSGP S DIK="^PS(55,"_DA(1)_",5,",DIK(1)=125 D EN1^DIK K DIK
"RTN","PSGOTR",34,0)
 S PSGTOL=2,PSGTOO=1 F PSGUOW=0:0 S PSGUOW=$O(^PS(53.41,2,1,PSGUOW)) Q:'PSGUOW  I $D(^(PSGUOW,1,PSGP,1,2,1,+ODA)) K ^(+ODA) D ENL^PSGVDS
"RTN","PSGOTR",35,0)
DONE I $D(PSGOE2),PSGOE2]"",$D(^TMP("PSJON",$J,PSGOE2)) S ^(PSGOE2)=DA_"U"
"RTN","PSGOTR",36,0)
 S PSGODA=ODA,PSGORD=DA_"U"
"RTN","PSGOTR",37,0)
 F Q=0:0 S Q=$O(^PS(53.44,Q)) Q:'Q  I $D(^(Q,1,PSGP,+ODA,0)) S $P(^(0),"^",2)=DA
"RTN","PSGOTR",38,0)
 L -^PS(53.1,ODA) L -^PS(55,DFN,5,+PSGORD) K CNT,ND,ODA,XX,ZND Q
"RTN","PSGPER")
0^24^B11838843
"RTN","PSGPER",1,0)
PSGPER ;BIR/CML3-PRINTS PRE-EXCHANGE NEEDS REPORT ;04 JAN 95 / 5:08 PM
"RTN","PSGPER",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**95,115,127,133**;16 DEC 97
"RTN","PSGPER",3,0)
 ;
"RTN","PSGPER",4,0)
 S PSGPERRF=0
"RTN","PSGPER",5,0)
DEV ;
"RTN","PSGPER",6,0)
 S PSGION=ION
"RTN","PSGPER",7,0)
DEV1 ;
"RTN","PSGPER",8,0)
 Q:'$$DEFON^PSGPER1
"RTN","PSGPER",9,0)
 S D=$G(PSGPXDEV) S:'D D=$P(PSJSYSW0,U,29) S:D="" D="HOME" S IOP=$S(D:"`"_D,1:D) K %ZIS S %ZIS="NQ" D ^%ZIS S D=$G(ION)
"RTN","PSGPER",10,0)
 K IOP,%ZIS,IO("Q"),ION S %ZIS="QM",%ZIS("A")="Select DEVICE for PRE-EXCHANGE UNITS REPORT: ",%ZIS("B")=D D ^%ZIS K %ZIS
"RTN","PSGPER",11,0)
 I POP D POP G:%=1 DEV1 G DONE
"RTN","PSGPER",12,0)
 I $G(ION)]"",D'=ION D CURDEF
"RTN","PSGPER",13,0)
 I $D(IO("Q")) K ZTSAVE S PSGTIR="^PSGPER0",ZTDESC="PRE-EXCHANGE UNITS REPORT",ZTDTH=$H,ZTSAVE("PSGPXN")="" D ENTSK^PSGTI G:'$D(ZTSK) DEV K ZTSK G OUT
"RTN","PSGPER",14,0)
 D ENP^PSGPER0:'$G(PSGPXPT),ENPAT^PSGPER0:$G(PSGPXPT),AG
"RTN","PSGPER",15,0)
 I %=1 S PSGPERRF=1 G DEV
"RTN","PSGPER",16,0)
 ;
"RTN","PSGPER",17,0)
DONE ;
"RTN","PSGPER",18,0)
 S DIK="^PS(53.4,",DA=PSGPXN D ^DIK
"RTN","PSGPER",19,0)
 ;
"RTN","PSGPER",20,0)
OUT ;
"RTN","PSGPER",21,0)
 K PSGPERRF,PSGPXN
"RTN","PSGPER",22,0)
 Q:$G(PSJCOM)!$G(PSJPREX)
"RTN","PSGPER",23,0)
 N PSJSYSW0,PSGVBW,PSJPWD,PSJSYSL D  Q
"RTN","PSGPER",24,0)
 . D:'$G(PSGPXPT) ENIVKV^PSGSETU
"RTN","PSGPER",25,0)
 ;
"RTN","PSGPER",26,0)
POP ;
"RTN","PSGPER",27,0)
 S %=2 W:'PSGPERRF !!,"IF A DEVICE IS NOT CHOSEN, NO REPORT WILL BE RUN AND THE DATA WILL NO LONGER BE RETRIEVABLE THROUGH THIS REPORT."
"RTN","PSGPER",28,0)
 I 'PSGPERRF F  W !,"Do you want another chance to choose a device" S %=1 D YN^DICN Q:%  W !?3,"Enter 'YES' to choose a device to print.  Enter 'NO' to quit now."
"RTN","PSGPER",29,0)
 I %'=1 S IOP=PSGION D ^%ZIS S %=2
"RTN","PSGPER",30,0)
 Q
"RTN","PSGPER",31,0)
 ;
"RTN","PSGPER",32,0)
AG ;
"RTN","PSGPER",33,0)
 F  W !!,"DO YOU NEED TO PRINT THIS REPORT AGAIN" S %=2 D YN^DICN Q:%  D AGMSG
"RTN","PSGPER",34,0)
 Q
"RTN","PSGPER",35,0)
 ;
"RTN","PSGPER",36,0)
AGMSG ;
"RTN","PSGPER",37,0)
 I %Y'?1."?" W $C(7),"  ANSWER 'YES' OR 'NO' (Entry required)" Q
"RTN","PSGPER",38,0)
 W !,"  Enter 'YES' to print this report again.  Enter 'NO' (or an '^') to quit",!,"now.  PLEASE NOTE that you will NOT be able to retrieve this data at a later",!,"date.  You should print this information now." Q
"RTN","PSGPER",39,0)
CURDEF ;
"RTN","PSGPER",40,0)
 Q:$G(PSGPXDEV)=0
"RTN","PSGPER",41,0)
 K DIC,DR,DA,X,Y,DIE S DIC="^%ZIS(1,",DIC(0)="SOX",X=ION D ^DIC Q:'($G(Y)>0)
"RTN","PSGPER",42,0)
 N D S D=+$G(Y)
"RTN","PSGPER",43,0)
 F  W !!,"Keep ",ION," as the PRE-EXCHANGE REPORT DEVICE for this session" S %=0 D YN^DICN S PSGPXDEV=$S(%=1:D,1:0) Q:%  D DEFMSG
"RTN","PSGPER",44,0)
 I $G(Y) S $P(PSJSYSW0,"^",29)=+Y
"RTN","PSGPER",45,0)
 K DIC,DR,DA,X,Y,DIE
"RTN","PSGPER",46,0)
 Q
"RTN","PSGPER",47,0)
 ;
"RTN","PSGPER",48,0)
DEFMSG ;
"RTN","PSGPER",49,0)
 I %Y'?1."?" W !,$C(7),"     ANSWER 'YES' OR 'NO' (Entry required)" Q
"RTN","PSGPER",50,0)
 W !!,"  Enter 'YES' to make ",ION," the PRE-EXCHANGE REPORT default DEVICE"
"RTN","PSGPER",51,0)
 W !,"  for the current session. PLEASE NOTE that this will override the ward"
"RTN","PSGPER",52,0)
 W !,"  default PRE-EXCHANGE REPORT DEVICE for this session only."
"RTN","PSGPER",53,0)
 Q
"RTN","PSGS0")
0^1^B43785743
"RTN","PSGS0",1,0)
PSGS0 ;BIR/CML3-SCHEDULE PROCESSOR ;29 Jan 99 / 8:04 AM
"RTN","PSGS0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**12,25,26,50,63,74,83,116,110,111,133**;16 DEC 97
"RTN","PSGS0",3,0)
 ;
"RTN","PSGS0",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177
"RTN","PSGS0",5,0)
 ; Reference to ^PS(55   is supported by DBIA 2191
"RTN","PSGS0",6,0)
 ;
"RTN","PSGS0",7,0)
ENA ; entry point for train option
"RTN","PSGS0",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGS0",9,0)
 F  S (PSGS0Y,PSGS0XT)="" R !!,"Select STANDARD SCHEDULE: ",X:DTIME W:'$T $C(7) S:'$T X="^" Q:"^"[X  D:X?1."?" ENQ^PSGSH I X'?1."?" D EN W:$D(X)[0 $C(7),"  ??" I $D(X)#2,'PSGS0Y,PSGS0XT W "  Every ",PSGS0XT," minutes"
"RTN","PSGS0",10,0)
 K DIC,DIE,PSGS0XT,PSGS0Y,Q,X,Y,PSGDT Q
"RTN","PSGS0",11,0)
 ;
"RTN","PSGS0",12,0)
EN3 ;
"RTN","PSGS0",13,0)
 S PSGST=$P($G(^PS(53.1,DA,0)),"^",7) G EN
"RTN","PSGS0",14,0)
 ;
"RTN","PSGS0",15,0)
EN5 ;
"RTN","PSGS0",16,0)
 S PSGST=$P($G(^PS(55,DA(1),5,DA,0)),"^",7)
"RTN","PSGS0",17,0)
 ;
"RTN","PSGS0",18,0)
EN ; validate
"RTN","PSGS0",19,0)
 K PSGS0Y
"RTN","PSGS0",20,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X)>70)!($L(X)<1) K X Q
"RTN","PSGS0",21,0)
 S X=$$TRIM^XLFSTR(X,"R"," ")
"RTN","PSGS0",22,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) I '$D(PSGOES) D EN^DDIOL("  ("_X_")")
"RTN","PSGS0",23,0)
 ;
"RTN","PSGS0",24,0)
ENOS ; order set entry
"RTN","PSGS0",25,0)
 N X0,Y0,PSJXI,PSJDIC2
"RTN","PSGS0",26,0)
 I $G(X)="",$G(P(2)),$G(P(3)) S X=$G(P(9))
"RTN","PSGS0",27,0)
 I $G(X)="" Q
"RTN","PSGS0",28,0)
 S PSGXT=$G(PSGS0XT),(PSGS0XT,PSGS0Y,XT,Y,PSJNSS)=""
"RTN","PSGS0",29,0)
 S X0=X I X?2.4N1"-".E!(X?2.4N) D ENCHK S:$D(X) Y=X G Q
"RTN","PSGS0",30,0)
 I X["PRN",$$PRNOK(X),'$D(^PS(51.1,"AC","PSJ",X)) D  G Q
"RTN","PSGS0",31,0)
 .I X["@"!$$DOW^PSIVUTL($P(X," PRN")) N DOW D  I $G(DOW) S (Y0,Y,PSGS0Y)=$P($P(X,"@",2)," ")
"RTN","PSGS0",32,0)
 ..N TMP S TMP=X N X S X=$P(TMP," PRN") D DW I $G(X)]"" S DOW=1
"RTN","PSGS0",33,0)
 ..I $G(DOW),$G(PSGST)]"" I ",P,R,"'[(","_PSGST_",") S (XT,PSGS0XT)="D"
"RTN","PSGS0",34,0)
 D DIC I $G(XT)]""!$G(Y0)!($G(X)]""&$G(PSJXI)) D  I $G(X)]"" G:$D(^PS(51.1,"AC","PSJ",X)) Q3 I $P(X,"@")]"" G:$D(^PS(51.1,"AC","PSJ",$P(X,"@"))) Q3
"RTN","PSGS0",35,0)
 .S PSGS0XT=XT S:$G(Y0) (Y,PSGS0Y)=Y0 S:'PSGS0Y&((PSGS0XT)="D")&(X["@") PSGS0Y=$P(X,"@",2)
"RTN","PSGS0",36,0)
 .S PSGS0Y=$P(PSGS0Y," ")
"RTN","PSGS0",37,0)
 N TMPSCHX S TMPSCHX=X I $L(X,"@")<3 S TMPX=X D DW I $G(X)]"" K PSJNSS S (PSGS0XT,XT)="D" D  G Q
"RTN","PSGS0",38,0)
 .S Y=$S(($G(TMPSCHX)["@"):$P(TMPSCHX,"@",2),1:"")
"RTN","PSGS0",39,0)
 .I Y,(X'["@"),(TMPSCHX["@") S X=TMPSCHX
"RTN","PSGS0",40,0)
 S X=TMPSCHX
"RTN","PSGS0",41,0)
 I X'="" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS G Q
"RTN","PSGS0",42,0)
 ;
"RTN","PSGS0",43,0)
NS I ($G(X)="^")!($G(X)="") K X S Y="" Q
"RTN","PSGS0",44,0)
 N NS S NS=0,PSJNSS=0
"RTN","PSGS0",45,0)
 I $G(Y)'>0 S X=X0,Y="",NS=1,PSJNSS=1
"RTN","PSGS0",46,0)
Q ;
"RTN","PSGS0",47,0)
 S PSGS0XT=$S(XT]"":XT,1:$G(PSGS0XT)),PSGS0Y=$S($G(Y):Y,$G(PSGS0Y):PSGS0Y,1:"") S:PSGS0XT<0 PSGS0XT=""
"RTN","PSGS0",48,0)
 I ('$G(PSGS0Y)&'$G(PSJDIC2)&$G(PSGAT))&'$G(PSJNEWOE)&$G(PSGS0XT) I PSGS0XT<1441 I ($L($G(PSGAT),"-")=PSGS0XT/1440)!($G(X)]""&($G(PSGSCH)=$G(X))) S PSGS0Y=$G(PSGAT)
"RTN","PSGS0",49,0)
Q2 K YY
"RTN","PSGS0",50,0)
 I '$G(PSJNSS),'$G(PSGS0Y),$G(YY) S PSGS0Y=YY
"RTN","PSGS0",51,0)
 I $G(X)]"",$$SCHREQ^PSJLIVFD(.P) D
"RTN","PSGS0",52,0)
 .I $$DOW^PSIVUTL(X)!$$PRNOK(X)!$D(^PS(51.1,"AC","PSJ",X)) S PSJNSS=0 Q
"RTN","PSGS0",53,0)
 .I $G(P(2))&$G(P(3)) D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",54,0)
 I ($G(PSJNSS)&($G(VALMBCK)'="Q"))!($G(PSJNSS)&$G(PSJLIFNI))!($G(PSJNSS)&$G(PSJTUD)) D
"RTN","PSGS0",55,0)
 .I $G(P(2))&$G(P(3)) Q
"RTN","PSGS0",56,0)
 .I ($G(X)]"") I ($G(PSGS0XT)'="D") D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",57,0)
Q3 I $G(X)]"" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS
"RTN","PSGS0",58,0)
 K QX,SDW,SWD,X0,XT,Z Q
"RTN","PSGS0",59,0)
 ;
"RTN","PSGS0",60,0)
NSSCONT(SCH,FREQ) ;
"RTN","PSGS0",61,0)
 Q:SCH=""!($G(VALMBCK)]"")!$G(PSGMARSD)!$G(PSIVFN1)
"RTN","PSGS0",62,0)
 I $G(PSGOES),'$G(NSFF) Q
"RTN","PSGS0",63,0)
 N PSGS0XT,PSGSCH,DIR,X,Y S PSGSCH=SCH,PSGS0XT=FREQ,PSJNSS=1
"RTN","PSGS0",64,0)
 D NSSMSG I ($L(PSJNSS)>2),'$G(PSJXI) W !!,PSJNSS,! S PSJNSS=1
"RTN","PSGS0",65,0)
 S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSGS0",66,0)
 K NSFF Q
"RTN","PSGS0",67,0)
 ;
"RTN","PSGS0",68,0)
NSSMSG ;
"RTN","PSGS0",69,0)
 Q:$G(PSJXI)
"RTN","PSGS0",70,0)
 I '(",O,"[(","_$G(PSGST)_",")),$G(PSJNSS),$G(PSGSCH)]"" D
"RTN","PSGS0",71,0)
 .S PSJNSS=" WARNING - "_PSGSCH_" is an invalid schedule."
"RTN","PSGS0",72,0)
 S PSGSCH="",PSGS0XT=""
"RTN","PSGS0",73,0)
 Q
"RTN","PSGS0",74,0)
 ;
"RTN","PSGS0",75,0)
NSO(FQ) ;
"RTN","PSGS0",76,0)
 Q:'FQ!(FQ<0)!(",D,O,"[(","_$G(PSGST)_",")) ""
"RTN","PSGS0",77,0)
 K FRQOUT S FRQOUT=$S(FQ<60:(FQ_"minute"),(FQ<1440)&(FQ#60):(FQ_" minute"),(FQ<1440)!(FQ#1440):(FQ/60_" hour"),1:(FQ/1440_" day")) D
"RTN","PSGS0",78,0)
 . S:(+FRQOUT'=1) FRQOUT=FRQOUT_"s"
"RTN","PSGS0",79,0)
 Q FRQOUT
"RTN","PSGS0",80,0)
 ;
"RTN","PSGS0",81,0)
ENCHK ;
"RTN","PSGS0",82,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSGS0",83,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSGS0",84,0)
 S X(1)=$L(X(1)) I X'["-"&((X>$E(2400,1,X(1))!($E(X,3,4)>59))) K X Q
"RTN","PSGS0",85,0)
 F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$E(2400,1,X(1)):1,$E(X(3),3,4)>59:1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSGS0",86,0)
 K:$D(X) X(1),X(2),X(3) Q
"RTN","PSGS0",87,0)
 ;
"RTN","PSGS0",88,0)
DIC ;
"RTN","PSGS0",89,0)
 K Y0,PSJXI N Y
"RTN","PSGS0",90,0)
 S Z=0 F PSJXI=0:1 S Z=$O(^PS(51.1,"AC","PSJ",X,Z)) Q:'Z
"RTN","PSGS0",91,0)
 I $G(X)]"",'$G(PSJSLUP) D
"RTN","PSGS0",92,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) D  Q:$G(PSGS0Y)&($G(PSGS0XT)]"")
"RTN","PSGS0",93,0)
 ..I $$DOW^PSIVUTL(X) S PSGS0XT="D",PSJNSS=0 S:X["@" (Y0,PSGS0Y)=$P(X,"@",2) Q
"RTN","PSGS0",94,0)
 ..I $G(NSFF) S Y0=$S($G(PSGS0Y):PSGS0Y,$G(PSGAT)&'$G(PSJNEWOE):PSGAT,1:"") S:Y0 PSGS0Y=Y0
"RTN","PSGS0",95,0)
 .; Check for duplicate schedules - force selection
"RTN","PSGS0",96,0)
 .Q:PSJXI>1&('$G(PSGOES))&($G(PSGS0XT)]"")
"RTN","PSGS0",97,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) N FREQ,ADMATCH S FREQ=PSGS0XT D
"RTN","PSGS0",98,0)
 ..N PSGS0XT,PSGS0Y,PSGST,PSGS0XT D ADMIN^PSJORPOE S:$G(PSGS0XT) XT=PSGS0XT S:$G(PSGS0Y) (Y0,Y)=PSGS0Y
"RTN","PSGS0",99,0)
 .S:$G(XT)]"" PSGS0XT=XT S:$G(Y) PSGS0Y=Y
"RTN","PSGS0",100,0)
 .I $$DOW^PSIVUTL(X) S:PSGS0XT="" (XT,PSGS0XT)="D" S:PSGS0Y="" (Y0,PSGS0Y)=$S($P(X,"@",2):$P(X,"@",2),1:"")
"RTN","PSGS0",101,0)
 I $G(PSJLIFNI)!($G(P(4))]""&($G(P(2))]"")) I '$D(^PS(51.1,"AC","PSJ",X))!($G(PSJXI)>1) S PSJSLUP=1
"RTN","PSGS0",102,0)
 I $G(NSFF),$G(PSJXI)>1 D
"RTN","PSGS0",103,0)
 .I $G(PSGS0XT)="",$G(NSFF),$G(PSGXT)]"" S PSGS0XT=PSGXT Q
"RTN","PSGS0",104,0)
 .I $G(PSGS0XT)=""!($G(PSGS0Y)="") S PSJSLUP=1
"RTN","PSGS0",105,0)
 I '$G(PSJSLUP) Q:$G(PSGS0XT)]""&($G(PSGS0Y)]"")  Q:($G(PSGS0XT)="D"&('$D(^PS(51.1,"AC","PSJ",X))))
"RTN","PSGS0",106,0)
 Q:$G(PSGOES)=2!$G(PSGCOPY)
"RTN","PSGS0",107,0)
 K PSJSLUP
"RTN","PSGS0",108,0)
 ;
"RTN","PSGS0",109,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(PSGOES))_"ISZ",DIC("W")="W ""  "","_$S('$D(PSJPWD):"$P(^(0),""^"",2)",'PSJPWD:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+PSJPWD,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ"
"RTN","PSGS0",110,0)
 I $D(PSGST) ;S DIC("S")="I $P(^(0),""^"",5)"_$E("'",PSGST'="O")_"=""O"""
"RTN","PSGS0",111,0)
 S PSJDIC2=1
"RTN","PSGS0",112,0)
 D IX^DIC K DIC S:$D(DIE)#2 DIC=DIE I Y'>0 D  Q
"RTN","PSGS0",113,0)
 .I '$$DOW^PSIVUTL(X),'$$PRNOK(X) S X="",PSJNSS=1,XT="",PSJXI=""
"RTN","PSGS0",114,0)
 S XT=$S("C"[$P(Y(0),"^",5):$P(Y(0),"^",3),1:$P(Y(0),"^",5))
"RTN","PSGS0",115,0)
 S X=+Y,Y="" I $D(PSJPWD),$D(^PS(51.1,+X,1,+PSJPWD,0)) S Y=$P(^(0),"^",2)
"RTN","PSGS0",116,0)
 S (X,X0)=Y(0,0) S:$G(Y)="" Y=$P(Y(0),"^",2)
"RTN","PSGS0",117,0)
 S (PSGS0Y,Y0)=$G(Y),Y0(0)=Y(0) I $P(Y(0),"^",3) S XT=$P(Y(0),"^",3)
"RTN","PSGS0",118,0)
 I $G(PSGS0XT)="",$$DOW^PSIVUTL(X) S (XT,PSGS0XT)="D"
"RTN","PSGS0",119,0)
 Q
"RTN","PSGS0",120,0)
 ;
"RTN","PSGS0",121,0)
DW ;
"RTN","PSGS0",122,0)
 N Y
"RTN","PSGS0",123,0)
 Q:($L(X,"@")>2)
"RTN","PSGS0",124,0)
 N AT I X["@" S AT=$P(X,"@",2)
"RTN","PSGS0",125,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) N XABB S XABB=""
"RTN","PSGS0",126,0)
 I X]"" D ENCHK Q:'$D(X)
"RTN","PSGS0",127,0)
 S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-"  ;F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSGS0",128,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSGS0",129,0)
 I $D(X) F II=1:1:$L(X,X(1)) S XABB=$G(XABB)_$E($P(X,X(1),II),1,2)_"-"
"RTN","PSGS0",130,0)
 K X(1) S:$D(X) X=SDW I $G(X)]"" I $TR(XABB,"-")]"" S X=$E($G(XABB),1,$L(XABB)-1)
"RTN","PSGS0",131,0)
 I $G(AT) S PSGS0Y=AT
"RTN","PSGS0",132,0)
 Q
"RTN","PSGS0",133,0)
DWC I $L(Z)<2 K X Q
"RTN","PSGS0",134,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSGS0",135,0)
 E  K X
"RTN","PSGS0",136,0)
 Q
"RTN","PSGS0",137,0)
 ;
"RTN","PSGS0",138,0)
PRNOK(PSCH) ;
"RTN","PSGS0",139,0)
 Q:PSCH'["PRN" 0
"RTN","PSGS0",140,0)
 I $TR(PSCH," ")="PRN" Q 1
"RTN","PSGS0",141,0)
 N BASE,I,OK S OK=0 S I=$P(PSCH," PRN") I I]"",$D(^PS(51.1,"AC","PSJ",I)) S OK=1
"RTN","PSGS0",142,0)
 I 'OK D
"RTN","PSGS0",143,0)
 .I PSCH["@" I $D(^PS(51.1,"AC","PSJ",$P(PSCH,"@")))!$$DOW^PSIVUTL($P(PSCH,"@")) S OK=1 Q
"RTN","PSGS0",144,0)
 .I $$DOW^PSIVUTL($P(PSCH," PRN")) S OK=1
"RTN","PSGS0",145,0)
 Q OK
"RTN","PSGS0",146,0)
ODD(PSF) ;determine if this is an odd schedule
"RTN","PSGS0",147,0)
 I PSF>1439,PSF#1440 Q 1
"RTN","PSGS0",148,0)
 I PSF,PSF<1440,1440#PSF Q 1
"RTN","PSGS0",149,0)
 Q 0
"RTN","PSGSETU")
0^18^B13119552
"RTN","PSGSETU",1,0)
PSGSETU ;BIR/CML3-PACKAGE UTILITIES ;10 Mar 99 / 10:53 AM
"RTN","PSGSETU",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,11,26,39,58,115,133**;16 DEC 97
"RTN","PSGSETU",3,0)
 ;
"RTN","PSGSETU",4,0)
 ; Reference to TERM^VALM0 is supported by DBIA #2615.
"RTN","PSGSETU",5,0)
 ; Reference to $$BROKER^XWBLIB is supported by DBIA #2198.
"RTN","PSGSETU",6,0)
 ;
"RTN","PSGSETU",7,0)
ENIVKV ; kill IV variables
"RTN","PSGSETU",8,0)
 K CHK,PSIVPL,PSIVPR,PSIVSITE,PSIVSN,PSIVBR,PSIVENO
"RTN","PSGSETU",9,0)
 ;
"RTN","PSGSETU",10,0)
ENKV ; when exiting package
"RTN","PSGSETU",11,0)
 K PSGP,PSJPAD,PSJPAGE,PSJPBID,PSJPCAF,PSJPDD,PSJPDOB,PSJPDX,PSJPFWD,PSJPHT,PSJPHTD,PSJPPID,PSJPPR,PSJPRB,PSJPSEX,PSJPSSN,PSJPTD,PSJPTS,PSJPTSP,PSJPWD,PSJPWDN,PSJPWT,PSJPWTD
"RTN","PSGSETU",12,0)
 I '$D(PSJNKF) K DFN,VA,VADM,VAERR,VAIN,VAIP
"RTN","PSGSETU",13,0)
 K PSJNKF,%,%DT,%H,%I,%T,%X,%Y,%ZIS,D,D0,D1,D2,DA,DI,DIC,DICR,DIE,DIG,DIH,DIK,DIR,DIRUT,DIQ,DISYS,DIU,DIV,DIW,DLAYGO,DP,DR,DQ,DTOUT,DUOUT,DZ,IO("Q"),IOP,POP,X,X1,X2,Y,XX,ZTSK
"RTN","PSGSETU",14,0)
 K PSGDT,PSGID,PSGION,PSGOD,Q,QQ,PSJSYSL,PSJSYSW0,PSJSYSW,PSJSYSP,PSJSYSP0,PSJSYSU,PSJOCNT,PSJRNF,PSJIRNF,PSJITECH,PSGPXDEV,PSGDDI,PSJORPVN,PSJPN
"RTN","PSGSETU",15,0)
 Q
"RTN","PSGSETU",16,0)
 ;
"RTN","PSGSETU",17,0)
ENCV ; check for (and set) package variables
"RTN","PSGSETU",18,0)
 K %DT,%ZIS,DIC,IOP D ^%ZISC,HOME^%ZIS
"RTN","PSGSETU",19,0)
 I '$D(ZTQUEUED),'$D(VALMWD) D
"RTN","PSGSETU",20,0)
 .S X="XWBLIB" X ^%ZOSF("TEST") I $T,($$BROKER^XWBLIB) Q
"RTN","PSGSETU",21,0)
 .D TERM^VALM0
"RTN","PSGSETU",22,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSGSETU",23,0)
 I $D(^TMP("PSJUSER",$J,"PSG",0)),$D(^(1)),$D(PSJSYSU) D  K %,%H,%I,X Q
"RTN","PSGSETU",24,0)
 .; naked ref below is from line above
"RTN","PSGSETU",25,0)
 .S %=^(0),PSJSYSU=$P(%,"^"),PSJSYSP=$P(%,"^",2),PSJSYSP0=^(1),PSJSYSL=$P(PSJSYSP0,"^",7)]""_"^"_$P(PSJSYSP0,"^",7),%=$G(^VA(200,DUZ,"PS")),$P(PSJSYSU,";",2)=$S('%:"",'$P(%,"^",4):1,1:$P(%,"^",4)\1>DT)
"RTN","PSGSETU",26,0)
 .I 'PSJSYSL,$G(PSJSYSW0) D SYSL
"RTN","PSGSETU",27,0)
 S PSJSYSU="",%=$G(^VA(200,DUZ,"PS")) I %,$S('$P(%,"^",4):1,1:$P(%,"^",4)>DT) S $P(PSJSYSU,";",2)=1
"RTN","PSGSETU",28,0)
 I $D(^XUSEC("PSJ RNURSE",DUZ)) D
"RTN","PSGSETU",29,0)
 .S:$D(^XUSEC("PSJ RNFINISH",DUZ)) PSJRNF=1
"RTN","PSGSETU",30,0)
 .S:$D(^XUSEC("PSJI RNFINISH",DUZ)) PSJIRNF=1
"RTN","PSGSETU",31,0)
 S:$D(^XUSEC("PSJI PHARM TECH",DUZ)) PSJITECH=1
"RTN","PSGSETU",32,0)
 S DIC="^PS(53.45,",DIC(0)="LNZ",DLAYGO=53.45,(DINUM,X)="`"_+DUZ D ^DIC
"RTN","PSGSETU",33,0)
 S PSJSYSP=+Y,PSJSYSP0=Y(0) F X=3,1,2 I $D(^XUSEC("PSJ "_$P("RNURSE^PHARM TECH^RPHARM","^",X),DUZ)) S $P(PSJSYSU,";",3)=X Q
"RTN","PSGSETU",34,0)
 I $P(PSJSYSU,";",3),"13"[$P(PSJSYSU,";",3) S $P(PSJSYSU,";")=$P(PSJSYSU,";",3)
"RTN","PSGSETU",35,0)
 S $P(PSJSYSU,";",4)=+PSJSYSU=3!$P(PSJSYSP0,"^",2)!$D(^XUSEC("PSJ RNFINISH",DUZ)),PSJSYSL=$P(PSJSYSP0,"^",7)]""_"^"_$P(PSJSYSP0,"^",7)
"RTN","PSGSETU",36,0)
 I 'PSJSYSL,$G(PSJSYSW0) D SYSL
"RTN","PSGSETU",37,0)
 I PSJSYSU S $P(PSJSYSP0,"^",3)=1,$P(PSJSYSP0,"^",4)=1,$P(PSJSYSP0,"^",5)=1
"RTN","PSGSETU",38,0)
 S ^TMP("PSJUSER",$J,"PSG",0)=PSJSYSU_"^"_PSJSYSP,^(1)=PSJSYSP0 K %,%H,%I,DA,DIC,DLAYGO,X,Y Q
"RTN","PSGSETU",39,0)
 ;
"RTN","PSGSETU",40,0)
ENDTC(Y) ; convert FM internal date/time to user readable format
"RTN","PSGSETU",41,0)
 I Y S Y=Y_$E(".",Y'[".")_"0000",Y=$E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)_"  "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSGSETU",42,0)
 E  S Y="********"
"RTN","PSGSETU",43,0)
 Q Y
"RTN","PSGSETU",44,0)
 ;
"RTN","PSGSETU",45,0)
SYSL ;
"RTN","PSGSETU",46,0)
 Q:$G(PSJSYSL)!'$G(PSJSYSW0)
"RTN","PSGSETU",47,0)
 S X=$P($G(PSJSYSU),";",3)>1 S PSJSYSL=$S(X=0:$P(PSJSYSW0,"^",12),1:$P(PSJSYSW0,"^",16)) I PSJSYSL D
"RTN","PSGSETU",48,0)
 .S:X X='$P(PSJSYSP0,"^",10) S IOP=$S($P(PSJSYSP0,"^",13)]"":$P(PSJSYSP0,"^",13),$P(PSJSYSW0,"^",19+X)]"":$P(PSJSYSW0,"^",19+X),1:"") I IOP]"" D
"RTN","PSGSETU",49,0)
 ..S IOP="`"_IOP K %ZIS S %ZIS="NQ" D ^%ZIS S:'POP $P(PSJSYSL,"^",2,3)=ION_"^"_IO D HOME^%ZIS
"RTN","PSGSETU",50,0)
 Q
"RTN","PSGVBW")
0^10^B57698798
"RTN","PSGVBW",1,0)
PSGVBW ;BIR/CML3,MV-VERIFY ORDERS BY WARD, WARD GROUP, OR PATIENT ;22 Oct 98 / 3:14 PM
"RTN","PSGVBW",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**5,16,39,59,62,67,58,81,80,110,111,133**;16 DEC 97
"RTN","PSGVBW",3,0)
 ;
"RTN","PSGVBW",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191
"RTN","PSGVBW",5,0)
 ;
"RTN","PSGVBW",6,0)
 N PSJNEW,PSGPTMP,PPAGE,CL,CG S PSJNEW=1
"RTN","PSGVBW",7,0)
START ;
"RTN","PSGVBW",8,0)
 D ENCV^PSGSETU I $D(XQUIT) K XQUIT Q
"RTN","PSGVBW",9,0)
 ;I ($P(PSJSYSU,";")=3)!($P(PSJSYSU,";",3)=2) 
"RTN","PSGVBW",10,0)
 D ^PSIVXU I $D(XQUIT) K XQUIT Q
"RTN","PSGVBW",11,0)
 D NOW^%DTC S PSGDT=%
"RTN","PSGVBW",12,0)
 I '$D(^XTMP("PSJPVNV")) D
"RTN","PSGVBW",13,0)
 .K DIR S DIR(0)="Y",DIR("A")="Display an Order Summary",DIR("B")="NO"
"RTN","PSGVBW",14,0)
 .S DIR("?",1)="Enter 'YES' to see a summary of orders by type and ward group",DIR("?")="or 'NO' to go directly to patient selection."
"RTN","PSGVBW",15,0)
 .D ^DIR K DIR Q:$D(DIRUT)!$D(DUOUT)  I Y D CNTORDRS^PSGVBWU
"RTN","PSGVBW",16,0)
 K ^TMP("PSJ",$J) S PSGPXN=0 D GTOOP G:$D(DIRUT) DONE L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE
"RTN","PSGVBW",17,0)
 S PSGSSH="VBW",PSGPXN=0,PSJPROT=$S($P(PSJSYSU,";",3)=3:3,$G(PSJRNF):3,$G(PSJIRNF):3,1:1)
"RTN","PSGVBW",18,0)
 S PSGVBWW=$S(PSJTOO=1:"NON-VERIFIED",PSJTOO=2:"PENDING",1:"NON-VERIFIED AND/OR PENDING")
"RTN","PSGVBW",19,0)
 F  K ^TMP("PSJSELECT",$J) D ^PSGSEL Q:"^"[PSGSS  F  S (PSGP,WD,WG)=0 S PSGPTMP=0,PPAGE=1 D @PSGSS Q:+Y'>0  D GO
"RTN","PSGVBW",20,0)
 ;
"RTN","PSGVBW",21,0)
DONE ;
"RTN","PSGVBW",22,0)
 K ^TMP("PSGVBW",$J),^TMP("PSJSELECT",$J),^TMP("PSJLIST",$J),^TMP("PSJON",$J)
"RTN","PSGVBW",23,0)
 K CHK,D0,DRGI,FQC,J,ND,ON,PN,PSGODT,PSGOEA,PSGOP,PSGSS,PSGSSH,RB,SD,ST,TM,WD,WDN,WG,PRI,PSJPNV,PSJCT
"RTN","PSGVBW",24,0)
 K PSGODDD,PSGOEORF,PSJORL,PSJORPCL,PSJORTOU,PSJORVP,PSGTOL,PSJTOO,PSGUOW,PSGONV,PX,PSGOEAV,PSGPX,PSGVBWTO,PSGVBWW,PSJOPC,PSGOENOF,PSJPROT,PSJLM,PSJASK
"RTN","PSGVBW",25,0)
 L -^PS(53.45,PSJSYSP) G:$G(PSGPXN) ^PSGPER1 D ENKV^PSGSETU K ND Q
"RTN","PSGVBW",26,0)
 ;
"RTN","PSGVBW",27,0)
GO ;
"RTN","PSGVBW",28,0)
 I PSGSS'="P" W !,"...a few moments, please..." K ^TMP("PSGVBW",$J) D ARRAY K CHK,ON,PN,RB,SD,TM,WD,WDN,WG,X,Y
"RTN","PSGVBW",29,0)
 I PSGSS'="P",'$D(^TMP("PSGVBW",$J)) W !,$C(7),"NO ",PSGVBWW," ORDERS FOR ",$S(PSGSS="P":"PATIENT",PSGSS="L":"CLINIC GROUP",PSGSS="C":"CLINIC",1:"WARD"),$S(PSGSS="G":" GROUP",1:"")," SELECTED." Q
"RTN","PSGVBW",30,0)
 D ^PSGVBW0 Q
"RTN","PSGVBW",31,0)
 ;
"RTN","PSGVBW",32,0)
 ; look-ups on ward group, ward, or patient; depending on value of SS
"RTN","PSGVBW",33,0)
G ;
"RTN","PSGVBW",34,0)
 K DIR S DIR(0)="FAO",DIR("A")="Select WARD GROUP: "
"RTN","PSGVBW",35,0)
 S DIR("?")="^D GDIC^PSGVBW" W ! D ^DIR
"RTN","PSGVBW",36,0)
 I Y="^OTHER" D OUTPT^PSGVBW1 Q
"RTN","PSGVBW",37,0)
 ;S DIC="^PS(57.5,",DIC(0)="QEAMI",DIC("A")="Select WARD GROUP: "
"RTN","PSGVBW",38,0)
GDIC ;
"RTN","PSGVBW",39,0)
 K DIC S DIC="^PS(57.5,",DIC(0)="QEMI" D ^DIC K DIC S:+Y>0 WG=+Y
"RTN","PSGVBW",40,0)
 W:X["?" !!,"Enter ""^OTHER"" to include all Outpatient IV orders and orders from the",!,"wards that do not belong to a ward group",!
"RTN","PSGVBW",41,0)
 Q
"RTN","PSGVBW",42,0)
C ;
"RTN","PSGVBW",43,0)
 K DIR S DIR(0)="FAO",DIR("A")="Select CLINIC: "
"RTN","PSGVBW",44,0)
 S DIR("?")="^D CDIC^PSGVBW" W ! D ^DIR
"RTN","PSGVBW",45,0)
CDIC ;
"RTN","PSGVBW",46,0)
 K DIC S DIC="^SC(",DIC(0)="QEMIZ" D ^DIC K DIC S:+Y>0 CL=+Y
"RTN","PSGVBW",47,0)
 W:X["?" !!,"Enter the clinic you want to use to select patients for processing.",!
"RTN","PSGVBW",48,0)
 Q
"RTN","PSGVBW",49,0)
L ;
"RTN","PSGVBW",50,0)
 K DIR S DIR(0)="FAO",DIR("A")="Select CLINIC GROUP: "
"RTN","PSGVBW",51,0)
 S DIR("?")="^D LDIC^PSGVBW" W ! D ^DIR
"RTN","PSGVBW",52,0)
LDIC ;
"RTN","PSGVBW",53,0)
 K DIC S DIC="^PS(57.8,",DIC(0)="QEMI" D ^DIC K DIC S:+Y>0 CG=+Y
"RTN","PSGVBW",54,0)
 W:X["?" !!,"Enter the name of the clinic group you want to use to select patients for processing."
"RTN","PSGVBW",55,0)
 Q
"RTN","PSGVBW",56,0)
W ;
"RTN","PSGVBW",57,0)
 K DIR S DIR(0)="FAO",DIR("A")="Select WARD: "
"RTN","PSGVBW",58,0)
 S DIR("?")="^D WDIC^PSGVBW" W ! D ^DIR
"RTN","PSGVBW",59,0)
 I Y="^OTHER" D OUTPT^PSGVBW1 Q
"RTN","PSGVBW",60,0)
WDIC ;
"RTN","PSGVBW",61,0)
 ;S DIC="^DIC(42,",DIC(0)="QEAMI",DIC("A")="Select WARD: "
"RTN","PSGVBW",62,0)
 K DIC S DIC="^DIC(42,",DIC(0)="QEMIZ" D ^DIC K DIC S:+Y>0 WD=+Y
"RTN","PSGVBW",63,0)
 W:X["?" !!,"Enter ""^OTHER"" for Outpatient IV orders",!
"RTN","PSGVBW",64,0)
 Q
"RTN","PSGVBW",65,0)
P ;
"RTN","PSGVBW",66,0)
 K ^TMP("PSJSELECT",$J) S PSJCNT=1 F  D ^PSJP Q:PSGP<0  D
"RTN","PSGVBW",67,0)
 .S PSJNV=0
"RTN","PSGVBW",68,0)
 .NEW ON,XX F ON=0:0 S ON=$O(^PS(53.1,"AS","N",PSGP,ON)) Q:'ON  S ND=$P($G(^PS(53.1,ON,0)),U,4) S XX=$S(ND="U"&(PSJPAC'=2):1,ND'="U"&(PSJPAC'=1):1,1:0) I XX S PSJNV=1 Q
"RTN","PSGVBW",69,0)
 .;S PSJNV=$O(^PS(53.1,"AS","N",+PSGP,0)),PSJPEN=$O(^PS(53.1,"AS","P",+PSGP,0))
"RTN","PSGVBW",70,0)
 .S PSJPEN=$O(^PS(53.1,"AS","P",+PSGP,0))
"RTN","PSGVBW",71,0)
 .I 'PSJNV D ^PSJAC D
"RTN","PSGVBW",72,0)
 ..I '$D(PSGDT) D NOW^%DTC S PSGDT=$E(%,1,12)
"RTN","PSGVBW",73,0)
 ..S X1=$P(PSGDT,"."),X2=-2 D C^%DTC S PSGODT=X_(PSGDT#1)
"RTN","PSGVBW",74,0)
 ..I PSJPAC'=2 F ST="C","O","OC","P","R" F SD=$S(ST="O":PSJPAD,1:PSGODT):0 S SD=$O(^PS(55,PSGP,5,"AU",ST,SD)) Q:'SD!PSJNV  F ON=0:0 S ON=$O(^PS(55,PSGP,5,"AU",ST,SD,ON)) Q:'ON  I $D(^PS(55,PSGP,5,ON,0)),$P(^(0),"^",9)'["D" D IFT I  S PSJNV=1 Q
"RTN","PSGVBW",75,0)
 ..I PSJPAC'=1 F SD=+PSJPAD:0 S SD=$O(^PS(55,PSGP,"IV","AIS",SD)) Q:'SD  F ON=0:0 S ON=$O(^PS(55,PSGP,"IV","AIS",SD,ON)) Q:'ON  I $D(^PS(55,PSGP,"IV",ON,0)),$P(^(0),"^",17)'["D" D IFT2 I  S PSJNV=1 Q
"RTN","PSGVBW",76,0)
 .S X=$S(PSJTOO=1:PSJNV,PSJTOO=2:PSJPEN,1:(PSJNV+PSJPEN))
"RTN","PSGVBW",77,0)
 .I X D SETPN S ^TMP("PSJSELECT",$J,PSJCNT)=PN,^TMP("PSJSELECT",$J,"B",$P(PN,U),PSJCNT)="",PSJCNT=PSJCNT+1 Q
"RTN","PSGVBW",78,0)
 .W !,"No ",PSGVBWW," orders found for this patient."
"RTN","PSGVBW",79,0)
 S:$D(^TMP("PSJSELECT",$J)) Y=1
"RTN","PSGVBW",80,0)
 Q
"RTN","PSGVBW",81,0)
 ;
"RTN","PSGVBW",82,0)
ARRAY ; put patient(s) with non-verified orders into array
"RTN","PSGVBW",83,0)
 I '$D(PSGDT) D NOW^%DTC S PSGDT=$E(%,1,12)
"RTN","PSGVBW",84,0)
 S X1=$P(PSGDT,"."),X2=-2 D C^%DTC S PSGODT=X_(PSGDT#1),PSGVBWW=$S(PSJTOO=1:"NON-VERIFIED",PSJTOO=2:"PENDING",1:"NON-VERIFIED AND/OR PENDING") I PSGSS="P" D IF S:$T ^TMP("PSGVBW",$J)=$P(PSGP(0),"^")_"^"_PSGP Q
"RTN","PSGVBW",85,0)
 G CG:PSGSS="L",CL:PSGSS="C",WD:PSGSS="W" F WD=0:0 S WD=$O(^PS(57.5,"AC",WG,WD)) Q:'WD  D WD
"RTN","PSGVBW",86,0)
 Q
"RTN","PSGVBW",87,0)
 ;
"RTN","PSGVBW",88,0)
CG S CL="" F  S CL=$O(^PS(57.8,"AD",CG,CL)) Q:CL=""  D CL
"RTN","PSGVBW",89,0)
 Q
"RTN","PSGVBW",90,0)
CL S WDN=$S($D(^SC(CL,0)):$P(^(0),"^"),1:"")
"RTN","PSGVBW",91,0)
 S PSGP="" F  S PSGP=$O(^PS(53.1,"AD",CL,PSGP)) Q:PSGP=""  D ^PSJAC,IF
"RTN","PSGVBW",92,0)
 Q
"RTN","PSGVBW",93,0)
WD S WDN=$S($D(^DIC(42,WD,0)):$P(^(0),"^"),1:"") I WDN]"" F PSGP=0:0 S PSGP=$O(^DPT("CN",WDN,PSGP)) Q:'PSGP  I $S($O(^PS(55,PSGP,5,"AUS",PSGDT)):1,1:$D(^PS(53.1,"AC",PSGP))) D ^PSJAC,IF
"RTN","PSGVBW",94,0)
 Q
"RTN","PSGVBW",95,0)
IF ;
"RTN","PSGVBW",96,0)
 W "." I PSJTOO'=1 F ON=0:0 S ON=$O(^PS(53.1,"AS","P",PSGP,ON)) Q:'ON  S X=$P($G(^PS(53.1,ON,0)),U,4),Y=0 I "FIU"[X D  G:Y SET
"RTN","PSGVBW",97,0)
 .I PSJPAC=3 S Y=1 Q
"RTN","PSGVBW",98,0)
 .I PSJPAC=2 S Y=X'="U" Q 
"RTN","PSGVBW",99,0)
 .I PSJPAC=1 S Y=X="U"
"RTN","PSGVBW",100,0)
 Q:PSJTOO=2
"RTN","PSGVBW",101,0)
 F X="N","I" I $D(^PS(53.1,"AS",X,PSGP)) NEW XX S XX=0 D  G:XX SET
"RTN","PSGVBW",102,0)
 . NEW ON F ON=0:0 S ON=$O(^PS(53.1,"AS",X,PSGP,ON)) Q:'ON  S ND=$P($G(^PS(53.1,ON,0)),U,4) S XX=$S(ND="U"&(PSJPAC'=2):1,ND'="U"&(PSJPAC'=1):1,1:0) Q:XX
"RTN","PSGVBW",103,0)
 S X1=$P(PSGDT,"."),X2=-2 D C^%DTC S PSGODT=X_(PSGDT#1)
"RTN","PSGVBW",104,0)
 I PSJPAC'=2 F ST="C","O","OC","P","R" F SD=$S(ST="O":PSJPAD,1:PSGODT):0 S SD=$O(^PS(55,PSGP,5,"AU",ST,SD)) Q:'SD  F ON=0:0 S ON=$O(^PS(55,PSGP,5,"AU",ST,SD,ON)) Q:'ON  I $D(^PS(55,PSGP,5,ON,0)),$P(^(0),"^",9)'["D" D IFT I  G SET
"RTN","PSGVBW",105,0)
 I PSJPAC'=1 F SD=+PSJPAD:0 S SD=$O(^PS(55,PSGP,"IV","AIS",SD)) Q:'SD  F ON=0:0 S ON=$O(^PS(55,PSGP,"IV","AIS",SD,ON)) Q:'ON  I $D(^PS(55,PSGP,"IV",ON,0)),$P(^(0),"^",17)'["D" D IFT2 I  G SET
"RTN","PSGVBW",106,0)
 Q
"RTN","PSGVBW",107,0)
 ;
"RTN","PSGVBW",108,0)
IFT ;
"RTN","PSGVBW",109,0)
 S ND=$G(^PS(55,PSGP,5,ON,4)) I $S(SD>PSGDT:$S(ND="":1,'$P(ND,"^",$S(PSJSYSU:PSJSYSU,1:1)):1,$P(ND,"^",13):1,$P(ND,"^",19):1,$P(ND,"^",23):1,1:$P(ND,"^",16)),ST="O":$S(ND="":1,1:'$P(ND,"^",$S(PSJSYSU:PSJSYSU,1:1))),1:$P(ND,"^",16))
"RTN","PSGVBW",110,0)
 Q
"RTN","PSGVBW",111,0)
 ;
"RTN","PSGVBW",112,0)
IFT2 ;
"RTN","PSGVBW",113,0)
 ;S ND=$G(^PS(55,PSGP,"IV",ON,4)) I $S((SD>PSGDT)&(ND=""):1,'$P(ND,"^",$S(+PSJSYSU=1:1,1:4)):1,1:0)
"RTN","PSGVBW",114,0)
 S ND=$G(^PS(55,PSGP,"IV",ON,4)) I $S((SD>PSGDT)&('$P(ND,"^",$S(+PSJSYSU=1:1,1:4))):1,1:0)
"RTN","PSGVBW",115,0)
 Q
"RTN","PSGVBW",116,0)
SET ;
"RTN","PSGVBW",117,0)
 S TM=$S(PSJPRB="":"",1:$P($G(^PS(57.7,WD,1,+$O(^PS(57.7,"AWRT",WD,PSJPRB,0)),0)),"^")) S:TM="" TM="zz"
"RTN","PSGVBW",118,0)
 ;
"RTN","PSGVBW",119,0)
SETPN ;
"RTN","PSGVBW",120,0)
 S PN=$P(PSGP(0),"^")_U_PSGP_U_PSJPBID S:PSGSS'="P" ^TMP("PSGVBW",$J,WDN,TM,PN)=""
"RTN","PSGVBW",121,0)
 Q
"RTN","PSGVBW",122,0)
 ;
"RTN","PSGVBW",123,0)
GTOOP ; Get 'Type Of Order' and Package
"RTN","PSGVBW",124,0)
 I $P(PSJSYSU,";",3)<2,'$G(PSJRNF),'$G(PSJIRNF) S PSJPAC=0,PSJTOO=1 D GTPAC Q
"RTN","PSGVBW",125,0)
 S (PSJPAC,PSJTOO)=0 W !!,"1) Non-Verified Orders",!,"2) Pending Orders",!!
"RTN","PSGVBW",126,0)
 N DIR S DIR(0)="LAO^1:2",DIR("A")="Select Order Type(s) (1-2): ",DIR("?")="^D TOH^PSGVBW" D ^DIR
"RTN","PSGVBW",127,0)
 I 'Y D EXIT("TYPE OF ORDER") Q
"RTN","PSGVBW",128,0)
 S PSJTOO=$S($L(Y)>2:3,1:$P(Y,","))
"RTN","PSGVBW",129,0)
 D GTPAC
"RTN","PSGVBW",130,0)
 I 'PSJPAC D EXIT("PACKAGE") Q
"RTN","PSGVBW",131,0)
 Q
"RTN","PSGVBW",132,0)
GTPAC ;
"RTN","PSGVBW",133,0)
 ;S PSJTOO=$S($L(Y)>2:3,1:$P(Y,",")) Q:PSJTOO=1
"RTN","PSGVBW",134,0)
 ;I $G(PSJRNF) S PSJPAC=1 Q
"RTN","PSGVBW",135,0)
 I ($G(PSJRNF))&('$G(PSJIRNF))&(PSJTOO=2) S PSJPAC=1 Q
"RTN","PSGVBW",136,0)
 I ($G(PSJIRNF))&('$G(PSJRNF))&(PSJTOO=2) S PSJPAC=2 Q
"RTN","PSGVBW",137,0)
 W !!,"1) Unit Dose Orders",!,"2) IV Orders",!
"RTN","PSGVBW",138,0)
 K DIR S DIR(0)="LAO^1:2",DIR("A")="Select Package(s) (1-2): ",DIR("?")="^D TOH^PSGVBW" W ! D ^DIR
"RTN","PSGVBW",139,0)
 S PSJPAC=$S($L(Y)>2:3,1:$P(Y,","))
"RTN","PSGVBW",140,0)
 Q
"RTN","PSGVBW",141,0)
EXIT(X) ;
"RTN","PSGVBW",142,0)
 W !!,X," not selected, option terminated."
"RTN","PSGVBW",143,0)
 Q
"RTN","PSGVBW",144,0)
 ;
"RTN","PSGVBW",145,0)
TOH ;
"RTN","PSGVBW",146,0)
 W !!,"SELECT FROM:",!?5,"1 - NON-VERIFIED ORDERS",!?5,"2 - PENDING ORDERS"
"RTN","PSGVBW",147,0)
 W !!?2,"Enter '1' if you want to verify non-verified orders.  Enter '2' if you",!,"want to complete pending orders.  Enter '1,2' or '1-2' if you want to do both." Q
"RTN","PSIVEDT")
0^30^B39067377
"RTN","PSIVEDT",1,0)
PSIVEDT ;BIR/MLM-EDIT IV ORDER ;10 Feb 98 / 3:23 PM
"RTN","PSIVEDT",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**4,110,127,133**;16 DEC 97
"RTN","PSIVEDT",3,0)
 ;
"RTN","PSIVEDT",4,0)
 ; Reference to ^DD(53.1 is supported by DBIA 2256.
"RTN","PSIVEDT",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSIVEDT",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSIVEDT",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSIVEDT",8,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSIVEDT",9,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVEDT",10,0)
 ;
"RTN","PSIVEDT",11,0)
EDIT ;
"RTN","PSIVEDT",12,0)
 I $G(DFN)&($G(PSJORD)["V") I $$COMPLEX^PSJOE(DFN,PSJORD) D
"RTN","PSIVEDT",13,0)
 . N X,Y,PARENT,P2ND S P2ND=$S($G(^PS(55,PSGP,"IV",+PSJORD,.2)):$G(^PS(55,PSGP,"IV",+PSJORD,.2)),1:$G(^PS(55,PSGP,5,+PSJORD,.2)))
"RTN","PSIVEDT",14,0)
 . S PARENT=$P(P2ND,"^",8)
"RTN","PSIVEDT",15,0)
 . I PARENT D FULL^VALM1 W !!?5,"This order is part of a complex order. Please review the following ",!?5,"associated orders before changing this order." D CMPLX^PSJCOM1(PSGP,PARENT,PSJORD)
"RTN","PSIVEDT",16,0)
 S DONE=0
"RTN","PSIVEDT",17,0)
 F PSIVE=1:1 S:DONE&$E(PSIVAC)="C" OREND=1 Q:PSIVE>$L(EDIT,U)!(DONE)  Q:'$L($P(EDIT,U,PSIVE))  D @($P(EDIT,U,PSIVE)) S:$E(PSIVAC,2)="N" PSIVOK=PSIVOK_U_$P(EDIT,U,PSIVE) I $E(X)=U,$L(X)>1 S:PSIVE>1 PSIVE=PSIVE-1 F  D FF Q:Y<0  D @Y Q:$E(X)'=U
"RTN","PSIVEDT",18,0)
 K EDIT,PSIVOK,PSGDI
"RTN","PSIVEDT",19,0)
 Q
"RTN","PSIVEDT",20,0)
 ;
"RTN","PSIVEDT",21,0)
1 ; Provider.
"RTN","PSIVEDT",22,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+$G(ON),0)),"^",24)="R" D  Q
"RTN","PSIVEDT",23,0)
 . W !!?5,"This is Renewal order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",24,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",25,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",26,0)
 S P(6)=$S('$G(^VA(200,+P(6),"PS")):"",'$P(^("PS"),U,4):P(6),$P(^("PS"),U,4)<DT:"",1:P(6))
"RTN","PSIVEDT",27,0)
 W !,"PROVIDER: "_$S($P(P(6),U,2)]"":$P(P(6),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X=""&P(6)) Q
"RTN","PSIVEDT",28,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 1
"RTN","PSIVEDT",29,0)
 I X]"" K DIC S DIC=200,DIC(0)="EQMZ",DIC("S")="I $D(^(""PS"")),^(""PS""),$S('$P(^(""PS""),U,4):1,$P(^(""PS""),U,4)>DT:1,1:0)" D ^DIC K DIC I Y>0 S P(6)=+Y_U_Y(0,0) Q
"RTN","PSIVEDT",30,0)
 S F1=53.1,F2=1 D ENHLP^PSIVORC1 W $C(7),!!,"A Provider must be entered.",!! G 1
"RTN","PSIVEDT",31,0)
 Q
"RTN","PSIVEDT",32,0)
 ;
"RTN","PSIVEDT",33,0)
3 ; Med Route.
"RTN","PSIVEDT",34,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",35,0)
 . W !!?5,"Med Route may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",36,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",37,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Med Route may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",38,0)
 S P(6)=$S('$G(^VA(200,+P(6),"PS")):"",'$P(^("PS"),U,4):P(6),$P(^("PS"),U,4)<DT:"",1:P(6))
"RTN","PSIVEDT",39,0)
 I P("MR")="" S X=$O(^PS(51.2,"B","INTRAVENOUS",0)) I $P($G(^PS(51.2,+X,0)),U,4) S P("MR")=+X_U_$P(^(0),U,3)
"RTN","PSIVEDT",40,0)
 W !,"MED ROUTE: "_$S($P(P("MR"),U,2)]"":$P(P("MR"),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I X=U!(X=""&P("MR"))!($E(X)=U) Q
"RTN","PSIVEDT",41,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 3
"RTN","PSIVEDT",42,0)
 I X]"" K DIC S DIC=51.2,DIC(0)="EQMZ",DIC("S")="I $P(^(0),U,4)" D ^DIC K DIC I Y>0 S P("MR")=+Y_U_$P(Y(0),U,3) Q
"RTN","PSIVEDT",43,0)
 S F1=53.1,F2=3 D ENHLP^PSIVORC1 W $C(7),!!,"A Med Route must be entered." G 3
"RTN","PSIVEDT",44,0)
 Q
"RTN","PSIVEDT",45,0)
 ;
"RTN","PSIVEDT",46,0)
10 ; Start Date.
"RTN","PSIVEDT",47,0)
 D 10^PSIVEDT1
"RTN","PSIVEDT",48,0)
 Q
"RTN","PSIVEDT",49,0)
 ;
"RTN","PSIVEDT",50,0)
25 ; Stop Date.
"RTN","PSIVEDT",51,0)
 D 25^PSIVEDT1
"RTN","PSIVEDT",52,0)
 Q
"RTN","PSIVEDT",53,0)
26 ; Schedule
"RTN","PSIVEDT",54,0)
 D 26^PSIVEDT1
"RTN","PSIVEDT",55,0)
 Q
"RTN","PSIVEDT",56,0)
 ;
"RTN","PSIVEDT",57,0)
39 ; Admin Times.
"RTN","PSIVEDT",58,0)
 D 39^PSIVEDT1
"RTN","PSIVEDT",59,0)
 Q
"RTN","PSIVEDT",60,0)
 ;
"RTN","PSIVEDT",61,0)
57 ; Additive.
"RTN","PSIVEDT",62,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",63,0)
 . W !!?5,"Additive may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",64,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",65,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",66,0)
 I $E(PSIVAC)="O" W !!,"Only additives marked for use in IV Fluid Order Entry may be selected."
"RTN","PSIVEDT",67,0)
 S FIL=52.6,DRGT="AD",DRGTN="ADDITIVE" D DRG^PSIVEDRG,DKILL
"RTN","PSIVEDT",68,0)
 Q
"RTN","PSIVEDT",69,0)
 ;
"RTN","PSIVEDT",70,0)
58 ; Solution.
"RTN","PSIVEDT",71,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",72,0)
 . W !!?5,"Solution may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",73,0)
 S FIL=52.7,DRGT="SOL",DRGTN="SOLUTION" D DRG^PSIVEDRG
"RTN","PSIVEDT",74,0)
 ;
"RTN","PSIVEDT",75,0)
DKILL ; Kill for drug edit.
"RTN","PSIVEDT",76,0)
 K DRGI,DRGN,DRGT,DRGTN,FIL,PSIVSTR
"RTN","PSIVEDT",77,0)
 Q
"RTN","PSIVEDT",78,0)
 ;
"RTN","PSIVEDT",79,0)
59 ; Infusion Rate.
"RTN","PSIVEDT",80,0)
 D 59^PSIVEDT1
"RTN","PSIVEDT",81,0)
 Q
"RTN","PSIVEDT",82,0)
 ;
"RTN","PSIVEDT",83,0)
62 ; IV Room.
"RTN","PSIVEDT",84,0)
 N DIR S DIR(0)="PA^59.5",DIR("A")="IV Room: ",DIR("??")="^S F1=59.5,F2=.01 D ENHLP^PSIVORC1" S:P("IVRM") DIR("B")=$P(P("IVRM"),U,2)
"RTN","PSIVEDT",85,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 S P("IVRM")=Y W $P($P(Y,U,2),X,2)
"RTN","PSIVEDT",86,0)
 Q
"RTN","PSIVEDT",87,0)
 ;
"RTN","PSIVEDT",88,0)
63 ; Remarks.
"RTN","PSIVEDT",89,0)
 D 63^PSIVEDT1
"RTN","PSIVEDT",90,0)
 Q
"RTN","PSIVEDT",91,0)
 ;
"RTN","PSIVEDT",92,0)
64 ; Other Print Info.
"RTN","PSIVEDT",93,0)
 D 64^PSIVEDT1
"RTN","PSIVEDT",94,0)
 Q
"RTN","PSIVEDT",95,0)
 ;
"RTN","PSIVEDT",96,0)
66 ; Provider's comments.
"RTN","PSIVEDT",97,0)
 N DA,DIE,DIR S DA=PSIVUP,DIE="^PS(53.45,",DR=4 D ^DIE S PSGSI=X,Y=1
"RTN","PSIVEDT",98,0)
 Q
"RTN","PSIVEDT",99,0)
 ;
"RTN","PSIVEDT",100,0)
101 ; Orderable Item.
"RTN","PSIVEDT",101,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",102,0)
 . W !!?5,"This is Renewal order. Orderable Item may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",103,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",104,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Orderable Item may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",105,0)
 W !,"Orderable Item: "_$S(P("PD"):$P(P("PD"),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X=""&P("PD")) Q
"RTN","PSIVEDT",106,0)
 I X]"" N DIC S DIC="^PS(50.7,",DIC(0)="EMQZ",DIC("B")=$S(P("PD")]"":+$P(("PD"),U),1:""),DIC("S")="S PSJSCT=1 I $$DRGSC^PSIVUTL(Y,PSJSCT) K PSJSCT" D ^DIC K DIC I Y>0 S P("PD")=Y Q
"RTN","PSIVEDT",107,0)
 W $C(7),!!,"Orderable Item is required!",!! G 101
"RTN","PSIVEDT",108,0)
 Q
"RTN","PSIVEDT",109,0)
109 ; Dosage Ordered.
"RTN","PSIVEDT",110,0)
 W !,"DOSAGE ORDERED: "_$S(P("DO")]"":P("DO")_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(P("DO")]""&(X="")) Q
"RTN","PSIVEDT",111,0)
 I X="???" D ORFLDS^PSIVEDT1 G 109
"RTN","PSIVEDT",112,0)
 D:X]"" CHK^DIE(53.1,109,"",X,.X) I $G(X)="^" W $C(7),!!,"Enter the dosage in which the Orderable Item entered should be dispensed.",! W "Answer must be 1-20 characters in length." G 109
"RTN","PSIVEDT",113,0)
 S P("DO")=X
"RTN","PSIVEDT",114,0)
 Q
"RTN","PSIVEDT",115,0)
 ;
"RTN","PSIVEDT",116,0)
FF ; up-arrow to another field.
"RTN","PSIVEDT",117,0)
 N DIC S X=$P(X,U,2),DIC="^DD(53.1,",DIC(0)="QEM",DIC("S")="I U_PSIVOK_U[(U_+Y_U)" D ^DIC K DIC S Y=+Y
"RTN","PSIVEDT",118,0)
 Q
"RTN","PSIVEDT",119,0)
 ;
"RTN","PSIVEDT",120,0)
NEWDRG ; Ask if adding a new drug.
"RTN","PSIVEDT",121,0)
 K DIR S DIR(0)="Y",DIR("A")="Are you adding "_$P(TDRG,U,2)_" as a new "_$S(DRGT="AD":"additive",1:"solution")_" for this order",DIR("B")="NO" D ^DIR I $D(DTOUT)!$D(DUOUT) Q
"RTN","PSIVEDT",122,0)
 I Y S (DRGI,DRG(DRGT,0))=DRG(DRGT,0)+1,DRG=TDRG,DRG(DRGT,+DRGI)=+DRG_U_$P(DRG,U,2) I DRGT="SOL" S X=$G(^PS(52.7,+DRG,0)),$P(DRG(DRGT,DRG),U,3)=$P(X,U,3)
"RTN","PSIVEDT",123,0)
 Q
"RTN","PSIVOPT2")
0^13^B32615251
"RTN","PSIVOPT2",1,0)
PSIVOPT2 ;BIR/PR,MLM-OPTION DRIVER (CONT) ;02 Mar 99 / 9:27 AM
"RTN","PSIVOPT2",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**23,29,58,110,127,133**;16 DEC 97
"RTN","PSIVOPT2",3,0)
 ;
"RTN","PSIVOPT2",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSIVOPT2",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVOPT2",6,0)
 ;
"RTN","PSIVOPT2",7,0)
D ; Discontinue order.
"RTN","PSIVOPT2",8,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) W !,$C(7),"Order Unchanged." S COMQUIT=1 Q
"RTN","PSIVOPT2",9,0)
 ;* 8/2* D EN1^PSJHL2(DFN,"OD",+ON55_"V","ORDER DISCONTINUED"),D1
"RTN","PSIVOPT2",10,0)
 I '$$REQPROV^PSGOEC W !,$C(7),"Order Unchanged." S COMQUIT=1 Q
"RTN","PSIVOPT2",11,0)
 I 'PSJCOM D
"RTN","PSIVOPT2",12,0)
 .D D1
"RTN","PSIVOPT2",13,0)
 .S PSIVALT=1,PSIVALCK="STOP",PSIVREA="D",ON=ON55 D LOG^PSIVORAL S P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3)
"RTN","PSIVOPT2",14,0)
 I PSJCOM N COMFLG S COMFLG=0 D
"RTN","PSIVOPT2",15,0)
 .I ON55'["P" N COMFLG,O,OO S (COMFLG,O)=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  Q:COMFLG  D
"RTN","PSIVOPT2",16,0)
 .. Q:OO=ON55  I '$$LS^PSSLOCK(DFN,OO) S COMFLG=1 Q
"RTN","PSIVOPT2",17,0)
 I PSJCOM Q:COMFLG  N O,OO S O=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  D
"RTN","PSIVOPT2",18,0)
 .I OO["V" S ON55=OO D D1 S PSIVALT=1,PSIVALCK="STOP",PSIVREA="D",ON=ON55 D LOG^PSIVORAL N PSJORD S P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),PSJORD=ON55 D HL^PSIVORA Q
"RTN","PSIVOPT2",19,0)
 .I OO["U" N PSGORD,PSJORD,PSJNOO K DA D NOW^%DTC S PSGDT=%,T=$E("T",'PSJSYSU),PSGALR=20,PSGP=DFN,DA=+OO,DA(1)=PSGP,(PSGORD,PSJORD)=OO,PSJNOO=P("NAT") D
"RTN","PSIVOPT2",20,0)
 ..S CF=$S($P(PSJSYSP0,U,5):1,PSGORD["U":0,1:($P($G(^PS(53.1,+PSGORD,0)),U,25)=""&($P($G(^(4)),U,7)=DUZ)))  D ASET^PSGOEC,AC^PSGOEC
"RTN","PSIVOPT2",21,0)
 Q
"RTN","PSIVOPT2",22,0)
D1 N %,DA,DIE,DIU,STP,NSTOP
"RTN","PSIVOPT2",23,0)
 S NSTOP=$$DATE^PSJUTL2(),STP=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),NSTOP=+$S(STP>NSTOP:NSTOP,1:STP),P(17)="D"
"RTN","PSIVOPT2",24,0)
 S DA(1)=DFN,DA=+ON55,DIE="^PS(55,"_DFN_",""IV"",",DR="109////"_NSTOP_$S('$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7):";116////"_STP,1:"")_";100///D;.03////"_NSTOP,PSIVACT=1 D ^DIE
"RTN","PSIVOPT2",25,0)
 I $S($G(PSIVAC)="OD":0,$G(PSIVAC)'="AD":1,$G(PSGALO)<1060:0,1:$P($G(PSJSYSW0),U,15)) S X=$S($G(PSIVAC)="AD":1,1:2) D ENLBL^PSIVOPT(X,$S(X=1:+$G(PSGUOW),1:DUZ),DFN,3,+ON55,$E("AD",1,3-X))
"RTN","PSIVOPT2",26,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN Q:'PSJIVORF  ;* S ORIFN=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,21) Q:'ORIFN
"RTN","PSIVOPT2",27,0)
 Q
"RTN","PSIVOPT2",28,0)
 ;
"RTN","PSIVOPT2",29,0)
R ; Renew order.
"RTN","PSIVOPT2",30,0)
 ;I PSJCOM D RIV^PSJCOMR Q
"RTN","PSIVOPT2",31,0)
 I PSJCOM D ^PSJCOMR Q
"RTN","PSIVOPT2",32,0)
 I P(17)="D",P(12) N ERR D RI W:$G(ERR)=1 $C(7),"  Order unchanged." I $G(ERR)<2 S COMQUIT=1 Q
"RTN","PSIVOPT2",33,0)
 NEW PSGORQF S PSIVRNFG=1 D ORDCHK^PSJLIFN K PSIVRNFG W !
"RTN","PSIVOPT2",34,0)
 I $G(PSGORQF) S COMQUIT=1 Q
"RTN","PSIVOPT2",35,0)
 ;
"RTN","PSIVOPT2",36,0)
R1 ;
"RTN","PSIVOPT2",37,0)
 I $$EXPIRED^PSGOER(DFN,ON55) D  Q
"RTN","PSIVOPT2",38,0)
 .W !?3,"  THIS ORDER HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED ADMINISTRATIONS"
"RTN","PSIVOPT2",39,0)
 .W !?20,"  AND CANNOT BE RENEWED!"
"RTN","PSIVOPT2",40,0)
 N PSJRNWDT,PSJOSTOP,OREASON S PSJRNWDT=$$DATE2^PSJUTL2(PSGDT) S:$G(ON55) PSJOSTOP=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3) I '(PSJOSTOP>P(2)),$G(PSGDT) S PSJOSTOP=PSGDT
"RTN","PSIVOPT2",41,0)
 S (PSIVOK,EDIT)="25^1" S P2=P(2),P(2)=PSJRNWDT D EDIT^PSIVEDT S P(2)=P2 K P2 I X="^" Q
"RTN","PSIVOPT2",42,0)
 S P(11)=$$ENRNAT^PSGOU($P($G(^PS(55,DFN,"IV",+ON55,2)),U,10),+VAIN(4),P(9),P(11))
"RTN","PSIVOPT2",43,0)
 D OK G:X["N" R1 I X=U D RD Q
"RTN","PSIVOPT2",44,0)
 S PSIVCHG=2
"RTN","PSIVOPT2",45,0)
 S P(17)="A",OREASON=P("RES"),P("RES")="R",P("FRES")="" D:'$D(PSJIVORF) ORPARM^PSIVOREN I PSJIVORF D  Q:'$D(P("NAT"))
"RTN","PSIVOPT2",46,0)
 .D NATURE^PSIVOREN I '$D(P("NAT")) D RD Q
"RTN","PSIVOPT2",47,0)
 .S ON=ON55
"RTN","PSIVOPT2",48,0)
 S P(16)="",PSJORIFN="",PSIVACT=1,P("21FLG")="",P("RES")=OREASON D SET55^PSIVORFB
"RTN","PSIVOPT2",49,0)
 D:$P(^PS(55,DFN,"IV",+ON55,0),U,17)="A" RUPDATE^PSIVOREN(DFN,ON55,P(2))
"RTN","PSIVOPT2",50,0)
 I PSJIVORF,$P(^PS(55,DFN,"IV",+ON55,0),U,17)'="A" S X=$$LS^PSSLOCK(DFN,+ON55_"V") D
"RTN","PSIVOPT2",51,0)
 .D EXPOE^PSGOER(DFN,ON55)
"RTN","PSIVOPT2",52,0)
 .S P("RES")="R",PSJREN=1
"RTN","PSIVOPT2",53,0)
 .D ENUDTX^PSJOREN(DFN,ON55,"NR"),EN1^PSJHL2(DFN,"SN",+ON55_"V","ORDER RENEWED"),UPDREN(DFN,ON55,PSJRNWDT,P(6),PSJOSTOP,P("NAT"))
"RTN","PSIVOPT2",54,0)
 S OD=P(2)
"RTN","PSIVOPT2",55,0)
 D VF1^PSJLIACT("","",1),UNL^PSSLOCK(DFN,+ON55_"V")
"RTN","PSIVOPT2",56,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"R")
"RTN","PSIVOPT2",57,0)
 I $G(PSJOSTOP),$G(ON55),$G(DFN) D STIX^PSIVOREN(PSJOSTOP,ON55,DFN)
"RTN","PSIVOPT2",58,0)
 Q
"RTN","PSIVOPT2",59,0)
 ;
"RTN","PSIVOPT2",60,0)
RD ; Delete for renew.
"RTN","PSIVOPT2",61,0)
 ;Q:'$G(PSJVFY)
"RTN","PSIVOPT2",62,0)
 ;D DEL55^PSIVORE2 S (ON55,P("OLDON"))=P("PON") D GT55^PSIVORFB
"RTN","PSIVOPT2",63,0)
 Q
"RTN","PSIVOPT2",64,0)
 ;
"RTN","PSIVOPT2",65,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSIVOPT2",66,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I ($G(P("PD"))="") D GTPD^PSIVORE2
"RTN","PSIVOPT2",67,0)
 D ^PSIVCHK I $D(DUOUT) S X="^",COMQUIT=1 Q
"RTN","PSIVOPT2",68,0)
 I ERR=1 S X="N",COMQUIT=1 Q
"RTN","PSIVOPT2",69,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVOPT2",70,0)
 I $G(PSIVCHG),($G(PSIVREA)'="R") W !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVOPT2",71,0)
 S X="Is this O.K.: ^"_$S(ERR:"N",1:"Y")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSIVOPT2",72,0)
 Q
"RTN","PSIVOPT2",73,0)
 ;
"RTN","PSIVOPT2",74,0)
RI ; Reinstate Auto-DC'ed order.
"RTN","PSIVOPT2",75,0)
 N DA,DIE,DIR,DIU,DR,PSIVACT,PSIVALT,PSIVALCK,PSIVREA W !!,$C(7),"This order has been Auto-DC'ed."
"RTN","PSIVOPT2",76,0)
 S DIR(0)="Y",DIR("A")="Reinstate this order" D ^DIR K DIR I 'Y S ERR=1 Q
"RTN","PSIVOPT2",77,0)
 D NOW^%DTC I %>$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7) D
"RTN","PSIVOPT2",78,0)
 .K DIR S ERR=1,DIR(0)="Y",DIR("A",1)="The original stop date of this order has past.",DIR("A")="Do you wish to renew this order" D ^DIR K DIR S ERR=$S(Y:2,1:1)
"RTN","PSIVOPT2",79,0)
 Q:$G(ERR)  S X=$G(^VA(200,+P(6),"PS")) I $S('X:1,'$P(X,U,4):0,DT<$P(X,U,4):0,1:1) S ERR=1
"RTN","PSIVOPT2",80,0)
 I $G(ERR) W !!,$C(7),"This order's provider is no longer valid. Please enter a valid provider." S (EDIT,PSIVOK)=1 D EDIT^PSIVEDT I $G(DONE) W $C(7),"Order unchanged." S ERR=1 Q
"RTN","PSIVOPT2",81,0)
 N PSGALO S PSGALO=18530 D ENARI^PSIVOPT(DFN,ON,DUZ,PSGALO)
"RTN","PSIVOPT2",82,0)
 Q
"RTN","PSIVOPT2",83,0)
 ;
"RTN","PSIVOPT2",84,0)
UPDREN(DFN,ORD,RNWDT,PROV,OSTOPDT,PSJNOO) ;
"RTN","PSIVOPT2",85,0)
 Q:'DFN!'ORD!'RNWDT!'PROV!'OSTOPDT!(PSJNOO="")
"RTN","PSIVOPT2",86,0)
 K DR,DA,DIC,DIE,DD,DO N ND0,PSGOEORD
"RTN","PSIVOPT2",87,0)
 S DIC="^PS(55,"_DFN_",""IV"","_+ORD S ND0=$G(@(DIC_",0)")),PSGOEORD=$P(ND0,"^",21) I $G(ON)["P",$G(PSGOLDOE) S PSGOEORD=PSGOLDOE
"RTN","PSIVOPT2",88,0)
 S DIC=DIC_",14,",DIC(0)="L",DIC("P")="55.1138DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=DFN,DA(1)=+ORD D
"RTN","PSIVOPT2",89,0)
 .S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$G(DUZ)_";2////"_$G(PROV)_";3////"_$G(OSTOPDT)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSIVOPT2",90,0)
 .Q
"RTN","PSIVOPT2",91,0)
 K DO,DINUM
"RTN","PSIVORE")
0^19^B41019563
"RTN","PSIVORE",1,0)
PSIVORE ;BIR/PR,MLM-ORDER ENTRY ;25 Nov 98 / 3:34 PM
"RTN","PSIVORE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**18,29,50,56,58,81,110,127,133**;16 DEC 97
"RTN","PSIVORE",3,0)
 ;
"RTN","PSIVORE",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVORE",5,0)
 ; Reference to ^ORX2 is supported by DBIA #867
"RTN","PSIVORE",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVORE",7,0)
 ; Reference to ^DICN is supported by DBIA 10009.
"RTN","PSIVORE",8,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSIVORE",9,0)
 ; Reference to EN^VALM is supported by DBIA 10118.
"RTN","PSIVORE",10,0)
 ; Reference to ^VADPT is supported by DBIA 10061.
"RTN","PSIVORE",11,0)
 ;
"RTN","PSIVORE",12,0)
 N PSJNEW,PSJOUT,PSGPTMP,PPAGE,FLAG S PSJNEW=1
"RTN","PSIVORE",13,0)
 ;
"RTN","PSIVORE",14,0)
 D SITE Q:'$G(PSIVQ)  K PSIVQ S PSGOP=""
"RTN","PSIVORE",15,0)
 ;
"RTN","PSIVORE",16,0)
BEG ;Get patient and make sure he is living.
"RTN","PSIVORE",17,0)
 L +^PS(53.45,DUZ):1 E  D LOCKERR^PSJOE G Q
"RTN","PSIVORE",18,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  D ASK
"RTN","PSIVORE",19,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S X=DFN_";DPT(" D LK^ORX2 Q:'Y  D ASK S X=DFN_";DPT(" D ULK^ORX2
"RTN","PSIVORE",20,0)
 NEW PSJLK
"RTN","PSIVORE",21,0)
 F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S PSJLK='$$L^PSSLOCK(DFN,1) Q:PSJLK  D ASK,UL^PSSLOCK(DFN)
"RTN","PSIVORE",22,0)
 I PSGOP,$P(PSJSYSL,"^",2)]"" D ENQL^PSGLW
"RTN","PSIVORE",23,0)
 G Q
"RTN","PSIVORE",24,0)
 ;
"RTN","PSIVORE",25,0)
ASK ;See if patient has been admitted.
"RTN","PSIVORE",26,0)
 I VADM(6) W !?5,"Patient has died." Q
"RTN","PSIVORE",27,0)
 I 'VAIN(4) K DIK S DIR(0)="Y",DIR("A")="Do you wish to continue",DIR("B")="NO",DIR("??")="^S HELP=""ADMYN"" D ^PSIVHLP1" W !,"This patient has not been admitted." D ^DIR K DIR Q:'Y
"RTN","PSIVORE",28,0)
 S:VAIN(4) WSCHADM=+VAIN(4)
"RTN","PSIVORE",29,0)
 ;
"RTN","PSIVORE",30,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSIVORE",31,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD,DINUM
"RTN","PSIVORE",32,0)
 .; Mark PSJ and PSO as converted
"RTN","PSIVORE",33,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSIVORE",34,0)
 S PSJNARC=1
"RTN","PSIVORE",35,0)
 S PSGP=DFN,PSJPWD=+VAIN(4),PSIVAC="P",PSIVBR="D ^PSIVOPT" D HK,ENCHS1^PSIV Q:'$D(DFN)
"RTN","PSIVORE",36,0)
 Q
"RTN","PSIVORE",37,0)
 ;
"RTN","PSIVORE",38,0)
NEW ;Ask to enter new order.
"RTN","PSIVORE",39,0)
 D:'$D(VADM(1)) DEM^VADPT
"RTN","PSIVORE",40,0)
 K P,PSIVCHG,PSIVTYPE,PSJOE,DIR S DIR(0)="Y",DIR("A")="New order for "_VADM(1),DIR("B")="YES",DIR("??")="^S HELP=""NEWORD"" D ^PSIVHLP" D ^DIR K DIR Q:'Y
"RTN","PSIVORE",41,0)
 NEW X S X=DFN_";DPT(" D LK^ORX2 Q:'Y  S PSJLSORX=1
"RTN","PSIVORE",42,0)
INMED K ON55,PSJOUT S (P(4),P("OT"),P("FRES"))="" D NEW55^PSIVORFB I '$D(ON55) D ULK G:'$D(PSJOE)&('$D(PSJOUT)) NEW G Q
"RTN","PSIVORE",43,0)
 S P("RES")="N",PSIVAC="PN",P("PON")=ON55,PSIVUP=+$$GTPCI^PSIVUTL D NEW^PSIVORE2 I $G(P(2))="" D DEL55^PSIVORE2 D ULK G:'$D(PSJOE) NEW Q
"RTN","PSIVORE",44,0)
 D OK L -^PS(55,DFN,"IV",+ON55) D ULK G:'$D(PSJOE) NEW
"RTN","PSIVORE",45,0)
 ;
"RTN","PSIVORE",46,0)
Q ; Kill and exit.
"RTN","PSIVORE",47,0)
 L:'$D(PSJOE) -^PS(53.45,DUZ) S PSJNKF=1 D Q^PSIV
"RTN","PSIVORE",48,0)
 K FIL,I1,ND,PC,PDM,PSGDT,PSGID,PSGLMT,PSGSI,PSJNARC,PSIVAC,PSIVCHG,PSIVUP,PSIVX,PSJOPC
"RTN","PSIVORE",49,0)
 Q
"RTN","PSIVORE",50,0)
 ;
"RTN","PSIVORE",51,0)
ULK ;
"RTN","PSIVORE",52,0)
 Q:'$G(PSJLSORX)  ;If NEW^PSIVORE did not lock, don't kill it here.
"RTN","PSIVORE",53,0)
 NEW X S X=DFN_";DPT(" D ULK^ORX2 K PSJLSORX
"RTN","PSIVORE",54,0)
 Q
"RTN","PSIVORE",55,0)
HK ;Queue job to print MAR labels generated for this patient.
"RTN","PSIVORE",56,0)
 I PSGOP,PSGOP'=DFN D
"RTN","PSIVORE",57,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSIVORE",58,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,U,2)]"" ENQL^PSGLW
"RTN","PSIVORE",59,0)
 S PSGOP=DFN
"RTN","PSIVORE",60,0)
 Q
"RTN","PSIVORE",61,0)
 ;
"RTN","PSIVORE",62,0)
SITE ;See if site parameters are ok.
"RTN","PSIVORE",63,0)
 K PSIVQ D ^PSIVXU Q:$D(XQUIT)
"RTN","PSIVORE",64,0)
 I '$D(PSIVSN)!('$D(PSIVSITE)) W $C(7),$C(7),!!,"You have no IV ROOM parameters ... PLEASE ... PLEASE ...",!,"Exit this package and reenter properly !!",!! Q
"RTN","PSIVORE",65,0)
 D ORPARM^PSIVOREN S PSIVQ=1
"RTN","PSIVORE",66,0)
 Q
"RTN","PSIVORE",67,0)
 ;
"RTN","PSIVORE",68,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSIVORE",69,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I $G(P("PD"))="" D GTPD^PSIVORE2
"RTN","PSIVORE",70,0)
 D ^PSIVCHK I $D(DUOUT) S X="^" G DOA
"RTN","PSIVORE",71,0)
 I ERR=1 S X="N" G BAD
"RTN","PSIVORE",72,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVORE",73,0)
 W:$G(PSIVCHG) !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVORE",74,0)
 I '$G(PSIVCOPY) G:PSIVAC["R" OK1 S X="Is this O.K.: ^"_$S(ERR:"NO",1:"YES")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV
"RTN","PSIVORE",75,0)
 S PSJIVBD=1 ;var use to indicate order enter from back door
"RTN","PSIVORE",76,0)
BAD ;; I X["N" D GSTRING^PSIVORE1,^PSIVORV2,GTFLDS^PSIVORFE G OK
"RTN","PSIVORE",77,0)
 I ON55["V",($G(P(21))="") S P(17)="N"
"RTN","PSIVORE",78,0)
 I X["N" NEW PSGEBN,PSGLI S (P("INS"),PSGEBN,PSGLI)="",(PSJORD,ON)=ON55 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q" Q
"RTN","PSIVORE",79,0)
 I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSIVORE",80,0)
DOA I X["^" D DEL55^PSIVORE2 Q
"RTN","PSIVORE",81,0)
 Q:$$NONVF("SN")
"RTN","PSIVORE",82,0)
OK1 S PSJORL=$$ENORL^PSJUTL($G(VAIN(4))),P(17)="A",ORSTS=6,ON=ON55,PSJORNP=+P(6)
"RTN","PSIVORE",83,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN
"RTN","PSIVORE",84,0)
 I PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) D DEL55^PSIVORE2 Q
"RTN","PSIVORE",85,0)
 D SET55^PSIVORFB
"RTN","PSIVORE",86,0)
 I PSJIVORF,($G(P(22))=.5) D CLINIC^PSIVOREN
"RTN","PSIVORE",87,0)
 I PSJIVORF D SET^PSIVORFE S ORNATR=P("NAT"),ON=+ON55,OD=P(2) D EN1^PSJHL2(DFN,"SN",+ON55_"V","SEND ORDER NUMBER") ;,EN1^PSJHL2(DFN,"SC",+ON55_"V","NEW ORDER CREATED")
"RTN","PSIVORE",88,0)
 D VF1^PSJLIACT("V","ORDER ENTERED AS ACTIVE BY ",1)
"RTN","PSIVORE",89,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"N")
"RTN","PSIVORE",90,0)
 ;
"RTN","PSIVORE",91,0)
CAL ;Calculate doses.
"RTN","PSIVORE",92,0)
 ;S OD=P(2) D EN,^PSIVORE1,^PSIVOPT
"RTN","PSIVORE",93,0)
 S OD=P(2) D EN,^PSIVOPT
"RTN","PSIVORE",94,0)
 Q
"RTN","PSIVORE",95,0)
 ;
"RTN","PSIVORE",96,0)
EN ;Update schedule interval P(15) only on continuous orders.
"RTN","PSIVORE",97,0)
 ;This includes Hyp/Adm/Continuous Syringes/Chemos =>P(5)=0
"RTN","PSIVORE",98,0)
 Q:'$D(DFN)!('$D(ON55))  Q:$P(^PS(55,DFN,"IV",+ON55,0),U,4)="P"!($P(^(0),U,5))!($P(^(0),U,23)="P")
"RTN","PSIVORE",99,0)
 D SPSOL S XXX=$P(^PS(55,DFN,"IV",+ON55,0),U,8) G:'SPSOL ENQ I XXX?1N.N.1"."1N.N1" ml/hr" S P(15)=$S('XXX:0,1:SPSOL\XXX*60+(SPSOL#XXX/XXX*60+.5)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15) G ENQ
"RTN","PSIVORE",100,0)
 S P(15)=$S('$P(XXX,"@",2):0,1:1440/$P(XXX,"@",2)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15)
"RTN","PSIVORE",101,0)
ENQ K SPSOL,XXX Q
"RTN","PSIVORE",102,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(^PS(55,DFN,"IV",+ON55,"SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(^(XXX,0),U,2)
"RTN","PSIVORE",103,0)
 K XXX Q
"RTN","PSIVORE",104,0)
ENIN ;Entry for Combined IV/UD order entry. Called by PSJOE0.
"RTN","PSIVORE",105,0)
 D HOLDHDR^PSJOE
"RTN","PSIVORE",106,0)
 W !
"RTN","PSIVORE",107,0)
 N PSJOUT S (DONE,FLAG)=0,PSIVAC="PN"
"RTN","PSIVORE",108,0)
ENIN1 ;
"RTN","PSIVORE",109,0)
 N DA,DIR,PSJOE,PSJPCAF,PSJSYSL,WSCHADM S:$G(VAIN(4)) WSCHADM=VAIN(4)
"RTN","PSIVORE",110,0)
 K P,PSIVCHG,PSJCOM
"RTN","PSIVORE",111,0)
 S PSJOE=1,DIR(0)="55.01,.04O",DIR("A")="Select IV TYPE" D ^DIR
"RTN","PSIVORE",112,0)
 I X]"",X'="^",$P("^PROFILE",X)="" S PSJOEPF=X Q
"RTN","PSIVORE",113,0)
 S:$D(DTOUT) X="^" I "^"[X S PSJORQF=PSJORQF+$S(X="^":2,$G(FLAG):0,1:1),X="." Q
"RTN","PSIVORE",114,0)
 S FLAG=1,PSIVTYPE=Y,(P(5),P(23))="" I "SC"[Y D @(Y_"^PSIVORC1") S $P(PSIVTYPE,U,2)=P(23)
"RTN","PSIVORE",115,0)
 D INMED G:'$D(PSJOUT) ENIN S:$D(PSJOUT) PSJORQF=2
"RTN","PSIVORE",116,0)
 Q
"RTN","PSIVORE",117,0)
NONVF(PSJOC)  ;If file at NonVF then quit with 1
"RTN","PSIVORE",118,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVORE",119,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVORE",120,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVORE",121,0)
 K DA D ENGNN^PSGOETO S ON=DA_"P",P(17)="N",P("REN")=0
"RTN","PSIVORE",122,0)
 D GTPD^PSIVORE2
"RTN","PSIVORE",123,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) D:ON55["V" DEL55 Q 1
"RTN","PSIVORE",124,0)
 D:$G(VAIN(4))="" CLINIC^PSIVOREN
"RTN","PSIVORE",125,0)
 W !,"...transcribing this non-verified order...."
"RTN","PSIVORE",126,0)
 D PUT531^PSIVORFA
"RTN","PSIVORE",127,0)
 D:$G(PSJOC)]"" EN1^PSJHL2(DFN,PSJOC,ON,"SEND ORDER NUMBER")
"RTN","PSIVORE",128,0)
 D:ON55["V" DEL55
"RTN","PSIVORE",129,0)
 NEW PSJORD S (ON55,PSJORD)=ON
"RTN","PSIVORE",130,0)
 D VF^PSIVORC2
"RTN","PSIVORE",131,0)
 Q 1
"RTN","PSIVORE",132,0)
DEL55 ;
"RTN","PSIVORE",133,0)
 Q:ON55["P"
"RTN","PSIVORE",134,0)
 S X=$G(^PS(55,DFN,"IV",+ON55,0))
"RTN","PSIVORE",135,0)
 I $P(X,U,21)]"",($G(^PS(55,DFN,"IV",+ON55,2))]"") S $P(^(2),U,6)=ON,$P(^PS(53.1,+ON,0),U,25)=ON55 Q
"RTN","PSIVORE",136,0)
 NEW PSIVORFA S PSIVORFA=1
"RTN","PSIVORE",137,0)
 D DEL55^PSIVORE2
"RTN","PSIVORE",138,0)
 Q 
"RTN","PSIVORE1")
0^20^B25223179
"RTN","PSIVORE1",1,0)
PSIVORE1 ;BIR/RGY,PR,MLM-ACT,NEW ORDER ;07 AUG 97 / 2:45 PM
"RTN","PSIVORE1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**58,110,127,133**;16 DEC 97
"RTN","PSIVORE1",3,0)
 ;
"RTN","PSIVORE1",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVORE1",5,0)
 ;
"RTN","PSIVORE1",6,0)
S ;
"RTN","PSIVORE1",7,0)
 Q:+PSJSYSU'=3
"RTN","PSIVORE1",8,0)
 I $G(ON),$G(DFN) N RNDT,OP2 S RNDT=+$$LASTREN^PSJLMPRI(DFN,ON) I RNDT D
"RTN","PSIVORE1",9,0)
 .N PSGSA,CD S OD=P(2),CD=P(3) D ENP3^PSIVWL
"RTN","PSIVORE1",10,0)
 .N NEXTX,DL,NXTLBL,DAY,LBLPC,BEG,OLDX S NXTLBL=0 S DAY=0,BEG=$P(+PSGSA,".") F LBLPC=1:1:$L(PSGSA," ") S OLDX=$G(NEXTX) S NEXTX=$P(PSGSA," ",LBLPC) D
"RTN","PSIVORE1",11,0)
 ..S:LBLPC=1 OLDX=NEXTX S:$E($P(NEXTX,".",2),1,2)<$E($P($G(OLDX),".",2),1,2) DAY=DAY+1 S DAY($$FMADD^XLFDT(BEG,DAY)_"."_$P(NEXTX,".",2))=LBLPC
"RTN","PSIVORE1",12,0)
 .S D=0 F  S D=$O(DAY(D)) Q:'D!$G(NXTLBL)  D
"RTN","PSIVORE1",13,0)
 ..I D>RNDT S NXTLBL=D
"RTN","PSIVORE1",14,0)
 .I $G(NXTLBL) S OP2=P(2) S (OD,P(2))=NXTLBL Q
"RTN","PSIVORE1",15,0)
 .S (OD,P(2))=RNDT
"RTN","PSIVORE1",16,0)
 ;
"RTN","PSIVORE1",17,0)
 D NOW^%DTC S Y=% Q:P(4)=""!(P(2)="")  S:'$D(OD) OD=$S(P(2)>Y:P(2),1:Y) S PSGCNT=0,PNOW=DT K PSGSA
"RTN","PSIVORE1",18,0)
STR ;
"RTN","PSIVORE1",19,0)
 ;
"RTN","PSIVORE1",20,0)
 K PSI F I=0:0 S I=$O(^PS(59.5,PSIVSN,2,"AC",P(4),I)) Q:'I  S PSI("E",+(PNOW_"."_$P(^PS(59.5,+PSIVSN,2,I,0),U,4)))=+(PNOW_"."_$P(^(0),U))_U_I,PSI("S",+(PNOW_"."_$P(^(0),U)))=I
"RTN","PSIVORE1",21,0)
 ;
"RTN","PSIVORE1",22,0)
EC ;
"RTN","PSIVORE1",23,0)
 S PSIVEC=$O(PSI("E",Y)) I PSIVEC="" S X1=PNOW,X2=1 D C^%DTC S PNOW=X G STR
"RTN","PSIVORE1",24,0)
 I $O(PSI("S",PSIVEC))="" S X1=$O(PSI("S",0)),X2=1 D C^%DTC S X=$P(X,".") S PSI("S",+(X_"."_$P($O(PSI("S",0)),".",2)))=PSI("S",$O(PSI("S",0)))
"RTN","PSIVORE1",25,0)
 I $P(^PS(59.5,+PSIVSN,2,PSI("S",$O(PSI("S",PSIVEC))),0),U,6)=$O(PSI("S",PSIVEC)) S Y=PSIVEC G EC
"RTN","PSIVORE1",26,0)
 I PSIVEC'<P(2) S CD=$S(P(3)>PSIVEC:PSIVEC,1:P(3)) S:OD=CD CD=CD+.0001 D ENP3^PSIVWL
"RTN","PSIVORE1",27,0)
P ;
"RTN","PSIVORE1",28,0)
 S:'$D(PSGSA) PSGSA=""
"RTN","PSIVORE1",29,0)
 D FULL^VALM1
"RTN","PSIVORE1",30,0)
 W:PSGCNT !!,PSGCNT," Label",$E("s",PSGCNT>1)," needed for dose",$E("s",PSGCNT>1)," due at ...",!!
"RTN","PSIVORE1",31,0)
 F Y=1:1 S X=$P(PSGSA," ",Y) S:$E(X)="." X=$$CONVER^PSIVORE2(X,Y) Q:X=""  W $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)_" "_$E(X#1_"000",2,5)_" : "
"RTN","PSIVORE1",32,0)
 W ! D:$P(PSIVSITE,U,8) TL^PSIVORE2 D NOW^%DTC S Y=% S PNOW=Y I $D(^PS(59.5,PSIVSN,3,"AT")) W !!,"Next delivery time is " S X=$O(^PS(59.5,PSIVSN,3,"AT",PNOW#1)) S:X="" X=$O(^(X)) S X=$P(X,".",2)_$E("000",1,5-$L(X)) W X," ***" G B1
"RTN","PSIVORE1",33,0)
ACT ; Prompt and process label action.
"RTN","PSIVORE1",34,0)
B I PSGCNT<1 S:($G(RNDT)&$G(OP2)) P(2)=OP2 G K^PSIVORE2
"RTN","PSIVORE1",35,0)
B1 ;
"RTN","PSIVORE1",36,0)
 W ! S X="Action (PB"_$S($P(PSIVSITE,U,2):"S",1:"")_")^"_$S(PSGCNT<1:"B",$G(PSJPRI)="D":"B",$P(PSIVSITE,U,2)&$D(X):"S",1:"P")_"^^PRINT LABELS,BYPASS"_$S($P(PSIVSITE,U,2):",SUSPEND LABELS",1:"")
"RTN","PSIVORE1",37,0)
 D ENQ^PSIV S X=$E(X) S:X["?" HELP="ANSWER" D:X["?" ^PSIVHLP G:X["?" B1 I "B^"[X G K^PSIVORE2
"RTN","PSIVORE1",38,0)
 I "S"[X,$D(^PS(55,"PSIVSUS",PSIVSN,DFN,ON)) D C^PSIVORE2 W !!,"There ",$S(SNM>1:"are",1:"is")," already ",SNM," LABEL",$E("S",SNM>1)," suspended for this order." K SNM,DAT
"RTN","PSIVORE1",39,0)
SS ;
"RTN","PSIVORE1",40,0)
 S PSIVA=X,X="# of labels^"_PSGCNT_"^^^QUX=+QUX&(QUX?1N.N)" D ENQ^PSIV W !!
"RTN","PSIVORE1",41,0)
 S PSIVLABN=X I X["?"!(X>99) S X=PSIVA W !,"Enter # labels, less than 100, to act on." G SS
"RTN","PSIVORE1",42,0)
 I 'X W " No action taken ***" G B1
"RTN","PSIVORE1",43,0)
 I PSIVA="S",$D(^PS(55,"PSIVSUS",PSIVSN,DFN,+ON,PNOW)) W $C(7),"NO Labels suspended, Wait 8 seconds and try again." D NOW^%DTC S Y=% S PNOW=Y G B1
"RTN","PSIVORE1",44,0)
 S $P(^(0),U,16)=$P(^PS(55,DFN,"IV",+ON,0),U,16)+X,PSIVNOL=+X,PSGCNT=PSGCNT-X,PSIVDOSE=$P(PSGSA," ",1,X),PLAST=$P(PSGSA," "),PLAST="."_$P(PLAST,".",2),PSGSA=$P(PSGSA," ",X+1,999) I PLAST>$P(PSGSA," ") S UP1=1
"RTN","PSIVORE1",45,0)
 S P(16)=$P(^PS(55,DFN,"IV",+ON,0),U,16)
"RTN","PSIVORE1",46,0)
 I $D(UP1) S:$D(X1)#2 XX1=X1 S:$D(X2)#2 XX2=X2 S X1=$E(PSIVDOSE,1,7),X2=1 D C^%DTC S PSGSA=X_PSGSA S:$D(XX1) X1=XX1 S:$D(XX2) X2=XX2 K XX2,XX1
"RTN","PSIVORE1",47,0)
 I '$D(UP1) S PSGSA=$E(PSIVDOSE,1,7)_PSGSA
"RTN","PSIVORE1",48,0)
 K UP1 I PSIVA="S" S ^PS(55,"PSIVSUS",PSIVSN,DFN,+ON,PNOW)=PSIVLABN_U_PSIVDOSE_U_P(16),Y=0,P(16)=P(16)+X W " ... ",PSIVLABN," Label",$E("s",PSIVLABN>1)," suspended !" S ACTION=5,PSIVNOL=PSIVLABN,TRACK=4 D ^PSIVLTR,NOW^%DTC S Y=% S PNOW=Y K X G B
"RTN","PSIVORE1",49,0)
 S IONOFF="" I PSIVPL=ION S P16=P(16),ACTION=1,TRACK=4 D ^PSIVLTR D ^PSIVHYPL:P(4)="H",^PSIVLABL:"APSC"[P(4) S P(16)=$P(^PS(55,DFN,"IV",+ON,0),U,16) G B
"RTN","PSIVORE1",50,0)
 W ! S P16=P(16),P(16)=P(16)+X,ZTDTH=$H,ZTIO=PSIVPL F Y="IONOFF","P16","PSIVDOSE","PSIVSITE","PSIVSN","PSIVNOL","DFN","ON","PSJSYSL","PSJSYSW0","PSJSYSW","PSJSYSP","PSJSYSP0","PSJSYSU" S ZTSAVE(Y)=""
"RTN","PSIVORE1",51,0)
 S ZTDESC="PRINT IV LABELS",ZTRTN="DEQ^PSIVORE2" D ^%ZTLOAD G B
"RTN","PSIVORE1",52,0)
GSTRING ; Setup edit "^" string.
"RTN","PSIVORE1",53,0)
 S PSIVOK="57^58^59^10^3^25^26^39^1^64^63"_$S($E(P("OT"))="I":"^101",1:"")
"RTN","PSIVORE1",54,0)
 S EDIT="57^58^59^10^3^25^26^39^1^"_$S(P("OT")="I":"101^",1:"")_"64^63"
"RTN","PSIVORE1",55,0)
 ;* S EDIT="57^58^59^10^3^25^26^39^1^"_$S(P("DTYP")=1:"101^",1:"")_"64^63"
"RTN","PSIVORE1",56,0)
 Q
"RTN","PSIVOREN")
0^21^B27037299
"RTN","PSIVOREN",1,0)
PSIVOREN ;BIR/MLM-UTILITIES FOR IV FLUIDS - OE/RR INTERFACE ; 25 Sep 98 / 2:00 PM
"RTN","PSIVOREN",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,18,69,110,127,133**;16 DEC 97
"RTN","PSIVOREN",3,0)
 ;
"RTN","PSIVOREN",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVOREN",5,0)
 ; Reference to ^VA(200 is supported by DBIA 10060.
"RTN","PSIVOREN",6,0)
 ; Reference to ^DIE is supported by DBIA 10018.
"RTN","PSIVOREN",7,0)
 ;
"RTN","PSIVOREN",8,0)
ENCPP ; Check Package Parameter
"RTN","PSIVOREN",9,0)
 D ORPARM I 'PSJORF W !!,"Inpatient Medications is not turned on for OE/RR.",!,"You will not be able to enter or edit IV or Unit Dose orders."
"RTN","PSIVOREN",10,0)
 I 'PSJIVORF W !!,"IV Medications is not turned on for OE/RR.",!,"You will not be able to enter or edit IV orders."
"RTN","PSIVOREN",11,0)
 I 'PSJORF!'PSJIVORF S PSJIVORF="" D DONE^PSIVORA1 Q
"RTN","PSIVOREN",12,0)
 S PSJORL=$G(VAIN(4)) I 'PSJORL,$G(DFN) D INP^VADPT S PSJORL=$G(VAIN(4))
"RTN","PSIVOREN",13,0)
 S PSJORPF=0,P("OT")="F^",PSJORNP=$S($G(PSJORNP):PSJORNP,1:+$G(DUZ))
"RTN","PSIVOREN",14,0)
 ;; S PSJORL=ORL,PSJORPF=0,P("OT")="F^"_$O(^ORD(101,"B","PSJI OR PAT FLUID OE",0))_";ORD(101,",PSJORNP=ORNP
"RTN","PSIVOREN",15,0)
 Q
"RTN","PSIVOREN",16,0)
 ;
"RTN","PSIVOREN",17,0)
PS ; Check if MD is authorized to write med. orders.
"RTN","PSIVOREN",18,0)
 S PSJORPF=0 S:PSJORNP X=$G(^VA(200,+PSJORNP,"PS")) Q:$S('PSJORNP:0,'X:0,'$P(X,U,4):1,$P(X,U,4)>DT:1,1:0)  D
"RTN","PSIVOREN",19,0)
 .W !?2,"(The selected PROVIDER is NOT qualified to write MEDICATION orders.  You must",!,"select a valid provider to be able to continue with Inpatient Medications.)"
"RTN","PSIVOREN",20,0)
 .K DIC S DIC="^VA(200,",DIC(0)="AEMQZ",DIC("A")="Select PHARMACY PROVIDER: ",DIC("S")="S PSIV=$G(^(""PS"")) I PSIV,$S($P(PSIV,""^"",4)="""":1,DT<$P(PSIV,""^"",4):1,1:0)" F  W ! D ^DIC Q:$D(DUOUT)!$D(DTOUT)!(Y>0)  W $C(7),"  (Required.)"
"RTN","PSIVOREN",21,0)
 .K DIC S:Y'>0 PSJORPF=11 S:Y>0 PSJORNP=+Y Q
"RTN","PSIVOREN",22,0)
 K DTOUT
"RTN","PSIVOREN",23,0)
 Q
"RTN","PSIVOREN",24,0)
 ;
"RTN","PSIVOREN",25,0)
RUPDATE(DFN,ON,NSTRT) ;
"RTN","PSIVOREN",26,0)
 ; Update renewal orders (called from Pharmacy options).
"RTN","PSIVOREN",27,0)
 N DA,DIE,DR,ND,NSTOP,OSTOP,NOO,ORETURN,PSIVACT,PSIVAL,PSIVALCK,PSJOSTRT,PSGOLDOE S DIE="^PS(55,"_DFN_","
"RTN","PSIVOREN",28,0)
 I ON["P" S OLDON=$P($G(^PS(53.1,+ON,0)),"^",25),NOO=$P($G(^PS(53.1,+ON,.2)),"^",3)
"RTN","PSIVOREN",29,0)
 I ON["V" S OLDON=ON,NOO=$P($G(^PS(55,DFN,"IV",+ON,.2)),"^",5)
"RTN","PSIVOREN",30,0)
 I ON["U" S OLDON=$P($G(^PS(55,DFN,5,+ON,0)),U,25)
"RTN","PSIVOREN",31,0)
 I OLDON["P" S OLDON=$P($G(^PS(53.1,+OLDON,0)),U,25)
"RTN","PSIVOREN",32,0)
 I OLDON["V" S ON55=OLDON,X=$G(^PS(55,DFN,"IV",+OLDON,2)),PSJOSTRT=$P(X,U,7),OSTOP=$S(($G(PSJOSTOP)>PSJOSTRT):PSJOSTOP,1:$P($G(^(0)),U,3)),DIE=DIE_"""IV"",",DR="100////A",PSIVACT=1
"RTN","PSIVOREN",33,0)
 I OLDON["U" S X=$G(^PS(55,DFN,5,+OLDON,2)),PSJOSTRT=$P(X,U,7),OSTOP=$P(X,U,4),DIE=DIE_"5,"
"RTN","PSIVOREN",34,0)
 S NSTOP=+$S($G(P(3)):P(3),1:0),DA=+OLDON,DA(1)=DFN I 'NSTOP W !,"CAN'T RENEW THIS ORDER!" D PAUSE^VALM1 Q
"RTN","PSIVOREN",35,0)
 ;I OSTOP>NSTOP W !,"NEW STOP DATE IS LESS THAN PREVIOUS STOP DATE" D PAUSE^VALM1
"RTN","PSIVOREN",36,0)
 ;
"RTN","PSIVOREN",37,0)
 I ON["V"!(ON["P") D EXPOE^PSGOER(DFN,ON)
"RTN","PSIVOREN",38,0)
 ;
"RTN","PSIVOREN",39,0)
 S DR=DR_";"_$S(OLDON["V":.03,OLDON["U":34,1:25)_"////"_NSTOP_";"_$S(OLDON["V":"114////@;123////@",1:"105////@;107////@") S:+$G(P(6))?1.30N DR=DR_";.06////"_+P(6) D ^DIE
"RTN","PSIVOREN",40,0)
 I ON["P" S DIE="^PS(53.1,",DR="28////A;105////@;",DA=+ON D ^DIE D
"RTN","PSIVOREN",41,0)
 .I $G(OLDON)["V" S PSGOLDOE=$P($G(^PS(55,DFN,"IV",+OLDON,0)),"^",21)
"RTN","PSIVOREN",42,0)
 .N NOEORD,VN,VNDT S NOEORD=$P(^PS(53.1,+ON,0),U,21) S VN=$P($G(^PS(53.1,+ON,4)),"^") I VN S VNDT=$P($G(^PS(53.1,+ON,4)),"^",2)
"RTN","PSIVOREN",43,0)
 .I NOEORD K DA,DR,DIE S DIE="^PS(55,"_DFN_",""IV"",",DA(1)=DFN,DA=+ON55,DR="110////"_+NOEORD D
"RTN","PSIVOREN",44,0)
 ..S DR=DR_";16////"_$S($G(VN):VN,1:"@")_";17////"_$S($G(VNDT):VNDT,1:"@")_";" D ^DIE I NOEORD[";" S $P(^PS(53.1,+ON,0),U,21)=NOEORD
"RTN","PSIVOREN",45,0)
 ..I $G(VN) D EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSIVOREN",46,0)
 I ON["V" S DIE="^PS(55,DFN,""IV"",",DR="100////A;114////@;16////@;17////@" S DA=+ON55 D ^DIE
"RTN","PSIVOREN",47,0)
 N RDT S RDT=$P($G(@("^PS(53.1,"_+ON_",14,0)")),U,3) S:RDT RDT=+(^(RDT,0)) S RDT=$S(RDT:RDT,1:$$DATE^PSJUTL2) I RDT D UPDREN^PSIVOPT2(DFN,OLDON,RDT,+P(6),+$G(OSTOP),$G(NOO))
"RTN","PSIVOREN",48,0)
 ;
"RTN","PSIVOREN",49,0)
 I ON["V" D EN1^PSJHL2(DFN,"SN",ON,"NEW ORDER CREATED")
"RTN","PSIVOREN",50,0)
 I OLDON["V" S (ON,ON55)=OLDON,PSIVAL="",PSIVALCK="STOP",(P("FRES"),PSIVREA)="R" D LOG^PSIVORAL D
"RTN","PSIVOREN",51,0)
 .I $G(ON55),$G(OSTOP),$G(DFN) D STIX(OSTOP,OLDON,DFN)
"RTN","PSIVOREN",52,0)
 .I $G(PSJOSTOP),$G(NSTOP) I NSTOP=$P($G(^PS(55,DFN,"IV",+ON55,0)),"^",3),$D(^PS(55,"AIV",NSTOP,DFN,+ON55)) K ^PS(55,"AIV",PSJOSTOP,DFN,+ON55)
"RTN","PSIVOREN",53,0)
 D:'$D(PSJIVORF) ORPARM Q:'PSJIVORF
"RTN","PSIVOREN",54,0)
 Q
"RTN","PSIVOREN",55,0)
 ;
"RTN","PSIVOREN",56,0)
RUPTXT(DFN,OLDON) ;
"RTN","PSIVOREN",57,0)
 ;Update ORTX( in OE/RR
"RTN","PSIVOREN",58,0)
 I OLDON'["V" ;; D ENUDTX^PSJOREN(DFN,OLDON,"OR") S ORIFN=$P($G(^PS(55,DFN,"IV",+OLDON,0)),U,21)
"RTN","PSIVOREN",59,0)
 I OLDON["V" S P("FRES")="R" D GTPC^PSIVORFB(OLDON),SORTX^PSIVORFE S ORIFN=$P($G(^PS(55,DFN,"IV",+OLDON,0)),U,21)
"RTN","PSIVOREN",60,0)
 ;; F X=0:0 S X=$O(ORTX(X)) Q:'X  S ORETURN("ORTX",X)=ORTX(X)
"RTN","PSIVOREN",61,0)
 Q
"RTN","PSIVOREN",62,0)
 ;
"RTN","PSIVOREN",63,0)
ORPARM ;Check if inpatient pkges are on.
"RTN","PSIVOREN",64,0)
 S (PSJORF,PSJIVORF)=1
"RTN","PSIVOREN",65,0)
 Q
"RTN","PSIVOREN",66,0)
 ;
"RTN","PSIVOREN",67,0)
NATURE ; Ask nature of order.
"RTN","PSIVOREN",68,0)
 I '+$G(PSJSYSU) S P("NAT")="W" Q
"RTN","PSIVOREN",69,0)
 K P("NAT") NEW X
"RTN","PSIVOREN",70,0)
 I $D(XQORNOD(0)) S X=$E($P(XQORNOD(0),U,3),1,1) S:X="" X="E"
"RTN","PSIVOREN",71,0)
 ;* S:'$D(X) X="N" S:X="A" X="E"
"RTN","PSIVOREN",72,0)
 S:'$D(X) X="N" S:"AF"[X X="E"
"RTN","PSIVOREN",73,0)
 I $G(PSIVCOPY) S X="N"
"RTN","PSIVOREN",74,0)
 S P("NAT")=$$ENNOO^PSJUTL5(X)
"RTN","PSIVOREN",75,0)
 K:P("NAT")=-1 P("NAT")
"RTN","PSIVOREN",76,0)
 Q
"RTN","PSIVOREN",77,0)
CLINIC ;Ask clinic where outpt is being seen for DSS
"RTN","PSIVOREN",78,0)
 K P("CLIN") NEW X1,X2,X,PSJDT,DIC,Y
"RTN","PSIVOREN",79,0)
 S X1=DT,X2=-7 D C^%DTC S PSJDT=X
"RTN","PSIVOREN",80,0)
 S DIC("S")="I $P($G(^SC(Y,0)),U,3)=""C"",$S('$P($G(^(""I"")),U):1,($P($G(^(""I"")),U)>PSJDT):1,(($P($G(^(""I"")),U)<PSJDT)&($P($G(^(""I"")),U,2)]"""")&(DT>$P($G(^(""I"")),U,2))):1,1:0)"
"RTN","PSIVOREN",81,0)
 S DIC=44,DIC(0)="QEAZ",DIC("A")="Select CLINIC LOCATION: " D ^DIC
"RTN","PSIVOREN",82,0)
 I $S($D(DTOUT):1,$D(DUOUT):1,1:0) Q
"RTN","PSIVOREN",83,0)
 S:+Y>0 P("CLIN")=+Y,$P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=+Y
"RTN","PSIVOREN",84,0)
 Q
"RTN","PSIVOREN",85,0)
 ;
"RTN","PSIVOREN",86,0)
STIX(OST,OON,DFN) ; Check start index, cleanup old start
"RTN","PSIVOREN",87,0)
 I $G(OST),$G(OON) S OS="" F  S OS=$O(^PS(55,DFN,"IV","AIS",OS)) Q:'OS  D
"RTN","PSIVOREN",88,0)
 . Q:'$D(^PS(55,DFN,"IV","AIS",OS,+OON))
"RTN","PSIVOREN",89,0)
 . I $P($G(^PS(55,DFN,"IV",+OON,0)),"^",3)'=OS K ^PS(55,DFN,"IV","AIS",OS,+OON)
"RTN","PSIVOREN",90,0)
 Q
"RTN","PSIVSP")
0^16^B34083635
"RTN","PSIVSP",1,0)
PSIVSP ;BIR/RGY,PR,CML3-DOSE PROCESSOR ;09 Feb 99 / 12:30 PM
"RTN","PSIVSP",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**30,37,41,50,56,74,83,111,133**;16 DEC 97
"RTN","PSIVSP",3,0)
 ;
"RTN","PSIVSP",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVSP",5,0)
 ;
"RTN","PSIVSP",6,0)
EN ;
"RTN","PSIVSP",7,0)
 Q:'$D(X)
"RTN","PSIVSP",8,0)
 ;/S (PSIVAT,PSIVWAT,Y)="",XT=-1,X0=X,X=$S(X="ON CALL":X,X["ONE ":X,1:$P(X," "))
"RTN","PSIVSP",9,0)
 S ATZERO=0 I X["@",$P(X,"@",2)=0 S ATZERO=1,X=$P(X,"@")
"RTN","PSIVSP",10,0)
 D EN^PSGS0 S (P(9),PSIVSC1)=$S($G(X)]"":X,1:$G(P(9))),P(11)=$S($G(PSGS0Y):PSGS0Y,1:$G(P(11))),(XT,P(15))=$S(($G(PSGS0XT)!($G(PSGS0XT)="D")):$G(PSGS0XT),1:$G(P(15)))
"RTN","PSIVSP",11,0)
 I $G(ATZERO) S P(7)=1
"RTN","PSIVSP",12,0)
 K ATZERO Q
"RTN","PSIVSP",13,0)
EN1 ;
"RTN","PSIVSP",14,0)
 S (PSIVAT,PSIVWAT,Y)="",XT=-1,X0=X,X=$S(X="ON CALL":X,X="ONCALL":X,X="ON-CALL":X,X="ONETIME":X,X="ONE-TIME":X,X="ONE TIME":X,X="1TIME":X,X="1 TIME":X,X="1-TIME":X,$L(X," ")<3:$P(X," "),1:$P(X," ",1,2))
"RTN","PSIVSP",15,0)
 S:$E(X)="^" X=$E(X,2,999) G:X="" Q S:X["@0" ATZERO=1 S X=$S(X["@0":$P(X,"@"),1:X),P(7)=$S($D(ATZERO):1,1:"") K ATZERO
"RTN","PSIVSP",16,0)
 ;;I X0["@",$P(X0,"@",2)'=0 K X Q
"RTN","PSIVSP",17,0)
 I $S($D(^PS(51.1,"AC","PSJ",X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC I Y'<0 G SH
"RTN","PSIVSP",18,0)
 ;;I $S(X="NOW":1,X="ONCE":1,X="STAT":1,X="ONE-TIME":1,X="ONE TIME":1,1:0) S XT=0,Y(0)=X G SH
"RTN","PSIVSP",19,0)
NS0 S Y=""
"RTN","PSIVSP",20,0)
 I $E(X,1,2)="AD" S XT=-1 Q
"RTN","PSIVSP",21,0)
 I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S XT=1440\$F("BTQ",$E(X))
"RTN","PSIVSP",22,0)
 E  S:$E(X)="Q" X=$E(X,2,99) S:'X X=$E(X)["O"+1_X S I=+X,X=$P(X,I,2),XT=I*$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:0),X=X0 D 
"RTN","PSIVSP",23,0)
 . I 'XT,X'="NOW",X'="STAT",X'="ONCE",X'="ONE-TIME",X'="ONE TIME",X'="ONETIME",X'="1-TIME",X'="1 TIME",X'="1TIME",Y="" S XT=-1
"RTN","PSIVSP",24,0)
SH ;
"RTN","PSIVSP",25,0)
 I +Y<1,$E(X0)'="^" W:$G(ON)'["P" "  ",$S(XT=0&($S("^NOW^STAT^ONCE^ONE-TIME^ONETIME^1TIME^1-TIME^"[(U_$P(X," ")_U):1,X["1 TIME":1,1:X["ONE TIME")):"(ONCE ONLY)",XT>0:"Nonstandard schedule",XT<0:"",1:"(??)") W:XT>0 " (",XT," MINUTES)"
"RTN","PSIVSP",26,0)
Q Q:X="ONE TIME"
"RTN","PSIVSP",27,0)
 N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 K X0 S:$G(P(7)) XT="" Q
"RTN","PSIVSP",28,0)
 ;N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 K X0 S:$G(P(7)) XT="" Q
"RTN","PSIVSP",29,0)
 ;S X0=X K:XT<0!($L(X0)>22) X S:$D(X) X=X0 K X0 S:$G(P(7)) XT="" Q
"RTN","PSIVSP",30,0)
NEWQ ;N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 S:P(7) X=X0 K X0 K:XT>0&('P(7)) X Q
"RTN","PSIVSP",31,0)
 Q
"RTN","PSIVSP",32,0)
 ;
"RTN","PSIVSP",33,0)
ENDL W "   Dose limit ....  " S PSIVMIN=P(15)*X,PSIVSD=+P(2)
"RTN","PSIVSP",34,0)
 I PSIVMIN<0 W !!," --- There is something wrong with this order !!",!,"     Call inpatient supervisor ....." S Y=-1 K PSIVMIN Q
"RTN","PSIVSP",35,0)
 I P(4)="P"!(P(5))!(P(23)="P"),PSIVMIN=0,"^NOW^STAT^ONCE^ONE-TIME^ONE TIME^ON CALL^ONETIME^1TIME^1 TIME^1-TIME^"'[(U_P(9)_U) D DLP G QDL
"RTN","PSIVSP",36,0)
 D ENT^PSIVWL
"RTN","PSIVSP",37,0)
QDL I $D(X) S X=Y X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2) S Y=X
"RTN","PSIVSP",38,0)
 Q
"RTN","PSIVSP",39,0)
DLP ;
"RTN","PSIVSP",40,0)
 S X=X+1,$P(PSIVSD,".",2)=$P(PSIVSD,".",2)_$E("0000",1,4-$L($P(PSIVSD,".",2))) D CHK S X2=0,Y=1 I X<2 S Y=+PSIVSD G QDLP
"RTN","PSIVSP",41,0)
 I $P(PSIVSD,".",2)>$P(P(11),"-",$L(P(11),"-")) S X2=1 G OV
"RTN","PSIVSP",42,0)
 G:$P(P(11),"-")>$P(PSIVSD,".",2) OV
"RTN","PSIVSP",43,0)
 F Y=1:1 S X1=$P(P(11),"-",Y) I X1=$P(PSIVSD,".",2)!($P(PSIVSD,".",2)<X1) Q
"RTN","PSIVSP",44,0)
OV I P(11)="" W $C(7)," ???",!?15,"*** You have not defined any administration times !!" K X Q
"RTN","PSIVSP",45,0)
 F Y=Y:1 S:$P(P(11),"-",Y)="" X2=X2+1,Y=0,X=X+1 S X=X-1 Q:X<1
"RTN","PSIVSP",46,0)
 S X=PSIVSD\1 I X2>0 S X1=PSIVSD D C^%DTC S X=$P(X,".") ; install with version 17.3 of fileman
"RTN","PSIVSP",47,0)
 S Y=+(X_"."_$P(P(11),"-",Y))
"RTN","PSIVSP",48,0)
QDLP K X1,X2 Q
"RTN","PSIVSP",49,0)
 ;
"RTN","PSIVSP",50,0)
ENI ;
"RTN","PSIVSP",51,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X)!'$D(P(4)) Q
"RTN","PSIVSP",52,0)
 I P(4)="P"!(P(5))!(P(23)="P") Q:'X  S X="INFUSE OVER "_X_" MIN." W "   ",X Q
"RTN","PSIVSP",53,0)
 I X'=+X,($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",54,0)
 S SPSOL=$O(DRG("SOL",0)) I 'SPSOL K SPSOL,X W "  You must define at least one solution !!" Q
"RTN","PSIVSP",55,0)
 I X=+X S X=X_" ml/hr" W " ml/hr" D SPSOL S P(15)=$S('X:0,1:SPSOL\X*60+(SPSOL#X/X*60+.5)\1) K SPSOL Q
"RTN","PSIVSP",56,0)
 S SPSOL=$P(X,"@",2) S:$P(X,"@")=+X $P(X,"@")=$P(X,"@")_" ml/hr" W "   ",+SPSOL," Label",$S(SPSOL'=1:"s",1:"")," per day",!?15,"at an infusion rate of: ",$P(X,"@") S P(15)=$S('SPSOL:0,1:1440/SPSOL\1) K SPSOL
"RTN","PSIVSP",57,0)
 Q
"RTN","PSIVSP",58,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(DRG("SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(DRG("SOL",XXX),U,3)
"RTN","PSIVSP",59,0)
 K XXX Q
"RTN","PSIVSP",60,0)
CHK F Y=1:1 Q:$L(P(11))>240!($P(P(11),"-",Y)="")  S $P(P(11),"-",Y)=$P(P(11),"-",Y)_$E("0000",1,4-$L($P(P(11),"-",Y)))
"RTN","PSIVSP",61,0)
 Q
"RTN","PSIVSP",62,0)
 ;
"RTN","PSIVSP",63,0)
DIC ; 51.1 look-up
"RTN","PSIVSP",64,0)
 N PSJSCH S PSJSCH=X I '$D(WSCHADM) N VAIP D IN5^VADPT S WSCHADM=VAIP(5),X=PSJSCH
"RTN","PSIVSP",65,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(NOECH))_"ISZ"
"RTN","PSIVSP",66,0)
 S DIC("W")="W ""  "","_$S('$D(WSCHADM):"$P(^(0),""^"",2)",'+WSCHADM:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+WSCHADM,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ" S:$D(PSIVSPQF) DIC(0)=DIC(0)_"O"
"RTN","PSIVSP",67,0)
 D IX^DIC K DIC
"RTN","PSIVSP",68,0)
 S:$D(DIE)#2 DIC=DIE Q:Y<0
"RTN","PSIVSP",69,0)
 S X=Y(0,0),ZZY=Y,(XT,Y)="" I $D(WSCHADM),$D(^PS(51.1,+ZZY,1,+WSCHADM,0)),$P(^(0),"^",2)]"" S (PSIVWAT,Y)=$P(^(0),"^",2)
"RTN","PSIVSP",70,0)
 K ZZY,WSCHADM S:Y="" (X,PSIVSC1)=$P(Y(0),U),(PSIVAT,Y)=$P(Y(0),"^",2) S XT=$P(Y(0),"^",3) Q
"RTN","PSIVSP",71,0)
 ;
"RTN","PSIVSP",72,0)
ORINF ;  OERR input transform for Infusion Rate
"RTN","PSIVSP",73,0)
 ;  X=data
"RTN","PSIVSP",74,0)
 N INFUSE
"RTN","PSIVSP",75,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X) Q
"RTN","PSIVSP",76,0)
 I X?.E1L.E S INFUSE=$$ENLU^PSGMI(X) Q:(INFUSE="TITRATE")!(INFUSE="BOLUS")
"RTN","PSIVSP",77,0)
 Q:(X="TITRATE")!(X="BOLUS")
"RTN","PSIVSP",78,0)
 I X["=" D  Q   ; NOIS LOU-0501-42191
"RTN","PSIVSP",79,0)
 .N X2,X1 S X1=$P(X,"="),X2=$P(X,"=",2)
"RTN","PSIVSP",80,0)
 .I X1["ML/HR",(+X1=$P(X1,"ML/HR"))!(+X1=$P(X1," ML/HR")) D
"RTN","PSIVSP",81,0)
 ..S X1=$TR(X1,"ML/HR","ml/hr")
"RTN","PSIVSP",82,0)
 .I X2["ML/HR",(+X2=$P(X2,"ML/HR"))!(+X2=$P(X2," ML/HR")) D
"RTN","PSIVSP",83,0)
 ..S X2=$TR(X2,"ML/HR","ml/hr")
"RTN","PSIVSP",84,0)
 .I X1[" ml/hr",(+X1=$P(X1," ml/hr")) D
"RTN","PSIVSP",85,0)
 ..S X1=$P(X1," ml/hr")_$P(X1," ml/hr",2,9999)
"RTN","PSIVSP",86,0)
 .I X2[" ml/hr",(+X2=$P(X2," ml/hr")) D
"RTN","PSIVSP",87,0)
 ..S X2=$P(X2," ml/hr")_$P(X2," ml/hr",2,9999)
"RTN","PSIVSP",88,0)
 .I X1["ml/hr",(+X1=$P(X1,"ml/hr")) D
"RTN","PSIVSP",89,0)
 ..S X1=$P(X1,"ml/hr")_$P(X1,"ml/hr",2,9999)
"RTN","PSIVSP",90,0)
 .I X2["ml/hr",(+X2=$P(X2,"ml/hr")) D
"RTN","PSIVSP",91,0)
 ..S X2=$P(X2,"ml/hr")_$P(X2,"ml/hr",2,9999)
"RTN","PSIVSP",92,0)
 .I X2'=+X2 D
"RTN","PSIVSP",93,0)
 ..I ($P(X2,"@",2,999)'=+$P(X2,"@",2,999)!(+$P(X2,"@",2,999)<0)) K X Q
"RTN","PSIVSP",94,0)
 .I X1=+X1 S X1=X1_" ml/hr"
"RTN","PSIVSP",95,0)
 .I X2=+X2 S X2=X2_" ml/hr"
"RTN","PSIVSP",96,0)
 .S:$P(X2,"@")=+X2 $P(X2,"@")=$P(X2,"@")_" ml/hr"
"RTN","PSIVSP",97,0)
 .S X=X1_"="_X2
"RTN","PSIVSP",98,0)
 I X["ML/HR",(+X=$P(X,"ML/HR"))!(+X=$P(X," ML/HR")) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",99,0)
 I X[" ml/hr",+X=$P(X," ml/hr") S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",100,0)
 I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",101,0)
 I X'=+X,($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",102,0)
 I X=+X S X=X_" ml/hr" Q
"RTN","PSIVSP",103,0)
 S:$P(X,"@")=+X $P(X,"@")=$P(X,"@")_" ml/hr"
"RTN","PSIVSP",104,0)
 Q
"RTN","PSIVUTL")
0^2^B27771040
"RTN","PSIVUTL",1,0)
PSIVUTL ;BIR/MLM-IV UTILITIES ;07 SEP 97 / 2:17 PM 
"RTN","PSIVUTL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**69,58,81,85,110,133**;16 DEC 97
"RTN","PSIVUTL",3,0)
 ;
"RTN","PSIVUTL",4,0)
 ; Reference to ^DD("DD" is supported by DBIA 10017.
"RTN","PSIVUTL",5,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSIVUTL",6,0)
 ; Reference to ^PS(52.6 is supported y DBIA 1231.
"RTN","PSIVUTL",7,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVUTL",8,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSIVUTL",9,0)
 ; Reference to ^DIC is supported by DBIA 10006.
"RTN","PSIVUTL",10,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177.
"RTN","PSIVUTL",11,0)
 ;
"RTN","PSIVUTL",12,0)
DRGSC(Y,PSJSCT) ; Called to set DIC("S") when selecting  Orderable Items.
"RTN","PSIVUTL",13,0)
 N OK,ND,NDU,NDI S OK=0
"RTN","PSIVUTL",14,0)
 S ND=$G(^PS(50.7,+Y,0))
"RTN","PSIVUTL",15,0)
 ;I $P(ND,U,3) S OK=$S('$P(ND,U,4):1,$P(ND,U,4)>DT:1,1:0)
"RTN","PSIVUTL",16,0)
 S OK=$S('$P(ND,U,4):1,$P(ND,U,4)>DT:1,1:0)
"RTN","PSIVUTL",17,0)
 Q OK
"RTN","PSIVUTL",18,0)
 ;
"RTN","PSIVUTL",19,0)
IVDRGSC(Y) ; Set DIC("S") for IV additive/solution selection.
"RTN","PSIVUTL",20,0)
 ; Naked reference below refers to full reference in Y, which is either ^PS(52.6, or ^PS(52.7
"RTN","PSIVUTL",21,0)
 N Y S Y="S X(1)=$G(^(0)),X(2)=$G(^(""I"")) I $S('X(2):1,X(2)>DT:1,1:0),$D(^PSDRUG(+$P(X(1),U,2),0)) S X(2)=$G(^(""I"")) I $S('+$P(X(1),U,11):0,'X(2):1,X(2)>DT:1,1:0)"
"RTN","PSIVUTL",22,0)
 Q Y
"RTN","PSIVUTL",23,0)
 ;
"RTN","PSIVUTL",24,0)
ENU(Y) ;Get IV additive strength.
"RTN","PSIVUTL",25,0)
 N X S X=$P(^PS(52.6,+Y,0),U,3),Y=$$CODES^PSIVUTL(X,52.6,2)
"RTN","PSIVUTL",26,0)
 Q Y
"RTN","PSIVUTL",27,0)
 ;
"RTN","PSIVUTL",28,0)
CODES(PSJCD,PSJF,PSJFLD) ; Get name from code. 
"RTN","PSIVUTL",29,0)
 ; PSJF = one of following files: ^PS(55, ^PS(53.1, ^PS(52.6
"RTN","PSIVUTL",30,0)
 D FIELD^DID(PSJF,PSJFLD,"","POINTER","PSJDD")
"RTN","PSIVUTL",31,0)
 S Y=$G(PSJDD("POINTER")) K PSJDD
"RTN","PSIVUTL",32,0)
 S Y=$P($P(";"_Y,";"_PSJCD_":",2),";")
"RTN","PSIVUTL",33,0)
 Q Y
"RTN","PSIVUTL",34,0)
 ;
"RTN","PSIVUTL",35,0)
CODES1(PSJCD,PSJF,PSJFLD)       ;Check to see if code is valid.
"RTN","PSIVUTL",36,0)
 ; PSJF = one of following files: ^PS(55, ^PS(53.1, ^PS(52.6
"RTN","PSIVUTL",37,0)
 D FIELD^DID(PSJF,PSJFLD,"","POINTER","PSJDD")
"RTN","PSIVUTL",38,0)
 I PSJDD("POINTER")'[PSJCD_":"  K PSJDD Q 0
"RTN","PSIVUTL",39,0)
 K PSJDD Q 1
"RTN","PSIVUTL",40,0)
 ;
"RTN","PSIVUTL",41,0)
CODES2(PSJF,PSJFLD)     ;Get field name
"RTN","PSIVUTL",42,0)
 ; PSJF = one of following files: ^PS(55, ^PS(53.1, ^PS(52.6
"RTN","PSIVUTL",43,0)
 D FIELD^DID(PSJF,PSJFLD,"","LABEL","PSJDD")
"RTN","PSIVUTL",44,0)
 Q PSJDD("LABEL")
"RTN","PSIVUTL",45,0)
 ;
"RTN","PSIVUTL",46,0)
GTPCI(Y) ; Set up "work" area for provider comments.
"RTN","PSIVUTL",47,0)
 N DIC,DINUM,DLAYGO,X S DIC="^PS(53.45,",DIC(0)="LNZ",DLAYGO=53.45,(DINUM,X)=+DUZ D ^DIC
"RTN","PSIVUTL",48,0)
 Q Y
"RTN","PSIVUTL",49,0)
 ;
"RTN","PSIVUTL",50,0)
WDTE(Y) ; Format and print date.
"RTN","PSIVUTL",51,0)
 I 'Y S Y="******"
"RTN","PSIVUTL",52,0)
 E  X ^DD("DD") S Y=$P(Y,"@")_" "_$P($P(Y,"@",2),":",1,2)
"RTN","PSIVUTL",53,0)
 Q Y
"RTN","PSIVUTL",54,0)
GTOT(Y) ; Get order type & protocol
"RTN","PSIVUTL",55,0)
 S P("OT")=$S(Y="A":"F",Y="H":"H",1:"I")
"RTN","PSIVUTL",56,0)
 I P("OT")="F" F DRGT="AD","SOL" F DRGI=0:0 S DRGI=$O(DRG(DRGT,DRGI)) Q:'DRGI  I '$P(DRG(DRGT,DRGI),U,5) S P("OT")="I" Q
"RTN","PSIVUTL",57,0)
 Q
"RTN","PSIVUTL",58,0)
 ;
"RTN","PSIVUTL",59,0)
PIV(ON) ; Display IV orders.
"RTN","PSIVUTL",60,0)
 N DRG,ON55,P,PSJORIFN,TYP,X,Y S TYP="?" I ON["V" D
"RTN","PSIVUTL",61,0)
 .S Y=$G(^PS(55,DFN,"IV",+ON,0)) F X=2,3,4,5,8,9,17,23 S P(X)=$P(Y,U,X)
"RTN","PSIVUTL",62,0)
 .S TYP=$$ONE^PSJBCMA(DFN,ON,P(9),P(2),P(3)) I TYP'="O" S TYP="C"
"RTN","PSIVUTL",63,0)
 .S ON55=ON,P("OT")=$S(P(4)="A":"F",P(4)="H":"H",1:"I") D GTDRG^PSIVORFB,GTOT^PSIVUTL(P(4))
"RTN","PSIVUTL",64,0)
 .W $S($P($G(^PS(55,DFN,"IV",+ON,.2)),U,4)="D":" d",1:"  ")
"RTN","PSIVUTL",65,0)
 .S X=$G(^PS(55,DFN,"IV",+ON,4)) I +PSJSYSU,'+$P(X,U,$S(+PSJSYSU=3:4,1:++PSJSYSU)) W "->"
"RTN","PSIVUTL",66,0)
 I ON=+ON N O S O="" F  S O=$O(^PS(53.1,"ACX",ON,O)) Q:O=""  D
"RTN","PSIVUTL",67,0)
 . S (P(2),P(3))="",P(17)=$P($G(^PS(53.1,+O,0)),U,9),Y=$G(^(8)),P(4)=$P(Y,U),P(8)=$P(Y,U,5),P(9)=$P($G(^(2)),U) D GTDRG^PSIVORFA,GTOT^PSIVUTL(P(4)) D PIV(O_"P") W !
"RTN","PSIVUTL",68,0)
 I ON["P" S (P(2),P(3))="",P(17)=$P($G(^PS(53.1,+ON,0)),U,9),Y=$G(^(8)),P(4)=$P(Y,U),P(8)=$P(Y,U,5),P(9)=$P($G(^(2)),U) D GTDRG^PSIVORFA,GTOT^PSIVUTL(P(4)) I $E(P("OT"))="I" D  Q
"RTN","PSIVUTL",69,0)
 . NEW MARX,PSIVX D DRGDISP^PSJLMUT1(PSGP,+ON_"P",40,54,.MARX,0)
"RTN","PSIVUTL",70,0)
 . F PSIVX=0:0 S PSIVX=$O(MARX(PSIVX)) Q:'PSIVX  W @($S(PSIVX=1:"?9",1:"!?11")),MARX(PSIVX) D:PSIVX=1 PIV1
"RTN","PSIVUTL",71,0)
 NEW DRGX S DRGX=0 F  S DRGX=$O(DRG("AD",DRGX)) Q:'DRGX  D PIVAD
"RTN","PSIVUTL",72,0)
SOL ;
"RTN","PSIVUTL",73,0)
 NEW NAME
"RTN","PSIVUTL",74,0)
 S DRGX=0 F  S DRGX=$O(DRG("SOL",DRGX)) Q:'DRGX  D
"RTN","PSIVUTL",75,0)
 . D NAME(DRG("SOL",DRGX),39,.NAME,0)
"RTN","PSIVUTL",76,0)
 . W:($D(DRG("AD",1))!(DRGX>1)) ! W:DRGX=1 ?9,"in "
"RTN","PSIVUTL",77,0)
 . F X=0:0 S X=$O(NAME(X)) Q:'X  W ?12 W NAME(X) I X=1,DRGX=1,'$D(DRG("AD",1)) D PIV1
"RTN","PSIVUTL",78,0)
 Q
"RTN","PSIVUTL",79,0)
PIVAD ; Print IV Additives.
"RTN","PSIVUTL",80,0)
 NEW NAME,PSGX
"RTN","PSIVUTL",81,0)
 D NAME(DRG("AD",DRGX),39,.NAME,1)
"RTN","PSIVUTL",82,0)
 F PSGX=0:0 S PSGX=$O(NAME(PSGX)) Q:'PSGX  W:(DRGX'=1!(PSGX'=1)) ! W ?9,NAME(PSGX) I PSGX=1,DRGX=1 D PIV1
"RTN","PSIVUTL",83,0)
 Q
"RTN","PSIVUTL",84,0)
 ;
"RTN","PSIVUTL",85,0)
PIV1 ; Print Sched type, start/stop dates, and status.
"RTN","PSIVUTL",86,0)
 F X=2,3 S P(X)=$E($$ENDTC^PSGMI(P(X)),1,$S($D(PSJEXTP):8,1:5))
"RTN","PSIVUTL",87,0)
 I '$D(PSJEXTP) W ?50,TYP,?53,P(2),?60,P(3),?67,P(17) Q
"RTN","PSIVUTL",88,0)
 W ?50,TYP,?53,P(2),?63,P(3),?73,P(17)
"RTN","PSIVUTL",89,0)
 Q
"RTN","PSIVUTL",90,0)
59 ; Validate the Infusion rate entered using IV Quick order code.
"RTN","PSIVUTL",91,0)
 N I F I=2,3,5,7,8,9,11,15,23 S P(I)=""
"RTN","PSIVUTL",92,0)
 S P(4)="A",P(8)=$P($G(^PS(57.1,PSJQO,1)),U,5)
"RTN","PSIVUTL",93,0)
 I $G(^PS(57.1,PSJQO,4,1,0)) S DRG("SOL",1)=^(0),DRG("SOL",0)=1
"RTN","PSIVUTL",94,0)
 I X["?" S F1=53.1,F2=59 D ENHLP^PSIVORC1 G 59
"RTN","PSIVUTL",95,0)
 I X]"" D ENI^PSIVSP S:$D(X) P(8)=X
"RTN","PSIVUTL",96,0)
 Q
"RTN","PSIVUTL",97,0)
WRTDRG(X,L)       ; Format and print drug name, strength and bottle no.
"RTN","PSIVUTL",98,0)
 N Y S Y=" "_$P(X,U,3) S:$P(X,U,4) Y=Y_" ("_$P(X,U,4)_")"
"RTN","PSIVUTL",99,0)
 Q $E($P(X,U,2),1,(L-$L(Y)))_Y
"RTN","PSIVUTL",100,0)
 ;
"RTN","PSIVUTL",101,0)
NAME(X,L,MARX,AD)        ; Format Additive display.
"RTN","PSIVUTL",102,0)
 ;INPUT : X=DRG("AD",DRG)  L=Display length   AD=for Additive(1/0)
"RTN","PSIVUTL",103,0)
 ;OUTPUT: AD(X)  if X=2 that means there is a second line to display
"RTN","PSIVUTL",104,0)
 N Y K MARX S Y=$P(X,U,3) S:(AD&$P(X,U,4)) Y=Y_" ("_$P(X,U,4)_")"
"RTN","PSIVUTL",105,0)
 ;* S:'AD Y=Y_" "_$S(P(4)="P"!($G(P(23))="P")!$G(P(5)):P(9),1:$P(P(8),"@"))
"RTN","PSIVUTL",106,0)
 I 'AD!('$O(DRG("SOL",0))) D
"RTN","PSIVUTL",107,0)
 .I $G(PSJL)["  in" S Y=Y_" "_$S(P(4)="P"!($G(P(23))="P")!$G(P(5)):P(9),1:$P(P(8),"@")) Q
"RTN","PSIVUTL",108,0)
 .I $G(DRGX)]"",DRGX'>1 S Y=Y_"  "_$S(P(4)="P"!($G(P(23))="P")!$G(P(5)):P(9),1:$P(P(8),"@")) Q
"RTN","PSIVUTL",109,0)
 ;I ($L($P(X,U,2))+$L(Y)+1)>L S NAME(1)=$P(X,U,2),NAME(2)="   "_Y Q
"RTN","PSIVUTL",110,0)
 I ($L($P(X,U,2))+$L(Y)+1)>L D TXT^PSGMUTL($P(X,U,2)_" "_Y,L) S:AD MARX(2)="   "_MARX(2) Q
"RTN","PSIVUTL",111,0)
 S MARX(1)=$P(X,U,2)_" "_Y
"RTN","PSIVUTL",112,0)
 Q
"RTN","PSIVUTL",113,0)
 ;
"RTN","PSIVUTL",114,0)
INTERVAL(IVAR) ;
"RTN","PSIVUTL",115,0)
 N P,X,PSGOES M P=IVAR S X=$G(P(9)),PSGOES=1
"RTN","PSIVUTL",116,0)
 D EN^PSIVSP S IVAR(15)=$S($G(P(15)):P(15),1:1440)
"RTN","PSIVUTL",117,0)
 Q IVAR(15)
"RTN","PSIVUTL",118,0)
 ;
"RTN","PSIVUTL",119,0)
DOW(SCHED) ;
"RTN","PSIVUTL",120,0)
 Q:SCHED="" 0
"RTN","PSIVUTL",121,0)
 N P9,PSIVX,X S PSIVX=0 S P9=SCHED
"RTN","PSIVUTL",122,0)
 ; Use schedule validator
"RTN","PSIVUTL",123,0)
 S X=SCHED D DW^PSGS0 I $G(X)="" Q 0
"RTN","PSIVUTL",124,0)
 I +$O(^PS(51.1,"APPSJ",SCHED,0)) S PSIVX=1 S P9=$P(SCHED,"@") F X=1:1:$L(P9,"-") D  Q:'$G(PSIVX)
"RTN","PSIVUTL",125,0)
 . I '("MON,TUE,WED,THU,FRI,SAT,SUN"[$P(P9,"-",X)) S PSIVX=0 Q
"RTN","PSIVUTL",126,0)
 Q:PSIVX +PSIVX
"RTN","PSIVUTL",127,0)
 I '$D(^PS(51.1,"APPSJ",SCHED)) S PSIVX=1,P9=$P(SCHED,"@") F X=1:1:$L(P9,"-") D  Q:'$G(PSIVX)
"RTN","PSIVUTL",128,0)
 . I '(",MO,TU,WE,TH,FR,SA,SU,"[(","_$P(P9,"-",X)_",")) S PSIVX=0 Q
"RTN","PSIVUTL",129,0)
 Q +PSIVX
"RTN","PSJDCU")
0^25^B4000752
"RTN","PSJDCU",1,0)
PSJDCU ;BIR/JLC-DATE CALCULATION UTILITY ;09/07/00
"RTN","PSJDCU",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**47,63,66,69,58,95,127,133**;16 DEC 97
"RTN","PSJDCU",3,0)
 ;
"RTN","PSJDCU",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191
"RTN","PSJDCU",5,0)
 ; Reference to ^PS(59.7 is supported by DBIA# 2181
"RTN","PSJDCU",6,0)
 ; Reference to ^%DTC is supported by DBIA# 10000
"RTN","PSJDCU",7,0)
 ; Reference to ^PSBAPIPM is supported by DBIA# 3564
"RTN","PSJDCU",8,0)
 ;
"RTN","PSJDCU",9,0)
DSTART(PSJDFN,PSJORD) ;calculate default start date
"RTN","PSJDCU",10,0)
 I $G(PSJSPEED) Q ""
"RTN","PSJDCU",11,0)
 I $G(PSJORD)["U",$G(PSGORD)["P" I $P($G(^PS(53.1,+PSGORD,0)),"^",24,25)="R^"_PSJORD Q $P($G(^PS(55,+$G(PSJDFN),5,+PSJORD,2)),"",2)
"RTN","PSJDCU",12,0)
 N LAST,LASTH,NOW,FREQ,X,Y,%H,%T,NEW,SCH,ADM,STOP
"RTN","PSJDCU",13,0)
 S Y=$$EN^PSBAPIPM(PSJDFN,PSJORD)
"RTN","PSJDCU",14,0)
 I Y=""!("GR"'[$P(Y,U,3)) Q ""
"RTN","PSJDCU",15,0)
 S (SCH,X)=$P(Y,U) D H^%DTC S LAST=%H*86400+%T,LASTH=%H_","_%T
"RTN","PSJDCU",16,0)
 D NOW^%DTC S NOW=%
"RTN","PSJDCU",17,0)
 I PSJORD["U" S X=^PS(55,PSJDFN,5,+PSJORD,2),STOP=$P(X,U,4),ADM=$P(X,U,5),FREQ=$P(X,U,6)
"RTN","PSJDCU",18,0)
 I PSJORD["V" S X=^PS(55,PSJDFN,"IV",+PSJORD,0),STOP=$P(X,U,3),ADM=$P(X,U,11),FREQ=$P(X,U,15)
"RTN","PSJDCU",19,0)
 I FREQ="O" Q ""
"RTN","PSJDCU",20,0)
 I ADM="" S SCH="",X=$P(Y,U,2) D H^%DTC S LAST=%H*86400+%T
"RTN","PSJDCU",21,0)
 S FREQ=$S(FREQ="D":1440,FREQ="O":0,1:FREQ)*60
"RTN","PSJDCU",22,0)
 S NEW=LAST+FREQ+$S(SCH]"":0,1:3599),%H=NEW\86400_","_(NEW#86400)
"RTN","PSJDCU",23,0)
 I $P(%H,",",2)<3600 S %H=$S(+%H=+LASTH:+%H,1:%H-1)_",86400"
"RTN","PSJDCU",24,0)
 D YMD^%DTC
"RTN","PSJDCU",25,0)
 S NEW=X_+$E(%,1,3)
"RTN","PSJDCU",26,0)
 I NOW>NEW Q ""
"RTN","PSJDCU",27,0)
 I $G(PSJREN) I ADM]"",NEW>STOP S NEW=STOP
"RTN","PSJDCU",28,0)
 I ADM]"",NEW>STOP Q ""
"RTN","PSJDCU",29,0)
 Q NEW
"RTN","PSJDCU",30,0)
ENOSD(PSJWP,PSJSD,DFN) ;calculate one-time stop date from ward/system parameters
"RTN","PSJDCU",31,0)
 ;Input:  PSJWP - Inpatient Ward Parameters for the patient's ward
"RTN","PSJDCU",32,0)
 ;        PSJSD - Start date for the order
"RTN","PSJDCU",33,0)
 ;        DFN   - Internal entry number for the patient
"RTN","PSJDCU",34,0)
 N PSJOP,PSJST,VAIP,%,I,X,Y,W,Z,E
"RTN","PSJDCU",35,0)
 S PSJWP=$G(PSJWP),PSJSD=$G(PSJSD),DFN=$G(DFN)
"RTN","PSJDCU",36,0)
 D NOW^%DTC I PSJSD="" S PSJSD=%
"RTN","PSJDCU",37,0)
 I DFN]"" S VAIP("D")=% D IN5^VADPT I VAIP(5)="" S PSJWP=""
"RTN","PSJDCU",38,0)
 S PSJOP=$P(PSJWP,"^",28) I PSJOP="" S PSJOP=$P($G(^PS(59.7,1,26)),"^",6)
"RTN","PSJDCU",39,0)
 I PSJOP="" Q ""
"RTN","PSJDCU",40,0)
 S PSJST=$$FMADD^XLFDT(PSJSD,PSJOP)  Q PSJST
"RTN","PSJHL7")
0^9^B50036131
"RTN","PSJHL7",1,0)
PSJHL7 ;BIR/LDT-ACTIONS ON HL7 MESSAGES FROM OE/RR (CONT) ;29 AUG 96 / 11:18 AM
"RTN","PSJHL7",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**42,47,50,70,82,110,127,133**;16 DEC 97
"RTN","PSJHL7",3,0)
 ;
"RTN","PSJHL7",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJHL7",5,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSJHL7",6,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJHL7",7,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJHL7",8,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJHL7",9,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL7",10,0)
 ; Reference to ^SC( is supported by DBIA# 10040.
"RTN","PSJHL7",11,0)
 ; Reference to ^TMP("PSB" is supported by DBIA# 3564.
"RTN","PSJHL7",12,0)
 ; 
"RTN","PSJHL7",13,0)
RENEW ;Renew orders from OE/RR
"RTN","PSJHL7",14,0)
 N PSJSYSW0,PSJSYSW,WRDPTR,PSJOSTOP,Q1,Q2
"RTN","PSJHL7",15,0)
 S PSJSYSW0="",PSJSYSW=0 I $G(LOC) S WRDPTR=$G(^SC(+LOC,42)) S:WRDPTR]"" PSJSYSW=+$O(^PS(59.6,"B",WRDPTR,0)) I PSJSYSW S PSJSYSW0=$G(^PS(59.6,PSJSYSW,0))
"RTN","PSJHL7",16,0)
 I PREON["V" D IVSET G DONE
"RTN","PSJHL7",17,0)
 N ND,ND1,ND2,PSGSI,PSGMR,PSGSM,PSGHSM,PSGST,OIDRG,PSGDO,PSGSCH,PSGSOY,PSGOXT,PSGNEDFD,DRUGS,WAT
"RTN","PSJHL7",18,0)
 S ND=$G(^PS(55,PSJHLDFN,5,+PREON,0)),ND1=$G(^(.2)),ND2=$G(^(2)),PSGSI=$G(^(6)),PSGWLL=$S($P(PSJSYSW0,"^",4):+$G(^PS(55,PSJHLDFN,5.1)),1:0)
"RTN","PSJHL7",19,0)
 I +PSITEM>0,PSITEM'=+$P(ND1,"^") S $P(ND1,"^")=PSITEM
"RTN","PSJHL7",20,0)
 S PSGMR=$P(ND,"^",3),PSGSM=$P(ND,"^",5),PSGHSM=$P(ND,"^",6),PSGST=$P(ND,"^",7),OIDRG=$P(ND1,"^"),PSGDO=$P(ND1,"^",2),DOSE=$P(ND1,"^",5),UNIT=$P(ND1,"^",6),PSGSCH=$P(ND2,"^")
"RTN","PSJHL7",21,0)
 S PSGSOY=$P(ND2,"^",5),PSGOXT=$P(ND2,"^",6),PSGNEDFD=$P($$GTNEDFD^PSGOE7("UI",OIDRG),"^")
"RTN","PSJHL7",22,0)
 S:$P(LOC,"^")'=$P(ND2,"^",10) PSGSOY=$$ENRNAT^PSJHL7($P(ND2,"^",10),+LOC,PSGSCH,PSGSOY)
"RTN","PSJHL7",23,0)
 S X=$O(^PS(55,PSJHLDFN,5,+PREON,1,0)) I X S (Q,Q1)=0 F  S Q=$O(^PS(55,PSJHLDFN,5,+PREON,1,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,$S('$P(ND,"^",3):1,1:$P(ND,"^",3)>DT) S Q1=Q1+1,DRUGS(Q1)=$P(ND,"^",1,3)
"RTN","PSJHL7",24,0)
 S (PSGNESD,PSGNEFD)="" D ENWALL^PSGNE3(PSGNESD,PSGNEFD,PSJHLDFN)
"RTN","PSJHL7",25,0)
 I PSGOXT="D",'PSGSOY S PSGSOY=+$E(PSGNESD_"00011",9,12)
"RTN","PSJHL7",26,0)
 S ND=NEWORDER_U_PROVIDER_U_PSGMR_U_"U"_U_PSGSM_U_PSGHSM_U_PSGST_"^^P^^^^^"_LOGIN_U_PSJHLDFN_U_LOGIN S:PSGNEDFD $P(ND,U,$P(PSGNEDFD,U)["L"+10)=+PSGNEDFD
"RTN","PSJHL7",27,0)
 S $P(ND,U,21)=$P(ORDER,U),$P(ND,U,24,25)=ROC_U_PREON
"RTN","PSJHL7",28,0)
 F X="PSGNESD","PSGNEFD" S:@X]"" @X=+@X
"RTN","PSJHL7",29,0)
 S ND2=PSGSCH_U_PSGNESD_"^^"_PSGNEFD_U_PSGSOY_U_PSGOXT
"RTN","PSJHL7",30,0)
 S F="^PS(53.1,"_NEWORDER_",",@(F_"0)")=ND,^(.2)=OIDRG_U_PSGDO_U_ORDCON_U_PRIORITY_U_DOSE_U_UNIT_U_U_$G(PRNTON),^(2)=ND2 S:$G(PSGSI)]"" ^(6)=PSGSI
"RTN","PSJHL7",31,0)
 I $D(DRUGS) D
"RTN","PSJHL7",32,0)
 .I $D(@(F_"1,0)")) K @(F_"1)")
"RTN","PSJHL7",33,0)
 .; Naked reference below refers to full reference to ^PS(53.1,+NEWORDER in variable F created using indirection.
"RTN","PSJHL7",34,0)
 .I '$D(@(F_"1,0)")) S ^(0)="^53.11P^0^0"
"RTN","PSJHL7",35,0)
 .S JJ=0 F  S JJ=$O(DRUGS(JJ)) Q:'JJ  I $S('$P(DRUGS(JJ),U,3):1,1:$P(DRUGS(JJ),U,3)>DT) S $P(@(F_"1,0)"),"^",3,4)=JJ_"^"_JJ,@(F_"1,"_JJ_",0)")=$P(DRUGS(JJ),U,1,2),@(F_"1,""B"","_+DRUGS(JJ)_","_JJ_")")=""
"RTN","PSJHL7",36,0)
 S PSJOSTOP=$G(@("^PS(55,"_PSJHLDFN_",5,"_+$G(PREON)_",2)")),PSJOSTOP=$P(PSJOSTOP,"^",4)
"RTN","PSJHL7",37,0)
 D REN531(NEWORDER,$P(ND,"^",14),$S($G(PREON)["U":$P(ND,"^",2),1:$P(ND,"^",6)),PSJOSTOP,PSJHLDFN)
"RTN","PSJHL7",38,0)
 ;
"RTN","PSJHL7",39,0)
DONE ;
"RTN","PSJHL7",40,0)
 N DA,DR,DIE,PSIVACT,PSIVALT,ON55,PSIVREA
"RTN","PSJHL7",41,0)
 S DIE=$S(PREON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,"),DA=+PREON,DA(1)=PSJHLDFN,DR=$S(PREON["V":"100////R;123////R;114////"_PSJORDER,1:"28////R;107////R;105////"_PSJORDER)
"RTN","PSJHL7",42,0)
 I PREON["A"!(PREON["U") S PSGAL("C")=18000 D ^PSGAL5
"RTN","PSJHL7",43,0)
 I PREON["V" S PSIVACT=1,PSIVALT=2,ON55=PREON,PSIVREA="R"
"RTN","PSJHL7",44,0)
 D ^DIE
"RTN","PSJHL7",45,0)
 I PREON["V" N DFN S DFN=PSJHLDFN D LOG^PSIVORAL
"RTN","PSJHL7",46,0)
 S PSJHLMTN="ORM" D EN1^PSJHL2(PSJHLDFN,"SC",PREON) S PSJHLMTN="ORR",PSOC="NW"
"RTN","PSJHL7",47,0)
 Q
"RTN","PSJHL7",48,0)
IVSET ;
"RTN","PSJHL7",49,0)
 N DRG,DRGN,P
"RTN","PSJHL7",50,0)
 S P("RES")="R",P("REN")="",Y=$G(^PS(55,PSJHLDFN,"IV",+PREON,0)) F X=1:1:23 S P(X)=$P(Y,U,X)
"RTN","PSJHL7",51,0)
 S P("PON")=PREON,P(21)=$P(ORDER,U),P(6)=PROVIDER_U_$P($G(^VA(200,+PROVIDER,0)),U),(DRG,DRGN)="",P("REM")=$G(^PS(55,PSJHLDFN,"IV",+PREON,1))
"RTN","PSJHL7",52,0)
 S Y=$G(^PS(55,PSJHLDFN,"IV",+PREON,2)),P("LOG")=LOGIN
"RTN","PSJHL7",53,0)
 S P("CLRK")=CLERK_U_$P($G(^VA(200,+CLERK,0)),U),P("RES")=ROC,P("FRES")=$P(Y,U,9),P("SYRS")=$P(Y,U,4),P("OPI")=$G(^PS(55,PSJHLDFN,"IV",+PREON,3))
"RTN","PSJHL7",54,0)
 S ND=$G(^PS(55,PSJHLDFN,"IV",+PREON,.2)),P("PD")=$S($P(ND,U):$P(ND,U)_U_$P($G(^PS(50.7,+ND,0)),U),1:""),P("DO")=$P(ND,U,2)
"RTN","PSJHL7",55,0)
 S P("MR")=$P(ND,U,3),ND=$G(^PS(51.2,+P("MR"),0)),P("MR")=P("MR")_U_$S($P(ND,U,3)]"":$P(ND,U,3),1:$P(ND,U))
"RTN","PSJHL7",56,0)
 D GTDRG
"RTN","PSJHL7",57,0)
 S P("OT")=$S(P(4)="A":"F",P(4)="H":"I",1:"I")
"RTN","PSJHL7",58,0)
 I P("OT")="F" F DRGT="AD","SOL" F DRGI=0:0 S DRGI=$O(DRG(DRGT,DRGI)) Q:'DRGI  I '$P(DRG(DRGT,DRGI),U,5) S P("OT")="I"
"RTN","PSJHL7",59,0)
PUT531 ; Move data in local variables to 53.1
"RTN","PSJHL7",60,0)
 N IVLIM,IVLIMIT S IVLIM=$$GETDUR^PSJLIVMD(PSJHLDFN,+PREON,$E(PREON,$L(PREON)),1) I IVLIM]"",$G(IVLIMIT) S $P(^PS(53.1,+NEWORDER,2.5),U,4)=IVLIM
"RTN","PSJHL7",61,0)
 S ND(0)=+NEWORDER_U_+P(6)_U_$S(+P("MR"):+P("MR"),1:"")_U_P("OT")_U_U_U_"C",$P(ND(0),U,9)="P"
"RTN","PSJHL7",62,0)
 S $P(ND(0),U,14,16)=P("LOG")_U_PSJHLDFN_U_P("LOG"),$P(ND(0),U,21)=P(21),$P(ND(0),U,24,26)=$G(P("RES"))_U_P("PON")
"RTN","PSJHL7",63,0)
 S ND(2)=P(9)_U_U_U_U_P(11)_U_P(15),$P(ND(4),U,7,9)=+P("CLRK")_U_U_P("REN")
"RTN","PSJHL7",64,0)
 S ND(8)=P(4)_U_P(23)_U_P("SYRS")_U_P(5)_U_P(8)_"^^"_P(7),ND(9)=$S($L(P("REM")_P("OPI")):P("REM")_U_P("OPI"),1:"")
"RTN","PSJHL7",65,0)
 F X=0,2,4,8,9 S ^PS(53.1,+NEWORDER,X)=ND(X)
"RTN","PSJHL7",66,0)
 S:+P("PD") ^PS(53.1,+NEWORDER,.2)=+P("PD")_U_P("DO")
"RTN","PSJHL7",67,0)
 S $P(^PS(53.1,+NEWORDER,.2),"^",3,4)=ORDCON_U_PRIORITY
"RTN","PSJHL7",68,0)
 ;I $G(PRNTON) I $$UP^XLFSTR($G(PSGSCH))="NOW" S PRNTON=""
"RTN","PSJHL7",69,0)
 I $G(PRNTON) S $P(^PS(53.1,+NEWORDER,.2),"^",8)=PRNTON
"RTN","PSJHL7",70,0)
 F DRGT="AD","SOL" D:$D(DRG(DRGT)) PTD531
"RTN","PSJHL7",71,0)
 S PSJOSTOP=$G(@("^PS(55,"_PSJHLDFN_",""IV"","_+PREON_",0)")),PSJOSTOP=$P(PSJOSTOP,"^",3) D
"RTN","PSJHL7",72,0)
 .N IVND S IVND=$G(^PS(53.1,+NEWORDER,0)) D REN531(NEWORDER,$P(IVND,"^",14),$P(ND,"^",2),PSJOSTOP,PSJHLDFN)
"RTN","PSJHL7",73,0)
 Q
"RTN","PSJHL7",74,0)
PTD531 ; Move drug data from local array into 53.1
"RTN","PSJHL7",75,0)
 K ^PS(53.1,+NEWORDER,DRGT) S ^PS(53.1,+NEWORDER,DRGT,0)=$S(DRGT="AD":"^53.157PA^0^0",1:"^53.158PA^0^0")
"RTN","PSJHL7",76,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJHL7",77,0)
 .S X1=$P(DRG(DRGT,X),U),Y=^PS(53.1,+NEWORDER,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJHL7",78,0)
 .S ^PS(53.1,+NEWORDER,DRGT,0)=Y,Y=+X1_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^PS(53.1,+NEWORDER,DRGT,+DRG,0)=Y,^PS(53.1,+NEWORDER,DRGT,"B",+X1,+DRG)=""
"RTN","PSJHL7",79,0)
 I $G(P("RES"))="R",($G(ND(0))]"") D REN531(+NEWORDER,$P(ND(0),"^",14),$P(ND(0),"^",2),$G(P(3)),$G(DFN))
"RTN","PSJHL7",80,0)
 Q
"RTN","PSJHL7",81,0)
 ;
"RTN","PSJHL7",82,0)
ENRNAT(OWD,NWD,SC,OAT) ;Determine admin times for renewal orders.
"RTN","PSJHL7",83,0)
 ;OWD=ORIGINAL W,NWD=NEW WD LOCATION, SC=SCHEDULE, OAT=ORDER ADMIN TIMES
"RTN","PSJHL7",84,0)
 N OWAT,SCP,X,Y,OOAT
"RTN","PSJHL7",85,0)
 S OOAT=OAT,SCP=+$O(^PS(51.1,"APPSJ",+SC,0)),WAT=$P($G(^PS(51.1,SCP,1,+$G(OWD),0)),U,2)
"RTN","PSJHL7",86,0)
 F X="WAT","OAT" F Y=1:1 Q:$L(@X)>240!($P(@X,"-",Y)="")  S $P(@X,"-",Y)=$P(@X,"-",Y)_$E("0000",1,4-$L($P(@X,"-",Y)))
"RTN","PSJHL7",87,0)
 I OAT'=WAT Q OOAT
"RTN","PSJHL7",88,0)
 S X=$P($G(^PS(51.1,+SCP,1,NWD,0)),U,2) I X Q X
"RTN","PSJHL7",89,0)
 Q OOAT
"RTN","PSJHL7",90,0)
 ;
"RTN","PSJHL7",91,0)
GTDRG ; Get drug info and place in DRG(. 
"RTN","PSJHL7",92,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,PSJHLDFN,"IV",+PREON,DRGT,Y)) Q:'Y  D
"RTN","PSJHL7",93,0)
 .;Naked reference ^(Y,0) below refers to full global reference ^PS(55,PSJHLDFN,"IV",+PREON,DRGT,Y)) above at GTDRG+1
"RTN","PSJHL7",94,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,DRG(DRGT,0))=$G(DRG(DRGT,0))+1,DRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSJHL7",95,0)
 Q
"RTN","PSJHL7",96,0)
 ;
"RTN","PSJHL7",97,0)
REN531(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSGP) ;
"RTN","PSJHL7",98,0)
 Q:'PSGORD!'PSGDT!'PSGOEPR!'PSGOFD!'PSGP
"RTN","PSJHL7",99,0)
 N DUP,PSGOLDPR I $G(PREON) D  Q:$G(DUP)
"RTN","PSJHL7",100,0)
 .S:$D(^PS(53.1,+PSGORD,14,"B",+PSGDT)) DUP=1 Q
"RTN","PSJHL7",101,0)
 S:$G(PREON)["U" PSGOLDPR=$P($G(^PS(55,PSGP,5,+PREON,0)),"^",2)
"RTN","PSJHL7",102,0)
 S:$G(PREON)["V" PSGOLDPR=$P($G(^PS(55,PSGP,"IV",+PREON,0)),"^",6)
"RTN","PSJHL7",103,0)
 K DR,DA,DIC,DIE,DD,DO S DIC="^PS(53.1,"_+PSGORD_",14,",DIC(0)="L",DIC("P")="53.1114DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=PSGP,DA(1)=+PSGORD D
"RTN","PSJHL7",104,0)
 . S DIC("DR")=".01////"_$G(PSGDT)_";1////"_$G(DUZ)_";2////"_$S($G(PSGOLDPR):$G(PSGOLDPR),1:$G(PSGOEPR))_";3////"_$G(PSGOFD),X=$G(PSGDT) D FILE^DICN
"RTN","PSJHL7",105,0)
 K DO,DINUM
"RTN","PSJHL7",106,0)
 Q
"RTN","PSJHL7",107,0)
 ;
"RTN","PSJHL7",108,0)
CHK(X,Y,Z) ;Check for required fields
"RTN","PSJHL7",109,0)
 ; Input: X="^^"_MED ROUTE_"^^^^"_SCH TYPE
"RTN","PSJHL7",110,0)
 ;        Y=ORDERABLE ITEM_"^"_DOSAGE ORDERED
"RTN","PSJHL7",111,0)
 ;        Z=SCHEDULE_"^"_START DATE/TIME_"^^"_STOP DATE/TIME
"RTN","PSJHL7",112,0)
 S:'$D(^PS(50.7,+Y,0)) CHK=1
"RTN","PSJHL7",113,0)
 I ND="" S CHK=CHK_23
"RTN","PSJHL7",114,0)
 E  S CHK=CHK_$S($P(X,"^",3):"",1:2)_$S($P(X,"^",7)]"":"",1:3)
"RTN","PSJHL7",115,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSJHL7",116,0)
 S:'$$DDOK^PSJHL10("^TMP(""PSB"","_$J_",700,",+Y) CHK=CHK_7
"RTN","PSJHL7",117,0)
 ;
"RTN","PSJHL7",118,0)
CHKM ;
"RTN","PSJHL7",119,0)
 Q:'CHK
"RTN","PSJHL7",120,0)
 N MSG2
"RTN","PSJHL7",121,0)
 S MSG="THE FOLLOWING "_$S($L(CHK)>1:"ARE",1:"IS")_" EITHER INVALID OR MISSING FROM THIS ORDER:" F X=1:1:7 S:CHK[X MSG2=$P("ORDERABLE ITEM^MED ROUTE^SCHEDULE TYPE^SCHEDULE^START DATE/TIME^STOP DATE/TIME^DISPENSE DRUG","^",X)
"RTN","PSJHL7",122,0)
 S PSREASON=MSG_MSG2
"RTN","PSJHL7",123,0)
 Q
"RTN","PSJHLV")
0^23^B21285520
"RTN","PSJHLV",1,0)
PSJHLV ;BIR/CML3-VERIFY (MAKE ACTIVE) ORDERS ;4/8/99  08:16
"RTN","PSJHLV",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**39,42,78,92,127,133**;16 DEC 97
"RTN","PSJHLV",3,0)
 ;
"RTN","PSJHLV",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJHLV",5,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHLV",6,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJHLV",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA# 2789.
"RTN","PSJHLV",8,0)
 ;
"RTN","PSJHLV",9,0)
EN(PSJHLDFN,PSGORD) ;
"RTN","PSJHLV",10,0)
VFY ; change status, move to 55, and change label record
"RTN","PSJHLV",11,0)
 N PSJPWD,VAIP,DFN,PSGP,PSGORDP S (DFN,PSGP)=PSJHLDFN D IN5^VADPT S:VAIP(5)]"" PSJPWD=+VAIP(5) G:VAIP(5)']"" DONE
"RTN","PSJHLV",12,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,4)'="U" D IV Q
"RTN","PSJHLV",13,0)
 N PSJSYSP S PSJSYSP=+NURSEACK
"RTN","PSJHLV",14,0)
 N PSGDT D NOW^%DTC S PSGDT=%
"RTN","PSJHLV",15,0)
 S CHK=0 D DDCHK G:CHK DONE
"RTN","PSJHLV",16,0)
 D CHK($G(^PS(53.1,+PSGORD,0)),$G(^(.2)),$G(^(2)))
"RTN","PSJHLV",17,0)
 G:CHK DONE
"RTN","PSJHLV",18,0)
 S PSGORDP=PSGORD
"RTN","PSJHLV",19,0)
 ;
"RTN","PSJHLV",20,0)
 N PSJRPND0 S PSJRPND0=^PS(53.1,+PSGORD,0) I $P(PSJRPND0,U,24)="R" D
"RTN","PSJHLV",21,0)
 .N PSGORDR,PSJPRIO,PSJSCHED,FILE55N0
"RTN","PSJHLV",22,0)
 .S PSGORDR=$P(PSJRPND0,U,25)
"RTN","PSJHLV",23,0)
 .Q:'$$LS^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJHLV",24,0)
 .N OEORD,OOEORD,FILE55,FILE55N0,FILE55N2 S FILE55="^PS(55,"_PSJHLDFN_$S($P(PSJRPND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)",FILE55N2=FILE55_+PSGORDR_",2)"
"RTN","PSJHLV",25,0)
 .S OEORD=$P(PSJRPND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD N PSGSD S PSGSD=$P(@FILE55N2,"^",2) D
"RTN","PSJHLV",26,0)
 ..D EXPOE^PSGOER(PSJHLDFN,PSGORD,+$$LASTREN^PSJLMPRI(PSJHLDFN,PSGORD))
"RTN","PSJHLV",27,0)
 .K DA,DR,DIE S PSGORDP=PSGORD,DIE="^PS(53.1,",DA=+PSGORD,DR="28////A;104////@" W "." D ^DIE
"RTN","PSJHLV",28,0)
 .D START^PSGOTR(PSGORD,+PSGORDR) I OEORD D
"RTN","PSJHLV",29,0)
 ..K DA,DR,DIE S DA(1)=PSJHLDFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSJHLV",30,0)
 ..D EN1^PSJHL2(PSJHLDFN,"SC",PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJHLV",31,0)
 ..S PSGORD=PSGORDR
"RTN","PSJHLV",32,0)
 ;
"RTN","PSJHLV",33,0)
 S DIE="^PS(53.1,",DA=+PSGORD,DR="28////A" D ^DIE I $P(PSJRPND0,U,24)'="R" D ^PSGOT
"RTN","PSJHLV",34,0)
 S DA=+PSGORD,DA(1)=PSJHLDFN,PSGAL("C")=22010
"RTN","PSJHLV",35,0)
 D ^PSGAL5 S VND4=$G(^PS(55,PSJHLDFN,5,DA,4)) I $P(PSJRPND0,U,24)="R",$P(VND4,U,4) D
"RTN","PSJHLV",36,0)
 .K DA,DIE,DR I $P(VND4,U,4)<$$LASTREN^PSJLMPRI(PSJHLDFN,PSGORDP) S DIE="^PS(55,"_PSJHLDFN_",5,",DA(1)=PSJHLDFN,DA=+PSGORD,DR="18////@;19////@" D ^DIE
"RTN","PSJHLV",37,0)
 .S $P(VND4,U,3,4)=""
"RTN","PSJHLV",38,0)
 S $P(VND4,"^",10)=1
"RTN","PSJHLV",39,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",1,2)=+NURSEACK_"^"_PSGDT,^PS(55,PSJHLDFN,5,+PSGORD,4)=VND4
"RTN","PSJHLV",40,0)
 I '$P(VND4,U,9) S ^PS(55,"APV",PSJHLDFN,+PSGORD)=""
"RTN","PSJHLV",41,0)
 I '$P(VND4,U,10) S ^PS(55,"ANV",PSJHLDFN,+PSGORD)=""
"RTN","PSJHLV",42,0)
 I $P(VND4,U,10) K ^PS(55,"ANV",PSJHLDFN,+PSGORD)
"RTN","PSJHLV",43,0)
 D:$D(PSGORDP) ACTLOG^PSGOEV(PSGORDP,PSJHLDFN,PSGORD)
"RTN","PSJHLV",44,0)
 D EN1^PSJHL2(PSJHLDFN,"SC",+PSGORD_"U")
"RTN","PSJHLV",45,0)
 Q
"RTN","PSJHLV",46,0)
 ;
"RTN","PSJHLV",47,0)
IV ;
"RTN","PSJHLV",48,0)
 NEW DRG,DRGI,DRGN,DRGT,FIL,ON,ON55,P,PSJORD,VADM,VAIN
"RTN","PSJHLV",49,0)
 S ON=PSGORD,PSIVCHG=0,PSJSYSU=1
"RTN","PSJHLV",50,0)
 D INP^VADPT
"RTN","PSJHLV",51,0)
 D GT531^PSIVORFA(PSJHLDFN,PSGORD),ACTIVE^PSIVORC2
"RTN","PSJHLV",52,0)
 K PSIVCHG,PSJIVORF,PSJORF,PSJORIFN,PSJORL,PSJORNP,PSJPINIT,PSJSYSL,PSJSYSU,PSJSYSW,PSJSYSW0
"RTN","PSJHLV",53,0)
 Q
"RTN","PSJHLV",54,0)
DONE ;
"RTN","PSJHLV",55,0)
 K CHK,DA,DIE,DRGF,DP,DR,ND,PSGAL,PSGODA,PSGPD,VND4 Q
"RTN","PSJHLV",56,0)
 ;
"RTN","PSJHLV",57,0)
CHK(ND,DRG,ND2) ; checks for data in required fields
"RTN","PSJHLV",58,0)
 ; Input: ND  - ^(PS(53.1,PSGORD,0)
"RTN","PSJHLV",59,0)
 ;        DRG - ^(.2)
"RTN","PSJHLV",60,0)
 ;        ND2 - ^(2)
"RTN","PSJHLV",61,0)
 S CHK="" I DRG,$D(^PS(50.7,+DRG,0))
"RTN","PSJHLV",62,0)
 E  S CHK=1
"RTN","PSJHLV",63,0)
 I ND="" S CHK=CHK_23
"RTN","PSJHLV",64,0)
 E  S CHK=CHK_$S($P(ND,"^",3):"",1:2)_$S($P(ND,"^",7)]"":"",1:3)
"RTN","PSJHLV",65,0)
 ;The naked reference on the line below refers to the variable ND
"RTN","PSJHLV",66,0)
 ;which is ^PS(53.1,PSGORD,0).
"RTN","PSJHLV",67,0)
 I ND2="" S CHK=CHK_$S('$D(^(0)):4,$P(^(0),"^",7)="OC":"",1:4)_56
"RTN","PSJHLV",68,0)
 E  S CHK=CHK_$S($P(ND2,"^")]"":"",ND="":4,$P(ND,"^",7)="OC":"",1:4)_$S($P(ND2,"^",2):"",1:5)_$S($P(ND2,"^",4):"",1:6)
"RTN","PSJHLV",69,0)
 I $$CHECK^PSGOE8(PSJSYSP),$P(DRG,U,2)="" S CHK=CHK_8
"RTN","PSJHLV",70,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSJHLV",71,0)
 S:'$$OIOK^PSGOE2(+DRG) PSGPFLG=1
"RTN","PSJHLV",72,0)
 Q
"RTN","PSJHLV",73,0)
 ;
"RTN","PSJHLV",74,0)
DDCHK ; dispense drug check
"RTN","PSJHLV",75,0)
 S DRGF="^PS("_$S(PSGORD["P":"53.1,"_+PSGORD,1:"55,"_PSJHLDFN_",5,"_+PSGORD)_",",CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSJHLV",76,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSJHLV",77,0)
 S CHK=$S('$$DDOK(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSJHLV",78,0)
 Q
"RTN","PSJHLV",79,0)
 ;
"RTN","PSJHLV",80,0)
DDOK(PSJF,OI) ;Check to be sure all dispense drugs that are active in the
"RTN","PSJHLV",81,0)
  ;order are valid.
"RTN","PSJHLV",82,0)
  ; Input: PSJF - File root of the order including all but the IEN of 
"RTN","PSJHLV",83,0)
  ;               the drug. (EX "^PS(53.1,X,1,")
"RTN","PSJHLV",84,0)
  ;        OI   - IEN of the order's orderable item
"RTN","PSJHLV",85,0)
  ; Output: 1 - all active DD's in the order are valid
"RTN","PSJHLV",86,0)
  ;         0 - no DD's active DD's or at least one active is invalid
"RTN","PSJHLV",87,0)
  N DDCNT,ND,PSJ,X S (X,DDCNT)=0
"RTN","PSJHLV",88,0)
  I '$O(@(PSJF_"0)")) Q 1
"RTN","PSJHLV",89,0)
  F PSJ=0:0 S PSJ=$O(@(PSJF_PSJ_")")) Q:'PSJ!X  S ND=$G(@(PSJF_PSJ_",0)"))  D
"RTN","PSJHLV",90,0)
  .I $P(ND,U,3),($P(ND,U,3)'>PSGDT) Q
"RTN","PSJHLV",91,0)
  .S DDCNT=DDCNT+1
"RTN","PSJHLV",92,0)
  .S X=$S('$D(^PSDRUG(+ND,0)):1,$P($G(^(2)),U,3)'["U":1,+$G(^(2))'=+OI:1,$G(^("I"))="":0,1:^("I")'>PSGDT)
"RTN","PSJHLV",93,0)
  Q $S('DDCNT:0,X=1:0,1:1)
"RTN","PSJLMPRI")
0^5^B17650009
"RTN","PSJLMPRI",1,0)
PSJLMPRI ;BIR/MLM-INPATIENT LISTMAN IV PROFILE UTILITIES ;01 JUL 96 / 2:24 PM
"RTN","PSJLMPRI",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**58,85,118,110,133**;16 DEC 97
"RTN","PSJLMPRI",3,0)
 ;
"RTN","PSJLMPRI",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLMPRI",5,0)
 ;
"RTN","PSJLMPRI",6,0)
PIV(DFN,ON,PSJF,DN)       ;Setup LM display for IV order. 
"RTN","PSJLMPRI",7,0)
 N ND14,DRG,ON55,P,PSJORIFN,TYP,V,X,Y,PSJFLAG S TYP="?" I ON["V" D
"RTN","PSJLMPRI",8,0)
 .S Y=$G(^PS(55,DFN,"IV",+ON,0)) F X=2,3,4,5,8,9,17,23 S P(X)=$P(Y,U,X)
"RTN","PSJLMPRI",9,0)
 .S TYP=$$ONE^PSJBCMA(DFN,ON,P(9),P(2),P(3)) I TYP'="O" S TYP="C"
"RTN","PSJLMPRI",10,0)
 .S ON55=ON,P("OT")=$S(P(4)="A":"F",P(4)="H":"H",1:"I") D GTDRG^PSIVORFB,GTOT^PSIVUTL(P(4))
"RTN","PSJLMPRI",11,0)
 .S P("PRY")=$P($G(^PS(55,DFN,"IV",+ON,.2)),U,4),PSJFLAG=$P($G(^(.2)),U,7)
"RTN","PSJLMPRI",12,0)
 .S ND4=$G(^PS(55,DFN,"IV",+ON,4)),V=$S(P("PRY")="D":"d",1:" ")_$S((+PSJSYSU=1&'+$P(ND4,U)):"->",(+PSJSYSU=3&'+$P(ND4,U,4)):"->",1:"") I PSJFLAG D CNTRL^VALM10(PSJLN,1,4,IORVON,IORVOFF,0)
"RTN","PSJLMPRI",13,0)
 .S PSJL=$$SETSTR^VALM1(V,PSJL,6,3)
"RTN","PSJLMPRI",14,0)
 .S ND14=$G(^PS(55,DFN,"IV",+ON,14,0)),ND14=$P(ND14,U,3) S:ND14 ND14=+$G(^(ND14,0))
"RTN","PSJLMPRI",15,0)
 I ON=+ON N PSJEN2,O S PSJEN2=PSJEN,O="" F  S O=$O(^PS(53.1,"ACX",ON,O)) Q:O=""  D
"RTN","PSJLMPRI",16,0)
 .I PSJEN2'=PSJEN S PSJL=$J(PSJEN2,4)
"RTN","PSJLMPRI",17,0)
 .S (P(2),P(3))="",P(17)=$P($G(^PS(53.1,+O,O)),U,9),Y=+$G(^(8)),P(4)=$P(Y,U),P(8)=$P(Y,U,5),P(9)=$P($G(^(2)),U),PSJFLAG=$P($G(^(.2)),U,7)
"RTN","PSJLMPRI",18,0)
 .D GTDRG^PSIVORFA,GTOT^PSIVUTL(P(4)) D @$S($E(P("OT"))'="F":"PUD^PSJLMPRU(DFN,O_""P"",PSJF,DN)",1:"PIV^PSJLMPRI(DFN,O_""P"",PSJF,DN)") S PSJEN2=""
"RTN","PSJLMPRI",19,0)
 I ON["P" S (P(2),P(3))="",P(17)=$P($G(^PS(53.1,+ON,0)),U,9),Y=$G(^(8)),P(4)=$P(Y,U),P(8)=$P(Y,U,5),P(9)=$P($G(^(2)),U),PSJFLAG=$P($G(^(.2)),U,7) D  I $E(P("OT"))'="F" D PUD^PSJLMPRU(DFN,ON,PSJF,DN) Q
"RTN","PSJLMPRI",20,0)
 . D GTDRG^PSIVORFA,GTOT^PSIVUTL(P(4))
"RTN","PSJLMPRI",21,0)
 . S ND14=$G(^PS(53.1,+ON,14,0)),ND14=$P(ND14,U,3) S:ND14 ND14=+$G(^(ND14,0))
"RTN","PSJLMPRI",22,0)
 I $G(PSJFLAG) D CNTRL^VALM10(PSJLN,1,4,IORVON,IORVOFF,0)
"RTN","PSJLMPRI",23,0)
 NEW PSJIVFLG S PSJIVFLG=1
"RTN","PSJLMPRI",24,0)
 S DRG=+$O(DRG("AD",0)) D:DRG PIVAD F  S DRG=$O(DRG("AD",DRG)) Q:'DRG  S PSJL="" D PIVAD
"RTN","PSJLMPRI",25,0)
SOL ;
"RTN","PSJLMPRI",26,0)
 S PSJL=$S($G(PSJIVFLG):PSJL_$S(ON["V":"in",1:"    in"),1:"        in")
"RTN","PSJLMPRI",27,0)
 NEW DRGX,NAME
"RTN","PSJLMPRI",28,0)
 S DRG=0 F  S DRG=+$O(DRG("SOL",DRG)) Q:'DRG  D NAME^PSIVUTL(DRG("SOL",DRG),39,.NAME,0) S DRGX=0 F  S DRGX=$O(NAME(DRGX)) Q:'DRGX  S PSJL=$$SETSTR^VALM1(NAME(DRGX),PSJL,12,60) D:$G(PSJIVFLG) PIV1 D SETTMP S PSJL="      "
"RTN","PSJLMPRI",29,0)
 ;S DRG=0 F  S DRG=+$O(DRG("SOL",DRG)) Q:'DRG  D NAME^PSIVUTL(DRG("SOL",DRG),39,.NAME,0) S DRGX=0 F  S DRGX=$O(NAME(DRGX)) Q:'DRGX  S PSJL=$$SETSTR^VALM1(NAME(DRGX),PSJL,12,60) D:'$G(PSJIVFLG) SETTMP D:$G(PSJIVFLG) PIV1 S PSJL="      "
"RTN","PSJLMPRI",30,0)
 Q
"RTN","PSJLMPRI",31,0)
PIVAD ; Print IV Additives.
"RTN","PSJLMPRI",32,0)
 NEW NAME
"RTN","PSJLMPRI",33,0)
 D NAME^PSIVUTL(DRG("AD",DRG),39,.NAME,1)
"RTN","PSJLMPRI",34,0)
 I $D(NAME(2)) S PSJL=$$SETSTR^VALM1(NAME(1),PSJL,9,60) D:$G(PSJIVFLG) PIV1 D SETTMP S PSJL="",PSJL=$$SETSTR^VALM1(NAME(2),PSJL,9,60) D SETTMP
"RTN","PSJLMPRI",35,0)
 I '$D(NAME(2)) S PSJL=$$SETSTR^VALM1(NAME(1),PSJL,9,60) D:$G(PSJIVFLG) PIV1 D SETTMP
"RTN","PSJLMPRI",36,0)
 Q
"RTN","PSJLMPRI",37,0)
 ;
"RTN","PSJLMPRI",38,0)
PIV1 ; Print Sched type, start/stop dates, and status.
"RTN","PSJLMPRI",39,0)
 K PSJIVFLG
"RTN","PSJLMPRI",40,0)
 F X=2,3 S P(X)=$E($$ENDTC^PSGMI(P(X)),1,$S($D(PSJEXTP):8,1:5))
"RTN","PSJLMPRI",41,0)
 I '$D(PSJEXTP) S PSJL=$$SETSTR^VALM1(TYP,PSJL,50,1),PSJL=$$SETSTR^VALM1(P(2),PSJL,53,7),PSJL=$$SETSTR^VALM1(P(3),PSJL,60,7),PSJL=$$SETSTR^VALM1(P(17),PSJL,67,1)
"RTN","PSJLMPRI",42,0)
 E  S PSJL=$$SETSTR^VALM1(TYP,PSJL,50,1),PSJL=$$SETSTR^VALM1(P(2),53,7),PSJL=$$SETSTR^VALM1(P(3),PSJL,63,7),PSJL=$$SETSTR^VALM1(P(17),PSJL,73,1)
"RTN","PSJLMPRI",43,0)
 I $G(ND14) S ND14=$$ENDTC^PSGMI((ND14)) S PSJL=$$SETSTR^VALM1(ND14,PSJL,$S($D(PSJEXTP):75,1:72),5) K ND14
"RTN","PSJLMPRI",44,0)
 ;* D SETTMP
"RTN","PSJLMPRI",45,0)
 Q
"RTN","PSJLMPRI",46,0)
SETTMP ;
"RTN","PSJLMPRI",47,0)
 S ^TMP($S($G(PSIVLBNM)]"":PSIVLBNM,1:"PSJPRO"),$J,PSJLN,0)=PSJL,PSJLN=PSJLN+1
"RTN","PSJLMPRI",48,0)
 Q
"RTN","PSJLMPRI",49,0)
 ;
"RTN","PSJLMPRI",50,0)
LASTREN(DFN,ON) ;
"RTN","PSJLMPRI",51,0)
 N FIL,RNDT,ND0,ND14 S ND14="" I '$G(ON)!'$G(DFN) Q 0
"RTN","PSJLMPRI",52,0)
 S FIL=$S(ON["P":"^PS(53.1,"_+ON_",14,0)",ON["V":"^PS(55,"_DFN_",""IV"","_+ON_",14,0)",ON["U":"^PS(55,"_DFN_",5,"_+ON_",14,0)",1:"")
"RTN","PSJLMPRI",53,0)
 ; Naked reference below refers to either ^PS(53.1,+ON,14,0), ^PS(55,+ON,5,14,0), or ^PS(55,+ON,5,14,0) created using indirection in variable FIL.
"RTN","PSJLMPRI",54,0)
 Q:FIL="" 0
"RTN","PSJLMPRI",55,0)
 S ND14=$G(@(FIL)) I $P(ND14,"^",3) S ND14=$G(^($P(ND14,"^",3),0))
"RTN","PSJLMPRI",56,0)
 Q ND14
"RTN","PSJLMPRI",57,0)
 ;
"RTN","PSJLMPRI",58,0)
LASTRNBY(DFN,ON) ;
"RTN","PSJLMPRI",59,0)
 N FIL,RNBY,ND0,ND14 S RNBY=""
"RTN","PSJLMPRI",60,0)
 S FIL=$S(ON["P":"^PS(53.1,"_+ON_",14,0)",ON["V":"^PS(55,"_DFN_",""IV"","_+ON_",14,0)",ON["U":"^PS(55,"_DFN_",5,"_+ON_",14,0)",1:"")
"RTN","PSJLMPRI",61,0)
 ; Naked reference below refers to either ^PS(53.1,+ON,14,0), ^PS(55,+ON,5,14,0), or ^PS(55,+ON,5,14,0) created using indirection in variable FIL.
"RTN","PSJLMPRI",62,0)
 Q:FIL="" 0
"RTN","PSJLMPRI",63,0)
 S ND14=$G(@(FIL)) I $P(ND14,"^",3) S ND14=$G(^($P(ND14,"^",3),0)),RNBY=$P(ND14,"^",2)
"RTN","PSJLMPRI",64,0)
 Q RNBY
"RTN","PSJOE")
0^6^B80533601
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133**;16 DEC 97
"RTN","PSJOE",3,0)
 ;
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",8,0)
 ; Reference to ^DPT is supported by DBIA #10035.
"RTN","PSJOE",9,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",10,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",11,0)
 ;
"RTN","PSJOE",12,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",13,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",14,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",15,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",16,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",17,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",18,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",19,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",20,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",21,0)
 ..K PSGRDTX
"RTN","PSJOE",22,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",23,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",24,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",25,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",26,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",27,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",28,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",29,0)
 ...S NXTPT=1
"RTN","PSJOE",30,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",31,0)
 .S PSJOL="S"
"RTN","PSJOE",32,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",33,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",34,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",35,0)
 ...N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",36,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",37,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",38,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",39,0)
 ;
"RTN","PSJOE",40,0)
DONE ;
"RTN","PSJOE",41,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",42,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",43,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",44,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",45,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",46,0)
 Q
"RTN","PSJOE",47,0)
 ;
"RTN","PSJOE",48,0)
HK ; HouseKeeping (a nice COBOL term)
"RTN","PSJOE",49,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",50,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",51,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",52,0)
 Q:PSGP<0
"RTN","PSJOE",53,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",54,0)
 Q
"RTN","PSJOE",55,0)
 ;
"RTN","PSJOE",56,0)
SELECT ; Select order from list
"RTN","PSJOE",57,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",58,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",59,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",60,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",61,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",62,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",63,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",64,0)
 ..S PSGORD=""
"RTN","PSJOE",65,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",66,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",67,0)
 S VALMBCK="Q"
"RTN","PSJOE",68,0)
 K PSJLM
"RTN","PSJOE",69,0)
 Q
"RTN","PSJOE",70,0)
 ;
"RTN","PSJOE",71,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",72,0)
 ; DFN    - Patient IEN
"RTN","PSJOE",73,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",74,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",75,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55
"RTN","PSJOE",76,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",77,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",78,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",79,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",80,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",81,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",82,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",83,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",84,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",85,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",86,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",87,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",88,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",89,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",90,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",91,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",92,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",93,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",94,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285"),$$SDIMO^SDAMA203(CLINIC,DFN)>-1 Q
"RTN","PSJOE",95,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",96,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",97,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",98,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",99,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM S PSJLM=1,PSGORD=PSJORD D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),@$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") Q
"RTN","PSJOE",100,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI
"RTN","PSJOE",101,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",102,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",103,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",104,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",105,0)
 ;Send SN to CPRS if autoverify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",106,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",107,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",108,0)
 Q
"RTN","PSJOE",109,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",110,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",111,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",112,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",113,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",114,0)
 D ACT^PSGOEE
"RTN","PSJOE",115,0)
 Q
"RTN","PSJOE",116,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",117,0)
 D HOLDHDR
"RTN","PSJOE",118,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",119,0)
 I 'PSGRRF D ^PSGOER Q
"RTN","PSJOE",120,0)
 D ^PSGOERI
"RTN","PSJOE",121,0)
 Q
"RTN","PSJOE",122,0)
 ;
"RTN","PSJOE",123,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",124,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",125,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",126,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",127,0)
 ;
"RTN","PSJOE",128,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",129,0)
 D HOLDHDR
"RTN","PSJOE",130,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE") W !,"This order has already been DISCONTINUED." D PAUSE^VALM1 Q
"RTN","PSJOE",131,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",132,0)
 S VALMBCK="Q"
"RTN","PSJOE",133,0)
 Q
"RTN","PSJOE",134,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",135,0)
 D HOLDHDR
"RTN","PSJOE",136,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",137,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",138,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",139,0)
 Q
"RTN","PSJOE",140,0)
 ;
"RTN","PSJOE",141,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",142,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",143,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",144,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",145,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",146,0)
 .D COPY^PSIVOD(PSGP,PSGORD) Q
"RTN","PSJOE",147,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",148,0)
 D ^PSJHVARS
"RTN","PSJOE",149,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",150,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",151,0)
 S PSGCOPY=1
"RTN","PSJOE",152,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",153,0)
 S VALMBCK="R"
"RTN","PSJOE",154,0)
 K PSGCOPY
"RTN","PSJOE",155,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",156,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",157,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",158,0)
 Q
"RTN","PSJOE",159,0)
 ;
"RTN","PSJOE",160,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",161,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",162,0)
 Q
"RTN","PSJOE",163,0)
FINISH ;
"RTN","PSJOE",164,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",165,0)
 Q
"RTN","PSJOE",166,0)
 ;
"RTN","PSJOE",167,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",168,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",169,0)
 Q
"RTN","PSJOE",170,0)
NEWSEL ;
"RTN","PSJOE",171,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",172,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",173,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",174,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",175,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",176,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",177,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",178,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",179,0)
 ..S PSGORD=""
"RTN","PSJOE",180,0)
 ..S ON=PSJORD
"RTN","PSJOE",181,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",182,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",183,0)
 S VALMBCK="Q"
"RTN","PSJOE",184,0)
 K PSJLM
"RTN","PSJOE",185,0)
 Q
"RTN","PSJOE",186,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",187,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",188,0)
 Q
"RTN","PSJOE",189,0)
LOCKERR ;
"RTN","PSJOE",190,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",191,0)
 Q
"RTN","PSJOE",192,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entrypoint.
"RTN","PSJOE",193,0)
 N ORIFN,NODE0
"RTN","PSJOE",194,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",195,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",196,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",197,0)
 D PAUSE^VALM1
"RTN","PSJOE",198,0)
 Q
"RTN","PSJOE",199,0)
 ;
"RTN","PSJOE",200,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",201,0)
 N NDP2,COM
"RTN","PSJOE",202,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",203,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",204,0)
 Q 0
"RTN","PSJOE0")
0^17^B27877210
"RTN","PSJOE0",1,0)
PSJOE0 ;BIR/CML3-INPATIENT PROFILE AND ORDER ENTRY ;17 SEP 97 /  1:41 PM
"RTN","PSJOE0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**47,56,110,133**;16 DEC 97
"RTN","PSJOE0",3,0)
 ;
"RTN","PSJOE0",4,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJOE0",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJOE0",6,0)
 ; Reference to ^VA(200 is supported by DBIA 10060.
"RTN","PSJOE0",7,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSJOE0",8,0)
 ;
"RTN","PSJOE0",9,0)
START ; print orders
"RTN","PSJOE0",10,0)
 W:X]"" $P("^PROFILE",X,2) D ENL^PSJO3 G:PSJOL="^" DONE Q:PSJOL="N"  K PSJPR S PSGOEAV=0,PSJNARC=1 D ^PSJO I 'PSJON Q
"RTN","PSJOE0",11,0)
 ;
"RTN","PSJOE0",12,0)
ENVW ; ask user to select or view any of the orders shown
"RTN","PSJOE0",13,0)
 S (PSGONC,PSGONR,PSGONV)=0,PSGLMT=PSJON S:$D(PSJPRF) PSGPRF=1 D ENASR^PSGON K PSGPRF
"RTN","PSJOE0",14,0)
 ;G:X="^" DONE I X]"" S PSGOEA=""
"RTN","PSJOE0",15,0)
 G:X["^" DONE I X]"" S PSGOEA=""
"RTN","PSJOE0",16,0)
 K PSJDLW
"RTN","PSJOE0",17,0)
 I  F PSJOE=1:1:PSGODDD S PSGOE=PSJOE F PSJOE1=1:1:$L(PSGODDD(PSJOE),",")-1 S PSJOE2=$P(PSGODDD(PSJOE),",",PSJOE1),(PSGORD,PSJORD)=^TMP("PSJON",$J,PSJOE2) G:$D(PSJDLW) DONE D 
"RTN","PSJOE0",18,0)
 .I PSJORD=+PSJORD N PSJO,PSJO1 S PSJO=PSJORD,PSJO1=0 F  S PSJO1=$O(^PS(53.1,"ACX",PSJO,PSJO1)) Q:'PSJO1  Q:PSGOEA["^"  Q:$D(PSJDLW)  S PSJORD=PSJO1_"P" D GODO S PSJORD=""
"RTN","PSJOE0",19,0)
 .Q:PSJORD=""  Q:PSGOEA["^"
"RTN","PSJOE0",20,0)
 .D GODO Q:PSGOEA["^"
"RTN","PSJOE0",21,0)
 Q
"RTN","PSJOE0",22,0)
 ;
"RTN","PSJOE0",23,0)
LMNEW(PSGP,PSJPROT) ;Entry point for new order entry from listman.
"RTN","PSJOE0",24,0)
 ; PSGP = DFN
"RTN","PSJOE0",25,0)
 ; PSJPROT=1:UD ONLY; 2:IV ONLY; 3:BOTH
"RTN","PSJOE0",26,0)
 ;
"RTN","PSJOE0",27,0)
 ;S VALM("BM")=9 D CKNEW
"RTN","PSJOE0",28,0)
 D CKNEW N PSJUDPRF S PSJNEWOE=1
"RTN","PSJOE0",29,0)
 S PSGPTS=PSJPTS,PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU,PSGOEDMR=$O(^PS(51.2,"B","ORAL",0)),PSGOEPR=$S($D(^PS(55,PSGP,5.1)):$P(^(5.1),"^",2),1:0),PSJORQF=0,PSJOEPF=""
"RTN","PSJOE0",30,0)
 I PSGOEPR>0,$D(^VA(200,+PSGOEPR,"PS")) S PSGOEPR=$S('$P(^("PS"),"^",4):PSGOEPR,($P(^("PS"),"^",4)<DT):0,1:PSGOEPR)
"RTN","PSJOE0",31,0)
 S:'PSGOEPR PSGOEPR=PSJPTSP
"RTN","PSJOE0",32,0)
 ;* F PSJOE=0:0 Q:PSJORQF  D:PSJPCAF&(PSJPROT'=2) EN^PSJOE1 K PSGEFN,PSGOEF I PSJPROT>1,(+PSJSYSU=3) D ENIN^PSIVORE
"RTN","PSJOE0",33,0)
 ;F PSJOE=0:0 Q:PSJORQF  D:PSJPCAF&(PSJPROT'=2) EN^PSJOE1 K PSGEFN,PSGOEF I PSJPROT>1 D ENIN^PSIVORE
"RTN","PSJOE0",34,0)
 ; line below fixes bug in line above - infinite loop when selecting New Order in Unit Dose OE for Outpatient.
"RTN","PSJOE0",35,0)
 F PSJOE=0:0 Q:PSJORQF!('(PSJPCAF&(PSJPROT'=2))&(PSJPROT'>1))  D:PSJPCAF&(PSJPROT'=2) EN^PSJOE1 K PSGEFN,PSGOEF I PSJPROT>1 D ENIN^PSIVORE
"RTN","PSJOE0",36,0)
 Q
"RTN","PSJOE0",37,0)
 ;
"RTN","PSJOE0",38,0)
DONE ;
"RTN","PSJOE0",39,0)
 K PSG,PSGDL,PSGDLS,PSGDO,PSGDRG,PSGDRGN,PSGFD,PSGHSM,PSGMR,PSGMRN,PSGNEDFD,PSGNEFD,PSGNESD,PSGOES,PSGOPR,PSGORD,PSGOROE1,PSGPR,PSGPRN,PSGS0XT,PSGS0Y,PSGSCH,PSGSD,PSGSI,PSGSM,PSGST,PSGSTN,PSGUD,PSGX,PSJDLW,PSJLM,PSJNARC,PSIVAC
"RTN","PSJOE0",40,0)
 K P,PSGEFN,PSGOEEF
"RTN","PSJOE0",41,0)
 Q
"RTN","PSJOE0",42,0)
 ;
"RTN","PSJOE0",43,0)
CKNEW ;
"RTN","PSJOE0",44,0)
 K CF,CHK,OD,PSGLMT,PSGODDD,PSGOEA,PSGON,PSGONC,PSGONR,PSGONV,PSJOE1,PSJOE2,PSJCOM Q:$D(PSJPRF)
"RTN","PSJOE0",45,0)
 I $P(PSJPDD,"^",3) W !!?2,"Patient is shown as deceased.  You may not enter orders for this patient." D CONT Q
"RTN","PSJOE0",46,0)
 I 'PSJPCAF W !!,"(NOTE: You cannot enter Unit Dose orders for this patient.)" D CONT
"RTN","PSJOE0",47,0)
 Q
"RTN","PSJOE0",48,0)
 ;
"RTN","PSJOE0",49,0)
CONT ;
"RTN","PSJOE0",50,0)
 K DIR S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSJOE0",51,0)
 Q
"RTN","PSJOE0",52,0)
 ;
"RTN","PSJOE0",53,0)
GODO ;Display selected order.
"RTN","PSJOE0",54,0)
 S PSIVAC="C" I $S(PSJORD["V":1,PSJORD["P":$P($G(^PS(53.1,+PSJORD,0)),"^",4)="F",1:0) D @$S($D(PSJPRP):"ENINP^PSIVOPT(DFN,PSJORD)",1:"ENIN^PSIVOPT") G GODO1
"RTN","PSJOE0",55,0)
 I '$D(PSJPRP),(PSJORD["P"),($P($G(^PS(53.1,+PSJORD,0)),U,4)="I") D ASKTYP Q:$D(DIRUT)  I Y="I" D ENIN^PSIVOPT G GODO1
"RTN","PSJOE0",56,0)
 S PSGORD=PSJORD D EN2^PSGVW,^PSGOE1:'$D(PSJPRF)
"RTN","PSJOE0",57,0)
GODO1 ;
"RTN","PSJOE0",58,0)
 I $D(PSJPRP),'PSJPR K DIR S DIR(0)="E" D ^DIR K DIR S:$D(DUOUT)!$D(DTOUT) PSJDLW=1 Q:$D(PSJDLW)  W:$Y @IOF
"RTN","PSJOE0",59,0)
 Q
"RTN","PSJOE0",60,0)
 ;
"RTN","PSJOE0",61,0)
ASKTYP ; Ask if completing as IV or UD.
"RTN","PSJOE0",62,0)
 Q
"RTN","PSJOE0",63,0)
 W !! D PIV^PSIVUTL(+PSJORD_"P")
"RTN","PSJOE0",64,0)
 I $G(PSJPDD) S DIR(0)="E" D ^DIR S Y="I" Q
"RTN","PSJOE0",65,0)
 W ! K DIR S DIR(0)="SOA^U:Unit Dose;I:IV Medication",DIR("A")="Do you wish to complete this as an IV or Unit Dose order (I/U)? ",DIR("?")="^D PENDIU^PSJO3" D ^DIR
"RTN","PSJOE0",66,0)
 Q
"RTN","PSJOE0",67,0)
 ;
"RTN","PSJOE0",68,0)
OLDCOM(DFN,PSJORD) ;
"RTN","PSJOE0",69,0)
 Q:$$COMPLEX^PSJOE(DFN,PSJORD)
"RTN","PSJOE0",70,0)
 N DURFLG S DURFLG=$S($G(PSJORD)["P":$G(^PS(53.1,+PSJORD,2.5)),$G(PSJORD)["V":$G(^PS(55,DFN,"IV",+PSJORD,2.5)),1:$G(^PS(55,DFN,5,+PSJORD,2.5))) I $P(DURFLG,"^",2)]"" D
"RTN","PSJOE0",71,0)
 . D CLEAR^VALM1 W !!!!!?21," * WARNING * "
"RTN","PSJOE0",72,0)
 . W !!!?5,"The following order contains a Requested Duration"
"RTN","PSJOE0",73,0)
 . W !?12,"and may be part of a complex dose!"
"RTN","PSJOE0",74,0)
 . W !!," Review the entire profile to determine appropriate action(s).",!!!!!!! D PAUSE^VALM1
"RTN","PSJOE0",75,0)
 . D CLEAR^VALM1 W !!!!!?21," * WARNING * "
"RTN","PSJOE0",76,0)
 . W !!!?5,"The following order contains a Requested Duration"
"RTN","PSJOE0",77,0)
 . W !?12,"and may be part of a complex dose!"
"RTN","PSJOE0",78,0)
 . W !!," Review the entire profile to determine appropriate action(s).",!!!!!!! D PAUSE^VALM1
"RTN","PSJOE0",79,0)
 Q
"RTN","PSJOE0",80,0)
AM ;
"RTN","PSJOE0",81,0)
 W !!?2,"Enter a 'Y' (or press the RETURN key) to enter new INPATIENT orders for this",!,"patient.  Enter an 'N' (or an '^') if there are no new orders for this patient."
"RTN","PSJOE0",82,0)
 W:'PSJPCAF !!?2,"PLEASE NOTE: The patient selected is NOT shown as currently admitted.",!,"Therefore, you cannot enter Unit Dose orders for this patient.  (You can enter",!,"IV orders.)" Q
"RTN","PSJOEA")
0^31^B28156504
"RTN","PSJOEA",1,0)
PSJOEA ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOEA",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**110,127,133**;16 DEC 97
"RTN","PSJOEA",3,0)
 ;
"RTN","PSJOEA",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOEA",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOEA",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOEA",7,0)
 ; Reference to ^DPT is supported by DBIA #10035.
"RTN","PSJOEA",8,0)
 ;
"RTN","PSJOEA",9,0)
LOCK(DFN,PSJORD) ; Check to see if the order is already locked
"RTN","PSJOEA",10,0)
 N Q S Q=0
"RTN","PSJOEA",11,0)
 I PSJORD=+PSJORD N PSJO S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",PSJORD,PSJO)) Q:'PSJO  S Q=$$LS^PSSLOCK(DFN,PSJO_"P") I 'Q Q
"RTN","PSJOEA",12,0)
 I Q Q 1
"RTN","PSJOEA",13,0)
 Q 0
"RTN","PSJOEA",14,0)
 ;
"RTN","PSJOEA",15,0)
SELECT ;
"RTN","PSJOEA",16,0)
 Q:PSJORD=""!($G(Y)<0)  Q:('$$LOCK^PSJOEA(PSGP,PSJORD))
"RTN","PSJOEA",17,0)
 N PSJO S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",PSJORD,PSJO)) Q:'PSJO  D
"RTN","PSJOEA",18,0)
 .S PSGORD=""
"RTN","PSJOEA",19,0)
 .S ON=PSJO_"P"
"RTN","PSJOEA",20,0)
 .D DISACTIO(PSGP,PSJO_"P",$G(PSJPNV)) S:$G(PSJO)["V" O=ON
"RTN","PSJOEA",21,0)
 I $D(^TMP("PSJCOM",$J)) D CHK^PSJOEA1
"RTN","PSJOEA",22,0)
 S:'$G(PSGP) PSGP=$G(DFN)
"RTN","PSJOEA",23,0)
 N PSJO S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",PSJORD,PSJO)) Q:'PSJO  D
"RTN","PSJOEA",24,0)
 .D UNL^PSSLOCK(PSGP,PSJO_"P") Q:$G(Y)<0
"RTN","PSJOEA",25,0)
 Q
"RTN","PSJOEA",26,0)
 ;
"RTN","PSJOEA",27,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOEA",28,0)
 ; DFN    - Patient IEN
"RTN","PSJOEA",29,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOEA",30,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOEA",31,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55
"RTN","PSJOEA",32,0)
 Q:PSJORD'["P"
"RTN","PSJOEA",33,0)
 S PSGP=DFN D ENIV^PSJAC
"RTN","PSJOEA",34,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOEA",35,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOEA",36,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOEA",37,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOEA",38,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOEA",39,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOEA",40,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOEA",41,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) Q  ;L -^PS(53.1,+PSJORD) Q
"RTN","PSJOEA",42,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) Q  ;L -^PS(53.1,+PSJORD) Q
"RTN","PSJOEA",43,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOEA",44,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOEA",45,0)
 .. D GT531^PSIVORFA(+PSGP,PSJORD),VF^PSIVORC2
"RTN","PSJOEA",46,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOEA",47,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOEA",48,0)
 ..I $P(PSJXX1,U,4)="U",(+PSJPDD) W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1 Q
"RTN","PSJOEA",49,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOEA",50,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOEA",51,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOEA",52,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM S PSJLM=1,PSGORD=PSJORD D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),@$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") Q
"RTN","PSJOEA",53,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI
"RTN","PSJOEA",54,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOEA",55,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOEA",56,0)
 ;I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOEA",57,0)
 ;I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOEA",58,0)
 ;Send SN to CPRS if autoverify OFF and Order Set Entry and no 21st piece
"RTN","PSJOEA",59,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOEA",60,0)
 ;D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOEA",61,0)
 Q
"RTN","PSJOEA",62,0)
 ;
"RTN","PSJOEA",63,0)
ACTLOG(PSGORDP,DFN,PSGORD)  ;Store 53.1 activity log in local array to be moved to 55
"RTN","PSJOEA",64,0)
 ;PSGORDP: IEN from 53.1
"RTN","PSJOEA",65,0)
 ;PSGORD : IEN from 55
"RTN","PSJOEA",66,0)
 NEW PSGX,PSGXDA,PSGAL531,Q,QQ
"RTN","PSJOEA",67,0)
 F PSGX=0:0 S PSGX=$O(^PS(53.1,+PSGORDP,"A",PSGX)) Q:'PSGX  D
"RTN","PSJOEA",68,0)
 . S PSGAL531=$G(^PS(53.1,+PSGORDP,"A",PSGX,0))
"RTN","PSJOEA",69,0)
 . S QQ=$G(^PS(55,DFN,5,+PSGORD,9,0)) S:QQ="" QQ="^55,09D" F Q=$P(QQ,U,3)+1:1 I '$D(^(Q)) S $P(QQ,U,3,4)=Q_U_Q,^(0)=QQ,PSGXDA=Q Q
"RTN","PSJOEA",70,0)
 . S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,0)=PSGAL531
"RTN","PSJOEA",71,0)
 Q
"RTN","PSJOEA",72,0)
 ;
"RTN","PSJOEA",73,0)
UD ;
"RTN","PSJOEA",74,0)
 N DA,DR,DIE,PSJCMPDA D ENGNA^PSGOETO S $P(^TMP("PSJCOM",$J,PSJO,0),"^",26)=DA_"U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^")=DA,$P(^(0),"^",18)=DA S PSJCMPDA=DA
"RTN","PSJOEA",75,0)
 M ^PS(55,PSGP,5,DA)=^TMP("PSJCOM2",$J,+PSJO) M ^PS(53.1,+PSJO)=^TMP("PSJCOM",$J,+PSJO) D EN1^PSJHL2(PSGP,"OD",+PSJO_"P") S PSJNOO=$P(^TMP("PSJCOM2",$J,+PSJO,.2),U,3) D EN1^PSJHL2(PSGP,"SN",+PSJCMPDA_"U")
"RTN","PSJOEA",76,0)
 N PSGPDRG,PSGST,PSGNESD,PSGNEFD,ND2
"RTN","PSJOEA",77,0)
 S PSGPDRG=$P($G(^PS(55,PSGP,5,PSJCMPDA,.2)),"^"),PSGST=$P($G(^PS(55,PSGP,5,PSJCMPDA,0)),"^",7)
"RTN","PSJOEA",78,0)
 S ND2=$G(^PS(55,PSGP,5,PSJCMPDA,2)),PSGNESD=$P(ND2,"^",2),PSGNEFD=$P(ND2,"^",4) D CRA^PSGOETO
"RTN","PSJOEA",79,0)
 K ^PS(53.1,"ACX",PSJORD,PSJO) K PSJPREX
"RTN","PSJOEA",80,0)
 I $G(PSJCMPDA) D CMPLX2^PSJCOM1(PSGP,PSJORD,+PSJCMPDA_"U") I $G(PSGPXN) S PSJPREX=1
"RTN","PSJOEA",81,0)
 Q
"RTN","PSJOEA",82,0)
IV ; 
"RTN","PSJOEA",83,0)
 K ON55 I $P($G(^PS(53.1,+PSJO,0)),"^",24)="R",$P($G(^PS(53.1,+PSJO,0)),"^",25) S ON55=$P(^PS(53.1,+PSJO,0),"^",25)
"RTN","PSJOEA",84,0)
 I '$G(ON55) D NEW55^PSIVORFB
"RTN","PSJOEA",85,0)
 S $P(^TMP("PSJCOM",$J,PSJO,0),"^",26)=ON55,$P(^TMP("PSJCOM2",$J,PSJO,0),"^")=+ON55
"RTN","PSJOEA",86,0)
 S $P(^TMP("PSJCOM2",$J,PSJO,2),U,5)=PSJO_"P",$P(^TMP("PSJCOM",$J,PSJO,0),U,26)=ON55
"RTN","PSJOEA",87,0)
 M ^PS(55,DFN,"IV",+ON55)=^TMP("PSJCOM2",$J,+PSJO) M ^PS(53.1,+PSJO)=^TMP("PSJCOM",$J,+PSJO) D EN1^PSJHL2(PSGP,"OD",+PSJO_"P") S P("NAT")=$P(^TMP("PSJCOM2",$J,+PSJO,.2),U,5) D EN1^PSJHL2(PSGP,"SN",ON55)
"RTN","PSJOEA",88,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK K DA,DIK
"RTN","PSJOEA",89,0)
 K ^PS(53.1,"ACX",PSJORD,PSJO)
"RTN","PSJOEA",90,0)
 Q
"RTN","PSJOEA1")
0^32^B29163507
"RTN","PSJOEA1",1,0)
PSJOEA1 ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOEA1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**110,127,133**;16 DEC 97
"RTN","PSJOEA1",3,0)
 ;
"RTN","PSJOEA1",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOEA1",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789.
"RTN","PSJOEA1",6,0)
 ;
"RTN","PSJOEA1",7,0)
CHK ;Check to be sure all the orders in the complex order series are completed.
"RTN","PSJOEA1",8,0)
 N COMQUIT,PSJCOMV,PSJOT,PSJSTAT,PSJSTAT2,PSGND2P5,DUR,ND14,PSJPREX S (PSJCOMV,COMQUIT)=0,PSJSTAT2=""
"RTN","PSJOEA1",9,0)
 I '$D(^TMP("PSJCOM",$J)) Q
"RTN","PSJOEA1",10,0)
 N PSJO S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",PSJORD,PSJO)) Q:'PSJO  Q:COMQUIT  S PSJOT=$P(^PS(53.1,PSJO,0),"^",4) D
"RTN","PSJOEA1",11,0)
 . I '$D(^TMP("PSJCOM",$J,PSJO,0)) M ^TMP("PSJCOM",$J,PSJO)=^PS(53.1,PSJO) I '$D(^TMP("PSJCOM",$J,PSJO,0)) S COMQUIT=2 Q:COMQUIT
"RTN","PSJOEA1",12,0)
 . S PSJSTAT=$P(^TMP("PSJCOM",$J,PSJO,0),"^",9)
"RTN","PSJOEA1",13,0)
 . I PSJSTAT="DE" S PSJSTAT=$P($G(^TMP("PSJCOM2",$J,PSJO,0)),"^",9) I PSJSTAT="" S COMQUIT=1 Q
"RTN","PSJOEA1",14,0)
 . S:PSJSTAT2="" PSJSTAT2=PSJSTAT S:PSJSTAT'=PSJSTAT2 COMQUIT=2 Q:COMQUIT  S PSJSTAT2=PSJSTAT
"RTN","PSJOEA1",15,0)
 I COMQUIT,PSJOT="U",$G(^TMP("PSJCOM",$J))'="A" S:$G(PSJOWALL)]"" $P(^PS(55,PSGP,5.1),U)=PSJOWALL
"RTN","PSJOEA1",16,0)
 I (COMQUIT=2)!(COMQUIT&($G(^TMP("PSJCOM",$J))'="A")) W !,"By not finishing all the orders, none of the orders will be updated." D PAUSE^VALM1 Q
"RTN","PSJOEA1",17,0)
 I 'COMQUIT N PSJO S PSJO=0 F  S PSJO=$O(^TMP("PSJCOM",$J,PSJO)) Q:'PSJO  D
"RTN","PSJOEA1",18,0)
 .S PSGS0Y=$P($G(^TMP("PSJCOM",$J,+PSJO,2)),"^",5),PSGS0XT=$P($G(^TMP("PSJCOM",$J,+PSJO,2)),"^",6)
"RTN","PSJOEA1",19,0)
 .N EDITS0Y,EDITS0XT S EDITS0Y=$P($G(^TMP("PSJCOM2",$J,+PSJO,2)),"^",5),EDITS0XT=$P($G(^TMP("PSJCOM2",$J,+PSJO,2)),"^",6) D
"RTN","PSJOEA1",20,0)
 ..S:EDITS0Y PSGS0Y=EDITS0Y I EDITS0XT!(",O,D,"[(","_EDITS0XT_",")) S PSGS0XT=EDITS0XT
"RTN","PSJOEA1",21,0)
 .N DIE,DA,DR S DR="28////^S X=$P(^TMP(""PSJCOM"",$J,+PSJO,0),""^"",9)",DA=+PSJO,DIE="^PS(53.1," D ^DIE
"RTN","PSJOEA1",22,0)
 .N DIK,DA S DIK="^PS(53.1,",DA=+PSJO S:$G(DFN) DA(1)=DFN D IX^DIK K DIK,DA
"RTN","PSJOEA1",23,0)
 .M ^PS(53.1,+PSJO)=^TMP("PSJCOM",$J,+PSJO)
"RTN","PSJOEA1",24,0)
 .S PSGND=$G(^PS(53.1,+PSJO,0)),PSGND2P5=$G(^PS(53.1,+PSJO,2.5)),DUR=$P(PSGND2P5,"^",2),ND14=$$LASTREN^PSJLMPRI(DFN,+PSJO_"P")
"RTN","PSJOEA1",25,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,24)="R" D
"RTN","PSJOEA1",26,0)
 ..N PND0,PSGORDR S PND0=^PS(53.1,+PSJO,0) I $P(PND0,U,24)="R" S PSGORDR=$P(PND0,U,25) D
"RTN","PSJOEA1",27,0)
 ...S:'$G(PSGP) PSGP=$G(DFN) Q:'$$LS^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA1",28,0)
 ...N OEORD,OOEORD,FILE55,FILE55N0,PNDP2 S PNDP2=^PS(53.1,+PSJO,.2),FILE55="^PS(55,"_DFN_$S($P(PND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSJOEA1",29,0)
 ...S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,+PSJO_"P",+$$LASTREN^PSJLMPRI(DFN,+PSJO_"P"))
"RTN","PSJOEA1",30,0)
 ...S PSGORDP=PSJO,DIE="^PS(53.1,",DA=+PSJO,DR="28////A;104////@" W "." D ^DIE
"RTN","PSJOEA1",31,0)
 ...D START^PSGOTR(+PSJO_"P",+PSGORDR) I OEORD D
"RTN","PSJOEA1",32,0)
 ....K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD
"RTN","PSJOEA1",33,0)
 ....S:$P(PNDP2,U,8) DR=DR_";125////"_$P(PNDP2,U,8) D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSJOEA1",34,0)
 ....D EN1^PSJHL2(DFN,"SC",PSGORDR),UNL^PSSLOCK(DFN,PSGORDR)
"RTN","PSJOEA1",35,0)
 ..I '$G(COMQUIT) S ND14=$$LASTREN^PSJLMPRI(DFN,+PSJO_"P") I $G(ND14) S DA=+$P(PSGND,U,25) I DA D
"RTN","PSJOEA1",36,0)
 ...N PSGAT S PSGAT=$P($G(^TMP("PSJCOM",$J,+PSJO,2)),"^",5)
"RTN","PSJOEA1",37,0)
 ...D UPDREN^PSGOER(DA,$P(ND14,U),$P(ND14,U,3),$P(ND14,U,4),$P($G(^PS(53.1,+PSJO,.2)),U,3),$P(ND14,U,2))
"RTN","PSJOEA1",38,0)
 ...K PSJPREX I $G(PSGORDR)["U" I $G(PSJORD)=+$G(PSJORD) D CMPLX2^PSJCOM1(DFN,PSJORD,PSGORDR) I $G(PSGPXN) S PSJPREX=1
"RTN","PSJOEA1",39,0)
 .I '$G(PSGP) S:$G(DFN) PSGP=DFN
"RTN","PSJOEA1",40,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,24)="R",$P(PSGND,U,25),$P($G(^PS(53.1,+PSJO,2)),U,2)<$P($G(^PS(55,PSGP,"IV",+$P(PSGND,U,25),0)),U,3) D
"RTN","PSJOEA1",41,0)
 ..K DA,DR S DA(1)=PSGP,DA=+$P(PSGND,U,25),DIE="^PS(55,"_PSGP_",""IV"",",DR=".03////"_$P($G(^PS(53.1,+PSJO,2)),U,2)_";116////"_$P($G(^PS(55,PSGP,"IV",+$P(PSGND,U,25),0)),U,3)
"RTN","PSJOEA1",42,0)
 ..D ^DIE,EN1^PSJHL2(PSGP,"XX",$P(PSGND,U,25)) L -^PS(53.1,+PSJO)
"RTN","PSJOEA1",43,0)
 .I $P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),(",N,A,"[$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)) D
"RTN","PSJOEA1",44,0)
 ..S:'$G(PSGP) PSGP=DFN S PSGS0Y=$P($G(^TMP("PSJCOM2",$J,+PSJO,2)),"^",5)
"RTN","PSJOEA1",45,0)
 ..N DA,DR,DIE D ENGNN^PSGOETO S $P(^TMP("PSJCOM",$J,PSJO,0),"^",26)=DA_"P",$P(^TMP("PSJCOM2",$J,PSJO,0),"^")=DA,$P(^(0),"^",18)=DA
"RTN","PSJOEA1",46,0)
 ..S DR="28////^S X=$P(^TMP(""PSJCOM2"",$J,+PSJO,0),""^"",9)",DIE="^PS(53.1," D ^DIE
"RTN","PSJOEA1",47,0)
 ..M ^PS(53.1,DA)=^TMP("PSJCOM2",$J,+PSJO) M ^TMP("PSJCOM2",$J,DA)=^TMP("PSJCOM2",$J,+PSJO) N PSJOCHIL S PSJOCHIL=$P(^PS(53.1,DA,.2),"^",8) I PSJOCHIL S ^PS(53.1,"ACX",+PSJOCHIL,DA)=""
"RTN","PSJOEA1",48,0)
 ..I $P(^PS(53.1,+PSJO,2),"^",5)'=$P(^TMP("PSJCOM2",$J,+PSJO,2),"^",5) S $P(^PS(53.1,+PSJO,2),"^",5)=$P(^TMP("PSJCOM2",$J,+PSJO,2),"^",5)
"RTN","PSJOEA1",49,0)
 ..D EN1^PSJHL2(PSGP,"OD",+PSJO_"P"),EN1^PSJHL2(PSGP,"SN",+DA_"P")
"RTN","PSJOEA1",50,0)
 ..K ^PS(53.1,"ACX",PSJORD,PSJO) L -^PS(53.1,+PSJO) L -^PS(53.1,DA)
"RTN","PSJOEA1",51,0)
 I '$G(COMQUIT) N PSJO S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",PSJORD,PSJO)) Q:'PSJO  Q:PSJCOMV  D
"RTN","PSJOEA1",52,0)
 .I '$D(^TMP("PSJCOM",$J,PSJO)) D  Q:$G(PSJCOMV)
"RTN","PSJOEA1",53,0)
 ..N EDITND0,PREV,REAS S EDITND0=$G(^PS(53.1,+PSJO,0)) S PREV=$P(EDITND0,"^",25),REAS=$P(EDITND0,"^",24)
"RTN","PSJOEA1",54,0)
 ..I PREV,REAS="E" I $P($G(^PS(53.1,+PREV,0)),"^",9)="DE" M ^TMP("PSJCOM",$J,+PSJO)=^PS(53.1,+PSJO) K ^TMP("PSJCOM",$J,+PREV),^PS(53.1,"ACX",+PREV) Q
"RTN","PSJOEA1",55,0)
 ..S PSJCOMV=1
"RTN","PSJOEA1",56,0)
 .I $P(^TMP("PSJCOM",$J,PSJO,0),"^",9)'="A",'$D(^TMP("PSJCOM2",$J,PSJO,0)) S PSJCOMV=1 Q
"RTN","PSJOEA1",57,0)
 .I $P($G(^TMP("PSJCOM2",$J,PSJO,0)),"^",4)="U",$P(^TMP("PSJCOM",$J,PSJO,0),"^",9)'="A",$P($G(^TMP("PSJCOM2",$J,PSJO,0)),"^",9)'="A" S PSJCOMV=1 Q
"RTN","PSJOEA1",58,0)
 .I $P($G(^TMP("PSJCOM2",$J,PSJO,0)),"^",4)'="U",$P(^TMP("PSJCOM",$J,PSJO,0),"^",9)'="A",$P($G(^TMP("PSJCOM2",$J,PSJO,0)),"^",17)'="A" S PSJCOMV=1
"RTN","PSJOEA1",59,0)
 I ($G(COMQUIT)=2)!(($G(COMQUIT)!PSJCOMV)&$G(^TMP("PSJCOM",$J))="A") K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J) W !,"By not verifying all the orders, none of the orders will be verified." D PAUSE^VALM1 Q
"RTN","PSJOEA1",60,0)
 ; 
"RTN","PSJOEA1",61,0)
 D CHK^PSJOEA2
"RTN","PSJOEA1",62,0)
 Q
"RTN","PSJOEA2")
0^33^B27419272
"RTN","PSJOEA2",1,0)
PSJOEA2 ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOEA2",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**127,133**;16 DEC 97
"RTN","PSJOEA2",3,0)
 ;
"RTN","PSJOEA2",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOEA2",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789.
"RTN","PSJOEA2",6,0)
 ;
"RTN","PSJOEA2",7,0)
CHK ;Check to be sure all the orders in the complex order series are completed, continued.
"RTN","PSJOEA2",8,0)
 I 'PSJCOMV,'$G(COMQUIT) N PSJO S PSJO=0 F  S PSJO=$O(^TMP("PSJCOM",$J,PSJO)) Q:'PSJO  S PSGORD=+PSJO_"P",PSGND=$G(^PS(53.1,+PSJO,0)) D
"RTN","PSJOEA2",9,0)
 .S PSGP=$P(PSGND,"^",15)
"RTN","PSJOEA2",10,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="A",($P(PSGND,U,24)'="R") D ^PSGOT D  Q
"RTN","PSJOEA2",11,0)
 ..M ^PS(55,PSGP,5,+PSGORD,4)=^PS(53.1,PSJO,4)
"RTN","PSJOEA2",12,0)
 ..N PSGND2P5 S PSGND2P5=$G(^PS(53.1,+PSJO,2.5)),DUR=$P(PSGND2P5,"^",2) I $G(DUR)]"" N DA,DR,DIE S DIE="^PS(55,"_PSGP_",5,",DA(1)=PSGP,DA=+PSGORD,DR="126////"_$G(DUR) D ^DIE
"RTN","PSJOEA2",13,0)
 ..D ACTLOG^PSJOEA(PSJO,PSGP,PSGORD)
"RTN","PSJOEA2",14,0)
 ..S VND4=$G(^PS(55,PSGP,5,+PSGORD,4))
"RTN","PSJOEA2",15,0)
 ..I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSJOEA2",16,0)
 ..S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSJOEA2",17,0)
 ..I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSJOEA2",18,0)
 ..I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSJOEA2",19,0)
 ..I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSJOEA2",20,0)
 ..S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)=""
"RTN","PSJOEA2",21,0)
 ..S PSJCOM=$P($G(^PS(55,PSGP,5,+PSGORD,.2)),"^",8) I PSJCOM]"" K ^PS(53.1,"ACX",PSJCOM,PSJO) S $P(^PS(55,PSGP,5,+PSGORD,4),"^",9)=1
"RTN","PSJOEA2",22,0)
 ..D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSJOEA2",23,0)
 ..D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U") L -^PS(55,PSGP,5,+PSGORD)
"RTN","PSJOEA2",24,0)
 ..S PSJPREX=1 D CMPLX2^PSJCOM1(PSGP,PSJORD,PSGORD) K PSJPREX
"RTN","PSJOEA2",25,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="A" D GT531^PSIVORFA(PSGP,PSJO_"P") D  Q
"RTN","PSJOEA2",26,0)
 ..S ON55="" I $P(PSGND,"^",24)="R" S ON55=$P(PSGND,"^",25) D
"RTN","PSJOEA2",27,0)
 ...N PND0,PSGORDR S PND0=^PS(53.1,+PSJO,0),PSGORDR=$P(PND0,U,25)
"RTN","PSJOEA2",28,0)
 ...Q:'$$LS^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA2",29,0)
 ...N OEORD,OOEORD,FILE55,FILE55N0,PNDP2 S PNDP2=^PS(53.1,+PSJO,.2),FILE55="^PS(55,"_DFN_",""IV"",",FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSJOEA2",30,0)
 ...S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,+PSJO_"P",+$$LASTREN^PSJLMPRI(DFN,+PSJO_"P"))
"RTN","PSJOEA2",31,0)
 ...S PSGORDP=PSJO,DIE="^PS(53.1,",DA=+PSJO,DR="28////A;104////@" W "." D ^DIE
"RTN","PSJOEA2",32,0)
 ...Q:'$G(OEORD)  K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=110_"////"_+OEORD
"RTN","PSJOEA2",33,0)
 ...S:$P(PNDP2,U,8) DR=DR_";150////"_$P(PNDP2,U,8) D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSJOEA2",34,0)
 ...D EN1^PSJHL2(DFN,"SC",PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA2",35,0)
 ..I 'ON55 D SETNEW^PSIVORFB
"RTN","PSJOEA2",36,0)
 ..S (P("NEWON"),ON)=ON55,PSGP=$P(PSGND,U,15)
"RTN","PSJOEA2",37,0)
 ..S VND4=$G(^TMP("PSJCOM",$J,+PSJO,4)) D
"RTN","PSJOEA2",38,0)
 ...N PSJRN,PSJRNDT,PSJRPH,PSJRPHD,PSJPVFL,PSJNVFL,DR,DIE,DA
"RTN","PSJOEA2",39,0)
 ...S (PSJPVFL,PSJNVFL)=""
"RTN","PSJOEA2",40,0)
 ...S PSJRN=$P(VND4,U,1),PSJRNDT=$P(VND4,U,2),PSJRPH=$P(VND4,U,3),PSJRPHD=$P(VND4,U,4),PSJPVFL=$P(VND4,U,16) S:PSJRN]"" PSJNVFL=1
"RTN","PSJOEA2",41,0)
 ...S DR="16////"_PSJRN_";17////"_PSJRNDT_";140////"_PSJRPH_";141////"_PSJRPHD_";142////"_PSJPVFL_";143////"_PSJNVFL
"RTN","PSJOEA2",42,0)
 ...S DA(1)=PSGP,DA=+ON55,DIE="^PS(55,"_PSGP_",""IV""," D ^DIE
"RTN","PSJOEA2",43,0)
 ..D:P("RES")="R" RUPDATE^PSIVOREN(PSGP,ON,P(2))
"RTN","PSJOEA2",44,0)
 ..I +PSJSYSU=3 K OD D ^PSIVORE1 ;LABEL STUFF
"RTN","PSJOEA2",45,0)
 ..I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D  Q
"RTN","PSJOEA2",46,0)
 ...NEW DIC,DA,X,Y,XX D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJOEA2",47,0)
 ...S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJOEA2",48,0)
 ...S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJOEA2",49,0)
 ...S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJOEA2",50,0)
 ...K DO D FILE^DICN K DO
"RTN","PSJOEA2",51,0)
 ...N DIK,DA,PSIVACT S DIK="^PS(55,"_DFN_",""IV"",",DA=+ON,PSIVACT="" S:$G(DFN) DA(1)=DFN D IX^DIK K DIK,DA
"RTN","PSJOEA2",52,0)
 ...S PSJCOM=$P($G(^PS(55,DFN,"IV",+ON,.2)),"^",8) I PSJCOM]"" K ^PS(53.1,"ACX",PSJCOM,PSJO)
"RTN","PSJOEA2",53,0)
 ...D EN1^PSJHL2(DFN,"SC",ON)
"RTN","PSJOEA2",54,0)
 ...D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON) L -^PS(55,DFN,"IV",+ON) I $G(ON55) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSJOEA2",55,0)
 ..L -^PS(55,DFN,"IV",+ON) I $G(ON55) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSJOEA2",56,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)="A",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)="U" S PSGP=$P(PSGND,U,15) D UD^PSJOEA
"RTN","PSJOEA2",57,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)="A",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)="U" S PSGP=$P(PSGND,U,15) D UD^PSJOEA
"RTN","PSJOEA2",58,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)'="U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",17)="A" S DFN=$S($G(PSGP)]"":PSGP,1:$P(PSGND,U,15)) D IV^PSJOEA
"RTN","PSJOEA2",59,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)'="U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",17)="A" S DFN=$S($G(PSGP)]"":PSGP,1:$P(PSGND,U,15)) D IV^PSJOEA
"RTN","PSJOEA2",60,0)
 K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),PSJOWALL
"RTN","PSJOEA2",61,0)
 Q
"RTN","PSJORP2")
0^34^B19054632
"RTN","PSJORP2",1,0)
PSJORP2 ;BIR/JCH-CALCULATE FIRST DOSE FOR OE/RR 3.0 ;27 Feb 03 / 9:40 AM
"RTN","PSJORP2",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**80,110,111,133**;16 DEC 97
"RTN","PSJORP2",3,0)
 ;
"RTN","PSJORP2",4,0)
 Q
"RTN","PSJORP2",5,0)
ENQ(PSGP,INFO) ; start
"RTN","PSJORP2",6,0)
 ; INFO (piece 1) = START DATE/TIME
"RTN","PSJORP2",7,0)
 ; INFO (piece 2) = STOP DATE/TIME
"RTN","PSJORP2",8,0)
 ; INFO (piece 3) = SCHEDULE
"RTN","PSJORP2",9,0)
 ; INFO (piece 4) = SCHEDULE TYPE
"RTN","PSJORP2",10,0)
 ; INFO (piece 5) = ORDERABLE ITEM
"RTN","PSJORP2",11,0)
 ; INFO (piece 6) = ADMIN TIMES
"RTN","PSJORP2",12,0)
 ;
"RTN","PSJORP2",13,0)
 N PSGNESD,PSGSD,PSGNEFD,PSGFD,PSGSCH,PSGST,PST,PSGS0XT,PSGS0Y,PSGED,SCHFREQ,FIRST,PSGDF,PSGS
"RTN","PSJORP2",14,0)
 S (PSGSD,PSGNESD)=$P(INFO,U),(PSGFD,PSGNEFD)=$P(INFO,U,2),PSGSCH=$P(INFO,U,3),(PSGST,PST)=$P(INFO,U,4),PSGS0Y=$P(INFO,U,6)
"RTN","PSJORP2",15,0)
 S PSGST=$S(PSGST="O":"O",1:"C"),PSGS0XT="",FIRST=""
"RTN","PSJORP2",16,0)
 Q:'PSGSD "" S X=PSGSCH D ADMIN^PSJORPOE
"RTN","PSJORP2",17,0)
 I ($P(INFO,"^",6)]""),($G(PSGS0Y)'=$P(INFO,"^",6)) S PSGS0Y=$P(INFO,"^",6)
"RTN","PSJORP2",18,0)
 I $G(PSJLSTAT),'$G(PSGS0XT),'$$DOW^PSIVUTL(PSGSCH) D
"RTN","PSJORP2",19,0)
 .N D,DA,X,PSGAT,PSGOES,PSGST,PSJNSS,PSJPWD,TEST,VALMBCK,PSGS0Y,PSGDT S X=$P(INFO,"^",3) I X]"" S PSGOES=1 D EN^PSGORS0
"RTN","PSJORP2",20,0)
 I '$G(PSJLSTAT) S X2=$S(PSGS0XT>1440:(PSGS0XT\1440)+1,1:7),X1=PSGSD D C^%DTC S (PSGFD,PSGNEFD)=X
"RTN","PSJORP2",21,0)
 I 'PSGS0Y S:PSGSCH["@" PSGS0Y=$P(PSGSCH,"@",2) I 'PSGS0Y S PSGS0Y=$P(PSGSD,".",2) I $G(PSGST)'="O",($E(PSGS0Y,1,2)<23),($P($G(PSJSYSW0),"^",5)=1) D
"RTN","PSJORP2",22,0)
 . I $L($P(PSGSD,".",2))<3 S DCAL=$P(PSGSD,".",2) Q
"RTN","PSJORP2",23,0)
 . N DCAL S DCAL=$E($$FMADD^XLFDT(PSGSD,0,1,0,0),9,10) S:DCAL PSGS0Y=DCAL
"RTN","PSJORP2",24,0)
 S PSGS=$S(PSGST="C":1,PSGST="P":2,PSGST="O":4,1:"")
"RTN","PSJORP2",25,0)
 S X2=PSGNESD,X1=PSGNEFD D ^%DTC S PSGDF=X+30
"RTN","PSJORP2",26,0)
 K PSGD S X=$P(PSGSD,"."),PSGDW="" F Q=0:1:PSGDF-1 S X1=$P(PSGSD,"."),X2=Q D:Q C^%DTC S PSGD(X)=$E(X,4,5)_"/"_$E(X,6,7),HX=X D DW^%DTC S $P(PSGD(HX),U,2)=X
"RTN","PSJORP2",27,0)
 D NOW^%DTC S PSGDT=%
"RTN","PSJORP2",28,0)
 S PST=PSGST,PSGED=PSGSD D OS(PSGP,PSGST)
"RTN","PSJORP2",29,0)
 I $D(PSGD)<10 Q ""
"RTN","PSJORP2",30,0)
 D PRT(X) I $G(PSJLSTAT) S:$G(LAST)>PSGFD LAST=PSGFD Q +$G(LAST)
"RTN","PSJORP2",31,0)
 I $G(FIRST)<PSGSD S FIRST=PSGSD
"RTN","PSJORP2",32,0)
 I $P(PSGSD,".")=$P(FIRST,"."),($P($G(^PS(59.6,+$G(PSJPWD),0)),"^",5)=2),'$G(PSGS0Y) S FIRST=PSGSD
"RTN","PSJORP2",33,0)
 K PSGD,TS,PSGGD,X,S,Q,QQ,QST
"RTN","PSJORP2",34,0)
 Q FIRST
"RTN","PSJORP2",35,0)
 ;
"RTN","PSJORP2",36,0)
OS(PSGP,PSGST) ; order record set
"RTN","PSJORP2",37,0)
 S SD=PSGNESD I $S($P(SD,".")>PSGNEFD:1,PSGS=1:PSGSCH["PRN",1:0) Q
"RTN","PSJORP2",38,0)
 S FD=PSGNEFD,T=PSGS0XT
"RTN","PSJORP2",39,0)
 S QST=$S(PST="C"!(PST="O"):PST,PST="OC":"OA",PST="P":"OP",PSGSCH["PRN":"OR",1:"CR")
"RTN","PSJORP2",40,0)
 S QQ="" I QST["C" D DTS(PSGSCH) S SD=$P(SD,"."),QQ="" F X=0:0 S X=$O(PSGD(X)) Q:'X  D
"RTN","PSJORP2",41,0)
 . S QQ=QQ_$S(X<SD:"",X>FD:"",'S:$P(PSGD(X),U),$D(S(X)):$P(PSGD(X),U),1:"")
"RTN","PSJORP2",42,0)
 I PSGS0XT="D",PSGS0Y="" S PSGS0Y=$P(PSGNESD,".",2)
"RTN","PSJORP2",43,0)
 S X=$S(QST["C"!(QST="O"):PSGS0Y,1:"")_U_QQ
"RTN","PSJORP2",44,0)
 Q
"RTN","PSJORP2",45,0)
 ;
"RTN","PSJORP2",46,0)
DTS(SCHEDULE) ;
"RTN","PSJORP2",47,0)
 K S S S=0 I SCHEDULE["@"!(PSGST="D") S WD=$S(SCHEDULE["@":$P(SCHEDULE,"@"),1:SCHEDULE) D
"RTN","PSJORP2",48,0)
 . F Q=0:0 S Q=$O(PSGD(Q)) Q:'Q  F QQ=1:1:$L(WD,"-") I $P($P(PSGD(Q),U,2),$P(WD,"-",QQ))="" S S(Q)="",S=S+1 Q
"RTN","PSJORP2",49,0)
 Q:SCHEDULE["@"!(T="D")  Q:T'>1440  S WD=$P(PSGSD,".") I '(T#1440) S (SD,X)=$P(SD,"."),PSGT=T\1440 D
"RTN","PSJORP2",50,0)
 . F QQ=0:1 S X1=SD,X2=QQ*PSGT D:X2 C^%DTC I X'<WD S S=S+1 Q:X>PSGFD  Q:X>FD  S S(X)=""
"RTN","PSJORP2",51,0)
 K PSGT Q:'(T#1440)  S PSGT=T,X1=PSGSD,(ST,X2)=SD I PSGSD>SD D ^%DTC I X>1 S ST=$$EN^PSGCT(SD,X-1*1440\T*T)
"RTN","PSJORP2",52,0)
 S (PSGS,X)=ST F PSGX=0:1 S AM=PSGT*PSGX,ST=PSGS S:AM X=$$EN^PSGCT(ST,AM) S X=$P(X,".") I X'<WD Q:X>PSGFD  Q:X>FD  I '$D(S(X)) S S=S+1,S(X)=""
"RTN","PSJORP2",53,0)
 K AM,ST,PSGS,PSGT,PSGX Q
"RTN","PSJORP2",54,0)
 ;
"RTN","PSJORP2",55,0)
PRT(PSGTS) ; order info
"RTN","PSJORP2",56,0)
 S PSGGD=$P(PSGTS,"^",2),PSGTS=$P(PSGTS,"^") S PSJPSTO=PST
"RTN","PSJORP2",57,0)
 D TS(PSGTS) D FIRST D:$G(PSJLSTAT) LAST
"RTN","PSJORP2",58,0)
 S PSGOC=$G(PSGOC)+1
"RTN","PSJORP2",59,0)
 Q
"RTN","PSJORP2",60,0)
 ;
"RTN","PSJORP2",61,0)
FIRST ; find expected first dose
"RTN","PSJORP2",62,0)
 N QTS,ADMIN S FIRST=""
"RTN","PSJORP2",63,0)
 I PST["CZ" NEW PSGLFFD,PSGGD S P(9)="",PSGLFFD="9999999",PSGGD="" Q
"RTN","PSJORP2",64,0)
 I TS=1,'PSGTS S P(9)=1 K P(9) Q
"RTN","PSJORP2",65,0)
 F Q=0:0 S Q=$O(PSGD(Q)) Q:'Q!$G(FIRST)  S ADMIN=0 F  S ADMIN=$O(TS(ADMIN)) Q:'ADMIN!$G(FIRST)  D
"RTN","PSJORP2",66,0)
 . S QTS=Q_"."_TS(ADMIN)
"RTN","PSJORP2",67,0)
 . S FIRST=$S(QTS<PSGSD:"",QTS'<PSGFD:"",PSGGD="":"",PSGGD[$P(PSGD(Q),"^"):QTS,1:"")
"RTN","PSJORP2",68,0)
 Q
"RTN","PSJORP2",69,0)
 ;
"RTN","PSJORP2",70,0)
LAST ; find expected last dose
"RTN","PSJORP2",71,0)
 N QTS,ADMIN S LAST=""
"RTN","PSJORP2",72,0)
 I PST["CZ" NEW PSGLFFD,PSGGD S P(9)="",PSGLFFD="9999999",PSGGD="" Q
"RTN","PSJORP2",73,0)
 I TS=1,'PSGTS S P(9)=1 K P(9) Q
"RTN","PSJORP2",74,0)
 S Q=99999999 F  S Q=$O(PSGD(Q),-1) Q:'Q!$G(LAST)  S ADMIN="" F  S ADMIN=$O(TS(ADMIN),-1) Q:'ADMIN!$G(LAST)  D
"RTN","PSJORP2",75,0)
 . S QTS=Q_"."_TS(ADMIN)
"RTN","PSJORP2",76,0)
 . S LAST=$S(QTS>PSGFD:"",QTS'>PSGSD:"",PSGGD="":"",PSGGD[$P(PSGD(Q),"^"):QTS,1:"")
"RTN","PSJORP2",77,0)
 Q
"RTN","PSJORP2",78,0)
 ;
"RTN","PSJORP2",79,0)
TS(X) ;
"RTN","PSJORP2",80,0)
 K TS S TS=$L(X,"-") F Q=1:1:TS S TS(Q)=$P(X,"-",Q)
"RTN","PSJORP2",81,0)
 Q
"RTN","PSJORP2",82,0)
 ;
"RTN","PSJORP2",83,0)
LASTAT(PSGP,INFO) ;
"RTN","PSJORP2",84,0)
 N LSTDT,PSJLSTAT S LASTAT=0,PSJLSTAT=1 S LASTAT=$$ENQ(PSGP,INFO)
"RTN","PSJORP2",85,0)
 I (LASTAT>$P(INFO,"^",2)!'LASTAT) S LASTAT=$P(INFO,"^",2)
"RTN","PSJORP2",86,0)
 K PSGD,TS,PSGGD,X,S,Q,QQ,QST
"RTN","PSJORP2",87,0)
 Q LASTAT
"RTN","PSJORPOE")
0^27^B33672695
"RTN","PSJORPOE",1,0)
PSJORPOE ;BIR/MLM,LDT-MISC. PROCEDURE CALLS FOR OE/RR 3.0 ;24 Feb 99 / 10:43 AM
"RTN","PSJORPOE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**50,56,92,80,110,127,133**;16 DEC 97
"RTN","PSJORPOE",3,0)
 ;
"RTN","PSJORPOE",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJORPOE",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJORPOE",6,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJORPOE",7,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSJORPOE",8,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJORPOE",9,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJORPOE",10,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJORPOE",11,0)
 ;
"RTN","PSJORPOE",12,0)
STARTSTP(PSGP,SCH,OI,PSJPWD,PSGORD) ;
"RTN","PSJORPOE",13,0)
 ; PSGP=Patient IEN
"RTN","PSJORPOE",14,0)
 ; SCH=Schedule
"RTN","PSJORPOE",15,0)
 ; OI=Orderable Item        
"RTN","PSJORPOE",16,0)
 ; PSJPWD=Ward Location (Optional)
"RTN","PSJORPOE",17,0)
 ; PSGORD=Pharmacy Order Number if the order being placed is a Renewal (Optional)
"RTN","PSJORPOE",18,0)
 ;
"RTN","PSJORPOE",19,0)
 Q:+PSGP'>0 ""
"RTN","PSJORPOE",20,0)
 Q:SCH']"" ""
"RTN","PSJORPOE",21,0)
 Q:+OI'>0 ""
"RTN","PSJORPOE",22,0)
 I SCH?.E1L.E S SCH=$$ENLU^PSGMI(SCH)
"RTN","PSJORPOE",23,0)
 K DFN,PSGNEFDO,PSGNEFD,PSGST,PSGSCH,PSGNEDFD,PSGNESD,PSJSYSW,PSJSYSW0 N RESULT
"RTN","PSJORPOE",24,0)
 S:'$D(PSGS0XT) PSGS0XT="" S:'$D(PSGS0Y) PSGSOY=""
"RTN","PSJORPOE",25,0)
 I $G(PSJPWD)']"" S DFN=PSGP D IN5^VADPT S:VAIP(5)]"" PSJPWD=+VAIP(5)
"RTN","PSJORPOE",26,0)
 S PSJSYSW0="",PSJSYSW=0 I $G(PSJPWD)]"" S PSJSYSW=+$O(^PS(59.6,"B",PSJPWD,0)) I PSJSYSW S PSJSYSW0=$G(^PS(59.6,PSJSYSW,0))
"RTN","PSJORPOE",27,0)
 S RESULT=$S($P(PSJSYSW0,"^",5)=0:"CLOSEST",$P(PSJSYSW0,"^",5)=1:"NEXT",1:"NOW")
"RTN","PSJORPOE",28,0)
 I OI]"" S PSGST=$S($P($G(^PS(50.7,OI,0)),"^",7)]"":$P($G(^PS(50.7,OI,0)),"^",7),1:"C")
"RTN","PSJORPOE",29,0)
 N %,PSGXSCH D NOW^%DTC S PSGDT=%,DFN=PSGP,(PSGSCH,PSGXSCH)=SCH
"RTN","PSJORPOE",30,0)
 S X=PSGSCH,PSGS0Y="" D ADMIN
"RTN","PSJORPOE",31,0)
 I $G(PSGORD)]"" D
"RTN","PSJORPOE",32,0)
 .S PSGNESD=$$DSTART^PSJDCU(PSGP,PSGORD) I PSGNESD]"" S RESULT=RESULT_"^"_PSGNESD Q
"RTN","PSJORPOE",33,0)
 .S ND=$S(PSGORD["U":$G(^PS(55,PSGP,5,+PSGORD,2)),1:$G(^PS(55,PSGP,"IV",+PSGORD,0)))
"RTN","PSJORPOE",34,0)
 .N PSJADM,PSJSTRT S PSJADM=$S(PSGORD["U":$P(ND,"^",5),1:$P(ND,"^",11)),PSJSTRT=$P(ND,"^",2),PSJREN=1
"RTN","PSJORPOE",35,0)
 S SCH=PSGXSCH
"RTN","PSJORPOE",36,0)
 I $G(PSGNESD)="" S RESULT=RESULT_"^"_$$ENSD^PSGNE3(PSGSCH,$S($G(PSJADM)]"":$G(PSJADM),1:PSGS0Y),PSGDT,$S($G(PSJSTRT)]"":$G(PSJSTRT),1:PSGDT))
"RTN","PSJORPOE",37,0)
 ;S Y=$P(RESULT,"^",2) X ^DD("DD") S RESULT=RESULT_"^"_Y
"RTN","PSJORPOE",38,0)
 S PSGNESD=$P(RESULT,"^",2)
"RTN","PSJORPOE",39,0)
 S PSGNEDFD=$$GTNEDFD^PSGOE7("U",OI)
"RTN","PSJORPOE",40,0)
 K PSGODF,PSGOES,PSJREN
"RTN","PSJORPOE",41,0)
 S SCH=PSGXSCH
"RTN","PSJORPOE",42,0)
 D ENFD^PSGNE3(PSGDT) S RESULT=RESULT_"^"_$G(PSGNEFD) ;_"^"_$G(PSGNEFDO)
"RTN","PSJORPOE",43,0)
 N DATE S DATE=$$FMDIFF^XLFDT($P(RESULT,"^",3),$P(RESULT,"^",2),3)
"RTN","PSJORPOE",44,0)
 S $P(RESULT,"^",3)=$S($G(PSGST)="O":0,+DATE>0:+DATE_"D",$P($P(DATE," ",2),":")>0:$P($P(DATE," ",2),":")_"H",1:0)
"RTN","PSJORPOE",45,0)
 ;S RESULT=RESULT_"^"_$P($$RESOLVE(PSGP,SCH,OI,"NEXT"),"^",2)
"RTN","PSJORPOE",46,0)
 N STRING S STRING=PSGNESD_U_PSGNEFD_U_$G(PSGSCH)_U_$G(PSGST)_U_$G(OI) I ($P($G(ZZND),U,2)]"")&($P($G(ZZND),"^")=$G(PSGSCH)) S STRING=STRING_U_$P(ZZND,U,2)
"RTN","PSJORPOE",47,0)
 I $G(PSGSCH)]"" I $$DOW^PSIVUTL(PSGSCH) S:$G(PSGS0Y) $P(STRING,"^",6)=PSGS0Y
"RTN","PSJORPOE",48,0)
 S RESULT=RESULT_"^"_$$ENQ^PSJORP2(PSGP,STRING) I ($G(PSGSCH)]"") I $$DOW^PSIVUTL(PSGSCH),(PSGSCH'["@"),'$G(PSGS0Y) S $P(RESULT,"^",4)=$P(RESULT,"^",2)
"RTN","PSJORPOE",49,0)
 I ($G(PSGSCH)]"") I $$PRNOK^PSGS0(PSGSCH) S $P(RESULT,"^",4)=$P(RESULT,"^",2)
"RTN","PSJORPOE",50,0)
 D KVAR^VADPT K LYN,ND,PSGDT,PSGNEDFD,PSGNEFD,PSGNEFDO,PSGNESD,PSGS0Y,PSGSCH,PSGST,PSJSYSW,PSJSYSW0,ZZ
"RTN","PSJORPOE",51,0)
 ;RESULT=WARD PARAMETER^DEFAULT START DATE/TIME^#_D(NUMBER OF DAYS ORDER LASTS) OR #_H(NUMBER OF HOURS ORDER LASTS)^EXPECTED FIRST DOSE
"RTN","PSJORPOE",52,0)
 Q RESULT
"RTN","PSJORPOE",53,0)
 ;
"RTN","PSJORPOE",54,0)
RESOLVE(PSGP,SCH,OI,PCH,PSJPWD) ;
"RTN","PSJORPOE",55,0)
 ; PSGP=Patient IEN
"RTN","PSJORPOE",56,0)
 ; SCH=Schedule
"RTN","PSJORPOE",57,0)
 ; OI=Orderable Item
"RTN","PSJORPOE",58,0)
 ; PCH=Providers Choice
"RTN","PSJORPOE",59,0)
 ; PSJPWD=Ward Location (Optional)
"RTN","PSJORPOE",60,0)
 ;
"RTN","PSJORPOE",61,0)
 N PSJSYSW0,PSJSYSW,PSGSCH,PSGOES,PSGS0Y,DFN,RESULT1
"RTN","PSJORPOE",62,0)
 I $G(PSJPWD)']"" S DFN=PSGP D IN5^VADPT S:VAIP(5)]"" PSJPWD=+VAIP(5)
"RTN","PSJORPOE",63,0)
 S PSJSYSW0="",PSJSYSW=0 I $G(PSJPWD)]"" S PSJSYSW=+$O(^PS(59.6,"B",PSJPWD,0)) I PSJSYSW S PSJSYSW0=$G(^PS(59.6,PSJSYSW,0))
"RTN","PSJORPOE",64,0)
 S $P(PSJSYSW0,"^",5)=$S($$ONE(SCH):2,PCH="NEXT":1,1:0)
"RTN","PSJORPOE",65,0)
 S RESULT1=$S($P(PSJSYSW0,"^",5)=0:"CLOSEST",$P(PSJSYSW0,"^",5)=1:"NEXT",1:"NOW")
"RTN","PSJORPOE",66,0)
 I OI]"" S PSGST=$S($P($G(^PS(50.7,OI,0)),"^",7)]"":$P($G(^PS(50.7,OI,0)),"^",7),1:"C")
"RTN","PSJORPOE",67,0)
 N % D NOW^%DTC S PSGDT=%,DFN=PSGP,PSGSCH=SCH
"RTN","PSJORPOE",68,0)
 S X=PSGSCH,PSGS0Y="" I $D(^PS(51.1,"AC","PSJ",X)) D ADMIN
"RTN","PSJORPOE",69,0)
 S RESULT1=RESULT1_"^"_$$ENSD^PSGNE3(SCH,PSGS0Y,PSGDT,PSGDT)
"RTN","PSJORPOE",70,0)
 I $G(PSGSCH)]"" I $$DOW^PSIVUTL(PSGSCH),(PSGSCH'["@"),'$G(PSGS0Y) S $P(RESULT,"^",4)=$P(RESULT,"^",2)
"RTN","PSJORPOE",71,0)
 I $G(PSGSCH)]"" I $$PRNOK^PSGS0(PSGSCH) S $P(RESULT1,"^",4)=$P(RESULT,"^",2)
"RTN","PSJORPOE",72,0)
 D KVAR^VADPT K LYN,PSGDT,PSGNEDFD,PSGNEFD,PSGNEFDO,PSGNESD,PSGS0Y,PSGSCH,PSGST,PSJSYSW,PSJSYSW0,ZZ,PSGS0XT,PSGS0Y
"RTN","PSJORPOE",73,0)
 Q RESULT1
"RTN","PSJORPOE",74,0)
 ;
"RTN","PSJORPOE",75,0)
SCHREQ(MR,OI,DD)  ;
"RTN","PSJORPOE",76,0)
 ; MR=Medication Route from 51.2 (Required)
"RTN","PSJORPOE",77,0)
 ; OI=Orderable Item from 50.7 (Optional)
"RTN","PSJORPOE",78,0)
 ; DD=Dispense Drug from 50 (Optional)
"RTN","PSJORPOE",79,0)
 N ADDITIVE,SOLUTION,REQ S REQ=0,(SOLUTION,ADDITIVE)=""
"RTN","PSJORPOE",80,0)
 I '+$G(MR) S REQ=1 Q REQ
"RTN","PSJORPOE",81,0)
 I '+$G(OI),'+$G(DD) S REQ=1 Q REQ
"RTN","PSJORPOE",82,0)
 I +$G(DD) S:$P($G(^PSDRUG(+DD,2)),U,3)["U" REQ=1 Q REQ
"RTN","PSJORPOE",83,0)
 I '$D(PS(51.2,+MR,0)) S REQ=1 Q REQ
"RTN","PSJORPOE",84,0)
 I $P($G(^PS(51.2,+MR,0)),"^",6)=1 D
"RTN","PSJORPOE",85,0)
 .I +$G(OI) D
"RTN","PSJORPOE",86,0)
 ..I '$D(^PS(50.7,+OI,0)) S REQ=1 Q
"RTN","PSJORPOE",87,0)
 ..F  S SOLUTION=$O(^PS(52.7,"AOI",+OI,SOLUTION)) Q:'SOLUTION  Q:REQ=1  S:$P(^PSDRUG(+$P(^PS(52.7,SOLUTION,0),U,2),2),U,3)["U" REQ=1
"RTN","PSJORPOE",88,0)
 ..F  S ADDITIVE=$O(^PS(52.6,"AOI",+OI,ADDITIVE)) Q:'ADDITIVE  Q:REQ=1  S:$P(^PSDRUG(+$P(^PS(52.6,ADDITIVE,0),U,2),2),U,3)["U" REQ=1
"RTN","PSJORPOE",89,0)
 Q REQ
"RTN","PSJORPOE",90,0)
 ;
"RTN","PSJORPOE",91,0)
ADMIN ; Get admin times associated with schedule
"RTN","PSJORPOE",92,0)
 S PSGS0Y="",ZZ=0
"RTN","PSJORPOE",93,0)
 I $$DOW^PSIVUTL(X),'$D(^PS(51.1,"AC","PSJ",X)) S PSGST="D" D  Q
"RTN","PSJORPOE",94,0)
 .I $P(X,"@",2) N PSJADBAD D  I '$G(PSJADBAD) S PSGS0Y=$P(X,"@",2)
"RTN","PSJORPOE",95,0)
 ..N ADMIN,TIME,II S ADMIN=$P(X,"@",2) F II=1:1:$L(ADMIN,"-") S TIME=$P(ADMIN,"-",II) I TIME'?2N&(TIME'?4N) S PSJADBAD=1
"RTN","PSJORPOE",96,0)
 .I '$G(PSGS0Y) S PSGS0Y=""
"RTN","PSJORPOE",97,0)
 D FIND^DIC(51.1,,,,X,,"APPSJ",,,"LYN")
"RTN","PSJORPOE",98,0)
 S ZZ=$O(LYN("DILIST",2,ZZ)) I ZZ S ZZ=+LYN("DILIST",2,ZZ) I ZZ S ZZND=$G(^PS(51.1,ZZ,0)) S PSGST=$P(ZZND,U,5),PSGS0XT=$P(ZZND,U,3) I $G(PSJPWD) D
"RTN","PSJORPOE",99,0)
 . N ZZNDW S ZZNDW=$G(^PS(51.1,ZZ,1,PSJPWD,0)) I $P(ZZNDW,"^",2)]"" S PSGS0Y=$P(ZZNDW,"^",2),$P(ZZND,"^",2)=PSGS0Y
"RTN","PSJORPOE",100,0)
 S ZZ=0 F  S ZZ=$O(LYN("DILIST",1,ZZ)) Q:'ZZ  I $G(LYN("DILIST",1,ZZ))'=X K LYN("DILIST",1,ZZ),LYN("DILIST",2,ZZ),LYN("DILIST","ID",ZZ,1)
"RTN","PSJORPOE",101,0)
 I $D(PSJPWD) S ZZ=0 F  S ZZ=$O(LYN("DILIST",2,ZZ)) Q:'ZZ  I $P($G(^PS(51.1,+LYN("DILIST",2,ZZ),1,+PSJPWD,0)),U,2)]"" S PSGS0Y=$P($G(^(0)),U,2)
"RTN","PSJORPOE",102,0)
 Q:PSGS0Y]""  S ZZ=0 F  S ZZ=$O(LYN("DILIST",2,ZZ)) Q:'ZZ  Q:PSGS0Y]""  I $G(LYN("DILIST","ID",ZZ,1))]"" S PSGS0Y=$G(LYN("DILIST","ID",ZZ,1))
"RTN","PSJORPOE",103,0)
 Q
"RTN","PSJORPOE",104,0)
 ;
"RTN","PSJORPOE",105,0)
ONE(SCH) ;
"RTN","PSJORPOE",106,0)
 ; SCH=Admin Schedule
"RTN","PSJORPOE",107,0)
 ; Returns 0 = (zero) Not a one time schedule.
"RTN","PSJORPOE",108,0)
 ;         1 =  One time schedule. 
"RTN","PSJORPOE",109,0)
 Q:$G(SCH)="" 0
"RTN","PSJORPOE",110,0)
 N X,SCHLST
"RTN","PSJORPOE",111,0)
 S SCHLST=",TODAY,ONCE,NOW,ONE TIME,ONETIME,ONE-TIME,1TIME,1 TIME,1-TIME,STAT,"
"RTN","PSJORPOE",112,0)
 I SCHLST[(","_SCH_",") Q 1
"RTN","PSJORPOE",113,0)
 I $D(^PS(51.1,"AC","PSJ",SCH)) S X=$O(^(SCH,"")) S X=$P(^PS(51.1,X,0),"^",5) Q $S(X="O":1,1:0)
"RTN","PSJORPOE",114,0)
 Q 0
"VER")
8.0^22.0
"BLD",4891,6)
^SEQ #126
**END**
**END**
