Released MD*1*2 SEQ #2
Extracted from mail message
**KIDS**:MD*1.0*2^

**INSTALL NAME**
MD*1.0*2
"BLD",4850,0)
MD*1.0*2^CLINICAL PROCEDURES^0^3040712^y
"BLD",4850,1,0)
^^2^2^3040114^
"BLD",4850,1,1,0)
Please refer to the National Patch Module for the detail of this patch 
"BLD",4850,1,2,0)
build.
"BLD",4850,4,0)
^9.64PA^^
"BLD",4850,"INID")
^y
"BLD",4850,"INIT")
MDPOSTI
"BLD",4850,"KRN",0)
^9.67PA^8989.52^19
"BLD",4850,"KRN",.4,0)
.4
"BLD",4850,"KRN",.401,0)
.401
"BLD",4850,"KRN",.402,0)
.402
"BLD",4850,"KRN",.403,0)
.403
"BLD",4850,"KRN",.5,0)
.5
"BLD",4850,"KRN",.84,0)
.84
"BLD",4850,"KRN",3.6,0)
3.6
"BLD",4850,"KRN",3.8,0)
3.8
"BLD",4850,"KRN",9.2,0)
9.2
"BLD",4850,"KRN",9.8,0)
9.8
"BLD",4850,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",4850,"KRN",9.8,"NM",1,0)
MDPS1^^0^B73206463
"BLD",4850,"KRN",9.8,"NM",2,0)
MDPS2^^0^B62406460
"BLD",4850,"KRN",9.8,"NM",3,0)
MDPFTP1^^0^B35842325
"BLD",4850,"KRN",9.8,"NM",4,0)
MDPFTP2^^0^B16086407
"BLD",4850,"KRN",9.8,"NM",5,0)
MDPFTP2A^^0^B46174785
"BLD",4850,"KRN",9.8,"NM",6,0)
MDPFTP3^^0^B28116832
"BLD",4850,"KRN",9.8,"NM",7,0)
MDPS3^^0^B8516931
"BLD",4850,"KRN",9.8,"NM","B","MDPFTP1",3)

"BLD",4850,"KRN",9.8,"NM","B","MDPFTP2",4)

"BLD",4850,"KRN",9.8,"NM","B","MDPFTP2A",5)

"BLD",4850,"KRN",9.8,"NM","B","MDPFTP3",6)

"BLD",4850,"KRN",9.8,"NM","B","MDPS1",1)

"BLD",4850,"KRN",9.8,"NM","B","MDPS2",2)

"BLD",4850,"KRN",9.8,"NM","B","MDPS3",7)

"BLD",4850,"KRN",19,0)
19
"BLD",4850,"KRN",19.1,0)
19.1
"BLD",4850,"KRN",101,0)
101
"BLD",4850,"KRN",409.61,0)
409.61
"BLD",4850,"KRN",771,0)
771
"BLD",4850,"KRN",870,0)
870
"BLD",4850,"KRN",8989.51,0)
8989.51
"BLD",4850,"KRN",8989.52,0)
8989.52
"BLD",4850,"KRN",8994,0)
8994
"BLD",4850,"KRN","B",.4,.4)

"BLD",4850,"KRN","B",.401,.401)

"BLD",4850,"KRN","B",.402,.402)

"BLD",4850,"KRN","B",.403,.403)

"BLD",4850,"KRN","B",.5,.5)

"BLD",4850,"KRN","B",.84,.84)

"BLD",4850,"KRN","B",3.6,3.6)

"BLD",4850,"KRN","B",3.8,3.8)

"BLD",4850,"KRN","B",9.2,9.2)

"BLD",4850,"KRN","B",9.8,9.8)

"BLD",4850,"KRN","B",19,19)

"BLD",4850,"KRN","B",19.1,19.1)

"BLD",4850,"KRN","B",101,101)

"BLD",4850,"KRN","B",409.61,409.61)

"BLD",4850,"KRN","B",771,771)

"BLD",4850,"KRN","B",870,870)

"BLD",4850,"KRN","B",8989.51,8989.51)

"BLD",4850,"KRN","B",8989.52,8989.52)

"BLD",4850,"KRN","B",8994,8994)

"BLD",4850,"QUES",0)
^9.62^^
"BLD",4850,"REQB",0)
^9.611^2^2
"BLD",4850,"REQB",1,0)
MD*1.0*1^2
"BLD",4850,"REQB",2,0)
MC*2.3*39^2
"BLD",4850,"REQB","B","MC*2.3*39",2)

"BLD",4850,"REQB","B","MD*1.0*1",1)

"INIT")
MDPOSTI
"MBREQ")
0
"PKG",365,-1)
1^1
"PKG",365,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",365,20,0)
^9.402P^^
"PKG",365,22,0)
^9.49I^1^1
"PKG",365,22,1,0)
1.0^3040429^2980529^363
"PKG",365,22,1,"PAH",1,0)
2^3040712
"PKG",365,22,1,"PAH",1,1,0)
^^2^2^3040712
"PKG",365,22,1,"PAH",1,1,1,0)
Please refer to the National Patch Module for the detail of this patch 
"PKG",365,22,1,"PAH",1,1,2,0)
build.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","MDPFTP1")
0^3^B35842325
"RTN","MDPFTP1",1,0)
MDPFTP1 ;HOIFO/NCA - PFT REPORT-DEMO INFO ;3/15/04  11:55
"RTN","MDPFTP1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPFTP1",3,0)
 ; Reference IA #10061 for VADPT call.
"RTN","MDPFTP1",4,0)
 ;              #10040 for HOSPITAL LOCATION FILE #44.
"RTN","MDPFTP1",5,0)
 ;              #10060 for NEW PERSON file #200.
"RTN","MDPFTP1",6,0)
 ;              #3175 for measurement API XLFMSMT
"RTN","MDPFTP1",7,0)
 ; ------------------------
"RTN","MDPFTP1",8,0)
 ; SSN = Enternal Format of the patients SSN with the first letter
"RTN","MDPFTP1",9,0)
 ; of the last name tacked on the end
"RTN","MDPFTP1",10,0)
 ; ------------------------
"RTN","MDPFTP1",11,0)
GET(MDGRS,MDF,MDR,MDPNAM,MDLNE,MDH) ; Return the PFT report in MDGRS
"RTN","MDPFTP1",12,0)
 Q:'$G(MDR)  N DFN
"RTN","MDPFTP1",13,0)
 S MCPFT0=$G(^MCAR(700,+MDR,0)),DFN=$P(MCPFT0,U,2) Q:MCPFT0=""
"RTN","MDPFTP1",14,0)
 D DEM^VADPT S MCARGNM=VADM(1),SSN=VA("PID")
"RTN","MDPFTP1",15,0)
 S X1=$E($P(MCPFT0,U),1,7),X2=$P(VADM(3),U)
"RTN","MDPFTP1",16,0)
 ; ---------------------
"RTN","MDPFTP1",17,0)
 ; AGE = the patients age at the date of the procedure
"RTN","MDPFTP1",18,0)
 ; ---------------------
"RTN","MDPFTP1",19,0)
 S AGE=$E(X1,1,3)-$E(X2,1,3)-($E(X1,4,7)<$E(X2,4,7))
"RTN","MDPFTP1",20,0)
 S RACE=$P(VADM(8),U,2),CLIN="" S:$P(MCPFT0,U,10) CLIN=$P(MCPFT0,U,10) I CLIN,$D(^SC(CLIN,0)) S CLIN=$P(^(0),U)
"RTN","MDPFTP1",21,0)
 N MCHOLD S MCHOLD=RACE,RACE=$$ETHN(MCHOLD,.VADM)
"RTN","MDPFTP1",22,0)
 S DATE=$P(MCPFT0,U),DATE=+$E(DATE,4,5)_"/"_+$E(DATE,6,7)_"/"_$E(DATE,2,3)_$S($P(DATE,".",2):"@"_+$E(DATE,9,10)_":"_$S($L($E(DATE,11,12))=2:$E(DATE,11,12),$L($E(DATE,11,12))=1:$E(DATE,11)_"0",1:"00"),1:"")
"RTN","MDPFTP1",23,0)
 N HTCM,HTIN,WTKG,WTLB
"RTN","MDPFTP1",24,0)
 S (HTIN,HT1)=$P(MCPFT0,U,4),(HTCM,HT)=$P($$LENGTH^XLFMSMT(HTIN,"IN","CM")," ")
"RTN","MDPFTP1",25,0)
 S (WTLB,WT1)=$P(MCPFT0,U,5),(WTKG,WT)=$P($$WEIGHT^XLFMSMT(WTLB,"LB","KG")," ")
"RTN","MDPFTP1",26,0)
 I HT'>0 S (HTCM,HT)=$P(MCPFT0,U,3),(HTIN,HT1)=$P($$LENGTH^XLFMSMT(HTCM,"CM","IN")," ")
"RTN","MDPFTP1",27,0)
 I WT'>0 S (WTKG,WT)=$P(MCPFT0,U,6),(WTLB,WT1)=$P($$WEIGHT^XLFMSMT(WTKG,"KG","LB")," ")
"RTN","MDPFTP1",28,0)
 S $P(MCDOT,".",81)=""
"RTN","MDPFTP1",29,0)
 S (MC17,MCEFF,MCSEX)="" S:$D(^MCAR(700,+MDR,17)) MC17=^(17),MCEFF=$P(MC17,U,6),MCEFF=$S(MCEFF="G":"GOOD",MCEFF="E":"EXCELLENT",MCEFF="P":"POOR",1:"")
"RTN","MDPFTP1",30,0)
 S MCSEX=$P(VADM(5),U),X=$P(VADM(3),"^",2) S MCARDOB=$S(X'="":X,1:""),X=$P(MCPFT0,U) D DTIME^MCARP S (MCARGDT,MCARGDT2)=X
"RTN","MDPFTP1",31,0)
 D INP^VADPT S MCARWARD=$S(VAIN(4)'="":$P(VAIN(4),U,2),1:"NOT INPATIENT"),MCARRB=VAIN(5) D NOW^%DTC S X=% D DTIME^MCARP S MCARDTM=X
"RTN","MDPFTP1",32,0)
 D HEAD^MDPS2
"RTN","MDPFTP1",33,0)
 S SS="SEX: "_MCSEX_"  AGE: "_AGE_$J(" ",10)_+$J(HT1,0,2)_" in/"_+$J(WT1,0,1)_" lb"
"RTN","MDPFTP1",34,0)
 S SS=SS_$J(" ",60-$L(SS))_"AMBIENT: "_$P(MCPFT0,U,12)_"C/"_$P(MCPFT0,U,7)_"T" K HT1,WT1 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP1",35,0)
 S SS="RACE: "_RACE S TECH=$P(MCPFT0,U,13) I TECH,$$GET1^DIQ(200,TECH_",",.01)'="" S TECH=$$GET1^DIQ(200,TECH_",",.01)
"RTN","MDPFTP1",36,0)
 I $L(RACE)>60 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP1",37,0)
 S SS=SS_$J(" ",60-$L(SS))_"TECH: "_$E(TECH,1,14) D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP1",38,0)
 S SS=$S($P(MCPFT0,U,8)="Y":"SMOKER",$P(MCPFT0,U,8)="N":"NON-SMOKER",1:"")
"RTN","MDPFTP1",39,0)
 S SS=SS_$J(" ",30-$L(SS))_$S($P(MCPFT0,U,9)="Y":"CURRENT BRONCHODILATOR USE",1:"")
"RTN","MDPFTP1",40,0)
 S SS=SS_$J(" ",60-$L(SS))_"EFFORT: "_MCEFF D SETNODE(MDGRS,SS)
"RTN","MDPFTP1",41,0)
 K ^UTILITY("DIQ1",$J) D SETNODE^MDPFTP1(MDGRS," "),SETNODE^MDPFTP1(MDGRS,"CONSULT DX: ") S DR(700.01)=.01,DIQ(0)="E",DIC="^MCAR(700,"
"RTN","MDPFTP1",42,0)
 F K=0:0 S K=$O(^MCAR(700,MDR,1,K)) Q:K'?1N.N  S DA=MDR,DA(700.01)=K,DR=11,DIQ(0)="E" D EN^DIQ1 I $D(^UTILITY("DIQ1",$J,700.01,K,.01,"E"))#2 D SETNODE(MDGRS,$J(" ",15)_$G(^("E")))
"RTN","MDPFTP1",43,0)
 K ^UTILITY("DIQ1",$J),DIQ D SETNODE(MDGRS,MCDOT) D PRED
"RTN","MDPFTP1",44,0)
 S RDATE=9999999.9999-$P(MCPFT0,U)
"RTN","MDPFTP1",45,0)
 D:$D(MCRCN) SETNODE(MDGRS,MCRCN)
"RTN","MDPFTP1",46,0)
 D ^MDPFTP2,FOOTER^MDPS2
"RTN","MDPFTP1",47,0)
EXIT ; End of PFT Report process
"RTN","MDPFTP1",48,0)
 K ^UTILITY($J),MCOUT,ACT,AGE,CK,CLIN,D0,D1,DA,DATE,CI95
"RTN","MDPFTP1",49,0)
 K HB,PH,PACO2,PAO2,O2HB,COHB,FIO2,MHB,PAAO2,QSQT,CAO2,CVO2
"RTN","MDPFTP1",50,0)
 K DIC,DIW,DIWL,DIWR,DIWT,DLCOSB,DN,MCDOT,DR,FEV1,FRC,FVC,MC17
"RTN","MDPFTP1",51,0)
 K HT,I,J,K,MCARGNM,MCFF,MCK,MCN,MCPI,MCREC,MCREC1,MCVCN
"RTN","MDPFTP1",52,0)
 K MCREC2,MCTLCN,MCVN,MCX,MEAS,FEF2575,ND,ND1,P1,P2,PC,PD1,PD11,MCEFF
"RTN","MDPFTP1",53,0)
 K PD2,PD21,PF,MCPFT0,PG,PRED,MCPV,RACE,RDATE,RDATE1,RDATE2,RV,MCSEX
"RTN","MDPFTP1",54,0)
 K SSN,TAB,TECH,TLC,TYPE,UNIT,UNITS,VC,WT,X,Z,VA,MCRCN
"RTN","MDPFTP1",55,0)
 K MCMVVN,MVV,PMVV,MCSP,MCP1S0,MCP1S1,MCP1S2,MCP2S0,MCP2S1,MCP2S2
"RTN","MDPFTP1",56,0)
 K CDLCOSB,MCIAO1,MCIAO2,MCIDA,MCIDL,MCIDP,MCIFA,MCIFE
"RTN","MDPFTP1",57,0)
 K MCIFL,MCIFV,MCIPTL,MCIRV,MCITL,MCMAIN,MCP1,MCP2,MCRC,MCRCR
"RTN","MDPFTP1",58,0)
 K MCTYPEP,MCY,MCRC1,MCRC2,MCRC3,MCRC4,MCSTAT,MCFOOTER,MCOUNT
"RTN","MDPFTP1",59,0)
 K MCARRB,MCARDOB,MCARWARD,MCARDTM,MCARHDR,MCARZ,MCARGDT,MCARGDT2,MCDL,MCLNG
"RTN","MDPFTP1",60,0)
 D KVAR^VADPT
"RTN","MDPFTP1",61,0)
 Q
"RTN","MDPFTP1",62,0)
PRED S (DLCOSB,FEV1,FRC,FVC,FEF2575,PF,RV,TLC,VC,MVV,CTLC,CVC,CFRC,CRV,CFVC,CFEV1,CPF,CFEF2575,CMVV,CDLCOSB,ACT,COHB)=""
"RTN","MDPFTP1",63,0)
 S MCPV=$$MCPV(+MDR)
"RTN","MDPFTP1",64,0)
 I ('HT)!('WT)!('AGE)!(MCPV=0) Q
"RTN","MDPFTP1",65,0)
 D PREDS,MCRACE Q
"RTN","MDPFTP1",66,0)
MCRACE S MCRCR="",MCRC=$G(^MCAR(700.1,MCPV,"RC")) Q:MCRC=""
"RTN","MDPFTP1",67,0)
 S MCRCR=$G(^MCAR(700,+MDR,17)) Q:MCRCR=""  Q:$P(MCRCR,U,5)'="Y"
"RTN","MDPFTP1",68,0)
 N MCRAC,MCMRAC S MCMRAC=0
"RTN","MDPFTP1",69,0)
 S:RACE["ASIAN" MCMRAC=MCMRAC+1
"RTN","MDPFTP1",70,0)
 S:RACE["BLACK" MCMRAC=MCMRAC+1
"RTN","MDPFTP1",71,0)
 I MCMRAC>1 S MCRAC=$P(MCRCR,U,7),MCRAC=$S(MCRAC="A":"O",1:MCRAC)
"RTN","MDPFTP1",72,0)
 S MCRCR=$S(RACE["BLACK":"B",RACE["ASIAN":"O",1:"") Q:MCRCR=""
"RTN","MDPFTP1",73,0)
 I MCMRAC>1 S MCRCR=MCRAC Q:MCRCR=""
"RTN","MDPFTP1",74,0)
 F I=1:1:6 I $P(MCRC,U,I) S J=$P(MCRC,U,I) D:J
"RTN","MDPFTP1",75,0)
 .Q:'$D(^MCAR(700.2,J,0))  S J=$P(^(0),U,1)
"RTN","MDPFTP1",76,0)
 .S @("MCRC"_I)="S PRED="_J
"RTN","MDPFTP1",77,0)
 K J G ORIENTAL:MCRCR="O" K MCRC2,MCRC6
"RTN","MDPFTP1",78,0)
 I '$D(MCRC1),'$D(MCRC3),'$D(MCRC4),'$D(MCRC5) Q
"RTN","MDPFTP1",79,0)
 S:$D(MCRC1) MCRCN="TLC,VC,FVC,FEV1" S:$D(MCRC3) MCRCN=MCRCN_",FRC,RV" S:$D(MCRC4) MCRCN=MCRCN_",FEF25-75" S:$D(MCRC5) MCRCN=MCRCN_",MVV" S:$E(MCRCN,1)="," MCRCN=$E(MCRCN,2,35)
"RTN","MDPFTP1",80,0)
 G NOTE
"RTN","MDPFTP1",81,0)
SETNODE(NODE,VALUE) ;Set the node with the string
"RTN","MDPFTP1",82,0)
 S MDLNE=MDLNE+1,@NODE@(MDLNE,0)=VALUE
"RTN","MDPFTP1",83,0)
 Q
"RTN","MDPFTP1",84,0)
ORIENTAL I '$D(MCRC2),'$D(MCRC6) K MCRC1,MCRC3,MCRC4,MCRC5 Q
"RTN","MDPFTP1",85,0)
 S:$D(MCRC2) MCRC1=MCRC2 S:$D(MCRC6) MCRC5=MCRC6 K MCRC3,MCRC4,MCRC6 S MCRCN="TLC,VC,FVC,FEV1,MVV"
"RTN","MDPFTP1",86,0)
NOTE S MCRCN="NOTE: Race Correction on predicted values: "_MCRCN
"RTN","MDPFTP1",87,0)
 I $G(MCMRAC)>1 S MCRCN=MCRCN_$S(MCRCR="O":" - ASIAN",1:" - BLACK")
"RTN","MDPFTP1",88,0)
 Q
"RTN","MDPFTP1",89,0)
CONFID(MCPV,VALUE) ;
"RTN","MDPFTP1",90,0)
 Q $P(^MCAR(700.2,^MCAR(700.1,MCPV,VALUE),0),U,5)
"RTN","MDPFTP1",91,0)
PREDV(MCPV,VALUE)       ;
"RTN","MDPFTP1",92,0)
 N EXPRESS,FORMULA,IEN,RESULT
"RTN","MDPFTP1",93,0)
 S IEN=+$P($G(^MCAR(700.1,MCPV,VALUE)),U)
"RTN","MDPFTP1",94,0)
 S FORMULA=$P($G(^MCAR(700.2,IEN,0)),U)
"RTN","MDPFTP1",95,0)
 S RESULT=""
"RTN","MDPFTP1",96,0)
 I FORMULA]"" S EXPRESS="S RESULT="_FORMULA X EXPRESS
"RTN","MDPFTP1",97,0)
 Q $S(RESULT]"":RESULT,1:"")
"RTN","MDPFTP1",98,0)
MCPV(MCDA) ; Get the Predicted Value entry
"RTN","MDPFTP1",99,0)
 Q $S($D(^MCAR(700,MCDA,"PV")):^("PV"),1:0)
"RTN","MDPFTP1",100,0)
PREDS S BSA=+$$BSA(HT,WT),I="DLCOSB",DLCOSB=$$PREDV(MCPV,"DLCOSB"),CDLCOSB=$$CONFID(MCPV,"DLCOSB")
"RTN","MDPFTP1",101,0)
 S FEV1=$$PREDV(MCPV,"FEV1"),CFEV1=$$CONFID(MCPV,"FEV1")
"RTN","MDPFTP1",102,0)
 S FRC=$$PREDV(MCPV,"FRC"),CFRC=$$CONFID(MCPV,"FRC")
"RTN","MDPFTP1",103,0)
 S FVC=$$PREDV(MCPV,"FVC"),CFVC=$$CONFID(MCPV,"FVC")
"RTN","MDPFTP1",104,0)
 S FEF2575=$$PREDV(MCPV,"FEF2575"),CFEF2575=$$CONFID(MCPV,"FEF2575")
"RTN","MDPFTP1",105,0)
 S PF=$$PREDV(MCPV,"PF"),CPF=$$CONFID(MCPV,"PF")
"RTN","MDPFTP1",106,0)
 S RV=$$PREDV(MCPV,"RV"),CRV=$$CONFID(MCPV,"RV")
"RTN","MDPFTP1",107,0)
 S TLC=$$PREDV(MCPV,"TLC"),CTLC=$$CONFID(MCPV,"TLC")
"RTN","MDPFTP1",108,0)
 S VC=$$PREDV(MCPV,"VC"),CVC=$$CONFID(MCPV,"VC")
"RTN","MDPFTP1",109,0)
 S MVV=$$PREDV(MCPV,"MVV"),CMVV=$$CONFID(MCPV,"MVV")
"RTN","MDPFTP1",110,0)
 Q
"RTN","MDPFTP1",111,0)
BSA(HT,WT) ; Compute BSA
"RTN","MDPFTP1",112,0)
 D COMPUTE^MCARBSA
"RTN","MDPFTP1",113,0)
 Q X
"RTN","MDPFTP1",114,0)
ETHN(MCRSTR,MCETH) ; Get the Race and Ethnicity arrays and concat with Race
"RTN","MDPFTP1",115,0)
 N MCCTR,MCSTR,MCLP,MCX,Y
"RTN","MDPFTP1",116,0)
 S MCCTR=+$G(MCETH(12)),MCSTR=""
"RTN","MDPFTP1",117,0)
 I MCCTR F MCLP=1:1:MCCTR S MDX=$G(MCETH(12,MCLP)) S:$P(MDX,"^",2)'="" MCSTR=MCSTR_$S(MCSTR="":"",1:", ")_$P(MDX,"^",2)
"RTN","MDPFTP1",118,0)
 S Y=$S(MCSTR'="":MCSTR,1:MCRSTR)
"RTN","MDPFTP1",119,0)
 Q Y
"RTN","MDPFTP2")
0^4^B16086407
"RTN","MDPFTP2",1,0)
MDPFTP2 ; HOIFO/NCA - PFT REPORT-VOLUMES ;3/15/04  10:00
"RTN","MDPFTP2",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPFTP2",3,0)
 D SETVAR G FLOW:'$D(^MCAR(700,+MDR,3)),FLOW:'$O(^(3,0)) S MCX=0
"RTN","MDPFTP2",4,0)
 S HEAD1="VOLUMES" D HEAD1,HEAD2
"RTN","MDPFTP2",5,0)
VOL S MCMAIN=0,MCX=$O(^MCAR(700,+MDR,3,MCX)) G FLOW:MCX'?1N.N S MCREC=^(MCX,0),TYPE=$P(MCREC,U) S:(TYPE="I")!(TYPE="B") MCMAIN=1
"RTN","MDPFTP2",6,0)
 S ND="AV",ND1=3 D PRETEST S SS=""
"RTN","MDPFTP2",7,0)
 D SETNODE(MDGRS," ")
"RTN","MDPFTP2",8,0)
 S SS="     "_$S(TYPE="B":"BODY BOX",TYPE="I":"INERT GAS DILUTION",TYPE="N":"NITROGEN WASH OUT",1:"X-RAY PLANIMETRY") D PREVDATE
"RTN","MDPFTP2",9,0)
 I $P(MCREC,U,6)'="" S SS="(NOTES): "_$P(MCREC,U,6) D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2",10,0)
 S ACT=$P(MCREC,U,2) I ACT S MEAS="TLC",UNITS="L",PRED=TLC X:$D(MCRC1) MCRC1 S PC=2,CI95=$S(PRED:PRED-CTLC,1:"") D PRTLINE S:MCMAIN MCTLCN=ACT,MCITL=CI95,MCIPTL=PRED
"RTN","MDPFTP2",11,0)
 S ACT=$P(MCREC,U,3) I ACT S MEAS="VC",UNITS="L",PRED=VC X:$D(MCRC1) MCRC1 S PC=3,CI95=$S(PRED:PRED-CVC,1:"") D PRTLINE S:MCMAIN MCVCN=ACT
"RTN","MDPFTP2",12,0)
 S ACT=$P(MCREC,U,4) I ACT S MEAS="FRC",UNITS="L",PRED=FRC X:$D(MCRC3) MCRC3 S PC=4,CI95=$S(PRED:PRED+CFRC,1:"") D PRTLINU
"RTN","MDPFTP2",13,0)
 S ACT=$P(MCREC,U,5) I ACT S MEAS="RV",UNITS="L",PRED=RV X:$D(MCRC3) MCRC3 S PC=5,CI95=$S(PRED:PRED+CRV,1:"") D PRTLINU
"RTN","MDPFTP2",14,0)
 I $P(MCREC,U,2),$P(MCREC,U,5) S SS="     "_"RV/TLC"_"       %" S ACT=$P(MCREC,U,5)/$P(MCREC,U,2) S SS=SS_$J(" ",35-$L(SS))_$J(ACT*100,5,0) D SETNODE(MDGRS,SS) S:MCMAIN&(ACT>.35) MCIRV=1
"RTN","MDPFTP2",15,0)
 G VOL
"RTN","MDPFTP2",16,0)
FLOW K CTLC,CVC,CFRC,CRV G ^MDPFTP2A
"RTN","MDPFTP2",17,0)
EXIT Q
"RTN","MDPFTP2",18,0)
SETVAR S (MCVCN,MCTLCN,MCMVVN,MCIRV,MCIFA,MCIFL,MCIPTL,MCIFE,MCIFV,MCIDA,MCIDL,MCIDP,MCIAO2,MCIAO1,MCITL)="",MCDL=2,MCLNG=5,PRED=0 Q
"RTN","MDPFTP2",19,0)
PRTLINE S MCP1=$G(MCP1),MCP2=$G(MCP2),SS=""
"RTN","MDPFTP2",20,0)
 S SS="     "_MEAS,SS=SS_$J(" ",18-$L(SS))_UNITS,SS=SS_$J("",25-$L(SS))_$S(PRED:$J(PRED,MCLNG,MCDL),1:"")
"RTN","MDPFTP2",21,0)
 S SS=SS_$J(" ",35-$L(SS))_$J(ACT,MCLNG,MCDL),SS=SS_$J(" ",45-$L(SS))_$S(PRED:$J(ACT/PRED*100,5,1),1:"")
"RTN","MDPFTP2",22,0)
 S:$P(MCP1,U,PC) SS=SS_$J(" ",55-$L(SS))_$J($P(MCP1,U,PC),MCLNG,MCDL) S:$P(MCP2,U,PC) SS=SS_$J(" ",65-$L(SS))_$J($P(MCP2,U,PC),MCLNG,MCDL)
"RTN","MDPFTP2",23,0)
 S:(CI95)&(CI95'=PRED) SS=SS_$J(" ",72-$L(SS))_" "_$J(CI95,6,2)
"RTN","MDPFTP2",24,0)
 D SETNODE(MDGRS,SS) S SS="" Q
"RTN","MDPFTP2",25,0)
PRTLINU S SS="" S SS="     "_MEAS,SS=SS_$J(" ",18-$L(SS))_UNITS,SS=SS_$J(" ",25-$L(SS))_$S(PRED:$J(PRED,MCLNG,MCDL),1:"")
"RTN","MDPFTP2",26,0)
 S SS=SS_$J(" ",35-$L(SS))_$J(ACT,MCLNG,MCDL),SS=SS_$J(" ",45-$L(SS))_$S(PRED:$J(ACT/PRED*100,5,1),1:"")
"RTN","MDPFTP2",27,0)
 S:$P(MCP1,U,PC) SS=SS_$J(" ",55-$L(SS))_$J($P(MCP1,U,PC),MCLNG,MCDL) S:$P(MCP2,U,PC) SS=SS_$J(" ",65-$L(SS))_$J($P(MCP2,U,PC),MCLNG,MCDL)
"RTN","MDPFTP2",28,0)
 S:(CI95)&(CI95'=PRED) SS=SS_$J(" ",72-$L(SS))_"U"_$J(CI95,6,2)
"RTN","MDPFTP2",29,0)
 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2",30,0)
 Q
"RTN","MDPFTP2",31,0)
HEAD1 D SETNODE(MDGRS," "),SETNODE(MDGRS," ")
"RTN","MDPFTP2",32,0)
 S SS=$J(" ",15)_"UNITS"_"     "_$S('$D(MCSP):"PRED",1:"")
"RTN","MDPFTP2",33,0)
 S SS=SS_$J(" ",35-$L(SS))_"ACTUAL"_"     "_$S('$D(MCSP):"%PRED",1:"")
"RTN","MDPFTP2",34,0)
 S SS=SS_$J(" ",55-$L(SS))_"PREV1"_"     "_"PREV2"
"RTN","MDPFTP2",35,0)
 I '$D(MCSP) S SS=SS_$J(" ",73-$L(SS))_"CI"
"RTN","MDPFTP2",36,0)
 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2",37,0)
 Q
"RTN","MDPFTP2",38,0)
HEAD2 D SETNODE(MDGRS,HEAD1_$E(MCDOT,1,80-$L(HEAD1))) Q
"RTN","MDPFTP2",39,0)
PREVDATE F I="RDATE1","RDATE2" I $D(@I),@I S X=9999999.9999-@I S TAB=$S(I="RDATE1":55,1:65) S SS=SS_$J(" ",TAB-$L(SS))_+$E(X,4,5)_"/"_+$E(X,6,7)_"/"_$E(X,2,3)
"RTN","MDPFTP2",40,0)
 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2",41,0)
 Q
"RTN","MDPFTP2",42,0)
PRETEST S (MCP1,MCP2,MCP1S0,MCP2S0,MCP1S1,MCP1S2,MCP2S1,MCP2S2,RDATE1,RDATE2)=""
"RTN","MDPFTP2",43,0)
 Q:'$O(^MCAR(700,ND,DFN,TYPE,RDATE))  S RDATE1=$O(^(RDATE)),PD11=$O(^(RDATE1,0)),PD1=$O(^(PD11,0))
"RTN","MDPFTP2",44,0)
 S (MCP1,MCP1S0)=^MCAR(700,PD11,ND1,PD1,0) I ND="AS" S:$D(^(1)) MCP1S1=^(1) S:$D(^(2)) MCP1S2=^(2)
"RTN","MDPFTP2",45,0)
 K PD1,PD11 Q:'$O(^MCAR(700,ND,DFN,TYPE,RDATE1))  S RDATE2=$O(^(RDATE1)),PD21=$O(^(RDATE2,0)),PD2=$O(^(PD21,0))
"RTN","MDPFTP2",46,0)
 S (MCP2,MCP2S0)=^MCAR(700,PD21,ND1,PD2,0) I ND="AS" S:$D(^(1)) MCP2S1=^(1) S:$D(^(2)) MCP2S2=^(2)
"RTN","MDPFTP2",47,0)
 K PD2,PD21 Q
"RTN","MDPFTP2",48,0)
SETNODE(NODE,VALUE) ;Set the node with the string
"RTN","MDPFTP2",49,0)
 S MDLNE=MDLNE+1,@NODE@(MDLNE,0)=VALUE
"RTN","MDPFTP2",50,0)
 Q
"RTN","MDPFTP2A")
0^5^B46174785
"RTN","MDPFTP2A",1,0)
MDPFTP2A ; HOIFO/NCA - PFT REPORT-FLOWS ;3/17/04  08:22
"RTN","MDPFTP2A",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPFTP2A",3,0)
FLOW G DIF:'$D(^MCAR(700,+MDR,4)),DIF:'$O(^(4,0)) S MCX=0
"RTN","MDPFTP2A",4,0)
 S HEAD1="FLOWS" D HEAD1^MDPFTP2,HEAD2^MDPFTP2,SETNODE(MDGRS," ")
"RTN","MDPFTP2A",5,0)
 I MC17'="" S MC17A=$P(MC17,U,2),SS="MACHINE: "_$S(MC17A="F":"FLOW TURBINE",MC17A="P":"PNEUMOTACH",MC17A="A":"ANEMOMETER",MC17A="DS":"DRY WATER SEAL",MC17A="WS":"WATER SEAL",MC17A="W":"WEDGE",1:"") K MC17A D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",6,0)
FLOW1 S MCX=$O(^MCAR(700,MDR,4,MCX)) G DIF:MCX'?1N.N S MCREC=^(MCX,0),TYPE=$P(MCREC,U)
"RTN","MDPFTP2A",7,0)
 D SETNODE(MDGRS," ")
"RTN","MDPFTP2A",8,0)
 S ND="AF",ND1=4 D PRETEST^MDPFTP2 S SS=""
"RTN","MDPFTP2A",9,0)
 S SS="    "_$S(TYPE="S":"STANDARD STUDY",TYPE="B":"AFTER BRONCHODILATOR",TYPE="I":"AFTER INHALATION CHALLENGE",1:"AFTER EXERCISE") D PREVDATE^MDPFTP2
"RTN","MDPFTP2A",10,0)
 I $P(MCREC,U,6)'="" D SETNODE(MDGRS,"    "_"(NOTES): "_$P(MCREC,U,6))
"RTN","MDPFTP2A",11,0)
 S ACT=$P(MCREC,U,2) I ACT S MEAS="FVC",UNITS="L",PRED=FVC X:$D(MCRC1) MCRC1 S PC=2,CI95=$S(PRED:PRED-CFVC,1:"") D PRTLINE S:TYPE="S" MCIFA=ACT,MCIFL=CI95
"RTN","MDPFTP2A",12,0)
 S ACT=$P(MCREC,U,3) I ACT S MEAS="FEV1",UNITS="L",PRED=FEV1 X:$D(MCRC1) MCRC1 S PC=3,CI95=$S(PRED:PRED-CFEV1,1:"") D PRTLINE S:TYPE="S" MCIFE=ACT
"RTN","MDPFTP2A",13,0)
 S MCDL=3,MCLNG=6,ACT=$P(MCREC,U,4) I ACT S MEAS="PF",UNITS="L/SEC",PRED=PF,PC=4,CI95=$S(PRED:PRED-CPF,1:"") D PRTLINE
"RTN","MDPFTP2A",14,0)
 S ACT=$P(MCREC,U,5) I ACT S MEAS="FEF25-75",UNITS="L/SEC",PRED=FEF2575 X:$D(MCRC4) MCRC4 S PC=5,CI95=$S(PRED:PRED-CFEF2575,1:"") D PRTLINE
"RTN","MDPFTP2A",15,0)
 S MCDL=2,MCLNG=5,ACT=$P(MCREC,U,7) I ACT S MEAS="MVV",UNITS="L/MIN",PRED=MVV X:$D(MCRC5) MCRC5 S PC=7,CI95=$S(PRED:PRED-CMVV,1:"") S:TYPE="S" MCMVVN=ACT D PRTLINE
"RTN","MDPFTP2A",16,0)
 I $P(MCREC,U,2),$P(MCREC,U,3) S SS="     FEV1/FVC    %" S ACT=$P(MCREC,U,3)/$P(MCREC,U,2) S SS=SS_$J(" ",35-$L(SS))_$J(ACT*100,5,0) S:TYPE="S" MCIFV=ACT D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",17,0)
 G FLOW1
"RTN","MDPFTP2A",18,0)
DIF K CFVC,CFEV1,CPF,CFEF2575,CMVV G ABG:'$D(^MCAR(700,MDR,5)) S (ACT,MCIDA)=^(5) G ABG:'ACT
"RTN","MDPFTP2A",19,0)
 I '$D(HEAD1) S HEAD1="DIFFUSION" D HEAD1^MDPFTP2,HEAD2^MDPFTP2
"RTN","MDPFTP2A",20,0)
 E  S HEAD1="DIFFUSION" D SETNODE(MDGRS," "),HEAD2^MDPFTP2
"RTN","MDPFTP2A",21,0)
 I MC17'="" S MC17A=$P(MC17,U,4) D SETNODE(MDGRS,"  METHOD: "_$S(MC17A=1:"SINGLE BREATH",MC17A=2:"STEADY STATE",1:"")) K MC17A
"RTN","MDPFTP2A",22,0)
DIF0 S (MCIDP,PRED)=DLCOSB,UNITS="L",MEAS="DLCO-SB",PC=1
"RTN","MDPFTP2A",23,0)
 S (P1,P2)="" S RDATE1=$O(^MCAR(700,"ADI",DFN,RDATE)) I RDATE1 S P1=$O(^(RDATE1,0))
"RTN","MDPFTP2A",24,0)
 G DIF1:'P1 S MCP1=$G(^MCAR(700,P1,5))
"RTN","MDPFTP2A",25,0)
 S RDATE2=$O(^MCAR(700,"ADI",DFN,RDATE1)) I RDATE2 S P2=$O(^(RDATE2,0)) I P2 S MCP2=$G(^MCAR(700,P2,5))
"RTN","MDPFTP2A",26,0)
DIF1 D:P1 PREVDATE^MDPFTP2 S (MCIDL,CI95)=$S(PRED:PRED-CDLCOSB,1:"") D PRTLINE
"RTN","MDPFTP2A",27,0)
 G ABG:'$D(^MCAR(700,MDR,6))
"RTN","MDPFTP2A",28,0)
 I $G(MCPV)<1 S MCPV=$$MCPV^MDPFTP1(MDR)
"RTN","MDPFTP2A",29,0)
 S MCHB=$G(^MCAR(700.1,MCPV,"HB")),MCCOHB=$G(^("COHB"))
"RTN","MDPFTP2A",30,0)
 I MCHB="",MCCOHB="" G ABG
"RTN","MDPFTP2A",31,0)
 G HB:$P(MCCOHB,U)="" S MCCOHB=$G(^MCAR(700.2,MCCOHB,0)) G HB:MCCOHB="" S COHB=""
"RTN","MDPFTP2A",32,0)
 S I=0 F  S I=$O(^MCAR(700,MDR,6,I)) Q:I'?1N.N  I $D(^(I,0)),$P(^(0),U,7) S COHB=$P(^(0),U,7)
"RTN","MDPFTP2A",33,0)
 G HB:COHB="" X "S MCCOHB="_$P(MCCOHB,U)
"RTN","MDPFTP2A",34,0)
HB G ABG:$P(MCHB,U)="" S MCHB=$G(^MCAR(700.2,MCHB,0)) G ABG:MCHB=""
"RTN","MDPFTP2A",35,0)
 S HB="",I=0 F  S I=$O(^MCAR(700,MDR,6,I)) Q:I'?1N.N  I $D(^(I,0)),$P(^(0),U,2) S HB=$P(^(0),U,2)
"RTN","MDPFTP2A",36,0)
 G ABG:'HB X "S MCHB="_$P(MCHB,U)
"RTN","MDPFTP2A",37,0)
 ;W !,"Corrected DLCO for HB: ",$J(MCHB,8,2)
"RTN","MDPFTP2A",38,0)
 ; Actual Line of Code below before Mod for Washington on Over-Correction
"RTN","MDPFTP2A",39,0)
 ; of the DLCO for HB & COHB
"RTN","MDPFTP2A",40,0)
 ;W !,"Corr DLCO for HB & COHB:",?19,$J(MCIDL,6,2),?32,$J(MCHB,8,2),?42,$S(MCIDL'=0:$J(MCHB/MCIDL*100,8,1),1:"")
"RTN","MDPFTP2A",41,0)
 S SS="Corr DLCO for HB & COHB:"_$S(PRED:$J(PRED,6,2),1:"      ")_"  "_$J(MCHB,8,2)_"  "_$S(MCIDL'=0:$J(MCHB/PRED*100,8,1),1:"") D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",42,0)
ABG K HB,COHB,MCHB,MCCOHB
"RTN","MDPFTP2A",43,0)
 K HEAD1 G SPEC:'$D(^MCAR(700,+MDR,6)),SPEC:'$D(^(6,0))
"RTN","MDPFTP2A",44,0)
 D SETNODE(MDGRS," "),SETNODE(MDGRS," ")
"RTN","MDPFTP2A",45,0)
 D SETNODE(MDGRS,"BLOOD GASES"_$E(MCDOT,1,69))
"RTN","MDPFTP2A",46,0)
ABG0 D SETNODE(MDGRS," "),SETNODE(MDGRS," ") S SS=""
"RTN","MDPFTP2A",47,0)
 S SS="STUDY TYPE"_"      pH    pCO2  pO2     O2HB   COHB MHB    HB   FiO2 A-aO2  QS/QT" D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",48,0)
 S SS="  (NORMAL)  7.36-7.44 36-44 80-100 >88%    <3%  <2%              <22" D SETNODE(MDGRS,SS) S SS="",MCX=0
"RTN","MDPFTP2A",49,0)
ABG1 S MCX=$O(^MCAR(700,+MDR,6,MCX)) G SPEC:MCX'?1N.N S MCREC=^(MCX,0),TYPE=$P(MCREC,U)
"RTN","MDPFTP2A",50,0)
 S MCTYPEP=$S(TYPE="R":"ROOM AIR",TYPE="O":"100% O2 STUDY",TYPE="X":"POST EXERCISE",TYPE="M":"MAX EXERCISE",TYPE="P":"PRE EXERCISE",1:"SUPPLEMENTAL O2 STUDY")
"RTN","MDPFTP2A",51,0)
 S HB=$P(MCREC,U,2),PH=$P(MCREC,U,3),PACO2=$P(MCREC,U,4),PAO2=$P(MCREC,U,5),O2HB=$P(MCREC,U,6),COHB=$P(MCREC,U,7),FIO2=$P(MCREC,U,8),MHB=$P(MCREC,U,9)
"RTN","MDPFTP2A",52,0)
 S (PAAO2,QSQT)=0 G ABG2:FIO2="" S PAAO2=($P(MCPFT0,U,7)-47)*FIO2-(PACO2/.8)-PAO2 S:PAAO2<0 PAAO2=0
"RTN","MDPFTP2A",53,0)
 G ABG2:PAO2="" S CAO2=(.003*650)+(1.36*HB),CAO2(1)=(.003*PAO2)+(1.36*HB*(O2HB/100)),CVO2=CAO2(1)-5
"RTN","MDPFTP2A",54,0)
 I FIO2=1 S QSQT=CAO2-CAO2(1)/(CAO2-CVO2)
"RTN","MDPFTP2A",55,0)
ABG2 S SS=$E(MCTYPEP,1,13)_$J(" ",14-$L($E(MCTYPEP,1,13)))_$J(PH,6,3)_" "_$J(PACO2,5,1)_" "
"RTN","MDPFTP2A",56,0)
 S SS=SS_$J(PAO2,5,1)_"  "_$J(O2HB,5,1)_"%  "_$J(COHB,4,1)_"%"_$J(MHB,4,1)_"% "_$J(HB,5,1)_" "_$J(FIO2,5,3)_$S(PAAO2:$J(PAAO2,5,0),1:"     ")_" "_$S(QSQT:$J(QSQT,6,2),1:"")
"RTN","MDPFTP2A",57,0)
 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",58,0)
 S:TYPE="R" MCIAO2=PAO2,MCIAO1=PAAO2
"RTN","MDPFTP2A",59,0)
 D SETNODE(MDGRS,"PATIENT TEMPERATURE (C): "_$P(MCREC,U,11))
"RTN","MDPFTP2A",60,0)
 D:$P(MCREC,U,10)'="" SETNODE(MDGRS,"(NOTES): "_$P(MCREC,U,10)) G ABG1
"RTN","MDPFTP2A",61,0)
SPEC K HB,PH,PACO2,PAO2,O2HB,COHB,FIO2,MHB,PAAO2,QSQT,CAO2,CVO2
"RTN","MDPFTP2A",62,0)
 S CI95="" G INT:'$D(^MCAR(700,MDR,"S")),INT:'$O(^("S",0)) S MCX=0
"RTN","MDPFTP2A",63,0)
 D SETNODE(MDGRS," "),SETNODE(MDGRS," ")
"RTN","MDPFTP2A",64,0)
 S CI95="",HEAD1="SPECIAL STUDIES",MCSP="" D HEAD1^MDPFTP2,HEAD2^MDPFTP2
"RTN","MDPFTP2A",65,0)
SPEC1 S MCX=$O(^MCAR(700,MDR,"S",MCX)) G INT:MCX'?1N.N S MCREC=^(MCX,0),TYPE=$P(MCREC,U),(MCREC1,MCREC2)="" S:$D(^(1)) MCREC1=^(1) S:$D(^(2)) MCREC2=^(2)
"RTN","MDPFTP2A",66,0)
 S ND="AS",ND1="S" D PRETEST^MDPFTP2
"RTN","MDPFTP2A",67,0)
 D SETNODE(MDGRS," ") S SS="     "_$S(TYPE="E":"EXERCISE",TYPE="M":"MECHANICS",TYPE="S":"SMALL AIRWAY",1:"MAXIMUM PRESSURES") D PREVDATE^MDPFTP2
"RTN","MDPFTP2A",68,0)
 I MCREC2'="",$P(MCREC2,U,8)'="" D SETNODE(MDGRS,"    (NOTES): "_$P(MCREC2,U,8))
"RTN","MDPFTP2A",69,0)
 I TYPE="P" S ND=MCREC2,PC=7,MEAS="PiMAX",UNITS="cmH2O",MCP1=MCP1S2,MCP2=MCP2S2 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2 Q:$D(MCOUT)  G SPEC1
"RTN","MDPFTP2A",70,0)
 G:TYPE="E" ^MDPFTP3 S ND=MCREC G:TYPE="S" SMAIR
"RTN","MDPFTP2A",71,0)
 S MEAS="Raw",UNITS="cmH20/L/S",PC=2,MCP1=MCP1S0,MCP2=MCP2S0 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",72,0)
 S MEAS="SGaw",UNITS="L/S/cmH20",PC=3 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",73,0)
 S MEAS="Cst",UNITS="4cmH20",PC=4 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",74,0)
 G SPEC1
"RTN","MDPFTP2A",75,0)
SMAIR S MEAS="Cdyn",UNITS="L/cmH20",PC=5 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",76,0)
 S MEAS="FEF50 He-Air",UNITS="L/Sec",PC=6,MCP1=MCP1S0,MCP2=MCP2S0 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",77,0)
 S MEAS="VISOV",UNITS="L",PC=7 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",78,0)
 S MEAS="CV",PC=8 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",79,0)
 S MEAS="CC",PC=9 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP2A",80,0)
 S CV=$P(MCREC,U,8),(CVVC,CVTL)=""
"RTN","MDPFTP2A",81,0)
 I CV'="" S:MCVCN'="" CVVC=CV/MCVCN S:MCTLCN'="" CVTL=CV/MCTLCN
"RTN","MDPFTP2A",82,0)
 S SS="     CV/VC"
"RTN","MDPFTP2A",83,0)
 S PRED="",ACT=$P(ND,U,PC) I ACT'="" N MDSKIP S MDSKIP=1 D SETNODE(MDGRS,SS),PRTLINE^MDPFTP2
"RTN","MDPFTP2A",84,0)
 S SS=SS_$S(ACT'="":"",1:$J(" ",18-$L(SS)))_"%",SS=SS_$S(ACT'="":"    ",1:$J(" ",25-$L(SS)))_$S(PRED:$J(PRED,5,2),1:"")
"RTN","MDPFTP2A",85,0)
 S SS=SS_$S(ACT'="":"   ",1:$J(" ",35-$L(SS)))_$J(CVVC,5,2),SS=SS_$S(ACT'="":"   ",1:$J(" ",45-$L(SS)))_$S(PRED:$J(CVVC/PRED*100,5,1),1:"") D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",86,0)
 D SETNODE(MDGRS,"     CV/TLC       %                "_$J(CVTL,5,2))
"RTN","MDPFTP2A",87,0)
 S VISOV=$P(MCREC,U,7)
"RTN","MDPFTP2A",88,0)
 I VISOV'="",+CV'=0 D SETNODE(MDGRS,"     VISOV/CV     %"_$J(" ",16)_$J(VISOV/CV,5,2))
"RTN","MDPFTP2A",89,0)
 K CV,CVTL,CVVC,VISOV G SPEC1
"RTN","MDPFTP2A",90,0)
INT K MCSP G INT^MDPFTP3
"RTN","MDPFTP2A",91,0)
EXIT Q
"RTN","MDPFTP2A",92,0)
PRTLINE S MCP1=$G(MCP1),MCP2=$G(MCP2),SS=""
"RTN","MDPFTP2A",93,0)
 S SS="     "_MEAS,SS=SS_$J(" ",15-$L(SS))_UNITS,SS=SS_$J(" ",25-$L(SS))_$S(PRED:$J(PRED,MCLNG,MCDL),1:""),SS=SS_$J(" ",35-$L(SS))_$J(ACT,MCLNG,MCDL)
"RTN","MDPFTP2A",94,0)
 S SS=SS_$J(" ",45-$L(SS))_$S(PRED:$J(ACT/PRED*100,5,1),1:"")
"RTN","MDPFTP2A",95,0)
 S:$P(MCP1,U,PC) SS=SS_$J(" ",55-$L(SS))_$J($P(MCP1,U,PC),MCLNG,MCDL)
"RTN","MDPFTP2A",96,0)
 S:$P(MCP2,U,PC) SS=SS_$J(" ",65-$L(SS))_$J($P(MCP2,U,PC),MCLNG,MCDL)
"RTN","MDPFTP2A",97,0)
 S:(CI95)&(CI95'=PRED) SS=SS_$J(" ",72-$L(SS))_$J(CI95,6,2)
"RTN","MDPFTP2A",98,0)
 Q:+$G(MDSKIP)
"RTN","MDPFTP2A",99,0)
 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP2A",100,0)
 Q
"RTN","MDPFTP2A",101,0)
SETNODE(NODE,VALUE) ;Set the node with the string
"RTN","MDPFTP2A",102,0)
 S MDLNE=MDLNE+1,@NODE@(MDLNE,0)=VALUE
"RTN","MDPFTP2A",103,0)
 Q
"RTN","MDPFTP2A",104,0)
MCFF1 Q
"RTN","MDPFTP3")
0^6^B28116832
"RTN","MDPFTP3",1,0)
MDPFTP3 ; HOIFO/NCA - PFT REPORT-SPECIAL STUDIES (PT 2) ;3/17/04  12:48
"RTN","MDPFTP3",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPFTP3",3,0)
 ; Reference IA #10060 New Person File (#200 Read w/FM)
"RTN","MDPFTP3",4,0)
 ;
"RTN","MDPFTP3",5,0)
EX S ND=MCREC1,MCP1=MCP1S1,MCP2=MCP2S1,VE=$P(MCREC1,U,1),MCEX=$P(MCREC2,U,9)
"RTN","MDPFTP3",6,0)
 S MEAS="VEmax(BTPS)",UNITS="L",PC=1 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",7,0)
 S MEAS="BR",PC=2 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",8,0)
 S MEAS="VD/VT REST",PC=14 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",9,0)
 S MEAS="VD/VT MAX",PC=15 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",10,0)
 S MEAS="VE/VCO2, AT",PC=16 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",11,0)
 S MEAS="VErest(BTPS)",UNITS="ml/beat",PC=5 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",12,0)
 K VE S MEAS="VO2rest",UNITS="L/min",PC=6 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",13,0)
 S MEAS="VO2max",UNITS="L/min",PC=7 I MCEX=1 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",14,0)
 D:(MCEX=3)!(MCEX=2) VO2MAX
"RTN","MDPFTP3",15,0)
 S MEAS="AT",UNITS="L",PC=3 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",16,0)
 S MEAS="HRrest",UNITS="BPM",PC=8 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",17,0)
 S MEAS="HRmax",PC=9 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",18,0)
 S MEAS="VO2/HR",PC=11,UNITS="ML" S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",19,0)
 S MEAS="BP MAX",PC=12,UNITS="" S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",20,0)
 S MEAS="EKG",PC=13 S ACT=$P(ND,U,PC) S SS="     "_MEAS,SS=SS_$J(" ",35-$L(SS))_$S(ACT="N":"NORMAL",ACT="A":"ABNORMAL",1:"") D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP3",21,0)
 S MEAS="RRrest",UNITS="brths/m",PC=10 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",22,0)
 S ND=MCREC2,MCP1=MCP1S2,MCP2=MCP2S2,MEAS="RRmax",PC=1 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",23,0)
 S MEAS="Wmax",UNITS="wrpm/min",PC=2 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",24,0)
 S MEAS="WRI/WRT",UNITS="watts/min",PC=6 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",25,0)
 S MEAS="Max Speed",UNITS="mph",PC=4 S ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",26,0)
 S MEAS="Max Grade",UNITS="%",PC=5 S ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",27,0)
 S PRED="",MEAS="TOTAL TIME",UNITS="min",PC=3 S ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",28,0)
 S MEAS="HCO3 Change",UNITS="mg/dl",PC=10 S PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2
"RTN","MDPFTP3",29,0)
 S SS="Exercise Testing Mode: "_$S(MCEX=1:"TREADMILL",MCEX=2:"BIKE ERGOMETER",MCEX=3:"HAND ERGOMETER",1:"") K MCEX D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP3",30,0)
 D SETNODE(MDGRS,"REASON(S) FOR STOPPING:")
"RTN","MDPFTP3",31,0)
 S MCX(1)=0 F  S MCX(1)=$O(^MCAR(700,MDR,"S",MCX,3,MCX(1))) Q:MCX(1)'?1N.N  S MCX(2)=$G(^(MCX(1),0)) I MCX(2) D SETNODE(MDGRS,$J(" ",27)_$P($G(^MCAR(695.8,MCX(2),0)),U)) K MCX(2)
"RTN","MDPFTP3",32,0)
 N KK,MDORS S MDLL=0 F  S MDLL=$O(^MCAR(700,+MDR,"S",MCX,4,MDLL)) Q:MDLL<1  S MDORS=$G(^(MDLL,0)) D LNE
"RTN","MDPFTP3",33,0)
EXEND G SPEC1^MDPFTP2A
"RTN","MDPFTP3",34,0)
INT K HEAD1 Q:$E(MCDOT,1)=" "
"RTN","MDPFTP3",35,0)
 D SETNODE(MDGRS," "),SETNODE(MDGRS,"INTERPRETATION:")
"RTN","MDPFTP3",36,0)
 D COMP
"RTN","MDPFTP3",37,0)
 K ^TMP("MDWP",$J) N MDLL,MDWP,MDXX,MDY S MDWP=$$GET1^DIQ(700,MDR_",",33.5,"Z","^TMP(""MDWP"",$J)")
"RTN","MDPFTP3",38,0)
 S MDLL=0 F  S MDLL=$O(^TMP("MDWP",$J,MDLL)) Q:MDLL<1  D SETNODE(MDGRS,$J(" ",16)_$G(^(MDLL,0)))
"RTN","MDPFTP3",39,0)
 K ^TMP("MDWP",$J)
"RTN","MDPFTP3",40,0)
 D SETNODE(MDGRS," "),SETNODE(MDGRS,"COMMENTS AND RECOMMENDATIONS:")
"RTN","MDPFTP3",41,0)
 S MDLL=0 F  S MDLL=$O(^MCAR(700,+MDR,16,MDLL)) Q:MDLL<1  D SETNODE(MDGRS,$G(^(MDLL,0)))
"RTN","MDPFTP3",42,0)
 D SETNODE(MDGRS," "),SETNODE(MDGRS,"INTERPRETED BY: ")
"RTN","MDPFTP3",43,0)
 S MDLL=0 F  S MDLL=$O(^MCAR(700,+MDR,7,MDLL)) Q:MDLL<1  S MDY=+$G(^(MDLL,0)) I +MDY S MDXX=$J(" ",16)_$E($$GET1^DIQ(200,+MDY_",",.01,"E"),1,35) D SETNODE(MDGRS,MDXX)
"RTN","MDPFTP3",44,0)
 D SETNODE(MDGRS," ") S MDXX=$G(^MCAR(700,+MDR,17)),MDY=+$P(MDXX,U,1)
"RTN","MDPFTP3",45,0)
 I +MDY S MDXX=$E($$GET1^DIQ(200,+MDY_",",.01,"E"),1,35) D SETNODE(MDGRS,"REVIEWED BY:    "_MDXX)
"RTN","MDPFTP3",46,0)
 D SETNODE(MDGRS," ") K MDXX,MDY
"RTN","MDPFTP3",47,0)
EXIT Q:$E(MCDOT)=" "  D PV Q
"RTN","MDPFTP3",48,0)
PV ;
"RTN","MDPFTP3",49,0)
 I $G(MCPV)<1 S MCPV=$$MCPV^MDPFTP1(MDR)
"RTN","MDPFTP3",50,0)
 Q:'$D(MCPV)  Q:'$D(^MCAR(700.1,MCPV))
"RTN","MDPFTP3",51,0)
PV1 ;
"RTN","MDPFTP3",52,0)
 I $G(MCPV)<1 S MCPV=$$MCPV^MDPFTP1(MDR)
"RTN","MDPFTP3",53,0)
 Q:'$D(MCPV)
"RTN","MDPFTP3",54,0)
 S SS="" D SETNODE(MDGRS," ") D SETNODE(MDGRS,$J(" ",24)_"PREDICTED VALUE FORMULAS USED")
"RTN","MDPFTP3",55,0)
 F J="TLC","VC","FRC","RV","FVC","FEV1","PF","FEF2575","MVV","DLCOSB","COHB","HB" D
"RTN","MDPFTP3",56,0)
 .S I=$G(^MCAR(700.1,MCPV,J)) Q:'I
"RTN","MDPFTP3",57,0)
 .Q:'$D(^MCAR(700.2,I,0))  S I=$G(^(0))
"RTN","MDPFTP3",58,0)
 .S SS="    "_$S(J="DLCOSB":"DLCO-SB",J="FEF2575":"FEF25-75",J="COHB":"COHB CORR.",J="HB":"HB CORR.",1:J)
"RTN","MDPFTP3",59,0)
 .D PVW
"RTN","MDPFTP3",60,0)
 .K J Q
"RTN","MDPFTP3",61,0)
 G:'$D(MCRC1) PVEXIT
"RTN","MDPFTP3",62,0)
 D SETNODE(MDGRS," "),SETNODE(MDGRS,$J(" ",24)_"RACE CORRECTION FORMULAS USED")
"RTN","MDPFTP3",63,0)
 ;I $D(MCRC2) S I=$P($G(^MCAR(700.1,MCPV,"RC")),U,2) I I,$D(^MCAR(700.2,I,0)) S I=$G(^(0)) S SS="    TLC,VC,FVC,FEV1" D PVW G PVEXIT
"RTN","MDPFTP3",64,0)
 I $D(MCRC2) D  G PVEXIT
"RTN","MDPFTP3",65,0)
 . F J=2,6 S I=$P($G(^MCAR(700.1,MCPV,"RC")),U,J) I I,$D(^MCAR(700.2,I,0)) S I=$G(^(0)) S SS="    "_$S(J=2:"TLC,VC,FVC,FEV1",J=6:"MVV",1:"") D PVW
"RTN","MDPFTP3",66,0)
 . Q
"RTN","MDPFTP3",67,0)
 F J=1,3,4,5 S I=$P($G(^MCAR(700.1,MCPV,"RC")),U,J) I I,$D(^MCAR(700.2,I,0)) S I=$G(^(0)) S SS="    "_$S(J=1:"TLC,VC,FVC,FEV1",J=3:"FRC,RV",J=4:"FEF25-75",J=5:"MVV",1:"") D PVW
"RTN","MDPFTP3",68,0)
PVEXIT D SETNODE(MDGRS,"NOTE:  HT=height,WT=weight,ACT=actual measurement value") Q
"RTN","MDPFTP3",69,0)
PVW S SS=SS_$J(" ",21-$L(SS))_$P(I,U),SS=SS_$J(" ",50-$L(SS))_$P(I,U,3)
"RTN","MDPFTP3",70,0)
 D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPFTP3",71,0)
 Q
"RTN","MDPFTP3",72,0)
COMP S I=0 F  S I=$O(^MCAR(700,+MDR,24,I)) Q:I'?1N.N  I $D(^(I,0)),$P(^(0),U,2)="Y" S J=$P(^(0),U,1) D:$D(^MCAR(693.2,J,0)) SETNODE(MDGRS,$J(" ",16)_$P(^(0),U,1))
"RTN","MDPFTP3",73,0)
 Q
"RTN","MDPFTP3",74,0)
VO2ER1(MCSEX) ;
"RTN","MDPFTP3",75,0)
 Q $S(MCSEX="F":(42.8+WT)*(22.78-(.17*AGE)),1:(.79*HT-60.7))
"RTN","MDPFTP3",76,0)
VO2ER2(MCSEX) ;
"RTN","MDPFTP3",77,0)
 Q $S(MCSEX="F":HT*(14.81-(.11*AGE)),1:50.72-(0.372*AGE))
"RTN","MDPFTP3",78,0)
VO2MAX ;
"RTN","MDPFTP3",79,0)
 S ER1=$$VO2ER1(MCSEX),ER2=$$VO2ER2(MCSEX),PRED="",ACT=$P(ND,U,PC) D:ACT'="" PRTLINE^MDPFTP2 Q
"RTN","MDPFTP3",80,0)
SETNODE(NODE,VALUE) ;Set the node with the string
"RTN","MDPFTP3",81,0)
 S MDLNE=MDLNE+1,@NODE@(MDLNE,0)=VALUE
"RTN","MDPFTP3",82,0)
 Q
"RTN","MDPFTP3",83,0)
LNE ; Break line if longer than 48 chars
"RTN","MDPFTP3",84,0)
 I $L(MDORS)<49 D SETNODE(MDGRS,$J(" ",27)_MDORS) Q
"RTN","MDPFTP3",85,0)
 F KK=49:-1:1 Q:$E(MDORS,KK)?1P
"RTN","MDPFTP3",86,0)
 I KK=1 S KK=48 D SETNODE(MDGRS,$J(" ",27)_$E(MDORS,1,48))
"RTN","MDPFTP3",87,0)
 E  D SETNODE(MDGRS,$J(" ",27)_$E(MDORS,1,KK-1))
"RTN","MDPFTP3",88,0)
 S MDORS=$E(MDORS,KK+1,999) G LNE
"RTN","MDPOSTI")
0^^B11641276
"RTN","MDPOSTI",1,0)
MDPOSTI ; HOIFO/NCA - Post Conversion to add CP Report Component ;8/15/03  11:26
"RTN","MDPOSTI",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPOSTI",3,0)
 ; Integration Agreements:
"RTN","MDPOSTI",4,0)
 ; IA# 4327 [Private] Read and Write Access to OE/RR Report File (#101.24)
"RTN","MDPOSTI",5,0)
 ; IA# 4328 [Private] Read and Write access to Health Summary Components file (#142.1)
"RTN","MDPOSTI",6,0)
 ; IA# 10141 [Supported] XPDUTL KERNEL calls.
"RTN","MDPOSTI",7,0)
 ;
"RTN","MDPOSTI",8,0)
CHECK ; Check for existing components
"RTN","MDPOSTI",9,0)
 N MDCTR,MDCOMP,MDDEL,MDERR,MDFDA,MDID,MDIEN,MDIEN1,MDIENS,MDK,MDLP,MDRPT,MDTYP,MDWP,MDX,P1
"RTN","MDPOSTI",10,0)
 Q:+$$FIND1^DIC(101.24,"","MX","ORRPW MEDICINE/CP")
"RTN","MDPOSTI",11,0)
 D ADDHS S MDRPT=$$FIND1^DIC(101.24,"","MX","ORRPW MEDICINE")  D:+MDRPT ADDIT
"RTN","MDPOSTI",12,0)
 Q
"RTN","MDPOSTI",13,0)
ADDHS ; Modify Health Summary components
"RTN","MDPOSTI",14,0)
 S MDCTR=0
"RTN","MDPOSTI",15,0)
 F MDX=1:1 S MDCOMP=$P($T(HS+MDX),";;",2) Q:MDCOMP="**END**"  D
"RTN","MDPOSTI",16,0)
 .S MDRPT=+$$FIND1^DIC(142.1,"","MX",$P(MDCOMP,";",1)) Q:'MDRPT
"RTN","MDPOSTI",17,0)
 .S MDIENS=MDRPT_","
"RTN","MDPOSTI",18,0)
 .S MDFDA(142.1,MDIENS,.01)=$P(MDCOMP,";",1)
"RTN","MDPOSTI",19,0)
 .S MDFDA(142.1,MDIENS,1)=$P(MDCOMP,";",2,3)
"RTN","MDPOSTI",20,0)
 .S MDFDA(142.1,MDIENS,13)="MD" K MDIEN
"RTN","MDPOSTI",21,0)
 .D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDPOSTI",22,0)
 .K MDWP S MDK=0 F MDLP=4:1 Q:$P(MDCOMP,";",MDLP)=""  D
"RTN","MDPOSTI",23,0)
 ..S MDK=MDK+1,MDWP(MDK)=$P(MDCOMP,";",MDLP) Q
"RTN","MDPOSTI",24,0)
 .S MDDEL="@" D WP^DIE(142.1,MDIENS,3,5,"K","MDDEL")
"RTN","MDPOSTI",25,0)
 .D WP^DIE(142.1,MDIENS,3.5,"K","MDWP")
"RTN","MDPOSTI",26,0)
 .S P1=0 F  S P1=$O(^GMT(142.1,+MDIENS,.1,P1)) Q:P1<1  D
"RTN","MDPOSTI",27,0)
 ..S MDFDA(142.11,P1_","_+MDIENS_",",.01)="@"
"RTN","MDPOSTI",28,0)
 ..D FILE^DIE("","MDFDA","MDERR") K MDERR
"RTN","MDPOSTI",29,0)
 .D MES^XPDUTL("Modified "_$P(MDCOMP,";",1)_" component.")
"RTN","MDPOSTI",30,0)
 .Q
"RTN","MDPOSTI",31,0)
 Q
"RTN","MDPOSTI",32,0)
ADDIT ; Rename ORRPW MEDICINE
"RTN","MDPOSTI",33,0)
 S MDFDA(101.24,MDRPT_",",.01)="ORRPW MEDICINE/CP"
"RTN","MDPOSTI",34,0)
 S MDFDA(101.24,MDRPT_",",.23)="Medicine/CP"
"RTN","MDPOSTI",35,0)
 S MDFDA(101.24,MDRPT_",",.24)="Medicine/CP"
"RTN","MDPOSTI",36,0)
 D FILE^DIE("K","MDFDA","MDERR")
"RTN","MDPOSTI",37,0)
 D MES^XPDUTL("Rename ORRPW MEDICINE to ORRPW MEDICINE/CP")
"RTN","MDPOSTI",38,0)
 Q
"RTN","MDPOSTI",39,0)
HS ; Health Summary Components
"RTN","MDPOSTI",40,0)
 ;;MEDICINE ABNORMAL BRIEF;CPA;MDPS1;This component displays the Display Result;of the Consults procedure and the TIU documents for;the abnormal procedures.
"RTN","MDPOSTI",41,0)
 ;;MEDICINE BRIEF REPORT;CPB;MDPS1;This component displays the Clinical Procedure Name,;the Date/Time Performed, and the Procedure Summary Code.
"RTN","MDPOSTI",42,0)
 ;;MEDICINE FULL REPORT;CPF;MDPS1;This component displays the Display Result;of the Consults procedure and the TIU documents for;the procedure.
"RTN","MDPOSTI",43,0)
 ;;MEDICINE FULL CAPTIONED;CPC;MDPS1;This component displays the Display Result;of the Consults procedure and the TIU documents for;the procedure.
"RTN","MDPOSTI",44,0)
 ;;MEDICINE SUMMARY;CPS;MDPS1;This component displays a (1 line) summary;with the Consult Number, Procedure Name, Date/Time Performed;and Procedure Summary Code.
"RTN","MDPOSTI",45,0)
 ;;**END**
"RTN","MDPS1")
0^1^B73206463
"RTN","MDPS1",1,0)
MDPS1 ; HOIFO/NCA - CP/Medicine Report Generator ;5/18/04  09:48
"RTN","MDPS1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPS1",3,0)
 ; Integration Agreements:
"RTN","MDPS1",4,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDPS1",5,0)
 ; IA# 2926 [Subscription] Calls to GMRCGUIA.
"RTN","MDPS1",6,0)
 ; IA# 2944 [Subscription] Calls to TIUSRVR1.
"RTN","MDPS1",7,0)
 ; IA# 3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDPS1",8,0)
 ; IA# 4110 [Subscription] Read access field #50 Associated Results in
"RTN","MDPS1",9,0)
 ;                         Consult file (#123) w/FM
"RTN","MDPS1",10,0)
 ; IA# 4230 [Subscription] Document MDPS1 calls.
"RTN","MDPS1",11,0)
 ; IA# 4231 [Subscription] Document CKP^GMTSUP usage.
"RTN","MDPS1",12,0)
 ; IA# 10104 [Supported] Routine XLFSTR calls
"RTN","MDPS1",13,0)
 ;
"RTN","MDPS1",14,0)
 ; Pre-existing local variables
"RTN","MDPS1",15,0)
 ; DFN,GMTS1,GMTS2,GMTSNDM,GMTSNPG,GMTSQIT
"RTN","MDPS1",16,0)
 ;
"RTN","MDPS1",17,0)
EN1(MDGLO,MDDFN,MDSDT,MDEDT,MDMAX,MDPSC,MDALL) ; Return the List of Completed Studies
"RTN","MDPS1",18,0)
 ; Input: MDGLO - Return Global Array (Required)
"RTN","MDPS1",19,0)
 ;        MDDFN - Patient DFN         (Required)
"RTN","MDPS1",20,0)
 ;        MDSDT - Start Date in FM Internal Format (Optional)
"RTN","MDPS1",21,0)
 ;        MDEDT - End Date in FM Internal Format (Optional)
"RTN","MDPS1",22,0)
 ;        MDMAX - Number of studies to return    (Optional)
"RTN","MDPS1",23,0)
 ;        MDPSC - Procedure Summary Code         (Optional)
"RTN","MDPS1",24,0)
 ;        MDALL - Return the all text reports with
"RTN","MDPS1",25,0)
 ;                the procedures list            (Optional)
"RTN","MDPS1",26,0)
 ; (Returns all studies for Patient, if no MDSDT, MDEDT,and MDMAX.)
"RTN","MDPS1",27,0)
 ;
"RTN","MDPS1",28,0)
 I '$G(MDDFN)!('$D(MDGLO)) Q
"RTN","MDPS1",29,0)
 I $G(MDGLO)="" S MDGLO=$NA(^TMP("MDHSP",$J))
"RTN","MDPS1",30,0)
 N MDARR,MDCODE,MDCON,MDCTR,MDDTE,MDLP,MDLP1,MDPLST,MDPROC,MDSTAT,MDT,MDTIUER,MDX,Y
"RTN","MDPS1",31,0)
 S (MDIMG,MDCTR)=0,(MDCODE,MDDTE,MDTIUER)="",MDC=$G(MDPSC)
"RTN","MDPS1",32,0)
 K ^TMP("MDPLST",$J) S MDPLST=$NA(^TMP("MDPLST",$J))
"RTN","MDPS1",33,0)
 ;
"RTN","MDPS1",34,0)
 ; If not converted call old medicine gather routine
"RTN","MDPS1",35,0)
 D EN^MCARPS3(MDDFN,MDC,MDSDT,MDEDT)
"RTN","MDPS1",36,0)
 ;
"RTN","MDPS1",37,0)
 ; Get CP procedures
"RTN","MDPS1",38,0)
 D GET702(.MDGLO,MDDFN,MDC,MDSDT,MDEDT,$S(+$G(MDMAX):MDMAX,1:999))
"RTN","MDPS1",39,0)
 K ^TMP("MDPLST",$J)
"RTN","MDPS1",40,0)
 Q
"RTN","MDPS1",41,0)
 ;
"RTN","MDPS1",42,0)
GET702(MDGLO,MDDFN,MDC,MDSDT,MDEDT,MDMAX) ; Gather the new 702 entries
"RTN","MDPS1",43,0)
 S MDLP="" F  S MDLP=$O(^MDD(702,"B",MDDFN,MDLP)) Q:MDLP<1  D
"RTN","MDPS1",44,0)
 .S MDX=$G(^MDD(702,MDLP,0)) Q:$P(MDX,"^",9)'=3
"RTN","MDPS1",45,0)
 .S MDPROC=$$GET1^DIQ(702,MDLP_",",.04,"E") Q:MDPROC=""
"RTN","MDPS1",46,0)
 .Q:'$P(MDX,U,6)
"RTN","MDPS1",47,0)
 .K ^TMP("MDTIUST",$J) S MDTIUER=""
"RTN","MDPS1",48,0)
 .D EXTRACT^TIULQ($P(MDX,U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;70201;70202") Q:+MDTIUER
"RTN","MDPS1",49,0)
 .S MDCODE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70201,"E"))
"RTN","MDPS1",50,0)
 .S:MDCODE'="" MDCODE=$$UP^XLFSTR(MDCODE)
"RTN","MDPS1",51,0)
 .I $G(MDC)'="" Q:MDCODE'=$G(MDC)
"RTN","MDPS1",52,0)
 .S MDDTE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70202,"I"))
"RTN","MDPS1",53,0)
 .S MDSTAT=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),.05,"E"))
"RTN","MDPS1",54,0)
 .S:'MDDTE MDDTE=$$GET1^DIQ(702,MDLP_",",.02,"I")
"RTN","MDPS1",55,0)
 .K ^TMP("MDTIUST",$J)
"RTN","MDPS1",56,0)
 .S MDCON=$P(MDX,U,5) Q:'MDCON
"RTN","MDPS1",57,0)
 .I +$G(MDSDT) Q:MDDTE<+$G(MDSDT)
"RTN","MDPS1",58,0)
 .I +$G(MDEDT) Q:MDDTE>+$G(MDEDT)
"RTN","MDPS1",59,0)
 .I MDCON D  Q:MDSTAT'="COMPLETE"
"RTN","MDPS1",60,0)
 ..S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDPS1",61,0)
 ..I MDSTAT="" S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"I") S:+MDSTAT MDSTAT=$$GET1^DIQ(100.01,MDSTAT_",",.01,"E")
"RTN","MDPS1",62,0)
 ..Q
"RTN","MDPS1",63,0)
 .S Y=MDDTE X ^DD("DD")
"RTN","MDPS1",64,0)
 .I MDCON Q:$G(MDARR(MDCON))'=""  S MDARR(MDCON)=MDCON
"RTN","MDPS1",65,0)
 .S:$G(^TMP("MDPLST",$J,(9999999.9999-MDDTE),MDPROC_"~"_MDLP))="" ^(MDPROC_"~"_MDLP)=MDPROC_"^"_MDLP_"^"_"PR702"_"^"_"MDPS1"_"^^"_Y_"^"_MDCODE_"^^^^"_MDPROC_"^^"_MDCON
"RTN","MDPS1",66,0)
 .Q
"RTN","MDPS1",67,0)
 S MDCTR=0
"RTN","MDPS1",68,0)
 S MDLP="" F  S MDLP=$O(^TMP("MDPLST",$J,MDLP)) Q:MDLP=""  S MDLP1="" F  S MDLP1=$O(^TMP("MDPLST",$J,MDLP,MDLP1)) Q:MDLP1=""  S MDX=$G(^(MDLP1)) D
"RTN","MDPS1",69,0)
 .I +$G(MDMAX) Q:MDCTR=MDMAX
"RTN","MDPS1",70,0)
 .S MDCTR=MDCTR+1,@MDGLO@(MDCTR)=$G(MDX)
"RTN","MDPS1",71,0)
 K MDARR
"RTN","MDPS1",72,0)
 I +$G(MDALL) K ^TMP("MDPTXT",$J) S MDLP=0 F  S MDLP=$O(@MDGLO@(MDLP)) Q:MDLP<1  S MDX1=$G(@MDGLO@(MDLP)) D
"RTN","MDPS1",73,0)
 .S MCARGDA=+$P(MDX1,U,2),MCPRO=$P(MDX1,U,11),MCARPPS=$P(MDX1,U,3,4)
"RTN","MDPS1",74,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT="RD"
"RTN","MDPS1",75,0)
 .D @MCARPPS
"RTN","MDPS1",76,0)
 K MCARGDA,MCARGRTN,MCPRO,MCARPPS
"RTN","MDPS1",77,0)
 Q
"RTN","MDPS1",78,0)
CPA ; Abnormal Report - Health Summary Component
"RTN","MDPS1",79,0)
 N MDHR,MDHSG,MDHDR,MDHFLG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPS1",80,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",81,0)
 K ^TMP("MDHSP",$J) S MDHFLG=1
"RTN","MDPS1",82,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",83,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM,"ABNORMAL")
"RTN","MDPS1",84,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",85,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",86,0)
 .D HSHDR^MDPS2
"RTN","MDPS1",87,0)
 .S MCARGDA=+$P(MDX1,U,2),MCARPPS=$P(MDX1,U,3,4),MCPRO=$P(MDX1,U,11)
"RTN","MDPS1",88,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT="RD",MDHDR=1
"RTN","MDPS1",89,0)
 .D @MCARPPS Q
"RTN","MDPS1",90,0)
 K ^TMP("MDHSP",$J),MCARGRTN,MCPRO,MCARPPS
"RTN","MDPS1",91,0)
 Q
"RTN","MDPS1",92,0)
CPB ; Brief Report - Health Summary Component
"RTN","MDPS1",93,0)
 N MDHR,MDHSG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPS1",94,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",95,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",96,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",97,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPS1",98,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",99,0)
 D HDR^MDPS2
"RTN","MDPS1",100,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",101,0)
 .D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",102,0)
 .W !,$S(+$P(MDX1,U,13):$J($P(MDX1,U,13),9),1:""),?12,$E($P(MDX1,U,1),1,30),?44,$P(MDX1,U,6),?67,$P(MDX1,U,7)
"RTN","MDPS1",103,0)
 .Q
"RTN","MDPS1",104,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",105,0)
 Q
"RTN","MDPS1",106,0)
CPC ; Full Caption Report - Health Summary Component
"RTN","MDPS1",107,0)
 S MDT1="CD"
"RTN","MDPS1",108,0)
CPF ; Full Report - Health Summary Component
"RTN","MDPS1",109,0)
 N MDHR,MDHSG,MDHDR,MDHFLG,MDLIM,MDT,MDTS1,MDTS2,MDX1
"RTN","MDPS1",110,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",111,0)
 K ^TMP("MDHSP",$J) S MDHFLG=1
"RTN","MDPS1",112,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",113,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPS1",114,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",115,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",116,0)
 .D HSHDR^MDPS2
"RTN","MDPS1",117,0)
 .S MCARGDA=+$P(MDX1,U,2),MCPRO=$P(MDX1,U,11),MCARPPS=$P(MDX1,U,3,4)
"RTN","MDPS1",118,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT=$S($G(MDT1)="":"RD",1:"CD"),MDHDR=1
"RTN","MDPS1",119,0)
 .D @MCARPPS Q
"RTN","MDPS1",120,0)
 K ^TMP("MDHSP",$J),MCARGDA,MCARGRTN,MCPRO,MCARPPS,MDT1
"RTN","MDPS1",121,0)
 Q
"RTN","MDPS1",122,0)
CPS ; One Line Summary Report
"RTN","MDPS1",123,0)
 N MDHR,MDHSG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPS1",124,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",125,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",126,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",127,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPS1",128,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",129,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",130,0)
 .D HSHDR^MDPS2
"RTN","MDPS1",131,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",132,0)
 Q
"RTN","MDPS1",133,0)
PR702 ; Return the Result Text for File 702 records
"RTN","MDPS1",134,0)
 Q:'$G(MCARGDA)
"RTN","MDPS1",135,0)
 N FFF,MDCLIN,MDCON,MDIMG,MDMCG,MDMED,MDREC,MDPTR,MDSTUDY,MDTIU,MDX4,PATID,MDRPG,RESULTS
"RTN","MDPS1",136,0)
 I '$G(MDALL) K ^TMP("MDPTXT",$J)
"RTN","MDPS1",137,0)
 S MDIMG=0,$P(FFF,"-",80)="",MDRPG=0
"RTN","MDPS1",138,0)
 S MDSTUDY=+$G(MCARGDA)
"RTN","MDPS1",139,0)
 S MDTIU=$$GET1^DIQ(702,MDSTUDY_",",.06,"I")
"RTN","MDPS1",140,0)
 S MDCON=$$GET1^DIQ(702,MDSTUDY_",",.05,"I")
"RTN","MDPS1",141,0)
 Q:'MDTIU
"RTN","MDPS1",142,0)
 I +$P($G(^MDD(702,MDSTUDY,.1,0)),U,4)>0 S MDIMG=1
"RTN","MDPS1",143,0)
 S RESULTS="",MDCLIN=0
"RTN","MDPS1",144,0)
 I 'MDCON D TGET^TIUSRVR1(.RESULTS,+MDTIU) M ^TMP("MDPTXT",$J,MCARGDA,MCPRO)=@RESULTS K ^TMP("TIUVIEW",$J) Q:+$G(MDALL)  D NXT Q
"RTN","MDPS1",145,0)
 I MDCON D  Q:+$G(MDMED)
"RTN","MDPS1",146,0)
 .S MDG=$NA(^TMP("MDPTXT",$J,MCARGDA,MCPRO))
"RTN","MDPS1",147,0)
 .S MDMED=$$CHKMED(MDCON)
"RTN","MDPS1",148,0)
 .I MDMED D GETARY(.MDG,MDCON) Q:+$G(MDALL)  Q:+$G(MDRDV)  D NXT Q
"RTN","MDPS1",149,0)
 .K ^TMP("MDGMRC",$J) S RESULTS=$NA(^TMP("MDGMRC",$J))
"RTN","MDPS1",150,0)
 .D RT^GMRCGUIA(MDCON,.RESULTS)
"RTN","MDPS1",151,0)
 .D SETLINE(.MDG,.RESULTS)
"RTN","MDPS1",152,0)
 Q:+$G(MDALL)  Q:+$G(MDRDV)
"RTN","MDPS1",153,0)
NXT I $D(ORHFS) U IO G PRINT
"RTN","MDPS1",154,0)
 G PRINT
"RTN","MDPS1",155,0)
PR690 ; Return the Result text for File 690 Medicine report record
"RTN","MDPS1",156,0)
 Q:'$G(MCARGDA)
"RTN","MDPS1",157,0)
 N MDSTUDY,RESULTS,MDTMP,PATID
"RTN","MDPS1",158,0)
 I '$G(MDALL) K ^TMP("MDPTXT",$J)
"RTN","MDPS1",159,0)
 S MDSTUDY=+$G(MCARGDA)
"RTN","MDPS1",160,0)
 S MDG=$NA(^TMP("MDPTXT",$J,MCARGDA,MCPRO))
"RTN","MDPS1",161,0)
 S MDTMP="",MDTMP=+$O(^MCAR(697.2,"B",MCPRO,MDTMP))
"RTN","MDPS1",162,0)
 S MDTMP=$G(^MCAR(697.2,+MDTMP,0)) Q:MDTMP=""
"RTN","MDPS1",163,0)
 S MDF=$P(MDTMP,U,2),MDF=$P(MDF,"(",2),MDR=+MCARGDA,MDPR=MCPRO,PATID=DFN S:$G(MDT)="" MDT="RD"
"RTN","MDPS1",164,0)
 D GETDATA^MDPS2(.MDG,DFN,MDPR,MDF,MDR,MDT,$S(+$G(MDHDR):MDHDR,1:0))
"RTN","MDPS1",165,0)
 Q:+$G(MDALL)  Q:+$G(MDRDV)
"RTN","MDPS1",166,0)
 I $D(ORHFS) U IO G PRINT
"RTN","MDPS1",167,0)
PRINT ; Print the text for Display
"RTN","MDPS1",168,0)
 S MDREC=$NA(^TMP("MDPTXT",$J)),MDRPG=1
"RTN","MDPS1",169,0)
 W:'$G(MDHFLG) @IOF,!!
"RTN","MDPS1",170,0)
 F  S MDREC=$Q(@MDREC) Q:MDREC=""  Q:$QS(MDREC,1)'="MDPTXT"  D
"RTN","MDPS1",171,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",172,0)
 .I '$G(MDHFLG)&($Y>(IOSL-3)) W @IOF D HDR^MDPS3
"RTN","MDPS1",173,0)
 .W !,$G(@MDREC)
"RTN","MDPS1",174,0)
 .Q
"RTN","MDPS1",175,0)
 I +$G(MDIMG) D
"RTN","MDPS1",176,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",177,0)
 .W ! I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",178,0)
 .W !,"NOTE: Images are associated with this procedure."
"RTN","MDPS1",179,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",180,0)
 .W !,"      Please use Imaging Display to view the images."
"RTN","MDPS1",181,0)
 .Q
"RTN","MDPS1",182,0)
 K MCPRO,MCARPPS,MCARGRTN,^TMP("MDPTXT",$J)
"RTN","MDPS1",183,0)
 Q
"RTN","MDPS1",184,0)
CHKMED(MDCON) ; Check for Medicine results
"RTN","MDPS1",185,0)
 N MDCK,MDCX,MDY
"RTN","MDPS1",186,0)
 S MDY=0 D GETS^DIQ(123,MDCON_",","50*","I","MDCX")
"RTN","MDPS1",187,0)
 S MDCK="" F  S MDCK=$O(MDCX(123.03,MDCK)) Q:MDCK<1  S MDX4=$G(MDCX(123.03,MDCK,.01,"I")) D
"RTN","MDPS1",188,0)
 .I MDX4["MCAR" S MDY=1
"RTN","MDPS1",189,0)
 Q MDY
"RTN","MDPS1",190,0)
GETARY(MDG,MDCON) ; Get the Medicine Result
"RTN","MDPS1",191,0)
 N MDCK,MDCX,MDX4,MDGL
"RTN","MDPS1",192,0)
 K ^TMP("MDREST",$J) S MDGL=$NA(^TMP("MDREST",$J))
"RTN","MDPS1",193,0)
 D GETS^DIQ(123,MDCON_",","50*","I","MDCX")
"RTN","MDPS1",194,0)
 S MDCK="" F  S MDCK=$O(MDCX(123.03,MDCK)) Q:MDCK<1  S MDX4=$G(MDCX(123.03,MDCK,.01,"I")) D
"RTN","MDPS1",195,0)
 .I MDX4["MCAR" D  Q
"RTN","MDPS1",196,0)
 ..S MDR=+MDX4,MDF=+$P(MDX4,"(",2),PATID=DFN S:$G(MDT)="" MDT="RD"
"RTN","MDPS1",197,0)
 ..Q:MDX4=""  S MCPRO=$$PRO^MDPS3(MDX4),MDPR=MCPRO
"RTN","MDPS1",198,0)
 ..D GETDATA^MDPS2(.MDGL,DFN,MDPR,MDF,MDR,MDT,$S(+$G(MDHDR):1,1:0))
"RTN","MDPS1",199,0)
 ..D SETLINE(.MDG,.MDGL) K ^TMP("MDREST",$J)
"RTN","MDPS1",200,0)
 ..Q
"RTN","MDPS1",201,0)
 .I MDX4["TIU" D  Q
"RTN","MDPS1",202,0)
 ..S RESULTS="" D TGET^TIUSRVR1(.RESULTS,+MDX4)
"RTN","MDPS1",203,0)
 ..D SETLINE(.MDG,.RESULTS) K ^TMP("TIUVIEW",$J)
"RTN","MDPS1",204,0)
 ..S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=FFF
"RTN","MDPS1",205,0)
 ..Q
"RTN","MDPS1",206,0)
 Q
"RTN","MDPS1",207,0)
SETLINE(MDG,MDGL) ; Set Global Lines
"RTN","MDPS1",208,0)
 N MDCK1,MDX3,MDSC,MDNAME,MDTITL
"RTN","MDPS1",209,0)
 I $G(MCPRO)'="" S MDNAME=$O(^MCAR(697.2,"B",MCPRO,0)) D
"RTN","MDPS1",210,0)
 .I MDNAME S MDTITL=$P($G(^MCAR(697.2,+MDNAME,0)),"^",8)
"RTN","MDPS1",211,0)
 .I $G(MDTITL)="" S MDNAME=$O(^MDS(702.01,"B",MCPRO,0)) S:MDNAME MDTITL=$P($G(^MDS(702.01,+MDNAME,0)),U)
"RTN","MDPS1",212,0)
 S MDCK1=MDGL,MDSC=$QS(MDCK1,1),MDRPG=MDRPG+1
"RTN","MDPS1",213,0)
 I '$G(MDHDR) D
"RTN","MDPS1",214,0)
 .Q:MDSC="MDREST"
"RTN","MDPS1",215,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)="Pg. "_MDRPG_$J(" ",25)_$$HOSP^MDPS2(DFN)
"RTN","MDPS1",216,0)
 .I $G(MDTITL)'="" S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$J(" ",25)_MDTITL
"RTN","MDPS1",217,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$$DEMO^MDPS2(DFN)
"RTN","MDPS1",218,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=FFF
"RTN","MDPS1",219,0)
 F  S MDCK1=$Q(@MDCK1) Q:MDCK1=""  Q:$QS(MDCK1,1)'=MDSC  S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$G(@MDCK1)
"RTN","MDPS1",220,0)
 Q
"RTN","MDPS2")
0^2^B62406460
"RTN","MDPS2",1,0)
MDPS2 ; HOIFO/NCA - CP/Medicine Report Generator (Cont.) ;5/18/04  09:41
"RTN","MDPS2",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPS2",3,0)
 ; Integration Agreements:
"RTN","MDPS2",4,0)
 ; Reference IA #2432 for Hospital Location File #44 FM Lookup
"RTN","MDPS2",5,0)
 ;              #1576 for DIVISION file 40.8 lookup
"RTN","MDPS2",6,0)
 ;              #2263 for XPAR Utilities
"RTN","MDPS2",7,0)
 ;              #4231 for Document CKP^GMTSUP usage.
"RTN","MDPS2",8,0)
 ;              #4428 for ORWRP TIME/OCC LIMITS ALL Parameter.
"RTN","MDPS2",9,0)
 ;              #10035 for Patient File (#2) Direct Global Reads
"RTN","MDPS2",10,0)
 ;              #10060 for New Person file (#200) Read w/FM
"RTN","MDPS2",11,0)
 ;              #10061 for ^VADPT call.
"RTN","MDPS2",12,0)
 ;              #10103 for XLFDT calls.
"RTN","MDPS2",13,0)
 ;
"RTN","MDPS2",14,0)
GETDATA(MDGRS,MDDFN,MDPR,MDF,MDR,MDT,MDH) ; Return the text of the Medicine Report
"RTN","MDPS2",15,0)
 ; Input: MDGRS - Return Global Array (Required)
"RTN","MDPS2",16,0)
 ;        MDDFN - Patient DFN         (Required)
"RTN","MDPS2",17,0)
 ;        MDPR - Procedure name in file #697.2 (Required)
"RTN","MDPS2",18,0)
 ;        MDF - File number (Required)
"RTN","MDPS2",19,0)
 ;        MDR - Record number (Required)
"RTN","MDPS2",20,0)
 ;        MDT - The type of report (Full or Caption)   (Required)
"RTN","MDPS2",21,0)
 ;        MDH - Header is needed or not (Required)
"RTN","MDPS2",22,0)
 ;
"RTN","MDPS2",23,0)
 I '$G(MDDFN)!('$D(MDGRS)) Q
"RTN","MDPS2",24,0)
 N MDCT,MDDAT,MDERR,MDDRDR,MDFLD,MDFLD1,MDFTYP,MDDS0,MDDS1,MDGPRO,MDL1,MDLAB,MDLNE,MDLP,MDMCT,MDMFLD,MDN,MDNOD,MDNXT,MDPNAM,MDSUBF,MDTX,MDTXT,MDVAL,Y
"RTN","MDPS2",25,0)
 S MDN=MDT
"RTN","MDPS2",26,0)
 S MDERR=$$GETDATA^MCORMN1(MDPR,MDR,"^TMP(""MCORMN"",$J)",MDF,$S(MDT'="RD":"RD",1:MDT))
"RTN","MDPS2",27,0)
 I +MDERR=0 S @MDGRS@(1,0)="No Report Text" Q
"RTN","MDPS2",28,0)
 S MDGPRO=$O(^MCAR(697.2,"B",MDPR,0)),(MDDS0,MDDS1)=0,MDPNAM=$P($G(^MCAR(697.2,+MDGPRO,0)),U,8) S:MDPNAM="" MDPNAM=MDPR
"RTN","MDPS2",29,0)
 I MDPR["PFT" S MDLNE=0 D GET^MDPFTP1(.MDGRS,MDF,MDR,MDPNAM,MDLNE,MDH) Q
"RTN","MDPS2",30,0)
 F  S MDDS1=+$O(^MCAR(690.2,"D",MDGPRO,MDDS1)) Q:'MDDS1!(MDDS0)  D
"RTN","MDPS2",31,0)
 .Q:'$D(^MCAR(690.2,MDDS1,0))
"RTN","MDPS2",32,0)
 .S:$P(^MCAR(690.2,MDDS1,0),U,3)="F" MDDS0=MDDS1
"RTN","MDPS2",33,0)
 I 'MDDS0 S @MDGRS@(1,0)="No Report Text" Q
"RTN","MDPS2",34,0)
 S MDFLD="",(MDDRDR,MDLNE)=0,MDNOD=$NA(^TMP("MCORMN",$J)) D HEAD
"RTN","MDPS2",35,0)
 ; Get the Single in the Medicine View File (#690.2)
"RTN","MDPS2",36,0)
 F  S MDFLD=$O(^MCAR(690.2,MDDS0,1,MDFLD)) Q:MDFLD=""  S MDDRDR=+$G(^(MDFLD,0)) D
"RTN","MDPS2",37,0)
 .Q:'MDDRDR
"RTN","MDPS2",38,0)
 .S MDDAT=$G(@MDNOD@("F",MDF,MDDRDR,0)),MDLAB=$P(MDDAT,U),MDFTYP=$P(MDDAT,U,2)
"RTN","MDPS2",39,0)
 .S:MDLAB'="" MDLAB=MDLAB_": "
"RTN","MDPS2",40,0)
 .I +MDFTYP I $E($P(MDFTYP,+MDFTYP,2),1)?1U D SUBF Q
"RTN","MDPS2",41,0)
 .I +MDFTYP&($P($G(@MDNOD@("F",+MDFTYP,.01,0)),U,2)["W") D  Q
"RTN","MDPS2",42,0)
 ..I MDT="CD" S MDNXT=$O(@MDNOD@("E",MDF,MDR,MDDRDR,0)) Q:'+MDNXT  Q:$G(@MDNOD@("E",MDF,MDR,MDDRDR,+MDNXT))=""
"RTN","MDPS2",43,0)
 ..D SETNODE(MDGRS," "),SETNODE(MDGRS,MDLAB)
"RTN","MDPS2",44,0)
 ..S MDLP=0 F  S MDLP=$O(@MDNOD@("E",MDF,MDR,MDDRDR,MDLP)) Q:MDLP<1  S MDVAL="  "_$G(^(MDLP)) D SETNODE(MDGRS,MDVAL)
"RTN","MDPS2",45,0)
 ..D SETNODE(MDGRS," ")
"RTN","MDPS2",46,0)
 ..Q
"RTN","MDPS2",47,0)
 .I MDFTYP'["W"&(MDFTYP'["M") D  Q
"RTN","MDPS2",48,0)
 ..S MDTXT=$G(@MDNOD@("E",MDF,MDR,MDDRDR,1))
"RTN","MDPS2",49,0)
 ..Q:MDT="CD"&(MDTXT="")
"RTN","MDPS2",50,0)
 ..I MDFTYP["D" S MDTX=$$FMTE^XLFDT(MDTXT,2),MDTXT=MDTX
"RTN","MDPS2",51,0)
 ..S MDVAL=MDLAB_$S(MDLAB'="":"  "_MDTXT,1:"") D SETNODE(MDGRS,MDVAL)
"RTN","MDPS2",52,0)
 ..Q
"RTN","MDPS2",53,0)
 .Q
"RTN","MDPS2",54,0)
 I +$P($G(^MCAR(MDF,MDR,2005,0)),U,4)>0 D
"RTN","MDPS2",55,0)
 .D SETNODE(MDGRS," ")
"RTN","MDPS2",56,0)
 .D SETNODE(MDGRS,"NOTE: Images are associated with this procedure.")
"RTN","MDPS2",57,0)
 .D SETNODE(MDGRS,"      Please use Imaging Display to view the images.")
"RTN","MDPS2",58,0)
 .Q
"RTN","MDPS2",59,0)
 K ^TMP("MCORMN",$J)
"RTN","MDPS2",60,0)
 D FOOTER
"RTN","MDPS2",61,0)
 Q
"RTN","MDPS2",62,0)
SETNODE(NODE,VALUE) ;Set the node with the string
"RTN","MDPS2",63,0)
 S MDLNE=MDLNE+1,@NODE@(MDLNE,0)=VALUE
"RTN","MDPS2",64,0)
 Q
"RTN","MDPS2",65,0)
SUBF ; Get the Sub-file fields in the Medicine View File (#690.2)
"RTN","MDPS2",66,0)
 S MDMFLD=$O(^MCAR(690.2,MDDS0,2,"B",+MDFTYP,0)) Q:'MDMFLD
"RTN","MDPS2",67,0)
 S MDCT=0,MDMCT=0 F  S MDCT=$O(@MDNOD@("E",+MDFTYP,MDCT)) Q:MDCT<1  S MDFLD1=0 F  S MDFLD1=$O(@MDNOD@("E",+MDFTYP,MDCT,MDFLD1)) Q:MDFLD1=""  D
"RTN","MDPS2",68,0)
 .S:MDFLD1=".01" MDMCT=MDMCT+1
"RTN","MDPS2",69,0)
 .Q:'+$O(^MCAR(690.2,MDDS0,2,MDMFLD,1,"B",MDFLD1,0))
"RTN","MDPS2",70,0)
 .S MDDAT=$G(@MDNOD@("F",+MDFTYP,MDFLD1,0)),MDLAB=$P(MDDAT,U)
"RTN","MDPS2",71,0)
 .S:MDLAB'="" MDLAB=MDLAB_": "
"RTN","MDPS2",72,0)
 .I MDT="CD" Q:$G(@MDNOD@("E",+MDFTYP,MDCT,MDFLD1,1))=""
"RTN","MDPS2",73,0)
 .I $P(MDDAT,U,2)["M" D  Q
"RTN","MDPS2",74,0)
 ..I MDMCT<2 D SETNODE(MDGRS," "),SETNODE(MDGRS,MDLAB)
"RTN","MDPS2",75,0)
 ..S MDVAL="  "_$G(@MDNOD@("E",+MDFTYP,MDCT,MDFLD1,1)) D SETNODE(MDGRS,MDVAL) Q
"RTN","MDPS2",76,0)
 .I $P(MDDAT,U,2)["D" S MDVAL=$G(@MDNOD@("E",+MDFTYP,MDCT,MDFLD1,1)),MDTX=$$FMTE^XLFDT(MDVAL,2),MDVAL=MDTX D SETNODE(MDGRS,MDLAB_MDVAL) Q
"RTN","MDPS2",77,0)
 .S MDVAL="     "_MDLAB_$G(@MDNOD@("E",+MDFTYP,MDCT,MDFLD1,1)) D SETNODE(MDGRS,MDVAL) Q
"RTN","MDPS2",78,0)
 .Q
"RTN","MDPS2",79,0)
 Q
"RTN","MDPS2",80,0)
FOOTER ; Display Medicine Footer
"RTN","MDPS2",81,0)
 Q:+$G(MDH)
"RTN","MDPS2",82,0)
 N CODE,ERROR,PART,PDUZ,RDATE,SCD,SCRAMBLE,SDUZ,TDATE,TEMP,TRUE,TP,DIC,DR,DA,DIQ
"RTN","MDPS2",83,0)
 N ENAME,EES,EDATE,NAME,NUM,VNAME,VES,VDATE,CODE,RELDATE,VERDATE,NA,MFD,MFDNAME,SUPD,CREATION,SUPNUM,SUPNUM,SUP1,SUP2,ROV,VERSION
"RTN","MDPS2",84,0)
 N FT,FTYPE,FNAME,PERSON,DTEMP,TT,X,X1,X2
"RTN","MDPS2",85,0)
 I '$D(^MCAR(MDF,+MDR,"ES")) Q
"RTN","MDPS2",86,0)
 S TEMP=$G(^MCAR(MDF,MDR,"ES"))
"RTN","MDPS2",87,0)
 ; Retrieve RC/ES Field (NA = Dont need)
"RTN","MDPS2",88,0)
 S NAME="ENAME^NA^EDATE^VNAME^VES^VDATE^CODE^RDATE^VDATE^SUP1^SUP2^MFD^MFDNAME^SUPD^CREATION^SUPNUM",FTYPE="P^X^D^P^F^D^F^D^D^F^F^F^P^D^D^F"
"RTN","MDPS2",89,0)
 F TT=1:1:16 S Y=$P(TEMP,U,TT),FT=$P(FTYPE,U,TT),FNAME=$P(NAME,U,TT) D DATE:FT="D",NAME:FT="P",FREE:FT="F"
"RTN","MDPS2",90,0)
 S SCD=$S(MFD:EDATE,CODE["RV":VDATE,CODE["ROV":VDATE,CODE="RNV":RDATE,CODE="S":EDATE,1:EDATE)
"RTN","MDPS2",91,0)
 S PERSON=$$DECODE(TEMP,CODE,MDF,MDR)
"RTN","MDPS2",92,0)
 S ROV=$S(CODE["ROV":"Signing for "_VNAME,1:""),SUPNUM=+SUPNUM,TSUP2=SUP2,SUPNUM=SUPNUM+1
"RTN","MDPS2",93,0)
 S:'SUP2 NUM=SUPNUM
"RTN","MDPS2",94,0)
 D:SUP2 VERSION
"RTN","MDPS2",95,0)
 S VERSION=SUPNUM_" of "_NUM,SS=""
"RTN","MDPS2",96,0)
 S $P(SS," -",40)="" D SETNODE(MDGRS,SS)
"RTN","MDPS2",97,0)
 S SS=$J(" ",18)_"R e p o r t   R e l e a s e   S t a t u s" D SETNODE(MDGRS,SS)
"RTN","MDPS2",98,0)
 D SETNODE(MDGRS," ")
"RTN","MDPS2",99,0)
 S SS="Current "_$J(" ",11)_"Date   "_$J(" ",2)_"Person Who" D SETNODE(MDGRS,SS)
"RTN","MDPS2",100,0)
 S SS="Report  "_$J(" ",11)_$S(CODE["D":"Last   ",1:"Status ")_"  Last "_$S(CODE["D":"Edited",1:"Changed")
"RTN","MDPS2",101,0)
 S SS=SS_$J(" ",13)_"Date of"_$J(" ",12)_"Report" D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPS2",102,0)
 S SS="Status  "_$J(" ",11)_$S(CODE["D":"Edited",1:"Changed")_$J(" ",2)_$S(CODE["D":" Procedure",1:"The Status")_$J(" ",15)_" Entry "_$J(" ",12)_"Version" D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPS2",103,0)
 S $P(SS,"=",80)="" D SETNODE(MDGRS,SS)
"RTN","MDPS2",104,0)
 I $G(MCSTAT)'="" D SETNODE(MDGRS,MCSTAT)
"RTN","MDPS2",105,0)
 S SS=$J(" ",19)_SCD_$J(" ",2)_PERSON
"RTN","MDPS2",106,0)
 S SS=SS_$J(" ",(52-$L(SS)))
"RTN","MDPS2",107,0)
 S SS=SS_CREATION_$J(" ",(64-$L(SS)))_VERSION
"RTN","MDPS2",108,0)
 D SETNODE(MDGRS,SS) K SS
"RTN","MDPS2",109,0)
 D SETNODE(MDGRS,$J(" ",28)_ROV)
"RTN","MDPS2",110,0)
 K MCFILE1
"RTN","MDPS2",111,0)
 Q
"RTN","MDPS2",112,0)
NAME S Y=$$GET1^DIQ(200,+Y_",",.01,"E"),@FNAME=$P(Y,",",2)_" "_$P(Y,",",1) Q
"RTN","MDPS2",113,0)
DATE S @FNAME=+$E(Y,4,5)_"/"_+$E(Y,6,7)_"/"_$E((1700+$E(Y,1,3)),3,4) Q
"RTN","MDPS2",114,0)
FREE S @FNAME=Y Q
"RTN","MDPS2",115,0)
DECODE(TEMP,CODE,FILE,REC) ;Decode the Validation code 1
"RTN","MDPS2",116,0)
 N CR,PDUZ,STR,PRE
"RTN","MDPS2",117,0)
 S PRE=+$P(TEMP,U,1) S:PRE=0 PRE=DUZ
"RTN","MDPS2",118,0)
 Q:(CODE="")!(CODE="D")!(CODE="PD")!(CODE="MFD")!(CODE="S") $$GET1^DIQ(200,PRE_",",.01) ;HUN-1095-22932
"RTN","MDPS2",119,0)
 S CR=$P(TEMP,U,$S(CODE["RV":5,1:2))
"RTN","MDPS2",120,0)
 S PDUZ=$P(TEMP,U,$S(CODE["RV":4,1:1))
"RTN","MDPS2",121,0)
 S STR=$$SUM^MCESPRT($G(^MCAR(MDF,REC,0)))
"RTN","MDPS2",122,0)
 Q $$DECODER^MCESPRT(CR,PDUZ,REC)
"RTN","MDPS2",123,0)
 ;
"RTN","MDPS2",124,0)
VERSION ; Find the version number of a procedure
"RTN","MDPS2",125,0)
 F NUM=SUPNUM:1 D CHECK Q:TSUP2=0
"RTN","MDPS2",126,0)
 S NUM=NUM+1
"RTN","MDPS2",127,0)
 Q
"RTN","MDPS2",128,0)
CHECK ; Find the number of times the report was superseded
"RTN","MDPS2",129,0)
 S DTEMP=$G(^MCAR(MDF,TSUP2,"ES"))
"RTN","MDPS2",130,0)
 S TSUP2=+$P(DTEMP,U,11)
"RTN","MDPS2",131,0)
 Q
"RTN","MDPS2",132,0)
HEDSPAS(MDTX,MDSP1) ;    surround text string X with space to length X1
"RTN","MDPS2",133,0)
 N I,Y1
"RTN","MDPS2",134,0)
 S (TY,Y1)="",$P(Y1," ",MDSP1-$L(MDTX)\2-1)=" ",TY=Y1_" "_MDTX_" "
"RTN","MDPS2",135,0)
 F I=$L(TY):1:MDSP1 S TY=TY_" "
"RTN","MDPS2",136,0)
 Q TY
"RTN","MDPS2",137,0)
SET ; Set GMTS variable
"RTN","MDPS2",138,0)
 N MDLIM1 S MDLIM=GMTSNDM
"RTN","MDPS2",139,0)
 D:+$G(MDLIM)<1 LIMIT(.MDLIM)
"RTN","MDPS2",140,0)
 S MDTS2=(9999999-GMTS1),MDTS1=(9999999-GMTS2)
"RTN","MDPS2",141,0)
 Q
"RTN","MDPS2",142,0)
LIMIT(MDLIM) ; Get all Report maximum occurrence limit
"RTN","MDPS2",143,0)
 N LIM
"RTN","MDPS2",144,0)
 S LIM=$$GET^XPAR("USR.`"_DUZ_"^DIV^SYS^PKG","ORWRP TIME/OCC LIMITS ALL",1,"I")
"RTN","MDPS2",145,0)
 S MDLIM=$S(+$P(LIM,";",3):+$P(LIM,";",3),1:999)
"RTN","MDPS2",146,0)
 Q
"RTN","MDPS2",147,0)
HEAD ; Display Header
"RTN","MDPS2",148,0)
 N MDPG S MDPG=0
"RTN","MDPS2",149,0)
H1 ; Display Header with Page increment
"RTN","MDPS2",150,0)
 Q:+$G(MDH)
"RTN","MDPS2",151,0)
 N CODE,MDDOB,MDRB,MDTIME,MDWARD,MDTM,X
"RTN","MDPS2",152,0)
 S MDPG=MDPG+1 D NOW^%DTC S X=% D DTIME^MCARP S MDTIME=$$FMTE^XLFDT(X,2)
"RTN","MDPS2",153,0)
 S MCSTAT="",MDTM=$G(^MCAR(MDF,+MDR,"ES")),CODE=$P(MDTM,U,7),MFD=$P(MDTM,U,12) I CODE'="" S MCSTAT=$S(MFD:" Mark for Deletion",1:"X") S:MCSTAT="X" MCSTAT=$$STATUS^MCESEDT(MDF,CODE)
"RTN","MDPS2",154,0)
 D DEM^VADPT
"RTN","MDPS2",155,0)
 S SS="Pg. "_MDPG_$J(" ",25)_$$HOSP(DFN)
"RTN","MDPS2",156,0)
 S SS=SS_$J(" ",(74-$L(SS_MDTIME)))_MDTIME D SETNODE(MDGRS,SS)
"RTN","MDPS2",157,0)
 S SS=$$HEDSPAS(MDPNAM_" REPORT"_$S(MCSTAT="":"",1:" - "_MCSTAT),77) D SETNODE(MDGRS,SS) S SS=""
"RTN","MDPS2",158,0)
 S SS=$$DEMO(DFN) D SETNODE(MDGRS,SS)
"RTN","MDPS2",159,0)
 N FFF S $P(FFF,"- ",40)="- " D SETNODE(MDGRS,FFF)
"RTN","MDPS2",160,0)
 Q
"RTN","MDPS2",161,0)
HOSP(DFN) ; Hospital for Header
"RTN","MDPS2",162,0)
 N HOSP
"RTN","MDPS2",163,0)
 S HOSP=$P($G(^DPT(DFN,.1)),U)
"RTN","MDPS2",164,0)
 S:HOSP'="" HOSP=$$FIND1^DIC(44,,"X",HOSP)
"RTN","MDPS2",165,0)
 S:HOSP'<1 HOSP=$$GET1^DIQ(44,HOSP,3.5,"I")
"RTN","MDPS2",166,0)
 S:HOSP'="" HOSP=$P($G(^DG(40.8,HOSP,0)),U)
"RTN","MDPS2",167,0)
 Q HOSP
"RTN","MDPS2",168,0)
DEMO(DFN) ; Demographics for Header
"RTN","MDPS2",169,0)
 N SS1,MDDOB,MDWARD,SS1
"RTN","MDPS2",170,0)
 D DEM^VADPT
"RTN","MDPS2",171,0)
 S SS1=$G(VADM(1))_"    "_$P($G(VADM(2)),U,2)_"   "
"RTN","MDPS2",172,0)
 S MDDOB=" DOB: "_$P($G(VADM(3)),U,2)_"  ("_$G(VADM(4))_")"
"RTN","MDPS2",173,0)
 S SS1=SS1_$J(" ",(39-$L(MDDOB)))_MDDOB
"RTN","MDPS2",174,0)
 D KVAR^VADPT
"RTN","MDPS2",175,0)
 D INP^VADPT S MDWARD=$S(VAIN(4)'="":$P(VAIN(4),U,2),1:"NOT INPATIENT"),MDRB=VAIN(5) D KVAR^VADPT
"RTN","MDPS2",176,0)
 Q SS1_$J(" ",(72-$L(SS1)))_MDWARD_" "_MDRB
"RTN","MDPS2",177,0)
HDR ; Page Header
"RTN","MDPS2",178,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)  W "  CONSULT                                   DATE/TIME",!
"RTN","MDPS2",179,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS2",180,0)
 W "   NUMBER   COMPLETED PROCEDURES            PERFORMED              PROCEDURE CODE",!
"RTN","MDPS2",181,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS2",182,0)
 W "  -------   ------------------------------  ----------------       -----------------",!
"RTN","MDPS2",183,0)
 Q
"RTN","MDPS2",184,0)
HSHDR ; Health Summary One Line Procedure Header
"RTN","MDPS2",185,0)
 N MDLINE
"RTN","MDPS2",186,0)
 S $P(MDLINE,"-",80)=""
"RTN","MDPS2",187,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)  W !,MDLINE
"RTN","MDPS2",188,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)  W !,$S(+$P(MDX1,U,13):$J($P(MDX1,U,13),9),1:""),?12,$E($P(MDX1,U,1),1,30),?44,$P(MDX1,U,6),?64,$P(MDX1,U,7)
"RTN","MDPS2",189,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)  W !,MDLINE
"RTN","MDPS2",190,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)  W !
"RTN","MDPS2",191,0)
 Q
"RTN","MDPS3")
0^7^B8516931
"RTN","MDPS3",1,0)
MDPS3 ; HOIFO/NCA - Remote Data View Data Retriever for CP ;4/29/04  10:50
"RTN","MDPS3",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2**;Apr 01, 2004
"RTN","MDPS3",3,0)
 ; Integration Agreements:
"RTN","MDPS3",4,0)
 ; Reference IA# 2693 [Subscription] TIU Extractions.
"RTN","MDPS3",5,0)
 ;               3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDPS3",6,0)
 ;               10104 [Supported] Routine XLFSTR calls.
"RTN","MDPS3",7,0)
 ;
"RTN","MDPS3",8,0)
GET702(MDGLO,MDDFN,MDC,MDSDT,MDEDT,MDMAX) ; Gather the new 702 entries
"RTN","MDPS3",9,0)
 N MDARR,MDCON,MDDTE,MDLP,MDCODE,MDPROC,MDSTAT,MDX
"RTN","MDPS3",10,0)
 S MDLP="" F  S MDLP=$O(^MDD(702,"B",MDDFN,MDLP)) Q:MDLP<1  D
"RTN","MDPS3",11,0)
 .S MDX=$G(^MDD(702,MDLP,0)) Q:$P(MDX,"^",9)'=3
"RTN","MDPS3",12,0)
 .S MDPROC=$$GET1^DIQ(702,MDLP_",",.04,"E") Q:MDPROC=""
"RTN","MDPS3",13,0)
 .Q:'$P(MDX,U,6)
"RTN","MDPS3",14,0)
 .K ^TMP("MDTIUST",$J) S MDTIUER=""
"RTN","MDPS3",15,0)
 .D EXTRACT^TIULQ($P(MDX,U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;70201;70202") Q:+MDTIUER
"RTN","MDPS3",16,0)
 .S MDCODE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70201,"E"))
"RTN","MDPS3",17,0)
 .S:MDCODE'="" MDCODE=$$UP^XLFSTR(MDCODE)
"RTN","MDPS3",18,0)
 .I $G(MDC)'="" Q:MDCODE'=$G(MDC)
"RTN","MDPS3",19,0)
 .S MDDTE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70202,"I"))
"RTN","MDPS3",20,0)
 .S MDSTAT=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),.05,"E"))
"RTN","MDPS3",21,0)
 .S:'MDDTE MDDTE=$$GET1^DIQ(702,MDLP_",",.02,"I")
"RTN","MDPS3",22,0)
 .K ^TMP("MDTIUST",$J)
"RTN","MDPS3",23,0)
 .S MDCON=$P(MDX,U,5) Q:'MDCON
"RTN","MDPS3",24,0)
 .I +$G(MDSDT) Q:MDDTE<+$G(MDSDT)
"RTN","MDPS3",25,0)
 .I +$G(MDEDT) Q:MDDTE>+$G(MDEDT)
"RTN","MDPS3",26,0)
 .I MDCON D  Q:MDSTAT'="COMPLETE"
"RTN","MDPS3",27,0)
 ..S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDPS3",28,0)
 ..I MDSTAT="" S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"I") S:+MDSTAT MDSTAT=$$GET1^DIQ(100.01,MDSTAT_",",.01,"E")
"RTN","MDPS3",29,0)
 ..Q
"RTN","MDPS3",30,0)
 .S Y=MDDTE X ^DD("DD") N MDREV S MDREV=(9999999.9999-MDDTE)
"RTN","MDPS3",31,0)
 .I MDCON Q:$G(MDARR(MDCON))'=""  S MDARR(MDCON)=MDCON
"RTN","MDPS3",32,0)
 .S:$G(^TMP("MDPLST",$J,MDPROC,MDREV_"^"_MDLP))="" ^(MDREV_"^"_MDLP)=MDPROC_"^"_MDLP_"^"_"PR702"_"^"_"MDPS1"_"^^"_Y_"^"_MDCODE_"^^^^"_MDPROC_"^^"_MDCON
"RTN","MDPS3",33,0)
 .Q
"RTN","MDPS3",34,0)
 K MDARR
"RTN","MDPS3",35,0)
 Q
"RTN","MDPS3",36,0)
PRO(RESULT) ;  Function to return info on single proceedure.
"RTN","MDPS3",37,0)
 ;
"RTN","MDPS3",38,0)
 ; RESULT = variable pointer to a medicine file
"RTN","MDPS3",39,0)
 ;          (e.g. "12;MCAR(691.5,") (required)
"RTN","MDPS3",40,0)
 N MDVAL,LL,S3,S4,S5
"RTN","MDPS3",41,0)
 S S3=+RESULT,S4=$P(RESULT,";",2),S4=$P(S4,",")
"RTN","MDPS3",42,0)
 I S4="MCAR(702.7" Q ""
"RTN","MDPS3",43,0)
 I S4="MCAR(699" S LL=$P($G(^MCAR(699,+S3,0)),U,12),MDVAL=$P($G(^MCAR(697.2,+LL,0)),U) Q MDVAL
"RTN","MDPS3",44,0)
 I S4="MCAR(699.5" S LL=$P($G(^MCAR(699.5,+S3,0)),U,6),MDVAL=$P($G(^MCAR(697.2,+LL,0)),U) Q MDVAL
"RTN","MDPS3",45,0)
 I S4="MCAR(694" S LL=$P($G(^MCAR(699.5,+S3,0)),U,6),MDVAL=$P($G(^MCAR(697.2,+LL,0)),U) Q MDVAL
"RTN","MDPS3",46,0)
 S LL=$O(^MCAR(697.2,"C",S4,0)),MDVAL=$P(^MCAR(697.2,LL,0),U)
"RTN","MDPS3",47,0)
 Q MDVAL
"RTN","MDPS3",48,0)
HDR ; Print Header for Report Form Feed
"RTN","MDPS3",49,0)
 N FFL,MDNM,MDNAME,MDTITL S $P(FFL,"-",80)=""
"RTN","MDPS3",50,0)
 S MDNM=$QS(MDREC,4),MDNAME=$O(^MCAR(697.2,"B",MDNM,0))
"RTN","MDPS3",51,0)
 I MDNAME S MDTITL=$P($G(^MCAR(697.2,+MDNAME,0)),"^",8)
"RTN","MDPS3",52,0)
 I $G(MDTITL)="" S MDNAME=$O(^MDS(702.01,"B",MDNM,0)) S:MDNAME MDTITL=$P($G(^MDS(702.01,+MDNAME,0)),U)
"RTN","MDPS3",53,0)
 W !!
"RTN","MDPS3",54,0)
 S MDRPG=MDRPG+1 W !,"Pg. "_MDRPG_$J(" ",25)_$$HOSP^MDPS2(DFN)
"RTN","MDPS3",55,0)
 I $G(MDTITL)'="" W !,$J(" ",25)_MDTITL
"RTN","MDPS3",56,0)
 W !,$$DEMO^MDPS2(DFN)
"RTN","MDPS3",57,0)
 W !,FFL
"RTN","MDPS3",58,0)
 Q
"VER")
8.0^22
**END**
**END**
