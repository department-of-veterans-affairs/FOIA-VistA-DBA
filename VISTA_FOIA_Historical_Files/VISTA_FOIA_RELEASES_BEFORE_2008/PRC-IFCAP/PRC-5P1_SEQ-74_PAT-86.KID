Released PRC*5.1*86 SEQ #74
Extracted from mail message
**KIDS**:PRC*5.1*86^

**INSTALL NAME**
PRC*5.1*86
"BLD",4287,0)
PRC*5.1*86^IFCAP^0^3050804^y
"BLD",4287,1,0)
^^5^5^3050804^
"BLD",4287,1,1,0)
 This patch corrects two issues related to the interface between the
"BLD",4287,1,2,0)
 DynaMed inventory system and IFCAP.
"BLD",4287,1,3,0)
 The first issue relates to the inappropriate use of BOC 2696 and the 
"BLD",4287,1,4,0)
 second to a problem that occurs when a Receiving Report is deleted
"BLD",4287,1,5,0)
 prior to being signed.
"BLD",4287,4,0)
^9.64PA^^
"BLD",4287,"KRN",0)
^9.67PA^8989.52^19
"BLD",4287,"KRN",.4,0)
.4
"BLD",4287,"KRN",.401,0)
.401
"BLD",4287,"KRN",.402,0)
.402
"BLD",4287,"KRN",.403,0)
.403
"BLD",4287,"KRN",.5,0)
.5
"BLD",4287,"KRN",.84,0)
.84
"BLD",4287,"KRN",3.6,0)
3.6
"BLD",4287,"KRN",3.8,0)
3.8
"BLD",4287,"KRN",9.2,0)
9.2
"BLD",4287,"KRN",9.8,0)
9.8
"BLD",4287,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",4287,"KRN",9.8,"NM",1,0)
PRCV442A^^0^B50305344
"BLD",4287,"KRN",9.8,"NM",2,0)
PRCV442B^^0^B43609146
"BLD",4287,"KRN",9.8,"NM",3,0)
PRCVIBH^^0^B98169766
"BLD",4287,"KRN",9.8,"NM","B","PRCV442A",1)

"BLD",4287,"KRN",9.8,"NM","B","PRCV442B",2)

"BLD",4287,"KRN",9.8,"NM","B","PRCVIBH",3)

"BLD",4287,"KRN",19,0)
19
"BLD",4287,"KRN",19.1,0)
19.1
"BLD",4287,"KRN",101,0)
101
"BLD",4287,"KRN",409.61,0)
409.61
"BLD",4287,"KRN",771,0)
771
"BLD",4287,"KRN",870,0)
870
"BLD",4287,"KRN",8989.51,0)
8989.51
"BLD",4287,"KRN",8989.52,0)
8989.52
"BLD",4287,"KRN",8994,0)
8994
"BLD",4287,"KRN","B",.4,.4)

"BLD",4287,"KRN","B",.401,.401)

"BLD",4287,"KRN","B",.402,.402)

"BLD",4287,"KRN","B",.403,.403)

"BLD",4287,"KRN","B",.5,.5)

"BLD",4287,"KRN","B",.84,.84)

"BLD",4287,"KRN","B",3.6,3.6)

"BLD",4287,"KRN","B",3.8,3.8)

"BLD",4287,"KRN","B",9.2,9.2)

"BLD",4287,"KRN","B",9.8,9.8)

"BLD",4287,"KRN","B",19,19)

"BLD",4287,"KRN","B",19.1,19.1)

"BLD",4287,"KRN","B",101,101)

"BLD",4287,"KRN","B",409.61,409.61)

"BLD",4287,"KRN","B",771,771)

"BLD",4287,"KRN","B",870,870)

"BLD",4287,"KRN","B",8989.51,8989.51)

"BLD",4287,"KRN","B",8989.52,8989.52)

"BLD",4287,"KRN","B",8994,8994)

"BLD",4287,"QUES",0)
^9.62^^
"BLD",4287,"REQB",0)
^9.611^1^1
"BLD",4287,"REQB",1,0)
PRC*5.1*81^2
"BLD",4287,"REQB","B","PRC*5.1*81",1)

"MBREQ")
0
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
86^3050804
"PKG",455,22,1,"PAH",1,1,0)
^^5^5^3050804
"PKG",455,22,1,"PAH",1,1,1,0)
 This patch corrects two issues related to the interface between the
"PKG",455,22,1,"PAH",1,1,2,0)
 DynaMed inventory system and IFCAP.
"PKG",455,22,1,"PAH",1,1,3,0)
 The first issue relates to the inappropriate use of BOC 2696 and the 
"PKG",455,22,1,"PAH",1,1,4,0)
 second to a problem that occurs when a Receiving Report is deleted
"PKG",455,22,1,"PAH",1,1,5,0)
 prior to being signed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PRCV442A")
0^1^B50305344
"RTN","PRCV442A",1,0)
PRCV442A ;WOIFO/CC-GET PO VALUES TO SEND TO DYNAMED;1/29/05
"RTN","PRCV442A",2,0)
V ;;5.1;IFCAP;**81,86**;Oct 20, 2000
"RTN","PRCV442A",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCV442A",4,0)
 Q
"RTN","PRCV442A",5,0)
 ;
"RTN","PRCV442A",6,0)
ITEM(POIEN,PRCVLINE,PRCVDATA,PRCVERR) ; Get Item data to send to DynaMed
"RTN","PRCV442A",7,0)
 ;
"RTN","PRCV442A",8,0)
 ;   POIEN    = the ien of the purchase order
"RTN","PRCV442A",9,0)
 ;   PRCVLINE = the ien of the line item number in the purchase order
"RTN","PRCV442A",10,0)
 ;   PRCVDATA = information from the PO level to keep for reference
"RTN","PRCV442A",11,0)
 ;               2237 number ^ expected delivery date
"RTN","PRCV442A",12,0)
 ;   PRCVERR  = flag to indicate if the item is not qualified for 
"RTN","PRCV442A",13,0)
 ;              transmission to DynaMed as it has no DM DOC ID or an
"RTN","PRCV442A",14,0)
 ;              error occurred
"RTN","PRCV442A",15,0)
 ;
"RTN","PRCV442A",16,0)
 N PRCV,PRCVDD,PRCVL,PRCVI
"RTN","PRCV442A",17,0)
 S PRCVDD="",PRCVERR=0,PRCVI=PRCVLINE_","_POIEN_","
"RTN","PRCV442A",18,0)
 D GETS^DIQ(442.01,PRCVI,".01;1.5;2;3;3.1;2;5;10;48","IE","PRCVL")
"RTN","PRCV442A",19,0)
 I $D(^TMP("DIERR",$J)) S PRCVERR=3 Q  ; item not on file in PO
"RTN","PRCV442A",20,0)
 S $P(PRCV,"^",1)=PRCVL(442.01,PRCVI,48,"I") ; DM Doc ID (#48 N2P15)
"RTN","PRCV442A",21,0)
 I $P(PRCV,"^",1)']"" S PRCVERR=1 Q  ; this is not a DM item
"RTN","PRCV442A",22,0)
 S $P(PRCV,"^",2)=PRCVL(442.01,PRCVI,1.5,"I") ; Item IEN (#1.5 N0 P5))
"RTN","PRCV442A",23,0)
 S $P(PRCV,"^",8)=$$GET1^DIQ(441,(PRCVL(442.01,PRCVI,1.5,"I")),51) ; NIF
"RTN","PRCV442A",24,0)
 S $P(PRCV,"^",3)=PRCVL(442.01,PRCVI,.01,"E") ; line item# #.01 n0,p1
"RTN","PRCV442A",25,0)
 S $P(PRCV,"^",6)=PRCVL(442.01,PRCVI,2,"I") ; QTY ORDERED (#2 N0 P 2)
"RTN","PRCV442A",26,0)
 S $P(PRCV,"^",5)=PRCVL(442.01,PRCVI,3,"E") ; UOP (#3 N 0 P 3)
"RTN","PRCV442A",27,0)
 S $P(PRCV,"^",9)=PRCVL(442.01,PRCVI,"3.1","E") ; pkg multiple (#3.1 N0 P12)
"RTN","PRCV442A",28,0)
 S $P(PRCV,"^",7)=PRCVL(442.01,PRCVI,5,"I") ; unit price (#5 N0 P 9)
"RTN","PRCV442A",29,0)
 S $P(PRCV,"^",4)=PRCVL(442.01,PRCVI,10,"E") ; 2237 IEN (#10 N0 P10)
"RTN","PRCV442A",30,0)
 I $P(PRCV,"^",4)']"" S $P(PRCV,"^",4)=$P(PRCVDATA,"^",1)
"RTN","PRCV442A",31,0)
 D DD(POIEN,PRCVL(442.01,PRCVI,.01,"E"),.PRCVDD) ; delivery date
"RTN","PRCV442A",32,0)
 S $P(PRCV,"^",13)=PRCVDD I PRCVDD="" S $P(PRCV,"^",13)=$P(PRCVDATA,"^",2)
"RTN","PRCV442A",33,0)
 S ^TMP("PRCV442A",$J,POIEN,PRCVLINE)=PRCV
"RTN","PRCV442A",34,0)
 ; 
"RTN","PRCV442A",35,0)
 Q
"RTN","PRCV442A",36,0)
 ;
"RTN","PRCV442A",37,0)
DD(POIEN,PRCVLINE,PRCVDD) ; get the earliest delivery date for the item
"RTN","PRCV442A",38,0)
 ;
"RTN","PRCV442A",39,0)
 ;   POIEN    = the ien of the purchase order
"RTN","PRCV442A",40,0)
 ;   PRCVLINE = the ien of the line item number in the purchase order
"RTN","PRCV442A",41,0)
 ;   PRCVDD   = the purchase order's expected delivery date
"RTN","PRCV442A",42,0)
 ;
"RTN","PRCV442A",43,0)
 N PRCVDS,PRCVDZ
"RTN","PRCV442A",44,0)
 S PRCVDZ="",PRCVDS=0
"RTN","PRCV442A",45,0)
 F  S PRCVDS=$O(^PRC(442.8,"AC",POIEN,PRCVLINE,PRCVDS)) Q:+PRCVDS'>0!(PRCVDS']"")  D
"RTN","PRCV442A",46,0)
 . S PRCVDZ=$P($G(^PRC(442.8,PRCVDS,0)),"^",3) ; get date from delivery schedule for item
"RTN","PRCV442A",47,0)
 . I PRCVDZ<PRCVDD S PRCVDD=PRCVDZ
"RTN","PRCV442A",48,0)
 . I PRCVDD']"" S PRCVDD=PRCVDZ
"RTN","PRCV442A",49,0)
 . Q
"RTN","PRCV442A",50,0)
 Q
"RTN","PRCV442A",51,0)
 ;
"RTN","PRCV442A",52,0)
PO(POIEN,PRCVDATA,PRCVERR) ; get PO information, station, DUZ
"RTN","PRCV442A",53,0)
 ;
"RTN","PRCV442A",54,0)
 ;   POIEN     = the ien of the purchase order
"RTN","PRCV442A",55,0)
 ;   PRCVDATA  = information from the PO level to keep for reference
"RTN","PRCV442A",56,0)
 ;               2237 number ^ expected delivery date
"RTN","PRCV442A",57,0)
 ;   PRCVERR   = flag to indicate if the order is not a qualified DynaMed
"RTN","PRCV442A",58,0)
 ;               PO.  1 - indicates MOP is not suitable for a DM order
"RTN","PRCV442A",59,0)
 ;
"RTN","PRCV442A",60,0)
 N PRCV,PRCVV,PRCVP,PRCVPO
"RTN","PRCV442A",61,0)
 S PRCVERR=0,PRCVPO=POIEN_","
"RTN","PRCV442A",62,0)
 D GETS^DIQ(442,PRCVPO,".01;.02;.07;5;7;17;62","IE","PRCVP")
"RTN","PRCV442A",63,0)
 I $D(^TMP("DIERR",$J)) S PRCVERR=2 Q  ; PO not on file
"RTN","PRCV442A",64,0)
 I PRCVP(442,PRCVPO,.02,"I")'=1,PRCVP(442,PRCVPO,.02,"I")'=25 S PRCVERR=1 Q  ; MOP (#.02 - n0,p2)
"RTN","PRCV442A",65,0)
 S $P(PRCV,"^",1)=PRCVP(442,PRCVPO,.01,"E") ; PO# (#.01 n0,p1)
"RTN","PRCV442A",66,0)
 S $P(PRCV,"^",4)=PRCVP(442,PRCVPO,5,"I") ; vendor IEN (#5 n1 p1)
"RTN","PRCV442A",67,0)
 ; get FMS vendor ID & alt addr code from file 440, #34&#35 - n3 p4&5
"RTN","PRCV442A",68,0)
 D GETS^DIQ(440,PRCVP(442,PRCVPO,5,"I")_",","34:35","E","PRCVV")
"RTN","PRCV442A",69,0)
 I $D(^TMP("DIERR",$J)) G PO1 ; vendor info not on file
"RTN","PRCV442A",70,0)
 S $P(PRCV,"^",5)=PRCVV(440,PRCVP(442,PRCVPO,5,"I")_",",34,"E") ; FMS vendor ID
"RTN","PRCV442A",71,0)
 S $P(PRCV,"^",6)=PRCVV(440,PRCVP(442,PRCVPO,5,"I")_",",35,"E") ; FMA alt add ind
"RTN","PRCV442A",72,0)
PO1 S $P(PRCV,"^",7)=PRCVP(442,PRCVPO,17,"I") ; date signed (un-amended POs) n12 p3
"RTN","PRCV442A",73,0)
 S PRCVDATA=PRCVP(442,PRCVPO,62,"E") ; for PC orders MOP=25, 2237 is in #62 N23,P23
"RTN","PRCV442A",74,0)
 I PRCVDATA']"" S PRCVDATA=PRCVP(442,PRCVPO,.07,"E") ; for inv/rec MOP=1, 2237 is in #.07 - n0,p12
"RTN","PRCV442A",75,0)
 S $P(PRCVDATA,"^",2)=PRCVP(442,PRCVPO,7,"I") ; delivery date (#7 n0p10)
"RTN","PRCV442A",76,0)
 ;
"RTN","PRCV442A",77,0)
 ; get Station Number, DUZ
"RTN","PRCV442A",78,0)
 S $P(PRCV,"^",8)=$$GET1^DIQ(4,$$KSP^XUPARAM("INST")_",",99)
"RTN","PRCV442A",79,0)
 S $P(PRCV,"^",3)=DUZ
"RTN","PRCV442A",80,0)
 ;
"RTN","PRCV442A",81,0)
 S ^TMP("PRCV442A",$J,POIEN)=PRCV
"RTN","PRCV442A",82,0)
 Q
"RTN","PRCV442A",83,0)
 ;
"RTN","PRCV442A",84,0)
RR(POIEN,PRCVLINE,PRCVRR,PRCVERR,ACTION) ; get receipt data for item
"RTN","PRCV442A",85,0)
 ;
"RTN","PRCV442A",86,0)
 ;   POIEN    = the ien of the purchase order
"RTN","PRCV442A",87,0)
 ;   PRCVLINE = the ien of the line item number in the purchase order
"RTN","PRCV442A",88,0)
 ;   PRCVRR   = the ien of the receiving report of interest
"RTN","PRCV442A",89,0)
 ;   PRCVERR  = flag to indicate if the order does not qualify for
"RTN","PRCV442A",90,0)
 ;              transmission to DynaMed or error occurred
"RTN","PRCV442A",91,0)
 ;   ACTION   = flag  1 - approved report ; 2- deleted report
"RTN","PRCV442A",92,0)
 ;
"RTN","PRCV442A",93,0)
 N PRCV,PRCVI,PRCVDEL,PRCVR
"RTN","PRCV442A",94,0)
 S PRCVI=PRCVRR_","_PRCVLINE_","_POIEN_","
"RTN","PRCV442A",95,0)
 D GETS^DIQ(442.08,PRCVI,"1;2;3;4","I","PRCVR")
"RTN","PRCV442A",96,0)
 I $D(^TMP("DIERR",$J)) S PRCVERR=4 G RR2  ; RR not on file
"RTN","PRCV442A",97,0)
 S PRCVDEL="" I ACTION=2 S PRCVDEL="-"
"RTN","PRCV442A",98,0)
 S PRCV=$G(^TMP("PRCV442A",$J,POIEN,PRCVLINE))
"RTN","PRCV442A",99,0)
 S $P(PRCV,"^",10)=PRCVDEL_PRCVR(442.08,PRCVI,1,"I") ; qty received (#1, NO P2)
"RTN","PRCV442A",100,0)
 S $P(PRCV,"^",11)=PRCVDEL_PRCVR(442.08,PRCVI,2,"I") ; total item cost (#2 NO P3)
"RTN","PRCV442A",101,0)
 S $P(PRCV,"^",12)=PRCVDEL_PRCVR(442.08,PRCVI,4,"I") ; total discount for item(#4, N0 P5)
"RTN","PRCV442A",102,0)
 S ^TMP("PRCV442A",$J,POIEN,PRCVLINE)=PRCV
"RTN","PRCV442A",103,0)
RR2 Q
"RTN","PRCV442A",104,0)
 ;
"RTN","PRCV442A",105,0)
UPD(POIEN) ; Update DynaMed of Approved POs with DynaMed items on them
"RTN","PRCV442A",106,0)
 ;
"RTN","PRCV442A",107,0)
 ; POIEN    The IEN of the Purchase Order
"RTN","PRCV442A",108,0)
 ;
"RTN","PRCV442A",109,0)
 N PRCVDATA,PRCVERR,PRCVLINE
"RTN","PRCV442A",110,0)
 S PRCVERR=0
"RTN","PRCV442A",111,0)
 K ^TMP("PRCV442A",$J)
"RTN","PRCV442A",112,0)
 D PO(POIEN,.PRCVDATA,.PRCVERR)
"RTN","PRCV442A",113,0)
 I PRCVERR=1 Q  ; not a DynaMed order
"RTN","PRCV442A",114,0)
 I PRCVERR>0 S PRCVERR=PRCVERR_"U" G TMPERR Q
"RTN","PRCV442A",115,0)
 S PRCVLINE=0
"RTN","PRCV442A",116,0)
 F  S PRCVLINE=$O(^PRC(442,POIEN,2,PRCVLINE)) Q:+PRCVLINE'>0!(PRCVLINE']"")  D
"RTN","PRCV442A",117,0)
 . D ITEM(POIEN,PRCVLINE,PRCVDATA,.PRCVERR)
"RTN","PRCV442A",118,0)
 . I PRCVERR=1 Q
"RTN","PRCV442A",119,0)
 . I PRCVERR>0 S PRCVERR=PRCVERR_"U" D TMPERR Q
"RTN","PRCV442A",120,0)
 I $O(^TMP("PRCV442A",$J,POIEN,""))]"" D
"RTN","PRCV442A",121,0)
 . S $P(^TMP("PRCV442A",$J,POIEN),"^",2)=1
"RTN","PRCV442A",122,0)
 I $O(^TMP("PRCV442A",$J,POIEN,""))']"" S PRCVERR=1 D Q Q  ; no item detail
"RTN","PRCV442A",123,0)
 D EN^PRCVPOSD(POIEN)
"RTN","PRCV442A",124,0)
 Q
"RTN","PRCV442A",125,0)
 ;
"RTN","PRCV442A",126,0)
DEL(POIEN) ; Update DynaMed of DynaMed items on a cancelled PC order
"RTN","PRCV442A",127,0)
 ;
"RTN","PRCV442A",128,0)
 ; POIEN    The IEN of the Purchase Order
"RTN","PRCV442A",129,0)
 ;
"RTN","PRCV442A",130,0)
 N PRCVDATA,PRCVDDAT,PRCVERR,PRCVLINE
"RTN","PRCV442A",131,0)
 S PRCVERR=0
"RTN","PRCV442A",132,0)
 K ^TMP("PRCV442A",$J)
"RTN","PRCV442A",133,0)
 D PO(POIEN,.PRCVDATA,.PRCVERR)
"RTN","PRCV442A",134,0)
 I PRCVERR=1 Q
"RTN","PRCV442A",135,0)
 I PRCVERR>0 S PRCVERR=PRCVERR_"D" G TMPERR Q
"RTN","PRCV442A",136,0)
 S PRCVDDAT=$$NOW^XLFDT
"RTN","PRCV442A",137,0)
 S $P(^TMP("PRCV442A",$J,POIEN),"^",7)=PRCVDDAT
"RTN","PRCV442A",138,0)
 S PRCVLINE=0
"RTN","PRCV442A",139,0)
 S $P(^TMP("PRCV442A",$J,POIEN),"^",2)=5
"RTN","PRCV442A",140,0)
 F  S PRCVLINE=$O(^PRC(442,POIEN,2,PRCVLINE)) Q:+PRCVLINE'>0!(PRCVLINE']"")  D
"RTN","PRCV442A",141,0)
 . D ITEM(POIEN,PRCVLINE,PRCVDATA,.PRCVERR)
"RTN","PRCV442A",142,0)
 . I PRCVERR=1 Q
"RTN","PRCV442A",143,0)
 . I PRCVERR>0 S PRCVERR=PRCVERR_"D" D TMPERR Q
"RTN","PRCV442A",144,0)
 . D DELAUD^PRCV442B($P(^TMP("PRCV442A",$J,POIEN,PRCVLINE),"^",1),PRCVDDAT,DUZ,POIEN,$P(^TMP("PRCV442A",$J,POIEN,PRCVLINE),"^",3),"") ; update DynaMed audit file
"RTN","PRCV442A",145,0)
 I $O(^TMP("PRCV442A",$J,POIEN,""))']"" S PRCVERR=1 D Q Q  ; no item detail
"RTN","PRCV442A",146,0)
 D EN^PRCVPOSD(POIEN)
"RTN","PRCV442A",147,0)
 Q
"RTN","PRCV442A",148,0)
 ;
"RTN","PRCV442A",149,0)
REC(POIEN,PARTIAL,ACTION) ; Update DynaMed of Receiving Report activity
"RTN","PRCV442A",150,0)
 ; 
"RTN","PRCV442A",151,0)
 ; POIEN    The IEN of the Purchase Order 
"RTN","PRCV442A",152,0)
 ; PARTIAL  The number of the Receiving Report
"RTN","PRCV442A",153,0)
 ; ACTION   1-signed ; 2-deleted
"RTN","PRCV442A",154,0)
 ;
"RTN","PRCV442A",155,0)
 N PRCV,PRCVDAT,PRCVERR,PRCVLINE,PRCVRR,PRCVDATA,PRCVSIG
"RTN","PRCV442A",156,0)
 S PRCVSIG=$$GET1^DIQ(442.11,(PARTIAL_","_POIEN_","),10,"I") ;WH D/T signed (#10 n0p11)
"RTN","PRCV442A",157,0)
 I PRCVSIG']"" Q  ; send only signed RR
"RTN","PRCV442A",158,0)
 ; Find all the items in the RR, get the fields needed
"RTN","PRCV442A",159,0)
 K ^TMP("PRCV442A",$J)
"RTN","PRCV442A",160,0)
 S PRCVERR=0
"RTN","PRCV442A",161,0)
 D PO(POIEN,.PRCVDATA,.PRCVERR)
"RTN","PRCV442A",162,0)
 I PRCVERR=1 D Q Q  ; order has MOP not used for DynaMed items
"RTN","PRCV442A",163,0)
 I PRCVERR>0 S PRCVERR=PRCVERR_ACTION D TMPERR Q
"RTN","PRCV442A",164,0)
 S PRCVDAT=$$NOW^XLFDT ; use for deletions
"RTN","PRCV442A",165,0)
 S PRCVLINE=0
"RTN","PRCV442A",166,0)
 F  S PRCVLINE=$O(^PRC(442,POIEN,2,PRCVLINE)) Q:+PRCVLINE'>0!(PRCVLINE']"")  D
"RTN","PRCV442A",167,0)
 . S PRCVRR=0
"RTN","PRCV442A",168,0)
 . F  S PRCVRR=$O(^PRC(442,POIEN,2,PRCVLINE,3,PRCVRR)) Q:+PRCVRR'>0!(PRCVRR']"")  I $P(^PRC(442,POIEN,2,PRCVLINE,3,PRCVRR,0),"^",4)=PARTIAL D
"RTN","PRCV442A",169,0)
 . . D ITEM(POIEN,PRCVLINE,PRCVDATA,.PRCVERR)
"RTN","PRCV442A",170,0)
 . . I PRCVERR=1 Q  ; this is not a DM item
"RTN","PRCV442A",171,0)
 . . I PRCVERR>0 S PRCVERR=PRCVERR_ACTION D TMPERR Q
"RTN","PRCV442A",172,0)
 . . D RR(POIEN,PRCVLINE,PRCVRR,.PRCVERR,ACTION)
"RTN","PRCV442A",173,0)
 . . I ACTION=2 S PRCV=$G(^TMP("PRCV442A",$J,POIEN,PRCVLINE)) D RRAUD^PRCV442B(POIEN,PRCV,PRCVSIG,PRCVDAT)
"RTN","PRCV442A",174,0)
 . . I PRCVERR>1 S PRCVERR=PRCVERR_ACTION D TMPERR ; sends blanks to DM?
"RTN","PRCV442A",175,0)
 I $O(^TMP("PRCV442A",$J,POIEN,""))]"" D
"RTN","PRCV442A",176,0)
 . S $P(^TMP("PRCV442A",$J,POIEN),"^",7)=$S(ACTION=2:PRCVDAT,1:PRCVSIG)
"RTN","PRCV442A",177,0)
 . S $P(^TMP("PRCV442A",$J,POIEN),"^",2)=$S(ACTION=2:4,1:3)
"RTN","PRCV442A",178,0)
 . D EN^PRCVPOSD(POIEN)
"RTN","PRCV442A",179,0)
 I $O(^TMP("PRCV442A",$J,POIEN,""))']"" S PRCVERR=1 D Q ; no item detail
"RTN","PRCV442A",180,0)
 Q
"RTN","PRCV442A",181,0)
 ;
"RTN","PRCV442A",182,0)
TMPERR ;
"RTN","PRCV442A",183,0)
 ; D TMPERR^PRCV442B
"RTN","PRCV442A",184,0)
 Q
"RTN","PRCV442A",185,0)
 ;
"RTN","PRCV442A",186,0)
Q I PRCVERR K ^TMP("PRCV442A",$J)
"RTN","PRCV442A",187,0)
 Q
"RTN","PRCV442B")
0^2^B43609146
"RTN","PRCV442B",1,0)
PRCV442B ;WOIFO/CC-GET DATA WHEN ITEM DELETED, SET UP AUDIT FILE;1/29/05
"RTN","PRCV442B",2,0)
V ;;5.1;IFCAP;**81,86**;Oct 20, 2000
"RTN","PRCV442B",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCV442B",4,0)
 Q
"RTN","PRCV442B",5,0)
 ;
"RTN","PRCV442B",6,0)
RRAUD(POIEN,PRCV,PRCVCR,PRCVDAT) ; add deleted Receiving Report to audit file
"RTN","PRCV442B",7,0)
 ;
"RTN","PRCV442B",8,0)
 ;   POIEN  = the ien of the purchase order from which the receiving
"RTN","PRCV442B",9,0)
 ;            report is being deleted.
"RTN","PRCV442B",10,0)
 ;   PRCV   = the string of info about the item (from PRCV442A)
"RTN","PRCV442B",11,0)
 ;            DM DOC ID ^ Item ien ^ line item # ^ 2237 ien ^ UOP ^ 
"RTN","PRCV442B",12,0)
 ;            qty ordered ^ unit price ^ NIF ^ pkg mult ^ qty rec'd
"RTN","PRCV442B",13,0)
 ;            ^ total item cost ^ total discount ^ delivery date
"RTN","PRCV442B",14,0)
 ;   PRCVCR = the date/time the receiving report was created
"RTN","PRCV442B",15,0)
 ;  PRCVDAT = The date/time of deletion processing
"RTN","PRCV442B",16,0)
 ;
"RTN","PRCV442B",17,0)
 N PRCVRA,PRCVRN,PRCVIEN,PRCVY
"RTN","PRCV442B",18,0)
 S PRCVID=$P(PRCV,"^",1) Q:PRCVID']""  ; DM DOC ID
"RTN","PRCV442B",19,0)
 S PRCVRN=$O(^PRCV(414.02,"B",PRCVID,0)) ; find DM DOC ID record
"RTN","PRCV442B",20,0)
 I +PRCVRN'>0 D MAIL("X1",POIEN,PRCVID,$P(PRCV,"^",2)) Q  ; notify users that DM DOC ID record not in audit file
"RTN","PRCV442B",21,0)
 S PRCVIEN="+1,"_PRCVRN_","
"RTN","PRCV442B",22,0)
 S PRCVRA(414.021,PRCVIEN,.01)=PRCVDAT ; D/T RR deleted
"RTN","PRCV442B",23,0)
 S PRCVRA(414.021,PRCVIEN,1)=DUZ ; user deleting RR
"RTN","PRCV442B",24,0)
 S PRCVRA(414.021,PRCVIEN,2)=PRCVCR ; RR create D/T
"RTN","PRCV442B",25,0)
 S PRCVRA(414.021,PRCVIEN,3)=0-$P(PRCV,"^",10) ; Qty
"RTN","PRCV442B",26,0)
 S PRCVRA(414.021,PRCVIEN,4)=0-$P(PRCV,"^",11) ; total cost
"RTN","PRCV442B",27,0)
 S PRCVRA(414.021,PRCVIEN,5)=0-$P(PRCV,"^",12) ; discount
"RTN","PRCV442B",28,0)
 D UPDATE^DIE("","PRCVRA","PRCVY")
"RTN","PRCV442B",29,0)
 I $D(^TMP("DIERR",$J)) D MAIL("X5",POIEN,PRCVID,$P(PRCV,"^",2)) ; tell users that Audit file could not be updated
"RTN","PRCV442B",30,0)
 S $P(^TMP("PRCV442A",$J,POIEN),"^",7)=PRCVDAT
"RTN","PRCV442B",31,0)
 Q
"RTN","PRCV442B",32,0)
 ;
"RTN","PRCV442B",33,0)
DELAUD(PRCVID,PRCVDATE,PRCVDUZ,POIEN,PRCVITEM,PRCVIT) ; UPDATE AUDIT FILE FOR DELETED ITEMS
"RTN","PRCV442B",34,0)
 ;
"RTN","PRCV442B",35,0)
 ; PRCVID   = the DM Doc ID of the item being deleted
"RTN","PRCV442B",36,0)
 ; PRCVDATE = the date/time the item is deleted or PO is cancelled
"RTN","PRCV442B",37,0)
 ; PRCVDUZ  = the user deleting the item or canceling the PO
"RTN","PRCV442B",38,0)
 ; POIEN    = the ien of the purchase order from which the receiving
"RTN","PRCV442B",39,0)
 ;            report is being deleted.
"RTN","PRCV442B",40,0)
 ; PRCVITEM = the item number
"RTN","PRCV442B",41,0)
 ; PRCVIT   = set to 1 if deleted at line item level, else PC cancel
"RTN","PRCV442B",42,0)
 ;
"RTN","PRCV442B",43,0)
 N PRCVD,PRCVDA,PRCVIEN,PRCVY
"RTN","PRCV442B",44,0)
 S PRCVY="C" I PRCVIT=1 S PRCVY="D"
"RTN","PRCV442B",45,0)
 S PRCVDA=$O(^PRCV(414.02,"B",PRCVID,0)) ; find DM DOC ID record
"RTN","PRCV442B",46,0)
 I PRCVDA']"" D MAIL(PRCVY_1,POIEN,PRCVID,PRCVITEM) Q  ; DM DOC ID not in audit file
"RTN","PRCV442B",47,0)
 S PRCVD(414.02,PRCVDA_",",8)=PRCVDATE
"RTN","PRCV442B",48,0)
 S PRCVD(414.02,PRCVDA_",",9)=PRCVDUZ
"RTN","PRCV442B",49,0)
 D UPDATE^DIE("","PRCVD")
"RTN","PRCV442B",50,0)
 I $D(^TMP("DIERR",$J)) D MAIL(PRCVY_5,POIEN,PRCVID,PRCVITEM) ; tell user audit file not updated
"RTN","PRCV442B",51,0)
 Q
"RTN","PRCV442B",52,0)
 ;
"RTN","PRCV442B",53,0)
 ;
"RTN","PRCV442B",54,0)
DELITEM(POIEN) ; delete line item, get key info for DYNAMED
"RTN","PRCV442B",55,0)
 ; called from "AK" cross ref in DD - .01 of file 442.01 (Item multiple)
"RTN","PRCV442B",56,0)
 ;
"RTN","PRCV442B",57,0)
 ; POIEN = the ien of the purchase order (file 442)
"RTN","PRCV442B",58,0)
 ;
"RTN","PRCV442B",59,0)
 N PRCV,PRCVP
"RTN","PRCV442B",60,0)
 S PRCVP=""
"RTN","PRCV442B",61,0)
 D OP^XQCHK I $P(XQOPT,"^",1)="PRCHPC PO REMOVE 2237" Q  ; this option does not cancel item out of IFCAP
"RTN","PRCV442B",62,0)
 I $$GET^XPAR("SYS","PRCV COTS INVENTORY",1,"Q")'=1 Q  ; DM interface not active
"RTN","PRCV442B",63,0)
 D GETS^DIQ(442,POIEN_",",".01;.02;.07;5;7;62","IE","PRCVP") ; get PO data
"RTN","PRCV442B",64,0)
 S $P(PRCV,"^",7)=POIEN,POIEN=POIEN_","
"RTN","PRCV442B",65,0)
 I $D(^TMP("DIERR",$J)) G DELITEM1 ; PO data not on file,send to DM anyway
"RTN","PRCV442B",66,0)
 S $P(PRCV,"^",8)=PRCVP(442,POIEN,.02,"I") ; MOP (#.02 - n0,p2)
"RTN","PRCV442B",67,0)
 S $P(PRCV,"^",1)=PRCVP(442,POIEN,.01,"E") ; PO# (#.01 n0,p1)
"RTN","PRCV442B",68,0)
 S $P(PRCV,"^",4)=PRCVP(442,POIEN,5,"I") ; vendor IEN (#5 n1 p1)
"RTN","PRCV442B",69,0)
 S $P(PRCV,"^",5)=PRCVP(442,POIEN,62,"E") ; for PC orders MOP=25, 2237 is in #62 N23,P23
"RTN","PRCV442B",70,0)
 S $P(PRCV,"^",6)=PRCVP(442,POIEN,.07,"E") ; for inv/rec MOP=1, 2237 is in #.07 - n0,p12
"RTN","PRCV442B",71,0)
 S $P(PRCV,"^",2)=PRCVP(442,POIEN,7,"I") ; delivery date (#7 n0p10)
"RTN","PRCV442B",72,0)
DELITEM1 S $P(PRCV,"^",10)=$$NOW^XLFDT
"RTN","PRCV442B",73,0)
 S $P(PRCV,"^",11)=DA
"RTN","PRCV442B",74,0)
 ;
"RTN","PRCV442B",75,0)
 ; get DUZ
"RTN","PRCV442B",76,0)
 S $P(PRCV,"^",3)=DUZ
"RTN","PRCV442B",77,0)
 ;
"RTN","PRCV442B",78,0)
 ; X1 is the array of variables set in the execution of the 'AK' cross reference
"RTN","PRCV442B",79,0)
 S X1(999999)=PRCV ; save PO data to variables passed to background job
"RTN","PRCV442B",80,0)
 ;
"RTN","PRCV442B",81,0)
 D OPKG^XUHUI("","PRCV 442 ITEM DELETE","K","AK") ; invoke background job
"RTN","PRCV442B",82,0)
 K X1(999999) ; not to go back DD
"RTN","PRCV442B",83,0)
 Q
"RTN","PRCV442B",84,0)
 ;
"RTN","PRCV442B",85,0)
DELJOB ; send deleted item's info to DynaMed (collected by DELITEM subroutine)
"RTN","PRCV442B",86,0)
 ; called from protocol PRCV 442 ITEM DELETE and jobbed by TaskMan
"RTN","PRCV442B",87,0)
 ; builds
"RTN","PRCV442B",88,0)
 ; PRCVI (string for each item)  
"RTN","PRCV442B",89,0)
 ;   DM DOC ID ^ Item ien ^ line item # ^ 2237 ien ^ UOP ^ qty ordered
"RTN","PRCV442B",90,0)
 ;   ^ unit price ^ NIF ^ pkg mult ^ qty rec'd ^ total item cost ^
"RTN","PRCV442B",91,0)
 ;   total discount ^ delivery date
"RTN","PRCV442B",92,0)
 ; PRCV (header) variable -
"RTN","PRCV442B",93,0)
 ;   PO# ^ txn type ^ DUZ ^ vendor IEN ^ FMS vendor # ^Alt add ind ^
"RTN","PRCV442B",94,0)
 ;   txn D/T ^ Station# ^ Purchasing Station
"RTN","PRCV442B",95,0)
 ;
"RTN","PRCV442B",96,0)
 N POIEN,PRCV,PRCVERR,PRCVI,PRCVP,PRCVV,PRCV2237
"RTN","PRCV442B",97,0)
 ; QUIT IF mop'1 AND '=25
"RTN","PRCV442B",98,0)
 S PRCVP=XUHUIX1(999999) I $P(PRCVP,"^",8)'=1,$P(PRCVP,"^",8)'=25 Q
"RTN","PRCV442B",99,0)
 S POIEN=$P(PRCVP,"^",7)
"RTN","PRCV442B",100,0)
 K ^TMP("PRCV442A",$J,POIEN)
"RTN","PRCV442B",101,0)
 S PRCV=$P(PRCVP,"^",1,4),$P(PRCV,"^",7)=$P(PRCVP,"^",10)
"RTN","PRCV442B",102,0)
 ; get FMS vendor ID & alt addr code from file 440, #34&#35 - n3 p4&5
"RTN","PRCV442B",103,0)
 I $P(PRCV,"^",4)]"" D GETS^DIQ(440,$P(PRCV,"^",4)_",","34:35","E","PRCVV")
"RTN","PRCV442B",104,0)
 I $D(^TMP("DIERR",$J)) G DELJOB1 ; vendor data not on file
"RTN","PRCV442B",105,0)
 S $P(PRCV,"^",2)=5 ; DELETE
"RTN","PRCV442B",106,0)
 S $P(PRCV,"^",5)=PRCVV(440,$P(PRCV,"^",4)_",",34,"E") ; FMS vendor ID
"RTN","PRCV442B",107,0)
 S $P(PRCV,"^",6)=PRCVV(440,$P(PRCV,"^",4)_",",35,"E") ; FMA alt add ind
"RTN","PRCV442B",108,0)
 ; get Station Number
"RTN","PRCV442B",109,0)
DELJOB1 S $P(PRCV,"^",8)=$$GET1^DIQ(4,$$KSP^XUPARAM("INST")_",",99)
"RTN","PRCV442B",110,0)
 S ^TMP("PRCV442A",$J,POIEN)=PRCV
"RTN","PRCV442B",111,0)
 S PRCVI=XUHUIX1(2)_"^"_XUHUIX1(3)_"^"_XUHUIX1(1)_"^^^"_XUHUIX1(4)_"^"_XUHUIX1(7)_"^^"_XUHUIX1(6)
"RTN","PRCV442B",112,0)
 S $P(PRCVI,"^",5)=$$GET1^DIQ(420.5,XUHUIX1(5),.01,"E") ; UOP
"RTN","PRCV442B",113,0)
 S $P(PRCVI,"^",8)=$$GET1^DIQ(441,XUHUIX1(3),51) ; NIF
"RTN","PRCV442B",114,0)
 S $P(PRCVI,"^",13)=$P(PRCVP,"^",2) ; DELIVERY DATE FOR PO
"RTN","PRCV442B",115,0)
 S PRCV2237=XUHUIX1(8)
"RTN","PRCV442B",116,0)
 I PRCV2237]"" S PRCV2237=$$GET1^DIQ(410,PRCV2237,.01,"E")
"RTN","PRCV442B",117,0)
 I PRCV2237']"" S PRCV2237=$P(PRCVP,"^",6)
"RTN","PRCV442B",118,0)
 I PRCV2237']"" S PRCV2237=$P(PRCVP,"^",5)
"RTN","PRCV442B",119,0)
 S $P(PRCVI,"^",4)=PRCV2237
"RTN","PRCV442B",120,0)
 D DELAUD($P(PRCVI,"^",1),$P(PRCV,"^",7),$P(PRCV,"^",3),POIEN,$P(PRCVI,"^",2),1)
"RTN","PRCV442B",121,0)
 S ^TMP("PRCV442A",$J,POIEN,$P(PRCVP,"^",11))=PRCVI
"RTN","PRCV442B",122,0)
 I $O(^TMP("PRCV442A",$J,POIEN,""))']"" S PRCVERR=1 D Q  Q  ; no DynaMed items
"RTN","PRCV442B",123,0)
 D EN^PRCVPOSD(POIEN)
"RTN","PRCV442B",124,0)
 Q
"RTN","PRCV442B",125,0)
 ;
"RTN","PRCV442B",126,0)
MAIL(PRCVCODE,PRCVPIEN,PRCVID,PRCVITEM) ; PREPARE VALUES FOR MESSAGE TO USERS
"RTN","PRCV442B",127,0)
 ;
"RTN","PRCV442B",128,0)
 ; $E(PRCVCODE,1) = U if the error occurred approving a PO
"RTN","PRCV442B",129,0)
 ;                = C if the error occurred canceling a PO
"RTN","PRCV442B",130,0)
 ;                = D if error occurred while deleting a line item
"RTN","PRCV442B",131,0)
 ;                = R if the error occurred signing a Receipt Report
"RTN","PRCV442B",132,0)
 ;                = X if the error occurred deleting a Receipt Report
"RTN","PRCV442B",133,0)
 ; $E(PRCVCODE,2) = DM Doc ID not in Audit File
"RTN","PRCV442B",134,0)
 ;                = 2 if the PO data could not be found
"RTN","PRCV442B",135,0)
 ;                = 3 if the item data could not be found
"RTN","PRCV442B",136,0)
 ;                = 4 if the receiving report info for item was not found
"RTN","PRCV442B",137,0)
 ;                = 5 if data could not be saved in audit file
"RTN","PRCV442B",138,0)
 ;
"RTN","PRCV442B",139,0)
 ; PRCVPIEN       IEN of selected purchase order
"RTN","PRCV442B",140,0)
 ; PRCVID         DM Doc ID of affected item
"RTN","PRCV442B",141,0)
 ; PRCVITEM       ien of item (item#)
"RTN","PRCV442B",142,0)
 ;
"RTN","PRCV442B",143,0)
 N PRCVSITE,PRCVFCP,PRCVPO,XMB
"RTN","PRCV442B",144,0)
 K ^TMP($J,"PRCV442B")
"RTN","PRCV442B",145,0)
 S XMB(1)=$S($E(PRCVCODE,1)="C":"cancelling a PC order",$E(PRCVCODE,1)="D":"deleting a line item from a purchase order",1:"deleting a receiving report")
"RTN","PRCV442B",146,0)
 S XMB(2)=PRCVID
"RTN","PRCV442B",147,0)
 S XMB(3)=" "_PRCVID_" is not in file 414.02 - can't add related data"
"RTN","PRCV442B",148,0)
 I $E(PRCVCODE,2)=5 D
"RTN","PRCV442B",149,0)
 . S XMB(3)="System can't update Audit File (414.02) for "_PRCVID
"RTN","PRCV442B",150,0)
 . D TMPERR
"RTN","PRCV442B",151,0)
 S PRCVPO=$P($G(^PRC(442,PRCVPIEN,0)),"^",1)
"RTN","PRCV442B",152,0)
 S ^TMP($J,"PRCV442B",1)="Purchase Order# "_PRCVPO
"RTN","PRCV442B",153,0)
 S ^TMP($J,"PRCV442B",2)="ITEM# "_PRCVITEM
"RTN","PRCV442B",154,0)
 S ^TMP($J,"PRCV442B")=2
"RTN","PRCV442B",155,0)
 S PRCVSITE=PRCVPO+0 I PRCVSITE=0 S PRCVSITE=PRC("SITE")
"RTN","PRCV442B",156,0)
 S PRCVFCP=$P($G(^PRC(442,PRCVPIEN,0)),"^",3)
"RTN","PRCV442B",157,0)
 S PRCVFCP=$P(PRCVFCP," ",1)
"RTN","PRCV442B",158,0)
 D DMERXMB^PRCVLIC("PRCV442B",PRCVSITE,PRCVFCP)
"RTN","PRCV442B",159,0)
 K ^TMP($J,"PRCV442B")
"RTN","PRCV442B",160,0)
 Q
"RTN","PRCV442B",161,0)
 ;
"RTN","PRCV442B",162,0)
TMPERR ;
"RTN","PRCV442B",163,0)
 ;
"RTN","PRCV442B",164,0)
 ;
"RTN","PRCV442B",165,0)
 N PRCJ,PRCK S PRCK=$G(^TMP($J,"PRCV442B")),PRCJ=0
"RTN","PRCV442B",166,0)
 F  S PRCJ=$O(^TMP("DIERR",$J,PRCJ)) Q:PRCJ'?1.N  D
"RTN","PRCV442B",167,0)
 . I $D(^TMP("DIERR",$J,PRCJ,"TEXT",1)) D
"RTN","PRCV442B",168,0)
 . . S PRCK=PRCK+1,^TMP($J,"PRCV442B",PRCK)="Reason: "_^TMP("DIERR",$J,PRCJ,"TEXT",1)
"RTN","PRCV442B",169,0)
 . . S:$D(^TMP("DIERR",$J,PRCJ,"PARAM","IENS")) ^TMP($J,"PRCV442B",PRCK)=$E(^TMP($J,"PRCV442B",PRCK),1,220)_"-IENS: "_^TMP("DIERR",$J,PRCJ,"PARAM","IENS")
"RTN","PRCV442B",170,0)
 S:PRCK>0 ^TMP($J,"PRCV442B")=PRCK
"RTN","PRCV442B",171,0)
 K ^TMP("DIERR",$J)
"RTN","PRCV442B",172,0)
 Q
"RTN","PRCV442B",173,0)
 ;
"RTN","PRCV442B",174,0)
FCP(PRCVPO) ; return FCP for PO#
"RTN","PRCV442B",175,0)
 ;
"RTN","PRCV442B",176,0)
 ;    PRCVPO = the external purchase order number
"RTN","PRCV442B",177,0)
 ;    returns -1 if the PO or its FCP cannot be found
"RTN","PRCV442B",178,0)
 ;
"RTN","PRCV442B",179,0)
 N PRCVF,PRCVI
"RTN","PRCV442B",180,0)
 S PRCVF=-1
"RTN","PRCV442B",181,0)
 S PRCVI=$O(^PRC(442,"B",PRCVPO,0))
"RTN","PRCV442B",182,0)
 I PRCVI]"" D
"RTN","PRCV442B",183,0)
 . S PRCVI=$$GET1^DIQ(442,PRCVI_",",1,"E")
"RTN","PRCV442B",184,0)
 . I PRCVI]"" S PRCVF=$P(PRCVI," ",1)
"RTN","PRCV442B",185,0)
 Q PRCVF
"RTN","PRCV442B",186,0)
 ;
"RTN","PRCV442B",187,0)
Q I PRCVERR K ^TMP("PRCV442A",$J)
"RTN","PRCV442B",188,0)
 Q
"RTN","PRCVIBH")
0^3^B98169766
"RTN","PRCVIBH",1,0)
PRCVIBH ;WOIFO/DST - Issue Book Processing, from DynaMed to IFCAP ;7/26/05  17:10
"RTN","PRCVIBH",2,0)
 ;;5.1;IFCAP;**81,86**;Oct 20, 2000
"RTN","PRCVIBH",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCVIBH",4,0)
 ;
"RTN","PRCVIBH",5,0)
 ; IV - Internal Voucher, SV - Standard Voucher
"RTN","PRCVIBH",6,0)
 Q
"RTN","PRCVIBH",7,0)
CRT ; Process Issue Book transactions sent from DynaMed to IFCAP
"RTN","PRCVIBH",8,0)
 K HLERR
"RTN","PRCVIBH",9,0)
 N %,PRCVDT,PRCVI,PRCVJ,PRCVK,PRCVIBF,PRCVSUB,PRCVSITE
"RTN","PRCVIBH",10,0)
 D:'$D(U) DT^DICRW
"RTN","PRCVIBH",11,0)
 D NOW^%DTC S PRCVDT=%
"RTN","PRCVIBH",12,0)
 S PRCVSUB="PRCVFMS2;"_HL("MID")
"RTN","PRCVIBH",13,0)
 K ^TMP(PRCVSUB),^TMP($J,"PRCVIB")
"RTN","PRCVIBH",14,0)
 F PRCVI=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","PRCVIBH",15,0)
 . S ^TMP($J,"PRCVIB",PRCVI)=HLNODE,PRCVJ=0
"RTN","PRCVIBH",16,0)
 . F  S PRCVJ=$O(HLNODE(PRCVJ)) Q:'PRCVJ  S ^TMP($J,"PRCVIB",PRCVI,PRCVJ)=HLNODE(PRCVJ)
"RTN","PRCVIBH",17,0)
 . Q
"RTN","PRCVIBH",18,0)
 ; 
"RTN","PRCVIBH",19,0)
MAIN ; Main routine
"RTN","PRCVIBH",20,0)
 ; Check HL7 message type and message event
"RTN","PRCVIBH",21,0)
 ; PRCVEA - Error message array
"RTN","PRCVIBH",22,0)
 ; PRCVTDT - Transaction Date 
"RTN","PRCVIBH",23,0)
 ; PRCVDAC - Document Action
"RTN","PRCVIBH",24,0)
 N PRCVFS,PRCVRS,PRCVCS,PRCVES,PRCVSS,PRCVCC,PRCVSCC
"RTN","PRCVIBH",25,0)
 N PRCVEA,PRCVTDT,PRCVBID,PRCVLID,PRCVND,PRCVSEG,PRCVY,X,X1,X2
"RTN","PRCVIBH",26,0)
 ;
"RTN","PRCVIBH",27,0)
 S PRCVK=0
"RTN","PRCVIBH",28,0)
 S PRCVFS=$G(HL("FS")),PRCVCS=$E($G(HL("ECH"))),PRCVRS=$E($G(HL("ECH")),2),PRCVES=$E($G(HL("ECH")),U,3),PRCVSS=$E($G(HL("ECH")),U,4)
"RTN","PRCVIBH",29,0)
 ;
"RTN","PRCVIBH",30,0)
HEADER I HL("MTN")'="DFT"!(HL("ETN")'="P03") D  Q
"RTN","PRCVIBH",31,0)
 . D ADDERR("PRCV1"_U_"Wrong Message or Event Type: "_HL("MTN")_U_HL("ETN"))
"RTN","PRCVIBH",32,0)
 . D GENACK("AR",HL("MID"),PRCVDT,.PRCVEA)
"RTN","PRCVIBH",33,0)
 . Q
"RTN","PRCVIBH",34,0)
 ;
"RTN","PRCVIBH",35,0)
 S X1=$P(PRCVDT,"."),X2=14 D C^%DTC
"RTN","PRCVIBH",36,0)
 S ^TMP(PRCVSUB,$J,0)=X_U_$P(PRCVDT,".")_"^IB Sent from DynaMed to IFCAP"
"RTN","PRCVIBH",37,0)
 ;
"RTN","PRCVIBH",38,0)
 ; Check each segments - EVN,PID,FT1
"RTN","PRCVIBH",39,0)
 ;   PRCVTCD - Transaction Code - "IV" or "SV"
"RTN","PRCVIBH",40,0)
 ;   PRCVSTN - Station Number
"RTN","PRCVIBH",41,0)
 ;
"RTN","PRCVIBH",42,0)
START N PREVSEG,PRCVSTN,PRCVDAC,PRCVTDT,PRCVTCD
"RTN","PRCVIBH",43,0)
 S PRCVSITE=$$GET1^DIQ(4,$$KSP^XUPARAM("INST")_",",99)
"RTN","PRCVIBH",44,0)
 S PREVSEG=""
"RTN","PRCVIBH",45,0)
 S PRCVI=0
"RTN","PRCVIBH",46,0)
 D NOW^%DTC S PRCVDT=%
"RTN","PRCVIBH",47,0)
 F  S PRCVI=$O(^TMP($J,"PRCVIB",PRCVI)) Q:'PRCVI  D
"RTN","PRCVIBH",48,0)
 . S PRCVND=$G(^TMP($J,"PRCVIB",PRCVI))
"RTN","PRCVIBH",49,0)
 . S PRCVSEG=$P(PRCVND,PRCVFS)
"RTN","PRCVIBH",50,0)
 . Q:PRCVSEG="MSH"!(PRCVSEG="")
"RTN","PRCVIBH",51,0)
 . I $$CHKSEQ(PRCVSEG) K ^TMP($J,"PRCVIB") S PRCVI="" Q
"RTN","PRCVIBH",52,0)
 . S PREVSEG=PRCVSEG
"RTN","PRCVIBH",53,0)
 . D @PRCVSEG
"RTN","PRCVIBH",54,0)
 . Q
"RTN","PRCVIBH",55,0)
 I PRCVSEG'="FT1" D ADDERR("PRCV1"_U_"No Item line for this transaction.")
"RTN","PRCVIBH",56,0)
 ; 
"RTN","PRCVIBH",57,0)
 ; If errored, send AE ACK, clean up and QUIT
"RTN","PRCVIBH",58,0)
ERR I $D(PRCVEA)!(PRCVTCD']"") D XTMP("AE"),FIN Q
"RTN","PRCVIBH",59,0)
OK ; Calling IFCAP and FMS routines for Issue Book and FMS update
"RTN","PRCVIBH",60,0)
 ;
"RTN","PRCVIBH",61,0)
 I PRCVTCD="SV" D
"RTN","PRCVIBH",62,0)
 . I '$$ENT^PRCVFMS2(PRCVSUB) D
"RTN","PRCVIBH",63,0)
 .. D ADDERR("PRCV3"_U_"Error in generating FMS Code Sheet.")
"RTN","PRCVIBH",64,0)
 .. D XTMP("AE")
"RTN","PRCVIBH",65,0)
 .. Q
"RTN","PRCVIBH",66,0)
 . Q
"RTN","PRCVIBH",67,0)
 I PRCVTCD="IV" D
"RTN","PRCVIBH",68,0)
 . S PRCVIBF=$$INIT^PRCVIBF(PRCVSUB)
"RTN","PRCVIBH",69,0)
 . ; PRCVIBF - return "IEN of 410^Error Code^Error Description"
"RTN","PRCVIBH",70,0)
 . ; If errored, move ^TMP to ^XTMP and quit
"RTN","PRCVIBH",71,0)
 . I '+PRCVIBF D  Q
"RTN","PRCVIBH",72,0)
 .. D ADDERR("PRCV3"_U_$P(PRCVIBF,U,2)_"-"_$P(PRCVIBF,U,3))
"RTN","PRCVIBH",73,0)
 .. D XTMP("AE")
"RTN","PRCVIBH",74,0)
 .. Q
"RTN","PRCVIBH",75,0)
 . I '$$ENT^PRCVFMS1(PRCVSUB,+PRCVIBF) D
"RTN","PRCVIBH",76,0)
 .. D ADDERR("PRCV3"_U_"Error in generating FMS Code Sheet.")
"RTN","PRCVIBH",77,0)
 .. D XTMP("AE")
"RTN","PRCVIBH",78,0)
 .. Q
"RTN","PRCVIBH",79,0)
 . Q
"RTN","PRCVIBH",80,0)
 ;
"RTN","PRCVIBH",81,0)
 I '$D(PRCVEA) D GENACK("AA",HL("MID"),PRCVDT)
"RTN","PRCVIBH",82,0)
 D FIN
"RTN","PRCVIBH",83,0)
 Q
"RTN","PRCVIBH",84,0)
 ;
"RTN","PRCVIBH",85,0)
CHKSEQ(SEG) ; SEG - Segment name
"RTN","PRCVIBH",86,0)
 N SEGERR,PREV1,PREV2,PRCVER1
"RTN","PRCVIBH",87,0)
 S SEGERR=0
"RTN","PRCVIBH",88,0)
 S PREV1=$P($P($T(@(SEG_1)),";;",2),U)
"RTN","PRCVIBH",89,0)
 S PREV2=$P($P($T(@(SEG_1)),";;",2),U,2)
"RTN","PRCVIBH",90,0)
 I PREVSEG=PREV1!(PREVSEG=PREV2) Q SEGERR
"RTN","PRCVIBH",91,0)
 S SEGERR=1
"RTN","PRCVIBH",92,0)
 S PRCVER1=$P($P($T(@(SEG_1)),";;",2),U,4)_SEG
"RTN","PRCVIBH",93,0)
 D ADDERR("PRCV1"_U_PRCVER1)
"RTN","PRCVIBH",94,0)
 Q SEGERR
"RTN","PRCVIBH",95,0)
 ;
"RTN","PRCVIBH",96,0)
EVN ; Process EVN segment
"RTN","PRCVIBH",97,0)
 ;
"RTN","PRCVIBH",98,0)
 S PRCVSTN=$P(PRCVND,PRCVFS,8)
"RTN","PRCVIBH",99,0)
 I PRCVSTN']"" D ADDERR("PRCV2"_U_"Station Number is missing.",8)
"RTN","PRCVIBH",100,0)
 I PRCVSTN'=PRCVSITE D ADDERR("PRCV2"_U_"Invalid Station Number: "_PRCVSTN,8)
"RTN","PRCVIBH",101,0)
 S PRCVDAC=$P(PRCVND,PRCVFS,5)
"RTN","PRCVIBH",102,0)
 I "EMX"'[PRCVDAC!(PRCVDAC']"") D ADDERR("PRCV2"_U_"Invalid Document Action: "_PRCVDAC,5)
"RTN","PRCVIBH",103,0)
 S PRCVTDT=$P(PRCVND,PRCVFS,3)
"RTN","PRCVIBH",104,0)
 I PRCVTDT']"" D ADDERR("PRCV2"_U_"Transaction Date is missing.",3) Q
"RTN","PRCVIBH",105,0)
 S PRCVTDT=$$HL7TFM^XLFDT(PRCVTDT,"L",0)
"RTN","PRCVIBH",106,0)
 I $P(PRCVTDT,".")>PRCVDT D ADDERR("PRCV2"_U_"Invalid Transaction Date: "_PRCVTDT,3)
"RTN","PRCVIBH",107,0)
 Q
"RTN","PRCVIBH",108,0)
 ;
"RTN","PRCVIBH",109,0)
PID ; Process PID segment
"RTN","PRCVIBH",110,0)
 ;
"RTN","PRCVIBH",111,0)
 N PRCVDUZ,PRCVFCP1,PRCVFCP2,PRCVBOC,PRCVTERM
"RTN","PRCVIBH",112,0)
 ;
"RTN","PRCVIBH",113,0)
 S PRCVBID=$P(PRCVND,PRCVFS,4)
"RTN","PRCVIBH",114,0)
 I PRCVBID']"" D ADDERR("PRCV2"_U_"Batch ID is missing.",4)
"RTN","PRCVIBH",115,0)
 S PRCVTCD=$P(PRCVND,PRCVFS,5)
"RTN","PRCVIBH",116,0)
 I PRCVTCD']"" D ADDERR("PRCV2"_U_"Transaction Code is missing.",5)
"RTN","PRCVIBH",117,0)
 I PRCVTCD'="IV",(PRCVTCD'="SV") D ADDERR("PRCV2"_U_"Invalid Transaction Code: "_PRCVTCD,5)
"RTN","PRCVIBH",118,0)
 ; Check User ID, Termination Date and is authorized FCP user
"RTN","PRCVIBH",119,0)
 S PRCVDUZ=$P(PRCVND,PRCVFS,3)
"RTN","PRCVIBH",120,0)
 I PRCVDUZ']"" D ADDERR("PRCV2"_U_"User ID is missing.",3)
"RTN","PRCVIBH",121,0)
 I PRCVDUZ]"" D
"RTN","PRCVIBH",122,0)
 . I '$$FIND1^DIC(200,"","","`"_PRCVDUZ,"","","PRCVERR") D ADDERR("PRCV2"_U_"Invalid User ID: "_PRCVDUZ,3)
"RTN","PRCVIBH",123,0)
 . E  D
"RTN","PRCVIBH",124,0)
 .. S PRCVTERM=$$GET1^DIQ(200,PRCVDUZ_",",9.2,"I")
"RTN","PRCVIBH",125,0)
 .. I +PRCVTERM>0,(PRCVTERM<DT) D ADDERR("PRCV2"_U_"Invalid User ID: "_PRCVDUZ,3)
"RTN","PRCVIBH",126,0)
 .. Q
"RTN","PRCVIBH",127,0)
 .Q
"RTN","PRCVIBH",128,0)
 S PRCVFCP1=$P(PRCVND,PRCVFS,22)
"RTN","PRCVIBH",129,0)
 I PRCVFCP1']"" D ADDERR("PRCV2"_U_$S(PRCVTCD="IV":"Seller's",1:"Warehouse's")_" Fund Control Point is missing.",22)
"RTN","PRCVIBH",130,0)
 I '$D(^PRC(420,PRCVSITE,1,+PRCVFCP1)) D ADDERR("PRCV2"_U_"Invalid "_$S(PRCVTCD="IV":"Seller's",1:"Warehouse's")_" Fund Control Point.",22)
"RTN","PRCVIBH",131,0)
 I $D(^PRC(420,PRCVSITE,1,+PRCVFCP1)),$P(^PRC(420,PRCVSITE,1,+PRCVFCP1,0),U,19) D ADDERR("PRCV2"_U_"Inactivated "_$S(PRCVTCD="IV":"Seller's",1:"Warehouse's")_" Fund Control Point.",22)
"RTN","PRCVIBH",132,0)
 I PRCVTCD="IV" D
"RTN","PRCVIBH",133,0)
 . S PRCVFCP2=$P(PRCVND,PRCVFS,24)
"RTN","PRCVIBH",134,0)
 . I PRCVFCP2']"" D ADDERR("PRCV2"_U_"Buyer's Fund Control Point is missing.",24)
"RTN","PRCVIBH",135,0)
 . E  D
"RTN","PRCVIBH",136,0)
 .. I '$D(^PRC(420,PRCVSITE,1,+PRCVFCP2)) D ADDERR("PRCV2"_U_"Invalid Buyer's Fund Control Point.",24)
"RTN","PRCVIBH",137,0)
 .. I $D(^PRC(420,PRCVSITE,1,+PRCVFCP2)),$P(^PRC(420,PRCVSITE,1,+PRCVFCP2,0),U,19) D ADDERR("PRCV2"_U_"Inactivated Buyer's Fund Control Point.",24)
"RTN","PRCVIBH",138,0)
 .. Q
"RTN","PRCVIBH",139,0)
 . S PRCVCC=$P(PRCVND,PRCVFS,19)
"RTN","PRCVIBH",140,0)
 . I PRCVCC']"" D ADDERR("PRCV2"_U_"Buyer's Cost Center is missing.",19)
"RTN","PRCVIBH",141,0)
 . S PRCVSCC=$P(PRCVND,PRCVFS,20)
"RTN","PRCVIBH",142,0)
 . I PRCVSCC']"" D ADDERR("PRCV2"_U_"Buyer's Sub-cost Center is missing.",20)
"RTN","PRCVIBH",143,0)
 . I PRCVCC,(PRCVSCC'="") D
"RTN","PRCVIBH",144,0)
 .. I '$D(^PRCD(420.1,PRCVCC_PRCVSCC)) D ADDERR("PRCV2"_U_"Invalid Buyer's Cost Center. Cost Center not defined in Cost Center file 420.1",19) Q
"RTN","PRCVIBH",145,0)
 .. I '$D(^PRC(420,PRCVSTN,1,+PRCVFCP2,2,PRCVCC_PRCVSCC)) D ADDERR("PRCV2"_U_"Invalid Buyer's Cost Center. Cost Center not used for this Fund Control Point.",19)
"RTN","PRCVIBH",146,0)
 .. Q
"RTN","PRCVIBH",147,0)
 . Q
"RTN","PRCVIBH",148,0)
 I PRCVDUZ]"",('$D(^PRC(420,PRCVSTN,1,$S(PRCVTCD="IV":+PRCVFCP2,1:+PRCVFCP1),1,PRCVDUZ))) D ADDERR("PRCV2"_U_"Unauthorized User for this FCP.",3)
"RTN","PRCVIBH",149,0)
 S ^TMP(PRCVSUB,$J,1)=PRCVSTN_U_PRCVBID_U_PRCVTCD_U_PRCVDAC_U_PRCVTDT_U_PRCVDUZ
"RTN","PRCVIBH",150,0)
 S ^TMP(PRCVSUB,$J,2)=PRCVFCP1_U_$G(PRCVFCP2)_U_$G(PRCVCC)_U_$G(PRCVSCC)
"RTN","PRCVIBH",151,0)
 Q
"RTN","PRCVIBH",152,0)
 ;
"RTN","PRCVIBH",153,0)
FT1 ; Process FT1 segment
"RTN","PRCVIBH",154,0)
 N PRCVACC,PRCVBOC,PRCVINV,PRCVSAL,PRCVRCD
"RTN","PRCVIBH",155,0)
 ;
"RTN","PRCVIBH",156,0)
 S PRCVLID=$P(PRCVND,PRCVFS,3)
"RTN","PRCVIBH",157,0)
 I 'PRCVLID D ADDERR("PRCV2"_U_"Line ID is missing.",3)
"RTN","PRCVIBH",158,0)
 S PRCVACC=$P(PRCVND,PRCVFS,9)
"RTN","PRCVIBH",159,0)
 I 'PRCVACC D ADDERR("PRCV2"_U_"Account Code is missing.",9)
"RTN","PRCVIBH",160,0)
 I PRCVACC,((PRCVACC'?1N)!("12368"'[PRCVACC)) D ADDERR("PRCV2"_U_"Invalid Account Code: "_PRCVACC,9)
"RTN","PRCVIBH",161,0)
 I PRCVTCD="IV" D
"RTN","PRCVIBH",162,0)
 . S PRCVBOC=$P(PRCVND,PRCVFS,10)
"RTN","PRCVIBH",163,0)
 . I PRCVBOC=2696 D ADDERR("PRCV2"_U_"Invalid Buyer's Budget Object Code: "_PRCVBOC,10)
"RTN","PRCVIBH",164,0)
 . I 'PRCVBOC D ADDERR("PRCV2"_U_"Budget Object Code is missing.",10)
"RTN","PRCVIBH",165,0)
 . I '$D(^PRCD(420.1,PRCVCC_PRCVSCC,1,PRCVBOC)) D ADDERR("PRCV2"_U_"Invalid Budget Object Code for this Cost Center: "_PRCVBOC,10)
"RTN","PRCVIBH",166,0)
 . I $P($G(^PRCD(420.2,PRCVBOC,0)),"^",2)=1 D ADDERR("PRCV2"_U_"Inactivated Budget Object Code: "_PRCVBOC,10)
"RTN","PRCVIBH",167,0)
 . S PRCVSAL=$P(PRCVND,PRCVFS,13)
"RTN","PRCVIBH",168,0)
 . I 'PRCVSAL D ADDERR("PRCV2"_U_"Sale Value is missing.",13)
"RTN","PRCVIBH",169,0)
 . Q
"RTN","PRCVIBH",170,0)
 S PRCVINV=$P(PRCVND,PRCVFS,12)
"RTN","PRCVIBH",171,0)
 I 'PRCVINV D ADDERR("PRCV2"_U_"Inventory Value is missing.",12)
"RTN","PRCVIBH",172,0)
 I PRCVTCD="SV" D
"RTN","PRCVIBH",173,0)
 . S PRCVRCD=$P(PRCVND,PRCVFS,8)
"RTN","PRCVIBH",174,0)
 . I PRCVRCD']"" D ADDERR("PRCV2"_U_"Reason Code is missing.",8)
"RTN","PRCVIBH",175,0)
 . I PRCVRCD'?1N!(PRCVRCD<1)!(PRCVRCD>7) D ADDERR("PRCV2"_U_"Invalid Reason Code: "_PRCVRCD,8)
"RTN","PRCVIBH",176,0)
 . Q
"RTN","PRCVIBH",177,0)
 S ^TMP(PRCVSUB,$J,3,0)=PRCVLID
"RTN","PRCVIBH",178,0)
 S ^TMP(PRCVSUB,$J,3,PRCVLID,0)=PRCVLID_U_PRCVACC_U_$G(PRCVBOC)_U_PRCVINV_U_$G(PRCVSAL)_U_$G(PRCVRCD)
"RTN","PRCVIBH",179,0)
 Q
"RTN","PRCVIBH",180,0)
 ;
"RTN","PRCVIBH",181,0)
GENACK(PRCVAC,PRCVMCID,PRCVDT,PRCVOCCR) ;
"RTN","PRCVIBH",182,0)
 ;
"RTN","PRCVIBH",183,0)
 ;PRCVAC - Acknowledgment Code
"RTN","PRCVIBH",184,0)
 ;PRCVMCID - Message Control ID which you're acknowledging
"RTN","PRCVIBH",185,0)
 ;PRCVDT - Date/Time of Transaction
"RTN","PRCVIBH",186,0)
 ;PRCVOCCR - Error message array
"RTN","PRCVIBH",187,0)
 ;
"RTN","PRCVIBH",188,0)
 N PRCVFS,PRCVCNT,PRCVCS,PRCVI,PRCVJ,PRCVND,PRCVRES
"RTN","PRCVIBH",189,0)
 ;
"RTN","PRCVIBH",190,0)
 S PRCVFS=$G(HL("FS")),PRCVCS=$E($G(HL("ECH"))),PRCVRS=$E($G(HL("ECH")),2),PRCVES=$E($G(HL("ECH")),U,3),PRCVSS=$E($G(HL("ECH")),U,4)
"RTN","PRCVIBH",191,0)
 S PRCVRES="",PRCVJ=0,PRCVI=1
"RTN","PRCVIBH",192,0)
 ;
"RTN","PRCVIBH",193,0)
 ; MSA Segment
"RTN","PRCVIBH",194,0)
 S HLA("HLA",1)="MSA"_PRCVFS_PRCVAC_PRCVFS_PRCVMCID_PRCVFS_$G(PRCVBID)
"RTN","PRCVIBH",195,0)
 ; 
"RTN","PRCVIBH",196,0)
 ; ERR Segment
"RTN","PRCVIBH",197,0)
 I $G(PRCVOCCR)'="" D
"RTN","PRCVIBH",198,0)
 . F  S PRCVJ=$O(PRCVOCCR(PRCVJ)) Q:'PRCVJ  D
"RTN","PRCVIBH",199,0)
 .. S PRCVI=PRCVI+1
"RTN","PRCVIBH",200,0)
 .. S HLA("HLA",PRCVI)="ERR"_PRCVFS_PRCVOCCR(PRCVJ)
"RTN","PRCVIBH",201,0)
 .. Q
"RTN","PRCVIBH",202,0)
 . Q
"RTN","PRCVIBH",203,0)
 ;
"RTN","PRCVIBH",204,0)
 D GENACK^HLMA1(HL("EID"),$G(HLMTIENS),HL("EIDS"),"LM",1,PRCVRES)
"RTN","PRCVIBH",205,0)
 I $P($G(PRCVRES),U,2) D
"RTN","PRCVIBH",206,0)
 . K XMB,XMZ
"RTN","PRCVIBH",207,0)
 . S XMB="PRCV HL7 ERROR"
"RTN","PRCVIBH",208,0)
 . S XMB(1)="PRCVIB"
"RTN","PRCVIBH",209,0)
 . S XMB(2)="Application Acknowledgement"
"RTN","PRCVIBH",210,0)
 . S XMB(3)="PRCV_IFCAP_06_SU_IB_PROC"
"RTN","PRCVIBH",211,0)
 . S XMB(4)=PRCVRES
"RTN","PRCVIBH",212,0)
 . S XMDUZ="PRCV HL7 Generator"
"RTN","PRCVIBH",213,0)
 . D ^XMB
"RTN","PRCVIBH",214,0)
 . K XMB,XMDUZ,XMZ
"RTN","PRCVIBH",215,0)
 . Q
"RTN","PRCVIBH",216,0)
 ;
"RTN","PRCVIBH",217,0)
 K HLA("HLA"),^TMP("HLA",$J)
"RTN","PRCVIBH",218,0)
 K PRCVAC,X
"RTN","PRCVIBH",219,0)
 Q
"RTN","PRCVIBH",220,0)
 ;
"RTN","PRCVIBH",221,0)
ADDERR(PRCVER,PRCVFD) ;
"RTN","PRCVIBH",222,0)
 ; PRCVER - Error message
"RTN","PRCVIBH",223,0)
 ; PRCVFD - Field number, if any 
"RTN","PRCVIBH",224,0)
 ;
"RTN","PRCVIBH",225,0)
 S PRCVK=PRCVK+1
"RTN","PRCVIBH",226,0)
 S PRCVEA=PRCVK
"RTN","PRCVIBH",227,0)
 S:'$G(PRCVLID) PRCVLID=1
"RTN","PRCVIBH",228,0)
 S:'$G(PRCVFD) PRCVLID="",PRCVFD=""
"RTN","PRCVIBH",229,0)
 S PRCVEA(PRCVK)=PRCVFS_$G(PRCVSEG)_U_PRCVLID_U_PRCVFD_PRCVFS_"207^Application Internal Error^HL70357"_PRCVFS_"E"_PRCVFS_PRCVER_PRCVFS_PRCVLID
"RTN","PRCVIBH",230,0)
 Q
"RTN","PRCVIBH",231,0)
 ;
"RTN","PRCVIBH",232,0)
XTMP(AC) ; Move ^TMP(PRCVSUB,$j) to ^XTMP
"RTN","PRCVIBH",233,0)
 ;
"RTN","PRCVIBH",234,0)
 ; AC - Acknowledgement
"RTN","PRCVIBH",235,0)
 ;
"RTN","PRCVIBH",236,0)
 S ^XTMP(PRCVSUB,0)=$$FMADD^XLFDT(PRCVDT,14)_U_PRCVDT_U_"IB Data from DynaMed with error"
"RTN","PRCVIBH",237,0)
 F PRCVI=1,2 S ^XTMP(PRCVSUB,PRCVI)=^TMP(PRCVSUB,$J,PRCVI)
"RTN","PRCVIBH",238,0)
 I $D(^TMP(PRCVSUB,$J,3,0)) D
"RTN","PRCVIBH",239,0)
 . S ^XTMP(PRCVSUB,3,0)=^TMP(PRCVSUB,$J,3,0)
"RTN","PRCVIBH",240,0)
 . S PRCVI=0
"RTN","PRCVIBH",241,0)
 . F  S PRCVI=$O(^TMP(PRCVSUB,$J,3,PRCVI)) Q:'PRCVI  D
"RTN","PRCVIBH",242,0)
 .. S ^XTMP(PRCVSUB,3,PRCVI)=^TMP(PRCVSUB,$J,3,PRCVI,0)
"RTN","PRCVIBH",243,0)
 .. Q
"RTN","PRCVIBH",244,0)
 D GENACK(AC,HL("MID"),PRCVDT,.PRCVEA)
"RTN","PRCVIBH",245,0)
 S ^XTMP(PRCVSUB,4,0)=PRCVEA
"RTN","PRCVIBH",246,0)
 S PRCVI=0
"RTN","PRCVIBH",247,0)
 F  S PRCVI=$O(PRCVEA(PRCVI)) Q:'PRCVI  D
"RTN","PRCVIBH",248,0)
 . S ^XTMP(PRCVSUB,4,PRCVI)=PRCVEA(PRCVI)
"RTN","PRCVIBH",249,0)
 . Q
"RTN","PRCVIBH",250,0)
 Q
"RTN","PRCVIBH",251,0)
 ;
"RTN","PRCVIBH",252,0)
FIN ; Clean up
"RTN","PRCVIBH",253,0)
 ;
"RTN","PRCVIBH",254,0)
 ; K ^TMP($J,"PRCVIB")
"RTN","PRCVIBH",255,0)
 ; K ^TMP(PRCVSUB,$J)
"RTN","PRCVIBH",256,0)
 K PRCVEA
"RTN","PRCVIBH",257,0)
 Q
"RTN","PRCVIBH",258,0)
 ;
"RTN","PRCVIBH",259,0)
TXT ; 
"RTN","PRCVIBH",260,0)
EVN1 ;;^EVN^^Missing segment ^100^Missing line item info.
"RTN","PRCVIBH",261,0)
PID1 ;;EVN^^^Missing segment ^100^Missing line item info.
"RTN","PRCVIBH",262,0)
FT11 ;;PID^FT1^^Missing segment ^100^Missing line item info.
"VER")
8.0^22.0
"BLD",4287,6)
^SEQ #74
**END**
**END**
