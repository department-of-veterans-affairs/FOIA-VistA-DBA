Released PSD*3*60 SEQ #50
Extracted from mail message
**KIDS**:PSD*3.0*60^

**INSTALL NAME**
PSD*3.0*60
"BLD",6540,0)
PSD*3.0*60^CONTROLLED SUBSTANCES^0^3060705^y
"BLD",6540,1,0)
^^3^3^3051215^
"BLD",6540,1,1,0)
This patch will correct the problem of an old greensheet being
"BLD",6540,1,2,0)
selected when a drug IEN is entered and it matches an old 
"BLD",6540,1,3,0)
pharmacy dispencing number.
"BLD",6540,4,0)
^9.64PA^^
"BLD",6540,"ABPKG")
n
"BLD",6540,"KRN",0)
^9.67PA^8989.52^19
"BLD",6540,"KRN",.4,0)
.4
"BLD",6540,"KRN",.401,0)
.401
"BLD",6540,"KRN",.402,0)
.402
"BLD",6540,"KRN",.403,0)
.403
"BLD",6540,"KRN",.5,0)
.5
"BLD",6540,"KRN",.84,0)
.84
"BLD",6540,"KRN",3.6,0)
3.6
"BLD",6540,"KRN",3.8,0)
3.8
"BLD",6540,"KRN",9.2,0)
9.2
"BLD",6540,"KRN",9.8,0)
9.8
"BLD",6540,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",6540,"KRN",9.8,"NM",1,0)
PSDRF^^0^B25117230
"BLD",6540,"KRN",9.8,"NM",2,0)
PSDRF4^^0^B21421420
"BLD",6540,"KRN",9.8,"NM",3,0)
PSDRFR^^0^B28496304
"BLD",6540,"KRN",9.8,"NM",4,0)
PSDRFS^^0^B27168731
"BLD",6540,"KRN",9.8,"NM",5,0)
PSDRFW^^0^B28360776
"BLD",6540,"KRN",9.8,"NM","B","PSDRF",1)

"BLD",6540,"KRN",9.8,"NM","B","PSDRF4",2)

"BLD",6540,"KRN",9.8,"NM","B","PSDRFR",3)

"BLD",6540,"KRN",9.8,"NM","B","PSDRFS",4)

"BLD",6540,"KRN",9.8,"NM","B","PSDRFW",5)

"BLD",6540,"KRN",19,0)
19
"BLD",6540,"KRN",19.1,0)
19.1
"BLD",6540,"KRN",101,0)
101
"BLD",6540,"KRN",409.61,0)
409.61
"BLD",6540,"KRN",771,0)
771
"BLD",6540,"KRN",870,0)
870
"BLD",6540,"KRN",8989.51,0)
8989.51
"BLD",6540,"KRN",8989.52,0)
8989.52
"BLD",6540,"KRN",8994,0)
8994
"BLD",6540,"KRN","B",.4,.4)

"BLD",6540,"KRN","B",.401,.401)

"BLD",6540,"KRN","B",.402,.402)

"BLD",6540,"KRN","B",.403,.403)

"BLD",6540,"KRN","B",.5,.5)

"BLD",6540,"KRN","B",.84,.84)

"BLD",6540,"KRN","B",3.6,3.6)

"BLD",6540,"KRN","B",3.8,3.8)

"BLD",6540,"KRN","B",9.2,9.2)

"BLD",6540,"KRN","B",9.8,9.8)

"BLD",6540,"KRN","B",19,19)

"BLD",6540,"KRN","B",19.1,19.1)

"BLD",6540,"KRN","B",101,101)

"BLD",6540,"KRN","B",409.61,409.61)

"BLD",6540,"KRN","B",771,771)

"BLD",6540,"KRN","B",870,870)

"BLD",6540,"KRN","B",8989.51,8989.51)

"BLD",6540,"KRN","B",8989.52,8989.52)

"BLD",6540,"KRN","B",8994,8994)

"BLD",6540,"QUES",0)
^9.62^^
"BLD",6540,"REQB",0)
^9.611^4^4
"BLD",6540,"REQB",1,0)
PSD*3.0*25^1
"BLD",6540,"REQB",2,0)
PSD*3.0*50^1
"BLD",6540,"REQB",3,0)
PSD*3.0*51^1
"BLD",6540,"REQB",4,0)
PSD*3.0*53^1
"BLD",6540,"REQB","B","PSD*3.0*25",1)

"BLD",6540,"REQB","B","PSD*3.0*50",2)

"BLD",6540,"REQB","B","PSD*3.0*51",3)

"BLD",6540,"REQB","B","PSD*3.0*53",4)

"MBREQ")
0
"PKG",499,-1)
1^1
"PKG",499,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",499,20,0)
^9.402P^^
"PKG",499,22,0)
^9.49I^1^1
"PKG",499,22,1,0)
3.0^2970213^2981028^66481
"PKG",499,22,1,"PAH",1,0)
60^3060705
"PKG",499,22,1,"PAH",1,1,0)
^^3^3^3060705
"PKG",499,22,1,"PAH",1,1,1,0)
This patch will correct the problem of an old greensheet being
"PKG",499,22,1,"PAH",1,1,2,0)
selected when a drug IEN is entered and it matches an old 
"PKG",499,22,1,"PAH",1,1,3,0)
pharmacy dispencing number.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSDRF")
0^1^B25117230^B21036728
"RTN","PSDRF",1,0)
PSDRF ;BIR/JPW,LTL - Nurse RF Dispensing ; 8 Aug 94
"RTN","PSDRF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**25,51,60**;13 Feb 97
"RTN","PSDRF",3,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRF",4,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRF",5,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRF",6,0)
 ;Reference to $$WITNESS^XUVERIFY are covered by DBIA #1513
"RTN","PSDRF",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRF",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRF",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRF",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRF",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRF",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRF",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRF",14,0)
 W !!,"Please enter the ward from which the drug(s) will be signed out."
"RTN","PSDRF",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRF",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRF",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRF",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRF",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRF",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRF",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRF",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRF",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRF",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRF",25,0)
PATIENT N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRF",26,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRF",27,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRF",28,0)
DRUG ;select drug
"RTN","PSDRF",29,0)
 N DIR,PSD,PSDR,PSDQ,WQTY,PSDDT
"RTN","PSDRF",30,0)
 S DIR(0)="FAO^1:40"
"RTN","PSDRF",31,0)
 S DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRF",32,0)
 W ! D ^DIR K DIR G:Y="" PATIENT G:$D(DIRUT) END
"RTN","PSDRF",33,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRF",34,0)
 I $O(^PSD(58.81,"D",Y,0)) D
"RTN","PSDRF",35,0)
 .S PSD=0
"RTN","PSDRF",36,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17
"RTN","PSDRF",37,0)
 I $D(PSDR),PSDR'=Y D
"RTN","PSDRF",38,0)
 .I $D(^PSDRUG(Y)),$D(^PSD(58.8,NAOU,1,Y)) D
"RTN","PSDRF",39,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRF",40,0)
 ..I PSDDT>365 S PSDR=Y
"RTN","PSDRF",41,0)
 .I '$D(^PSDRUG(Y)),$D(PSD(1)) D
"RTN","PSDRF",42,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRF",43,0)
 ..I PSDDT>365 K PSDR
"RTN","PSDRF",44,0)
 .I '$D(^PSDRUG(Y)),'$D(^PSD(58.8,NAOU,1,Y)),'$D(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRF",45,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRF",46,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRF",47,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! Q
"RTN","PSDRF",48,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRF",49,0)
 I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRF",50,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRF",51,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRF",52,0)
 W:'OQTY&$D(Y(0,0)) !,?12,Y(0,0)
"RTN","PSDRF",53,0)
 I 'OQTY,'$P($G(^PSD(58.81,+$G(PSD),9)),U) W !!,"Sorry, this drug has a zero balance." G DRUG
"RTN","PSDRF",54,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRF",55,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRF",56,0)
 S DIR(0)="Y",DIR("A")="Starting Balance:  "_OQTY_" "_$P(PSDR(1),U,8)_"     Correct count"
"RTN","PSDRF",57,0)
 S DIR("B")="Yes",NUR1=DUZ
"RTN","PSDRF",58,0)
 S DIR("?")="Answer Yes if the amount on hand equals the starting balance."
"RTN","PSDRF",59,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRF",60,0)
 I Y=0 D ^PSDRF2 G:$G(PSDOUT) END S $P(PSDR(1),U,4)=PSDQ(1),OQTY=PSDQ(1),PSDTYP=17
"RTN","PSDRF",61,0)
 G:'$G(PSDS) END
"RTN","PSDRF",62,0)
LIQ G:$P($G(^PSD(58.8,+PSDS,1,PSDR,7)),U) ^PSDRFL
"RTN","PSDRF",63,0)
QTY S DIR(0)="NA^.01:"_OQTY_":2",DIR("A")="Amount given: "
"RTN","PSDRF",64,0)
 S DIR("B")=1 W ! D ^DIR K DIR G:Y'>0 END S (PSDQ,OQTY)=Y
"RTN","PSDRF",65,0)
WASTE I PSDQ#1 D  G:$G(PSDOUT) END
"RTN","PSDRF",66,0)
 .W ?30,"Amount wasted: ",1-PSDQ#1,! S WQTY=1-PSDQ#1
"RTN","PSDRF",67,0)
 .W !,"You have sixty seconds to find a witness.",!
"RTN","PSDRF",68,0)
WIT .W:$G(NUR2(1)) !,"OK, sixty more seconds, but that's it.",!
"RTN","PSDRF",69,0)
 .S NUR2=$$WITNESS^XUVERIFY("WITNESS"),NUR2(1)=$G(NUR2(1))+1
"RTN","PSDRF",70,0)
 .I NUR2=DUZ W !!,"Wait a minute, you can't witness yourself!",$C(7) G WIT
"RTN","PSDRF",71,0)
 .G:NUR2'>0&(NUR2(1)<2) WIT I NUR2'>0 S PSDOUT=1 Q
"RTN","PSDRF",72,0)
 .W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U)) S PSDQ=PSDQ+(1-PSDQ#1)
"RTN","PSDRF",73,0)
 W !!,"Remaining Balance: ",$P(PSDR(1),U,4)-PSDQ," ",$P(PSDR(1),U,8)
"RTN","PSDRF",74,0)
 D UPDAT^PSDRF1 G DRUG
"RTN","PSDRF",75,0)
END W:$G(PSDOUT) !!,"No dose signed out.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1
"RTN","PSDRF",76,0)
 K NAOU,NAOUN,NBKU,NPKG,NUR2,OK,OKTYP,ORD,PAT,PSDA,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,REQD,TEXT,TYPE,WORD,X,Y
"RTN","PSDRF",77,0)
 Q
"RTN","PSDRF",78,0)
MSG ;display error message
"RTN","PSDRF",79,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRF",80,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRF",81,0)
 Q
"RTN","PSDRF4")
0^2^B21421420^B17429430
"RTN","PSDRF4",1,0)
PSDRF4 ;BIR/JPW,LTL-Nurse RF damaged dose ; 8 Aug 94
"RTN","PSDRF4",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**25,60**;13 Feb 97
"RTN","PSDRF4",3,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRF4",4,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRF4",5,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRF4",6,0)
 ;Reference to $$WITNESS^XUVERIFY are covered by DBIA #1513
"RTN","PSDRF4",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRF4",8,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRF4",9,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRF4",10,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRF4",11,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRF4",12,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G DRUG
"RTN","PSDRF4",13,0)
 W !!,"Please enter the ward from which the defective drug(s) will be destroyed."
"RTN","PSDRF4",14,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRF4",15,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRF4",16,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRF4",17,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRF4",18,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRF4",19,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRF4",20,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRF4",21,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRF4",22,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRF4",23,0)
DRUG ;select drug
"RTN","PSDRF4",24,0)
 N DIR,PSD,PSDR,PSDQ,PSDDT
"RTN","PSDRF4",25,0)
 S DIR(0)="FAO^1:40"
"RTN","PSDRF4",26,0)
 S DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRF4",27,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRF4",28,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRF4",29,0)
 I $O(^PSD(58.81,"D",Y,0)) D
"RTN","PSDRF4",30,0)
 .S PSD=0
"RTN","PSDRF4",31,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17
"RTN","PSDRF4",32,0)
 I $D(PSDR),PSDR'=Y  D
"RTN","PSDRF4",33,0)
 .I $D(^PSDRUG(Y)),$D(^PSD(58.8,NAOU,1,Y)) D
"RTN","PSDRF4",34,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRF4",35,0)
 ..I PSDDT>365 S PSDR=Y
"RTN","PSDRF4",36,0)
 .I '$D(^PSDRUG(Y)),$D(PSD(1))  D
"RTN","PSDRF4",37,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRF4",38,0)
 ..I PSDDT>365 K PSDR
"RTN","PSDRF4",39,0)
 .I '$D(^PSDRUG(Y)),'$D(^PSD(58.8,NAOU,1,Y)),'$D(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRF4",40,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 DRUG
"RTN","PSDRF4",41,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRF4",42,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! Q
"RTN","PSDRF4",43,0)
 .S PSDR=+Y,PSDTYP=9,PSDRE="DEFECTIVE DOSE"
"RTN","PSDRF4",44,0)
 I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRF4",45,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRF4",46,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRF4",47,0)
 I 'OQTY W !!,"Sorry, this drug has a zero balance." G DRUG
"RTN","PSDRF4",48,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRF4",49,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRF4",50,0)
 S DIR(0)="Y",DIR("A")="Starting Balance:  "_OQTY_" "_$P(PSDR(1),U,8)_"     Correct count"
"RTN","PSDRF4",51,0)
 S DIR("B")="Yes",NUR1=DUZ
"RTN","PSDRF4",52,0)
 S DIR("?")="Answer Yes if the amount on hand equals the starting balance."
"RTN","PSDRF4",53,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRF4",54,0)
 I Y=0 D ^PSDRF2 G:$G(PSDOUT) END S $P(PSDR(1),U,4)=PSDQ(1),OQTY=PSDQ(1),PSDTYP=17
"RTN","PSDRF4",55,0)
LIQ G:$P($G(^PSD(58.8,+PSDS,1,PSDR,7)),U) ^PSDRF5
"RTN","PSDRF4",56,0)
DEF W ! S DIR(0)="NA^.01:"_OQTY_":2",DIR("A")="Amount defective: "
"RTN","PSDRF4",57,0)
 S DIR("B")=1 D ^DIR K DIR G:$D(DIRUT) END S (PSDQ,WQTY)=Y
"RTN","PSDRF4",58,0)
WIT S NUR2=$$WITNESS^XUVERIFY("WITNESS")
"RTN","PSDRF4",59,0)
 I NUR2=DUZ W !!,"Wait a minute, you can't witness yourself!",$C(7) G WIT
"RTN","PSDRF4",60,0)
 I NUR2'>0 S PSDOUT=1 Q
"RTN","PSDRF4",61,0)
 W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U))
"RTN","PSDRF4",62,0)
 W !!,"Remaining Balance: ",$P(PSDR(1),U,4)-PSDQ," ",$P(PSDR(1),U,8)
"RTN","PSDRF4",63,0)
 D UPDAT^PSDRF1
"RTN","PSDRF4",64,0)
END W:$G(PSDOUT) !!,"No dose signed out.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1,NUR2,WQTY
"RTN","PSDRF4",65,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PSDA,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,PSDPN,PSDTYP,PSDRE,OQTY,REQD,TEXT,TYPE,WORD,NUR1,X,Y
"RTN","PSDRF4",66,0)
 Q
"RTN","PSDRF4",67,0)
MSG ;display error message
"RTN","PSDRF4",68,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRF4",69,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRF4",70,0)
 Q
"RTN","PSDRFR")
0^3^B28496304^B23996028
"RTN","PSDRFR",1,0)
PSDRFR ;BIR/JPW,LTL,BJW-Nurse RF Return to stock ; 11 May 98
"RTN","PSDRFR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**5,7,25,53,60**;13 Feb 97
"RTN","PSDRFR",3,0)
 ;modified to set variables psdret,psdar for return date
"RTN","PSDRFR",4,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRFR",5,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRFR",6,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRFR",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRFR",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRFR",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRFR",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRFR",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRFR",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRFR",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRFR",14,0)
 W !!,"Please enter the ward from which the drug(s) was signed out."
"RTN","PSDRFR",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRFR",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRFR",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRFR",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRFR",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRFR",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRFR",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRFR",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRFR",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRFR",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRFR",25,0)
PATIENT W !!,"Returns can only be recorded within "
"RTN","PSDRFR",26,0)
 S NAOU(1)=$S($P($G(^PSD(58.8,NAOU,6)),U,2):$P(^(6),U,2),1:12)
"RTN","PSDRFR",27,0)
 W NAOU(1)," hours after signing out a dose."
"RTN","PSDRFR",28,0)
 N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRFR",29,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRFR",30,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRFR",31,0)
DRUG ;select drug
"RTN","PSDRFR",32,0)
 N DIR,PSD,PSDR,PSDQ,PSDDT
"RTN","PSDRFR",33,0)
 S DIR(0)="FAO^1:40",DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRFR",34,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFR",35,0)
MM ;
"RTN","PSDRFR",36,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRFR",37,0)
 I $O(^PSD(58.81,"D",Y,0)) D
"RTN","PSDRFR",38,0)
 .S PSD=0
"RTN","PSDRFR",39,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17
"RTN","PSDRFR",40,0)
 I $D(PSDR),PSDR'=Y D
"RTN","PSDRFR",41,0)
 .I $D(^PSDRUG(Y)),$D(^PSD(58.8,NAOU,1,Y)) D
"RTN","PSDRFR",42,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRFR",43,0)
 ..I PSDDT>365 S PSDR=Y
"RTN","PSDRFR",44,0)
 .I '$D(^PSDRUG(Y)),$D(PSD(1)) D
"RTN","PSDRFR",45,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRFR",46,0)
 ..I PSDDT>365 K PSDR
"RTN","PSDRFR",47,0)
 .I '$D(^PSDRUG(Y)),'$D(^PSD(58.8,NAOU,1,Y)),'$D(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFR",48,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRFR",49,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRFR",50,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! Q
"RTN","PSDRFR",51,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRFR",52,0)
 I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFR",53,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRFR",54,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRFR",55,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRFR",56,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRFR",57,0)
 I '$G(PSDA(1)) W !!,"No doses signed out",!! G END
"RTN","PSDRFR",58,0)
 S OQTY=$P($G(^PSD(58.81,PSDA(1),0)),U,6)
"RTN","PSDRFR",59,0)
 I $$FMADD^XLFDT(PSDA(3),"",NAOU(1))<$$NOW^XLFDT W !!,"The last dose was signed out at ",PSDA(2),", over ",NAOU(1)," hours ago.",!!,"It is too late to return to stock.",!! G END
"RTN","PSDRFR",60,0)
 I PSDA(4)'=DUZ W !!,"Sorry, only the person who signed out the dose can return to stock.",!! G END
"RTN","PSDRFR",61,0)
 W !!,"Starting Balance:  "_$P(PSDR(1),U,4)_" "_$P(PSDR(1),U,8)
"RTN","PSDRFR",62,0)
QTY S DIR(0)="NA^0:"_OQTY_":2"
"RTN","PSDRFR",63,0)
 S DIR("A")="Amount actually given at "_PSDA(2)_": "
"RTN","PSDRFR",64,0)
 W ! D ^DIR K DIR I $D(DIRUT)!(Y=OQTY) S PSDOUT=1 G END
"RTN","PSDRFR",65,0)
 S PSDQ=Y
"RTN","PSDRFR",66,0)
 S PSDRET=$$FMADD^XLFDT($$NOW^XLFDT,0)
"RTN","PSDRFR",67,0)
 S PSDAR(1)=$$FMTE^XLFDT(PSDRET,"2P")
"RTN","PSDRFR",68,0)
WASTE I PSDQ'=OQTY D  G:$G(PSDOUT) END
"RTN","PSDRFR",69,0)
 .S:'$D(PSDAR(1)) PSDAR(1)=""
"RTN","PSDRFR",70,0)
 .I (OQTY-PSDQ)>1 D  Q:$G(PSDOUT)  G REA
"RTN","PSDRFR",71,0)
 ..S DIR(0)="N^1:"_(OQTY-PSDQ)_":2",DIR("A")="Amount returned at "_PSDAR(1)
"RTN","PSDRFR",72,0)
 ..S DIR("B")=OQTY-PSDQ D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFR",73,0)
 ..S WQTY=Y S:OQTY-WQTY PSDQ(1)=OQTY-WQTY
"RTN","PSDRFR",74,0)
 .S WQTY=$S('$G(PSDQ(2)):OQTY-PSDQ,1:OQTY-WQTY)
"RTN","PSDRFR",75,0)
 .W ?55,"Amount returned: ",WQTY,!
"RTN","PSDRFR",76,0)
REA .S DIR(0)="58.81,15",DIR("B")="Not given, returned to stock"
"RTN","PSDRFR",77,0)
 .D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFR",78,0)
 .S PSDRE(1)=Y
"RTN","PSDRFR",79,0)
 ;VMP OIFO BAY PINES;PSD*3.0*53;DISPLAY CORRECT BALANCE
"RTN","PSDRFR",80,0)
 N PSDRETQ
"RTN","PSDRFR",81,0)
 S PSDRETQ=WQTY,PSDQ=+$G(PSDQ(1))
"RTN","PSDRFR",82,0)
 D UPDATE^PSDRFX W !!,"Balance:  ",$P(PSDR(1),U,4)+PSDRETQ," ",$P(PSDR(1),U,8),!!
"RTN","PSDRFR",83,0)
 ;VMP OIFO BAY PINES;PSD*3.0*53;REMOVED CALL TO WASTE^PSDRFW
"RTN","PSDRFR",84,0)
END I $G(PSDQ(2)),$G(PSDOUT) S $P(^PSD(58.81,PSDA(1),0),U,6)=PSDQ
"RTN","PSDRFR",85,0)
 W:$G(PSDOUT) !!,"No return recorded.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1,PSDTYP
"RTN","PSDRFR",86,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PAT,PSDA,PSDAR,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRE,PSDRET,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,PSDPN,REQD,TEXT,TYPE,WQTY,OQTY,PSDQ,WORD,X,Y,PSDRETQ
"RTN","PSDRFR",87,0)
 Q
"RTN","PSDRFR",88,0)
MSG ;display error message
"RTN","PSDRFR",89,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRFR",90,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRFR",91,0)
 Q
"RTN","PSDRFS")
0^4^B27168731^B22721083
"RTN","PSDRFS",1,0)
PSDRFS ;BIR/JPW,LTL-Nurse RF Delayed Dispensing ;8 Aug 94
"RTN","PSDRFS",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**25,50,60**;13 Feb 97
"RTN","PSDRFS",3,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRFS",4,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRFS",5,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRFS",6,0)
 ;Reference to $$WITNESS^XUVERIFY are covered by DBIA #1513
"RTN","PSDRFS",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRFS",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRFS",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRFS",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRFS",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRFS",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRFS",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRFS",14,0)
 W !!,"Please enter the ward from which the drug(s) will be signed out."
"RTN","PSDRFS",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRFS",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRFS",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRFS",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRFS",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRFS",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRFS",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRFS",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRFS",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRFS",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRFS",25,0)
PATIENT N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRFS",26,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRFS",27,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRFS",28,0)
DRUG ;select drug
"RTN","PSDRFS",29,0)
 N DIR,PSD,PSDR,PSDQ,WQTY,PSDDT
"RTN","PSDRFS",30,0)
 S DIR(0)="FAO^1:40"
"RTN","PSDRFS",31,0)
 S DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRFS",32,0)
 W ! D ^DIR K DIR G:Y="" PATIENT G:$D(DIRUT) END
"RTN","PSDRFS",33,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRFS",34,0)
 I $O(^PSD(58.81,"D",Y,0)) D
"RTN","PSDRFS",35,0)
 .S PSD=0
"RTN","PSDRFS",36,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17
"RTN","PSDRFS",37,0)
 I $D(PSDR),PSDR'=Y D
"RTN","PSDRFS",38,0)
 .I $D(^PSDRUG(Y)),$D(^PSD(58.8,NAOU,1,Y)) D
"RTN","PSDRFS",39,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRFS",40,0)
 ..I PSDDT>365 S PSDR=Y
"RTN","PSDRFS",41,0)
 .I '$D(^PSDRUG(Y)),$D(PSD(1)) D
"RTN","PSDRFS",42,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRFS",43,0)
 ..I PSDDT>365 K PSDR
"RTN","PSDRFS",44,0)
 .I '$D(^PSDRUG(Y)),'$D(^PSD(58.8,NAOU,1,Y)),'$D(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFS",45,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRFS",46,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRFS",47,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! Q
"RTN","PSDRFS",48,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRFS",49,0)
 I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFS",50,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRFS",51,0)
 ;S DIC="^PSD(58.81,",DIC(0)="EMQSZ"
"RTN","PSDRFS",52,0)
 ;S DIC("S")="I $P(^(0),U,11)>3,$P(^(0),U,18)=NAOU"
"RTN","PSDRFS",53,0)
 ;W ! D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRFS",54,0)
 ;S PSDR=$P(Y(0),U,5),PSDPN=$P(Y(0),U,17),PSDTYP=17
"RTN","PSDRFS",55,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRFS",56,0)
 I 'OQTY,'$P($G(^PSD(58.81,+$G(PSD),9)),U) W !!,"Sorry, this drug has a zero balance." G DRUG
"RTN","PSDRFS",57,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRFS",58,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRFS",59,0)
 S DIR(0)="Y",DIR("A")="Starting Balance:  "_OQTY_" "_$P(PSDR(1),U,8)_"     Correct count"
"RTN","PSDRFS",60,0)
 S DIR("B")="Yes",NUR1=DUZ
"RTN","PSDRFS",61,0)
 S DIR("?")="Answer Yes if the amount on hand equals the starting balance."
"RTN","PSDRFS",62,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFS",63,0)
 I Y=0 D ^PSDRF2 G:$G(PSDOUT) END S $P(PSDR(1),U,4)=PSDQ(1),OQTY=PSDQ(1),PSDTYP=17
"RTN","PSDRFS",64,0)
LIQ G:$P($G(^PSD(58.8,+PSDS,1,PSDR,7)),U) ^PSDRFU
"RTN","PSDRFS",65,0)
QTY S DIR(0)="NA^.01:"_OQTY_":2",DIR("A")="Amount given: "
"RTN","PSDRFS",66,0)
 S DIR("B")=1 W ! D ^DIR K DIR G:Y'>0 END S (PSDQ,OQTY)=Y
"RTN","PSDRFS",67,0)
WASTE I PSDQ#1 D  G:$G(PSDOUT) END
"RTN","PSDRFS",68,0)
 .W ?30,"Amount wasted: ",1-PSDQ#1,! S WQTY=1-PSDQ#1
"RTN","PSDRFS",69,0)
WIT .S NUR2=$$WITNESS^XUVERIFY("WITNESS")
"RTN","PSDRFS",70,0)
 .I NUR2=DUZ W !!,"Wait a minute, you can't witness yourself!",$C(7) G WIT
"RTN","PSDRFS",71,0)
 .I NUR2'>0 S PSDOUT=1 Q
"RTN","PSDRFS",72,0)
 .W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U)) S PSDQ=PSDQ+(1-PSDQ#1)
"RTN","PSDRFS",73,0)
 S %DT="AEPRX",%DT(0)="-NOW",%DT("A")="Date/time given: "
"RTN","PSDRFS",74,0)
 W ! D ^%DT K %DT G:Y<1 END S PSDT=Y D ^PSDRFZ
"RTN","PSDRFS",75,0)
 ; PSD*3*50 RJS - MODIFY TO CHECK SIGN OUT NURSE AGAINST WITNESS
"RTN","PSDRFS",76,0)
ADMN S DIC="^VA(200,",DIC(0)="AEMQ",DIC("A")="Nurse that signed out dose: "
"RTN","PSDRFS",77,0)
 W ! D ^DIC K DIC G:Y<1 END S NUR1=+Y,NUR1(1)=DUZ
"RTN","PSDRFS",78,0)
 I $D(NUR2),NUR1=NUR2 W !,"Witness and Sign Out Nurse can not be the same person" G:NUR1=NUR2 ADMN
"RTN","PSDRFS",79,0)
 W !!,"Remaining Balance: ",$P(PSDR(1),U,4)-PSDQ," ",$P(PSDR(1),U,8)
"RTN","PSDRFS",80,0)
 D UPDAT^PSDRFT G DRUG
"RTN","PSDRFS",81,0)
END W:$G(PSDOUT) !!,"No dose signed out.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1,NUR2,WQTY
"RTN","PSDRFS",82,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PSDA,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,PSDPN,PSDTYP,OQTY,REQD,TEXT,TYPE,WORD,NUR1,X,Y
"RTN","PSDRFS",83,0)
 Q
"RTN","PSDRFS",84,0)
MSG ;display error message
"RTN","PSDRFS",85,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRFS",86,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRFS",87,0)
 Q
"RTN","PSDRFW")
0^5^B28360776^B23766867
"RTN","PSDRFW",1,0)
PSDRFW ;BIR/JPW,LTL-Nurse RF Dispensing ; 8 Aug 94
"RTN","PSDRFW",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**25,53,60**;13 Feb 97
"RTN","PSDRFW",3,0)
 ;Reference to $$WITNESS^XUVERIFY are covered by DBIA #1513
"RTN","PSDRFW",4,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRFW",5,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRFW",6,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRFW",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRFW",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRFW",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRFW",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRFW",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRFW",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRFW",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRFW",14,0)
 W !!,"Please enter the ward from which the drug(s) will be signed out."
"RTN","PSDRFW",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRFW",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRFW",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRFW",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRFW",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRFW",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRFW",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRFW",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRFW",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRFW",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRFW",25,0)
PATIENT W !!,"Wastage can only be recorded within "
"RTN","PSDRFW",26,0)
 S NAOU(1)=$S($P($G(^PSD(58.8,NAOU,6)),U,2):$P(^(6),U,2),1:12)
"RTN","PSDRFW",27,0)
 W NAOU(1)," hours after signing out a dose.",!!
"RTN","PSDRFW",28,0)
 W "(except for PCA syringes and Infusions)"
"RTN","PSDRFW",29,0)
 N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRFW",30,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRFW",31,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRFW",32,0)
DRUG ;select drug
"RTN","PSDRFW",33,0)
 N DIR,PSD,PSDA,PSDR,PSDQ,PSDDT
"RTN","PSDRFW",34,0)
 S DIR(0)="FAO^1:40",DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRFW",35,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFW",36,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRFW",37,0)
 I $O(^PSD(58.81,"D",Y,0)) D
"RTN","PSDRFW",38,0)
 .S PSD=0
"RTN","PSDRFW",39,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17
"RTN","PSDRFW",40,0)
 I $D(PSDR),PSDR'=Y D
"RTN","PSDRFW",41,0)
 .I $D(^PSDRUG(Y)),$D(^PSD(58.8,NAOU,1,Y)) D
"RTN","PSDRFW",42,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRFW",43,0)
 ..I PSDDT>365 S PSDR=Y
"RTN","PSDRFW",44,0)
 .I '$D(^PSDRUG(Y)),$D(PSD(1)) D
"RTN","PSDRFW",45,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRFW",46,0)
 ..I PSDDT>365 K PSDR
"RTN","PSDRFW",47,0)
 .I '$D(^PSDRUG(Y)),'$D(^PSD(58.8,NAOU,1,Y)),'$D(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFW",48,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRFW",49,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRFW",50,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! Q
"RTN","PSDRFW",51,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRFW",52,0)
 I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFW",53,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRFW",54,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRFW",55,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRFW",56,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRFW",57,0)
 I '$G(PSDA(1)) W !!,"No doses signed out",!! G END
"RTN","PSDRFW",58,0)
 S OQTY=$P($G(^PSD(58.81,PSDA(1),0)),U,6)
"RTN","PSDRFW",59,0)
 I $$FMADD^XLFDT(PSDA(3),"",NAOU(1))<$$NOW^XLFDT W !!,"The last dose was signed out at ",PSDA(2),", over ",NAOU(1)," hours ago.",!!,"It is too late to record wastage.",!! G END
"RTN","PSDRFW",60,0)
 I PSDA(4)'=DUZ W !!,"Sorry, only the person that signed out the dose can record delayed wastage.",!! G END
"RTN","PSDRFW",61,0)
 ;S DIR(0)="Y",DIR("A")="Starting Balance:  "_OQTY_" "_$P(PSDR(1),U,8)_"     Correct count"
"RTN","PSDRFW",62,0)
 ;S DIR("B")="Yes",NUR1=DUZ
"RTN","PSDRFW",63,0)
 ;S DIR("?")="Answer Yes if the amount on hand equals the starting balance."
"RTN","PSDRFW",64,0)
 ;W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFW",65,0)
 ;I Y=0 D ^PSDRF2 G:$G(PSDOUT) END S $P(PSDR(1),U,4)=PSDQ(1),OQTY=PSDQ(1)
"RTN","PSDRFW",66,0)
QTY S DIR(0)="NA^0:"_OQTY_":2"
"RTN","PSDRFW",67,0)
 S DIR("A")="Amount actually given at "_PSDA(2)_": "
"RTN","PSDRFW",68,0)
 W ! D ^DIR K DIR I $D(DIRUT)!(Y=OQTY) S PSDOUT=1 G END
"RTN","PSDRFW",69,0)
 S PSDQ=Y
"RTN","PSDRFW",70,0)
WASTE I PSDQ'=OQTY D  G:$G(PSDOUT) END
"RTN","PSDRFW",71,0)
 .I (OQTY-PSDQ)>1 D  Q:$G(PSDOUT)  G REA
"RTN","PSDRFW",72,0)
 ..S DIR(0)="N^1:"_(OQTY-PSDQ)_":2",DIR("A")="Amount wasted"
"RTN","PSDRFW",73,0)
 ..S DIR("B")=OQTY-PSDQ D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFW",74,0)
 ..S WQTY=Y S:OQTY-WQTY PSDQ(2)=OQTY-WQTY
"RTN","PSDRFW",75,0)
 .S WQTY=$S('$G(PSDQ(1)):OQTY-PSDQ,1:PSDQ)
"RTN","PSDRFW",76,0)
 .W ?55,"Amount wasted: ",WQTY,!
"RTN","PSDRFW",77,0)
REA .S DIR(0)="58.81,15" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFW",78,0)
 .S PSDRE=Y
"RTN","PSDRFW",79,0)
WIT .W ! S NUR2=$$WITNESS^XUVERIFY("WITNESS")
"RTN","PSDRFW",80,0)
 .I NUR2=DUZ W !!,"Wait a minute, you can't witness yourself!",$C(7) G WIT
"RTN","PSDRFW",81,0)
 .I NUR2'>0 S PSDOUT=1 Q
"RTN","PSDRFW",82,0)
 .W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U))
"RTN","PSDRFW",83,0)
 ;VMP OIFO BAY PINES;VGF;PSD*3.0*53;REMOVED CALL TO WASTE^PSDRFR
"RTN","PSDRFW",84,0)
 D EDIT^PSDRFX
"RTN","PSDRFW",85,0)
END I $G(PSDQ(1)),$G(PSDOUT) S $P(^PSD(58.81,PSDA(1),0),U,6)=PSDQ
"RTN","PSDRFW",86,0)
 W:$G(PSDOUT) !!,"No wastage recorded.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1,PSDTYP,NUR2
"RTN","PSDRFW",87,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PAT,PSDA,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRE,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,PSDPN,REQD,TEXT,TYPE,WQTY,OQTY,PSDQ,WORD,NUR1,X,Y
"RTN","PSDRFW",88,0)
 Q
"RTN","PSDRFW",89,0)
MSG ;display error message
"RTN","PSDRFW",90,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRFW",91,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRFW",92,0)
 Q
"VER")
8.0^22.0
"BLD",6540,6)
^50
**END**
**END**
