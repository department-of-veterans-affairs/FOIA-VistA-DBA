Released MPIF*1*1 SEQ #1
Extracted from mail message
**KIDS**:MPIF*1.0*1^

**INSTALL NAME**
MPIF*1.0*1
"BLD",1093,0)
MPIF*1.0*1^MASTER PATIENT INDEX VISTA^0^3000323^y
"BLD",1093,1,0)
^^1^1^2990604^
"BLD",1093,1,1,0)
See Patch Module for patch description.
"BLD",1093,4,0)
^9.64PA^^
"BLD",1093,"ABNS",0)
^9.66A^^
"BLD",1093,"ABPKG")
y^y^G.CIRN DEV@FORUM.VA.GOV
"BLD",1093,"INIT")
MPIFPST1
"BLD",1093,"KRN",0)
^9.67PA^19^18
"BLD",1093,"KRN",.4,0)
.4
"BLD",1093,"KRN",.401,0)
.401
"BLD",1093,"KRN",.402,0)
.402
"BLD",1093,"KRN",.403,0)
.403
"BLD",1093,"KRN",.5,0)
.5
"BLD",1093,"KRN",.84,0)
.84
"BLD",1093,"KRN",3.6,0)
3.6
"BLD",1093,"KRN",3.6,"NM",0)
^9.68A^1^1
"BLD",1093,"KRN",3.6,"NM",1,0)
MPIF CMOR COMPARE COMPLETE^^0
"BLD",1093,"KRN",3.6,"NM","B","MPIF CMOR COMPARE COMPLETE",1)

"BLD",1093,"KRN",3.8,0)
3.8
"BLD",1093,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",1093,"KRN",3.8,"NM",1,0)
MPIF EXCEPTIONS^^0
"BLD",1093,"KRN",3.8,"NM","B","MPIF EXCEPTIONS",1)

"BLD",1093,"KRN",9.2,0)
9.2
"BLD",1093,"KRN",9.8,0)
9.8
"BLD",1093,"KRN",9.8,"NM",0)
^9.68A^19^19
"BLD",1093,"KRN",9.8,"NM",1,0)
MPIF001^^0^B38634936
"BLD",1093,"KRN",9.8,"NM",2,0)
MPIFQ0^^0^B73182661
"BLD",1093,"KRN",9.8,"NM",3,0)
MPIFRES^^0^B8842645
"BLD",1093,"KRN",9.8,"NM",4,0)
MPIFAPI^^0^B10172747
"BLD",1093,"KRN",9.8,"NM",5,0)
MPIFRTC^^0^B5585592
"BLD",1093,"KRN",9.8,"NM",6,0)
MPIFBT2^^0^B41055656
"BLD",1093,"KRN",9.8,"NM",7,0)
MPIFQUE4^^0^B48055957
"BLD",1093,"KRN",9.8,"NM",8,0)
MPIFBT3^^0^B21232774
"BLD",1093,"KRN",9.8,"NM",9,0)
MPIFQUE3^^0^B51410453
"BLD",1093,"KRN",9.8,"NM",10,0)
MPIFCMOR^^0^B6338689
"BLD",1093,"KRN",9.8,"NM",11,0)
MPIFREQ^^0^B15813923
"BLD",1093,"KRN",9.8,"NM",12,0)
MPIFRESS^^0^B11094085
"BLD",1093,"KRN",9.8,"NM",13,0)
MPIFSAQ^^0^B69662567
"BLD",1093,"KRN",9.8,"NM",14,0)
MPIFQ1^^0^B31816969
"BLD",1093,"KRN",9.8,"NM",15,0)
MPIFA31I^^0^B20785590
"BLD",1093,"KRN",9.8,"NM",16,0)
MPIFQUE5^^0^B8627708
"BLD",1093,"KRN",9.8,"NM",17,0)
MPIFDEL^^0^B7732205
"BLD",1093,"KRN",9.8,"NM",18,0)
MPIFVTQ^^0^B40474289
"BLD",1093,"KRN",9.8,"NM",19,0)
MPIFHL7^^0^B3214414
"BLD",1093,"KRN",9.8,"NM","B","MPIF001",1)
 
"BLD",1093,"KRN",9.8,"NM","B","MPIFA31I",15)

"BLD",1093,"KRN",9.8,"NM","B","MPIFAPI",4)
 
"BLD",1093,"KRN",9.8,"NM","B","MPIFBT2",6)

"BLD",1093,"KRN",9.8,"NM","B","MPIFBT3",8)

"BLD",1093,"KRN",9.8,"NM","B","MPIFCMOR",10)

"BLD",1093,"KRN",9.8,"NM","B","MPIFDEL",17)

"BLD",1093,"KRN",9.8,"NM","B","MPIFHL7",19)

"BLD",1093,"KRN",9.8,"NM","B","MPIFQ0",2)
 
"BLD",1093,"KRN",9.8,"NM","B","MPIFQ1",14)

"BLD",1093,"KRN",9.8,"NM","B","MPIFQUE3",9)

"BLD",1093,"KRN",9.8,"NM","B","MPIFQUE4",7)

"BLD",1093,"KRN",9.8,"NM","B","MPIFQUE5",16)

"BLD",1093,"KRN",9.8,"NM","B","MPIFREQ",11)

"BLD",1093,"KRN",9.8,"NM","B","MPIFRES",3)
 
"BLD",1093,"KRN",9.8,"NM","B","MPIFRESS",12)

"BLD",1093,"KRN",9.8,"NM","B","MPIFRTC",5)

"BLD",1093,"KRN",9.8,"NM","B","MPIFSAQ",13)

"BLD",1093,"KRN",9.8,"NM","B","MPIFVTQ",18)

"BLD",1093,"KRN",19,0)
19
"BLD",1093,"KRN",19,"NM",0)
^9.68A^^
"BLD",1093,"KRN",19.1,0)
19.1
"BLD",1093,"KRN",101,0)
101
"BLD",1093,"KRN",409.61,0)
409.61
"BLD",1093,"KRN",771,0)
771
"BLD",1093,"KRN",869.2,0)
869.2
"BLD",1093,"KRN",870,0)
870
"BLD",1093,"KRN",8994,0)
8994
"BLD",1093,"KRN","B",.4,.4)
 
"BLD",1093,"KRN","B",.401,.401)
 
"BLD",1093,"KRN","B",.402,.402)
 
"BLD",1093,"KRN","B",.403,.403)
 
"BLD",1093,"KRN","B",.5,.5)
 
"BLD",1093,"KRN","B",.84,.84)
 
"BLD",1093,"KRN","B",3.6,3.6)
 
"BLD",1093,"KRN","B",3.8,3.8)
 
"BLD",1093,"KRN","B",9.2,9.2)
 
"BLD",1093,"KRN","B",9.8,9.8)
 
"BLD",1093,"KRN","B",19,19)
 
"BLD",1093,"KRN","B",19.1,19.1)
 
"BLD",1093,"KRN","B",101,101)
 
"BLD",1093,"KRN","B",409.61,409.61)
 
"BLD",1093,"KRN","B",771,771)
 
"BLD",1093,"KRN","B",869.2,869.2)
 
"BLD",1093,"KRN","B",870,870)
 
"BLD",1093,"KRN","B",8994,8994)
 
"BLD",1093,"QUES",0)
^9.62^^
"BLD",1093,"REQB",0)
^9.611^2^2
"BLD",1093,"REQB",1,0)
MASTER PATIENT INDEX VISTA 1.0^1
"BLD",1093,"REQB",2,0)
RG*1.0*1^1
"BLD",1093,"REQB","B","MASTER PATIENT INDEX VISTA 1.0",1)
 
"BLD",1093,"REQB","B","RG*1.0*1",2)

"INIT")
MPIFPST1
"KRN",3.6,168,-1)
0^1
"KRN",3.6,168,0)
MPIF CMOR COMPARE COMPLETE^CMOR COMPARE MSG COMPLETED
"KRN",3.6,168,1,0)
^^1^1^3000228^
"KRN",3.6,168,1,1,0)
CMOR Compare Message Processed.
"KRN",3.6,168,3,0)
^3.63^4^4^3000228^^^^
"KRN",3.6,168,3,1,0)
This bulletin is to alert the install team that the CMOR compare message
"KRN",3.6,168,3,2,0)
has been processed on the CMOR site and that X patients had their CMOR
"KRN",3.6,168,3,3,0)
changed.  This will assist the team in knowing that these messages have
"KRN",3.6,168,3,4,0)
been processed and how many where changed.
"KRN",3.6,168,4,0)
^3.64A^^0
"KRN",3.8,159,-1)
0^1
"KRN",3.8,159,0)
MPIF EXCEPTIONS^PU^^^^0^
"KRN",3.8,159,2,0)
^3.801^7^7^3000301^^
"KRN",3.8,159,2,1,0)
MPI Exception Messages to be addressed.  These messages are all technical
"KRN",3.8,159,2,2,0)
in nature, involving problems with HL7 messages or ones that a NOIS would
"KRN",3.8,159,2,3,0)
be required to be logged.  Since these all require NOISes to be logged, a
"KRN",3.8,159,2,4,0)
remote mail group has been added G.CIRN EXCEPTION MGT@FORUM.VA.GOV.  A
"KRN",3.8,159,2,5,0)
NOIS will be logged once these messages are received by the mail group.
"KRN",3.8,159,2,6,0)
The site does not need to have any local members, but can choose to if
"KRN",3.8,159,2,7,0)
desired.
"KRN",3.8,159,3)

"KRN",3.8,159,6,0)
^3.812^1^1
"KRN",3.8,159,6,1,0)
G.CIRN EXCEPTION MGT@FORUM.VA.GOV
"KRN",3.8,159,6,"B","G.CIRN EXCEPTION MGT@FORUM.VA.",1)

"MBREQ")
0
"ORD",2,3.6)
3.6;2;1;;BUL^XPDTA1;;BULE1^XPDIA1;;;BULDEL^XPDIA1
"ORD",2,3.6,0)
BULLETIN
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1
"ORD",11,3.8,0)
MAIL GROUP
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
1^3000323^9139
"PKG",474,22,1,"PAH",1,1,0)
^^1^1^3000323
"PKG",474,22,1,"PAH",1,1,1,0)
See Patch Module for patch description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
20
"RTN","MPIF001")
0^1^B38634936
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS-UTILITY ROUTINE TO SUPPORT VCCI STUFF ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIF001",3,0)
GETICN(DFN) ;
"RTN","MPIF001",4,0)
 ; This function returns the ICN, including checksum for a given DFN
"RTN","MPIF001",5,0)
 ; or -1^error message
"RTN","MPIF001",6,0)
 ; DFN - ien in Patient file
"RTN","MPIF001",7,0)
 ;
"RTN","MPIF001",8,0)
 N RETURN,NODE
"RTN","MPIF001",9,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",10,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",11,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",12,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",13,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",14,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",15,0)
EXIT1 ;
"RTN","MPIF001",16,0)
 Q RETURN
"RTN","MPIF001",17,0)
 ;
"RTN","MPIF001",18,0)
GETDFN(ICN) ;
"RTN","MPIF001",19,0)
 ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",20,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",21,0)
 N RETURN,DFN
"RTN","MPIF001",22,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",23,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",24,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",25,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",26,0)
 S RETURN=DFN
"RTN","MPIF001",27,0)
EXIT2 ;
"RTN","MPIF001",28,0)
 Q RETURN
"RTN","MPIF001",29,0)
 ;
"RTN","MPIF001",30,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",31,0)
 ; a Local ICN and updating the appropriate fileds if a Local was created
"RTN","MPIF001",32,0)
 ; DFN= Patient IEN
"RTN","MPIF001",33,0)
 ; Returns ICN (local or National including checksum)
"RTN","MPIF001",34,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",35,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",36,0)
 I '$D(ICN) S ICN=$$GETICN(DFN)
"RTN","MPIF001",37,0)
 I +ICN=-1 D
"RTN","MPIF001",38,0)
 .;no icn create a Local ICN
"RTN","MPIF001",39,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",40,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",41,0)
 .S NOLOCK=""
"RTN","MPIF001",42,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",43,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",44,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",45,0)
 .K NOLOCK
"RTN","MPIF001",46,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",47,0)
 Q ICN
"RTN","MPIF001",48,0)
 ;
"RTN","MPIF001",49,0)
CMOR2(DFN) ;
"RTN","MPIF001",50,0)
 ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",51,0)
 ; DFN = Patient IEN
"RTN","MPIF001",52,0)
 N NODE
"RTN","MPIF001",53,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",54,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",55,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",56,0)
 ;
"RTN","MPIF001",57,0)
CMORNAME(CIEN) ;
"RTN","MPIF001",58,0)
 ; Returns CMOR site name or -1^error message
"RTN","MPIF001",59,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",60,0)
 ;
"RTN","MPIF001",61,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",62,0)
 N INST
"RTN","MPIF001",63,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",64,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",65,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",66,0)
 Q $P(INST,"^")
"RTN","MPIF001",67,0)
 ;
"RTN","MPIF001",68,0)
GETVCCI(DFN) ;
"RTN","MPIF001",69,0)
 ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",70,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",71,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",72,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",73,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",74,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",75,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",76,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",77,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",78,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",79,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",80,0)
 S RETURN=STANUM
"RTN","MPIF001",81,0)
EXIT3 ;
"RTN","MPIF001",82,0)
 Q RETURN
"RTN","MPIF001",83,0)
 ;
"RTN","MPIF001",84,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",85,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",86,0)
 ;
"RTN","MPIF001",87,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",88,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",89,0)
 ; VCCI = CMOR ien from the institution file or CMOR site name
"RTN","MPIF001",90,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",91,0)
 ;             1 - successful
"RTN","MPIF001",92,0)
 N RETURN,DIQUIET,DIE,DA,DR,IEN,Y,X,DIC
"RTN","MPIF001",93,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",94,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",95,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",96,0)
 I $G(VCCI)="" S RETURN="-1^NO CMOR PASSED" G EXIT4
"RTN","MPIF001",97,0)
 I VCCI'?.N S IEN=$$LKUP^XUAF4(VCCI)
"RTN","MPIF001",98,0)
 ; ^ passed name, get ien from Institution file
"RTN","MPIF001",99,0)
 I $G(IEN)=0 S RETURN="-1^NO INSTITUTION BY THAT NAME" G EXIT4
"RTN","MPIF001",100,0)
 I $D(IEN) S VCCI=IEN
"RTN","MPIF001",101,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",102,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",103,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",104,0)
 S DIQUIET=1
"RTN","MPIF001",105,0)
 S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",106,0)
 D ^DIE
"RTN","MPIF001",107,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",108,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",109,0)
EXIT4 ;
"RTN","MPIF001",110,0)
 Q RETURN
"RTN","MPIF001",111,0)
 ;
"RTN","MPIF001",112,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",113,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",114,0)
 ;
"RTN","MPIF001",115,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",116,0)
 ; file for a given patient.
"RTN","MPIF001",117,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",118,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",119,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",120,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",121,0)
 ;          1 - successful
"RTN","MPIF001",122,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y
"RTN","MPIF001",123,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",124,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",125,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",126,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",127,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",128,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",129,0)
 .N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",130,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIF001",131,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",132,0)
 .S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",133,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",134,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",135,0)
 S DIQUIET=1
"RTN","MPIF001",136,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",137,0)
 D ^DIE
"RTN","MPIF001",138,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",139,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN) I $$IFLOCAL(DFN) N ERR S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",140,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",141,0)
EXIT5 ;
"RTN","MPIF001",142,0)
 Q RETURN
"RTN","MPIF001",143,0)
 ;
"RTN","MPIF001",144,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",145,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",146,0)
 ;
"RTN","MPIF001",147,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",148,0)
 ; for the given patient
"RTN","MPIF001",149,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",150,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",151,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",152,0)
 ;
"RTN","MPIF001",153,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",154,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",155,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",156,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",157,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",158,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",159,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",160,0)
 D ^DIE
"RTN","MPIF001",161,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",162,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",163,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",164,0)
EXIT6 ;
"RTN","MPIF001",165,0)
 Q RETURN
"RTN","MPIF001",166,0)
 ;
"RTN","MPIF001",167,0)
IFLOCAL(DFN) ;
"RTN","MPIF001",168,0)
 ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",169,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",170,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",171,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",172,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",173,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",174,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",175,0)
 Q:$P($G(^DPT(DFN,"MPI")),"^",4)=1 1
"RTN","MPIF001",176,0)
 Q 0
"RTN","MPIF001",177,0)
 ;
"RTN","MPIF001",178,0)
IFVCCI(DFN) ;
"RTN","MPIF001",179,0)
 ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",180,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",181,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",182,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",183,0)
 N VCCI,SITE
"RTN","MPIF001",184,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",185,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",186,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",187,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",188,0)
 Q 1
"RTN","MPIF001",189,0)
 ;
"RTN","MPIF001",190,0)
HL7CMOR(DFN,SEP) ;
"RTN","MPIF001",191,0)
 ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",192,0)
 ; the given patient.
"RTN","MPIF001",193,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",194,0)
 ; SEP = delimeter to separate station number and name
"RTN","MPIF001",195,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",196,0)
 ;            -1^error message
"RTN","MPIF001",197,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",198,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",199,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",200,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",201,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",202,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",203,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",204,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",205,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",206,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",207,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",208,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",209,0)
EXIT7 ;
"RTN","MPIF001",210,0)
 Q RETURN
"RTN","MPIF001",211,0)
 ;
"RTN","MPIF001",212,0)
LOCK ;
"RTN","MPIF001",213,0)
 L +^DPT(DFN,"MPI"):10 I '$T G LOCK
"RTN","MPIF001",214,0)
 Q
"RTN","MPIF001",215,0)
 ;
"RTN","MPIF001",216,0)
UNLOCK ;
"RTN","MPIF001",217,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",218,0)
 Q
"RTN","MPIFA31I")
0^15^B20785590
"RTN","MPIFA31I",1,0)
MPIFA31I ;ALB/JRP-PROCESS ADT-A31 MESSAGE FROM MPI ;03-JAN-97
"RTN","MPIFA31I",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFA31I",3,0)
 ;
"RTN","MPIFA31I",4,0)
PROCESS(MSGARR) ;Process ADT-A31 message received from MPI when a new
"RTN","MPIFA31I",5,0)
 ; patient is assigned an Integration Control Number
"RTN","MPIFA31I",6,0)
 ;
"RTN","MPIFA31I",7,0)
 ;Input  : MSGARR - Array containing ADT-A31 message (full global ref)
"RTN","MPIFA31I",8,0)
 ;                - MSGARR must be in format compatible with interaction
"RTN","MPIFA31I",9,0)
 ;                  with DHCP HL7 package
"RTN","MPIFA31I",10,0)
 ;                    MSGARR(1) = First segment of message
"RTN","MPIFA31I",11,0)
 ;                    MSGARR(1,n) = Continuation node(s) for segment
"RTN","MPIFA31I",12,0)
 ;                    MSGARR(x) = Xth segment of message
"RTN","MPIFA31I",13,0)
 ;                    MSGARR(x,n) = Continuation node(s) for segment
"RTN","MPIFA31I",14,0)
 ;                - Defaults to ^TMP("MPIFA31",$J,"MPI-ADT-A31")
"RTN","MPIFA31I",15,0)
 ;Output : ICN = Successfully processed
"RTN","MPIFA31I",16,0)
 ;        -1^Reason = Failure
"RTN","MPIFA31I",17,0)
 ;Notes  : The MPI uses an ADT-A31 message to return the ICN of new
"RTN","MPIFA31I",18,0)
 ;         patients.  This value (seq # 2 of PID segment) is the only
"RTN","MPIFA31I",19,0)
 ;         information that will be stored.
"RTN","MPIFA31I",20,0)
 ;
"RTN","MPIFA31I",21,0)
 ;Check input
"RTN","MPIFA31I",22,0)
 S MSGARR=$G(MSGARR)
"RTN","MPIFA31I",23,0)
 S:(MSGARR="") MSGARR="^TMP(""MPIFA31"","_$J_",""MPI-ADT-A31"")"
"RTN","MPIFA31I",24,0)
 Q:(('$D(@MSGARR))!('$O(@MSGARR@(0)))) "-1^Array containing ADT-A31 message not valid"
"RTN","MPIFA31I",25,0)
 ;Declare variables
"RTN","MPIFA31I",26,0)
 N MSH,EVN,PID,SEND,RECEIVE,EVENT,REASON,SEGMENT,SEGNAME
"RTN","MPIFA31I",27,0)
 N ICN,ICNNUM,ICNCHECK,DFNCHECK,CHKSCHM,SSN,LOCAL,TMP,FLDSEP,HLECH
"RTN","MPIFA31I",28,0)
 N CMPSEP,REPSEP,ESC,SUBSEP,TMP1,TMP2
"RTN","MPIFA31I",29,0)
 ;Parse required segments out of message
"RTN","MPIFA31I",30,0)
 S (MSH,EVN,PID)=""
"RTN","MPIFA31I",31,0)
 S TMP=0
"RTN","MPIFA31I",32,0)
 F  S TMP=+$O(@MSGARR@(TMP)) Q:('TMP)  D
"RTN","MPIFA31I",33,0)
 .;Get segment and screen out unused segments
"RTN","MPIFA31I",34,0)
 .S SEGMENT=$G(@MSGARR@(TMP))
"RTN","MPIFA31I",35,0)
 .S SEGNAME=$E(SEGMENT,1,3)
"RTN","MPIFA31I",36,0)
 .S TMP1=","_SEGNAME_","
"RTN","MPIFA31I",37,0)
 .Q:('(",MSH,EVN,PID,"[TMP1))
"RTN","MPIFA31I",38,0)
 .;Use first occurrance of segment
"RTN","MPIFA31I",39,0)
 .Q:(@SEGNAME'="")
"RTN","MPIFA31I",40,0)
 .;Remember field separator if MSH segment
"RTN","MPIFA31I",41,0)
 .S:(SEGNAME="MSH") FLDSEP=$E(SEGMENT,4)
"RTN","MPIFA31I",42,0)
 .;Drop segment name and field separator for storage
"RTN","MPIFA31I",43,0)
 .S @SEGNAME=$E(SEGMENT,5,$L(SEGMENT))
"RTN","MPIFA31I",44,0)
 .;Account for rollover (begin rollover subscripting with 1)
"RTN","MPIFA31I",45,0)
 .S TMP1=0
"RTN","MPIFA31I",46,0)
 .S TMP2=1
"RTN","MPIFA31I",47,0)
 .F  S TMP1=+$O(@MSGARR@(TMP,TMP1)) Q:('TMP1)  D
"RTN","MPIFA31I",48,0)
 ..;Get/save rollover
"RTN","MPIFA31I",49,0)
 ..S @SEGNAME@(TMP2)=$G(@MSGARR@(TMP,TMP1))
"RTN","MPIFA31I",50,0)
 ..S TMP2=TMP2+1
"RTN","MPIFA31I",51,0)
 ;Make sure used segments were all found
"RTN","MPIFA31I",52,0)
 F SEGNAME="MSH","EVN","PID" Q:(@SEGNAME="")
"RTN","MPIFA31I",53,0)
 Q:(@SEGNAME="") "-1^Required segment ("_SEGNAME_") missing"
"RTN","MPIFA31I",54,0)
 ;Safety check on field separator (use DHCP default value)
"RTN","MPIFA31I",55,0)
 S:($G(FLDSEP)="") FLDSEP="^"
"RTN","MPIFA31I",56,0)
 ;Get encoding characters
"RTN","MPIFA31I",57,0)
 S HLECH=$P(MSH,FLDSEP,1)
"RTN","MPIFA31I",58,0)
 ;Component separator
"RTN","MPIFA31I",59,0)
 S CMPSEP=$E(HLECH,1)
"RTN","MPIFA31I",60,0)
 ;Repetion separator
"RTN","MPIFA31I",61,0)
 S REPSEP=$E(HLECH,2)
"RTN","MPIFA31I",62,0)
 ;Escape character
"RTN","MPIFA31I",63,0)
 S ESC=$E(HLECH,3)
"RTN","MPIFA31I",64,0)
 ;Subcomponent separator
"RTN","MPIFA31I",65,0)
 S SUBSEP=$E(HLECH,4)
"RTN","MPIFA31I",66,0)
 ;Process MSH segment
"RTN","MPIFA31I",67,0)
 ; - Get sending facility
"RTN","MPIFA31I",68,0)
 S SEND=$P(MSH,FLDSEP,3)
"RTN","MPIFA31I",69,0)
 ; - Get receiving facility
"RTN","MPIFA31I",70,0)
 S RECEIVE=$P(MSH,FLDSEP,5)
"RTN","MPIFA31I",71,0)
 ; - Get event type
"RTN","MPIFA31I",72,0)
 S EVENT=$P($P(MSH,FLDSEP,8),CMPSEP,2)
"RTN","MPIFA31I",73,0)
 ; - Validate information in MSH segment
"RTN","MPIFA31I",74,0)
 ;   - MPI is sending facility
"RTN","MPIFA31I",75,0)
 ;Q:(SEND'="200M") "-1^Sending facility not valid (must be '200M')"
"RTN","MPIFA31I",76,0)
 ;   - Receiving facility is local facility
"RTN","MPIFA31I",77,0)
 S TMP=+$P($$SITE^VASITE(),"^",3)
"RTN","MPIFA31I",78,0)
 Q:(RECEIVE'=TMP) "-1^Receiving facility not valid (must be "_TMP_")"
"RTN","MPIFA31I",79,0)
 ;   - Event type is A31
"RTN","MPIFA31I",80,0)
 Q:(EVENT'="A31") "-1^Event type not valid (must be 'A31')"
"RTN","MPIFA31I",81,0)
 ;Process EVN segment
"RTN","MPIFA31I",82,0)
 ; - Get event reason
"RTN","MPIFA31I",83,0)
 S REASON=$P(EVN,FLDSEP,4)
"RTN","MPIFA31I",84,0)
 ; - Validate information in EVN segment
"RTN","MPIFA31I",85,0)
 ;   - Event reason is 95
"RTN","MPIFA31I",86,0)
 Q:(REASON'="95") "-1^Event reason code not valid (must be '95')"
"RTN","MPIFA31I",87,0)
 ;Process PID segment
"RTN","MPIFA31I",88,0)
 ; - Get ICN & checksum & checksum scheme
"RTN","MPIFA31I",89,0)
 S TMP=$P(PID,FLDSEP,2)
"RTN","MPIFA31I",90,0)
 S ICN=$P(TMP,CMPSEP,1)
"RTN","MPIFA31I",91,0)
 Q:(ICN'?1.16N1"V"6N) "-1^ICN not in correct format"
"RTN","MPIFA31I",92,0)
 S ICNNUM=$P(ICN,"V",1)
"RTN","MPIFA31I",93,0)
 S ICNCHECK=$P(TMP,"V",2)
"RTN","MPIFA31I",94,0)
 Q:((ICNNUM="")!(ICNCHECK="")) "-1^Could not determine ICN"
"RTN","MPIFA31I",95,0)
 ; - Validate checksum
"RTN","MPIFA31I",96,0)
 Q:(ICNCHECK'=$$CHECKDG^MPIFSPC(ICNNUM)) "-1^ICN/checksum not valid"
"RTN","MPIFA31I",97,0)
 ; - Get DFN & checksum & checksum scheme
"RTN","MPIFA31I",98,0)
 S TMP=$P(PID,FLDSEP,3)
"RTN","MPIFA31I",99,0)
 ; - Get SSN (account for roll over)
"RTN","MPIFA31I",100,0)
 S SSN=""
"RTN","MPIFA31I",101,0)
 S TMP=$L(PID,FLDSEP)
"RTN","MPIFA31I",102,0)
 S TMP1=$P(PID,FLDSEP,TMP)
"RTN","MPIFA31I",103,0)
 S:(TMP=19) SSN=$P(PID,FLDSEP,19)_$P($G(PID(1)),FLDSEP,1)
"RTN","MPIFA31I",104,0)
 S:(TMP>19) SSN=$P(PID,FLDSEP,19)
"RTN","MPIFA31I",105,0)
 S:(TMP<19) SSN=$P($G(PID(1)),FLDSEP,((19-TMP)+1))
"RTN","MPIFA31I",106,0)
 ; - Validate information in PID
"RTN","MPIFA31I",107,0)
 ;   - Make sure DFN exists
"RTN","MPIFA31I",108,0)
 S LOCAL=$G(^DPT(DFN,0))
"RTN","MPIFA31I",109,0)
 Q:($P(LOCAL,"^",1)="") "-1^Could not locate patient (bad DFN)"
"RTN","MPIFA31I",110,0)
 ;   - Make sure SSNs match
"RTN","MPIFA31I",111,0)
 Q:($P(LOCAL,"^",9)'=SSN) "-1^DFN/SSN pairing not valid"
"RTN","MPIFA31I",112,0)
 ;Extra validation checks
"RTN","MPIFA31I",113,0)
 ; - Verify local ownership of patient
"RTN","MPIFA31I",114,0)
 Q:($$IFVCCI^MPIF001(DFN)<0) "-1^Local facility not listed as Primary Patient Facility"
"RTN","MPIFA31I",115,0)
 ; - Verify lack of national ICN
"RTN","MPIFA31I",116,0)
 I ($$GETICN^MPIF001(DFN)>0) Q:('$D(^DPT("AICNL",1,DFN))) "-1^National ICN already assigned to patient"
"RTN","MPIFA31I",117,0)
 ;Passed all validation checks - store ICN & checksum
"RTN","MPIFA31I",118,0)
 S TMP=$$SETICN^MPIF001(DFN,ICNNUM,ICNCHECK)
"RTN","MPIFA31I",119,0)
 Q:(TMP<0) "-1^Unable to store ICN and checksum"
"RTN","MPIFA31I",120,0)
 ;Delete local ICN flag
"RTN","MPIFA31I",121,0)
 S TMP=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFA31I",122,0)
 N HERE,TFSITE
"RTN","MPIFA31I",123,0)
 S HERE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFA31I",124,0)
 S TFSITE=$$LKUP^XUAF4(HERE)
"RTN","MPIFA31I",125,0)
 Q:+TFSITE'>0 ICN
"RTN","MPIFA31I",126,0)
 Q:$D(^DGCN(391.91,"APAT",DFN,TFSITE)) ICN
"RTN","MPIFA31I",127,0)
 K DD,DO N DIC,X,Y
"RTN","MPIFA31I",128,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=DFN,DIC(0)="LQZ"
"RTN","MPIFA31I",129,0)
 D FILE^DICN
"RTN","MPIFA31I",130,0)
 I +Y=-1 S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D
"RTN","MPIFA31I",131,0)
 .D EXC^RGHLLOG(212,"DFN= "_DFN_"  Treating Facility= "_TFSITE,DFN)
"RTN","MPIFA31I",132,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFA31I",133,0)
 ;Done
"RTN","MPIFA31I",134,0)
 Q ICN
"RTN","MPIFAPI")
0^4^B10172747
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ;original 1st line ARS/SLC - API for local ICNs ;04-FEB-97
"RTN","MPIFAPI",4,0)
 ;
"RTN","MPIFAPI",5,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",6,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",7,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",8,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",9,0)
 S MPINUM=0
"RTN","MPIFAPI",10,0)
 S X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",11,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",12,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",13,0)
 S MPINUM=MPINUM1_"V"_MPICHK
"RTN","MPIFAPI",14,0)
 S MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",15,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",16,0)
 D ^DIE
"RTN","MPIFAPI",17,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",18,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",19,0)
 Q MPINUM
"RTN","MPIFAPI",20,0)
SETUP ;
"RTN","MPIFAPI",21,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",22,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",23,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",24,0)
 S NUM=SITE_"0000000"
"RTN","MPIFAPI",25,0)
 S CHK=$$CHECKDG^MPIFSPC(NUM)
"RTN","MPIFAPI",26,0)
 S MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",27,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",28,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",29,0)
 K DD,D0
"RTN","MPIFAPI",30,0)
 D FILE^DICN
"RTN","MPIFAPI",31,0)
 K DIC,X,Y
"RTN","MPIFAPI",32,0)
 Q MPINUM
"RTN","MPIFAPI",33,0)
 ;
"RTN","MPIFAPI",34,0)
MPILINK() ;returns MPI logical LInk
"RTN","MPIFAPI",35,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",36,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",37,0)
 I '$D(MPIL) S MPIL(0)="-1^NOT DEFINED"
"RTN","MPIFAPI",38,0)
 S MPILINK=$O(MPIL(0)),MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",39,0)
 Q MPILINK
"RTN","MPIFAPI",40,0)
 ;
"RTN","MPIFAPI",41,0)
SUBNUM(DFN) ; returns Subscription Control Number from MPI node for given DFN
"RTN","MPIFAPI",42,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",43,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",44,0)
 ;           Subscription Control Number
"RTN","MPIFAPI",45,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",46,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",47,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",48,0)
 N NODE,SUB
"RTN","MPIFAPI",49,0)
 S NODE=$$MPINODE(DFN)
"RTN","MPIFAPI",50,0)
 S SUB=$P(NODE,"^",5)
"RTN","MPIFAPI",51,0)
 I SUB="" S SUB="-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",52,0)
 Q SUB
"RTN","MPIFAPI",53,0)
 ;
"RTN","MPIFAPI",54,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",55,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",56,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",57,0)
 ;           MPI node from patient file
"RTN","MPIFAPI",58,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",59,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",60,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",61,0)
 N NODE
"RTN","MPIFAPI",62,0)
 S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",63,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",64,0)
 Q NODE
"RTN","MPIFAPI",65,0)
 ;
"RTN","MPIFAPI",66,0)
UPDATE(DFN,ARR) ; updates fields on MPI node passed in ARR(field number) for
"RTN","MPIFAPI",67,0)
 ;patient DFN.  Fields 991.01-991.05 only
"RTN","MPIFAPI",68,0)
 ;ARR - array of values for each field to be updated where subscript
"RTN","MPIFAPI",69,0)
 ; is the field number to be updated
"RTN","MPIFAPI",70,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",71,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",72,0)
 ;          0 if sucessfully updated fields
"RTN","MPIFAPI",73,0)
 ;
"RTN","MPIFAPI",74,0)
 N FLD,DR,DIE,DA,LOC
"RTN","MPIFAPI",75,0)
 Q:'$D(^DPT(DFN,0)) "-1^No Entry in Patient file"
"RTN","MPIFAPI",76,0)
 I $$IFLOCAL^MPIF001(DFN) S LOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFAPI",77,0)
 S DIE="^DPT(",DA=DFN,RGRSICN=""
"RTN","MPIFAPI",78,0)
 F FLD=991.01,991.02,991.03,991.04,991.05 D
"RTN","MPIFAPI",79,0)
 .Q:$G(@ARR@(FLD))=""
"RTN","MPIFAPI",80,0)
 .S DR=FLD_"///^S X=$G(@ARR@(FLD))"
"RTN","MPIFAPI",81,0)
 .D ^DIE
"RTN","MPIFAPI",82,0)
 K ^DPT("AMPIMIS",DFN)
"RTN","MPIFAPI",83,0)
 K RGRSICN
"RTN","MPIFAPI",84,0)
 Q 0
"RTN","MPIFAPI",85,0)
 ;
"RTN","MPIFAPI",86,0)
MPIQ(MDFN) ;
"RTN","MPIFAPI",87,0)
 ;MPI QUERY
"RTN","MPIFAPI",88,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",89,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",90,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",91,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",92,0)
 .N ICN,ERR
"RTN","MPIFAPI",93,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",94,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",95,0)
 .S ERR=$$SETICN^MPIF001(MDFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",96,0)
 .S ERR=$$SETLOC^MPIF001(MDFN,1)
"RTN","MPIFAPI",97,0)
 .S ERR=$$CHANGE^MPIF001(MDFN,$P($$SITE^VASITE,"^",2))
"RTN","MPIFAPI",98,0)
 K MPIFRTN
"RTN","MPIFAPI",99,0)
 Q
"RTN","MPIFBT2")
0^6^B41055656
"RTN","MPIFBT2",1,0)
MPIFBT2 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFBT2",3,0)
ADDPAT ;Called when response from MPI is received for messages sent.
"RTN","MPIFBT2",4,0)
 K ^XTMP($J,"MPIF") D NOW^%DTC S ST=%,X1=ST,X2=20 D C^%DTC
"RTN","MPIFBT2",5,0)
 S STP=X,^XTMP($J,"MPIF","MPIIN",0)=STP_"^"_ST_"^"_"MPI BATCH JOB"
"RTN","MPIFBT2",6,0)
 K %,X,Y,X1,X2,ST,STP N RGLOG,MPIMSG S MPIMSG=HLMTIEN
"RTN","MPIFBT2",7,0)
 D START^RGHLLOG(HLMTIEN,"","ADDPAT^MPIFBT2")
"RTN","MPIFBT2",8,0)
 D PREPMSG,PROCESS(MPIMSG),STOP^RGHLLOG(0)
"RTN","MPIFBT2",9,0)
 K ACK1,ACK2,ACK3,ACK4,HDR,MPICKG,MPIIN,MPIIPPF,MPIIT,MPINUM,MPIPPF,DA
"RTN","MPIFBT2",10,0)
 K CNTR,COM,ENC,ESC,LOCAL,MSHDR,PATID,REP,SCOM,SEP,SITE,MPIDTH,VISTDTH,MPITMP,MPICNTR,MPIFOK,^XTMP($J,"MPIF")
"RTN","MPIFBT2",11,0)
 Q
"RTN","MPIFBT2",12,0)
PREPMSG ;prepare for response
"RTN","MPIFBT2",13,0)
 N I,J,X F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFBT2",14,0)
 .S ^XTMP($J,"MPIF","MPIIN",I)=HLNODE,J=0
"RTN","MPIFBT2",15,0)
 .F  S J=$O(HLNODE(J))  Q:'J  S ^XTMP($J,"MPIF","MPIIN",I,J)=HLNODE(J)
"RTN","MPIFBT2",16,0)
 Q
"RTN","MPIFBT2",17,0)
PROCESS(MPIMSG) ;Process mesage out of array
"RTN","MPIFBT2",18,0)
 N HDR,MPICNTR S MPICNTR=1,HDR=^XTMP($J,"MPIF","MPIIN",1) ;check hdr here
"RTN","MPIFBT2",19,0)
 D CHDR(HDR,.SEP,MPICNTR,MPIMSG)
"RTN","MPIFBT2",20,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",21,0)
 F  S MPICNTR=$O(^XTMP($J,"MPIF","MPIIN",MPICNTR)) Q:'MPICNTR  D LOOPS(.MPICNTR,SEP,MPIMSG)
"RTN","MPIFBT2",22,0)
 Q
"RTN","MPIFBT2",23,0)
LOOPS(CNTR,SEP,MPIMSG) ;Loop in the batch
"RTN","MPIFBT2",24,0)
 K ^XTMP($J,"MPIF","MSHERR") N MSHDR,ACK1,ACK2,ACK3,ACK4,ACK5,PATID,LOCAL,MPITMP
"RTN","MPIFBT2",25,0)
 S MSHDR=^XTMP($J,"MPIF","MPIIN",+CNTR)
"RTN","MPIFBT2",26,0)
 D CHKMSH(MSHDR,.SITE,SEP,MPIMSG)
"RTN","MPIFBT2",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",28,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",29,0)
 S ACK1=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",30,0)
 I $P(ACK1,SEP)'="MSA" S ^XTMP($J,"MPIF","MSHERR")="NOT AN MSA SEGMENT" D EXC^RGHLLOG(203,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",31,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",32,0)
 I ACK1["AR" S ^XTMP($J,"MPIF","MSHERR")="APP REJECT ERROR" D EXC^RGHLLOG(207,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",33,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",34,0)
 I ACK1["AE" S ^XTMP($J,"MPIF","MSHERR")="APP ERROR" D EXC^RGHLLOG(208,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",35,0)
 ;ACK1 must be an AA
"RTN","MPIFBT2",36,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",37,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",38,0)
 S ACK2=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",39,0)
 I $P(ACK2,SEP)'="QAK" S ^XTMP($J,"MPIF","MSHERR")="NOT A QAK SEGMENT" D EXC^RGHLLOG(202,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",40,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",41,0)
 I ACK2["NO DATA" D
"RTN","MPIFBT2",42,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NO DATA in MPI "
"RTN","MPIFBT2",43,0)
 .I ACK2["POTENTIAL MATCHES" D EXC^RGHLLOG(218,"For Patient DFN="_$P(ACK2,SEP,2)_".  Use Single Patient Initialization to MPI option to manually process.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",44,0)
 .I ACK2'["POTENTIAL MATCHES" D EXC^RGHLLOG(209,"For Patient DFN="_$P(ACK2,SEP,2)_".  Need required fields before patient can be processed again the MPI.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",45,0)
 .N TACK,TCNTR S TCNTR=CNTR,CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),TACK=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",46,0)
 .I $P(TACK,SEP)="MSH" S CNTR=TCNTR
"RTN","MPIFBT2",47,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",48,0)
 S PATID=$P(ACK2,SEP,2),LOCAL=$G(^DPT(PATID,0)) ;Verify patient is in database
"RTN","MPIFBT2",49,0)
 I LOCAL']"" S ^XTMP($J,"MPIF","MSHERR")="PATIENT DFN NOT IN DATABASE- BAD " D EXC^RGHLLOG(210,"Around line number "_(CNTR*2)_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT2",50,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",51,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",52,0)
 S ACK3=^XTMP($J,"MPIF","MPIIN",CNTR) ;RDF DEFINITION SEGMENT NO-OP
"RTN","MPIFBT2",53,0)
 I $P(ACK3,SEP)'="RDF" S ^XTMP($J,"MPIF","MSHERR")="NOT RDF SEGMENT" D EXC^RGHLLOG(204,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",54,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",55,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",56,0)
 S ACK4=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",57,0)
 I $P(ACK4,SEP)'="RDT" S ^XTMP($J,"MPIF","MSHERR")="NOT RDT SEGMENT" D EXC^RGHLLOG(205,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",58,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",59,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",60,0)
 I MPITMP'>0 S:$E($G(^XTMP($J,"MPIF","MPIIN",MPITMP)),1,3)="BTS" CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",61,0)
 Q:CNTR'>0
"RTN","MPIFBT2",62,0)
 D VFYRDT^MPIFBT3(ACK4,SEP,CNTR,PATID,SITE,MPIMSG)
"RTN","MPIFBT2",63,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",64,0)
 Q:MPITMP'>0
"RTN","MPIFBT2",65,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP)
"RTN","MPIFBT2",66,0)
 I $P(ACK5,SEP)="RDT" D MULT^MPIFBT3(.CNTR,ACK5,SEP,MPIMSG,PATID)
"RTN","MPIFBT2",67,0)
 Q
"RTN","MPIFBT2",68,0)
TFLIST(TFSITE,PATID) ;adding TFSITE site for patient to Treating Facility List (#391.91)
"RTN","MPIFBT2",69,0)
 I $G(TFSITE)="" S ^XTMP($J,"MPIF","MSHERR")="Treating Facility = null" D EXC^RGHLLOG(212,"DFN = "_PATID_" Treating Facility = Null",PATID) Q
"RTN","MPIFBT2",70,0)
 S TFSITE=$$LKUP^XUAF4(TFSITE)
"RTN","MPIFBT2",71,0)
 Q:+TFSITE'>0
"RTN","MPIFBT2",72,0)
 Q:$D(^DGCN(391.91,"APAT",PATID,TFSITE))
"RTN","MPIFBT2",73,0)
 K DD,DO N DIC,X,Y L +^DGCN(391.91,0):60
"RTN","MPIFBT2",74,0)
 I '$T D EXC^RGHLLOG(212,"Unable to Lock Treating Facility file to add patient DFN="_PATID_" Facility= "_TFSITE,PATID) Q
"RTN","MPIFBT2",75,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=PATID,DIC(0)="LQZ"
"RTN","MPIFBT2",76,0)
 I $D(^DGCN(391.91,"APAT",PATID,TFSITE)) L -^DGCN(391.91,0) Q
"RTN","MPIFBT2",77,0)
 D FILE^DICN L -^DGCN(391.91,0)
"RTN","MPIFBT2",78,0)
 I +Y=-1,'$D(^DGCN(391.91,"APAT",PATID,TFSITE)) S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D EXC^RGHLLOG(212,"DFN= "_PATID_"  Treating Facility= "_TFSITE_"  failed when adding an entry to the Treating Facility file.",DFN)
"RTN","MPIFBT2",79,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFBT2",80,0)
 Q
"RTN","MPIFBT2",81,0)
TFUPDT(PATID,MPIMSG,CNTR) ;treating facility update message to pivot file
"RTN","MPIFBT2",82,0)
 N ERR,TRANS,EVDT,X,Y,%
"RTN","MPIFBT2",83,0)
 D NOW^%DTC S EVDT=% K %,X,Y
"RTN","MPIFBT2",84,0)
 S ERR=$$PIVNW^VAFHPIVT(PATID,EVDT,5,PATID_";DPT(")
"RTN","MPIFBT2",85,0)
 I +ERR<1 D EXC^RGHLLOG(212,"When trying to add Patient (DFN)"_PATID_"   message# "_MPIMSG_" around line number "_(CNTR*2),DFN)
"RTN","MPIFBT2",86,0)
 Q:+ERR<1
"RTN","MPIFBT2",87,0)
 D XMITFLAG^VAFCDD01("",+ERR)
"RTN","MPIFBT2",88,0)
 Q
"RTN","MPIFBT2",89,0)
CHDR(HDR,SEP,CNTR,MPIMSG) ;Only process Batch message responses
"RTN","MPIFBT2",90,0)
 I $P(HDR,"^")'="BHS" S ^XTMP($J,"MPIF","MSHERR")="BHS SEGMENT MISSING" D EXC^RGHLLOG(200,"for message "_MPIMSG_".  The segment contains "_HDR)
"RTN","MPIFBT2",91,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",92,0)
 S SEP=$G(HL("FS")) ;get field sep, and encoding characters
"RTN","MPIFBT2",93,0)
 I SEP="" S ^XTMP($J,"MPIF","MSHERR")="Missing field seperator" D EXC^RGHLLOG(200,"Missing field seperator")
"RTN","MPIFBT2",94,0)
 Q
"RTN","MPIFBT2",95,0)
CHKMSH(MSHDR,SITE,SEP,MPIMSG) ;VERIFY MSH
"RTN","MPIFBT2",96,0)
 I $P(MSHDR,SEP)="BTS" S ^XTMP($J,"MPIF","MSHERR")="BTS FOUND" Q
"RTN","MPIFBT2",97,0)
 S:$P(MSHDR,SEP)'="MSH" ^XTMP($J,"MPIF","MSHERR")="NOT MSH HEADER   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",98,0)
 S:$E(MSHDR,4)'=SEP ^XTMP($J,"MPIF","MSHERR")="FIELD SEPARATOR MISMATCH   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",99,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(201,$G(^XTMP($J,"MPIF","MSHERR")))
"RTN","MPIFBT2",100,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",101,0)
 S SITE=$P(MSHDR,SEP,6)
"RTN","MPIFBT2",102,0)
 I SITE="" S ^XTMP($J,"MPIF","MSHERR")="SITE NOT IN MSH"
"RTN","MPIFBT2",103,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(8,"MSH Doesn't Have SITE as 6th piece.   MESSAGE# "_MPIMSG)
"RTN","MPIFBT2",104,0)
 Q
"RTN","MPIFBT3")
0^8^B21232774
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",5,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",6,0)
 D TFLIST^MPIFBT2(NEXTTF,PATID)
"RTN","MPIFBT3",7,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",8,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",9,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",10,0)
 Q
"RTN","MPIFBT3",11,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",12,0)
 N MPIY,IEN,MPICMOR S DGSENFLG=""
"RTN","MPIFBT3",13,0)
 D FINDHM(PATID,ACK4,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",14,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",15,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF
"RTN","MPIFBT3",16,0)
 S MPINUM=$P(ACK4,SEP,6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",17,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",18,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",19,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",20,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",21,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient dfn "_$O(^DPT("AICN",MPINUM,""))_" Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",22,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",23,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",24,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",25,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",26,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",27,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",28,0)
 S MPIIPPF=""
"RTN","MPIFBT3",29,0)
 S MPIPPF=$P(ACK4,SEP,5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",30,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",31,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",32,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",33,0)
 D TFLIST^MPIFBT2(SITE,PATID)
"RTN","MPIFBT3",34,0)
 I MPIPPF'=SITE D TFUPDT^MPIFBT2(PATID,MPIMSG,CNTR),INSERT^RGJCTS01(PATID)
"RTN","MPIFBT3",35,0)
 Q
"RTN","MPIFBT3",36,0)
FINDHM(PATID,ACK4,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",37,0)
 N DIC,X,Y,NM,YTMP
"RTN","MPIFBT3",38,0)
 ;added I to DIC(0) allow processing of sensative patients when DUZ=0
"RTN","MPIFBT3",39,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC,DGSENFLG
"RTN","MPIFBT3",40,0)
 S YTMP=Y
"RTN","MPIFBT3",41,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(ACK4,SEP,3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),$P(ACK4,SEP,3))
"RTN","MPIFBT3",42,0)
 Q:YTMP=-1
"RTN","MPIFBT3",43,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",44,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",45,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",46,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",47,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",48,0)
 Q:$P(Y(0),"^",9)["P"&($P(ACK4,SEP,3)="")
"RTN","MPIFBT3",49,0)
 I $P(Y(0),"^",9)'=$P(ACK4,SEP,3) S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH" D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(ACK4,SEP,3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",50,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",51,0)
 I NM'[$P(ACK4,SEP,2) S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH" D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_$P(ACK4,SEP,2)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",52,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",53,0)
 N MPIDTH,VISTDTH
"RTN","MPIFBT3",54,0)
 I $P(ACK4,SEP,9)'="" S MPIDTH=$P(ACK4,SEP,9),MPIDTH=$$FMDATE^HLFNC(MPIDTH)\1
"RTN","MPIFBT3",55,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",56,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",57,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",58,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",59,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",60,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",61,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",62,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",63,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",64,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",65,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",66,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",67,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",68,0)
 Q
"RTN","MPIFCMOR")
0^10^B6338689
"RTN","MPIFCMOR",1,0)
MPIFCMOR ;BHM/RGY-Set and broadcast CMOR changes ;FEB 20, 1998
"RTN","MPIFCMOR",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFCMOR",3,0)
BROAD(REQNO) ;Broadcase CMOR change for request
"RTN","MPIFCMOR",4,0)
 N CN,RGL,SITE,HL,CNT,HLA,PDX,ICN,HOME,RGLINK,RGL,TMP,II,CLIENT,HLA,USER,N0,NDATE,RLST
"RTN","MPIFCMOR",5,0)
 S CLIENT="MPIF CMOR REQUEST" K ERROR
"RTN","MPIFCMOR",6,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFCMOR",7,0)
 S DFN=$P(N0,"^",4)
"RTN","MPIFCMOR",8,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFCMOR",9,0)
 N X,Y,DIC
"RTN","MPIFCMOR",10,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFCMOR",11,0)
 D ^DIC
"RTN","MPIFCMOR",12,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFCMOR",13,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFCMOR",14,0)
 S ICN=$$ICN^MPIFNQ(DFN)
"RTN","MPIFCMOR",15,0)
 S HOME=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIFCMOR",16,0)
 S CN=+$P($$MPINODE^MPIFAPI(DFN),"^",5)
"RTN","MPIFCMOR",17,0)
 S HL=0,CNT=0
"RTN","MPIFCMOR",18,0)
 K ^XTMP("MPIFCMOR","ERR")
"RTN","MPIFCMOR",19,0)
 D INIT^HLFNC2(CLIENT,.HL)
"RTN","MPIFCMOR",20,0)
 I CN>0 D GET^HLSUB(CN,1,"MPIF CMOR RESPONSE",.HLL)
"RTN","MPIFCMOR",21,0)
 F II=0:0 S II=$O(HLL("LINKS",II)) Q:'II!($D(^XTMP("MPIFCMOR","ERR")))  D
"RTN","MPIFCMOR",22,0)
 .I $E($P($G(HLL("LINKS",II)),"^",2),1,2)'="VA" D
"RTN","MPIFCMOR",23,0)
 ..S ^XTMP("MPIFCMOR","ERR")=""
"RTN","MPIFCMOR",24,0)
 ..D START^RGHLLOG()
"RTN","MPIFCMOR",25,0)
 ..D EXC^RGHLLOG(224,$P(HLL("LINKS",II),"^",2)_" link returned in not a CIRN link.  Unable to send to appropriate station Change CMOR message for reqest # "_REQNO)
"RTN","MPIFCMOR",26,0)
 ..D STOP^RGHLLOG()
"RTN","MPIFCMOR",27,0)
 ..K HLL("LINKS",II)
"RTN","MPIFCMOR",28,0)
 .Q:$D(^XTMP("MPIFCMOR","ERR")) 
"RTN","MPIFCMOR",29,0)
 .S HLL("LINKS",II)="MPIF CMOR RESPONSE^"_$P(HLL("LINKS",II),"^",2)
"RTN","MPIFCMOR",30,0)
 Q:$D(^XTMP("MPIFCMOR","ERR"))
"RTN","MPIFCMOR",31,0)
 N MPILINK
"RTN","MPIFCMOR",32,0)
 S MPILINK=$$MPILINK^MPIFAPI()
"RTN","MPIFCMOR",33,0)
 S HLL("LINKS",9999999)="MPIF CMOR RESPONSE^"_MPILINK
"RTN","MPIFCMOR",34,0)
 ;Broadcase new pff to other sites
"RTN","MPIFCMOR",35,0)
 I HL S ERROR=HL Q
"RTN","MPIFCMOR",36,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFCMOR",37,0)
 S CNT=CNT+1,PDX=$$EN^VAFCPID(DFN,"2,3,5"),$P(PDX,"^",3)=ICN,HLA("HLS",CNT)=PDX
"RTN","MPIFCMOR",38,0)
 S CNT=CNT+1,HLA("HLS",CNT)="PV1"_HL("FS")_HL("FS")_HL("FS")_$P($$NNT^XUAF4(+$P(N0,"^",7)),"^",2)_HL("FS")_HL("FS")_HL("FS")_$P($$SITE^VASITE,"^",3)
"RTN","MPIFCMOR",39,0)
 D GENERATE^HLMA(CLIENT,"LM",1,.RLST,"",.HL)
"RTN","MPIFCMOR",40,0)
 I 'RLST S ERROR=RLST
"RTN","MPIFCMOR",41,0)
 Q
"RTN","MPIFCMOR",42,0)
SET(DFN,SITE) ;Set CMOR for patient to site
"RTN","MPIFCMOR",43,0)
 NEW RESULT
"RTN","MPIFCMOR",44,0)
 S RESULT=$$CHANGE^MPIF001(DFN,SITE)
"RTN","MPIFCMOR",45,0)
 Q
"RTN","MPIFDEL")
0^17^B7732205
"RTN","MPIFDEL",1,0)
MPIFDEL ;SF/MJM,CMC-DELETE PATIENT FROM MPI ;JUL 14, 1998
"RTN","MPIFDEL",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFDEL",3,0)
 ;
"RTN","MPIFDEL",4,0)
INTER ;
"RTN","MPIFDEL",5,0)
 ;Entry point for Inactivate Patient from MPI option [MPIF PAT INACT]
"RTN","MPIFDEL",6,0)
 ;No input or output variables ^DPT
"RTN","MPIFDEL",7,0)
 N DIC,DA,DFN,HL,ERROR,CNT,HLRST,ICN,DATE
"RTN","MPIFDEL",8,0)
 S ERROR=""
"RTN","MPIFDEL",9,0)
 S DIC=2,DIC(0)="QEAM" D ^DIC Q:+Y<0  S DFN=+Y
"RTN","MPIFDEL",10,0)
 I +$$PAT^MPIFNQ(DFN)=0 W !,"*** CIRN Master of Record is Not Defined ***" Q
"RTN","MPIFDEL",11,0)
 I +$$PAT^MPIFNQ(DFN)'=+$$SITE^VASITE W !,"*** CIRN Master of record site is '"_$$CMORNAME^MPIF001(+$$PAT^MPIFNQ(DFN))_"' ***" Q
"RTN","MPIFDEL",12,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFDEL",13,0)
 ;cleanup treating facility list for CMOR entry
"RTN","MPIFDEL",14,0)
 S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",15,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",16,0)
 I ERROR="" D DELETE(DFN)
"RTN","MPIFDEL",17,0)
 I ERROR=""!(ERROR=0) W !,"*** Done ***"
"RTN","MPIFDEL",18,0)
 I ERROR'="" W !,"Error Occurred - "_ERROR
"RTN","MPIFDEL",19,0)
 Q
"RTN","MPIFDEL",20,0)
 ;
"RTN","MPIFDEL",21,0)
HL7(DFN,ERROR) ; create HL7 message
"RTN","MPIFDEL",22,0)
 ; check if no subscribers
"RTN","MPIFDEL",23,0)
 N SUB,HL,CNT,ICN,%,HLDATE
"RTN","MPIFDEL",24,0)
 K HLL
"RTN","MPIFDEL",25,0)
 S SUB=$P($G(^DPT(DFN,"MPI")),"^",5)
"RTN","MPIFDEL",26,0)
 I SUB'="" D GET^HLSUB(SUB,"","MPIF A29 SERVER",.HLL) I $D(HLL) S ERROR="Attempted to Inactivate an ICN and Patient is Shared.  Can't Inactivate patient DFN= "_DFN D EXC(DFN,ERROR,225) Q
"RTN","MPIFDEL",27,0)
 S ICN=+$$ICN^MPIFNQ(DFN)
"RTN","MPIFDEL",28,0)
 D NOW^%DTC S HLDATE=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFDEL",29,0)
 S HL=0,CNT=0
"RTN","MPIFDEL",30,0)
 D INIT^HLFNC2("MPIF A29 SERVER",.HL)
"RTN","MPIFDEL",31,0)
 I HL S ERROR="ERROR = "_HL_" During INIT^HLFNC2 for MPIF A29 Server" D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",32,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A29"_HL("FS")_HLDATE_HL("FS")_HL("FS")_""_HL("FS")
"RTN","MPIFDEL",33,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFDEL",34,0)
 ; message only goes to MPI Link
"RTN","MPIFDEL",35,0)
 D GENERATE^HLMA("MPIF A29 SERVER","LM",1,.HLRST,"",.HL)
"RTN","MPIFDEL",36,0)
 I 'HLRST S ERROR="Error During Generate for MPIF A29 Server Error= "_HLRST_" for dfn "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",37,0)
 Q
"RTN","MPIFDEL",38,0)
 ;
"RTN","MPIFDEL",39,0)
PAT(DFN,ERROR) ;Programmer API to Delete MPI entry and remove ICN data from DPT
"RTN","MPIFDEL",40,0)
 S ERROR=""
"RTN","MPIFDEL",41,0)
 I $G(DFN)="" S ERROR="DFN not defined" Q
"RTN","MPIFDEL",42,0)
 I +$$PAT^MPIFNQ(DFN)'=+$$SITE^VASITE S ERROR="This site is not the CMOR for this patient" Q
"RTN","MPIFDEL",43,0)
 D HL7(DFN,ERROR)
"RTN","MPIFDEL",44,0)
 I ERROR="" D DELETE(DFN)
"RTN","MPIFDEL",45,0)
 Q
"RTN","MPIFDEL",46,0)
DELETE(DFN) ;
"RTN","MPIFDEL",47,0)
 N DA,DIE,X,Y,DR
"RTN","MPIFDEL",48,0)
 Q:DFN=""
"RTN","MPIFDEL",49,0)
 S DA=DFN,DIE="^DPT(",DR="991.01///@;991.02///@;991.03///@;991.04///@"
"RTN","MPIFDEL",50,0)
 D ^DIE
"RTN","MPIFDEL",51,0)
 Q
"RTN","MPIFDEL",52,0)
 ;
"RTN","MPIFDEL",53,0)
EXC(DFN,ERROR,TYPE) ; subscribers, log exception
"RTN","MPIFDEL",54,0)
 D START^RGHLLOG(0)
"RTN","MPIFDEL",55,0)
 D EXC^RGHLLOG(TYPE,ERROR)
"RTN","MPIFDEL",56,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFDEL",57,0)
 Q
"RTN","MPIFHL7")
0^19^B3214414
"RTN","MPIFHL7",1,0)
MPIFHL7 ;BHM/RGY-Processing incoming hl7 message ;FEB 20, 1998
"RTN","MPIFHL7",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFHL7",3,0)
IN ;
"RTN","MPIFHL7",4,0)
 ;Entry point used for MPIF CMOR RESPONSE protocol
"RTN","MPIFHL7",5,0)
 ; It process the inbound HL7 message to update CMOR
"RTN","MPIFHL7",6,0)
 N I,PHONE,COMMENTS,STATUS,ID,SITE,NDATE,USER,INST,ICN,HLNODE,HLQUIT,RES
"RTN","MPIFHL7",7,0)
 S HLQUIT="",ID=""
"RTN","MPIFHL7",8,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFHL7",9,0)
 .I $P(HLNODE,HL("FS"),1)="NTE" D
"RTN","MPIFHL7",10,0)
 ..S PHONE=$P(HLNODE,HL("FS"),4)
"RTN","MPIFHL7",11,0)
 ..S COMMENTS=$P(HLNODE,HL("FS"),5)
"RTN","MPIFHL7",12,0)
 ..S STATUS=$P(HLNODE,HL("FS"),6)
"RTN","MPIFHL7",13,0)
 ..S ID=$P(HLNODE,HL("FS"),7)
"RTN","MPIFHL7",14,0)
 ..S SITE=$P(HLNODE,HL("FS"),8)
"RTN","MPIFHL7",15,0)
 .I $P(HLNODE,HL("FS"),1)="EVN" D
"RTN","MPIFHL7",16,0)
 ..S NDATE=$P(HLNODE,HL("FS"),3)
"RTN","MPIFHL7",17,0)
 ..S USER=$P(HLNODE,HL("FS"),6)
"RTN","MPIFHL7",18,0)
 .I $P(HLNODE,HL("FS"),1)="PID" S ICN=+$P(HLNODE,HL("FS"),3)
"RTN","MPIFHL7",19,0)
 .I $P(HLNODE,HL("FS"),1)="PV1" S SITE=+$P(HLNODE,HL("FS"),4)
"RTN","MPIFHL7",20,0)
 I $G(SITE) S SITE=$$LKUP^XUAF4(SITE)
"RTN","MPIFHL7",21,0)
 ;Broadcase to all site to change cmor is id=null
"RTN","MPIFHL7",22,0)
 N DFN
"RTN","MPIFHL7",23,0)
 S RES=1,DFN=$$IEN^MPIFNQ(ICN)
"RTN","MPIFHL7",24,0)
 I ID="" D  Q
"RTN","MPIFHL7",25,0)
 .I SITE'="" S SITE=$$CMORNAME^MPIF001(SITE),RES=$$CHANGE^MPIF001(DFN,SITE)
"RTN","MPIFHL7",26,0)
 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_SITE_" in a CMOR Change Message for patient DFN= "_DFN,DFN),STOP^RGHLLOG()
"RTN","MPIFHL7",27,0)
 Q:+RES<1
"RTN","MPIFHL7",28,0)
 I $D(ICN) D IN^MPIFREQ(SITE,USER,COMMENTS,NDATE,ICN,PHONE,ID) Q
"RTN","MPIFHL7",29,0)
 D IN^MPIFRESS(ID,STATUS,NDATE,PHONE,USER,COMMENTS)
"RTN","MPIFHL7",30,0)
 Q
"RTN","MPIFPST1")
0^^B930883
"RTN","MPIFPST1",1,0)
MPIFPST1 ;CMC/SF-MPI VISTA build post-init ;JAN 13, 2000
"RTN","MPIFPST1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFPST1",3,0)
 ;
"RTN","MPIFPST1",4,0)
EN ;This post init will correct any exiting problems with the setting of
"RTN","MPIFPST1",5,0)
 ; the ^DPT("AICNL" cross reference for local ICNs or the field Locally
"RTN","MPIFPST1",6,0)
 ; assigned ICN in the patient file for local ICNs.
"RTN","MPIFPST1",7,0)
 ;
"RTN","MPIFPST1",8,0)
 D BMES^XPDUTL("Updating 'AICNL' Cross Reference.  This may take some time")
"RTN","MPIFPST1",9,0)
 N EN,LOCAL,ICN,SITE
"RTN","MPIFPST1",10,0)
 S ICN=0,SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFPST1",11,0)
 F  S ICN=$O(^DPT("AICN",ICN)) Q:ICN=""  D
"RTN","MPIFPST1",12,0)
 .S EN=""
"RTN","MPIFPST1",13,0)
 .F  S EN=$O(^DPT("AICN",ICN,EN)) Q:EN=""  D
"RTN","MPIFPST1",14,0)
 ..I $E(ICN,1,3)=SITE D
"RTN","MPIFPST1",15,0)
 ...I $P($G(^DPT(EN,"MPI")),"^")=ICN S LOCAL=$$SETLOC^MPIF001(EN,1),^DPT("AICNL",1,EN)=""
"RTN","MPIFPST1",16,0)
 Q
"RTN","MPIFPST1",17,0)
 ;
"RTN","MPIFQ0")
0^2^B73182661
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-CIRN QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",5,0)
 ;
"RTN","MPIFQ0",6,0)
 ;
"RTN","MPIFQ0",7,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",8,0)
 S MPIFRES="",MPIFINT=""
"RTN","MPIFQ0",9,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",10,0)
 S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","MPIFQ0",11,0)
 D ^DIC
"RTN","MPIFQ0",12,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",13,0)
 S DFN=+Y
"RTN","MPIFQ0",14,0)
 W !
"RTN","MPIFQ0",15,0)
CIRNEXC ; CIRN Exception Entry Point
"RTN","MPIFQ0",16,0)
 ; change to display messages to user 2/10/98 cmc
"RTN","MPIFQ0",17,0)
 I $$SEND^RGJUSITE'>0 W !,"CIRN Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",18,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",19,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",20,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",21,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",22,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",23,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",24,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",25,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W !,"Patient has Test SSN" G END
"RTN","MPIFQ0",26,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",27,0)
 G JUMP
"RTN","MPIFQ0",28,0)
 ;
"RTN","MPIFQ0",29,0)
VTQ ;
"RTN","MPIFQ0",30,0)
 G:$G(DFN)']"" END
"RTN","MPIFQ0",31,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",32,0)
 ;
"RTN","MPIFQ0",33,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",34,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",35,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",36,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",37,0)
 ;
"RTN","MPIFQ0",38,0)
 ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",39,0)
 ;
"RTN","MPIFQ0",40,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END
"RTN","MPIFQ0",41,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",42,0)
JUMP ;
"RTN","MPIFQ0",43,0)
 N TIME,%
"RTN","MPIFQ0",44,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFQ0",45,0)
 ;
"RTN","MPIFQ0",46,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",47,0)
 ;
"RTN","MPIFQ0",48,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER
"RTN","MPIFQ0",49,0)
 N TEST,SITE,RGDC
"RTN","MPIFQ0",50,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",51,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",52,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1
"RTN","MPIFQ0",53,0)
 S MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",54,0)
 ;
"RTN","MPIFQ0",55,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",56,0)
 ;
"RTN","MPIFQ0",57,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error
"RTN","MPIFQ0",58,0)
 ;and exit
"RTN","MPIFQ0",59,0)
 ;
"RTN","MPIFQ0",60,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",61,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0))
"RTN","MPIFQ0",62,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ0",63,0)
 . W !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",64,0)
 ;
"RTN","MPIFQ0",65,0)
 ;Create MSH
"RTN","MPIFQ0",66,0)
 ;
"RTN","MPIFQ0",67,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFQ0",68,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",69,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",70,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",71,0)
 ;
"RTN","MPIFQ0",72,0)
 ;
"RTN","MPIFQ0",73,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",74,0)
 ;Message is returned in RGDC array
"RTN","MPIFQ0",75,0)
 ;
"RTN","MPIFQ0",76,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFQ0",77,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","RGDC")
"RTN","MPIFQ0",78,0)
 ;
"RTN","MPIFQ0",79,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and
"RTN","MPIFQ0",80,0)
 ;continue with Registration
"RTN","MPIFQ0",81,0)
 ;
"RTN","MPIFQ0",82,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",83,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",84,0)
 . W !!,"Could not connect to MPI, assigning local ICN..."
"RTN","MPIFQ0",85,0)
 . D LOCAL(DFN)
"RTN","MPIFQ0",86,0)
 . S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",87,0)
 ;
"RTN","MPIFQ0",88,0)
 ;
"RTN","MPIFQ0",89,0)
 ;Kill ^TMP("MPIFQ0",$J) this is the array the data is parsed into
"RTN","MPIFQ0",90,0)
 ;for display in list manager
"RTN","MPIFQ0",91,0)
 ;
"RTN","MPIFQ0",92,0)
 K ^TMP("MPIFQ0",$J)
"RTN","MPIFQ0",93,0)
 ;
"RTN","MPIFQ0",94,0)
INIPARS ;
"RTN","MPIFQ0",95,0)
 N SEG,INDEX,COUNTER,LASTSSN
"RTN","MPIFQ0",96,0)
 S INDEX=0,COUNTER=1
"RTN","MPIFQ0",97,0)
PARSE ;
"RTN","MPIFQ0",98,0)
 S SEG=$$SEG^RGRSUTIL("RDT",1,"RDT")
"RTN","MPIFQ0",99,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",100,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN
"RTN","MPIFQ0",101,0)
 . N HEREICN,HERESSN,MIDDLE,IEN
"RTN","MPIFQ0",102,0)
 . S STRING=""
"RTN","MPIFQ0",103,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7)
"RTN","MPIFQ0",104,0)
 . S LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFQ0",105,0)
 . S MIDDLE=$P(SEG,HL("FS"),10)
"RTN","MPIFQ0",106,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFQ0",107,0)
 . S NAME=LASTNAME_","_FRSTNAME_" "_MIDDLE
"RTN","MPIFQ0",108,0)
 . S TF=$P(SEG,HL("FS"),8)
"RTN","MPIFQ0",109,0)
 . ;
"RTN","MPIFQ0",110,0)
 . ;Same patient just adding TF's
"RTN","MPIFQ0",111,0)
 . ;
"RTN","MPIFQ0",112,0)
 . I NAME_"^"_SSN=$P($G(^TMP("MPIFQ0",$J,INDEX,"DATA")),"^",0,2) D  Q
"RTN","MPIFQ0",113,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFQ0",114,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF
"RTN","MPIFQ0",115,0)
 . ;
"RTN","MPIFQ0",116,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",117,0)
 . S CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",118,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",119,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFQ0",120,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFQ0",121,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFQ0",122,0)
 . . S BIRTHDAY=$$IN2EXDT^VAFCMGU0(BIRTHDAY,0)
"RTN","MPIFQ0",123,0)
 . I $G(CMOR)]"" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(IEN),"^")
"RTN","MPIFQ0",124,0)
 . ;
"RTN","MPIFQ0",125,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",126,0)
 . ;
"RTN","MPIFQ0",127,0)
 . S INDEX=INDEX+1
"RTN","MPIFQ0",128,0)
 . S COUNTER=1
"RTN","MPIFQ0",129,0)
 . S HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",130,0)
 . I HEREICN D
"RTN","MPIFQ0",131,0)
 . . S STRING=$$SETSTR^VALM1("*",STRING,1,1)
"RTN","MPIFQ0",132,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",133,0)
 . S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4)
"RTN","MPIFQ0",134,0)
 . S STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",135,0)
 . S STRING=$$SETSTR^VALM1(SSN,STRING,30,9)
"RTN","MPIFQ0",136,0)
 . S STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",137,0)
 . S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",138,0)
 . S ^TMP("MPIFQ0",$J,INDEX,0)=STRING
"RTN","MPIFQ0",139,0)
 . S ^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",140,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF
"RTN","MPIFQ0",141,0)
 . S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",142,0)
 ;
"RTN","MPIFQ0",143,0)
DECIDE ;
"RTN","MPIFQ0",144,0)
 ;I no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",145,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",146,0)
 ;
"RTN","MPIFQ0",147,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",148,0)
 . W !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",149,0)
 . D A28(DFN)
"RTN","MPIFQ0",150,0)
 . S MPIFRTN="DID A28"
"RTN","MPIFQ0",151,0)
 ;
"RTN","MPIFQ0",152,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to
"RTN","MPIFQ0",153,0)
 ;see if it's definitely the same patient. If so, we automatically
"RTN","MPIFQ0",154,0)
 ;update the ICN, CMOR
"RTN","MPIFQ0",155,0)
 ;
"RTN","MPIFQ0",156,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",157,0)
 . N CMOR,ICN,DATA,TICN
"RTN","MPIFQ0",158,0)
 . S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ0",159,0)
 . S CMOR=CCMOR
"RTN","MPIFQ0",160,0)
 . S ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",161,0)
 . D START^RGHLLOG(0)
"RTN","MPIFQ0",162,0)
 . S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",163,0)
 . I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",164,0)
 . Q:TICN>0
"RTN","MPIFQ0",165,0)
 . W !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",166,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ0",167,0)
 . D UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",168,0)
 . S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",169,0)
 ;
"RTN","MPIFQ0",170,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",171,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",172,0)
 .W !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",173,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",174,0)
 .D EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN)
"RTN","MPIFQ0",175,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ0",176,0)
 .D LOCAL(DFN)
"RTN","MPIFQ0",177,0)
 .S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",178,0)
 ;
"RTN","MPIFQ0",179,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",180,0)
EXIT ;
"RTN","MPIFQ0",181,0)
 I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",182,0)
 K CCMOR
"RTN","MPIFQ0",183,0)
 H 3
"RTN","MPIFQ0",184,0)
 W !!
"RTN","MPIFQ0",185,0)
END ;
"RTN","MPIFQ0",186,0)
 Q
"RTN","MPIFQ0",187,0)
A28(DFN) ;
"RTN","MPIFQ0",188,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",189,0)
 I +ICN>0 W !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",190,0)
 ;ASSIGN LOCAL ICN
"RTN","MPIFQ0",191,0)
 W !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",192,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",193,0)
 Q
"RTN","MPIFQ0",194,0)
 ;
"RTN","MPIFQ0",195,0)
UPDATE(DFN,ICN,CMOR,LOCAL) ;
"RTN","MPIFQ0",196,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG
"RTN","MPIFQ0",197,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",198,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ0",199,0)
 S ICN=$P(ICN,"V",1)
"RTN","MPIFQ0",200,0)
 S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",201,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",202,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",203,0)
 I +SETICN'>0 D  Q
"RTN","MPIFQ0",204,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0"
"RTN","MPIFQ0",205,0)
 S SETLOC=1
"RTN","MPIFQ0",206,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",207,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",208,0)
 I +SETLOC'>0 D  Q
"RTN","MPIFQ0",209,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0"
"RTN","MPIFQ0",210,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",211,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",212,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",213,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^",2))
"RTN","MPIFQ0",214,0)
 I +CHANGE'>0 D  Q
"RTN","MPIFQ0",215,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0"
"RTN","MPIFQ0",216,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",217,0)
 N HERE
"RTN","MPIFQ0",218,0)
 S HERE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFQ0",219,0)
 I CMOR=HERE D TFLIST^MPIFBT2(CMOR,DFN)
"RTN","MPIFQ0",220,0)
 ; ^ add CMOR to treating facility list
"RTN","MPIFQ0",221,0)
 I CMOR'=HERE D TFLIST^MPIFBT2(HERE,DFN),TFUPDT^MPIFBT2(DFN,0,0),INSERT^RGJCTS01(DFN)
"RTN","MPIFQ0",222,0)
 ; ^ not CMOR add site to Treating Facility list, add pivot file treating facility message and add subscription control message to event queue.
"RTN","MPIFQ0",223,0)
 Q
"RTN","MPIFQ0",224,0)
 ;
"RTN","MPIFQ0",225,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",226,0)
 N ICN,CMOR,ERR
"RTN","MPIFQ0",227,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",228,0)
 ;don't assign local if one already exists
"RTN","MPIFQ0",229,0)
 S ICN=$$EN2^MPIFAPI()
"RTN","MPIFQ0",230,0)
 I +ICN'>0 D  Q
"RTN","MPIFQ0",231,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="DID NOT GET ICN IN LOCAL(DFN)"
"RTN","MPIFQ0",232,0)
 S ERR=$$SETICN^MPIF001(DFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFQ0",233,0)
 S ERR=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",234,0)
 S ERR=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^",2))
"RTN","MPIFQ0",235,0)
 Q
"RTN","MPIFQ0",236,0)
 ;
"RTN","MPIFQ0",237,0)
 ;
"RTN","MPIFQ0",238,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",239,0)
 N DFN
"RTN","MPIFQ0",240,0)
 I $G(ICN)="" Q 0
"RTN","MPIFQ0",241,0)
 S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",242,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",243,0)
 Q DFN
"RTN","MPIFQ0",244,0)
 ;
"RTN","MPIFQ0",245,0)
TEST(SSN) ;
"RTN","MPIFQ0",246,0)
 N DFN
"RTN","MPIFQ0",247,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ0",248,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ0",249,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ0",250,0)
 Q DFN
"RTN","MPIFQ0",251,0)
 ;
"RTN","MPIFQ0",252,0)
HERESSN(X) ;
"RTN","MPIFQ0",253,0)
 N DFN,X,Y,DIC,D
"RTN","MPIFQ0",254,0)
 I $G(X)="" Q 0
"RTN","MPIFQ0",255,0)
 S DIC="^DPT(",D="SSN",DIC(0)="X"
"RTN","MPIFQ0",256,0)
 D MIX^DIC1
"RTN","MPIFQ0",257,0)
 Q:$G(Y)=-1 0
"RTN","MPIFQ0",258,0)
 Q $P(Y,"^",1)
"RTN","MPIFQ0",259,0)
 ;
"RTN","MPIFQ0",260,0)
GETDATA(DIC,DA,ARRAY,DR,EI) ;
"RTN","MPIFQ0",261,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",262,0)
 ;DIC is the file reference
"RTN","MPIFQ0",263,0)
 ;DA is the file entry IEN
"RTN","MPIFQ0",264,0)
 ;ARRAY is the storage array for the values to be stored in
"RTN","MPIFQ0",265,0)
 ;DR are the fields requested
"RTN","MPIFQ0",266,0)
 ;EI is external/internal values of the fields or dont return null values
"RTN","MPIFQ0",267,0)
 N DIQ
"RTN","MPIFQ0",268,0)
 S DIQ=ARRAY
"RTN","MPIFQ0",269,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",270,0)
 D EN^DIQ1
"RTN","MPIFQ0",271,0)
 Q
"RTN","MPIFQ1")
0^14^B31816969
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFQ1",3,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",4,0)
 ; It is started from outside of the template.
"RTN","MPIFQ1",5,0)
 Q
"RTN","MPIFQ1",6,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",7,0)
 N SSN,DOB,MPIFQ1,NAME1
"RTN","MPIFQ1",8,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09","EI")
"RTN","MPIFQ1",9,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",10,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",11,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I"))
"RTN","MPIFQ1",12,0)
 I DOB]"" S DOB=$$IN2EXDT^VAFCMGU0(DOB,0)
"RTN","MPIFQ1",13,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",14,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",15,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",16,0)
 Q
"RTN","MPIFQ1",17,0)
START(INDEX) ;
"RTN","MPIFQ1",18,0)
 ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",19,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",20,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",21,0)
 Q
"RTN","MPIFQ1",22,0)
SELECT ;
"RTN","MPIFQ1",23,0)
 N VALMY
"RTN","MPIFQ1",24,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",25,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",26,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2,HERESSN
"RTN","MPIFQ1",27,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",28,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",29,0)
 S NODE2=$G(^TMP("MPIFQ0",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",30,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",31,0)
 S DATA(.03)=$P(DATA,"^",3) ;DOB
"RTN","MPIFQ1",32,0)
 S DATA(.09)=$P(DATA,"^",2) ;SSN
"RTN","MPIFQ1",33,0)
 S ICN=$P(DATA,"^",4)
"RTN","MPIFQ1",34,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",35,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",36,0)
 S DATA(991.01)=ICN
"RTN","MPIFQ1",37,0)
 S DATA(991.02)=CHKSUM ;CHKSUM
"RTN","MPIFQ1",38,0)
 S DATA(991.03)=$P(DATA,"^",5) ;CMOR
"RTN","MPIFQ1",39,0)
 ;
"RTN","MPIFQ1",40,0)
 ;If NODE2["*" it means we got a match on ICN for a patient in our
"RTN","MPIFQ1",41,0)
 ;list, with a patient in our local database. Since we don't allow more 
"RTN","MPIFQ1",42,0)
 ;than one patient to have the same ICN, we log an Exception and assign 
"RTN","MPIFQ1",43,0)
 ;a Local ICN for this patient.
"RTN","MPIFQ1",44,0)
 ;
"RTN","MPIFQ1",45,0)
 I NODE2["*" D  Q
"RTN","MPIFQ1",46,0)
 . D CLEAR^VALM1
"RTN","MPIFQ1",47,0)
 . D MSG1
"RTN","MPIFQ1",48,0)
 . D START^RGHLLOG()
"RTN","MPIFQ1",49,0)
 . D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",50,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ1",51,0)
 . W !!,"Assigning Local ICN"
"RTN","MPIFQ1",52,0)
 . D LOCAL^MPIFQ0(DFN)
"RTN","MPIFQ1",53,0)
 . D PROMPT
"RTN","MPIFQ1",54,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",55,0)
 ;
"RTN","MPIFQ1",56,0)
 ;User selected one from the list that doesn't exist already in this
"RTN","MPIFQ1",57,0)
 ; Patient file. 
"RTN","MPIFQ1",58,0)
 ;Does SSN and Name match?  If no - ask if they are sure before 
"RTN","MPIFQ1",59,0)
 ;updating ICN and CMOR fields
"RTN","MPIFQ1",60,0)
 ;
"RTN","MPIFQ1",61,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09","EI")
"RTN","MPIFQ1",62,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",63,0)
 ;SSN and Name both match on site and MPI -- Update ICN and CMOR
"RTN","MPIFQ1",64,0)
 I DATA(.09)=SSN,DATA(.01)=NAME  K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3,PROMPT Q
"RTN","MPIFQ1",65,0)
 ;
"RTN","MPIFQ1",66,0)
 ;SSN and/or Name doesn't match
"RTN","MPIFQ1",67,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",68,0)
 D MSG2
"RTN","MPIFQ1",69,0)
 D MSG(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",70,0)
 N ANS
"RTN","MPIFQ1",71,0)
 S ANS=$$PROMPT1()
"RTN","MPIFQ1",72,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT Q
"RTN","MPIFQ1",73,0)
 D MSG5,PROMPT
"RTN","MPIFQ1",74,0)
 S VALMBCK="R"
"RTN","MPIFQ1",75,0)
 ;
"RTN","MPIFQ1",76,0)
 Q
"RTN","MPIFQ1",77,0)
 ;
"RTN","MPIFQ1",78,0)
 ;
"RTN","MPIFQ1",79,0)
ADD ;
"RTN","MPIFQ1",80,0)
 ;Add List Manager Action (MPIF REAL-TIME QUERY (ADD PATIENT)) to add
"RTN","MPIFQ1",81,0)
 ; patient to the MPI Austin.
"RTN","MPIFQ1",82,0)
 D A28^MPIFQ0(DFN)
"RTN","MPIFQ1",83,0)
 D MSG3,PROMPT
"RTN","MPIFQ1",84,0)
 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",85,0)
 Q
"RTN","MPIFQ1",86,0)
 ;
"RTN","MPIFQ1",87,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",88,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",89,0)
 D MSG4
"RTN","MPIFQ1",90,0)
 D PROMPT
"RTN","MPIFQ1",91,0)
 S VALMBCK="R"
"RTN","MPIFQ1",92,0)
 Q
"RTN","MPIFQ1",93,0)
 ;
"RTN","MPIFQ1",94,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME) ;
"RTN","MPIFQ1",95,0)
 ;
"RTN","MPIFQ1",96,0)
 W !!!,"Local SSN = "_LOCSSN,?35,"MPI SSN = "_MPISSN
"RTN","MPIFQ1",97,0)
 W !,"Local NAME = "_LOCNAME,?35,"MPI NAME = "_MPINAME
"RTN","MPIFQ1",98,0)
 Q
"RTN","MPIFQ1",99,0)
 ;
"RTN","MPIFQ1",100,0)
MSG3 ;
"RTN","MPIFQ1",101,0)
 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ1",102,0)
 Q
"RTN","MPIFQ1",103,0)
MSG1 ;
"RTN","MPIFQ1",104,0)
 W !!,"You are attempting to assign an ICN that has already been assigned"
"RTN","MPIFQ1",105,0)
 W !,"to another patient in your Patient file."
"RTN","MPIFQ1",106,0)
 W !,"An Exception will be recorded noting that these 2 patients "
"RTN","MPIFQ1",107,0)
 W !,"need to be reviewed to determine in they are a duplicate."
"RTN","MPIFQ1",108,0)
 Q
"RTN","MPIFQ1",109,0)
MSG2 ;
"RTN","MPIFQ1",110,0)
 W !!,"You have selected a patient from the list of potential matches"
"RTN","MPIFQ1",111,0)
 W !," where the SSN and/or the Name is different than what the MPI has."
"RTN","MPIFQ1",112,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ1",113,0)
 Q
"RTN","MPIFQ1",114,0)
 ;
"RTN","MPIFQ1",115,0)
MSG5 ;
"RTN","MPIFQ1",116,0)
 W !!,"No Action Taken"
"RTN","MPIFQ1",117,0)
 Q
"RTN","MPIFQ1",118,0)
MSG4 ;
"RTN","MPIFQ1",119,0)
 W !!,"When you have reached MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ1",120,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ1",121,0)
 W !,"you are adding, or selected (pre-existing record)."
"RTN","MPIFQ1",122,0)
 W !!,"The MPI has returned a list of possible matches for that patient"
"RTN","MPIFQ1",123,0)
 W !,"An '*' indicates the Integration Control Number of a patient"
"RTN","MPIFQ1",124,0)
 W !,"on the list, matches one in your Patient file already."
"RTN","MPIFQ1",125,0)
 W !,"To select a patient from the list, choose SP."
"RTN","MPIFQ1",126,0)
 W !,"If the patients listed as potential matches aren't the same patient"
"RTN","MPIFQ1",127,0)
 W !,"select ADD to create a new entry on the MPI for this patient"
"RTN","MPIFQ1",128,0)
 Q
"RTN","MPIFQ1",129,0)
 ;
"RTN","MPIFQ1",130,0)
PROMPT ;
"RTN","MPIFQ1",131,0)
 W !!
"RTN","MPIFQ1",132,0)
 S DIR("A")="Hit the Enter key, to Continue "
"RTN","MPIFQ1",133,0)
 S DIR(0)="EA"
"RTN","MPIFQ1",134,0)
 D ^DIR
"RTN","MPIFQ1",135,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",136,0)
 Q
"RTN","MPIFQ1",137,0)
PROMPT1() ;
"RTN","MPIFQ1",138,0)
 N DIR,X,Y
"RTN","MPIFQ1",139,0)
 W !
"RTN","MPIFQ1",140,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO "
"RTN","MPIFQ1",141,0)
 S DIR(0)="YA"
"RTN","MPIFQ1",142,0)
 D ^DIR
"RTN","MPIFQ1",143,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",144,0)
 Q Y
"RTN","MPIFQ1",145,0)
HERESSN(SSN) ;
"RTN","MPIFQ1",146,0)
 N DFN
"RTN","MPIFQ1",147,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ1",148,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ1",149,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ1",150,0)
 Q DFN
"RTN","MPIFQ1",151,0)
 ;
"RTN","MPIFQ1",152,0)
CHECK(DFN) ;
"RTN","MPIFQ1",153,0)
 N CHECK
"RTN","MPIFQ1",154,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ1",155,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ1",156,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ1",157,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ1",158,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ1",159,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ1",160,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ1",161,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ1",162,0)
 Q 1
"RTN","MPIFQ1",163,0)
 ;
"RTN","MPIFQ1",164,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",165,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",166,0)
 Q
"RTN","MPIFQUE3")
0^9^B51410453
"RTN","MPIFQUE3",1,0)
MPIFQUE3 ;SF/TNV-Generate Batch message for comparison of CMOR score ;FEB 27, 1998
"RTN","MPIFQUE3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFQUE3",3,0)
 ;
"RTN","MPIFQUE3",4,0)
COMP ; Create a batch CMOR request for comparing the CMOR score with the owner
"RTN","MPIFQUE3",5,0)
 ; of this patient. This will be for ALL CMOR SITES. (NOT ONE SITE)
"RTN","MPIFQUE3",6,0)
 ;
"RTN","MPIFQUE3",7,0)
 N DIRUT
"RTN","MPIFQUE3",8,0)
 S DIR("A")="This process will take a while to complete. Are you sure? "
"RTN","MPIFQUE3",9,0)
 S DIR("B")="NO",DIR(0)="YAO" D ^DIR K DIR Q:$D(DIRUT)
"RTN","MPIFQUE3",10,0)
 I Y=0 K DIR Q                           ; no go
"RTN","MPIFQUE3",11,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^")'="" S $P(^("COMP"),"^")=""
"RTN","MPIFQUE3",12,0)
TASK ; Task this job to run
"RTN","MPIFQUE3",13,0)
 S ZTIO="",ZTRTN="EN^MPIFQUE3",ZTSAVE("DUZ")=""
"RTN","MPIFQUE3",14,0)
 S ZTDESC="GENERATE CMOR COMPARISON PROCESS"
"RTN","MPIFQUE3",15,0)
 D ^%ZTLOAD
"RTN","MPIFQUE3",16,0)
 I $D(ZTSK) W "   Task#, ",ZTSK," queued" S $P(^RGSITE(991.8,1,"COMP"),U,5)=ZTSK
"RTN","MPIFQUE3",17,0)
 ;
"RTN","MPIFQUE3",18,0)
KILL ; Clean up the partition
"RTN","MPIFQUE3",19,0)
 K DIR,ZTSK,Y,ZTIO,ZTRTN,ZTDESC,ZTSAVE
"RTN","MPIFQUE3",20,0)
 Q
"RTN","MPIFQUE3",21,0)
 ;
"RTN","MPIFQUE3",22,0)
EN ; Entry point for CMOR Batch comparison.  This should only be run after
"RTN","MPIFQUE3",23,0)
 ; the initialization to the MPI has been completed.
"RTN","MPIFQUE3",24,0)
 N U,SITE,NODE,MPI,MTIEN,MPILOOP,DTNOW,MSGCOUNT,LINCOUNT,RGLOG
"RTN","MPIFQUE3",25,0)
 S U="^",(MPILOOP,SITE)="",MPISTOP=0
"RTN","MPIFQUE3",26,0)
 D START^RGHLLOG()
"RTN","MPIFQUE3",27,0)
 N X,Y,DIC
"RTN","MPIFQUE3",28,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+DUZ
"RTN","MPIFQUE3",29,0)
 D ^DIC
"RTN","MPIFQUE3",30,0)
 I $G(Y)<1 S MPINAME=""
"RTN","MPIFQUE3",31,0)
 I $G(Y)>0 S MPINAME=$G(Y(0,0))
"RTN","MPIFQUE3",32,0)
 ; If the job has manually stopped status it should restart at where
"RTN","MPIFQUE3",33,0)
 ; it left off
"RTN","MPIFQUE3",34,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),U,4)="MS" D
"RTN","MPIFQUE3",35,0)
 . I $P($G(^RGSITE(991.8,1,"COMP")),U)="" S $P(^("COMP"),U,4)="C" Q  ; Not logical restart from the top
"RTN","MPIFQUE3",36,0)
 . S NODE=$$MPINODE^MPIFAPI(+$P(^RGSITE(991.8,1,"COMP"),U))
"RTN","MPIFQUE3",37,0)
 . S CMOR=$P(NODE,U,3)   ; CMOR of the last patient
"RTN","MPIFQUE3",38,0)
 . I +CMOR>0 S SITE=$O(^DPT("ACMOR",CMOR),-1)                        ; Back up one level
"RTN","MPIFQUE3",39,0)
 . I +CMOR>0 S MPILOOP=+$P(^RGSITE(991.8,1,"COMP"),U)                ; Marked the last patient
"RTN","MPIFQUE3",40,0)
 . I +CMOR<1 S (SITE,MPILOOP)=0
"RTN","MPIFQUE3",41,0)
 . K CMOR
"RTN","MPIFQUE3",42,0)
 ; If the job has completed status it should restart at the top
"RTN","MPIFQUE3",43,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),U,4)="C" S $P(^("COMP"),U)=""
"RTN","MPIFQUE3",44,0)
 ; Start the job
"RTN","MPIFQUE3",45,0)
 S ^XTMP("RGVCCMR","@@@@","DFNCOUNT")=0          ; set for counter in CALC^RGVCCMR2
"RTN","MPIFQUE3",46,0)
 D NOW^%DTC S Y=X X ^DD("DD") S DTNOW=Y          ; get current date and time
"RTN","MPIFQUE3",47,0)
 S $P(^RGSITE(991.8,1,"COMP"),U,2)=%             ; timestamp the job
"RTN","MPIFQUE3",48,0)
 S $P(^RGSITE(991.8,1,"COMP"),U,4)="R"           ; mark the status as running
"RTN","MPIFQUE3",49,0)
 S $P(^RGSITE(991.8,1,"COMP"),U,6)="N"           ; reset the flag
"RTN","MPIFQUE3",50,0)
 N RGDFN,CALDT,NODE
"RTN","MPIFQUE3",51,0)
 F  S SITE=$O(^DPT("ACMOR",SITE)) Q:SITE=""  D   ; Get the site CMOR on file
"RTN","MPIFQUE3",52,0)
 . Q:MPISTOP=1                                   ; Trouble occured, user wanted to stop
"RTN","MPIFQUE3",53,0)
 . I +SITE=+$$SITE^VASITE() Q                    ; Don't process your own
"RTN","MPIFQUE3",54,0)
 . D HDR                                         ; Create batch for each site
"RTN","MPIFQUE3",55,0)
 . F  S MPILOOP=$O(^DPT("ACMOR",+SITE,MPILOOP)) Q:MPILOOP=""  D  Q:MPISTOP=1  ; Start with DFN and go
"RTN","MPIFQUE3",56,0)
 . . S DFN=+MPILOOP Q:DFN<0
"RTN","MPIFQUE3",57,0)
 . . S NODE=$$MPINODE^MPIFAPI(DFN) Q:+NODE<1    ; Was not CIRN'ed
"RTN","MPIFQUE3",58,0)
 . . I $G(^DPT(DFN,.35)),$P($G(^DPT(DFN,.35)),"^")'="" Q  ; Death patient
"RTN","MPIFQUE3",59,0)
 . . I $P(NODE,"^")="" D LOG Q     ; Log exception if no ICN
"RTN","MPIFQUE3",60,0)
 . . I $P(NODE,"^",6)="" Q   ;No score
"RTN","MPIFQUE3",61,0)
 . . S CALDT=$P(NODE,"^",7)   ; current calc date
"RTN","MPIFQUE3",62,0)
 . . S X="T-90" D ^%DT
"RTN","MPIFQUE3",63,0)
 . . I CALDT<Y S RGDFN=DFN D CALC^RGVCCMR2   ; score is older than 90 days
"RTN","MPIFQUE3",64,0)
 . . S $P(^RGSITE(991.8,1,"COMP"),U)=+DFN        ; mark that patient as done
"RTN","MPIFQUE3",65,0)
 . . D INDV
"RTN","MPIFQUE3",66,0)
 . . I MSGCOUNT>99 D SEND D HDR                   ; send out if over 100 messages
"RTN","MPIFQUE3",67,0)
 . . I $P($G(^RGSITE(991.8,1,"COMP")),U,6)="Y" S MPISTOP=1 D SEND Q
"RTN","MPIFQUE3",68,0)
 . D SEND
"RTN","MPIFQUE3",69,0)
 ;
"RTN","MPIFQUE3",70,0)
 ; if user asked to stop set flag = yes and status to MS
"RTN","MPIFQUE3",71,0)
 ; if naturally stop set status to SN
"RTN","MPIFQUE3",72,0)
 I MPISTOP=1 S $P(^RGSITE(991.8,1,"COMP"),U,6)="Y",$P(^("COMP"),U,4)="MS"
"RTN","MPIFQUE3",73,0)
 E  S $P(^RGSITE(991.8,1,"COMP"),U,4)="C"
"RTN","MPIFQUE3",74,0)
 D NOW^%DTC S $P(^RGSITE(991.8,1,"COMP"),U,3)=%  ; timestamp when it stop
"RTN","MPIFQUE3",75,0)
 D CLEAN
"RTN","MPIFQUE3",76,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE3",77,0)
 Q
"RTN","MPIFQUE3",78,0)
 ;
"RTN","MPIFQUE3",79,0)
HDR ; Create HL7 batch HEADER message to each of the CMOR site
"RTN","MPIFQUE3",80,0)
 K ^TMP("HLS",$J)
"RTN","MPIFQUE3",81,0)
 D INIT^HLFNC2("MPIF CMOR COMPARISON SERVER",.HL)
"RTN","MPIFQUE3",82,0)
 I $D(HL)=1 D EXC^RGHLLOG(220,"Error Returned in INIT^HLFNC2") K HL S MPISTOP=1 Q
"RTN","MPIFQUE3",83,0)
 D CREATE^HLTF(.HLMID,.MTIEN,.HLDT,.HLDT1)
"RTN","MPIFQUE3",84,0)
 I $D(MTIEN)="" D EXC^RGHLLOG(220,"Error Returned in CREATE^HLTF") K HLMID,HLDT,HLDT1 S MPISTOP=1 Q
"RTN","MPIFQUE3",85,0)
 S LINCOUNT=0                            ; Set line counter
"RTN","MPIFQUE3",86,0)
 S MSGCOUNT=1                            ; Set counter for 100 message per batch
"RTN","MPIFQUE3",87,0)
 Q
"RTN","MPIFQUE3",88,0)
 ;
"RTN","MPIFQUE3",89,0)
INDV ; Create individual message of the HL7 ADT-A31 batch message
"RTN","MPIFQUE3",90,0)
 ; EVN segment = event, date, CMOR score, requestor name
"RTN","MPIFQUE3",91,0)
 ; PID segment = standard call
"RTN","MPIFQUE3",92,0)
 ; NTE segment = Reason CMOR COMPARISON, site requested
"RTN","MPIFQUE3",93,0)
 D INIT^HLFNC2("MPIF CMOR COMPARISON SERVER",.HL)  ; Because HL7 did not know
"RTN","MPIFQUE3",94,0)
 S HL("SAF")=$P($$SITE^VASITE,"^",3)       ; the facility # when dynamic
"RTN","MPIFQUE3",95,0)
 ;                                              address of batch. This needs
"RTN","MPIFQUE3",96,0)
 ;                                              to be set. Until HL7 fixs it
"RTN","MPIFQUE3",97,0)
 S MPIID=HLMID_"-"_MSGCOUNT
"RTN","MPIFQUE3",98,0)
 D MSH^HLFNC2(.HL,MPIID,.MPI)
"RTN","MPIFQUE3",99,0)
 N NODE
"RTN","MPIFQUE3",100,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",101,0)
 S ^TMP("HLS",$J,LINCOUNT)=MPI
"RTN","MPIFQUE3",102,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",103,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIFQUE3",104,0)
 Q:+NODE<1
"RTN","MPIFQUE3",105,0)
 S ^TMP("HLS",$J,LINCOUNT)="EVN"_HL("FS")_"A31"_HL("FS")_$P(NODE,"^",7)_HL("FS")_$P(NODE,U,6)_HL("FS")_MPINAME
"RTN","MPIFQUE3",106,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",107,0)
 S ^TMP("HLS",$J,LINCOUNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFQUE3",108,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",109,0)
 ;this is the request to the site for a comparison
"RTN","MPIFQUE3",110,0)
 S ^TMP("HLS",$J,LINCOUNT)="NTE"_HL("FS")_"COMPARISON"_HL("FS")_$P($$SITE^VASITE(),U,3)
"RTN","MPIFQUE3",111,0)
 S MSGCOUNT=MSGCOUNT+1
"RTN","MPIFQUE3",112,0)
 Q
"RTN","MPIFQUE3",113,0)
 ;
"RTN","MPIFQUE3",114,0)
SEND ; Send out the batch message
"RTN","MPIFQUE3",115,0)
 N RESLT
"RTN","MPIFQUE3",116,0)
 D GENERATE^HLMA("MPIF CMOR COMPARISON SERVER","GB",1,.RESLT,MTIEN)
"RTN","MPIFQUE3",117,0)
 I $P(RESLT,U,2)'="" D EXC^RGHLLOG(220,"Error Returned in GENERATE^HLMA "_$P(RESLT,U,2)) S MPISTOP=1
"RTN","MPIFQUE3",118,0)
 Q
"RTN","MPIFQUE3",119,0)
 ;
"RTN","MPIFQUE3",120,0)
LOGIC ; This is where the dynamic address located. 
"RTN","MPIFQUE3",121,0)
 ; ** Routing logic field in Protocol file is being used
"RTN","MPIFQUE3",122,0)
 ; instead of GET^HLSUB.
"RTN","MPIFQUE3",123,0)
 ; For now, I have to hard set the receiving logical link, intercept
"RTN","MPIFQUE3",124,0)
 ; the message before it send out, figure out the receiving Logical
"RTN","MPIFQUE3",125,0)
 ; link from the MSH segment and let the Routing logic create the
"RTN","MPIFQUE3",126,0)
 ; HLL("LINKS") array.
"RTN","MPIFQUE3",127,0)
 N RESLT
"RTN","MPIFQUE3",128,0)
 K RGL,RESLT
"RTN","MPIFQUE3",129,0)
 D LINK^HLUTIL3(SITE,.RGL)               ; get the logical link to that institution
"RTN","MPIFQUE3",130,0)
 S INSTITU=$O(RGL(0))
"RTN","MPIFQUE3",131,0)
 I INSTITU<1 Q                           ; if there is no logical link
"RTN","MPIFQUE3",132,0)
 I $E($G(RGL(INSTITU)),1,2)'="VA" D
"RTN","MPIFQUE3",133,0)
 .D START^RGHLLOG()
"RTN","MPIFQUE3",134,0)
 .D EXC^RGHLLOG(224,"Can't send CMOR Comparison message to site, due to non-CIRN logical link for site "_INSTITU)
"RTN","MPIFQUE3",135,0)
 .D STOP^RGHLLOG()
"RTN","MPIFQUE3",136,0)
 .S RESLT=1
"RTN","MPIFQUE3",137,0)
 Q:$D(RESLT)
"RTN","MPIFQUE3",138,0)
 S HLL("LINKS",1)="MPIF CMOR COMPARISON CLIENT"_HL("FS")_RGL(INSTITU)
"RTN","MPIFQUE3",139,0)
 K INSTITU,RGL
"RTN","MPIFQUE3",140,0)
 Q
"RTN","MPIFQUE3",141,0)
 ;
"RTN","MPIFQUE3",142,0)
CLEAN ; Clean up the partition
"RTN","MPIFQUE3",143,0)
 K %,X,Y,MPISTOP,MPINAME,DFN,MPIID
"RTN","MPIFQUE3",144,0)
 K ^XTMP("HLS",$J)
"RTN","MPIFQUE3",145,0)
 Q
"RTN","MPIFQUE3",146,0)
 ;
"RTN","MPIFQUE3",147,0)
LOG ; Log exception for non ICN but CMOR belong to someone else
"RTN","MPIFQUE3",148,0)
 N NAME,SSN,RGLOG,TEXT
"RTN","MPIFQUE3",149,0)
 S XMCHAN=1,NAME=$P(^DPT(DFN,0),"^",1),SSN=$P(^(0),"^",9)
"RTN","MPIFQUE3",150,0)
 S TEXT="This patient "_NAME_" ssn# "_SSN_" is missing the ICN. Log a NOIS regarding this missing ICN."
"RTN","MPIFQUE3",151,0)
 D EXC^RGHLLOG(219,TEXT,DFN)
"RTN","MPIFQUE3",152,0)
 K XMCHAN
"RTN","MPIFQUE3",153,0)
 Q
"RTN","MPIFQUE3",154,0)
 ;
"RTN","MPIFQUE3",155,0)
STOP ; Stop/Restart the CMOR Comparison process
"RTN","MPIFQUE3",156,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^",4)'="R" D  Q
"RTN","MPIFQUE3",157,0)
 . S DIR("A")="Do you want to RESTART this CMOR Comparison process"
"RTN","MPIFQUE3",158,0)
 . S DIR("B")="N",DIR(0)="Y" D ^DIR
"RTN","MPIFQUE3",159,0)
 . I $G(Y)=1 D TASK
"RTN","MPIFQUE3",160,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^",4)="R" D  Q
"RTN","MPIFQUE3",161,0)
 . W !
"RTN","MPIFQUE3",162,0)
 . S DIR("A")="Do you want to stop CMOR Comparison process after the current patient"
"RTN","MPIFQUE3",163,0)
 . S DIR("B")="N",DIR(0)="Y" D ^DIR
"RTN","MPIFQUE3",164,0)
 . I $G(Y)=1 S $P(^RGSITE(991.8,1,"COMP"),"^",6)="Y"
"RTN","MPIFQUE3",165,0)
 Q
"RTN","MPIFQUE3",166,0)
 ;
"RTN","MPIFQUE3",167,0)
STATUS ; Where is the process right now?
"RTN","MPIFQUE3",168,0)
 N IEN,NAME,SSN,STATUS,Y
"RTN","MPIFQUE3",169,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^",5)="" W !,"The CMOR Comparison process HAS NEVER been tasked" Q
"RTN","MPIFQUE3",170,0)
 W !,"The CMOR Comparison process has been tasked with task # ",$P($G(^RGSITE(991.8,1,"COMP")),"^",5),". The"
"RTN","MPIFQUE3",171,0)
 S STATUS=$P($G(^RGSITE(991.8,1,"COMP")),"^",4)
"RTN","MPIFQUE3",172,0)
 W !,"process ",$S(STATUS="R":"is currently running",STATUS="MS":"was manually stopped",STATUS="C":"has completed",1:"")
"RTN","MPIFQUE3",173,0)
 I (STATUS="C")!(STATUS="MS") S Y=$P($G(^RGSITE(991.8,1,"COMP")),"^",3) X ^DD("DD") W " on ",Y
"RTN","MPIFQUE3",174,0)
 S IEN=$P($G(^RGSITE(991.8,1,"COMP")),"^")
"RTN","MPIFQUE3",175,0)
 I IEN'="" D
"RTN","MPIFQUE3",176,0)
 .S NAME=$P($G(^DPT(+IEN,0)),"^"),SSN=$P($G(^(0)),"^",9)
"RTN","MPIFQUE3",177,0)
 .S CMOR=$P($G(^DPT(+IEN,"MPI")),"^",3)
"RTN","MPIFQUE3",178,0)
 .S CMOR=$P($$NNT^XUAF4(CMOR),"^")
"RTN","MPIFQUE3",179,0)
 .W " and the last patient",!,"was ",NAME," ssn # ",SSN," CMOR= ",CMOR
"RTN","MPIFQUE3",180,0)
 Q
"RTN","MPIFQUE3",181,0)
 ;
"RTN","MPIFQUE4")
0^7^B48055957
"RTN","MPIFQUE4",1,0)
MPIFQUE4 ;SF/TNV-Process the CMOR COMPARISON request ;FEB 25, 1998
"RTN","MPIFQUE4",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFQUE4",3,0)
 ; 
"RTN","MPIFQUE4",4,0)
 ; This routine will process the batch message from the sending CMOR
"RTN","MPIFQUE4",5,0)
 ; who wished to change the patient CMOR from you to their own.
"RTN","MPIFQUE4",6,0)
 ; PLEASE NOTE THAT THIS PROCESS WILL NOT BE TRACKED AS CMOR REQUEST
"RTN","MPIFQUE4",7,0)
 ; EVENT. SO NOTHING WILL BE RECORDED IN THAT FILE. (PER SRS 9-18-97)
"RTN","MPIFQUE4",8,0)
 ; Approving process:
"RTN","MPIFQUE4",9,0)
 ; The sender will give the CMOR score and the date for a patient
"RTN","MPIFQUE4",10,0)
 ; The receiver will look into the CMOR score on the system and compare
"RTN","MPIFQUE4",11,0)
 ; the date if the date is less than 90 days. Go and use the Current
"RTN","MPIFQUE4",12,0)
 ; CMOR score and compare. If the incoming CMOR score is 80% or more than
"RTN","MPIFQUE4",13,0)
 ; the system CMOR score. CMOR site will be changed to the requesting CMOR
"RTN","MPIFQUE4",14,0)
 ; site. An approved HL7 message will be send to ALL SITES in the
"RTN","MPIFQUE4",15,0)
 ; subscriber list and notify them the new CMOR site. MPI is included.
"RTN","MPIFQUE4",16,0)
 ; If the score is equal or greater than 90 days. CMOR score will be
"RTN","MPIFQUE4",17,0)
 ; recalulated for this patient and compare. Same process as above.
"RTN","MPIFQUE4",18,0)
 ; If the incoming CMOR score is not higher than 80% nothing will happen.
"RTN","MPIFQUE4",19,0)
BEGIN ; Entry point for CMOR COMPARISON request to process.
"RTN","MPIFQUE4",20,0)
 ; NO input or output variables
"RTN","MPIFQUE4",21,0)
 N IEN,RGLOG
"RTN","MPIFQUE4",22,0)
 K RGL
"RTN","MPIFQUE4",23,0)
 D NOW^%DTC
"RTN","MPIFQUE4",24,0)
 S ZTIO="",ZTDTH=%,ZTRTN="EN^MPIFQUE4"
"RTN","MPIFQUE4",25,0)
 S ZTDESC="BACKGROUND CMOR COMPARISON"
"RTN","MPIFQUE4",26,0)
 S ZTSAVE("HL*")=""
"RTN","MPIFQUE4",27,0)
 D ^%ZTLOAD,CLEAN
"RTN","MPIFQUE4",28,0)
 K COUNT,RGL,%,ZTIO,ZTDTH,ZTRTN,ZTDESC,ZTSAVE
"RTN","MPIFQUE4",29,0)
 Q
"RTN","MPIFQUE4",30,0)
 ;
"RTN","MPIFQUE4",31,0)
EN ; Background job to run for cmor comparison
"RTN","MPIFQUE4",32,0)
 K ERROR,MPICNT
"RTN","MPIFQUE4",33,0)
 N MPII,U,LINE,PARENT,COUNT,NDATE,IKI,MPIFFS,MPIFSFS,MPIFREAP,RGLOG
"RTN","MPIFQUE4",34,0)
 S MPIFFS=HL("FS"),MPIFSFS=$E(HL("ECH"),1),MPIFREAP=$E(HL("ECH"),2)
"RTN","MPIFQUE4",35,0)
 D START^RGHLLOG()
"RTN","MPIFQUE4",36,0)
 S U="^",(COUNT,MPICNT)=0
"RTN","MPIFQUE4",37,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0!($D(ERROR))  G:$$S^%ZTLOAD CLEAN D
"RTN","MPIFQUE4",38,0)
 . S LINE=HLNODE
"RTN","MPIFQUE4",39,0)
 . I $P(LINE,MPIFFS)["MSH" D MSH
"RTN","MPIFQUE4",40,0)
 . I $P(LINE,MPIFFS)["NTE" D NTE
"RTN","MPIFQUE4",41,0)
 . I $P(LINE,MPIFFS)["PID" D PID
"RTN","MPIFQUE4",42,0)
 . I $P(LINE,MPIFFS)["EVN" D EVN
"RTN","MPIFQUE4",43,0)
 . I COUNT=4,'$D(ERROR) D PROCES
"RTN","MPIFQUE4",44,0)
 K SERVER,CLIENT,ERROR
"RTN","MPIFQUE4",45,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE4",46,0)
 ; send msg to FORUM to note msg processed and # changed
"RTN","MPIFQUE4",47,0)
 D MAILB
"RTN","MPIFQUE4",48,0)
 Q
"RTN","MPIFQUE4",49,0)
MAILB ;
"RTN","MPIFQUE4",50,0)
 N XMY,XMDUZ
"RTN","MPIFQUE4",51,0)
 S XMSUB="MPIF CMOR COMPARE COMPLETE"
"RTN","MPIFQUE4",52,0)
 S XMTEXT="MPIFBUL("
"RTN","MPIFQUE4",53,0)
 S MPIFBUL(1)="CMOR Compare msg from site "_$G(HL("SAF"))
"RTN","MPIFQUE4",54,0)
 S MPIFBUL(2)="at site "_$P($$SITE^VASITE(),"^",2)_" has been processed"
"RTN","MPIFQUE4",55,0)
 S MPIFBUL(3)=$G(MPICNT)_" CMORs have been changed"
"RTN","MPIFQUE4",56,0)
 S XMDUZ="MPIF CC AT "_$P($$SITE^VASITE(),"^",2)
"RTN","MPIFQUE4",57,0)
 S XMY("G.MPIF EXCEPTIONS")=""
"RTN","MPIFQUE4",58,0)
 D ^XMD
"RTN","MPIFQUE4",59,0)
 K XMY,MPIFBUL,XMSUB,XMTEXT
"RTN","MPIFQUE4",60,0)
 Q
"RTN","MPIFQUE4",61,0)
 ;
"RTN","MPIFQUE4",62,0)
MSH ; Process MSH segment
"RTN","MPIFQUE4",63,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",64,0)
 Q
"RTN","MPIFQUE4",65,0)
 ;
"RTN","MPIFQUE4",66,0)
NTE ; Process NTE segment
"RTN","MPIFQUE4",67,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",68,0)
 S SITE=$P(LINE,MPIFFS,3)
"RTN","MPIFQUE4",69,0)
 I SITE="" S ERROR="Missing CMOR in message. HL7 Message # "_HLMTIEN D EXC^RGHLLOG(221,ERROR) Q
"RTN","MPIFQUE4",70,0)
 S REASON=$P(LINE,MPIFFS,2)
"RTN","MPIFQUE4",71,0)
 I REASON'="COMPARISON" S ERROR="I don't understand the reason of your request" D EXC^RGHLLOG(222,ERROR)
"RTN","MPIFQUE4",72,0)
 Q
"RTN","MPIFQUE4",73,0)
 ;
"RTN","MPIFQUE4",74,0)
PID ; Process PID segment
"RTN","MPIFQUE4",75,0)
 N NODE
"RTN","MPIFQUE4",76,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",77,0)
 S ICN=+$P(LINE,MPIFFS,3)   ; get ICN out.
"RTN","MPIFQUE4",78,0)
 I ICN="" S ERROR="Missing ICN in PID segment.  Log a NOIS regarding the missing ICN" D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE4",79,0)
 S DFN=$$IEN^MPIFNQ(ICN)                  ; get DFN of this patient
"RTN","MPIFQUE4",80,0)
 I DFN="" S ERROR="Can't Process CMOR Compare for Patient with ICN "_ICN_". ICN not at this site. HL7 Message#: "_HLMTIEN D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE4",81,0)
 S NODE=$$MPINODE^MPIFAPI(+DFN)
"RTN","MPIFQUE4",82,0)
 S CMOR=$P(NODE,"^",3)               ; get the CMOR of this patient
"RTN","MPIFQUE4",83,0)
 S SCORE=$P(NODE,U,6),NDATE=$P(NODE,U,7)
"RTN","MPIFQUE4",84,0)
 Q
"RTN","MPIFQUE4",85,0)
 ;
"RTN","MPIFQUE4",86,0)
EVN ; Process EVN segment
"RTN","MPIFQUE4",87,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",88,0)
 S X=$P(LINE,MPIFFS,3) D ^%DT S INDATE=Y
"RTN","MPIFQUE4",89,0)
 I INDATE=-1 S ERROR="CMOR score Date was missing for DFN "_DFN_" in CMOR Compare Inbound Message" D EXC^RGHLLOG(223,ERROR,DFN) Q
"RTN","MPIFQUE4",90,0)
 S INSCORE=$P($G(LINE),MPIFFS,4)
"RTN","MPIFQUE4",91,0)
 I INSCORE="" S ERROR="CMOR score was missing for DFN "_DFN_" in CMOR Compare Inbound Message" D EXC^RGHLLOG(223,ERROR,DFN)
"RTN","MPIFQUE4",92,0)
 Q
"RTN","MPIFQUE4",93,0)
 ;
"RTN","MPIFQUE4",94,0)
PROCES ; Process one complete message (MSH,PID,EVN,NTE)
"RTN","MPIFQUE4",95,0)
 N LIMIT
"RTN","MPIFQUE4",96,0)
 Q:SCORE=""!(NDATE="")    ;No score or calc date at CMOR
"RTN","MPIFQUE4",97,0)
 I $G(ERROR)]"" D CLEAN Q                ; Don't do anything if there is an error
"RTN","MPIFQUE4",98,0)
 S X="T-90" D ^%DT                       ; get the target date
"RTN","MPIFQUE4",99,0)
 I NDATE>Y D  Q                           ; RECORDED DATE is less than 90 days
"RTN","MPIFQUE4",100,0)
 . S LIMIT=$$PERCENT(INSCORE,SCORE)      ; Incoming CMOR score is above 80%
"RTN","MPIFQUE4",101,0)
 . I (LIMIT>80.5)&(INSCORE>SCORE) D CHANGE                 ; Incoming CMOR score is greater
"RTN","MPIFQUE4",102,0)
 . D CLEAN                               ; Incoming CMOR score is LESS
"RTN","MPIFQUE4",103,0)
 N RGDFN S RGDFN=DFN D CALC^RGVCCMR2                         ; Last calculation was greater than 90 days
"RTN","MPIFQUE4",104,0)
 S SCORE=$P($$MPINODE^MPIFAPI(DFN),U,6)    ; Get the latest score
"RTN","MPIFQUE4",105,0)
 S LIMIT=$$PERCENT(INSCORE,SCORE)        ; Incoming CMOR score is above 80%
"RTN","MPIFQUE4",106,0)
 I (LIMIT>80.5)&(INSCORE>SCORE) D CHANGE                   ; Incoming CMOR score is greater
"RTN","MPIFQUE4",107,0)
 D CLEAN                                 ; Incoming CMOR score is LESS than the latest score
"RTN","MPIFQUE4",108,0)
 Q
"RTN","MPIFQUE4",109,0)
 ;
"RTN","MPIFQUE4",110,0)
PERCENT(NUM1,NUM2) ; Calculate the percent difference 80% or more need for change
"RTN","MPIFQUE4",111,0)
 ; of CMOR number
"RTN","MPIFQUE4",112,0)
 N DIF
"RTN","MPIFQUE4",113,0)
 I NUM1="" S NUM1=0
"RTN","MPIFQUE4",114,0)
 I NUM2="" S NUM2=0
"RTN","MPIFQUE4",115,0)
 Q:$$MAX^XLFMTH(NUM1,NUM2)=0 0
"RTN","MPIFQUE4",116,0)
 S DIF=(100-(($$MIN^XLFMTH(NUM1,NUM2))/($$MAX^XLFMTH(NUM1,NUM2))*100))
"RTN","MPIFQUE4",117,0)
 Q DIF
"RTN","MPIFQUE4",118,0)
 ;
"RTN","MPIFQUE4",119,0)
CHANGE ; Process the change CMOR request to the new CMOR site and Send out 
"RTN","MPIFQUE4",120,0)
 ; notification to the Subscriber list and MPI.
"RTN","MPIFQUE4",121,0)
 N CHANGE,CMOR
"RTN","MPIFQUE4",122,0)
 S DIC="^DIC(4,",DIC(0)="QMOZ",X=SITE D ^DIC K DIC           ; Figure out
"RTN","MPIFQUE4",123,0)
 I Y=-1 S ERROR="CMOR Site name is not on file for Station Number "_SITE D EXC^RGHLLOG(211,ERROR,+DFN) Q            ; the CMOR site
"RTN","MPIFQUE4",124,0)
 S CMOR=Y(0,0)
"RTN","MPIFQUE4",125,0)
 S CHANGE=$$CHANGE^MPIF001(+DFN,Y(0,0))                      ; name and change
"RTN","MPIFQUE4",126,0)
 I +CHANGE<1 S ERROR="Unable to change CMOR from "_$G(CMOR)_" To "_$G(SITE)_" due to "_$P(CHANGE,"^",2) D EXC^RGHLLOG(211,ERROR,DFN) Q   ;Major problem here, unable to change the CMOR
"RTN","MPIFQUE4",127,0)
 S SERVER="MPIF CMOR RESULT SERVER",CLIENT="MPIF CMOR RESULT CLIENT"
"RTN","MPIFQUE4",128,0)
 D INIT^HLFNC2(SERVER,.HL)
"RTN","MPIFQUE4",129,0)
 I $G(HL) S ERROR=HL D EXC^RGHLLOG(220,ERROR) Q
"RTN","MPIFQUE4",130,0)
 D LINK
"RTN","MPIFQUE4",131,0)
 I $G(RESULT)=0 K RESULT Q
"RTN","MPIFQUE4",132,0)
 S HLA("HLS",1)=$$EN^VAFCPID(+DFN,"2,3,4,5,6,7,8,9,10")
"RTN","MPIFQUE4",133,0)
 S HLA("HLS",2)="EVN"_HL("FS")_"A31"_HL("FS")_INDATE_HL("FS")_INSCORE_HL("FS")_"POSTMASTER"
"RTN","MPIFQUE4",134,0)
 ;actually change the cmor
"RTN","MPIFQUE4",135,0)
 S HLA("HLS",3)="PV1"_HL("FS")_HL("FS")_HL("FS")_SITE_HL("FS")_HL("FS")_HL("FS")_$P($$NNT^XUAF4(CMOR),"^",2)
"RTN","MPIFQUE4",136,0)
 N RESLT
"RTN","MPIFQUE4",137,0)
 D GENERATE^HLMA(SERVER,"LM",1,.RESLT)
"RTN","MPIFQUE4",138,0)
 I $P(RESLT,U,2)'="" D EXC^RGHLLOG(220,"Error returned in GENERATE^HLMA  "_$P(RESLT,U,2))
"RTN","MPIFQUE4",139,0)
 K RESULT
"RTN","MPIFQUE4",140,0)
 S MPICNT=MPICNT+1 ;counting changes in CMOR
"RTN","MPIFQUE4",141,0)
 Q
"RTN","MPIFQUE4",142,0)
 ;
"RTN","MPIFQUE4",143,0)
LINK ; Give back the subscriber list in HLL(LINKS") array for this patient
"RTN","MPIFQUE4",144,0)
 N SUB,IEN,MPILINK
"RTN","MPIFQUE4",145,0)
 K RGL
"RTN","MPIFQUE4",146,0)
 S RGL(0)=""
"RTN","MPIFQUE4",147,0)
 S RESULT=0
"RTN","MPIFQUE4",148,0)
 S SUB=$P($$MPINODE^MPIFAPI(+DFN),U,5)                  ; Subscriber list
"RTN","MPIFQUE4",149,0)
 S MPILINK=$$MPILINK^MPIFAPI()
"RTN","MPIFQUE4",150,0)
 I MPILINK="" D EXC^RGHLLOG(224,"No MPI Link defined") Q
"RTN","MPIFQUE4",151,0)
 I $G(SUB)="" D  Q                                       ; If this empty
"RTN","MPIFQUE4",152,0)
 . S IEN=$$LKUP^XUAF4(SITE)
"RTN","MPIFQUE4",153,0)
 . I IEN'="" D LINK^HLUTIL3(IEN,.RGL)          ; Get the logical link to that site
"RTN","MPIFQUE4",154,0)
 . S X=$O(RGL(0))
"RTN","MPIFQUE4",155,0)
 . I X="" S ERROR="No Logical Link set up on this site "_SITE D EXC^RGHLLOG(224,ERROR) Q
"RTN","MPIFQUE4",156,0)
 . S HLL("LINKS",1)=CLIENT_U_$G(RGL(X))
"RTN","MPIFQUE4",157,0)
 . S HLL("LINKS",2)=CLIENT_U_MPILINK
"RTN","MPIFQUE4",158,0)
 . S RESULT=1
"RTN","MPIFQUE4",159,0)
 D GET^HLSUB(SUB,"",CLIENT,.HLL)
"RTN","MPIFQUE4",160,0)
 S RESULT=1,HLL("LINKS",9999)=CLIENT_U_MPILINK
"RTN","MPIFQUE4",161,0)
 Q
"RTN","MPIFQUE4",162,0)
 ;
"RTN","MPIFQUE4",163,0)
CLEAN ; Clean up the partition and ready for the next message
"RTN","MPIFQUE4",164,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE4",165,0)
 K RGL,EVENT,SITE,REASON,ICN,DFN,CMOR,SCORE,X,Y,INDATE,INSCORE
"RTN","MPIFQUE4",166,0)
 S COUNT=0
"RTN","MPIFQUE4",167,0)
 Q
"RTN","MPIFQUE5")
0^16^B8627708
"RTN","MPIFQUE5",1,0)
MPIFQUE5 ;SF/TNV-Process the RESULT from CMOR COMPARISON request ;FEB 20, 1998
"RTN","MPIFQUE5",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFQUE5",3,0)
 ; 
"RTN","MPIFQUE5",4,0)
 ; This routine will process the message from the CMOR site
"RTN","MPIFQUE5",5,0)
 ; who agreed to change the patient CMOR from his to you.
"RTN","MPIFQUE5",6,0)
 ; PLEASE NOTE THAT THIS PROCESS WILL NOT BE TRACKED AS CMOR REQUEST
"RTN","MPIFQUE5",7,0)
 ; EVENT. SO NOTHING WILL BE RECORDED IN THAT FILE. (PER SRS 9-18-97)
"RTN","MPIFQUE5",8,0)
 ; Now you are the CMOR site for this patient.
"RTN","MPIFQUE5",9,0)
 ;
"RTN","MPIFQUE5",10,0)
EN ; Entry point for process the update of CMOR
"RTN","MPIFQUE5",11,0)
 N U,LINE,IKI,ERROR,RGL,RGLOG
"RTN","MPIFQUE5",12,0)
 ; After being called from the Inbound Filler, this part was executed to
"RTN","MPIFQUE5",13,0)
 ; update the CMOR for this patient and an ack message to send back if requested.
"RTN","MPIFQUE5",14,0)
 S U="^",ACK="NO"
"RTN","MPIFQUE5",15,0)
 D START^RGHLLOG()
"RTN","MPIFQUE5",16,0)
 ;
"RTN","MPIFQUE5",17,0)
 N MPII,U,LINE,ERROR,PARENT,COUNT,NDATE,IKI,MPIFFS,MPIFSFS,MPIFREAP,RGLOG
"RTN","MPIFQUE5",18,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  G:$$S^%ZTLOAD ACK D
"RTN","MPIFQUE5",19,0)
 . S LINE=HLNODE
"RTN","MPIFQUE5",20,0)
 . I $P(LINE,HL("FS"))["MSH" D MSH
"RTN","MPIFQUE5",21,0)
 . I $P(LINE,HL("FS"))["PV1" D PV1
"RTN","MPIFQUE5",22,0)
 . I $P(LINE,HL("FS"))["PID" D PID
"RTN","MPIFQUE5",23,0)
 I $G(ERROR)]"" D ACK Q          ; Any problems before changing the CMOR
"RTN","MPIFQUE5",24,0)
 I ($G(SITE)]"")&($G(DFN)]"") D CHANGE
"RTN","MPIFQUE5",25,0)
 I $G(ERROR)]"" D ACK          ; Any problems after changing the CMOR
"RTN","MPIFQUE5",26,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE5",27,0)
 Q
"RTN","MPIFQUE5",28,0)
 ;
"RTN","MPIFQUE5",29,0)
MSH ; Process MSH segment
"RTN","MPIFQUE5",30,0)
 I $P(LINE,HL("FS"),16)="AL" S ACK="YES"
"RTN","MPIFQUE5",31,0)
 I $P(LINE,HL("FS"),16)="ER" S ACK="ERROR"
"RTN","MPIFQUE5",32,0)
 Q
"RTN","MPIFQUE5",33,0)
 ;
"RTN","MPIFQUE5",34,0)
PV1 ; Process PV1 segment
"RTN","MPIFQUE5",35,0)
 S SITE=$P(LINE,HL("FS"),4)
"RTN","MPIFQUE5",36,0)
 I SITE="" S ERROR="Missing CMOR site number" D EXC^RGHLLOG(221,ERROR)
"RTN","MPIFQUE5",37,0)
 Q
"RTN","MPIFQUE5",38,0)
NTE ; Process NTE segment
"RTN","MPIFQUE5",39,0)
 S SITE=$P(LINE,HL("FS"),8)
"RTN","MPIFQUE5",40,0)
 I SITE="" S ERROR="Missing CMOR site number" D EXC^RGHLLOG(221,ERROR)
"RTN","MPIFQUE5",41,0)
 Q
"RTN","MPIFQUE5",42,0)
 ;
"RTN","MPIFQUE5",43,0)
PID ; Process PID segment
"RTN","MPIFQUE5",44,0)
 S ICN=+$P(LINE,HL("FS"),3)                  ; get ICN out.
"RTN","MPIFQUE5",45,0)
 I ICN<1 S ERROR="Missing Patient Integration Control Number.  Log a NOIS regarding missing ICN." D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE5",46,0)
 S DFN=$$IEN^MPIFNQ(ICN)                  ; get DFN of this patient
"RTN","MPIFQUE5",47,0)
 I DFN="" S ERROR="Patient is not on file at this site for ICN "_ICN_". Log a NOIS regarding ICN not found." D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE5",48,0)
 Q
"RTN","MPIFQUE5",49,0)
 ;
"RTN","MPIFQUE5",50,0)
CHANGE ; Process the change CMOR to the new CMOR site (YOUR SITE NOW)
"RTN","MPIFQUE5",51,0)
 S DIC="^DIC(4,",DIC(0)="QMOZX",X=SITE D ^DIC K DIC          ; Figure out
"RTN","MPIFQUE5",52,0)
 I Y=-1 S ERROR="CMOR Site name is not on file for Station Number "_SITE D EXC^RGHLLOG(211,ERROR) Q            ; the CMOR site
"RTN","MPIFQUE5",53,0)
 S CHANGE=$$CHANGE^MPIF001(+DFN,+Y)              ; name and change
"RTN","MPIFQUE5",54,0)
 I +CHANGE=-1 S ERROR="Unable to update CMOR for site "_SITE_". For DFN "_DFN D EXC^RGHLLOG(211,ERROR,DFN)
"RTN","MPIFQUE5",55,0)
 Q
"RTN","MPIFQUE5",56,0)
 ;
"RTN","MPIFQUE5",57,0)
ACK ; Create ACK to send back and Clean up the partition.
"RTN","MPIFQUE5",58,0)
 ;
"RTN","MPIFQUE5",59,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE5",60,0)
 K X,Y,DFN,ICN,SITE,MPIFREAP,ACK,PARENT,CHANGE
"RTN","MPIFQUE5",61,0)
 Q
"RTN","MPIFREQ")
0^11^B15813923
"RTN","MPIFREQ",1,0)
MPIFREQ ;BHM/RGY,LTL-Process a CMOR request from CIRN demon ;FEB 20, 1998
"RTN","MPIFREQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFREQ",3,0)
EN(TYPE,REQNO,ERROR,HL7) ;
"RTN","MPIFREQ",4,0)
 NEW RGL,INST,USER,REASON,NDATE,ICN,PHONE,N0,CNT,HLA,HL,ID,X
"RTN","MPIFREQ",5,0)
 S CNT=0,HL=0
"RTN","MPIFREQ",6,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFREQ",7,0)
 I N0="" S ERROR="Node for request #"_REQNO_" is not defined" Q
"RTN","MPIFREQ",8,0)
 S INST=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFREQ",9,0)
 N X,Y,DIC
"RTN","MPIFREQ",10,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFREQ",11,0)
 D ^DIC
"RTN","MPIFREQ",12,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFREQ",13,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFREQ",14,0)
 S REASON=$P($G(^MPIF(984.9,REQNO,1)),"^",2)
"RTN","MPIFREQ",15,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFREQ",16,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFREQ",17,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFREQ",18,0)
 S ID=$P(N0,"^")
"RTN","MPIFREQ",19,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFREQ",20,0)
 I HL S ERROR=HL Q
"RTN","MPIFREQ",21,0)
 D LINK^HLUTIL3($P(N0,"^",7),.RGL)
"RTN","MPIFREQ",22,0)
 S X=$O(RGL(0))
"RTN","MPIFREQ",23,0)
 I X>0,$E($G(RGL(X)),1,2)'="VA" D START^RGHLLOG(),EXC^RGHLLOG(224,"Unable to send Request to change CMOR request#"_REQNO_"  No a CIRN logical link for site "_X),STOP^RGHLLOG() Q
"RTN","MPIFREQ",24,0)
 I X>0 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_RGL(X)
"RTN","MPIFREQ",25,0)
 S CNT=CNT+1,X=$$EN^VAFHLPID(+$P(N0,"^",4),"2,3,5"),$P(X,"^",3)=ICN
"RTN","MPIFREQ",26,0)
 S HLA("HLS",CNT)=X
"RTN","MPIFREQ",27,0)
 S CNT=CNT+1
"RTN","MPIFREQ",28,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST
"RTN","MPIFREQ",29,0)
 S CNT=CNT+1
"RTN","MPIFREQ",30,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFREQ",31,0)
 N RLST
"RTN","MPIFREQ",32,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFREQ",33,0)
 I 'RLST S ERROR=RLST
"RTN","MPIFREQ",34,0)
 Q
"RTN","MPIFREQ",35,0)
IN(INST,USER,REASON,NDATE,ICN,PHONE,ID) ;Process an incoming CMOR request
"RTN","MPIFREQ",36,0)
 NEW PATIEN,MAIL,MPIF,TYPE,N0,IEN,XMCHAN,XMDUZ,XMTEXT,XMSUB,XMY,TEXT,X
"RTN","MPIFREQ",37,0)
 S PATIEN=$$IEN^MPIFNQ(ICN)
"RTN","MPIFREQ",38,0)
 I PATIEN<1 D  K Y Q
"RTN","MPIFREQ",39,0)
 . I $G(^RGHL7(991.11,0))="" Q   ; No way to log this exception
"RTN","MPIFREQ",40,0)
 . S DIC="^RGHL7(991.11,",DIC(0)="MNOZ",X=210 D ^DIC K DIC
"RTN","MPIFREQ",41,0)
 . I Y=-1 D ERR^RGHLLOG("","") Q        ; This type of error is not define, log as Unclassified exception
"RTN","MPIFREQ",42,0)
 . D START^RGHLLOG()
"RTN","MPIFREQ",43,0)
 . S XMCHAN=1,TEXT=^RGHL7(991.11,+Y,10)_" with ICN # :"_ICN
"RTN","MPIFREQ",44,0)
 . D EXC^RGHLLOG(+Y,TEXT)            ; Log this error as 210 type
"RTN","MPIFREQ",45,0)
 . K XMCHAN
"RTN","MPIFREQ",46,0)
 . D STOP^RGHLLOG()
"RTN","MPIFREQ",47,0)
 ; Good to process 
"RTN","MPIFREQ",48,0)
 S IEN=$$ADD^MPIFNEW(ID)
"RTN","MPIFREQ",49,0)
 S TYPE=$S(+$$SITE^VASITE()=$$PAT^MPIFNQ(PATIEN):1,1:3)
"RTN","MPIFREQ",50,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR="[MPIF REQUEST INCOMING]" D ^DIE
"RTN","MPIFREQ",51,0)
 I $$AUTO^MPIFNQ() D AUTO(IEN) Q
"RTN","MPIFREQ",52,0)
 S MAIL=$$MAIL^MPIFUTL()
"RTN","MPIFREQ",53,0)
 I MAIL]"" D
"RTN","MPIFREQ",54,0)
 .S XMDUZ="MPI VISTA Package",XMTEXT="MPIF(1,",MPIF(1,1)="New CIRN Master Of Record (CMOR) request received for patient "_$S($P($G(^DPT(+PATIEN,0)),U)]"":$P(^DPT(PATIEN,0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",1:"UNKNOWN")
"RTN","MPIFREQ",55,0)
 .S XMSUB=$P(^MPIF(984.9,IEN,0),"^"),XMY("G."_MAIL)="" D ^XMD
"RTN","MPIFREQ",56,0)
 .Q
"RTN","MPIFREQ",57,0)
 Q
"RTN","MPIFREQ",58,0)
AUTO(REQNO) ;Process a request automatically
"RTN","MPIFREQ",59,0)
 NEW DFN,ERROR,DIE,DR,DA,CMOR,RES
"RTN","MPIFREQ",60,0)
 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW AUTO]",DA=REQNO D ^DIE
"RTN","MPIFREQ",61,0)
 D EN^RGEQ("MPIF RESULT",REQNO)
"RTN","MPIFREQ",62,0)
 S DFN=$P($G(^MPIF(984.9,REQNO,0)),"^",4)
"RTN","MPIFREQ",63,0)
 S CMOR=$$CMORNAME^MPIF001($P(^MPIF(984.9,REQNO,0),"^",7))
"RTN","MPIFREQ",64,0)
 I +CMOR=-1 D START^RGHLLOG(),EXC^RGHLLOG(220,"CMOR not sent in Change CMOR message for patient DFN= "_DFN,DFN)
"RTN","MPIFREQ",65,0)
 Q:+CMOR=-1      ;No CMOR defined
"RTN","MPIFREQ",66,0)
 I $P($G(^MPIF(984.9,REQNO,1)),"^",3)=1 D
"RTN","MPIFREQ",67,0)
 .S RES=1,RES=$$CHANGE^MPIF001(DFN,CMOR)
"RTN","MPIFREQ",68,0)
 .I +RES<1 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_CMOR_" in a CMOR Change Message for Patient DFN= "_DFN,DFN),STOP^RGHLLOG()
"RTN","MPIFREQ",69,0)
 .Q:+RES<1
"RTN","MPIFREQ",70,0)
 .D BROAD^MPIFCMOR(REQNO)
"RTN","MPIFREQ",71,0)
 Q
"RTN","MPIFRES")
0^3^B8842645
"RTN","MPIFRES",1,0)
MPIFRES ;SF/CMC-LOCAL AND MISSING ICN RESOLUTION ;JUL 13, 1998
"RTN","MPIFRES",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFRES",3,0)
 ;
"RTN","MPIFRES",4,0)
BKG ;
"RTN","MPIFRES",5,0)
 S ZTRTN="GO^MPIFRES",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFRES",6,0)
 D NOW^%DTC
"RTN","MPIFRES",7,0)
 S ZTIO="",ZTDTH=%
"RTN","MPIFRES",8,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFRES",9,0)
 D ^%ZTLOAD
"RTN","MPIFRES",10,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFRES",11,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFRES",12,0)
 Q
"RTN","MPIFRES",13,0)
 ;
"RTN","MPIFRES",14,0)
GO ;ENTRY POINT
"RTN","MPIFRES",15,0)
 N MPIMORE,MPITOT
"RTN","MPIFRES",16,0)
 L +^XTMP("MPIF RESOLUTION"):3 E  Q
"RTN","MPIFRES",17,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFRES",18,0)
 ;
"RTN","MPIFRES",19,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",20,0)
 D START^RGHLLOG()
"RTN","MPIFRES",21,0)
 D HLRDF,LOOP
"RTN","MPIFRES",22,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFRES",23,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFRES",24,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIHL,MPIMIDT,MPIMSH
"RTN","MPIFRES",25,0)
 K MPIOUT,MPIQRYNM,MPISEQ,QCNT,MPIMCNT,MPIMTX,ENDT,MPIFRES
"RTN","MPIFRES",26,0)
 L -^XTMP("MPIF RESOLUTION")
"RTN","MPIFRES",27,0)
 Q
"RTN","MPIFRES",28,0)
 ;
"RTN","MPIFRES",29,0)
HLRDF ;
"RTN","MPIFRES",30,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFRES",31,0)
 S MPIHL("ECH")="^~\&"
"RTN","MPIFRES",32,0)
 S MPIHL("FS")="|"
"RTN","MPIFRES",33,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.MPIHL)
"RTN","MPIFRES",34,0)
 I $O(MPIHL("")) D EXC^RGHLLOG(220,"INIT^HLFNC2 call error returned") Q
"RTN","MPIFRES",35,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFRES",36,0)
 Q
"RTN","MPIFRES",37,0)
LOOP ;
"RTN","MPIFRES",38,0)
 S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",39,0)
 D MAKE
"RTN","MPIFRES",40,0)
 Q
"RTN","MPIFRES",41,0)
SEND ;ready to send
"RTN","MPIFRES",42,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFRES",43,0)
 I +MPIEROR=0 D EXC^RGHLLOG(220,"GENERATE^HLMA call returned error") Q
"RTN","MPIFRES",44,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFRES",45,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",46,0)
 Q
"RTN","MPIFRES",47,0)
MAKE ;
"RTN","MPIFRES",48,0)
 N LOCAL,MPIIT,TICN
"RTN","MPIFRES",49,0)
 S LOCAL="",MPIIT=0,MPIFRES=""
"RTN","MPIFRES",50,0)
 ;local ICNs
"RTN","MPIFRES",51,0)
 F  S MPIIT=$O(^DPT("AICNL",1,MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",52,0)
 .;need to kill local?
"RTN","MPIFRES",53,0)
 .D MAKE3
"RTN","MPIFRES",54,0)
 ;missing ICNs
"RTN","MPIFRES",55,0)
 S MPIIT=0
"RTN","MPIFRES",56,0)
 F  S MPIIT=$O(^DPT("AMPIMIS",MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",57,0)
 .S TICN=+$$GETICN^MPIF001(MPIIT)
"RTN","MPIFRES",58,0)
 .I TICN<0 D MAKE3
"RTN","MPIFRES",59,0)
 .I TICN>0 K ^DPT("AMPIMIS",MPIIT)
"RTN","MPIFRES",60,0)
 Q
"RTN","MPIFRES",61,0)
MAKE3 ;
"RTN","MPIFRES",62,0)
 K MPIOUT
"RTN","MPIFRES",63,0)
 S MPIFRES=""
"RTN","MPIFRES",64,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFRES",65,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.MPIHL,.MPIQRYNM)
"RTN","MPIFRES",66,0)
 I $P(MPIOUT(0),"^",1)<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFRES",67,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFRES",68,0)
 Q:$P(MPIOUT(0),"^",1)<0
"RTN","MPIFRES",69,0)
 ;call for HL7 header
"RTN","MPIFRES",70,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFRES",71,0)
 D MSH^HLFNC2(.MPIHL,MPIMIDT,.MPIMSH)
"RTN","MPIFRES",72,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFRES",73,0)
 ;MESSAGE BUILT
"RTN","MPIFRES",74,0)
 S MPISEQ=0
"RTN","MPIFRES",75,0)
 F  S MPISEQ=$O(MPIOUT(MPISEQ)) Q:MPISEQ'>0  D
"RTN","MPIFRES",76,0)
 .S ^TMP("HLS",$J,MPICNT)=MPIOUT(MPISEQ)
"RTN","MPIFRES",77,0)
 .S MPICNT=MPICNT+1
"RTN","MPIFRES",78,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFRES",79,0)
 I MPIDNUM>100 D
"RTN","MPIFRES",80,0)
 .D SEND
"RTN","MPIFRES",81,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",82,0)
 .D HLRDF
"RTN","MPIFRES",83,0)
 Q
"RTN","MPIFRESS")
0^12^B11094085
"RTN","MPIFRESS",1,0)
MPIFRESS ;BHM/RGY-Process a CMOR result from CIRN demon ;FEB 27, 1998
"RTN","MPIFRESS",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFRESS",3,0)
EN(TYPE,REQNO,ERROR,HL7) ;
"RTN","MPIFRESS",4,0)
 NEW RGL,ID,COMMENTS,STATUS,NDATE,PHONE,REVIEWER,N0,CNT,HL,HLA,X
"RTN","MPIFRESS",5,0)
 S CNT=0,HL=0
"RTN","MPIFRESS",6,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFRESS",7,0)
 I N0="" S ERROR="Request does not exist" Q
"RTN","MPIFRESS",8,0)
 S ID=$P(N0,"^")
"RTN","MPIFRESS",9,0)
 S STATUS=$P(N0,"^",6)
"RTN","MPIFRESS",10,0)
 S COMMENTS=$P($G(^MPIF(984.9,REQNO,3)),"^",2)
"RTN","MPIFRESS",11,0)
 I $P($G(^MPIF(984.9,REQNO,3)),"^")]"" S REVIEWER=$P(^(3),"^")
"RTN","MPIFRESS",12,0)
 I $P($G(^MPIF(984.9,REQNO,3)),"^")']"" D
"RTN","MPIFRESS",13,0)
 .N DIC,X,Y
"RTN","MPIFRESS",14,0)
 .S DIC="^VA(200,",DIC(0)="ZMO",X="`"_+$P(^MPIF(984.9,REQNO,2),"^")
"RTN","MPIFRESS",15,0)
 .I $G(Y)>1 S REVIEWER=$G(Y(0,0))
"RTN","MPIFRESS",16,0)
 .I $G(Y)<1 S REVIEWER=""
"RTN","MPIFRESS",17,0)
 S NDATE=$P($G(^MPIF(984.9,REQNO,2)),"^",2)
"RTN","MPIFRESS",18,0)
 S PHONE=$P($G(^MPIF(984.9,REQNO,2)),"^",3)
"RTN","MPIFRESS",19,0)
 S COMMENTS=$P($G(^MPIF(984.9,REQNO,3)),"^",2)
"RTN","MPIFRESS",20,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFRESS",21,0)
 I HL S ERROR=HL Q
"RTN","MPIFRESS",22,0)
 D LINK^HLUTIL3($P(N0,"^",7),.RGL)
"RTN","MPIFRESS",23,0)
 S X=$O(RGL(0))
"RTN","MPIFRESS",24,0)
 I X>0,$E($G(RGL(X)),1,2)'="VA" D START^RGHLLOG(),EXC^RGHLLOG(224,"Unableto process Request to change CMOR request# "_REQNO_"  No a CIRN logical link for site "_X),STOP^RGHLLOG() Q
"RTN","MPIFRESS",25,0)
 I X>0 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_RGL(X)
"RTN","MPIFRESS",26,0)
 S CNT=CNT+1,HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_COMMENTS_HL("FS")_STATUS_HL("FS")_ID
"RTN","MPIFRESS",27,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_REVIEWER
"RTN","MPIFRESS",28,0)
 N RLST
"RTN","MPIFRESS",29,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFRESS",30,0)
 I 'RLST S ERROR=RLST
"RTN","MPIFRESS",31,0)
 Q
"RTN","MPIFRESS",32,0)
IN(ID,RESULT,NDATE,PHONE,REVIEWER,COMMENTS) ;Process an incoming CMOR result
"RTN","MPIFRESS",33,0)
 NEW DFN,ENT,XMY,XMDUZ,XMTEXT,MPIF,XMSUB,FSITE,CMOR
"RTN","MPIFRESS",34,0)
 S ENT=$O(^MPIF(984.9,"B",ID,0))
"RTN","MPIFRESS",35,0)
 Q:'$D(^MPIF(984.9,ENT,0))
"RTN","MPIFRESS",36,0)
 S DFN=$P($G(^MPIF(984.9,ENT,0)),"^",4),FSITE=$P($G(^(0)),"^",7)
"RTN","MPIFRESS",37,0)
 S DIC="^DIC(4,",DIC(0)="MNZ",X=FSITE D ^DIC
"RTN","MPIFRESS",38,0)
 I $G(Y)>0 S FSITE=$P(Y,"^",2)
"RTN","MPIFRESS",39,0)
 K Y,X,DIC
"RTN","MPIFRESS",40,0)
 S CMOR=$$CMORNAME^MPIF001($P(^MPIF(984.9,REQNO,0),"^",7))
"RTN","MPIFRESS",41,0)
 I +CMOR=-1 D START^RGHLLOG(),EXC^RGHLLOG(221,"CMOR not found in Change CMOR message for patient DFN= "_DFN,DFN) Q
"RTN","MPIFRESS",42,0)
 Q:+CMOR=-1
"RTN","MPIFRESS",43,0)
 I RESULT=4,$P($G(^MPIF(984.9,ENT,1)),"^",3)=1 D
"RTN","MPIFRESS",44,0)
 .S RES=1,RES=$$CHANGE^MPIF001(DFN,CMOR)
"RTN","MPIFRESS",45,0)
 .I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_CMOR_" in a CMOR Change Message for patient DFN= "_DFN,DFN),STOP^RGHLLOG()
"RTN","MPIFRESS",46,0)
 .Q:+RES<1
"RTN","MPIFRESS",47,0)
 .D BROAD^MPIFCMOR(ENT)
"RTN","MPIFRESS",48,0)
 S DIE="^MPIF(984.9,",DA=ENT,DR="[MPIF RESULT INCOMING]" D ^DIE K DIE,DA,DR
"RTN","MPIFRESS",49,0)
 S XMDUZ="MPI VISTA Package"
"RTN","MPIFRESS",50,0)
 S XMSUB="Request "_ID_" is "_$S(RESULT=4:"approved",1:"disapproved")
"RTN","MPIFRESS",51,0)
 S XMY($P(^MPIF(984.9,ENT,0),"^",2))="",XMTEXT="MPIF(1,"
"RTN","MPIFRESS",52,0)
 S MPIF(1,1)=FSITE_" received CMOR request for "_$P($G(^DPT(+$P(^MPIF(984.9,ENT,0),"^",4),0)),"^")_" ("_$E($P(^(0),"^",9),6,9)_")."
"RTN","MPIFRESS",53,0)
 S MPIF(1,2)=XMSUB_"."
"RTN","MPIFRESS",54,0)
 D ^XMD
"RTN","MPIFRESS",55,0)
 Q
"RTN","MPIFRTC")
0^5^B5585592
"RTN","MPIFRTC",1,0)
MPIFRTC ;ALB/JRP-GET ICN FROM MPI USING REAL TIME CONNECTION ;21-JAN-1997
"RTN","MPIFRTC",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFRTC",3,0)
 ;
"RTN","MPIFRTC",4,0)
GETICN(DFN) ;Get ICN from MPI using real time connection
"RTN","MPIFRTC",5,0)
 ;
"RTN","MPIFRTC",6,0)
 ;Input  : DFN - Pointer to entry in PATIENT file (#2)
"RTN","MPIFRTC",7,0)
 ;Output : ICN = Success
"RTN","MPIFRTC",8,0)
 ;         -1^Reason = Failure
"RTN","MPIFRTC",9,0)
 ;
"RTN","MPIFRTC",10,0)
 ;Check input
"RTN","MPIFRTC",11,0)
 S DFN=+$G(DFN)
"RTN","MPIFRTC",12,0)
 Q:('$D(^DPT(DFN,0))) "-1^Did not pass valid DFN"
"RTN","MPIFRTC",13,0)
 ;Declare variables
"RTN","MPIFRTC",14,0)
 N DPTZERO,CREATED,USER,INFOARR,MSG2MPI,MSG2DHCP,TMP,ICN
"RTN","MPIFRTC",15,0)
 S MSG2MPI="^TMP(""MPIFRTC"","_$J_",""MSG2MPI"")"
"RTN","MPIFRTC",16,0)
 S MSG2DHCP="^TMP(""MPIFRTC"","_$J_",""MSG2DHCP"")"
"RTN","MPIFRTC",17,0)
 S INFOARR="^TMP(""MPIFRTC"","_$J_",""INFOARR"")"
"RTN","MPIFRTC",18,0)
 K @MSG2MPI,@MSG2DHCP,@INFOARR
"RTN","MPIFRTC",19,0)
 ;Determine user that created patient and date/time patient was created
"RTN","MPIFRTC",20,0)
 S DPTZERO=$G(^DPT(DFN,0))
"RTN","MPIFRTC",21,0)
 S USER=+$P(DPTZERO,"^",15)
"RTN","MPIFRTC",22,0)
 S:('USER) USER=+$G(DUZ)
"RTN","MPIFRTC",23,0)
 S CREATED=+$P(DPTZERO,"^",16)
"RTN","MPIFRTC",24,0)
 S:('CREATED) CREATED=$$NOW^XLFDT()
"RTN","MPIFRTC",25,0)
 ;Set up extra info array for message builder
"RTN","MPIFRTC",26,0)
 ; - Event reason code (EVN segment, seq #4)
"RTN","MPIFRTC",27,0)
 S @INFOARR@("REASON",1)=94
"RTN","MPIFRTC",28,0)
 ; - Operator (EVN segment, seq #5)
"RTN","MPIFRTC",29,0)
 S @INFOARR@("USER")=$P($G(^VA(200,USER,0)),"^",1)
"RTN","MPIFRTC",30,0)
 ;Build MSH segment for ADT-A28 HL7 message
"RTN","MPIFRTC",31,0)
 D BLDMSH("A28","MPI","200M",MSG2MPI,1)
"RTN","MPIFRTC",32,0)
 ;Build rest of ADT-A28 HL7 message
"RTN","MPIFRTC",33,0)
 S TMP=$$BLDMSG^VAFCMSG1(DFN,"A28",CREATED,INFOARR,MSG2MPI,2)
"RTN","MPIFRTC",34,0)
 ;need to remove local ICN from PID segment
"RTN","MPIFRTC",35,0)
 S $P(@MSG2MPI@(3),"^",3)="",$P(@MSG2MPI@(3),"^",4)=""
"RTN","MPIFRTC",36,0)
 ;Send ADT-A28 HL7 message to MPI using real time connection
"RTN","MPIFRTC",37,0)
 S TMP=$$EN^HLCSAC("MPIVA DIR",MSG2MPI,MSG2DHCP)
"RTN","MPIFRTC",38,0)
 Q:(TMP<0) TMP
"RTN","MPIFRTC",39,0)
 ;Process ADT-A31 HL7 message returned by MPI (contains ICN assignment)
"RTN","MPIFRTC",40,0)
 S ICN=$$PROCESS^MPIFA31I(MSG2DHCP)
"RTN","MPIFRTC",41,0)
 ;Done - Clean up and return ICN
"RTN","MPIFRTC",42,0)
EX K @MSG2MPI,@MSG2DHCP,@INFOARR
"RTN","MPIFRTC",43,0)
 Q ICN
"RTN","MPIFRTC",44,0)
 ;
"RTN","MPIFRTC",45,0)
BLDMSH(EVNTHL7,RCVAPP,RCVFAC,ARRAY,LINE) ;Build MSH segment for ADT
"RTN","MPIFRTC",46,0)
 ; HL7 message
"RTN","MPIFRTC",47,0)
 ;
"RTN","MPIFRTC",48,0)
 ;Input  : EVNTHL7 - HL7 ADT event to build MSH segment for A28
"RTN","MPIFRTC",49,0)
 ;                   (Defaults to A28)
"RTN","MPIFRTC",50,0)
 ;         RCVAPP - Text to use as RECEIVING APPLICATION (seq #5)
"RTN","MPIFRTC",51,0)
 ;         RCVFAC - Text to use as RECEIVING FACILITY (seq #6)
"RTN","MPIFRTC",52,0)
 ;         ARRAY - Array to store MSH segment in (full global reference)
"RTN","MPIFRTC",53,0)
 ;                 (Defaults to ^TMP("MPIFRTC",$J,"MSH"))
"RTN","MPIFRTC",54,0)
 ;         LINE - Line number in ARRAY to store MSH segment in
"RTN","MPIFRTC",55,0)
 ;                Can not be zero or negative number (defaults to 1)
"RTN","MPIFRTC",56,0)
 ;Output : None
"RTN","MPIFRTC",57,0)
 ;         ARRAY() will be in the following format
"RTN","MPIFRTC",58,0)
 ;           ARRAY(LINE) = MSH segment
"RTN","MPIFRTC",59,0)
 ;           ARRAY(LINE,1) = First continuation node
"RTN","MPIFRTC",60,0)
 ;           ARRAY(LINE,n) = Nth continuation node
"RTN","MPIFRTC",61,0)
 ;Notes  : ARRAY(LINE) will be initialized (KILLed) on input
"RTN","MPIFRTC",62,0)
 ;       : ARRAY(LINE) will not be defined on bad input
"RTN","MPIFRTC",63,0)
 ;       : SENDING APPLICATION (seq #3) and SENDING FACILITY (seq #4)
"RTN","MPIFRTC",64,0)
 ;         are based on the application attached to the PIMS ADT-xxx
"RTN","MPIFRTC",65,0)
 ;         HL7 Server Protocol
"RTN","MPIFRTC",66,0)
 ;
"RTN","MPIFRTC",67,0)
 ;Check input
"RTN","MPIFRTC",68,0)
 S EVNTHL7=$G(EVNTHL7)
"RTN","MPIFRTC",69,0)
 S:(EVNTHL7="") EVNTHL7="A28"
"RTN","MPIFRTC",70,0)
 S RCVAPP=$G(RCVAPP)
"RTN","MPIFRTC",71,0)
 S RCVFAC=$G(RCVFAC)
"RTN","MPIFRTC",72,0)
 S ARRAY=$G(ARRAY)
"RTN","MPIFRTC",73,0)
 S:(ARRAY="") ARRAY="^TMP(""MPIFRTC"","_$J_",""MSH"")"
"RTN","MPIFRTC",74,0)
 S LINE=+$G(LINE)
"RTN","MPIFRTC",75,0)
 S:(LINE<1) LINE=1
"RTN","MPIFRTC",76,0)
 ;Declare variables
"RTN","MPIFRTC",77,0)
 N HLEID,HL,TMPMSHAR
"RTN","MPIFRTC",78,0)
 ;Inintialize output array
"RTN","MPIFRTC",79,0)
 K @ARRAY@(LINE)
"RTN","MPIFRTC",80,0)
 ;Get pointer to ADT-xxx HL7 Server Protocol
"RTN","MPIFRTC",81,0)
 S HLEID=$$GETSRVR^VAFCMSG5(EVNTHL7)
"RTN","MPIFRTC",82,0)
 ;Initialize HL7 variables
"RTN","MPIFRTC",83,0)
 D INIT^HLFNC2(HLEID,.HL)
"RTN","MPIFRTC",84,0)
 ;Build MSH segment for ADT-xxx HL7 message
"RTN","MPIFRTC",85,0)
 D MSH^HLFNC2(.HL,"",.TMPMSHAR)
"RTN","MPIFRTC",86,0)
 ;Manually set RECEIVING APPLICATION (seq #5)
"RTN","MPIFRTC",87,0)
 S $P(TMPMSHAR,HL("FS"),5)=RCVAPP
"RTN","MPIFRTC",88,0)
 ;Manually set RECEIVING FACILITY (seq #6)
"RTN","MPIFRTC",89,0)
 S $P(TMPMSHAR,HL("FS"),6)=RCVFAC
"RTN","MPIFRTC",90,0)
 ;Move MSH segment into output array
"RTN","MPIFRTC",91,0)
 S @ARRAY@(LINE)=TMPMSHAR
"RTN","MPIFRTC",92,0)
 S HL=0
"RTN","MPIFRTC",93,0)
 F  S HL=+$O(MSH(HL)) Q:('HL)  S @ARRAY@(LINE,HL)=TMPMSHAR(HL)
"RTN","MPIFRTC",94,0)
 ;Done
"RTN","MPIFRTC",95,0)
 Q
"RTN","MPIFSAQ")
0^13^B69662567
"RTN","MPIFSAQ",1,0)
MPIFSAQ ;SF/CMC-STAND ALONE QUERY ;JAN 12, 1998
"RTN","MPIFSAQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFSAQ",3,0)
 ;
"RTN","MPIFSAQ",4,0)
INTACTV ;Interactive standalone query - Display Only!
"RTN","MPIFSAQ",5,0)
 ;patient doesn't have to be in Patient file
"RTN","MPIFSAQ",6,0)
 ;
"RTN","MPIFSAQ",7,0)
 K DIR,X,Y
"RTN","MPIFSAQ",8,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is Patient in the PATIENT file? "
"RTN","MPIFSAQ",9,0)
 D ^DIR
"RTN","MPIFSAQ",10,0)
 G:(Y'=1)&(Y'=0) END
"RTN","MPIFSAQ",11,0)
 I Y=1 D PAT(.MPIVAR)
"RTN","MPIFSAQ",12,0)
 I Y'=1,'$D(MPIVAR) D NOPAT(.MPIVAR)
"RTN","MPIFSAQ",13,0)
 G:+$G(MPIVAR("DOB"))'>0 END
"RTN","MPIFSAQ",14,0)
 D VTQ(.MPIVAR)
"RTN","MPIFSAQ",15,0)
 K DIR,X,Y,MPIVAR
"RTN","MPIFSAQ",16,0)
 Q
"RTN","MPIFSAQ",17,0)
END ;
"RTN","MPIFSAQ",18,0)
 K DIR,X,Y,MPIVAR,DIRUT,DTOUT,DUOUT
"RTN","MPIFSAQ",19,0)
 Q
"RTN","MPIFSAQ",20,0)
 ;
"RTN","MPIFSAQ",21,0)
CLEAN(NAM) ;
"RTN","MPIFSAQ",22,0)
 ;NAM is the name to be cleaned up
"RTN","MPIFSAQ",23,0)
 ; Returned from this function is a clean name
"RTN","MPIFSAQ",24,0)
 N YY,I
"RTN","MPIFSAQ",25,0)
 ; -- only uppercase
"RTN","MPIFSAQ",26,0)
 I NAM?.E1L.E F I=1:1:$L(NAM) S:$E(NAM,I)?1L NAM=$E(NAM,0,I-1)_$C($A(NAM,I)-32)_$E(NAM,I+1,$L(NAM))
"RTN","MPIFSAQ",27,0)
 ; -- no space after comma and no double spaces
"RTN","MPIFSAQ",28,0)
 F YY=", ","  " F  Q:'$F(NAM,YY)  S NAM=$E(NAM,1,($F(NAM,YY)-2))_$E(NAM,$F(NAM,YY),$L(NAM))
"RTN","MPIFSAQ",29,0)
 ; -- no space at the end
"RTN","MPIFSAQ",30,0)
 F  Q:$E(NAM,$L(NAM))'=" "  S NAM=$E(NAM,1,$L(NAM)-1)
"RTN","MPIFSAQ",31,0)
 Q NAM
"RTN","MPIFSAQ",32,0)
 ;
"RTN","MPIFSAQ",33,0)
PAT(MPIVAR) ;
"RTN","MPIFSAQ",34,0)
 ;patient is in local Patient file
"RTN","MPIFSAQ",35,0)
PATA N DIC,X,Y,DIQ,DR,DA,ARRAY,DFN,DTOUT,DUOUT
"RTN","MPIFSAQ",36,0)
 S DIC="^DPT(",DIC(0)="AEQZM",DIC("A")="Patient Name: "
"RTN","MPIFSAQ",37,0)
 D ^DIC
"RTN","MPIFSAQ",38,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",39,0)
 I +Y=-1 W !,"Patient not found.  Try Again" G PATA
"RTN","MPIFSAQ",40,0)
 S (DFN,MPIVAR("DFN"))=+Y,MPIVAR("NM")=$P(Y(0),"^")
"RTN","MPIFSAQ",41,0)
 S DIQ="ARRAY",DR=".09;.03",DIC="^DPT(",DA=+Y,DIQ(0)="I"
"RTN","MPIFSAQ",42,0)
 D EN^DIQ1
"RTN","MPIFSAQ",43,0)
 S MPIVAR("DOB")=$G(ARRAY(2,DFN,.03,"I"))
"RTN","MPIFSAQ",44,0)
 S MPIVAR("SSN")=$G(ARRAY(2,DFN,.09,"I")) I MPIVAR("SSN")["P" S MPIVAR("SSN")=""
"RTN","MPIFSAQ",45,0)
 Q
"RTN","MPIFSAQ",46,0)
 ;
"RTN","MPIFSAQ",47,0)
NOPAT(MPIVAR) ;
"RTN","MPIFSAQ",48,0)
 ; patient is not in the local Patient file
"RTN","MPIFSAQ",49,0)
NAME N DTOUT,DUOUT,DIR,X,Y
"RTN","MPIFSAQ",50,0)
 S DIR(0)="FU^::",DIR("A")="PATIENT NAME (last,first middle)"
"RTN","MPIFSAQ",51,0)
 D ^DIR
"RTN","MPIFSAQ",52,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",53,0)
 I (Y="")!($L(Y)>45)!($L(Y)<3) W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",54,0)
 I (Y?1P.E)!(Y'?1U.ANP)!(Y'[",")!(Y[":")!(Y[";") W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",55,0)
 I Y'?.UNP F %=1:1:$L(Y) I $E(Y,%)?1L S Y=$E(Y,0,%-1)_$C($A(Y,%)-32)_$E(Y,%+1,999)
"RTN","MPIFSAQ",56,0)
 S MPIVAR("NM")=$$CLEAN(Y)
"RTN","MPIFSAQ",57,0)
 ;
"RTN","MPIFSAQ",58,0)
DOB K DIR,X,Y
"RTN","MPIFSAQ",59,0)
 S DIR(0)="DU^::AE",DIR("A")="Date of Birth"
"RTN","MPIFSAQ",60,0)
 D ^DIR
"RTN","MPIFSAQ",61,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",62,0)
 S MPIVAR("DOB")=Y
"RTN","MPIFSAQ",63,0)
SSN ; ssn is optional
"RTN","MPIFSAQ",64,0)
 K DIR,X,Y
"RTN","MPIFSAQ",65,0)
 S DIR(0)="FUO^9:9:",DIR("A")="9 Digit SSN (No Dashes)"
"RTN","MPIFSAQ",66,0)
 D ^DIR
"RTN","MPIFSAQ",67,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",68,0)
 I Y'="",Y'?9N W !,"SSN should be 9 numbers" G SSN
"RTN","MPIFSAQ",69,0)
 S MPIVAR("SSN")=Y
"RTN","MPIFSAQ",70,0)
 Q
"RTN","MPIFSAQ",71,0)
 ;
"RTN","MPIFSAQ",72,0)
VTQ(MPIVAR) ;
"RTN","MPIFSAQ",73,0)
 I $$SEND^RGJUSITE'>0 W !,"Not in SEND or SUSPEND mode, Try Again Later" G END
"RTN","MPIFSAQ",74,0)
 N TIME,%
"RTN","MPIFSAQ",75,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFSAQ",76,0)
 ;
"RTN","MPIFSAQ",77,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFSAQ",78,0)
 ;
"RTN","MPIFSAQ",79,0)
 N HL,MPIQRYNM,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER
"RTN","MPIFSAQ",80,0)
 N TEST,SITE,RGDC,MPINM,MPI1NM,MPI2NM,MPIESC,MPIHDOB,MPIRS,MPISCS
"RTN","MPIFSAQ",81,0)
 N QUEDDOB,QUERY,RDF
"RTN","MPIFSAQ",82,0)
 S HL("ECH")="^~\&",HL("FS")="|",MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFSAQ",83,0)
 S MPIIN="",MPICNT=1
"RTN","MPIFSAQ",84,0)
 S MPICS=$E(HL("ECH"),1)
"RTN","MPIFSAQ",85,0)
 I '$D(MPIVAR("DFN")) S MPIVAR("DFN")=235
"RTN","MPIFSAQ",86,0)
 S MPIMCNT=MPIVAR("DFN")
"RTN","MPIFSAQ",87,0)
 ;
"RTN","MPIFSAQ",88,0)
 ;SETUP VTQ
"RTN","MPIFSAQ",89,0)
 ;
"RTN","MPIFSAQ",90,0)
 S MPICS=$E(HL("ECH"),1),MPIRS=$E(HL("ECH"),2),MPISCS=$E(HL("ECH"),4),MPIESC=$E(HL("ECH"),3)
"RTN","MPIFSAQ",91,0)
 ;
"RTN","MPIFSAQ",92,0)
 S RDF="RDF"_HL("FS")_"15"_HL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",93,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_8
"RTN","MPIFSAQ",94,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFSAQ",95,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_20_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",96,0)
 ; ^ fields to be returned in query response
"RTN","MPIFSAQ",97,0)
 S QUERY="VTQ"_HL("FS")_$G(MPIVAR("DFN"))_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFSAQ",98,0)
 S MPI2NM=$P($G(MPIVAR("NM")),",",1),QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFSAQ",99,0)
 ; ^ sending last name
"RTN","MPIFSAQ",100,0)
 I MPIVAR("SSN")'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_$G(MPIVAR("SSN"))
"RTN","MPIFSAQ",101,0)
 ; ^ sending SSN
"RTN","MPIFSAQ",102,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFSAQ",103,0)
 ; ^ sending first name
"RTN","MPIFSAQ",104,0)
 I $G(MPIVAR("DOB"))>0 D
"RTN","MPIFSAQ",105,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIVAR("DOB"))
"RTN","MPIFSAQ",106,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFSAQ",107,0)
 .S QUEDDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFSAQ",108,0)
 .S QUERY=QUERY_QUEDDOB
"RTN","MPIFSAQ",109,0)
 .; ^ sending date of birth
"RTN","MPIFSAQ",110,0)
 ;
"RTN","MPIFSAQ",111,0)
 ;Create MSH
"RTN","MPIFSAQ",112,0)
 ;
"RTN","MPIFSAQ",113,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFSAQ",114,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFSAQ",115,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFSAQ",116,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFSAQ",117,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFSAQ",118,0)
 S MPIOUT(3)=RDF
"RTN","MPIFSAQ",119,0)
 ;
"RTN","MPIFSAQ",120,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFSAQ",121,0)
 ;Message is returned in RGDC array
"RTN","MPIFSAQ",122,0)
 ;
"RTN","MPIFSAQ",123,0)
 K RGDC
"RTN","MPIFSAQ",124,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","RGDC")
"RTN","MPIFSAQ",125,0)
 ;
"RTN","MPIFSAQ",126,0)
 I +TEST=-1 W !!,"Could not connect to MPI, try again later." G EXIT
"RTN","MPIFSAQ",127,0)
 ;
"RTN","MPIFSAQ",128,0)
 ;Kill ^TMP("MPIFSAQ",$J) this is the array the data is parsed into
"RTN","MPIFSAQ",129,0)
 K ^TMP("MPIFSAQ",$J)
"RTN","MPIFSAQ",130,0)
 ;
"RTN","MPIFSAQ",131,0)
INIPARS ;
"RTN","MPIFSAQ",132,0)
 N SEG,INDEX,COUNTER,LASTSSN,SKIP,CHECK
"RTN","MPIFSAQ",133,0)
 S INDEX=0,COUNTER=1
"RTN","MPIFSAQ",134,0)
 K CHECK
"RTN","MPIFSAQ",135,0)
PARSE ;
"RTN","MPIFSAQ",136,0)
 S SEG=$$SEG^RGRSUTIL("RDT",1,"RDT")
"RTN","MPIFSAQ",137,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFSAQ",138,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,NAME,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",139,0)
 . N HEREICN,HERESSN,MIDDLE,MNAME,SUFFIX,PREFIX,SEX,IEN,CMOR2,TF2
"RTN","MPIFSAQ",140,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7)
"RTN","MPIFSAQ",141,0)
 . S LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFSAQ",142,0)
 . S MIDDLE=$P(SEG,HL("FS"),10)
"RTN","MPIFSAQ",143,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFSAQ",144,0)
 . S NAME=LASTNAME_","_FRSTNAME_" "_MIDDLE
"RTN","MPIFSAQ",145,0)
 . S CMOR=$P(SEG,HL("FS"),5),CMOR2=CMOR
"RTN","MPIFSAQ",146,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^"),CMOR2=CMOR
"RTN","MPIFSAQ",147,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFSAQ",148,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFSAQ",149,0)
 . ;
"RTN","MPIFSAQ",150,0)
 . ;Same patient just adding TF's
"RTN","MPIFSAQ",151,0)
 . I TF'="",NAME_"^"_SSN=$P($G(^TMP("MPIFSAQ",$J,INDEX,"DATA")),"^",0,2) D
"RTN","MPIFSAQ",152,0)
 . . S SKIP="Y"
"RTN","MPIFSAQ",153,0)
 . . Q:CMOR2=TF2!($D(CHECK(TF2)))
"RTN","MPIFSAQ",154,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFSAQ",155,0)
 . . S ^TMP("MPIFSAQ",$J,INDEX,COUNTER)=TF,CHECK(TF2)=""
"RTN","MPIFSAQ",156,0)
 . ;
"RTN","MPIFSAQ",157,0)
 . I $D(SKIP) K SKIP Q
"RTN","MPIFSAQ",158,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFSAQ",159,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFSAQ",160,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFSAQ",161,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFSAQ",162,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFSAQ",163,0)
 . . S BIRTHDAY=$$IN2EXDT^VAFCMGU0(BIRTHDAY,0)
"RTN","MPIFSAQ",164,0)
 . S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFSAQ",165,0)
 . S SUFFIX=$P(SEG,HL("FS"),15)
"RTN","MPIFSAQ",166,0)
 . S PREFIX=$P(SEG,HL("FS"),14)
"RTN","MPIFSAQ",167,0)
 . S MNAME=$P(SEG,HL("FS"),16)
"RTN","MPIFSAQ",168,0)
 . S POBC=$P(SEG,HL("FS"),12)
"RTN","MPIFSAQ",169,0)
 . S POBS=$P(SEG,HL("FS"),13)
"RTN","MPIFSAQ",170,0)
 . S PAST=$P(SEG,HL("FS"),9)
"RTN","MPIFSAQ",171,0)
 . ;
"RTN","MPIFSAQ",172,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFSAQ",173,0)
 . ;
"RTN","MPIFSAQ",174,0)
 . S INDEX=INDEX+1
"RTN","MPIFSAQ",175,0)
 . S COUNTER=1
"RTN","MPIFSAQ",176,0)
 . I CMOR2=TF2 S TF=""
"RTN","MPIFSAQ",177,0)
 . S ^TMP("MPIFSAQ",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_SEX_"^"_SUFFIX_"^"_PREFIX_"^"_MNAME_"^"_POBC_"^"_POBS_"^"_PAST
"RTN","MPIFSAQ",178,0)
 ;
"RTN","MPIFSAQ",179,0)
 ; If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFSAQ",180,0)
 I '$D(^TMP("MPIFSAQ",$J)) W !!,"Patient was not found in the MPI." G EXIT
"RTN","MPIFSAQ",181,0)
 ;
"RTN","MPIFSAQ",182,0)
DISPLAY ;
"RTN","MPIFSAQ",183,0)
 I INDEX>1 W !!,"Found potential matches"
"RTN","MPIFSAQ",184,0)
 I INDEX=1 W !!,"Found One Match"
"RTN","MPIFSAQ",185,0)
 ; display data returned
"RTN","MPIFSAQ",186,0)
 N CNT1,CNT2,STOP,CNTR2,TTF,CNT3,DIR,X,Y,DATA
"RTN","MPIFSAQ",187,0)
 S (CNT1)=0
"RTN","MPIFSAQ",188,0)
 F  S CNT1=$O(^TMP("MPIFSAQ",$J,CNT1)) Q:CNT1'>0!($D(STOP))  D
"RTN","MPIFSAQ",189,0)
 . S CNTR2=0
"RTN","MPIFSAQ",190,0)
 . I CNT1>1 D
"RTN","MPIFSAQ",191,0)
 . . K DIR,X,Y
"RTN","MPIFSAQ",192,0)
 . . S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue to next Patient? "
"RTN","MPIFSAQ",193,0)
 . . D ^DIR
"RTN","MPIFSAQ",194,0)
 . . I Y'=1 S STOP=""
"RTN","MPIFSAQ",195,0)
 . Q:$D(STOP)
"RTN","MPIFSAQ",196,0)
 . S CNTR2=CNTR2+1
"RTN","MPIFSAQ",197,0)
 . S DATA=$G(^TMP("MPIFSAQ",$J,CNT1,"DATA"))
"RTN","MPIFSAQ",198,0)
 . Q:DATA=""
"RTN","MPIFSAQ",199,0)
 . K TF,CHECK
"RTN","MPIFSAQ",200,0)
 . S NAME=$P(DATA,"^"),SSN=$P(DATA,"^",2),BIRTHDAY=$P(DATA,"^",3)
"RTN","MPIFSAQ",201,0)
 . S ICN=$P(DATA,"^",4),CMOR=$P(DATA,"^",5)
"RTN","MPIFSAQ",202,0)
 . S TTF=$P(DATA,"^",6)
"RTN","MPIFSAQ",203,0)
 . I TTF'="",CMOR'=TTF S TF(CNTR2)=TTF
"RTN","MPIFSAQ",204,0)
 . S SEX=$P(DATA,"^",7),SUFFIX=$P(DATA,"^",8),PREFIX=$P(DATA,"^",9)
"RTN","MPIFSAQ",205,0)
 . S MNAME=$P(DATA,"^",10),POBC=$P(DATA,"^",11),POBS=$P(DATA,"^",12)
"RTN","MPIFSAQ",206,0)
 . S PAST=$P(DATA,"^",13)
"RTN","MPIFSAQ",207,0)
 . S CNT3=""
"RTN","MPIFSAQ",208,0)
 . F  S CNT3=$O(^TMP("MPIFSAQ",$J,CNT1,CNT3)) Q:CNT3<0!(CNT3'?.N)  D
"RTN","MPIFSAQ",209,0)
 . . S TTF=$G(^TMP("MPIFSAQ",$J,CNT1,CNT3))
"RTN","MPIFSAQ",210,0)
 . . I TTF'=CMOR S CNTR2=CNTR2+1,TF(CNTR2)=TTF
"RTN","MPIFSAQ",211,0)
 . W !!!,"Name: ",NAME," ",SUFFIX," ",PREFIX
"RTN","MPIFSAQ",212,0)
 . W !,"SSN: ",SSN,?25,"Gender: ",SEX
"RTN","MPIFSAQ",213,0)
 . W !,"Integration Control Number (ICN): ",$P(ICN,"V")
"RTN","MPIFSAQ",214,0)
 . W !,"Date of Birth: ",BIRTHDAY,?30,"Date of Death: ",PAST
"RTN","MPIFSAQ",215,0)
 . W:$G(POBC)'="" !,"Place of Birth: ",POBC,", ",POBS
"RTN","MPIFSAQ",216,0)
 . W !,"CMOR: ",CMOR
"RTN","MPIFSAQ",217,0)
 . S CNT2=""
"RTN","MPIFSAQ",218,0)
 . F  S CNT2=$O(TF(CNT2)) Q:CNT2=""  D
"RTN","MPIFSAQ",219,0)
 . . W !?10,"Treating Facility: ",TF(CNT2)
"RTN","MPIFSAQ",220,0)
 .W !!
"RTN","MPIFSAQ",221,0)
 Q
"RTN","MPIFSAQ",222,0)
EXIT ;
"RTN","MPIFSAQ",223,0)
 H 3
"RTN","MPIFSAQ",224,0)
 W !!
"RTN","MPIFVTQ")
0^18^B40474289
"RTN","MPIFVTQ",1,0)
MPIFVTQ ;SLC/ARS-BUILD DATA TO QUERY MPI RESPONSE PROCESS (ADDPAT) ;JUL 16, 1997
"RTN","MPIFVTQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1**;30 Apr 99
"RTN","MPIFVTQ",3,0)
 ;
"RTN","MPIFVTQ",4,0)
 Q  ;NOT an entry point
"RTN","MPIFVTQ",5,0)
HLRDF D INIT^HLFNC2("MPIF-STARTUP",.MPIHL)
"RTN","MPIFVTQ",6,0)
 S SITE=$$KSP^XUPARAM("INST")
"RTN","MPIFVTQ",7,0)
 Q
"RTN","MPIFVTQ",8,0)
VTQ2(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",9,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",10,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",11,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",12,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",13,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",14,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",15,0)
 ;  POB-CITY;POB-STATE
"RTN","MPIFVTQ",16,0)
 ;
"RTN","MPIFVTQ",17,0)
 ;If invalid DFN, Patient Merged, if ICN (NOT LOCAL) already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",18,0)
 ;
"RTN","MPIFVTQ",19,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",20,0)
 ;
"RTN","MPIFVTQ",21,0)
 ; allows VTQ to be created for Local ICN patients.
"RTN","MPIFVTQ",22,0)
 ;
"RTN","MPIFVTQ",23,0)
 N MPITEST,MPISSN,MPIDTH
"RTN","MPIFVTQ",24,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",25,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00180.4;00126.1;00126.2"
"RTN","MPIFVTQ",26,0)
 ;validation check
"RTN","MPIFVTQ",27,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",28,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",29,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",30,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",31,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",32,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",33,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1),MPIZLOC=$P(^DPT(MPIIT,"MPI"),"^",4)
"RTN","MPIFVTQ",34,0)
 I $G(MPIZICN)'="",$G(MPIZLOC)'=1 S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",35,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",36,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",37,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",38,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",39,0)
 S MPIDTH=""
"RTN","MPIFVTQ",40,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",41,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",42,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",43,0)
 Q
"RTN","MPIFVTQ",44,0)
 ;
"RTN","MPIFVTQ",45,0)
VTQ1(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",46,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",47,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",48,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",49,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",50,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",51,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",52,0)
 ;  POB-CITY;POB-STATE
"RTN","MPIFVTQ",53,0)
 ;
"RTN","MPIFVTQ",54,0)
 ;If invalid DFN, Patient Merged, if ICN already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",55,0)
 ;
"RTN","MPIFVTQ",56,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",57,0)
 ;
"RTN","MPIFVTQ",58,0)
 N MPITEST,MPISSN,MPIDTH
"RTN","MPIFVTQ",59,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",60,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00180.4;00126.1;00126.2"
"RTN","MPIFVTQ",61,0)
 ;validation check
"RTN","MPIFVTQ",62,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",63,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",64,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",65,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",66,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",67,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",68,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1)
"RTN","MPIFVTQ",69,0)
 I '$D(MPIFRES),$G(MPIZICN)'="" S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",70,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",71,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",72,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",73,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",74,0)
 S MPIDTH=""
"RTN","MPIFVTQ",75,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",76,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",77,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",78,0)
 Q
"RTN","MPIFVTQ",79,0)
 ;
"RTN","MPIFVTQ",80,0)
VTQC(MPISSN,MPIDTH,MPISND,MPIHL,MPIQRYNM,MPIOUT,MPIIT) ;
"RTN","MPIFVTQ",81,0)
 N MPIPOB,MPIPOBS,MPINM,MPI2MN,MPI1NM,QUERY,MPIDOB,RDF,MPIMOD
"RTN","MPIFVTQ",82,0)
 N MPIHDTH,MPIZDOB,MPIXDOB,MPIMPI,MPIZICN,QUEDOB,MPI2NM,MPICS,MPIESC,MPIHDOB,MPIMNM
"RTN","MPIFVTQ",83,0)
 N MPINMSFX,MPIRS,MPISCS,MPISEX,MPIZLOC
"RTN","MPIFVTQ",84,0)
 I $G(MPIQRYNM)="" S MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFVTQ",85,0)
 S MPICS=$E(MPIHL("ECH"),1)
"RTN","MPIFVTQ",86,0)
 S MPIRS=$E(MPIHL("ECH"),2)
"RTN","MPIFVTQ",87,0)
 S MPISCS=$E(MPIHL("ECH"),4)
"RTN","MPIFVTQ",88,0)
 S MPIESC=$E(MPIHL("ECH"),3)
"RTN","MPIFVTQ",89,0)
 ;
"RTN","MPIFVTQ",90,0)
 S RDF="RDF"_MPIHL("FS")_"9"_MPIHL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30_MPIRS_"@00105"_MPICS_"ST"_MPICS_19
"RTN","MPIFVTQ",91,0)
 S RDF=RDF_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_8_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16
"RTN","MPIFVTQ",92,0)
 ; ^ fields to be returned in query response
"RTN","MPIFVTQ",93,0)
 ;
"RTN","MPIFVTQ",94,0)
 S QUERY="VTQ"_MPIHL("FS")_MPIIT_MPIHL("FS")_"T"_MPIHL("FS")_MPIQRYNM_MPIHL("FS")_"ICN"_MPIHL("FS")
"RTN","MPIFVTQ",95,0)
 ;
"RTN","MPIFVTQ",96,0)
 I MPISND["00108" S MPINM=$P(MPITEST,"^",1),VAFHA08=1,VAFHCA08=1 D NAME^VAFCPID2(MPIIT,.MPINM) K VAFHA08,VAFHCA08 ;agressive name reformatting
"RTN","MPIFVTQ",97,0)
 ; ^ sending all or part of name
"RTN","MPIFVTQ",98,0)
 I MPISND["00108.1" S MPI2NM=$P(MPINM,",",1) I MPI2NM'="" S QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFVTQ",99,0)
 ; ^ sending last name
"RTN","MPIFVTQ",100,0)
 I MPISND["00122"&(MPISSN'="")&(MPISSN'["P") S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_MPISSN
"RTN","MPIFVTQ",101,0)
 ; ^ sending SSN
"RTN","MPIFVTQ",102,0)
 I MPISND["00108.2" S MPI1NM=$P(MPINM,",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFVTQ",103,0)
 ; ^ sending first name
"RTN","MPIFVTQ",104,0)
 I MPISND["00110" D
"RTN","MPIFVTQ",105,0)
 .S MPIDOB=$P(MPITEST,"^",3)
"RTN","MPIFVTQ",106,0)
 .Q:MPIDOB=""
"RTN","MPIFVTQ",107,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIDOB)
"RTN","MPIFVTQ",108,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFVTQ",109,0)
 .S MPIMOD=MPIDOB#100
"RTN","MPIFVTQ",110,0)
 .I MPIQRYNM'="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"GN"_MPICS_MPIHDOB
"RTN","MPIFVTQ",111,0)
 .I MPIQRYNM="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",112,0)
 .S MPIXDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",113,0)
 .S QUEDOB=$S(MPIMOD>0:MPIXDOB,1:MPIZDOB)
"RTN","MPIFVTQ",114,0)
 .S QUERY=QUERY_QUEDOB
"RTN","MPIFVTQ",115,0)
 ; ^ sending date of birth
"RTN","MPIFVTQ",116,0)
 I $D(MPIDTH),(MPISND["00740")&(MPIDTH'="") S MPIHDTH=$$HLDATE^HLFNC(MPIDTH),QUERY=QUERY_MPICS_"AND"_MPIRS_"@00740"_MPICS_"EQ"_MPICS_MPIHDTH
"RTN","MPIFVTQ",117,0)
 ; ^ sending date of death
"RTN","MPIFVTQ",118,0)
 I MPISND["00111" S:$G(^DPT(MPIIT,0))'="" MPISEX=$P(^DPT(MPIIT,0),"^",2) I MPISEX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_MPISEX
"RTN","MPIFVTQ",119,0)
 ; ^ sending Sex
"RTN","MPIFVTQ",120,0)
 I MPISND["00108.4" S MPIMNM=$P(MPI1NM," ",2),MPINMSFX=$P(MPI1NM," ",3) I MPINMSFX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPINMSFX
"RTN","MPIFVTQ",121,0)
 ; ^ sending suffix name
"RTN","MPIFVTQ",122,0)
 I MPISND["00126.1" S MPIPOB=$P(^DPT(MPIIT,0),"^",11) I MPIPOB'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_MPIPOB
"RTN","MPIFVTQ",123,0)
 ; send place of birth - city
"RTN","MPIFVTQ",124,0)
 I MPISND["00126.2" S MPIPOBS=$P(^DPT(MPIIT,0),"^",12) I MPIPOBS'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_MPIPOBS
"RTN","MPIFVTQ",125,0)
 ; send place of birth - state
"RTN","MPIFVTQ",126,0)
 ;
"RTN","MPIFVTQ",127,0)
 I $G(MPIOUT(0))="" S MPIOUT(0)="1^good data"
"RTN","MPIFVTQ",128,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFVTQ",129,0)
 S MPIOUT(3)=RDF
"RTN","MPIFVTQ",130,0)
 ;W !,QUERY
"RTN","MPIFVTQ",131,0)
 Q
"VER")
8.0^22.0
**END**
**END**
