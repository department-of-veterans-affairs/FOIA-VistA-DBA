Released RA*5*51 SEQ #47
Extracted from mail message
**KIDS**:RA*5.0*51^

**INSTALL NAME**
RA*5.0*51
"BLD",5205,0)
RA*5.0*51^RADIOLOGY/NUCLEAR MEDICINE^0^3041216^y
"BLD",5205,4,0)
^9.64PA^^
"BLD",5205,"KRN",0)
^9.67PA^8989.52^19
"BLD",5205,"KRN",.4,0)
.4
"BLD",5205,"KRN",.401,0)
.401
"BLD",5205,"KRN",.402,0)
.402
"BLD",5205,"KRN",.403,0)
.403
"BLD",5205,"KRN",.5,0)
.5
"BLD",5205,"KRN",.84,0)
.84
"BLD",5205,"KRN",3.6,0)
3.6
"BLD",5205,"KRN",3.8,0)
3.8
"BLD",5205,"KRN",9.2,0)
9.2
"BLD",5205,"KRN",9.8,0)
9.8
"BLD",5205,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5205,"KRN",9.8,"NM",1,0)
RAORD2^^0^B38868259
"BLD",5205,"KRN",9.8,"NM",2,0)
RAUTL9^^0^B31156793
"BLD",5205,"KRN",9.8,"NM",3,0)
RAHLTCPB^^0^B56853424
"BLD",5205,"KRN",9.8,"NM","B","RAHLTCPB",3)

"BLD",5205,"KRN",9.8,"NM","B","RAORD2",1)

"BLD",5205,"KRN",9.8,"NM","B","RAUTL9",2)

"BLD",5205,"KRN",19,0)
19
"BLD",5205,"KRN",19.1,0)
19.1
"BLD",5205,"KRN",101,0)
101
"BLD",5205,"KRN",409.61,0)
409.61
"BLD",5205,"KRN",771,0)
771
"BLD",5205,"KRN",870,0)
870
"BLD",5205,"KRN",8989.51,0)
8989.51
"BLD",5205,"KRN",8989.52,0)
8989.52
"BLD",5205,"KRN",8994,0)
8994
"BLD",5205,"KRN","B",.4,.4)

"BLD",5205,"KRN","B",.401,.401)

"BLD",5205,"KRN","B",.402,.402)

"BLD",5205,"KRN","B",.403,.403)

"BLD",5205,"KRN","B",.5,.5)

"BLD",5205,"KRN","B",.84,.84)

"BLD",5205,"KRN","B",3.6,3.6)

"BLD",5205,"KRN","B",3.8,3.8)

"BLD",5205,"KRN","B",9.2,9.2)

"BLD",5205,"KRN","B",9.8,9.8)

"BLD",5205,"KRN","B",19,19)

"BLD",5205,"KRN","B",19.1,19.1)

"BLD",5205,"KRN","B",101,101)

"BLD",5205,"KRN","B",409.61,409.61)

"BLD",5205,"KRN","B",771,771)

"BLD",5205,"KRN","B",870,870)

"BLD",5205,"KRN","B",8989.51,8989.51)

"BLD",5205,"KRN","B",8989.52,8989.52)

"BLD",5205,"KRN","B",8994,8994)

"BLD",5205,"QUES",0)
^9.62^^
"BLD",5205,"REQB",0)
^9.611^3^3
"BLD",5205,"REQB",1,0)
RA*5.0*25^2
"BLD",5205,"REQB",2,0)
RA*5.0*27^2
"BLD",5205,"REQB",3,0)
RA*5.0*10^2
"BLD",5205,"REQB","B","RA*5.0*10",3)

"BLD",5205,"REQB","B","RA*5.0*25",1)

"BLD",5205,"REQB","B","RA*5.0*27",2)

"MBREQ")
0
"PKG",18,-1)
1^1
"PKG",18,0)
RADIOLOGY/NUCLEAR MEDICINE^RA^REGISTERS PATIENTS,RECORDS EXAMS,PROFILES,AMIS REPORTS
"PKG",18,20,0)
^9.402P^^
"PKG",18,22,0)
^9.49I^1^1
"PKG",18,22,1,0)
5.0^3011017^2980407^50
"PKG",18,22,1,"PAH",1,0)
51^3041216^2178
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","RAHLTCPB")
0^3^B56853424
"RTN","RAHLTCPB",1,0)
RAHLTCPB ;HIRMFO/REL,GJC,BNT - Rad/Nuc Med HL7 TCP/IP Bridge;05/21/99
"RTN","RAHLTCPB",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**12,17,25,51**;Mar 16, 1998
"RTN","RAHLTCPB",3,0)
EN1 ; Build the ^TMP("RARPT-REC" global when we receive the
"RTN","RAHLTCPB",4,0)
 ; message from HL7.
"RTN","RAHLTCPB",5,0)
 S RASUB=HL("MID") K RAERR
"RTN","RAHLTCPB",6,0)
 K ^TMP("RARPT-HL7",$J) ; clean area that holds data from HL7
"RTN","RAHLTCPB",7,0)
 K ^TMP("RARPT-REC",$J,RASUB) ; kill storage area for new HL7 message id
"RTN","RAHLTCPB",8,0)
 S ^TMP("RARPT-REC",$J,RASUB,"RADATE")=$$DT^XLFDT()
"RTN","RAHLTCPB",9,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  S ^TMP("RARPT-HL7",$J,I)=HLNODE,J=0 F  S J=$O(HLNODE(J)) Q:'J  S ^TMP("RARPT-HL7",$J,I,J)=HLNODE(J)
"RTN","RAHLTCPB",10,0)
 S CNT=2,SEGMNT=$G(^TMP("RARPT-HL7",$J,CNT))
"RTN","RAHLTCPB",11,0)
 S VNDR=$G(HL("SAN"))
"RTN","RAHLTCPB",12,0)
 S ^TMP("RARPT-REC",$J,RASUB,"VENDOR")=$G(HL("SAN"))
"RTN","RAHLTCPB",13,0)
PID ; Pick data off the 'PID' segment.
"RTN","RAHLTCPB",14,0)
 I $P(SEGMNT,HL("FS"))="PID" D
"RTN","RAHLTCPB",15,0)
 . S SEGMNT=$P(SEGMNT,HL("FS"),2,99999)
"RTN","RAHLTCPB",16,0)
 . I $P($P(SEGMNT,HL("FS"),3),$E(HL("ECH")))]"" D
"RTN","RAHLTCPB",17,0)
 .. S ^TMP("RARPT-REC",$J,RASUB,"RADFN")=$P($P(SEGMNT,HL("FS"),3),$E(HL("ECH")))
"RTN","RAHLTCPB",18,0)
 .. Q
"RTN","RAHLTCPB",19,0)
 . I $P(SEGMNT,HL("FS"),19)]"" D
"RTN","RAHLTCPB",20,0)
 .. S ^TMP("RARPT-REC",$J,RASUB,"RASSN")=$P(SEGMNT,HL("FS"),19)
"RTN","RAHLTCPB",21,0)
 .. Q
"RTN","RAHLTCPB",22,0)
 . Q
"RTN","RAHLTCPB",23,0)
 E  S RAERR="Missing PID segment" D XIT Q
"RTN","RAHLTCPB",24,0)
 I '(+$G(^TMP("RARPT-REC",$J,RASUB,"RADFN"))) D  Q
"RTN","RAHLTCPB",25,0)
 .S RAERR="Invalid Patient ID"
"RTN","RAHLTCPB",26,0)
 .D XIT
"RTN","RAHLTCPB",27,0)
 ; Save off E-Sig information (if it exists)
"RTN","RAHLTCPB",28,0)
 S:$D(HL("ESIG")) ^TMP("RARPT-REC",$J,RASUB,"RAESIG")=HL("ESIG")
"RTN","RAHLTCPB",29,0)
 ;
"RTN","RAHLTCPB",30,0)
OBR ; Pick data off the 'OBR' segment.
"RTN","RAHLTCPB",31,0)
 K SEGMNT F  S CNT=$O(^TMP("RARPT-HL7",$J,CNT)) Q:CNT=""  S SEGMNT=$G(^(CNT)) Q:$P(SEGMNT,HL("FS"))="OBR"  ; find the 'OBR' segment
"RTN","RAHLTCPB",32,0)
 I $P($G(SEGMNT),HL("FS"))'="OBR" S RAERR="Missing OBR segment" D XIT Q
"RTN","RAHLTCPB",33,0)
 S SEGMNT=$P(SEGMNT,HL("FS"),2,99999)
"RTN","RAHLTCPB",34,0)
 I $P(SEGMNT,HL("FS"),3)]"" D
"RTN","RAHLTCPB",35,0)
 . N RADTCN S RADTCN=$P(SEGMNT,HL("FS"),3)
"RTN","RAHLTCPB",36,0)
 . S:$P($P(RADTCN,$E(HL("ECH"))),"-")]"" ^TMP("RARPT-REC",$J,RASUB,"RADTI")=$P($P(RADTCN,$E(HL("ECH"))),"-")
"RTN","RAHLTCPB",37,0)
 . S:$P($P(RADTCN,$E(HL("ECH"))),"-",2)]"" ^TMP("RARPT-REC",$J,RASUB,"RACNI")=$P($P(RADTCN,$E(HL("ECH"))),"-",2)
"RTN","RAHLTCPB",38,0)
 . S:$P(RADTCN,$E(HL("ECH")),2)["&L" RADTCN=$TR(RADTCN,"&","^")
"RTN","RAHLTCPB",39,0)
 . S:$P(RADTCN,$E(HL("ECH")),2)]"" ^TMP("RARPT-REC",$J,RASUB,"RALONGCN")=$P(RADTCN,$E(HL("ECH")),2)
"RTN","RAHLTCPB",40,0)
 . Q
"RTN","RAHLTCPB",41,0)
 S RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,25,HL("FS")) K RAHL70
"RTN","RAHLTCPB",42,0)
 I RAHLD="" S RAERR="Missing Report Status" D XIT Q
"RTN","RAHLTCPB",43,0)
 I "AFR"'[RAHLD S RAERR="Invalid Report Status" D XIT Q
"RTN","RAHLTCPB",44,0)
 S ^TMP("RARPT-REC",$J,RASUB,"RASTAT")=RAHLD
"RTN","RAHLTCPB",45,0)
 S RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,32,HL("FS")) K RAHL70
"RTN","RAHLTCPB",46,0)
 I RAHLD']"" S RAERR="Missing Provider ID" D XIT Q
"RTN","RAHLTCPB",47,0)
 S RAVERF=RAHLD
"RTN","RAHLTCPB",48,0)
 ; -----   Check the validity of the provider name   -----
"RTN","RAHLTCPB",49,0)
 I '$D(^VA(200,"B",RAVERF)) D  ; check for a partial match in file 200
"RTN","RAHLTCPB",50,0)
 . D VFIER ; if one partial match found, return the entry ien
"RTN","RAHLTCPB",51,0)
 . Q
"RTN","RAHLTCPB",52,0)
 E  D  ; $D(^VA(200,"B",RAVERF)) true, get the entry ien
"RTN","RAHLTCPB",53,0)
 . S RAVERF=$O(^VA(200,"B",RAVERF,0))
"RTN","RAHLTCPB",54,0)
 . S:'RAVERF RAERR="Invalid Provider Name"
"RTN","RAHLTCPB",55,0)
 . Q
"RTN","RAHLTCPB",56,0)
 I $D(RAERR) D XIT Q
"RTN","RAHLTCPB",57,0)
 ; can't get resident info from medspeak
"RTN","RAHLTCPB",58,0)
 S RAHLD="",RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,33,HL("FS")),RARSDNT="" K RAHL70
"RTN","RAHLTCPB",59,0)
 I RAHLD]"" D
"RTN","RAHLTCPB",60,0)
 . S RARSDNT=$P(RAHLD,$E(HL("ECH"),4)) I '$D(^VA(200,+RARSDNT,0)) S RARSDNT=""
"RTN","RAHLTCPB",61,0)
 S RAHLD="",RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,35,HL("FS")),RATRSCRP="" K RAHL70
"RTN","RAHLTCPB",62,0)
 I RAHLD]"" D
"RTN","RAHLTCPB",63,0)
 . S RATRSCRP=$P(RAHLD,$E(HL("ECH"),4)) I '$D(^VA(200,+RATRSCRP,0)) S RATRSCRP=""
"RTN","RAHLTCPB",64,0)
 S ^TMP("RARPT-REC",$J,RASUB,"RAVERF")=RAVERF
"RTN","RAHLTCPB",65,0)
 S ^TMP("RARPT-REC",$J,RASUB,"RATRANSCRIPT")=$S(RATRSCRP]"":RATRSCRP,RARSDNT]"":RARSDNT,1:RAVERF)
"RTN","RAHLTCPB",66,0)
 S:$G(RARSDNT) ^TMP("RARPT-REC",$J,RASUB,"RARESIDENT")=RARSDNT
"RTN","RAHLTCPB",67,0)
 S ^TMP("RARPT-REC",$J,RASUB,"RASTAFF")=RAVERF,^("RAWHOCHANGE")=RAVERF
"RTN","RAHLTCPB",68,0)
 D ESIG
"RTN","RAHLTCPB",69,0)
 K RAHLD,RARSDNT,RATRSCRP
"RTN","RAHLTCPB",70,0)
 ;
"RTN","RAHLTCPB",71,0)
OBX ; Pick data off the 'OBX' segments
"RTN","RAHLTCPB",72,0)
 K SEGMNT F  S CNT=$O(^TMP("RARPT-HL7",$J,CNT)) Q:CNT=""  S SEGMNT=$G(^(CNT)) D:$P(SEGMNT,HL("FS"))="OBX"  Q:$D(RAERR)
"RTN","RAHLTCPB",73,0)
 . S SEGMNT=$P(SEGMNT,HL("FS"),2,9999)
"RTN","RAHLTCPB",74,0)
 . I $P(SEGMNT,HL("FS"),3)']"" S RAERR="Missing Observation Identifier" Q
"RTN","RAHLTCPB",75,0)
 . S OBXTYP=$P(SEGMNT,HL("FS"),3),OBXTYP=$E(OBXTYP,$F(OBXTYP,"&"))
"RTN","RAHLTCPB",76,0)
 . S OBX2CE=""
"RTN","RAHLTCPB",77,0)
 . S:OBXTYP="" OBXTYP=" "
"RTN","RAHLTCPB",78,0)
 . I OBXTYP=" "&($P(SEGMNT,HL("FS"),2)="CE") D
"RTN","RAHLTCPB",79,0)
 . . I $P(SEGMNT,HL("FS"),5)=" " S OBXTYP="F" Q
"RTN","RAHLTCPB",80,0)
 . . S OBX2CE=1,OBXTYP="D" Q
"RTN","RAHLTCPB",81,0)
 . I "IDRF"'[OBXTYP S RAERR="Invalid Observation Identifier" Q
"RTN","RAHLTCPB",82,0)
 . D RPT Q
"RTN","RAHLTCPB",83,0)
XIT I $D(RAERR) D EN1^RAHLEXF,GENACK G XIT1
"RTN","RAHLTCPB",84,0)
 I $D(^TMP("RARPT-REC",$J)) D EN1^RAHLO I $D(RAERR) D EN1^RAHLEXF,GENACK
"RTN","RAHLTCPB",85,0)
XIT1 K ^TMP("RARPT-REC",$J) ; kill storage area for current HL7 message id
"RTN","RAHLTCPB",86,0)
 K ^TMP("RARPT-HL7",$J) ; clean up HL7 storage
"RTN","RAHLTCPB",87,0)
 K CNT,OBXTYPE,X1,LIN,RADATE,RADTCN,RAERR,RAESIG,RAHLD,RANODE,RARCNT
"RTN","RAHLTCPB",88,0)
 K RAVERF,RASUB,SEGMNT,VNDR,MSA1,OBX2CE,RADX,RADX1,RADX2,RADX3
"RTN","RAHLTCPB",89,0)
 Q
"RTN","RAHLTCPB",90,0)
RPT ; Save off Report Text data.
"RTN","RAHLTCPB",91,0)
 N RAXADEDN
"RTN","RAHLTCPB",92,0)
 S RAXADEDN=^TMP("RARPT-REC",$J,RASUB,"RASTAT")
"RTN","RAHLTCPB",93,0)
 S RANODE=$S(OBXTYP="D":"RADX",OBXTYP="I":"RAIMP",1:"RATXT"),LIN=""
"RTN","RAHLTCPB",94,0)
 I OBX2CE D  Q
"RTN","RAHLTCPB",95,0)
 . S X=$P(SEGMNT,HL("FS"),5),RADX1=$P(X,$E(HL("ECH")))
"RTN","RAHLTCPB",96,0)
 . S LIN=RADX1,L=999 D P2 S LIN=X
"RTN","RAHLTCPB",97,0)
 . Q:X'["~"  F J=0:0 S J=$O(^TMP("RARPT-HL7",$J,CNT,J)) Q:'J  S X1=^(J),LIN=LIN_X1 Q
"RTN","RAHLTCPB",98,0)
 . S RADX=LIN,RADX2=$P($P(RADX,"~",2),"^") S:RADX2]"" LIN=RADX2 D P2
"RTN","RAHLTCPB",99,0)
 . S RADX3=$P($P(RADX,"~",3),"^") Q:RADX3']""  S LIN=RADX3 D P2 Q
"RTN","RAHLTCPB",100,0)
 S X=$P(SEGMNT,HL("FS"),5)
"RTN","RAHLTCPB",101,0)
 I X["\S\"!(X["\R\")!(X["\E\")!(X["\T\") D FORMAT
"RTN","RAHLTCPB",102,0)
 D PAR
"RTN","RAHLTCPB",103,0)
 F J=0:0 S J=$O(^TMP("RARPT-HL7",$J,CNT,J)) Q:'J  S X1=^(J),X=$E(X1,1,125) D PAR I $L(X1)>125 S X=$E(X1,126,999) D PAR
"RTN","RAHLTCPB",104,0)
 I X=""!(LIN'="") S L=999 D P2
"RTN","RAHLTCPB",105,0)
 Q
"RTN","RAHLTCPB",106,0)
FORMAT ; Format report text for Escape Character delimited codes.
"RTN","RAHLTCPB",107,0)
 S Y=X N T,Q
"RTN","RAHLTCPB",108,0)
 I Y["\S\" S Q=$F(Y,"\S\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"))_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",109,0)
 I Y["\R\" S Q=$F(Y,"\R\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"),2)_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",110,0)
 I Y["\E\" S Q=$F(Y,"\E\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"),3)_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",111,0)
 I Y["\T\" S Q=$F(Y,"\T\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"),4)_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",112,0)
 I X["\S\"!(X["\R\")!(X["\E\")!(X["\T\") D FORMAT
"RTN","RAHLTCPB",113,0)
 Q
"RTN","RAHLTCPB",114,0)
PAR ; Build text paragraph
"RTN","RAHLTCPB",115,0)
 S LIN=LIN_X
"RTN","RAHLTCPB",116,0)
P1 I $L(LIN)<80 Q
"RTN","RAHLTCPB",117,0)
 F L=80:-1:1 Q:$E(LIN,L)=" "
"RTN","RAHLTCPB",118,0)
 D P2 S LIN=$E(LIN,L+1,999) G P1
"RTN","RAHLTCPB",119,0)
P2 ; Set node
"RTN","RAHLTCPB",120,0)
 ; If Addendum and Report text is a space don't process
"RTN","RAHLTCPB",121,0)
 I $P(SEGMNT,HL("FS"),1)=1,RAXADEDN="A",RANODE="RATXT",$E(LIN,1,L-1)=" " Q
"RTN","RAHLTCPB",122,0)
 S RARCNT(OBXTYP)=$G(RARCNT(OBXTYP))+1
"RTN","RAHLTCPB",123,0)
 S ^TMP("RARPT-REC",$J,RASUB,RANODE,RARCNT(OBXTYP))=$E(LIN,1,L-1) Q
"RTN","RAHLTCPB",124,0)
 ;
"RTN","RAHLTCPB",125,0)
GENACK ; Compile the 'ACK' segment, generate the 'ACK' message.
"RTN","RAHLTCPB",126,0)
 S MSA1="AA"
"RTN","RAHLTCPB",127,0)
 Q:$E($G(VNDR),1,3)'="RA-"  ; Don't allow non RA namespaced interfaces
"RTN","RAHLTCPB",128,0)
 I $D(RAERR) S MSA1=$S(VNDR="RA-PSCRIBE-TCP":"AE",1:"AR")
"RTN","RAHLTCPB",129,0)
 ; Added next line to support MedSpeak interface.  Must re-initialize
"RTN","RAHLTCPB",130,0)
 ; FS and EC's before sending ACK.
"RTN","RAHLTCPB",131,0)
 D:VNDR="RA-CLIENT-TCP" INIT^HLFNC2("RA VOICE TCP SERVER RPT",.HL)
"RTN","RAHLTCPB",132,0)
 S HLA("HLA",1)="MSA"_HL("FS")_MSA1_HL("FS")_HL("MID")_$S($D(RAERR):HL("FS")_RAERR,1:"")
"RTN","RAHLTCPB",133,0)
 S HLEID=HL("EID"),HLEIDS=HL("EIDS"),HLARYTYP="LM",HLFORMAT=1,HLRESLTA=HL("MID")
"RTN","RAHLTCPB",134,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT,.HLRESTLA)
"RTN","RAHLTCPB",135,0)
 Q
"RTN","RAHLTCPB",136,0)
VFIER ; Check if the RAVERF string is a partial match to an entry in file
"RTN","RAHLTCPB",137,0)
 ; 200.  If if is, check to see that is a partial match to only ONE
"RTN","RAHLTCPB",138,0)
 ; active provider entry in file 200.
"RTN","RAHLTCPB",139,0)
 I '$L(RAVERF) S RAERR="Missing Provider information" Q
"RTN","RAHLTCPB",140,0)
 K RAVCNT,RAVIEN,RAVLGTH,RAVPS
"RTN","RAHLTCPB",141,0)
 S RAVLGTH=$L(RAVERF) ; length of the RAVERF string
"RTN","RAHLTCPB",142,0)
 S RAVCNT=0,RAVS1=RAVERF,RAVIEN=""
"RTN","RAHLTCPB",143,0)
 F  S RAVS1=$O(^VA(200,"B",RAVS1)) Q:RAVS1=""!($E(RAVS1,1,RAVLGTH)'=RAVERF)  D  Q:RAVCNT>1
"RTN","RAHLTCPB",144,0)
 . ; return subscripts that have the RAVERF string as the first
"RTN","RAHLTCPB",145,0)
 . ; 1 - RAVLGTH chars of RAVS1
"RTN","RAHLTCPB",146,0)
 . S RAVIEN=0
"RTN","RAHLTCPB",147,0)
 . F  S RAVIEN=$O(^VA(200,"B",RAVS1,RAVIEN)) Q:RAVIEN'>0  D  Q:RAVCNT>1
"RTN","RAHLTCPB",148,0)
 .. S RAVPS=$G(^VA(200,RAVIEN,"PS"))
"RTN","RAHLTCPB",149,0)
 .. S:'$P(RAVPS,"^",4)!($P(RAVPS,"^",4)>DT) RAVCNT=RAVCNT+1
"RTN","RAHLTCPB",150,0)
 .. I RAVCNT=1,('$D(RAVIEN(RAVCNT))#2) S RAVIEN(RAVCNT)=RAVIEN ; when
"RTN","RAHLTCPB",151,0)
 .. ; we find the first active provider save the provider ien off
"RTN","RAHLTCPB",152,0)
 .. ; in a local array.
"RTN","RAHLTCPB",153,0)
 .. Q
"RTN","RAHLTCPB",154,0)
 . Q
"RTN","RAHLTCPB",155,0)
 ; Added for PowerScribe
"RTN","RAHLTCPB",156,0)
 I RAVIEN']"" D
"RTN","RAHLTCPB",157,0)
 . S RAVIEN=$P(RAVERF,$E(HL("ECH"),4))
"RTN","RAHLTCPB",158,0)
 . S RAVPS=$G(^VA(200,RAVIEN,"PS"))
"RTN","RAHLTCPB",159,0)
 . S:'$P(RAVPS,"^",4)!($P(RAVPS,"^",4)>DT) RAVCNT=RAVCNT+1
"RTN","RAHLTCPB",160,0)
 . I RAVCNT=1,('$D(RAVIEN(RAVCNT))#2) S RAVIEN(RAVCNT)=RAVIEN
"RTN","RAHLTCPB",161,0)
 . Q
"RTN","RAHLTCPB",162,0)
 I RAVCNT=0 S RAERR="Invalid Provider Name" Q  ; partial match not found
"RTN","RAHLTCPB",163,0)
 I RAVCNT>1 S RAERR="Non-Unique Provider Name" Q  ; >1 partial match
"RTN","RAHLTCPB",164,0)
 S RAVERF=$G(RAVIEN(1)) S:'RAVERF RAERR="Provider Name Entry Error"
"RTN","RAHLTCPB",165,0)
 K RAVCNT,RAVIEN,RAVLGTH,RAVPS
"RTN","RAHLTCPB",166,0)
 Q
"RTN","RAHLTCPB",167,0)
 ;
"RTN","RAHLTCPB",168,0)
ESIG ; Added for COTS E-Sig capability
"RTN","RAHLTCPB",169,0)
 ;
"RTN","RAHLTCPB",170,0)
 I $D(RAERR) D XIT Q
"RTN","RAHLTCPB",171,0)
 Q:"FA"'[^TMP("RARPT-REC",$J,RASUB,"RASTAT")!('$D(^("RAVERF")))!($D(^("RAESIG")))
"RTN","RAHLTCPB",172,0)
 S RADFN=+$G(^TMP("RARPT-REC",$J,RASUB,"RADFN"))
"RTN","RAHLTCPB",173,0)
 S RADTI=+$G(^TMP("RARPT-REC",$J,RASUB,"RADTI"))
"RTN","RAHLTCPB",174,0)
 S RADIV=$P($G(^RADPT(RADFN,"DT",RADTI,0)),"^",3)
"RTN","RAHLTCPB",175,0)
 Q:RADIV=""  ; exam has been deleted - will be rejected
"RTN","RAHLTCPB",176,0)
 ; Check division parameters for ALLOW E-SIG ON COTS REPORT in file 79
"RTN","RAHLTCPB",177,0)
 ; for the division that ordered this procedure.
"RTN","RAHLTCPB",178,0)
 I $P(^RA(79,RADIV,.1),"^",27)["Y" D
"RTN","RAHLTCPB",179,0)
 . S RAESIG=$$GET1^DIQ(200,RAVERF,20.2)
"RTN","RAHLTCPB",180,0)
 . S:RAESIG]"" ^TMP("RARPT-REC",$J,RASUB,"RAESIG")=RAESIG
"RTN","RAHLTCPB",181,0)
 . Q
"RTN","RAHLTCPB",182,0)
 Q
"RTN","RAORD2")
0^1^B38868259
"RTN","RAORD2",1,0)
RAORD2 ;HISC/CAH,FPT,GJC,DAD AISC/RMO-Detailed Request Display ;9/3/99  13:48
"RTN","RAORD2",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**5,10,51**;Mar 16, 1998
"RTN","RAORD2",3,0)
 K XQADATA
"RTN","RAORD2",4,0)
 D HOME^%ZIS K DIC S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","RAORD2",5,0)
 W ! D ^DIC G Q:Y<0
"RTN","RAORD2",6,0)
 S RADFN=+Y,RANME=$S($D(^DPT(RADFN,0)):$P(^(0),"^"),1:"Unknown")
"RTN","RAORD2",7,0)
 S RAOFNS="Display",RAOVSTS="1;2;3;5;6;8" D LOCATN I $G(RAQUIT) D Q Q
"RTN","RAORD2",8,0)
 I RAONE]"" S ^TMP($J,"RA L-TYPE",$P(RAONE,"^"),$P(RAONE,"^",2))=""
"RTN","RAORD2",9,0)
 S ^TMP($J,"RA L-TYPE","Unknown")=""
"RTN","RAORD2",10,0)
 I '$D(^TMP($J,"RA L-TYPE")) D ERROR^RAUTL7A D Q QUIT
"RTN","RAORD2",11,0)
 S X=0 W !!,"Imaging Location(s) included:"
"RTN","RAORD2",12,0)
 F  S X=$O(^TMP($J,"RA L-TYPE",X)) Q:X']""  D
"RTN","RAORD2",13,0)
 . W:($X+$L(X)+2)'<IOM !?$L("Imaging Location(s) included:") W ?($X+3),X
"RTN","RAORD2",14,0)
 . Q
"RTN","RAORD2",15,0)
 W ! K DIR S DIR(0)="E" D ^DIR K DIR I $D(DUOUT)!($D(DTOUT)) D Q Q
"RTN","RAORD2",16,0)
 D ^RAORDS G Q:'$D(RAORDS)
"RTN","RAORD2",17,0)
OERR ; Entry Point for OE/RR Cancel/Hold Alert
"RTN","RAORD2",18,0)
 I $D(XQADATA) D
"RTN","RAORD2",19,0)
 . S RAORDS(1)=+XQADATA
"RTN","RAORD2",20,0)
 . I $P(XQADATA,",",2)'="" S RADFN=$P(XQADATA,",",2)
"RTN","RAORD2",21,0)
 S RAPKG="",RAOSTSYM="dc^c^h^^p^^^s",$P(RALNE,"-",79)="",RAX=""
"RTN","RAORD2",22,0)
 F RAOLP=1:1 S RAOIFN=$S($D(RAORDS(RAOLP)):RAORDS(RAOLP),1:0) Q:'RAOIFN!(RAX=U)  D DISORD
"RTN","RAORD2",23,0)
 ;
"RTN","RAORD2",24,0)
 K:RAX="^" XQAID,XQAKILL I $D(XQAID) S DFN=$P(XQAID,",",2) D DELETE^XQALERT
"RTN","RAORD2",25,0)
Q K %,DIC,I,OREND,RA,RACI,RACNI,RADFN,RADIV,RADIVPAR,RADPT0,RADTI,RALNE
"RTN","RAORD2",26,0)
 K RANME,RAOFNS,RAOIFN,RAOLP,RAORD0,RAORDS,RAOSTS,RAOSTSYM,RAOVSTS,RAPKG
"RTN","RAORD2",27,0)
 K RAONE,RAQUIT,RASSN,X,XQAID,XQALERT,Y,RAX,VA200,VAERR,VAIP
"RTN","RAORD2",28,0)
 K RAPARENT
"RTN","RAORD2",29,0)
 K DFN,DIPGM,DISYS,DIW,DIWI,DIWT,DIWTC,DIWX,DN,RA6,RA7,POP,^TMP($J,"PRO-ORD")
"RTN","RAORD2",30,0)
 K ^TMP($J,"RA L-TYPE"),^TMP($J,"RAORDS"),^TMP($J,"RA DIFF PRC") Q
"RTN","RAORD2",31,0)
 ;
"RTN","RAORD2",32,0)
 ;
"RTN","RAORD2",33,0)
DISORD Q:'$D(^DPT(RADFN,0))  S RADPT0=^(0),RA("NME")=$P(RADPT0,"^"),RA("DOB")=$P(RADPT0,"^",3),RASSN=$$SSN^RAUTL Q:'$D(^RAO(75.1,RAOIFN,0))  S RAORD0=^(0)
"RTN","RAORD2",34,0)
 I $D(^RADPT("AO",RAOIFN,RADFN)) D DPRC(RAOIFN,RADFN)
"RTN","RAORD2",35,0)
 S RA("PROC. NODE")=$G(^RAMIS(71,+$P(RAORD0,U,2),0))
"RTN","RAORD2",36,0)
 S RA("PRC")=$E($P(RA("PROC. NODE"),U),1,36)
"RTN","RAORD2",37,0)
 S RA("PRCTY")=$P(RA("PROC. NODE"),U,6)
"RTN","RAORD2",38,0)
 S RA("PRCTY")=$$XTERNAL^RAUTL5(RA("PRCTY"),$P($G(^DD(71,6,0)),U,2))
"RTN","RAORD2",39,0)
 S RA("PRCTY")=$E(RA("PRCTY"))_$$LOW^XLFSTR($E(RA("PRCTY"),2,99))
"RTN","RAORD2",40,0)
 S RA("CPT")=+$P(RA("PROC. NODE"),U,9)
"RTN","RAORD2",41,0)
 ; don't find CPT code if procedure has type = Parent
"RTN","RAORD2",42,0)
 S RA("CPT")=$S($E(RA("PRCTY"))="P":"",1:$P($$NAMCODE^RACPTMSC(RA("CPT"),DT),U))
"RTN","RAORD2",43,0)
 S RA("PRCIT")=+$P(RA("PROC. NODE"),U,12)
"RTN","RAORD2",44,0)
 S RA("PRCIT")=$P($G(^RA(79.2,RA("PRCIT"),0)),U,3)
"RTN","RAORD2",45,0)
 S RA("PROC INFO")="",$E(RA("PROC INFO"),1,36)=RA("PRC")
"RTN","RAORD2",46,0)
 S RA("CNCAT")="("_RA("PRCIT")_" "_RA("PRCTY")_" "_RA("CPT")_")"
"RTN","RAORD2",47,0)
 S $E(RA("PROC INFO"),38,60)=RA("CNCAT") K RA("CNCAT"),RA("PRCIT")
"RTN","RAORD2",48,0)
 K RA("PRCTY"),RA("CPT")
"RTN","RAORD2",49,0)
 K RA("MOD") F I=0:0 S I=$O(^RAO(75.1,RAOIFN,"M","B",I)) Q:'I  I $D(^RAMIS(71.2,+I,0)) S RA("MOD")=$S('$D(RA("MOD")):$P(^(0),"^"),1:RA("MOD")_", "_$P(^(0),"^"))
"RTN","RAORD2",50,0)
 S RA("OST")=$P($P(^DD(75.1,5,0),$P(RAORD0,"^",5)_":",2),";")_$S($P(RAOSTSYM,"^",$P(RAORD0,"^",5))="":"",1:" ("_$P(RAOSTSYM,"^",$P(RAORD0,"^",5))_")")
"RTN","RAORD2",51,0)
 S RA("PHY")=$S($D(^VA(200,+$P(RAORD0,"^",14),0)):$P(^(0),"^"),1:"")
"RTN","RAORD2",52,0)
 ; Requesting Physician phone/pager info
"RTN","RAORD2",53,0)
 D PHONE^RAORD5("R",+$P(RAORD0,"^",14))
"RTN","RAORD2",54,0)
 S RA("HLC")=$S($D(^SC(+$P(RAORD0,"^",22),0)):$P(^(0),"^"),1:"")
"RTN","RAORD2",55,0)
 S DFN=RADFN,VA200=1 D IN5^VADPT I VAIP(1) S RA("ROOM-BED")=$S(+VAIP(6):$P(VAIP(6),"^",2),1:"")
"RTN","RAORD2",56,0)
 K RA("ODT") S X=$P(RAORD0,"^",16) I X S:$P(X,".",2) X=$P(X,".")_"."_$$NOSECNDS^RAORD3($P(X,".",2)) S RA("ODT")=$$FMTE^XLFDT(X,"1P")
"RTN","RAORD2",57,0)
 S RA("USR")=$S($D(^VA(200,+$P(RAORD0,"^",15),0)):$P(^(0),"^"),1:"")
"RTN","RAORD2",58,0)
 D HDR ; display a header
"RTN","RAORD2",59,0)
 W !,"Requested:",?17,RA("PROC INFO")
"RTN","RAORD2",60,0)
 I $D(^TMP($J,"RA DIFF PRC")) D
"RTN","RAORD2",61,0)
 . N I S I="" W !,"Registered:"
"RTN","RAORD2",62,0)
 . F  S I=$O(^TMP($J,"RA DIFF PRC",I)) Q:I']""  W ?11,I,!
"RTN","RAORD2",63,0)
 . Q
"RTN","RAORD2",64,0)
 W:$D(RA("MOD")) !,"Procedure Modifiers:",?22,RA("MOD")
"RTN","RAORD2",65,0)
 W !!,"Current Status:",?22,$E(RA("OST"),1,24)
"RTN","RAORD2",66,0)
 W !,"Requestor:",?22,$E(RA("PHY"),1,24)
"RTN","RAORD2",67,0)
 W !?1,"Tel/Page/Dig Page: ",RA("RPHOINFO")
"RTN","RAORD2",68,0)
 W !,"Patient Location:",?22,$E(RA("HLC"),1,20)
"RTN","RAORD2",69,0)
 W:$D(RA("ROOM-BED")) !,"Room-Bed:",?22,$E(RA("ROOM-BED"),1,20)
"RTN","RAORD2",70,0)
 W !,"Entered:",?22,$S($D(RA("ODT")):RA("ODT"),1:""),"  by ",$E(RA("USR"),1,20)
"RTN","RAORD2",71,0)
 ;
"RTN","RAORD2",72,0)
ENDIS ;OE/RR Entry Point for the PRINT ACTION Option
"RTN","RAORD2",73,0)
 I '$D(RAPKG) Q:'$D(ORPK)  S RAOIFN=+ORPK Q:'$D(^RAO(75.1,RAOIFN,0))  S RAORD0=^(0),RADFN=+$P(RAORD0,"^")
"RTN","RAORD2",74,0)
 S RA("TRAN")=$S($P(RAORD0,"^",19)']"":"",1:$P($P(^DD(75.1,19,0),$P(RAORD0,"^",19)_":",2),";"))
"RTN","RAORD2",75,0)
 K RA("ST") I $D(^RADPT("AO",RAOIFN,RADFN)) S RADTI=+$O(^(RADFN,0)),RACNI=+$O(^(RADTI,0)) I $D(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)) S RA(0)=^(0) I $D(^RA(72,+$P(RA(0),"^",3),0)) S RA("ST")=$P(^(0),"^")
"RTN","RAORD2",76,0)
 I '$D(RAPKG) D DPRC(RAOIFN,RADFN) K ^TMP($J,"RA DIFF PRC")
"RTN","RAORD2",77,0)
 S RADIV(0)=$G(^SC(+$P(RAORD0,"^",22),0))
"RTN","RAORD2",78,0)
 S RADIV=+$$SITE^VASITE(DT,+$P(RADIV(0),"^",15)) S:RADIV<0 RADIV=0
"RTN","RAORD2",79,0)
 S RADIV=$S($D(^RA(79,RADIV,0)):RADIV,1:$O(^RA(79,0)))
"RTN","RAORD2",80,0)
 S RADIVPAR=$S($D(^RA(79,+RADIV,.1)):^(.1),1:"")
"RTN","RAORD2",81,0)
 K RA("RDT") S Y=$P(RAORD0,"^",21) I Y S:$P(Y,".",2) Y=$P(Y,".")_"."_$$NOSECNDS^RAORD3($P(Y,".",2)) S RA("RDT")=$$FMTE^XLFDT(Y,"1P")
"RTN","RAORD2",82,0)
 K RA("PDT") S Y=$P(RAORD0,"^",12) I Y S:$P(Y,".",2) Y=$P(Y,".")_"."_$$NOSECNDS^RAORD3($P(Y,".",2)) S RA("PDT")=$$FMTE^XLFDT(Y,"1P")
"RTN","RAORD2",83,0)
 K RA("VDT") S Y=$P(RAORD0,"^",17) I Y S:$P(Y,".",2) Y=$P(Y,".")_"."_$$NOSECNDS^RAORD3($P(Y,".",2)) S RA("VDT")=$$FMTE^XLFDT(Y,"1P")
"RTN","RAORD2",84,0)
 K RA("SDT") S Y=$P(RAORD0,"^",23) I Y S:$P(Y,".",2) Y=$P(Y,".")_"."_$$NOSECNDS^RAORD3($P(Y,".",2)) S RA("SDT")=$$FMTE^XLFDT(Y,"1P")
"RTN","RAORD2",85,0)
 S RA("ILC")=$S('$P(RAORD0,"^",20):"UNKNOWN",'$D(^RA(79.1,+$P(RAORD0,"^",20),0)):"UNKNOWN",$D(^SC(+^(0),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","RAORD2",86,0)
 I $S('$D(XQORNOD(0)):0,$P(XQORNOD(0),"^",3)'="Results Display":0,1:1),$D(RA(0)) D ^RAORR3 Q
"RTN","RAORD2",87,0)
 D ^RAORD3 K RA,RACI,RACNI,RADIV,RADIVPAR,RADPT0,RADTI,RAORD0,RAOSTS,X,Y I '$D(RAPKG) K RADFN,RAOIFN
"RTN","RAORD2",88,0)
 Q
"RTN","RAORD2",89,0)
LOCATN ; Select or default to a Rad/Nuc Med location.
"RTN","RAORD2",90,0)
 S RAONE=$$LOC1() Q:RAONE]""
"RTN","RAORD2",91,0)
 S RADIC="^RA(79.1,",RADIC(0)="QEAMZ"
"RTN","RAORD2",92,0)
 S RADIC("A")="Select Rad/Nuc Med Location: "
"RTN","RAORD2",93,0)
 S RADIC("B")="All",RAUTIL="RA L-TYPE"
"RTN","RAORD2",94,0)
 W !! D EN1^RASELCT(.RADIC,RAUTIL) K DIC,RADIC,RAUTIL,X,Y
"RTN","RAORD2",95,0)
 Q
"RTN","RAORD2",96,0)
LOC1() ; Checking for only one Imaging Location
"RTN","RAORD2",97,0)
 ; Pass back null if more that one entry exists in 79.1 
"RTN","RAORD2",98,0)
 ; If one entry, pass back: external Hosp. Loc. file_"^"_IEN of file 79.1
"RTN","RAORD2",99,0)
 N X,Y S X=""
"RTN","RAORD2",100,0)
 I $P($G(^RA(79.1,0)),"^",4)=1 D
"RTN","RAORD2",101,0)
 . S Y=+$O(^RA(79.1,0)) Q:'Y
"RTN","RAORD2",102,0)
 . S Y(0)=$G(^RA(79.1,Y,0)),Y(1)=+$P(Y(0),"^")
"RTN","RAORD2",103,0)
 . S Y(44)=$P($G(^SC(Y(1),0)),"^"),X=Y(44)_"^"_Y
"RTN","RAORD2",104,0)
 . Q
"RTN","RAORD2",105,0)
 Q X
"RTN","RAORD2",106,0)
HDR ; Header for the 'Detailed Request Display' option.  Called from above
"RTN","RAORD2",107,0)
 ; (D HDR) and from RAORD3
"RTN","RAORD2",108,0)
 W @IOF,?22,"**** Detailed Display ****",!!,"Name: ",RA("NME"),"    (",RASSN,")" S Y=RA("DOB") D D^RAUTL W ?45,"Date of Birth: ",Y,!,RALNE
"RTN","RAORD2",109,0)
 Q
"RTN","RAORD2",110,0)
DPRC(RAOIFN,RADFN) ; If the requested and registered procedures differ,
"RTN","RAORD2",111,0)
 ; store off the registered procedure in ^TMP($J,"RA DIFF PRC")
"RTN","RAORD2",112,0)
 ;
"RTN","RAORD2",113,0)
 ; NOTE: The only time we don't set ^TMP($J,"RA DIFF PRC") is when
"RTN","RAORD2",114,0)
 ; we are using the 'Detailed Request Display' option and the ordered
"RTN","RAORD2",115,0)
 ; procedure is the same as the registered procedure.  All other
"RTN","RAORD2",116,0)
 ; Request display options output the ordered procedure, the
"RTN","RAORD2",117,0)
 ; registered procedure and exam case number if the order
"RTN","RAORD2",118,0)
 ; is active.
"RTN","RAORD2",119,0)
 ;
"RTN","RAORD2",120,0)
 N RA7003,RACNI,RADTI,RAFLG K RA("ST"),^TMP($J,"RA DIFF PRC")
"RTN","RAORD2",121,0)
 S (RADTI,RAFLG)=0
"RTN","RAORD2",122,0)
 F  S RADTI=+$O(^RADPT("AO",RAOIFN,RADFN,RADTI)) Q:RADTI'>0  D
"RTN","RAORD2",123,0)
 . S RACNI=0
"RTN","RAORD2",124,0)
 . F  S RACNI=$O(^RADPT("AO",RAOIFN,RADFN,RADTI,RACNI)) Q:RACNI'>0  D
"RTN","RAORD2",125,0)
 .. I $D(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)) D
"RTN","RAORD2",126,0)
 ... S RA7003=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),RAFLG=RAFLG+1
"RTN","RAORD2",127,0)
 ... S RA("ST")=$$GET1^DIQ(72,+$P(RA7003,"^",3)_",",.01)
"RTN","RAORD2",128,0)
 ... N RAPRC S RAPRC=$$DPROC^RAUTL15(RADFN,RADTI,RACNI,RAOIFN)
"RTN","RAORD2",129,0)
 ... S:RAPRC]"" ^TMP($J,"RA DIFF PRC",RAPRC)=""
"RTN","RAORD2",130,0)
 ... Q
"RTN","RAORD2",131,0)
 .. Q
"RTN","RAORD2",132,0)
 . Q
"RTN","RAORD2",133,0)
 K:RAFLG>1 RA("ST") ; >1 reg. xam for this order, RA("ST") not valid
"RTN","RAORD2",134,0)
 Q
"RTN","RAUTL9")
0^2^B31156793
"RTN","RAUTL9",1,0)
RAUTL9 ;HISC/FPT-Utility Routines ;4/9/97  10:08
"RTN","RAUTL9",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**13,27,51**;Mar 16, 1998
"RTN","RAUTL9",3,0)
EN1 ; allow lower & uppercase response to REPORT STATUS field
"RTN","RAUTL9",4,0)
 ; called from [RA REPORT EDIT] & [RA VERIFY REPORT ONLY]
"RTN","RAUTL9",5,0)
 ;   "      "  routine UNVER+2^RARTE1
"RTN","RAUTL9",6,0)
 ;
"RTN","RAUTL9",7,0)
 N Y K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","RAUTL9",8,0)
 N RAMT S RAMT=0 ; RAMT=$S(Report status before edit="":0,1:1)
"RTN","RAUTL9",9,0)
 D IARU
"RTN","RAUTL9",10,0)
 I RATRUE=1 S DIR(0)="S^V:VERIFIED;R:RELEASED/NOT VERIFIED;PD:PROBLEM DRAFT;D:DRAFT"
"RTN","RAUTL9",11,0)
 I RATRUE=0 S DIR(0)="S^V:VERIFIED;PD:PROBLEM DRAFT;D:DRAFT"
"RTN","RAUTL9",12,0)
 S DIR("A")="REPORT STATUS"
"RTN","RAUTL9",13,0)
 S:$P(^RARPT(D0,0),"^",5)="" RAMT=1
"RTN","RAUTL9",14,0)
 S:$P(^RARPT(D0,0),"^",5)]"" DIR("B")=$P(^RARPT(D0,0),"^",5)
"RTN","RAUTL9",15,0)
 S:RAMT DIR("B")="D" ; default to 'Draft' if missing report status
"RTN","RAUTL9",16,0)
 D ^DIR K DIR,RATRUE
"RTN","RAUTL9",17,0)
 I $D(DIRUT),(RAMT) D
"RTN","RAUTL9",18,0)
 . S $P(^RARPT(D0,0),"^",5)="D" D ENSET^RAXREF(74,5,"D",D0)
"RTN","RAUTL9",19,0)
 . ; set Report Status to 'Draft' if originally null, and user times out
"RTN","RAUTL9",20,0)
 . ; or '^' out!  Make sure xrefs are set!
"RTN","RAUTL9",21,0)
 . Q
"RTN","RAUTL9",22,0)
 Q:$D(DIRUT)
"RTN","RAUTL9",23,0)
 I $E(Y)="V",'$D(^XUSEC("RA VERIFY",DUZ)) W !!,*7,"You do not have the appropriate privileges to verify a report." G EN1
"RTN","RAUTL9",24,0)
 S RASTATX=$E(Y) S:RASTATX="P" RASTATX="PD"
"RTN","RAUTL9",25,0)
 Q
"RTN","RAUTL9",26,0)
EN2 ; residents enter report status to pre-verify
"RTN","RAUTL9",27,0)
 ; called from input templates [RA PRE-VERIFY REPORT EDIT] and [RA PRE-
"RTN","RAUTL9",28,0)
 ; VERIFY REPORT ONLY]
"RTN","RAUTL9",29,0)
 N Y K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","RAUTL9",30,0)
 N RAMT S RAMT=0 ; RAMT=$S(Report status before edit="":0,1:1)
"RTN","RAUTL9",31,0)
 D IARU
"RTN","RAUTL9",32,0)
 I RATRUE=1 S DIR(0)="S^R:RELEASED/NOT VERIFIED;PD:PROBLEM DRAFT;D:DRAFT"
"RTN","RAUTL9",33,0)
 I RATRUE=0 S DIR(0)="S^PD:PROBLEM DRAFT;D:DRAFT"
"RTN","RAUTL9",34,0)
 S DIR("A")="RESIDENT PRE-VERIFICATION REPORT STATUS"
"RTN","RAUTL9",35,0)
 S:$P(^RARPT(D0,0),"^",5)="" RAMT=1
"RTN","RAUTL9",36,0)
 S:$P(^RARPT(D0,0),"^",5)]"" DIR("B")=$P(^RARPT(D0,0),"^",5)
"RTN","RAUTL9",37,0)
 S:RAMT DIR("B")="D" ; default to 'Draft' if missing report status
"RTN","RAUTL9",38,0)
 D ^DIR K DIR,RATRUE
"RTN","RAUTL9",39,0)
 I $D(DIRUT),(RAMT) D
"RTN","RAUTL9",40,0)
 . S $P(^RARPT(D0,0),"^",5)="D" D ENSET^RAXREF(74,5,"D",D0)
"RTN","RAUTL9",41,0)
 . ; set Report Status to 'Draft' if originally null, and user times out
"RTN","RAUTL9",42,0)
 . ; or '^' out!  Make sure xrefs are set!
"RTN","RAUTL9",43,0)
 . Q
"RTN","RAUTL9",44,0)
 Q:$D(DIRUT)
"RTN","RAUTL9",45,0)
 S RASTATX=$E(Y) S:RASTATX="P" RASTATX="PD"
"RTN","RAUTL9",46,0)
 Q
"RTN","RAUTL9",47,0)
EN3 ; residents pre-verify a report
"RTN","RAUTL9",48,0)
 N Y K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","RAUTL9",49,0)
 W ! S DIR(0)="Y",DIR("A")="WANT TO PRE-VERIFY THIS REPORT"
"RTN","RAUTL9",50,0)
 S DIR("?")="Answer YES to mark this report as pre-verified. Your user ID number, electronic signature code and the current date/time will be stored in the pre-verification fields of this entry."
"RTN","RAUTL9",51,0)
 D ^DIR K DIR
"RTN","RAUTL9",52,0)
 W ! Q:$D(DIRUT)
"RTN","RAUTL9",53,0)
 S RAYN=+Y
"RTN","RAUTL9",54,0)
 Q
"RTN","RAUTL9",55,0)
EN4 ; re-display report text question
"RTN","RAUTL9",56,0)
 N Y K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","RAUTL9",57,0)
 S DIR(0)="Y",DIR("A")="Want to View the Report Text again" D ^DIR K DIR
"RTN","RAUTL9",58,0)
 W ! Q:$D(DIRUT)
"RTN","RAUTL9",59,0)
 S RAYN=Y
"RTN","RAUTL9",60,0)
 Q
"RTN","RAUTL9",61,0)
EXIST ; Checks if word processing data exists called from [RA REPORT EDIT]
"RTN","RAUTL9",62,0)
 ; and [RA PRE-VERIFY REPORT EDIT] templates.
"RTN","RAUTL9",63,0)
 I RANODE="H",(($D(DTOUT))!($D(DUOUT))) D  Q
"RTN","RAUTL9",64,0)
 . D CHRSTOR
"RTN","RAUTL9",65,0)
 I RANODE="R",(($D(DTOUT))!($D(DUOUT))) Q
"RTN","RAUTL9",66,0)
 I RANODE="I",(($D(DTOUT))!($D(DUOUT))) Q
"RTN","RAUTL9",67,0)
 I +$O(^RARPT(DA,RANODE,0)) D  Q
"RTN","RAUTL9",68,0)
 . N CNT,X,X1,X2,X3,X4,RAWPFLG S (RAWPFLG,X)=0
"RTN","RAUTL9",69,0)
 . F  S X=$O(^RARPT(DA,RANODE,X)) Q:X'>0  D  Q:RAWPFLG
"RTN","RAUTL9",70,0)
 .. S (CNT,X2)=0
"RTN","RAUTL9",71,0)
 .. S X1=$G(^RARPT(DA,RANODE,X,0)) Q:X1']""
"RTN","RAUTL9",72,0)
 .. S X2=$L(X1)
"RTN","RAUTL9",73,0)
 .. F X3=1:1:X2 D  Q:RAWPFLG
"RTN","RAUTL9",74,0)
 ... S X4=$E(X1,X3) S:X4?1AN CNT=CNT+1
"RTN","RAUTL9",75,0)
 ... S:X4'?1AN&(CNT>0) CNT=0
"RTN","RAUTL9",76,0)
 ... S:CNT=2 RAWPFLG=1
"RTN","RAUTL9",77,0)
 ... Q
"RTN","RAUTL9",78,0)
 .. Q
"RTN","RAUTL9",79,0)
 . I 'RAWPFLG D
"RTN","RAUTL9",80,0)
 .. S Y=$S(RANODE="H":"@1",RANODE="R":"@2",1:"@3")
"RTN","RAUTL9",81,0)
 .. W " ?? Invalid "
"RTN","RAUTL9",82,0)
 .. W $S(RANODE="H":"Clinical History",RANODE="R":"Report",1:"Impression")
"RTN","RAUTL9",83,0)
 .. W " text.",$C(7)
"RTN","RAUTL9",84,0)
 .. K ^RARPT(DA,RANODE) ; Clear out bad WP
"RTN","RAUTL9",85,0)
 .. Q
"RTN","RAUTL9",86,0)
 . I RANODE="H",('RAWPFLG) D CHRSTOR
"RTN","RAUTL9",87,0)
 . Q
"RTN","RAUTL9",88,0)
 Q
"RTN","RAUTL9",89,0)
CHRSTOR ; Restores original data to the Clinical History field in the
"RTN","RAUTL9",90,0)
 ; Rad/Nuc Med Reports File.  Global: ^RARPT(  File #: 74
"RTN","RAUTL9",91,0)
 ; Set ^RARPT('DA',"H") array to value in ^TMP($J,"RA Clin Hist")
"RTN","RAUTL9",92,0)
 N %X,%Y,Y
"RTN","RAUTL9",93,0)
 S %X="^TMP($J,""RA Clin Hist"",",%Y="^RARPT("_DA_",""H"","
"RTN","RAUTL9",94,0)
 D %XY^%RCR K ^TMP($J,"RA Clin Hist")
"RTN","RAUTL9",95,0)
 Q
"RTN","RAUTL9",96,0)
CHSAVE ; Checks if word processing data exists called from [RA REPORT EDIT]
"RTN","RAUTL9",97,0)
 ; and [RA PRE-VERIFY REPORT EDIT] templates.  For the 'Clinical History'
"RTN","RAUTL9",98,0)
 ; field.
"RTN","RAUTL9",99,0)
 ; Save off existing text in a ^TMP global.
"RTN","RAUTL9",100,0)
 K ^TMP($J,"RA Clin Hist") N %X,%Y
"RTN","RAUTL9",101,0)
 S %X="^RARPT("_DA_",""H"",",%Y="^TMP($J,""RA Clin Hist"","
"RTN","RAUTL9",102,0)
 D %XY^%RCR
"RTN","RAUTL9",103,0)
 Q
"RTN","RAUTL9",104,0)
CHPRINT ; Prints text from the 'Clinical History' field in file 70
"RTN","RAUTL9",105,0)
 ; from [RA REPORT EDIT] template.  Added with patch RA*5*27 - bnt
"RTN","RAUTL9",106,0)
 ;
"RTN","RAUTL9",107,0)
 N DIR,DTOUT,DUOUT
"RTN","RAUTL9",108,0)
 D EN^DDIOL("CLINICAL HISTORY:")
"RTN","RAUTL9",109,0)
 S DIWL=1,DIWF="|WC75",RAV=0 K ^UTILITY($J,"W")
"RTN","RAUTL9",110,0)
 F  S RAV=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"H",RAV)) Q:RAV'>0  D
"RTN","RAUTL9",111,0)
 . S X=^RADPT(RADFN,"DT",RADTI,"P",RACNI,"H",RAV,0)
"RTN","RAUTL9",112,0)
 . D ^DIWP
"RTN","RAUTL9",113,0)
 D ^DIWW S X=""
"RTN","RAUTL9",114,0)
 Q
"RTN","RAUTL9",115,0)
OUTTEXT(X,DIWF,DIWL,DIWR,RAFMAT,RALFF,RATFF) ; Output generic text using DIWP
"RTN","RAUTL9",116,0)
 ;INPUT VARIABLES:
"RTN","RAUTL9",117,0)
 ; 'X'      --> Text to be formatted    'DIWF'  -->  Format control data
"RTN","RAUTL9",118,0)
 ; 'DIWL'   --> Left margin             'DIWR'  -->  Right margin
"RTN","RAUTL9",119,0)
 ; 'RAFMAT' --> Tabs for columns        'RALFF' -->  Leading line feed
"RTN","RAUTL9",120,0)
 ; 'RATFF'  --> Trailing line feed
"RTN","RAUTL9",121,0)
 N DIW,DIWI,DIWT,DIWTC,DIWX,RALFMAT,RATFMAT,Y,Z
"RTN","RAUTL9",122,0)
 Q:X']""  S RAFMAT=+$G(RAFMAT)
"RTN","RAUTL9",123,0)
 S RALFF=$TR($G(RALFF),$G(RALFF),"!")
"RTN","RAUTL9",124,0)
 S RATFF=$TR($G(RATFF),$G(RATFF),"!")
"RTN","RAUTL9",125,0)
 S RALFMAT=RALFF_"?"_RAFMAT,RATFMAT=RATFF
"RTN","RAUTL9",126,0)
 K ^UTILITY($J,"W",DIWL) D ^DIWP
"RTN","RAUTL9",127,0)
 S Y=0 F  S Y=$O(^UTILITY($J,"W",DIWL,Y)) Q:Y'>0  D
"RTN","RAUTL9",128,0)
 . S Y(0)=$G(^UTILITY($J,"W",DIWL,Y,0)) W @RALFMAT,Y(0)
"RTN","RAUTL9",129,0)
 . S Z=$O(^UTILITY($J,"W",DIWL,Y))
"RTN","RAUTL9",130,0)
 . W:RATFMAT]""&(Z>0) @RATFF
"RTN","RAUTL9",131,0)
 . Q
"RTN","RAUTL9",132,0)
 K ^UTILITY($J,"W")
"RTN","RAUTL9",133,0)
 Q
"RTN","RAUTL9",134,0)
STOPCHK ; does user want to stop task?
"RTN","RAUTL9",135,0)
 I $$S^%ZTLOAD D
"RTN","RAUTL9",136,0)
 . S ZTSTOP=1 K ZTREQ
"RTN","RAUTL9",137,0)
 . W !?10,"*** OUTPUT STOPPED AT USER'S REQUEST ***"
"RTN","RAUTL9",138,0)
 . W !?10,"Option Name: ",$S($P($G(XQY0),"^")]"":$P($G(XQY0),"^"),1:"Unknown")
"RTN","RAUTL9",139,0)
 . W !?10,"Option Menu Text: ",$S($P($G(XQY0),"^",2)]"":$P($G(XQY0),"^",2),1:"Unknown")
"RTN","RAUTL9",140,0)
 . W !?10,"Task #: ",$S(+$G(ZTSK)>0:+$G(ZTSK),1:"Unknown")
"RTN","RAUTL9",141,0)
 . Q
"RTN","RAUTL9",142,0)
 Q
"RTN","RAUTL9",143,0)
UPDTPNT(RAIEN) ; Remove the possibility of broken pointers when a report
"RTN","RAUTL9",144,0)
 ; is deleted from the Rad/Nuc Med Reports file (74).  This checks the
"RTN","RAUTL9",145,0)
 ; following files: Report Batches file (74.2) and the
"RTN","RAUTL9",146,0)
 ; Report Distribution file (74.4)
"RTN","RAUTL9",147,0)
 N A,B,DA,DIK
"RTN","RAUTL9",148,0)
 I $D(^RABTCH(74.2,"D",RAIEN)) D
"RTN","RAUTL9",149,0)
 . S A=0 F  S A=$O(^RABTCH(74.2,"D",RAIEN,A)) Q:A'>0  D
"RTN","RAUTL9",150,0)
 .. S B=0 F  S B=$O(^RABTCH(74.2,"D",RAIEN,A,B)) Q:B'>0  D
"RTN","RAUTL9",151,0)
 ... S DA=B,DA(1)=A,DIK="^RABTCH(74.2,"_DA(1)_",""R"","
"RTN","RAUTL9",152,0)
 ... D ^DIK K DA,DIK
"RTN","RAUTL9",153,0)
 ... Q
"RTN","RAUTL9",154,0)
 .. Q
"RTN","RAUTL9",155,0)
 . Q
"RTN","RAUTL9",156,0)
 I $D(^RABTCH(74.4,"B",RAIEN)) D
"RTN","RAUTL9",157,0)
 . S A=0 F  S A=$O(^RABTCH(74.4,"B",RAIEN,A)) Q:A'>0  D
"RTN","RAUTL9",158,0)
 .. S DA=A,DIK="^RABTCH(74.4," D ^DIK K DA,DIK
"RTN","RAUTL9",159,0)
 .. Q
"RTN","RAUTL9",160,0)
 . Q
"RTN","RAUTL9",161,0)
 Q
"RTN","RAUTL9",162,0)
IARU ; Imaging Location allows released/unverified
"RTN","RAUTL9",163,0)
 S RATRUE=$S($P(^RA(79.1,+$P(^RADPT(RADFN,"DT",RADTI,0),U,4),0),U,17)="Y":1,1:0)
"RTN","RAUTL9",164,0)
 Q
"VER")
8.0^22
**END**
**END**
