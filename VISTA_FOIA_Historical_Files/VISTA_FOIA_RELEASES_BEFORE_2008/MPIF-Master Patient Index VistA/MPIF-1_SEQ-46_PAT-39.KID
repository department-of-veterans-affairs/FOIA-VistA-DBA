Released MPIF*1*39 SEQ #46
Extracted from mail message
**KIDS**:MPIF*1.0*39^

**INSTALL NAME**
MPIF*1.0*39
"BLD",2521,0)
MPIF*1.0*39^MASTER PATIENT INDEX VISTA^0^3070518^y
"BLD",2521,1,0)
^^3^3^3070518^
"BLD",2521,1,1,0)
LOCAL/MISSING ICN JOB CHANGE FOR LOCALS NOT RESOLVED
"BLD",2521,1,2,0)
Refer to patch MPIF*1*39 in the FORUM Patch Module for a complete
"BLD",2521,1,3,0)
description.
"BLD",2521,4,0)
^9.64PA^^
"BLD",2521,6.3)
3
"BLD",2521,"ABNS",0)
^9.66A^^
"BLD",2521,"ABPKG")
^^
"BLD",2521,"KRN",0)
^9.67PA^8989.52^19
"BLD",2521,"KRN",.4,0)
.4
"BLD",2521,"KRN",.401,0)
.401
"BLD",2521,"KRN",.402,0)
.402
"BLD",2521,"KRN",.403,0)
.403
"BLD",2521,"KRN",.5,0)
.5
"BLD",2521,"KRN",.84,0)
.84
"BLD",2521,"KRN",3.6,0)
3.6
"BLD",2521,"KRN",3.8,0)
3.8
"BLD",2521,"KRN",9.2,0)
9.2
"BLD",2521,"KRN",9.8,0)
9.8
"BLD",2521,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",2521,"KRN",9.8,"NM",1,0)
MPIFRES^^0^B24792139
"BLD",2521,"KRN",9.8,"NM",2,0)
MPIFA24^^0^B21542595
"BLD",2521,"KRN",9.8,"NM","B","MPIFA24",2)

"BLD",2521,"KRN",9.8,"NM","B","MPIFRES",1)

"BLD",2521,"KRN",19,0)
19
"BLD",2521,"KRN",19.1,0)
19.1
"BLD",2521,"KRN",101,0)
101
"BLD",2521,"KRN",409.61,0)
409.61
"BLD",2521,"KRN",771,0)
771
"BLD",2521,"KRN",870,0)
870
"BLD",2521,"KRN",8989.51,0)
8989.51
"BLD",2521,"KRN",8989.52,0)
8989.52
"BLD",2521,"KRN",8994,0)
8994
"BLD",2521,"KRN","B",.4,.4)

"BLD",2521,"KRN","B",.401,.401)

"BLD",2521,"KRN","B",.402,.402)

"BLD",2521,"KRN","B",.403,.403)

"BLD",2521,"KRN","B",.5,.5)

"BLD",2521,"KRN","B",.84,.84)

"BLD",2521,"KRN","B",3.6,3.6)

"BLD",2521,"KRN","B",3.8,3.8)

"BLD",2521,"KRN","B",9.2,9.2)

"BLD",2521,"KRN","B",9.8,9.8)

"BLD",2521,"KRN","B",19,19)

"BLD",2521,"KRN","B",19.1,19.1)

"BLD",2521,"KRN","B",101,101)

"BLD",2521,"KRN","B",409.61,409.61)

"BLD",2521,"KRN","B",771,771)

"BLD",2521,"KRN","B",870,870)

"BLD",2521,"KRN","B",8989.51,8989.51)

"BLD",2521,"KRN","B",8989.52,8989.52)

"BLD",2521,"KRN","B",8994,8994)

"BLD",2521,"QUES",0)
^9.62^^
"BLD",2521,"REQB",0)
^9.611^2^2
"BLD",2521,"REQB",1,0)
MPIF*1.0*43^2
"BLD",2521,"REQB",2,0)
MPIF*1.0*41^2
"BLD",2521,"REQB","B","MPIF*1.0*41",2)

"BLD",2521,"REQB","B","MPIF*1.0*43",1)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
39^3070518
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3070518
"PKG",282,22,1,"PAH",1,1,1,0)
LOCAL/MISSING ICN JOB CHANGE FOR LOCALS NOT RESOLVED
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*39 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MPIFA24")
0^2^B21542595^B20262010
"RTN","MPIFA24",1,0)
MPIFA24 ;BPOFO/CMC-A24 PROCESSING ROUTINE ;18 Mar 02
"RTN","MPIFA24",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24,27,31,25,41,39**;30 Apr 99;Build 3
"RTN","MPIFA24",3,0)
 ;
"RTN","MPIFA24",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24",7,0)
 ;  ^DPT("AICN" - #2070
"RTN","MPIFA24",8,0)
 ;  DELETETF^VAFCTFU, FILE^VAFCTFU - #2988
"RTN","MPIFA24",9,0)
 ;
"RTN","MPIFA24",10,0)
 ;PROCESS A24 RESULTING FROM A28 ADD TO MPI MESSAGE OR FROM A40 MERGE
"RTN","MPIFA24",11,0)
A24 ;
"RTN","MPIFA24",12,0)
 N MPII,MPIJ,ARRY,SEG,CNT,ERR,SITE,MSG,DFN,IEN,LIST,RARRY
"RTN","MPIFA24",13,0)
 S (CNT,ERR,FIRST)=1
"RTN","MPIFA24",14,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE D
"RTN","MPIFA24",15,0)
 .S MPIJ=0 F  S MPIJ=$O(HLNODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=HLNODE(MPIJ)
"RTN","MPIFA24",16,0)
 .S SEG=$E(HLNODE,1,3)
"RTN","MPIFA24",17,0)
 .I SEG="MSH" D MSH(.ARRY,.MSG) Q
"RTN","MPIFA24",18,0)
 .I SEG="EVN" D EVN(.ARRY,.MSG) Q
"RTN","MPIFA24",19,0)
 .I SEG="PID" D PID(.ARRY,.MSG,FIRST) D:FIRST=1  S FIRST=2 Q
"RTN","MPIFA24",20,0)
 ..;preserve the retained ICN values 991.01 and 991.02
"RTN","MPIFA24",21,0)
 .. S RARRY(991.01)=ARRY(991.01),RARRY(991.02)=ARRY(991.02)
"RTN","MPIFA24",22,0)
 .I SEG="PD1" D PD1(.ARRY,.MSG) Q
"RTN","MPIFA24",23,0)
 ;
"RTN","MPIFA24",24,0)
 ;restore the retained ICN values
"RTN","MPIFA24",25,0)
 S ARRY(991.01)=RARRY(991.01),ARRY(991.02)=RARRY(991.02)
"RTN","MPIFA24",26,0)
 ;UPDATE 991.01, 991.02, 991.03
"RTN","MPIFA24",27,0)
 ;**41 first check for DFN, if this DFN location is here
"RTN","MPIFA24",28,0)
 I $G(ARRY("DFN",2))'=""&($G(ARRY("DFNLOC"))=$P($$SITE^VASITE,"^",3)) S DFN=ARRY("DFN",2)
"RTN","MPIFA24",29,0)
 ;**41 if dfn is not passed set DFN from ICN
"RTN","MPIFA24",30,0)
 I $G(DFN)="" D
"RTN","MPIFA24",31,0)
 . I $G(ARRY("ICN",2))'="" S DFN=$$GETDFN^MPIF001(ARRY("ICN",2))
"RTN","MPIFA24",32,0)
 . I $G(ARRY("ICN",2))=""!(+$G(DFN)'>0) D
"RTN","MPIFA24",33,0)
 .. I $G(ARRY("DFN",2))'="" S DFN=ARRY("DFN",2)
"RTN","MPIFA24",34,0)
 .. I $G(ARRY("DFN",2))="" S DFN=ARRY("DFN",1)
"RTN","MPIFA24",35,0)
 S ARRY(991.03)=$$LKUP^XUAF4(ARRY(991.03))
"RTN","MPIFA24",36,0)
 I +$G(DFN)'>0 S ERR="-1^Unknown Identifier(s) ICN#"_$G(ARRY("ICN",2))_" and DFN#"_$G(ARRY("DFN",2))
"RTN","MPIFA24",37,0)
 I +$G(DFN)>0 S ERR=$$UPDATE^MPIFAPI(DFN,"ARRY",0) D
"RTN","MPIFA24",38,0)
 .;remove ALL Treating Facilities except your sites and add the CMOR
"RTN","MPIFA24",39,0)
 .D TFL^VAFCTFU1(.LIST,DFN) I $O(LIST(0)) D
"RTN","MPIFA24",40,0)
 .. N LOC,MPINODE,LOCIEN,CMOR,MPIFX,ERROR
"RTN","MPIFA24",41,0)
 .. S (CMOR,MPIFX)=0 F  S MPIFX=$O(LIST(MPIFX)) Q:'MPIFX  I $P(LIST(MPIFX),"^",5)="VAMC" D
"RTN","MPIFA24",42,0)
 ... ;get MPI node
"RTN","MPIFA24",43,0)
 ... S MPINODE=$$MPINODE^MPIFAPI(DFN),LOC=$P(LIST(MPIFX),"^"),LOCIEN=$$IEN^XUAF4(LOC)
"RTN","MPIFA24",44,0)
 ... I LOC=$P($$SITE^VASITE,"^",3) Q  ;do not delete own site
"RTN","MPIFA24",45,0)
 ... I LOCIEN=$P(MPINODE,"^",3) S CMOR=LOCIEN Q  ;do not delete CMOR site
"RTN","MPIFA24",46,0)
 ... S ERROR=$$DELETETF^VAFCTFU($P(MPINODE,"^",1),LOCIEN)
"RTN","MPIFA24",47,0)
 .. ;add CMOR site to TF list if it did not already exist
"RTN","MPIFA24",48,0)
 .. I CMOR'=0 D FILE^VAFCTFU(DFN,CMOR,1)
"RTN","MPIFA24",49,0)
 .; trigger A31 to MPI incase there have been edits since the ICN was created -- tasked off
"RTN","MPIFA24",50,0)
 .; **39 DON'T TASK OFF A31 IF MOVING FROM ONE NATIONAL ICN TO A DIFFERENT NATIONAL ICN
"RTN","MPIFA24",51,0)
 .I ARRY("ICN",1)=ARRY("ICN",2) D
"RTN","MPIFA24",52,0)
 ..S ZTRTN="TA31^MPIFA31B",ZTDESC="A31 triggered from A24 for DFN "_DFN ;**39 added DFN to text
"RTN","MPIFA24",53,0)
 ..S ZTSAVE("DFN")=DFN,ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFA24",54,0)
 ..D ^%ZTLOAD
"RTN","MPIFA24",55,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFA24",56,0)
 ;
"RTN","MPIFA24",57,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(ERR)'>0:$P(ERR,"^",2),1:"")
"RTN","MPIFA24",58,0)
 S $P(HLA("HLA",1),HL("FS"),7)="ICN="_ARRY("ICN",1)
"RTN","MPIFA24",59,0)
 D LINK^HLUTIL3(ARRY("SITE"),.LINK) S IEN=$O(LINK(0)),HLL("LINKS",1)="^"_LINK(IEN)
"RTN","MPIFA24",60,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.MPIFRSLT,"",.HL)
"RTN","MPIFA24",61,0)
 K LINK,MPIFRSLT
"RTN","MPIFA24",62,0)
 ;PATCH 25
"RTN","MPIFA24",63,0)
 I ARRY("ICN",1)'=ARRY("ICN",2),ARRY("ICN",2)'="" D
"RTN","MPIFA24",64,0)
 .; ^ checking if this is a result of a "merge" of ICNs from the MPI
"RTN","MPIFA24",65,0)
 .; to trigger if this is station 200 the MERGE for the FHIE Framework
"RTN","MPIFA24",66,0)
 .Q:$P($$SITE^VASITE,"^",3)'=200
"RTN","MPIFA24",67,0)
 .N FHIE S FHIE=$$MERGE^OMGPIDMI(ARRY("ICN",2),ARRY("ICN",1))
"RTN","MPIFA24",68,0)
 .;       ^^ THIS API IS ONLY AVAILABLE ON THE FHIE HOST SYSTEM
"RTN","MPIFA24",69,0)
 .I +FHIE=-1 D START^RGHLLOG(),EXC^RGHLLOG(208,$P(FHIE,"^",2),DFN),STOP^RGHLLOG()
"RTN","MPIFA24",70,0)
 Q
"RTN","MPIFA24",71,0)
 ;
"RTN","MPIFA24",72,0)
MSH(ARY,MSG) ;processing MSH fields
"RTN","MPIFA24",73,0)
 N COMP
"RTN","MPIFA24",74,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",75,0)
 S ARY("SITE")=$$LKUP^XUAF4($P($P(MSG,HL("FS"),4),COMP))
"RTN","MPIFA24",76,0)
 Q
"RTN","MPIFA24",77,0)
 ;
"RTN","MPIFA24",78,0)
EVN(ARY,MSG) ;processing EVN fields
"RTN","MPIFA24",79,0)
 S ARY("EVTR")=$P(MSG,HL("FS"),2) ;not currently used
"RTN","MPIFA24",80,0)
 S ARY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","MPIFA24",81,0)
 Q
"RTN","MPIFA24",82,0)
 ;
"RTN","MPIFA24",83,0)
PID(ARY,MSG,FIRST) ;processing PID fields
"RTN","MPIFA24",84,0)
 N REP,PID,COMP,SUBCOMP,MPIDFN,MPISSN,ICN
"RTN","MPIFA24",85,0)
 S REP=$E(HL("ECH"),2),COMP=$E(HL("ECH"),1),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24",86,0)
 S MPISSN="",MPIDFN=""
"RTN","MPIFA24",87,0)
 ;**41 replaced with line below D PIDPROC^MPIFA43(.ICN,.MPISSN,.MPIDFN,.PID)
"RTN","MPIFA24",88,0)
 D PIDP^RGADTP1(.MSG,.ARY,.HL)
"RTN","MPIFA24",89,0)
 I FIRST=1 S ARY(991.01)=+ARY("ICN"),ARY(991.02)=$P(ARY("ICN"),"V",2)
"RTN","MPIFA24",90,0)
 S ARY("ICN",FIRST)=ARY("ICN")
"RTN","MPIFA24",91,0)
 S ARY("SSN",FIRST)=ARY("SSN")
"RTN","MPIFA24",92,0)
 S ARY("DFN",FIRST)=ARY("DFN")
"RTN","MPIFA24",93,0)
 Q
"RTN","MPIFA24",94,0)
 ;
"RTN","MPIFA24",95,0)
PD1(ARY,MSG) ;processing PD1 fields
"RTN","MPIFA24",96,0)
 N COMP
"RTN","MPIFA24",97,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",98,0)
 S ARY(991.03)=$P($P(HLNODE,HL("FS"),4),COMP,3)
"RTN","MPIFA24",99,0)
 Q
"RTN","MPIFA24",100,0)
 ;
"RTN","MPIFA24",101,0)
PROC ;
"RTN","MPIFA24",102,0)
 N NXT,DFN
"RTN","MPIFA24",103,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24",104,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24",105,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24",106,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24",107,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24",108,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24",109,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24",110,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24",111,0)
 Q
"RTN","MPIFRES")
0^1^B24792139^B21931451
"RTN","MPIFRES",1,0)
MPIFRES ;SF/CMC-LOCAL AND MISSING ICN RESOLUTION ;JUL 13, 1998
"RTN","MPIFRES",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,7,10,15,17,21,26,28,33,35,43,39**;30 Apr 99;Build 3
"RTN","MPIFRES",3,0)
 ;
"RTN","MPIFRES",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFRES",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFRES",6,0)
 ;  ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFRES",7,0)
 ;  ^RGHL7(991.1 - #3259
"RTN","MPIFRES",8,0)
 ;  ^RGSITE - #2746
"RTN","MPIFRES",9,0)
 ;
"RTN","MPIFRES",10,0)
BKG ;
"RTN","MPIFRES",11,0)
 I $D(ZTQUEUED) D GO Q
"RTN","MPIFRES",12,0)
 S ZTRTN="GO^MPIFRES",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFRES",13,0)
 S ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFRES",14,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFRES",15,0)
 D ^%ZTLOAD
"RTN","MPIFRES",16,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFRES",17,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFRES",18,0)
 Q
"RTN","MPIFRES",19,0)
 ;
"RTN","MPIFRES",20,0)
GO ;ENTRY POINT
"RTN","MPIFRES",21,0)
 N MPIMORE,MPITOT
"RTN","MPIFRES",22,0)
 L +^XTMP("MPIF RESOLUTION"):3 E  Q
"RTN","MPIFRES",23,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFRES",24,0)
 ;
"RTN","MPIFRES",25,0)
 K ^TMP("HLS",$J),STOP
"RTN","MPIFRES",26,0)
 D START^RGHLLOG()
"RTN","MPIFRES",27,0)
 D HLRDF
"RTN","MPIFRES",28,0)
 I $D(STOP) K STOP Q  ;patch 7 added to quit if init returned an error
"RTN","MPIFRES",29,0)
 D LOOP
"RTN","MPIFRES",30,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFRES",31,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFRES",32,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIMIDT,MPIMSH
"RTN","MPIFRES",33,0)
 K MPIOUT,MPIQRYNM,MPISEQ,QCNT,MPIMCNT,MPIMTX,ENDT,MPIFRES
"RTN","MPIFRES",34,0)
 L -^XTMP("MPIF RESOLUTION")
"RTN","MPIFRES",35,0)
 ; mark job completion date/time
"RTN","MPIFRES",36,0)
 S $P(^RGSITE(991.8,1,0),"^",4)=$$NOW^XLFDT
"RTN","MPIFRES",37,0)
 Q
"RTN","MPIFRES",38,0)
 ;
"RTN","MPIFRES",39,0)
HLRDF ;
"RTN","MPIFRES",40,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFRES",41,0)
 S HL("ECH")="^~\&"
"RTN","MPIFRES",42,0)
 S HL("FS")="|"
"RTN","MPIFRES",43,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.HL)
"RTN","MPIFRES",44,0)
 I $O(HL("")) D EXC^RGHLLOG(220,"INIT^HLFNC2 call error returned") S STOP="" Q
"RTN","MPIFRES",45,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFRES",46,0)
 Q
"RTN","MPIFRES",47,0)
LOOP ;
"RTN","MPIFRES",48,0)
 S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",49,0)
 D MAKE
"RTN","MPIFRES",50,0)
 Q
"RTN","MPIFRES",51,0)
SEND ;ready to send
"RTN","MPIFRES",52,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFRES",53,0)
 I +MPIEROR=0 D EXC^RGHLLOG(220,"GENERATE^HLMA call returned error") Q
"RTN","MPIFRES",54,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFRES",55,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",56,0)
 Q
"RTN","MPIFRES",57,0)
MAKE ;
"RTN","MPIFRES",58,0)
 N LOCAL,MPIIT,TICN,STOP,X,Y,%,%H,%I,TODAY,SITE,XX,SDT,NDT
"RTN","MPIFRES",59,0)
 S LOCAL="",MPIIT=0,MPIFRES="",SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFRES",60,0)
 D NOW^%DTC S TODAY=X
"RTN","MPIFRES",61,0)
 ;local ICNs
"RTN","MPIFRES",62,0)
 F  S MPIIT=$O(^DPT("AICNL",1,MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",63,0)
 .; LINE BELOW ADDED FOR PATCH 26 TO CLEANUP AICNL X-REF WHEN LEFT AROUND
"RTN","MPIFRES",64,0)
 .I $E($$GETICN^MPIF001(MPIIT),1,3)'=SITE S XX=$$SETLOC^MPIF001(MPIIT,0) K ^DPT("AICNL",1,MPIIT) Q
"RTN","MPIFRES",65,0)
 .;Q:+$G(^DPT("AICNL",1,MPIIT))=1 **39 changing check
"RTN","MPIFRES",66,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=2&($P($G(^DPT("AICNL",1,MPIIT)),"^",2)=TODAY)
"RTN","MPIFRES",67,0)
 .; ^ check if A28 failed to get ICN back and should now be sent up
"RTN","MPIFRES",68,0)
 .; DON'T send if is the 2^today **35
"RTN","MPIFRES",69,0)
 .S SDT=$P($G(^DPT("AICNL",1,MPIIT)),"^",2)
"RTN","MPIFRES",70,0)
 .N X1,X2 K X S X1=SDT,X2=2 D C^%DTC S NDT=X ;**39 FIGURE 2 DAYS FROM NOW
"RTN","MPIFRES",71,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=1&(SDT=TODAY)
"RTN","MPIFRES",72,0)
 .; **39 ^ if send up today don't send again
"RTN","MPIFRES",73,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=1&(NDT>TODAY)
"RTN","MPIFRES",74,0)
 .;**39 ^ only send patient to MPI for Local ICN resolution 1 time UNLESS its day 3 since it was sent
"RTN","MPIFRES",75,0)
 .;I $D(^RGHL7(991.1,"ADFN",218,MPIIT)) S ^DPT("AICNL",1,MPIIT)="1^"_TODAY Q
"RTN","MPIFRES",76,0)
 .; ^ checking if potential match exception **43 REMOVE CHECK ON POTENTIAL MATCH EXCEPTIONS
"RTN","MPIFRES",77,0)
 .D MAKE3
"RTN","MPIFRES",78,0)
 ;missing ICNs
"RTN","MPIFRES",79,0)
 S MPIIT=0
"RTN","MPIFRES",80,0)
 F  S MPIIT=$O(^DPT("AMPIMIS",MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",81,0)
 .K STOP
"RTN","MPIFRES",82,0)
 .I $D(^DPT(MPIIT,-9)) K ^DPT("AMPIMIS",MPIIT) Q  ;**43 CHECK IF MERGED PATIENT AND CLEANUP CROSS REFERENCE
"RTN","MPIFRES",83,0)
 .S TICN=+$$GETICN^MPIF001(MPIIT)
"RTN","MPIFRES",84,0)
 .I TICN<0 L +^DPT(MPIIT):5 I '$T Q  ;**35
"RTN","MPIFRES",85,0)
 .L -^DPT(MPIIT,0) ;**35
"RTN","MPIFRES",86,0)
 .;**35 If don't have ICN yet, try to lock if can't get lock skip record - still creating patient.
"RTN","MPIFRES",87,0)
 .I TICN<0,'$D(STOP) D MAKE3
"RTN","MPIFRES",88,0)
 .I TICN>0 K ^DPT("AMPIMIS",MPIIT)
"RTN","MPIFRES",89,0)
 Q
"RTN","MPIFRES",90,0)
MAKE3 ;
"RTN","MPIFRES",91,0)
 K MPIOUT
"RTN","MPIFRES",92,0)
 S MPIFRES=""
"RTN","MPIFRES",93,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="EXACT_MATCH_QUERY" ;**43 changed MPIQRYNM from VTQ_PID_ICN_LOAD_1 to stop automatic add pts on the MPI
"RTN","MPIFRES",94,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.HL,.MPIQRYNM)
"RTN","MPIFRES",95,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFRES",96,0)
 ;I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" Q
"RTN","MPIFRES",97,0)
 ;Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFRES",98,0)
 S ^DPT("AICNL",1,MPIIT)="1^"_TODAY
"RTN","MPIFRES",99,0)
 ; ^ mark Local ICN as having been sent to MPI for resolution
"RTN","MPIFRES",100,0)
 ;call for HL7 header
"RTN","MPIFRES",101,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFRES",102,0)
 D MSH^HLFNC2(.HL,MPIMIDT,.MPIMSH)
"RTN","MPIFRES",103,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFRES",104,0)
 S ^TMP("HLS",$J,MPICNT)=MPIOUT(1)
"RTN","MPIFRES",105,0)
 S MPICNT=MPICNT+1
"RTN","MPIFRES",106,0)
 ;MESSAGE BUILT
"RTN","MPIFRES",107,0)
 S MPISEQ=0
"RTN","MPIFRES",108,0)
 ;setup VTQ segment in HL array
"RTN","MPIFRES",109,0)
 S ^TMP("HLS",$J,MPICNT)=MPIOUT(2)
"RTN","MPIFRES",110,0)
 S MPICNT=MPICNT+1
"RTN","MPIFRES",111,0)
 ;setup RDF segment in HL array
"RTN","MPIFRES",112,0)
 S ^TMP("HLS",$J,MPICNT)=MPIOUT(3)
"RTN","MPIFRES",113,0)
 ;loop through and add the additional RDF continuations
"RTN","MPIFRES",114,0)
 N SCNT,Y S Y=3,SCNT=1 F  S Y=$O(MPIOUT(Y)) Q:'Y  D
"RTN","MPIFRES",115,0)
 .S ^TMP("HLS",$J,MPICNT,SCNT)=MPIOUT(Y),SCNT=SCNT+1
"RTN","MPIFRES",116,0)
 S MPICNT=MPICNT+1
"RTN","MPIFRES",117,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFRES",118,0)
 I MPIDNUM>100 D
"RTN","MPIFRES",119,0)
 .D SEND
"RTN","MPIFRES",120,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",121,0)
 .D HLRDF
"RTN","MPIFRES",122,0)
 Q
"VER")
8.0^22.0
"BLD",2521,6)
^46
**END**
**END**
