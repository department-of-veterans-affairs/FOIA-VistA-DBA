Released IB*2*284 SEQ #255
Extracted from mail message
**KIDS**:IB*2.0*284^

**INSTALL NAME**
IB*2.0*284
"BLD",5738,0)
IB*2.0*284^INTEGRATED BILLING^0^3040916^y
"BLD",5738,1,0)
^^3^3^3040916^^
"BLD",5738,1,1,0)
This patch modifies the 'Sender' name used by the IIV STATISTICAL REPORT
"BLD",5738,1,2,0)
when mailing the report to the IBCNE IIV MESSAGE mail group.
"BLD",5738,1,3,0)
The name is changed from "IB IIV INTERFACE" to "IIV INTERFACE (IB)".
"BLD",5738,4,0)
^9.64PA^^
"BLD",5738,"KRN",0)
^9.67PA^8989.52^19
"BLD",5738,"KRN",.4,0)
.4
"BLD",5738,"KRN",.401,0)
.401
"BLD",5738,"KRN",.402,0)
.402
"BLD",5738,"KRN",.403,0)
.403
"BLD",5738,"KRN",.5,0)
.5
"BLD",5738,"KRN",.84,0)
.84
"BLD",5738,"KRN",3.6,0)
3.6
"BLD",5738,"KRN",3.8,0)
3.8
"BLD",5738,"KRN",9.2,0)
9.2
"BLD",5738,"KRN",9.8,0)
9.8
"BLD",5738,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",5738,"KRN",9.8,"NM",1,0)
IBCNEUT5^^0^B55096924
"BLD",5738,"KRN",9.8,"NM","B","IBCNEUT5",1)

"BLD",5738,"KRN",19,0)
19
"BLD",5738,"KRN",19.1,0)
19.1
"BLD",5738,"KRN",101,0)
101
"BLD",5738,"KRN",409.61,0)
409.61
"BLD",5738,"KRN",771,0)
771
"BLD",5738,"KRN",870,0)
870
"BLD",5738,"KRN",8989.51,0)
8989.51
"BLD",5738,"KRN",8989.52,0)
8989.52
"BLD",5738,"KRN",8994,0)
8994
"BLD",5738,"KRN","B",.4,.4)

"BLD",5738,"KRN","B",.401,.401)

"BLD",5738,"KRN","B",.402,.402)

"BLD",5738,"KRN","B",.403,.403)

"BLD",5738,"KRN","B",.5,.5)

"BLD",5738,"KRN","B",.84,.84)

"BLD",5738,"KRN","B",3.6,3.6)

"BLD",5738,"KRN","B",3.8,3.8)

"BLD",5738,"KRN","B",9.2,9.2)

"BLD",5738,"KRN","B",9.8,9.8)

"BLD",5738,"KRN","B",19,19)

"BLD",5738,"KRN","B",19.1,19.1)

"BLD",5738,"KRN","B",101,101)

"BLD",5738,"KRN","B",409.61,409.61)

"BLD",5738,"KRN","B",771,771)

"BLD",5738,"KRN","B",870,870)

"BLD",5738,"KRN","B",8989.51,8989.51)

"BLD",5738,"KRN","B",8989.52,8989.52)

"BLD",5738,"KRN","B",8994,8994)

"BLD",5738,"QUES",0)
^9.62^^
"BLD",5738,"REQB",0)
^9.611^1^1
"BLD",5738,"REQB",1,0)
IB*2.0*184^2
"BLD",5738,"REQB","B","IB*2.0*184",1)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
284^3040916
"PKG",200,22,1,"PAH",1,1,0)
^^3^3^3040916
"PKG",200,22,1,"PAH",1,1,1,0)
This patch modifies the 'Sender' name used by the IIV STATISTICAL REPORT
"PKG",200,22,1,"PAH",1,1,2,0)
when mailing the report to the IBCNE IIV MESSAGE mail group.
"PKG",200,22,1,"PAH",1,1,3,0)
The name is changed from "IB IIV INTERFACE" to "IIV INTERFACE (IB)".
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","IBCNEUT5")
0^1^B55096924
"RTN","IBCNEUT5",1,0)
IBCNEUT5 ;DAOU/ALA - IIV MISC. UTILITIES ;20-JUN-2002
"RTN","IBCNEUT5",2,0)
 ;;2.0;INTEGRATED BILLING;**184,284**;21-MAR-94
"RTN","IBCNEUT5",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNEUT5",4,0)
 ;
"RTN","IBCNEUT5",5,0)
 ;**Program Description**
"RTN","IBCNEUT5",6,0)
 ;  This program contains some general utilities or functions
"RTN","IBCNEUT5",7,0)
 ;
"RTN","IBCNEUT5",8,0)
 Q
"RTN","IBCNEUT5",9,0)
 ;
"RTN","IBCNEUT5",10,0)
MSG(MGRP,XMSUB,XMTEXT,FROMFLAG,XMY) ;  Send a MailMan Message
"RTN","IBCNEUT5",11,0)
 ;
"RTN","IBCNEUT5",12,0)
 ;  Input Parameters
"RTN","IBCNEUT5",13,0)
 ;   MGRP = Mailgroup Name (optional)
"RTN","IBCNEUT5",14,0)
 ;   XMSUB = Subject Line (required)
"RTN","IBCNEUT5",15,0)
 ;   XMTEXT = Message Text Array Name in open format:  "MSG(" (required)
"RTN","IBCNEUT5",16,0)
 ;   FROMFLAG = Flag indicating from whom the message is sent (optional)
"RTN","IBCNEUT5",17,0)
 ;         false/undefined:  from the specific, non-human IIV user
"RTN","IBCNEUT5",18,0)
 ;                    true:  from the actual user (DUZ)
"RTN","IBCNEUT5",19,0)
 ;   XMY = recipients array; pass by reference (optional)
"RTN","IBCNEUT5",20,0)
 ;         The possible recipients are the sender, the Mail Group in the
"RTN","IBCNEUT5",21,0)
 ;         first parameter, and anybody else already defined in the XMY 
"RTN","IBCNEUT5",22,0)
 ;         array when this parameter is used.
"RTN","IBCNEUT5",23,0)
 ;
"RTN","IBCNEUT5",24,0)
 ; New MailMan variables and also some FileMan variables.  The FileMan
"RTN","IBCNEUT5",25,0)
 ; variables are used and not cleaned up when sending to external
"RTN","IBCNEUT5",26,0)
 ; internet addresses.
"RTN","IBCNEUT5",27,0)
 NEW DIFROM,XMDUZ,XMDUN,XMZ,XMMG,XMSTRIP,XMROU,XMYBLOB
"RTN","IBCNEUT5",28,0)
 NEW D0,D1,D2,DG,DIC,DICR,DISYS,DIW
"RTN","IBCNEUT5",29,0)
 NEW TMPSUB,TMPTEXT,TMPY,XX
"RTN","IBCNEUT5",30,0)
 ;
"RTN","IBCNEUT5",31,0)
 I $G(FROMFLAG),$G(DUZ) S XMDUZ=DUZ
"RTN","IBCNEUT5",32,0)
 E  S XMDUZ="IIV INTERFACE (IB)"
"RTN","IBCNEUT5",33,0)
 ;I $G(DUZ) S XMY(DUZ)=""      ; original location of line - moved below
"RTN","IBCNEUT5",34,0)
 I $G(MGRP)'="" S XMY("G."_MGRP)=""
"RTN","IBCNEUT5",35,0)
 ; If no recipients are defined, send to postmaster
"RTN","IBCNEUT5",36,0)
 I '$D(XMY) S XMY(.5)=""
"RTN","IBCNEUT5",37,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","IBCNEUT5",38,0)
 ; Store off subject, array reference and array of recipients
"RTN","IBCNEUT5",39,0)
 S TMPSUB=XMSUB,TMPTEXT=XMTEXT
"RTN","IBCNEUT5",40,0)
 M TMPY=XMY
"RTN","IBCNEUT5",41,0)
 D ^XMD
"RTN","IBCNEUT5",42,0)
 ;
"RTN","IBCNEUT5",43,0)
 ; Error logic
"RTN","IBCNEUT5",44,0)
 ; If there's an error message and the message was not originally sent
"RTN","IBCNEUT5",45,0)
 ; to the postmaster, then send a message to the postmaster with this
"RTN","IBCNEUT5",46,0)
 ; error message.
"RTN","IBCNEUT5",47,0)
 ;
"RTN","IBCNEUT5",48,0)
 I $D(XMMG),'$D(TMPY(.5)) D
"RTN","IBCNEUT5",49,0)
 . S XMY(.5)=""
"RTN","IBCNEUT5",50,0)
 . S XMTEXT=TMPTEXT,XMSUB="MailMan Error"
"RTN","IBCNEUT5",51,0)
 . ; Add XMMG error message as the first line of the message
"RTN","IBCNEUT5",52,0)
 . S XX=999999
"RTN","IBCNEUT5",53,0)
 . F  S XX=$O(@(XMTEXT_"XX)"),-1) Q:'XX  S @(XMTEXT_"XX+3)")=@(XMTEXT_"XX)")
"RTN","IBCNEUT5",54,0)
 . S @(XMTEXT_"1)")="   MailMan Error:  "_XMMG
"RTN","IBCNEUT5",55,0)
 . S @(XMTEXT_"2)")="Original Subject:  "_TMPSUB
"RTN","IBCNEUT5",56,0)
 . S @(XMTEXT_"3)")="------Original Message------"
"RTN","IBCNEUT5",57,0)
 . D ^XMD
"RTN","IBCNEUT5",58,0)
 . Q
"RTN","IBCNEUT5",59,0)
 Q
"RTN","IBCNEUT5",60,0)
 ;
"RTN","IBCNEUT5",61,0)
 ;
"RTN","IBCNEUT5",62,0)
BFEXIST(DFN,INSNAME) ; Function returns 1 if an Entered Ins Buffer File 
"RTN","IBCNEUT5",63,0)
 ; entry exists with the same DFN and INSNAME, otherwise it returns a 0
"RTN","IBCNEUT5",64,0)
 ;
"RTN","IBCNEUT5",65,0)
 ; DFN - Patient DFN
"RTN","IBCNEUT5",66,0)
 ; INSNAME - Insurance Company Name File 36 - Field .01
"RTN","IBCNEUT5",67,0)
 ;
"RTN","IBCNEUT5",68,0)
 NEW EXIST,IEN
"RTN","IBCNEUT5",69,0)
 S EXIST=0
"RTN","IBCNEUT5",70,0)
 S INSNAME=$$TRIM^XLFSTR(INSNAME)  ; trimmed
"RTN","IBCNEUT5",71,0)
 I ('DFN)!(INSNAME="") G BFEXIT
"RTN","IBCNEUT5",72,0)
 ;
"RTN","IBCNEUT5",73,0)
 S IEN=0
"RTN","IBCNEUT5",74,0)
 F  S IEN=$O(^IBA(355.33,"C",DFN,IEN)) Q:'IEN!EXIST  D
"RTN","IBCNEUT5",75,0)
 .  ; Quit if status is NOT 'Entered'
"RTN","IBCNEUT5",76,0)
 .  I $P($G(^IBA(355.33,IEN,0)),U,4)'="E" Q
"RTN","IBCNEUT5",77,0)
 .  ; Quit if Ins Buffer Ins Co Name (trimmed) is NOT EQUAL to 
"RTN","IBCNEUT5",78,0)
 .  ;  the Ins Co Name parameter (trimmed)
"RTN","IBCNEUT5",79,0)
 .  I $$TRIM^XLFSTR($P($G(^IBA(355.33,IEN,20)),U))'=INSNAME Q
"RTN","IBCNEUT5",80,0)
 .  ; Match found
"RTN","IBCNEUT5",81,0)
 .  S EXIST=1
"RTN","IBCNEUT5",82,0)
 .  Q
"RTN","IBCNEUT5",83,0)
BFEXIT ;
"RTN","IBCNEUT5",84,0)
 Q EXIST
"RTN","IBCNEUT5",85,0)
 ;
"RTN","IBCNEUT5",86,0)
 ;
"RTN","IBCNEUT5",87,0)
MGRP() ; Get the Mail Group for the IIV Interface - IB Site Parameters (51.04)
"RTN","IBCNEUT5",88,0)
 Q $$GET1^DIQ(350.9,"1,",51.04,"E")
"RTN","IBCNEUT5",89,0)
 ;
"RTN","IBCNEUT5",90,0)
 ;
"RTN","IBCNEUT5",91,0)
PYRAPP(APP,PAYERIEN) ; Get the Payer Application multiple IEN
"RTN","IBCNEUT5",92,0)
 ; based on the payer application name and payer ien.
"RTN","IBCNEUT5",93,0)
 ;
"RTN","IBCNEUT5",94,0)
 NEW MIEN,APPIEN,DISYS
"RTN","IBCNEUT5",95,0)
 S MIEN=""
"RTN","IBCNEUT5",96,0)
 S APPIEN=$$FIND1^DIC(365.13,,"X",APP,"B")
"RTN","IBCNEUT5",97,0)
 I 'APPIEN G PYRAPPX
"RTN","IBCNEUT5",98,0)
 I '$G(PAYERIEN) G PYRAPPX
"RTN","IBCNEUT5",99,0)
 S MIEN=$O(^IBE(365.12,PAYERIEN,1,"B",APPIEN,""))
"RTN","IBCNEUT5",100,0)
PYRAPPX ;
"RTN","IBCNEUT5",101,0)
 Q MIEN
"RTN","IBCNEUT5",102,0)
 ;
"RTN","IBCNEUT5",103,0)
 ;
"RTN","IBCNEUT5",104,0)
ACTAPP(IEN) ; Active payer applications
"RTN","IBCNEUT5",105,0)
 ; This function will return 1 if any of the payer applications for 
"RTN","IBCNEUT5",106,0)
 ; this payer (being passed in by the payer IEN) are NOT deactivated.
"RTN","IBCNEUT5",107,0)
 ; This should not be confused with the other payer application fields
"RTN","IBCNEUT5",108,0)
 ; such as national active or local active.  The deactivated field is
"RTN","IBCNEUT5",109,0)
 ; the .11 field in the payer application multiple.
"RTN","IBCNEUT5",110,0)
 ;
"RTN","IBCNEUT5",111,0)
 ; This function is invoked by the FileMan data dictionary as a screen
"RTN","IBCNEUT5",112,0)
 ; for the Payer field (#3.1) in the Insurance company file (#36).
"RTN","IBCNEUT5",113,0)
 ;
"RTN","IBCNEUT5",114,0)
 NEW APPIEN,ACTAPP,APPDATA
"RTN","IBCNEUT5",115,0)
 S APPIEN=0,ACTAPP="",IEN=+$G(IEN)
"RTN","IBCNEUT5",116,0)
 F  S APPIEN=$O(^IBE(365.12,IEN,1,APPIEN)) Q:'APPIEN  D  Q:ACTAPP
"RTN","IBCNEUT5",117,0)
 . S APPDATA=$G(^IBE(365.12,IEN,1,APPIEN,0))
"RTN","IBCNEUT5",118,0)
 . I $P(APPDATA,U,11) Q
"RTN","IBCNEUT5",119,0)
 . I $P(APPDATA,U,12) Q
"RTN","IBCNEUT5",120,0)
 . S ACTAPP=1
"RTN","IBCNEUT5",121,0)
 . Q
"RTN","IBCNEUT5",122,0)
 Q ACTAPP
"RTN","IBCNEUT5",123,0)
 ;
"RTN","IBCNEUT5",124,0)
ADDTQ(DFN,PAYER,SRVDT,FDAYS) ; Function  - Returns flag (0/1)
"RTN","IBCNEUT5",125,0)
 ; 1 - TQ File entry can be added as the service date for the patient 
"RTN","IBCNEUT5",126,0)
 ;     and payer >= MAX TQ service date + Freshness Days
"RTN","IBCNEUT5",127,0)
 ; 0 - otherwise
"RTN","IBCNEUT5",128,0)
 ;
"RTN","IBCNEUT5",129,0)
 ; Input:
"RTN","IBCNEUT5",130,0)
 ;  DFN   - Patient DFN (File #2)
"RTN","IBCNEUT5",131,0)
 ;  PAYER - Payer IEN (File #365.12)
"RTN","IBCNEUT5",132,0)
 ;  SRVDT - Service dt for potential TQ entry
"RTN","IBCNEUT5",133,0)
 ;  FDAYS - Freshness Days param (by extract type)
"RTN","IBCNEUT5",134,0)
 ;
"RTN","IBCNEUT5",135,0)
 N ADDTQ,MAXDT
"RTN","IBCNEUT5",136,0)
 ; 
"RTN","IBCNEUT5",137,0)
 S ADDTQ=1
"RTN","IBCNEUT5",138,0)
 I ($G(DFN)="")!($G(PAYER)="")!($G(SRVDT)="")!($G(FDAYS)="") S ADDTQ=0 G ADDTQX
"RTN","IBCNEUT5",139,0)
 ; MAX TQ Service Date
"RTN","IBCNEUT5",140,0)
 S MAXDT=$$TQMAXSV(DFN,PAYER)
"RTN","IBCNEUT5",141,0)
 I MAXDT="" G ADDTQX
"RTN","IBCNEUT5",142,0)
 ; If Service Date < Max Service Date + Freshness Days, do not add
"RTN","IBCNEUT5",143,0)
 I SRVDT<$$FMADD^XLFDT(MAXDT,FDAYS) S ADDTQ=0
"RTN","IBCNEUT5",144,0)
 ;
"RTN","IBCNEUT5",145,0)
ADDTQX ; ADDTQ exit pt
"RTN","IBCNEUT5",146,0)
 Q ADDTQ
"RTN","IBCNEUT5",147,0)
 ;
"RTN","IBCNEUT5",148,0)
TQUPDSV(DFN,PAYER,SRVDT) ; Update service dates & freshness dates for TQ
"RTN","IBCNEUT5",149,0)
 ; entries awaiting transmission
"RTN","IBCNEUT5",150,0)
 ;
"RTN","IBCNEUT5",151,0)
 N SVDT,STS,ERACT,CSRVDT,CSPAN,SPAN,DA,HL7IEN,RIEN
"RTN","IBCNEUT5",152,0)
 ;
"RTN","IBCNEUT5",153,0)
 I ($G(DFN)="")!($G(PAYER)="")!($G(SRVDT)="") G TQUPDSVX
"RTN","IBCNEUT5",154,0)
 ;
"RTN","IBCNEUT5",155,0)
 ; Loop thru all inquiries to be transmitted to update the service date
"RTN","IBCNEUT5",156,0)
 ; Statuses:  Ready to Transmit(1), Hold(4) and Retry(6)
"RTN","IBCNEUT5",157,0)
 S SVDT=""
"RTN","IBCNEUT5",158,0)
 F  S SVDT=$O(^IBCN(365.1,"AD",DFN,PAYER,SVDT)) Q:'SVDT  D
"RTN","IBCNEUT5",159,0)
 . S DA=0
"RTN","IBCNEUT5",160,0)
 . F  S DA=$O(^IBCN(365.1,"AD",DFN,PAYER,SVDT,DA)) Q:'DA  D
"RTN","IBCNEUT5",161,0)
 .. ; TQ Status
"RTN","IBCNEUT5",162,0)
 .. S STS=$P($G(^IBCN(365.1,DA,0)),U,4)
"RTN","IBCNEUT5",163,0)
 .. ; Check to see if record is still scheduled to be transmitted.
"RTN","IBCNEUT5",164,0)
 .. ; If so, update the service date if the new service date and current
"RTN","IBCNEUT5",165,0)
 .. ; service date are both in the past or future and the new service
"RTN","IBCNEUT5",166,0)
 .. ; date is closer to Today.  Also, if the current service date is in
"RTN","IBCNEUT5",167,0)
 .. ; the future and the new service date is in the past, update with the
"RTN","IBCNEUT5",168,0)
 .. ; new service date.
"RTN","IBCNEUT5",169,0)
 .. ; If not Ready to Transmit(1), Hold(4) and Retry(6), quit
"RTN","IBCNEUT5",170,0)
 .. I STS'=1,STS'=4,STS'=6 Q
"RTN","IBCNEUT5",171,0)
 .. ; If Hold and last Response returned Error Action - Please resubmit
"RTN","IBCNEUT5",172,0)
 .. ; Original Transaction (P) - do not update
"RTN","IBCNEUT5",173,0)
 .. I STS=4 S ERACT="" D  I ERACT="P" Q
"RTN","IBCNEUT5",174,0)
 .. . ; Last msg sent
"RTN","IBCNEUT5",175,0)
 .. . S HL7IEN=$O(^IBCN(365.1,DA,2," "),-1) Q:'HL7IEN
"RTN","IBCNEUT5",176,0)
 .. . ; Assoc IIV Response IEN
"RTN","IBCNEUT5",177,0)
 .. . S RIEN=$P($G(^IBCN(365.1,DA,2,HL7IEN,0)),U,3) Q:'RIEN
"RTN","IBCNEUT5",178,0)
 .. . ; Error Action IEN (365.018)
"RTN","IBCNEUT5",179,0)
 .. . S ERACT=$P($G(^IBCN(365,RIEN,1)),U,15) Q:'ERACT
"RTN","IBCNEUT5",180,0)
 .. . S ERACT=$P($G(^IBE(365.018,ERACT,0)),U,1)
"RTN","IBCNEUT5",181,0)
 .. ;
"RTN","IBCNEUT5",182,0)
 .. ; Current service date for TQ entry
"RTN","IBCNEUT5",183,0)
 .. S CSRVDT=$P($G(^IBCN(365.1,DA,0)),U,12)
"RTN","IBCNEUT5",184,0)
 .. ; If current service date is today (DT), do not update
"RTN","IBCNEUT5",185,0)
 .. I CSRVDT=DT Q
"RTN","IBCNEUT5",186,0)
 .. ; If new service date is in the future and current service date is in
"RTN","IBCNEUT5",187,0)
 .. ; the past, do not update
"RTN","IBCNEUT5",188,0)
 .. I SRVDT>DT,CSRVDT<DT Q
"RTN","IBCNEUT5",189,0)
 .. ; If new service date is today, update
"RTN","IBCNEUT5",190,0)
 .. I SRVDT=DT D SAVETQ^IBCNEUT2(DA,SRVDT),SAVFRSH(DA,+$$FMDIFF^XLFDT(SRVDT,CSRVDT,1)) Q
"RTN","IBCNEUT5",191,0)
 .. ; If both current and new service dates are in the past or future,
"RTN","IBCNEUT5",192,0)
 .. ; only update, when new service date is closer to today (DT).
"RTN","IBCNEUT5",193,0)
 .. I ((CSRVDT<DT)&(SRVDT<DT))!((CSRVDT>DT)&(SRVDT>DT)) D  Q
"RTN","IBCNEUT5",194,0)
 .. . S CSPAN=$$FMDIFF^XLFDT(CSRVDT,DT,1),SPAN=$$FMDIFF^XLFDT(SRVDT,DT,1)
"RTN","IBCNEUT5",195,0)
 .. . I CSPAN<0 S CSPAN=-CSPAN
"RTN","IBCNEUT5",196,0)
 .. . I SPAN<0 S SPAN=-SPAN
"RTN","IBCNEUT5",197,0)
 .. . I SPAN<CSPAN D SAVETQ^IBCNEUT2(DA,SRVDT),SAVFRSH(DA,+$$FMDIFF^XLFDT(SRVDT,CSRVDT,1))
"RTN","IBCNEUT5",198,0)
 .. ; If new service date is in the past and current service date is in
"RTN","IBCNEUT5",199,0)
 .. ; the future, update
"RTN","IBCNEUT5",200,0)
 .. I SRVDT<CSRVDT D SAVETQ^IBCNEUT2(DA,SRVDT),SAVFRSH(DA,+$$FMDIFF^XLFDT(SRVDT,CSRVDT,1)) Q
"RTN","IBCNEUT5",201,0)
 .. Q
"RTN","IBCNEUT5",202,0)
TQUPDSVX ; TQUPDSV exit pt
"RTN","IBCNEUT5",203,0)
 Q
"RTN","IBCNEUT5",204,0)
 ;
"RTN","IBCNEUT5",205,0)
TQMAXSV(DFN,PAYER) ; Returns MAX(TQ Service Date) for Patient & Payer
"RTN","IBCNEUT5",206,0)
 ; Input: 
"RTN","IBCNEUT5",207,0)
 ;  DFN     - Patient DFN (2)
"RTN","IBCNEUT5",208,0)
 ;  PAYER   - Payer IEN (365.12)
"RTN","IBCNEUT5",209,0)
 ; Output:
"RTN","IBCNEUT5",210,0)
 ;  TQMAXSV - MAX (most recent) service date from TQ entry for Patient &
"RTN","IBCNEUT5",211,0)
 ;            Payer
"RTN","IBCNEUT5",212,0)
 ;
"RTN","IBCNEUT5",213,0)
 N TQMAXSV
"RTN","IBCNEUT5",214,0)
 S TQMAXSV=""
"RTN","IBCNEUT5",215,0)
 I ($G(DFN)="")!($G(PAYER)="") G TQMAXSVX
"RTN","IBCNEUT5",216,0)
 S TQMAXSV=$O(^IBCN(365.1,"AD",DFN,PAYER,""),-1)
"RTN","IBCNEUT5",217,0)
TQMAXSVX ; TQMAXSV exit pt
"RTN","IBCNEUT5",218,0)
 Q TQMAXSV
"RTN","IBCNEUT5",219,0)
 ;
"RTN","IBCNEUT5",220,0)
SNDSSN(PIEN,APP) ; Determine Transmit SSN flag based on Payer and Payer 
"RTN","IBCNEUT5",221,0)
 ; Application values
"RTN","IBCNEUT5",222,0)
 ; Input:
"RTN","IBCNEUT5",223,0)
 ;  PIEN - Payer IEN (365.12)
"RTN","IBCNEUT5",224,0)
 ;  APP  - Payer application description (like "IIV")
"RTN","IBCNEUT5",225,0)
 N IBFLG
"RTN","IBCNEUT5",226,0)
 ;
"RTN","IBCNEUT5",227,0)
 S IBFLG=0
"RTN","IBCNEUT5",228,0)
 ;
"RTN","IBCNEUT5",229,0)
 I $G(PIEN)=""!($G(APP)="") G SNDSSNX
"RTN","IBCNEUT5",230,0)
 S IBFLG=+$P($G(^IBE(365.12,PIEN,1,+$$PYRAPP(APP,PIEN),0)),U,10)
"RTN","IBCNEUT5",231,0)
 ;
"RTN","IBCNEUT5",232,0)
SNDSSNX Q IBFLG
"RTN","IBCNEUT5",233,0)
 ;
"RTN","IBCNEUT5",234,0)
SAVFRSH(TQIEN,DTDIFF) ; Update TQ freshness date based on service date diff
"RTN","IBCNEUT5",235,0)
 ;
"RTN","IBCNEUT5",236,0)
 N DIE,DA,FDT,DR,D,D0,DI,DIC,DQ,X
"RTN","IBCNEUT5",237,0)
 I $G(TQIEN)="" Q
"RTN","IBCNEUT5",238,0)
 S FDT=$P($G(^IBCN(365.1,TQIEN,0)),U,17)
"RTN","IBCNEUT5",239,0)
 ; Note - will only update if FDT > 0.
"RTN","IBCNEUT5",240,0)
 S FDT=$$FMADD^XLFDT(FDT,+DTDIFF)
"RTN","IBCNEUT5",241,0)
 S DIE="^IBCN(365.1,",DA=TQIEN,DR=".17////"_FDT
"RTN","IBCNEUT5",242,0)
 D ^DIE
"RTN","IBCNEUT5",243,0)
 Q
"RTN","IBCNEUT5",244,0)
 ;
"VER")
8.0^22
**END**
**END**
