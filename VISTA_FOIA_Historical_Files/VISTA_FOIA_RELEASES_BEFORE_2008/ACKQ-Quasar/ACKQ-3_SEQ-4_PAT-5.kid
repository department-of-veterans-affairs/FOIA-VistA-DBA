Released ACKQ*3*5 SEQ #4
Extracted from mail message
**KIDS**:ACKQ*3.0*5^

**INSTALL NAME**
ACKQ*3.0*5
"BLD",3481,0)
ACKQ*3.0*5^QUASAR^0^3030224^y
"BLD",3481,1,0)
^^2^2^3021218^
"BLD",3481,1,1,0)
This patch fixes the problem with updating diagnosis histories in the 
"BLD",3481,1,2,0)
A&SP Patient file (#509850.2).
"BLD",3481,4,0)
^9.64PA^^
"BLD",3481,"KRN",0)
^9.67PA^8989.52^19
"BLD",3481,"KRN",.4,0)
.4
"BLD",3481,"KRN",.401,0)
.401
"BLD",3481,"KRN",.402,0)
.402
"BLD",3481,"KRN",.403,0)
.403
"BLD",3481,"KRN",.5,0)
.5
"BLD",3481,"KRN",.84,0)
.84
"BLD",3481,"KRN",3.6,0)
3.6
"BLD",3481,"KRN",3.8,0)
3.8
"BLD",3481,"KRN",9.2,0)
9.2
"BLD",3481,"KRN",9.8,0)
9.8
"BLD",3481,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",3481,"KRN",9.8,"NM",1,0)
ACKQUTL3^^0^B40584171
"BLD",3481,"KRN",9.8,"NM",2,0)
ACKQPCE1^^0^B65163195
"BLD",3481,"KRN",9.8,"NM","B","ACKQPCE1",2)

"BLD",3481,"KRN",9.8,"NM","B","ACKQUTL3",1)

"BLD",3481,"KRN",19,0)
19
"BLD",3481,"KRN",19.1,0)
19.1
"BLD",3481,"KRN",101,0)
101
"BLD",3481,"KRN",409.61,0)
409.61
"BLD",3481,"KRN",771,0)
771
"BLD",3481,"KRN",870,0)
870
"BLD",3481,"KRN",8989.51,0)
8989.51
"BLD",3481,"KRN",8989.52,0)
8989.52
"BLD",3481,"KRN",8994,0)
8994
"BLD",3481,"KRN","B",.4,.4)

"BLD",3481,"KRN","B",.401,.401)

"BLD",3481,"KRN","B",.402,.402)

"BLD",3481,"KRN","B",.403,.403)

"BLD",3481,"KRN","B",.5,.5)

"BLD",3481,"KRN","B",.84,.84)

"BLD",3481,"KRN","B",3.6,3.6)

"BLD",3481,"KRN","B",3.8,3.8)

"BLD",3481,"KRN","B",9.2,9.2)

"BLD",3481,"KRN","B",9.8,9.8)

"BLD",3481,"KRN","B",19,19)

"BLD",3481,"KRN","B",19.1,19.1)

"BLD",3481,"KRN","B",101,101)

"BLD",3481,"KRN","B",409.61,409.61)

"BLD",3481,"KRN","B",771,771)

"BLD",3481,"KRN","B",870,870)

"BLD",3481,"KRN","B",8989.51,8989.51)

"BLD",3481,"KRN","B",8989.52,8989.52)

"BLD",3481,"KRN","B",8994,8994)

"BLD",3481,"QUES",0)
^9.62^^
"BLD",3481,"REQB",0)
^9.611^^
"MBREQ")
0
"PKG",509,-1)
1^1
"PKG",509,0)
QUASAR^ACKQ^Quality: Audiology and Speech Pathology Audit and Review
"PKG",509,20,0)
^9.402P^^
"PKG",509,22,0)
^9.49I^1^1
"PKG",509,22,1,0)
3.0^3000211^3000901^11718
"PKG",509,22,1,"PAH",1,0)
5^3030224
"PKG",509,22,1,"PAH",1,1,0)
^^2^2^3030224
"PKG",509,22,1,"PAH",1,1,1,0)
This patch fixes the problem with updating diagnosis histories in the 
"PKG",509,22,1,"PAH",1,1,2,0)
A&SP Patient file (#509850.2).
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ACKQPCE1")
0^2^B65163195
"RTN","ACKQPCE1",1,0)
ACKQPCE1 ;HCIOFO/AG - Quasar/PCE Interface; August 1999. ; 2/24/03 9:57am
"RTN","ACKQPCE1",2,0)
 ;;3.0;QUASAR;**1,2,5**;Feb 11, 2000
"RTN","ACKQPCE1",3,0)
 ;
"RTN","ACKQPCE1",4,0)
 ; this routine contains the code for sending a Quasar visit to PCE
"RTN","ACKQPCE1",5,0)
 ; it is called from ACKQPCE.
"RTN","ACKQPCE1",6,0)
 ;
"RTN","ACKQPCE1",7,0)
SENDPCE(ACKVIEN,ACKPKG,ACKSRC) ; send a Quasar Visit to PCE.
"RTN","ACKQPCE1",8,0)
 ; see SENDPCE^ACKQPCE for entry parameters and processing notes.
"RTN","ACKQPCE1",9,0)
 ; this routine should not be called directly, only from ACKQPCE
"RTN","ACKQPCE1",10,0)
 ; (this routine assumes all the entry parameters are passed!)
"RTN","ACKQPCE1",11,0)
 N ACKSENT,ACKLOCK,ACKRSN,ACKMSG,ACKFDA,ACKFDA2,ACKPCE,ACKE,ACKERR,ACKNARR
"RTN","ACKQPCE1",12,0)
 N ACKVDT,ACKVTM,ACKPAT,ACKSC,ACKAO,ACKIR,ACKEC,ACKCHKDT,ACKELIG,ACKPROCP
"RTN","ACKQPCE1",13,0)
 N ACKVSC,ACKCAT,ACKAPI,ACKCT,ACKPRIM,ACKSCND,ACKSTUD,ACKIEN,ACKICD9
"RTN","ACKQPCE1",14,0)
 N ACKCPT,ACKVOL,ACKIEN2,ACKMOD,ACKPROB,ACKARR,ACKDATE,ACKDPRIM,ACKK5
"RTN","ACKQPCE1",15,0)
 ; initialise
"RTN","ACKQPCE1",16,0)
 S ACKSENT=0,ACKLOCK=0,ACKERR=0
"RTN","ACKQPCE1",17,0)
 D NOW^%DTC S ACKDATE=%  ; to be used for LAST SENT TO PCE field
"RTN","ACKQPCE1",18,0)
 ;
"RTN","ACKQPCE1",19,0)
 ; lock the visit
"RTN","ACKQPCE1",20,0)
 L +^ACK(509850.6,ACKVIEN):0 S ACKLOCK=$T
"RTN","ACKQPCE1",21,0)
 ; if unable to lock then exit
"RTN","ACKQPCE1",22,0)
 I 'ACKLOCK G SENDPCEX
"RTN","ACKQPCE1",23,0)
 ;
"RTN","ACKQPCE1",24,0)
 ; initialise temp file
"RTN","ACKQPCE1",25,0)
 K ^TMP("ACKQPCE1",$J)
"RTN","ACKQPCE1",26,0)
 ;
"RTN","ACKQPCE1",27,0)
 ; remove PCE errors from the visit
"RTN","ACKQPCE1",28,0)
 D CLEAR^ACKQPCE(ACKVIEN)
"RTN","ACKQPCE1",29,0)
 ;
"RTN","ACKQPCE1",30,0)
 ; get the visit data and place in temp file
"RTN","ACKQPCE1",31,0)
 D GETDATA
"RTN","ACKQPCE1",32,0)
 ;
"RTN","ACKQPCE1",33,0)
 ; if this visit exists in PCE then remove workload data
"RTN","ACKQPCE1",34,0)
 D CHKPCE I ACKERR G SENDPCEX
"RTN","ACKQPCE1",35,0)
 ;
"RTN","ACKQPCE1",36,0)
 ; build the temp file for sending to PCE
"RTN","ACKQPCE1",37,0)
 D BUILD
"RTN","ACKQPCE1",38,0)
 ;
"RTN","ACKQPCE1",39,0)
 ; now send
"RTN","ACKQPCE1",40,0)
 D SENDIT
"RTN","ACKQPCE1",41,0)
 ;
"RTN","ACKQPCE1",42,0)
SENDPCEX ; exit point
"RTN","ACKQPCE1",43,0)
 ;
"RTN","ACKQPCE1",44,0)
 ; if visit was locked, unlock it
"RTN","ACKQPCE1",45,0)
 I ACKLOCK L -^ACK(509850.6,ACKVIEN)
"RTN","ACKQPCE1",46,0)
 ;
"RTN","ACKQPCE1",47,0)
 ; clear the temp file
"RTN","ACKQPCE1",48,0)
 ;K ^TMP("ACKQPCE1",$J)
"RTN","ACKQPCE1",49,0)
 ;
"RTN","ACKQPCE1",50,0)
 ; return
"RTN","ACKQPCE1",51,0)
 Q ACKSENT
"RTN","ACKQPCE1",52,0)
 ;
"RTN","ACKQPCE1",53,0)
GETDATA ; get the visit data and place in temp file
"RTN","ACKQPCE1",54,0)
 S ACKFDA=$NA(^TMP("ACKQPCE1",$J,"FDA"))
"RTN","ACKQPCE1",55,0)
 D GETS^DIQ(509850.6,ACKVIEN_",","**","I",ACKFDA,"")
"RTN","ACKQPCE1",56,0)
 S ACKFDA2=$NA(^TMP("ACKQPCE1",$J,"FDA",509850.6,ACKVIEN_","))
"RTN","ACKQPCE1",57,0)
 ; data now stored in ..
"RTN","ACKQPCE1",58,0)
 ;  ^TMP("ACKQPCE1",$j,"FDA",509850.6,visit_",",fldnum,"I")=internal value
"RTN","ACKQPCE1",59,0)
 ;  simplified to @ACKFDA2@(fldnum,"I")=internal value
"RTN","ACKQPCE1",60,0)
 ;  get the PCE visit ien
"RTN","ACKQPCE1",61,0)
 S ACKPCE=@ACKFDA2@(125,"I")
"RTN","ACKQPCE1",62,0)
 ; get the visit date and time, patient and clinic
"RTN","ACKQPCE1",63,0)
 S ACKVDT=@ACKFDA2@(.01,"I")
"RTN","ACKQPCE1",64,0)
 S ACKVTM=@ACKFDA2@(55,"I")
"RTN","ACKQPCE1",65,0)
 S ACKPAT=@ACKFDA2@(1,"I")
"RTN","ACKQPCE1",66,0)
 S ACKCLN=@ACKFDA2@(2.6,"I")
"RTN","ACKQPCE1",67,0)
 ; end of getdata
"RTN","ACKQPCE1",68,0)
 Q
"RTN","ACKQPCE1",69,0)
 ;
"RTN","ACKQPCE1",70,0)
CHKPCE ; check if the visit is already in PCE and remove workload if it is
"RTN","ACKQPCE1",71,0)
 I 'ACKPCE Q
"RTN","ACKQPCE1",72,0)
 ;
"RTN","ACKQPCE1",73,0)
 ; check PCE visit is for same Patient, Clinic, Date and Time
"RTN","ACKQPCE1",74,0)
 ;  if any item different then this Qsr visit is treated as new
"RTN","ACKQPCE1",75,0)
 ;   and any data from Quasar is deleted from the original PCE visit
"RTN","ACKQPCE1",76,0)
 ;  (sending ACKPKG and ACKSRC ensures that only data that originally
"RTN","ACKQPCE1",77,0)
 ;  came from Quasar will be removed).
"RTN","ACKQPCE1",78,0)
 I +$$PCECHK^ACKQUTL3(ACKPCE,ACKVDT,ACKVTM,ACKPAT,ACKCLN)'=2 D  Q
"RTN","ACKQPCE1",79,0)
 . S ACKE=$$DELVFILE^PXAPI("ALL",ACKPCE,ACKPKG,ACKSRC,0,0,"")
"RTN","ACKQPCE1",80,0)
 . S ACKPCE=""  ; remove PCE Visit ien from Qsr visit
"RTN","ACKQPCE1",81,0)
 . K ACKARR S ACKARR(509850.6,ACKVIEN_",",125)="@"
"RTN","ACKQPCE1",82,0)
 . D FILE^DIE("","ACKARR","")
"RTN","ACKQPCE1",83,0)
 ;
"RTN","ACKQPCE1",84,0)
 ; remove all workload data from the PCE visit
"RTN","ACKQPCE1",85,0)
 S ACKE=$$DELVFILE^PXAPI("CPT^POV^PRV^VISIT",ACKPCE,"","",0,0,"")
"RTN","ACKQPCE1",86,0)
 S ACKERR=$S(ACKE>-1:0,ACKE=-4:0,1:1)
"RTN","ACKQPCE1",87,0)
 ;
"RTN","ACKQPCE1",88,0)
 ; if error occurred then store on visit file
"RTN","ACKQPCE1",89,0)
 I ACKERR D  Q
"RTN","ACKQPCE1",90,0)
 . K ACKRSN S ACKMSG="Unable to delete original PCE visit data (error code="_ACKE_")"
"RTN","ACKQPCE1",91,0)
 . D ADDRSN^ACKQPCE2("PCE VISIT",ACKPCE,"",ACKMSG,.ACKRSN)
"RTN","ACKQPCE1",92,0)
 . D FILERSN^ACKQPCE(ACKVIEN,.ACKRSN)   ; file errors on visit file
"RTN","ACKQPCE1",93,0)
 ;
"RTN","ACKQPCE1",94,0)
 ; if no error, check to see if the entire PCE visit has been deleted
"RTN","ACKQPCE1",95,0)
 ;  and if so, blank out the PCE Visit ien variable so that a new one
"RTN","ACKQPCE1",96,0)
 ;  can be allocated.
"RTN","ACKQPCE1",97,0)
 K ^TMP("PXKENC",$J)
"RTN","ACKQPCE1",98,0)
 D ENCEVENT^PXAPI(ACKPCE)
"RTN","ACKQPCE1",99,0)
 I '$D(^TMP("PXKENC",$J,ACKPCE)) D
"RTN","ACKQPCE1",100,0)
 . K ACKARR S ACKARR(509850.6,ACKVIEN_",",125)="@"
"RTN","ACKQPCE1",101,0)
 . D FILE^DIE("","ACKARR","")
"RTN","ACKQPCE1",102,0)
 . S ACKPCE=""
"RTN","ACKQPCE1",103,0)
 K ^TMP("PXKENC",$J)
"RTN","ACKQPCE1",104,0)
 ;
"RTN","ACKQPCE1",105,0)
 ; return
"RTN","ACKQPCE1",106,0)
 Q
"RTN","ACKQPCE1",107,0)
 ;
"RTN","ACKQPCE1",108,0)
 ;
"RTN","ACKQPCE1",109,0)
BUILD ; now build array for passing data to PCE
"RTN","ACKQPCE1",110,0)
 K ^TMP("ACKQPCE1",$J,"PXAPI")
"RTN","ACKQPCE1",111,0)
 S ACKAPI=$NA(^TMP("ACKQPCE1",$J,"PXAPI"))
"RTN","ACKQPCE1",112,0)
 ;
"RTN","ACKQPCE1",113,0)
 ; ----------encounter date/time----------------
"RTN","ACKQPCE1",114,0)
 S @ACKAPI@("ENCOUNTER",1,"ENC D/T")=(ACKVDT\1+ACKVTM)
"RTN","ACKQPCE1",115,0)
 ; --------------patient-----------------------
"RTN","ACKQPCE1",116,0)
 S @ACKAPI@("ENCOUNTER",1,"PATIENT")=ACKPAT
"RTN","ACKQPCE1",117,0)
 ; ---------------clinic-----------------------
"RTN","ACKQPCE1",118,0)
 S @ACKAPI@("ENCOUNTER",1,"HOS LOC")=ACKCLN
"RTN","ACKQPCE1",119,0)
 ; ------------service connected---------------
"RTN","ACKQPCE1",120,0)
 S ACKSC=@ACKFDA2@(20,"I")
"RTN","ACKQPCE1",121,0)
 S @ACKAPI@("ENCOUNTER",1,"SC")=ACKSC
"RTN","ACKQPCE1",122,0)
 ; -------------agent orange,MST etc---------------
"RTN","ACKQPCE1",123,0)
 S ACKAO=@ACKFDA2@(25,"I")
"RTN","ACKQPCE1",124,0)
 S @ACKAPI@("ENCOUNTER",1,"AO")=ACKAO
"RTN","ACKQPCE1",125,0)
 S ACKIR=@ACKFDA2@(30,"I")
"RTN","ACKQPCE1",126,0)
 S @ACKAPI@("ENCOUNTER",1,"IR")=ACKIR
"RTN","ACKQPCE1",127,0)
 S ACKEC=@ACKFDA2@(35,"I")
"RTN","ACKQPCE1",128,0)
 S @ACKAPI@("ENCOUNTER",1,"EC")=ACKEC
"RTN","ACKQPCE1",129,0)
 S ACKMST=@ACKFDA2@(90,"I")
"RTN","ACKQPCE1",130,0)
 S @ACKAPI@("ENCOUNTER",1,"MST")=ACKMST
"RTN","ACKQPCE1",131,0)
 ; -------------checkout date/time-------------
"RTN","ACKQPCE1",132,0)
 D NOW^%DTC S ACKCHKDT=%
"RTN","ACKQPCE1",133,0)
 S @ACKAPI@("ENCOUNTER",1,"CHECKOUT D/T")=ACKCHKDT
"RTN","ACKQPCE1",134,0)
 ; -------------visit eligibility--------------
"RTN","ACKQPCE1",135,0)
 S ACKELIG=@ACKFDA2@(80,"I")
"RTN","ACKQPCE1",136,0)
 S @ACKAPI@("ENCOUNTER",1,"ELIGIBILITY")=ACKELIG
"RTN","ACKQPCE1",137,0)
 ; --------------service category--------------
"RTN","ACKQPCE1",138,0)
 S ACKVSC=@ACKFDA2@(4,"I")
"RTN","ACKQPCE1",139,0)
 S ACKCAT=$S(ACKVSC="AT":"T",ACKVSC="ST":"T",1:"X")
"RTN","ACKQPCE1",140,0)
 S @ACKAPI@("ENCOUNTER",1,"SERVICE CATEGORY")=ACKCAT
"RTN","ACKQPCE1",141,0)
 ; ---------------encounter type---------------
"RTN","ACKQPCE1",142,0)
 S @ACKAPI@("ENCOUNTER",1,"ENCOUNTER TYPE")="P"
"RTN","ACKQPCE1",143,0)
 ;
"RTN","ACKQPCE1",144,0)
 S ACKCT=0
"RTN","ACKQPCE1",145,0)
 ; ------------secondary provider-------------
"RTN","ACKQPCE1",146,0)
 S ACKK5=""
"RTN","ACKQPCE1",147,0)
 F  S ACKK5=$O(^TMP("ACKQPCE1",$J,"FDA",509850.66,ACKK5)) Q:ACKK5=""  D
"RTN","ACKQPCE1",148,0)
 . I $P(ACKK5,",",2)'=ACKVIEN Q
"RTN","ACKQPCE1",149,0)
 . S ACKSCND=$G(^TMP("ACKQPCE1",$J,"FDA",509850.66,ACKK5,".01","I"))
"RTN","ACKQPCE1",150,0)
 . I ACKSCND="" Q
"RTN","ACKQPCE1",151,0)
 . S ACKSCND=$$CONVERT1^ACKQUTL4(ACKSCND)
"RTN","ACKQPCE1",152,0)
 . S ACKCT=ACKCT+1,@ACKAPI@("PROVIDER",ACKCT,"NAME")=ACKSCND
"RTN","ACKQPCE1",153,0)
 ; ------------primary provider----------------
"RTN","ACKQPCE1",154,0)
 S ACKPRIM=@ACKFDA2@(6,"I")
"RTN","ACKQPCE1",155,0)
 I ACKPRIM'="" D
"RTN","ACKQPCE1",156,0)
 . S ACKPRIM=$$CONVERT1^ACKQUTL4(ACKPRIM)
"RTN","ACKQPCE1",157,0)
 . S ACKCT=ACKCT+1,@ACKAPI@("PROVIDER",ACKCT,"NAME")=ACKPRIM
"RTN","ACKQPCE1",158,0)
 . S @ACKAPI@("PROVIDER",ACKCT,"PRIMARY")=1
"RTN","ACKQPCE1",159,0)
 ;
"RTN","ACKQPCE1",160,0)
 ; ----------------diagnosis------------------
"RTN","ACKQPCE1",161,0)
 N ACKPBLM,ACKPBLMP,ACKIFN,ACKPLQT
"RTN","ACKQPCE1",162,0)
 S ACKCT=0,(ACKIEN,ACKDPRIM,ACKNARR,ACKPBLM,ACKPBLMP)=""
"RTN","ACKQPCE1",163,0)
 F  S ACKIEN=$O(@ACKFDA@(509850.63,ACKIEN)) Q:ACKIEN=""  D
"RTN","ACKQPCE1",164,0)
 . I $P(ACKIEN,",",2)'=ACKVIEN Q
"RTN","ACKQPCE1",165,0)
 . S ACKICD9=@ACKFDA@(509850.63,ACKIEN,.01,"I")
"RTN","ACKQPCE1",166,0)
 . S ACKCT=ACKCT+1,@ACKAPI@("DX/PL",ACKCT,"DIAGNOSIS")=ACKICD9
"RTN","ACKQPCE1",167,0)
 . S ACKNARR=$$GET1^DIQ(80,ACKICD9,10,"I")
"RTN","ACKQPCE1",168,0)
 . I ACKNARR'="" S @ACKAPI@("DX/PL",ACKCT,"NARRATIVE")=ACKNARR
"RTN","ACKQPCE1",169,0)
 . S ACKPBLM=@ACKFDA@(509850.63,ACKIEN,.13,"I") I ACKPBLM D
"RTN","ACKQPCE1",170,0)
 . . S ACKPBLMP=@ACKFDA@(509850.63,ACKIEN,.14,"I") Q:'ACKPBLMP
"RTN","ACKQPCE1",171,0)
 . . I ACKPBLMP'="" S ACKPBLMP=$$CONVERT1^ACKQUTL4(ACKPBLMP)
"RTN","ACKQPCE1",172,0)
 . . S @ACKAPI@("DX/PL",ACKCT,"ENC PROVIDER")=ACKPBLMP
"RTN","ACKQPCE1",173,0)
 . . S ACKIFN=0,ACKPLQT=0
"RTN","ACKQPCE1",174,0)
 . . I $D(^AUPNPROB("AC",ACKPAT)) D
"RTN","ACKQPCE1",175,0)
 . . . F  S ACKIFN=$O(^AUPNPROB("AC",ACKPAT,ACKIFN)) Q:(ACKIFN="")  D  Q:ACKPLQT
"RTN","ACKQPCE1",176,0)
 . . . . I $D(^AUPNPROB("B",ACKICD9,ACKIFN)) S ACKPLQT=ACKIFN
"RTN","ACKQPCE1",177,0)
 . . S:ACKPLQT @ACKAPI@("DX/PL",ACKCT,"PL IEN")=ACKPLQT
"RTN","ACKQPCE1",178,0)
 . . S:'ACKPLQT @ACKAPI@("DX/PL",ACKCT,"PL ADD")="1"
"RTN","ACKQPCE1",179,0)
 . . S @ACKAPI@("DX/PL",ACKCT,"EVENT D/T")=ACKVD
"RTN","ACKQPCE1",180,0)
 . I 'ACKDPRIM,@ACKFDA@(509850.63,ACKIEN,.12,"I")=1 D
"RTN","ACKQPCE1",181,0)
 . . S @ACKAPI@("DX/PL",ACKCT,"PRIMARY")=1
"RTN","ACKQPCE1",182,0)
 . . S ACKDPRIM=1
"RTN","ACKQPCE1",183,0)
 ;  First Diagnosis sent as Primary is No Primary defined on Visit file
"RTN","ACKQPCE1",184,0)
 I 'ACKDPRIM,ACKCT>0 S @ACKAPI@("DX/PL",1,"PRIMARY")=1
"RTN","ACKQPCE1",185,0)
 ;
"RTN","ACKQPCE1",186,0)
 ; -----------------procedures----------------
"RTN","ACKQPCE1",187,0)
 S ACKCT=0,ACKIEN="",ACKPROCP=""
"RTN","ACKQPCE1",188,0)
 F  S ACKIEN=$O(@ACKFDA@(509850.61,ACKIEN)) Q:ACKIEN=""  D
"RTN","ACKQPCE1",189,0)
 . I $P(ACKIEN,",",2)'=ACKVIEN Q
"RTN","ACKQPCE1",190,0)
 . S ACKCPT=@ACKFDA@(509850.61,ACKIEN,.01,"I")    ; CPT IEN
"RTN","ACKQPCE1",191,0)
 . S ACKVOL=@ACKFDA@(509850.61,ACKIEN,.03,"I")    ; Volume
"RTN","ACKQPCE1",192,0)
 . S ACKPROCP=@ACKFDA@(509850.61,ACKIEN,.05,"I")  ; Provider
"RTN","ACKQPCE1",193,0)
 . I ACKPROCP'="" S ACKPROCP=$$CONVERT1^ACKQUTL4(ACKPROCP)   ;  Covert fom QSR to Vista
"RTN","ACKQPCE1",194,0)
 . S ACKCT=ACKCT+1,@ACKAPI@("PROCEDURE",ACKCT,"PROCEDURE")=ACKCPT
"RTN","ACKQPCE1",195,0)
 . S @ACKAPI@("PROCEDURE",ACKCT,"QTY")=$S(ACKVOL:ACKVOL,1:1)
"RTN","ACKQPCE1",196,0)
 . I ACKPROCP'="" S @ACKAPI@("PROCEDURE",ACKCT,"ENC PROVIDER")=ACKPROCP
"RTN","ACKQPCE1",197,0)
 . ; --------------procedure modifiers-------------
"RTN","ACKQPCE1",198,0)
 . S ACKIEN2=""
"RTN","ACKQPCE1",199,0)
 . F  S ACKIEN2=$O(@ACKFDA@(509850.64,ACKIEN2)) Q:ACKIEN2=""  D
"RTN","ACKQPCE1",200,0)
 . . I $P(ACKIEN2,",",2,3)'=$P(ACKIEN,",",1,2) Q
"RTN","ACKQPCE1",201,0)
 . . S ACKMOD=@ACKFDA@(509850.64,ACKIEN2,.01,"I")
"RTN","ACKQPCE1",202,0)
 . . S ACKMOD=$$GET1^DIQ(509850.5,ACKMOD,.01,"E")
"RTN","ACKQPCE1",203,0)
 . . I $D(@ACKAPI@("PROCEDURE",ACKCT,"MODIFIERS"))#10=0 D
"RTN","ACKQPCE1",204,0)
 . . . S @ACKAPI@("PROCEDURE",ACKCT,"MODIFIERS")=""
"RTN","ACKQPCE1",205,0)
 . . S @ACKAPI@("PROCEDURE",ACKCT,"MODIFIERS",ACKMOD)=""
"RTN","ACKQPCE1",206,0)
 ;
"RTN","ACKQPCE1",207,0)
 ; end of build
"RTN","ACKQPCE1",208,0)
 Q
"RTN","ACKQPCE1",209,0)
 ;
"RTN","ACKQPCE1",210,0)
SENDIT ; send the data to PCE
"RTN","ACKQPCE1",211,0)
 K ACKPROB
"RTN","ACKQPCE1",212,0)
 ;
"RTN","ACKQPCE1",213,0)
 ; call the PCE package API
"RTN","ACKQPCE1",214,0)
 S ACKE=$$DATA2PCE^PXAPI($NA(^TMP("ACKQPCE1",$J,"PXAPI")),ACKPKG,ACKSRC,.ACKPCE,"",0,.ACKE2,"",.ACKPROB)
"RTN","ACKQPCE1",215,0)
 ;
"RTN","ACKQPCE1",216,0)
 ; check for returned error messages
"RTN","ACKQPCE1",217,0)
 K ACKRSN S ACKRSN=0
"RTN","ACKQPCE1",218,0)
 I $D(ACKPROB) D CONVERT^ACKQPCE2(.ACKPROB,ACKAPI,.ACKRSN)
"RTN","ACKQPCE1",219,0)
 ;
"RTN","ACKQPCE1",220,0)
 ; if update failed but no errors were returned then create a message
"RTN","ACKQPCE1",221,0)
 I ACKE'=1,'ACKRSN D
"RTN","ACKQPCE1",222,0)
 . S ACKMSG="Unable to update PCE Visit (error code="_ACKE_")"
"RTN","ACKQPCE1",223,0)
 . D ADDRSN^ACKQPCE2("PCE VISIT","","",ACKMSG,.ACKRSN)
"RTN","ACKQPCE1",224,0)
 . I ACKPCE'>0 D    ; pce ien has been corrupted by the API
"RTN","ACKQPCE1",225,0)
 . . K ACKARR S ACKARR(509850.6,ACKVIEN_",",125)="@"
"RTN","ACKQPCE1",226,0)
 . . D FILE^DIE("","ACKARR","")
"RTN","ACKQPCE1",227,0)
 ;
"RTN","ACKQPCE1",228,0)
 ; if errors found then file them on the Visit file and create exception
"RTN","ACKQPCE1",229,0)
 I ACKE'=1,ACKRSN D
"RTN","ACKQPCE1",230,0)
 . D FILERSN^ACKQPCE(ACKVIEN,.ACKRSN)
"RTN","ACKQPCE1",231,0)
 . K ACKARR
"RTN","ACKQPCE1",232,0)
 . S ACKARR(509850.6,ACKVIEN_",",125)=ACKPCE  ; for new visits!
"RTN","ACKQPCE1",233,0)
 . D FILE^DIE("","ACKARR","")
"RTN","ACKQPCE1",234,0)
 ;
"RTN","ACKQPCE1",235,0)
 ; if no errors update the PCE fields
"RTN","ACKQPCE1",236,0)
 I ACKE=1 D
"RTN","ACKQPCE1",237,0)
 . K ACKARR
"RTN","ACKQPCE1",238,0)
 . S ACKARR(509850.6,ACKVIEN_",",125)=ACKPCE  ; for new visits!
"RTN","ACKQPCE1",239,0)
 . S ACKARR(509850.6,ACKVIEN_",",135)=ACKDATE ; date last sent
"RTN","ACKQPCE1",240,0)
 . D FILE^DIE("","ACKARR","")
"RTN","ACKQPCE1",241,0)
 . S ACKSENT=1   ; return flag (1=sent,0=not sent)
"RTN","ACKQPCE1",242,0)
 ;
"RTN","ACKQPCE1",243,0)
 ; end of sendit
"RTN","ACKQPCE1",244,0)
 Q
"RTN","ACKQPCE1",245,0)
 ;
"RTN","ACKQUTL3")
0^1^B40584171
"RTN","ACKQUTL3",1,0)
ACKQUTL3 ;HCIOFO/AG - QUASAR Utility Routine ; 12/13/02 3:51pm
"RTN","ACKQUTL3",2,0)
 ;;3.0;QUASAR;**5**;Feb 11, 2000
"RTN","ACKQUTL3",3,0)
 ;Per VHA Directive 10-93-142, this routine SHOULD NOT be modified.
"RTN","ACKQUTL3",4,0)
 ;
"RTN","ACKQUTL3",5,0)
PCECHKV(ACKVIEN) ; is PCE Visit still same patient etc.
"RTN","ACKQUTL3",6,0)
 ; this function will check that the Qsr Visit (ACKVIEN) has the same
"RTN","ACKQUTL3",7,0)
 ;  values for Patient, Clinic, Date and Time as the PCE Visit that it 
"RTN","ACKQUTL3",8,0)
 ;  points to.
"RTN","ACKQUTL3",9,0)
 ; inputs:-  ACKVIEN - QUASAR Visit IEN (reqd)
"RTN","ACKQUTL3",10,0)
 ; outputs:- see function $$PCECHK below!
"RTN","ACKQUTL3",11,0)
 N ACKTGT,ACKPCE,ACKDT,ACKTM,ACKPAT,ACKCLN
"RTN","ACKQUTL3",12,0)
 D GETS^DIQ(509850.6,ACKVIEN_",",".01;125;1;2.6;55","I","ACKTGT")
"RTN","ACKQUTL3",13,0)
 S ACKPCE=$G(ACKTGT(509850.6,ACKVIEN_",",125,"I"))
"RTN","ACKQUTL3",14,0)
 I 'ACKPCE Q "2^"  ; not pointing to a visit
"RTN","ACKQUTL3",15,0)
 S ACKDT=$G(ACKTGT(509850.6,ACKVIEN_",",.01,"I"))\1
"RTN","ACKQUTL3",16,0)
 S ACKTM=$G(ACKTGT(509850.6,ACKVIEN_",",55,"I"))
"RTN","ACKQUTL3",17,0)
 S ACKPAT=$G(ACKTGT(509850.6,ACKVIEN_",",1,"I"))
"RTN","ACKQUTL3",18,0)
 S ACKCLN=$G(ACKTGT(509850.6,ACKVIEN_",",2.6,"I"))
"RTN","ACKQUTL3",19,0)
 Q $$PCECHK(ACKPCE,ACKDT,ACKTM,ACKPAT,ACKCLN)
"RTN","ACKQUTL3",20,0)
 ;
"RTN","ACKQUTL3",21,0)
PCECHK(ACKPCE,ACKDT,ACKTM,ACKPAT,ACKCLN) ; is PCE Visit still same patient etc.
"RTN","ACKQUTL3",22,0)
 ; this function will check that the Qsr Visit (ACKVIEN) has the same
"RTN","ACKQUTL3",23,0)
 ;  values for Patient, Clinic, Date and Time as the PCE Visit that it 
"RTN","ACKQUTL3",24,0)
 ;  points to.
"RTN","ACKQUTL3",25,0)
 ; inputs:-  ACKPCE - PCE Visit IEN (reqd)
"RTN","ACKQUTL3",26,0)
 ;           ACKDT - date of visit (reqd) (fileman internal)
"RTN","ACKQUTL3",27,0)
 ;           ACKTM - time of visit (reqd)  (qsr time .n[nnnnn])
"RTN","ACKQUTL3",28,0)
 ;           ACKPAT - patient (reqd)
"RTN","ACKQUTL3",29,0)
 ;           ACKCLN - clinic (reqd)
"RTN","ACKQUTL3",30,0)
 ; outputs:- string
"RTN","ACKQUTL3",31,0)
 ;           value: "0^X^Y^Z" - either the date, patient or clinic differ
"RTN","ACKQUTL3",32,0)
 ;                    where X=Clinics are same (1 or 0)
"RTN","ACKQUTL3",33,0)
 ;                          Y=Patients are same (1 or 0)
"RTN","ACKQUTL3",34,0)
 ;                          Z=Dates are same (1 or 0)
"RTN","ACKQUTL3",35,0)
 ;                        eg "0^1^0^0" = patient and dates differ
"RTN","ACKQUTL3",36,0)
 ;                  "1^.123" - only time is different (.123=Pce time)
"RTN","ACKQUTL3",37,0)
 ;                  "2^" - all fields the same
"RTN","ACKQUTL3",38,0)
 N PCEDTTM,PCEDT,PCETM,PCEPAT,PCECLN,ACKSTR
"RTN","ACKQUTL3",39,0)
 K ^TMP("PXKENC",$J)
"RTN","ACKQUTL3",40,0)
 ;
"RTN","ACKQUTL3",41,0)
 ; get the visit data from PCE (places it in ^TMP("PXKENC",$J)
"RTN","ACKQUTL3",42,0)
 D ENCEVENT^PXAPI(ACKPCE)
"RTN","ACKQUTL3",43,0)
 S PCEDTTM=$P($G(^TMP("PXKENC",$J,ACKPCE,"VST",ACKPCE,0)),U,1)
"RTN","ACKQUTL3",44,0)
 S PCEDT=PCEDTTM\1,PCETM=PCEDTTM#1
"RTN","ACKQUTL3",45,0)
 S PCEPAT=$P($G(^TMP("PXKENC",$J,ACKPCE,"VST",ACKPCE,0)),U,5)
"RTN","ACKQUTL3",46,0)
 S PCECLN=$P($G(^TMP("PXKENC",$J,ACKPCE,"VST",ACKPCE,0)),U,22)
"RTN","ACKQUTL3",47,0)
 K ^TMP("PXKENC",$J)
"RTN","ACKQUTL3",48,0)
 ;
"RTN","ACKQUTL3",49,0)
 ; check date, patient and clinic
"RTN","ACKQUTL3",50,0)
 I (PCEDT'=ACKDT)!(PCEPAT'=ACKPAT)!(PCECLN'=ACKCLN) D  Q ACKSTR
"RTN","ACKQUTL3",51,0)
 . S ACKSTR="0^"
"RTN","ACKQUTL3",52,0)
 . S $P(ACKSTR,U,2)=$S(PCECLN=ACKCLN:1,1:0)
"RTN","ACKQUTL3",53,0)
 . S $P(ACKSTR,U,3)=$S(PCEPAT=ACKPAT:1,1:0)
"RTN","ACKQUTL3",54,0)
 . S $P(ACKSTR,U,4)=$S(PCEDT=ACKDT:1,1:0)
"RTN","ACKQUTL3",55,0)
 ;
"RTN","ACKQUTL3",56,0)
 ; check Appointment time
"RTN","ACKQUTL3",57,0)
 I +PCETM'=+ACKTM Q "1^"_PCETM
"RTN","ACKQUTL3",58,0)
 ;
"RTN","ACKQUTL3",59,0)
 ; must be the same!
"RTN","ACKQUTL3",60,0)
 Q "2^"
"RTN","ACKQUTL3",61,0)
 ;
"RTN","ACKQUTL3",62,0)
DISPLAY(ACKVIEN,XPOS) ; create summary line for visit selection
"RTN","ACKQUTL3",63,0)
 N ACKPAT,ACKCLN,ACKTM,ACKTIME,ACKAM,ACKDISP,ACKLEN
"RTN","ACKQUTL3",64,0)
 S ACKTM=$$GET1^DIQ(509850.6,ACKVIEN_",",55,"I"),ACKTIME=$$FMT^ACKQUTL6(ACKTM,2)
"RTN","ACKQUTL3",65,0)
 S ACKPAT=$$GET1^DIQ(509850.6,ACKVIEN_",",1,"E")
"RTN","ACKQUTL3",66,0)
 S ACKCLN=$$GET1^DIQ(509850.6,ACKVIEN_",",2.6,"E")
"RTN","ACKQUTL3",67,0)
 S ACKP=$S($$GET1^DIQ(509850.6,ACKVIEN_",",125,"I"):".",1:" ")
"RTN","ACKQUTL3",68,0)
 I XPOS<35 D
"RTN","ACKQUTL3",69,0)
 . S ACKLEN=80-XPOS-10-2/2
"RTN","ACKQUTL3",70,0)
 . S ACKPAT=$E(ACKPAT_$J("",ACKLEN),1,ACKLEN\1)
"RTN","ACKQUTL3",71,0)
 . I $G(%)'="" D
"RTN","ACKQUTL3",72,0)
 . . I $TR(%,",","")'?.A D
"RTN","ACKQUTL3",73,0)
 . . . S ACKCLN=$E(ACKCLN_$J("",ACKLEN),1,ACKLEN+.5\1)
"RTN","ACKQUTL3",74,0)
 . . . S ACKDISP=" "_ACKTIME_ACKP_" "_ACKPAT_" "_ACKCLN
"RTN","ACKQUTL3",75,0)
 . . I $TR(%,",","")?.A D
"RTN","ACKQUTL3",76,0)
 . . . S ACKCLN=$E(ACKCLN,1,(40-$L(%)))
"RTN","ACKQUTL3",77,0)
 . . . S ACKDISP=" "_ACKTIME_ACKP_" "_ACKCLN
"RTN","ACKQUTL3",78,0)
 . I $G(%)="" D
"RTN","ACKQUTL3",79,0)
 . . S ACKCLN=$E(ACKCLN_$J("",ACKLEN),1,ACKLEN+.5\1)
"RTN","ACKQUTL3",80,0)
 . . S ACKDISP=" "_ACKTIME_ACKP_" "_ACKPAT_" "_ACKCLN
"RTN","ACKQUTL3",81,0)
 I XPOS'<35 D
"RTN","ACKQUTL3",82,0)
 . S ACKLEN=80-XPOS-10-1
"RTN","ACKQUTL3",83,0)
 . S ACKPAT=$E(ACKPAT_$J("",ACKLEN),1,ACKLEN)
"RTN","ACKQUTL3",84,0)
 . S ACKDISP=" "_ACKTIME_ACKP_" "_ACKPAT
"RTN","ACKQUTL3",85,0)
 Q ACKDISP
"RTN","ACKQUTL3",86,0)
 ;
"RTN","ACKQUTL3",87,0)
PCEERR(ACKVIEN,ACKARR,ACKNUM,ACKWIDE) ; retrieve PCE Errors for a visit and store in ACKARR
"RTN","ACKQUTL3",88,0)
 ; inputs:- ACKVIEN - visit ien  (reqd)
"RTN","ACKQUTL3",89,0)
 ;          ACKARR - array name in which to place errors (indirection
"RTN","ACKQUTL3",90,0)
 ;                   used to file data ie @ACKARR@(x) (reqd)
"RTN","ACKQUTL3",91,0)
 ;          ACKNUM - Error number (if only one reqd)  (opt)
"RTN","ACKQUTL3",92,0)
 ;          ACKWIDE - max number of characters in each line (opt)
"RTN","ACKQUTL3",93,0)
 ; outputs:-
"RTN","ACKQUTL3",94,0)
 ;    ACKARR=n  - number of lines to display
"RTN","ACKQUTL3",95,0)
 ;    ACKARR(1-n)=text - text of error (wrapped to ACKWIDE characters)
"RTN","ACKQUTL3",96,0)
 ; if @ACKARR already contains data then this subroutine will append 
"RTN","ACKQUTL3",97,0)
 ;  the PCE Errors starting at line @ACKARR+1. It is up to the calling
"RTN","ACKQUTL3",98,0)
 ;  routine to clear the array @ACKARR before calling this function.
"RTN","ACKQUTL3",99,0)
 N ACKTMP,ACKCT,ACKSUB,TXT,TXT2,I
"RTN","ACKQUTL3",100,0)
 K ^TMP("ACKQUTL3",$J,"PCEERR")
"RTN","ACKQUTL3",101,0)
 S ACKTMP=$NA(^TMP("ACKQUTL3",$J,"PCEERR"))
"RTN","ACKQUTL3",102,0)
 S ACKNUM=+$G(ACKNUM)
"RTN","ACKQUTL3",103,0)
 S ACKWIDE=$S(+$G(ACKWIDE)<1:80,ACKWIDE<40:40,1:ACKWIDE)
"RTN","ACKQUTL3",104,0)
 I 'ACKNUM D GETS^DIQ(509850.6,ACKVIEN_",","6.5*","I",ACKTMP,"")
"RTN","ACKQUTL3",105,0)
 I ACKNUM D GETS^DIQ(509850.65,ACKNUM_","_ACKVIEN_",","*","I",ACKTMP,"")
"RTN","ACKQUTL3",106,0)
 S ACKCT=+$G(@ACKARR)
"RTN","ACKQUTL3",107,0)
 S ACKSUB="" F  S ACKSUB=$O(@ACKTMP@(509850.65,ACKSUB)) Q:ACKSUB=""  D
"RTN","ACKQUTL3",108,0)
 . I $P(ACKSUB,",",2)'=ACKVIEN Q
"RTN","ACKQUTL3",109,0)
 . ; field name and external value
"RTN","ACKQUTL3",110,0)
 . S TXT=@ACKTMP@(509850.65,ACKSUB,.02,"I")_" - "_@ACKTMP@(509850.65,ACKSUB,.04,"I")
"RTN","ACKQUTL3",111,0)
 . I $L(TXT)'>ACKWIDE D
"RTN","ACKQUTL3",112,0)
 . . S ACKCT=ACKCT+1,@ACKARR@(ACKCT)=TXT
"RTN","ACKQUTL3",113,0)
 . I $L(TXT)>ACKWIDE D
"RTN","ACKQUTL3",114,0)
 . . S TXT=$E(@ACKTMP@(509850.65,ACKSUB,.02,"I"),1,ACKWIDE)
"RTN","ACKQUTL3",115,0)
 . . S ACKCT=ACKCT+1,@ACKARR@(ACKCT)=TXT
"RTN","ACKQUTL3",116,0)
 . . S TXT=$E(@ACKTMP@(509850.65,ACKSUB,.04,"I"),1,ACKWIDE)
"RTN","ACKQUTL3",117,0)
 . . S ACKCT=ACKCT+1,@ACKARR@(ACKCT)=TXT
"RTN","ACKQUTL3",118,0)
 . ; pce error message
"RTN","ACKQUTL3",119,0)
 . S TXT=@ACKTMP@(509850.65,ACKSUB,1,"I")
"RTN","ACKQUTL3",120,0)
 . F  Q:TXT=""  D
"RTN","ACKQUTL3",121,0)
 . . S TXT2=$E(TXT,1,ACKWIDE),I=0
"RTN","ACKQUTL3",122,0)
 . . I $L(TXT2)=ACKWIDE F I=$L(TXT2):-1:0 Q:$E(TXT2,I)?1P
"RTN","ACKQUTL3",123,0)
 . . I I S TXT2=$E(TXT2,1,I)
"RTN","ACKQUTL3",124,0)
 . . S TXT=$P(TXT,TXT2,2,255)
"RTN","ACKQUTL3",125,0)
 . . S ACKCT=ACKCT+1,@ACKARR@(ACKCT)=TXT2
"RTN","ACKQUTL3",126,0)
 S @ACKARR=ACKCT
"RTN","ACKQUTL3",127,0)
 K ^TMP("ACKQUTL3",$J,"PCEERR")
"RTN","ACKQUTL3",128,0)
 Q
"RTN","ACKQUTL3",129,0)
 ;
"RTN","ACKQUTL3",130,0)
PROBLIST(ACKPAT,ACKECHO) ; re-build the problem list for a Patient
"RTN","ACKQUTL3",131,0)
 ; this function will run down the QUASAR Visits for a patient and
"RTN","ACKQUTL3",132,0)
 ;  create an accurate problem list for the patient on the A&SP
"RTN","ACKQUTL3",133,0)
 ;  PATIENT file. The function will be called from the Patient 
"RTN","ACKQUTL3",134,0)
 ;  Inquiry option and the Delete Visit function.
"RTN","ACKQUTL3",135,0)
 ; inputs:- ACKPAT - patient DFN
"RTN","ACKQUTL3",136,0)
 ;          ACKECHO - whether to display progress
"RTN","ACKQUTL3",137,0)
 N ACKTMP,ACKVIEN,ACKDT,ACKDT1,ACKIVDT,ACKDIEN,ACKICD,ACKARR
"RTN","ACKQUTL3",138,0)
 ;
"RTN","ACKQUTL3",139,0)
 I '+$G(ACKPAT) Q
"RTN","ACKQUTL3",140,0)
 S ACKECHO=+$G(ACKECHO)
"RTN","ACKQUTL3",141,0)
 K ^TMP("ACKQUTL3",$J,"PROBLIST")
"RTN","ACKQUTL3",142,0)
 S ACKTMP=$NA(^TMP("ACKQUTL3",$J,"PROBLIST"))
"RTN","ACKQUTL3",143,0)
 ;
"RTN","ACKQUTL3",144,0)
 ; walk down the visits for a patient
"RTN","ACKQUTL3",145,0)
 S ACKIVDT=0
"RTN","ACKQUTL3",146,0)
 S ACKVIEN=0 F  S ACKVIEN=$O(^ACK(509850.6,"APT",ACKPAT,ACKVIEN)) Q:'ACKVIEN  D
"RTN","ACKQUTL3",147,0)
 . ; get visit date
"RTN","ACKQUTL3",148,0)
 . S ACKDT=+$$GET1^DIQ(509850.6,ACKVIEN_",",.01,"I")\1
"RTN","ACKQUTL3",149,0)
 . ; get Diagnosis multiple for this visit
"RTN","ACKQUTL3",150,0)
 . D GETS^DIQ(509850.6,ACKVIEN_",","3*","I",$NA(@ACKTMP@(1)))
"RTN","ACKQUTL3",151,0)
 . ; walk down the diagnosis multiple entries
"RTN","ACKQUTL3",152,0)
 . S ACKDIEN="" F  S ACKDIEN=$O(@ACKTMP@(1,509850.63,ACKDIEN)) Q:ACKDIEN=""  D
"RTN","ACKQUTL3",153,0)
 . . I $P(ACKDIEN,",",2)'=ACKVIEN Q
"RTN","ACKQUTL3",154,0)
 . . S ACKICD=@ACKTMP@(1,509850.63,ACKDIEN,.01,"I")
"RTN","ACKQUTL3",155,0)
 . . S ACKDT1=$G(@ACKTMP@(2,ACKICD))
"RTN","ACKQUTL3",156,0)
 . . I ('ACKDT1)!(ACKDT1>ACKDT) S @ACKTMP@(2,ACKICD)=ACKDT
"RTN","ACKQUTL3",157,0)
 . . I ('ACKIVDT)!(ACKIVDT>ACKDT) S ACKIVDT=ACKDT  ; earliest visit date
"RTN","ACKQUTL3",158,0)
 ;
"RTN","ACKQUTL3",159,0)
 ; update initial visit date for the patient
"RTN","ACKQUTL3",160,0)
 K ACKARR
"RTN","ACKQUTL3",161,0)
 S ACKARR(509850.2,ACKPAT_",",1)=ACKIVDT
"RTN","ACKQUTL3",162,0)
 D FILE^DIE("","ACKARR","")
"RTN","ACKQUTL3",163,0)
 ;
"RTN","ACKQUTL3",164,0)
 ; clear down the diagnosis history for the patient
"RTN","ACKQUTL3",165,0)
 D GETS^DIQ(509850.2,ACKPAT_",","2*","I",$NA(@ACKTMP@(4)))
"RTN","ACKQUTL3",166,0)
 S ACKDIEN="" F  S ACKDIEN=$O(@ACKTMP@(4,509850.22,ACKDIEN)) Q:ACKDIEN=""  D
"RTN","ACKQUTL3",167,0)
 . I $P(ACKDIEN,",",2)'=ACKPAT Q
"RTN","ACKQUTL3",168,0)
 . K ACKARR
"RTN","ACKQUTL3",169,0)
 . S ACKARR(509850.22,ACKDIEN,.01)="@"
"RTN","ACKQUTL3",170,0)
 . D FILE^DIE("","ACKARR","")
"RTN","ACKQUTL3",171,0)
 ;
"RTN","ACKQUTL3",172,0)
 ; if no diagnosis history then display message
"RTN","ACKQUTL3",173,0)
 I ACKECHO,$O(@ACKTMP@(2,""))="" D  G PROBLISX
"RTN","ACKQUTL3",174,0)
 . W !!,"No Diagnosis was found in the A&SP CLINIC VISIT file for this patient.",!
"RTN","ACKQUTL3",175,0)
 ;
"RTN","ACKQUTL3",176,0)
 ; sort new diagnosis list by date
"RTN","ACKQUTL3",177,0)
 S ACKICD="" F  S ACKICD=$O(@ACKTMP@(2,ACKICD)) Q:ACKICD=""  D
"RTN","ACKQUTL3",178,0)
 . S ACKDT=@ACKTMP@(2,ACKICD) S @ACKTMP@(3,ACKDT,ACKICD)=""
"RTN","ACKQUTL3",179,0)
 ;
"RTN","ACKQUTL3",180,0)
 ; update diagnosis history 
"RTN","ACKQUTL3",181,0)
 I ACKECHO W !!,"Now updating diagnostic history.",!
"RTN","ACKQUTL3",182,0)
 S (ACKDT,ACKICD)="" F  S ACKDT=$O(@ACKTMP@(3,ACKDT)) Q:ACKDT=""  F  S ACKICD=$O(@ACKTMP@(3,ACKDT,ACKICD)) Q:ACKICD=""  D
"RTN","ACKQUTL3",183,0)
 . K ACKARR
"RTN","ACKQUTL3",184,0)
 . S ACKARR(509850.22,"?+1,"_ACKPAT_",",.01)=ACKICD
"RTN","ACKQUTL3",185,0)
 . S ACKARR(509850.22,"?+1,"_ACKPAT_",",1)=ACKDT
"RTN","ACKQUTL3",186,0)
 . D UPDATE^DIE("","ACKARR","","")
"RTN","ACKQUTL3",187,0)
 ;
"RTN","ACKQUTL3",188,0)
PROBLISX ; all done
"RTN","ACKQUTL3",189,0)
 K ^TMP("ACKQUTL3",$J,"PROBLIST")
"RTN","ACKQUTL3",190,0)
 Q
"VER")
8.0^22.0
**END**
**END**
