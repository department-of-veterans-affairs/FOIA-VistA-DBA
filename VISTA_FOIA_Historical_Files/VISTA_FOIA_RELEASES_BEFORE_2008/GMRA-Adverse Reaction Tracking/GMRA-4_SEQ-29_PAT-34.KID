EMERGENCY Released GMRA*4*34 SEQ #29
Extracted from mail message
**KIDS**:GMRA*4.0*34^

**INSTALL NAME**
GMRA*4.0*34
"BLD",5992,0)
GMRA*4.0*34^ADVERSE REACTION TRACKING^0^3060317^y
"BLD",5992,1,0)
^^2^2^3060118^
"BLD",5992,1,1,0)
Updates to HL7 messaging for HDR.  See FORUM for a complete
"BLD",5992,1,2,0)
description.
"BLD",5992,4,0)
^9.64PA^^
"BLD",5992,6)
1^
"BLD",5992,"ABPKG")
n
"BLD",5992,"KRN",0)
^9.67PA^8989.52^19
"BLD",5992,"KRN",.4,0)
.4
"BLD",5992,"KRN",.401,0)
.401
"BLD",5992,"KRN",.402,0)
.402
"BLD",5992,"KRN",.403,0)
.403
"BLD",5992,"KRN",.5,0)
.5
"BLD",5992,"KRN",.84,0)
.84
"BLD",5992,"KRN",3.6,0)
3.6
"BLD",5992,"KRN",3.8,0)
3.8
"BLD",5992,"KRN",9.2,0)
9.2
"BLD",5992,"KRN",9.8,0)
9.8
"BLD",5992,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5992,"KRN",9.8,"NM",1,0)
GMRAIAL2^^0^B37153742
"BLD",5992,"KRN",9.8,"NM",2,0)
GMRAIAL1^^0^B37789768
"BLD",5992,"KRN",9.8,"NM","B","GMRAIAL1",2)

"BLD",5992,"KRN",9.8,"NM","B","GMRAIAL2",1)

"BLD",5992,"KRN",19,0)
19
"BLD",5992,"KRN",19.1,0)
19.1
"BLD",5992,"KRN",101,0)
101
"BLD",5992,"KRN",409.61,0)
409.61
"BLD",5992,"KRN",771,0)
771
"BLD",5992,"KRN",870,0)
870
"BLD",5992,"KRN",8989.51,0)
8989.51
"BLD",5992,"KRN",8989.52,0)
8989.52
"BLD",5992,"KRN",8994,0)
8994
"BLD",5992,"KRN","B",.4,.4)

"BLD",5992,"KRN","B",.401,.401)

"BLD",5992,"KRN","B",.402,.402)

"BLD",5992,"KRN","B",.403,.403)

"BLD",5992,"KRN","B",.5,.5)

"BLD",5992,"KRN","B",.84,.84)

"BLD",5992,"KRN","B",3.6,3.6)

"BLD",5992,"KRN","B",3.8,3.8)

"BLD",5992,"KRN","B",9.2,9.2)

"BLD",5992,"KRN","B",9.8,9.8)

"BLD",5992,"KRN","B",19,19)

"BLD",5992,"KRN","B",19.1,19.1)

"BLD",5992,"KRN","B",101,101)

"BLD",5992,"KRN","B",409.61,409.61)

"BLD",5992,"KRN","B",771,771)

"BLD",5992,"KRN","B",870,870)

"BLD",5992,"KRN","B",8989.51,8989.51)

"BLD",5992,"KRN","B",8989.52,8989.52)

"BLD",5992,"KRN","B",8994,8994)

"BLD",5992,"QUES",0)
^9.62^^
"BLD",5992,"REQB",0)
^9.611^1^1
"BLD",5992,"REQB",1,0)
GMRA*4.0*23^1
"BLD",5992,"REQB","B","GMRA*4.0*23",1)

"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
34^3060317^1326
"PKG",140,22,1,"PAH",1,1,0)
^^2^2^3060317
"PKG",140,22,1,"PAH",1,1,1,0)
Updates to HL7 messaging for HDR.  See FORUM for a complete
"PKG",140,22,1,"PAH",1,1,2,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMRAIAL1")
0^2^B37789768^B32654103
"RTN","GMRAIAL1",1,0)
GMRAIAL1 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ALLERGIES - PART 1 ; 17 Mar 2006  11:07 AM
"RTN","GMRAIAL1",2,0)
 ;;4.0;Adverse Reaction Tracking;**22,23,34**;Mar 29, 1996
"RTN","GMRAIAL1",3,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","GMRAIAL1",4,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy updates & assessments
"RTN","GMRAIAL1",5,0)
 ;
"RTN","GMRAIAL1",6,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAL1",7,0)
 ;   #4248 - VDEFEL calls       (controlled)
"RTN","GMRAIAL1",8,0)
 ;   #3630 - VAFCQRY calls      (controlled)
"RTN","GMRAIAL1",9,0)
 ;   #2196 - ^PS(50.416,IEN,0)  (controlled)
"RTN","GMRAIAL1",10,0)
 ;   #2574 - $$CLASS2^PSNAPIS   (supported)
"RTN","GMRAIAL1",11,0)
 ;   #4571 - ERR^VDEFREQ        (controlled)
"RTN","GMRAIAL1",12,0)
 ;   #4631 - XTID calls         (supported)
"RTN","GMRAIAL1",13,0)
 ;
"RTN","GMRAIAL1",14,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","GMRAIAL1",15,0)
 ;
"RTN","GMRAIAL1",16,0)
 ; This routine calls GMRAIAL2 for a portion of message
"RTN","GMRAIAL1",17,0)
 ;
"RTN","GMRAIAL1",18,0)
 Q
"RTN","GMRAIAL1",19,0)
 ;
"RTN","GMRAIAL1",20,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ; Entry point
"RTN","GMRAIAL1",21,0)
 ;
"RTN","GMRAIAL1",22,0)
 ; Inputs: EVIEN = IEN of VDEF Event in file 577
"RTN","GMRAIAL1",23,0)
 ;         KEY - IEN of file to create message from
"RTN","GMRAIAL1",24,0)
 ;         VFLAG - "V" for VistA HL7 destination (default)
"RTN","GMRAIAL1",25,0)
 ;         OUT - target array, passed by reference
"RTN","GMRAIAL1",26,0)
 ;         MSHP - Piece 4 contains message subtype
"RTN","GMRAIAL1",27,0)
 ;
"RTN","GMRAIAL1",28,0)
 ; Output: Two part string with parts separated by "^"
"RTN","GMRAIAL1",29,0)
 ;         Part 1: "LM" - output in local array passed in "OUT" parameter
"RTN","GMRAIAL1",30,0)
 ;                 "GM" - output in ^TMP("HLS",$J)
"RTN","GMRAIAL1",31,0)
 ;         Part 2: No longer used
"RTN","GMRAIAL1",32,0)
 ;
"RTN","GMRAIAL1",33,0)
 N DFN,HLFS,HLCM,HLSC,HLRP,HLES,HLQ,ALRDATA,ADD,ALTYPE,XX ;34
"RTN","GMRAIAL1",34,0)
 N DATA,VAL,I,S,X,Y,Z,X1,HL7RC,IEN,IEN1,OUTX,GMRAPID,ENTERR
"RTN","GMRAIAL1",35,0)
 N SEPF,SEPC,SEPR,SEPE,SEPS,ARRAY,CMP,SEQ,GMRAHL,RSLTSTA
"RTN","GMRAIAL1",36,0)
 N GMRAFILE,GMRAIENS,GMRAVUID
"RTN","GMRAIAL1",37,0)
 ;
"RTN","GMRAIAL1",38,0)
 ; Initialize stuff
"RTN","GMRAIAL1",39,0)
 K ^TMP("HLS",$J) S S=0,ARRAY="OUT("_"""HLS"""_",S)",TARGET="LM^"
"RTN","GMRAIAL1",40,0)
 M GMRAHL=VDEFHL
"RTN","GMRAIAL1",41,0)
 ;
"RTN","GMRAIAL1",42,0)
 ; Determine whether API was Allergy Update or Assessment
"RTN","GMRAIAL1",43,0)
 S ALTYPE=$S($P(MSHP,"~",4)="ALGY":1,$P(MSHP,"~",4)="ADAS":2,1:1)
"RTN","GMRAIAL1",44,0)
 ;
"RTN","GMRAIAL1",45,0)
 ; Set up HL7 delimiters
"RTN","GMRAIAL1",46,0)
 S HLCM=$E(GMRAHL("ECH")),HLRP=$E(GMRAHL("ECH"),2),HLSC=$E(GMRAHL("ECH"),4),HLES=$E(GMRAHL("ECH"),3)
"RTN","GMRAIAL1",47,0)
 S HLFS=GMRAHL("FS"),HLQ=GMRAHL("Q"),HL7RC=HLES_HLFS_HLCM_HLRP_HLSC
"RTN","GMRAIAL1",48,0)
 D SETDLMS^VDEFEL
"RTN","GMRAIAL1",49,0)
 ;
"RTN","GMRAIAL1",50,0)
 ; Get allergy data, patient ID, 'entered in error data'
"RTN","GMRAIAL1",51,0)
 ; based on whether it's an allergy update or an assessment
"RTN","GMRAIAL1",52,0)
 ; Allergy: ALTYPE=1, Assessment: ALTYPE=2
"RTN","GMRAIAL1",53,0)
 D:ALTYPE=1  G EXIT:ZTSTOP=1
"RTN","GMRAIAL1",54,0)
 . S ALRDATA=$G(^GMR(120.8,KEY,0))
"RTN","GMRAIAL1",55,0)
 . I ALRDATA="" D ERR^VDEFREQ("No data in file GMR(120.8) for IEN "_KEY) S ZTSTOP=1 Q
"RTN","GMRAIAL1",56,0)
 . S DFN=$P(ALRDATA,U),ENTERR=$G(^GMR(120.8,KEY,"ER"))
"RTN","GMRAIAL1",57,0)
 . S RSLTSTA=$E("FW",1+ENTERR) ;34
"RTN","GMRAIAL1",58,0)
 . I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No data in file DPT for DFN "_DFN) S ZTSTOP=1 Q
"RTN","GMRAIAL1",59,0)
 D:ALTYPE=2  G EXIT:ZTSTOP=1
"RTN","GMRAIAL1",60,0)
 . S ENTERR="",ALRDATA=$G(^GMR(120.86,KEY,0))
"RTN","GMRAIAL1",61,0)
 . I $P(ALRDATA,U,2)="" S ENTERR=1
"RTN","GMRAIAL1",62,0)
 . S DFN=$S(+ENTERR=1:KEY,1:$P(ALRDATA,U))
"RTN","GMRAIAL1",63,0)
 . I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No data in file DPT for DFN "_DFN) S ZTSTOP=1 Q
"RTN","GMRAIAL1",64,0)
 ;
"RTN","GMRAIAL1",65,0)
 ; Build segments for message in OUT, $P # = HL7 field #
"RTN","GMRAIAL1",66,0)
 ;
"RTN","GMRAIAL1",67,0)
 ; PID - Use MPI PID builder
"RTN","GMRAIAL1",68,0)
PID K GMRAPID S OUTX="",S=1,SEQ=""
"RTN","GMRAIAL1",69,0)
 D BLDPID^VAFCQRY(DFN,1,SEQ,.GMRAPID,.GMRAHL)
"RTN","GMRAIAL1",70,0)
 F I=2:1 Q:$G(GMRAPID(I))=""  S GMRAPID(1,I-1)=GMRAPID(I) K GMRAPID(I)
"RTN","GMRAIAL1",71,0)
 M OUTX=GMRAPID(1) K GMRAPID D SAVE
"RTN","GMRAIAL1",72,0)
 ;
"RTN","GMRAIAL1",73,0)
 ; OBR
"RTN","GMRAIAL1",74,0)
OBR S S=S+1,OUTX="",$P(OUTX,HLFS)=1
"RTN","GMRAIAL1",75,0)
 S $P(OUTX,HLFS,3)=KEY_HLCM_$P(SITEPARM,U,6)_$S(ALTYPE=1:"_120.8",ALTYPE=2:"_120.86")
"RTN","GMRAIAL1",76,0)
 S $P(OUTX,HLFS,4)=$P("ALLERGY,ASSESSMENT",",",ALTYPE)_HLCM_HLCM_"L"
"RTN","GMRAIAL1",77,0)
 ;
"RTN","GMRAIAL1",78,0)
 ; Result Status
"RTN","GMRAIAL1",79,0)
 S $P(OUTX,HLFS,25)=$E("FE",1+ENTERR) ;34
"RTN","GMRAIAL1",80,0)
 ;
"RTN","GMRAIAL1",81,0)
 ; Date/time reaction entered in system
"RTN","GMRAIAL1",82,0)
 S $P(OUTX,HLFS,7)=$$TS^VDEFEL($P(ALRDATA,U,4))
"RTN","GMRAIAL1",83,0)
 ;
"RTN","GMRAIAL1",84,0)
 ; Originator for allergy
"RTN","GMRAIAL1",85,0)
 S XX=$P(ALRDATA,U,$P("5^3",U,ALTYPE)) ;34
"RTN","GMRAIAL1",86,0)
 I XX'="" D  ;Block added in 34
"RTN","GMRAIAL1",87,0)
 . S XX=$$XCN200^VDEFEL(XX),XX=$TR(XX,HLCM,HLSC)
"RTN","GMRAIAL1",88,0)
 . F II=2:1:7 S $P(XX,SEPS,II)=$$HL7RC($P(XX,SEPS,II))
"RTN","GMRAIAL1",89,0)
 . S $P(OUTX,HLFS,32)=XX
"RTN","GMRAIAL1",90,0)
 G OBRX:ALTYPE=2
"RTN","GMRAIAL1",91,0)
 ;
"RTN","GMRAIAL1",92,0)
 ; Repeating field of various person roles
"RTN","GMRAIAL1",93,0)
 ; Enterer, Verifier, Error User, ID Band Marker, Chart Marker
"RTN","GMRAIAL1",94,0)
 ; and associated dates
"RTN","GMRAIAL1",95,0)
 S (X,Y,Z)=""
"RTN","GMRAIAL1",96,0)
ENT S XX=$P(ALRDATA,U,5) G VER:XX="" ;34
"RTN","GMRAIAL1",97,0)
 S XX=$$XCN200^VDEFEL(XX),XX=$TR(XX,HLCM,HLSC) ;34
"RTN","GMRAIAL1",98,0)
 F II=2:1:7 S $P(XX,SEPS,II)=$$HL7RC($P(XX,SEPS,II)) ;34
"RTN","GMRAIAL1",99,0)
 S VAL=XX,$P(VAL,HLSC,8)="E",Z=VAL ;34
"RTN","GMRAIAL1",100,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ALRDATA,U,4)),X=Z
"RTN","GMRAIAL1",101,0)
VER G ERR:$P(ALRDATA,U,17)=""
"RTN","GMRAIAL1",102,0)
 S XX=$$XCN200^VDEFEL($P(ALRDATA,U,18)),XX=$TR(XX,HLCM,HLSC) ;34
"RTN","GMRAIAL1",103,0)
 F II=2:1:7 S $P(XX,SEPS,II)=$$HL7RC($P(XX,SEPS,II)) ;34
"RTN","GMRAIAL1",104,0)
 S VAL=XX,$P(VAL,HLSC,8)="V",Z=VAL ;34
"RTN","GMRAIAL1",105,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ALRDATA,U,17)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",106,0)
ERR S XX=+ENTERR G IDBM:'XX ;34
"RTN","GMRAIAL1",107,0)
 S XX=$$XCN200^VDEFEL($P(ENTERR,U,3)),XX=$TR(XX,HLCM,HLSC) ;34
"RTN","GMRAIAL1",108,0)
 F II=2:1:7 S $P(XX,SEPS,II)=$$HL7RC($P(XX,SEPS,II)) ;34
"RTN","GMRAIAL1",109,0)
 S VAL=XX,$P(VAL,HLSC,8)="EE",Z=VAL ;34
"RTN","GMRAIAL1",110,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ENTERR,U,2)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",111,0)
 ;
"RTN","GMRAIAL1",112,0)
 ; May be multiple entries for ID Band & Chart Marker persons
"RTN","GMRAIAL1",113,0)
IDBM G CHRT:'$D(^GMR(120.8,KEY,14))
"RTN","GMRAIAL1",114,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,14,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL1",115,0)
 . S X1=$G(^GMR(120.8,KEY,14,IEN1,0)) ;34
"RTN","GMRAIAL1",116,0)
 . S XX=$$XCN200^VDEFEL($P(X1,U,2)),XX=$TR(XX,HLCM,HLSC) ;34
"RTN","GMRAIAL1",117,0)
 . F II=2:1:7 S $P(XX,SEPS,II)=$$HL7RC($P(XX,SEPS,II)) ;34
"RTN","GMRAIAL1",118,0)
 . S VAL=XX S:VAL="" VAL=Y S $P(VAL,HLSC,8)="BM",Z=VAL ;34
"RTN","GMRAIAL1",119,0)
 . S $P(Z,HLCM,2)=$$TS^VDEFEL($P(X1,U,1)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",120,0)
CHRT G OBR1:'$D(^GMR(120.8,KEY,13))
"RTN","GMRAIAL1",121,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,13,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL1",122,0)
 . S X1=$G(^GMR(120.8,KEY,13,IEN1,0)) ;34
"RTN","GMRAIAL1",123,0)
 . S XX=$$XCN200^VDEFEL($P(X1,U,2)),XX=$TR(XX,HLCM,HLSC) ;34
"RTN","GMRAIAL1",124,0)
 . F II=2:1:7 S $P(XX,SEPS,II)=$$HL7RC($P(XX,SEPS,II)) ;34
"RTN","GMRAIAL1",125,0)
 . S VAL=XX S:VAL="" VAL=Y S $P(VAL,HLSC,8)="CM",Z=VAL ;34
"RTN","GMRAIAL1",126,0)
 . S $P(Z,HLCM,2)=$$TS^VDEFEL($P(X1,U,1)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",127,0)
OBR1 S $P(OUTX,HLFS,34)=X
"RTN","GMRAIAL1",128,0)
 ;
"RTN","GMRAIAL1",129,0)
 ; Observed/Historical Indicator
"RTN","GMRAIAL1",130,0)
 S X=$P(ALRDATA,U,6),GMRAVUID=$$GETVUID(120.8,6,X)
"RTN","GMRAIAL1",131,0)
 S VAL=$P(GMRAVUID,U)_HLCM_$S(X="o":"OBSERVED",X="h":"HISTORICAL",1:"")
"RTN","GMRAIAL1",132,0)
 S VAL=VAL_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL1",133,0)
 S $P(OUTX,HLFS,47)=VAL
"RTN","GMRAIAL1",134,0)
OBRX S OUTX="OBR"_HLFS_OUTX D SAVE
"RTN","GMRAIAL1",135,0)
 ;
"RTN","GMRAIAL1",136,0)
 ; If the record is missing both the Reactant and the GMR Allergy
"RTN","GMRAIAL1",137,0)
 ; trap it as an error.
"RTN","GMRAIAL1",138,0)
 I ALTYPE'=2,$P(ALRDATA,U,2)="",$P(ALRDATA,U,3)="" D ERR^VDEFREQ("Record is missing Reactant and GMR Allergy") S ZTSTOP=1 Q
"RTN","GMRAIAL1",139,0)
 ;
"RTN","GMRAIAL1",140,0)
 ; OK to continue, call GMRAIAL2 for the rest of the message
"RTN","GMRAIAL1",141,0)
CALL D ENTRY^GMRAIAL2
"RTN","GMRAIAL1",142,0)
 ;
"RTN","GMRAIAL1",143,0)
 ; Done building segments
"RTN","GMRAIAL1",144,0)
EXIT Q TARGET
"RTN","GMRAIAL1",145,0)
 ;
"RTN","GMRAIAL1",146,0)
 ;
"RTN","GMRAIAL1",147,0)
 ; Place current string into message array.
"RTN","GMRAIAL1",148,0)
 ; Turn string into array if length >245.
"RTN","GMRAIAL1",149,0)
 ; Move local array to global if needed.
"RTN","GMRAIAL1",150,0)
SAVE N I
"RTN","GMRAIAL1",151,0)
 I $P(OUTX,HLFS)'="PID",$L(OUTX)>245 D
"RTN","GMRAIAL1",152,0)
 . K ADD S ADD=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX))
"RTN","GMRAIAL1",153,0)
 . F I=1:1 S ADD(I)=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX)) Q:OUTX=""
"RTN","GMRAIAL1",154,0)
 . K OUTX M OUTX=ADD
"RTN","GMRAIAL1",155,0)
 M @ARRAY=OUTX
"RTN","GMRAIAL1",156,0)
 ;
"RTN","GMRAIAL1",157,0)
 ; Move local array to global if it's getting big.
"RTN","GMRAIAL1",158,0)
 I $P(TARGET,U)="LM",$S<16000 D
"RTN","GMRAIAL1",159,0)
 . K ^TMP("HLS",$J) M ^TMP("HLS",$J)=OUT("HLS") K OUT("HLS")
"RTN","GMRAIAL1",160,0)
 . S $P(TARGET,U)="GM",ARRAY="^TMP("_"""HLS"""_",$J,S)"
"RTN","GMRAIAL1",161,0)
 K OUTX,ADD
"RTN","GMRAIAL1",162,0)
 Q
"RTN","GMRAIAL1",163,0)
 ;
"RTN","GMRAIAL1",164,0)
 ; Replace any HL7 coding chars. in strings with HL7 escape sequence
"RTN","GMRAIAL1",165,0)
 ; Input: X = data string
"RTN","GMRAIAL1",166,0)
HL7RC(X) N OCHR,RCHR,RCHRI,TYPE,I F TYPE="E","F","C","R","S" D
"RTN","GMRAIAL1",167,0)
 . S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","GMRAIAL1",168,0)
 . S OCHR=$E(HL7RC,RCHRI),RCHR=$E("EFSRT",RCHRI)
"RTN","GMRAIAL1",169,0)
 . Q:'$F(X,OCHR)
"RTN","GMRAIAL1",170,0)
 . F I=1:1 Q:$E(X,I)=""  I $E(X,I)=OCHR S X=$E(X,1,I-1)_HLES_RCHR_HLES_$E(X,I+1,999),I=I+2
"RTN","GMRAIAL1",171,0)
 Q X
"RTN","GMRAIAL1",172,0)
 ;
"RTN","GMRAIAL1",173,0)
 ; Get the VUID value and set up name of coding system
"RTN","GMRAIAL1",174,0)
GETVUID(GMRAFILE,GMRAFLD,GMRADATA,GMRAFLSW) ;
"RTN","GMRAIAL1",175,0)
 ; Input parameters:
"RTN","GMRAIAL1",176,0)
 ;  GMRAFILE - VistA File #
"RTN","GMRAIAL1",177,0)
 ;  GMRAFLD  - Field # in GMRAFILE
"RTN","GMRAIAL1",178,0)
 ;  GMRADATA - Reference value to look up VUID for
"RTN","GMRAIAL1",179,0)
 ;  GMRAFLSW - (Optional) Use 8985.1 if nil, else use GMRAFILE
"RTN","GMRAIAL1",180,0)
 ;
"RTN","GMRAIAL1",181,0)
 ; Output parameter:
"RTN","GMRAIAL1",182,0)
 ;  1st '^' piece - VUID # or 0 if no VUID
"RTN","GMRAIAL1",183,0)
 ;  2nd '^' piece - Coding system: "99VA8985.1" if VUID and GMRAFLSW=nil
"RTN","GMRAIAL1",184,0)
 ;                                 "99VA"_GMRAFILE if GMRAFLSW=1
"RTN","GMRAIAL1",185,0)
 ;                  else = <site_VistA application file #> if no VUID
"RTN","GMRAIAL1",186,0)
 N X S X=+$$GETVUID^XTID(GMRAFILE,GMRAFLD,GMRADATA),GMRAFLSW=$G(GMRAFLSW)
"RTN","GMRAIAL1",187,0)
 I X S $P(X,U,2)="99VA"_$S(GMRAFLSW:GMRAFILE,1:"8985.1")
"RTN","GMRAIAL1",188,0)
 E  S $P(X,U,2)=$P(SITEPARM,U,6)_"_"_GMRAFILE
"RTN","GMRAIAL1",189,0)
 Q X
"RTN","GMRAIAL2")
0^1^B37153742^B32309600
"RTN","GMRAIAL2",1,0)
GMRAIAL2 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ALLERGIES - PART 2 ; 17 Mar 2006  11:55 AM
"RTN","GMRAIAL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**22,23,34**;Mar 29, 1996
"RTN","GMRAIAL2",3,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy updates & assessments
"RTN","GMRAIAL2",4,0)
 ;
"RTN","GMRAIAL2",5,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAL2",6,0)
 ;   #4248 - VDEFEL calls        (controlled)
"RTN","GMRAIAL2",7,0)
 ;   #3630 - VAFCQRY calls       (controlled)
"RTN","GMRAIAL2",8,0)
 ;   #4531 - ZERO^PSN50P41       (supported)
"RTN","GMRAIAL2",9,0)
 ;   #2574 - $$CLASS2^PSNAPIS    (supported)
"RTN","GMRAIAL2",10,0)
 ;
"RTN","GMRAIAL2",11,0)
 ; This routine is called as a subroutine by GMRAIAL1
"RTN","GMRAIAL2",12,0)
 ;
"RTN","GMRAIAL2",13,0)
 Q
"RTN","GMRAIAL2",14,0)
 ;
"RTN","GMRAIAL2",15,0)
ENTRY ; Entry point from GMRAIAL1
"RTN","GMRAIAL2",16,0)
 ;
"RTN","GMRAIAL2",17,0)
 ; Skip to OBX8 if doing an assessment
"RTN","GMRAIAL2",18,0)
 G OBX8:ALTYPE=2
"RTN","GMRAIAL2",19,0)
 ;
"RTN","GMRAIAL2",20,0)
 ; OBX 1 - Reactant
"RTN","GMRAIAL2",21,0)
OBX1 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"AGENT"_HLFS
"RTN","GMRAIAL2",22,0)
 S $P(OUTX,HLFS,5)=$$HL7RC^GMRAIAL1($P(ALRDATA,U,2)),$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",23,0)
 S X=$P(SITEPARM,U,6)_HLCM_$P(SITEPARM,U,5)_HLCM_"L",$P(OUTX,HLFS,15)=X
"RTN","GMRAIAL2",24,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",25,0)
 ;
"RTN","GMRAIAL2",26,0)
 ; OBX2 - Allergy Type
"RTN","GMRAIAL2",27,0)
OBX2 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"ALLERGY TYPE"_HLFS
"RTN","GMRAIAL2",28,0)
 S X=$P(ALRDATA,U,20),VAL=X_HLCM F I=1:1:$L(X) D
"RTN","GMRAIAL2",29,0)
 . S Y=$E(X,I),Y=$S(Y="D":"DRUG",Y="F":"FOOD",Y="O":"OTHER",1:"")
"RTN","GMRAIAL2",30,0)
 . S VAL=VAL_Y S:I<$L(X) VAL=VAL_","
"RTN","GMRAIAL2",31,0)
 S VAL=VAL_HLCM_"L",$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",32,0)
 S X=$P(SITEPARM,U,6)_HLCM_$P(SITEPARM,U,5)_HLCM_"L",$P(OUTX,HLFS,15)=X
"RTN","GMRAIAL2",33,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",34,0)
 ;
"RTN","GMRAIAL2",35,0)
 ; OBX3 - GMR Allergy
"RTN","GMRAIAL2",36,0)
 ;        ALLERGIES FROM VA DRUG CLASS HAVE SPECIAL FORMAT FOR
"RTN","GMRAIAL2",37,0)
 ;        OBX-5
"RTN","GMRAIAL2",38,0)
OBX3 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"GMR ALLERGY"_HLFS
"RTN","GMRAIAL2",39,0)
 S VAL="",X=$P(ALRDATA,U,3) G OBX4:X=""
"RTN","GMRAIAL2",40,0)
 I X'["50.605" D
"RTN","GMRAIAL2",41,0)
 . S VAL=$P($G(@("^"_$P(X,";",2)_$P(X,";",1)_",0)")),U)
"RTN","GMRAIAL2",42,0)
 . I VAL="" D ERR^VDEFREQ("No data in GMR Allergy file "_$P(X,";",2)_$P(X,";")_",0)") S ZTSTOP=1 Q
"RTN","GMRAIAL2",43,0)
 . I X["PSDRUG" S GMRAVUID=$P(X,";",1)_U_$P(SITEPARM,U,6)_"_"_50
"RTN","GMRAIAL2",44,0)
 . E  D
"RTN","GMRAIAL2",45,0)
 . . S GMRAFILE=+$P($P(X,";",2),"(",2),GMRAIENS=+X_","
"RTN","GMRAIAL2",46,0)
 . . S GMRAVUID=$$GETVUID^GMRAIAL1(GMRAFILE,.01,GMRAIENS,1)
"RTN","GMRAIAL2",47,0)
 . S VAL=$P(GMRAVUID,U)_HLCM_VAL_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",48,0)
 I X["50.605" D
"RTN","GMRAIAL2",49,0)
 . S GMRAIENS=$P(X,";"),Y=$$CLASS2^PSNAPIS(GMRAIENS)
"RTN","GMRAIAL2",50,0)
 . S GMRAVUID=$$GETVUID^GMRAIAL1(50.605,.01,GMRAIENS_",",1)
"RTN","GMRAIAL2",51,0)
 . S VAL=$G(VAL)_$P(GMRAVUID,U)_HLCM_$P(Y,U,2)_HLCM_$P(GMRAVUID,U,2)_HLCM_$P(Y,U)_HLCM_$P(Y,U,2)_HLCM_$P(SITEPARM,U,6)_"_50.605"
"RTN","GMRAIAL2",52,0)
 G RETURN:ZTSTOP
"RTN","GMRAIAL2",53,0)
 S $P(VAL,HLCM,2)=$$HL7RC^GMRAIAL1($P(VAL,HLCM,2)),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA ;34
"RTN","GMRAIAL2",54,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",55,0)
 ;
"RTN","GMRAIAL2",56,0)
 ; OBX4 - List of drug ingredients
"RTN","GMRAIAL2",57,0)
OBX4 G OBX5:'$D(^GMR(120.8,KEY,2))
"RTN","GMRAIAL2",58,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"DRUG INGREDIENTS"_HLFS
"RTN","GMRAIAL2",59,0)
 S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,2,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",60,0)
 . S Y=^GMR(120.8,KEY,2,IEN1,0),GMRAVUID=$$GETVUID^GMRAIAL1(50.416,.01,Y_",",1)
"RTN","GMRAIAL2",61,0)
 . D ZERO^PSN50P41(Y,,,"GMRAING") ;34 Gets zero node of ingredient entry from 50.416
"RTN","GMRAIAL2",62,0)
 . S X=$P(GMRAVUID,U)_HLCM_$$HL7RC^GMRAIAL1($P(^TMP($J,"GMRAING",Y,.01),U))_HLCM_$P(GMRAVUID,U,2),VAL=VAL_X_HLRP ;34
"RTN","GMRAIAL2",63,0)
 S VAL=$E(VAL,1,$L(VAL)-1),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",64,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",65,0)
 ;
"RTN","GMRAIAL2",66,0)
 ; OBX5 - Drug class
"RTN","GMRAIAL2",67,0)
OBX5 G OBX6:'$D(^GMR(120.8,KEY,3))
"RTN","GMRAIAL2",68,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"DRUG CLASSES"_HLFS
"RTN","GMRAIAL2",69,0)
 S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,3,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",70,0)
 . S GMRAIENS=^GMR(120.8,KEY,3,IEN1,0),X=$$CLASS2^PSNAPIS(GMRAIENS)
"RTN","GMRAIAL2",71,0)
 . S GMRAVUID=$$GETVUID^GMRAIAL1(50.605,.01,GMRAIENS_",",1)
"RTN","GMRAIAL2",72,0)
 . S VAL=$G(VAL)_$P(GMRAVUID,U)_HLCM_$$HL7RC^GMRAIAL1($P(X,U,2))_HLCM_$P(GMRAVUID,U,2)_HLCM_$P(X,U)_HLCM_$$HL7RC^GMRAIAL1($P(X,U,2))_HLCM_$P(SITEPARM,U,6)_"_50.605"_HLRP ;34
"RTN","GMRAIAL2",73,0)
 S VAL=$E(VAL,1,$L(VAL)-1),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",74,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",75,0)
 ;
"RTN","GMRAIAL2",76,0)
 ; OBX6 - MECHANISM
"RTN","GMRAIAL2",77,0)
OBX6 S X=$P(ALRDATA,U,14) G OBX7:X=""
"RTN","GMRAIAL2",78,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"MECHANISM"_HLFS
"RTN","GMRAIAL2",79,0)
 S GMRAVUID=$$GETVUID^GMRAIAL1(120.8,17,X)
"RTN","GMRAIAL2",80,0)
 S VAL=$P(GMRAVUID,U)_HLCM_$S(X="A":"ALLERGY",X="P":"PHARMACOLOGIC",X="U":"UNKNOWN",1:"")_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",81,0)
 S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",82,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",83,0)
 ;
"RTN","GMRAIAL2",84,0)
 ; OBX7 - Reaction
"RTN","GMRAIAL2",85,0)
OBX7 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,10,IEN1)) Q:'+IEN1  D  Q:ZTSTOP
"RTN","GMRAIAL2",86,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"REACTION"_HLFS
"RTN","GMRAIAL2",87,0)
 . S X=^GMR(120.8,KEY,10,IEN1,0),GMRAVUID=""
"RTN","GMRAIAL2",88,0)
 . S:$P(X,U,2)'="" GMRAVUID="^L"
"RTN","GMRAIAL2",89,0)
 . S:$P(X,U,2)="" $P(X,U,2)=$P($G(^GMRD(120.83,+X,0)),U)
"RTN","GMRAIAL2",90,0)
 . S:GMRAVUID'="^L" GMRAVUID=$$GETVUID^GMRAIAL1(120.83,.01,+X_",",1)
"RTN","GMRAIAL2",91,0)
 . S VAL=$P(GMRAVUID,U)_HLCM_$$HL7RC^GMRAIAL1($P(X,U,2))_HLCM_$P(GMRAVUID,U,2) ;34
"RTN","GMRAIAL2",92,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",93,0)
 . S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(X,U,4))
"RTN","GMRAIAL2",94,0)
 . S XX=$$XCN200^VDEFEL($P(X,U,3)) ;34
"RTN","GMRAIAL2",95,0)
 . F II=2:1:7 S $P(XX,SEPC,II)=$$HL7RC^GMRAIAL1($P(XX,SEPC,II)) ;34
"RTN","GMRAIAL2",96,0)
 . S $P(OUTX,HLFS,16)=XX ;34
"RTN","GMRAIAL2",97,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",98,0)
 ;
"RTN","GMRAIAL2",99,0)
 ; Skip assessment if allergy update
"RTN","GMRAIAL2",100,0)
 G OBX9:ALTYPE=1
"RTN","GMRAIAL2",101,0)
 ;
"RTN","GMRAIAL2",102,0)
 ; OBX8 - Assessment
"RTN","GMRAIAL2",103,0)
OBX8 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"ASSESSMENT"_HLFS
"RTN","GMRAIAL2",104,0)
 I +ENTERR=1 S VAL=HLCM_"ENTERED IN ERROR"_HLCM G OBX8A ;34
"RTN","GMRAIAL2",105,0)
 S X=+$P(ALRDATA,U,2),GMRAVUID=$$GETVUID^GMRAIAL1(120.86,1,X)
"RTN","GMRAIAL2",106,0)
 S VAL=$P(GMRAVUID,U)_HLCM_$S(X=0:"NO KNOWN ALLERGIES",X=1:"YES",1:"")
"RTN","GMRAIAL2",107,0)
 S VAL=VAL_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",108,0)
OBX8A S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=$E("FW",1+ENTERR) ;34
"RTN","GMRAIAL2",109,0)
 I '+ENTERR S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(ALRDATA,U,4))
"RTN","GMRAIAL2",110,0)
 I '+ENTERR D  ;Block added in 34
"RTN","GMRAIAL2",111,0)
 . S XX=$$XCN200^VDEFEL($P(ALRDATA,U,3))
"RTN","GMRAIAL2",112,0)
 . F II=2:1:7 S $P(XX,SEPC,II)=$$HL7RC^GMRAIAL1($P(XX,SEPC,II))
"RTN","GMRAIAL2",113,0)
 . S $P(OUTX,HLFS,16)=XX
"RTN","GMRAIAL2",114,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",115,0)
 ;
"RTN","GMRAIAL2",116,0)
 ; Done if assessment
"RTN","GMRAIAL2",117,0)
 G RETURN:ALTYPE=2
"RTN","GMRAIAL2",118,0)
 ;
"RTN","GMRAIAL2",119,0)
 ; OBX9 - Comments
"RTN","GMRAIAL2",120,0)
 ; One OBX for each comment
"RTN","GMRAIAL2",121,0)
OBX9 S IEN=0 F  S IEN=$O(^GMR(120.8,KEY,26,IEN)) Q:'+IEN  D
"RTN","GMRAIAL2",122,0)
 . S ALRDATA=$G(^GMR(120.8,KEY,26,IEN,0)) G RETURN:ALRDATA=""
"RTN","GMRAIAL2",123,0)
 . ; Set up the static fields
"RTN","GMRAIAL2",124,0)
 . S X1=1_HLFS_"TX"_HLFS_"COMMENT"_HLFS
"RTN","GMRAIAL2",125,0)
 . S XX=$$XCN200^VDEFEL($P(ALRDATA,U,2)) ;34
"RTN","GMRAIAL2",126,0)
 . F II=2:1:7 S $P(XX,SEPC,II)=$$HL7RC^GMRAIAL1($P(XX,SEPC,II)) ;34
"RTN","GMRAIAL2",127,0)
 . S $P(X1,HLFS,11)=RSLTSTA,$P(X1,HLFS,16)=XX ;34
"RTN","GMRAIAL2",128,0)
 . S $P(X1,HLFS,19)=$$TS^VDEFEL($P(ALRDATA,U)),X=$P(ALRDATA,U,3)
"RTN","GMRAIAL2",129,0)
 . S GMRAVUID=$$GETVUID^GMRAIAL1(120.826,1.5,X)
"RTN","GMRAIAL2",130,0)
 . S $P(X,HLCM,2)=$S(X="V":"VERIFIED",X="O":"OBSERVED",X="E":"ERRORED",1:"")
"RTN","GMRAIAL2",131,0)
 . S $P(X,HLCM)=+GMRAVUID,$P(X,HLCM,3)=$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",132,0)
 . S $P(X1,HLFS,17)=X
"RTN","GMRAIAL2",133,0)
 . ;
"RTN","GMRAIAL2",134,0)
 . ; A comment may be more than one line
"RTN","GMRAIAL2",135,0)
 . S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,26,IEN,2,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",136,0)
 . . S X=$$HL7RC^GMRAIAL1(^GMR(120.8,KEY,26,IEN,2,IEN1,0)),VAL=VAL_X_HLRP
"RTN","GMRAIAL2",137,0)
 . S:$E(VAL,$L(VAL))=HLRP VAL=$E(VAL,1,$L(VAL)-1)
"RTN","GMRAIAL2",138,0)
 . S OUTX=X1,$P(OUTX,HLFS,5)=VAL
"RTN","GMRAIAL2",139,0)
 . S S=S+1,OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",140,0)
 ;
"RTN","GMRAIAL2",141,0)
 ; Return to GMRAIAL1
"RTN","GMRAIAL2",142,0)
RETURN Q
"VER")
8.0^22.0
"BLD",5992,6)
^29
**END**
**END**
