Released ECX*3*68 SEQ #65
Extracted from mail message
**KIDS**:ECX*3.0*68^

**INSTALL NAME**
ECX*3.0*68
"BLD",5384,0)
ECX*3.0*68^DSS EXTRACTS^0^3040512^y
"BLD",5384,1,0)
^^5^5^3040217^
"BLD",5384,1,1,0)
Add 'S' prefixed NDC codes to Pharmacy Extracts Incomplete Feeder Key
"BLD",5384,1,2,0)
Report, update YEAR MONTH field definition for the Clinic 
"BLD",5384,1,3,0)
Extract file, identify inactive divisions in division selection list for 
"BLD",5384,1,4,0)
the Surgery Extract Audit Report, update DSS documentation with 
"BLD",5384,1,5,0)
global journaling recommendation.
"BLD",5384,4,0)
^9.64PA^727.827^1
"BLD",5384,4,727.827,0)
727.827
"BLD",5384,4,727.827,2,0)
^9.641^727.827^1
"BLD",5384,4,727.827,2,727.827,0)
CLINIC EXTRACT  (File-top level)
"BLD",5384,4,727.827,2,727.827,1,0)
^9.6411^1^1
"BLD",5384,4,727.827,2,727.827,1,1,0)
YEAR MONTH
"BLD",5384,4,727.827,222)
y^n^p^^^^n^^n
"BLD",5384,4,727.827,224)

"BLD",5384,4,"APDD",727.827,727.827)

"BLD",5384,4,"APDD",727.827,727.827,1)

"BLD",5384,4,"B",727.827,727.827)

"BLD",5384,"KRN",0)
^9.67PA^8989.52^19
"BLD",5384,"KRN",.4,0)
.4
"BLD",5384,"KRN",.401,0)
.401
"BLD",5384,"KRN",.402,0)
.402
"BLD",5384,"KRN",.403,0)
.403
"BLD",5384,"KRN",.5,0)
.5
"BLD",5384,"KRN",.84,0)
.84
"BLD",5384,"KRN",3.6,0)
3.6
"BLD",5384,"KRN",3.8,0)
3.8
"BLD",5384,"KRN",9.2,0)
9.2
"BLD",5384,"KRN",9.8,0)
9.8
"BLD",5384,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5384,"KRN",9.8,"NM",1,0)
ECXDRUG1^^0^B33255159
"BLD",5384,"KRN",9.8,"NM",2,0)
ECXDRUG2^^0^B15540546
"BLD",5384,"KRN",9.8,"NM",3,0)
ECXDVSN2^^0^B40513797
"BLD",5384,"KRN",9.8,"NM","B","ECXDRUG1",1)

"BLD",5384,"KRN",9.8,"NM","B","ECXDRUG2",2)

"BLD",5384,"KRN",9.8,"NM","B","ECXDVSN2",3)

"BLD",5384,"KRN",19,0)
19
"BLD",5384,"KRN",19.1,0)
19.1
"BLD",5384,"KRN",101,0)
101
"BLD",5384,"KRN",409.61,0)
409.61
"BLD",5384,"KRN",771,0)
771
"BLD",5384,"KRN",870,0)
870
"BLD",5384,"KRN",8989.51,0)
8989.51
"BLD",5384,"KRN",8989.52,0)
8989.52
"BLD",5384,"KRN",8994,0)
8994
"BLD",5384,"KRN","B",.4,.4)

"BLD",5384,"KRN","B",.401,.401)

"BLD",5384,"KRN","B",.402,.402)

"BLD",5384,"KRN","B",.403,.403)

"BLD",5384,"KRN","B",.5,.5)

"BLD",5384,"KRN","B",.84,.84)

"BLD",5384,"KRN","B",3.6,3.6)

"BLD",5384,"KRN","B",3.8,3.8)

"BLD",5384,"KRN","B",9.2,9.2)

"BLD",5384,"KRN","B",9.8,9.8)

"BLD",5384,"KRN","B",19,19)

"BLD",5384,"KRN","B",19.1,19.1)

"BLD",5384,"KRN","B",101,101)

"BLD",5384,"KRN","B",409.61,409.61)

"BLD",5384,"KRN","B",771,771)

"BLD",5384,"KRN","B",870,870)

"BLD",5384,"KRN","B",8989.51,8989.51)

"BLD",5384,"KRN","B",8989.52,8989.52)

"BLD",5384,"KRN","B",8994,8994)

"BLD",5384,"QUES",0)
^9.62^^
"BLD",5384,"REQB",0)
^9.611^2^2
"BLD",5384,"REQB",1,0)
ECX*3.0*40^2
"BLD",5384,"REQB",2,0)
ECX*3.0*24^2
"BLD",5384,"REQB","B","ECX*3.0*24",2)

"BLD",5384,"REQB","B","ECX*3.0*40",1)

"FIA",727.827)
CLINIC EXTRACT
"FIA",727.827,0)
^ECX(727.827,
"FIA",727.827,0,0)
727.827
"FIA",727.827,0,1)
y^n^p^^^^n^^n
"FIA",727.827,0,10)

"FIA",727.827,0,11)

"FIA",727.827,0,"RLRO")

"FIA",727.827,0,"VR")
3.0^ECX
"FIA",727.827,727.827)
1
"FIA",727.827,727.827,1)

"MBREQ")
0
"PKG",535,-1)
1^1
"PKG",535,0)
DSS EXTRACTS^ECX
"PKG",535,20,0)
^9.402P^^
"PKG",535,22,0)
^9.49I^1^1
"PKG",535,22,1,0)
3.0^2971222^3000224^66481
"PKG",535,22,1,"PAH",1,0)
68^3040512
"PKG",535,22,1,"PAH",1,1,0)
^^5^5^3040512
"PKG",535,22,1,"PAH",1,1,1,0)
Add 'S' prefixed NDC codes to Pharmacy Extracts Incomplete Feeder Key
"PKG",535,22,1,"PAH",1,1,2,0)
Report, update YEAR MONTH field definition for the Clinic 
"PKG",535,22,1,"PAH",1,1,3,0)
Extract file, identify inactive divisions in division selection list for 
"PKG",535,22,1,"PAH",1,1,4,0)
the Surgery Extract Audit Report, update DSS documentation with 
"PKG",535,22,1,"PAH",1,1,5,0)
global journaling recommendation.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","ECXDRUG1")
0^1^B33255159
"RTN","ECXDRUG1",1,0)
ECXDRUG1 ;ALB/TMD-Pharmacy Extracts Incomplete Feeder Key Report ; 2/17/04 3:23pm
"RTN","ECXDRUG1",2,0)
 ;;3.0;DSS EXTRACTS;**40,68**;Dec 22, 1997
"RTN","ECXDRUG1",3,0)
 ;
"RTN","ECXDRUG1",4,0)
EN ; entry point
"RTN","ECXDRUG1",5,0)
 N X,Y,DATE,ECRUN,ECXTL,ECSTART,ECEND,ECXDESC,ECXSAVE,ECXOPT,ECSD1,ECED,ECXERR,QFLG
"RTN","ECXDRUG1",6,0)
 S QFLG=0
"RTN","ECXDRUG1",7,0)
 ; get today's date
"RTN","ECXDRUG1",8,0)
 D NOW^%DTC S DATE=X,Y=$E(%,1,12) D DD^%DT S ECRUN=$P(Y,"@") K %DT
"RTN","ECXDRUG1",9,0)
 D BEGIN Q:QFLG
"RTN","ECXDRUG1",10,0)
 D SELECT Q:QFLG
"RTN","ECXDRUG1",11,0)
 S ECXDESC=ECXTL_" Extract Incomplete Feeder Key Report"
"RTN","ECXDRUG1",12,0)
 S ECXSAVE("EC*")=""
"RTN","ECXDRUG1",13,0)
 W !!,"This report requires 132 column format."
"RTN","ECXDRUG1",14,0)
 D EN^XUTMDEVQ("PROCESS^ECXDRUG1",ECXDESC,.ECXSAVE)
"RTN","ECXDRUG1",15,0)
 I POP W !!,"No device selected...exiting.",! Q
"RTN","ECXDRUG1",16,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXDRUG1",17,0)
 D HOME^%ZIS
"RTN","ECXDRUG1",18,0)
 D AUDIT^ECXKILL
"RTN","ECXDRUG1",19,0)
 Q
"RTN","ECXDRUG1",20,0)
 ;
"RTN","ECXDRUG1",21,0)
BEGIN ; display report description
"RTN","ECXDRUG1",22,0)
 W @IOF,!,"This report prints a listing of Drug File (#50) entries that will generate",!,"incomplete Feeder keys in the three Pharmacy Extracts.  This listing",!,"can be used to identify and fix Drug File entries.  "
"RTN","ECXDRUG1",23,0)
 W "The number of extract",!,"records, total, quantity, unit price and total cost for each drug are",!,"included to aid in determining the impact of the incomplete Feeder Keys."
"RTN","ECXDRUG1",24,0)
 W !!,"This report is broken into 3 sections as follows:"
"RTN","ECXDRUG1",25,0)
 W !!,"Section 1:  No PSNDF VA Product Name Entry (first 5 digits are zero)."
"RTN","ECXDRUG1",26,0)
 W !!,"Section 2:  No National Drug Code (NDC) (last 12 digits are zero) or the NDC",!,?12,"is prefixed with an 'S', indicating possible supply item number",!,?12,"or UPC."
"RTN","ECXDRUG1",27,0)
 W !!,"Section 3:  No PSNDF VA Product Name Entry, and"
"RTN","ECXDRUG1",28,0)
 W !,?14,"a. no NDC (all 17 digits are zero), or"
"RTN","ECXDRUG1",29,0)
 W !,?14,"b. The NDC is prefixed with an 'S', indicating possible supply",!,?17,"item number or UPC."
"RTN","ECXDRUG1",30,0)
 W !,"Section 3:  No PSNDF VA Product Name Entry or NDC."
"RTN","ECXDRUG1",31,0)
 W !!,"Run times for this report will vary depending upon the size of the extract and",!,"could take as long as 30 minutes or more to complete.  This report has no effect",!,"on the actual extracts and can be run as needed."
"RTN","ECXDRUG1",32,0)
 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXDRUG1",33,0)
 W:$Y!($E(IOST)="C") @IOF,!!
"RTN","ECXDRUG1",34,0)
 Q
"RTN","ECXDRUG1",35,0)
 ;
"RTN","ECXDRUG1",36,0)
SELECT ; user inputs for report option and date range
"RTN","ECXDRUG1",37,0)
 N DONE,OUT
"RTN","ECXDRUG1",38,0)
 ; allow user to select report option (PRE,IVP or UDP)
"RTN","ECXDRUG1",39,0)
 W "Choose the report you would like to run."
"RTN","ECXDRUG1",40,0)
 S DIR(0)="S^1:PRE;2:IVP;3:UDP",DIR("A")="Selection",DIR("B")=1 D ^DIR K DIR S ECXOPT=Y I X["^" S QFLG=1 Q
"RTN","ECXDRUG1",41,0)
 S ECXTL=$S(ECXOPT=1:"Prescription",ECXOPT=2:"IV Detail",ECXOPT=3:"Unit Dose Local",1:"")
"RTN","ECXDRUG1",42,0)
 ; allow user to select date range for report records
"RTN","ECXDRUG1",43,0)
 W !!,"Enter the date range for which you would like to scan the ",ECXTL,!,"Extract records."
"RTN","ECXDRUG1",44,0)
 S DONE=0 F  S (ECED,ECSD)="" D  Q:QFLG!DONE
"RTN","ECXDRUG1",45,0)
 .K %DT S %DT="AEX",%DT("A")="Starting with Date: ",%DT(0)=-DATE D ^%DT
"RTN","ECXDRUG1",46,0)
 .I Y<0 S QFLG=1 Q
"RTN","ECXDRUG1",47,0)
 .S ECSD=Y,ECSD1=ECSD-.1
"RTN","ECXDRUG1",48,0)
 .D DD^%DT S ECSTART=Y
"RTN","ECXDRUG1",49,0)
 .K %DT S %DT="AEX",%DT("A")="Ending with Date: ",%DT(0)=-DATE D ^%DT
"RTN","ECXDRUG1",50,0)
 .I Y<0 S QFLG=1 Q
"RTN","ECXDRUG1",51,0)
 .I Y<ECSD D  Q
"RTN","ECXDRUG1",52,0)
 ..W !!,"The ending date cannot be earlier than the starting date."
"RTN","ECXDRUG1",53,0)
 ..W !,"Please try again.",!!
"RTN","ECXDRUG1",54,0)
 .I $E(Y,1,5)'=$E(ECSD,1,5) D  Q
"RTN","ECXDRUG1",55,0)
 ..W !!,"Beginning and ending dates must be in the same month and year."
"RTN","ECXDRUG1",56,0)
 ..W !,"Please try again.",!!
"RTN","ECXDRUG1",57,0)
 .S ECED=Y
"RTN","ECXDRUG1",58,0)
 .D DD^%DT S ECEND=Y
"RTN","ECXDRUG1",59,0)
 .S DONE=1
"RTN","ECXDRUG1",60,0)
 Q
"RTN","ECXDRUG1",61,0)
 ;
"RTN","ECXDRUG1",62,0)
PROCESS ; entry point for queued report
"RTN","ECXDRUG1",63,0)
 S ZTREQ="@"
"RTN","ECXDRUG1",64,0)
 S ECXERR=0 D EN^ECXDRUG2 Q:ECXERR
"RTN","ECXDRUG1",65,0)
 S QFLG=0 D PRINT
"RTN","ECXDRUG1",66,0)
 Q
"RTN","ECXDRUG1",67,0)
 ;
"RTN","ECXDRUG1",68,0)
PRINT ; process temp file and print report
"RTN","ECXDRUG1",69,0)
 N PG,GTOT,LN,S,COUNT,SUBTOT,DR,ECTYPE,REC,STATS,ECCOUNT,ECQTY,ECPRC,ECCOST
"RTN","ECXDRUG1",70,0)
 U IO
"RTN","ECXDRUG1",71,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXDRUG1",72,0)
 S (PG,QFLG,GTOT)=0,$P(LN,"-",132)=""
"RTN","ECXDRUG1",73,0)
 F S=1:1:3  Q:QFLG  D HEADER Q:QFLG  D
"RTN","ECXDRUG1",74,0)
 .S (COUNT,SUBTOT)=0,DR="" F  S DR=$O(^TMP($J,DR)) Q:DR=""!QFLG  S ECTYPE=$P(^(DR),U,4) I ECTYPE=S D
"RTN","ECXDRUG1",75,0)
 ..S REC=^TMP($J,DR),STATS=^(DR,0)
"RTN","ECXDRUG1",76,0)
 ..S COUNT=COUNT+1
"RTN","ECXDRUG1",77,0)
 ..S ECCOUNT=$FNUMBER($P(STATS,U),",")
"RTN","ECXDRUG1",78,0)
 ..S ECQTY=$FNUMBER($P(STATS,U,2),",")
"RTN","ECXDRUG1",79,0)
 ..S ECPRC="$"_$FNUMBER($P(REC,U,3),",",4)
"RTN","ECXDRUG1",80,0)
 ..S ECCOST="$"_$FNUMBER($P(STATS,U,3),",",2)
"RTN","ECXDRUG1",81,0)
 ..S SUBTOT=SUBTOT+$P(STATS,U,3)
"RTN","ECXDRUG1",82,0)
 ..W !,$$RJ^XLFSTR(DR,5),?8,$P(REC,U),?60,$P(REC,U,2),?79,$$RJ^XLFSTR(ECCOUNT,5),?87,$$RJ^XLFSTR(ECQTY,10),?99,$$RJ^XLFSTR(ECPRC,16),?117,$$RJ^XLFSTR(ECCOST,13)
"RTN","ECXDRUG1",83,0)
 ..I $Y+2>IOSL D HEADER
"RTN","ECXDRUG1",84,0)
 .Q:QFLG
"RTN","ECXDRUG1",85,0)
 .I COUNT=0 W !!,?8,"No drugs to report for this section"
"RTN","ECXDRUG1",86,0)
 .; print sub total
"RTN","ECXDRUG1",87,0)
 .I COUNT D
"RTN","ECXDRUG1",88,0)
 ..I $Y+3>IOSL D HEADER Q:QFLG
"RTN","ECXDRUG1",89,0)
 ..S GTOT=GTOT+SUBTOT
"RTN","ECXDRUG1",90,0)
 ..S SUBTOT="$"_$FNUMBER(SUBTOT,",",2)
"RTN","ECXDRUG1",91,0)
 ..W !!,?110,"TOTAL",?116,$$RJ^XLFSTR(SUBTOT,14)
"RTN","ECXDRUG1",92,0)
 ; print grand total
"RTN","ECXDRUG1",93,0)
 I GTOT,'QFLG D
"RTN","ECXDRUG1",94,0)
 .I $Y+3>IOSL D HEADER Q:QFLG
"RTN","ECXDRUG1",95,0)
 .S GTOT="$"_$FNUMBER(GTOT,",",2)
"RTN","ECXDRUG1",96,0)
 .W !!,?104,"GRAND TOTAL",?116,$$RJ^XLFSTR(GTOT,14)
"RTN","ECXDRUG1",97,0)
 ;
"RTN","ECXDRUG1",98,0)
CLOSE ;
"RTN","ECXDRUG1",99,0)
 I $E(IOST)="C",'QFLG D
"RTN","ECXDRUG1",100,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXDRUG1",101,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXDRUG1",102,0)
 Q
"RTN","ECXDRUG1",103,0)
 ;
"RTN","ECXDRUG1",104,0)
HEADER ; header and page control
"RTN","ECXDRUG1",105,0)
 N SS,JJ
"RTN","ECXDRUG1",106,0)
 I $E(IOST)="C" D
"RTN","ECXDRUG1",107,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXDRUG1",108,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXDRUG1",109,0)
 Q:QFLG
"RTN","ECXDRUG1",110,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXDRUG1",111,0)
 W !,ECXTL_" Extract Incomplete Feeder Key Report",?124,"Page: "_PG
"RTN","ECXDRUG1",112,0)
 W !,"Start Date: ",ECSTART
"RTN","ECXDRUG1",113,0)
 W !,"End Date:   ",ECEND,?97,"Report Run Date/Time:  "_ECRUN
"RTN","ECXDRUG1",114,0)
 W !!,"Drug",?8,"Generic Name",?60,"Feeder Key",?79,"# of",?89,"Total",?107,"Unit",?122,"Total"
"RTN","ECXDRUG1",115,0)
 W !,"Entry",?79,"Records",?89,"Quantity",?107,"Price",?122,"Cost"
"RTN","ECXDRUG1",116,0)
 W !,LN
"RTN","ECXDRUG1",117,0)
 I S=1 W !!,"No PSNDF VA Product Name Entry (Five leading zeros)",!
"RTN","ECXDRUG1",118,0)
 I S=2 W !!,"No National Drug Code (NDC) (Last 12 zeros, 'N/A', or 'S' prefix)",!
"RTN","ECXDRUG1",119,0)
 I S=3 W !!,"No PSNDF VA Product Name Entry or National Drug Code (NDC)",!
"RTN","ECXDRUG1",120,0)
 Q
"RTN","ECXDRUG1",121,0)
 ;
"RTN","ECXDRUG2")
0^2^B15540546
"RTN","ECXDRUG2",1,0)
ECXDRUG2 ;ALB/TMD-Pharmacy Extracts Incomplete Feeder Key Report ; 2/9/04 7:58pm
"RTN","ECXDRUG2",2,0)
 ;;3.0;DSS EXTRACTS;**40,68**;Dec 22, 1997
"RTN","ECXDRUG2",3,0)
 ;
"RTN","ECXDRUG2",4,0)
EN ; entry point
"RTN","ECXDRUG2",5,0)
 N ECD,LINE,ECDRG,ECQTY,ECPRC
"RTN","ECXDRUG2",6,0)
 K ^TMP($J)
"RTN","ECXDRUG2",7,0)
 S ECD=ECSD1,ECED=ECED+.3
"RTN","ECXDRUG2",8,0)
 S LINE=$S(ECXOPT=1:"PRE",ECXOPT=2:"IVP",ECXOPT=3:"UDP",1:"EXIT")
"RTN","ECXDRUG2",9,0)
 D @LINE
"RTN","ECXDRUG2",10,0)
 Q
"RTN","ECXDRUG2",11,0)
 ;
"RTN","ECXDRUG2",12,0)
PRE ; entry point for PRE data
"RTN","ECXDRUG2",13,0)
 ; order through fills, refills and partial refills
"RTN","ECXDRUG2",14,0)
 N ECRFL,ECRX,ECREF,ECDATA,ECDATA1
"RTN","ECXDRUG2",15,0)
 S ECREF=1
"RTN","ECXDRUG2",16,0)
 F  S ECD=$O(^PSRX("AL",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED   Q:ECXERR  F  S ECRX=$O(^PSRX("AL",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AL",ECD,ECRX,ECRFL)) Q:ECRFL=""  Q:ECXERR  D PRE2
"RTN","ECXDRUG2",17,0)
 S ECD=ECSD1,ECREF="P"
"RTN","ECXDRUG2",18,0)
 F  S ECD=$O(^PSRX("AM",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  Q:ECXERR  F  S ECRX=$O(^PSRX("AM",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AM",ECD,ECRX,ECRFL)) Q:ECRFL=""  D PRE2
"RTN","ECXDRUG2",19,0)
 Q
"RTN","ECXDRUG2",20,0)
 ;
"RTN","ECXDRUG2",21,0)
PRE2 ; get Prescription data
"RTN","ECXDRUG2",22,0)
 S ECDATA=$G(^PSRX(ECRX,0))
"RTN","ECXDRUG2",23,0)
 S ECDRG=+$P(ECDATA,U,6)
"RTN","ECXDRUG2",24,0)
 I ECRFL D
"RTN","ECXDRUG2",25,0)
 .S ECDATA1=$G(^PSRX(ECRX,ECREF,ECRFL,0))
"RTN","ECXDRUG2",26,0)
 .S ECQTY=+$P(ECDATA1,U,4),ECPRC=+$P(ECDATA1,U,11)
"RTN","ECXDRUG2",27,0)
 I 'ECRFL S ECQTY=+$P(ECDATA,U,7),ECPRC=+$P(ECDATA,U,17)
"RTN","ECXDRUG2",28,0)
 D TEST
"RTN","ECXDRUG2",29,0)
 Q
"RTN","ECXDRUG2",30,0)
 ;
"RTN","ECXDRUG2",31,0)
IVP ; entry point for IVP data
"RTN","ECXDRUG2",32,0)
 N ON,DFN,DA,SA
"RTN","ECXDRUG2",33,0)
 F  S ECD=$O(^ECX(728.113,"A",ECD)),DFN=0 Q:'ECD  Q:ECXERR  Q:ECD>ECED  F  S DFN=$O(^ECX(728.113,"A",ECD,DFN)),ON=0  Q:'DFN  Q:ECXERR  F  S ON=$O(^ECX(728.113,"A",ECD,DFN,ON)),DA=0 Q:'ON  K ^TMP($J,"A"),^("S") D
"RTN","ECXDRUG2",34,0)
 .F  S DA=$O(^ECX(728.113,"A",ECD,DFN,ON,DA)) Q:'DA  I $D(^ECX(728.113,DA,0)) S EC=^(0) D
"RTN","ECXDRUG2",35,0)
 ..S ECDRG=$P(EC,U,4)
"RTN","ECXDRUG2",36,0)
 ..S SA=$S($P(EC,U,8)]"":"A",$P(EC,U,9):"S",1:"")
"RTN","ECXDRUG2",37,0)
 ..I SA'="" D
"RTN","ECXDRUG2",38,0)
 ...I '$D(^TMP($J,SA,ECDRG)) S ^(ECDRG)=0,$P(^(ECDRG),U,2)=$P(EC,U,12)
"RTN","ECXDRUG2",39,0)
 ...S $P(^TMP($J,SA,ECDRG),U)=$P(^TMP($J,SA,ECDRG),U)+$S($P(EC,U,6)=1:1,$P(EC,U,6)=4:0,1:-1)
"RTN","ECXDRUG2",40,0)
 .;looped thru all DAs for this order - now put it together
"RTN","ECXDRUG2",41,0)
 .F SA="S","A" S ECDRG="" F  S ECDRG=$O(^TMP($J,SA,ECDRG)) Q:ECDRG=""  D
"RTN","ECXDRUG2",42,0)
 ..S ECQTY=$P(^TMP($J,SA,ECDRG),U),ECPRC=$P(^(ECDRG),U,2)
"RTN","ECXDRUG2",43,0)
 ..D TEST
"RTN","ECXDRUG2",44,0)
 K ^TMP($J,"A"),^TMP($J,"S")
"RTN","ECXDRUG2",45,0)
 Q
"RTN","ECXDRUG2",46,0)
 ;
"RTN","ECXDRUG2",47,0)
UDP ; entry point for UDP data
"RTN","ECXDRUG2",48,0)
 N ECXJ,ECDATA
"RTN","ECXDRUG2",49,0)
 F  S ECD=$O(^ECX(728.904,"A",ECD)) Q:'ECD  Q:ECD>ECED  Q:ECXERR  D
"RTN","ECXDRUG2",50,0)
 .S ECXJ=0 F  S ECXJ=$O(^ECX(728.904,"A",ECD,ECXJ)) Q:'ECXJ  Q:ECXERR  I $D(^ECX(728.904,ECXJ,0)) D
"RTN","ECXDRUG2",51,0)
 ..S DATA=^ECX(728.904,ECXJ,0)
"RTN","ECXDRUG2",52,0)
 ..S ECDRG=$P(DATA,U,4),ECQTY=$P(DATA,U,5),ECCOST=$P(DATA,U,8)
"RTN","ECXDRUG2",53,0)
 ..S ECPRC=ECCOST/ECQTY
"RTN","ECXDRUG2",54,0)
 ..D TEST
"RTN","ECXDRUG2",55,0)
 Q
"RTN","ECXDRUG2",56,0)
 ;
"RTN","ECXDRUG2",57,0)
TEST ; retrieve NDC and PSNDF VA Product Code Entry and test for missing NDC or VA Prod Code
"RTN","ECXDRUG2",58,0)
 N ECTYPE,ECNDC,ECZERO,K,ECPROD,ECFCHAR,ECSTOCK
"RTN","ECXDRUG2",59,0)
 S ECTYPE=0
"RTN","ECXDRUG2",60,0)
 S ECNDC=$P($G(^PSDRUG(ECDRG,2)),U,4)
"RTN","ECXDRUG2",61,0)
 S ECNDC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNDC=$TR(ECNDC,"*",0)
"RTN","ECXDRUG2",62,0)
 S ECZERO=1,ECSTOCK=0 F K=1:1:$L(ECNDC) D  Q:'ECZERO!ECSTOCK
"RTN","ECXDRUG2",63,0)
 .S ECFCHAR=$E(ECNDC,K)
"RTN","ECXDRUG2",64,0)
 .I ECFCHAR="S" S ECSTOCK=1 Q
"RTN","ECXDRUG2",65,0)
 .I ECFCHAR'=0 S ECZERO=0 Q
"RTN","ECXDRUG2",66,0)
 I ECZERO!ECSTOCK!(ECNDC["N/A") S ECTYPE=2
"RTN","ECXDRUG2",67,0)
 S ECPROD=$P($G(^PSDRUG(ECDRG,"ND")),U,3),ECPROD=$$RJ^XLFSTR(ECPROD,5,0)
"RTN","ECXDRUG2",68,0)
 I ECTYPE,'ECPROD S ECTYPE=3
"RTN","ECXDRUG2",69,0)
 I 'ECTYPE,'ECPROD S ECTYPE=1
"RTN","ECXDRUG2",70,0)
 I ECTYPE D FILE
"RTN","ECXDRUG2",71,0)
 Q
"RTN","ECXDRUG2",72,0)
 ;
"RTN","ECXDRUG2",73,0)
FILE ; file record
"RTN","ECXDRUG2",74,0)
 N ECFKEY,ECGNAME,STATS,ECCOUNT,QTY,COST,ECCOST
"RTN","ECXDRUG2",75,0)
 ; create new record if none exists for this drug
"RTN","ECXDRUG2",76,0)
 I '$D(^TMP($J,ECDRG)) D
"RTN","ECXDRUG2",77,0)
 .S ECFKEY=ECPROD_ECNDC
"RTN","ECXDRUG2",78,0)
 .S ECGNAME=$P($G(^PSDRUG(ECDRG,0)),U)
"RTN","ECXDRUG2",79,0)
 .S ^TMP($J,ECDRG)=ECGNAME_U_ECFKEY_U_ECPRC_U_ECTYPE
"RTN","ECXDRUG2",80,0)
 .S ^TMP($J,ECDRG,0)="0^0^0"
"RTN","ECXDRUG2",81,0)
 ; add stats to record
"RTN","ECXDRUG2",82,0)
 S STATS=^TMP($J,ECDRG,0)
"RTN","ECXDRUG2",83,0)
 S ECCOUNT=$P(STATS,U),QTY=$P(STATS,U,2),COST=$P(STATS,U,3)
"RTN","ECXDRUG2",84,0)
 S ECCOUNT=ECCOUNT+1
"RTN","ECXDRUG2",85,0)
 S ECCOST=ECQTY*ECPRC
"RTN","ECXDRUG2",86,0)
 S ECQTY=ECQTY+QTY,ECCOST=ECCOST+COST
"RTN","ECXDRUG2",87,0)
 S ^TMP($J,ECDRG,0)=ECCOUNT_U_ECQTY_U_ECCOST
"RTN","ECXDRUG2",88,0)
 Q
"RTN","ECXDRUG2",89,0)
 ;
"RTN","ECXDRUG2",90,0)
EXIT S ECXERR=1 Q
"RTN","ECXDVSN2")
0^3^B40513797
"RTN","ECXDVSN2",1,0)
ECXDVSN2 ;ALB/JAP - Division selection utility (cont.) ; 5/11/04 3:29pm
"RTN","ECXDVSN2",2,0)
 ;;3.0;DSS EXTRACTS;**14,24,68**;Dec 22, 1997
"RTN","ECXDVSN2",3,0)
 ;
"RTN","ECXDVSN2",4,0)
RAD(ECXDIV,ECXALL,ECXERR) ;setup division/site information for RAD extract audit report
"RTN","ECXDVSN2",5,0)
 ;   input
"RTN","ECXDVSN2",6,0)
 ;   ECXDIV = passed by reference array variable (required)
"RTN","ECXDVSN2",7,0)
 ;   ECXALL = 0/1 (optional)
"RTN","ECXDVSN2",8,0)
 ;            '0' indicates user to select radiology division;
"RTN","ECXDVSN2",9,0)
 ;            '1' indicates 'all' radiology divisions selected or only one division
"RTN","ECXDVSN2",10,0)
 ;                exists in file #79; default is '1'
"RTN","ECXDVSN2",11,0)
 ;   output
"RTN","ECXDVSN2",12,0)
 ;   ECXDIV = data for radiology division/site;
"RTN","ECXDVSN2",13,0)
 ;            ECXDIV(ien in file #79)=ien in file #4^name^station number
"RTN","ECXDVSN2",14,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",15,0)
 ;            if input problem, then '1' returned
"RTN","ECXDVSN2",16,0)
 N X,Y,DIC,DA,DUOUT,DTOUT,DR,DIQ,OUT,ECXARR,ECXD,ECXIEN
"RTN","ECXDVSN2",17,0)
 S:'$D(ECXALL) ECXALL=1 S:ECXALL="" ECXALL=1
"RTN","ECXDVSN2",18,0)
 S ECXERR=0,ECXD=""
"RTN","ECXDVSN2",19,0)
 ;if ecxall=1, then all radiology divisions/sites are selected
"RTN","ECXDVSN2",20,0)
 I ECXALL=1 D
"RTN","ECXDVSN2",21,0)
 .;ecxd=ecxien; both are iens in file #4
"RTN","ECXDVSN2",22,0)
 .F  S ECXD=$O(^RA(79,"B",ECXD)) Q:ECXD=""  S ECXIEN=$O(^(ECXD,"")) D
"RTN","ECXDVSN2",23,0)
 ..K ECXARR S DA=ECXIEN,DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",24,0)
 ..I $D(ECXARR) S ECXDIV(ECXIEN)=ECXIEN_U_ECXARR(4,ECXIEN,.01)_U_ECXARR(4,ECXIEN,99)
"RTN","ECXDVSN2",25,0)
 ;if ecxall=0, user selects radiology divisions/sites
"RTN","ECXDVSN2",26,0)
 I ECXALL=0 S OUT=0 D
"RTN","ECXDVSN2",27,0)
 .F  Q:OUT!ECXERR  D
"RTN","ECXDVSN2",28,0)
 ..S DIC="^RA(79,",DIC(0)="AEMQ" K X,Y D ^DIC
"RTN","ECXDVSN2",29,0)
 ..I $G(DUOUT)!($G(DTOUT)) S OUT=1,ECXERR=1 Q
"RTN","ECXDVSN2",30,0)
 ..I Y=-1,X="" S OUT=1 Q
"RTN","ECXDVSN2",31,0)
 ..S (ECXIEN,DA)=+Y K ECXARR S DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",32,0)
 ..I $D(ECXARR) S ECXDIV(ECXIEN)=ECXIEN_U_ECXARR(4,ECXIEN,.01)_U_ECXARR(4,ECXIEN,99)
"RTN","ECXDVSN2",33,0)
 I ECXERR=1 K ECXDIV
"RTN","ECXDVSN2",34,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",35,0)
 Q
"RTN","ECXDVSN2",36,0)
 ;
"RTN","ECXDVSN2",37,0)
MTL(ECXDIV,ECXALL,ECXERR) ;setup division/site information for MTL extract audit report
"RTN","ECXDVSN2",38,0)
 ;   input
"RTN","ECXDVSN2",39,0)
 ;   ECXDIV = passed by reference array variable (required)
"RTN","ECXDVSN2",40,0)
 ;   ECXALL = 0/1 (optional)
"RTN","ECXDVSN2",41,0)
 ;            '0' not valid; mental health is non-divisional
"RTN","ECXDVSN2",42,0)
 ;            '1' indicates 'all' divisions selected or only one 
"RTN","ECXDVSN2",43,0)
 ;                exists in file #602; default is '1'
"RTN","ECXDVSN2",44,0)
 ;   output
"RTN","ECXDVSN2",45,0)
 ;   ECXDIV = data for site;
"RTN","ECXDVSN2",46,0)
 ;            ECXDIV(ien in file #602)=name in file #602^ien in file #4^name in file #4^station number
"RTN","ECXDVSN2",47,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",48,0)
 ;            if error, then '1' returned; otherwise 0
"RTN","ECXDVSN2",49,0)
 N X,Y,DIC,DA,DR,DIQ,DATE,ECXARR,ECXIEN,SITE,DSITE,YSITE
"RTN","ECXDVSN2",50,0)
 S ECXALL=1
"RTN","ECXDVSN2",51,0)
 S ECXERR=0,ECXD=""
"RTN","ECXDVSN2",52,0)
 ;ecxall=0 is not valid; mental health application is non-divisional
"RTN","ECXDVSN2",53,0)
 ;ecxall=1; get mh site name from file #602
"RTN","ECXDVSN2",54,0)
 ;because mh site is free text, use dss site pointer to file #4
"RTN","ECXDVSN2",55,0)
 I ECXALL=1 D
"RTN","ECXDVSN2",56,0)
 .S X=$O(^YSA(602,"B",ECXD))
"RTN","ECXDVSN2",57,0)
 .I X="" S ECXERR=1 Q
"RTN","ECXDVSN2",58,0)
 .S ECXIEN=$O(^(X,""))
"RTN","ECXDVSN2",59,0)
 .K ECXARR S DA=ECXIEN,DIC="^YSA(602,",DR=".01",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",60,0)
 .I '$D(ECXARR) S ECXERR=1 Q
"RTN","ECXDVSN2",61,0)
 .S YSITE=ECXARR(602,ECXIEN,.01)
"RTN","ECXDVSN2",62,0)
 .S DSSITE=$P($G(^ECX(728,1,0)),U)
"RTN","ECXDVSN2",63,0)
 .I 'DSSITE S ECXERR=1 Q
"RTN","ECXDVSN2",64,0)
 .K ECXARR S DA=DSSITE,DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",65,0)
 .S DATA=DSSITE_U_ECXARR(4,DSSITE,.01)_U_ECXARR(4,DSSITE,99)
"RTN","ECXDVSN2",66,0)
 .;name in file#602^file#4 pointer^name in file #4^station number with suffix
"RTN","ECXDVSN2",67,0)
 .S ECXDIV(ECXIEN)=YSITE_U_DATA
"RTN","ECXDVSN2",68,0)
 I ECXERR=1 K ECXDIV
"RTN","ECXDVSN2",69,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",70,0)
 Q
"RTN","ECXDVSN2",71,0)
 ;
"RTN","ECXDVSN2",72,0)
SUR(ECXDIV,ECXALL,ECXERR) ;setup division/site information for SUR extract audit report
"RTN","ECXDVSN2",73,0)
 ;   input
"RTN","ECXDVSN2",74,0)
 ;   ECXDIV = passed by reference array variable (required)
"RTN","ECXDVSN2",75,0)
 ;   ECXALL = 0/1 (optional)
"RTN","ECXDVSN2",76,0)
 ;            '0' indicates user to select surgery division;
"RTN","ECXDVSN2",77,0)
 ;            '1' indicates 'all' surgery divisions selected or only one division
"RTN","ECXDVSN2",78,0)
 ;                exists in file #133; default is '1'
"RTN","ECXDVSN2",79,0)
 ;   output
"RTN","ECXDVSN2",80,0)
 ;   ECXDIV = data for surgery division/site;
"RTN","ECXDVSN2",81,0)
 ;            ECXDIV(ien in file #133)=ien in file #4^name^station number
"RTN","ECXDVSN2",82,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",83,0)
 ;            if input problem, then '1' returned
"RTN","ECXDVSN2",84,0)
 N X,Y,DIC,DA,DUOUT,DTOUT,DR,DIQ,OUT,ECXARR,ECXD,ECXIEN
"RTN","ECXDVSN2",85,0)
 S:'$D(ECXALL) ECXALL=1 S:ECXALL="" ECXALL=1
"RTN","ECXDVSN2",86,0)
 S ECXERR=0,ECXD=""
"RTN","ECXDVSN2",87,0)
 ;if ecxall=1, then all surgery divisions/sites are selected
"RTN","ECXDVSN2",88,0)
 I ECXALL=1 D
"RTN","ECXDVSN2",89,0)
 .F  S ECXD=$O(^SRO(133,"B",ECXD)) Q:ECXD=""  S ECXIEN=$O(^(ECXD,"")) D
"RTN","ECXDVSN2",90,0)
 ..K ECXARR S DA=ECXD,DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",91,0)
 ..I $D(ECXARR) S ECXDIV(ECXD)=ECXIEN_U_ECXARR(4,ECXD,.01)_U_ECXARR(4,ECXD,99)
"RTN","ECXDVSN2",92,0)
 ;if ecxall=0, user selects surgery divisions/sites
"RTN","ECXDVSN2",93,0)
 I ECXALL=0 S OUT=0 D
"RTN","ECXDVSN2",94,0)
 .F  Q:OUT!ECXERR  D
"RTN","ECXDVSN2",95,0)
 ..S DIC="^SRO(133,",DIC(0)="AEMQ",DIC("W")="I $P(^(0),U,21)=1 W ""**INACTIVE**""" K X,Y D ^DIC
"RTN","ECXDVSN2",96,0)
 ..I $G(DUOUT)!($G(DTOUT)) S OUT=1,ECXERR=1 Q
"RTN","ECXDVSN2",97,0)
 ..I Y=-1,X="" S OUT=1 Q
"RTN","ECXDVSN2",98,0)
 ..S ECXIEN=+Y,(ECXD,DA)=$P(Y,U,2) K ECXARR S DIC="^DIC(4,",DR=".01;99",DIQ="ECXARR" D EN^DIQ1
"RTN","ECXDVSN2",99,0)
 ..I $D(ECXARR) S ECXDIV(ECXD)=ECXIEN_U_ECXARR(4,ECXD,.01)_U_ECXARR(4,ECXD,99)
"RTN","ECXDVSN2",100,0)
 I ECXERR=1 K ECXDIV
"RTN","ECXDVSN2",101,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",102,0)
 Q
"RTN","ECXDVSN2",103,0)
 ;
"RTN","ECXDVSN2",104,0)
PRO(ECXDUZ,ECXPRIME,ECXDIV,ECXALL,ECXERR) ;setup division/site information for PRO extract reports
"RTN","ECXDVSN2",105,0)
 ;   input
"RTN","ECXDVSN2",106,0)
 ;   ECXDUX   = ien in file#200 for user
"RTN","ECXDVSN2",107,0)
 ;   ECXPRIME = primary division ien in file #4 (required)
"RTN","ECXDVSN2",108,0)
 ;   all other variables passed by reference
"RTN","ECXDVSN2",109,0)
 ;   output
"RTN","ECXDVSN2",110,0)
 ;   ECXALL = 0 (one subdivision)
"RTN","ECXDVSN2",111,0)
 ;            1 (all divisions related to primary division)
"RTN","ECXDVSN2",112,0)
 ;   ECXDIV = data array for prosthetics division/site;
"RTN","ECXDVSN2",113,0)
 ;            ECXDIV(n)=ien in file #4^name^station number
"RTN","ECXDVSN2",114,0)
 ;   ECXERR = 0/1
"RTN","ECXDVSN2",115,0)
 ;            if input problem, then '1' returned
"RTN","ECXDVSN2",116,0)
 N X,Y,DA,DR,DUOUT,DTOUT,DIRUT,DIC,DIQ,DIR,OUT,ECXARR
"RTN","ECXDVSN2",117,0)
 S ECXERR=0
"RTN","ECXDVSN2",118,0)
 I +ECXPRIME=0 S ECXERR=1
"RTN","ECXDVSN2",119,0)
 I '$D(^DIC(4,+ECXPRIME)) S ECXERR=1
"RTN","ECXDVSN2",120,0)
 D PDIV3^ECXPUTL(ECXDUZ,ECXPRIME,.ECXDIV)
"RTN","ECXDVSN2",121,0)
 I ECXDIV(1)=0 S ECXERR=1 Q
"RTN","ECXDVSN2",122,0)
 S ECXALL=1
"RTN","ECXDVSN2",123,0)
 S LAST=$O(ECXDIV(99),-1) I LAST>1 D
"RTN","ECXDVSN2",124,0)
 .W !!,"You may select ONE or ALL of the following:",!
"RTN","ECXDVSN2",125,0)
 .F DIV=1:1:LAST D
"RTN","ECXDVSN2",126,0)
 ..W !,"("_DIV_")",?6,$P(ECXDIV(DIV),U,2),?14,$P(ECXDIV(DIV),U,3)
"RTN","ECXDVSN2",127,0)
 .S DIR(0)="SMBA^A:ALL;O:ONE",DIR("A")="Select O(ne) or A(ll): ",DIR("B")="ALL"
"RTN","ECXDVSN2",128,0)
 .W ! K X,Y D ^DIR K DIR
"RTN","ECXDVSN2",129,0)
 .I $D(DUOUT)!($D(DTOUT)) K ECXDIV S OUT=1 Q
"RTN","ECXDVSN2",130,0)
 .Q:Y="A"
"RTN","ECXDVSN2",131,0)
 .S OUT=0 F  D  Q:OUT
"RTN","ECXDVSN2",132,0)
 ..S DIR(0)="NA^1:99:0",DIR("A")="Which one?: ",DIR("?")="^D HELP^ECXDVSN2"
"RTN","ECXDVSN2",133,0)
 ..W ! K X,Y D ^DIR K DIR
"RTN","ECXDVSN2",134,0)
 ..I $D(ECXDIV(+Y)) S DIV=+Y,OUT=1,ECXALL=0 Q
"RTN","ECXDVSN2",135,0)
 ..I $D(DUOUT)!($D(DTOUT)) K ECXDIV S OUT=1 Q
"RTN","ECXDVSN2",136,0)
 .Q:'$D(ECXDIV)
"RTN","ECXDVSN2",137,0)
 .F X=1:1:LAST I X'=DIV K ECXDIV(X)
"RTN","ECXDVSN2",138,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",139,0)
 Q
"RTN","ECXDVSN2",140,0)
 ;
"RTN","ECXDVSN2",141,0)
HELP ;help for dir in pro
"RTN","ECXDVSN2",142,0)
 W !,"A response is required from the following:",!
"RTN","ECXDVSN2",143,0)
 F DIV=1:1:LAST D
"RTN","ECXDVSN2",144,0)
 .W !,"("_DIV_")",?6,$P(ECXDIV(DIV),U,2),?14,$P(ECXDIV(DIV),U,3)
"RTN","ECXDVSN2",145,0)
 W !,"Or ""^"" to exit."
"RTN","ECXDVSN2",146,0)
 Q
"RTN","ECXDVSN2",147,0)
 ;
"RTN","ECXDVSN2",148,0)
ALL(ECXDIV,ECXALL,ECXSTART,ECXEND,ECXERR) ;general purpose division information
"RTN","ECXDVSN2",149,0)
 ;   input
"RTN","ECXDVSN2",150,0)
 ;   ECXDIV = array of divisions selected (required)
"RTN","ECXDVSN2",151,0)
 ;            passed by reference array to contain
"RTN","ECXDVSN2",152,0)
 ;            selected divisions;
"RTN","ECXDVSN2",153,0)
 ;   ECXALL = 1/0 (optional)
"RTN","ECXDVSN2",154,0)
 ;            1==> user wants all divisions OR
"RTN","ECXDVSN2",155,0)
 ;                 facility is non-divisional
"RTN","ECXDVSN2",156,0)
 ;            0==> user wants to select some divisions
"RTN","ECXDVSN2",157,0)
 ;            if ECXALL not defined, then assume 1
"RTN","ECXDVSN2",158,0)
 ;   ECXSTART = start date of date range (optional)
"RTN","ECXDVSN2",159,0)
 ;   ECXEND   = end date of date range (optional)
"RTN","ECXDVSN2",160,0)
 ;   ECXERR   = passed by reference for error return (required)
"RTN","ECXDVSN2",161,0)
 ;   output
"RTN","ECXDVSN2",162,0)
 ;   ECXDIV = array of divisions selected from file #40.8;
"RTN","ECXDVSN2",163,0)
 ;   ECXDIV(ien in file #40.8) = ien in file #4^name^station number^primary indicator^active indicator^dss id
"RTN","ECXDVSN2",164,0)
 ;   error CODE
"RTN","ECXDVSN2",165,0)
 ;   ECXERR   = 1, if input problem occurs
"RTN","ECXDVSN2",166,0)
 ;              0, otherwise
"RTN","ECXDVSN2",167,0)
 ;
"RTN","ECXDVSN2",168,0)
 N OUT,DIC,X,Y,NM,ECXD,ECXIEN,ECXDIEN,ECXACT,ECXNAME,ECXNUM
"RTN","ECXDVSN2",169,0)
 S (OUT,ECXERR)=0
"RTN","ECXDVSN2",170,0)
 ;if start date or end date missing, then both default to today
"RTN","ECXDVSN2",171,0)
 I '$G(ECXSTART)!('$G(ECXEND)) S (ECXSTART,ECXEND)=DT
"RTN","ECXDVSN2",172,0)
 S:'$D(ECXALL) ECXALL=1 S:ECXALL="" ECXALL=1
"RTN","ECXDVSN2",173,0)
 I ECXALL=1 D
"RTN","ECXDVSN2",174,0)
 .S NM="" F  S NM=$O(^DG(40.8,"B",NM)) Q:NM=""  S ECXIEN=$O(^(NM,"")) D
"RTN","ECXDVSN2",175,0)
 ..K Y S DIC="^DG(40.8,",DIC(0)="NZ",X=ECXIEN D ^DIC
"RTN","ECXDVSN2",176,0)
 ..Q:Y=-1
"RTN","ECXDVSN2",177,0)
 ..S ECXNAME=$P(Y(0),U,1),ECXNUM=$P(Y(0),U,2),ECXDIEN=$P(Y(0),U,7)
"RTN","ECXDVSN2",178,0)
 ..S ECXDIV(ECXIEN)=ECXDIEN_U_ECXNAME_U_ECXNUM
"RTN","ECXDVSN2",179,0)
 ..D ACTDIV^ECXDVSN(ECXIEN,ECXSTART,ECXEND,.ECXD,.ECXACT)
"RTN","ECXDVSN2",180,0)
 ..S ECXDIV(ECXIEN)=ECXDIV(ECXIEN)_U_ECXD_U_ECXACT
"RTN","ECXDVSN2",181,0)
 ..I $D(^ECX(727.3,ECXIEN)) D
"RTN","ECXDVSN2",182,0)
 ...S ECXDIV(ECXIEN)=ECXDIV(ECXIEN)_U_$P($G(^ECX(727.3,ECXIEN,0)),U,2)
"RTN","ECXDVSN2",183,0)
 I ECXALL=0 F  Q:OUT!ECXERR  D
"RTN","ECXDVSN2",184,0)
 .K Y S DIC="^DG(40.8,",DIC(0)="AEMQZ"
"RTN","ECXDVSN2",185,0)
 .D ^DIC I $G(DUOUT)!($G(DTOUT)) S OUT=1,ECXERR=1 Q
"RTN","ECXDVSN2",186,0)
 .I Y=-1,X="" S OUT=1 Q
"RTN","ECXDVSN2",187,0)
 .S ECXIEN=+Y,ECXNAME=$P(Y(0),U,1),ECXNUM=$P(Y(0),U,2),ECXDIEN=$P(Y(0),U,7)
"RTN","ECXDVSN2",188,0)
 .S ECXDIV(ECXIEN)=ECXDIEN_U_ECXNAME_U_ECXNUM
"RTN","ECXDVSN2",189,0)
 .D ACTDIV^ECXDVSN(ECXIEN,ECXSTART,ECXEND,.ECXD,.ECXACT)
"RTN","ECXDVSN2",190,0)
 .S ECXDIV(ECXIEN)=ECXDIV(ECXIEN)_U_ECXD_U_ECXACT
"RTN","ECXDVSN2",191,0)
 .I $D(^ECX(727.3,ECXIEN)) D
"RTN","ECXDVSN2",192,0)
 ..S ECXDIV(ECXIEN)=ECXDIV(ECXIEN)_U_$P($G(^ECX(727.3,ECXIEN,0)),U,2)
"RTN","ECXDVSN2",193,0)
 .I 'ECXACT W !!,?5,"Please note: Division "_ECXNUM_" was not active during",!,?5,"             selected date range.",!
"RTN","ECXDVSN2",194,0)
 I ECXERR=1 K ECXDIV
"RTN","ECXDVSN2",195,0)
 I '$D(ECXDIV) S ECXERR=1
"RTN","ECXDVSN2",196,0)
 Q
"VER")
8.0^22
"^DD",727.827,727.827,1,0)
YEAR MONTH^RFO^^0;2^K:$L(X)>6!($L(X)<6)!'(X?6N) X
"^DD",727.827,727.827,1,2)
S Y(0)=Y S Y=$$ECXYMX^ECXUTL(Y)
"^DD",727.827,727.827,1,2.1)
S Y=$$ECXYMX^ECXUTL(Y)
"^DD",727.827,727.827,1,3)
Answer must be 6 characters in length
"^DD",727.827,727.827,1,"DT")
3040211
**END**
**END**
