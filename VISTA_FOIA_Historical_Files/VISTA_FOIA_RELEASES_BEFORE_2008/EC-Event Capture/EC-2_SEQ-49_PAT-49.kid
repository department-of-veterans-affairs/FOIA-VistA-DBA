Released EC*2*49 SEQ #49
Extracted from mail message
**KIDS**:EC*2.0*49^

**INSTALL NAME**
EC*2.0*49
"BLD",4772,0)
EC*2.0*49^EVENT CAPTURE^0^3031017^y
"BLD",4772,1,0)
^^1^1^3030522^^^^
"BLD",4772,1,1,0)

"BLD",4772,4,0)
^9.64PA^^
"BLD",4772,"ABPKG")
n
"BLD",4772,"INID")
^
"BLD",4772,"INIT")

"BLD",4772,"KRN",0)
^9.67PA^8989.52^20
"BLD",4772,"KRN",.4,0)
.4
"BLD",4772,"KRN",.401,0)
.401
"BLD",4772,"KRN",.402,0)
.402
"BLD",4772,"KRN",.403,0)
.403
"BLD",4772,"KRN",.5,0)
.5
"BLD",4772,"KRN",.84,0)
.84
"BLD",4772,"KRN",3.6,0)
3.6
"BLD",4772,"KRN",3.8,0)
3.8
"BLD",4772,"KRN",9.2,0)
9.2
"BLD",4772,"KRN",9.8,0)
9.8
"BLD",4772,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",4772,"KRN",9.8,"NM",1,0)
ECV1RPC^^0^B7867612
"BLD",4772,"KRN",9.8,"NM",2,0)
ECV2RPC^^0^B31124227
"BLD",4772,"KRN",9.8,"NM",3,0)
ECV4RPC^^0^B61727818
"BLD",4772,"KRN",9.8,"NM",4,0)
ECU1RPC^^0^B18109250
"BLD",4772,"KRN",9.8,"NM",5,0)
ECUURPC^^0^B5408975
"BLD",4772,"KRN",9.8,"NM",6,0)
ECEFPAT^^0^B54347386
"BLD",4772,"KRN",9.8,"NM",7,0)
ECV3RPC^^0^B32146887
"BLD",4772,"KRN",9.8,"NM",8,0)
ECUMRPC2^^0^B18378419
"BLD",4772,"KRN",9.8,"NM","B","ECEFPAT",6)

"BLD",4772,"KRN",9.8,"NM","B","ECU1RPC",4)

"BLD",4772,"KRN",9.8,"NM","B","ECUMRPC2",8)

"BLD",4772,"KRN",9.8,"NM","B","ECUURPC",5)

"BLD",4772,"KRN",9.8,"NM","B","ECV1RPC",1)

"BLD",4772,"KRN",9.8,"NM","B","ECV2RPC",2)

"BLD",4772,"KRN",9.8,"NM","B","ECV3RPC",7)

"BLD",4772,"KRN",9.8,"NM","B","ECV4RPC",3)

"BLD",4772,"KRN",19,0)
19
"BLD",4772,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",4772,"KRN",19,"NM",1,0)
EC GUI CONTEXT^^0
"BLD",4772,"KRN",19,"NM","B","EC GUI CONTEXT",1)

"BLD",4772,"KRN",19.1,0)
19.1
"BLD",4772,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",4772,"KRN",101,0)
101
"BLD",4772,"KRN",101,"NM",0)
^9.68A^^
"BLD",4772,"KRN",409.61,0)
409.61
"BLD",4772,"KRN",771,0)
771
"BLD",4772,"KRN",869.2,0)
869.2
"BLD",4772,"KRN",870,0)
870
"BLD",4772,"KRN",8989.51,0)
8989.51
"BLD",4772,"KRN",8989.52,0)
8989.52
"BLD",4772,"KRN",8994,0)
8994
"BLD",4772,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",4772,"KRN",8994,"NM",1,0)
EC GETVERSION^^0
"BLD",4772,"KRN",8994,"NM","B","EC GETVERSION",1)

"BLD",4772,"KRN","B",.4,.4)

"BLD",4772,"KRN","B",.401,.401)

"BLD",4772,"KRN","B",.402,.402)

"BLD",4772,"KRN","B",.403,.403)

"BLD",4772,"KRN","B",.5,.5)

"BLD",4772,"KRN","B",.84,.84)

"BLD",4772,"KRN","B",3.6,3.6)

"BLD",4772,"KRN","B",3.8,3.8)

"BLD",4772,"KRN","B",9.2,9.2)

"BLD",4772,"KRN","B",9.8,9.8)

"BLD",4772,"KRN","B",19,19)

"BLD",4772,"KRN","B",19.1,19.1)

"BLD",4772,"KRN","B",101,101)

"BLD",4772,"KRN","B",409.61,409.61)

"BLD",4772,"KRN","B",771,771)

"BLD",4772,"KRN","B",869.2,869.2)

"BLD",4772,"KRN","B",870,870)

"BLD",4772,"KRN","B",8989.51,8989.51)

"BLD",4772,"KRN","B",8989.52,8989.52)

"BLD",4772,"KRN","B",8994,8994)

"BLD",4772,"QUES",0)
^9.62^^
"BLD",4772,"REQB",0)
^9.611^3^1
"BLD",4772,"REQB",3,0)
EC*2.0*47^2
"BLD",4772,"REQB","B","EC*2.0*47",3)

"KRN",19,11187,-1)
0^1
"KRN",19,11187,0)
EC GUI CONTEXT^EC GUI Context version 2.0.10.1^^B^^^^^^^^EVENT CAPTURE
"KRN",19,11187,1,0)
^19.06^1^1^3030529^^^^
"KRN",19,11187,1,1,0)
This is the Broker Client/Server type option for the Event Capture GUI option
"KRN",19,11187,99)
58583,58456
"KRN",19,11187,99.1)
58981,55862
"KRN",19,11187,"RPC",0)
^19.05P^52^52
"KRN",19,11187,"RPC",1,0)
EC DSSCATCHECK
"KRN",19,11187,"RPC",2,0)
EC FILER
"KRN",19,11187,"RPC",3,0)
EC GETBATPROCS
"KRN",19,11187,"RPC",4,0)
EC GETCAT
"KRN",19,11187,"RPC",5,0)
EC GETCPTLST
"KRN",19,11187,"RPC",6,0)
EC GETDSSECS
"KRN",19,11187,"RPC",7,0)
EC GETDSSUNIT
"KRN",19,11187,"RPC",8,0)
EC GETDSSUNITUSRS
"KRN",19,11187,"RPC",9,0)
EC GETECLOC
"KRN",19,11187,"RPC",10,0)
EC GETECSCATS
"KRN",19,11187,"RPC",11,0)
EC GETECSCREEN
"KRN",19,11187,"RPC",12,0)
EC GETECSDETAIL
"KRN",19,11187,"RPC",13,0)
EC GETECSPROCS
"KRN",19,11187,"RPC",14,0)
EC GETENCDXS
"KRN",19,11187,"RPC",15,0)
EC GETIEN
"KRN",19,11187,"RPC",16,0)
EC GETLIST
"KRN",19,11187,"RPC",17,0)
EC GETLOC
"KRN",19,11187,"RPC",18,0)
EC GETNATPX
"KRN",19,11187,"RPC",19,0)
EC GETPATCLASTAT
"KRN",19,11187,"RPC",20,0)
EC GETPATELIG
"KRN",19,11187,"RPC",21,0)
EC GETPATINFO
"KRN",19,11187,"RPC",22,0)
EC GETPATPROCS
"KRN",19,11187,"RPC",23,0)
EC GETPRODEFS
"KRN",19,11187,"RPC",24,0)
EC GETPROVIDER
"KRN",19,11187,"RPC",25,0)
EC GETPXLST
"KRN",19,11187,"RPC",26,0)
EC GETPXMODIFIER
"KRN",19,11187,"RPC",27,0)
EC GETPXREASON
"KRN",19,11187,"RPC",28,0)
EC GETSCNHELP
"KRN",19,11187,"RPC",29,0)
EC GETUSRDSSUNIT
"KRN",19,11187,"RPC",30,0)
EC REPORTS
"KRN",19,11187,"RPC",31,0)
EC VALIDATE SPREADSHEET DATA
"KRN",19,11187,"RPC",32,0)
ORWU USERINFO
"KRN",19,11187,"RPC",33,0)
ORWU HASKEY
"KRN",19,11187,"RPC",34,0)
ORWU DEVICE
"KRN",19,11187,"RPC",35,0)
SC PATIENT LOOKUP
"KRN",19,11187,"RPC",36,0)
ORWU NEWPERS
"KRN",19,11187,"RPC",37,0)
DDR GET DD HELP
"KRN",19,11187,"RPC",38,0)
DDR FINDER
"KRN",19,11187,"RPC",39,0)
DDR FIND1
"KRN",19,11187,"RPC",40,0)
DDR LISTER
"KRN",19,11187,"RPC",41,0)
EC GETDATE
"KRN",19,11187,"RPC",42,0)
EC CLASHELP
"KRN",19,11187,"RPC",43,0)
DDR GETS ENTRY DATA
"KRN",19,11187,"RPC",44,0)
DG CHK BS5 XREF Y/N
"KRN",19,11187,"RPC",45,0)
DG SENSITIVE RECORD ACCESS
"KRN",19,11187,"RPC",46,0)
DG SENSITIVE RECORD BULLETIN
"KRN",19,11187,"RPC",47,0)
DG CHK PAT/DIV MEANS TEST
"KRN",19,11187,"RPC",48,0)
EC SPACEBAR
"KRN",19,11187,"RPC",49,0)
EC DIEDON
"KRN",19,11187,"RPC",50,0)
EC GETPATCH
"KRN",19,11187,"RPC",51,0)
EC GETVISITINFO
"KRN",19,11187,"RPC",52,0)
EC GETVERSION
"KRN",19,11187,"U")
EC GUI CONTEXT VERSION 2.0.10.
"KRN",8994,1445,-1)
0^1
"KRN",8994,1445,0)
EC GETVERSION^VERSRV^ECUURPC^1^R^^^1
"KRN",8994,1445,1,0)
^8994.01^2^2^3030529^^^^
"KRN",8994,1445,1,1,0)
Returns the server version of a particular option.  This is used by ECS GUI 
"KRN",8994,1445,1,2,0)
to determine the current server version of the software.
"KRN",8994,1445,2,0)
^8994.02A^1^1
"KRN",8994,1445,2,1,0)
ECARY^1^^1
"KRN",8994,1445,2,1,1,0)
^8994.021^1^1^3030529^^
"KRN",8994,1445,2,1,1,1,0)
ECARY contains the option name and client version of the software.
"KRN",8994,1445,2,"B","ECARY",1)

"KRN",8994,1445,3,0)
^8994.03^1^1^3030529^^^^
"KRN",8994,1445,3,1,0)
Returns the server version of the software.
"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",486,-1)
1^1
"PKG",486,0)
EVENT CAPTURE^EC^Event Capture Workload Capture System^
"PKG",486,20,0)
^9.402P^^
"PKG",486,22,0)
^9.49I^1^1
"PKG",486,22,1,0)
2.0^2960508^2981027^66481
"PKG",486,22,1,"PAH",1,0)
49^3031017
"PKG",486,22,1,"PAH",1,1,0)
^^1^1^3031017
"PKG",486,22,1,"PAH",1,1,1,0)

"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","ECEFPAT")
0^6^B54347386
"RTN","ECEFPAT",1,0)
ECEFPAT ;ALB/JAM-Enter Event Capture Data Patient Filer ;12 Oct 00
"RTN","ECEFPAT",2,0)
 ;;2.0; EVENT CAPTURE ;**25,32,39,42,47,49**;8 May 96
"RTN","ECEFPAT",3,0)
 ;
"RTN","ECEFPAT",4,0)
FILE ;Used by the RPC broker to file patient encounter in file #721
"RTN","ECEFPAT",5,0)
 ;     Variables passed in
"RTN","ECEFPAT",6,0)
 ;       ECIEN   - IEN of #721, if editing
"RTN","ECEFPAT",7,0)
 ;       ECDEL   - Delete record. 1- YES; 0- 0, null or undefine for NO.
"RTN","ECEFPAT",8,0)
 ;       ECDFN   - Patient IEN for file #2
"RTN","ECEFPAT",9,0)
 ;       ECDT    - Date and time of procedure
"RTN","ECEFPAT",10,0)
 ;       ECL     - Location
"RTN","ECEFPAT",11,0)
 ;       ECD     - DSS Unit
"RTN","ECEFPAT",12,0)
 ;       ECC     - Category
"RTN","ECEFPAT",13,0)
 ;       ECP     - Procedure
"RTN","ECEFPAT",14,0)
 ;       ECVOL   - Volume
"RTN","ECEFPAT",15,0)
 ;       ECU     - Provider
"RTN","ECEFPAT",16,0)
 ;       ECMN    - Ordering Section
"RTN","ECEFPAT",17,0)
 ;       ECDUZ   - Entered/Edited by, pointer to #200
"RTN","ECEFPAT",18,0)
 ;       ECU2    - Provider 2, optional
"RTN","ECEFPAT",19,0)
 ;       ECU3    - Provider 3, optional
"RTN","ECEFPAT",20,0)
 ;       ECDX    - Primary Diagnosis
"RTN","ECEFPAT",21,0)
 ;       ECDXS   - Seconday Diagnosis; multiple, optional
"RTN","ECEFPAT",22,0)
 ;       EC4     - Asssociated Clinic, required if sending data to PCE
"RTN","ECEFPAT",23,0)
 ;       ECPTSTAT- Patient Status
"RTN","ECEFPAT",24,0)
 ;       ECPXREAS- Procedure reason, optional
"RTN","ECEFPAT",25,0)
 ;       ECMOD   - CPT modifiers, optional
"RTN","ECEFPAT",26,0)
 ;       ECLASS  - Classification, optional
"RTN","ECEFPAT",27,0)
 ;       ECELIG  - Eligibility, optional
"RTN","ECEFPAT",28,0)
 ;
"RTN","ECEFPAT",29,0)
 ;     Variable return
"RTN","ECEFPAT",30,0)
 ;       ^TMP($J,"ECMSG",n)=Success or failure to file in #721^Message
"RTN","ECEFPAT",31,0)
 ;
"RTN","ECEFPAT",32,0)
 N NODE,ECS,ECM,ECID,ECCPT,ECINT,ECPCE,ECX,ECERR,ECOUT,ECFLG
"RTN","ECEFPAT",33,0)
 S ECFLG=1,ECERR=0 D CHKDT(1) I ECERR Q
"RTN","ECEFPAT",34,0)
 F ECX="ECU","ECU2","ECU3" D  I ECERR Q
"RTN","ECEFPAT",35,0)
 .I $G(@ECX)="" Q
"RTN","ECEFPAT",36,0)
 .S NODE=$$GET^XUA4A72(@ECX,ECDT) I +NODE'>0 S ECERR=1 D  Q
"RTN","ECEFPAT",37,0)
 ..S ^TMP($J,"ECMSG",1)="0^Provider doesn't have an active Person class"
"RTN","ECEFPAT",38,0)
 I $G(ECIEN)'="" S ECFLG=0 D  I ECERR Q
"RTN","ECEFPAT",39,0)
 . I '$D(^ECH(ECIEN)) S ECERR=1,^TMP($J,"ECMSG",1)="0^Pat IEN Not Found"
"RTN","ECEFPAT",40,0)
 I $G(ECDEL) K ^TMP($J,"ECMSG") D  Q
"RTN","ECEFPAT",41,0)
 .S ECVST=$P($G(^ECH(ECIEN,0)),"^",21) I ECVST D
"RTN","ECEFPAT",42,0)
 ..;* Resend all EC records with same Visit file entry to PCE
"RTN","ECEFPAT",43,0)
 ..;* Remove Visit entry from ^ECH( so DELVFILE will complete cleanup
"RTN","ECEFPAT",44,0)
 ..S ECVAR1=$$FNDVST^ECUTL(ECVST) K ECVAR1
"RTN","ECEFPAT",45,0)
 ..;Set VALQUIET to stop Amb Care validator from broadcasting to screen
"RTN","ECEFPAT",46,0)
 ..S VALQUIET=1,ECVV=$$DELVFILE^PXAPI("ALL",ECVST) K ECVST,VALQUIET
"RTN","ECEFPAT",47,0)
 .S DA=ECIEN,DIK="^ECH(" D ^DIK K DA,DIK,ECVV
"RTN","ECEFPAT",48,0)
 .S ^TMP($J,"ECMSG",1)="1^Procedure Deleted"
"RTN","ECEFPAT",49,0)
 S ECDT=+ECDT,NODE=$G(^ECD(ECD,0)) I NODE="" D MSG Q
"RTN","ECEFPAT",50,0)
 S ECFN=$G(ECIEN),ECVOL=$G(ECVOL,1),ECS=$P(NODE,U,2),ECM=$P(NODE,U,3)
"RTN","ECEFPAT",51,0)
 S ECPCE="U~"_$S($P(NODE,"^",14)]"":$P(NODE,"^",14),1:"N")
"RTN","ECEFPAT",52,0)
 ;S ECPTSTAT=$$INOUTPT^ECUTL0(ECDFN,+ECDT) ;pat stat may not need
"RTN","ECEFPAT",53,0)
 I $G(EC4)="" D GETCLN^ECEDF
"RTN","ECEFPAT",54,0)
 S ECID=$S(+EC4:$P($G(^SC(+EC4,0)),"^",7),1:""),ECINP=ECPTSTAT
"RTN","ECEFPAT",55,0)
 I $S($P(ECPCE,"~",2)="N":0,$P(ECPCE,"~",2)="O"&(ECINP'="O"):0,1:1) D
"RTN","ECEFPAT",56,0)
 .D CHKDT(2)
"RTN","ECEFPAT",57,0)
 Q:ECERR  I ECFLG D NEWIEN
"RTN","ECEFPAT",58,0)
 S ECCPT=$S(ECP["ICPT":+ECP,1:$P($G(^EC(725,+ECP,0)),U,5))
"RTN","ECEFPAT",59,0)
 K DA,DR,DIE S DIE="^ECH(",(DA,ECFN)=ECIEN K ECIEN
"RTN","ECEFPAT",60,0)
 S DR=".01////"_ECFN_";1////"_ECDFN_";3////"_ECL_";4////"_ECS
"RTN","ECEFPAT",61,0)
 S DR=DR_";5////"_ECM_";6////"_ECD_";7////"_+ECC_";9////"_ECVOL
"RTN","ECEFPAT",62,0)
 S $P(^ECH(ECFN,0),"^",9)=ECP
"RTN","ECEFPAT",63,0)
 D ^DIE I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",64,0)
 S DA=ECFN,DR="10////"_ECU_";11////"_ECMN_";13////"_ECDUZ_";2////"_ECDT
"RTN","ECEFPAT",65,0)
 S ECU2=$G(ECU2),ECU3=$G(ECU3),ECPXREAS=$G(ECPXREAS)
"RTN","ECEFPAT",66,0)
 S DR=DR_";15////"_$S(+ECU2:+ECU2,1:"@")_";17////"_$S(+ECU3:+ECU3,1:"@")
"RTN","ECEFPAT",67,0)
 S DR=DR_";19////"_$S(+ECCPT:ECCPT,1:"@")_";20////"_ECDX
"RTN","ECEFPAT",68,0)
 S DR=DR_";26////"_$G(EC4)_";27////"_$G(ECID)_";29////"_ECPTSTAT
"RTN","ECEFPAT",69,0)
 S DR=DR_";34////"_$S(ECPXREAS="":"@",1:ECPXREAS)
"RTN","ECEFPAT",70,0)
 D ^DIE I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",71,0)
 S ^DISV(DUZ,"^VA(200,")=$S(+ECU3>0:ECU3,+ECU2>0:ECU2,1:ECU) ;5/30/03
"RTN","ECEFPAT",72,0)
 ;Remove Old CPT modifiers
"RTN","ECEFPAT",73,0)
 I 'ECFLG D
"RTN","ECEFPAT",74,0)
 . K OLDMOD S (ECDA,DA(1))=ECFN,DIK="^ECH("_DA(1)_",""MOD"",",DA=0
"RTN","ECEFPAT",75,0)
 . F  S DA=$O(^ECH(ECDA,"MOD",DA)) Q:'DA  S OLDMOD(DA)="" D ^DIK
"RTN","ECEFPAT",76,0)
 . K DA,ECDA,DIK,^ECH(ECFN,"MOD")
"RTN","ECEFPAT",77,0)
 .;Remove old secondary diagnosis codes
"RTN","ECEFPAT",78,0)
 . K OLDDXS S (ECDA,DA(1))=ECFN,DIK="^ECH("_DA(1)_",""DX"",",DA=0
"RTN","ECEFPAT",79,0)
 . F  S DA=$O(^ECH(ECDA,"DX",DA)) Q:'DA  S OLDDXS(DA)="" D ^DIK
"RTN","ECEFPAT",80,0)
 . K DA,ECDA,DIK,^ECH(ECFN,"DX")
"RTN","ECEFPAT",81,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",82,0)
 ;File CPT modifiers
"RTN","ECEFPAT",83,0)
 I $G(ECMOD)'="" D
"RTN","ECEFPAT",84,0)
 . S DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,36,0),U,2)
"RTN","ECEFPAT",85,0)
 . S DIC="^ECH("_DA(1)_","_"""MOD"""_","
"RTN","ECEFPAT",86,0)
 . F ECX=1:1:$L(ECMOD,"^") S MODIEN=$P(ECMOD,U,ECX) I +MODIEN>0 D
"RTN","ECEFPAT",87,0)
 . . K DD,DO S X=MODIEN D FILE^DICN
"RTN","ECEFPAT",88,0)
 . K MODIEN,DIC
"RTN","ECEFPAT",89,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",90,0)
 ; File multiple secondary diagnosis codes
"RTN","ECEFPAT",91,0)
 I $G(ECDXS)'="" D
"RTN","ECEFPAT",92,0)
 . S DXS="",DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,38,0),U,2)
"RTN","ECEFPAT",93,0)
 . S DIC="^ECH("_DA(1)_","_"""DX"""_",",ECDXY=ECDX K ECDXX
"RTN","ECEFPAT",94,0)
 . F ECX=1:1:$L(ECDXS,"^") S DXSIEN=$P(ECDXS,U,ECX) I +DXSIEN>0 D
"RTN","ECEFPAT",95,0)
 . . S DXCDE=$$ICDDX^ICDCODE(DXSIEN,ECDT) Q:+DXCDE<0  I '$P(DXCDE,U,10) Q
"RTN","ECEFPAT",96,0)
 . . K DD,DO S X=DXSIEN D FILE^DICN
"RTN","ECEFPAT",97,0)
 . . S DXCDE=$P(DXCDE,U,2),ECDXX(DXCDE)=DXSIEN
"RTN","ECEFPAT",98,0)
 . ; Update all procedures for an encounter with same primary & second dx
"RTN","ECEFPAT",99,0)
 . S PXUPD=$$PXUPD^ECUTL2(ECDFN,ECDT,ECL,EC4,ECDXY,.ECDXX,ECFN)
"RTN","ECEFPAT",100,0)
 . K PXUPD,ECDXY,ECDXX,DXS,DXSIEN,DIC,DXCDE,DA,DD,DO
"RTN","ECEFPAT",101,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",102,0)
 S DA=ECFN
"RTN","ECEFPAT",103,0)
 ;File classification AO^IR^SC^EC^MST^HNC
"RTN","ECEFPAT",104,0)
 I $G(ECLASS)'="" D
"RTN","ECEFPAT",105,0)
 . S CLSTR="21^22^24^23^35^39",DR=""
"RTN","ECEFPAT",106,0)
 . F ECX=1:1:$L(CLSTR,"^") D
"RTN","ECEFPAT",107,0)
 . . S DR=DR_$P(CLSTR,U,ECX)_"////"_$P(ECLASS,U,ECX)_";"
"RTN","ECEFPAT",108,0)
 . S DR=$E(DR,1,($L(DR)-1)) D ^DIE
"RTN","ECEFPAT",109,0)
 . K CLSTR,DR,DIE
"RTN","ECEFPAT",110,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",111,0)
 ;
"RTN","ECEFPAT",112,0)
PCE ; format PCE data to send
"RTN","ECEFPAT",113,0)
 I ($P(ECPCE,"~",2)="N")!($P(ECPCE,"~",2)="O"&(ECINP'="O")) D  Q
"RTN","ECEFPAT",114,0)
 .S ^TMP($J,"ECMSG",1)="1^Record Filed"
"RTN","ECEFPAT",115,0)
 D:ECFLG PCE^ECBEN2U I 'ECFLG S EC(0)=^ECH(ECFN,0) D PCEE^ECBEN2U K EC
"RTN","ECEFPAT",116,0)
 I $G(ECOUT)!(ECERR) D  Q
"RTN","ECEFPAT",117,0)
 . D RECDEL S STR=$S($G(^ECH(ECFN,"R")):^("R"),1:" PCE Data Missing")
"RTN","ECEFPAT",118,0)
 . S ^TMP($J,"ECMSG",1)="0^Record Not Filed, "_STR K STR
"RTN","ECEFPAT",119,0)
 S ^TMP($J,"ECMSG",1)="1^Record Filed"_U_$G(ECIEN)
"RTN","ECEFPAT",120,0)
 Q
"RTN","ECEFPAT",121,0)
 ;
"RTN","ECEFPAT",122,0)
NEWIEN ;Create new IEN in file #721
"RTN","ECEFPAT",123,0)
 N DIC,DA,DD,DO,ECRN
"RTN","ECEFPAT",124,0)
RLCK L +^ECH(0) S ECRN=$P(^ECH(0),"^",3)+1
"RTN","ECEFPAT",125,0)
 I $D(^ECH(ECRN)) S $P(^ECH(0),"^",3)=$P(^(0),"^",3)+1 L -^ECH(0) G RLCK
"RTN","ECEFPAT",126,0)
 L -^ECH(0) S DIC(0)="L",DIC="^ECH(",X=ECRN
"RTN","ECEFPAT",127,0)
 D FILE^DICN S ECIEN=+Y
"RTN","ECEFPAT",128,0)
 Q
"RTN","ECEFPAT",129,0)
RECDEL ; Delete record
"RTN","ECEFPAT",130,0)
 ;restore old data
"RTN","ECEFPAT",131,0)
 I 'ECFLG D  Q
"RTN","ECEFPAT",132,0)
 . I $O(OLDMOD("")) D
"RTN","ECEFPAT",133,0)
 . . S DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,36,0),U,2)
"RTN","ECEFPAT",134,0)
 . . S DIC="^ECH("_DA(1)_","_"""MOD"""_",",ECX=0
"RTN","ECEFPAT",135,0)
 . . F  S ECX=$O(OLDMOD(ECX)) Q:'ECX  I ECX>0 K DD,DO S X=ECX D FILE^DICN
"RTN","ECEFPAT",136,0)
 . I $O(OLDDXS("")) D
"RTN","ECEFPAT",137,0)
 . . S DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,38,0),U,2)
"RTN","ECEFPAT",138,0)
 . . S DIC="^ECH("_DA(1)_","_"""DX"""_",",ECX=0
"RTN","ECEFPAT",139,0)
 . . F  S ECX=$O(OLDDXS(ECX)) Q:'ECX  I ECX>0 K DD,DO S X=ECX D FILE^DICN
"RTN","ECEFPAT",140,0)
 . K DIC,DA,DD,DO,OLDMOD,OLDDXS,ECX
"RTN","ECEFPAT",141,0)
 S DA=ECFN,DIK="^ECH(" D ^DIK K DA,DIK
"RTN","ECEFPAT",142,0)
 Q
"RTN","ECEFPAT",143,0)
MSG ;Record not filed
"RTN","ECEFPAT",144,0)
 S ^TMP($J,"ECMSG",1)="0^Record not Filed"
"RTN","ECEFPAT",145,0)
 Q
"RTN","ECEFPAT",146,0)
CHKDT(FLG) ;Required Data Check
"RTN","ECEFPAT",147,0)
 N I,C
"RTN","ECEFPAT",148,0)
 S C=1
"RTN","ECEFPAT",149,0)
 I FLG=1 D  Q
"RTN","ECEFPAT",150,0)
 .F I="ECD","ECC","ECL","ECDT","ECP","ECDFN","ECU","ECMN","ECDUZ","ECPTSTAT" D
"RTN","ECEFPAT",151,0)
 ..I $G(@I)="" S ^TMP($J,"ECMSG",C)="0^Key data missing "_I,C=C+1,ECERR=1
"RTN","ECEFPAT",152,0)
 .I $G(ECDEL),$D(ECIEN) K ^TMP($J,"ECMSG") S ECERR=0
"RTN","ECEFPAT",153,0)
 ;check PCE data
"RTN","ECEFPAT",154,0)
 I FLG=2 D  Q
"RTN","ECEFPAT",155,0)
 .F I="EC4","ECDX" D  Q
"RTN","ECEFPAT",156,0)
 ..I $G(@I)="" S ^TMP($J,"ECMSG",C)="0^Key PCE data missing "_I,C=C+1,ECERR=1
"RTN","ECEFPAT",157,0)
 Q
"RTN","ECEFPAT",158,0)
VALDATA ;validate data
"RTN","ECEFPAT",159,0)
 N ECRRX
"RTN","ECEFPAT",160,0)
 D CHK^DIE(721,1,,"`"_ECDFN,.ECRRX) I ECRRX'=ECDFN D  Q
"RTN","ECEFPAT",161,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Patient"
"RTN","ECEFPAT",162,0)
 D CHK^DIE(721,2,,ECDT,.ECRRX) I ECRRX'=ECDT D  Q
"RTN","ECEFPAT",163,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Procedure Date"
"RTN","ECEFPAT",164,0)
 D CHK^DIE(721,3,,"`"_ECL,.ECRRX) I ECRRX'=ECL D  Q
"RTN","ECEFPAT",165,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Location"
"RTN","ECEFPAT",166,0)
 D CHK^DIE(721,6,,"`"_ECD,.ECRRX) I ECRRX'=ECD D  Q
"RTN","ECEFPAT",167,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid DSS Unit"
"RTN","ECEFPAT",168,0)
 D CHK^DIE(721,7,,"`"_ECC,.ECRRX) I ECRRX'=ECC D  Q
"RTN","ECEFPAT",169,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Category"
"RTN","ECEFPAT",170,0)
 D  I ECERR Q
"RTN","ECEFPAT",171,0)
 .I ECP["ICPT" S ECRRX=$$CPT^ICPTCOD(+ECP,ECDT) I +ECRRX>0,$P(ECRRX,U,7) Q
"RTN","ECEFPAT",172,0)
 .I ECP["EC",$D(^EC(725,+ECP,0)) Q
"RTN","ECEFPAT",173,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Procedure"
"RTN","ECEFPAT",174,0)
 D CHK^DIE(721,10,,"`"_ECU,.ECRRX) I ECRRX'=ECU D  Q
"RTN","ECEFPAT",175,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Provider"
"RTN","ECEFPAT",176,0)
 I $G(ECU2)'="" D CHK^DIE(721,15,,"`"_ECU2,.ECRRX) I ECRRX'=ECU2 D  Q
"RTN","ECEFPAT",177,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Provider #2"
"RTN","ECEFPAT",178,0)
 I $G(ECU3)'="" D CHK^DIE(721,10,,"`"_ECU3,.ECRRX) I ECRRX'=ECU3 D  Q
"RTN","ECEFPAT",179,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Provider #3"
"RTN","ECEFPAT",180,0)
 D CHK^DIE(721,11,,"`"_ECMN,.ECRRX) I ECRRX'=ECMN D  Q
"RTN","ECEFPAT",181,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Orddering Section"
"RTN","ECEFPAT",182,0)
 D CHK^DIE(721,20,,"`"_ECDX,.ECRRX) I ECRRX'=ECDX D  Q
"RTN","ECEFPAT",183,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Primary Diagnosis"
"RTN","ECEFPAT",184,0)
 I $G(EC4)'="" D CHK^DIE(721,26,,"`"_EC4,.ECRRX) I ECRRX'=EC4 D  Q
"RTN","ECEFPAT",185,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Associated Clinic"
"RTN","ECEFPAT",186,0)
 Q
"RTN","ECU1RPC")
0^4^B18109250
"RTN","ECU1RPC",1,0)
ECU1RPC ;ALB/ACS;Event Capture Spreadsheet Utilities ;07 Aug 01
"RTN","ECU1RPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,30,49**;8 May 96
"RTN","ECU1RPC",3,0)
 ;
"RTN","ECU1RPC",4,0)
 ;-----------------------------------------------------------------------
"RTN","ECU1RPC",5,0)
 ;
"RTN","ECU1RPC",6,0)
 ;INPUT     ECDATA  - Contains column headers or a row of Event Capture
"RTN","ECU1RPC",7,0)
 ;                    spreadshet data
"RTN","ECU1RPC",8,0)
 ;
"RTN","ECU1RPC",9,0)
 ;
"RTN","ECU1RPC",10,0)
 ;OTHER     ^TMP($J,"COLS" array will store the column header order
"RTN","ECU1RPC",11,0)
 ;
"RTN","ECU1RPC",12,0)
 ;-----------------------------------------------------------------------
"RTN","ECU1RPC",13,0)
 ;=======================================================================
"RTN","ECU1RPC",14,0)
 ;MODIFICATIONS:
"RTN","ECU1RPC",15,0)
 ;
"RTN","ECU1RPC",16,0)
 ;08/2001    EC*2.0*30   Changed column header from 'Station' to
"RTN","ECU1RPC",17,0)
 ;                       'Location'.
"RTN","ECU1RPC",18,0)
 ;=======================================================================
"RTN","ECU1RPC",19,0)
 ;
"RTN","ECU1RPC",20,0)
ECHDRS(ECDATA) ;
"RTN","ECU1RPC",21,0)
 ;
"RTN","ECU1RPC",22,0)
 ;--kill temporary file
"RTN","ECU1RPC",23,0)
 K ^TMP($J,"COLS")
"RTN","ECU1RPC",24,0)
 N PIECENUM,NUMCOLS
"RTN","ECU1RPC",25,0)
 ;
"RTN","ECU1RPC",26,0)
 ; --Set up column header order
"RTN","ECU1RPC",27,0)
 S NUMCOLS=$L(ECDATA,U)
"RTN","ECU1RPC",28,0)
 ;
"RTN","ECU1RPC",29,0)
 ; --Remove first piece "COLHEADERS" from colum header string--
"RTN","ECU1RPC",30,0)
 S ECDATA=$P(ECDATA,U,2,NUMCOLS)
"RTN","ECU1RPC",31,0)
 S NUMCOLS=$L(ECDATA,U)
"RTN","ECU1RPC",32,0)
 ;
"RTN","ECU1RPC",33,0)
 ; --Spin through each piece in string and assign 'piece' value 
"RTN","ECU1RPC",34,0)
 F PIECENUM=1:1 Q:PIECENUM>NUMCOLS  D
"RTN","ECU1RPC",35,0)
 . S DATA=$P(ECDATA,U,PIECENUM)
"RTN","ECU1RPC",36,0)
 . I DATA["Record Num" S ECRECPC=PIECENUM Q
"RTN","ECU1RPC",37,0)
 . I DATA["Location" S ECSTAPC=PIECENUM Q
"RTN","ECU1RPC",38,0)
 . I DATA["SSN" S ECSSNPC=PIECENUM Q
"RTN","ECU1RPC",39,0)
 . I DATA["Pat LName" S ECPATLPC=PIECENUM Q
"RTN","ECU1RPC",40,0)
 . I DATA["Pat FName" S ECPATFPC=PIECENUM Q
"RTN","ECU1RPC",41,0)
 . I DATA["Unit Name" S ECDSSPC=PIECENUM Q
"RTN","ECU1RPC",42,0)
 . I DATA["Unit Num" S ECDCMPC=PIECENUM Q
"RTN","ECU1RPC",43,0)
 . I DATA["Unit IEN" S ECUNITPC=PIECENUM Q
"RTN","ECU1RPC",44,0)
 . I DATA["Proc" S ECPROCPC=PIECENUM Q
"RTN","ECU1RPC",45,0)
 . I DATA["Volume" S ECVOLPC=PIECENUM Q
"RTN","ECU1RPC",46,0)
 . I DATA["Ordering Sect" S ECOSPC=PIECENUM Q
"RTN","ECU1RPC",47,0)
 . I DATA["Prov" S ECPRVLPC=PIECENUM Q
"RTN","ECU1RPC",48,0)
 . I DATA["Date/Time" S ECENCPC=PIECENUM Q
"RTN","ECU1RPC",49,0)
 . I DATA["Category" S ECCATPC=PIECENUM Q
"RTN","ECU1RPC",50,0)
 . I DATA["Diag" S ECDXPC=PIECENUM Q
"RTN","ECU1RPC",51,0)
 . I DATA["Assoc Clin" S ECCLNPC=PIECENUM Q
"RTN","ECU1RPC",52,0)
 . ;
"RTN","ECU1RPC",53,0)
 . I DATA["Pat Stat" S ECPSTATV=+DATA Q
"RTN","ECU1RPC",54,0)
 . I DATA["Override Deceased" S ECDECPAT=+DATA
"RTN","ECU1RPC",55,0)
 ; 
"RTN","ECU1RPC",56,0)
 ;--Move column header piece numbers into Temp file ^TMP($J,"COLS")
"RTN","ECU1RPC",57,0)
 ;   for future reference
"RTN","ECU1RPC",58,0)
 ;
"RTN","ECU1RPC",59,0)
 K ^TMP($J,"COLS")
"RTN","ECU1RPC",60,0)
 S ^TMP($J,"COLS","ECRECPC")=ECRECPC
"RTN","ECU1RPC",61,0)
 S ^TMP($J,"COLS","ECSTAPC")=ECSTAPC
"RTN","ECU1RPC",62,0)
 S ^TMP($J,"COLS","ECSSNPC")=ECSSNPC
"RTN","ECU1RPC",63,0)
 S ^TMP($J,"COLS","ECPATLPC")=ECPATLPC
"RTN","ECU1RPC",64,0)
 S ^TMP($J,"COLS","ECPATFPC")=ECPATFPC
"RTN","ECU1RPC",65,0)
 S ^TMP($J,"COLS","ECDSSPC")=ECDSSPC
"RTN","ECU1RPC",66,0)
 S ^TMP($J,"COLS","ECDCMPC")=ECDCMPC
"RTN","ECU1RPC",67,0)
 S ^TMP($J,"COLS","ECUNITPC")=ECUNITPC
"RTN","ECU1RPC",68,0)
 S ^TMP($J,"COLS","ECPROCPC")=ECPROCPC
"RTN","ECU1RPC",69,0)
 S ^TMP($J,"COLS","ECVOLPC")=ECVOLPC
"RTN","ECU1RPC",70,0)
 S ^TMP($J,"COLS","ECOSPC")=ECOSPC
"RTN","ECU1RPC",71,0)
 S ^TMP($J,"COLS","ECPRVLPC")=ECPRVLPC
"RTN","ECU1RPC",72,0)
 S ^TMP($J,"COLS","ECENCPC")=ECENCPC
"RTN","ECU1RPC",73,0)
 S ^TMP($J,"COLS","ECCATPC")=ECCATPC
"RTN","ECU1RPC",74,0)
 S ^TMP($J,"COLS","ECDXPC")=ECDXPC
"RTN","ECU1RPC",75,0)
 S ^TMP($J,"COLS","ECCLNPC")=ECCLNPC
"RTN","ECU1RPC",76,0)
 S ^TMP($J,"COLS","ECPSTATV")=ECPSTATV
"RTN","ECU1RPC",77,0)
 S ^TMP($J,"COLS","ECDECPAT")=ECDECPAT
"RTN","ECU1RPC",78,0)
 ;
"RTN","ECU1RPC",79,0)
 Q
"RTN","ECU1RPC",80,0)
 ;
"RTN","ECU1RPC",81,0)
GETDATA(ECDATA) ;
"RTN","ECU1RPC",82,0)
 ;
"RTN","ECU1RPC",83,0)
 ;--Get data piece numbers and uploaded data values
"RTN","ECU1RPC",84,0)
 S ECRECPC=$G(^TMP($J,"COLS","ECRECPC"))
"RTN","ECU1RPC",85,0)
 S ECRECV=$P(ECDATA,U,ECRECPC)
"RTN","ECU1RPC",86,0)
 ;
"RTN","ECU1RPC",87,0)
 S ECSTAPC=$G(^TMP($J,"COLS","ECSTAPC"))
"RTN","ECU1RPC",88,0)
 S ECSTAV=$P(ECDATA,U,ECSTAPC)
"RTN","ECU1RPC",89,0)
 ;
"RTN","ECU1RPC",90,0)
 S ECSSNPC=$G(^TMP($J,"COLS","ECSSNPC"))
"RTN","ECU1RPC",91,0)
 I ECSSNPC S ECSSNV=$P(ECDATA,U,ECSSNPC)
"RTN","ECU1RPC",92,0)
 ;
"RTN","ECU1RPC",93,0)
 S ECPATLPC=$G(^TMP($J,"COLS","ECPATLPC"))
"RTN","ECU1RPC",94,0)
 S ECPATLV=$P(ECDATA,U,ECPATLPC)
"RTN","ECU1RPC",95,0)
 ;
"RTN","ECU1RPC",96,0)
 S ECPATFPC=$G(^TMP($J,"COLS","ECPATFPC"))
"RTN","ECU1RPC",97,0)
 S ECPATFV=$P(ECDATA,U,ECPATFPC)
"RTN","ECU1RPC",98,0)
 ; --concatenate patient name into one string, comma separated
"RTN","ECU1RPC",99,0)
 S ECPATV=ECPATLV_","_ECPATFV
"RTN","ECU1RPC",100,0)
 ;
"RTN","ECU1RPC",101,0)
 S ECDSSPC=$G(^TMP($J,"COLS","ECDSSPC"))
"RTN","ECU1RPC",102,0)
 S ECDSSV=$P(ECDATA,U,ECDSSPC)
"RTN","ECU1RPC",103,0)
 ;
"RTN","ECU1RPC",104,0)
 S ECDCMPC=$G(^TMP($J,"COLS","ECDCMPC"))
"RTN","ECU1RPC",105,0)
 S ECDCMV=$P(ECDATA,U,ECDCMPC)
"RTN","ECU1RPC",106,0)
 ;
"RTN","ECU1RPC",107,0)
 S ECUNITPC=$G(^TMP($J,"COLS","ECUNITPC"))
"RTN","ECU1RPC",108,0)
 S ECUNITV=$P(ECDATA,U,ECUNITPC)
"RTN","ECU1RPC",109,0)
 ;
"RTN","ECU1RPC",110,0)
 S ECPROCPC=$G(^TMP($J,"COLS","ECPROCPC"))
"RTN","ECU1RPC",111,0)
 S ECPROCV=$P(ECDATA,U,ECPROCPC)
"RTN","ECU1RPC",112,0)
 ;
"RTN","ECU1RPC",113,0)
 S ECVOLPC=$G(^TMP($J,"COLS","ECVOLPC"))
"RTN","ECU1RPC",114,0)
 S ECVOLV=$P(ECDATA,U,ECVOLPC)
"RTN","ECU1RPC",115,0)
 ;
"RTN","ECU1RPC",116,0)
 S ECOSPC=$G(^TMP($J,"COLS","ECOSPC"))
"RTN","ECU1RPC",117,0)
 S ECOSV=$P(ECDATA,U,ECOSPC)
"RTN","ECU1RPC",118,0)
 ;
"RTN","ECU1RPC",119,0)
 S ECPRVLPC=$G(^TMP($J,"COLS","ECPRVLPC"))
"RTN","ECU1RPC",120,0)
 S ECPROVV=$P(ECDATA,U,ECPRVLPC)
"RTN","ECU1RPC",121,0)
 ;
"RTN","ECU1RPC",122,0)
 S ECENCPC=$G(^TMP($J,"COLS","ECENCPC"))
"RTN","ECU1RPC",123,0)
 S ECENCV=$P(ECDATA,U,ECENCPC)
"RTN","ECU1RPC",124,0)
 ;
"RTN","ECU1RPC",125,0)
 S ECCATPC=$G(^TMP($J,"COLS","ECCATPC"))
"RTN","ECU1RPC",126,0)
 S ECCATV=$P(ECDATA,U,ECCATPC)
"RTN","ECU1RPC",127,0)
 ;
"RTN","ECU1RPC",128,0)
 S ECDXPC=$G(^TMP($J,"COLS","ECDXPC"))
"RTN","ECU1RPC",129,0)
 S ECDXV=$P(ECDATA,U,ECDXPC)
"RTN","ECU1RPC",130,0)
 ;
"RTN","ECU1RPC",131,0)
 S ECCLNPC=$G(^TMP($J,"COLS","ECCLNPC"))
"RTN","ECU1RPC",132,0)
 S ECCLNV=$P(ECDATA,U,ECCLNPC)
"RTN","ECU1RPC",133,0)
 ;
"RTN","ECU1RPC",134,0)
 S ECPSTATV=$G(^TMP($J,"COLS","ECPSTATV"))
"RTN","ECU1RPC",135,0)
 ;
"RTN","ECU1RPC",136,0)
 S ECDECPAT=$G(^TMP($J,"COLS","ECDECPAT"))
"RTN","ECU1RPC",137,0)
 ;
"RTN","ECU1RPC",138,0)
END Q
"RTN","ECUMRPC2")
0^8^B18378419
"RTN","ECUMRPC2",1,0)
ECUMRPC2 ;ALB/JAM;Event Capture Management Broker Utils ; 10/4/00 4:58pm
"RTN","ECUMRPC2",2,0)
 ;;2.0; EVENT CAPTURE ;**25,30,42,46,47,49**;8 May 96
"RTN","ECUMRPC2",3,0)
GLOC(RESULTS,ECARY) ;
"RTN","ECUMRPC2",4,0)
 ;
"RTN","ECUMRPC2",5,0)
 ;This broker entry point returns all active Event Capture locations
"RTN","ECUMRPC2",6,0)
 ;        RPC: EC GETLOC
"RTN","ECUMRPC2",7,0)
 ;INPUTS         ECARY - Contains the following subscripted elements
"RTN","ECUMRPC2",8,0)
 ;               STAT   - Active or inactive locations (optional)
"RTN","ECUMRPC2",9,0)
 ;               A-ctive (default), I-nactive, B-oth
"RTN","ECUMRPC2",10,0)
 ;
"RTN","ECUMRPC2",11,0)
 ;OUTPUTS        RESULTS - The array of active Event Capture locations.
"RTN","ECUMRPC2",12,0)
 ;               PIECE - Description
"RTN","ECUMRPC2",13,0)
 ;                 1     Location IEN
"RTN","ECUMRPC2",14,0)
 ;                 2     LOC description
"RTN","ECUMRPC2",15,0)
 ;                 3     State Abbreviation
"RTN","ECUMRPC2",16,0)
 ;                 4     Current Location Flag
"RTN","ECUMRPC2",17,0)
 ;                 5     Facility Type
"RTN","ECUMRPC2",18,0)
 ;                 6     Station Number
"RTN","ECUMRPC2",19,0)
 N LOC,STAT,CNT,CLOC,ST,NODE,ACT,ECLOC,ELOC,ECFT,ECSN
"RTN","ECUMRPC2",20,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC2",21,0)
 K ^TMP($J,"ECLOCATION")
"RTN","ECUMRPC2",22,0)
 S STAT=$P($G(ECARY),U),(CNT,LOC)=0,ACT=0 S:STAT="" STAT="A"
"RTN","ECUMRPC2",23,0)
 D GETLOC^ECL(.ECLOC)
"RTN","ECUMRPC2",24,0)
 F  S LOC=$O(ECLOC(LOC)) Q:'LOC  S ELOC($P(ECLOC(LOC),U,2))=""
"RTN","ECUMRPC2",25,0)
 S LOC=0
"RTN","ECUMRPC2",26,0)
 F  S LOC=$O(^DIC(4,LOC)) Q:'LOC  S NODE=$G(^DIC(4,LOC,0)) I NODE'="" D
"RTN","ECUMRPC2",27,0)
 . I $P(NODE,U)="" Q
"RTN","ECUMRPC2",28,0)
 . I ($P(NODE,U,11)="I")!($P($G(^DIC(4,LOC,99)),U,4)) S ACT=1
"RTN","ECUMRPC2",29,0)
 . I $S(STAT="A"&(ACT):1,STAT="I"&('ACT):1,1:0) Q
"RTN","ECUMRPC2",30,0)
 . S CLOC=$D(ELOC(LOC)),CLOC=$S(CLOC:"YES",1:"")
"RTN","ECUMRPC2",31,0)
 . S CNT=CNT+1,ST=$P(NODE,U,2) S:ST'="" ST=$$GET1^DIQ(5,ST,1,"I")
"RTN","ECUMRPC2",32,0)
 . S ECFT=$P($G(^DIC(4.1,+$G(^DIC(4,LOC,3)),0)),U)
"RTN","ECUMRPC2",33,0)
 . S ECSN=$P($G(^DIC(4,LOC,99)),U)
"RTN","ECUMRPC2",34,0)
 . S ^TMP($J,"ECLOCATION",CNT)=LOC_U_$P(NODE,U)_U_ST_U_CLOC_U_ECFT_U_ECSN
"RTN","ECUMRPC2",35,0)
 S RESULTS=$NA(^TMP($J,"ECLOCATION"))
"RTN","ECUMRPC2",36,0)
 Q
"RTN","ECUMRPC2",37,0)
CPTFND(RESULTS,ECARY) ;
"RTN","ECUMRPC2",38,0)
 ;
"RTN","ECUMRPC2",39,0)
 ;This broker entry point does a search on a CPT string and returns
"RTN","ECUMRPC2",40,0)
 ;a list of matches from file #81
"RTN","ECUMRPC2",41,0)
 ;        RPC: EC GETCPTLST
"RTN","ECUMRPC2",42,0)
 ;INPUTS      ECARY   - Contains the following subscripted elements
"RTN","ECUMRPC2",43,0)
 ;             CPTSTR - CPT search string
"RTN","ECUMRPC2",44,0)
 ;
"RTN","ECUMRPC2",45,0)
 ;OUTPUTS     RESULTS - The array of cpt codes. Data pieces as follows:-
"RTN","ECUMRPC2",46,0)
 ;             CPT ien^CPT code^Name
"RTN","ECUMRPC2",47,0)
 ;
"RTN","ECUMRPC2",48,0)
 N CPTSTR,ECNT,DIC,ECTG,ECER
"RTN","ECUMRPC2",49,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC2",50,0)
 S CPTSTR=$P(ECARY,U),ECNT=0 I CPTSTR="" Q
"RTN","ECUMRPC2",51,0)
 K ^TMP($J,"ECPTSRCH"),^TMP("ECCPT",$J)
"RTN","ECUMRPC2",52,0)
 D CPTSRH(81,CPTSTR)
"RTN","ECUMRPC2",53,0)
 F  S ECNT=$O(^TMP("ECCPT",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC2",54,0)
 .S ^TMP($J,"ECPTSRCH",ECNT)=$G(^TMP("ECCPT",$J,"DILIST",2,ECNT))_U_^TMP("ECCPT",$J,"DILIST","ID",ECNT,.01)_U_^TMP("ECCPT",$J,"DILIST","ID",ECNT,2)
"RTN","ECUMRPC2",55,0)
 K ^TMP("ECCPT",$J)
"RTN","ECUMRPC2",56,0)
 S RESULTS=$NA(^TMP($J,"ECPTSRCH"))
"RTN","ECUMRPC2",57,0)
 Q
"RTN","ECUMRPC2",58,0)
 ;
"RTN","ECUMRPC2",59,0)
PXFND(RESULTS,ECARY) ;
"RTN","ECUMRPC2",60,0)
 ;
"RTN","ECUMRPC2",61,0)
 ;This broker entry point does a search on a procedure string and returns
"RTN","ECUMRPC2",62,0)
 ;a list of matches from file #81 and/or #725
"RTN","ECUMRPC2",63,0)
 ;        RPC: EC GETPXLST
"RTN","ECUMRPC2",64,0)
 ;INPUTS      ECARY   - Contains the following subscripted elements
"RTN","ECUMRPC2",65,0)
 ;             PXSTR -  Procedure search string
"RTN","ECUMRPC2",66,0)
 ;
"RTN","ECUMRPC2",67,0)
 ;OUTPUTS     RESULTS - The array of procedures. Data pieces as follows:-
"RTN","ECUMRPC2",68,0)
 ;             Procedure ien^Procedure code  Procedure Name
"RTN","ECUMRPC2",69,0)
 ;
"RTN","ECUMRPC2",70,0)
 N CPTSTR,ECNT,DIC,ECX,CNT,ECTG,ECER,PXSTR,ECSTR
"RTN","ECUMRPC2",71,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC2",72,0)
 S PXSTR=$P(ECARY,U),ECNT=0 I PXSTR="" Q
"RTN","ECUMRPC2",73,0)
 K ^TMP($J,"ECPXSRCH"),^TMP("ECCPT",$J),^TMP("ECCPT1",$J)
"RTN","ECUMRPC2",74,0)
 D 
"RTN","ECUMRPC2",75,0)
 . I $P(PXSTR,".")="A" D CPTSRH(81,$P(PXSTR,".",2)) Q
"RTN","ECUMRPC2",76,0)
 . I $P(PXSTR,".")="B" D CPTSRH(725,$P(PXSTR,".",2)) Q
"RTN","ECUMRPC2",77,0)
 . F ECX=81,725 D CPTSRH(ECX,PXSTR)
"RTN","ECUMRPC2",78,0)
 F  S ECNT=$O(^TMP("ECCPT",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC2",79,0)
 .S ECID=$G(^TMP("ECCPT",$J,"DILIST",2,ECNT))_";ICPT("
"RTN","ECUMRPC2",80,0)
 .S ECSTR=^TMP("ECCPT",$J,"DILIST","ID",ECNT,.01)_"  "_^(2)
"RTN","ECUMRPC2",81,0)
 .S ^TMP($J,"ECPXSRCH",ECNT)=ECID_U_ECSTR
"RTN","ECUMRPC2",82,0)
 S ECNT=0,CNT=+$O(^TMP($J,"ECPXSRCH","A"),-1)
"RTN","ECUMRPC2",83,0)
 F  S ECNT=$O(^TMP("ECCPT1",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC2",84,0)
 .S CNT=CNT+1,ECID=$G(^TMP("ECCPT1",$J,"DILIST",2,ECNT))_";EC(725,"
"RTN","ECUMRPC2",85,0)
 .S ECSTR=^TMP("ECCPT1",$J,"DILIST","ID",ECNT,1)_"  "_^(.01)
"RTN","ECUMRPC2",86,0)
 .S ^TMP($J,"ECPXSRCH",CNT)=ECID_U_ECSTR
"RTN","ECUMRPC2",87,0)
 K ^TMP("ECCPT",$J),^TMP("ECCPT1",$J)
"RTN","ECUMRPC2",88,0)
 S RESULTS=$NA(^TMP($J,"ECPXSRCH"))
"RTN","ECUMRPC2",89,0)
 Q
"RTN","ECUMRPC2",90,0)
CPTSRH(FILE,CPTSTR) ;Searches either file 81 or 725 for a CPT string
"RTN","ECUMRPC2",91,0)
 I FILE=81 D
"RTN","ECUMRPC2",92,0)
 .D FINDIC(81,"",".01;2","M",CPTSTR,100,"","I $P($$CPT^ICPTCOD(+Y),""^"",7)","","^TMP(""ECCPT"",$J)")
"RTN","ECUMRPC2",93,0)
 I FILE=725 D
"RTN","ECUMRPC2",94,0)
 .D FINDIC(725,"",".01;1","M",CPTSTR,100,"","I '$P(^(0),""^"",3)","","^TMP(""ECCPT1"",$J)")
"RTN","ECUMRPC2",95,0)
 Q
"RTN","ECUMRPC2",96,0)
FINDIC(ECFL,ECIEN,ECFLD,ECFLG,ECVAL,ECN,ECINDX,ECSCN,ECID,ECTG,ECER) ;
"RTN","ECUMRPC2",97,0)
 ;Find records in a file base on search string
"RTN","ECUMRPC2",98,0)
 S ECER=$G(ECER)
"RTN","ECUMRPC2",99,0)
 D FIND^DIC(ECFL,ECIEN,ECFLD,ECFLG,ECVAL,ECN,ECINDX,ECSCN,ECID,ECTG,ECER)
"RTN","ECUMRPC2",100,0)
 K ECFL,ECIEN,ECFLD,ECFLG,ECVAL,ECN,ECINDX,ECSCN,ECID
"RTN","ECUMRPC2",101,0)
 Q
"RTN","ECUMRPC2",102,0)
PROV ;Return a set of providers from the NEW PERSON file
"RTN","ECUMRPC2",103,0)
 ;Input Variables:-
"RTN","ECUMRPC2",104,0)
 ;  FROM   - text to $O from
"RTN","ECUMRPC2",105,0)
 ;  DATE   - checks for an active person class on this date (optional)
"RTN","ECUMRPC2",106,0)
 ;  ECDIR  - $O direction
"RTN","ECUMRPC2",107,0)
 ;  KEY    - screen users by security key (optional)
"RTN","ECUMRPC2",108,0)
 ;
"RTN","ECUMRPC2",109,0)
 ;Output Variables:-
"RTN","ECUMRPC2",110,0)
 ;  ^TMP($J,"ECFIND",1..n - returned array
"RTN","ECUMRPC2",111,0)
 ;     IEN of file 200^Provider Name^occupation^speciality^subspeciality
"RTN","ECUMRPC2",112,0)
 ;
"RTN","ECUMRPC2",113,0)
 N I,IEN,CNT,FROM,DATE,ECUTN S I=0,CNT=44  ;KEY="PROVIDER"
"RTN","ECUMRPC2",114,0)
 S FROM=$P(ECSTR,"|"),DATE=$P(ECSTR,"|",2)
"RTN","ECUMRPC2",115,0)
 F  Q:I'<CNT  S FROM=$O(^VA(200,"B",FROM),ECDIR) Q:FROM=""  D
"RTN","ECUMRPC2",116,0)
 . S IEN="" F  S IEN=$O(^VA(200,"B",FROM,IEN),ECDIR) Q:'IEN  D 
"RTN","ECUMRPC2",117,0)
 . . ;I $L(KEY),'$D(^XUSEC(KEY,+IEN)) Q
"RTN","ECUMRPC2",118,0)
 . . ;I +$G(ALLUSERS)=0,'$$ACTIVE^XUSER(IEN) Q  ; terminated user
"RTN","ECUMRPC2",119,0)
 . . S ECUTN=$$GET^XUA4A72(IEN,DATE)
"RTN","ECUMRPC2",120,0)
 . . I DATE>0,ECUTN<1 Q
"RTN","ECUMRPC2",121,0)
 . . S I=I+1,^TMP($J,"ECFIND",I)=IEN_"^"_FROM_"^"_$P(ECUTN,"^",2,4)
"RTN","ECUMRPC2",122,0)
 Q
"RTN","ECUURPC")
0^5^B5408975
"RTN","ECUURPC",1,0)
ECUURPC ;ALB/JAM;Event Capture Data Entry Broker Utilities ;Aug 28, 2000
"RTN","ECUURPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,42,49**;8 May 96
"RTN","ECUURPC",3,0)
 ;
"RTN","ECUURPC",4,0)
ECHELP(RESULTS,ECARY) ;
"RTN","ECUURPC",5,0)
 ;
"RTN","ECUURPC",6,0)
 ;Broker call returns the entries from HELP FILE #9.2
"RTN","ECUURPC",7,0)
 ;        RPC: EC GETSCNHELP
"RTN","ECUURPC",8,0)
 ;INPUTS   ECARY - Contains the following elements
"RTN","ECUURPC",9,0)
 ;          HLPDA  - Help Frame Name
"RTN","ECUURPC",10,0)
 ;
"RTN","ECUURPC",11,0)
 ;OUTPUTS  RESULTS - Array of help text in the HELP FRAM File (#9.2)
"RTN","ECUURPC",12,0)
 ;
"RTN","ECUURPC",13,0)
 N HLPDA,DIC,X,Y
"RTN","ECUURPC",14,0)
 S HLPDA=$G(ECARY) I HLPDA="" Q
"RTN","ECUURPC",15,0)
 D SETENV^ECUMRPC K ^TMP($J,"ECHELP")
"RTN","ECUURPC",16,0)
 S DIC="^DIC(9.2,",DIC(0)="MN",X=HLPDA
"RTN","ECUURPC",17,0)
 D ^DIC M ^TMP($J,"ECHELP")=^DIC(9.2,+Y,1)
"RTN","ECUURPC",18,0)
 I $D(^TMP($J,"ECHELP")) D
"RTN","ECUURPC",19,0)
 . S $P(^TMP($J,"ECHELP",0),U)=$P(^DIC(9.2,+Y,0),U,2)
"RTN","ECUURPC",20,0)
 S RESULTS=$NA(^TMP($J,"ECHELP"))
"RTN","ECUURPC",21,0)
 Q
"RTN","ECUURPC",22,0)
FNDIEN(RESULTS,ECARY) ;find IEN
"RTN","ECUURPC",23,0)
 ;Broker call returns the IEN from a file
"RTN","ECUURPC",24,0)
 ;        RPC: EC GETIEN
"RTN","ECUURPC",25,0)
 ;INPUTS   ECARY - Contains the following data elements
"RTN","ECUURPC",26,0)
 ;          FIL  - File number
"RTN","ECUURPC",27,0)
 ;          TXT  - .01 description
"RTN","ECUURPC",28,0)
 ;
"RTN","ECUURPC",29,0)
 ;OUTPUTS  RESULTS - File IEN
"RTN","ECUURPC",30,0)
 ;
"RTN","ECUURPC",31,0)
 N TXT,FIL,DIC,X,Y
"RTN","ECUURPC",32,0)
 D SETENV^ECUMRPC
"RTN","ECUURPC",33,0)
 S FIL=$P(ECARY,U),TXT=$P(ECARY,U,2) I TXT=""!(FIL="") Q
"RTN","ECUURPC",34,0)
 S DIC=FIL,DIC(0)="MN",X=TXT
"RTN","ECUURPC",35,0)
 D ^DIC I Y=-1 Q
"RTN","ECUURPC",36,0)
 S RESULTS=+Y
"RTN","ECUURPC",37,0)
 Q
"RTN","ECUURPC",38,0)
ECDATE(RESULTS,ECARY) ;
"RTN","ECUURPC",39,0)
 ;
"RTN","ECUURPC",40,0)
 ;Broker call returns an Fileman internal date
"RTN","ECUURPC",41,0)
 ;        RPC: EC GETDATE
"RTN","ECUURPC",42,0)
 ;INPUTS   ECARY - Contains the following elements
"RTN","ECUURPC",43,0)
 ;          DTSTR  - Date String
"RTN","ECUURPC",44,0)
 ;          FLG    - Date Flag (optional)
"RTN","ECUURPC",45,0)
 ;
"RTN","ECUURPC",46,0)
 ;OUTPUTS  RESULTS - A valid Fileman date format^External format
"RTN","ECUURPC",47,0)
 ;
"RTN","ECUURPC",48,0)
 N ECDTSTR,DIC,X,Y,DTSTR,FLG
"RTN","ECUURPC",49,0)
 D SETENV^ECUMRPC
"RTN","ECUURPC",50,0)
 S DTSTR=$P(ECARY,U),FLG=$P(ECARY,U,2) I DTSTR="" Q
"RTN","ECUURPC",51,0)
 S X=DTSTR,%DT="XT"_$S(FLG="R":"R",1:""),%DT(0)="-NOW" D ^%DT
"RTN","ECUURPC",52,0)
 I +Y<1 S RESULTS="0^Invalid Date/Time" Q
"RTN","ECUURPC",53,0)
 S RESULTS=Y D D^DIQ
"RTN","ECUURPC",54,0)
 S RESULTS=RESULTS_U_Y
"RTN","ECUURPC",55,0)
 Q
"RTN","ECUURPC",56,0)
PATCH(RESULTS,ECARY)    ;
"RTN","ECUURPC",57,0)
 ;
"RTN","ECUURPC",58,0)
 ;Broker call returns 1 if patch X is installed
"RTN","ECUURPC",59,0)
 ;        RPC: EC GETPATCH
"RTN","ECUURPC",60,0)
 ;INPUTS   ECARY - contains the patch number
"RTN","ECUURPC",61,0)
 ;
"RTN","ECUURPC",62,0)
 ;OUTPUTS  RESULTS 1 OR 0
"RTN","ECUURPC",63,0)
 ;
"RTN","ECUURPC",64,0)
 I ECARY="" Q
"RTN","ECUURPC",65,0)
 D SETENV^ECUMRPC
"RTN","ECUURPC",66,0)
 S RESULTS=$$PATCH^XPDUTL(ECARY)
"RTN","ECUURPC",67,0)
 Q
"RTN","ECUURPC",68,0)
VERSRV(RESULTS,ECARY,VERSION)   ; Return server version of option name and 
"RTN","ECUURPC",69,0)
 ; minimum GUI client version.
"RTN","ECUURPC",70,0)
 ;
"RTN","ECUURPC",71,0)
 ;Server/client version consist of 4 pieces, namely
"RTN","ECUURPC",72,0)
 ;    major version.minor version.release.build  (ex. 2.0.10.1)
"RTN","ECUURPC",73,0)
 ;
"RTN","ECUURPC",74,0)
 ;Broker call returns server version of option name
"RTN","ECUURPC",75,0)
 ;        RPC: EC GETVERSION
"RTN","ECUURPC",76,0)
 ;INPUTS   ECARY - contains the option name
"RTN","ECUURPC",77,0)
 ;         VERSION - EC GUI client version ;stay in partition for session
"RTN","ECUURPC",78,0)
 ;
"RTN","ECUURPC",79,0)
 ;OUTPUTS  RESULTS version number OR null ("")
"RTN","ECUURPC",80,0)
 ;           current server version^minimum client version
"RTN","ECUURPC",81,0)
 ;
"RTN","ECUURPC",82,0)
 S ECCLVER=$G(VERSION)
"RTN","ECUURPC",83,0)
 I $G(ECARY)="" Q
"RTN","ECUURPC",84,0)
 N ECLST,ECMINV
"RTN","ECUURPC",85,0)
 S ECMINV="2.0.10.1"    ; Minimum version of EC GUI client
"RTN","ECUURPC",86,0)
 D FIND^DIC(19,"",1,"X",ECARY,1,,,,"ECLST")
"RTN","ECUURPC",87,0)
 I 'ECLST("DILIST",0) S RESULTS="" Q
"RTN","ECUURPC",88,0)
 S RESULTS=ECLST("DILIST","ID",1,1)
"RTN","ECUURPC",89,0)
 S RESULTS=$P(RESULTS,"version ",2)_U_ECMINV
"RTN","ECUURPC",90,0)
 Q
"RTN","ECV1RPC")
0^1^B7867612
"RTN","ECV1RPC",1,0)
ECV1RPC ;ALB/ACS;Event Capture Spreadsheet Upload Broker Utilities ;13 Oct 00
"RTN","ECV1RPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,33,49**;8 May 96
"RTN","ECV1RPC",3,0)
 ;
"RTN","ECV1RPC",4,0)
IN(RESULTS,ECDATA) ;
"RTN","ECV1RPC",5,0)
 ;-----------------------------------------------------------------------
"RTN","ECV1RPC",6,0)
 ;This broker entry point receives a row of data from the Event
"RTN","ECV1RPC",7,0)
 ;Capture GUI Spreadsheet (a module of the Event Capture GUI app).
"RTN","ECV1RPC",8,0)
 ;The data is validated and an array is returned to the spreadsheet
"RTN","ECV1RPC",9,0)
 ;module.
"RTN","ECV1RPC",10,0)
 ;
"RTN","ECV1RPC",11,0)
 ;          RPC: EC VALIDATE SPREADSHEET DATA
"RTN","ECV1RPC",12,0)
 ;
"RTN","ECV1RPC",13,0)
 ;INPUT     ECDATA  - Contains either the column headers or a row of
"RTN","ECV1RPC",14,0)
 ;                    spreadshet data.  Fields included are:
"RTN","ECV1RPC",15,0)
 ;                    Record number, station, SSN, patient last
"RTN","ECV1RPC",16,0)
 ;                    name, patient first name, DSS unit IEN, DSS
"RTN","ECV1RPC",17,0)
 ;                    unit number, DSS unit name, procedure code,
"RTN","ECV1RPC",18,0)
 ;                    volume, ordering section, provider last name,
"RTN","ECV1RPC",19,0)
 ;                    provider first name, encounter date/time,
"RTN","ECV1RPC",20,0)
 ;                    event code category, diag code, associated clinic,
"RTN","ECV1RPC",21,0)
 ;                    and patient status override flag
"RTN","ECV1RPC",22,0)
 ;
"RTN","ECV1RPC",23,0)
 ;OUTPUT    RESULTS - If an error is found during data validation,
"RTN","ECV1RPC",24,0)
 ;                    then the output contains an array of error
"RTN","ECV1RPC",25,0)
 ;                    messages:
"RTN","ECV1RPC",26,0)
 ;
"RTN","ECV1RPC",27,0)
 ;                    PIECE     Description
"RTN","ECV1RPC",28,0)
 ;                    -----     ------------------------
"RTN","ECV1RPC",29,0)
 ;                      1       Record number
"RTN","ECV1RPC",30,0)
 ;                      2       Column number (on spreadsheet)
"RTN","ECV1RPC",31,0)
 ;                              containing the record number
"RTN","ECV1RPC",32,0)
 ;                      3       Column number (on spreadsheet)
"RTN","ECV1RPC",33,0)
 ;                              containing the data in error
"RTN","ECV1RPC",34,0)
 ;                      4       Error message
"RTN","ECV1RPC",35,0)
 ;
"RTN","ECV1RPC",36,0)
 ;                  - If no errors are found during data validation,
"RTN","ECV1RPC",37,0)
 ;                    then the output contains a string of Event
"RTN","ECV1RPC",38,0)
 ;                    Capture data for that patient, beginning with
"RTN","ECV1RPC",39,0)
 ;                    the string "NO ERRORS":
"RTN","ECV1RPC",40,0)
 ;
"RTN","ECV1RPC",41,0)
 ;                    "NO ERRORS"^Patient SSN IEN^Encounter Date/Time^
"RTN","ECV1RPC",42,0)
 ;                    Station IEN^DSS Unit IEN^0^Procedure^Volume^
"RTN","ECV1RPC",43,0)
 ;                    Provider IEN^Ordering Section IEN^Provider IEN^
"RTN","ECV1RPC",44,0)
 ;                    Patient Status^
"RTN","ECV1RPC",45,0)
 ;                 
"RTN","ECV1RPC",46,0)
 ;OTHER     ^TMP($J,"COLS") will store the column/data order
"RTN","ECV1RPC",47,0)
 ;          (used as data 'piece') of the input data string.
"RTN","ECV1RPC",48,0)
 ;          For example:
"RTN","ECV1RPC",49,0)
 ;
"RTN","ECV1RPC",50,0)
 ;          ^TMP($J,"COLS","ECRECPC")=1   => Record number is 1st piece
"RTN","ECV1RPC",51,0)
 ;          ^TMP($J,"COLS","ECSTAPC")=2   => Station is 2nd piece
"RTN","ECV1RPC",52,0)
 ;
"RTN","ECV1RPC",53,0)
 ;SPECIAL PROCESSING
"RTN","ECV1RPC",54,0)
 ;          An exception to the above described output exists when no
"RTN","ECV1RPC",55,0)
 ;          exact match is found on the provider.  In this case, some
"RTN","ECV1RPC",56,0)
 ;          provider info will be sent back with the error message
"RTN","ECV1RPC",57,0)
 ;          so the user can determine which provider they want.  For
"RTN","ECV1RPC",58,0)
 ;          example, provider JONES,WILLIAM is entered by the user, but
"RTN","ECV1RPC",59,0)
 ;          the file contains JONES,WILLIAM H and JONES,WILLIAM J.
"RTN","ECV1RPC",60,0)
 ;          Both of those providers and their associated information 
"RTN","ECV1RPC",61,0)
 ;          will be sent with the error message.
"RTN","ECV1RPC",62,0)
 ;       
"RTN","ECV1RPC",63,0)
 ;
"RTN","ECV1RPC",64,0)
 ;-----------------------------------------------------------------------
"RTN","ECV1RPC",65,0)
 ;
"RTN","ECV1RPC",66,0)
INIT ;-- piece numbers (associated with column numbers in the spreadsheet)
"RTN","ECV1RPC",67,0)
 N ECRECPC,ECSTAPC,ECSSNPC,ECPATLPC,ECPATFPC,ECDSSPC,ECDCMPC,ECUNITPC
"RTN","ECV1RPC",68,0)
 N ECPROCPC,ECVOLPC,ECOSPC,ECPRVLPC,ECPRVFPC,ECENCPC,ECCATPC,ECDXPC
"RTN","ECV1RPC",69,0)
 N ECCLNPC
"RTN","ECV1RPC",70,0)
 ;-- spreadsheet values entered by user
"RTN","ECV1RPC",71,0)
 N ECRECV,ECSTAV,ECSSNV,ECPATLV,ECPATFV,ECPATV,ECDSSV,ECDCMV,ECUNITV
"RTN","ECV1RPC",72,0)
 N ECPROCV,ECVOLV,ECOSV,ECPROVLV,ECPROVFV,ECPROVV,ECENCV,ECCATV,ECDXV
"RTN","ECV1RPC",73,0)
 N ECCLNV
"RTN","ECV1RPC",74,0)
 N ECPSTATV,ECDECPAT
"RTN","ECV1RPC",75,0)
 ;-- error flags and derived data
"RTN","ECV1RPC",76,0)
 N ECERR,ECERRFLG,ECERRMSG,ECCOLERR,ECPRVIEN,ECOSIEN,ECVSSN,ECDSSIEN
"RTN","ECV1RPC",77,0)
 N ECINDEX,ECSSNIEN,ECPCLASS,ECPRVTYP,ECCATIEN,ECDXIEN,ECCLNIEN
"RTN","ECV1RPC",78,0)
 N ECPSTAT
"RTN","ECV1RPC",79,0)
 ;
"RTN","ECV1RPC",80,0)
 S U="^"
"RTN","ECV1RPC",81,0)
 S (ECINDEX,ECERR)=0
"RTN","ECV1RPC",82,0)
 K RESULTS
"RTN","ECV1RPC",83,0)
 ;
"RTN","ECV1RPC",84,0)
 ;--Call utility program to set up piece numbers and column header info
"RTN","ECV1RPC",85,0)
 I ECDATA["COLHEADERS" D ECHDRS^ECU1RPC(ECDATA) Q
"RTN","ECV1RPC",86,0)
 ;
"RTN","ECV1RPC",87,0)
 I ECDATA["END OF PROCESSING" D CLEANUP Q
"RTN","ECV1RPC",88,0)
 ;
"RTN","ECV1RPC",89,0)
MAIN ;--Call utility program to get piece numbers and set up data values
"RTN","ECV1RPC",90,0)
 D GETDATA^ECU1RPC(ECDATA)
"RTN","ECV1RPC",91,0)
 ;
"RTN","ECV1RPC",92,0)
 ;--Call validation routines to validate the data
"RTN","ECV1RPC",93,0)
 D ^ECV2RPC
"RTN","ECV1RPC",94,0)
 D ^ECV3RPC
"RTN","ECV1RPC",95,0)
 D ^ECV4RPC
"RTN","ECV1RPC",96,0)
 ;
"RTN","ECV1RPC",97,0)
FINAL ;If no errors, send data back to spreadsheet module
"RTN","ECV1RPC",98,0)
 ;note: ECDXIEN and ECCLNIEN will not be sent back if the record is 
"RTN","ECV1RPC",99,0)
 ;not being sent to PCE.
"RTN","ECV1RPC",100,0)
 ;
"RTN","ECV1RPC",101,0)
 I '($D(RESULTS(1))) D
"RTN","ECV1RPC",102,0)
 . N RESDATA
"RTN","ECV1RPC",103,0)
 . S RESDATA="NO ERRORS"_"^"_ECSSNIEN_"^"_ECENCV_"^"_ECSTAV_"^"_ECDSSIEN
"RTN","ECV1RPC",104,0)
 . S RESDATA=RESDATA_"^"_ECCATIEN_"^"_ECPROCV_"^"_ECVOLV_"^"_ECPRVIEN
"RTN","ECV1RPC",105,0)
 . S RESDATA=RESDATA_"^"_ECOSIEN_"^"_ECDUZ_"^"_$G(ECDXIEN)
"RTN","ECV1RPC",106,0)
 . S RESDATA=RESDATA_"^"_$G(ECCLNIEN)_"^"_ECPSTAT_"^"
"RTN","ECV1RPC",107,0)
 . S RESULTS(1)=RESDATA
"RTN","ECV1RPC",108,0)
 . Q
"RTN","ECV1RPC",109,0)
 Q
"RTN","ECV1RPC",110,0)
 ;
"RTN","ECV1RPC",111,0)
CLEANUP ;Delete temporary files
"RTN","ECV1RPC",112,0)
 I $D(^TMP($J,"COLS")) K ^TMP($J,"COLS")
"RTN","ECV1RPC",113,0)
 Q
"RTN","ECV2RPC")
0^2^B31124227
"RTN","ECV2RPC",1,0)
ECV2RPC ;ALB/ACS;Event Capture Spreadsheet Validation;07 Aug 01
"RTN","ECV2RPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,30,49**;8 May 96
"RTN","ECV2RPC",3,0)
 ;
"RTN","ECV2RPC",4,0)
 ;-----------------------------------------------------------------------
"RTN","ECV2RPC",5,0)
 ;       Validates the following Event Capture spreadsheet fields:
"RTN","ECV2RPC",6,0)
 ;       1. Location
"RTN","ECV2RPC",7,0)
 ;       2. Patient SSN
"RTN","ECV2RPC",8,0)
 ;       3. Patient Name
"RTN","ECV2RPC",9,0)
 ;-----------------------------------------------------------------------
"RTN","ECV2RPC",10,0)
 ;=======================================================================
"RTN","ECV2RPC",11,0)
 ;MODIFICATIONS
"RTN","ECV2RPC",12,0)
 ;08/2001    EC*2.0*30  Updated the error message for Location
"RTN","ECV2RPC",13,0)
 ;=======================================================================
"RTN","ECV2RPC",14,0)
 ;
"RTN","ECV2RPC",15,0)
 ;--Set up error flag
"RTN","ECV2RPC",16,0)
 S ECERRFLG=0
"RTN","ECV2RPC",17,0)
 ;
"RTN","ECV2RPC",18,0)
 ;--Location must be on the Institution file
"RTN","ECV2RPC",19,0)
 I '$D(^DIC(4,ECSTAV)),'$D(^DIC(4,"D",ECSTAV)) D 
"RTN","ECV2RPC",20,0)
 . ; Location not on the VistA file
"RTN","ECV2RPC",21,0)
 . S ECERRMSG=$P($T(STA1^ECV2RPC),";;",2)
"RTN","ECV2RPC",22,0)
 . S ECCOLERR=ECSTAPC
"RTN","ECV2RPC",23,0)
 . D ERROR
"RTN","ECV2RPC",24,0)
 . Q
"RTN","ECV2RPC",25,0)
 ;Check for multiple station number entries
"RTN","ECV2RPC",26,0)
 N LOC,C,STR
"RTN","ECV2RPC",27,0)
 S (LOC,C)=0,STR=""
"RTN","ECV2RPC",28,0)
 F  S LOC=$O(^DIC(4,"D",ECSTAV,LOC)) Q:'LOC  S C=C+1 D
"RTN","ECV2RPC",29,0)
 . S LOC(LOC)=ECSTAV_", Location IEN "_LOC_", "_$P(^DIC(4,LOC,0),"^")
"RTN","ECV2RPC",30,0)
 I C>1 S LOC=0 F  S LOC=$O(LOC(LOC)) Q:'LOC  D
"RTN","ECV2RPC",31,0)
 . S ECERRMSG=$P($T(STA2^ECV2RPC),";;",2)_LOC(LOC)
"RTN","ECV2RPC",32,0)
 . S ECCOLERR=ECSTAPC
"RTN","ECV2RPC",33,0)
 . D ERROR
"RTN","ECV2RPC",34,0)
 I C=1,$D(^DIC(4,"D",ECSTAV)) S ECSTAV=$O(^DIC(4,"D",ECSTAV,"")) ;get ien
"RTN","ECV2RPC",35,0)
 ;
"RTN","ECV2RPC",36,0)
 ;--Patient SSN must be on the Patient file--
"RTN","ECV2RPC",37,0)
 N ECNAME4,ECNAME3,ECNAME2,ECNAME1,ECVNAME4,ECVNAME3
"RTN","ECV2RPC",38,0)
 N ECVNAME2,ECVNAME1,ECVNAME,ECSSNNUM
"RTN","ECV2RPC",39,0)
 S (ECSSNIEN,ECERRFLG)=0,ECSSNNUM=+ECSSNV
"RTN","ECV2RPC",40,0)
 I $L(ECSSNNUM)>9!$L(ECSSNV)>10 D
"RTN","ECV2RPC",41,0)
 . ; User has entered an SSN that is too long
"RTN","ECV2RPC",42,0)
 . S ECERRMSG=$P($T(SSN5^ECV2RPC),";;",2)
"RTN","ECV2RPC",43,0)
 . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",44,0)
 . D ERROR
"RTN","ECV2RPC",45,0)
 . Q
"RTN","ECV2RPC",46,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",47,0)
 . ; -add leading zeros if needed
"RTN","ECV2RPC",48,0)
 . I $L(ECSSNNUM)<9 S ECSSNV=$E("000000000",1,9-$L(ECSSNNUM))_ECSSNNUM
"RTN","ECV2RPC",49,0)
 . I $L(ECSSNV)>10 D 
"RTN","ECV2RPC",50,0)
 . . ; User has entered an invalid SSN
"RTN","ECV2RPC",51,0)
 . . S ECERRMSG=$P($T(SSN5^ECV2RPC),";;",2)
"RTN","ECV2RPC",52,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",53,0)
 . . D ERROR
"RTN","ECV2RPC",54,0)
 . . Q
"RTN","ECV2RPC",55,0)
 . I 'ECERRFLG,$L(ECSSNV)=10 D
"RTN","ECV2RPC",56,0)
 . . I $E(ECSSNV,10,10)'="P" D
"RTN","ECV2RPC",57,0)
 . . . ; Invalid SSN
"RTN","ECV2RPC",58,0)
 . . . S ECERRMSG=$P($T(SSN5^ECV2RPC),";;",2)
"RTN","ECV2RPC",59,0)
 . . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",60,0)
 . . . D ERROR
"RTN","ECV2RPC",61,0)
 . . Q
"RTN","ECV2RPC",62,0)
 . I 'ECERRFLG,'$D(^DPT("SSN",ECSSNV)) D
"RTN","ECV2RPC",63,0)
 . . ; No SSN x-ref on patient file
"RTN","ECV2RPC",64,0)
 . . S ECERRMSG=$P($T(SSN1^ECV2RPC),";;",2)
"RTN","ECV2RPC",65,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",66,0)
 . . D ERROR
"RTN","ECV2RPC",67,0)
 . . Q
"RTN","ECV2RPC",68,0)
 . Q
"RTN","ECV2RPC",69,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",70,0)
 . ; -get SSN IEN
"RTN","ECV2RPC",71,0)
 . S ECSSNIEN=$O(^DPT("SSN",ECSSNV,0))
"RTN","ECV2RPC",72,0)
 . I 'ECSSNIEN D
"RTN","ECV2RPC",73,0)
 . . S ECERRMSG=$P($T(SSN2^ECV2RPC),";;",2)
"RTN","ECV2RPC",74,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",75,0)
 . . D ERROR
"RTN","ECV2RPC",76,0)
 . . Q
"RTN","ECV2RPC",77,0)
 . Q
"RTN","ECV2RPC",78,0)
 I 'ECERRFLG,'$D(^DPT(ECSSNIEN,0)) D
"RTN","ECV2RPC",79,0)
 . ; SSN record not found
"RTN","ECV2RPC",80,0)
 . S ECERRMSG=$P($T(SSN3^ECV2RPC),";;",2)
"RTN","ECV2RPC",81,0)
 . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",82,0)
 . D ERROR
"RTN","ECV2RPC",83,0)
 . Q
"RTN","ECV2RPC",84,0)
 ;
"RTN","ECV2RPC",85,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",86,0)
 . ; -Compare patient file ssn to patient ssn
"RTN","ECV2RPC",87,0)
 . S ECVSSN=$P(^DPT(ECSSNIEN,0),U,9)
"RTN","ECV2RPC",88,0)
 . I ECVSSN'=ECSSNV D
"RTN","ECV2RPC",89,0)
 . . ; Spreadsheet ssn doesn't match vista
"RTN","ECV2RPC",90,0)
 . . S ECERRMSG=$P($T(SSN4^ECV2RPC),";;",2)
"RTN","ECV2RPC",91,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",92,0)
 . . D ERROR
"RTN","ECV2RPC",93,0)
 . . Q
"RTN","ECV2RPC",94,0)
 . Q
"RTN","ECV2RPC",95,0)
 ;--Patient Name must match VistA name--
"RTN","ECV2RPC",96,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",97,0)
 . S ECVNAME=$P(^DPT(ECSSNIEN,0),U,1)
"RTN","ECV2RPC",98,0)
 . I '$D(ECVNAME) D
"RTN","ECV2RPC",99,0)
 . . ; Patient name missing from VistA file
"RTN","ECV2RPC",100,0)
 . . S ECERRMSG=$P($T(NAME1^ECV2RPC),";;",2)
"RTN","ECV2RPC",101,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",102,0)
 . . D ERROR
"RTN","ECV2RPC",103,0)
 . . Q
"RTN","ECV2RPC",104,0)
 . Q
"RTN","ECV2RPC",105,0)
 I 'ECERRFLG,'ECDECPAT D
"RTN","ECV2RPC",106,0)
 . N DFN,VADM S DFN=ECSSNIEN D 2^VADPT I +VADM(6) D
"RTN","ECV2RPC",107,0)
 . . S ECERRMSG="WARNING: [PATIENT DIED ON "_$P(VADM(6),U,2)_"]"
"RTN","ECV2RPC",108,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",109,0)
 . . D ERROR
"RTN","ECV2RPC",110,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",111,0)
 . S ECVNAME4=$E(ECVNAME,1,4),ECNAME4=$E(ECPATV,1,4)
"RTN","ECV2RPC",112,0)
 . S ECVNAME3=$E(ECVNAME,1,3),ECNAME3=$E(ECPATV,1,3)
"RTN","ECV2RPC",113,0)
 . S ECVNAME2=$E(ECVNAME,1,2),ECNAME2=$E(ECPATV,1,2)
"RTN","ECV2RPC",114,0)
 . S ECVNAME1=$E(ECVNAME,1,1),ECNAME1=$E(ECPATV,1,1)
"RTN","ECV2RPC",115,0)
 . I ECNAME1'=ECVNAME1 D
"RTN","ECV2RPC",116,0)
 . . ; First char of name doesn't match
"RTN","ECV2RPC",117,0)
 . . S ECERRMSG=$P($T(NAME5^ECV2RPC),";;",2)
"RTN","ECV2RPC",118,0)
 . . S ECCOLERR=ECPATLPC
"RTN","ECV2RPC",119,0)
 . . D ERROR
"RTN","ECV2RPC",120,0)
 . . Q
"RTN","ECV2RPC",121,0)
 . I 'ECERRFLG,ECNAME2'=ECVNAME2 D
"RTN","ECV2RPC",122,0)
 . . ; First 2 chars of name doesn't match
"RTN","ECV2RPC",123,0)
 . . S ECERRMSG=$P($T(NAME2^ECV2RPC),";;",2)
"RTN","ECV2RPC",124,0)
 . . S ECCOLERR=ECPATLPC
"RTN","ECV2RPC",125,0)
 . . D ERROR
"RTN","ECV2RPC",126,0)
 . . Q
"RTN","ECV2RPC",127,0)
 . I 'ECERRFLG,(ECNAME3'=ECVNAME3) D
"RTN","ECV2RPC",128,0)
 . . ; First 3 chars of name doesn't match
"RTN","ECV2RPC",129,0)
 . . S ECERRMSG=$P($T(NAME3^ECV2RPC),";;",2)
"RTN","ECV2RPC",130,0)
 . . S ECCOLERR=ECPATLPC
"RTN","ECV2RPC",131,0)
 . . D ERROR
"RTN","ECV2RPC",132,0)
 . . Q
"RTN","ECV2RPC",133,0)
 . I 'ECERRFLG,(ECNAME4'=ECVNAME4) D
"RTN","ECV2RPC",134,0)
 . . ; First 4 chars of name doesn't match
"RTN","ECV2RPC",135,0)
 . . S ECERRMSG=$P($T(NAME4^ECV2RPC),";;",2)
"RTN","ECV2RPC",136,0)
 . . S ECCOLERR=ECPATLPC
"RTN","ECV2RPC",137,0)
 . . D ERROR
"RTN","ECV2RPC",138,0)
 . . Q
"RTN","ECV2RPC",139,0)
 . Q
"RTN","ECV2RPC",140,0)
 Q
"RTN","ECV2RPC",141,0)
 ;
"RTN","ECV2RPC",142,0)
ERROR ;--Set up array entry to contain the following:
"RTN","ECV2RPC",143,0)
 ;1. record number
"RTN","ECV2RPC",144,0)
 ;2. column number on spreadsheet containing the record number
"RTN","ECV2RPC",145,0)
 ;3. column number on spreadsheet containing the data in error
"RTN","ECV2RPC",146,0)
 ;4. error message
"RTN","ECV2RPC",147,0)
 ;
"RTN","ECV2RPC",148,0)
 S ECINDEX=ECINDEX+1
"RTN","ECV2RPC",149,0)
 S RESULTS(ECINDEX)=ECRECV_"^"_ECRECPC_"^"_ECCOLERR_"^"_ECERRMSG_"^"
"RTN","ECV2RPC",150,0)
 S ECERRFLG=1
"RTN","ECV2RPC",151,0)
 Q
"RTN","ECV2RPC",152,0)
 ;
"RTN","ECV2RPC",153,0)
 ;Error messages:
"RTN","ECV2RPC",154,0)
 ;
"RTN","ECV2RPC",155,0)
STA1 ;;Location not on institution file(#4)
"RTN","ECV2RPC",156,0)
STA2 ;;Multiple entries found for Location/Station #
"RTN","ECV2RPC",157,0)
SSN1 ;;No SSN x-ref on patient file(#2)
"RTN","ECV2RPC",158,0)
SSN2 ;;No SSN entry on patient file(#2)
"RTN","ECV2RPC",159,0)
SSN3 ;;No internal entry on patient file(#2) for ssn x-ref
"RTN","ECV2RPC",160,0)
SSN4 ;;SSN doesn't match SSN on patient file(#2)
"RTN","ECV2RPC",161,0)
SSN5 ;;SSN invalid
"RTN","ECV2RPC",162,0)
NAME1 ;;Patient Name is missing from VistA patient file(#2)
"RTN","ECV2RPC",163,0)
NAME2 ;;First 2 chars of patient last name don't match VistA
"RTN","ECV2RPC",164,0)
NAME3 ;;First 3 chars of patient last name don't match VistA
"RTN","ECV2RPC",165,0)
NAME4 ;;First 4 chars of patient last name don't match VistA
"RTN","ECV2RPC",166,0)
NAME5 ;;First char of patient last name doesn't match VistA
"RTN","ECV3RPC")
0^7^B32146887
"RTN","ECV3RPC",1,0)
ECV3RPC ;ALB/ACS;Event Capture Spreadsheet Data Validation ;Oct 13, 2000
"RTN","ECV3RPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,47,49**;8 May 96
"RTN","ECV3RPC",3,0)
 ;
"RTN","ECV3RPC",4,0)
 ;-----------------------------------------------------------------------
"RTN","ECV3RPC",5,0)
 ;  Validates the following Event Capture Spreadsheet Upload fields:
"RTN","ECV3RPC",6,0)
 ;    1. DSS UNIT IEN, DSS UNIT NUMBER, DSS UNIT NAME
"RTN","ECV3RPC",7,0)
 ;    2. ORDERING SECTION
"RTN","ECV3RPC",8,0)
 ;    3. PROCEDURE CODE
"RTN","ECV3RPC",9,0)
 ;    4. CATEGORY
"RTN","ECV3RPC",10,0)
 ;
"RTN","ECV3RPC",11,0)
 ;-----------------------------------------------------------------------
"RTN","ECV3RPC",12,0)
 ;
"RTN","ECV3RPC",13,0)
 ;--Set up error flag
"RTN","ECV3RPC",14,0)
 S ECERRFLG=0
"RTN","ECV3RPC",15,0)
 ;
"RTN","ECV3RPC",16,0)
 ;--GET DSS Unit IEN--
"RTN","ECV3RPC",17,0)
 S ECDSSIEN=""
"RTN","ECV3RPC",18,0)
 ; -Check for DSS Unit IEN first
"RTN","ECV3RPC",19,0)
 I ECUNITV'="",(ECUNITV'=+ECUNITV) D
"RTN","ECV3RPC",20,0)
 . S ECERRMSG=$P($T(DSS1^ECV3RPC),";;",2)
"RTN","ECV3RPC",21,0)
 . S ECCOLERR=ECUNITPC
"RTN","ECV3RPC",22,0)
 . D ERROR
"RTN","ECV3RPC",23,0)
 I ECUNITV,'ECERRFLG,$D(^ECD(ECUNITV,0)) S ECDSSIEN=ECUNITV
"RTN","ECV3RPC",24,0)
 I ECUNITV,'ECERRFLG,'$D(^ECD(ECUNITV,0)) D
"RTN","ECV3RPC",25,0)
 . ; DSS unit ien not found on VistA
"RTN","ECV3RPC",26,0)
 . S ECERRMSG=$P($T(DSS1^ECV3RPC),";;",2)
"RTN","ECV3RPC",27,0)
 . S ECCOLERR=ECUNITPC
"RTN","ECV3RPC",28,0)
 . D ERROR
"RTN","ECV3RPC",29,0)
 . Q
"RTN","ECV3RPC",30,0)
 ; -Check for DSS Unit Number
"RTN","ECV3RPC",31,0)
 I ECDCMV'="",'$D(^ECD("C",ECDCMV)) D
"RTN","ECV3RPC",32,0)
 . ; DSS Unit Number not found on VistA
"RTN","ECV3RPC",33,0)
 . S ECERRMSG=$P($T(DSS2^ECV3RPC),";;",2)
"RTN","ECV3RPC",34,0)
 . S ECCOLERR=ECDCMPC
"RTN","ECV3RPC",35,0)
 . D ERROR
"RTN","ECV3RPC",36,0)
 I 'ECERRFLG,ECDCMV'="",$D(^ECD("C",ECDCMV)) S ECDSSIEN=$O(^ECD("C",ECDCMV,0))
"RTN","ECV3RPC",37,0)
 ;Check if the next record is a match
"RTN","ECV3RPC",38,0)
 I 'ECERRFLG,'ECDSSIEN,ECDCMV'="",$D(^ECD("C",ECDCMV)) D
"RTN","ECV3RPC",39,0)
 . S ECDSSIEN=$O(^ECD("C",ECDCMV,0))
"RTN","ECV3RPC",40,0)
 . I '$D(^ECD("C",ECDCMV)) D
"RTN","ECV3RPC",41,0)
 . . ; DSS Unit Number not found on VistA
"RTN","ECV3RPC",42,0)
 . . S ECERRMSG=$P($T(DSS2^ECV3RPC),";;",2)
"RTN","ECV3RPC",43,0)
 . . S ECCOLERR=ECDCMPC
"RTN","ECV3RPC",44,0)
 . . D ERROR
"RTN","ECV3RPC",45,0)
 . . Q
"RTN","ECV3RPC",46,0)
 ; -Check for DSS Unit Name
"RTN","ECV3RPC",47,0)
 I ECDSSV'="",'$D(^ECD("B",ECDSSV)) D
"RTN","ECV3RPC",48,0)
 . S ECERRMSG=$P($T(DSS3^ECV3RPC),";;",2)
"RTN","ECV3RPC",49,0)
 . S ECCOLERR=ECDSSPC
"RTN","ECV3RPC",50,0)
 . D ERROR
"RTN","ECV3RPC",51,0)
 ; 
"RTN","ECV3RPC",52,0)
 I 'ECERRFLG,'ECDSSIEN,ECDSSV'="",$D(^ECD("B",ECDSSV)) S ECDSSIEN=$O(^ECD("B",ECDSSV,0))
"RTN","ECV3RPC",53,0)
 I 'ECERRFLG,'ECDSSIEN,ECDSSV'="",'$D(^ECD("B",ECDSSV)) D
"RTN","ECV3RPC",54,0)
 . N ECNXTDSS
"RTN","ECV3RPC",55,0)
 . S ECNXTDSS=$O(^ECD("B",ECDSSV))
"RTN","ECV3RPC",56,0)
 . I ECDSSV=$E(ECNXTDSS,1,$L(ECDSSV)) S ECDSSIEN=$O(^ECD("B",ECNXTDSS,0))
"RTN","ECV3RPC",57,0)
 . ;
"RTN","ECV3RPC",58,0)
 . I ECDSSV'=$E(ECNXTDSS,1,$L(ECDSSV)) D
"RTN","ECV3RPC",59,0)
 . . ; DSS unit name not found on VistA
"RTN","ECV3RPC",60,0)
 . . S ECERRMSG=$P($T(DSS3^ECV3RPC),";;",2)
"RTN","ECV3RPC",61,0)
 . . S ECCOLERR=ECDSSPC
"RTN","ECV3RPC",62,0)
 . . D ERROR
"RTN","ECV3RPC",63,0)
 . . Q
"RTN","ECV3RPC",64,0)
 . Q
"RTN","ECV3RPC",65,0)
 ;
"RTN","ECV3RPC",66,0)
 ;--Validate Ordering section or derive from DSS Unit IEN--
"RTN","ECV3RPC",67,0)
 I ECOSV'="" D
"RTN","ECV3RPC",68,0)
 . S ECOSIEN=$O(^ECC(723,"B",ECOSV,0))
"RTN","ECV3RPC",69,0)
 . I ECOSIEN="" D
"RTN","ECV3RPC",70,0)
 . . ; Ordering Section "B" x-ref doesn't exist
"RTN","ECV3RPC",71,0)
 . . S ECERRMSG=$P($T(ORDSEC1^ECV3RPC),";;",2)
"RTN","ECV3RPC",72,0)
 . . S ECCOLERR=ECOSPC
"RTN","ECV3RPC",73,0)
 . . D ERROR
"RTN","ECV3RPC",74,0)
 . . Q
"RTN","ECV3RPC",75,0)
 . Q
"RTN","ECV3RPC",76,0)
 I ECOSV="" D
"RTN","ECV3RPC",77,0)
 . I 'ECDSSIEN D
"RTN","ECV3RPC",78,0)
 . . ; Unable to derive Ordering section from DSS Unit
"RTN","ECV3RPC",79,0)
 . . S ECERRMSG=$P($T(ORDSEC2^ECV3RPC),";;",2)
"RTN","ECV3RPC",80,0)
 . . S ECCOLERR=ECOSPC
"RTN","ECV3RPC",81,0)
 . . D ERROR
"RTN","ECV3RPC",82,0)
 . . Q
"RTN","ECV3RPC",83,0)
 . I ECDSSIEN D
"RTN","ECV3RPC",84,0)
 . . S ECOSIEN=$P(^ECD(ECDSSIEN,0),U,3)
"RTN","ECV3RPC",85,0)
 . . I ECOSIEN="" D
"RTN","ECV3RPC",86,0)
 . . . ; Unable to derive Ordering section from DSS Unit
"RTN","ECV3RPC",87,0)
 . . . S ECERRMSG=$P($T(ORDSEC2^ECV3RPC),";;",2)
"RTN","ECV3RPC",88,0)
 . . . S ECCOLERR=ECOSPC
"RTN","ECV3RPC",89,0)
 . . . D ERROR
"RTN","ECV3RPC",90,0)
 . . . Q
"RTN","ECV3RPC",91,0)
 . . Q
"RTN","ECV3RPC",92,0)
 ;
"RTN","ECV3RPC",93,0)
 ;--Procedure must be a National Procedure, Local Procedure,   --
"RTN","ECV3RPC",94,0)
 ;--or a CPT code, and the EC Event Code Screen must be active --
"RTN","ECV3RPC",95,0)
 N ECFOUND,ECPI,ECDT
"RTN","ECV3RPC",96,0)
 S ECERRFLG=0,ECFOUND=0
"RTN","ECV3RPC",97,0)
 S %DT="XST",X=$G(ECENCV,"NOW") D ^%DT S ECDT=+Y
"RTN","ECV3RPC",98,0)
 ; Check for National Procedure code (D x-ref)
"RTN","ECV3RPC",99,0)
 I $D(^EC(725,"D",ECPROCV)) D
"RTN","ECV3RPC",100,0)
 . S ECPROCV=$O(^EC(725,"D",ECPROCV,0))_";EC(725,"
"RTN","ECV3RPC",101,0)
 . S ECPI=$P($G(^EC(725,ECPROCV,0)),"^",5)
"RTN","ECV3RPC",102,0)
 . I ECPI="" S ECFOUND=1 Q
"RTN","ECV3RPC",103,0)
 . S ECPI=$$CPT^ICPTCOD(ECPI,ECDT) I +ECPI>0,$P(ECPI,"^",7) S ECFOUND=1
"RTN","ECV3RPC",104,0)
 ; Check for local procedure code (DL x-ref)
"RTN","ECV3RPC",105,0)
 I 'ECFOUND,$D(^EC(725,"DL",ECPROCV)) D
"RTN","ECV3RPC",106,0)
 . S ECPROCV=$O(^EC(725,"DL",ECPROCV,0))_";EC(725,"
"RTN","ECV3RPC",107,0)
 . S ECPI=$P($G(^EC(725,ECPROCV,0)),"^",5)
"RTN","ECV3RPC",108,0)
 . I ECPI="" S ECFOUND=1 Q
"RTN","ECV3RPC",109,0)
 . S ECPI=$$CPT^ICPTCOD(ECPI,ECDT) I +ECPI>0,$P(ECPI,"^",7)  S ECFOUND=1
"RTN","ECV3RPC",110,0)
 ; Check for CPT code (B x-ref)
"RTN","ECV3RPC",111,0)
 I 'ECFOUND S ECPI=$$CPT^ICPTCOD(ECPROCV,ECDT) I +ECPI>0,$P(ECPI,"^",7) D
"RTN","ECV3RPC",112,0)
 . S ECPROCV=$P(ECPI,"^")_";ICPT("
"RTN","ECV3RPC",113,0)
 . S ECFOUND=1
"RTN","ECV3RPC",114,0)
 ;
"RTN","ECV3RPC",115,0)
 I 'ECFOUND D
"RTN","ECV3RPC",116,0)
 . ; Invalid procedure code
"RTN","ECV3RPC",117,0)
 . S ECERRMSG=$P($T(PROC1^ECV3RPC),";;",2)
"RTN","ECV3RPC",118,0)
 . S ECCOLERR=ECPROCPC
"RTN","ECV3RPC",119,0)
 . D ERROR
"RTN","ECV3RPC",120,0)
 . Q
"RTN","ECV3RPC",121,0)
 ;
"RTN","ECV3RPC",122,0)
 ; -Category must exist on the Event Capture Category file
"RTN","ECV3RPC",123,0)
 I ECCATV="" S ECCATIEN=0
"RTN","ECV3RPC",124,0)
 I ECCATV'="" D
"RTN","ECV3RPC",125,0)
 . I $D(^EC(726,"B",ECCATV)) S ECCATIEN=$O(^EC(726,"B",ECCATV,0))
"RTN","ECV3RPC",126,0)
 . I '$D(^EC(726,"B",ECCATV)) D
"RTN","ECV3RPC",127,0)
 . . ; B cross reference not found for category
"RTN","ECV3RPC",128,0)
 . . S ECERRMSG=$P($T(CAT1^ECV3RPC),";;",2)
"RTN","ECV3RPC",129,0)
 . . S ECCOLERR=ECCATPC
"RTN","ECV3RPC",130,0)
 . . D ERROR
"RTN","ECV3RPC",131,0)
 . . Q
"RTN","ECV3RPC",132,0)
 ;
"RTN","ECV3RPC",133,0)
 ; -check for active Event Code screen
"RTN","ECV3RPC",134,0)
 N ECEVNT,ECSNODE,ECSDATA,ECSFOUND
"RTN","ECV3RPC",135,0)
 I 'ECERRFLG D
"RTN","ECV3RPC",136,0)
 . S ECEVNT=ECSTAV_"-"_ECDSSIEN_"-"_ECCATIEN_"-"_ECPROCV
"RTN","ECV3RPC",137,0)
 . S (ECSNODE,ECSFOUND)=0
"RTN","ECV3RPC",138,0)
 . F  S ECSNODE=$O(^ECJ(ECSNODE)) Q:ECSNODE=""  D
"RTN","ECV3RPC",139,0)
 . . S ECSDATA=$G(^ECJ(ECSNODE,0))
"RTN","ECV3RPC",140,0)
 . . I ECEVNT=$P(ECSDATA,U,1) D
"RTN","ECV3RPC",141,0)
 . . . S ECSFOUND=1
"RTN","ECV3RPC",142,0)
 . . . I $P(ECSDATA,U,2)'="" D
"RTN","ECV3RPC",143,0)
 . . . . ; Event Code screen inactive
"RTN","ECV3RPC",144,0)
 . . . . S ECERRMSG=$P($T(PROC2^ECV3RPC),";;",2)
"RTN","ECV3RPC",145,0)
 . . . . S ECCOLERR=ECPROCPC
"RTN","ECV3RPC",146,0)
 . . . . D ERROR
"RTN","ECV3RPC",147,0)
 . . . . Q
"RTN","ECV3RPC",148,0)
 . . . Q
"RTN","ECV3RPC",149,0)
 . . Q
"RTN","ECV3RPC",150,0)
 . Q
"RTN","ECV3RPC",151,0)
 ;
"RTN","ECV3RPC",152,0)
 ;Generate error if event code screen not found
"RTN","ECV3RPC",153,0)
 I 'ECERRFLG,'ECSFOUND,ECDSSIEN D
"RTN","ECV3RPC",154,0)
 . ; Event Code screen not found
"RTN","ECV3RPC",155,0)
 . S ECERRMSG=$P($T(PROC3^ECV3RPC),";;",2)
"RTN","ECV3RPC",156,0)
 . S ECCOLERR=ECPROCPC
"RTN","ECV3RPC",157,0)
 . D ERROR
"RTN","ECV3RPC",158,0)
 . Q
"RTN","ECV3RPC",159,0)
 ;
"RTN","ECV3RPC",160,0)
 Q
"RTN","ECV3RPC",161,0)
ERROR ;--Set up array entry to contain the following:
"RTN","ECV3RPC",162,0)
 ;1. record number
"RTN","ECV3RPC",163,0)
 ;2. column number on spreadsheet containing the record number
"RTN","ECV3RPC",164,0)
 ;3. column number on spreadsheet containing the data in error
"RTN","ECV3RPC",165,0)
 ;4. error message
"RTN","ECV3RPC",166,0)
 ;
"RTN","ECV3RPC",167,0)
 S ECINDEX=ECINDEX+1
"RTN","ECV3RPC",168,0)
 S RESULTS(ECINDEX)=ECRECV_"^"_ECRECPC_"^"_ECCOLERR_"^"_ECERRMSG_"^"
"RTN","ECV3RPC",169,0)
 S ECERRFLG=1
"RTN","ECV3RPC",170,0)
 Q
"RTN","ECV3RPC",171,0)
 ;
"RTN","ECV3RPC",172,0)
DSS1 ;;Invalid DSS Unit IEN
"RTN","ECV3RPC",173,0)
DSS2 ;;Invalid DSS Unit Number
"RTN","ECV3RPC",174,0)
DSS3 ;;Invalid DSS Unit Name
"RTN","ECV3RPC",175,0)
ORDSEC1 ;;Ordering Section "B" x-ref not on Med Specialty file(#723)
"RTN","ECV3RPC",176,0)
ORDSEC2 ;;Unable to derive Ordering Section from DSS Unit
"RTN","ECV3RPC",177,0)
PROC1 ;;Procedure/CPT invalid
"RTN","ECV3RPC",178,0)
PROC2 ;;Procedure/CPT invalid for this Station and DSS Unit
"RTN","ECV3RPC",179,0)
PROC3 ;;Event Code screen not found
"RTN","ECV3RPC",180,0)
CAT1 ;;Category "B" x-ref not on EC Category file(#726)
"RTN","ECV4RPC")
0^3^B61727818
"RTN","ECV4RPC",1,0)
ECV4RPC ;ALB/ACS;Event Capture Spreadsheet Data Validation ;Oct 13, 2000
"RTN","ECV4RPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,33,49**;8 May 96
"RTN","ECV4RPC",3,0)
 ;
"RTN","ECV4RPC",4,0)
 ;-----------------------------------------------------------------------
"RTN","ECV4RPC",5,0)
 ;  Validates the following Event Capture Spreadsheet Upload fields:
"RTN","ECV4RPC",6,0)
 ;    1. VOLUME
"RTN","ECV4RPC",7,0)
 ;    2. ENCOUNTER DATE/TIME
"RTN","ECV4RPC",8,0)
 ;    3. PROVIDER NAME
"RTN","ECV4RPC",9,0)
 ;
"RTN","ECV4RPC",10,0)
 ;  Determines the following:
"RTN","ECV4RPC",11,0)
 ;    1. PATIENT STATUS
"RTN","ECV4RPC",12,0)
 ;-----------------------------------------------------------------------
"RTN","ECV4RPC",13,0)
 ;
"RTN","ECV4RPC",14,0)
 ;--Volume must be 1 thru 99--
"RTN","ECV4RPC",15,0)
 N ECVOLVN,ECPDT
"RTN","ECV4RPC",16,0)
 S ECVOLVN=ECVOLV
"RTN","ECV4RPC",17,0)
 I (+ECVOLVN'=ECVOLVN)!(ECVOLVN<1)!(ECVOLVN>99)!(ECVOLVN?.E1"."1N.N) D
"RTN","ECV4RPC",18,0)
 . S ECERRMSG=$P($T(VOL1^ECV4RPC),";;",2)
"RTN","ECV4RPC",19,0)
 . S ECCOLERR=ECVOLPC
"RTN","ECV4RPC",20,0)
 . D ERROR
"RTN","ECV4RPC",21,0)
 . Q
"RTN","ECV4RPC",22,0)
 I $L(ECVOLVN)'=$L(ECVOLV) D
"RTN","ECV4RPC",23,0)
 . ; Volume must be numeric
"RTN","ECV4RPC",24,0)
 . S ECERRMSG=$P($T(VOL2^ECV4RPC),";;",2)
"RTN","ECV4RPC",25,0)
 . S ECCOLERR=ECVOLPC
"RTN","ECV4RPC",26,0)
 . D ERROR
"RTN","ECV4RPC",27,0)
 . Q
"RTN","ECV4RPC",28,0)
 ;
"RTN","ECV4RPC",29,0)
 ;--Encounter Date/Time--
"RTN","ECV4RPC",30,0)
 S ECERRFLG=0
"RTN","ECV4RPC",31,0)
 N ECRETVAL
"RTN","ECV4RPC",32,0)
 S %DT(0)="-NOW",ECENCV=$TR(ECENCV," ","")
"RTN","ECV4RPC",33,0)
 D CHK^DIE(721,2,"E",ECENCV,.ECRETVAL)
"RTN","ECV4RPC",34,0)
 I $G(ECRETVAL)="^" D
"RTN","ECV4RPC",35,0)
 . ; Invalid encounter date/time
"RTN","ECV4RPC",36,0)
 . S ECERRMSG=$P($T(ENC1^ECV4RPC),";;",2)
"RTN","ECV4RPC",37,0)
 . S ECCOLERR=ECENCPC
"RTN","ECV4RPC",38,0)
 . D ERROR
"RTN","ECV4RPC",39,0)
 . Q
"RTN","ECV4RPC",40,0)
 I $G(ECRETVAL)'="^" D
"RTN","ECV4RPC",41,0)
 . S %DT="XST",X=ECENCV
"RTN","ECV4RPC",42,0)
 . D ^%DT
"RTN","ECV4RPC",43,0)
 . S ECENCV=+Y
"RTN","ECV4RPC",44,0)
 . Q
"RTN","ECV4RPC",45,0)
 ;
"RTN","ECV4RPC",46,0)
 ;--Provider Name or IEN must be on the New Person file--
"RTN","ECV4RPC",47,0)
 ;--and provider must have active person class  --
"RTN","ECV4RPC",48,0)
 N ECPROV1
"RTN","ECV4RPC",49,0)
 S ECERRFLG=0,ECPRVIEN=0
"RTN","ECV4RPC",50,0)
 ; Remove punctuation if necessary
"RTN","ECV4RPC",51,0)
 I ECPROVV?.E1P S ECPROVV=$E(ECPROVV,1,$L(ECPROVV)-1)
"RTN","ECV4RPC",52,0)
 ; If provider ien passed in, find on file
"RTN","ECV4RPC",53,0)
 S ECPROV1=ECPROVV
"RTN","ECV4RPC",54,0)
 I +ECPROVV>0 D
"RTN","ECV4RPC",55,0)
 . I '$D(^VA(200,ECPROVV)) D
"RTN","ECV4RPC",56,0)
 . . ; Provider ien not found on New Person file
"RTN","ECV4RPC",57,0)
 . . S ECERRMSG=$P($T(PROV4^ECV4RPC),";;",2)
"RTN","ECV4RPC",58,0)
 . . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",59,0)
 . . D ERROR
"RTN","ECV4RPC",60,0)
 . E  S ECPRVIEN=ECPROVV
"RTN","ECV4RPC",61,0)
 ;
"RTN","ECV4RPC",62,0)
 ; If provider name passed in, find on B x-ref and
"RTN","ECV4RPC",63,0)
 ; make sure there isn't more than 1 with same name
"RTN","ECV4RPC",64,0)
 N ECPRVNXT,ECPRVMOR,ECPRVMNT
"RTN","ECV4RPC",65,0)
 S (ECPRVMOR,ECPRVMNT)=0,ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",66,0)
 I +ECPROVV'>0,$D(^VA(200,"B",ECPROVV)) D
"RTN","ECV4RPC",67,0)
 . S ECPRVIE2=$O(^VA(200,"B",ECPROVV,""))
"RTN","ECV4RPC",68,0)
 . S ECPRVNXT=$O(^VA(200,"B",ECPROVV,ECPRVIE2))
"RTN","ECV4RPC",69,0)
 . I ECPRVNXT'="" D
"RTN","ECV4RPC",70,0)
 . . S ECERRMSG=$P($T(PROV5^ECV4RPC),";;",2)
"RTN","ECV4RPC",71,0)
 . . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",72,0)
 . . D ERROR
"RTN","ECV4RPC",73,0)
 . . S ECPRVMOR=1
"RTN","ECV4RPC",74,0)
 . E  S ECPRVIEN=ECPRVIE2
"RTN","ECV4RPC",75,0)
 ;
"RTN","ECV4RPC",76,0)
 I +ECPROVV'>0,'$D(^VA(200,"B",ECPROVV)) D
"RTN","ECV4RPC",77,0)
 . ; Exact match not found on New Person file
"RTN","ECV4RPC",78,0)
 . ; Generate standard error message
"RTN","ECV4RPC",79,0)
 . S ECERRMSG=$P($T(PROV1^ECV4RPC),";;",2)
"RTN","ECV4RPC",80,0)
 . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",81,0)
 . D ERROR
"RTN","ECV4RPC",82,0)
 . S ECPRVMNT=1
"RTN","ECV4RPC",83,0)
 ; If exact match not found, get provider info
"RTN","ECV4RPC",84,0)
 I ECPRVMNT D
"RTN","ECV4RPC",85,0)
 . ; look at next provider on file for 'close' match
"RTN","ECV4RPC",86,0)
 . N ECINFO,ECLENPRV,NOMATCH,ECSPEC,ECSUBSP
"RTN","ECV4RPC",87,0)
 . N ECCOUNT,ECFIRST,ECLAST,ECPRVNXT,ECPRVIE2,ECPRVIE3
"RTN","ECV4RPC",88,0)
 . S ECLENPRV=$L(ECPROVV),(ECPRVIE2,ECPRVIE3)="",(ECCOUNT,NOMATCH)=0
"RTN","ECV4RPC",89,0)
 . S ECPRVNXT=ECPROVV
"RTN","ECV4RPC",90,0)
 . F  S ECPRVNXT=$O(^VA(200,"B",ECPRVNXT)) Q:NOMATCH=1  D
"RTN","ECV4RPC",91,0)
 . . F  S ECPRVIE3=$O(^VA(200,"B",ECPRVNXT,ECPRVIE3)) Q:ECPRVIE3=""  D
"RTN","ECV4RPC",92,0)
 . . . I ECPROVV'=$E(ECPRVNXT,1,ECLENPRV) S NOMATCH=1
"RTN","ECV4RPC",93,0)
 . . . E  D
"RTN","ECV4RPC",94,0)
 . . . . ;get provider info and add to end of error string
"RTN","ECV4RPC",95,0)
 . . . . S ECINFO=$$GET^XUA4A72(ECPRVIE3,ECENCV)
"RTN","ECV4RPC",96,0)
 . . . . I +ECINFO'>0 D
"RTN","ECV4RPC",97,0)
 . . . . . S ECERRMSG=ECPRVNXT_"-"_ECPRVIE3_"-Inactive Provider for this encounter date"
"RTN","ECV4RPC",98,0)
 . . . . . D ERROR
"RTN","ECV4RPC",99,0)
 . . . . . ;S ECCOUNT=ECCOUNT+1
"RTN","ECV4RPC",100,0)
 . . . . I +ECINFO>0 D
"RTN","ECV4RPC",101,0)
 . . . . . S ECCOUNT=ECCOUNT+1
"RTN","ECV4RPC",102,0)
 . . . . . S ECSPEC=$P(ECINFO,U,3)
"RTN","ECV4RPC",103,0)
 . . . . . I ECSPEC=" " S ECSPEC=""
"RTN","ECV4RPC",104,0)
 . . . . . S ECSUBSP=$P(ECINFO,U,4)
"RTN","ECV4RPC",105,0)
 . . . . . I ECSUBSP=" " S ECSUBSP=""
"RTN","ECV4RPC",106,0)
 . . . . . S ECPCLASS=$P(^VA(200,ECPRVIE3,"USC1",0),U,3)
"RTN","ECV4RPC",107,0)
 . . . . . I ECPCLASS="" S ECPCLASS="PERSON CLASS NOT FOUND"
"RTN","ECV4RPC",108,0)
 . . . . . S ECERRMSG=ECPRVNXT_"-"_ECPRVIE3_"-"_ECSPEC_"-"_ECSUBSP_"-"_ECPCLASS
"RTN","ECV4RPC",109,0)
 . . . . . D ERROR
"RTN","ECV4RPC",110,0)
 ; If more than one provider with that name, get info
"RTN","ECV4RPC",111,0)
 I ECPRVMOR D
"RTN","ECV4RPC",112,0)
 . N ECINFO,ECSPEC,ECSUBSP,ECPCLASS,ECCOUNT,ECFIRST,ECLAST,ECPRVIE2
"RTN","ECV4RPC",113,0)
 . S ECCOUNT=0,ECPRVIE2=0
"RTN","ECV4RPC",114,0)
 . ;look at each provider for exact match
"RTN","ECV4RPC",115,0)
 . F  S ECPRVIE2=$O(^VA(200,"B",ECPROVV,ECPRVIE2)) Q:ECPRVIE2=""  D
"RTN","ECV4RPC",116,0)
 . . S ECINFO=$$GET^XUA4A72(ECPRVIE2,ECENCV)
"RTN","ECV4RPC",117,0)
 . . I +ECINFO'>0 D
"RTN","ECV4RPC",118,0)
 . . . S ECERRMSG=ECPROVV_"-"_ECPRVIE2_"-Inactive Provider for this encounter date"
"RTN","ECV4RPC",119,0)
 . . . D ERROR
"RTN","ECV4RPC",120,0)
 . . I +ECINFO>0 D
"RTN","ECV4RPC",121,0)
 . . . S ECCOUNT=ECCOUNT+1
"RTN","ECV4RPC",122,0)
 . . . S ECSPEC=$P(ECINFO,U,3)
"RTN","ECV4RPC",123,0)
 . . . I ECSPEC=" " S ECSPEC=""
"RTN","ECV4RPC",124,0)
 . . . S ECSUBSP=$P(ECINFO,U,4)
"RTN","ECV4RPC",125,0)
 . . . I ECSUBSP=" " S ECSUBSP=""
"RTN","ECV4RPC",126,0)
 . . . S ECPCLASS=$P(^VA(200,ECPRVIE2,"USC1",0),U,3)
"RTN","ECV4RPC",127,0)
 . . . I ECPCLASS="" S ECPCLASS="PERSON CLASS NOT FOUND"
"RTN","ECV4RPC",128,0)
 . . . S ECERRMSG=ECPROVV_"-"_ECPRVIE2_"-"_ECSPEC_"-"_ECSUBSP_"-"_ECPCLASS
"RTN","ECV4RPC",129,0)
 . . . D ERROR
"RTN","ECV4RPC",130,0)
 ;
"RTN","ECV4RPC",131,0)
 ; Check person class of valid provider
"RTN","ECV4RPC",132,0)
 S ECPROVV=ECPROV1
"RTN","ECV4RPC",133,0)
 S %DT="XST",X=ECENCV D ^%DT S ECPDT=$S(+Y>0:+Y,1:DT)
"RTN","ECV4RPC",134,0)
 I 'ECERRFLG D
"RTN","ECV4RPC",135,0)
 . I ECPRVIEN=0 S ECPRVIEN=$O(^VA(200,"B",ECPROVV,0))
"RTN","ECV4RPC",136,0)
 . I '$D(^VA(200,ECPRVIEN,"USC1",0)) D 
"RTN","ECV4RPC",137,0)
 . . ; Person class xref doesn't exist
"RTN","ECV4RPC",138,0)
 . . S ECERRMSG=$P($T(PROV2^ECV4RPC),";;",2)
"RTN","ECV4RPC",139,0)
 . . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",140,0)
 . . D ERROR
"RTN","ECV4RPC",141,0)
 . . Q
"RTN","ECV4RPC",142,0)
 . Q
"RTN","ECV4RPC",143,0)
 ;
"RTN","ECV4RPC",144,0)
 I 'ECERRFLG D
"RTN","ECV4RPC",145,0)
 . S ECPCLASS=$P(^VA(200,ECPRVIEN,"USC1",0),U,3)
"RTN","ECV4RPC",146,0)
 . I ECPCLASS="" D
"RTN","ECV4RPC",147,0)
 . . ; Person class field empty
"RTN","ECV4RPC",148,0)
 . . S ECERRMSG=$P($T(PROV2^ECV4RPC),";;",2)
"RTN","ECV4RPC",149,0)
 . . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",150,0)
 . . D ERROR
"RTN","ECV4RPC",151,0)
 . . Q
"RTN","ECV4RPC",152,0)
 . Q
"RTN","ECV4RPC",153,0)
 ;
"RTN","ECV4RPC",154,0)
 I 'ECERRFLG,'$D(^VA(200,ECPRVIEN,"USC1",ECPCLASS,0)) D
"RTN","ECV4RPC",155,0)
 . ; Person class information missing
"RTN","ECV4RPC",156,0)
 . S ECERRMSG=$P($T(PROV2^ECV4RPC),";;",2)
"RTN","ECV4RPC",157,0)
 . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",158,0)
 . D ERROR
"RTN","ECV4RPC",159,0)
 . Q
"RTN","ECV4RPC",160,0)
 ;
"RTN","ECV4RPC",161,0)
 ; Check for person class expiration date
"RTN","ECV4RPC",162,0)
 I 'ECERRFLG,$$GET^XUA4A72(ECPRVIEN,ECPDT)<1 D
"RTN","ECV4RPC",163,0)
 . ; Person class contains an expiration date
"RTN","ECV4RPC",164,0)
 . S ECERRMSG=$P($T(PROV3^ECV4RPC),";;",2)
"RTN","ECV4RPC",165,0)
 . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",166,0)
 . D ERROR
"RTN","ECV4RPC",167,0)
 . Q
"RTN","ECV4RPC",168,0)
 ;
"RTN","ECV4RPC",169,0)
 I 'ECERRFLG D
"RTN","ECV4RPC",170,0)
 . S ECPRVTYP=$P(^VA(200,ECPRVIEN,"USC1",ECPCLASS,0),U,1)
"RTN","ECV4RPC",171,0)
 . I $P(^USC(8932.1,ECPRVTYP,0),U,4)'="a" D
"RTN","ECV4RPC",172,0)
 . . ; Person class is not active
"RTN","ECV4RPC",173,0)
 . . S ECERRMSG=$P($T(PROV3^ECV4RPC),";;",2)
"RTN","ECV4RPC",174,0)
 . . S ECCOLERR=ECPRVLPC
"RTN","ECV4RPC",175,0)
 . . D ERROR
"RTN","ECV4RPC",176,0)
 . . Q
"RTN","ECV4RPC",177,0)
 . Q
"RTN","ECV4RPC",178,0)
 ;
"RTN","ECV4RPC",179,0)
 ;--Determine Patient Status--
"RTN","ECV4RPC",180,0)
 S ECPSTAT=""
"RTN","ECV4RPC",181,0)
 I ECSSNIEN D
"RTN","ECV4RPC",182,0)
 . S ECERRFLG=0
"RTN","ECV4RPC",183,0)
 . S ECPSTAT=$$INOUTPT^ECUTL0(ECSSNIEN,+ECENCV)
"RTN","ECV4RPC",184,0)
 . I ECPSTAT="" D
"RTN","ECV4RPC",185,0)
 . . ; Unable to determine patient status
"RTN","ECV4RPC",186,0)
 . . S ECERRMSG=$P($T(STAT1^ECV4RPC),";;",2)
"RTN","ECV4RPC",187,0)
 . . S ECCOLERR=ECENCPC
"RTN","ECV4RPC",188,0)
 . . D ERROR
"RTN","ECV4RPC",189,0)
 . . Q
"RTN","ECV4RPC",190,0)
 . I ECPSTAT="I",'ECPSTATV,'ECERRFLG D
"RTN","ECV4RPC",191,0)
 . . ; Patient status is Inpatient and override flag is false
"RTN","ECV4RPC",192,0)
 . . S ECERRMSG=$P($T(STAT2^ECV4RPC),";;",2)
"RTN","ECV4RPC",193,0)
 . . S ECCOLERR=ECENCPC
"RTN","ECV4RPC",194,0)
 . . D ERROR
"RTN","ECV4RPC",195,0)
 . . Q
"RTN","ECV4RPC",196,0)
 ;
"RTN","ECV4RPC",197,0)
 ;--Check to see if the DSS Unit is 'send to PCE'--
"RTN","ECV4RPC",198,0)
 S ECDXIEN="",ECCLNIEN=""
"RTN","ECV4RPC",199,0)
 I ECPSTAT'="",ECDSSIEN'="" D
"RTN","ECV4RPC",200,0)
 . N ECDSSDAT,ECDSSPCE
"RTN","ECV4RPC",201,0)
 . S ECDSSDAT=$G(^ECD(ECDSSIEN,0))
"RTN","ECV4RPC",202,0)
 . S ECDSSPCE=$P(ECDSSDAT,U,14)
"RTN","ECV4RPC",203,0)
 . ; If Outpatient and send=O, or send=A
"RTN","ECV4RPC",204,0)
 . I ((ECPSTAT="O")&(ECDSSPCE["O"))!(ECDSSPCE["A") D
"RTN","ECV4RPC",205,0)
 . . ;Validate Diagnosis code and Associated Clinic
"RTN","ECV4RPC",206,0)
 . . D VALDIAG^ECV5RPC
"RTN","ECV4RPC",207,0)
 . . D VALCLIN^ECV5RPC
"RTN","ECV4RPC",208,0)
 . Q
"RTN","ECV4RPC",209,0)
 ;
"RTN","ECV4RPC",210,0)
 ;--Check to see if DUZ is defined
"RTN","ECV4RPC",211,0)
 S ECDUZ=$S($D(DUZ):DUZ,1:"")
"RTN","ECV4RPC",212,0)
 I ECDUZ="" D
"RTN","ECV4RPC",213,0)
 . ; Invalid DUZ
"RTN","ECV4RPC",214,0)
 . S ECERRMSG=$P($T(DUZ^ECV4RPC),";;",2),ECCOLERR=0
"RTN","ECV4RPC",215,0)
 . D ERROR
"RTN","ECV4RPC",216,0)
 Q
"RTN","ECV4RPC",217,0)
 ;;
"RTN","ECV4RPC",218,0)
ERROR ;--Set up array entry to contain the following:
"RTN","ECV4RPC",219,0)
 ;1. record number
"RTN","ECV4RPC",220,0)
 ;2. column number on spreadsheet containing the record number
"RTN","ECV4RPC",221,0)
 ;3. column number on spreadsheet containing the data in error
"RTN","ECV4RPC",222,0)
 ;4. error message
"RTN","ECV4RPC",223,0)
 ;
"RTN","ECV4RPC",224,0)
 S ECINDEX=ECINDEX+1
"RTN","ECV4RPC",225,0)
 S RESULTS(ECINDEX)=ECRECV_"^"_ECRECPC_"^"_ECCOLERR_"^"_ECERRMSG_"^"
"RTN","ECV4RPC",226,0)
 S ECERRFLG=1
"RTN","ECV4RPC",227,0)
 Q
"RTN","ECV4RPC",228,0)
 ;
"RTN","ECV4RPC",229,0)
 ;Error messages:
"RTN","ECV4RPC",230,0)
 ;
"RTN","ECV4RPC",231,0)
VOL1 ;;Volume must be a whole number from 1 to 99
"RTN","ECV4RPC",232,0)
VOL2 ;;Volume must contain numeric characters only
"RTN","ECV4RPC",233,0)
PROV1 ;;Provider has no B x-ref on New Person file(#200)
"RTN","ECV4RPC",234,0)
PROV2 ;;Unable to determine person class
"RTN","ECV4RPC",235,0)
PROV3 ;;Provider does not have an active person class
"RTN","ECV4RPC",236,0)
PROV4 ;;Provider IEN not found on New Person file(#200)
"RTN","ECV4RPC",237,0)
PROV5 ;;More than one provider  with this name - use IEN
"RTN","ECV4RPC",238,0)
ENC1 ;;Invalid encounter date/time.  Date cannot be in the future.
"RTN","ECV4RPC",239,0)
STAT1 ;;Unable to determine patient status
"RTN","ECV4RPC",240,0)
STAT2 ;;The patient status is Inpatient
"RTN","ECV4RPC",241,0)
DUZ ;;User DUZ not defined
"VER")
8.0^22
**END**
**END**
