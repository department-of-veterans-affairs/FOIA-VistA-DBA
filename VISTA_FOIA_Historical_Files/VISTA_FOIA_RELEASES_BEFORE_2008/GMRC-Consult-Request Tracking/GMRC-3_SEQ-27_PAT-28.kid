Released GMRC*3*28 SEQ #27
Extracted from mail message
**KIDS**:GMRC*3.0*28^

**INSTALL NAME**
GMRC*3.0*28
"BLD",3866,0)
GMRC*3.0*28^CONSULT/REQUEST TRACKING^0^3021101^y
"BLD",3866,1,0)
^^2^2^3020820^
"BLD",3866,1,1,0)
Check the National Patch Module for complete details of enhancements 
"BLD",3866,1,2,0)
provided in this patch. 
"BLD",3866,4,0)
^9.64PA^^
"BLD",3866,"KRN",0)
^9.67PA^8989.52^19
"BLD",3866,"KRN",.4,0)
.4
"BLD",3866,"KRN",.401,0)
.401
"BLD",3866,"KRN",.402,0)
.402
"BLD",3866,"KRN",.403,0)
.403
"BLD",3866,"KRN",.5,0)
.5
"BLD",3866,"KRN",.84,0)
.84
"BLD",3866,"KRN",3.6,0)
3.6
"BLD",3866,"KRN",3.8,0)
3.8
"BLD",3866,"KRN",9.2,0)
9.2
"BLD",3866,"KRN",9.8,0)
9.8
"BLD",3866,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",3866,"KRN",9.8,"NM",1,0)
GMRCIEV1^^0^B33699336
"BLD",3866,"KRN",9.8,"NM",2,0)
GMRCIEVT^^0^B55919888
"BLD",3866,"KRN",9.8,"NM",3,0)
GMRCIBKG^^0^B37488140
"BLD",3866,"KRN",9.8,"NM",4,0)
GMRCIAC2^^0^B37912108
"BLD",3866,"KRN",9.8,"NM",5,0)
GMRCIMSG^^0^B22849846
"BLD",3866,"KRN",9.8,"NM",6,0)
GMRCIERR^^0^B66228788
"BLD",3866,"KRN",9.8,"NM",7,0)
GMRCUTL1^^0^B13626178
"BLD",3866,"KRN",9.8,"NM",8,0)
GMRCITR^^0^B36533926
"BLD",3866,"KRN",9.8,"NM",9,0)
GMRCITPI^^0^B12587821
"BLD",3866,"KRN",9.8,"NM","B","GMRCIAC2",4)

"BLD",3866,"KRN",9.8,"NM","B","GMRCIBKG",3)

"BLD",3866,"KRN",9.8,"NM","B","GMRCIERR",6)

"BLD",3866,"KRN",9.8,"NM","B","GMRCIEV1",1)

"BLD",3866,"KRN",9.8,"NM","B","GMRCIEVT",2)

"BLD",3866,"KRN",9.8,"NM","B","GMRCIMSG",5)

"BLD",3866,"KRN",9.8,"NM","B","GMRCITPI",9)

"BLD",3866,"KRN",9.8,"NM","B","GMRCITR",8)

"BLD",3866,"KRN",9.8,"NM","B","GMRCUTL1",7)

"BLD",3866,"KRN",19,0)
19
"BLD",3866,"KRN",19,"NM",0)
^9.68A^3^3
"BLD",3866,"KRN",19,"NM",1,0)
GMRC IFC PARAMETER EDIT^^0
"BLD",3866,"KRN",19,"NM",2,0)
GMRC IFC INC RPT^^0
"BLD",3866,"KRN",19,"NM",3,0)
GMRC IFC MGMT^^2
"BLD",3866,"KRN",19,"NM","B","GMRC IFC INC RPT",2)

"BLD",3866,"KRN",19,"NM","B","GMRC IFC MGMT",3)

"BLD",3866,"KRN",19,"NM","B","GMRC IFC PARAMETER EDIT",1)

"BLD",3866,"KRN",19.1,0)
19.1
"BLD",3866,"KRN",101,0)
101
"BLD",3866,"KRN",409.61,0)
409.61
"BLD",3866,"KRN",771,0)
771
"BLD",3866,"KRN",870,0)
870
"BLD",3866,"KRN",8989.51,0)
8989.51
"BLD",3866,"KRN",8989.51,"NM",0)
^9.68A^2^2
"BLD",3866,"KRN",8989.51,"NM",1,0)
GMRC IFC ALERT IMMED ON PT ERR^^0
"BLD",3866,"KRN",8989.51,"NM",2,0)
GMRC IFC SKIP WEEKEND RE-TRANS^^0
"BLD",3866,"KRN",8989.51,"NM","B","GMRC IFC ALERT IMMED ON PT ERR",1)

"BLD",3866,"KRN",8989.51,"NM","B","GMRC IFC SKIP WEEKEND RE-TRANS",2)

"BLD",3866,"KRN",8989.52,0)
8989.52
"BLD",3866,"KRN",8989.52,"NM",0)
^9.68A^1^1
"BLD",3866,"KRN",8989.52,"NM",1,0)
GMRC IFC PARAMETERS^^0
"BLD",3866,"KRN",8989.52,"NM","B","GMRC IFC PARAMETERS",1)

"BLD",3866,"KRN",8994,0)
8994
"BLD",3866,"KRN","B",.4,.4)

"BLD",3866,"KRN","B",.401,.401)

"BLD",3866,"KRN","B",.402,.402)

"BLD",3866,"KRN","B",.403,.403)

"BLD",3866,"KRN","B",.5,.5)

"BLD",3866,"KRN","B",.84,.84)

"BLD",3866,"KRN","B",3.6,3.6)

"BLD",3866,"KRN","B",3.8,3.8)

"BLD",3866,"KRN","B",9.2,9.2)

"BLD",3866,"KRN","B",9.8,9.8)

"BLD",3866,"KRN","B",19,19)

"BLD",3866,"KRN","B",19.1,19.1)

"BLD",3866,"KRN","B",101,101)

"BLD",3866,"KRN","B",409.61,409.61)

"BLD",3866,"KRN","B",771,771)

"BLD",3866,"KRN","B",870,870)

"BLD",3866,"KRN","B",8989.51,8989.51)

"BLD",3866,"KRN","B",8989.52,8989.52)

"BLD",3866,"KRN","B",8994,8994)

"BLD",3866,"QUES",0)
^9.62^^
"BLD",3866,"REQB",0)
^9.611^2^2
"BLD",3866,"REQB",1,0)
GMRC*3.0*22^2
"BLD",3866,"REQB",2,0)
GMRC*3.0*17^2
"BLD",3866,"REQB","B","GMRC*3.0*17",2)

"BLD",3866,"REQB","B","GMRC*3.0*22",1)

"KRN",19,8792,-1)
2^3
"KRN",19,8792,0)
GMRC IFC MGMT^IFC Management Menu^^M^1322^^^^^^^128
"KRN",19,8792,10,0)
^19.01IP^12^12
"KRN",19,8792,10,11,0)
9031^EP
"KRN",19,8792,10,11,"^")
GMRC IFC PARAMETER EDIT
"KRN",19,8792,10,12,0)
9030^AI
"KRN",19,8792,10,12,"^")
GMRC IFC INC RPT
"KRN",19,8792,"U")
IFC MANAGEMENT MENU
"KRN",19,9030,-1)
0^2
"KRN",19,9030,0)
GMRC IFC INC RPT^Print All Incomplete IFC Transactions^^A^^^^^^^^CONSULT/REQUEST TRACKING^^1^1
"KRN",19,9030,1,0)
^19.06^2^2^3020827^^
"KRN",19,9030,1,1,0)
This option will print all incomplete IFC transactions sorted by Consult 
"KRN",19,9030,1,2,0)
number.
"KRN",19,9030,15)
K DIC,BY,FR,TO,FLDS,DHD,DHIT
"KRN",19,9030,20)
S DIC="^GMR(123.6,",BY=".06,.04",FR=1,TO=1,FLDS="[CAPTIONED]",DHIT="D EN^DDIOL("" "")",DHD="Incomplete IFC Transaction Report" D EN1^DIP
"KRN",19,9030,"U")
PRINT ALL INCOMPLETE IFC TRANS
"KRN",19,9031,-1)
0^1
"KRN",19,9031,0)
GMRC IFC PARAMETER EDIT^Edit IFC Processing Parameters^^A^^^^^^^^CONSULT/REQUEST TRACKING^^1
"KRN",19,9031,1,0)
^19.06^2^2^3020821^^
"KRN",19,9031,1,1,0)
This option allows the editing of parameters related to the processing of 
"KRN",19,9031,1,2,0)
Inter-facility Consult requests.
"KRN",19,9031,20)
D TED^XPAREDIT("GMRC IFC PARAMETERS","B")
"KRN",19,9031,"U")
EDIT IFC PROCESSING PARAMETERS
"KRN",8989.51,226,-1)
0^1
"KRN",8989.51,226,0)
GMRC IFC ALERT IMMED ON PT ERR^Alert CLIN group immed. on pt. err^0^^Alert CLIN group
"KRN",8989.51,226,1)
Y
"KRN",8989.51,226,6)
N
"KRN",8989.51,226,20,0)
^8989.512^6^6^3020814^
"KRN",8989.51,226,20,1,0)
This parameter controls whether the IFC CLIN ERRORS GROUP at the 
"KRN",8989.51,226,20,2,0)
requesting site is notified immediately of patient information errors at 
"KRN",8989.51,226,20,3,0)
the consulting site.  If set to yes, this group will be alerted every 
"KRN",8989.51,226,20,4,0)
time an Unknown Patient error is returned from the consulting site. If 
"KRN",8989.51,226,20,5,0)
set to No, this group is only notified if the problem is unresolved after
"KRN",8989.51,226,20,6,0)
5 re-transmissions.
"KRN",8989.51,226,30,0)
^8989.513I^1^1
"KRN",8989.51,226,30,1,0)
1^4.2
"KRN",8989.51,228,-1)
0^2
"KRN",8989.51,228,0)
GMRC IFC SKIP WEEKEND RE-TRANS^Skip IFC re-transmissions on weekends^0^^Skip weekends
"KRN",8989.51,228,1)
Y
"KRN",8989.51,228,30,0)
^8989.513I^1^1
"KRN",8989.51,228,30,1,0)
1^4.2
"KRN",8989.51,4751,0)
GMRC RETAIN IFC ACTIVITY DAYS^Days to retain complete IFC transactions^0^^Retention days
"KRN",8989.51,4751,1)
N^7:180^Enter the number of days (7-180) to retain completed transactions
"KRN",8989.51,4751,6)
N
"KRN",8989.51,4751,20,0)
^8989.512^6^6^3020227^^
"KRN",8989.51,4751,20,1,0)
This parameter controls the number of days that completed Inter-facility 
"KRN",8989.51,4751,20,2,0)
Consult transactions are maintained in the IFC MESSAGE LOG (#123.6) file.
"KRN",8989.51,4751,20,3,0)
 
"KRN",8989.51,4751,20,4,0)
Completed transactions represent Consult activities transmitted to a
"KRN",8989.51,4751,20,5,0)
remote facility via HL7 which have been responded to with no error 
"KRN",8989.51,4751,20,6,0)
condition.
"KRN",8989.51,4751,30,0)
^8989.513I^1^1
"KRN",8989.51,4751,30,1,0)
1^4.2
"KRN",8989.52,155,-1)
0^1
"KRN",8989.52,155,0)
GMRC IFC PARAMETERS^Configure IFC parameters^4.2
"KRN",8989.52,155,10,0)
^8989.521IA^3^3
"KRN",8989.52,155,10,1,0)
10^GMRC RETAIN IFC ACTIVITY DAYS
"KRN",8989.52,155,10,2,0)
20^GMRC IFC ALERT IMMED ON PT ERR
"KRN",8989.52,155,10,3,0)
30^GMRC IFC SKIP WEEKEND RE-TRANS
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"ORD",21,8989.52)
8989.52;21;1;;PAR2E1^XPDTA2;PAR2F1^XPDIA3;PAR2E1^XPDIA3;PAR2F2^XPDIA3
"ORD",21,8989.52,0)
PARAMETER TEMPLATE
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^13
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
28^3021101
"PKG",128,22,1,"PAH",1,1,0)
^^2^2^3021101
"PKG",128,22,1,"PAH",1,1,1,0)
Check the National Patch Module for complete details of enhancements 
"PKG",128,22,1,"PAH",1,1,2,0)
provided in this patch. 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","GMRCIAC2")
0^4^B37912108
"RTN","GMRCIAC2",1,0)
GMRCIAC2 ;SLC/JFR - FILE IFC ACTIVITIES CONT'D ;09/05/02 10:48
"RTN","GMRCIAC2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCIAC2",3,0)
 Q  ;can't start here
"RTN","GMRCIAC2",4,0)
FILRES(GMRCO,GMRCOBX) ;file or delete results
"RTN","GMRCIAC2",5,0)
 N GMRCRES,GMRCFIL,GMRCSITE,GMRCROOT,RESIEN,GMRCERR
"RTN","GMRCIAC2",6,0)
 S GMRCRES=+$P(GMRCOBX,"|",5)
"RTN","GMRCIAC2",7,0)
 S GMRCFIL=$P($P(GMRCOBX,"|",3),U,3)
"RTN","GMRCIAC2",8,0)
 S GMRCROOT=$S($P($P(GMRCOBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",9,0)
 S GMRCFIL=$P(GMRCFIL,"VA",2)
"RTN","GMRCIAC2",10,0)
 S GMRCRES=GMRCRES_";"_GMRCROOT_GMRCFIL
"RTN","GMRCIAC2",11,0)
 S GMRCSITE=$$IEN^XUAF4($P($P(GMRCOBX,"|",5),U,3))
"RTN","GMRCIAC2",12,0)
 I $P(GMRCOBX,"|",11)'="D" D  ;add new result
"RTN","GMRCIAC2",13,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.01)=$$NOW^XLFDT
"RTN","GMRCIAC2",14,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.02)=GMRCRES
"RTN","GMRCIAC2",15,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.03)=GMRCSITE
"RTN","GMRCIAC2",16,0)
 I $P(GMRCOBX,"|",11)="D" D  ; find and delete result
"RTN","GMRCIAC2",17,0)
 . N RESIEN
"RTN","GMRCIAC2",18,0)
 . S RESIEN=$O(^GMR(123,GMRCO,51,"AR",GMRCRES,GMRCSITE,0))
"RTN","GMRCIAC2",19,0)
 . I 'RESIEN Q
"RTN","GMRCIAC2",20,0)
 . S FDA(1,123.051,RESIEN_","_GMRCO_",",.01)="@"
"RTN","GMRCIAC2",21,0)
 I '$D(FDA) Q
"RTN","GMRCIAC2",22,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC2",23,0)
 Q
"RTN","GMRCIAC2",24,0)
 ;
"RTN","GMRCIAC2",25,0)
UPDORD(GMRCDA,GMRC40) ; update CPRS order if action on placer order.
"RTN","GMRCIAC2",26,0)
 ; Input:
"RTN","GMRCIAC2",27,0)
 ;  GMRCDA   = ien from file 123
"RTN","GMRCIAC2",28,0)
 ;  GMRC40 = ien of activity in 40 multiple
"RTN","GMRCIAC2",29,0)
 ;
"RTN","GMRCIAC2",30,0)
 N GMRCDFN,GMRCAD,AC,GMRCOC,GMRCMT
"RTN","GMRCIAC2",31,0)
 S GMRCDFN=$P(^GMR(123,GMRCDA,0),U,2)
"RTN","GMRCIAC2",32,0)
 I $O(^GMR(123,GMRCDA,40,GMRC40,1,0)) D
"RTN","GMRCIAC2",33,0)
 . S GMRCMT=1,GMRCMT(0)=GMRC40
"RTN","GMRCIAC2",34,0)
 S GMRCAD=$P(^GMR(123,GMRCDA,40,GMRC40,0),U,3)
"RTN","GMRCIAC2",35,0)
 S AC=$P(^GMR(123,GMRCDA,40,GMRC40,0),U,2)
"RTN","GMRCIAC2",36,0)
 S GMRCOC=$S(AC=6:"OD",AC=19:"OC",AC=10:"RE",AC=9:"RE",AC=8:"ZC",1:"SC")
"RTN","GMRCIAC2",37,0)
 D EN^GMRCHL7(GMRCDFN,GMRCDA,"","",GMRCOC,"","",.GMRCMT,,GMRCAD)
"RTN","GMRCIAC2",38,0)
 Q
"RTN","GMRCIAC2",39,0)
FILEACT(GMRCO,GMRCLAST,GMRCFR,GMRCAR) ;file REQUEST PROCESSING ACTIVITY 
"RTN","GMRCIAC2",40,0)
 ; Input:
"RTN","GMRCIAC2",41,0)
 ;  GMRCO     = ien from file 123
"RTN","GMRCIAC2",42,0)
 ;  GMRCLAST  = last action taken on request
"RTN","GMRCIAC2",43,0)
 ;  GMRCFR    = service that consult was forwarded from
"RTN","GMRCIAC2",44,0)
 ;  GMRCAR    = name of the array containing the message
"RTN","GMRCIAC2",45,0)
 ;
"RTN","GMRCIAC2",46,0)
 N GMRCORC,GMRCFDA,GMRCRP,GMRCEP,GMRCACT,GMRCERR,FDA
"RTN","GMRCIAC2",47,0)
 M ^TMP("GMRCFIL",$J)=@GMRCAR
"RTN","GMRCIAC2",48,0)
 S GMRCORC=^TMP("GMRCFIL",$J,"ORC")
"RTN","GMRCIAC2",49,0)
 S GMRCFDA(.01)=$$NOW^XLFDT
"RTN","GMRCIAC2",50,0)
 S GMRCFDA(.25)=$$HL7TFM^XLFDT($P(GMRCORC,"|",9))
"RTN","GMRCIAC2",51,0)
 S GMRCFDA(1)=GMRCLAST
"RTN","GMRCIAC2",52,0)
 S GMRCFDA(2)=$$HL7TFM^XLFDT($P(GMRCORC,"|",15))
"RTN","GMRCIAC2",53,0)
 D  ;get entering and responsible persons
"RTN","GMRCIAC2",54,0)
 . D UNHLNAME^GMRCIUTL($P(GMRCORC,"|",10),.GMRCEP,1,U)
"RTN","GMRCIAC2",55,0)
 . D UNHLNAME^GMRCIUTL($P(GMRCORC,"|",12),.GMRCRP,1,U)
"RTN","GMRCIAC2",56,0)
 S GMRCFDA(.21)=GMRCEP
"RTN","GMRCIAC2",57,0)
 S GMRCFDA(.22)=GMRCRP
"RTN","GMRCIAC2",58,0)
 S GMRCFDA(.23)=$P($G(^TMP("GMRCFIL",$J,"OBX",5,1)),"|",5)
"RTN","GMRCIAC2",59,0)
 I $D(GMRCFR) S GMRCFDA(.31)=GMRCFR
"RTN","GMRCIAC2",60,0)
 I $D(^TMP("GMRCFIL",$J,"OBX",4)) D
"RTN","GMRCIAC2",61,0)
 . N RFIL,RSLT,DESC,GMRCOBX,ROOT,RSITE
"RTN","GMRCIAC2",62,0)
 . S GMRCOBX=^TMP("GMRCFIL",$J,"OBX",4,1)
"RTN","GMRCIAC2",63,0)
 . S RFIL=$P($P(GMRCOBX,"|",3),U,3),RFIL=$P(RFIL,"VA",2)
"RTN","GMRCIAC2",64,0)
 . S RSLT=+$P(GMRCOBX,"|",5)
"RTN","GMRCIAC2",65,0)
 . S RSITE=$$IEN^XUAF4($P($P(GMRCOBX,"|",5),U,3))
"RTN","GMRCIAC2",66,0)
 . S ROOT=$S($P($P(GMRCOBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",67,0)
 . S DESC=$P($P(GMRCOBX,"|",5),U,2)
"RTN","GMRCIAC2",68,0)
 . S GMRCFDA(.24)=RSLT_";"_ROOT_RFIL_";"_DESC_";"_RSITE
"RTN","GMRCIAC2",69,0)
 I GMRCLAST=10 D  ; overwite inc. report in last action?
"RTN","GMRCIAC2",70,0)
 . N GMRCLACT
"RTN","GMRCIAC2",71,0)
 . S GMRCLACT=$O(^GMR(123,GMRCO,40," "),-1)
"RTN","GMRCIAC2",72,0)
 . I '$G(GMRCLACT) Q
"RTN","GMRCIAC2",73,0)
 . I $P($G(^GMR(123,GMRCO,40,GMRCLACT,0)),U,2)'=9 Q
"RTN","GMRCIAC2",74,0)
 . I $$FMDIFF^XLFDT($$NOW^XLFDT,+^GMR(123,GMRCO,40,GMRCLACT,0),2)>900 Q
"RTN","GMRCIAC2",75,0)
 . I $P($G(^GMR(123,GMRCO,40,GMRCLACT,2)),U,4)=GMRCFDA(.24) D
"RTN","GMRCIAC2",76,0)
 .. S GMRCACT(1)=GMRCLACT
"RTN","GMRCIAC2",77,0)
 .. M FDA(1,123.02,GMRCACT(1)_","_GMRCO_",")=GMRCFDA
"RTN","GMRCIAC2",78,0)
 .. D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC2",79,0)
 . Q
"RTN","GMRCIAC2",80,0)
 I '$D(GMRCACT(1)) D  ; need to create new activity
"RTN","GMRCIAC2",81,0)
 . M FDA(1,123.02,"+1,"_GMRCO_",")=GMRCFDA
"RTN","GMRCIAC2",82,0)
 . D UPDATE^DIE("","FDA(1)","GMRCACT","GMRCERR")
"RTN","GMRCIAC2",83,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC2",84,0)
 D  ; file comments if present
"RTN","GMRCIAC2",85,0)
 . I $D(^TMP("GMRCFIL",$J,"OBX",3)) D  ; general comments
"RTN","GMRCIAC2",86,0)
 .. N TMPARR
"RTN","GMRCIAC2",87,0)
 .. S TMPARR=$NA(^TMP("GMRCFIL",$J,"OBX",3))
"RTN","GMRCIAC2",88,0)
 .. D TRIMWP^GMRCIUTL(TMPARR,5)
"RTN","GMRCIAC2",89,0)
 .. D WP^DIE(123.02,GMRCACT(1)_","_GMRCO_",",5,"K",TMPARR)
"RTN","GMRCIAC2",90,0)
 . I $D(^TMP("GMRCFIL",$J,"NTE")) D  ; DC or cancel comments
"RTN","GMRCIAC2",91,0)
 .. N TMPARR
"RTN","GMRCIAC2",92,0)
 .. S TMPARR=$NA(^TMP("GMRCFIL",$J,"NTE"))
"RTN","GMRCIAC2",93,0)
 .. D TRIMWP^GMRCIUTL(TMPARR,3)
"RTN","GMRCIAC2",94,0)
 .. D WP^DIE(123.02,GMRCACT(1)_","_GMRCO_",",5,"K",TMPARR)
"RTN","GMRCIAC2",95,0)
 .. Q
"RTN","GMRCIAC2",96,0)
 D  ; update order if necessary
"RTN","GMRCIAC2",97,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" Q  ; fillers have no order
"RTN","GMRCIAC2",98,0)
 . I GMRCLAST=11!(GMRCLAST=13)!(GMRCLAST=14) Q  ;no status chg
"RTN","GMRCIAC2",99,0)
 . I GMRCLAST=4!(GMRCLAST=20) Q  ;no status chg
"RTN","GMRCIAC2",100,0)
 . D UPDORD(GMRCO,GMRCACT(1))
"RTN","GMRCIAC2",101,0)
 K ^TMP("GMRCFIL",$J)
"RTN","GMRCIAC2",102,0)
 Q
"RTN","GMRCIAC2",103,0)
 ;
"RTN","GMRCIAC2",104,0)
TST(ARRAY) ;process test message and check item ordered
"RTN","GMRCIAC2",105,0)
 ;Input:
"RTN","GMRCIAC2",106,0)
 ; ARRAY  = name of array containing message parts
"RTN","GMRCIAC2",107,0)
 ;
"RTN","GMRCIAC2",108,0)
 N GMRCFDA,GMRCORC,GMRCDA,GMRCITM,GMRCITER
"RTN","GMRCIAC2",109,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC2",110,0)
 M ^TMP("GMRCIN",$J)=@ARRAY
"RTN","GMRCIAC2",111,0)
 D  ;get ordered item and service
"RTN","GMRCIAC2",112,0)
 . S GMRCITM=$P(^TMP("GMRCIN",$J,"OBR"),"|",4)
"RTN","GMRCIAC2",113,0)
 . I GMRCITM["VA1233" D  ; proc
"RTN","GMRCIAC2",114,0)
 .. N PROC
"RTN","GMRCIAC2",115,0)
 .. S PROC=$$GETPROC^GMRCIUTL(GMRCITM)
"RTN","GMRCIAC2",116,0)
 .. I +PROC'>0!('$P(PROC,U,2)) S GMRCITER=$P(PROC,U,3) Q
"RTN","GMRCIAC2",117,0)
 . I GMRCITM["VA1235" D
"RTN","GMRCIAC2",118,0)
 .. N SERV
"RTN","GMRCIAC2",119,0)
 .. S SERV=$$GETSERV^GMRCIUTL(GMRCITM) ;consult
"RTN","GMRCIAC2",120,0)
 .. I +SERV'>0 S GMRCITER=$P(SERV,U,3)
"RTN","GMRCIAC2",121,0)
 I $D(GMRCITER) D  ;error in procedure or service, reject new order
"RTN","GMRCIAC2",122,0)
 . N GMRCRSLT
"RTN","GMRCIAC2",123,0)
 . D RESP^GMRCIUTL("AR",HL("MID"),,,GMRCITER) ;build HLA(
"RTN","GMRCIAC2",124,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",125,0)
 I '$D(GMRCITER) D
"RTN","GMRCIAC2",126,0)
 . N GMRCRSLT
"RTN","GMRCIAC2",127,0)
 . D RESP^GMRCIUTL("AA",HL("MID")) ;build HLA(
"RTN","GMRCIAC2",128,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",129,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC2",130,0)
 Q
"RTN","GMRCIAC2",131,0)
 ;
"RTN","GMRCIAC2",132,0)
GETDA(GMRCORC) ; determine what local Consult ien to work on
"RTN","GMRCIAC2",133,0)
 ; Input:
"RTN","GMRCIAC2",134,0)
 ;  GMRCORC = ORC seg from incoming message
"RTN","GMRCIAC2",135,0)
 ; Output:
"RTN","GMRCIAC2",136,0)
 ;  ien from file 123
"RTN","GMRCIAC2",137,0)
 ;
"RTN","GMRCIAC2",138,0)
 N GMRCORC2,GMRCORC3
"RTN","GMRCIAC2",139,0)
 S GMRCORC2=$P(GMRCORC,"|",2),GMRCORC3=$P(GMRCORC,"|",3)
"RTN","GMRCIAC2",140,0)
 I $$IEN^XUAF4($P(GMRCORC2,U,2))=$$KSP^XUPARAM("INST") Q +GMRCORC2
"RTN","GMRCIAC2",141,0)
 Q +GMRCORC3
"RTN","GMRCIAC2",142,0)
 ;
"RTN","GMRCIAC2",143,0)
DUPACT(GMRCO,ACTVT,ORC,OBX) ;check to see if activity is a dup transmission
"RTN","GMRCIAC2",144,0)
 ;Input:
"RTN","GMRCIAC2",145,0)
 ;  GMRCO = ien of consult
"RTN","GMRCIAC2",146,0)
 ;  ACTVT = ien of activity from file 123.1
"RTN","GMRCIAC2",147,0)
 ;  ORC   = ORC segment from message
"RTN","GMRCIAC2",148,0)
 ;  OBX   = OBX segment containing result
"RTN","GMRCIAC2",149,0)
 ;
"RTN","GMRCIAC2",150,0)
 ;Output:
"RTN","GMRCIAC2",151,0)
 ;  0  = activity is not a duplicate of one on file already
"RTN","GMRCIAC2",152,0)
 ;  1  = duplicate, activity already on file
"RTN","GMRCIAC2",153,0)
 ;
"RTN","GMRCIAC2",154,0)
 N GMRCIADT,GMRCIFDT,DUP
"RTN","GMRCIAC2",155,0)
 S GMRCIFDT=+$$HL7TFM^XLFDT($P(ORC,"|",9))
"RTN","GMRCIAC2",156,0)
 S GMRCIADT=+$$HL7TFM^XLFDT($P(ORC,"|",15))
"RTN","GMRCIAC2",157,0)
 S DUP=0
"RTN","GMRCIAC2",158,0)
 I $D(^GMR(123,GMRCO,40,"AC",ACTVT,GMRCIFDT,GMRCIADT)) D  Q DUP ;dupl.
"RTN","GMRCIAC2",159,0)
 . N RSLT,RFIL,RSITE,ROOT
"RTN","GMRCIAC2",160,0)
 . I $L($G(OBX)) D  Q:'$G(DUP)
"RTN","GMRCIAC2",161,0)
 .. S RFIL=$P($P(OBX,"|",3),U,3),RFIL=$P(RFIL,"VA",2)
"RTN","GMRCIAC2",162,0)
 .. S RSLT=+$P(OBX,"|",5)
"RTN","GMRCIAC2",163,0)
 .. S RSITE=$$IEN^XUAF4($P($P(OBX,"|",5),U,3))
"RTN","GMRCIAC2",164,0)
 .. S ROOT=$S($P($P(OBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",165,0)
 .. S RSLT=RSLT_";"_ROOT_RFIL
"RTN","GMRCIAC2",166,0)
 .. I ACTVT=12,$D(^GMR(123,GMRCO,51,"AR",RSLT,RSITE)) Q  ;no dup
"RTN","GMRCIAC2",167,0)
 .. I ACTVT'=12,'$D(^GMR(123,GMRCO,51,"AR",RSLT,RSITE)) Q  ;no dup
"RTN","GMRCIAC2",168,0)
 .. S DUP=1
"RTN","GMRCIAC2",169,0)
 . S DUP=1
"RTN","GMRCIAC2",170,0)
 . D APPACK(GMRCO,"AR",802) ;send app. ACK and unlock record
"RTN","GMRCIAC2",171,0)
 Q 0
"RTN","GMRCIAC2",172,0)
 ;
"RTN","GMRCIAC2",173,0)
APPACK(GMRCO,ACK,ERR) ;send application acknowledgement for all cases
"RTN","GMRCIAC2",174,0)
 ;Input:
"RTN","GMRCIAC2",175,0)
 ;  GMRCO = ien from file 123
"RTN","GMRCIAC2",176,0)
 ;  ACK   = ACK code to include  ("AA"=accept or "AR"=reject)
"RTN","GMRCIAC2",177,0)
 ;  ERR   = error code to return if there is one (optional)
"RTN","GMRCIAC2",178,0)
 ;
"RTN","GMRCIAC2",179,0)
 ; Output: none
"RTN","GMRCIAC2",180,0)
 ;
"RTN","GMRCIAC2",181,0)
 ;send appl ACK
"RTN","GMRCIAC2",182,0)
 N GMRCRSLT
"RTN","GMRCIAC2",183,0)
 I '$G(ERR) S ERR=""
"RTN","GMRCIAC2",184,0)
 D RESP^GMRCIUTL(ACK,HL("MID"),,,ERR) ;build HLA("HLA", array
"RTN","GMRCIAC2",185,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",186,0)
 ;
"RTN","GMRCIAC2",187,0)
 D UNLKREC^GMRCUTL1(GMRCO) ;unlock record
"RTN","GMRCIAC2",188,0)
 Q
"RTN","GMRCIBKG")
0^3^B37488140
"RTN","GMRCIBKG",1,0)
GMRCIBKG ;SLC/JFR - IFC BACKGROUND ERROR PROCESSOR; 10/29/02 09:20
"RTN","GMRCIBKG",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCIBKG",3,0)
 ;
"RTN","GMRCIBKG",4,0)
 ; This routine invokes IA# 3335
"RTN","GMRCIBKG",5,0)
 ;
"RTN","GMRCIBKG",6,0)
EN ;process file 123.6 and take action
"RTN","GMRCIBKG",7,0)
 ;Start background process
"RTN","GMRCIBKG",8,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","GMRCIBKG",9,0)
 ;
"RTN","GMRCIBKG",10,0)
 ; OK to run?
"RTN","GMRCIBKG",11,0)
 I '$$GONOGO Q
"RTN","GMRCIBKG",12,0)
 ;
"RTN","GMRCIBKG",13,0)
 ; set start param to NOW and run
"RTN","GMRCIBKG",14,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND START",1,$$NOW^XLFDT)
"RTN","GMRCIBKG",15,0)
 ;
"RTN","GMRCIBKG",16,0)
 N GMRCLOG,GMRCTIM,GMRCLOG0
"RTN","GMRCIBKG",17,0)
 S GMRCLOG=0
"RTN","GMRCIBKG",18,0)
 S GMRCTIM=$$FMADD^XLFDT($$NOW^XLFDT,,-1)
"RTN","GMRCIBKG",19,0)
 F  S GMRCLOG=$O(^GMR(123.6,GMRCLOG)) Q:'GMRCLOG  D
"RTN","GMRCIBKG",20,0)
 . S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0))
"RTN","GMRCIBKG",21,0)
 . ;
"RTN","GMRCIBKG",22,0)
 . ;  v-- resend if couldn't update file immediately
"RTN","GMRCIBKG",23,0)
 . I $P(GMRCLOG0,U,6),$P(GMRCLOG0,U,8)=901 D  Q
"RTN","GMRCIBKG",24,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",25,0)
 . ;  v-- wait at least 1 hour on all other errors
"RTN","GMRCIBKG",26,0)
 . I $P(GMRCLOG0,U)>GMRCTIM Q
"RTN","GMRCIBKG",27,0)
 . ;  v-- if incomplete activity is now the earliest, resend it
"RTN","GMRCIBKG",28,0)
 . I $P(GMRCLOG0,U,6),$P(GMRCLOG0,U,8)=902 D  Q
"RTN","GMRCIBKG",29,0)
 .. Q:$O(^GMR(123.6,"AC",$P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)),-1)
"RTN","GMRCIBKG",30,0)
 .. D DELALRT(GMRCLOG)
"RTN","GMRCIBKG",31,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",32,0)
 . ; v-- delete complete entries after # in GMRC RETAIN IFC ACTIVITY DAYS
"RTN","GMRCIBKG",33,0)
 . I '$P(GMRCLOG0,U,6) D  Q
"RTN","GMRCIBKG",34,0)
 .. N DIK,DA,GMRCRETN
"RTN","GMRCIBKG",35,0)
 .. S GMRCRETN=$$GET^XPAR("SYS","GMRC RETAIN IFC ACTIVITY DAYS",1)
"RTN","GMRCIBKG",36,0)
 .. I 'GMRCRETN S GMRCRETN=7
"RTN","GMRCIBKG",37,0)
 .. I $P(GMRCLOG0,U)>$$FMADD^XLFDT(GMRCTIM,(0-GMRCRETN)) Q  ;don't delete
"RTN","GMRCIBKG",38,0)
 .. S DIK="^GMR(123.6,",DA=GMRCLOG
"RTN","GMRCIBKG",39,0)
 .. D ^DIK ;remove old completed entries
"RTN","GMRCIBKG",40,0)
 . ;
"RTN","GMRCIBKG",41,0)
 . ;  v-- resend unknown patient errors after 3 hours
"RTN","GMRCIBKG",42,0)
 . I $P(GMRCLOG0,U,8)=201,GMRCLOG0<$$FMADD^XLFDT($$NOW^XLFDT,,-3) D  Q
"RTN","GMRCIBKG",43,0)
 .. D  ;re-send based on parameter and day of week
"RTN","GMRCIBKG",44,0)
 ... N GMRCSND,GMRCPAR
"RTN","GMRCIBKG",45,0)
 ... S GMRCPAR=$$GET^XPAR("SYS","GMRC IFC SKIP WEEKEND RE-TRANS",1)
"RTN","GMRCIBKG",46,0)
 ... S GMRCSND=$S('GMRCPAR:1,$$DOW^XLFDT(DT)<6:1,1:0)
"RTN","GMRCIBKG",47,0)
 ... I GMRCSND D  ;re-send activity
"RTN","GMRCIBKG",48,0)
 .... D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5))
"RTN","GMRCIBKG",49,0)
 .. I '($P(GMRCLOG0,U,7)#8) D  ;alert CAC's about errors every 24 hrs.
"RTN","GMRCIBKG",50,0)
 ... D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",51,0)
 ... D SNDALRT^GMRCIERR(GMRCLOG,"C") ; alert CAC's to patient errors
"RTN","GMRCIBKG",52,0)
 ... D  ; send mail to remote CAC group
"RTN","GMRCIBKG",53,0)
 .... N GMRCLNK,GMRCIQT,HL,HLECH,HLFS,HLQ,PID,DOM,STA,GMRCLNK
"RTN","GMRCIBKG",54,0)
 .... D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIBKG",55,0)
 .... D  I $D(GMRCIQT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIBKG",56,0)
 ..... N GMRCDFN S GMRCDFN=$P(^GMR(123,+$P(GMRCLOG0,U,4),0),U,2)
"RTN","GMRCIBKG",57,0)
 ..... I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIBKG",58,0)
 ..... I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIBKG",59,0)
 ..... I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIBKG",60,0)
 ..... S PID=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIBKG",61,0)
 ..... S PID=$P(PID,"|",2,999)
"RTN","GMRCIBKG",62,0)
 .... D LINK^HLUTIL3($P(GMRCLOG0,U,2),.GMRCLNK)
"RTN","GMRCIBKG",63,0)
 .... S GMRCLNK=$O(GMRCLNK(0)) I 'GMRCLNK Q  ;no link set up
"RTN","GMRCIBKG",64,0)
 .... S DOM=$$GET1^DIQ(870,+GMRCLNK,.03)
"RTN","GMRCIBKG",65,0)
 .... S STA=$$STA^XUAF4($P(GMRCLOG0,U,2))
"RTN","GMRCIBKG",66,0)
 .... D PTERRMSG^GMRCIERR(PID,STA,DOM)
"RTN","GMRCIBKG",67,0)
 . ;
"RTN","GMRCIBKG",68,0)
 . ;  v-- resend local ICN errors after 3 hours
"RTN","GMRCIBKG",69,0)
 . I $P(GMRCLOG0,U,8)=202,GMRCLOG0<$$FMADD^XLFDT($$NOW^XLFDT,,-3) D  Q
"RTN","GMRCIBKG",70,0)
 .. ;re-send based on parameter and day of week
"RTN","GMRCIBKG",71,0)
 .. N GMRCSND,GMRCPAR
"RTN","GMRCIBKG",72,0)
 .. S GMRCPAR=$$GET^XPAR("SYS","GMRC IFC SKIP WEEKEND RE-TRANS",1)
"RTN","GMRCIBKG",73,0)
 .. S GMRCSND=$S('GMRCPAR:1,$$DOW^XLFDT(DT)<6:1,1:0)
"RTN","GMRCIBKG",74,0)
 .. I 'GMRCSND Q  ;don't re-send activity
"RTN","GMRCIBKG",75,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",76,0)
 .. I '($P(GMRCLOG0,U,7)#8) D  ;alert CAC's about errors every 24 hrs 
"RTN","GMRCIBKG",77,0)
 ... D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",78,0)
 ... D SNDALRT^GMRCIERR(GMRCLOG,"C") ; alert CAC's to patient errors
"RTN","GMRCIBKG",79,0)
 . ;  v-- re-process implementation errors
"RTN","GMRCIBKG",80,0)
 . I $P(GMRCLOG0,U,8)>300,$P(GMRCLOG0,U,8)<702 D  Q
"RTN","GMRCIBKG",81,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",82,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",83,0)
 . ;  v-- if incomplete and no error, alert tech group
"RTN","GMRCIBKG",84,0)
 . I '$P(GMRCLOG0,U,8)!($P(GMRCLOG0,U,8)>902) D  Q
"RTN","GMRCIBKG",85,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",86,0)
 .. D SNDALRT^GMRCIERR(GMRCLOG,"T")
"RTN","GMRCIBKG",87,0)
 . Q
"RTN","GMRCIBKG",88,0)
 ;
"RTN","GMRCIBKG",89,0)
 ;  v-- set finish param 
"RTN","GMRCIBKG",90,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1,$$NOW^XLFDT)
"RTN","GMRCIBKG",91,0)
 ;  v-- start it again one hour after completing
"RTN","GMRCIBKG",92,0)
 D REQUEUE
"RTN","GMRCIBKG",93,0)
 Q
"RTN","GMRCIBKG",94,0)
 ;
"RTN","GMRCIBKG",95,0)
REQUEUE ;task job to start up again one hour after completing
"RTN","GMRCIBKG",96,0)
 N ZTRTN,ZTSK,ZTIO,ZTDESC,ZTDTH
"RTN","GMRCIBKG",97,0)
 S ZTDESC="IF Consults background error processor"
"RTN","GMRCIBKG",98,0)
 S ZTIO=""
"RTN","GMRCIBKG",99,0)
 S ZTRTN="EN^GMRCIBKG"
"RTN","GMRCIBKG",100,0)
 S ZTDTH=$$FMTH^XLFDT($$FMADD^XLFDT($$NOW^XLFDT,,1))
"RTN","GMRCIBKG",101,0)
 D ^%ZTLOAD
"RTN","GMRCIBKG",102,0)
 Q
"RTN","GMRCIBKG",103,0)
DELALRT(MSGLOG) ;delete obsolete alerts for an entry
"RTN","GMRCIBKG",104,0)
 ; Input:
"RTN","GMRCIBKG",105,0)
 ;   MSGLOG = ien from file 123.6
"RTN","GMRCIBKG",106,0)
 ;
"RTN","GMRCIBKG",107,0)
 N XQAID,XQAKILL
"RTN","GMRCIBKG",108,0)
 S XQAID="GMRCIFC,trans error,"_MSGLOG,XQAKILL=0
"RTN","GMRCIBKG",109,0)
 D DELETEA^XQALERT
"RTN","GMRCIBKG",110,0)
 Q
"RTN","GMRCIBKG",111,0)
 ;
"RTN","GMRCIBKG",112,0)
OVERDUE ; write message for alert to tell IRM job is overdue
"RTN","GMRCIBKG",113,0)
 W @IOF
"RTN","GMRCIBKG",114,0)
 W !,"The Inter-facility Consults background job is overdue."
"RTN","GMRCIBKG",115,0)
 W !,"This is likely due to an error while the job runs. It is suggested"
"RTN","GMRCIBKG",116,0)
 W !,"that you check the systems for errors. If the errors are resolved"
"RTN","GMRCIBKG",117,0)
 W !,"the background job will catch up and run normally. There is a "
"RTN","GMRCIBKG",118,0)
 W !,"remote possibility that the GMRC IFC BACKGROUND... parameters have"
"RTN","GMRCIBKG",119,0)
 W !,"been edited and are out of synch."
"RTN","GMRCIBKG",120,0)
 S XQAKILL=0
"RTN","GMRCIBKG",121,0)
 Q
"RTN","GMRCIBKG",122,0)
 ;
"RTN","GMRCIBKG",123,0)
GONOGO() ; determine if background job should run or not
"RTN","GMRCIBKG",124,0)
 ;Output: 
"RTN","GMRCIBKG",125,0)
 ;  1 = go ahead and run
"RTN","GMRCIBKG",126,0)
 ;  0 = don't run for some reason
"RTN","GMRCIBKG",127,0)
 N GMRCQT
"RTN","GMRCIBKG",128,0)
 S GMRCQT=1
"RTN","GMRCIBKG",129,0)
 D
"RTN","GMRCIBKG",130,0)
 . N GMRCBST,GMRCNOW,GMRCBFI
"RTN","GMRCIBKG",131,0)
 . S GMRCBST=$$GET^XPAR("SYS","GMRC IFC BACKGROUND START",1)
"RTN","GMRCIBKG",132,0)
 . I 'GMRCBST Q  ; has never run or needs to
"RTN","GMRCIBKG",133,0)
 . S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCIBKG",134,0)
 . I GMRCBST>GMRCNOW S GMRCQT=0 Q  ;set to future date/time - don't run
"RTN","GMRCIBKG",135,0)
 . S GMRCBFI=$$GET^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1)
"RTN","GMRCIBKG",136,0)
 . I $$FMDIFF^XLFDT(GMRCNOW,GMRCBFI,2)<3600,GMRCBFI>GMRCBST S GMRCQT=0 Q
"RTN","GMRCIBKG",137,0)
 . ;                 ^--ran < 1 hr ago
"RTN","GMRCIBKG",138,0)
 . I $$FMDIFF^XLFDT(GMRCBST,GMRCBFI,2)>4500 D  Q
"RTN","GMRCIBKG",139,0)
 .. ; >1.5 hrs and job not finishing for some reason, alert techies
"RTN","GMRCIBKG",140,0)
 .. N XQA,XQAMSG,XQAROU,XQAID,XQAKILL
"RTN","GMRCIBKG",141,0)
 .. S XQAID="GMRC IFC BKG",XQAKILL=0 D DELETEA^XQALERT
"RTN","GMRCIBKG",142,0)
 .. S XQA("G.IFC TECH ERRORS")=""
"RTN","GMRCIBKG",143,0)
 .. S XQAMSG="IFC Background job overdue."
"RTN","GMRCIBKG",144,0)
 .. S XQAID="GMRC IFC BKG"
"RTN","GMRCIBKG",145,0)
 .. S XQAROU="OVERDUE^GMRCIBKG"
"RTN","GMRCIBKG",146,0)
 .. D SETUP^XQALERT
"RTN","GMRCIBKG",147,0)
 .. Q
"RTN","GMRCIBKG",148,0)
 . Q
"RTN","GMRCIBKG",149,0)
 Q GMRCQT
"RTN","GMRCIERR")
0^6^B66228788
"RTN","GMRCIERR",1,0)
GMRCIERR ;SLC/JFR - process IFC message error alert ;10/22/02 14:16
"RTN","GMRCIERR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCIERR",3,0)
EN(GMRCLOG,GMRCDA,GMRCACT,GMRCRPT) ;start here
"RTN","GMRCIERR",4,0)
 ;Build ^TMP array for processing alert
"RTN","GMRCIERR",5,0)
 ;
"RTN","GMRCIERR",6,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCIERR",7,0)
 N GMRCPNM,GMRCACTV,GMRCERR,GMRCRP,GMRCEP,GMRCACTM,GMRCCOM,GMRCSS
"RTN","GMRCIERR",8,0)
 N GMRCPROC,GMRCSITE,GMRCFCN,GMRCPT,GMRCSSN,VAHOW,VAROOT
"RTN","GMRCIERR",9,0)
 I '$D(^GMR(123.6,GMRCLOG,0)) D  Q
"RTN","GMRCIERR",10,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry no longer exists"
"RTN","GMRCIERR",11,0)
 I $P(^GMR(123.6,GMRCLOG,0),U,4)'=GMRCDA D  Q
"RTN","GMRCIERR",12,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry and Consult# don't match"
"RTN","GMRCIERR",13,0)
 I $P(^GMR(123.6,GMRCLOG,0),U,5)'=GMRCACT D  Q
"RTN","GMRCIERR",14,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry & activity# don't match"
"RTN","GMRCIERR",15,0)
 S DFN=$P(^GMR(123,GMRCDA,0),U,2),VAROOT="GMRCPT",VAHOW=1
"RTN","GMRCIERR",16,0)
 D DEM^VADPT
"RTN","GMRCIERR",17,0)
 S GMRCPNM=GMRCPT("NM")
"RTN","GMRCIERR",18,0)
 S GMRCSSN=$P(GMRCPT("SS"),U,2)
"RTN","GMRCIERR",19,0)
 S GMRCACTV=$G(^GMR(123,GMRCDA,40,GMRCACT,0))
"RTN","GMRCIERR",20,0)
 S GMRCRP=$$GET1^DIQ(200,+$P(GMRCACTV,U,4),.01)
"RTN","GMRCIERR",21,0)
 S GMRCEP=$$GET1^DIQ(200,+$P(GMRCACTV,U,5),.01)
"RTN","GMRCIERR",22,0)
 S GMRCACTM=$$FMTE^XLFDT($P(GMRCACTV,U,3))
"RTN","GMRCIERR",23,0)
 S GMRCACTV=$$GET1^DIQ(123.1,$P(GMRCACTV,U,2),.01)
"RTN","GMRCIERR",24,0)
 S GMRCCOM=$O(^GMR(123,GMRCDA,40,GMRCACT,1,0))
"RTN","GMRCIERR",25,0)
 S GMRCSS=$$GET1^DIQ(123.5,+$P(^GMR(123,GMRCDA,0),U,5),.01)
"RTN","GMRCIERR",26,0)
 S GMRCPROC=$$GET1^DIQ(123.3,+$P(^GMR(123,GMRCDA,0),U,8),.01)
"RTN","GMRCIERR",27,0)
 S GMRCFCN=$P(^GMR(123,GMRCDA,0),U,22)
"RTN","GMRCIERR",28,0)
 D F4^XUAF4($$STA^XUAF4($P(^GMR(123,GMRCDA,0),U,23)),.GMRCSITE)
"RTN","GMRCIERR",29,0)
 N LN S LN=1
"RTN","GMRCIERR",30,0)
 S ^TMP("GMRCIERR",$J,LN,0)="An error occurred transmitting the following inter-facility consult ",LN=LN+1
"RTN","GMRCIERR",31,0)
 S ^TMP("GMRCIERR",$J,LN,0)="activity to "_GMRCSITE("NAME")_":",LN=LN+1
"RTN","GMRCIERR",32,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",33,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Consult #: "_GMRCDA,LN=LN+1
"RTN","GMRCIERR",34,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Remote Consult #: "_GMRCFCN,LN=LN+1
"RTN","GMRCIERR",35,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Patient Name: "_GMRCPNM,LN=LN+1
"RTN","GMRCIERR",36,0)
 S ^TMP("GMRCIERR",$J,LN,0)="SSN: "_GMRCSSN,LN=LN+1
"RTN","GMRCIERR",37,0)
 S ^TMP("GMRCIERR",$J,LN,0)="To Service: "_GMRCSS,LN=LN+1
"RTN","GMRCIERR",38,0)
 I $L(GMRCPROC) S ^TMP("GMRCIERR",$J,LN,0)="Procedure: "_GMRCPROC,LN=LN+1
"RTN","GMRCIERR",39,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",40,0)
 I '$D(GMRCRPT) D ACTLG(GMRCDA,GMRCACT,GMRCLOG,.LN)
"RTN","GMRCIERR",41,0)
 Q
"RTN","GMRCIERR",42,0)
ACTLG(GMRCDA,GMRCACT,LOG,LN) ;build activity log entry
"RTN","GMRCIERR",43,0)
 N GMRCCT,TAB,GMRCERR,GMRCDIF
"RTN","GMRCIERR",44,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCIERR",45,0)
 S GMRCERR=$T(@("ERR"_$P(^GMR(123.6,LOG,0),U,8)_"^GMRCIUTL"))
"RTN","GMRCIERR",46,0)
 S GMRCERR=$S($L(GMRCERR):$P(GMRCERR,";",2),1:"Technical error")
"RTN","GMRCIERR",47,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Activity #: "_GMRCACT,LN=LN+1
"RTN","GMRCIERR",48,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Activity"_$E(TAB,1,17)_"Date/Time/Zone"_$E(TAB,1,6)_"Responsible Person"_$E(TAB,1,2)_"Entered By",LN=LN+1
"RTN","GMRCIERR",49,0)
 S GMRCCT=LN
"RTN","GMRCIERR",50,0)
 D BLDALN^GMRCSLM4(GMRCDA,GMRCACT)
"RTN","GMRCIERR",51,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",52,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",53,0)
 S ^TMP("GMRCIERR",$J,LN,0)="The error was: "_GMRCERR
"RTN","GMRCIERR",54,0)
 M ^TMP("GMRCIERR",$J)=^TMP("GMRCR",$J,"DT")
"RTN","GMRCIERR",55,0)
 K ^TMP("GMRCR",$J,"DT")
"RTN","GMRCIERR",56,0)
 Q
"RTN","GMRCIERR",57,0)
 ;
"RTN","GMRCIERR",58,0)
DIALOG(GMRCDATA) ;ask user what to do based on error and activity
"RTN","GMRCIERR",59,0)
 ;Input:
"RTN","GMRCIERR",60,0)
 ;  GMRCDATA  = XQADATA from alert handler
"RTN","GMRCIERR",61,0)
 ;      in form:   IFC_msg_log#|consult#|activity#
"RTN","GMRCIERR",62,0)
 ;
"RTN","GMRCIERR",63,0)
 ;Output:
"RTN","GMRCIERR",64,0)
 ;  value to set XQAKILL to
"RTN","GMRCIERR",65,0)
 N DIR,X,Y,LN,DUOUT,DTOUT
"RTN","GMRCIERR",66,0)
 D EN($P(GMRCDATA,"|"),$P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3))
"RTN","GMRCIERR",67,0)
 W @IOF
"RTN","GMRCIERR",68,0)
 S LN=0 F  S LN=$O(^TMP("GMRCIERR",$J,LN)) Q:'LN  W !,^(LN,0)
"RTN","GMRCIERR",69,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCIERR",70,0)
 W !
"RTN","GMRCIERR",71,0)
 I $O(^TMP("GMRCIERR",$J," "),-1)<2 Q 0 ;some problem so delete alert
"RTN","GMRCIERR",72,0)
 S DIR(0)="E" D ^DIR
"RTN","GMRCIERR",73,0)
 I $D(DTOUT)!($D(DUOUT)) Q "@"
"RTN","GMRCIERR",74,0)
 W !
"RTN","GMRCIERR",75,0)
 I $O(^GMR(123.6,"AC",$P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3)),-1) D  Q "@"
"RTN","GMRCIERR",76,0)
 . W !,"There is at least one earlier incomplete transaction for this"
"RTN","GMRCIERR",77,0)
 . W !,"consult, all incomplete transactions should be processed in "
"RTN","GMRCIERR",78,0)
 . W !,"order.",!
"RTN","GMRCIERR",79,0)
 . W !,"You can use the List incomplete IFC transactions option to"
"RTN","GMRCIERR",80,0)
 . W !,"locate and process the incomplete transactions for this consult."
"RTN","GMRCIERR",81,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCIERR",82,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",83,0)
 S DIR("A",1)="If you have corrected this problem you may resend this activity!"
"RTN","GMRCIERR",84,0)
 S DIR("A",2)=" "
"RTN","GMRCIERR",85,0)
 S DIR("A")="Do you want to retransmit this? " D ^DIR
"RTN","GMRCIERR",86,0)
 I $G(Y)=1 D  Q 0
"RTN","GMRCIERR",87,0)
 . D TRIGR^GMRCIEVT($P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3))
"RTN","GMRCIERR",88,0)
 K DIR
"RTN","GMRCIERR",89,0)
 W !
"RTN","GMRCIERR",90,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",91,0)
 S DIR("A")="Do you want to delete this alert for yourself? "
"RTN","GMRCIERR",92,0)
 D ^DIR
"RTN","GMRCIERR",93,0)
 I $G(Y)=1 Q 1
"RTN","GMRCIERR",94,0)
 Q "@"
"RTN","GMRCIERR",95,0)
 ;
"RTN","GMRCIERR",96,0)
FOLLUP ;action to take from alert
"RTN","GMRCIERR",97,0)
 S XQAKILL=$$DIALOG(XQADATA)
"RTN","GMRCIERR",98,0)
 I XQAKILL="@" K XQAKILL
"RTN","GMRCIERR",99,0)
 Q
"RTN","GMRCIERR",100,0)
 ;
"RTN","GMRCIERR",101,0)
SNDALRT(GMRCLOG,TYPE,XQAMSG) ; send an alert on some errors
"RTN","GMRCIERR",102,0)
 ;Input:
"RTN","GMRCIERR",103,0)
 ; GMRCLOG = IFC MESSAGE LOG entry
"RTN","GMRCIERR",104,0)
 ; TYPE    = "C" for a clinical error, "T" for a technical error
"RTN","GMRCIERR",105,0)
 ;
"RTN","GMRCIERR",106,0)
 N XQA,XQAROU,XQADATA,XQAID,GROUP,GMRCACT,GMRCDA,GMRCLOG0
"RTN","GMRCIERR",107,0)
 S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0)) Q:'$L(GMRCLOG0)
"RTN","GMRCIERR",108,0)
 S GMRCDA=$P(GMRCLOG0,U,4) Q:'GMRCDA
"RTN","GMRCIERR",109,0)
 S GMRCACT=$P(GMRCLOG0,U,5) Q:'GMRCACT
"RTN","GMRCIERR",110,0)
 S GROUP=$S(TYPE="C":"G.IFC CLIN ERRORS",1:"G.IFC TECH ERRORS")
"RTN","GMRCIERR",111,0)
 S XQA(GROUP)=""
"RTN","GMRCIERR",112,0)
 I '$D(XQAMSG) S XQAMSG="Failed IFC transaction"
"RTN","GMRCIERR",113,0)
 S XQAROU="FOLLUP^GMRCIERR"
"RTN","GMRCIERR",114,0)
 S XQAID="GMRCIFC,trans error,"_GMRCLOG
"RTN","GMRCIERR",115,0)
 S XQADATA=GMRCLOG_"|"_GMRCDA_"|"_GMRCACT
"RTN","GMRCIERR",116,0)
 D SETUP^XQALERT
"RTN","GMRCIERR",117,0)
 Q
"RTN","GMRCIERR",118,0)
PTERRMSG(GMRCPID,GMRCSTA,GMRCDOM,GMRCOBR) ;send IFC pt err to mail group
"RTN","GMRCIERR",119,0)
 ;Input:
"RTN","GMRCIERR",120,0)
 ;  GMRCPID = PID seg from IFC message
"RTN","GMRCIERR",121,0)
 ;  GMRCSTA = station # of site where message originated
"RTN","GMRCIERR",122,0)
 ;  GMRCDOM = domain to send the message to, if defined   (optional)
"RTN","GMRCIERR",123,0)
 ;  GMRCOBR = OBR segment from IFC msg  (optional)
"RTN","GMRCIERR",124,0)
 ;
"RTN","GMRCIERR",125,0)
 ;Output:
"RTN","GMRCIERR",126,0)
 ;  mail message containing patient demographics
"RTN","GMRCIERR",127,0)
 ;
"RTN","GMRCIERR",128,0)
 N GMRCGRP,GMRCMSG,GMRCNM,GMRCNAM,GMRCDOB
"RTN","GMRCIERR",129,0)
 N XMERR,GMRCSUB,GMRCSITE,GMRCERR,GMRCICN
"RTN","GMRCIERR",130,0)
 N XMTEXT,XMY,XMDUZ,XMSUB,XMZ,XMMG
"RTN","GMRCIERR",131,0)
 S GMRCNAM=$P(GMRCPID,"|",5)
"RTN","GMRCIERR",132,0)
 S GMRCNM("FAMILY")=$P(GMRCNAM,U),GMRCNM("GIVEN")=$P(GMRCNAM,U,2)
"RTN","GMRCIERR",133,0)
 S GMRCNM("MIDDLE")=$P(GMRCNAM,U,3),GMRCNM("SUFFIX")=$P(GMRCNAM,U,4)
"RTN","GMRCIERR",134,0)
 S GMRCNAM=$$NAMEFMT^XLFNAME(.GMRCNM,"F","CL56Xc")
"RTN","GMRCIERR",135,0)
 S GMRCDOB=$$HL7TFM^XLFDT($P(GMRCPID,"|",7))
"RTN","GMRCIERR",136,0)
 S GMRCDOB=$$FMTE^XLFDT(GMRCDOB)
"RTN","GMRCIERR",137,0)
 S GMRCICN=+$P(GMRCPID,"|",2)
"RTN","GMRCIERR",138,0)
 D F4^XUAF4(GMRCSTA,.GMRCSITE)
"RTN","GMRCIERR",139,0)
 S GMRCMSG(1,0)="An Inter-facility Consult for the following patient has been requested."
"RTN","GMRCIERR",140,0)
 S GMRCMSG(2,0)="The patient has either never been registered at your facility or the national"
"RTN","GMRCIERR",141,0)
 S GMRCMSG(3,0)="MPI ICN for this patient at your site does not match that from the requesting"
"RTN","GMRCIERR",142,0)
 S GMRCMSG(4,0)="site. Please refer to the Master Patient Index/Patient Demographics (MPI/PD)"
"RTN","GMRCIERR",143,0)
 S GMRCMSG(5,0)="User Manual and Master Patient Index/Patient Demographics Exception"
"RTN","GMRCIERR",144,0)
 S GMRCMSG(6,0)="Handling Manuals to resolve this error so request may be processed."
"RTN","GMRCIERR",145,0)
 S GMRCMSG(7,0)="processed at your site.",GMRCMSG(8,0)=" "
"RTN","GMRCIERR",146,0)
 S GMRCMSG(9,0)="Patient demographics from "_GMRCSITE("NAME")
"RTN","GMRCIERR",147,0)
 S GMRCMSG(10,0)="   Patient name: "_GMRCNAM
"RTN","GMRCIERR",148,0)
 S GMRCMSG(11,0)="            SSN: "_$P(GMRCPID,"|",19)
"RTN","GMRCIERR",149,0)
 S GMRCMSG(12,0)="  Date of birth: "_GMRCDOB
"RTN","GMRCIERR",150,0)
 S GMRCMSG(13,0)="            Sex: "_$P(GMRCPID,"|",8)
"RTN","GMRCIERR",151,0)
 S GMRCMSG(14,0)="     Remote ICN: "_GMRCICN
"RTN","GMRCIERR",152,0)
 S GMRCMSG(15,0)=" "
"RTN","GMRCIERR",153,0)
 I $L($G(GMRCOBR)) D
"RTN","GMRCIERR",154,0)
 . N GMRCITM
"RTN","GMRCIERR",155,0)
 . S GMRCITM=$P(GMRCOBR,"|",4)
"RTN","GMRCIERR",156,0)
 . I GMRCITM["VA1235" S GMRCITM="Ordered service: "_$P(GMRCITM,U,2)
"RTN","GMRCIERR",157,0)
 . I GMRCITM["VA1233" S GMRCITM="  Ordered proc.: "_$P(GMRCITM,U,2)
"RTN","GMRCIERR",158,0)
 . S GMRCMSG(16,0)=GMRCITM
"RTN","GMRCIERR",159,0)
 S GMRCMSG(17,0)=" "
"RTN","GMRCIERR",160,0)
 S GMRCMSG(18,0)="   The error is: Unknown Patient (201)"
"RTN","GMRCIERR",161,0)
 ;
"RTN","GMRCIERR",162,0)
 D  ; set XMY to local group or remote group
"RTN","GMRCIERR",163,0)
 . I $D(GMRCDOM) S XMY("G.IFC CLIN ERRORS@"_GMRCDOM)="" Q
"RTN","GMRCIERR",164,0)
 . S XMY("G.IFC PATIENT ERROR MESSAGES")=""
"RTN","GMRCIERR",165,0)
 S XMSUB="Incoming IFC patient error, "_GMRCNAM
"RTN","GMRCIERR",166,0)
 S XMDUZ="Consult/Request Tracking Package"
"RTN","GMRCIERR",167,0)
 S XMTEXT="GMRCMSG("
"RTN","GMRCIERR",168,0)
 D ^XMD
"RTN","GMRCIERR",169,0)
 Q
"RTN","GMRCIERR",170,0)
 ;
"RTN","GMRCIERR",171,0)
PTMPIER(GMRCDFN) ;send IFC local MPI error to MAS mail group
"RTN","GMRCIERR",172,0)
 ;Input:
"RTN","GMRCIERR",173,0)
 ;  GMRCDFN = DFN from file 2 of patient with MPI problem
"RTN","GMRCIERR",174,0)
 ;
"RTN","GMRCIERR",175,0)
 ;Output:
"RTN","GMRCIERR",176,0)
 ;  mail message containing patient demographics
"RTN","GMRCIERR",177,0)
 ;
"RTN","GMRCIERR",178,0)
 N DFN,GMRCPT,GMRCMSG,VAHOW,VAROOT
"RTN","GMRCIERR",179,0)
 N XMTEXT,XMY,XMDUZ,XMSUB,XMZ,XMMG
"RTN","GMRCIERR",180,0)
 S DFN=GMRCDFN,VAHOW=1,VAROOT="GMRCPT"
"RTN","GMRCIERR",181,0)
 D DEM^VADPT
"RTN","GMRCIERR",182,0)
 S GMRCMSG(1,0)="An Inter-facility Consult for the following patient has been requested."
"RTN","GMRCIERR",183,0)
 S GMRCMSG(2,0)="The PATIENT file is either missing an ICN or contains a local ICN."
"RTN","GMRCIERR",184,0)
 S GMRCMSG(3,0)="Please refer to the Master Patient Index/Patient Demographics(MPI/PD) User"
"RTN","GMRCIERR",185,0)
 S GMRCMSG(4,0)="and Master Patient Index/Patient Demographics Exception Handling Manuals"
"RTN","GMRCIERR",186,0)
 S GMRCMSG(5,0)="to resolve this error so request may be processed."
"RTN","GMRCIERR",187,0)
 S GMRCMSG(6,0)=" "
"RTN","GMRCIERR",188,0)
 S GMRCMSG(7,0)="   Patient name: "_GMRCPT("NM")
"RTN","GMRCIERR",189,0)
 S GMRCMSG(8,0)="            SSN: "_$P(GMRCPT("SS"),U,2)
"RTN","GMRCIERR",190,0)
 S GMRCMSG(9,0)="  Date of birth: "_$P(GMRCPT("DB"),U,2)
"RTN","GMRCIERR",191,0)
 S GMRCMSG(10,0)="            Sex: "_$P(GMRCPT("SX"),U,2)
"RTN","GMRCIERR",192,0)
 S GMRCMSG(11,0)="  "
"RTN","GMRCIERR",193,0)
 S GMRCMSG(12,0)="   The error is: Local or unknown MPI identifiers (202)"
"RTN","GMRCIERR",194,0)
 ;
"RTN","GMRCIERR",195,0)
 S XMY("G.IFC PATIENT ERROR MESSAGES")=""
"RTN","GMRCIERR",196,0)
 S XMSUB="Outgoing IFC patient error, "_GMRCPT("NM")
"RTN","GMRCIERR",197,0)
 S XMDUZ="Consult/Request Tracking Package"
"RTN","GMRCIERR",198,0)
 S XMTEXT="GMRCMSG("
"RTN","GMRCIERR",199,0)
 D ^XMD
"RTN","GMRCIERR",200,0)
 Q
"RTN","GMRCIERR",201,0)
 ;
"RTN","GMRCIEV1")
0^1^B33699336
"RTN","GMRCIEV1",1,0)
GMRCIEV1 ;SLC/JFR - IFC EVENTS CONT'D ;07/17/02 14:35
"RTN","GMRCIEV1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCIEV1",3,0)
 Q  ;no-no-no
"RTN","GMRCIEV1",4,0)
RESUB(GMRCDA,GMRCACT) ;build HL7 msg with edits from resubit
"RTN","GMRCIEV1",5,0)
 ;Input:
"RTN","GMRCIEV1",6,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",7,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",8,0)
 ;
"RTN","GMRCIEV1",9,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEV1",10,0)
 S SEG=1
"RTN","GMRCIEV1",11,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",12,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",13,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEV1",14,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEV1",15,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",16,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",17,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",18,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",19,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",20,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",21,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",22,0)
 . Q
"RTN","GMRCIEV1",23,0)
 ;
"RTN","GMRCIEV1",24,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",25,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"XO","IP",GMRCACT)
"RTN","GMRCIEV1",26,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",27,0)
 ;
"RTN","GMRCIEV1",28,0)
 ; include Inpatient or Outpatient
"RTN","GMRCIEV1",29,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA,GMRCACT)
"RTN","GMRCIEV1",30,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",31,0)
 ;
"RTN","GMRCIEV1",32,0)
 D  ;load up reason for request
"RTN","GMRCIEV1",33,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEV1",34,0)
 . D OBXWP^GMRCISEG(GMRCDA,"XO",GMRCACT,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEV1",35,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEV1",36,0)
 . N I S I=0
"RTN","GMRCIEV1",37,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEV1",38,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEV1",39,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",40,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEV1",41,0)
 . Q
"RTN","GMRCIEV1",42,0)
 D  ;prov DX changed, send it
"RTN","GMRCIEV1",43,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA)
"RTN","GMRCIEV1",44,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",45,0)
 ;
"RTN","GMRCIEV1",46,0)
 D  ;send ed-res comment and file as is
"RTN","GMRCIEV1",47,0)
 . N I
"RTN","GMRCIEV1",48,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",49,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",50,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",51,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",52,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",53,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",54,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",55,0)
 . Q
"RTN","GMRCIEV1",56,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",57,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",58,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",59,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",60,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",61,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",62,0)
 Q
"RTN","GMRCIEV1",63,0)
 ;
"RTN","GMRCIEV1",64,0)
SF(GMRCDA,GMRCACT) ;send SIG FINDING update
"RTN","GMRCIEV1",65,0)
 ;Input:
"RTN","GMRCIEV1",66,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",67,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",68,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT,GMRCOS
"RTN","GMRCIEV1",69,0)
 S SEG=1
"RTN","GMRCIEV1",70,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",71,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",72,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEV1",73,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEV1",74,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",75,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",76,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",77,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",78,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",79,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",80,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",81,0)
 . Q
"RTN","GMRCIEV1",82,0)
 ;
"RTN","GMRCIEV1",83,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",84,0)
 S GMRCOS=$S($P(^GMR(123,GMRCDA,0),U,12)="2":"CM",1:"IP")
"RTN","GMRCIEV1",85,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"RE","CM",GMRCACT)
"RTN","GMRCIEV1",86,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",87,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up comment to send
"RTN","GMRCIEV1",88,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",89,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",90,0)
 . N I S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",91,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",92,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",93,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",94,0)
 . Q
"RTN","GMRCIEV1",95,0)
 S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA),SEG=SEG+1
"RTN","GMRCIEV1",96,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",97,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",98,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",99,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",100,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",101,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",102,0)
 Q
"RTN","GMRCIEV1",103,0)
 ;
"RTN","GMRCIEV1",104,0)
FWD(GMRCDA,GMRCACT) ;bld HL7 msg upon FWD action
"RTN","GMRCIEV1",105,0)
 ;Input:
"RTN","GMRCIEV1",106,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",107,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",108,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT,GMRCOS
"RTN","GMRCIEV1",109,0)
 S SEG=1
"RTN","GMRCIEV1",110,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",111,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",112,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEV1",113,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEV1",114,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",115,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",116,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",117,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",118,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",119,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",120,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",121,0)
 . Q
"RTN","GMRCIEV1",122,0)
 ;
"RTN","GMRCIEV1",123,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",124,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"XX","IP",GMRCACT)
"RTN","GMRCIEV1",125,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",126,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA,GMRCACT),SEG=SEG+1
"RTN","GMRCIEV1",127,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up comment to send
"RTN","GMRCIEV1",128,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",129,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",130,0)
 . N I S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",131,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",132,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",133,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",134,0)
 . Q
"RTN","GMRCIEV1",135,0)
 S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA),SEG=SEG+1
"RTN","GMRCIEV1",136,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",137,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",138,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",139,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",140,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",141,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",142,0)
 Q
"RTN","GMRCIEV1",143,0)
 ;
"RTN","GMRCIEV1",144,0)
FWD2IFC(GMRCDA,GMRCACT) ;pkg up and send request upon fwd'ing into IFC serv
"RTN","GMRCIEV1",145,0)
 ;Input:
"RTN","GMRCIEV1",146,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",147,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",148,0)
 N GMRCACTN
"RTN","GMRCIEV1",149,0)
 I '$P(^GMR(123,GMRCDA,0),U,22),'$D(^GMR(123.6,"C",GMRCDA)) D  Q
"RTN","GMRCIEV1",150,0)
 . D NW^GMRCIEVT(GMRCDA)
"RTN","GMRCIEV1",151,0)
 . S GMRCACTN=1
"RTN","GMRCIEV1",152,0)
 . F  S GMRCACTN=$O(^GMR(123,GMRCDA,40,GMRCACTN)) Q:'GMRCACTN  D
"RTN","GMRCIEV1",153,0)
 .. D TRIGR^GMRCIEVT(GMRCDA,GMRCACTN)
"RTN","GMRCIEV1",154,0)
 D FWD(GMRCDA,GMRCACT)
"RTN","GMRCIEV1",155,0)
 Q
"RTN","GMRCIEVT")
0^2^B55919888
"RTN","GMRCIEVT",1,0)
GMRCIEVT ;SLC/JFR - process events and build HL7 message; 7/17/02 14:27
"RTN","GMRCIEVT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCIEVT",3,0)
 ;
"RTN","GMRCIEVT",4,0)
 Q  ;don't start at the top
"RTN","GMRCIEVT",5,0)
TRIGR(IEN,ACTN) ;determine what action was taken on IFC and call event point
"RTN","GMRCIEVT",6,0)
 ;Input: 
"RTN","GMRCIEVT",7,0)
 ;  IEN   = consult number from file 123
"RTN","GMRCIEVT",8,0)
 ;  ACT   = ien in 40 multiple corresponding to activity
"RTN","GMRCIEVT",9,0)
 ;
"RTN","GMRCIEVT",10,0)
 N ACTYPE
"RTN","GMRCIEVT",11,0)
 S ACTYPE=$P(^GMR(123,IEN,40,ACTN,0),U,2)
"RTN","GMRCIEVT",12,0)
 I 'ACTYPE Q
"RTN","GMRCIEVT",13,0)
 ;
"RTN","GMRCIEVT",14,0)
 ; check bkgrd job and run if overdue
"RTN","GMRCIEVT",15,0)
 I '$D(ZTQUEUED),$$GONOGO^GMRCIBKG D
"RTN","GMRCIEVT",16,0)
 . N ZTQUEUED S ZTQUEUED=1 D EN^GMRCIBKG ;remove ZTQUEUED? 
"RTN","GMRCIEVT",17,0)
 ;
"RTN","GMRCIEVT",18,0)
 I $O(^GMR(123.6,"AC",IEN,ACTN),-1) D  Q  ;earlier pending activities
"RTN","GMRCIEVT",19,0)
 . I ACTYPE=22 Q  ; not a trigger or not done here
"RTN","GMRCIEVT",20,0)
 . I ACTYPE=6 N GMRCQT D  I $D(GMRCQT) Q
"RTN","GMRCIEVT",21,0)
 .. ;complete all transactions if IFC DC'd before request ever sent 
"RTN","GMRCIEVT",22,0)
 .. I $O(^GMR(123.6,"AC",IEN,ACTN),-1)'=1 Q  ;new request already sent
"RTN","GMRCIEVT",23,0)
 .. S GMRCQT=1
"RTN","GMRCIEVT",24,0)
 .. N DA,DIE,DR,GMRCACTS
"RTN","GMRCIEVT",25,0)
 .. S GMRCACTS=0
"RTN","GMRCIEVT",26,0)
 .. F  S GMRCACTS=$O(^GMR(123.6,"AC",IEN,GMRCACTS)) Q:'GMRCACTS  D
"RTN","GMRCIEVT",27,0)
 ... S DIE="^GMR(123.6,",DA=$O(^GMR(123.6,"AC",IEN,GMRCACTS,1,0))
"RTN","GMRCIEVT",28,0)
 ... S DR=".06///@" D ^DIE
"RTN","GMRCIEVT",29,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",902) ;msg log entry but no msg sent
"RTN","GMRCIEVT",30,0)
 I ACTYPE=2!(ACTYPE=1) D NW(IEN) Q  ;send new order
"RTN","GMRCIEVT",31,0)
 I ACTYPE=9!(ACTYPE=14) D RSLT(IEN,ACTN) Q  ;inc report or add'l notes
"RTN","GMRCIEVT",32,0)
 I ACTYPE=10,$P(^GMR(123,IEN,40,ACTN,0),U,9) D RSLT(IEN,ACTN) Q  ;comp
"RTN","GMRCIEVT",33,0)
 I ACTYPE=12 D RSLT(IEN,ACTN) Q  ;dis-associate result
"RTN","GMRCIEVT",34,0)
 I ACTYPE=11 D RESUB^GMRCIEV1(IEN,ACTN) Q  ;ed/resubmit
"RTN","GMRCIEVT",35,0)
 I ACTYPE=13 D RSLT(IEN,ACTN) Q  ; addendum added
"RTN","GMRCIEVT",36,0)
 I ACTYPE=4 D SF^GMRCIEV1(IEN,ACTN) Q  ; sig finding update
"RTN","GMRCIEVT",37,0)
 I ACTYPE=22 Q  ;printed to is not a trigger
"RTN","GMRCIEVT",38,0)
 I ACTYPE=17 D FWD^GMRCIEV1(IEN,ACTN) Q  ; forward
"RTN","GMRCIEVT",39,0)
 I ACTYPE=25 D FWD2IFC^GMRCIEV1(IEN,ACTN) Q  ; FWD into an IFC service
"RTN","GMRCIEVT",40,0)
 D GENUPD(IEN,ACTN) ;all other updates
"RTN","GMRCIEVT",41,0)
 Q
"RTN","GMRCIEVT",42,0)
NW(GMRCDA) ;build new order message for IFC
"RTN","GMRCIEVT",43,0)
 ; Input:
"RTN","GMRCIEVT",44,0)
 ;   GMRCDA  = ien from file 123
"RTN","GMRCIEVT",45,0)
 ;
"RTN","GMRCIEVT",46,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",47,0)
 S SEG=1
"RTN","GMRCIEVT",48,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",49,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",50,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",51,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",52,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,1) Q  ;build PID seg if not a local ICN
"RTN","GMRCIEVT",53,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",54,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",55,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",56,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",57,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",58,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",59,0)
 . Q
"RTN","GMRCIEVT",60,0)
 S ^TMP("HLS",$J,SEG)=$$NWORC^GMRCISG1(GMRCDA) ; get ORC for new ord
"RTN","GMRCIEVT",61,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",62,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA) ;get OBR segment
"RTN","GMRCIEVT",63,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",64,0)
 D  ;build reason for request into OBX segment(s)
"RTN","GMRCIEVT",65,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",66,0)
 . D OBXWP^GMRCISEG(GMRCDA,"NW",1,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEVT",67,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEVT",68,0)
 . N I S I=0
"RTN","GMRCIEVT",69,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEVT",70,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEVT",71,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",72,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",73,0)
 . Q
"RTN","GMRCIEVT",74,0)
 S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA) ; build prov DX in OBX
"RTN","GMRCIEVT",75,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",76,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always send local time zone
"RTN","GMRCIEVT",77,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",78,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",79,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",80,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"")
"RTN","GMRCIEVT",81,0)
 D LOGMSG^GMRCIUTL(GMRCDA,1,+GMRC773,ERR)
"RTN","GMRCIEVT",82,0)
 Q
"RTN","GMRCIEVT",83,0)
 ;
"RTN","GMRCIEVT",84,0)
GENUPD(GMRCDA,GMRCACT) ;build msg and send upon REC, SC or ADD CMT event
"RTN","GMRCIEVT",85,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",86,0)
 S SEG=1
"RTN","GMRCIEVT",87,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",88,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",89,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",90,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",91,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",92,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",93,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",94,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",95,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",96,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",97,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",98,0)
 . Q
"RTN","GMRCIEVT",99,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",100,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",101,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",102,0)
 . ;set order control for ORC seg:
"RTN","GMRCIEVT",103,0)
 . ;   v-- IP=cmt RE=adm comp OD=DC OC=cancel SC=sch or receive
"RTN","GMRCIEVT",104,0)
 . S OC=$S(ACTVT=20:"IP",ACTVT=10:"RE",ACTVT=6:"OD",ACTVT=19:"OC",1:"SC")
"RTN","GMRCIEVT",105,0)
 . ;set order status for ORC seg:
"RTN","GMRCIEVT",106,0)
 . ;   v-- SC=sch RE=adm comp DC=DC CA=cancel IP=cmt or receive
"RTN","GMRCIEVT",107,0)
 . S OS=$S(ACTVT=8:"SC",ACTVT=10:"CM",ACTVT=6:"DC",ACTVT=19:"CA",1:"IP")
"RTN","GMRCIEVT",108,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",109,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",110,0)
 . Q
"RTN","GMRCIEVT",111,0)
 I $L($P(^GMR(123,GMRCDA,0),U,19)) D  ;send sig findings
"RTN","GMRCIEVT",112,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA)
"RTN","GMRCIEVT",113,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",114,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up a comment if there
"RTN","GMRCIEVT",115,0)
 . N I
"RTN","GMRCIEVT",116,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEVT",117,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)'["O" D 
"RTN","GMRCIEVT",118,0)
 .. D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEVT",119,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)["O" D
"RTN","GMRCIEVT",120,0)
 .. N GMRCMT
"RTN","GMRCIEVT",121,0)
 .. D NTE^GMRCISEG(GMRCDA,GMRCACT,.GMRCMT)
"RTN","GMRCIEVT",122,0)
 .. I $D(GMRCMT) M ^TMP("GMRCMT",$J)=GMRCMT
"RTN","GMRCIEVT",123,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEVT",124,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEVT",125,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEVT",126,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",127,0)
 . Q
"RTN","GMRCIEVT",128,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",129,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",130,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",131,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",132,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",133,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",134,0)
 Q
"RTN","GMRCIEVT",135,0)
 ;
"RTN","GMRCIEVT",136,0)
RSLT(GMRCDA,GMRCACT) ;attach or dis-associate results and update
"RTN","GMRCIEVT",137,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",138,0)
 S SEG=1
"RTN","GMRCIEVT",139,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",140,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",141,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",142,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",143,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",144,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",145,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",146,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",147,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",148,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",149,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",150,0)
 . Q
"RTN","GMRCIEVT",151,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",152,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",153,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",154,0)
 . S OC="RE"
"RTN","GMRCIEVT",155,0)
 . S OS=$S(ACTVT=9:"A",ACTVT=12:"IP",1:"CM") ; A=part res CM=comp IP=dis
"RTN","GMRCIEVT",156,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",157,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",158,0)
 I $P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2)'=99 D
"RTN","GMRCIEVT",159,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXRSLT^GMRCISEG(GMRCDA,GMRCACT)
"RTN","GMRCIEVT",160,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",161,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",162,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",163,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",164,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",165,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",166,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",167,0)
 Q
"RTN","GMRCIEVT",168,0)
 ;
"RTN","GMRCIEVT",169,0)
NOMPI(GMRCIEN,GMRCACTV) ;process MPI exception
"RTN","GMRCIEVT",170,0)
 N GMRCDFN
"RTN","GMRCIEVT",171,0)
 S GMRCDFN=$P(^GMR(123,GMRCIEN,0),U,2)
"RTN","GMRCIEVT",172,0)
 D PTMPIER^GMRCIERR(GMRCDFN) ; send msg to local group for ICN problem
"RTN","GMRCIEVT",173,0)
 D LOGMSG^GMRCIUTL(GMRCIEN,GMRCACTV,,202) ;put inc. entry in MSG log
"RTN","GMRCIEVT",174,0)
 Q
"RTN","GMRCIEVT",175,0)
 ;
"RTN","GMRCIEVT",176,0)
ROUTE(GMRCDA) ; determine correct routing for IFC msg
"RTN","GMRCIEVT",177,0)
 ; Input:
"RTN","GMRCIEVT",178,0)
 ;  GMRCDA = ien from file 123
"RTN","GMRCIEVT",179,0)
 ;
"RTN","GMRCIEVT",180,0)
 ; Output:
"RTN","GMRCIEVT",181,0)
 ;   the logical link to send the message to in format
"RTN","GMRCIEVT",182,0)
 ;     "GMRC IFC SUBSC^VHAHIN"
"RTN","GMRCIEVT",183,0)
 ;
"RTN","GMRCIEVT",184,0)
 N SITE,GMRCLINK,STA
"RTN","GMRCIEVT",185,0)
 S SITE=$P(^GMR(123,GMRCDA,0),U,23) I 'SITE Q "" ;no ROUTING FACILITY
"RTN","GMRCIEVT",186,0)
 S STA=$$STA^XUAF4(SITE)
"RTN","GMRCIEVT",187,0)
 I '$L(STA) Q "" ;can't find station num for that site
"RTN","GMRCIEVT",188,0)
 D LINK^HLUTIL3(STA,.GMRCLINK,"I")
"RTN","GMRCIEVT",189,0)
 S GMRCLINK=$O(GMRCLINK(0)) I 'GMRCLINK Q "" ; no link for that site
"RTN","GMRCIEVT",190,0)
 S GMRCLINK=GMRCLINK(GMRCLINK) I '$L(GMRCLINK) Q "" ;no link name
"RTN","GMRCIEVT",191,0)
 Q "GMRC IFC SUBSC^"_GMRCLINK
"RTN","GMRCIMSG")
0^5^B22849846
"RTN","GMRCIMSG",1,0)
GMRCIMSG ;SLC/JFR - IFC MESSAGE HANDLING ROUTINE; 09/26/02 00:23
"RTN","GMRCIMSG",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCIMSG",3,0)
 ;
"RTN","GMRCIMSG",4,0)
 Q  ;don't start at the top
"RTN","GMRCIMSG",5,0)
IN ;process incoming message and save segments to ^TMP(
"RTN","GMRCIMSG",6,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",7,0)
 N HLNODE,SEG,I,GMRCIER  ;production code
"RTN","GMRCIMSG",8,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","GMRCIMSG",9,0)
 . I $P(HLNODE,"|")="OBX" D  ;multiple segs for OBX
"RTN","GMRCIMSG",10,0)
 .. S ^TMP("GMRCIF",$J,"OBX",$P(HLNODE,"|",2),$P(HLNODE,"|",5))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",11,0)
 . I $P(HLNODE,"|")="NTE" D  ; may be multiple NTE's
"RTN","GMRCIMSG",12,0)
 .. S ^TMP("GMRCIF",$J,"NTE",$P(HLNODE,"|",2))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",13,0)
 . I "OBXNTE"'[$P(HLNODE,"|") D  ;all other segs are single
"RTN","GMRCIMSG",14,0)
 .. S ^TMP("GMRCIF",$J,$P(HLNODE,"|"))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",15,0)
 . Q
"RTN","GMRCIMSG",16,0)
 ;
"RTN","GMRCIMSG",17,0)
 I '$$VALMSG(^TMP("GMRCIF",$J,"ORC")) D EX Q  ;chk msg for valid cslt #'s
"RTN","GMRCIMSG",18,0)
 ;
"RTN","GMRCIMSG",19,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="NW" D  D EX Q
"RTN","GMRCIMSG",20,0)
 . I $P(^TMP("GMRCIF",$J,"ORC"),"|",2)["TST1234" D  D EX Q  ;testing impl
"RTN","GMRCIMSG",21,0)
 .. D TST^GMRCIAC2($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",22,0)
 . D NW^GMRCIACT($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",23,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="XO" D  D EX Q
"RTN","GMRCIMSG",24,0)
 . D RESUB^GMRCIAC1($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",25,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="XX" D  D EX Q
"RTN","GMRCIMSG",26,0)
 . D FWD^GMRCIAC1($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",27,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="RE" D  D EX Q
"RTN","GMRCIMSG",28,0)
 . I $P($G(^TMP("GMRCIF",$J,"OBX",4,1)),"|",11)="D" D  Q
"RTN","GMRCIMSG",29,0)
 .. D DIS^GMRCIACT($NA(^TMP("GMRCIF",$J))) ; dis-assoc. result
"RTN","GMRCIMSG",30,0)
 . I $P($P(^TMP("GMRCIF",$J,"ORC"),"|",16),U)="S" D  Q
"RTN","GMRCIMSG",31,0)
 .. D SF^GMRCIAC1($NA(^TMP("GMRCIF",$J))) ; significant findings
"RTN","GMRCIMSG",32,0)
 . D COMP^GMRCIAC1($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",33,0)
 D OTHER^GMRCIACT($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",34,0)
 D EX
"RTN","GMRCIMSG",35,0)
 Q
"RTN","GMRCIMSG",36,0)
 ;
"RTN","GMRCIMSG",37,0)
EX ; clean up ^TMP(
"RTN","GMRCIMSG",38,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",39,0)
 Q
"RTN","GMRCIMSG",40,0)
 ;
"RTN","GMRCIMSG",41,0)
ORRIN ;process IFC responses
"RTN","GMRCIMSG",42,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",43,0)
 N HLNODE,SEG,I  ;production code
"RTN","GMRCIMSG",44,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","GMRCIMSG",45,0)
 .S ^TMP("GMRCIF",$J,$P(HLNODE,"|"))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",46,0)
 I $D(^TMP("GMRCIF",$J,"ORC")),$P(^("ORC"),"|")="OK" D
"RTN","GMRCIMSG",47,0)
 . N GMRCFNUM,GMRCROUT,GMRCDA,FDA
"RTN","GMRCIMSG",48,0)
 . S GMRCROUT=$$IEN^XUAF4($P($P(^TMP("GMRCIF",$J,"ORC"),"|",3),U,2))
"RTN","GMRCIMSG",49,0)
 . S GMRCDA=+$P(^TMP("GMRCIF",$J,"ORC"),"|",2)
"RTN","GMRCIMSG",50,0)
 . ;I GMRCROUT'=$P(^GMR(123,GMRCDA,0),U,23) Q
"RTN","GMRCIMSG",51,0)
 . S GMRCFNUM=+$P(^TMP("GMRCIF",$J,"ORC"),"|",3)
"RTN","GMRCIMSG",52,0)
 . S FDA(1,123,GMRCDA_",",.06)=GMRCFNUM
"RTN","GMRCIMSG",53,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIMSG",54,0)
 . Q
"RTN","GMRCIMSG",55,0)
 I $P(^TMP("GMRCIF",$J,"MSA"),"|")="AA" D
"RTN","GMRCIMSG",56,0)
 . N MSGID,MSGLOG,FDA,GMRCDA,GMRCACT,GMRCLOG
"RTN","GMRCIMSG",57,0)
 . S MSGID=$P(^TMP("GMRCIF",$J,"MSA"),"|",2)
"RTN","GMRCIMSG",58,0)
 . S MSGLOG=$O(^GMR(123.6,"AM",MSGID,0)) Q:'MSGLOG
"RTN","GMRCIMSG",59,0)
 . S FDA(1,123.6,MSGLOG_",",.06)="@"
"RTN","GMRCIMSG",60,0)
 . S FDA(1,123.6,MSGLOG_",",.08)="@"
"RTN","GMRCIMSG",61,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIMSG",62,0)
 . S GMRCDA=$P(^GMR(123.6,MSGLOG,0),U,4) Q:'GMRCDA
"RTN","GMRCIMSG",63,0)
 . S GMRCACT=$P(^GMR(123.6,MSGLOG,0),U,5) Q:'GMRCACT
"RTN","GMRCIMSG",64,0)
 . S GMRCACT=$O(^GMR(123.6,"AC",GMRCDA,GMRCACT)) D
"RTN","GMRCIMSG",65,0)
 .. I 'GMRCACT Q
"RTN","GMRCIMSG",66,0)
 .. S GMRCLOG=$O(^GMR(123.6,"AC",GMRCDA,GMRCACT,1,0)) Q:'GMRCLOG
"RTN","GMRCIMSG",67,0)
 .. I $P(^GMR(123.6,GMRCLOG,0),U,8)<900 Q  ;re-send 901 & 902 immed.
"RTN","GMRCIMSG",68,0)
 .. D TRIGR^GMRCIEVT(GMRCDA,GMRCACT)
"RTN","GMRCIMSG",69,0)
 . Q
"RTN","GMRCIMSG",70,0)
 I $P(^TMP("GMRCIF",$J,"MSA"),"|")="AR" D
"RTN","GMRCIMSG",71,0)
 . N MSGID,MSGLOG,FDA,GMRCERR,GMRCE
"RTN","GMRCIMSG",72,0)
 . S MSGID=$P(^TMP("GMRCIF",$J,"MSA"),"|",2)
"RTN","GMRCIMSG",73,0)
 . S MSGLOG=$O(^GMR(123.6,"AM",MSGID,0)) Q:'MSGLOG
"RTN","GMRCIMSG",74,0)
 . S GMRCE=$P(^TMP("GMRCIF",$J,"MSA"),"|",3)
"RTN","GMRCIMSG",75,0)
 . S FDA(1,123.6,MSGLOG_",",.08)=GMRCE
"RTN","GMRCIMSG",76,0)
 . I GMRCE=802 S FDA(1,123.6,MSGLOG_",",.06)="@"
"RTN","GMRCIMSG",77,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIMSG",78,0)
 . I GMRCE=901!(GMRCE=902) Q  ;no alerts on these probs (yet)
"RTN","GMRCIMSG",79,0)
 . I GMRCE=201 D  Q
"RTN","GMRCIMSG",80,0)
 .. I '$$GET^XPAR("SYS","GMRC IFC ALERT IMMED ON PT ERR",1) Q
"RTN","GMRCIMSG",81,0)
 .. D SNDALRT^GMRCIERR(MSGLOG,"C","IFC patient error at remote facility")
"RTN","GMRCIMSG",82,0)
 . D SNDALRT^GMRCIERR(MSGLOG,"C")
"RTN","GMRCIMSG",83,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",84,0)
 Q
"RTN","GMRCIMSG",85,0)
 ;
"RTN","GMRCIMSG",86,0)
VALMSG(GMRCORC) ;check to make sure placer and filler # match current entry
"RTN","GMRCIMSG",87,0)
 ; Input: 
"RTN","GMRCIMSG",88,0)
 ;  GMRCORC = ORC segment from incoming HL7 msg
"RTN","GMRCIMSG",89,0)
 ;
"RTN","GMRCIMSG",90,0)
 I $P(GMRCORC,"|")="NW" Q 1 ; no #'s to match on new order
"RTN","GMRCIMSG",91,0)
 N GMRCPDA,GMRCFDA,GMRCPSIT,GMRCFSIT,GMRCROL,GMRCOK
"RTN","GMRCIMSG",92,0)
 S GMRCPDA=+$P(GMRCORC,"|",2)
"RTN","GMRCIMSG",93,0)
 S GMRCPSIT=$$IEN^XUAF4($P($P(GMRCORC,"|",2),U,2))
"RTN","GMRCIMSG",94,0)
 S GMRCFDA=+$P(GMRCORC,"|",3)
"RTN","GMRCIMSG",95,0)
 S GMRCFSIT=$$IEN^XUAF4($P($P(GMRCORC,"|",3),U,2))
"RTN","GMRCIMSG",96,0)
 I $$KSP^XUPARAM("INST")=GMRCPSIT S GMRCROL="P"
"RTN","GMRCIMSG",97,0)
 I $$KSP^XUPARAM("INST")=GMRCFSIT S GMRCROL="F"
"RTN","GMRCIMSG",98,0)
 S GMRCOK=1
"RTN","GMRCIMSG",99,0)
 I '$D(GMRCROL) S GMRCOK=0,GMRCROL="" ;bad institutions in msg
"RTN","GMRCIMSG",100,0)
 I GMRCROL="P" D
"RTN","GMRCIMSG",101,0)
 . I '$D(^GMR(123,GMRCPDA,0)) S GMRCOK=0 Q  ;no such cslt #
"RTN","GMRCIMSG",102,0)
 . I $P(^GMR(123,GMRCPDA,0),U,22)'=GMRCFDA S GMRCOK=0 Q  ;cslt # prob
"RTN","GMRCIMSG",103,0)
 . I $P(^GMR(123,GMRCPDA,0),U,23)'=GMRCFSIT S GMRCOK=0 Q  ;routing facil.
"RTN","GMRCIMSG",104,0)
 I GMRCROL="F" D
"RTN","GMRCIMSG",105,0)
 . I '$D(^GMR(123,GMRCFDA,0)) S GMRCOK=0 Q  ;no such cslt #
"RTN","GMRCIMSG",106,0)
 . I $P(^GMR(123,GMRCFDA,0),U,22)'=GMRCPDA S GMRCOK=0 Q  ;cslt # prob
"RTN","GMRCIMSG",107,0)
 . I $P(^GMR(123,GMRCFDA,0),U,23)'=GMRCPSIT S GMRCOK=0 Q  ;routing facil.
"RTN","GMRCIMSG",108,0)
 I 'GMRCOK D  ;return a 101 error to sending site
"RTN","GMRCIMSG",109,0)
 . N GMRCRSLT
"RTN","GMRCIMSG",110,0)
 . D RESP^GMRCIUTL("AR",HL("MID"),,,101) ;build HLA(
"RTN","GMRCIMSG",111,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT) ;-(
"RTN","GMRCIMSG",112,0)
 Q GMRCOK
"RTN","GMRCIMSG",113,0)
 ;
"RTN","GMRCITPI")
0^9^B12587821
"RTN","GMRCITPI",1,0)
GMRCITPI ;SLC/JFR - SET TEST PATIENT ICN'S ;10/2/02 12:10
"RTN","GMRCITPI",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCITPI",3,0)
 ;
"RTN","GMRCITPI",4,0)
 ; This routine invokes IA #'s 3552, 3553
"RTN","GMRCITPI",5,0)
 ;
"RTN","GMRCITPI",6,0)
 ;
"RTN","GMRCITPI",7,0)
 ; WARNING: due to complications that may occur with the VA MPI, this 
"RTN","GMRCITPI",8,0)
 ;          routine should never be executed in a production VistA 
"RTN","GMRCITPI",9,0)
 ;          environment.  
"RTN","GMRCITPI",10,0)
 ;
"RTN","GMRCITPI",11,0)
EN ;set test patient ICN's based on SSN
"RTN","GMRCITPI",12,0)
 I '$$ENVOK Q  ;don't continue if environment isn't right
"RTN","GMRCITPI",13,0)
 N DIR,X,Y,DIRUT,DIROUT,DUOUT,DTOUT,GMRCPT,VA,VAHOW,VAROOT,DFN,OK
"RTN","GMRCITPI",14,0)
 W !!
"RTN","GMRCITPI",15,0)
 S DIR(0)="PAO^2:EMQZ",DIR("A")="Select shared patient: "
"RTN","GMRCITPI",16,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCITPI",17,0)
 S DFN=+Y
"RTN","GMRCITPI",18,0)
 S VAROOT="GMRCPT",VAHOW=1 D DEM^VADPT
"RTN","GMRCITPI",19,0)
 I '$$PATOK($P(GMRCPT("SS"),U)) G EN
"RTN","GMRCITPI",20,0)
 W !!,"Trying to set test patient ICN..."
"RTN","GMRCITPI",21,0)
 S OK=$$SETICN^MPIF001(DFN,(9_+GMRCPT("SS")),$E(GMRCPT("SS"),3,8))
"RTN","GMRCITPI",22,0)
 I 'OK W !!,"Unable to set ICN for this patient. Try again or select another patient." Q
"RTN","GMRCITPI",23,0)
 W !!,"  Done.",!
"RTN","GMRCITPI",24,0)
 G EN
"RTN","GMRCITPI",25,0)
 Q
"RTN","GMRCITPI",26,0)
ENVOK() ;check and quit if this could be a production environment
"RTN","GMRCITPI",27,0)
 ; checks PROCESSING ID (#.03) of file 869.3 to see if training
"RTN","GMRCITPI",28,0)
 N GMRCPID
"RTN","GMRCITPI",29,0)
 S GMRCPID=$P($$PARAM^HLCS2,U,3) ; new API to call
"RTN","GMRCITPI",30,0)
 I '$L(GMRCPID) D  Q 0
"RTN","GMRCITPI",31,0)
 . W !!,"Unable to continue! VistA HL7 is not configured."
"RTN","GMRCITPI",32,0)
 . W !,"Check the HL COMMUNICATION SERVER PARAMETERS file to be sure this is "
"RTN","GMRCITPI",33,0)
 . W !,"configured as a test environment."
"RTN","GMRCITPI",34,0)
 I GMRCPID="P" D  Q 0
"RTN","GMRCITPI",35,0)
 . W !!,$C(7),"This appears to be a production system!",!!
"RTN","GMRCITPI",36,0)
 . W "This option is only for use in training environments!",!
"RTN","GMRCITPI",37,0)
 . W !,"If this is indeed a training environment, Check the HL COMMUNICATION "
"RTN","GMRCITPI",38,0)
 . W !,"SERVER PARAMETERS file to be sure this is configured as a test environment."
"RTN","GMRCITPI",39,0)
 . W !,"Then access this option again."
"RTN","GMRCITPI",40,0)
 Q 1
"RTN","GMRCITPI",41,0)
 ;
"RTN","GMRCITPI",42,0)
PATOK(GMRCSSN) ;make sure patient is only one with the SSN passed in
"RTN","GMRCITPI",43,0)
 ; Input:
"RTN","GMRCITPI",44,0)
 ;   GMRCSSN = ssn of patient in question
"RTN","GMRCITPI",45,0)
 ;
"RTN","GMRCITPI",46,0)
 ; Output:
"RTN","GMRCITPI",47,0)
 ;   1 = patient has a unique SSN and can be assigned a pseudo-ICN
"RTN","GMRCITPI",48,0)
 ;   0 = already a patient on file with the SSN
"RTN","GMRCITPI",49,0)
 N GMRCPT,ICN,OK
"RTN","GMRCITPI",50,0)
 I $E(GMRCSSN,1,5)="00000" D  Q 0
"RTN","GMRCITPI",51,0)
 . W !,"Patients having a SSN with 5 leading zeros cannot be used for inter-facility",!,"consult testing. Edit the SSN or choose a different patient."
"RTN","GMRCITPI",52,0)
 I GMRCSSN["P" D  Q 0
"RTN","GMRCITPI",53,0)
 . W !!,"This patient has a pseudo-SSN. A pseudo-ICN cannot be assigned. Edit the SSN",!,"or choose a different patient.",!
"RTN","GMRCITPI",54,0)
 S GMRCPT=$$FIND1^DIC(2,"","X",GMRCSSN,"SSN")
"RTN","GMRCITPI",55,0)
 I GMRCPT'>0 D  Q 0
"RTN","GMRCITPI",56,0)
 . W !,"There is more than one patient on file with the SSN of this patient. ",!,"A pseudo-ICN cannot be assigned. Edit the SSN or choose different patient."
"RTN","GMRCITPI",57,0)
 S ICN=$$GETICN^MPIF001(GMRCPT)
"RTN","GMRCITPI",58,0)
 I $L(ICN),+ICN=(9_GMRCSSN) D  Q 0
"RTN","GMRCITPI",59,0)
 . W !!,"Test patient ICN already set using current SSN.",!
"RTN","GMRCITPI",60,0)
 I $L(ICN),'$$IFLOCAL^MPIF001(GMRCPT) D  Q OK
"RTN","GMRCITPI",61,0)
 . S OK=1
"RTN","GMRCITPI",62,0)
 . W !!,"This patient appears to have a national ICN on file.",!
"RTN","GMRCITPI",63,0)
 . N DIR,X,Y,DTOUT,DIRUT,DUOUT
"RTN","GMRCITPI",64,0)
 . S DIR(0)="YA",DIR("A")="Are you sure you want to overwrite this ICN? "
"RTN","GMRCITPI",65,0)
 . D ^DIR
"RTN","GMRCITPI",66,0)
 . I Y'>0 S OK=0
"RTN","GMRCITPI",67,0)
 Q 1
"RTN","GMRCITR")
0^8^B36533926
"RTN","GMRCITR",1,0)
GMRCITR ;SLC/JAK - IFC transactions ; 09/27/02 15:50
"RTN","GMRCITR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28**;DEC 27, 1997
"RTN","GMRCITR",3,0)
EN ; -- main entry point for GMRC IF TRANSACTION
"RTN","GMRCITR",4,0)
 N GMRCDAS,GMRCLOG,GMRCQUT,GMRCS,X,Y
"RTN","GMRCITR",5,0)
 N GMRCDT1,GMRCDT2,GMRCEDT1,GMRCEDT2
"RTN","GMRCITR",6,0)
 D CON I $D(GMRCQUT) D EXIT^GMRCINC Q
"RTN","GMRCITR",7,0)
 ;Ask for date range
"RTN","GMRCITR",8,0)
 D ^GMRCSPD
"RTN","GMRCITR",9,0)
 I $D(GMRCQUT) D EXIT^GMRCINC Q
"RTN","GMRCITR",10,0)
 D LISTDATE^GMRCSTU1(GMRCDT1,GMRCDT2,.GMRCEDT1,.GMRCEDT2)
"RTN","GMRCITR",11,0)
 D VIEW I $D(GMRCQUT) D EXIT^GMRCINC Q
"RTN","GMRCITR",12,0)
 I GMRCSEL="ALL" D
"RTN","GMRCITR",13,0)
 . S GMRCNUM=0 F  S GMRCNUM=$O(^GMR(123.6,"C",GMRCNUM)) Q:'GMRCNUM  D
"RTN","GMRCITR",14,0)
 .. D BLD(GMRCNUM)
"RTN","GMRCITR",15,0)
 E  D
"RTN","GMRCITR",16,0)
 . S GMRCNUM=GMRCSEL
"RTN","GMRCITR",17,0)
 . D BLD(GMRCNUM)
"RTN","GMRCITR",18,0)
 I '$O(GMRCLOG(0)) D
"RTN","GMRCITR",19,0)
 . S ^TMP("GMRCINC",$J,1,0)="No transactions for consult#: "_GMRCSEL
"RTN","GMRCITR",20,0)
 E  D
"RTN","GMRCITR",21,0)
 . D DATA(GMRCS)
"RTN","GMRCITR",22,0)
 D EN^VALM("GMRC IF TRANSACTION")
"RTN","GMRCITR",23,0)
 Q
"RTN","GMRCITR",24,0)
 ;
"RTN","GMRCITR",25,0)
CON ; ask for consult number or all
"RTN","GMRCITR",26,0)
 S GMRCSEL=0
"RTN","GMRCITR",27,0)
 F  D ASK S:X["^" GMRCQUT=1 Q:X["^"  Q:X="ALL"  D LKUP Q:GMRCSEL
"RTN","GMRCITR",28,0)
 Q
"RTN","GMRCITR",29,0)
ASK ; write prompt, do read
"RTN","GMRCITR",30,0)
 W !!,"Select Consult/Request Number: ALL// "
"RTN","GMRCITR",31,0)
 R X:DTIME
"RTN","GMRCITR",32,0)
 I '$T S X="^"
"RTN","GMRCITR",33,0)
 I X'["^" S X=$S('$L(X):"ALL",1:X)
"RTN","GMRCITR",34,0)
 S:X="ALL" GMRCSEL="ALL"
"RTN","GMRCITR",35,0)
 Q
"RTN","GMRCITR",36,0)
LKUP ; use value of x for lookup
"RTN","GMRCITR",37,0)
 N DIC
"RTN","GMRCITR",38,0)
 S DIC="^GMR(123,",DIC(0)="MNEQZ"
"RTN","GMRCITR",39,0)
 D ^DIC I '$D(Y(0)) W "...invalid entry"
"RTN","GMRCITR",40,0)
 S:Y>0 GMRCSEL=+Y
"RTN","GMRCITR",41,0)
 Q
"RTN","GMRCITR",42,0)
VIEW ; ask for sort/view
"RTN","GMRCITR",43,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCITR",44,0)
 K GMRCQUT
"RTN","GMRCITR",45,0)
 ;old code
"RTN","GMRCITR",46,0)
 ; S DIR(0)="SA^C:CONSULT;D:DATE;A:ACTIVITY;M:MESSAGE STATUS"
"RTN","GMRCITR",47,0)
 ; S DIR("A")="View by (C)onsult, (D)ate, (A)ctivity or (M)essage Status: "
"RTN","GMRCITR",48,0)
 ;new code w/ patch 28
"RTN","GMRCITR",49,0)
 S DIR(0)="SA^C:CONSULT;D:DATE;A:ACTIVITY"
"RTN","GMRCITR",50,0)
 S DIR("A")="View by (C)onsult, (D)ate, or (A)ctivity: "
"RTN","GMRCITR",51,0)
 S DIR("B")="Consult"
"RTN","GMRCITR",52,0)
 S DIR("?")="Data will be sorted by your selection."
"RTN","GMRCITR",53,0)
 D ^DIR I $D(DIRUT) S GMRCQUT=1 Q
"RTN","GMRCITR",54,0)
 S GMRCS=Y
"RTN","GMRCITR",55,0)
 Q
"RTN","GMRCITR",56,0)
BLD(GMRCDA) ; get list of IF transactions for one or all consults
"RTN","GMRCITR",57,0)
 ; Input:
"RTN","GMRCITR",58,0)
 ;   GMRCDA = ien of consult from file 123
"RTN","GMRCITR",59,0)
 ;
"RTN","GMRCITR",60,0)
 N ACT,ENT,GMRCDTE
"RTN","GMRCITR",61,0)
 S ACT=0
"RTN","GMRCITR",62,0)
 F  S ACT=$O(^GMR(123.6,"C",GMRCDA,ACT)) Q:'ACT  D
"RTN","GMRCITR",63,0)
 . S ENT=$O(^GMR(123.6,"C",GMRCDA,ACT,0)) Q:'ENT
"RTN","GMRCITR",64,0)
 . I $S(GMRCDT1="ALL":0,1:1) D  Q:GMRCDTE<GMRCDT1!(GMRCDTE'<GMRCDT2)
"RTN","GMRCITR",65,0)
 .. S GMRCDTE=+$P($G(^GMR(123.6,ENT,0)),"^")
"RTN","GMRCITR",66,0)
 .. S GMRCDT2=GMRCDT2+1
"RTN","GMRCITR",67,0)
 . S GMRCLOG(GMRCDA,ACT)=ENT
"RTN","GMRCITR",68,0)
 Q
"RTN","GMRCITR",69,0)
DATA(GMRCS) ; get data for IF transaction(s)
"RTN","GMRCITR",70,0)
 ; Input:
"RTN","GMRCITR",71,0)
 ;   GMRCS = sort/view by selection
"RTN","GMRCITR",72,0)
 ; Output:
"RTN","GMRCITR",73,0)
 ;   ^TMP("GMRCINC",$J array
"RTN","GMRCITR",74,0)
 N ACT,GMRCSV,TAB
"RTN","GMRCITR",75,0)
 I $O(GMRCLOG(0)) D
"RTN","GMRCITR",76,0)
 . K GMRCDAS
"RTN","GMRCITR",77,0)
 . K ^TMP("GMRCS",$J),^TMP("GMRCINC",$J)
"RTN","GMRCITR",78,0)
 S (GMRCDA,LINE)=0
"RTN","GMRCITR",79,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCITR",80,0)
 F  S GMRCDA=$O(GMRCLOG(GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCITR",81,0)
 . S ACT=0
"RTN","GMRCITR",82,0)
 . F  S ACT=$O(GMRCLOG(GMRCDA,ACT)) Q:'ACT  D
"RTN","GMRCITR",83,0)
 .. S GMRCLOG=$G(GMRCLOG(GMRCDA,ACT)) D
"RTN","GMRCITR",84,0)
 ... N ACTTXT,EDT,IERR,STA,GMRCACT,GMRCLOG0
"RTN","GMRCITR",85,0)
 ... S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0)) Q:'GMRCLOG0
"RTN","GMRCITR",86,0)
 ... S GMRCDA(0)=$G(^GMR(123,GMRCDA,40,ACT,0)) Q:'GMRCDA(0)
"RTN","GMRCITR",87,0)
 ... S LINE=LINE+1
"RTN","GMRCITR",88,0)
 ... S X=$P(GMRCLOG0,"^") D REGDTM^GMRCU
"RTN","GMRCITR",89,0)
 ... S EDT=$S(X]"":X,1:"No Date/Time")
"RTN","GMRCITR",90,0)
 ... S GMRCACT=$P(GMRCDA(0),"^",2)
"RTN","GMRCITR",91,0)
 ... S ACTTXT=$P($G(^GMR(123.1,+GMRCACT,0)),"^",1)
"RTN","GMRCITR",92,0)
 ... S:'$L(ACTTXT) ACTTXT=GMRCACT_" action?"
"RTN","GMRCITR",93,0)
 ... S STA=$P(GMRCLOG0,"^",3),STA=$$MSGSTAT^HLUTIL(STA) ; IA #3098
"RTN","GMRCITR",94,0)
 ... S STA=$S(+STA>0:$E($$GET1^DIQ(771.6,+STA,.01),1,22),1:"No Status")
"RTN","GMRCITR",95,0)
 ... S IERR=$T(@("ERR"_$P(GMRCLOG0,"^",8)_"^GMRCIUTL"))
"RTN","GMRCITR",96,0)
 ... S IERR=$S(IERR]"":$E($P(IERR,";",2),1,45),1:"No Error")
"RTN","GMRCITR",97,0)
 ... ;
"RTN","GMRCITR",98,0)
 ... S GMRCDAS(GMRCDA)=""
"RTN","GMRCITR",99,0)
 ... ; sort data
"RTN","GMRCITR",100,0)
 ... S GMRCSV=$S(GMRCS="C":GMRCDA,GMRCS="D":EDT,GMRCS="A":ACTTXT,1:STA)
"RTN","GMRCITR",101,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=GMRCDA
"RTN","GMRCITR",102,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=^TMP("GMRCS",$J,GMRCSV,GMRCLOG)_$E(TAB,1,13-$L(^(GMRCLOG)))_EDT_$E(TAB,1,5)_ACTTXT
"RTN","GMRCITR",103,0)
 ... ;S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=^TMP("GMRCS",$J,GMRCSV,GMRCLOG)_$E(TAB,1,56-$L(^(GMRCLOG)))_STA  ;msg status not included after patch 28
"RTN","GMRCITR",104,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=^TMP("GMRCS",$J,GMRCSV,GMRCLOG)_$E(TAB,1,56-$L(^(GMRCLOG)))_IERR
"RTN","GMRCITR",105,0)
 .. Q
"RTN","GMRCITR",106,0)
 . ; set data in array name
"RTN","GMRCITR",107,0)
 . N GMRC1,LINE
"RTN","GMRCITR",108,0)
 . S GMRC1="",LINE=0
"RTN","GMRCITR",109,0)
 . F  S GMRC1=$O(^TMP("GMRCS",$J,GMRC1)) Q:GMRC1=""  D
"RTN","GMRCITR",110,0)
 .. N GMRC2
"RTN","GMRCITR",111,0)
 .. S GMRC2=""
"RTN","GMRCITR",112,0)
 .. F  S GMRC2=$O(^TMP("GMRCS",$J,GMRC1,GMRC2)) Q:GMRC2=""  D
"RTN","GMRCITR",113,0)
 ... S LINE=LINE+1
"RTN","GMRCITR",114,0)
 ... S ^TMP("GMRCINC",$J,LINE,0)=$G(^TMP("GMRCS",$J,GMRC1,GMRC2))
"RTN","GMRCITR",115,0)
 .. Q
"RTN","GMRCITR",116,0)
 . Q
"RTN","GMRCITR",117,0)
 Q
"RTN","GMRCITR",118,0)
 ;
"RTN","GMRCITR",119,0)
HDR ; -- header code
"RTN","GMRCITR",120,0)
 S VALMHDR(1)="Transaction(s) for consult#: "_GMRCSEL
"RTN","GMRCITR",121,0)
 S VALMHDR(2)="From: "_$G(GMRCEDT1)_"   To: "_$G(GMRCEDT2)
"RTN","GMRCITR",122,0)
 Q
"RTN","GMRCITR",123,0)
LM ; set caption line
"RTN","GMRCITR",124,0)
 D CHGCAP^VALM("CAPTION LINE","Consult     Entry Date/Time    Activity                Error")
"RTN","GMRCITR",125,0)
 ;D CHGCAP^VALM("CAPTION LINE 1","Error") ; error moved over w/ patch 28
"RTN","GMRCITR",126,0)
 Q
"RTN","GMRCITR",127,0)
SELECT ; select a consult for detailed display of information
"RTN","GMRCITR",128,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y,GMRCDDS
"RTN","GMRCITR",129,0)
 K GMRCLOG
"RTN","GMRCITR",130,0)
 S DIR(0)="NO^1:9999999^D CKSEL^GMRCITR(X) K:'GMRCDDS X"
"RTN","GMRCITR",131,0)
 S DIR("A")="Select a Consult number from the display"
"RTN","GMRCITR",132,0)
 S DIR("?")="This response must be a number from the display."
"RTN","GMRCITR",133,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCITR",134,0)
 K ^TMP("GMRCINC",$J)
"RTN","GMRCITR",135,0)
 S GMRCSEL=Y
"RTN","GMRCITR",136,0)
 D BLD(GMRCSEL)
"RTN","GMRCITR",137,0)
 N ACT,ENT,GMRCND,LINE
"RTN","GMRCITR",138,0)
 S (ACT,LINE)=0
"RTN","GMRCITR",139,0)
 F  S ACT=$O(^GMR(123.6,"C",GMRCSEL,ACT)) Q:'ACT  D
"RTN","GMRCITR",140,0)
 . S ENT=$O(^GMR(123.6,"C",GMRCSEL,ACT,0)) Q:'ENT  D
"RTN","GMRCITR",141,0)
 .. Q:'$D(^GMR(123.6,ENT,0))
"RTN","GMRCITR",142,0)
 .. N DIC,DR,DA,DIQ,GMRCA
"RTN","GMRCITR",143,0)
 .. S DIC="^GMR(123.6,",DR=".01:.08",DA=ENT,DIQ="GMRCA"
"RTN","GMRCITR",144,0)
 .. D EN^DIQ1
"RTN","GMRCITR",145,0)
 .. S LINE=LINE+1
"RTN","GMRCITR",146,0)
 .. S GMRCND="^TMP(""GMRCINC"",$J,LINE,0)"
"RTN","GMRCITR",147,0)
 .. S @GMRCND="ENTRY DATE/TIME: "_GMRCA(123.6,ENT,.01),LINE=LINE+1
"RTN","GMRCITR",148,0)
 .. S @GMRCND="FACILITY: "_GMRCA(123.6,ENT,.02),LINE=LINE+1
"RTN","GMRCITR",149,0)
 .. S @GMRCND="MESSAGE #: "_GMRCA(123.6,ENT,.03),LINE=LINE+1
"RTN","GMRCITR",150,0)
 .. S @GMRCND="ACTIVITY #: "_GMRCA(123.6,ENT,.05),LINE=LINE+1
"RTN","GMRCITR",151,0)
 .. S @GMRCND="INCOMPLETE: "_GMRCA(123.6,ENT,.06),LINE=LINE+1
"RTN","GMRCITR",152,0)
 .. S @GMRCND="TRANS. ATTEMPTS: "_GMRCA(123.6,ENT,.07),LINE=LINE+1
"RTN","GMRCITR",153,0)
 .. S @GMRCND="ERROR: "_GMRCA(123.6,ENT,.08),LINE=LINE+1
"RTN","GMRCITR",154,0)
 .. S @GMRCND=""
"RTN","GMRCITR",155,0)
 S VALMHDR(1)="Detailed Display"
"RTN","GMRCITR",156,0)
 S VALMHDR(2)="Consult#: "_GMRCSEL
"RTN","GMRCITR",157,0)
 D CHGCAP^VALM("CAPTION LINE","")
"RTN","GMRCITR",158,0)
 D CHGCAP^VALM("CAPTION LINE 1","")
"RTN","GMRCITR",159,0)
 S VALMCNT=$O(^TMP("GMRCINC",$J," "),-1)
"RTN","GMRCITR",160,0)
 S VALMBG=1
"RTN","GMRCITR",161,0)
 Q
"RTN","GMRCITR",162,0)
CKSEL(X) ; check selection
"RTN","GMRCITR",163,0)
 N GMRCDA
"RTN","GMRCITR",164,0)
 S (GMRCDA,GMRCDDS)=0
"RTN","GMRCITR",165,0)
 F  S GMRCDA=$O(GMRCDAS(GMRCDA)) Q:'GMRCDA!GMRCDDS  D
"RTN","GMRCITR",166,0)
 . I GMRCDA=X S GMRCDDS=1
"RTN","GMRCITR",167,0)
 Q
"RTN","GMRCUTL1")
0^7^B13626178
"RTN","GMRCUTL1",1,0)
GMRCUTL1 ;SLC/DCM,JFR,MA - General Utilities ;10/15/02  11:49
"RTN","GMRCUTL1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,15,21,17,28**;DEC 27, 1997
"RTN","GMRCUTL1",3,0)
 ;
"RTN","GMRCUTL1",4,0)
 ; This routine invokes IA #2876,3121
"RTN","GMRCUTL1",5,0)
 ; Patch #21 added variable GMRCAUDT and moved line tag PRNTAUDT
"RTN","GMRCUTL1",6,0)
 ; to GMRCP5A.
"RTN","GMRCUTL1",7,0)
 ;
"RTN","GMRCUTL1",8,0)
ACTM ;;Set correct variables to complete, discontinue, etc. a consult
"RTN","GMRCUTL1",9,0)
 K GMRCQUT
"RTN","GMRCUTL1",10,0)
 S:'+$G(GMRCA) GMRCA=$O(^GMR(123.1,"B",GMRCACTM,""))
"RTN","GMRCUTL1",11,0)
 S GMRCACTM=$P($G(^GMR(123.1,+GMRCA,0)),"^")
"RTN","GMRCUTL1",12,0)
 S ORSTS=$S(GMRCA:$P(^GMR(123.1,GMRCA,0),"^",2),1:0)
"RTN","GMRCUTL1",13,0)
 I 'GMRCA S GMRCQUT=1
"RTN","GMRCUTL1",14,0)
 Q
"RTN","GMRCUTL1",15,0)
PRNT(SRVCIFN,GMRCO) ;print form 513 to a printer when new consult is entered
"RTN","GMRCUTL1",16,0)
 N ORVP,GMRCDEV,GMRCQUED,IOP,%ZIS,POP,ZTDTH,ZTDESC,ZTIO,ZTRTN,ZTSK,GMRCAUDT
"RTN","GMRCUTL1",17,0)
 I '$G(SRVCIFN) S SRVCIFN=+$P(^GMR(123,GMRCO,0),U,5)
"RTN","GMRCUTL1",18,0)
 Q:'$D(^GMR(123.5,SRVCIFN,123))  Q:'$P(^GMR(123.5,SRVCIFN,123),"^",9)
"RTN","GMRCUTL1",19,0)
 S IOP="`"_$P(^GMR(123.5,SRVCIFN,123),"^",9)
"RTN","GMRCUTL1",20,0)
 S %ZIS="N" D ^%ZIS I POP S %ZIS=0 D HOME^%ZIS Q
"RTN","GMRCUTL1",21,0)
 S GMRCDEV=ION,GMRCQUED=1,GMRCAUDT=1
"RTN","GMRCUTL1",22,0)
 S ZTRTN="PRNT^GMRCP5A("_(+GMRCO)_","_(+$G(TIUFLG))_",1,"""_$G(GMRCCPY,"W")_""",0,"_(GMRCAUDT)_")"
"RTN","GMRCUTL1",23,0)
 S ZTDESC="CONSULT/REQUEST PACKAGE PRINT FORM 513 FOR NEW CONSULT"
"RTN","GMRCUTL1",24,0)
 S ZTIO=GMRCDEV,ZTDTH=$H
"RTN","GMRCUTL1",25,0)
 D ^%ZTLOAD
"RTN","GMRCUTL1",26,0)
 S %ZIS=0 D HOME^%ZIS
"RTN","GMRCUTL1",27,0)
 K GMRCQUED,GMRCDEV1
"RTN","GMRCUTL1",28,0)
 Q
"RTN","GMRCUTL1",29,0)
END K GMRCDEV,GMRCDEV1,GMRCOREC,GMRCFMT
"RTN","GMRCUTL1",30,0)
 Q
"RTN","GMRCUTL1",31,0)
PROVDX(OI) ;return PROV DX prompting info from 123.5
"RTN","GMRCUTL1",32,0)
 ;    Input:
"RTN","GMRCUTL1",33,0)
 ;       OI = ref to file 123.5("#;99CON") or file 123.3 (#;99PRC)
"RTN","GMRCUTL1",34,0)
 ;
"RTN","GMRCUTL1",35,0)
 ;    Returns:  string  A^B
"RTN","GMRCUTL1",36,0)
 ;       A = O (optional), R (required) or S (suppress)
"RTN","GMRCUTL1",37,0)
 ;       B = F (free-text) or L (lexicon)
"RTN","GMRCUTL1",38,0)
 ;
"RTN","GMRCUTL1",39,0)
 N GMRCFIL
"RTN","GMRCUTL1",40,0)
 Q:'+$G(OI) "^"
"RTN","GMRCUTL1",41,0)
 S GMRCFIL=$S(OI["99PRC":123.3,1:123.5)
"RTN","GMRCUTL1",42,0)
 Q:'$D(^GMR(GMRCFIL,+OI)) "^"
"RTN","GMRCUTL1",43,0)
 N STRING,NODE
"RTN","GMRCUTL1",44,0)
 I GMRCFIL=123.3 S NODE=$P(^GMR(123.3,+OI,0),U,7,8)
"RTN","GMRCUTL1",45,0)
 I GMRCFIL=123.5 S NODE=$P($G(^GMR(123.5,+OI,1)),U,1,2)
"RTN","GMRCUTL1",46,0)
 I NODE="" Q "O^F" ;values not set
"RTN","GMRCUTL1",47,0)
 S $P(STRING,U)=$S($L($P(NODE,U)):$P(NODE,U),1:"O")
"RTN","GMRCUTL1",48,0)
 S $P(STRING,U,2)=$S($L($P(NODE,U,2)):$P(NODE,U,2),1:"F")
"RTN","GMRCUTL1",49,0)
 Q STRING
"RTN","GMRCUTL1",50,0)
ORIFN(GMRC123) ;return ORIFN associated with give record in ^GMR(123,
"RTN","GMRCUTL1",51,0)
 ; GMRC123 = ien of consult record in file 123
"RTN","GMRCUTL1",52,0)
 Q $P($G(^GMR(123,GMRC123,0)),U,3)
"RTN","GMRCUTL1",53,0)
GETDT(PROMPT,DEFAULT) ;prompt and return FM date
"RTN","GMRCUTL1",54,0)
 ;Input:
"RTN","GMRCUTL1",55,0)
 ;  PROMPT  = text of prompt - DIR("A")          (optional)
"RTN","GMRCUTL1",56,0)
 ;  DEFAULT = default date to prompt - DIR("B")  (optional)
"RTN","GMRCUTL1",57,0)
 ; 
"RTN","GMRCUTL1",58,0)
 ;Output:
"RTN","GMRCUTL1",59,0)
 ; FM date/time if successfully answered, "^" if exit or timeout
"RTN","GMRCUTL1",60,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,X,Y
"RTN","GMRCUTL1",61,0)
 S DIR(0)="DA^::EPT"
"RTN","GMRCUTL1",62,0)
 S DIR("?")="Enter the date/time the activity took place."
"RTN","GMRCUTL1",63,0)
 S DIR("A")=$S($D(PROMPT):PROMPT_" ",1:"Actual Date/Time of Activity: ")
"RTN","GMRCUTL1",64,0)
 S DIR("B")=$S($D(DEFAULT):DEFAULT,1:"NOW")
"RTN","GMRCUTL1",65,0)
 D ^DIR
"RTN","GMRCUTL1",66,0)
 I $D(DUOUT)!($D(DTOUT)) S Y="^"
"RTN","GMRCUTL1",67,0)
 Q Y
"RTN","GMRCUTL1",68,0)
 ;
"RTN","GMRCUTL1",69,0)
DCPRNT(IEN,USER) ;reprint SF-513 on DC?
"RTN","GMRCUTL1",70,0)
 N SERV,REPR
"RTN","GMRCUTL1",71,0)
 S SERV=$P(^GMR(123,IEN,0),U,5) I 'SERV Q 0
"RTN","GMRCUTL1",72,0)
 S REPR=$P($G(^GMR(123.5,SERV,1)),U,5)
"RTN","GMRCUTL1",73,0)
 I 'REPR Q 1
"RTN","GMRCUTL1",74,0)
 I REPR=2 Q 0
"RTN","GMRCUTL1",75,0)
 I REPR=1,'$$VALID^GMRCAU(SERV,IEN,USER) Q 1
"RTN","GMRCUTL1",76,0)
 Q 0
"RTN","GMRCUTL1",77,0)
 ;
"RTN","GMRCUTL1",78,0)
PREREQ(GMRCARR,GMRCSRV,GMRCDFN,UNRESOLV) ; return service pre-requisite
"RTN","GMRCUTL1",79,0)
 ; pre-requisite stored in 125 nodes in file 123.5 or 123.3
"RTN","GMRCUTL1",80,0)
 ; GMRCARR = array to return containing pre-requisite
"RTN","GMRCUTL1",81,0)
 ; GMRCSRV = ref to file 123.5 (ien;99CON) or 123.3 (ien;99PRC)
"RTN","GMRCUTL1",82,0)
 ; GMRCDFN = patient identifier if to return resolved
"RTN","GMRCUTL1",83,0)
 ; UNRESOLV = 1 or 0 ; if UNRESOLV=1 GMRCARR will be returned unresolved
"RTN","GMRCUTL1",84,0)
 Q:'+GMRCSRV
"RTN","GMRCUTL1",85,0)
 N GMRCFIL
"RTN","GMRCUTL1",86,0)
 S GMRCFIL=$S(GMRCSRV["99PRC":123.3,1:123.5)
"RTN","GMRCUTL1",87,0)
 Q:'$D(^GMR(GMRCFIL,+GMRCSRV,125))
"RTN","GMRCUTL1",88,0)
 I '$D(GMRCDFN)!($G(UNRESOLV)) D  Q
"RTN","GMRCUTL1",89,0)
 . M @GMRCARR=^GMR(GMRCFIL,+GMRCSRV,125)
"RTN","GMRCUTL1",90,0)
 D BLRPLT^TIUSRVD(,,GMRCDFN,,$NA(^GMR(GMRCFIL,+GMRCSRV,125)))
"RTN","GMRCUTL1",91,0)
 I $D(^TMP("TIUBOIL",$J)) M @GMRCARR=^TMP("TIUBOIL",$J)
"RTN","GMRCUTL1",92,0)
 K ^TMP("TIUBOIL",$J)
"RTN","GMRCUTL1",93,0)
 Q
"RTN","GMRCUTL1",94,0)
 ;
"RTN","GMRCUTL1",95,0)
LOCKREC(GMRCDA) ;attempt to lock a consult record using order or record
"RTN","GMRCUTL1",96,0)
 ; Input:
"RTN","GMRCUTL1",97,0)
 ;   GMRCDA  = ien of consult record from file 123
"RTN","GMRCUTL1",98,0)
 ;
"RTN","GMRCUTL1",99,0)
 ; Output: 
"RTN","GMRCUTL1",100,0)
 ;     1 or 0^reason can't be locked  
"RTN","GMRCUTL1",101,0)
 ;          1 = successfully locked
"RTN","GMRCUTL1",102,0)
 ;          0 = couldn't be locked
"RTN","GMRCUTL1",103,0)
 N GMRCORD,GMRCMSG
"RTN","GMRCUTL1",104,0)
 S GMRCORD=$P($G(^GMR(123,GMRCDA,0)),U,3)
"RTN","GMRCUTL1",105,0)
 I $G(GMRCORD) D  ;an order associated
"RTN","GMRCUTL1",106,0)
 . S GMRCMSG=$$LOCK1^ORX2(GMRCORD)
"RTN","GMRCUTL1",107,0)
 . ; GMRCMSG=1 if locked  or 0 if couldn't be locked
"RTN","GMRCUTL1",108,0)
 I $L($G(GMRCMSG)) Q GMRCMSG
"RTN","GMRCUTL1",109,0)
 ; no order = Inter-facility Consult so lock consult record
"RTN","GMRCUTL1",110,0)
 L +^GMR(123,GMRCDA):5
"RTN","GMRCUTL1",111,0)
 I '$T Q "0^Another user is editing this record" ; couldn't lock it
"RTN","GMRCUTL1",112,0)
 Q 1
"RTN","GMRCUTL1",113,0)
 ;
"RTN","GMRCUTL1",114,0)
UNLKREC(GMRCDA) ;unlock a consult record
"RTN","GMRCUTL1",115,0)
 ; Input:
"RTN","GMRCUTL1",116,0)
 ;   GMRCDA  = ien of consult record from file 123
"RTN","GMRCUTL1",117,0)
 ;
"RTN","GMRCUTL1",118,0)
 N GMRCORD
"RTN","GMRCUTL1",119,0)
 S GMRCORD=$P($G(^GMR(123,GMRCDA,0)),U,3)
"RTN","GMRCUTL1",120,0)
 I $G(GMRCORD) D  Q
"RTN","GMRCUTL1",121,0)
 . D UNLK1^ORX2(GMRCORD)
"RTN","GMRCUTL1",122,0)
 L -^GMR(123,GMRCDA)
"RTN","GMRCUTL1",123,0)
 Q
"VER")
8.0^22.0
**END**
**END**
