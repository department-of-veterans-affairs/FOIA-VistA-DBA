Released MPIF*1*26 SEQ #25
Extracted from mail message
**KIDS**:MPIF*1.0*26^

**INSTALL NAME**
MPIF*1.0*26
"BLD",1660,0)
MPIF*1.0*26^MASTER PATIENT INDEX VISTA^0^3030131^y
"BLD",1660,1,0)
^^3^3^3021210^
"BLD",1660,1,1,0)
AICNL FIX AND DISPLAY MSG
"BLD",1660,1,2,0)
Refer to patch MPIF*1*26 in the FORUM Patch Module for a complete
"BLD",1660,1,3,0)
description.
"BLD",1660,4,0)
^9.64PA^^
"BLD",1660,"ABNS",0)
^9.66A^^
"BLD",1660,"ABPKG")
n^n^
"BLD",1660,"KRN",0)
^9.67PA^8989.52^19
"BLD",1660,"KRN",.4,0)
.4
"BLD",1660,"KRN",.401,0)
.401
"BLD",1660,"KRN",.402,0)
.402
"BLD",1660,"KRN",.403,0)
.403
"BLD",1660,"KRN",.5,0)
.5
"BLD",1660,"KRN",.84,0)
.84
"BLD",1660,"KRN",3.6,0)
3.6
"BLD",1660,"KRN",3.8,0)
3.8
"BLD",1660,"KRN",9.2,0)
9.2
"BLD",1660,"KRN",9.8,0)
9.8
"BLD",1660,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",1660,"KRN",9.8,"NM",1,0)
MPIFRES^^0^B14703475
"BLD",1660,"KRN",9.8,"NM",2,0)
MPIFQ0^^0^B75036439
"BLD",1660,"KRN",9.8,"NM",3,0)
MPIFREQ^^0^B26998619
"BLD",1660,"KRN",9.8,"NM","B","MPIFQ0",2)
 
"BLD",1660,"KRN",9.8,"NM","B","MPIFREQ",3)
 
"BLD",1660,"KRN",9.8,"NM","B","MPIFRES",1)
 
"BLD",1660,"KRN",19,0)
19
"BLD",1660,"KRN",19.1,0)
19.1
"BLD",1660,"KRN",101,0)
101
"BLD",1660,"KRN",409.61,0)
409.61
"BLD",1660,"KRN",771,0)
771
"BLD",1660,"KRN",870,0)
870
"BLD",1660,"KRN",8989.51,0)
8989.51
"BLD",1660,"KRN",8989.52,0)
8989.52
"BLD",1660,"KRN",8994,0)
8994
"BLD",1660,"KRN","B",.4,.4)
 
"BLD",1660,"KRN","B",.401,.401)
 
"BLD",1660,"KRN","B",.402,.402)
 
"BLD",1660,"KRN","B",.403,.403)
 
"BLD",1660,"KRN","B",.5,.5)
 
"BLD",1660,"KRN","B",.84,.84)
 
"BLD",1660,"KRN","B",3.6,3.6)
 
"BLD",1660,"KRN","B",3.8,3.8)
 
"BLD",1660,"KRN","B",9.2,9.2)
 
"BLD",1660,"KRN","B",9.8,9.8)
 
"BLD",1660,"KRN","B",19,19)
 
"BLD",1660,"KRN","B",19.1,19.1)
 
"BLD",1660,"KRN","B",101,101)
 
"BLD",1660,"KRN","B",409.61,409.61)
 
"BLD",1660,"KRN","B",771,771)
 
"BLD",1660,"KRN","B",870,870)
 
"BLD",1660,"KRN","B",8989.51,8989.51)
 
"BLD",1660,"KRN","B",8989.52,8989.52)
 
"BLD",1660,"KRN","B",8994,8994)
 
"BLD",1660,"QUES",0)
^9.62^^
"BLD",1660,"REQB",0)
^9.611^3^3
"BLD",1660,"REQB",1,0)
MPIF*1.0*21^1
"BLD",1660,"REQB",2,0)
MPIF*1.0*24^1
"BLD",1660,"REQB",3,0)
MPIF*1.0*11^1
"BLD",1660,"REQB","B","MPIF*1.0*11",3)
 
"BLD",1660,"REQB","B","MPIF*1.0*21",1)
 
"BLD",1660,"REQB","B","MPIF*1.0*24",2)
 
"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
26^3030131
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3030131
"PKG",282,22,1,"PAH",1,1,1,0)
AICNL FIX AND DISPLAY MSG
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*26 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIFQ0")
0^2^B75036439
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17,21,20,24,26**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$SEND2^VAFCUTL1- #2779
"RTN","MPIFQ0",8,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFQ0",9,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",10,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",11,0)
 ;
"RTN","MPIFQ0",12,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",13,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",14,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",15,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",16,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W:'$D(MPIFRPC) !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",17,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",18,0)
 W:'$D(MPIFRPC) !
"RTN","MPIFQ0",19,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",20,0)
 I $$SEND^RGJUSITE'>0 W:'$D(MPIFRPC) !,"MPI/PD Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",21,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",22,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",23,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",24,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",25,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N W:'$D(MPIFRPC) !,"Patient is missing Date of Birth -- Required Field" D LOCAL(DFN) G END
"RTN","MPIFQ0",26,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",27,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",28,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",29,0)
 I $E(LOCDATA(2,DFN,.01),1,3)="EEE" W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" G END
"RTN","MPIFQ0",30,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",31,0)
 G JUMP
"RTN","MPIFQ0",32,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",33,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",34,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",35,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",36,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",37,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S MPIFRTN="MISSING DOB" D EXC^MPIFVTQ(DFN) G END
"RTN","MPIFQ0",38,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",39,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",40,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",41,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",42,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",43,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC
"RTN","MPIFQ0",44,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",45,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",46,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",47,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",48,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",49,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",50,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",51,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",52,0)
 .;;I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",53,0)
 ;Create MSH
"RTN","MPIFQ0",54,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",55,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",56,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",57,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",58,0)
 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",59,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",60,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",61,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and continue with Registration
"RTN","MPIFQ0",62,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",63,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",64,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",65,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",66,0)
 K ^TMP("MPIFQ0",$J) ;array data is parsed into for display in LM
"RTN","MPIFQ0",67,0)
INIPARS N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",68,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",69,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFQ0",70,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",71,0)
 .N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN,HEREICN,HERESSN,MIDDLE,IEN,F,SUFF,SEX
"RTN","MPIFQ0",72,0)
 .S STRING="",FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2),MIDDLE=$P(SEG,HL("FS"),10),SUFF=$P(SEG,HL("FS"),15)
"RTN","MPIFQ0",73,0)
 .S (LASTSSN,SSN)=$P(SEG,HL("FS"),3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",74,0)
 .I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",75,0)
 .I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",76,0)
 .S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",77,0)
 .S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",78,0)
 .I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN
"RTN","MPIFQ0",79,0)
 .I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",80,0)
 .S FIRST=FIRST+1,CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",81,0)
 .I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",82,0)
 .S TF=$P(SEG,HL("FS"),8)
"RTN","MPIFQ0",83,0)
 .I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",84,0)
 .;Same patient just adding TF's
"RTN","MPIFQ0",85,0)
 .I TF'="",ICN=FICN,FIRST'=2 S COUNTER=COUNTER+1,^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF_"^"_IEN
"RTN","MPIFQ0",86,0)
 .Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",87,0)
 .S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",88,0)
 .I $G(LASTNAME)="" Q
"RTN","MPIFQ0",89,0)
 .I $G(BIRTHDAY)]"" S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY),BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFQ0",90,0)
 .;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",91,0)
 .S INDEX=INDEX+1,COUNTER=1,HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",92,0)
 .I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",93,0)
 .S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",94,0)
 .S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",95,0)
 .S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",96,0)
 .S ^TMP("MPIFQ0",$J,INDEX,0)=STRING,^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",97,0)
 .S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_CCMOR_"^"_SEX
"RTN","MPIFQ0",98,0)
 .S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",99,0)
 .S ^TMP("MPIFQ0",$J,INDEX,"HOLD")=SEG
"RTN","MPIFQ0",100,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",101,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",102,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",103,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",104,0)
 .D A28(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",105,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to see if it's definitely the same patient.
"RTN","MPIFQ0",106,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",107,0)
 .N CMOR,ICN,DATA,TICN,SNM,SNM2
"RTN","MPIFQ0",108,0)
 .S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA"),CMOR=CCMOR,ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",109,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",110,0)
 .S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",111,0)
 .I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",112,0)
 .I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",113,0)
 .; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",114,0)
 .S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",115,0)
 .S SNM2=$P(DATA,"^") D NAME^VAFCPID2(0,.SNM2,0) S $P(DATA,"^")=SNM2
"RTN","MPIFQ0",116,0)
 .I $P(DATA,"^")'=SNM D  Q
"RTN","MPIFQ0",117,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",118,0)
 ..I '$D(MPIFINT) D LOC2(DFN) Q
"RTN","MPIFQ0",119,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",120,0)
 .D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",121,0)
 .S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",122,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",123,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",124,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",125,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",126,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",127,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",128,0)
EXIT I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",129,0)
 K VALMCNT,VALMLST
"RTN","MPIFQ0",130,0)
 K CCMOR,FICN H 3 W:'$D(MPIFRPC) !!
"RTN","MPIFQ0",131,0)
END Q
"RTN","MPIFQ0",132,0)
A28(DFN) ; *** CHANGED FOR PATCH 24 TO USE NEW MESSAGING
"RTN","MPIFQ0",133,0)
 S ICN=$$A28^MPIFA28(DFN)
"RTN","MPIFQ0",134,0)
 I +ICN>0 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Message sent to MPI requesting Patient to be added." Q
"RTN","MPIFQ0",135,0)
 Q
"RTN","MPIFQ0",136,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",137,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",138,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",139,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",140,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",141,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",142,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",143,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",144,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",145,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",146,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",147,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",148,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",149,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",150,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",151,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",152,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",153,0)
 ;;;N HERE S HERE=+$P($$SITE^VASITE,"^",3) D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",154,0)
 N RESLT S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFQ0",155,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFQ0",156,0)
 Q
"RTN","MPIFQ0",157,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",158,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",159,0)
 N ICN S ICN=$$ICNLC^MPIF001(DFN) ;don't assign local if exists
"RTN","MPIFQ0",160,0)
 Q
"RTN","MPIFQ0",161,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",162,0)
 Q:$G(ICN)="" 0
"RTN","MPIFQ0",163,0)
 N DFN S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",164,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",165,0)
 Q DFN
"RTN","MPIFQ0",166,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFQ0",167,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",168,0)
 ;DIC is the file reference, DA is the file entry IEN, ARRAY is the
"RTN","MPIFQ0",169,0)
 ;storage array for the values to be stored in, DR are the fields
"RTN","MPIFQ0",170,0)
 ;requested, EI is external/internal values of the fields or don't
"RTN","MPIFQ0",171,0)
 ;return null values
"RTN","MPIFQ0",172,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFQ0",173,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",174,0)
 D EN^DIQ1
"RTN","MPIFQ0",175,0)
 Q
"RTN","MPIFQ0",176,0)
LOC2(DFN) ;
"RTN","MPIFQ0",177,0)
 W:'$D(MPIFRPC) !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",178,0)
 D START^RGHLLOG(),EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN),STOP^RGHLLOG()
"RTN","MPIFQ0",179,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",180,0)
 Q
"RTN","MPIFREQ")
0^3^B26998619
"RTN","MPIFREQ",1,0)
MPIFREQ ;SF/TN/CMC-CMOR CHANGE REQUEST ;FEB 20, 1998
"RTN","MPIFREQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6,11,26**;30 Apr 99
"RTN","MPIFREQ",3,0)
 ;
"RTN","MPIFREQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFREQ",5,0)
 ;
"RTN","MPIFREQ",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFREQ",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFREQ",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFREQ",9,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFREQ",10,0)
 ;
"RTN","MPIFREQ",11,0)
EN(TYPE,REQNO,ERROR,HL7) ;
"RTN","MPIFREQ",12,0)
 ; Create HL7 message for Change of CMOR Request
"RTN","MPIFREQ",13,0)
 N RGL,INST,USER,REASON,NDATE,ICN,PHONE,N0,CNT,HLA,HL,ID,XX,PID
"RTN","MPIFREQ",14,0)
 S CNT=0,HL=0
"RTN","MPIFREQ",15,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFREQ",16,0)
 I N0="" S ERROR="Node for request #"_REQNO_" is not defined" Q
"RTN","MPIFREQ",17,0)
 S INST=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFREQ",18,0)
 N X,Y,DIC
"RTN","MPIFREQ",19,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFREQ",20,0)
 D ^DIC
"RTN","MPIFREQ",21,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFREQ",22,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFREQ",23,0)
 S REASON=$P($G(^MPIF(984.9,REQNO,1)),"^",2)
"RTN","MPIFREQ",24,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFREQ",25,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFREQ",26,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFREQ",27,0)
 S ID=$P(N0,"^")
"RTN","MPIFREQ",28,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFREQ",29,0)
 I HL D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO_" FOR ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG() D RESET(REQNO) Q
"RTN","MPIFREQ",30,0)
 K HLL("LINKS")
"RTN","MPIFREQ",31,0)
 D LINK^HLUTIL3($P(N0,"^",7),.RGL)
"RTN","MPIFREQ",32,0)
 S XX=$O(RGL(0))
"RTN","MPIFREQ",33,0)
 I XX>0,$E($G(RGL(XX)),1,2)'="VA" D START^RGHLLOG(),EXC^RGHLLOG(224,"Unable to send Request to change CMOR request# "_REQNO_"  No HL7 logical link for site "_XX_" for ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG() D RESET(REQNO) Q
"RTN","MPIFREQ",34,0)
 I XX>0 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_RGL(XX)
"RTN","MPIFREQ",35,0)
 S CNT=CNT+1,PID=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFREQ",36,0)
 S HLA("HLS",CNT)=PID
"RTN","MPIFREQ",37,0)
 S CNT=CNT+1
"RTN","MPIFREQ",38,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST
"RTN","MPIFREQ",39,0)
 S CNT=CNT+1
"RTN","MPIFREQ",40,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFREQ",41,0)
 N RLST
"RTN","MPIFREQ",42,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFREQ",43,0)
 I 'RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO_" for ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG(),RESET(REQNO)
"RTN","MPIFREQ",44,0)
 Q
"RTN","MPIFREQ",45,0)
 ;
"RTN","MPIFREQ",46,0)
RESET(REQNO) ; reset status to Open
"RTN","MPIFREQ",47,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///1" D ^DIE
"RTN","MPIFREQ",48,0)
 K DIE,DA,DR
"RTN","MPIFREQ",49,0)
 Q
"RTN","MPIFREQ",50,0)
 ;
"RTN","MPIFREQ",51,0)
IN(INST,USER,REASON,NDATE,ICN,PHONE,ID) ;Process an incoming CMOR request
"RTN","MPIFREQ",52,0)
 N PATIEN,MAIL,MPIF,TYPE,N0,IEN,XMCHAN,XMDUZ,XMTEXT,XMSUB,XMY,TEXT,X
"RTN","MPIFREQ",53,0)
 S PATIEN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFREQ",54,0)
 I PATIEN<1 D  Q
"RTN","MPIFREQ",55,0)
 . D START^RGHLLOG()
"RTN","MPIFREQ",56,0)
 . D EXC^RGHLLOG(210,"Received CMOR Change Request for ICN "_ICN_" ICN not Found. Request # "_ID)
"RTN","MPIFREQ",57,0)
 . D STOP^RGHLLOG()
"RTN","MPIFREQ",58,0)
 S IEN=$$ADD^MPIFNEW(ID) ;add request to request file
"RTN","MPIFREQ",59,0)
 S TYPE=2 ;type of action to Request Received From
"RTN","MPIFREQ",60,0)
 S INST=$G(HL("SFN")) ; site that sent this message
"RTN","MPIFREQ",61,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR="[MPIF REQUEST INCOMING]" D ^DIE
"RTN","MPIFREQ",62,0)
 I $$IFVCCI^MPIF001(+PATIEN)=-1 D PUSH(IEN) Q
"RTN","MPIFREQ",63,0)
 ; ^ your site isn't the CMOR, so this is a push to make you the CMOR
"RTN","MPIFREQ",64,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR=".09///"_INST D ^DIE
"RTN","MPIFREQ",65,0)
 ; ^ update CMOR AFTER APPROVAL field
"RTN","MPIFREQ",66,0)
 I $$AUTO^MPIFNQ() D AUTO(IEN) Q
"RTN","MPIFREQ",67,0)
 S MAIL=$$MAIL^MPIFUTL()
"RTN","MPIFREQ",68,0)
 I MAIL="" S MAIL="MPIF EXCEPTIONS"
"RTN","MPIFREQ",69,0)
 S XMDUZ="MPI VISTA Package",XMTEXT="MPIF(1,",MPIF(1,1)="New Coordinating Master Of Record (CMOR) request received for patient "_$S($P($G(^DPT(+PATIEN,0)),U)]"":$P(^DPT(PATIEN,0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",1:"UNKNOWN")
"RTN","MPIFREQ",70,0)
 I MAIL="MPIF EXCEPTIONS" S XMTEXT=XMTEXT_" no mail group defined for CMOR requests"
"RTN","MPIFREQ",71,0)
 S XMSUB="CMOR Change Request #"_$P(^MPIF(984.9,IEN,0),"^"),XMY("G."_MAIL)="" D ^XMD
"RTN","MPIFREQ",72,0)
 Q
"RTN","MPIFREQ",73,0)
 ;
"RTN","MPIFREQ",74,0)
AUTO(REQNO) ;Process a request automatically
"RTN","MPIFREQ",75,0)
 N DFN,MPIFERR,DIE,DR,DA,CMOR,RES,CMORN
"RTN","MPIFREQ",76,0)
 S MPIFERR=0
"RTN","MPIFREQ",77,0)
 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW AUTO]",DA=REQNO D ^DIE
"RTN","MPIFREQ",78,0)
 S DFN=$P($G(^MPIF(984.9,REQNO,0)),"^",4)
"RTN","MPIFREQ",79,0)
 S CMORN=$P($G(^MPIF(984.9,REQNO,0)),"^",7)
"RTN","MPIFREQ",80,0)
 S CMOR=$$CMORNAME^MPIF001(CMORN)
"RTN","MPIFREQ",81,0)
 I +CMOR=-1 D START^RGHLLOG(),EXC^RGHLLOG(220,"CMOR not sent in Change CMOR message for patient DFN= "_DFN_" Request # "_REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",82,0)
 Q:+CMOR=-1      ;No CMOR defined
"RTN","MPIFREQ",83,0)
 I $P($G(^MPIF(984.9,REQNO,1)),"^",3)=2 D
"RTN","MPIFREQ",84,0)
 .S RES=1,RES=$$CHANGE^MPIF001(DFN,CMORN)
"RTN","MPIFREQ",85,0)
 .I +RES<1 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_CMOR_" in a CMOR Change Message for Patient DFN= "_DFN_" Request # "+REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",86,0)
 .Q:+RES<1
"RTN","MPIFREQ",87,0)
 .D BROAD^MPIFCMOR(REQNO,.MPIFERR)
"RTN","MPIFREQ",88,0)
 .I +MPIFERR=0 D EN^MPIFRESS(REQNO)
"RTN","MPIFREQ",89,0)
 .; ^ trigger approval msg
"RTN","MPIFREQ",90,0)
 Q
"RTN","MPIFREQ",91,0)
 ;
"RTN","MPIFREQ",92,0)
RESET2(REQNO) ; reset status to Pending Approval
"RTN","MPIFREQ",93,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///3" D ^DIE
"RTN","MPIFREQ",94,0)
 K DIE,DA,DR
"RTN","MPIFREQ",95,0)
 Q
"RTN","MPIFREQ",96,0)
 ;
"RTN","MPIFREQ",97,0)
PUSH(IEN) ;Change of CMOR Request is a Push
"RTN","MPIFREQ",98,0)
 ; just want to get request into 984.9 for
"RTN","MPIFREQ",99,0)
 ; tracking purposes, marking it as approved
"RTN","MPIFREQ",100,0)
 N DA,DIE,X,Y,TEXT
"RTN","MPIFREQ",101,0)
 S DIE="^MPIF(984.9,",DA=IEN,TEXT="Auto change - CMOR pushed here"
"RTN","MPIFREQ",102,0)
 S DR=".06///4;1.03///4;3.01///"_TEXT_";.09///`"_+$$SITE^VASITE()
"RTN","MPIFREQ",103,0)
 D ^DIE
"RTN","MPIFREQ",104,0)
 Q
"RTN","MPIFRES")
0^1^B14703475
"RTN","MPIFRES",1,0)
MPIFRES ;SF/CMC-LOCAL AND MISSING ICN RESOLUTION ;JUL 13, 1998
"RTN","MPIFRES",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,7,10,15,17,21,26**;30 Apr 99
"RTN","MPIFRES",3,0)
 ;
"RTN","MPIFRES",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFRES",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFRES",6,0)
 ;  ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFRES",7,0)
 ;  ^RGHL7(991.1 - #3259
"RTN","MPIFRES",8,0)
 ;  ^RGSITE - #2746
"RTN","MPIFRES",9,0)
 ;
"RTN","MPIFRES",10,0)
BKG ;
"RTN","MPIFRES",11,0)
 S ZTRTN="GO^MPIFRES",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFRES",12,0)
 D NOW^%DTC
"RTN","MPIFRES",13,0)
 S ZTIO="",ZTDTH=%
"RTN","MPIFRES",14,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFRES",15,0)
 D ^%ZTLOAD
"RTN","MPIFRES",16,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFRES",17,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFRES",18,0)
 Q
"RTN","MPIFRES",19,0)
 ;
"RTN","MPIFRES",20,0)
GO ;ENTRY POINT
"RTN","MPIFRES",21,0)
 N MPIMORE,MPITOT
"RTN","MPIFRES",22,0)
 L +^XTMP("MPIF RESOLUTION"):3 E  Q
"RTN","MPIFRES",23,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFRES",24,0)
 ;
"RTN","MPIFRES",25,0)
 K ^TMP("HLS",$J),STOP
"RTN","MPIFRES",26,0)
 D START^RGHLLOG()
"RTN","MPIFRES",27,0)
 D HLRDF
"RTN","MPIFRES",28,0)
 I $D(STOP) K STOP Q  ;patch 7 added to quit if init returned an error
"RTN","MPIFRES",29,0)
 D LOOP
"RTN","MPIFRES",30,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFRES",31,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFRES",32,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIHL,MPIMIDT,MPIMSH
"RTN","MPIFRES",33,0)
 K MPIOUT,MPIQRYNM,MPISEQ,QCNT,MPIMCNT,MPIMTX,ENDT,MPIFRES
"RTN","MPIFRES",34,0)
 L -^XTMP("MPIF RESOLUTION")
"RTN","MPIFRES",35,0)
 ; mark job completion date/time
"RTN","MPIFRES",36,0)
 S $P(^RGSITE(991.8,1,0),"^",4)=$$NOW^XLFDT
"RTN","MPIFRES",37,0)
 Q
"RTN","MPIFRES",38,0)
 ;
"RTN","MPIFRES",39,0)
HLRDF ;
"RTN","MPIFRES",40,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFRES",41,0)
 S MPIHL("ECH")="^~\&"
"RTN","MPIFRES",42,0)
 S MPIHL("FS")="|"
"RTN","MPIFRES",43,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.MPIHL)
"RTN","MPIFRES",44,0)
 I $O(MPIHL("")) D EXC^RGHLLOG(220,"INIT^HLFNC2 call error returned") S STOP="" Q
"RTN","MPIFRES",45,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFRES",46,0)
 Q
"RTN","MPIFRES",47,0)
LOOP ;
"RTN","MPIFRES",48,0)
 S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",49,0)
 D MAKE
"RTN","MPIFRES",50,0)
 Q
"RTN","MPIFRES",51,0)
SEND ;ready to send
"RTN","MPIFRES",52,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFRES",53,0)
 I +MPIEROR=0 D EXC^RGHLLOG(220,"GENERATE^HLMA call returned error") Q
"RTN","MPIFRES",54,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFRES",55,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",56,0)
 Q
"RTN","MPIFRES",57,0)
MAKE ;
"RTN","MPIFRES",58,0)
 N LOCAL,MPIIT,TICN,STOP,X,Y,%,%H,%I,TODAY,SITE
"RTN","MPIFRES",59,0)
 S LOCAL="",MPIIT=0,MPIFRES="",SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFRES",60,0)
 D NOW^%DTC S TODAY=X
"RTN","MPIFRES",61,0)
 ;local ICNs
"RTN","MPIFRES",62,0)
 F  S MPIIT=$O(^DPT("AICNL",1,MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",63,0)
 .; LINE BELOW ADDED FOR PATCH 26 TO CLEANUP AICNL X-REF WHEN LEFT AROUND
"RTN","MPIFRES",64,0)
 .I $E($$GETICN^MPIF001(MPIIT),1,3)'=SITE K ^DPT("AICNL",1,MPIIT) Q
"RTN","MPIFRES",65,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=1
"RTN","MPIFRES",66,0)
 .; ^ only send patient to MPI for Local ICN resolution 1 time
"RTN","MPIFRES",67,0)
 .I $D(^RGHL7(991.1,"ADFN",218,MPIIT)) S ^DPT("AICNL",1,MPIIT)="1^"_TODAY Q
"RTN","MPIFRES",68,0)
 .; ^ checking if potential match exception
"RTN","MPIFRES",69,0)
 .D MAKE3
"RTN","MPIFRES",70,0)
 ;missing ICNs
"RTN","MPIFRES",71,0)
 S MPIIT=0
"RTN","MPIFRES",72,0)
 F  S MPIIT=$O(^DPT("AMPIMIS",MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",73,0)
 .K STOP
"RTN","MPIFRES",74,0)
 .S TICN=+$$GETICN^MPIF001(MPIIT)
"RTN","MPIFRES",75,0)
 .I TICN<0,'$D(STOP) D MAKE3
"RTN","MPIFRES",76,0)
 .I TICN>0 K ^DPT("AMPIMIS",MPIIT)
"RTN","MPIFRES",77,0)
 Q
"RTN","MPIFRES",78,0)
MAKE3 ;
"RTN","MPIFRES",79,0)
 K MPIOUT
"RTN","MPIFRES",80,0)
 S MPIFRES=""
"RTN","MPIFRES",81,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFRES",82,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.MPIHL,.MPIQRYNM)
"RTN","MPIFRES",83,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFRES",84,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFRES",85,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" Q
"RTN","MPIFRES",86,0)
 Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFRES",87,0)
 S ^DPT("AICNL",1,MPIIT)="1^"_TODAY
"RTN","MPIFRES",88,0)
 ; ^ mark Local ICN as having been sent to MPI for resolution
"RTN","MPIFRES",89,0)
 ;call for HL7 header
"RTN","MPIFRES",90,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFRES",91,0)
 D MSH^HLFNC2(.MPIHL,MPIMIDT,.MPIMSH)
"RTN","MPIFRES",92,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFRES",93,0)
 ;MESSAGE BUILT
"RTN","MPIFRES",94,0)
 S MPISEQ=0
"RTN","MPIFRES",95,0)
 F  S MPISEQ=$O(MPIOUT(MPISEQ)) Q:MPISEQ'>0  D
"RTN","MPIFRES",96,0)
 .S ^TMP("HLS",$J,MPICNT)=MPIOUT(MPISEQ)
"RTN","MPIFRES",97,0)
 .S MPICNT=MPICNT+1
"RTN","MPIFRES",98,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFRES",99,0)
 I MPIDNUM>100 D
"RTN","MPIFRES",100,0)
 .D SEND
"RTN","MPIFRES",101,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",102,0)
 .D HLRDF
"RTN","MPIFRES",103,0)
 Q
"VER")
8.0^22.0
**END**
**END**
