Released GMRA*4*22 SEQ #19
Extracted from mail message
**KIDS**:GMRA*4.0*22^

**INSTALL NAME**
GMRA*4.0*22
"BLD",5282,0)
GMRA*4.0*22^ADVERSE REACTION TRACKING^0^3041221^y
"BLD",5282,1,0)
^^2^2^3040929^
"BLD",5282,1,1,0)
HDR related changes.  Please see FORUM patch description
"BLD",5282,1,2,0)
for details regarding this patch.
"BLD",5282,4,0)
^9.64PA^^
"BLD",5282,"ABPKG")
n
"BLD",5282,"INIT")
POSTKID^GMRAIVDK
"BLD",5282,"KRN",0)
^9.67PA^8989.52^19
"BLD",5282,"KRN",.4,0)
.4
"BLD",5282,"KRN",.401,0)
.401
"BLD",5282,"KRN",.402,0)
.402
"BLD",5282,"KRN",.403,0)
.403
"BLD",5282,"KRN",.5,0)
.5
"BLD",5282,"KRN",.84,0)
.84
"BLD",5282,"KRN",3.6,0)
3.6
"BLD",5282,"KRN",3.8,0)
3.8
"BLD",5282,"KRN",9.2,0)
9.2
"BLD",5282,"KRN",9.8,0)
9.8
"BLD",5282,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",5282,"KRN",9.8,"NM",1,0)
GMRAIAD1^^0^B59578836
"BLD",5282,"KRN",9.8,"NM",2,0)
GMRAIAD2^^0^B11418385
"BLD",5282,"KRN",9.8,"NM",3,0)
GMRAIAL1^^0^B24680189
"BLD",5282,"KRN",9.8,"NM",4,0)
GMRAIAL2^^0^B20897543
"BLD",5282,"KRN",9.8,"NM",5,0)
GMRAIVDK^^0^B5285280
"BLD",5282,"KRN",9.8,"NM","B","GMRAIAD1",1)

"BLD",5282,"KRN",9.8,"NM","B","GMRAIAD2",2)

"BLD",5282,"KRN",9.8,"NM","B","GMRAIAL1",3)

"BLD",5282,"KRN",9.8,"NM","B","GMRAIAL2",4)

"BLD",5282,"KRN",9.8,"NM","B","GMRAIVDK",5)

"BLD",5282,"KRN",19,0)
19
"BLD",5282,"KRN",19.1,0)
19.1
"BLD",5282,"KRN",101,0)
101
"BLD",5282,"KRN",101,"NM",0)
^9.68A^6^6
"BLD",5282,"KRN",101,"NM",1,0)
GMRA VDEF ORU R01 ADV ASSESS HR^^0
"BLD",5282,"KRN",101,"NM",2,0)
GMRA VDEF ORU R01 ADV ASSESS VS^^0
"BLD",5282,"KRN",101,"NM",3,0)
GMRA VDEF ORU R01 ADV REACT HR^^0
"BLD",5282,"KRN",101,"NM",4,0)
GMRA VDEF ORU R01 ADV REACT VS^^0
"BLD",5282,"KRN",101,"NM",5,0)
GMRA VDEF ORU R01 ALLERGY HR^^0
"BLD",5282,"KRN",101,"NM",6,0)
GMRA VDEF ORU R01 ALLERGY VS^^0
"BLD",5282,"KRN",101,"NM","B","GMRA VDEF ORU R01 ADV ASSESS HR",1)

"BLD",5282,"KRN",101,"NM","B","GMRA VDEF ORU R01 ADV ASSESS VS",2)

"BLD",5282,"KRN",101,"NM","B","GMRA VDEF ORU R01 ADV REACT HR",3)

"BLD",5282,"KRN",101,"NM","B","GMRA VDEF ORU R01 ADV REACT VS",4)

"BLD",5282,"KRN",101,"NM","B","GMRA VDEF ORU R01 ALLERGY HR",5)

"BLD",5282,"KRN",101,"NM","B","GMRA VDEF ORU R01 ALLERGY VS",6)

"BLD",5282,"KRN",409.61,0)
409.61
"BLD",5282,"KRN",771,0)
771
"BLD",5282,"KRN",771,"NM",0)
^9.68A^4^4
"BLD",5282,"KRN",771,"NM",1,0)
GMRA VDEF IE SIDE^^0
"BLD",5282,"KRN",771,"NM",2,0)
HDRADAS^^0
"BLD",5282,"KRN",771,"NM",3,0)
HDRADRA^^0
"BLD",5282,"KRN",771,"NM",4,0)
HDRALGY^^0
"BLD",5282,"KRN",771,"NM","B","GMRA VDEF IE SIDE",1)

"BLD",5282,"KRN",771,"NM","B","HDRADAS",2)

"BLD",5282,"KRN",771,"NM","B","HDRADRA",3)

"BLD",5282,"KRN",771,"NM","B","HDRALGY",4)

"BLD",5282,"KRN",870,0)
870
"BLD",5282,"KRN",8989.51,0)
8989.51
"BLD",5282,"KRN",8989.52,0)
8989.52
"BLD",5282,"KRN",8994,0)
8994
"BLD",5282,"KRN","B",.4,.4)

"BLD",5282,"KRN","B",.401,.401)

"BLD",5282,"KRN","B",.402,.402)

"BLD",5282,"KRN","B",.403,.403)

"BLD",5282,"KRN","B",.5,.5)

"BLD",5282,"KRN","B",.84,.84)

"BLD",5282,"KRN","B",3.6,3.6)

"BLD",5282,"KRN","B",3.8,3.8)

"BLD",5282,"KRN","B",9.2,9.2)

"BLD",5282,"KRN","B",9.8,9.8)

"BLD",5282,"KRN","B",19,19)

"BLD",5282,"KRN","B",19.1,19.1)

"BLD",5282,"KRN","B",101,101)

"BLD",5282,"KRN","B",409.61,409.61)

"BLD",5282,"KRN","B",771,771)

"BLD",5282,"KRN","B",870,870)

"BLD",5282,"KRN","B",8989.51,8989.51)

"BLD",5282,"KRN","B",8989.52,8989.52)

"BLD",5282,"KRN","B",8994,8994)

"BLD",5282,"QUES",0)
^9.62^^
"BLD",5282,"REQB",0)
^9.611^2^2
"BLD",5282,"REQB",1,0)
GMRA*4.0*18^1
"BLD",5282,"REQB",2,0)
VDEF 1.00^1
"BLD",5282,"REQB","B","GMRA*4.0*18",1)

"BLD",5282,"REQB","B","VDEF 1.00",2)

"INIT")
POSTKID^GMRAIVDK
"KRN",101,6530,-1)
0^3
"KRN",101,6530,0)
GMRA VDEF ORU R01 ADV REACT HR^^^S^^^^^^^^
"KRN",101,6530,770)
^GMRA VDEF IE SIDE^^^^^VDEFVIE2^^^^ACK
"KRN",101,6530,773)
1^1
"KRN",101,6531,-1)
0^4
"KRN",101,6531,0)
GMRA VDEF ORU R01 ADV REACT VS^^^E^^^^^^^^
"KRN",101,6531,1,0)
^^1^1^3040713^
"KRN",101,6531,1,1,0)
VistA VDEF Adverse Reaction Report HL7 message
"KRN",101,6531,770)
HDRADRA^^ORU^R01^^^^AL^NE^2.4^
"KRN",101,6531,775,0)
^101.0775PA^1^1
"KRN",101,6531,775,1,0)
6530
"KRN",101,6531,775,1,"^")
GMRA VDEF ORU R01 ADV REACT HR
"KRN",101,6532,-1)
0^5
"KRN",101,6532,0)
GMRA VDEF ORU R01 ALLERGY HR^^^S^^^^^^^^
"KRN",101,6532,99)
59813,31953
"KRN",101,6532,770)
^GMRA VDEF IE SIDE^^^^^VDEFVIE2^^^^ACK
"KRN",101,6532,773)
1^1
"KRN",101,6533,-1)
0^6
"KRN",101,6533,0)
GMRA VDEF ORU R01 ALLERGY VS^^^E^^^^^^^^
"KRN",101,6533,1,0)
^^1^1^3040713^
"KRN",101,6533,1,1,0)
VistA VDEF Allergy Update/Insert HL7 message
"KRN",101,6533,770)
HDRALGY^^ORU^R01^^^^AL^NE^2.4^
"KRN",101,6533,775,0)
^101.0775PA^1^1
"KRN",101,6533,775,1,0)
6532
"KRN",101,6533,775,1,"^")
GMRA VDEF ORU R01 ALLERGY HR
"KRN",101,6534,-1)
0^1
"KRN",101,6534,0)
GMRA VDEF ORU R01 ADV ASSESS HR^^^S^^^^^^^^
"KRN",101,6534,770)
^GMRA VDEF IE SIDE^^^^^VDEFVIE2^^^^ACK
"KRN",101,6534,773)
1^1
"KRN",101,6535,-1)
0^2
"KRN",101,6535,0)
GMRA VDEF ORU R01 ADV ASSESS VS^^^E^^^^^^^^
"KRN",101,6535,1,0)
^^1^1^3040713^
"KRN",101,6535,1,1,0)
VistA VDEF Adverse Reaction Assessment HL7 message
"KRN",101,6535,770)
HDRADAS^^ORU^R01^^^^AL^NE^2.4^
"KRN",101,6535,775,0)
^101.0775PA^1^1
"KRN",101,6535,775,1,0)
6534
"KRN",101,6535,775,1,"^")
GMRA VDEF ORU R01 ADV ASSESS HR
"KRN",771,122,-1)
0^1
"KRN",771,122,0)
GMRA VDEF IE SIDE^a^200HD~HDR.MED.VA.GOV~DNS^^^^US
"KRN",771,122,"EC")

"KRN",771,122,"FS")

"KRN",771,123,-1)
0^3
"KRN",771,123,0)
HDRADRA^a^^^^^US
"KRN",771,124,-1)
0^4
"KRN",771,124,0)
HDRALGY^a^^^^^US
"KRN",771,125,-1)
0^2
"KRN",771,125,0)
HDRADAS^a^^^^^US
"MBREQ")
0
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;HLAPDEL^XPDIA1(%)
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
22^3041221^1326
"PKG",140,22,1,"PAH",1,1,0)
^^2^2^3041221
"PKG",140,22,1,"PAH",1,1,1,0)
HDR related changes.  Please see FORUM patch description
"PKG",140,22,1,"PAH",1,1,2,0)
for details regarding this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","GMRAIAD1")
0^1^B59578836
"RTN","GMRAIAD1",1,0)
GMRAIAD1 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ADVERSE REACTION - PART 1 ;12/21/04  07:49
"RTN","GMRAIAD1",2,0)
 ;;4.0;Adverse Reaction Tracking;**22**;Mar 29, 1996
"RTN","GMRAIAD1",3,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","GMRAIAD1",4,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy adverse reaction
"RTN","GMRAIAD1",5,0)
 ;
"RTN","GMRAIAD1",6,0)
 ; This routines uses the following IAs:
"RTN","GMRAIAD1",7,0)
 ;   #4248 - VDEFEL calls         (controlled)
"RTN","GMRAIAD1",8,0)
 ;   #3630 - VAFCQRY calls        (controlled)
"RTN","GMRAIAD1",9,0)
 ;   #2196 - ^PS(50.416,IEN,0)    (controlled)
"RTN","GMRAIAD1",10,0)
 ;   #4571 - ERR^VDEFREQ          (controlled)
"RTN","GMRAIAD1",11,0)
 ;
"RTN","GMRAIAD1",12,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","GMRAIAD1",13,0)
 ;
"RTN","GMRAIAD1",14,0)
 ; This routine calls GMRAIAD2 for a portion of message
"RTN","GMRAIAD1",15,0)
 ;
"RTN","GMRAIAD1",16,0)
 Q
"RTN","GMRAIAD1",17,0)
 ;
"RTN","GMRAIAD1",18,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ;
"RTN","GMRAIAD1",19,0)
 ;
"RTN","GMRAIAD1",20,0)
 ; Inputs: EVIEN = IEN of message in file 577
"RTN","GMRAIAD1",21,0)
 ;         KEY - IEN of file to create message from
"RTN","GMRAIAD1",22,0)
 ;         VFLAG - "V" for VistA HL7 destination (default)
"RTN","GMRAIAD1",23,0)
 ;         OUT - target array, passed by reference
"RTN","GMRAIAD1",24,0)
 ;         MSHP - Piece 4 contains message subtype
"RTN","GMRAIAD1",25,0)
 ;
"RTN","GMRAIAD1",26,0)
 ; Output: Two part string with parts separated by "^"
"RTN","GMRAIAD1",27,0)
 ;         Part 1: "LM" - output in local array passed in "OUT" parameter
"RTN","GMRAIAD1",28,0)
 ;                 "GM" - output in ^TMP("HLS",$J)
"RTN","GMRAIAD1",29,0)
 ;         Part 2: No longer used
"RTN","GMRAIAD1",30,0)
 ;
"RTN","GMRAIAD1",31,0)
 N DFN,HLFS,HLCM,HLSC,HLRP,HLES,HLQ,ALRDATA,DTE,DTP,ADD
"RTN","GMRAIAD1",32,0)
 N DATA,VAL,I,S,X,Y,Z,X1,X2,HL7RC,IEN,OUTX,LIKE,LIKERSP,PIDSEG,SEQ
"RTN","GMRAIAD1",33,0)
 N SEPF,SEPC,SEPR,SEPE,SEPS,ARRAY,PTC,CMP
"RTN","GMRAIAD1",34,0)
 ;
"RTN","GMRAIAD1",35,0)
 ; Initialize stuff
"RTN","GMRAIAD1",36,0)
 K ^TMP("HLS",$J) S S=0,ARRAY="OUT("_"""HLS"""_",S)",TARGET="LM^"
"RTN","GMRAIAD1",37,0)
 ;
"RTN","GMRAIAD1",38,0)
 ; Set up HL7 delimiters
"RTN","GMRAIAD1",39,0)
 S HLCM=$E(VDEFHL("ECH")),HLRP=$E(VDEFHL("ECH"),2),HLSC=$E(VDEFHL("ECH"),4),HLES=$E(VDEFHL("ECH"),3)
"RTN","GMRAIAD1",40,0)
 S HLFS=VDEFHL("FS"),HLQ=VDEFHL("Q"),HL7RC=HLES_HLFS_HLCM_HLRP_HLSC
"RTN","GMRAIAD1",41,0)
 D SETDLMS^VDEFEL
"RTN","GMRAIAD1",42,0)
 ;
"RTN","GMRAIAD1",43,0)
 ; Get allergy data & patient ID
"RTN","GMRAIAD1",44,0)
 S ALRDATA=^GMR(120.85,KEY,0),DFN=$P(ALRDATA,U,2)
"RTN","GMRAIAD1",45,0)
 ;
"RTN","GMRAIAD1",46,0)
 ; Build segments for message in OUT, $P # = HL7 field #
"RTN","GMRAIAD1",47,0)
 ;
"RTN","GMRAIAD1",48,0)
 ; PID - Use MPI PID builder
"RTN","GMRAIAD1",49,0)
PID K PIDSEG S OUTX="",S=1,SEQ=""
"RTN","GMRAIAD1",50,0)
 I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No entry in ^DPT for DFN "_DFN) S ZTSTOP=1 G EXIT
"RTN","GMRAIAD1",51,0)
 D BLDPID^VAFCQRY(DFN,1,SEQ,.PIDSEG,.VDEFHL)
"RTN","GMRAIAD1",52,0)
 F I=2:1 Q:$G(PIDSEG(I))=""  S PIDSEG(1,I-1)=PIDSEG(I) K PIDSEG(I)
"RTN","GMRAIAD1",53,0)
 M OUTX=PIDSEG(1) K PIDSEG D SAVE
"RTN","GMRAIAD1",54,0)
 ;
"RTN","GMRAIAD1",55,0)
 ; OBR
"RTN","GMRAIAD1",56,0)
OBR S S=S+1,OUTX="",$P(OUTX,HLFS)=1,$P(OUTX,HLFS,25)="F"
"RTN","GMRAIAD1",57,0)
 S VAL=KEY_HLCM_$P(SITEPARM,U,4)_"_120.85",$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD1",58,0)
 S $P(OUTX,HLFS,4)="ADVERSE REACTION REPORT"_HLCM_HLCM_"L"
"RTN","GMRAIAD1",59,0)
 ;
"RTN","GMRAIAD1",60,0)
 ;Date/time reaction occured
"RTN","GMRAIAD1",61,0)
 S $P(OUTX,HLFS,7)=$$TS^VDEFEL($P(ALRDATA,U,1))
"RTN","GMRAIAD1",62,0)
 ;
"RTN","GMRAIAD1",63,0)
 ; Entering User
"RTN","GMRAIAD1",64,0)
 S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,19)),$P(VAL,HLCM,8)="ENT",$P(OUTX,HLFS,32)=VAL
"RTN","GMRAIAD1",65,0)
 ;
"RTN","GMRAIAD1",66,0)
 ; Observer (Witness)
"RTN","GMRAIAD1",67,0)
 S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,13)),$P(VAL,HLCM,8)="OBS"
"RTN","GMRAIAD1",68,0)
 ;
"RTN","GMRAIAD1",69,0)
 ; Reporter
"RTN","GMRAIAD1",70,0)
 S X=$P($G(^GMR(120.85,KEY,"RPT")),U,1)
"RTN","GMRAIAD1",71,0)
 S X=HLCM_$P(X,",",1)_HLCM_$P($P(X,",",2)," ",1)_HLCM_$P($P(X,",",2)," ",2)
"RTN","GMRAIAD1",72,0)
 S $P(X,HLCM,8)="RPT",$P(OUTX,HLFS,34)=VAL_HLRP_X
"RTN","GMRAIAD1",73,0)
 ;
"RTN","GMRAIAD1",74,0)
 ; Related Reaction
"RTN","GMRAIAD1",75,0)
 S X=$P(ALRDATA,U,15)_HLCM_$P($G(^GMR(120.8,$P(ALRDATA,U,15),0)),U,2)_HLCM_"L"
"RTN","GMRAIAD1",76,0)
 S $P(OUTX,HLFS,47)=X
"RTN","GMRAIAD1",77,0)
 S OUTX="OBR"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",78,0)
 ;
"RTN","GMRAIAD1",79,0)
 ; OBX 1 - Symptoms
"RTN","GMRAIAD1",80,0)
OBX1 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"SYMPTOM"_HLFS
"RTN","GMRAIAD1",81,0)
 ;
"RTN","GMRAIAD1",82,0)
 ; Get the reactions
"RTN","GMRAIAD1",83,0)
 S X=0,(Y,Z)="" F  S X=$O(^GMR(120.85,KEY,2,X))  Q:X'?1N.N  D
"RTN","GMRAIAD1",84,0)
 . S Y=^GMR(120.85,KEY,2,X,0),VAL=$P(Y,U,3)
"RTN","GMRAIAD1",85,0)
 . I $P(Y,U,2)'="" S Z=Z_$P(Y,U,2)_HLRP
"RTN","GMRAIAD1",86,0)
 . E  S Z=Z_$P(^GMRD(120.83,+Y,0),U,1)_HLRP
"RTN","GMRAIAD1",87,0)
 S $P(OUTX,HLFS,5)=$E(Z,1,$L(Z)-1),$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",88,0)
 ;
"RTN","GMRAIAD1",89,0)
 ; Reaction entered by
"RTN","GMRAIAD1",90,0)
 S $P(OUTX,HLFS,16)=$$XCN200^VDEFEL(VAL)
"RTN","GMRAIAD1",91,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",92,0)
 ;
"RTN","GMRAIAD1",93,0)
 ; RXA/RXE/RXR/OBX Suspected Agent Group
"RTN","GMRAIAD1",94,0)
 G OBX2:$G(^GMR(120.85,KEY,3,1,0))="" S IEN=0
"RTN","GMRAIAD1",95,0)
RXAGRP1 F  S IEN=$O(^GMR(120.85,KEY,3,IEN)) Q:IEN'?1N.N  D
"RTN","GMRAIAD1",96,0)
 . S S=S+1,OUTX="0"_HLFS_"1" K ALRDATA M ALRDATA=^GMR(120.85,KEY,3,IEN)
"RTN","GMRAIAD1",97,0)
 . ;
"RTN","GMRAIAD1",98,0)
 . ; RXA
"RTN","GMRAIAD1",99,0)
 . ; Start & Stop dates
"RTN","GMRAIAD1",100,0)
 . S VAL=$P($G(ALRDATA(1)),U) I VAL S $P(OUTX,HLFS,3)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",101,0)
 . S VAL=$P($G(ALRDATA(1)),U,2) I VAL S $P(OUTX,HLFS,4)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",102,0)
 . ;
"RTN","GMRAIAD1",103,0)
 . ; Suspected agent & daily dose
"RTN","GMRAIAD1",104,0)
 . S VAL=$P(ALRDATA(0),U),$P(OUTX,HLFS,5)=$$HL7RC(VAL)
"RTN","GMRAIAD1",105,0)
 . S VAL=$P(ALRDATA(0),U,2),$P(OUTX,HLFS,6)=$$HL7RC(VAL)
"RTN","GMRAIAD1",106,0)
 . ;
"RTN","GMRAIAD1",107,0)
 . ; Lot number, Exp. Date, Manufacturer
"RTN","GMRAIAD1",108,0)
 . S VAL=$P(ALRDATA(0),U,8) S:VAL $P(OUTX,HLFS,15)=$$HL7RC(VAL)
"RTN","GMRAIAD1",109,0)
 . S VAL=$P($G(ALRDATA(1)),U,3) I VAL S $P(OUTX,HLFS,16)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",110,0)
 . S VAL=$P(ALRDATA(0),U,7) S:VAL $P(OUTX,HLFS,17)=$$HL7RC(VAL)
"RTN","GMRAIAD1",111,0)
 . ;
"RTN","GMRAIAD1",112,0)
 . ; Indication for use
"RTN","GMRAIAD1",113,0)
 . S VAL=$P(ALRDATA(0),U,4) S:VAL $P(OUTX,HLFS,19)=$$HL7RC(VAL)
"RTN","GMRAIAD1",114,0)
 . ;
"RTN","GMRAIAD1",115,0)
 . ; Set into array
"RTN","GMRAIAD1",116,0)
 . S OUTX="RXA"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",117,0)
 . ;
"RTN","GMRAIAD1",118,0)
 . ; RXE
"RTN","GMRAIAD1",119,0)
 . S S=S+1,OUTX="",CMP=""
"RTN","GMRAIAD1",120,0)
 . ;
"RTN","GMRAIAD1",121,0)
 . ; Previous doses
"RTN","GMRAIAD1",122,0)
 . S $P(CMP,HLCM,1)=$$HL7RC($P(ALRDATA(0),U,9))
"RTN","GMRAIAD1",123,0)
 . ;
"RTN","GMRAIAD1",124,0)
 . ; Duration
"RTN","GMRAIAD1",125,0)
 . S X1=$P($G(ALRDATA(1)),U,2),X2=$P($G(ALRDATA(1)),U) D ^%DTC S:X="" X=0 S $P(CMP,HLCM,3)=X
"RTN","GMRAIAD1",126,0)
 . ;
"RTN","GMRAIAD1",127,0)
 . ; Last date given
"RTN","GMRAIAD1",128,0)
 . S VAL=$P(ALRDATA(0),U,10) I VAL S $P(CMP,HLCM,5)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",129,0)
 . S $P(OUTX,HLFS)=CMP,CMP=""
"RTN","GMRAIAD1",130,0)
 . ;
"RTN","GMRAIAD1",131,0)
 . ; Give codes
"RTN","GMRAIAD1",132,0)
 . S VAL=$P(ALRDATA(0),U),$P(CMP,HLCM,1)=$$HL7RC(VAL)
"RTN","GMRAIAD1",133,0)
 . S $P(CMP,HLCM,4)=$P($G(ALRDATA(1)),U,4),$P(CMP,HLCM,6)="NDC"
"RTN","GMRAIAD1",134,0)
 . S $P(OUTX,HLFS,2)=CMP,$P(OUTX,HLFS,3)=0
"RTN","GMRAIAD1",135,0)
 . ;
"RTN","GMRAIAD1",136,0)
 . ; SIG
"RTN","GMRAIAD1",137,0)
 . S $P(OUTX,HLFS,7)=$$HL7RC($P($G(ALRDATA(1)),U,5))
"RTN","GMRAIAD1",138,0)
 . ;
"RTN","GMRAIAD1",139,0)
 . ; Daily dose
"RTN","GMRAIAD1",140,0)
 . S $P(OUTX,HLFS,19)=$$HL7RC($P(ALRDATA(0),U,2))
"RTN","GMRAIAD1",141,0)
 . S OUTX="RXE"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",142,0)
 . ;
"RTN","GMRAIAD1",143,0)
 . ; RXR
"RTN","GMRAIAD1",144,0)
 . ; Route of administration
"RTN","GMRAIAD1",145,0)
 . S OUTX="",VAL=$P(ALRDATA(0),U,3) S:VAL="" VAL="UNKNOWN" S $P(OUTX,HLFS,1)=$$HL7RC(VAL)
"RTN","GMRAIAD1",146,0)
 . S S=S+1,OUTX="RXR"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",147,0)
 . ;
"RTN","GMRAIAD1",148,0)
 . ; OBX - LIKES
"RTN","GMRAIAD1",149,0)
 . S LIKERSP=$G(ALRDATA("LIKE")) I LIKERSP'="" F LIKE=1:1:6 D
"RTN","GMRAIAD1",150,0)
 . . S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD1",151,0)
 . . S VAL="LIKE "_LIKE_HLCM_$P($T(LIKEQ+(LIKE)),";",2),$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD1",152,0)
 . . S VAL=$P(ALRDATA(0),U,1)_HLCM,X=$P(LIKERSP,U,LIKE)
"RTN","GMRAIAD1",153,0)
 . . S X=$S(X="y":"YES",X="n":"NO",1:"UNKNOWN")
"RTN","GMRAIAD1",154,0)
 . . S VAL=VAL_X_HLCM_"HL70136",$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",155,0)
 . . S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",156,0)
 . . ;
"RTN","GMRAIAD1",157,0)
 . . ; Likelihood
"RTN","GMRAIAD1",158,0)
 . . S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"LIKELIHOOD"
"RTN","GMRAIAD1",159,0)
 . . S VAL=$P(LIKERSP,U,7) S:VAL="" VAL=5
"RTN","GMRAIAD1",160,0)
 . . S X=VAL_HLCM_$P("REMOTE,POSSIBLE,PROBABLE,HIGHLY PROBABLE, ",",",VAL)
"RTN","GMRAIAD1",161,0)
 . . S $P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",162,0)
 . . S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",163,0)
 ;
"RTN","GMRAIAD1",164,0)
 ; OBX2 - Lab Results
"RTN","GMRAIAD1",165,0)
OBX2 S X=$G(^GMR(120.85,KEY,4,0)) G CALL:X=""
"RTN","GMRAIAD1",166,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,KEY,4,IEN)) Q:IEN'?1N.N  D
"RTN","GMRAIAD1",167,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD1",168,0)
 . S X=^GMR(120.85,KEY,4,IEN,0),$P(OUTX,HLFS,3)=$$HL7RC($P(X,U,1))
"RTN","GMRAIAD1",169,0)
 . S $P(OUTX,HLFS,5)=$$HL7RC($P(X,U,2)),$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",170,0)
 . S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(X,U,3))
"RTN","GMRAIAD1",171,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",172,0)
 ;
"RTN","GMRAIAD1",173,0)
 ; Call GMRAIAD2
"RTN","GMRAIAD1",174,0)
CALL D ENTRY^GMRAIAD2
"RTN","GMRAIAD1",175,0)
 ;
"RTN","GMRAIAD1",176,0)
 ; OBX10 - IND/NDA Info
"RTN","GMRAIAD1",177,0)
OBX10 S X=$G(^GMR(120.85,KEY,"MFR2")) G RXAGRP2:X=""
"RTN","GMRAIAD1",178,0)
 S S=S+1,OUTX=1_HLFS_"ST",$P(OUTX,HLFS,5)=$P(X,U,1)
"RTN","GMRAIAD1",179,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",180,0)
 ;
"RTN","GMRAIAD1",181,0)
 ; RXA/RXE Concommitant Drugs Group
"RTN","GMRAIAD1",182,0)
RXAGRP2 S X=$G(^GMR(120.85,KEY,13,0)) G EXIT:X=""
"RTN","GMRAIAD1",183,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,KEY,13,IEN)) Q:IEN'?1N.N  D
"RTN","GMRAIAD1",184,0)
 . ;
"RTN","GMRAIAD1",185,0)
 . ; RXA
"RTN","GMRAIAD1",186,0)
 . S X=^GMR(120.85,KEY,13,IEN,0),S=S+1,OUTX=0_HLFS_1
"RTN","GMRAIAD1",187,0)
 . ;
"RTN","GMRAIAD1",188,0)
 . ; Start Date, Stop Date
"RTN","GMRAIAD1",189,0)
 . I $P(X,U,2)'="" S $P(OUTX,HLFS,3)=$$TS^VDEFEL($P(X,U,2))
"RTN","GMRAIAD1",190,0)
 . I $P(X,U,3)'="" S $P(OUTX,HLFS,4)=$$TS^VDEFEL($P(X,U,3))
"RTN","GMRAIAD1",191,0)
 . ;
"RTN","GMRAIAD1",192,0)
 . ; Drug Name
"RTN","GMRAIAD1",193,0)
 . S $P(OUTX,HLFS,5)=$$HL7RC($P(X,U,1)),$P(OUTX,HLFS,6)=0
"RTN","GMRAIAD1",194,0)
 . S OUTX="RXA"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",195,0)
 . ;
"RTN","GMRAIAD1",196,0)
 . ; RXE
"RTN","GMRAIAD1",197,0)
 . ; Stop Date
"RTN","GMRAIAD1",198,0)
 . S S=S+1,OUTX="",VAL=$$TS^VDEFEL($P(X,U,3))
"RTN","GMRAIAD1",199,0)
 . S Y="",$P(Y,HLCM,5)=VAL,$P(OUTX,HLFS,1)=Y
"RTN","GMRAIAD1",200,0)
 . ;
"RTN","GMRAIAD1",201,0)
 . ; Drug Name
"RTN","GMRAIAD1",202,0)
 . S $P(OUTX,HLFS,2)=$$HL7RC($P(X,U,1)),$P(OUTX,HLFS,3)=0
"RTN","GMRAIAD1",203,0)
 . ;
"RTN","GMRAIAD1",204,0)
 . ; SIG if known
"RTN","GMRAIAD1",205,0)
 . S $P(OUTX,HLFS,5)="UNK",$P(OUTX,HLFS,7)=$$HL7RC($P(X,U,5))
"RTN","GMRAIAD1",206,0)
 . S OUTX="RXE"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",207,0)
 ;
"RTN","GMRAIAD1",208,0)
 ; Done building segments
"RTN","GMRAIAD1",209,0)
EXIT Q TARGET
"RTN","GMRAIAD1",210,0)
 ;
"RTN","GMRAIAD1",211,0)
 ;
"RTN","GMRAIAD1",212,0)
 ; Place current string into message array
"RTN","GMRAIAD1",213,0)
 ; Turn string into array if length >245.
"RTN","GMRAIAD1",214,0)
 ; Move local array to global if needed
"RTN","GMRAIAD1",215,0)
SAVE N I
"RTN","GMRAIAD1",216,0)
 I $P(OUTX,HLFS)'="PID",$L(OUTX)>245 D
"RTN","GMRAIAD1",217,0)
 . K ADD S ADD=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX))
"RTN","GMRAIAD1",218,0)
 . F I=1:1 S ADD(I)=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX)) Q:OUTX=""
"RTN","GMRAIAD1",219,0)
 . K OUTX M OUTX=ADD
"RTN","GMRAIAD1",220,0)
 M @ARRAY=OUTX
"RTN","GMRAIAD1",221,0)
 ;
"RTN","GMRAIAD1",222,0)
 ; Move local array to global if it's getting big.
"RTN","GMRAIAD1",223,0)
 I $P(TARGET,U)="LM",$S<16000 D
"RTN","GMRAIAD1",224,0)
 . K ^TMP("HLS",$J) M ^TMP("HLS",$J)=OUT("HLS") K OUT("HLS")
"RTN","GMRAIAD1",225,0)
 . S $P(TARGET,U)="GM",ARRAY="^TMP("_"""HLS"""_",$J,S)"
"RTN","GMRAIAD1",226,0)
 K OUTX,ADD
"RTN","GMRAIAD1",227,0)
 Q
"RTN","GMRAIAD1",228,0)
 ;
"RTN","GMRAIAD1",229,0)
 ; Replace any HL7 coding chars. in strings with HL7 escape sequence
"RTN","GMRAIAD1",230,0)
 ; Input: X = data string
"RTN","GMRAIAD1",231,0)
HL7RC(X) N OCHR,RCHR,RCHRI,TYPE,I F TYPE="E","F","C","R","S" D
"RTN","GMRAIAD1",232,0)
 . S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","GMRAIAD1",233,0)
 . S OCHR=$E(HL7RC,RCHRI),RCHR=$E("EFSRT",RCHRI)
"RTN","GMRAIAD1",234,0)
 . Q:'$F(X,OCHR)
"RTN","GMRAIAD1",235,0)
 . F I=1:1 Q:$E(X,I)=""  I $E(X,I)=OCHR S X=$E(X,1,I-1)_HLES_RCHR_HLES_$E(X,I+1,999),I=I+3
"RTN","GMRAIAD1",236,0)
 Q X
"RTN","GMRAIAD1",237,0)
 ;
"RTN","GMRAIAD1",238,0)
LIKEQ ; LIKE set
"RTN","GMRAIAD1",239,0)
 ;1. Reaction normally occurs with this reactant?
"RTN","GMRAIAD1",240,0)
 ;2. Administration of the reactant was stopped?
"RTN","GMRAIAD1",241,0)
 ;3. Reaction stopped when the administration of the reactant was terminated?
"RTN","GMRAIAD1",242,0)
 ;4. Reactant was re-administered?
"RTN","GMRAIAD1",243,0)
 ;5. Reaction could be due to the patient current clinical condition?
"RTN","GMRAIAD1",244,0)
 ;6. Reaction reappeared after the reactant was re-administered?
"RTN","GMRAIAD2")
0^2^B11418385
"RTN","GMRAIAD2",1,0)
GMRAIAD2 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ADVERSE REACTION - PART 2 ;10/5/04  08:57
"RTN","GMRAIAD2",2,0)
 ;;4.0;Adverse Reaction Tracking;**22**;Mar 29, 1996
"RTN","GMRAIAD2",3,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy adverse reaction
"RTN","GMRAIAD2",4,0)
 ;
"RTN","GMRAIAD2",5,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAD2",6,0)
 ;   #4248 - VDEFEL calls        (conrolled)
"RTN","GMRAIAD2",7,0)
 ;   #3630 - VAFCQRY calls       (controlled)
"RTN","GMRAIAD2",8,0)
 ;   #2196 - ^PS(50.416,IEN,0)   (controlled)
"RTN","GMRAIAD2",9,0)
 ;
"RTN","GMRAIAD2",10,0)
 ; This routine is called as a subroutine by GMRAIAD1
"RTN","GMRAIAD2",11,0)
 ;
"RTN","GMRAIAD2",12,0)
 Q
"RTN","GMRAIAD2",13,0)
 ;
"RTN","GMRAIAD2",14,0)
ENTRY ; Entry point from GMRAIAD1
"RTN","GMRAIAD2",15,0)
 ;
"RTN","GMRAIAD2",16,0)
 ; OBX3 - QUESTIONS 1 thru 10
"RTN","GMRAIAD2",17,0)
OBX3 S X="",ALRDATA=^GMR(120.85,KEY,0)
"RTN","GMRAIAD2",18,0)
 F I=3:1:7,9:1:11,16,17 S X=X_$P(ALRDATA,U,I)_U
"RTN","GMRAIAD2",19,0)
 F I=1:1:10 D
"RTN","GMRAIAD2",20,0)
 . Q:$P(X,U,I)=""  S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD2",21,0)
 . S VAL=$P(X,U,I)_HLCM_$P($T(QSTNS+(I)),";",2)_HLCM_"HL70136"
"RTN","GMRAIAD2",22,0)
 . S $P(OUTX,HLFS,3)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD2",23,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",24,0)
 ;
"RTN","GMRAIAD2",25,0)
 ; OBX4 - # Days in Hospital
"RTN","GMRAIAD2",26,0)
OBX4 S X=$P(ALRDATA,U,8)+0 G OBX5:X=0
"RTN","GMRAIAD2",27,0)
 S S=S+1,OUTX=1_HLFS_"NM"_HLFS_"DAYS IN HOSPITAL"
"RTN","GMRAIAD2",28,0)
 S $P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD2",29,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",30,0)
 ;
"RTN","GMRAIAD2",31,0)
 ; OBX5 - Other related history
"RTN","GMRAIAD2",32,0)
OBX5 S X=$G(^GMR(120.85,KEY,14,1,0)) G OBX6:X=""
"RTN","GMRAIAD2",33,0)
 S S=S+1,OUTX=1_HLFS_"TX"_HLFS_"Other History"_HLFS_HLFS_$$HL7RC^GMRAIAD1(X)
"RTN","GMRAIAD2",34,0)
 S X=$P(ALRDATA,U,14) I X'="" S $P(OUTX,HLFS,8)=$$EXTERNAL^DILFD(120.85,14.5,,X)
"RTN","GMRAIAD2",35,0)
 S $P(OUTX,HLFS,11)="F",OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",36,0)
 ;
"RTN","GMRAIAD2",37,0)
 ; OBX6 - FDA Questions
"RTN","GMRAIAD2",38,0)
OBX6 S PTC=$G(^GMR(120.85,KEY,"PTC1")) G OBX8:PTC=""
"RTN","GMRAIAD2",39,0)
 F I=1:1:5 D
"RTN","GMRAIAD2",40,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD2",41,0)
 . S VAL="FDAQ"_I_HLCM_$P($T(FDAQ+I),";",2),$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD2",42,0)
 . S VAL=$P(PTC,U,I+(I=5*8)),VAL=VAL_HLCM_$S(VAL="y":"Yes",VAL="n":"No",1:"Unknown")_HLCM_"HL70136"
"RTN","GMRAIAD2",43,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F",OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",44,0)
 ;
"RTN","GMRAIAD2",45,0)
 ; OBX7 - P & T Questions
"RTN","GMRAIAD2",46,0)
OBX7 F I=1:1:3 D
"RTN","GMRAIAD2",47,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS,Y=$$HL7RC^GMRAIAD1("P&T")_" ACTION "
"RTN","GMRAIAD2",48,0)
 . S Y=Y_$P("FDA^MFR^RCPM",U,I)_" REPORT",VAL="PTQ"_I_HLCM_Y,$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD2",49,0)
 . S VAL=$P(X,U,I+8),VAL=VAL_HLCM_$S(VAL="y":"Yes",VAL="n":"No",1:"Unknown")_HLCM_"HL70136"
"RTN","GMRAIAD2",50,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F",OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",51,0)
 ;
"RTN","GMRAIAD2",52,0)
 ; OBX8 - P & T Addendum
"RTN","GMRAIAD2",53,0)
OBX8 S PTC=$O(^GMR(120.85,KEY,"PTC2",0)) G OBX9:PTC="" S IEN=0
"RTN","GMRAIAD2",54,0)
 S VAL=$$TS^VDEFEL(^GMR(120.85,KEY,"PTC2",1,0))
"RTN","GMRAIAD2",55,0)
 F  S IEN=$O(^GMR(120.85,KEY,"PTC2",1,1,IEN)) Q:IEN=""  D
"RTN","GMRAIAD2",56,0)
 . S S=S+1,OUTX=1_HLFS_"TX"_HLFS_$$HL7RC^GMRAIAD1("P&T Addendum")
"RTN","GMRAIAD2",57,0)
 . S $P(OUTX,HLFS,5)=$$HL7RC^GMRAIAD1(^GMR(120.85,KEY,"PTC2",1,1,IEN,0))
"RTN","GMRAIAD2",58,0)
 . S $P(OUTX,HLFS,11)="F",$P(OUTX,HLFS,14)=VAL
"RTN","GMRAIAD2",59,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",60,0)
 ;
"RTN","GMRAIAD2",61,0)
 ; OBX9 - Notification Dates
"RTN","GMRAIAD2",62,0)
OBX9 S VAL=$P(^GMR(120.85,KEY,0),U,12) I VAL'="" D
"RTN","GMRAIAD2",63,0)
 . ;
"RTN","GMRAIAD2",64,0)
 . ; Date MD notified
"RTN","GMRAIAD2",65,0)
 . S VAL=$$TS^VDEFEL(VAL) S S=S+1,OUTX=1_HLFS_"DT"_HLFS_"DATE MD NOTIFIED"
"RTN","GMRAIAD2",66,0)
 . S $P(OUTX,5,HLFS)=VAL,$P(OUTX,11,HLFS)="F"
"RTN","GMRAIAD2",67,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",68,0)
 ;
"RTN","GMRAIAD2",69,0)
 ; Dates reported to FDA, MFR, RCPM, VAERS
"RTN","GMRAIAD2",70,0)
 S PTC=$G(^GMR(120.85,KEY,"PTC1")) G RETURN:PTC=""
"RTN","GMRAIAD2",71,0)
 F I=1:1:5 S VAL=$P(PTC,U,I+4) I VAL'="" D
"RTN","GMRAIAD2",72,0)
 . S VAL=$$TS^VDEFEL(VAL) S S=S+1,OUTX=1_HLFS_"DT"_HLFS_$P($T(RPTXT+I),";",2)
"RTN","GMRAIAD2",73,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD2",74,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",75,0)
 ;
"RTN","GMRAIAD2",76,0)
 ; Return to GMRAIAD1
"RTN","GMRAIAD2",77,0)
RETURN Q
"RTN","GMRAIAD2",78,0)
 ;
"RTN","GMRAIAD2",79,0)
QSTNS ; Question 1-10 Set
"RTN","GMRAIAD2",80,0)
 ;Patient died from reaction?
"RTN","GMRAIAD2",81,0)
 ;Patient treated with RX drug?
"RTN","GMRAIAD2",82,0)
 ;Life threatening illness?
"RTN","GMRAIAD2",83,0)
 ;Required ER/MD visit?
"RTN","GMRAIAD2",84,0)
 ;Required hospitalization?
"RTN","GMRAIAD2",85,0)
 ;Prolonged hospitalization?
"RTN","GMRAIAD2",86,0)
 ;Resulted in permanent disability?
"RTN","GMRAIAD2",87,0)
 ;Patient recovered?
"RTN","GMRAIAD2",88,0)
 ;Is this event a congenital anomaly?
"RTN","GMRAIAD2",89,0)
 ;Did this event require intervention to prevent impairment or damage?
"RTN","GMRAIAD2",90,0)
 ;
"RTN","GMRAIAD2",91,0)
FDAQ ; FDA Questions
"RTN","GMRAIAD2",92,0)
 ;Serious ADR?
"RTN","GMRAIAD2",93,0)
 ;ADR related to new drug? (Marketed within last 2 yrs.)
"RTN","GMRAIAD2",94,0)
 ;Unexpected ADR?
"RTN","GMRAIAD2",95,0)
 ;ADR related to therapeutic failure?
"RTN","GMRAIAD2",96,0)
 ;Dose related?
"RTN","GMRAIAD2",97,0)
 ;
"RTN","GMRAIAD2",98,0)
RPTXT ; Dates Reported Texts
"RTN","GMRAIAD2",99,0)
 ;DATE REPORTED TO FDA
"RTN","GMRAIAD2",100,0)
 ;DATE OF PATIENT CONSENT TO MFR
"RTN","GMRAIAD2",101,0)
 ;DATE SENT TO MFR
"RTN","GMRAIAD2",102,0)
 ;DATE SENT TO RCPM
"RTN","GMRAIAD2",103,0)
 ;DATE SENT TO VAERS
"RTN","GMRAIAL1")
0^3^B24680189
"RTN","GMRAIAL1",1,0)
GMRAIAL1 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ALLERGIES - PART 1 ;12/21/04  07:50
"RTN","GMRAIAL1",2,0)
 ;;4.0;Adverse Reaction Tracking;**22**;Mar 29, 1996
"RTN","GMRAIAL1",3,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","GMRAIAL1",4,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy updates & assessments
"RTN","GMRAIAL1",5,0)
 ;
"RTN","GMRAIAL1",6,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAL1",7,0)
 ;   #4248 - VDEFEL calls       (controlled)
"RTN","GMRAIAL1",8,0)
 ;   #3630 - VAFCQRY calls      (controlled)
"RTN","GMRAIAL1",9,0)
 ;   #2196 - ^PS(50.416,IEN,0)  (controlled)
"RTN","GMRAIAL1",10,0)
 ;   #2574 - $$CLASS2^PSNAPIS   (supported)
"RTN","GMRAIAL1",11,0)
 ;   #4571 - ERR^VDEFREQ        (controlled)
"RTN","GMRAIAL1",12,0)
 ;
"RTN","GMRAIAL1",13,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","GMRAIAL1",14,0)
 ;
"RTN","GMRAIAL1",15,0)
 ; This routine calls GMRAIAL2 for a portion of message
"RTN","GMRAIAL1",16,0)
 ;
"RTN","GMRAIAL1",17,0)
 Q
"RTN","GMRAIAL1",18,0)
 ;
"RTN","GMRAIAL1",19,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ; Entry point
"RTN","GMRAIAL1",20,0)
 ;
"RTN","GMRAIAL1",21,0)
 ; Inputs: EVIEN = IEN of VDEF Event in file 577
"RTN","GMRAIAL1",22,0)
 ;         KEY - IEN of file to create message from
"RTN","GMRAIAL1",23,0)
 ;         VFLAG - "V" for VistA HL7 destination (default)
"RTN","GMRAIAL1",24,0)
 ;         OUT - target array, passed by reference
"RTN","GMRAIAL1",25,0)
 ;         MSHP - Piece 4 contains message sutbtype
"RTN","GMRAIAL1",26,0)
 ;
"RTN","GMRAIAL1",27,0)
 ; Output: Two part string with parts separated by "^"
"RTN","GMRAIAL1",28,0)
 ;         Part 1: "LM" - output in local array passed in "OUT" parameter
"RTN","GMRAIAL1",29,0)
 ;                 "GM" - output in ^TMP("HLS",$J)
"RTN","GMRAIAL1",30,0)
 ;         Part 2: No longer used
"RTN","GMRAIAL1",31,0)
 ;
"RTN","GMRAIAL1",32,0)
 N DFN,HLFS,HLCM,HLSC,HLRP,HLES,HLQ,ALRDATA,ADD,ALTYPE
"RTN","GMRAIAL1",33,0)
 N DATA,VAL,I,S,X,Y,Z,X1,HL7RC,IEN,IEN1,OUTX,PIDSEG,ENTERR
"RTN","GMRAIAL1",34,0)
 N SEPF,SEPC,SEPR,SEPE,SEPS,ARRAY,CMP,SEQ
"RTN","GMRAIAL1",35,0)
 ;
"RTN","GMRAIAL1",36,0)
 ; Initialize stuff
"RTN","GMRAIAL1",37,0)
 K ^TMP("HLS",$J) S S=0,ARRAY="OUT("_"""HLS"""_",S)",TARGET="LM^"
"RTN","GMRAIAL1",38,0)
 ;
"RTN","GMRAIAL1",39,0)
 ; Determine whether API was Allergy Update or Assessment
"RTN","GMRAIAL1",40,0)
 S ALTYPE=$S($P(MSHP,"~",4)="ALGY":1,$P(MSHP,"~",4)="ADAS":2,1:1)
"RTN","GMRAIAL1",41,0)
 ;
"RTN","GMRAIAL1",42,0)
 ; Set up HL7 delimiters
"RTN","GMRAIAL1",43,0)
 S HLCM=$E(VDEFHL("ECH")),HLRP=$E(VDEFHL("ECH"),2),HLSC=$E(VDEFHL("ECH"),4),HLES=$E(VDEFHL("ECH"),3)
"RTN","GMRAIAL1",44,0)
 S HLFS=VDEFHL("FS"),HLQ=VDEFHL("Q"),HL7RC=HLES_HLFS_HLCM_HLRP_HLSC
"RTN","GMRAIAL1",45,0)
 D SETDLMS^VDEFEL
"RTN","GMRAIAL1",46,0)
 ;
"RTN","GMRAIAL1",47,0)
 ; Get allergy data, patient ID, 'entered in error data'
"RTN","GMRAIAL1",48,0)
 ; based on whether it's an allergy update or an assessment
"RTN","GMRAIAL1",49,0)
 I ALTYPE=1 S ALRDATA=^GMR(120.8,KEY,0),DFN=$P(ALRDATA,U),ENTERR=$G(^GMR(120.8,KEY,"ER"))
"RTN","GMRAIAL1",50,0)
 E  S ALRDATA=$G(^GMR(120.86,KEY,0)),DFN=$P(ALRDATA,U),ENTERR=""
"RTN","GMRAIAL1",51,0)
 I ALTYPE=2,$P(ALRDATA,U,2)="" D ERR^VDEFREQ("No data in patient file 120.86 for IEN "_KEY) S ZTSTOP=1 G EXIT
"RTN","GMRAIAL1",52,0)
 ;
"RTN","GMRAIAL1",53,0)
 ; Build segments for message in OUT, $P # = HL7 field #
"RTN","GMRAIAL1",54,0)
 ;
"RTN","GMRAIAL1",55,0)
 ; PID - Use MPI PID builder
"RTN","GMRAIAL1",56,0)
PID K PIDSEG S OUTX="",S=1,SEQ=""
"RTN","GMRAIAL1",57,0)
 I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No entry in ^DPT for DFN "_DFN) S ZTSTOP=1 G EXIT
"RTN","GMRAIAL1",58,0)
 D BLDPID^VAFCQRY(DFN,1,SEQ,.PIDSEG,.VDEFHL)
"RTN","GMRAIAL1",59,0)
 F I=2:1 Q:$G(PIDSEG(I))=""  S PIDSEG(1,I-1)=PIDSEG(I) K PIDSEG(I)
"RTN","GMRAIAL1",60,0)
 M OUTX=PIDSEG(1) K PIDSEG D SAVE
"RTN","GMRAIAL1",61,0)
 ;
"RTN","GMRAIAL1",62,0)
 ; OBR
"RTN","GMRAIAL1",63,0)
OBR S S=S+1,OUTX="",$P(OUTX,HLFS)=1
"RTN","GMRAIAL1",64,0)
 S $P(OUTX,HLFS,3)=KEY_HLCM_$P(SITEPARM,U,4)_$S(ALTYPE=1:"_120.8",ALTYPE=2:"_120.86")
"RTN","GMRAIAL1",65,0)
 S $P(OUTX,HLFS,4)=$P("ALLERGY,ASSESSMENT",",",ALTYPE)_HLCM_HLCM_"L"
"RTN","GMRAIAL1",66,0)
 ;
"RTN","GMRAIAL1",67,0)
 ; Result Status
"RTN","GMRAIAL1",68,0)
 S $P(OUTX,HLFS,25)=$E("FE",1+(ENTERR'=""))
"RTN","GMRAIAL1",69,0)
 ;
"RTN","GMRAIAL1",70,0)
 ; Date/time reaction entered in system
"RTN","GMRAIAL1",71,0)
 S $P(OUTX,HLFS,7)=$$TS^VDEFEL($P(ALRDATA,U,4))
"RTN","GMRAIAL1",72,0)
 ;
"RTN","GMRAIAL1",73,0)
 ; Date/time reaction verified
"RTN","GMRAIAL1",74,0)
 I ALTYPE=1 S $P(OUTX,HLFS,8)=$$TS^VDEFEL($P(ALRDATA,U,17))
"RTN","GMRAIAL1",75,0)
 ;
"RTN","GMRAIAL1",76,0)
 ; Originator for allergy
"RTN","GMRAIAL1",77,0)
 S VAL=$P(ALRDATA,U,$P("5^3",U,ALTYPE))
"RTN","GMRAIAL1",78,0)
 S $P(OUTX,HLFS,32)=$$XCN200^VDEFEL(VAL)
"RTN","GMRAIAL1",79,0)
 G OBRX:ALTYPE=2
"RTN","GMRAIAL1",80,0)
 ;
"RTN","GMRAIAL1",81,0)
 ; Repeating field of various person roles
"RTN","GMRAIAL1",82,0)
 ; Enterer, Verifier, Error User, ID Band Marker, Chart Marker
"RTN","GMRAIAL1",83,0)
 ; and associated dates
"RTN","GMRAIAL1",84,0)
 S (X,Y,Z)=""
"RTN","GMRAIAL1",85,0)
ENT S VAL=$P(ALRDATA,U,5) G VER:VAL=""
"RTN","GMRAIAL1",86,0)
 S VAL=$$XCN200^VDEFEL(VAL),VAL=$TR(VAL,HLCM,HLSC),$P(VAL,HLSC,8)="E",Z=VAL
"RTN","GMRAIAL1",87,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ALRDATA,U,4)),X=Z
"RTN","GMRAIAL1",88,0)
VER S VAL=$P(ALRDATA,U,18) G ERR:VAL=""
"RTN","GMRAIAL1",89,0)
 S VAL=$$XCN200^VDEFEL(VAL),VAL=$TR(VAL,HLCM,HLSC),$P(VAL,HLSC,8)="V",Z=VAL
"RTN","GMRAIAL1",90,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ALRDATA,U,17)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",91,0)
ERR S VAL=$P(ENTERR,U,3) G IDBM:VAL=""
"RTN","GMRAIAL1",92,0)
 S VAL=$$XCN200^VDEFEL(VAL),VAL=$TR(VAL,HLCM,HLSC),$P(VAL,HLSC,8)="EE",Z=VAL
"RTN","GMRAIAL1",93,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ENTERR,U,2)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",94,0)
 ;
"RTN","GMRAIAL1",95,0)
 ; May be multiple entries for ID Band & Chart Marker persons
"RTN","GMRAIAL1",96,0)
IDBM G CHRT:'$D(^GMR(120.8,KEY,14))
"RTN","GMRAIAL1",97,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,14,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL1",98,0)
 . S X1=$G(^GMR(120.8,KEY,14,IEN1,0)),VAL=$$XCN200^VDEFEL($P(X1,U,2))
"RTN","GMRAIAL1",99,0)
 . S VAL=$TR(VAL,HLCM,HLSC) S:VAL="" VAL=Y S $P(VAL,HLSC,8)="BM",Z=VAL
"RTN","GMRAIAL1",100,0)
 . S $P(Z,HLCM,2)=$$TS^VDEFEL($P(X1,U,1)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",101,0)
CHRT G OBR1:'$D(^GMR(120.8,KEY,13))
"RTN","GMRAIAL1",102,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,13,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL1",103,0)
 . S X1=$G(^GMR(120.8,KEY,13,IEN1,0)),VAL=$$XCN200^VDEFEL($P(X1,U,2))
"RTN","GMRAIAL1",104,0)
 . S VAL=$TR(VAL,HLCM,HLSC) S:VAL="" VAL=Y S $P(VAL,HLSC,8)="CM",Z=VAL
"RTN","GMRAIAL1",105,0)
 . S $P(Z,HLCM,2)=$$TS^VDEFEL($P(X1,U,1)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",106,0)
OBR1 S $P(OUTX,HLFS,34)=X
"RTN","GMRAIAL1",107,0)
 ;
"RTN","GMRAIAL1",108,0)
 ; Observed/Historical Indicator
"RTN","GMRAIAL1",109,0)
 S X=$P(ALRDATA,U,6),Y=$S(X="o":"OBSERVED",X="h":"HISTORICAL",1:"")
"RTN","GMRAIAL1",110,0)
 S X=$G(X)_HLCM_Y,$P(OUTX,HLFS,47)=X
"RTN","GMRAIAL1",111,0)
OBRX S OUTX="OBR"_HLFS_OUTX D SAVE
"RTN","GMRAIAL1",112,0)
 ;
"RTN","GMRAIAL1",113,0)
 ; Call GMRAIAL2
"RTN","GMRAIAL1",114,0)
CALL D ENTRY^GMRAIAL2
"RTN","GMRAIAL1",115,0)
 ; Done building segments
"RTN","GMRAIAL1",116,0)
EXIT Q TARGET
"RTN","GMRAIAL1",117,0)
 ;
"RTN","GMRAIAL1",118,0)
 ;
"RTN","GMRAIAL1",119,0)
 ; Place current string into message array.
"RTN","GMRAIAL1",120,0)
 ; Turn string into array if length >245.
"RTN","GMRAIAL1",121,0)
 ; Move local array to global if needed.
"RTN","GMRAIAL1",122,0)
SAVE N I
"RTN","GMRAIAL1",123,0)
 I $P(OUTX,HLFS)'="PID",$L(OUTX)>245 D
"RTN","GMRAIAL1",124,0)
 . K ADD S ADD=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX))
"RTN","GMRAIAL1",125,0)
 . F I=1:1 S ADD(I)=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX)) Q:OUTX=""
"RTN","GMRAIAL1",126,0)
 . K OUTX M OUTX=ADD
"RTN","GMRAIAL1",127,0)
 M @ARRAY=OUTX
"RTN","GMRAIAL1",128,0)
 ;
"RTN","GMRAIAL1",129,0)
 ; Move local array to global if it's getting big.
"RTN","GMRAIAL1",130,0)
 I $P(TARGET,U)="LM",$S<16000 D
"RTN","GMRAIAL1",131,0)
 . K ^TMP("HLS",$J) M ^TMP("HLS",$J)=OUT("HLS") K OUT("HLS")
"RTN","GMRAIAL1",132,0)
 . S $P(TARGET,U)="GM",ARRAY="^TMP("_"""HLS"""_",$J,S)"
"RTN","GMRAIAL1",133,0)
 K OUTX,ADD
"RTN","GMRAIAL1",134,0)
 Q
"RTN","GMRAIAL1",135,0)
 ;
"RTN","GMRAIAL1",136,0)
 ; Replace any HL7 coding chars. in strings with HL7 escape sequence
"RTN","GMRAIAL1",137,0)
 ; Input: X = data string
"RTN","GMRAIAL1",138,0)
HL7RC(X) N OCHR,RCHR,RCHRI,TYPE,I F TYPE="E","F","C","R","S" D
"RTN","GMRAIAL1",139,0)
 . S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","GMRAIAL1",140,0)
 . S OCHR=$E(HL7RC,RCHRI),RCHR=$E("EFSRT",RCHRI)
"RTN","GMRAIAL1",141,0)
 . Q:'$F(X,OCHR)
"RTN","GMRAIAL1",142,0)
 . F I=1:1 Q:$E(X,I)=""  I $E(X,I)=OCHR S X=$E(X,1,I-1)_HLES_RCHR_HLES_$E(X,I+1,999),I=I+3
"RTN","GMRAIAL1",143,0)
 Q X
"RTN","GMRAIAL2")
0^4^B20897543
"RTN","GMRAIAL2",1,0)
GMRAIAL2 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ALLERGIES - PART 2 ;11/30/04  08:08
"RTN","GMRAIAL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**22**;Mar 29, 1996
"RTN","GMRAIAL2",3,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy updates & assessments
"RTN","GMRAIAL2",4,0)
 ;
"RTN","GMRAIAL2",5,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAL2",6,0)
 ;   #4248 - VDEFEL calls       (controlled)
"RTN","GMRAIAL2",7,0)
 ;   #3630 - VAFCQRY calls       (controlled)
"RTN","GMRAIAL2",8,0)
 ;   #2196 -  ^PS(50.416,IEN,0)  (controlled)
"RTN","GMRAIAL2",9,0)
 ;   #2574 - $$CLASS2^PSNAPIS    (supported)
"RTN","GMRAIAL2",10,0)
 ;
"RTN","GMRAIAL2",11,0)
 ; This routine is called as a subroutine by GMRAIAL1
"RTN","GMRAIAL2",12,0)
 ;
"RTN","GMRAIAL2",13,0)
 Q
"RTN","GMRAIAL2",14,0)
 ;
"RTN","GMRAIAL2",15,0)
ENTRY ; Entry point from GMRAIAL1
"RTN","GMRAIAL2",16,0)
 ;
"RTN","GMRAIAL2",17,0)
 ; Skip to OBX8 if doing an assessment
"RTN","GMRAIAL2",18,0)
 G OBX8:ALTYPE=2
"RTN","GMRAIAL2",19,0)
 ;
"RTN","GMRAIAL2",20,0)
 ; OBX 1 - Reactant
"RTN","GMRAIAL2",21,0)
OBX1 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"AGENT"_HLFS
"RTN","GMRAIAL2",22,0)
 S $P(OUTX,HLFS,5)=$$HL7RC^GMRAIAL1($P(ALRDATA,U,2)),$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",23,0)
 S X=$P(SITEPARM,U,4)_HLCM_$P(SITEPARM,U,5)_HLCM_"L",$P(OUTX,HLFS,15)=X
"RTN","GMRAIAL2",24,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",25,0)
 ;
"RTN","GMRAIAL2",26,0)
 ; OBX2 - Allergy Type
"RTN","GMRAIAL2",27,0)
OBX2 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"ALLERGY TYPE"_HLFS
"RTN","GMRAIAL2",28,0)
 S X=$P(ALRDATA,U,20),VAL=X_HLCM F I=1:1:$L(X) D
"RTN","GMRAIAL2",29,0)
 . S Y=$E(X,I),Y=$S(Y="D":"DRUG",Y="F":"FOOD",Y="O":"OTHER",1:"")
"RTN","GMRAIAL2",30,0)
 . S VAL=VAL_Y S:I<$L(X) VAL=VAL_","
"RTN","GMRAIAL2",31,0)
 S VAL=VAL_HLCM_"L",$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",32,0)
 S X=$P(SITEPARM,U,4)_HLCM_$P(SITEPARM,U,5)_HLCM_"L",$P(OUTX,HLFS,15)=X
"RTN","GMRAIAL2",33,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",34,0)
 ;
"RTN","GMRAIAL2",35,0)
 ; OBX3 - GMR Allergy
"RTN","GMRAIAL2",36,0)
OBX3 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"GMR ALLERGY"_HLFS
"RTN","GMRAIAL2",37,0)
 S VAL="",X=$P(ALRDATA,U,3)
"RTN","GMRAIAL2",38,0)
 I X'="" D
"RTN","GMRAIAL2",39,0)
 . S VAL=$P(X,";")_HLCM_$P(@("^"_$P(X,";",2)_$P(X,";",1)_",0)"),U)
"RTN","GMRAIAL2",40,0)
 . S VAL=VAL_HLCM_$P(SITEPARM,U,4)_"_"_($P($P(X,";",2),"(",2)+0)
"RTN","GMRAIAL2",41,0)
 E  S VAL=HLCM_"NONE REPORTED"_HLCM
"RTN","GMRAIAL2",42,0)
 S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",43,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",44,0)
 ;
"RTN","GMRAIAL2",45,0)
 ; OBX4 - List of drug ingredients
"RTN","GMRAIAL2",46,0)
OBX4 G OBX5:'$D(^GMR(120.8,KEY,2))
"RTN","GMRAIAL2",47,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"DRUG INGREDIENTS"_HLFS
"RTN","GMRAIAL2",48,0)
 S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,2,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",49,0)
 . S Y=^GMR(120.8,KEY,2,IEN1,0),X=Y_HLCM_$P(^PS(50.416,Y,0),U)
"RTN","GMRAIAL2",50,0)
 . S X=$G(X)_HLCM_$P(SITEPARM,U,4)_"_50.416"
"RTN","GMRAIAL2",51,0)
 . S VAL=VAL_X_HLRP
"RTN","GMRAIAL2",52,0)
 S VAL=$E(VAL,1,$L(VAL)-1),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",53,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",54,0)
 ;
"RTN","GMRAIAL2",55,0)
 ; OBX5 - Drug class
"RTN","GMRAIAL2",56,0)
OBX5 G OBX6:'$D(^GMR(120.8,KEY,3))
"RTN","GMRAIAL2",57,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"DRUG CLASSES"_HLFS
"RTN","GMRAIAL2",58,0)
 S IEN1=0,X="" F  S IEN1=$O(^GMR(120.8,KEY,3,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",59,0)
 . S Y=$P($$CLASS2^PSNAPIS(^GMR(120.8,KEY,3,IEN1,0)),U),X=$G(X)_Y_HLRP
"RTN","GMRAIAL2",60,0)
 S X=$E(X,1,$L(X)-1),$P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",61,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",62,0)
 ;
"RTN","GMRAIAL2",63,0)
 ; OBX6 - MECHANISM
"RTN","GMRAIAL2",64,0)
OBX6 S X=$P(ALRDATA,U,14) G OBX7:X=""
"RTN","GMRAIAL2",65,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"MECHANISM"_HLFS
"RTN","GMRAIAL2",66,0)
 S X=$G(X)_HLCM_$S(X="A":"ALLERGY",X="P":"PHARMACOLOGIC",X="U":"UNKNOWN",1:"")
"RTN","GMRAIAL2",67,0)
 S $P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",68,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",69,0)
 ;
"RTN","GMRAIAL2",70,0)
 ; OBX7 - Reaction
"RTN","GMRAIAL2",71,0)
OBX7 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,10,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",72,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"REACTION"_HLFS
"RTN","GMRAIAL2",73,0)
 . S X=^GMR(120.8,KEY,10,IEN1,0) S:$P(X,U,2)="" $P(X,U,2)=$P(^GMRD(120.83,+X,0),U)
"RTN","GMRAIAL2",74,0)
 . I X+0'=30 S VAL=$P(X,U)_HLCM_$P(X,U,2)_HLCM_$P(SITEPARM,U,4)_"_120.83"
"RTN","GMRAIAL2",75,0)
 . E  S VAL="OTHER"_HLCM_$P(X,U,2)_HLCM_"L"
"RTN","GMRAIAL2",76,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",77,0)
 . S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(X,U,4))
"RTN","GMRAIAL2",78,0)
 . S VAL=$$XCN200^VDEFEL($P(X,U,3)),$P(OUTX,HLFS,16)=VAL
"RTN","GMRAIAL2",79,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",80,0)
 ;
"RTN","GMRAIAL2",81,0)
 ; Skip assessment if allergy update
"RTN","GMRAIAL2",82,0)
 G OBX9:ALTYPE=1
"RTN","GMRAIAL2",83,0)
 ;
"RTN","GMRAIAL2",84,0)
 ; OBX8 - Assessment
"RTN","GMRAIAL2",85,0)
OBX8 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"ASSESSMENT"_HLFS
"RTN","GMRAIAL2",86,0)
 S X=+$P(ALRDATA,U,2),X=X_HLCM_$S(X=0:"NO KNOWN ALLERGIES",X=1:"ALLERGIES IDENTIFIED")
"RTN","GMRAIAL2",87,0)
 S $P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAL2",88,0)
 S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(ALRDATA,U,4))
"RTN","GMRAIAL2",89,0)
 S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,3)),$P(OUTX,HLFS,16)=VAL
"RTN","GMRAIAL2",90,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",91,0)
 ;
"RTN","GMRAIAL2",92,0)
 ; Done if assessment
"RTN","GMRAIAL2",93,0)
 G RETURN:ALTYPE=2
"RTN","GMRAIAL2",94,0)
 ;
"RTN","GMRAIAL2",95,0)
 ; OBX9 - Comments
"RTN","GMRAIAL2",96,0)
 ; One OBX for each comment
"RTN","GMRAIAL2",97,0)
OBX9 S IEN=0 F  S IEN=$O(^GMR(120.8,KEY,26,IEN)) Q:'+IEN  D
"RTN","GMRAIAL2",98,0)
 . S ALRDATA=$G(^GMR(120.8,KEY,26,IEN,0)) G RETURN:ALRDATA=""
"RTN","GMRAIAL2",99,0)
 . ;
"RTN","GMRAIAL2",100,0)
 . ; Set up the static fields
"RTN","GMRAIAL2",101,0)
 . S X1=1_HLFS_"TX"_HLFS_"COMMENT"_HLFS
"RTN","GMRAIAL2",102,0)
 . S $P(X1,HLFS,11)="F",$P(X1,HLFS,16)=$$XCN200^VDEFEL($P(ALRDATA,U,2))
"RTN","GMRAIAL2",103,0)
 . S $P(X1,HLFS,19)=$$TS^VDEFEL($P(ALRDATA,U)),X=$P(ALRDATA,U,3)
"RTN","GMRAIAL2",104,0)
 . S $P(X,HLCM,2)=$S(X="V":"VERIFIED",X="O":"OBSERVED",X="E":"ERRORED",1:"")
"RTN","GMRAIAL2",105,0)
 . S $P(X1,HLFS,17)=X
"RTN","GMRAIAL2",106,0)
 . ;
"RTN","GMRAIAL2",107,0)
 . ; A comment may be more than one line
"RTN","GMRAIAL2",108,0)
 . S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,26,IEN,2,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",109,0)
 . . S X=$$HL7RC^GMRAIAL1(^GMR(120.8,KEY,26,IEN,2,IEN1,0)),VAL=VAL_X_HLRP
"RTN","GMRAIAL2",110,0)
 . S:$E(VAL,$L(VAL))=HLRP VAL=$E(VAL,1,$L(VAL)-1)
"RTN","GMRAIAL2",111,0)
 . S OUTX=X1,$P(OUTX,HLFS,5)=VAL
"RTN","GMRAIAL2",112,0)
 . S S=S+1,OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",113,0)
 ;
"RTN","GMRAIAL2",114,0)
 ; Return to GMRAIAL1
"RTN","GMRAIAL2",115,0)
RETURN Q
"RTN","GMRAIVDK")
0^5^B5285280
"RTN","GMRAIVDK",1,0)
GMRAIVDK ;BPOIFO/JG - KIDS POST INSTALL FOR VDEF PATCH ;10/5/04  08:57
"RTN","GMRAIVDK",2,0)
 ;;4.0;ADVERSE REACTION TRACKING;**22**;Mar 29, 1996
"RTN","GMRAIVDK",3,0)
 ;
"RTN","GMRAIVDK",4,0)
 ; This routine uses the following IAs:
"RTN","GMRAIVDK",5,0)
 ;    #4447 - POSTKID^VDEF   (controlled)
"RTN","GMRAIVDK",6,0)
 ;   #10141 - XPDUTL calls   (controlled)
"RTN","GMRAIVDK",7,0)
 ;
"RTN","GMRAIVDK",8,0)
 ; This program is used as the KIDS Post-Install routine
"RTN","GMRAIVDK",9,0)
 ; for the second VDEF patch that installs GMRA application
"RTN","GMRAIVDK",10,0)
 ; specific components that are required by VDEF to construct
"RTN","GMRAIVDK",11,0)
 ; a message.
"RTN","GMRAIVDK",12,0)
 ;
"RTN","GMRAIVDK",13,0)
POSTKID ; Entry point
"RTN","GMRAIVDK",14,0)
 ; Inputs that are required by POSTKID^VDEFVU:
"RTN","GMRAIVDK",15,0)
 ;    MSGTYP - HL7 message type (ADT, ORU, etc)
"RTN","GMRAIVDK",16,0)
 ;    EVNTYP - HL7 event type (A60, R01, etc)
"RTN","GMRAIVDK",17,0)
 ;    SUBTYP - VDEF Event Subtype (ALGY, PPAR, etc)
"RTN","GMRAIVDK",18,0)
 ;    PROTO - VistA HL7 Event Driver Protocol Name
"RTN","GMRAIVDK",19,0)
 ;    CUSTPKG - Custodial Package Name
"RTN","GMRAIVDK",20,0)
 ;    EXTROUT - VDEF Message Extraction Program
"RTN","GMRAIVDK",21,0)
 ;    EVDESC - Event description
"RTN","GMRAIVDK",22,0)
 ;    SUBDESC - Subtype description
"RTN","GMRAIVDK",23,0)
 ;
"RTN","GMRAIVDK",24,0)
 ; If needed, POSTKID^VDEFVU will generate error message (BMES^XPDUTL)
"RTN","GMRAIVDK",25,0)
 ; and set KIDABORT=1
"RTN","GMRAIVDK",26,0)
 ;
"RTN","GMRAIVDK",27,0)
 K XPDABORT
"RTN","GMRAIVDK",28,0)
 I $G(XPDNM)="" D BMES^XPDUTL("Must be run as a KIDS Post-Install process.") S XPDABORT=1 Q
"RTN","GMRAIVDK",29,0)
 N MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,ERRMSG,KIDABORT
"RTN","GMRAIVDK",30,0)
 ;
"RTN","GMRAIVDK",31,0)
 ; Create Allergy Update/Insert Event
"RTN","GMRAIVDK",32,0)
 S MSGTYP="ORU"
"RTN","GMRAIVDK",33,0)
 S EVNTYP="R01"
"RTN","GMRAIVDK",34,0)
 S SUBTYP="ALGY"
"RTN","GMRAIVDK",35,0)
 S PROTO="GMRA VDEF ORU R01 ALLERGY VS"
"RTN","GMRAIVDK",36,0)
 S CUSTPKG="ADVERSE REACTION TRACKING"
"RTN","GMRAIVDK",37,0)
 S EXTROUT="GMRAIAL1"
"RTN","GMRAIVDK",38,0)
 S EVDESC="ALLERGY UPDATE/INSERT"
"RTN","GMRAIVDK",39,0)
 S SUBDESC="ALLERGY UPDATE/INSERT"
"RTN","GMRAIVDK",40,0)
 D POSTKID^VDEFVU(MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,.KIDABORT)
"RTN","GMRAIVDK",41,0)
 Q:$G(KIDABORT)
"RTN","GMRAIVDK",42,0)
 ;
"RTN","GMRAIVDK",43,0)
 ; Create Allergy Assessment Event
"RTN","GMRAIVDK",44,0)
 S SUBTYP="ADAS"
"RTN","GMRAIVDK",45,0)
 S PROTO="GMRA VDEF ORU R01 ADV ASSESS VS"
"RTN","GMRAIVDK",46,0)
 S EVDESC="ALLERGY ASSESSMENT"
"RTN","GMRAIVDK",47,0)
 S SUBDESC="ALLERGY ASSESSMENT"
"RTN","GMRAIVDK",48,0)
 D POSTKID^VDEFVU(MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,.KIDABORT)
"RTN","GMRAIVDK",49,0)
 Q:$G(KIDABORT)
"RTN","GMRAIVDK",50,0)
 ;
"RTN","GMRAIVDK",51,0)
 ; Create Adverse Reaction Report Event
"RTN","GMRAIVDK",52,0)
 S SUBTYP="ADRA"
"RTN","GMRAIVDK",53,0)
 S PROTO="GMRA VDEF ORU R01 ADV REACT VS"
"RTN","GMRAIVDK",54,0)
 S EXTROUT="GMRAIAD1"
"RTN","GMRAIVDK",55,0)
 S EVDESC="ADVERSE REACTION REPORT"
"RTN","GMRAIVDK",56,0)
 S SUBDESC="ADVERSE REACTION"
"RTN","GMRAIVDK",57,0)
 D POSTKID^VDEFVU(MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,.KIDABORT)
"RTN","GMRAIVDK",58,0)
 Q:$G(KIDABORT)
"RTN","GMRAIVDK",59,0)
 ;
"RTN","GMRAIVDK",60,0)
 ; Success!!
"RTN","GMRAIVDK",61,0)
 D BMES^XPDUTL("VDEF Event(s) successfully installed in VDEF globals.")
"RTN","GMRAIVDK",62,0)
 Q
"VER")
8.0^22.0
**END**
**END**
