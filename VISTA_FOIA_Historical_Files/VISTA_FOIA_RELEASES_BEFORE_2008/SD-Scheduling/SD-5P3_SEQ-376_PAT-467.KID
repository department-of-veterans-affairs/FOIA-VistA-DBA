Released SD*5.3*467 SEQ #376
Extracted from mail message
**KIDS**:SD*5.3*467^

**INSTALL NAME**
SD*5.3*467
"BLD",6462,0)
SD*5.3*467^SCHEDULING^0^3060212^y
"BLD",6462,1,0)
^^4^4^3051121^^^
"BLD",6462,1,1,0)
This patch will allow keeping the wait list entry status up to date with 
"BLD",6462,1,2,0)
any related appointment cancellation by clinic, performed either for a 
"BLD",6462,1,3,0)
patient or for a clinic. The related EWL entries will be opened following 
"BLD",6462,1,4,0)
the cancellation and optionally closed again if rebooked.
"BLD",6462,4,0)
^9.64PA^^
"BLD",6462,6)
4^
"BLD",6462,"KRN",0)
^9.67PA^8989.52^19
"BLD",6462,"KRN",.4,0)
.4
"BLD",6462,"KRN",.401,0)
.401
"BLD",6462,"KRN",.402,0)
.402
"BLD",6462,"KRN",.403,0)
.403
"BLD",6462,"KRN",.5,0)
.5
"BLD",6462,"KRN",.84,0)
.84
"BLD",6462,"KRN",3.6,0)
3.6
"BLD",6462,"KRN",3.8,0)
3.8
"BLD",6462,"KRN",9.2,0)
9.2
"BLD",6462,"KRN",9.8,0)
9.8
"BLD",6462,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",6462,"KRN",9.8,"NM",1,0)
SDC0^^0^B26427996
"BLD",6462,"KRN",9.8,"NM",2,0)
SDWLREB^^0^B76814897
"BLD",6462,"KRN",9.8,"NM",3,0)
SDM2^^0^B20767664
"BLD",6462,"KRN",9.8,"NM",4,0)
SDWLQSC^^0^B72135252
"BLD",6462,"KRN",9.8,"NM",5,0)
SDCNP1^^0^B27171115
"BLD",6462,"KRN",9.8,"NM","B","SDC0",1)

"BLD",6462,"KRN",9.8,"NM","B","SDCNP1",5)

"BLD",6462,"KRN",9.8,"NM","B","SDM2",3)

"BLD",6462,"KRN",9.8,"NM","B","SDWLQSC",4)

"BLD",6462,"KRN",9.8,"NM","B","SDWLREB",2)

"BLD",6462,"KRN",19,0)
19
"BLD",6462,"KRN",19,"NM",0)
^9.68A^^
"BLD",6462,"KRN",19.1,0)
19.1
"BLD",6462,"KRN",101,0)
101
"BLD",6462,"KRN",409.61,0)
409.61
"BLD",6462,"KRN",771,0)
771
"BLD",6462,"KRN",870,0)
870
"BLD",6462,"KRN",8989.51,0)
8989.51
"BLD",6462,"KRN",8989.52,0)
8989.52
"BLD",6462,"KRN",8994,0)
8994
"BLD",6462,"KRN","B",.4,.4)

"BLD",6462,"KRN","B",.401,.401)

"BLD",6462,"KRN","B",.402,.402)

"BLD",6462,"KRN","B",.403,.403)

"BLD",6462,"KRN","B",.5,.5)

"BLD",6462,"KRN","B",.84,.84)

"BLD",6462,"KRN","B",3.6,3.6)

"BLD",6462,"KRN","B",3.8,3.8)

"BLD",6462,"KRN","B",9.2,9.2)

"BLD",6462,"KRN","B",9.8,9.8)

"BLD",6462,"KRN","B",19,19)

"BLD",6462,"KRN","B",19.1,19.1)

"BLD",6462,"KRN","B",101,101)

"BLD",6462,"KRN","B",409.61,409.61)

"BLD",6462,"KRN","B",771,771)

"BLD",6462,"KRN","B",870,870)

"BLD",6462,"KRN","B",8989.51,8989.51)

"BLD",6462,"KRN","B",8989.52,8989.52)

"BLD",6462,"KRN","B",8994,8994)

"BLD",6462,"QUES",0)
^9.62^^
"BLD",6462,"REQB",0)
^9.611^3^3
"BLD",6462,"REQB",1,0)
SD*5.3*394^2
"BLD",6462,"REQB",2,0)
SD*5.3*398^2
"BLD",6462,"REQB",3,0)
SD*5.3*434^2
"BLD",6462,"REQB","B","SD*5.3*394",1)

"BLD",6462,"REQB","B","SD*5.3*398",2)

"BLD",6462,"REQB","B","SD*5.3*434",3)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
467^3060212^100892
"PKG",16,22,1,"PAH",1,1,0)
^^4^4^3060212
"PKG",16,22,1,"PAH",1,1,1,0)
This patch will allow keeping the wait list entry status up to date with 
"PKG",16,22,1,"PAH",1,1,2,0)
any related appointment cancellation by clinic, performed either for a 
"PKG",16,22,1,"PAH",1,1,3,0)
patient or for a clinic. The related EWL entries will be opened following 
"PKG",16,22,1,"PAH",1,1,4,0)
the cancellation and optionally closed again if rebooked.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","SDC0")
0^1^B26427996
"RTN","SDC0",1,0)
SDC0 ;MAN/GRR,ALB/TMP/LDB - Continuation of SDC (cancel a clinic) ; 16 JUL 2003  1:27 pm
"RTN","SDC0",2,0)
 ;;5.3;Scheduling;**303,330,379,398,467**;Aug 13, 1993
"RTN","SDC0",3,0)
 ;
"RTN","SDC0",4,0)
 ;SD/467 - open matched EWL entries with canceled appointments
"RTN","SDC0",5,0)
 ;
"RTN","SDC0",6,0)
CHKEND G:NOAP END
"RTN","SDC0",7,0)
 S %=1,DTOUT=0 W !,"WANT TO AUTO-REBOOK APPOINTMENTS NOW" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G CHKEND
"RTN","SDC0",8,0)
 S ANS=$S('(%-1):"Y",1:"N") I %<0 W " NO" Q:'DTOUT
"RTN","SDC0",9,0)
ASKL S SDLT1="",%=1,(SDLET,SDFORM)="" W !,"WANT LETTERS PRINTED NOW" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G ASKL
"RTN","SDC0",10,0)
 W:%<0 " NO" S ALS=$S('(%-1):"Y",1:"N") G:ALS'["Y" AOR
"RTN","SDC0",11,0)
EN Q:($P(^SC(SC,0),"^",3)'="C")!($D(SDVAUTC(+SC)))  S SDIV=$P(^SC(SC,0),"^",15),SDIV=$S(SDIV:SDIV,1:$O(^DG(40.8,0))) I $D(SDLT),SDIV'=SDV1 Q
"RTN","SDC0",12,0)
 K SDRE,SDIN I $D(SDLT)&($D(^SC(SC,"I"))) S SDIN=+^("I"),SDRE=+$P(^("I"),"^",2) I $D(SDIN),SDIN,SDIN'>SDBD&('$D(SDRE)!('SDRE)!(SDRE>SDED)) Q
"RTN","SDC0",13,0)
 S:'SDLT1 SDLET=$S($D(^SC(SC,"LTR")):$P(^("LTR"),"^",3),1:"") S ALS=$S(SDLET:"Y",1:"N")
"RTN","SDC0",14,0)
 I ALS="N"!(ANS="Y") S SDFFFF=1
"RTN","SDC0",15,0)
 I ALS="N" W !,"NO LETTERS ARE ASSIGNED TO THE ",$P(^SC(SC,0),"^")," CLINIC" Q:$D(SDLT)
"RTN","SDC0",16,0)
 I SDFORM="",$D(^DG(40.8,SDIV,"LTR")),^("LTR") S SDFORM=^("LTR")
"RTN","SDC0",17,0)
 I $D(SDLT),(ALS'="N") D CHK Q
"RTN","SDC0",18,0)
 Q:$D(SDLT)
"RTN","SDC0",19,0)
AOR G:ANS'["Y"&(ALS'["Y") END
"RTN","SDC0",20,0)
 I '$D(SDLT) S DGPGM="START^SDC0",DGVAR="SC^SI^CDATE^ALS^ANS^SDLET^SDTIME"_$S($D(SDIN):"^SDIN^SDRE",1:"")_"^SDFORM^SDV1^SDFFFF"
"RTN","SDC0",21,0)
 I '$D(SDLT) D FZIS^DGUTQ G:POP END
"RTN","SDC0",22,0)
START U IO I ANS'["Y"&('$D(SDLT)) D:ALS["Y" APP D END Q
"RTN","SDC0",23,0)
BEG1 N SDFIRST
"RTN","SDC0",24,0)
 I $D(SDLT) S SDAR=$S('VAUTC:"VAUTC",1:"^SC"),ANS="N",ALS="Y" D
"RTN","SDC0",25,0)
 .F SC=0:0 S SC=$O(@(SDAR_"("_SC_")")) Q:SC'>0  D
"RTN","SDC0",26,0)
 ..K SDOK1 D EN I $D(SDOK1),SDLET D
"RTN","SDC0",27,0)
 ...F SD=(SDBD-.1):0 S SD=$O(^SC(SC,"S",SD)) S CDATE=SD Q:SD>(SDED+.999999)!(SD'>0)  D
"RTN","SDC0",28,0)
 ....D DUP
"RTN","SDC0",29,0)
 S SDFIRST=$S($G(SDFFFF)=1:0,1:1)
"RTN","SDC0",30,0)
 I $D(SDLT),$D(^UTILITY("SDLT",$J)) D PR^SDC3,END Q
"RTN","SDC0",31,0)
 Q:$D(SDLT)  D ^SDAUT1
"RTN","SDC0",32,0)
 I MAX=0 W !,"AUTO-REBOOKING NOT ALLOWED FOR THIS CLINIC" G APP:ALS["Y",END
"RTN","SDC0",33,0)
 F GDATE=CDATE:0 S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  F L=0:0 S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  S A=^(L,0) I $D(^DPT(+A,"S",GDATE,0)),$P(^(0),"^",2)="C",$P(^(0),"^",14)=SDTIME D ^SDAUT2,^SDCCP
"RTN","SDC0",34,0)
 D:ALS["Y" APP
"RTN","SDC0",35,0)
END ;
"RTN","SDC0",36,0)
 D:$G(SC)>0&($G(CDATE)>0) RESOLVE
"RTN","SDC0",37,0)
 K %,%DT,%H,%I,%DT,%IS,%ZIS,A,ALS,ANS,BY,CDATE,CHAR,DA,DFN,DH,DHD,DIC,DIS,DO,DOW,FLDS,FR,GDATE,I,L,LET,MAX,NOAP,P,POP,SI,SL,SS,ST,SDSTRTDT,TO,X,Y,ADDR,B,CLIN,HX,L0,L1,L2,LL,PDAT,S,TIME,Z,D,ENDATE,J,SM,STIME,X1,X2,SDX1,SDX2,SDRE,SDRE1,SDIN,FSW
"RTN","SDC0",38,0)
 K ^TMP("SDC0",$J),SDAP,SDAPNUM
"RTN","SDC0",39,0)
 K SC,SD,Z0,Z5,DGPGM,DUPE,J2,MESS,NDATE,SDDIF,SDFORM,SDINP,SDFORM,SDLET,SDLT1,SDNODE,SDRT,SDSOH,SDST,SDV1,DGVAR,SD1,SD8,SD81,SDANS,SDCNT,SDERR,SDHTO,SDJ,SDTIME,SDZ,STARTDAY,SD82,SDOK,SDOK1,SDLE,SDZ,SDOK1,TST,W,^UTILITY("SD")
"RTN","SDC0",40,0)
 K SDFFFF,DIW,DIWF,DIWL,DIWR,DIWT,DN,DUPE,J2,MESS,NDATE,SDADD,SDC,SDCL,SDDAT,SDDIF,SDFORM,SDHX,SDINP,SDIV,SDLET,SDNODE,SDRT,SDSOH,SDST,SDT0,TST,SDV1,^TMP($J,"BADADD") D CLOSE^DGUTQ Q
"RTN","SDC0",41,0)
CHK K SDOK1 I $D(^SC(SC,"SL")) S SL=^("SL"),%=$P(SL,"^",6),SI=$S(%="":4,%<3:4,%:%,1:4) S SDOK1=1 K SL,% E  W $P(^SC(SC,0),"^")," does not have an appointment length indicated."
"RTN","SDC0",42,0)
 Q
"RTN","SDC0",43,0)
RESOLVE ;evaluate canceled and rebooked appointments with relation to EWL
"RTN","SDC0",44,0)
 S GDATE=CDATE K ^TMP("SDWLREB",$J),^TMP($J,"SDWLPL")
"RTN","SDC0",45,0)
 F  S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  S L=0 F  S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  D
"RTN","SDC0",46,0)
 .S DFN=+^SC(SC,"S",GDATE,1,L,0)
"RTN","SDC0",47,0)
 .N RBFLG,SDTRB,SDCAN,SDREB S SDREB=0 D REBOOK^SDWLREB(DFN,GDATE,SC,.RBFLG,.SDTRB,.SDCAN) Q:SDCAN'=SDTIME
"RTN","SDC0",48,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDC0",49,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDC0",50,0)
 .D OPENEWL^SDWLREB(DFN,GDATE,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDC0",51,0)
 I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDC0",52,0)
 Q
"RTN","SDC0",53,0)
 ;
"RTN","SDC0",54,0)
DUP ;SCREEN FOR DUPLICATE PATIENTS - SD*5.3*379
"RTN","SDC0",55,0)
 S SDAP="" F  S SDAP=$O(^SC(SC,"S",SD,SDAP)) Q:SDAP=""  D
"RTN","SDC0",56,0)
 .S SDAPNUM="" F  S SDAPNUM=$O(^SC(SC,"S",SD,SDAP,SDAPNUM)) Q:SDAPNUM=""  D
"RTN","SDC0",57,0)
 ..I $D(^SC(SC,"S",SD,SDAP,SDAPNUM,0)) D
"RTN","SDC0",58,0)
 ...S A=$P(^SC(SC,"S",SD,SDAP,SDAPNUM,0),"^",1)
"RTN","SDC0",59,0)
 ...I '$D(^TMP("SDC0",$J,SD,A)) S ^TMP("SDC0",$J,SD,A)="" D ^SDC3
"RTN","SDC0",60,0)
 Q
"RTN","SDC0",61,0)
APP I $G(SDFFFF)=1 S SDFIRST=0
"RTN","SDC0",62,0)
 F GDATE=CDATE:0 S GDATE=$O(^SC(+SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  F L=0:0 S L=$O(^SC(+SC,"S",GDATE,1,L)) Q:L=""  S A=^(L,0) D CHECK
"RTN","SDC0",63,0)
 I $D(^TMP($J,"BADADD")) D BADADD^SDLT K ^TMP($J,"BADADD")
"RTN","SDC0",64,0)
 Q
"RTN","SDC0",65,0)
CHK1 S (SDX,X)=GDATE D WRAPP^SDLT
"RTN","SDC0",66,0)
 I $P(S,"^",2)'["A" D REST^SDLT Q
"RTN","SDC0",67,0)
 S SDX=$P(S,"^",10) I '$D(^DPT(+A,"S",SDX,0)) D REST^SDLT Q
"RTN","SDC0",68,0)
 W !!,"The cancelled appointment(s) were rescheduled as follows:",!
"RTN","SDC0",69,0)
 S S=^DPT(+A,"S",SDX,0) D WRAPP^SDLT,REST^SDLT
"RTN","SDC0",70,0)
 Q
"RTN","SDC0",71,0)
CHECK I $$BADADR^DGUTL3(+A) S ^TMP($J,"BADADD",$P(^DPT(+A,0),"^"),+A)="" Q
"RTN","SDC0",72,0)
 ;
"RTN","SDC0",73,0)
 ;SCREEN FOR DUPLICATES - SD*5.3*379
"RTN","SDC0",74,0)
 ;
"RTN","SDC0",75,0)
 I $D(^TMP("SDC0",$J,GDATE,A)) Q
"RTN","SDC0",76,0)
 S ^TMP("SDC0",$J,GDATE,A)=""
"RTN","SDC0",77,0)
 I $S('$D(^DPT(+A,.35)):1,$P(^DPT(+A,.35),"^",1)']"":1,1:0),$D(^DPT(+A,"S",GDATE)),$P(^DPT(+A,"S",GDATE,0),"^",2)["C",$P(^(0),"^",14)=SDTIME!(SDTIME="*") S S=^DPT(+A,"S",GDATE,0) D ^SDLT,CHK1
"RTN","SDCNP1")
0^5^B27171115
"RTN","SDCNP1",1,0)
SDCNP1 ;ALB/LDB - CANCEL APPOINTMENT (cont.) ; 14 MAR 88@13:00
"RTN","SDCNP1",2,0)
 ;;5.3;Scheduling;**398,467**;Aug 13, 1993
"RTN","SDCNP1",3,0)
 ;
"RTN","SDCNP1",4,0)
 ;SD/467 - EWL Open Matched Entry with rebook
"RTN","SDCNP1",5,0)
NOPE W !,*7,$S(CNT:CNT_" Appointment"_$S(CNT>1:"s",1:"")_" cancelled",1:"NOTHING CANCELLED")
"RTN","SDCNP1",6,0)
 S SDCNT=CNT,SDA=1,SDCNT1=0 I CNT,$S('$D(^DPT(DFN,.35)):1,'$P(^(.35),U):1,1:0) S (SDA,X8)=0 D ASK G:X8="^" END
"RTN","SDCNP1",7,0)
 ;no rebooking to take place; open EWL entries only if applicable
"RTN","SDCNP1",8,0)
 I $D(DFN)>0 D EWL(DFN) ;SD/467
"RTN","SDCNP1",9,0)
 I SDA,SDCNT W !,*7,"NO AUTO-REBOOKING --Patient has died."
"RTN","SDCNP1",10,0)
 I 'SDA,SDCNT S A=DFN D LOOP1^SDCNP1A,LET
"RTN","SDCNP1",11,0)
END K:'$D(DIROUT) DFN D END^SDCNP Q:$D(DIROUT)  G RD^SDCNP
"RTN","SDCNP1",12,0)
ASK S (SDCTR,SDCTRL)=0,%=2 W !!,"DO YOU WISH TO REBOOK ANY APPOINTMENT(S) THAT YOU HAVE CANCELLED" D YN^DICN D:'% REASK G:'% ASK I %-1 S CNT=0 S:%<0 X8="^" D  Q
"RTN","SDCNP1",13,0)
 .W !,"OK"
"RTN","SDCNP1",14,0)
 W !!,"PLEASE NOTE THAT YOU MUST ENTER A DEVICE TO AUTO-REBOOK",!
"RTN","SDCNP1",15,0)
ZIS S %ZIS("A")="DEVICE TO OUTPUT REBOOKED APPT(S). :",%ZIS="QN" D ^%ZIS I POP S X8="^" Q
"RTN","SDCNP1",16,0)
 S L=0 F  S L=$O(^UTILITY($J,"SDCNP",L)) Q:'L  I $P(^(L),U,4)="*** JUST CANCELLED ***" S ^UTILITY($J,"SDCNP1",DFN,$P(^(L),"^",2),$P(^(L),"^"))=^(L)
"RTN","SDCNP1",17,0)
 D SDLST
"RTN","SDCNP1",18,0)
LST S B=0 F  S B=$O(^UTILITY($J,"SDCNP2",DFN,B)) Q:'B  W !!,$J($S(B\1=B:"("_$J(B,2)_") ",1:""),5) S AT=$S($P(^(B),"^",2)'?.N:1,1:0),Y=$P($P(^(B),"^"),".") D DT^SDM0 S X=$P(^(B),"^") X ^DD("FUNC",2,1) W " ",$J(X,8) S Z1(B)="" D MORE Q:SDCTRL
"RTN","SDCNP1",19,0)
 D WH
"RTN","SDCNP1",20,0)
 I B>0 G:SDCTRL&(A8']"") NOPE1 G:SDCTRL DEL
"RTN","SDCNP1",21,0)
 Q
"RTN","SDCNP1",22,0)
SDLST S L1=0 S Z5=0 F  S Z5=$O(^UTILITY($J,"SDCNP1",DFN,Z5)) Q:'Z5  F Z6=0:0 S Z7=Z6,Z6=$O(^UTILITY($J,"SDCNP1",DFN,Z5,Z6)) I Z6="" S L1=L1+1,^UTILITY($J,"SDCNP2",DFN,L1)=Z7_"^"_Z5_"^"_$P(^(Z7),"^",3,6) Q
"RTN","SDCNP1",23,0)
 Q
"RTN","SDCNP1",24,0)
MORE S SDCTR=SDCTR+2 I AT W ?41,$P(^UTILITY($J,"SDCNP2",B),"^",2) G OVR
"RTN","SDCNP1",25,0)
 S S5=^UTILITY($J,"SDCNP2",DFN,B) W " (",$P(S5,"^",6)," MINUTES)  ",$S($D(^SC($P(S5,"^",2),0)):$P(^(0),"^",1),1:"DELETED CLINIC"),$P(S5,"^",3) S M1=$P(^SC($P(S5,"^",2),"SDP"),"^",4) W !,?41,"Max days for rebooking= ",M1
"RTN","SDCNP1",26,0)
OVR I SDCTR>20,$O(^UTILITY($J,"SDCNP2",B))>0 S (SDCTRL,SDCTR)=0 W *7 D WH W:'SDCTRL @IOF
"RTN","SDCNP1",27,0)
 Q
"RTN","SDCNP1",28,0)
WH W !!,"SELECT APPOINTMENT(S) TO BE REBOOKED" W:B>0 " OR HIT RETURN TO CONTINUE DISPLAY" R ": ",A8:DTIME I '$T!(A8="^") S SDCTRL=1,A8="",X8="^" Q
"RTN","SDCNP1",29,0)
 I A8["?" X SDMSG G WH
"RTN","SDCNP1",30,0)
DEL S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  D MTCH
"RTN","SDCNP1",31,0)
 I SDERR G LST
"RTN","SDCNP1",32,0)
DEL1 S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  S SDDI=$P(SDDH,"-"),SDDM=$P(SDDH,"-",2) D CKK^SDCNP1A Q:SDERR  D CKK2^SDCNP1A Q:SDERR  F Z9=SDDI:1:$S(SDDM:SDDM,1:SDDI) D:SDDI REBK I 'SDDI S SDERR=1 Q
"RTN","SDCNP1",33,0)
 G:SDERR LST Q:A8["^"!(A8="")  S SDERR=0 D ^SDCNP1A Q:X8="^"
"RTN","SDCNP1",34,0)
 D:MAX QUE
"RTN","SDCNP1",35,0)
 D NOPE1
"RTN","SDCNP1",36,0)
 Q 
"RTN","SDCNP1",37,0)
LET S %=2 W !!,"DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT(S)" D YN^DICN S ANS="Y" D:'% REASK G:'% LET Q:(%-1)
"RTN","SDCNP1",38,0)
 I $$BADADR^DGUTL3(+DFN) D  Q  ;display, don't print BAI list
"RTN","SDCNP1",39,0)
 . W *7,!,"** THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDCNP1",40,0)
 . W !,"WILL BE PRINTED."
"RTN","SDCNP1",41,0)
 . S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1",42,0)
QUE2 S DGPGM="SDLET^SDCNP1A",DGVAR="SDCL#^DUZ^DFN^DT^A^SDWH" D ZIS^DGUTQ D:POP CLOSE^DGUTQ Q:POP  D SDLET^SDCNP1A Q
"RTN","SDCNP1",43,0)
QUE I IO'=IO(0) S DGPGM="^SDCNP2",DGVAR="SDCL#^NDATE^A^GDATE^DT^DUZ",IOP=IO,X="NOW" D Q1^DGUTQ Q
"RTN","SDCNP1",44,0)
 U IO I IO=IO(0),$E(IOST,1,2)="C-" S SDIO=1 D ^SDCNP2 Q
"RTN","SDCNP1",45,0)
NOPE1 W @IOF,!,*7,$S(SDCNT1:SDCNT1_" Appointment"_$S(SDCNT1>1:"s",1:"")_" rebooked",1:"NOTHING REBOOKED") Q
"RTN","SDCNP1",46,0)
REBK K ^UTILITY($J,"SDCNP") S ^UTILITY($J,"SDCNP2","REBK",DFN,Z9)=^UTILITY($J,"SDCNP2",DFN,Z9)
"RTN","SDCNP1",47,0)
 Q
"RTN","SDCNP1",48,0)
 F A9=SDDI,SDDM Q:'SDDM&(SDDI-A9)  I '$D(Z1(A9)) S SDERR=1 W !,*7,"There is no appointment number ",A9
"RTN","SDCNP1",49,0)
 Q
"RTN","SDCNP1",50,0)
REASK W !,"ANSWER (Y)ES OR (N)O" Q
"RTN","SDCNP1",51,0)
CLRK S $P(^DPT(DFN,"S",S,0),"^",19)=$P(SDNODE,"^",7),$P(^DPT(DFN,"S",S,0),"^",18)=$P(SDNODE,"^",6) Q
"RTN","SDCNP1",52,0)
MTCH Q:SDDH?1N.N!(SDDH?1.N1"-".N)  S SDERR=1 X SDMSG
"RTN","SDCNP1",53,0)
 Q
"RTN","SDCNP1",54,0)
EWL(DFN) ;
"RTN","SDCNP1",55,0)
 I '$D(^UTILITY($J,"SDCNP1")) I '$D(^UTILITY($J,"SDCNP")) Q
"RTN","SDCNP1",56,0)
 ;call to EWL to open and optionally close EWL entry with rebooked appointment
"RTN","SDCNP1",57,0)
 N SDFRB,SDT,SC,SDREB K ^TMP("SDWLREB",$J),^TMP($J,"SDWPL"),^TMP($J,"APPT")
"RTN","SDCNP1",58,0)
 I $D(^UTILITY($J,"SDCNP1")) S SDFRB="^UTILITY($J,""SDCNP1"")"  D REB I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB Q
"RTN","SDCNP1",59,0)
 E  S SDFRB="^UTILITY($J,""SDCNP"")" D CAN I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDCNP1",60,0)
 Q
"RTN","SDCNP1",61,0)
REB I $D(^UTILITY($J,"SDCNP1")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP1"  S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",62,0)
 .;N NN F NN=1:1 Q:'$D(^UTILITY($J,"SDCNP","REBK",DFN,NN))  I $P($G(^UTILITY($J,"SDCNP2","REBK",DFN,NN)),U)=SDT S SDREB=1 Q
"RTN","SDCNP1",63,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",64,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",65,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",66,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",67,0)
 Q
"RTN","SDCNP1",68,0)
CAN I $D(^UTILITY($J,"SDCNP")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP"  I @SDFRB["CANCELLED" S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",69,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",70,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",71,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",72,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",73,0)
 Q
"RTN","SDM2")
0^3^B20767664
"RTN","SDM2",1,0)
SDM2 ;SF/GFT - MAKE APPOINTMENT ; 07 Jan 2000  6:30 PM
"RTN","SDM2",2,0)
 ;;5.3;Scheduling;**32,132,168,356,434,467**;Aug 13, 1993
"RTN","SDM2",3,0)
 ;
"RTN","SDM2",4,0)
 ;SD/467 - call EWL to open its entry if matching appointment is canceled
"RTN","SDM2",5,0)
 W *7,!,"PATIENT ALREADY HAS APPOINTMENT "
"RTN","SDM2",6,0)
 N SDATA,SDCMHDL ; for evt dvr
"RTN","SDM2",7,0)
 I $D(^DPT(DFN,"S",SD,0)),$P(^(0),"^",2)'["C" S S=SD,I=+^(0) D FLEN W "(",APL," MINUTES) THEN" D IN,PROT G:$D(SDPROT) ^SDM1 R ".",!,"  DO YOU WANT TO CANCEL IT? ",X:DTIME S X=$$UP^XLFSTR(X) D:X?1"Y".A STAT G CAN:X?1"Y".A W "??",*7 G ^SDM1
"RTN","SDM2",8,0)
SDAY S %=1 W "ON THE SAME DAY (" D AT,IN W ") ...OK" D YN^DICN I '% W !,"RESPOND YES OR NO",!,"PATIENT ALREADY HAS APPOINTMENT " G SDAY
"RTN","SDM2",9,0)
 G ^SDM1:(%-1),PRECAN^SDM1
"RTN","SDM2",10,0)
 ;
"RTN","SDM2",11,0)
CAN Q:'$D(^SC(I,"SL"))  S SCI=I,DIV=$S($P(^SC(I,0),"^",15)]"":" "_$P(^(0),"^",15),1:" 1") I $D(^DPT("ASDPSD","C",DIV,I,S,DFN)) K ^(DFN)
"RTN","SDM2",12,0)
 S SD17=$P(^DPT(DFN,"S",S,0),"^") K ^SC("ARAD",I,S,DFN) S (DA,SDSY)=0 F SDSX=0:0 S SDSX=$O(^SC(I,"S",S,1,SDSX)) Q:'SDSX  Q:'$D(^(SDSX,0))  D C Q:SDSY&(DA)
"RTN","SDM2",13,0)
 I $D(^DPT("ASDPSD","B",DIV,$P(S,"."),DFN)) D CK1
"RTN","SDM2",14,0)
 G OUT:'SDSY S SL1=$P(^SC(I,"S",S,1,SDSY,0),U,2) I DA,'$D(^("OB")) K ^SC(I,"S",S,1,DA,"OB")
"RTN","SDM2",15,0)
 S SDRT="D",SDTTM=SD,SDPL=SDSY,SDSC=I D RT^SDUTL
"RTN","SDM2",16,0)
 I I'=SC D
"RTN","SDM2",17,0)
 .W !
"RTN","SDM2",18,0)
 .I $$BADADR^DGUTL3(DFN)>0 D  Q
"RTN","SDM2",19,0)
 ..W !!,"**BAD ADDRESS INDICATOR FOR THIS PATIENT. NO LETTER WILL BE PRINTED.**",!!
"RTN","SDM2",20,0)
 .S DIR("A")="DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT"
"RTN","SDM2",21,0)
 .S DIR("A",1)="THIS IS THE ONLY OPPORTUNITY.",DIR("B")="YES"
"RTN","SDM2",22,0)
 .S DIR(0)="Y" D ^DIR W ! K DIR
"RTN","SDM2",23,0)
 .Q:(Y'=1)
"RTN","SDM2",24,0)
 .N SDWH,A,SC,SDCL S SDWH="P",A=+DFN,SDCL(1)=I_"^"_S N DFN
"RTN","SDM2",25,0)
 .S %ZIS("A")="Device for cancellation letter: ",%ZIS("B")=""
"RTN","SDM2",26,0)
 .N I,S,SDHX,SDP
"RTN","SDM2",27,0)
 .D ^%ZIS Q:POP  U IO
"RTN","SDM2",28,0)
 .D SDLET^SDCNP1A
"RTN","SDM2",29,0)
 .D ^%ZISC
"RTN","SDM2",30,0)
 K ^SC(I,"S",S,1,SDSY)
"RTN","SDM2",31,0)
 I '$D(^SC(I,"ST",$P(SD,"."),1)) G OUT
"RTN","SDM2",32,0)
 S SD1(1)=^SC(I,"SL"),SD1=$P(SD1(1),"^",3),SB1=$S(SD1:SD1,1:8)-1/100,SD1=$P(SD1(1),"^",6),HSI1=$S(SD1:SD1,1:4),SI1=$S(SD1="":4,SD1<3:4,SD1:SD1,1:4),SDDIF1=$S(HSI1<3:8/HSI1,1:2) K SD1
"RTN","SDM2",33,0)
 S S=^SC(I,"ST",$P(SD,"."),1),SDQ=SD#1-SB1*100,ST=SDQ#1*SI1\.6+($P(SDQ,".")*SI1),SS=SL1*HSI1/60
"RTN","SDM2",34,0)
 I SDQ'<1 F I=ST+ST:SDDIF1 S SDQ=$E(STR,$F(STR,$E(S,I+1))) Q:SDQ=""  S S=$E(S,1,I)_SDQ_$E(S,I+2,999),SS=SS-1 Q:SS'>0
"RTN","SDM2",35,0)
 S ^(1)=S K SL1,SB1,SDDIF1,HSI1,SI1,SDQ ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDM2",36,0)
OUT D EVT Q:$D(SDNSF)  W *7,!,"APPOINTMENT IN ",$P(^SC(SCI,0),"^",1)," CANCELLED!" S X=SD D DOW^SDM1 W !,"APPOINTMENT NOW BEING MADE IN ",$P(^SC(SC,0),"^",1) K SCI G S^SDM1
"RTN","SDM2",37,0)
 ;
"RTN","SDM2",38,0)
C I +^SC(I,"S",S,1,SDSX,0)=DFN,$P(^(0),"^",9)'["C" S SDSY=SDSX Q
"RTN","SDM2",39,0)
 Q:'$D(^("OB"))!DA  S:^("OB")?1"O".E DA=SDSX Q  ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDSX,"OB")
"RTN","SDM2",40,0)
 ;
"RTN","SDM2",41,0)
AT W "AT ",$E(S_0,9,10),":",$E(S_"000",11,12) Q
"RTN","SDM2",42,0)
IN W:SC-I&$D(^SC(I,0)) " IN ",$P(^(0),U,1) Q
"RTN","SDM2",43,0)
PROT K SDPROT
"RTN","SDM2",44,0)
 I $D(^SC(I,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(I,"SDPRIV",DUZ)) D  Q
"RTN","SDM2",45,0)
 .W !!,*7,">>> Access to ",$$CNAM(I)," is prohibited!"
"RTN","SDM2",46,0)
 .W !,"    Only users with a special code may access this clinic.",!
"RTN","SDM2",47,0)
 .S SDPROT=""
"RTN","SDM2",48,0)
 ;
"RTN","SDM2",49,0)
 I $$CODT^SDCOU(DFN,SD,I) D  Q
"RTN","SDM2",50,0)
 .W !?5,*7,">>> A check out date has been entered for this appointment!"
"RTN","SDM2",51,0)
 .W !?5,"    Please enter another date and time.   Thank you.",!
"RTN","SDM2",52,0)
 .S SDPROT=""
"RTN","SDM2",53,0)
 Q
"RTN","SDM2",54,0)
 ;
"RTN","SDM2",55,0)
CNAM(SDCL) ;Return clinic name
"RTN","SDM2",56,0)
 ;Input: SDCL=clinic ien
"RTN","SDM2",57,0)
 N SDX
"RTN","SDM2",58,0)
 S SDX=$P($G(^SC(+SDCL,0)),U)
"RTN","SDM2",59,0)
 Q $S($L(SDX):SDX,1:"this clinic")
"RTN","SDM2",60,0)
 ;
"RTN","SDM2",61,0)
FLEN S APL="" I $D(^SC(I,"S",SD)) F ZL=0:0 S ZL=$O(^SC(I,"S",SD,1,ZL)) Q:ZL=""  I +^(ZL,0)=DFN S APL=$P(^SC(I,"S",SD,1,ZL,0),"^",2)
"RTN","SDM2",62,0)
 Q
"RTN","SDM2",63,0)
 ;
"RTN","SDM2",64,0)
DISP G ^SDM1 ; LINE TAG IS NO LONGER USED
"RTN","SDM2",65,0)
 ;W !?4 K S F SDQ=Y:0 S SDQ=$N(^SC(SC,"S",SDQ)) Q:Y+1<SDQ!(SDQ<0)  F I=0:0 S I=$N(^SC(SC,"S",SDQ,1,I)) Q:I'>0  Q:'$D(^(I,0))  S ST=$S($P(^(0),U,4)="":"BLANK",1:"'"_$E($P(^(0),U,4),1,28)_"'"),S(ST)=$S($D(S(ST)):S(ST)+1,1:1)
"RTN","SDM2",66,0)
 ;I '$D(S) W "NO APPNT'S SCHEDULED YET" G ^SDM1
"RTN","SDM2",67,0)
 ;W "'OTHER' TYPES ALREADY SCHEDULED:   ",!
"RTN","SDM2",68,0)
 ;S S=0 F I=0:1 S S=$N(S(S)) G ^SDM1:S=-1 W:$X+$L(S)>72 ! W S,": ",S(S),"     "
"RTN","SDM2",69,0)
CK1 S SDZ=0 F SD1=$P(S,"."):0 S SD1=$O(^DPT(DFN,"S",SD1)) Q:'SD1!((SD1\1)'=(S\1))  I $P(^(SD1,0),"^",2)'["C",$P(^(0),"^",2)'["N" S SDZ=1 Q
"RTN","SDM2",70,0)
 Q:SDZ  F SD1=2,4 I $D(^SC("AAS",SD1,$P(S,"."),DFN)) S SDZ=1 Q
"RTN","SDM2",71,0)
 Q:SDZ  IF $D(^SCE(+$$EXAE^SDOE(DFN,S\1,S\1),0)) S SDX=1
"RTN","SDM2",72,0)
 Q:SDZ  K ^DPT("ASDPSD","B",DIV,$P(S,"."),DFN) Q
"RTN","SDM2",73,0)
STAT N X S SDCMHDL=$$HANDLE^SDAMEVT(1) D BEFORE^SDAMEVT(.SDATA,DFN,SD,I,"",SDCMHDL),NOW^%DTC
"RTN","SDM2",74,0)
 S $P(^DPT(DFN,"S",SD,0),"^",2)="C",$P(^(0),"^",14)=$E(%,1,12) S:$D(DUZ) $P(^(0),"^",12)=DUZ S ^DPT("ASDCN",+^(0),SD,DFN)=""
"RTN","SDM2",75,0)
 K ^TMP("SDWLREB",$J),^TMP($J,"SDWLPL") N SC S SC=+^DPT(DFN,"S",SD,0) D OPENEWL^SDWLREB(DFN,SD,SC,0) K ^TMP($J,"SDWLP")
"RTN","SDM2",76,0)
 I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB ; SD/467
"RTN","SDM2",77,0)
 Q
"RTN","SDM2",78,0)
 ;
"RTN","SDM2",79,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDM2",80,0)
 ; -- cancel event
"RTN","SDM2",81,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SDTTM,SDSC,SDPL,0,SDCMHDL)
"RTN","SDM2",82,0)
 Q
"RTN","SDWLQSC")
0^4^B72135252
"RTN","SDWLQSC",1,0)
SDWLQSC        ;IOFO BAY PINES/TEH,DMR - WAITING LIST-SC PRIORITY BACKGROUND ;09/02/2004 2:10 PM [4/21/05 8:04pm]
"RTN","SDWLQSC",2,0)
 ;;5.3;scheduling;**327,394,467**;AUG 13, 1993
"RTN","SDWLQSC",3,0)
 ;
"RTN","SDWLQSC",4,0)
 ;SD*5.3*327       EWL Updates Phase II - Addition of EWL notification messages.
"RTN","SDWLQSC",5,0)
 ;SD*5.3*394       New Routine for background update of SDWL(409.3) SC priorities.
"RTN","SDWLQSC",6,0)
 ;SD*5.3*467       Match canceled appts in 409.3            
"RTN","SDWLQSC",7,0)
 ;This routine will run as a background job to determine changes in SC disabilities and update
"RTN","SDWLQSC",8,0)
 ;the priority of the wait list visit. A mailman message will then be sent to the EWL mail group.
"RTN","SDWLQSC",9,0)
 ;Vars: SDWLDFN=EWL IEN
"RTN","SDWLQSC",10,0)
 ;      SDWLSC1=EWL RECORDED SC %
"RTN","SDWLQSC",11,0)
 ;      SDWLSC2=PATIENT FILE (2) CURRENT SC %          
"RTN","SDWLQSC",12,0)
 ;DBIAs: 1476 reference to PRIMARY ELIG. ^DPT(IEN,.372)
"RTN","SDWLQSC",13,0)
 ;        427 reference to ^DIC(8)                               
"RTN","SDWLQSC",14,0)
 Q
"RTN","SDWLQSC",15,0)
EN ;Use SDWL(409.3) to determine SC changes and priority.
"RTN","SDWLQSC",16,0)
 S SDWLDFN=0 F  S SDWLDFN=$O(^SDWL(409.3,"B",SDWLDFN)) Q:SDWLDFN<1  D
"RTN","SDWLQSC",17,0)
 .S SDWLDA=0,SDWLME=0 F  S SDWLDA=$O(^SDWL(409.3,"B",SDWLDFN,SDWLDA)) Q:SDWLDA=""  D
"RTN","SDWLQSC",18,0)
 ..L ^SDWL(409.3,SDWLDA):5 I '$T Q
"RTN","SDWLQSC",19,0)
 ..I $P($G(^SDWL(409.3,SDWLDA,0)),U,17)["C" Q  ;I EWL entry has been 'CLOSED' don't process.
"RTN","SDWLQSC",20,0)
 ..S SDWLME=SDWLME+1
"RTN","SDWLQSC",21,0)
 ..S SDWLSC1=+$P($G(^SDWL(409.3,SDWLDA,"SC")),U,1)
"RTN","SDWLQSC",22,0)
 ..S SDWLSC2=+$$GET1^DIQ(2,SDWLDFN_",",.302,,"SDWLX","")
"RTN","SDWLQSC",23,0)
 ..I SDWLSC1=SDWLSC2 S SDWLSC4=1 Q
"RTN","SDWLQSC",24,0)
 ..S SDWLSCX=0,SDWLSC3=0,SDWLSC4=0
"RTN","SDWLQSC",25,0)
 ..I SDWLSC2<50,SDWLSC1>49 D
"RTN","SDWLQSC",26,0)
 ...S SDWLSC3=1,SDWLSC4=1,DA=SDWLDA,DR="14////^S X=SDWLSC2",DIE=409.3 D ^DIE,SET1
"RTN","SDWLQSC",27,0)
 ..I SDWLSC2>49,SDWLSC1>49 S SDWLSCX=SDWLSC2 D SET0 Q
"RTN","SDWLQSC",28,0)
 ..I SDWLSC2>49,SDWLSC1<50 S SDWLSCX=SDWLSC2 D SET0,SET1 Q
"RTN","SDWLQSC",29,0)
 ..I SDWLSC2<50,SDWLSC1<50 S SDWLSC3=1,SDWLSC4=1,SDWLSCX=SDWLSC2 D SET0,SET1 Q
"RTN","SDWLQSC",30,0)
 ..I '$D(^SDWL(409.3,SDWLDA,"SC")) D
"RTN","SDWLQSC",31,0)
 ...I SDWLSC2>49 S SDWLSCX=SDWLSC2 D SET0,SET1 Q  ;Set "SC" node if not defined.
"RTN","SDWLQSC",32,0)
 ...I SDWLSC2<50 S SDWLSC3=1,SDWLSC4=1,DA=SDWLDA,DR="14////^S X=SDWLSC2",DIE=409.3 D ^DIE,SET1
"RTN","SDWLQSC",33,0)
 ..K SDWLSSN,SDWLSC2,SDWLSC1,SDWLSC3,SDWLSCP,SDWLX,SDWLI,SDWLSCX
"RTN","SDWLQSC",34,0)
 ..L  Q
"RTN","SDWLQSC",35,0)
 I $D(SDWLSC4),SDWLSC4 D
"RTN","SDWLQSC",36,0)
 .I $D(^TMP("SDWLQSC2",$J)) D MESS1^SDWLMSG
"RTN","SDWLQSC",37,0)
 I $D(^TMP("SDWLQSC1",$J)) D MESS^SDWLMSG
"RTN","SDWLQSC",38,0)
 K SDWLDA,SDWLDFN,SDWLSC1,SDWLSC2,SDWLSC3,SDWLSC4,DA,DR,DIC,DIE,X,SDWLX,SDWLNAM,SDWLSSN,SDWLSCX,SDWLWRT,SDWLME
"RTN","SDWLQSC",39,0)
 D EN2
"RTN","SDWLQSC",40,0)
 K IEN,DFN,APPT,WLAPPT,STOP,WLSTAT,STATUS,NN,SDREC,SDARRAY,SDAPPT,CL,CLINIC,SDC,SDDFN,SDNAME,SDAPPST,CIEN,SDWL
"RTN","SDWLQSC",41,0)
 K SDCL,SDIEN,CC,SDREACT,SDINACT,CLINICS,TEAM,TEAMN,WLOPEN,PIEN,POS,POSN,SDWLPOS,EDATE,DOD,DIS,NAME,MAX,AVAL,SDFORM
"RTN","SDWLQSC",42,0)
 Q
"RTN","SDWLQSC",43,0)
SET0 ;Set EWL file with current SC percentage.
"RTN","SDWLQSC",44,0)
 S DA=SDWLDA,DR="14////^S X=SDWLSCX",DIE=409.3 D ^DIE
"RTN","SDWLQSC",45,0)
 I SDWLSC2=50!(SDWLSC2>50) S DR="15////^S X=1" D ^DIE
"RTN","SDWLQSC",46,0)
 K DA,DR,X,DIE
"RTN","SDWLQSC",47,0)
 Q
"RTN","SDWLQSC",48,0)
SET1 ;Set temporary file for message.
"RTN","SDWLQSC",49,0)
 F SDWLI=.01,.09 S SDWLX(SDWLI)=$$GET1^DIQ(2,SDWLDFN_",",SDWLI,,"SDWLX","")
"RTN","SDWLQSC",50,0)
 S SDWLNAM=$E($G(SDWLX(.01)),1,27),SDWLSSN=$E($G(SDWLX(.09)),6,99)
"RTN","SDWLQSC",51,0)
 S SDWLSCP=$$GET1^DIQ(409.3,SDWLDA_",",15,,"SDWLSCP","")
"RTN","SDWLQSC",52,0)
 S SDWLWRT=SDWLNAM,SDWLWRT=SDWLWRT_$J(SDWLSSN,(35-$L(SDWLNAM)))
"RTN","SDWLQSC",53,0)
 S SDWLWRT=SDWLWRT_$J(SDWLSC1,8),SDWLWRT=SDWLWRT_$J(SDWLSC2,16-$L(SDWLSC1))
"RTN","SDWLQSC",54,0)
 I 'SDWLSC3 S SDWLWRT=SDWLWRT_$J(SDWLSCP,15)
"RTN","SDWLQSC",55,0)
 I SDWLSC3 S SDWLWRT=SDWLWRT_$J($S(SDWLME>1:"YES",1:"NO"),15)
"RTN","SDWLQSC",56,0)
 I SDWLSC3 S ^TMP("SDWLQSC2",$J,SDWLDFN)=SDWLWRT Q
"RTN","SDWLQSC",57,0)
 S ^TMP("SDWLQSC1",$J,SDWLDFN)=SDWLWRT
"RTN","SDWLQSC",58,0)
 Q
"RTN","SDWLQSC",59,0)
EN2 ;Part 2 - checks status of appts linked to closed EWL entries.
"RTN","SDWLQSC",60,0)
 S (IEN,DFN,APPT,WLAPPT,CLINIC,SDAPPT,WLSTAT,STATUS,NN,SDFORM)=""
"RTN","SDWLQSC",61,0)
 F  S DFN=$O(^SDWL(409.3,"B",DFN)) Q:DFN<1  D
"RTN","SDWLQSC",62,0)
 .S IEN="" F  S IEN=$O(^SDWL(409.3,"B",DFN,IEN)) Q:IEN<1  D
"RTN","SDWLQSC",63,0)
 ..S STATUS="" S STATUS=$$GET1^DIQ(409.3,IEN_",",23,"I") IF STATUS="C" D
"RTN","SDWLQSC",64,0)
 ...IF $G(^SDWL(409.3,IEN,"SDAPT")) D
"RTN","SDWLQSC",65,0)
 ....S CLINIC=$$GET1^DIQ(409.3,IEN_",",13.2,"I") IF CLINIC>0 D
"RTN","SDWLQSC",66,0)
 .....S WLAPPT=$$GET1^DIQ(409.3,IEN_",",13,"I"),WLSTAT=$$GET1^DIQ(409.3,IEN_",",21,"I") IF WLSTAT="SA" D APPT(CLINIC,IEN)
"RTN","SDWLQSC",67,0)
 IF $D(^TMP("SDWLQSC3",$J)) D MESS2^SDWLMSG
"RTN","SDWLQSC",68,0)
 D EN3
"RTN","SDWLQSC",69,0)
 Q
"RTN","SDWLQSC",70,0)
APPT(CLINIC,IEN) ;
"RTN","SDWLQSC",71,0)
 S (SDREC,SDARRAY)=""
"RTN","SDWLQSC",72,0)
 S SDARRAY(1)=WLAPPT_";"_WLAPPT
"RTN","SDWLQSC",73,0)
 S SDARRAY(4)=DFN
"RTN","SDWLQSC",74,0)
 S SDARRAY("FLDS")="3;2;4;1"
"RTN","SDWLQSC",75,0)
 S SDREC=$$SDAPI^SDAMA301(.SDARRAY)
"RTN","SDWLQSC",76,0)
 IF SDREC>0 D
"RTN","SDWLQSC",77,0)
 .S (CL,SDC,SDDFN,SDNAM,SDAPPT,SDAPPST,NN)=""
"RTN","SDWLQSC",78,0)
 .S CL=$O(^TMP($J,"SDAMA301",DFN,"")) Q:CL=""  ;Current Clinic
"RTN","SDWLQSC",79,0)
 .S SDAPPST=$P($G(^TMP($J,"SDAMA301",DFN,CL,WLAPPT)),"^",3),SDAPPST=$P(SDAPPST,";")  ;Appt Status
"RTN","SDWLQSC",80,0)
 .I CL'=CLINIC!(SDAPPST="CC") D
"RTN","SDWLQSC",81,0)
 ..S SDDFN=$P($G(^TMP($J,"SDAMA301",DFN,CL,WLAPPT)),"^",4) IF SDDFN'="" S SDNAM=$P($G(SDDFN),";",2),SDNAM=$E(SDNAM,1,30)
"RTN","SDWLQSC",82,0)
 ..S SDC=$P($G(^TMP($J,"SDAMA301",DFN,CL,WLAPPT)),"^",2)
"RTN","SDWLQSC",83,0)
 ..S SDC=$$GET1^DIQ(44,CL_",",.01),SDC=$E(SDC,1,25)
"RTN","SDWLQSC",84,0)
 ..S Y=WLAPPT D DD^%DT S SDAPPT=Y
"RTN","SDWLQSC",85,0)
 ..IF CL'=CLINIC S SDC=SDC_"(new)"  ;to distinguish another clinic"
"RTN","SDWLQSC",86,0)
 ..S SDFORM=$$FORM^SDFORM(SDNAM,32,SDC,27,SDAPPT,21)
"RTN","SDWLQSC",87,0)
 ..S NN=NN+1,^TMP("SDWLQSC3",$J,NN)=SDFORM
"RTN","SDWLQSC",88,0)
 ..S DIE="^SDWL(409.3,",DA=IEN,DR="23////^S X=""O""" D ^DIE
"RTN","SDWLQSC",89,0)
 ..S DR="13.8////^S X=""CC""" D ^DIE
"RTN","SDWLQSC",90,0)
 ..S DR="29////^S X=""CA""" D ^DIE
"RTN","SDWLQSC",91,0)
 ..S DR="19///@;20///@;21///@" D ^DIE
"RTN","SDWLQSC",92,0)
 ..S DR="13///@;13.1////@;13.2///@;13.3///@;13.4///@;13.5///@;13.6///@;13.8///@;13.7///@" D ^DIE ;SD/467
"RTN","SDWLQSC",93,0)
 Q
"RTN","SDWLQSC",94,0)
EN3 ;Inactive clinics
"RTN","SDWLQSC",95,0)
 S (CIEN,IEN,APPT,DFN,WLSTAT,SDCL,SDIEN,CC,SDREACT,SDINACT,CLINICS,SDFORM)=""
"RTN","SDWLQSC",96,0)
 F  S CIEN=$O(^SDWL(409.3,"SC",CIEN)) Q:CIEN<1  S CC=0 D
"RTN","SDWLQSC",97,0)
 .S SDINACT=$$GET1^DIQ(44,CIEN_",",2505,"I"),SDREACT=$$GET1^DIQ(44,CIEN_",",2506,"I")
"RTN","SDWLQSC",98,0)
 .Q:SDINACT=""&(SDREACT="")  D 
"RTN","SDWLQSC",99,0)
 ..S IEN="" F  S IEN=$O(^SDWL(409.3,"SC",CIEN,IEN)) Q:IEN<1  S WLSTAT=$$GET1^DIQ(409.3,IEN_",",23,"I") D
"RTN","SDWLQSC",100,0)
 ...Q:WLSTAT'="O"
"RTN","SDWLQSC",101,0)
 ...Q:SDINACT<SDREACT&((SDREACT+.01)>DT)
"RTN","SDWLQSC",102,0)
 ...Q:SDINACT<DT&(SDREACT>SDINACT)
"RTN","SDWLQSC",103,0)
 ...Q:SDINACT>(DT+.01)
"RTN","SDWLQSC",104,0)
 ...S CC=CC+1
"RTN","SDWLQSC",105,0)
 .IF CC>0 D
"RTN","SDWLQSC",106,0)
 ..S CLINIC=$$GET1^DIQ(44,CIEN_",",.01),CLINIC=$E(CLINIC,1,30)
"RTN","SDWLQSC",107,0)
 ..S SDFORM=$$FORM^SDFORM(CLINIC,40,CC,20),^TMP("SDWLQSC4",$J,CIEN)=SDFORM
"RTN","SDWLQSC",108,0)
 ..S REC="",REC=$O(^SDWL(409.32,"B",CIEN,REC),-1)
"RTN","SDWLQSC",109,0)
 ..IF REC'="" D
"RTN","SDWLQSC",110,0)
 ...S SDINACT=$$GET1^DIQ(44,CIEN_",",2505,"I")
"RTN","SDWLQSC",111,0)
 ...S DIE="^SDWL(409.32,",DA=REC,DR="3////^S X=SDINACT" D ^DIE
"RTN","SDWLQSC",112,0)
 ...S DR="4////^S X=.5" D ^DIE
"RTN","SDWLQSC",113,0)
 IF $D(^TMP("SDWLQSC4",$J)) D MESS3^SDWLMSG
"RTN","SDWLQSC",114,0)
 D EN4
"RTN","SDWLQSC",115,0)
 Q
"RTN","SDWLQSC",116,0)
EN4 ;PCMM Team inactivated
"RTN","SDWLQSC",117,0)
 S (IEN,TIEN,TEAM,TEAMN,DFN,CC,STATUS,WLOPEN,SDFORM)="" S CC="0"
"RTN","SDWLQSC",118,0)
 F  S TEAM=$O(^SDWL(409.3,"D",TEAM)) Q:TEAM<1  S CC=0 D
"RTN","SDWLQSC",119,0)
 .S IEN="" F  S IEN=$O(^SDWL(409.3,"D",TEAM,IEN)) Q:IEN<1  S WLOPEN=$$GET1^DIQ(409.3,IEN_",",23,"I") D
"RTN","SDWLQSC",120,0)
 ..Q:WLOPEN="C"  S TIEN="",TIEN=$O(^SCTM(404.58,"B",TEAM,TIEN),-1) IF TIEN'="" D
"RTN","SDWLQSC",121,0)
 ...S STATUS=$$GET1^DIQ(404.58,TIEN_",",.03,"I")
"RTN","SDWLQSC",122,0)
 ...Q:STATUS="1"
"RTN","SDWLQSC",123,0)
 ...IF STATUS="0" S CC=CC+1
"RTN","SDWLQSC",124,0)
 .IF CC>0 D 
"RTN","SDWLQSC",125,0)
 ..S TEAMN=$$GET1^DIQ(404.51,TEAM_",",.01) S TEAMN=$E(TEAMN,1,30)
"RTN","SDWLQSC",126,0)
 ..S SDFORM=$$FORM^SDFORM(TEAMN,40,CC,20),^TMP("SDWLQSC5",$J,TEAM)=SDFORM
"RTN","SDWLQSC",127,0)
 IF $D(^TMP("SDWLQSC5",$J)) D MESS4^SDWLMSG
"RTN","SDWLQSC",128,0)
 D EN5
"RTN","SDWLQSC",129,0)
 Q
"RTN","SDWLQSC",130,0)
EN5 ;PCMM Position inactivated
"RTN","SDWLQSC",131,0)
 S (IEN,PIEN,POS,POSN,STATUS,WLOPEN,SDWLPOS,SDFORM,TEAM)=""
"RTN","SDWLQSC",132,0)
 S SDWLPOS="" F  S IEN=$O(^SDWL(409.3,"SP",IEN)) Q:IEN<1  D
"RTN","SDWLQSC",133,0)
 .S POS="" F  S POS=$O(^SDWL(409.3,"SP",IEN,POS)) Q:POS<1  D
"RTN","SDWLQSC",134,0)
 ..S WLOPEN=$$GET1^DIQ(409.3,IEN_",",23,"I")
"RTN","SDWLQSC",135,0)
 ..Q:WLOPEN="C"
"RTN","SDWLQSC",136,0)
 ..S PIEN="",PIEN=$O(^SCTM(404.59,"B",POS,PIEN),-1) IF PIEN'="" D
"RTN","SDWLQSC",137,0)
 ... S POSN=$$GET1^DIQ(404.57,POS_",",.01)
"RTN","SDWLQSC",138,0)
 ...IF PIEN'="" S STATUS=$$GET1^DIQ(404.59,PIEN_",",.03,"I")
"RTN","SDWLQSC",139,0)
 ...Q:STATUS="1"
"RTN","SDWLQSC",140,0)
 ...IF STATUS="0" D
"RTN","SDWLQSC",141,0)
 ....S:'$D(SDWLPOS(POS)) SDWLPOS(POS)=0 S SDWLPOS(POS)=SDWLPOS(POS)+1,POSN=$E(POSN,1,30)
"RTN","SDWLQSC",142,0)
 ....S TEAM=$$GET1^DIQ(404.57,POS_",",.02),TEAM=$E(TEAM,1,25)
"RTN","SDWLQSC",143,0)
 ....S SDFORM=$$FORM^SDFORM(POSN,32,TEAM,27,SDWLPOS(POS),21)
"RTN","SDWLQSC",144,0)
 ....S ^TMP("SDWLQSC6",$J,POS)=SDFORM
"RTN","SDWLQSC",145,0)
 IF $D(^TMP("SDWLQSC6",$J)) D MESS5^SDWLMSG
"RTN","SDWLQSC",146,0)
 D EN6
"RTN","SDWLQSC",147,0)
 Q
"RTN","SDWLQSC",148,0)
EN6 ;Date of Death
"RTN","SDWLQSC",149,0)
 S (IEN,SDDFN,DIS,DOD,NAME)=""
"RTN","SDWLQSC",150,0)
 F  S SDDFN=$O(^SDWL(409.3,"B",SDDFN)) Q:SDDFN<1  D
"RTN","SDWLQSC",151,0)
 .S IEN="" F  S IEN=$O(^SDWL(409.3,"B",SDDFN,IEN)) Q:IEN<1  D
"RTN","SDWLQSC",152,0)
 ..S DIS=$$GET1^DIQ(409.3,IEN_",",21,"I") IF DIS="D" D
"RTN","SDWLQSC",153,0)
 ...S DOD=$$GET1^DIQ(2,SDDFN_",",.351) Q:DOD'=""  D
"RTN","SDWLQSC",154,0)
 ....S DIE="^SDWL(409.3,",DA=IEN,DR="23////^S X=""O""" D ^DIE
"RTN","SDWLQSC",155,0)
 ....S DR="19///@" D ^DIE
"RTN","SDWLQSC",156,0)
 ....S DR="20///@" D ^DIE
"RTN","SDWLQSC",157,0)
 ....S DR="21///@" D ^DIE
"RTN","SDWLQSC",158,0)
 ....S DR="29////^S X=""DE""" D ^DIE
"RTN","SDWLQSC",159,0)
 ....S NAME=$$GET1^DIQ(2,SDDFN_",",.01) S ^TMP("SDWLQSC7",$J,SDDFN)=NAME
"RTN","SDWLQSC",160,0)
 IF $D(^TMP("SDWLQSC7",$J)) D MESS6^SDWLMSG
"RTN","SDWLQSC",161,0)
 D EN7
"RTN","SDWLQSC",162,0)
 Q
"RTN","SDWLQSC",163,0)
EN7 ;PCMM Team open slots
"RTN","SDWLQSC",164,0)
 S (IEN,TIEN,TEAMN,CC,WLOPEN,MAX,AVAL,SDFORM,TEAM,STATUS)=""
"RTN","SDWLQSC",165,0)
 F  S TEAM=$O(^SDWL(409.3,"D",TEAM)) Q:TEAM<1  S CC=0 D
"RTN","SDWLQSC",166,0)
 .S IEN="" F  S IEN=$O(^SDWL(409.3,"D",TEAM,IEN)) Q:IEN<1  S WLOPEN=$$GET1^DIQ(409.3,IEN_",",23,"I") D
"RTN","SDWLQSC",167,0)
 ..Q:WLOPEN="C"  S CC=CC+1
"RTN","SDWLQSC",168,0)
 .IF CC>0 D
"RTN","SDWLQSC",169,0)
 ..S TIEN="",TIEN=$O(^SCTM(404.58,"B",TEAM,TIEN),-1) IF TIEN'="" D
"RTN","SDWLQSC",170,0)
 ...S STATUS=$$GET1^DIQ(404.58,TIEN_",",.03,"I")
"RTN","SDWLQSC",171,0)
 ...Q:STATUS="0"
"RTN","SDWLQSC",172,0)
 ...S MAX=$$GET1^DIQ(404.51,TEAM_",",.08)
"RTN","SDWLQSC",173,0)
 ...S TEAMC=$$TEAMCNT^SCAPMCU1(TEAM,DT)
"RTN","SDWLQSC",174,0)
 ...Q:(TEAMC+.01)>MAX  S AVAL=MAX-TEAMC,TEAMN=$$GET1^DIQ(404.51,TEAM_",",.01)
"RTN","SDWLQSC",175,0)
 ...S TEAMN=$E(TEAMN,1,30),SDFORM=$$FORM^SDFORM(TEAMN,35,AVAL,22,CC,12)
"RTN","SDWLQSC",176,0)
 ...S ^TMP("SDWLQSC8",$J,TIEN)=SDFORM
"RTN","SDWLQSC",177,0)
 IF $D(^TMP("SDWLQSC8",$J)) D
"RTN","SDWLQSC",178,0)
 .S SDFORM=$$FORM^SDFORM("TEAM",35,"SLOTS AVAILIABLE",22,"EWL ENTRIES",12)
"RTN","SDWLQSC",179,0)
 .S ^TMP("SDWLQSC8",$J,.06)=SDFORM
"RTN","SDWLQSC",180,0)
 .D MESS7^SDWLMSG
"RTN","SDWLQSC",181,0)
 D EN8
"RTN","SDWLQSC",182,0)
 Q
"RTN","SDWLQSC",183,0)
EN8 ;PCMM Position open slots
"RTN","SDWLQSC",184,0)
 S (IEN,PIEN,POS,POSN,STATUS,WLOPEN,EDATE,SDWLPOS,SDWL,SDFORM)="" K SDWLPOS
"RTN","SDWLQSC",185,0)
 S SDWLPOS="" F  S IEN=$O(^SDWL(409.3,"SP",IEN)) Q:IEN<1  D
"RTN","SDWLQSC",186,0)
 .S POS="" F  S POS=$O(^SDWL(409.3,"SP",IEN,POS)) Q:POS<1  D
"RTN","SDWLQSC",187,0)
 ..S PIEN="",PIEN=$O(^SCTM(404.59,"B",POS,PIEN),-1) IF PIEN'="" D
"RTN","SDWLQSC",188,0)
 ...S STATUS=$$GET1^DIQ(404.59,PIEN_",",.03,"I")
"RTN","SDWLQSC",189,0)
 ...S WLOPEN=$$GET1^DIQ(409.3,IEN_",",23,"I"),EDATE=$$GET1^DIQ(404.59,PIEN_",",.02,"I")
"RTN","SDWLQSC",190,0)
 ...Q:WLOPEN="C"
"RTN","SDWLQSC",191,0)
 ...Q:((EDATE+.01)<DT&(STATUS="0"))
"RTN","SDWLQSC",192,0)
 ...S:'$D(SDWLPOS(POS)) SDWLPOS(POS)=0 S SDWLPOS(POS)=SDWLPOS(POS)+1
"RTN","SDWLQSC",193,0)
 S (IEN,POS,POSN,MAX,AVAL,CC,TEAM)=""
"RTN","SDWLQSC",194,0)
 F  S POS=$O(SDWLPOS(POS)) Q:POS<1  D
"RTN","SDWLQSC",195,0)
 .S MAX=$$GET1^DIQ(404.57,POS_",",.08),SDWL=$$PCPOSCNT^SCAPMCU1(POS,DT)
"RTN","SDWLQSC",196,0)
 .Q:(SDWL+.01)>MAX
"RTN","SDWLQSC",197,0)
 .S TEAM=$$GET1^DIQ(404.57,POS_",",.02),TEAM=$E(TEAM,1,23)
"RTN","SDWLQSC",198,0)
 .S AVAL=MAX-SDWL,POSN=$$GET1^DIQ(404.57,POS_",",.01)
"RTN","SDWLQSC",199,0)
 .S POSN=$E(POSN,1,23),SDFORM=$$FORM^SDFORM(POSN,25,TEAM,25,AVAL,14,SDWLPOS(POS),11)
"RTN","SDWLQSC",200,0)
 .S ^TMP("SDWLQSC9",$J,POS)=SDFORM
"RTN","SDWLQSC",201,0)
 IF $D(^TMP("SDWLQSC9",$J)) D
"RTN","SDWLQSC",202,0)
 .S SDFORM=$$FORM^SDFORM("POSITION",25,"TEAM",25,"SLOTS AVAIL",14,"EWL ENTRIES",11)
"RTN","SDWLQSC",203,0)
 .S ^TMP("SDWLQSC9",$J,.06)=SDFORM
"RTN","SDWLQSC",204,0)
 .D MESS8^SDWLMSG
"RTN","SDWLQSC",205,0)
 Q
"RTN","SDWLREB")
0^2^B76814897
"RTN","SDWLREB",1,0)
SDWLREB ;BP/ESW - EWL matched with Canceled and Rebooked Appointment by Clinic ; 11/16/05 1:16pm
"RTN","SDWLREB",2,0)
 ;;5.3;Scheduling;**467**;Aug 13, 1993
"RTN","SDWLREB",3,0)
 ;
"RTN","SDWLREB",4,0)
 ;SD*5.3*467 - Match canceled appointments in EWL entries 
"RTN","SDWLREB",5,0)
 ;
"RTN","SDWLREB",6,0)
 Q
"RTN","SDWLREB",7,0)
REBOOK(DFN,SD,SC,RBFLG,SDTRB,SDCAN) ; rebook section
"RTN","SDWLREB",8,0)
 ;create appt TMP to check for rebooking
"RTN","SDWLREB",9,0)
 ;SD - appt date/time
"RTN","SDWLREB",10,0)
 ;SC - Hospital Location IEN
"RTN","SDWLREB",11,0)
 ;called by reference:
"RTN","SDWLREB",12,0)
 ;       RBFLG - cancellation status from Appointment Multiple
"RTN","SDWLREB",13,0)
 ;                       Only if RBFLG="CCR" - canceled by clinic, rebooked
"RTN","SDWLREB",14,0)
 ;       SDTRB - asked for scheduled Date/Time of Rebooked Appointment
"RTN","SDWLREB",15,0)
 ;       SDCAN - asked for cancellation date/time 
"RTN","SDWLREB",16,0)
 N SDARR,SCNT
"RTN","SDWLREB",17,0)
 S RBFLG=0,SDTRB="",SDCAN="NONE" ;initiate if not 'good' appointment
"RTN","SDWLREB",18,0)
 S SDARR(1)=SD_";"_SD
"RTN","SDWLREB",19,0)
 S SDARR(2)=SC
"RTN","SDWLREB",20,0)
 S SDARR(4)=DFN
"RTN","SDWLREB",21,0)
 S SDARR("FLDS")="1;2;3;24;25"
"RTN","SDWLREB",22,0)
 N SAPP S SAPP=$$SDAPI^SDAMA301(.SDARR) D
"RTN","SDWLREB",23,0)
 .N SDINST,SDFAC,SDINSTE
"RTN","SDWLREB",24,0)
 .Q:'$D(^TMP($J,"SDAMA301",DFN))
"RTN","SDWLREB",25,0)
 .N SDSTR S SDSTR=^TMP($J,"SDAMA301",DFN,SC,SD)
"RTN","SDWLREB",26,0)
 .N SDSTAT S SDSTAT=$P(SDSTR,U,3)
"RTN","SDWLREB",27,0)
 .K ^TMP($J,"SDAMA301",DFN,SC,SD)
"RTN","SDWLREB",28,0)
 .S RBFLG=$P(SDSTAT,";")
"RTN","SDWLREB",29,0)
 .S SDTRB=$P(SDSTR,U,24)
"RTN","SDWLREB",30,0)
 .S SDCAN=$P(SDSTR,U,25)
"RTN","SDWLREB",31,0)
 Q
"RTN","SDWLREB",32,0)
DISREB(DFN,SDTRB,SC) ;DISPOSITION REBOOK OR NOT
"RTN","SDWLREB",33,0)
 ; DFN - IEN of file #2 (Patient)
"RTN","SDWLREB",34,0)
 ; SDTRB - Scheduled Date/Time of Rebooked Appt
"RTN","SDWLREB",35,0)
 ; SC - Clinic IEN
"RTN","SDWLREB",36,0)
 ; Temporary ^TMP($J,"APPT" will be created with rebooked appt data
"RTN","SDWLREB",37,0)
 N SDARR,SCNT
"RTN","SDWLREB",38,0)
 S SDDIV=""
"RTN","SDWLREB",39,0)
 S SDARR(1)=SDTRB_";"_SDTRB
"RTN","SDWLREB",40,0)
 S SDARR(2)=SC
"RTN","SDWLREB",41,0)
 S SDARR(4)=DFN
"RTN","SDWLREB",42,0)
 S SDARR("FLDS")="1;2;3;4;10;13;14"
"RTN","SDWLREB",43,0)
 N SAPP S SAPP=$$SDAPI^SDAMA301(.SDARR) D
"RTN","SDWLREB",44,0)
 .N SDINST,SDFAC,SDINSTE
"RTN","SDWLREB",45,0)
 .Q:'$D(^TMP($J,"SDAMA301",DFN))
"RTN","SDWLREB",46,0)
 .K ^TMP($J,"APPT") S SCNT=1
"RTN","SDWLREB",47,0)
 .S ^TMP($J,"APPT",SCNT)=^TMP($J,"SDAMA301",DFN,SC,SDTRB)
"RTN","SDWLREB",48,0)
 .S SDINST=$$GET1^DIQ(44,SC_",",3,"I")  ; get Institution
"RTN","SDWLREB",49,0)
 .S SDINSTE=$$GET1^DIQ(44,SC_",",3,"E")
"RTN","SDWLREB",50,0)
 .S SDFAC=$S(SDINST="":"",1:$$GET1^DIQ(4,SDINST_",",99,"I"))  ; Station
"RTN","SDWLREB",51,0)
 .I SDFAC="" N SDDIV S SDDIV="" S SDDIV=$$GET1^DIQ(44,SC_",",3.5,"I") D
"RTN","SDWLREB",52,0)
 ..I SDDIV'="" S SDINST=$$GET1^DIQ(40.8,SDDIV_",",.07,"I") I SDINST'="" D
"RTN","SDWLREB",53,0)
 ...S SDFAC=$S(SDINST="":"",1:$$GET1^DIQ(4,SDINST_",",99,"I"))  ; Station
"RTN","SDWLREB",54,0)
 ..I SDDIV="" S SDFAC=$P($$SITE^VASITE(,),"^",3)
"RTN","SDWLREB",55,0)
 .S $P(^TMP($J,"APPT",SCNT),"^",15)=SDINST_";"_SDINSTE
"RTN","SDWLREB",56,0)
 .S $P(^TMP($J,"APPT",SCNT),"^",16)=SDFAC
"RTN","SDWLREB",57,0)
 .K ^TMP($J,"SDAMA301",DFN,SC,SDTRB)
"RTN","SDWLREB",58,0)
 Q
"RTN","SDWLREB",59,0)
OPENEWL(DFN,SDT,SC,SDREB,CEWL) ; SD*5.3*467 Open EWL entry if closed with appointment being canceled
"RTN","SDWLREB",60,0)
 ;SDT - appointment date/time
"RTN","SDWLREB",61,0)
 ;SC  - appointment clinic IEN
"RTN","SDWLREB",62,0)
 ;SDREB - REBOOKING FLAG: 1 - cancel & rebook
"RTN","SDWLREB",63,0)
 ;                        0 - cancel only
"RTN","SDWLREB",64,0)
 ;CEWL - counter, optionally passed by reference with initial value=0 
"RTN","SDWLREB",65,0)
 N DH,IEN,STATUS,CLINIC,WLAPPT,WLSTAT,SDNAM,SDAPPT,SSN,SCN
"RTN","SDWLREB",66,0)
 K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL")
"RTN","SDWLREB",67,0)
 I '$D(CEWL) D
"RTN","SDWLREB",68,0)
 .I $D(^TMP("SDWLREB",$J)) S CEWL=$O(^TMP("SDWLREB",$J,""),-1)
"RTN","SDWLREB",69,0)
 .E  S CEWL=0
"RTN","SDWLREB",70,0)
 S IEN="" F  S IEN=$O(^SDWL(409.3,"B",DFN,IEN)) Q:IEN<1  D
"RTN","SDWLREB",71,0)
 .S STATUS="" S STATUS=$$GET1^DIQ(409.3,IEN_",",23,"I") IF STATUS="C" D
"RTN","SDWLREB",72,0)
 ..IF $G(^SDWL(409.3,IEN,"SDAPT")) D
"RTN","SDWLREB",73,0)
 ...S CLINIC=$$GET1^DIQ(409.3,IEN_",",13.2,"I"),WLAPPT=$$GET1^DIQ(409.3,IEN_",",13,"I")
"RTN","SDWLREB",74,0)
 ...IF CLINIC=SC&(WLAPPT=SDT) S WLSTAT=$$GET1^DIQ(409.3,IEN_",",21,"I") I WLSTAT="SA" D
"RTN","SDWLREB",75,0)
 ....N Y S Y=WLAPPT D DD^%DT S SDAPPT=Y
"RTN","SDWLREB",76,0)
 ....S SCN=$$GET1^DIQ(44,SC_",",.01),SCN=$E(SCN,1,20)
"RTN","SDWLREB",77,0)
 ....S SDNAM=$$GET1^DIQ(2,DFN_",",.01,"I"),SDNAM=$E(SDNAM,1,25),SSN=$$GET1^DIQ(2,DFN_",",.09,"I")
"RTN","SDWLREB",78,0)
 ....S SDFORM=$$FORM^SDFORM(SDNAM,23,SSN,12,SCN,24,SDAPPT,20)
"RTN","SDWLREB",79,0)
 ....S CEWL=CEWL+1 S ^TMP("SDWLREB",$J,CEWL)=SDFORM
"RTN","SDWLREB",80,0)
 ....N DIE,DA,DR
"RTN","SDWLREB",81,0)
 ....S DIE="^SDWL(409.3,",DA=IEN,DR="23////^S X=""O""" D ^DIE
"RTN","SDWLREB",82,0)
 ....S DR="13.8////^S X=""CC""" D ^DIE
"RTN","SDWLREB",83,0)
 ....S DR="29////^S X=""CA""" D ^DIE
"RTN","SDWLREB",84,0)
 ....S DR="19///@" D ^DIE
"RTN","SDWLREB",85,0)
 ....S DR="20///@" D ^DIE
"RTN","SDWLREB",86,0)
 ....S DR="21///@" D ^DIE
"RTN","SDWLREB",87,0)
 ....S DR="13///@;13.1////@;13.2///@;13.3///@;13.4///@;13.5///@;13.6///@;13.8///@;13.7///@" D ^DIE
"RTN","SDWLREB",88,0)
 ....I $D(^TMP("SDWLREB",$J)) I SDREB D ASKDISP(IEN)
"RTN","SDWLREB",89,0)
 I '$D(^TMP($J,"SDWLPL")) Q  ; no closed EWL related entry
"RTN","SDWLREB",90,0)
 I SDREB D DISP
"RTN","SDWLREB",91,0)
 Q
"RTN","SDWLREB",92,0)
MESS ; SD*5.3*467 - send message with a list of opened EWL entries because of canceled appointments
"RTN","SDWLREB",93,0)
 S ^TMP("SDWLREB",$J,.01)="This message displays patients that had their EWL entry opened because of "
"RTN","SDWLREB",94,0)
 S ^TMP("SDWLREB",$J,.02)="their matching appointment being now 'CANCELED BY CLINIC'. Some of those "
"RTN","SDWLREB",95,0)
 S ^TMP("SDWLREB",$J,.03)="entries may be already closed again if new appointments were scheduled and "
"RTN","SDWLREB",96,0)
 S ^TMP("SDWLREB",$J,.04)="matched with those EWL entries. You may use 'SD WAIT LIST REOPEN ENTRIES' "
"RTN","SDWLREB",97,0)
 S ^TMP("SDWLREB",$J,.05)="to run report identifying the related EWL entries."
"RTN","SDWLREB",98,0)
 N SDFORM S SDFORM=$$FORM^SDFORM("PATIENT NAME",23,"SSN",12,"CLINIC",24,"DATE/TIME of APPT",20) D  ;added
"RTN","SDWLREB",99,0)
 .S ^TMP("SDWLREB",$J,.06)=SDFORM
"RTN","SDWLREB",100,0)
 S ^TMP("SDWLREB",$J,.07)="-----------------------------------------------------------------------"
"RTN","SDWLREB",101,0)
 S ^TMP("SDWLREB",$J,.08)=""
"RTN","SDWLREB",102,0)
 N XMSUB,XMY,XMTEXT,XMDUZ
"RTN","SDWLREB",103,0)
 S XMSUB="EWL opened entries with appointments 'CANCELED BY CLINIC'."
"RTN","SDWLREB",104,0)
 S XMY("G.SD EWL BACKGROUND UPDATE")=""
"RTN","SDWLREB",105,0)
 S XMTEXT="^TMP(""SDWLREB"",$J,"
"RTN","SDWLREB",106,0)
 S XMDUZ="POSTMASTER"
"RTN","SDWLREB",107,0)
 D ^XMD K ^TMP("SDWLREB",$J)
"RTN","SDWLREB",108,0)
 Q
"RTN","SDWLREB",109,0)
ASKDISP(IEN) ;
"RTN","SDWLREB",110,0)
 ;IEN - pointer to 409.3 to get data and display
"RTN","SDWLREB",111,0)
 N SDDIS S SDDIS=0 ; flag indicating disposition
"RTN","SDWLREB",112,0)
 W ! N X,DIR,DENTER
"RTN","SDWLREB",113,0)
 Q:$$GET1^DIQ(409.3,IEN_",",23,"I")="C"
"RTN","SDWLREB",114,0)
 S ^TMP("SDWLPL",$J,IEN)=$G(^SDWL(409.3,IEN,0)) S DENTER="",DENTER=$P($G(^TMP("SDWLPL",$J,IEN)),"^",2)
"RTN","SDWLREB",115,0)
 S (WLTYPE,TYPE,WLTN,NUM)="",TYPE=$P($G(^TMP("SDWLPL",$J,IEN)),"^",5)
"RTN","SDWLREB",116,0)
 IF DENTER'=""&(TYPE'="") D
"RTN","SDWLREB",117,0)
 .IF TYPE=1 S WLTYPE="PCMM TEAM",NUM=$P($G(^TMP("SDWLPL",$J,IEN)),"^",6),WLTNI=$$GET1^DIQ(404.51,NUM_",",.01,"I"),WLTN=$$GET1^DIQ(404.51,NUM_",",.01)
"RTN","SDWLREB",118,0)
 .IF TYPE=2 S WLTYPE="PCMM POSITION",NUM=$P($G(^TMP("SDWLPL",$J,IEN)),"^",7),WLTNI=$$GET1^DIQ(404.57,NUM_",",.01,"I"),WLTN=$$GET1^DIQ(404.57,NUM_",",.01)
"RTN","SDWLREB",119,0)
 .IF TYPE=3 S WLTYPE="SERV/SPECIALTY",NUM=$P($G(^TMP("SDWLPL",$J,IEN)),"^",8),WLTNI=$$GET1^DIQ(409.31,NUM_",",.01,"I"),WLTN=$$GET1^DIQ(409.31,NUM_",",.01)
"RTN","SDWLREB",120,0)
 .IF TYPE=4 S WLTYPE="CLINIC",NUM=$P($G(^TMP("SDWLPL",$J,IEN)),"^",9),WLTNI=$$GET1^DIQ(409.32,NUM_",",.01,"I"),WLTN=$$GET1^DIQ(409.32,NUM_",",.01)
"RTN","SDWLREB",121,0)
 E  Q
"RTN","SDWLREB",122,0)
 D SAVE(TYPE,WLTNI,IEN)
"RTN","SDWLREB",123,0)
 Q
"RTN","SDWLREB",124,0)
SAVE(TYPE,WLTNI,IEN) ;
"RTN","SDWLREB",125,0)
 ;TYPE - EWL type
"RTN","SDWLREB",126,0)
 ;WLTNI - TYPE related name the EWL entry is waiting for
"RTN","SDWLREB",127,0)
 ;IEN - pointer to 409.3 
"RTN","SDWLREB",128,0)
 S REQBY=$P($G(^TMP("SDWLPL",$J,IEN)),"^",12)
"RTN","SDWLREB",129,0)
 S INST=$P($G(^TMP("SDWLPL",$J,IEN)),"^",3)
"RTN","SDWLREB",130,0)
 N DESIRED S DESIRED=$P($G(^TMP("SDWLPL",$J,IEN)),"^",16)
"RTN","SDWLREB",131,0)
 N NAME,SSN S NAME=$$GET1^DIQ(2,DFN_",",.01),SSN=$$GET1^DIQ(2,DFN_",",.09)
"RTN","SDWLREB",132,0)
 N SDBY S SDBY=$$GET1^DIQ(409.3,IEN_",",11),SDBY=$E(SDBY,1,3)
"RTN","SDWLREB",133,0)
 S NN=$O(^TMP($J,"SDWLPL",""),-1)+1
"RTN","SDWLREB",134,0)
 S ^TMP($J,"SDWLPL",NN)=IEN_U_WLTYPE_U_U_WLTN_U_INST_U_DENTER_U_SDBY_U_DESIRED
"RTN","SDWLREB",135,0)
 ;
"RTN","SDWLREB",136,0)
 N SPIEC S SPIEC=$S(TYPE=4:9,TYPE=3:10,TYPE=2:11,TYPE=1:12)
"RTN","SDWLREB",137,0)
 S $P(^TMP($J,"SDWLPL",NN),U,SPIEC)=WLTNI
"RTN","SDWLREB",138,0)
 K ^TMP("SDWLPL",$J,IEN)
"RTN","SDWLREB",139,0)
 Q
"RTN","SDWLREB",140,0)
DISP ;
"RTN","SDWLREB",141,0)
 W !,"EWL Entry has just been opened because of its matching appointment",!,"being canceled.",!!
"RTN","SDWLREB",142,0)
 N DIR S DIR("B")="YES" ; default to match and close rebooked appointments
"RTN","SDWLREB",143,0)
 S DIR("A")="Do you wish to close this EWL entry with Rebooked Appointment(Yes/No)",DIR(0)="Y"
"RTN","SDWLREB",144,0)
 W "Closing this entry will disposition it: SA - REMOVED/SCHEDULED-ASSIGNED",!,"with Rebooked Appointment.",!!
"RTN","SDWLREB",145,0)
 S DIR("?")="Y(ES) will disposition this EWL entry as 'SA' with just rebooked appointment."
"RTN","SDWLREB",146,0)
 D LIST ; disable displaying EWL entry per SRS.
"RTN","SDWLREB",147,0)
 W ! D ^DIR
"RTN","SDWLREB",148,0)
 N SDDIS S SDDIS=0 I Y S SDDIS=1
"RTN","SDWLREB",149,0)
 E  Q
"RTN","SDWLREB",150,0)
 N SDWLDISP,SDWLDA,SDWLDFN,NUM
"RTN","SDWLREB",151,0)
 I SDDIS S SDWLDISP="SA",NUM="" F  S NUM=$O(^TMP($J,"SDWLPL",NUM)) Q:NUM=""  S REC=^TMP($J,"SDWLPL",NUM) D
"RTN","SDWLREB",152,0)
 .S SDWLDA=+REC N SDP,SDR D
"RTN","SDWLREB",153,0)
 .S DIE="^SDWL(409.3,",DA=SDWLDA,DR="21////^S X=SDWLDISP" D ^DIE
"RTN","SDWLREB",154,0)
 .S DR="19////^S X=DT" D ^DIE
"RTN","SDWLREB",155,0)
 .S DR="20////^S X=DUZ" D ^DIE
"RTN","SDWLREB",156,0)
 .S DR="23////^S X=""C""" D ^DIE
"RTN","SDWLREB",157,0)
 .;I SDWLDISP="SA" update with appointment data
"RTN","SDWLREB",158,0)
 .;get appointment data to file (for a particular appt #)
"RTN","SDWLREB",159,0)
 .I SDWLDISP="SA" N SDA D DATP^SDWLEVAL(1,.SDA) D
"RTN","SDWLREB",160,0)
 ..I $D(SDA) S DIE="^SDWL(409.3,",DA=SDWLDA D
"RTN","SDWLREB",161,0)
 ...S DR="13////"_SDA(1)_";13.1////"_DT_";13.2////"_SDA(2)_";13.3////"_SDA(15)_";13.4////"_SDA(13)_";13.5////"_SDA(14)_";13.6////"_SDA(16)_";13.8////"_SDA(3)_";13.7////"_DUZ
"RTN","SDWLREB",162,0)
 ...D ^DIE
"RTN","SDWLREB",163,0)
 .N SDWLSCL,SDWLSS,SDC
"RTN","SDWLREB",164,0)
 .S SDC=1
"RTN","SDWLREB",165,0)
 .S SDWLSCL=$P($G(^TMP($J,"SDWLPL",SDC)),U,9)
"RTN","SDWLREB",166,0)
 .S SDWLSS=$P($G(^TMP($J,"SDWLPL",SDC)),U,10)
"RTN","SDWLREB",167,0)
 .I SDWLSCL K:$D(^SDWL(409.3,"SC",SDWLSCL,SDWLDA)) ^SDWL(409.3,"SC",SDWLSCL,SDWLDA)
"RTN","SDWLREB",168,0)
 .S SDWLDFN=$P($G(^TMP($J,"APPT",1)),U,4)
"RTN","SDWLREB",169,0)
 .I SDWLSS,SDWLDFN K:$D(^SDWL(409.3,"SS",SDWLDFN,SDWLSS,SDWLDA)) ^SDWL(409.3,"SS",SDWLDFN,SDWLSS,SDWLDA)
"RTN","SDWLREB",170,0)
 Q
"RTN","SDWLREB",171,0)
LIST ;LIST
"RTN","SDWLREB",172,0)
 ;may be called if EWL entry display would be needed
"RTN","SDWLREB",173,0)
 S (REC,NUM)="" N SDPN
"RTN","SDWLREB",174,0)
 F  S NUM=$O(^TMP($J,"SDWLPL",NUM)) Q:NUM=""  S REC=^TMP($J,"SDWLPL",NUM) D
"RTN","SDWLREB",175,0)
 .S IEN=+REC N SDP,SDR D
"RTN","SDWLREB",176,0)
 ..S SDPN=$$GET1^DIQ(409.3,IEN_",",.01) W !,"Patient: ",SDPN
"RTN","SDWLREB",177,0)
 ..W !,"  EW List Type   P  Waiting for Institution  Orig Date   By  Des. Date Reopen"
"RTN","SDWLREB",178,0)
 ..W !,"--------------------------------------------------------------------------"
"RTN","SDWLREB",179,0)
 ..S SDP=$E($$GET1^DIQ(409.3,IEN_",",10)) ;priority
"RTN","SDWLREB",180,0)
 ..S SDR=$$GET1^DIQ(409.3,IEN_",",29,"I") ;reopen reason
"RTN","SDWLREB",181,0)
 .N SDINS,SDIN S SDINS=$P(REC,"^",5) S SDIN=$$GET1^DIQ(4,SDINS_",",.01,"I")
"RTN","SDWLREB",182,0)
 .W !,NUM_". ",$E($P(REC,"^",2),1,12),?17,SDP,?21,$E($P(REC,U,4),1,13),?35,SDIN,?45,$$FMTE^XLFDT($P(REC,"^",6),8),?57,$P(REC,"^",7),?61,$$FMTE^XLFDT($P(REC,"^",8),8),?76,SDR
"RTN","SDWLREB",183,0)
 .N SDUP,SDLO
"RTN","SDWLREB",184,0)
 .S SDUP="ABCDEFGHIJKLMNOPRSTUWQXYzv",SDLO="abcdefghijklmnoprstuwqxyzv"
"RTN","SDWLREB",185,0)
 .N SMT S SMT=$$GET1^DIQ(409.3,IEN_",",25) I SMT'="" S SMT=$TR(SMT,SDUP,SDLO) W !?2,"Comment: ",SMT
"RTN","SDWLREB",186,0)
 .N SMO S SMO=$$GET1^DIQ(409.3,IEN_",",30) I SMO'="" S SMO=$TR(SMO,SDUP,SDLO) W !?2,"Reopen: ",SMO
"RTN","SDWLREB",187,0)
 K ANS1,NN,INST,SCODE,CLINIC,DENTER,REQBY,DESIRD,SCPRI
"RTN","SDWLREB",188,0)
 K CLINIC,WLTYPE,TYPE,WLTN,NUM,REC
"RTN","SDWLREB",189,0)
 Q
"VER")
8.0^22.0
"BLD",6462,6)
^376
**END**
**END**
