Released XU*8*157 SEQ #200
Extracted from mail message
**KIDS**:XU*8.0*157^

**INSTALL NAME**
XU*8.0*157
"BLD",300,0)
XU*8.0*157^KERNEL^0^3020701^y
"BLD",300,1,0)
^^4^4^3020509^
"BLD",300,1,1,0)
XU*8*157
"BLD",300,1,2,0)
Menu Rebuild Rewrite - Part 2
"BLD",300,1,3,0)
Refer to patch XU*8*157 in the FORUM Patch Module for a complete
"BLD",300,1,4,0)
description.
"BLD",300,4,0)
^9.64PA^^
"BLD",300,"KRN",0)
^9.67PA^19^17
"BLD",300,"KRN",.4,0)
.4
"BLD",300,"KRN",.401,0)
.401
"BLD",300,"KRN",.402,0)
.402
"BLD",300,"KRN",.403,0)
.403
"BLD",300,"KRN",.5,0)
.5
"BLD",300,"KRN",.84,0)
.84
"BLD",300,"KRN",3.6,0)
3.6
"BLD",300,"KRN",3.8,0)
3.8
"BLD",300,"KRN",9.2,0)
9.2
"BLD",300,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",300,"KRN",9.8,0)
9.8
"BLD",300,"KRN",9.8,"NM",0)
^9.68A^21^18
"BLD",300,"KRN",9.8,"NM",1,0)
XQ12^^0^B48280597
"BLD",300,"KRN",9.8,"NM",2,0)
XQ75^^0^B50661291
"BLD",300,"KRN",9.8,"NM",3,0)
XQ8^^0^B22674034
"BLD",300,"KRN",9.8,"NM",4,0)
XQ81^^0^B62776969
"BLD",300,"KRN",9.8,"NM",6,0)
XQ83^^0^B32147680
"BLD",300,"KRN",9.8,"NM",7,0)
XQ83A^^0^B26531678
"BLD",300,"KRN",9.8,"NM",8,0)
XQ83D^^0^B9411981
"BLD",300,"KRN",9.8,"NM",9,0)
XQ83R^^0^B28235554
"BLD",300,"KRN",9.8,"NM",11,0)
XQ8A^^0^B6567473
"BLD",300,"KRN",9.8,"NM",12,0)
XQLOCK^^0^B28321990
"BLD",300,"KRN",9.8,"NM",14,0)
XQCS^^0^B35404398
"BLD",300,"KRN",9.8,"NM",15,0)
XQTOC^^0^B16630019
"BLD",300,"KRN",9.8,"NM",16,0)
XQ84^^0^B37218485
"BLD",300,"KRN",9.8,"NM",17,0)
XQ72^^0^B38288578
"BLD",300,"KRN",9.8,"NM",18,0)
XQ71^^0^B18790192
"BLD",300,"KRN",9.8,"NM",19,0)
XUSERNEW^^0^B18286823
"BLD",300,"KRN",9.8,"NM",20,0)
XQ82^^0^B5592001
"BLD",300,"KRN",9.8,"NM",21,0)
XQ^^0^B24858955
"BLD",300,"KRN",9.8,"NM","B","XQ",21)

"BLD",300,"KRN",9.8,"NM","B","XQ12",1)

"BLD",300,"KRN",9.8,"NM","B","XQ71",18)

"BLD",300,"KRN",9.8,"NM","B","XQ72",17)

"BLD",300,"KRN",9.8,"NM","B","XQ75",2)

"BLD",300,"KRN",9.8,"NM","B","XQ8",3)

"BLD",300,"KRN",9.8,"NM","B","XQ81",4)

"BLD",300,"KRN",9.8,"NM","B","XQ82",20)

"BLD",300,"KRN",9.8,"NM","B","XQ83",6)

"BLD",300,"KRN",9.8,"NM","B","XQ83A",7)

"BLD",300,"KRN",9.8,"NM","B","XQ83D",8)

"BLD",300,"KRN",9.8,"NM","B","XQ83R",9)

"BLD",300,"KRN",9.8,"NM","B","XQ84",16)

"BLD",300,"KRN",9.8,"NM","B","XQ8A",11)

"BLD",300,"KRN",9.8,"NM","B","XQCS",14)

"BLD",300,"KRN",9.8,"NM","B","XQLOCK",12)

"BLD",300,"KRN",9.8,"NM","B","XQTOC",15)

"BLD",300,"KRN",9.8,"NM","B","XUSERNEW",19)

"BLD",300,"KRN",19,0)
19
"BLD",300,"KRN",19,"NM",0)
^9.68A^6^5
"BLD",300,"KRN",19,"NM",1,0)
XQBUILDMAIN^^2
"BLD",300,"KRN",19,"NM",3,0)
XQSHOWBUILDS^^0
"BLD",300,"KRN",19,"NM",4,0)
XQBUILDTREE^^0^
"BLD",300,"KRN",19,"NM",5,0)
XQRIGHTNOW^^0
"BLD",300,"KRN",19,"NM",6,0)
XQKICKMICRO^^0
"BLD",300,"KRN",19,"NM","B","XQBUILDMAIN",1)

"BLD",300,"KRN",19,"NM","B","XQBUILDTREE",4)

"BLD",300,"KRN",19,"NM","B","XQKICKMICRO",6)

"BLD",300,"KRN",19,"NM","B","XQRIGHTNOW",5)

"BLD",300,"KRN",19,"NM","B","XQSHOWBUILDS",3)

"BLD",300,"KRN",19.1,0)
19.1
"BLD",300,"KRN",101,0)
101
"BLD",300,"KRN",409.61,0)
409.61
"BLD",300,"KRN",771,0)
771
"BLD",300,"KRN",870,0)
870
"BLD",300,"KRN",8994,0)
8994
"BLD",300,"KRN","B",.4,.4)

"BLD",300,"KRN","B",.401,.401)

"BLD",300,"KRN","B",.402,.402)

"BLD",300,"KRN","B",.403,.403)

"BLD",300,"KRN","B",.5,.5)

"BLD",300,"KRN","B",.84,.84)

"BLD",300,"KRN","B",3.6,3.6)

"BLD",300,"KRN","B",3.8,3.8)

"BLD",300,"KRN","B",9.2,9.2)

"BLD",300,"KRN","B",9.8,9.8)

"BLD",300,"KRN","B",19,19)

"BLD",300,"KRN","B",19.1,19.1)

"BLD",300,"KRN","B",101,101)

"BLD",300,"KRN","B",409.61,409.61)

"BLD",300,"KRN","B",771,771)

"BLD",300,"KRN","B",870,870)

"BLD",300,"KRN","B",8994,8994)

"BLD",300,"QUES",0)
^9.62^^
"BLD",300,"REQB",0)
^9.611^1^1
"BLD",300,"REQB",1,0)
XU*8.0*156^2
"BLD",300,"REQB","B","XU*8.0*156",1)

"KRN",19,58,-1)
0^4
"KRN",19,58,0)
XQBUILDTREE^Build Primary Menu Trees^^R^^^XQBUILDTREE^^^^^^^
"KRN",19,58,1,0)
^^5^5^2880111^^
"KRN",19,58,1,1,0)
This option can be used to force the rebuilding of the tree structures
"KRN",19,58,1,2,0)
used for the ^JUMP.  Whenever an item in a menu is modified, the tree
"KRN",19,58,1,3,0)
must get rebuilt.  This will happen automatically the first time it is
"KRN",19,58,1,4,0)
referenced, but forcing the rebuild can often save time.
"KRN",19,58,1,5,0)
The rebuilding of all trees can be queued.
"KRN",19,58,25)
BUILD^XQ81
"KRN",19,58,"U")
BUILD PRIMARY MENU TREES
"KRN",19,821,-1)
0^3
"KRN",19,821,0)
XQSHOWBUILDS^Most Recent Menu Rebuilds^^R^^^^^^^y^KERNEL^y
"KRN",19,821,1,0)
^^4^4^3000928^
"KRN",19,821,1,1,0)
        This option runs the program ^XQ84 which formats the data stored
"KRN",19,821,1,2,0)
in the global ^XUTL("XQ","BUILDS") the 20 most recent menu rebuilds,
"KRN",19,821,1,3,0)
including complete live rebuilds, micro surgery episodes, and tasked
"KRN",19,821,1,4,0)
rebuilds.
"KRN",19,821,25)
SHOW^XQ84
"KRN",19,821,"U")
MOST RECENT MENU REBUILDS
"KRN",19,822,-1)
2^1
"KRN",19,822,0)
XQBUILDMAIN^Menu Rebuild Menu^^M^10^^^^^^^3^y
"KRN",19,822,10,0)
^19.01IP^5^5
"KRN",19,822,10,1,0)
821
"KRN",19,822,10,1,"^")
XQSHOWBUILDS
"KRN",19,822,10,2,0)
58
"KRN",19,822,10,2,"^")
XQBUILDTREE
"KRN",19,822,10,4,0)
824
"KRN",19,822,10,4,"^")
XQKICKMICRO
"KRN",19,822,10,5,0)
827
"KRN",19,822,10,5,"^")
XQRIGHTNOW
"KRN",19,822,"U")
MENU REBUILD MENU
"KRN",19,824,-1)
0^6
"KRN",19,824,0)
XQKICKMICRO^Kick Off Micro Surgery^^R^^^^^^^^^y^1
"KRN",19,824,1,0)
^^9^9^3001124^
"KRN",19,824,1,1,0)
     When certain changes are made to the Option File those changes are
"KRN",19,824,1,2,0)
recorded in the cross-reference ^DIC(19,"AT").  Micro surgery is the
"KRN",19,824,1,3,0)
software in ^XQ83* that uses this data to rebuild the compiled menu trees
"KRN",19,824,1,4,0)
in ^DIC(19,"AXQ").  Micro surgery is normally triggered when a user logs
"KRN",19,824,1,5,0)
into a system, but this option allows the programmer to start it manually
"KRN",19,824,1,6,0)
if minor changes are made to the Option File which do not merit a complete
"KRN",19,824,1,7,0)
rebuild.  If there is nothing in the "AT" cross reference to work on the
"KRN",19,824,1,8,0)
option responds: "Nothing to rebuild.", if there is work to do then the
"KRN",19,824,1,9,0)
option responds with "Done." meaning that Micro surgery has been started.
"KRN",19,824,20)
W !!,?5,$S($D(^DIC(19,"AT")):"Done.",1:"Nothing to rebuild.")
"KRN",19,824,25)
CHEK^XQ83
"KRN",19,824,"U")
KICK OFF MICRO SURGERY
"KRN",19,827,-1)
0^5
"KRN",19,827,0)
XQRIGHTNOW^Is there a menu rebuild running right now?^^R^^^^^^^y^^y
"KRN",19,827,1,0)
^^2^2^3001017^
"KRN",19,827,1,1,0)
     This option checks the various flags set in ^DIC(19,"AXQ","P0") to
"KRN",19,827,1,2,0)
determine if there is menu rebuild activity on your system right now.
"KRN",19,827,25)
NOW^XQ84
"KRN",19,827,"U")
IS THERE A MENU REBUILD RUNNIN
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
157^3020701
"PKG",3,22,1,"PAH",1,1,0)
^^4^4^3020701
"PKG",3,22,1,"PAH",1,1,1,0)
XU*8*157
"PKG",3,22,1,"PAH",1,1,2,0)
Menu Rebuild Rewrite - Part 2
"PKG",3,22,1,"PAH",1,1,3,0)
Refer to patch XU*8*157 in the FORUM Patch Module for a complete
"PKG",3,22,1,"PAH",1,1,4,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
18
"RTN","XQ")
0^21^B24858955
"RTN","XQ",1,0)
XQ ; SEA/MJM - Menu driver (Part 1) ;05/06/2002  10:21
"RTN","XQ",2,0)
 ;;8.0;KERNEL;**9,46,94,103,157**;Jul 10, 1995
"RTN","XQ",3,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",4,0)
 D INIT^XQ12 Q:'$D(XQY)
"RTN","XQ",5,0)
 I $D(XQUR),$E(XQUR,1,2)="^^" S XQRB=1,XQJS=4
"RTN","XQ",6,0)
 I '$D(XQJS),$D(XQUR),XQUR'="",XQUR'["[" S:XQUR'[U XQUR=U_XQUR K ^VA(200,DUZ,202.1) S XQJS=0 D ^XQTOC
"RTN","XQ",7,0)
 I $D(XQUR),XQUR["[" K ^VA(200,DUZ,202.1) S XQJS=3,^XUTL("XQ",$J,"T")=1
"RTN","XQ",8,0)
 I $D(^VA(200,DUZ,202.1)),$L($P(^(202.1),U)) S XQJS=1 S %=+^(202.1) S XQUR=$G(^DIC(19,%,"U")) I XQUR]"" D ^XQTOC
"RTN","XQ",9,0)
M I '$D(XQVOL) S XQVOL=$G(^XUTL("XQ",$J,"XQVOL")) I '$L(XQVOL) D GETENV^%ZOSV S XQVOL=$P(Y,U,2)
"RTN","XQ",10,0)
 I $G(^%ZIS(14.5,"LOGON",XQVOL)) S XQNOLOG="" G H^XUS
"RTN","XQ",11,0)
 S:$S('$D(XQY0):1,'$L(XQY0):1,1:0) XQY0=^DIC(19,XQY,0) S XQT=$P(XQY0,U,4) G:XQT="" M3 K:'$D(XQJS) XQUR K X,XQNOGO,XQR,XQUIT,XQUEFLG ;,XQSV
"RTN","XQ",12,0)
 I $D(XQAUDIT),XQAUDIT D LOGOPT^XQ12
"RTN","XQ",13,0)
 I $P(XQY0,U,18) D CHKQUE^XQ92 I XQUEFLG S XQNOGO=""
"RTN","XQ",14,0)
 ;
"RTN","XQ",15,0)
 ;Execute the Entry Action and look for XQUIT
"RTN","XQ",16,0)
 D:'$D(XQM3)&("LOQX"'[XQT) LO K XQM3 I $D(XQUIT) D
"RTN","XQ",17,0)
 .S XQUIT=0
"RTN","XQ",18,0)
 .D ^XQUIT
"RTN","XQ",19,0)
 .Q
"RTN","XQ",20,0)
 ;
"RTN","XQ",21,0)
 G:$D(XQUR) ASK1 ;Jump start or continue
"RTN","XQ",22,0)
 I '$D(XQUIT),XQT'="A",$P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ",23,0)
 D:$D(XQXFLG)[0 ABT^XQ12 ;D:$P($G(XQXFLG),U,2) LOGRSRC^%ZOSV($P(XQY0,U))
"RTN","XQ",24,0)
 D:$P(XQY0,U)]"" LOGRSRC^%ZOSV($P(XQY0,U),0,1)
"RTN","XQ",25,0)
 ;A call to PRIO was removed from the following line D:$L($P(XQY0,U,8))
"RTN","XQ",26,0)
 ;Since Kernel no longer resets priority from the Option File
"RTN","XQ",27,0)
 I XQT'="M" W:'^XUTL("XQ",$J,"T") !,$P(XQY0,U,2) W:$D(DUZ("SAV")) !,"Not when testing another's menus." S %=^XUTL("XQ",$J,"T"),^("T")=%+1,^(%+1)=XQY_XQPSM_U_XQY0 G M3:XQT'?1U!$D(DUZ("SAV"))
"RTN","XQ",28,0)
 I XQT'="M" D:'$D(XQXFLG) ABT^XQ12 D:+XQXFLG ABLOG^XQ12 K %,X,XQTT G @(XQT_"^XQ1")
"RTN","XQ",29,0)
M1 ;
"RTN","XQ",30,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",31,0)
 Q:XQY<1!'$D(^XUTL("XQ",$J,"T"))  D:'$D(XQXFLG) ABT^XQ12
"RTN","XQ",32,0)
 D:'$D(XQABOLD)&(+XQXFLG) ABLOG^XQ12 K XQABOLD W ! S XQUR=0,XQTT=^XUTL("XQ",$J,"T"),XQDIC=XQY,XQAA="Select "_$S($D(DUZ("SAV")):$P(DUZ("SAV"),U,3)_"'s ",1:"")_$P(XQY0,U,2)_" Option: " S:$D(XQMM("B")) XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",33,0)
 S:$S('XQTT:1,1:+$P(^XUTL("XQ",$J,XQTT),U,1)'=XQY) ^("T")=XQTT+1,^(XQTT+1)=XQY_XQPSM_U_XQY0 I $D(DUZ("AUTO")),DUZ("AUTO"),'$D(XQMM("J")),'$D(XQMM("N")) G EN^XQ2
"RTN","XQ",34,0)
 K:'$D(XQMM("J")) XQMM("N")
"RTN","XQ",35,0)
M2 ;
"RTN","XQ",36,0)
 I '$D(XQMMF),$D(XQMM("J")) G ^XQ74
"RTN","XQ",37,0)
 Q:$D(XQALEXIT)&'$D(XQALMENU)  K XQMMF I $D(XQMM("A")) S XQAA=XQMM("A") K XQMM("A") I $D(XQMM("B")),$L(XQMM("B")) S XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",38,0)
 D DISPLAY^XQALERT,CHK^XM
"RTN","XQ",39,0)
 S:'$D(DTIME) DTIME=60
"RTN","XQ",40,0)
 ;
"RTN","XQ",41,0)
ASK ;Get user's response in XQUR
"RTN","XQ",42,0)
 W !,XQAA R XQUR:DTIME I '$T Q:$D(XQALEXIT)  W $C(7),"  Timed out...." G CON^XQTOC
"RTN","XQ",43,0)
 I $D(XQALEXIT),XQUR=""!(XQUR["^") Q
"RTN","XQ",44,0)
 ;
"RTN","XQ",45,0)
ASK1 D SETSV ;Set XQSV to remember where we started from (XQY^XQDIC^XQY0)
"RTN","XQ",46,0)
 K XQUIT
"RTN","XQ",47,0)
 I XQUR="*",$D(DUZ("SAV")) G TESTN^XUS91
"RTN","XQ",48,0)
 I $D(XQJS),XQJS,XQJS'>2 D SET^XQTOC G JUMP^XQ72 ;Continue, 3=[LOGIN
"RTN","XQ",49,0)
 I XQUR["[" G:'$D(DUZ("SAV")) ^XQT W !,"Not when testing another's menus!" S %=^XUTL("XQ",$J,"T")+1,^("T")=%,^(%)=XQY_XQPSM_U_XQY0 G M3
"RTN","XQ",50,0)
 I XQUR="" S:$D(XQMM("B")) XQUR=XQMM("B") K XQMM("B") G:$L(XQUR) D S XQABOLD=1 G M3:^XUTL("XQ",$J,"T")>1,XPRMP^XQ12
"RTN","XQ",51,0)
 I XQUR=U G M3
"RTN","XQ",52,0)
 ;$C(34) is ", which is a shortcut to XUCOMMAND
"RTN","XQ",53,0)
 I $E(XQUR)=$C(34),$L(XQUR)>1 S XQUR=$P(XQUR,$C(34),2) D P^XQ75 G:XQY'>0 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G JUMP^XQ72
"RTN","XQ",54,0)
 ;,XQY=-1 G:$L(XQUR) M0 S XQUR=$C(34)
"RTN","XQ",55,0)
D I XQUR["^^" G:XQUR="^^" R^XQ73 S XQRB=1 S XQUR=$P(XQUR,U,2,99)
"RTN","XQ",56,0)
 ;"^^" is GO HOME, return to the Primary Menu, "^^x" is a rubber band
"RTN","XQ",57,0)
 I XQUR[U S XQUR=$P(XQUR,U,2) G:'$L(XQUR) NOFIND D S^XQ75 G D:'XQY,NOFIND:XQY<0 K XQAA S XQY=+XQY,XQCH=XQUR G:$D(XQRB) ^XQ73 G JUMP^XQ72
"RTN","XQ",58,0)
D0 G:XQUR'?1"?"1AN.ANP D1 D OPT^XQHLP G ASK
"RTN","XQ",59,0)
D1 G EN^XQ2:XQUR?."?"!(XQUR'?.ANP) D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM=$S(XQPSM=("U"_DUZ):XQPSM_",P"_XQDIC,XQPSM[",":XQPSM,XQDIC>0:XQPSM,1:"P"_XQDIC)
"RTN","XQ",60,0)
 I XQY=-1,$O(^VA(200,DUZ,203,0))>0 S XQDIC="U"_DUZ D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="U"_DUZ_",P"_XQY
"RTN","XQ",61,0)
M0 I XQY=-1 S XQDIC=$O(^DIC(19,"B","XUCOMMAND",0)) S:XQDIC="" XQDIC=-1 D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="PXU" I XQY=-1 G M3:XQUR="HALT",NOFIND
"RTN","XQ",62,0)
 G:XQY=-2 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G M
"RTN","XQ",63,0)
 ;
"RTN","XQ",64,0)
NOFIND ;Could not find the option requested, go back and try again
"RTN","XQ",65,0)
 W:XQY=-1 "  ??" S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),XQY0=$P(%,U,2,999),XQY=+$P(%,U,1) K XQJS,XQR G M1
"RTN","XQ",66,0)
 ;
"RTN","XQ",67,0)
M3 I $P(XQY0,U,15),$D(^DIC(19,+XQY,15)),$L(^(15)) X ^(15) ;W "  ==> XQ+47"
"RTN","XQ",68,0)
 S %=^XUTL("XQ",$J,"T")-1,^("T")=% G H^XUS:(%'>0) S %=^XUTL("XQ",$J,%),XQY0=$P(%,U,2,999),XQPSM=$P(%,U,1),XQY=+XQPSM,XQPSM=$P(XQPSM,XQY,2,99),XQM3="" I +XQY<0 D RBX^XQ73
"RTN","XQ",69,0)
 G M
"RTN","XQ",70,0)
 ;
"RTN","XQ",71,0)
LO I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,+XQY,20)),$L(^(20)) X ^(20) ;W " ==> LO^XQ"
"RTN","XQ",72,0)
 ;I $D(^XUTL("XQ",$J,"P")) S X=^("P") K ^("P") X ^%ZOSF("PRIORITY")
"RTN","XQ",73,0)
 Q
"RTN","XQ",74,0)
 ;
"RTN","XQ",75,0)
SETSV ;Record where we are now for posterity in XQSV
"RTN","XQ",76,0)
 N %
"RTN","XQ",77,0)
 S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T"))
"RTN","XQ",78,0)
 S XQSV=""
"RTN","XQ",79,0)
 S $P(XQSV,U)=+%
"RTN","XQ",80,0)
 S $P(XQSV,U,2)=$S($P(%,U)["PXU":$O(^DIC(19,"B","XUCOMMAND",0)),1:$P($P(%,U),"P",2)) I $P(XQSV,U,2)="" S $P(XQSV,U,2)=XQY
"RTN","XQ",81,0)
 S $P(XQSV,U,3)=$P(%,U,2,99)
"RTN","XQ",82,0)
 Q
"RTN","XQ",83,0)
 ;
"RTN","XQ",84,0)
PRIO ;This subroutine is no longer used.  Kernel no longer resets priority.
"RTN","XQ",85,0)
 ;S Y=10 X:$D(^%ZOSF("PRIINQ")) ^("PRIINQ") S ^XUTL("XQ",$J,"P")=Y,X=$P(XQY0,U,8) X ^%ZOSF("PRIORITY")
"RTN","XQ",86,0)
 Q
"RTN","XQ12")
0^1^B48280597
"RTN","XQ12",1,0)
XQ12 ;SEA/LUKE - MENU MANAGER UTILITIES ;04/16/2002  13:56
"RTN","XQ12",2,0)
 ;;8.0;KERNEL;**9,20,46,157**;Jul 10, 1995
"RTN","XQ12",3,0)
 ;
"RTN","XQ12",4,0)
DVARS ;Set up (or reset) necessary variables. From ^XQ1 and ^XQT1.
"RTN","XQ12",5,0)
 S U="^" I '$D(DUZ)#2 S DUZ=^XUTL("XQ",$J,"DUZ")
"RTN","XQ12",6,0)
 S:'$D(DUZ(0))#2 DUZ(0)="" I DUZ(0)="" S:$D(^VA(200,DUZ,0)) DUZ(0)=$P(^(0),U,4)
"RTN","XQ12",7,0)
 I '$D(DT) D ^XQDATE S DT=$P(%,".")
"RTN","XQ12",8,0)
 I '$D(DUZ("AG")),$D(^XTV(8989.3,1,0)) S DUZ("AG")=$P(^(0),U,8)
"RTN","XQ12",9,0)
 I '$D(IOS) S IOS=$S($D(^XUTL("XQ",$J,"IOS"))#2:^("IOS"),1:"")
"RTN","XQ12",10,0)
 I '$D(DTIME) S DTIME=$$DTIME^XUP(DUZ,IOS)
"RTN","XQ12",11,0)
 I '$D(DUZ("AUTO")) S I=$S($D(^VA(200,DUZ,200)):$P(^(200),U,6),1:"") S:'$L(I) I=$S($D(^%ZIS(1,$I,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=$S($D(^XTV(8989.3,1,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=1 S DUZ("AUTO")=I
"RTN","XQ12",12,0)
 Q
"RTN","XQ12",13,0)
 ;
"RTN","XQ12",14,0)
INIT ;Entry for new logon, called from the top of ^XQ and ^XQ1
"RTN","XQ12",15,0)
 K DIC,Y Q:$D(DUZ)[0  Q:'$D(^VA(200,DUZ,0))
"RTN","XQ12",16,0)
 ;S:'$D(XQY) XQY=^VA(200,DUZ,201)
"RTN","XQ12",17,0)
 I '$D(XQUSER) S XQUSER=$P($P(^VA(200,DUZ,0),U),",",2)_" "_$P($P(^(0),U),",")
"RTN","XQ12",18,0)
 ;
"RTN","XQ12",19,0)
 ;Select device tied option, primary menu, or primary window
"RTN","XQ12",20,0)
 ;
"RTN","XQ12",21,0)
 S:'$D(XQY) XQY=""
"RTN","XQ12",22,0)
 S %=$G(^VA(200,DUZ,201)),^XUTL("XQ",$J,"XQM")=+%,^("XQW")=$P(%,"^",2)
"RTN","XQ12",23,0)
 D:'$D(IO) HOME^%ZIS
"RTN","XQ12",24,0)
 I IO]"" S %=$G(^%ZIS(1,IO,201)) I %]"" S XQY=%
"RTN","XQ12",25,0)
 I XQY']"" D
"RTN","XQ12",26,0)
 .S %=$G(^VA(200,DUZ,201))
"RTN","XQ12",27,0)
 .S XQPM=$P(%,U),XQPW=$P(%,U,2),XQSD=$P(%,U,3)
"RTN","XQ12",28,0)
 .I XQPW']"" S XQY=XQPM Q
"RTN","XQ12",29,0)
 .I XQSD="M" S XQY=XQPM
"RTN","XQ12",30,0)
 .E  S XQY=XQPW
"RTN","XQ12",31,0)
 .Q
"RTN","XQ12",32,0)
 ;
"RTN","XQ12",33,0)
 D SET^XQCHK
"RTN","XQ12",34,0)
 S ^XUTL("XQ",$J,1)=XQY_"P"_XQY_"^"_XQY0,^("T")=1
"RTN","XQ12",35,0)
 S XQDIC=XQY,XQPSM="P"_XQY
"RTN","XQ12",36,0)
 ;
"RTN","XQ12",37,0)
 ;D MERGE,MGPXU,MGSEC ;get the menu trees this user will need to jump
"RTN","XQ12",38,0)
 ;
"RTN","XQ12",39,0)
 ;Fire LOGIN menu template if they have one and its the first login
"RTN","XQ12",40,0)
 ;of the day.  XQXFLG("LLOG") is copy of ^VA(200,DUZ,1.1) before it's
"RTN","XQ12",41,0)
 ;updated at XUS1+47
"RTN","XQ12",42,0)
 I $D(^VA(200,DUZ,19.8,"B","LOGIN")) D
"RTN","XQ12",43,0)
 .Q:'$D(XQXFLG("LLOG"))
"RTN","XQ12",44,0)
 .S XQLAST=$P($P(XQXFLG("LLOG"),U),".") ;Get last login DT
"RTN","XQ12",45,0)
 .Q:+XQLAST<1
"RTN","XQ12",46,0)
 .I XQLAST<DT S XQUR="[LOGIN",XQJS=3
"RTN","XQ12",47,0)
 .K XQLAST
"RTN","XQ12",48,0)
 .Q
"RTN","XQ12",49,0)
 K XQXFLG("LLOG")
"RTN","XQ12",50,0)
 ;
"RTN","XQ12",51,0)
UI ;Entry for TaskMan (DUZ may =  0), from ZTSK^XQ1
"RTN","XQ12",52,0)
 D DVARS I '$D(^XUTL("XQ",$J,0)) D ^XQDATE S ^XUTL("XQ",$J,0)=%_U_%Y
"RTN","XQ12",53,0)
 S:'$D(XQDIC) XQDIC="P"_XQY
"RTN","XQ12",54,0)
 S:'$D(XQPSM) XQPSM="P"_XQY
"RTN","XQ12",55,0)
 S:'$D(XQJS)&'$D(ZTQUEUED) XQY0=^DIC(19,XQY,0),^XUTL("XQ",$J,"T")=0,^("DUZ")=DUZ,^("XQM")=XQY,XQPSM="P"_XQY
"RTN","XQ12",56,0)
 S XQCY=XQY D ^XQCHK I XQCY<1 D
"RTN","XQ12",57,0)
 .S XQPRMN=1,XQL=0
"RTN","XQ12",58,0)
 .D:'$D(ZTQUEUED) MES^XQCHK,PAUSE^XQ6
"RTN","XQ12",59,0)
 .;G:'$D(ZTQUEUED) ^XUSCLEAN S XQY=-1
"RTN","XQ12",60,0)
 .S XQY=-1
"RTN","XQ12",61,0)
 .Q
"RTN","XQ12",62,0)
 S XQM3="" I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,XQY,20)),$L(^(20)) X ^(20) ;W "  ==> XQ12+59"
"RTN","XQ12",63,0)
 ;I $D(XQUIT),'$D(ZTQUEUED) S XQL=0 W !!,"The variable XQUIT was encountered in the Entry Action of your Primary Menu." D PAUSE^XQ6 S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",64,0)
 I $D(XQUIT),'$D(ZTQUEUED) D PM^XQUIT I $D(XQUIT) S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",65,0)
 ;I $P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ12",66,0)
ABT ;WARNING: XQXFLG is also used by OERR test sites.
"RTN","XQ12",67,0)
 S U="^"
"RTN","XQ12",68,0)
 S $P(XQXFLG,U)=$S($O(^XTV(8989.3,1,"ABPKG",0))>0:1,1:0)
"RTN","XQ12",69,0)
CMP S $P(XQXFLG,U,2)=$S('$D(^XTV(8989.3,1,"XUCP")):0,1:^("XUCP")="Y")
"RTN","XQ12",70,0)
 K %,%Y,PGM,X,XQCY,XQPM,XQPW,XQSD
"RTN","XQ12",71,0)
 Q
"RTN","XQ12",72,0)
 ;
"RTN","XQ12",73,0)
 ;
"RTN","XQ12",74,0)
MERGE ;Merge in the menu trees that this user needs, start with Primary Menu
"RTN","XQ12",75,0)
 Q:'$D(^DIC(19,"AXQ",XQPSM))
"RTN","XQ12",76,0)
 Q:$D(^XUTL("XQM",XQPSM))  ;It's already being done
"RTN","XQ12",77,0)
 ;
"RTN","XQ12",78,0)
 L +^DIC(19,"AXQ",XQPSM):0 Q:'$T
"RTN","XQ12",79,0)
 S ^XUTL("XQM",XQPSM)=$H
"RTN","XQ12",80,0)
 ;
"RTN","XQ12",81,0)
 M ^XUTL("XQO",XQPSM)=^DIC(19,"AXQ",XQPSM)
"RTN","XQ12",82,0)
 ;
"RTN","XQ12",83,0)
 L -^DIC(19,"AXQ",XQPSM)
"RTN","XQ12",84,0)
 K ^XUTL("XQM",XQPSM)
"RTN","XQ12",85,0)
 Q
"RTN","XQ12",86,0)
 ;
"RTN","XQ12",87,0)
MGPXU ;Check for XUCOMMAND
"RTN","XQ12",88,0)
 Q:'$D(^DIC(19,"AXQ","PXU"))
"RTN","XQ12",89,0)
 Q:$D(^XUTL("XQM","PXU"))  ;Already being merged
"RTN","XQ12",90,0)
 ;
"RTN","XQ12",91,0)
 L +^DIC(19,"AXQ","PXU"):0 Q:'$T
"RTN","XQ12",92,0)
 S ^XUTL("XQM","PXU")=$H
"RTN","XQ12",93,0)
 ;
"RTN","XQ12",94,0)
 M ^XUTL("XQO","PXU")=^DIC(19,"AXQ","PXU")
"RTN","XQ12",95,0)
 ;
"RTN","XQ12",96,0)
 L -^DIC(19,"AXQ","PXU")
"RTN","XQ12",97,0)
 K ^XUTL("XQM","PXU")
"RTN","XQ12",98,0)
 Q
"RTN","XQ12",99,0)
 ;
"RTN","XQ12",100,0)
MGSEC ;Now the Secondary Menu trees
"RTN","XQ12",101,0)
 N %,%1
"RTN","XQ12",102,0)
 F %=0:0 S %=$O(^VA(200,DUZ,203,"B",%)) Q:%'=+%  D
"RTN","XQ12",103,0)
 .S %1="P"_%
"RTN","XQ12",104,0)
 .I '$D(^XUTL("XQO",%1)),$D(^DIC(19,"AXQ",%1)) D
"RTN","XQ12",105,0)
 ..Q:$D(^XUTL("XQM",%1))  ;Already merging as we speak
"RTN","XQ12",106,0)
 ..S ^XUTL("XQM",%1)=$H
"RTN","XQ12",107,0)
 ..L +^DIC(19,"AXQ",%1):0 Q:'$T
"RTN","XQ12",108,0)
 ..I '$D(^XUTL("XQO",%1)) M ^XUTL("XQO",%1)=^DIC(19,"AXQ",%1)
"RTN","XQ12",109,0)
 ..L -^DIC(19,"AXQ",%1)
"RTN","XQ12",110,0)
 ..K ^XUTL("XQM",%1)
"RTN","XQ12",111,0)
 ..Q
"RTN","XQ12",112,0)
 .Q
"RTN","XQ12",113,0)
 Q
"RTN","XQ12",114,0)
 ;
"RTN","XQ12",115,0)
 ;
"RTN","XQ12",116,0)
LOGOPT ;Option audit
"RTN","XQ12",117,0)
 S:'$D(XQLTL) XQLTL=""
"RTN","XQ12",118,0)
 S %=$P($H,",",2),%=DT_(%\60#60/100+(%\3600)+(%#60/10000)/100)
"RTN","XQ12",119,0)
 I XQLTL S $P(^XUSEC(19,XQLTL,0),U,5)=%,XQLTL=0
"RTN","XQ12",120,0)
 S I=1 I XQAUDIT'=1 S I=0 F J=1:2 S K1=$P(XQAUDIT,U,J),K2=$P(XQAUDIT,U,J+1) Q:'$L(K1)!I  I K1=2&(K2=XQY)!(K1=3&($E($P(XQY0,U,1),1,$L(K2))=K2)) S I=1
"RTN","XQ12",121,0)
 Q:'I  S XQLTL=% L +^XUSEC(19,0):0 S %=^XUSEC(19,0),XQLTL=XQLTL+(.00000001*$S(XQLTL'=$E($P(%,U,3),1,14):10,1:$E($P(%,U,3),15,16)+1)),$P(^(0),U,3,4)=XQLTL_"^"_($P(%,U,4)+1) L -^XUSEC(19,0)
"RTN","XQ12",122,0)
 D GETENV^%ZOSV S XUVOL=$P(Y,U,2),^XUSEC(19,XQLTL,0)=XQY_U_DUZ_U_$I_U_$J_"^^"_XUVOL
"RTN","XQ12",123,0)
 K K1,K2
"RTN","XQ12",124,0)
 Q
"RTN","XQ12",125,0)
XPRMP D CHK^XM W !!,"Do you really want to ",$S(XQUR="REST":"restart",1:"halt"),"? YES// " R X:10 S:'$L(X) X="Y"
"RTN","XQ12",126,0)
 I "Yy"'[$E(X) S Y=1 S:^XUTL("XQ",$J,"T")>1 Y=^("T")-1 S ^("T")=Y,Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_" Option: " W ! G ASK^XQ
"RTN","XQ12",127,0)
 G REST:XQUR="REST",HALT:XQUR'="CON"
"RTN","XQ12",128,0)
 ;
"RTN","XQ12",129,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQ12",130,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQ12",131,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQ12",132,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_" Option: " G ASK^XQ
"RTN","XQ12",133,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQ12",134,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQ12",135,0)
 W !!,$P("HMM^OK^ALL RIGHT^WELL CERTAINLY^FINE","^",$R(5)+1),"... ",$P("SEE YOU LATER^I'LL BE READY WHEN YOU ARE.^HURRY BACK!^HAVE A GOOD LUNCH BREAK!","^",$R(3)+X+1)
"RTN","XQ12",136,0)
HALT ;
"RTN","XQ12",137,0)
 G H^XUS
"RTN","XQ12",138,0)
REST S XQNOHALT=1 D ^XUSCLEAN G ^XUS
"RTN","XQ12",139,0)
 ;
"RTN","XQ12",140,0)
SS ;Search Secondaries for a particuloar option.
"RTN","XQ12",141,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQ12",142,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQ12",143,0)
 Q
"RTN","XQ12",144,0)
ABLOG S %2=0 F %3=0:0 S %2=$O(^XTV(8989.3,1,"ABPKG",%2)) Q:%2'>0  F %=0:0 S %=$O(^XTV(8989.3,1,"ABPKG",%2,1,%)) Q:%'>0  S %1=$P(^(%,0),U) I $E(XQY0,1,$L(%1))=%1,$E(XQY0,$L(%1)+1)'="Z" D ABLOG1
"RTN","XQ12",145,0)
 K %,%1,%2,%3,%4
"RTN","XQ12",146,0)
 Q
"RTN","XQ12",147,0)
ABLOG1 F %4=0:0 S %4=$O(^XTV(8989.3,1,"ABPKG",%2,1,%,1,%4)) Q:%4'>0  S %1=$P(^(%4,0),U) I $E(XQY0,1,$L(%1))=%1 Q
"RTN","XQ12",148,0)
 I %4'>0 S:'$D(^XTV(8989.3,1,"ABOPT",0)) ^(0)="^8989.333P^" S:'$D(^(XQY)) %4=+$P(^(0),U,3),$P(^(0),U,3,4)=$S(XQY>%4:XQY,1:%4)_U_($P(^(0),U,4)+1) S ^(0)=XQY_U_($S($D(^(XQY,0)):$P(^(0),U,2),1:0)+1),%2="A"
"RTN","XQ12",149,0)
 Q
"RTN","XQ71")
0^18^B18790192
"RTN","XQ71",1,0)
XQ71 ;SEA/AMF,MJM - Lookup response to menu prompt ;04/16/2002  13:47
"RTN","XQ71",2,0)
 ;;8.0;KERNEL;**154,157**;Jul 10, 1995
"RTN","XQ71",3,0)
CHK ;See if this option is locked, out of order, etc.
"RTN","XQ71",4,0)
 S XQJMP=0,XQA=1,XQCY=XQY S:'$D(XQNOXUTL) XQCY0=XQY0 D ^XQCHK I XQCY<0 S XQY=-1
"RTN","XQ71",5,0)
 Q
"RTN","XQ71",6,0)
NO ;Space bar option no longer in the Option File
"RTN","XQ71",7,0)
 K ^DISV(DUZ,"XQ",XQMN) S XQY=-1
"RTN","XQ71",8,0)
 ;
"RTN","XQ71",9,0)
OUT ;Exit point: return to XQ
"RTN","XQ71",10,0)
 K %,%Y,%XQ,XQ,XQ2,XQA,XQA3,XQCY,XQCY0,XQI,XQII,XQIO,XQJ,XQK,XQMN,XQNOAV,XQNOXUTL,XQQ,XQS,XQSAV,XQW,XQX,XQZ
"RTN","XQ71",11,0)
 Q
"RTN","XQ71",12,0)
 ;
"RTN","XQ71",13,0)
U I XQX'?.ANP S XQX="?" Q
"RTN","XQ71",14,0)
 ;
"RTN","XQ71",15,0)
UP S XQX=$$UP^XLFSTR(XQX) ;F XQZ=1:1 Q:XQX?.NUP  S XQW=$A(XQX,XQZ) I XQW<123,XQW>96 S XQX=$E(XQX,1,XQZ-1)_$C(XQW-32)_$E(XQX,XQZ+1,255)
"RTN","XQ71",16,0)
 Q
"RTN","XQ71",17,0)
 ;
"RTN","XQ71",18,0)
XBLK F  S XQW=$E(XQK,1) Q:XQW'=" "  S XQK=$E(XQK,2,99)
"RTN","XQ71",19,0)
 Q
"RTN","XQ71",20,0)
 ;
"RTN","XQ71",21,0)
DIC ;Entry point from XQ
"RTN","XQ71",22,0)
 S XQNOAV=0,XQUR=$E(XQUR,1,27),XQMN=XQDIC,XQX=XQUR D U:XQX'?.PUN S XQUR=XQX
"RTN","XQ71",23,0)
 I XQX=" ",$D(^DISV(DUZ,"XQ",XQMN)) S XQY=^(XQMN) G:'($D(^XUTL("XQO",XQDIC,U,XQY))&$D(^DIC(19,XQY,0))) NO S XQY0=^(0),XQNOXUTL="" D CHK W:$L($P(XQY,U,2)) !,$P(XQY,U,2) S XQY=+XQY I XQY>0 S XQUR="" G W
"RTN","XQ71",24,0)
 I XQY=-1,$D(XQNOXUTL) K ^DISV(DUZ,"XQ",XQMN),XQNOXUTL S XQY=-2 G OUT
"RTN","XQ71",25,0)
 I $E(XQDIC,1)="P" S XQDIC=$E(XQDIC,2,99) ;Remove the "P" this is not a jump
"RTN","XQ71",26,0)
 ;I $S($D(^XUTL("XQO","P0")):1,'$D(^XUTL("XQO",XQDIC,0)):1,'$D(^DIC(19,$E(XQDIC,2,99),99.1)):1,1:0) D PMO^XQ8 S XQY=-2 G OUT
"RTN","XQ71",27,0)
 I XQDIC=+XQDIC L +^XUTL("XQO",XQDIC):5 D:$S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^DIC(19,XQDIC,99)):1,1:^DIC(19,XQDIC,99)'=$P(^XUTL("XQO",XQDIC,0),U,2)) ^XQSET L -^XUTL("XQO",XQDIC)
"RTN","XQ71",28,0)
 I $E(XQDIC,1)="U" D:$S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,DUZ,203.1)):1,1:^VA(200,DUZ,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) ^XQSET
"RTN","XQ71",29,0)
 S (XQ,XQS)=0 S:XQUR="0" XQUR="0"_$C(1) I XQUR="?" S X=0 G X
"RTN","XQ71",30,0)
 S X=XQUR,XQA3=$S(($E(XQDIC,1)="P"):XQUR_U,1:XQUR) G:'$D(^XUTL("XQO",XQDIC,XQA3)) X S X=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z" G:($P($O(^XUTL("XQO",XQDIC,XQA3)),U,1)=XQUR) X
"RTN","XQ71",31,0)
 S XQSAV=X
"RTN","XQ71",32,0)
 S %XQ=^XUTL("XQO",XQDIC,XQA3),XQY=+%XQ,XQY0=$P(^("^",XQY),U,2,99) D CHK S X=XQSAV W:$L($P(XQY,U,2)) "  ",$P(XQY0,U,2),$C(7),!,$P(XQY,U,2) S:$L($P(XQY,U,2)) XQNOAV=1 S:XQY<1 X=$O(^XUTL("XQO",XQDIC,X)) G X:XQY<1 I '$P(%XQ,U,2) W "  " S XQUR=""
"RTN","XQ71",33,0)
 ;
"RTN","XQ71",34,0)
W W $E($P(XQY0,U,2),$L(XQUR)+1,99) K XQ S:(XQMN=+XQMN) ^DISV(DUZ,"XQ",XQMN)=XQY G OUT
"RTN","XQ71",35,0)
 ;
"RTN","XQ71",36,0)
X S X=$O(^XUTL("XQO",XQDIC,X)) S XQJ=$S(X="":0,XQUR="?":X'=U,XQUR=("0"_$C(1)):'$L($P(X,"0",1)),1:'$L($P(X,XQUR,1)))
"RTN","XQ71",37,0)
 I XQJ S XQY=^XUTL("XQO",XQDIC,X) S:'$P(XQY,U,2) XQ("S",+XQY)="" S XQY=+XQY G:$D(XQ("X",XQY)) X S XQY0=$P(^("^",XQY),U,2,99) S XQQ=X D CHK S X=XQQ G:XQY'>0 X S XQ=XQ+1,XQ(XQ)=+XQY_U_$P(XQY0,U,2)_U_XQA_U_$P(XQY,U,2),XQ("X",XQY)="" G:XQ>19 C G X
"RTN","XQ71",38,0)
 S:'XQ XQY=-1 S:XQNOAV XQY=-2 Q:'XQ  I XQ=1,XQS=0 S XQY=+XQ(1) I XQY>0 S XQY0=$P(^XUTL("XQO",XQDIC,"^",XQY),U,2,99),XQA=$P(XQ(1),U,3) S:$D(XQ("S",XQY)) XQUR="" W:'$L(XQUR) "  " G W
"RTN","XQ71",39,0)
 I XQ=1,XQS=0 W $E($P(XQ(1),U,2),$L(XQUR)+1,99),$C(7),!,$P(XQ(1),U,4) S XQY=-2 G OUT
"RTN","XQ71",40,0)
 ;
"RTN","XQ71",41,0)
C F XQY=1:1:XQ W !?4,XQS*20+XQY,?9,$P(XQ(XQY),U,2),?43,$P(XQ(XQY),U,4)
"RTN","XQ71",42,0)
 W:XQ>19 !,"TYPE '^' TO STOP, OR" W !,"CHOOSE ",(XQS*20+1),"-",(XQS*20+XQY),": "
"RTN","XQ71",43,0)
 R XQJ:DTIME S:'$T XQJ=U G:$L(XQJ)>7 C I XQJ?1.7N G C:'$D(XQ(XQJ-1#20+1)) W "  " S XQUR="",XQY=+XQ(XQJ-1#20+1) I XQY>0 S XQY0=$P(^XUTL("XQO",XQDIC,"^",XQY),U,2,99),XQA=$P(XQ(XQJ-1#20+1),U,3) G W
"RTN","XQ71",44,0)
 I XQJ?1.7N W $C(7),$P(XQ(XQJ-1#20+1),U,4),! G C
"RTN","XQ71",45,0)
 I $L(XQJ)>7 G C
"RTN","XQ71",46,0)
 I '$L(XQJ),XQ>19 K XQ S XQS=XQS+1,XQ=0 G X
"RTN","XQ71",47,0)
 S:XQJ=U XQJ="" K XQ S XQY=-1,XQUR=$C(95) S:$L(XQJ) XQUR=$S($E(XQDIC,1)="P":U_XQJ,1:XQJ),XQY=0 G OUT
"RTN","XQ71",48,0)
 Q
"RTN","XQ72")
0^17^B38288578
"RTN","XQ72",1,0)
XQ72 ;SEA/MJM - ^Jump Utilities ;04/16/2002  14:02
"RTN","XQ72",2,0)
 ;;8.0;KERNEL;**47,46,157**;Jul 10, 1995
"RTN","XQ72",3,0)
 ;
"RTN","XQ72",4,0)
JUMP ;Entry point for D+1^XQ and  LEGAL^XQ74.
"RTN","XQ72",5,0)
 ;With +XQY: target opt, XQY0: 0th node with pathway, XQY1: parent's
"RTN","XQ72",6,0)
 ;0th node; XQ(XQ) array of alternate pathways, if any; XQDIC:
"RTN","XQ72",7,0)
 ;P-tree of target option; XQPSM: XQDIC or mutiple trees (U66,P258)
"RTN","XQ72",8,0)
 ;XQSV: XQY^XQDIC^XQY0 of origin (previous) option.
"RTN","XQ72",9,0)
 ;
"RTN","XQ72",10,0)
 ;** Variables **
"RTN","XQ72",11,0)
 ;XQFLAG=1 usually means we're done.  Head for the door.
"RTN","XQ72",12,0)
 S XQJMP=1 ;Flag indicating we are in a jump process
"RTN","XQ72",13,0)
 N XQFLAG,XQI,XQJ,XQTT,XQSTK,XQSVSTK,XQONSTK,XQOLDSTK
"RTN","XQ72",14,0)
 ;
"RTN","XQ72",15,0)
 ;Get current stack pointer and Primary Menu tree, set "all done" flag
"RTN","XQ72",16,0)
 S XQTT=^XUTL("XQ",$J,"T"),XQPMEN="P"_^("XQM")
"RTN","XQ72",17,0)
 ;
"RTN","XQ72",18,0)
 ;If we are already in a rubber-band jump, unwind it
"RTN","XQ72",19,0)
 I $D(^XUTL("XQ",$J,"RBX")) S XQFLG=1,XQSAV=XQY_U_XQPSM_U_XQY0,XQY=+^("RBX"),XQY0=$P(^("RBX"),U,2,99) D RBX^XQ73 S XQY=+XQSAV,XQPSM=$P(XQSAV,U,2),XQY0=$P(XQSAV,U,3,99) K XQFLG,XQSAV
"RTN","XQ72",20,0)
 ;
"RTN","XQ72",21,0)
 ;Get the stack and see if target option is already on it
"RTN","XQ72",22,0)
 S XQSTK=""
"RTN","XQ72",23,0)
 F XQI=1:1:XQTT S XQOLDSTK(XQI)=^XUTL("XQ",$J,XQI),XQSTK=XQSTK_+XQOLDSTK(XQI)_","
"RTN","XQ72",24,0)
 ;
"RTN","XQ72",25,0)
 I (","_XQSTK)[(","_XQY_","),'$D(XQRB) D NOJ^XQ72A G OUT
"RTN","XQ72",26,0)
 ;
"RTN","XQ72",27,0)
 ;See if target option is in the current display tree (+XQDISTR)
"RTN","XQ72",28,0)
 S XQDISTR=+XQSV
"RTN","XQ72",29,0)
 I $S('$D(^XUTL("XQO",XQDISTR,0)):1,'$D(^DIC(19,XQDISTR,99)):1,^DIC(19,XQDISTR,99)'=$P(^XUTL("XQO",XQDISTR,0),U,2):1,1:0) L +^XUTL("XQO",XQDISTR):5 S XQSAVE=XQDIC,XQDIC=XQDISTR D ^XQSET L -^XUTL("XQO",XQDISTR) S XQDIC=XQSAVE
"RTN","XQ72",30,0)
 I $D(^XUTL("XQO",XQDISTR,"^",+XQY)),($P(^(+XQY),U,6)=+XQY!($P(^(+XQY),U,6)="")) S XQY0=$P(^(+XQY),U,2,99),^DISV(DUZ,"XQ",XQDISTR)=XQY G OUT
"RTN","XQ72",31,0)
 ;
"RTN","XQ72",32,0)
 ;Set XQMA to the parent of the tree we're jumping from
"RTN","XQ72",33,0)
 S XQMA=$P(XQSV,U,2)
"RTN","XQ72",34,0)
 I XQMA']"" S XQMA=XQY
"RTN","XQ72",35,0)
 ;
"RTN","XQ72",36,0)
 ;Find shortest path to target if there are more than one in XQ(XQ)
"RTN","XQ72",37,0)
 I $D(XQ),XQ>0 D MPW G:XQ<0 OUT
"RTN","XQ72",38,0)
 ;
"RTN","XQ72",39,0)
 ;Get jump path and add parent menu option.
"RTN","XQ72",40,0)
 S XQJP=$P(XQY0,U,5)
"RTN","XQ72",41,0)
 I XQPSM["PXU" S %=0,%=$O(^DIC(19,"B","XUCOMMAND",%)),XQJP=%_","_XQJP
"RTN","XQ72",42,0)
 I XQPSM["," S %=$P(XQPSM,",",2),XQJP=$P(%,"P",2)_","_XQJP
"RTN","XQ72",43,0)
 S XQNP=XQTT_U_XQJP
"RTN","XQ72",44,0)
 ;
"RTN","XQ72",45,0)
 ;Save stack as it was before we messed with it.
"RTN","XQ72",46,0)
 S XQSVSTK=XQTT_U_XQSTK
"RTN","XQ72",47,0)
 S XQONSTK="" ;Those options we put on the stack are collected here.
"RTN","XQ72",48,0)
 ;
"RTN","XQ72",49,0)
 ;
"RTN","XQ72",50,0)
 ;** BEGIN PROCESSING PRIMARY AND SECONDARY JUMPS **
"RTN","XQ72",51,0)
 ;
"RTN","XQ72",52,0)
 S XQNOW=^XUTL("XQ",$J,XQTT)
"RTN","XQ72",53,0)
 ;
"RTN","XQ72",54,0)
 ;See if we are jumping FROM a Secondary menu tree
"RTN","XQ72",55,0)
 S XQFLAG=0
"RTN","XQ72",56,0)
 S XQSFROM=$S($P(XQNOW,U)["U":1,1:0)
"RTN","XQ72",57,0)
 I XQSFROM D
"RTN","XQ72",58,0)
 .N %,XQI,XQT,XQDIC
"RTN","XQ72",59,0)
 .S XQT=XQTT
"RTN","XQ72",60,0)
 .S XQDIC=XQPSM I XQDIC["," S XQDIC=$P(XQDIC,",",2)
"RTN","XQ72",61,0)
 .I $D(^XUTL("XQO",XQDIC,U,+XQSV)) S XQFLAG=1 D SAMTREE Q  ;target in current tree.
"RTN","XQ72",62,0)
 .F XQI=XQT:-1:1 S %=$P(^XUTL("XQ",$J,XQI),U,1) Q:%'[","&(%'["PXU")  D POP(XQI) ;Remove current secondary from the stack
"RTN","XQ72",63,0)
 .Q
"RTN","XQ72",64,0)
 G:XQFLAG B1
"RTN","XQ72",65,0)
 ;
"RTN","XQ72",66,0)
 ;See if we're staying in the Primary Menu's tree
"RTN","XQ72",67,0)
 S XQFLAG=0
"RTN","XQ72",68,0)
 I $D(^XUTL("XQO",XQPMEN,U,XQY)) D
"RTN","XQ72",69,0)
 .S XQJP=XQMA_","_XQJP
"RTN","XQ72",70,0)
 .S XQFLAG=1
"RTN","XQ72",71,0)
 .D:XQTT>1 SAMTREE
"RTN","XQ72",72,0)
 .Q
"RTN","XQ72",73,0)
 G:XQFLAG B1
"RTN","XQ72",74,0)
 ;
"RTN","XQ72",75,0)
 ;See if we are jumping TO a secondary menu: just load and go.
"RTN","XQ72",76,0)
 S XQSTO=0
"RTN","XQ72",77,0)
 S XQFLAG=0
"RTN","XQ72",78,0)
 I XQPSM["U" D
"RTN","XQ72",79,0)
 .S XQSTO=1
"RTN","XQ72",80,0)
 .S XQFLAG=1
"RTN","XQ72",81,0)
 .I XQPSM["," S XQDIC=$P(XQPSM,",",2)
"RTN","XQ72",82,0)
 .S (^XUTL("XQ",$J,"T"),XQST)=XQTT
"RTN","XQ72",83,0)
 .Q
"RTN","XQ72",84,0)
 ;
"RTN","XQ72",85,0)
 ;
"RTN","XQ72",86,0)
 ;
"RTN","XQ72",87,0)
B1 ;Get the path of options and process them one by one
"RTN","XQ72",88,0)
 S XQZ=$P(XQNP,U,2) I '$L(XQZ) S XQTT=1 G OUT
"RTN","XQ72",89,0)
 I '$D(XQUIT) F XQSTPT=1:1 S XQD=$P(XQZ,",",XQSTPT) Q:(+XQD=+XQY)!('$L(XQD))  D JUMP1 I $D(XQUIT) S XQUIT=2 D ^XQUIT Q:$D(XQUIT)  D RXQ
"RTN","XQ72",90,0)
 ;
"RTN","XQ72",91,0)
 I '$D(XQUIT) D
"RTN","XQ72",92,0)
 .N %
"RTN","XQ72",93,0)
 .S ^DISV(DUZ,"XQ",XQMA)=XQY
"RTN","XQ72",94,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQ72",95,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQ72",96,0)
 .I %]"" S XQY0=$P(%,U,2,5)_"^^"_$P(%,U,7,11)_"^^"_$P(%,U,13)_"^^"_$P(%,U,15,99)
"RTN","XQ72",97,0)
 .E  S XQFAIL=""
"RTN","XQ72",98,0)
 .Q
"RTN","XQ72",99,0)
 I $D(XQFAIL) K XQFAIL S XQTT=1
"RTN","XQ72",100,0)
 ;
"RTN","XQ72",101,0)
 ;
"RTN","XQ72",102,0)
OUT ;Reset the stack pointer, clean up, and return to XQ
"RTN","XQ72",103,0)
 I '$D(XQTT) S XQTT=$G(^XUTL("XQ",$J,"T")) I XQTT="" S XQTT=1
"RTN","XQ72",104,0)
 S ^XUTL("XQ",$J,"T")=XQTT
"RTN","XQ72",105,0)
 ;
"RTN","XQ72",106,0)
 K %,%XQJP,X,XQ,XQCH,XQD,XQDISTR,XQEX,XQI,XQII,XQJ,XQJMP,XQJP,XQJS,XQK,XQMA,XQN,XQNO,XQNOW,XQNO1,XQNP,XQOLDSTK,XQPMEN,XQSAV,XQSTO,XQSFROM,XQST,XQSTK,XQSTPT,XQSVSTK,XQT,XQTT,XQV,XQW,XQY1,XQZ,Y,Z
"RTN","XQ72",107,0)
 ;
"RTN","XQ72",108,0)
 I $D(XQUIT) K XQUIT G M1^XQ
"RTN","XQ72",109,0)
 G M^XQ
"RTN","XQ72",110,0)
 ;
"RTN","XQ72",111,0)
 ;
"RTN","XQ72",112,0)
 ;** SUBROUTINES **
"RTN","XQ72",113,0)
 ;
"RTN","XQ72",114,0)
POP(XQSTPT) ;Pop one level on the stack
"RTN","XQ72",115,0)
 ;Execute Exit Actions and Headers
"RTN","XQ72",116,0)
 N %,XQY,XQY0
"RTN","XQ72",117,0)
 S %=^XUTL("XQ",$J,XQSTPT)
"RTN","XQ72",118,0)
 S XQY=+%,XQY0=$P(%,U,2,99)
"RTN","XQ72",119,0)
 I $P(XQY0,U,15),$D(^DIC(19,XQY,15)),$L(^(15)) X ^(15) ;W " ==> POP^XQ72"
"RTN","XQ72",120,0)
 S %=^XUTL("XQ",$J,XQSTPT-1)
"RTN","XQ72",121,0)
 S XQY=+%,XQY0=$P(%,U,2,99)
"RTN","XQ72",122,0)
 I $P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26) ;W " ==> POP^XQ72"
"RTN","XQ72",123,0)
 I '$D(XQTT) S XQTT=^XUTL("XQ",$J,"T")
"RTN","XQ72",124,0)
 S XQTT=XQTT-1 ;Reset stack pointer to next option
"RTN","XQ72",125,0)
 Q
"RTN","XQ72",126,0)
 ;
"RTN","XQ72",127,0)
JUMP1 ;Check pathway for prohibitions
"RTN","XQ72",128,0)
 ;Push intermediate option onto the stack
"RTN","XQ72",129,0)
 ;Execute Entry Actions and Headers
"RTN","XQ72",130,0)
 S XQST=+XQNP
"RTN","XQ72",131,0)
 S XQY0=$S($D(^XUTL("XQO",XQMA,U,+XQD))#2:$P(^(+XQD),U,2,99),1:^DIC(19,+XQD,0)),XQMA=XQD
"RTN","XQ72",132,0)
 S ^XUTL("XQ",$J,XQTT+1)=XQD_XQPSM_U_XQY0 ;,^("T")=XQST+XQSTPT
"RTN","XQ72",133,0)
 I $P(XQY0,U,14) Q:'$D(^DIC(19,XQD,20))  Q:'$L(^(20))  X ^(20) ;W " ==> JUMP1^XQ72"
"RTN","XQ72",134,0)
 Q:$D(XQUIT)
"RTN","XQ72",135,0)
 ;
"RTN","XQ72",136,0)
RXQ ;Return if XQUIT is cancelled by the application
"RTN","XQ72",137,0)
 I $P(XQY0,U,17),$D(^DIC(19,XQD,26)),$L(^(26)) X ^(26) ;W " ==> JUMP1^XQ72"
"RTN","XQ72",138,0)
 S XQTT=XQTT+1 ;Reset stack pointer
"RTN","XQ72",139,0)
 S XQONSTK=XQTT_U_XQONSTK
"RTN","XQ72",140,0)
 Q
"RTN","XQ72",141,0)
 ;
"RTN","XQ72",142,0)
MPW ;Multiple paths, choose shortest or best
"RTN","XQ72",143,0)
 S XQ(XQ+1)=$P(XQY0,U,5),XQJ=1,%="" F XQI=0:0 S %=$O(XQ(%)) Q:%=""!(%'=+%)  S XQ(XQJ)=XQ(%),XQJ=XQJ+1
"RTN","XQ72",144,0)
 S XQ=XQJ-1 F XQJ=1:1:$L(XQSTK,",")-2 S X=","_$P(XQSTK,",",XQJ)_"," F XQI=1:1:XQ S %=","_XQ(XQI) I %[X,'$D(Y(XQI)) S XQ(XQI)=$E(X,2,99)_$P(XQ(XQI),X,2,99),Y(XQI)=""
"RTN","XQ72",145,0)
 F XQI=1:1:XQ S %($L(XQ(XQI),","),XQI)=XQ(XQI)
"RTN","XQ72",146,0)
 S X="",Z=1 F XQI=1:1:XQ S X=$O(%(X)) Q:X=""  S Y="" F XQJ=0:0 S Y=$O(%(X,Y)) Q:Y=""  S XQ(Z)=%(X,Y),Z=Z+1
"RTN","XQ72",147,0)
 F XQI=1:1:XQ S %XQJP=XQ(XQI) Q:%XQJP=""  D JMP^XQCHK Q:$L(%XQJP)
"RTN","XQ72",148,0)
 I %XQJP="" W " ??",$C(7) S XQY=+XQSV,XQDIC=$P(XQSV,U,2),XQY0=$P(XQSV,U,3,99),XQ=-1 Q
"RTN","XQ72",149,0)
 S XQY0=$P(XQY0,U,1,4)_U_XQ(XQI)_U_$P(XQY0,U,6,99)
"RTN","XQ72",150,0)
 Q
"RTN","XQ72",151,0)
 ;
"RTN","XQ72",152,0)
SAMTREE ;Jump target is in the same tree, find the modified path
"RTN","XQ72",153,0)
 N XQI,XQJ,XQY1
"RTN","XQ72",154,0)
 ;Find in XQI the 1st option in XQJP not already on the stack
"RTN","XQ72",155,0)
 F XQI=1:1:$L(XQJP,",")-1  Q:XQSTK'[($P(XQJP,",",XQI)_",")
"RTN","XQ72",156,0)
 ;Remove that part of jump path already on the stack
"RTN","XQ72",157,0)
 S XQNP=$P(XQJP,",",XQI,99),XQNP=$L(XQNP,",")-1_U_XQNP
"RTN","XQ72",158,0)
 ;
"RTN","XQ72",159,0)
 ;Calculate where we push XQNP (the new path) onto the stack
"RTN","XQ72",160,0)
 S %=$P(XQJP,",",1,XQI-1),XQY1=$P(%,",",$L(%,","))
"RTN","XQ72",161,0)
 ;
"RTN","XQ72",162,0)
 ;Pop the stack until we are pointing to where we need to be
"RTN","XQ72",163,0)
 F XQM=XQTT:-1:2 Q:$P(XQSTK,",",XQM)=XQY1  D POP(XQM)
"RTN","XQ72",164,0)
 Q
"RTN","XQ72",165,0)
 ;
"RTN","XQ72",166,0)
 ;
"RTN","XQ72",167,0)
SOLVE(XQY1,XQJP,XQNP) ;See if and where we are on the jump path.
"RTN","XQ72",168,0)
 ;Returns the remainder of XQJP after XQY1 and everything
"RTN","XQ72",169,0)
 ;under it is removed from the path.  With XQJP = "1,2,3,4,5,"
"RTN","XQ72",170,0)
 ;and XQY1 = 3 (or "3,"; or "2,3"; or "1,2,3,") it returns XQNP
"RTN","XQ72",171,0)
 ;equal to "4,5,".  If XQY1 is not in XQJP, XQNP is returned as
"RTN","XQ72",172,0)
 ;null.
"RTN","XQ72",173,0)
 ;
"RTN","XQ72",174,0)
 N X,IN,OUT
"RTN","XQ72",175,0)
 S IN=+XQY1
"RTN","XQ72",176,0)
 S X=$S(XQY1[",":1,1:0) ;Is it a string or a number?
"RTN","XQ72",177,0)
 S XQNP=$P($E(XQJP,$F(XQJP,XQY1)-X,99),",",2,99)
"RTN","XQ72",178,0)
 I +XQNP=IN S XQNP="" ;No match
"RTN","XQ72",179,0)
 Q
"RTN","XQ75")
0^2^B50661291
"RTN","XQ75",1,0)
XQ75 ;SEA/AMF,LUKE,JLI - Lookup response for jumps ;05/03/2002  13:49
"RTN","XQ75",2,0)
 ;;8.0;KERNEL;**47,46,157**;Jul 10, 1995
"RTN","XQ75",3,0)
 ;Enter at S with XQUR. Exit with XQY set to the chosen option #,
"RTN","XQ75",4,0)
 ;with array of possibilities in XQ(XQ):XQY^menu txt [name]^XQPSM
"RTN","XQ75",5,0)
 ;XQXT(XQXT) similarly built, holds exact matches
"RTN","XQ75",6,0)
 ;XQY=-1 (no option found), or XQY=-2 (jumps shut down).
"RTN","XQ75",7,0)
 ;
"RTN","XQ75",8,0)
X ;Unless exact match is found, find all possibilities in any XQDIC
"RTN","XQ75",9,0)
 S XQO=$O(^XUTL("XQO",XQDIC,XQO)) Q:'$S(XQO="":0,XQUR="?":XQO'="^",XQUR=0_$C(1):'$L($P(XQO,"0",1)),1:'$L($P(XQO,XQUR,1)))
"RTN","XQ75",10,0)
 S XQYY=^XUTL("XQO",XQDIC,XQO) S XQY=+XQYY G:$D(XQ("X",+XQY)) X S %=$G(^XUTL("XQO",XQDIC,"^",+XQY)) G:%="" X S XQY0=$P(%,U,2,99)
"RTN","XQ75",11,0)
 S XQCY=XQY,XQCY0=XQY0 D ^XQCHK I XQCY<0 S XQY=0 G X
"RTN","XQ75",12,0)
 S:'$P(XQYY,U,2) XQ("S",+XQY)=$P(XQO,U)
"RTN","XQ75",13,0)
 I XQUR=$P(XQO,U),'XQS S XQXT=XQXT+1,XQXT(XQXT)=+XQY_U_$P(XQY0,U,2)_"  ["_$P(XQY0,U)_"] "_U_$S($D(XQUD):XQUD_",",1:"")_XQDIC,XQXT("X",XQY)="" S:'$P(XQYY,U,2) XQXT("S",+XQY)=$P(XQO,U)
"RTN","XQ75",14,0)
 S XQ=XQ+1,XQ1=XQ1+1,XQ(XQ)=+XQY_U_$P(XQY0,U,2)_"  ["_$P(XQY0,U)_"] "_U_$S($D(XQUD):XQUD_",",1:"")_XQDIC,XQ("X",XQY)=""
"RTN","XQ75",15,0)
 I XQ1>19,'XQXT D C
"RTN","XQ75",16,0)
 Q:XQY<0!(XQUR="")  G X
"RTN","XQ75",17,0)
 Q
"RTN","XQ75",18,0)
 ;
"RTN","XQ75",19,0)
C ;Display a screen-load of 19 possibilities and ask for a choice
"RTN","XQ75",20,0)
 ;I $G(XQXFLG("GUI")) D  Q
"RTN","XQ75",21,0)
 ;.D LIST^XQGS1(XQ)
"RTN","XQ75",22,0)
 ;.S XQUR=""
"RTN","XQ75",23,0)
 ;.Q:XQY<0
"RTN","XQ75",24,0)
 ;.S %="" F  S %=$O(XQ(%)) Q:%=""!(%'=+%)  I XQY=+XQ(%) S XQPSM=$P(XQ(%),U,3)
"RTN","XQ75",25,0)
 ;.Q
"RTN","XQ75",26,0)
 S:XQ1<1 XQ1=XQ W ! F XQI=1:1:XQ1 S XQJ=XQS*20+XQI W !?4,XQJ,?9,$P(XQ(XQJ),U,2) I $D(XQ("S",+XQ(XQJ))) W ?43,"  (",XQ("S",+XQ(XQJ)),")"
"RTN","XQ75",27,0)
ASK W !!,"Type '^' to stop, or choose a number from 1 to ",XQ," :"
"RTN","XQ75",28,0)
 R XQJ:DTIME S:'$T XQJ=U W:XQJ["?" !!,"**> Choose an item from this list by selecting its corresponding number,",!?5,"or type a '^' to return to your menu.",! G:XQJ["?" ASK
"RTN","XQ75",29,0)
 I XQJ=U S XQY=-1,XQ=0 Q
"RTN","XQ75",30,0)
 I XQJ'?1N.N,$L(XQJ),XQJ'=U W $C(7),"  ??",! G ASK
"RTN","XQ75",31,0)
 I XQJ?1N.N G C:'$D(XQ(XQJ)) D  Q:$D(XQ(+XQJ))
"RTN","XQ75",32,0)
 .N %,XQD,XQP,Y
"RTN","XQ75",33,0)
 .S %=XQ(XQJ),Y=+% I Y>0 D
"RTN","XQ75",34,0)
 ..S XQP=$P(%,U,3),XQD=$S($L(XQP,",")>1:$P(XQP,",",$L(XQP,",")),1:XQP)
"RTN","XQ75",35,0)
 ..S XQY0=$G(^XUTL("XQO",XQD,"^",Y)),XQY0=$P(XQY0,U,2,99)
"RTN","XQ75",36,0)
 ..I XQY0="" K XQ(XQJ) S XQ=XQ-1,XQJ="" Q
"RTN","XQ75",37,0)
 .I $L(XQJ),$D(XQ(XQJ)) S XQY=Y,XQDIC=XQD,XQPSM=XQP,XQUR="" W "  " Q
"RTN","XQ75",38,0)
 .Q
"RTN","XQ75",39,0)
 I XQJ?1N.N W $C(7),$P(XQ(XQJ-1#20+1),U,4),! G C
"RTN","XQ75",40,0)
 I '$L(XQJ),XQ1'<20 S XQS=XQS+1,XQ1=0 Q
"RTN","XQ75",41,0)
 I '$L(XQJ),XQ1<20 S XQY=-1,XQ=0 Q
"RTN","XQ75",42,0)
 I '$D(XQ(XQJ)) G C
"RTN","XQ75",43,0)
 K XQ S XQY=$S(XQJ=U:-3,XQJ="":-3,1:-1),XQUR=$C(95) S:XQJ=U XQJ="",XQY=-1 S:$L(XQJ) XQUR=$S($E(XQDIC,1)="P":U_XQJ,1:XQJ),XQY=0 Q
"RTN","XQ75",44,0)
 Q
"RTN","XQ75",45,0)
 ;
"RTN","XQ75",46,0)
S ;Entry from XQ: Search primary, common, and secondary menus for XQUR
"RTN","XQ75",47,0)
 I XQUR'?.ANP W $C(7) S XQY=-1 Q
"RTN","XQ75",48,0)
 I XQPSM'="PXU" S XQDIC=$S($D(XQPSM):$P(XQPSM,"P",2),$D(XQDIC):XQDIC,1:XQY)
"RTN","XQ75",49,0)
 E  S XQDIC="PXU"
"RTN","XQ75",50,0)
 I '$D(XQTT) S XQTT=$G(^XUTL("XQ",$J,"T")) I XQTT="" S XQTT=1
"RTN","XQ75",51,0)
 ;S:'$D(XQDIC) XQDIC=XQY S XQSV=XQY_U_XQDIC_U_XQY0
"RTN","XQ75",52,0)
 S XQJ="",XQJMP=1,(XQ,XQ1,XQS,XQXT,XQY)=0
"RTN","XQ75",53,0)
 S XQO=$E(XQUR,1,30) I XQUR'?.PUN S XQO=$$UP^XLFSTR(XQO) ;F XQI=1:1 Q:XQO?.NUP  S XQO1=$A(XQO,XQI) I XQO1<123,XQO1>96 S XQO=$E(XQO,1,XQI-1)_$C(XQO1-32)_$E(XQO,XQI+1,255)
"RTN","XQ75",54,0)
 S XQUR=XQO,(XQO,XQO1)=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z"
"RTN","XQ75",55,0)
 I '$D(^XUTL("XQ",$J,"XQM")) S ^("XQM")=+^VA(200,DUZ,201)
"RTN","XQ75",56,0)
 ;I '$D(^XUTL("XQ",$J,"XQW")) S ^("XQW")=$P(^VA(200,DUZ,201),U,2)
"RTN","XQ75",57,0)
 I $D(XQJS),XQJS G OUT
"RTN","XQ75",58,0)
 ;
"RTN","XQ75",59,0)
 ;Check the Primary Menu first
"RTN","XQ75",60,0)
 S XQDIC="P"_^XUTL("XQ",$J,"XQM")
"RTN","XQ75",61,0)
 ;If there's no master copy in ^DIC(19,"AXQ"), nothing to do.
"RTN","XQ75",62,0)
 I '$D(^DIC(19,"AXQ",XQDIC,0)) D REACT^XQ84(DUZ) S XQY=-1 G OUT
"RTN","XQ75",63,0)
 I '$D(^XUTL("XQO",XQDIC,0)) S XQSAVE=XQPSM,XQPSM=XQDIC K ^XUTL("XQO",XQDIC) D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",64,0)
 S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=^DIC(19,"AXQ",XQDIC,0)
"RTN","XQ75",65,0)
 I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",66,0)
 S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 S XQSAVE=XQPSM,XQPSM=XQDIC K ^XUTL("XQO",XQDIC) D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",67,0)
 ;If tree is not there or out of date, remerge it
"RTN","XQ75",68,0)
 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",69,0)
 ;
"RTN","XQ75",70,0)
 ;Look in XUCOMMAND
"RTN","XQ75",71,0)
 S XQDIC="PXU"
"RTN","XQ75",72,0)
 ;I $S('$D(^XUTL("XQO",XQDIC,0)):1,^XUTL("XQO",XQDIC,0)'=^DIC(19,"AXQ",XQDIC,0):1,1:0) K ^XUTL("XQO",XQDIC) D MGPXU^XQ12
"RTN","XQ75",73,0)
 I '$D(^XUTL("XQO",XQDIC,0)) D MGPXU^XQ12
"RTN","XQ75",74,0)
 S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=^DIC(19,"AXQ",XQDIC,0)
"RTN","XQ75",75,0)
 I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",76,0)
 S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 D MGPXU^XQ12
"RTN","XQ75",77,0)
 S XQO=XQO1 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",78,0)
 ;
"RTN","XQ75",79,0)
 ;Check the top level of the Secondaries
"RTN","XQ75",80,0)
 S XQDIC="U"_DUZ,XQO=XQO1 D:$S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,DUZ,203.1)):1,1:^VA(200,DUZ,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) ^XQSET I '$D(^XUTL("XQO",XQDIC,0)),'XQXT D C G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",81,0)
 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",82,0)
 ;
"RTN","XQ75",83,0)
 ;Check each secondary in depth
"RTN","XQ75",84,0)
 F XQK=0:0 Q:XQY<0!(XQUR="")  S XQUD="U"_DUZ,XQK=$O(^XUTL("XQO",XQUD,U,XQK)) Q:XQK=""  D
"RTN","XQ75",85,0)
 .S XQCY=XQK D ^XQCHK I XQCY>0,$P(^XUTL("XQO",XQUD,U,XQK),U,5)="M" D
"RTN","XQ75",86,0)
 ..N XQSAVE
"RTN","XQ75",87,0)
 ..S XQST=XQK,XQDIC="P"_XQK,XQO=XQO1
"RTN","XQ75",88,0)
 ..I '$D(^DIC(19,"AXQ","P0")) D
"RTN","XQ75",89,0)
 ...I '$D(^XUTL("XQO",XQDIC,0)) S XQSAVE=XQPSM K ^XUTL("XQO",XQDIC) D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",90,0)
 ...S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=$G(^DIC(19,"AXQ",XQDIC,0))
"RTN","XQ75",91,0)
 ...Q:XQDIC19=""  ;Nothing to merge, probably a new scondary
"RTN","XQ75",92,0)
 ...I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",93,0)
 ...S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 S XQSAVE=XQPSM,XQPSM=XQDIC K ^XUTL("XQO",XQDIC) D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",94,0)
 ...Q
"RTN","XQ75",95,0)
 ..D X Q:XQY<0!(XQUR="")
"RTN","XQ75",96,0)
 ..Q
"RTN","XQ75",97,0)
 .Q
"RTN","XQ75",98,0)
 G:XQY<0 OUT
"RTN","XQ75",99,0)
 G:XQUR="" W
"RTN","XQ75",100,0)
 ;
"RTN","XQ75",101,0)
 I XQXT K XQ S (XQ,XQ1)=XQXT F XQI=1:1:XQ S XQ(XQI)=XQXT(XQI),%=+XQ(XQI),XQ("X",%)="" I $D(XQXT("S",%)) S XQ("S",%)=XQXT("S",%)
"RTN","XQ75",102,0)
 ;
"RTN","XQ75",103,0)
 I XQ=1,XQS=0 D
"RTN","XQ75",104,0)
 .N X
"RTN","XQ75",105,0)
 .S %=XQ(1),XQY=+%,XQPSM=$P(%,U,3)
"RTN","XQ75",106,0)
 .S XQDIC=$S($L(XQPSM,",")>1:$P(XQPSM,",",$L(XQPSM,",")),1:XQPSM)
"RTN","XQ75",107,0)
 .S X=$G(^XUTL("XQO",XQDIC,U,XQY))
"RTN","XQ75",108,0)
 .I X="" S X=$G(^DIC(19,"AXQ",XQDIC,U,XQY))
"RTN","XQ75",109,0)
 .Q:X=""
"RTN","XQ75",110,0)
 .S XQY0=$P(X,U,2,99),XQSFLG=""
"RTN","XQ75",111,0)
 .Q
"RTN","XQ75",112,0)
 I $D(XQSFLG) K XQSFLG G W
"RTN","XQ75",113,0)
 ;
"RTN","XQ75",114,0)
 I XQ>0,'$D(XQ(XQS*20+1)) S XQY=-1 G OUT
"RTN","XQ75",115,0)
 D:XQ>0 C G:XQY<0 OUT I XQ=0 S XQY=-1 G OUT
"RTN","XQ75",116,0)
 ;
"RTN","XQ75",117,0)
W ;Write out remaining text and return to XQ
"RTN","XQ75",118,0)
 ;G:$D(XQXFLG("GUI")) OUT
"RTN","XQ75",119,0)
 I $D(XQ("S",+XQY)),XQUR=$E(XQ("S",+XQY),1,$L(XQUR)) W $E(XQ("S",+XQY),$L(XQUR)+1,99),"   ",$P(XQY0,U,2)
"RTN","XQ75",120,0)
 E  W $E($P(XQY0,U,2),$L(XQUR)+1,99) W:$D(XQ("S",+XQY)) "   (",XQ("S",+XQY),")"
"RTN","XQ75",121,0)
 ;
"RTN","XQ75",122,0)
OUT ;Exit here
"RTN","XQ75",123,0)
 K XQ
"RTN","XQ75",124,0)
 N % S XQ=""
"RTN","XQ75",125,0)
 I XQY>0,$D(^XUTL("XQO",XQDIC,"^",+XQY,0)) D
"RTN","XQ75",126,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",+XQY,0)) I %="" D
"RTN","XQ75",127,0)
 ..H 1 ;Micro surgery must have it wait a sec
"RTN","XQ75",128,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",+XQY,0))
"RTN","XQ75",129,0)
 ..Q
"RTN","XQ75",130,0)
 .Q:%=""
"RTN","XQ75",131,0)
 .S:%>0 XQ=+%
"RTN","XQ75",132,0)
 .F XQI=1:1:XQ D
"RTN","XQ75",133,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI)) I %="" D
"RTN","XQ75",134,0)
 ...H 1
"RTN","XQ75",135,0)
 ...S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI))
"RTN","XQ75",136,0)
 ...Q
"RTN","XQ75",137,0)
 ..I %]"" S XQ(XQI)=$P(%,U)
"RTN","XQ75",138,0)
 ..Q
"RTN","XQ75",139,0)
 .Q
"RTN","XQ75",140,0)
 I XQ="" S XQ=0
"RTN","XQ75",141,0)
 ;I XQY=-1,'$D(XQHLP) W $C(7),"  ??" S XQY=+XQSV,XQDIC=$P(XQSV,U,2),XQY0=$P(XQSV,U,3,99),XQUR=""
"RTN","XQ75",142,0)
 ;
"RTN","XQ75",143,0)
 K %,I,J,X,XQ1,XQAP,XQCY,XQCY0,XQDIC19,XQI,XQJ,XQJMP,XQK,XQO,XQO1,XQS,XQST,XQUD,XQXT,XQXUTL,XQYY,Y
"RTN","XQ75",144,0)
 K XQ
"RTN","XQ75",145,0)
 Q
"RTN","XQ75",146,0)
 ;
"RTN","XQ75",147,0)
FIND(XQDIC) ;The expected 0th node in ^XUTL is not here
"RTN","XQ75",148,0)
 I '$D(XQDIC) Q 0
"RTN","XQ75",149,0)
 N %,XQT1,XQT2
"RTN","XQ75",150,0)
 S %=$G(^DIC(19,"AXQ",XQDIC,0))
"RTN","XQ75",151,0)
 I '$L(%) Q 0
"RTN","XQ75",152,0)
 I $D(^XTMP("XQO","NOFIND",XQDIC)) D
"RTN","XQ75",153,0)
 .N XQT1,XQT2,XQFLG
"RTN","XQ75",154,0)
 .S XQT1=$H,XQFLG=0
"RTN","XQ75",155,0)
 .S XQT2=$G(^XTMP("XQO","NOFIND",XQDIC))
"RTN","XQ75",156,0)
 .I '$L(XQT2) Q
"RTN","XQ75",157,0)
 .I XQT2>XQT1 K ^XTMP("XQO","NOFIND",XQDIC) Q
"RTN","XQ75",158,0)
 .I XQT1>XQT2!($P(XQT1,",",2)-$P(XQT2,",",2)>.300) D
"RTN","XQ75",159,0)
 ..K ^XTMP("XQO","NOFIND",XQDIC)
"RTN","XQ75",160,0)
 ..I XQDIC="PXU" S XQFLG=1 D MGPXU^XQ12
"RTN","XQ75",161,0)
 ..I 'XQFLG D MERGE^XQ12
"RTN","XQ75",162,0)
 ..Q
"RTN","XQ75",163,0)
 .Q
"RTN","XQ75",164,0)
 I '$D(^XTMP("XQO","NOFIND",XQDIC)) S ^(XQDIC)=$H
"RTN","XQ75",165,0)
 Q %
"RTN","XQ75",166,0)
 ;
"RTN","XQ75",167,0)
P ;Entry point for '"' jump to XUCOMMAND options
"RTN","XQ75",168,0)
 I XQUR'?.ANP!(XQUR[U) W $C(7)," ??" S XQY=-1 Q
"RTN","XQ75",169,0)
 S XQO=XQUR I XQUR'?.PUN S XQO=$$UP^XLFSTR(XQO) ;F XQI=1:1 Q:XQO?.NUP  S XQO1=$A(XQO,XQI) I XQO1<123,XQO1>96 S XQO=$E(XQO,1,XQI-1)_$C(XQO1-32)_$E(XQO,XQI+1,255)
"RTN","XQ75",170,0)
 S XQUR=XQO ;,XQSV=XQY_U_XQDIC_U_XQY0
"RTN","XQ75",171,0)
 S XQJ="",XQJMP=1,(XQ,XQ1,XQS,XQXT,XQY)=0
"RTN","XQ75",172,0)
 S (XQO,XQO1)=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z"
"RTN","XQ75",173,0)
 S XQDIC="PXU" D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",174,0)
 I XQXT K XQ S XQ=XQXT F XQI=1:1:XQ S XQ(XQI)=XQXT(XQI),%=+XQ(XQI),XQ("X",%)="" I $D(XQXT("S",%)) S XQ("S",%)=XQXT("S",%)
"RTN","XQ75",175,0)
 I XQ=1,XQS=0 S %=XQ(1),XQY=+%,XQPSM=$P(%,U,3),XQDIC=$S($L(XQPSM,",")>1:$P(XQPSM,",",$L(XQPSM,",")),1:XQPSM),XQY0=$P(^XUTL("XQO",XQDIC,U,XQY),U,2,99) G OUT
"RTN","XQ75",176,0)
 D:XQ>0 C G:XQY<0 OUT I XQ=0&('XQXT) S XQY=-1 G OUT
"RTN","XQ75",177,0)
 G OUT
"RTN","XQ8")
0^3^B22674034
"RTN","XQ8",1,0)
XQ8 ;SEA/AMF,LUKE - Build menu trees ;06/06/2002  10:41
"RTN","XQ8",2,0)
 ;;8.0;KERNEL;**81,89,116,157**;Jul 10, 1995
"RTN","XQ8",3,0)
 ;
"RTN","XQ8",4,0)
 Q  ;You can't start here.
"RTN","XQ8",5,0)
TIME ;See if there are prohibited times for this option
"RTN","XQ8",6,0)
 S %XQI=$P(^DIC(19,Y,0),U,9) I $L(%XQI)>2 S XQP(L)=%XQI_"MO-FR"
"RTN","XQ8",7,0)
 I $D(^DIC(19,Y,3.91)) S %XQI=0 F  S %XQI=$O(^DIC(19,Y,3.91,%XQI)) Q:%XQI'>0  S XQP(L)=$S($D(XQP(L)):XQP(L)_";",1:"")_$P(^(%XQI,0),U,1)_$P(^(0),U,2)
"RTN","XQ8",8,0)
 K %XQI I '$D(XQP(L)),$L($P(Y(0),U,9)) S XQP(L)=$P(Y(0),U,9)
"RTN","XQ8",9,0)
 Q
"RTN","XQ8",10,0)
UP S X=$$UP^XLFSTR(X) ;F Z=1:1 Q:X?.NUP  S W=$A(X,Z) I W<123,W>96 S X=$E(X,1,Z-1)_$C(W-32)_$E(X,Z+1,255)
"RTN","XQ8",11,0)
 Q
"RTN","XQ8",12,0)
CHK ;Called from XQ81+107
"RTN","XQ8",13,0)
 S XQRE=$D(^XUTL("XQO",XQDIC,"^BUILD")) I XQRE,($P($H,",",2)-^("^BUILD")>1800)!(^("^BUILD")>$P($H,",",2)) K ^("^BUILD") S XQRE=0
"RTN","XQ8",14,0)
 Q
"RTN","XQ8",15,0)
PMO ;Called from XQ71+21
"RTN","XQ8",16,0)
 D CHK W !,$S(XQRE:"I'M REBUILDING",1:"I NEED TO REBUILD")," MENUS .... QUICK ACCESS IS TEMPORARILY DISABLED" W:$D(XQMMJ) !!,"Please proceed to '",$E(XQMMJ,2,99),"'" K XQMMJ,XQMM I XQRE K XQRE Q
"RTN","XQ8",17,0)
 Q
"RTN","XQ8",18,0)
 ;
"RTN","XQ8",19,0)
PM1 ;Enter here to build a single menu called by XQ83
"RTN","XQ8",20,0)
 S XQPM1=""
"RTN","XQ8",21,0)
 S:XQDIC'="PXU" XQXUF=""
"RTN","XQ8",22,0)
 ;
"RTN","XQ8",23,0)
PM2 ;Enter here to rebuild a single menu Called by RD3+10^XQ81
"RTN","XQ8",24,0)
 ;$D(XQFG1) causes it rebuild in real time otherwise it is queued
"RTN","XQ8",25,0)
 D:$D(XQCON) CHK S:'$D(XQRE) XQRE=0 Q:XQRE
"RTN","XQ8",26,0)
 K ^TMP("XQO",$J,XQDIC) S ^XUTL("XQO",XQDIC,"^BUILD")=$P($H,",",2) G:$D(XQFG1) REBLD
"RTN","XQ8",27,0)
 ;
"RTN","XQ8",28,0)
 S ZTIO="",ZTRTN="REBLD^XQ8",ZTDTH=$H
"RTN","XQ8",29,0)
 S ZTSAVE("XQDIC")="",ZTSAVE("XQPM2")=""
"RTN","XQ8",30,0)
 S ZTDESC="Rebuild The Single Menu "_XQDIC D ^%ZTLOAD Q
"RTN","XQ8",31,0)
 ;
"RTN","XQ8",32,0)
REBLD K XQFG1 S U="^",UU="^^" ;Taskman entry
"RTN","XQ8",33,0)
 S:'$D(XQDATE) XQDATE=$H
"RTN","XQ8",34,0)
 I XQDIC'="PXU" S Y=+$P(XQDIC,"P",2) Q:Y'>0  Q:'$D(^DIC(19,Y,0))
"RTN","XQ8",35,0)
 I '$D(XQXUF) K ^TMP("XQO",$J,"PXU") S XQSAV=XQDIC S XQDIC="PXU",Y=$O(^DIC(19,"B","XUCOMMAND",0)) S:Y>0 %="",(L,X(0))=0,(XQPX,XQD)=Y D:Y>0 TREE1,PMOK S XQDIC=XQSAV,XQXUF=1,^TMP("XQO",$J,"PXU",0)=XQDATE
"RTN","XQ8",36,0)
 S Y=$P(XQDIC,"P",2) G:Y'>0!'$D(^DIC(19,+Y,0)) PMOKA I Y>0,$D(^DIC(19,Y,0)),$P(^(0),U,4)="M" D PMOK S %="",(L,X(0))=0,XQD=Y D TREE1
"RTN","XQ8",37,0)
 S:$D(^DIC(19,$E(XQDIC,2,99),0)) ^(99.1)=XQDATE S ^TMP("XQO",$J,XQDIC,0)=XQDATE
"RTN","XQ8",38,0)
 S Y=+$P(XQDIC,"P",2)
"RTN","XQ8",39,0)
 I Y>0 S (XQD,%)=^DIC(19,Y,0),L=1,XQP(L)="" D TIME S ^TMP("XQO",$J,XQDIC,U,Y)=U_$P(%,U,1,2)_U_$S(($P(%,U,3)]""):1,1:"")_U_$P(%,U,4)_UU_$P(%,U,6,8)_U_XQP(L)_U_$P(%,U,10,99)
"RTN","XQ8",40,0)
 I Y>0,'$D(^DIC(19,Y,"U")) S XQFL=0 S:$D(X)#2 XQSAVE=X,XQFL=1 S X=$E($P(^DIC(19,+Y,0),U,2),1,30) D UP S ^("U")=X S:XQFL X=XQSAVE
"RTN","XQ8",41,0)
 I Y>0 S ^TMP("XQO",$J,XQDIC,^DIC(19,Y,"U")_U)=Y_"^0"
"RTN","XQ8",42,0)
PMOKA K ^XUTL("XQO",XQDIC,"^BUILD") I '$D(XQFG),$D(ZTSK) K ^%ZTSK(ZTSK)
"RTN","XQ8",43,0)
PMOK K %,XQA,XQD,XQE,XQF,XQFL,XQP,XQR,XQRE,XQSAVE
"RTN","XQ8",44,0)
 ;
"RTN","XQ8",45,0)
 I $D(XQPM1) D
"RTN","XQ8",46,0)
 .;A single menu is being built
"RTN","XQ8",47,0)
 .D MERGET^XQ81
"RTN","XQ8",48,0)
 .D MERGEX^XQ81
"RTN","XQ8",49,0)
 .K ^TMP($J),^TMP("XQO",$J)
"RTN","XQ8",50,0)
 .Q
"RTN","XQ8",51,0)
 K XQPM1
"RTN","XQ8",52,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ8",53,0)
 Q
"RTN","XQ8",54,0)
 ;
"RTN","XQ8",55,0)
TREE ;
"RTN","XQ8",56,0)
 S X(L)=$O(^DIC(19,XQD,10,X(L))) Q:X(L)'>0  S Y=^(X(L),0),%=$P(Y,U,2),Y=+Y G:$D(XQR(Y))!'$D(^DIC(19,Y,0)) TREE S XQR(Y)="" I $D(XQFG),'$D(XQNTREE) W:'(Y#5) "."
"RTN","XQ8",57,0)
TREE1 S Y(0)=^DIC(19,Y,0),X=$S($D(^("U")):^("U"),1:"") I X="" S X=$E($P(Y(0),U,2),1,30) D UP S ^("U")=X
"RTN","XQ8",58,0)
 S Y(1)=X S:'$L($P(Y(0),U,5)) $P(Y(0),U,5)=0
"RTN","XQ8",59,0)
 G:$L($P(Y(0),U,3)) TREE S:$L($P(Y(0),U,6)) XQK(L)=$P(Y(0),U,6) S XQA(L)=Y S:$L($P(Y(0),U,10)) XQE(L)=$P(Y(0),U,10)
"RTN","XQ8",60,0)
 S:$P(Y(0),U,16) XQF(L)=$P(^DIC(19,Y,3),U) I $D(XQF(L)) K:XQF(L)="" XQF(L)
"RTN","XQ8",61,0)
 D TIME,PMOSET S L=L+1,X(L)=0,(XQD,XQD(L))=Y D TREE
"RTN","XQ8",62,0)
 Q:L<2  K XQR(XQD(L)) S L=L-1 K XQA(L),XQK(L),XQP(L),XQE(L),XQF(L) S XQD=XQD(L) G TREE
"RTN","XQ8",63,0)
 ;
"RTN","XQ8",64,0)
PMOSET ;
"RTN","XQ8",65,0)
 S K=0,X=$E(Y(1),1,27) I $L(X) S X=X_U D:$D(^TMP("XQO",$J,XQDIC,X))!$D(^(X_"1")) PMO3 S:L&'K ^TMP("XQO",$J,XQDIC,X)=Y_"^1"
"RTN","XQ8",66,0)
 I $D(%),$L(%) S X=%,K=0 D UP Q:'$L(X)  S X=X_U D:$D(^TMP("XQO",$J,XQDIC,X))!$D(^(X_"1")) PMO3 S:L&'K ^TMP("XQO",$J,XQDIC,X)=Y_"^0"
"RTN","XQ8",67,0)
 S (XQA,XQK,XQP,XQE,XQF)="" F D="XQA","XQK","XQP","XQE","XQF" F I=1:1:L I $D(@(D_"(I)")) S @D=@D_@(D_"(I)")_","
"RTN","XQ8",68,0)
 I '$D(^TMP("XQO",$J,XQDIC,"^",Y)) S ^(Y)=U_$P(Y(0),U,1,2)_U_$S(($P(Y(0),U,3)]""):1,1:"")_U_$P(Y(0),U,4)_U_XQA_U_XQK_U_$P(Y(0),U,7,8)_U_XQP_U_XQE_U_$P(Y(0),U,11,15)_U_XQF_U_$P(Y(0),U,17,99) Q
"RTN","XQ8",69,0)
 S %=$S('$D(^TMP("XQO",$J,XQDIC,"^",Y,0)):1,1:^(0)+1),^(0)=%,^(0,%)=XQA_U_XQK_U_XQP_U_XQE_U_XQF
"RTN","XQ8",70,0)
 Q
"RTN","XQ8",71,0)
PMO3 ;
"RTN","XQ8",72,0)
 S D=X,K=$S($D(^TMP("XQO",$J,XQDIC,X)):(Y=+^(X)),1:0) F  S V=$O(^TMP("XQO",$J,XQDIC,D)) Q:K!($P(V,U,1)'=$P(X,U,1))  S D=V S:Y=+^(V) K=1
"RTN","XQ8",73,0)
 I 'K S I=$P(D,U,2) S:'$L(I) I=0 I I=0 S ^(X_"1")=^TMP("XQO",$J,XQDIC,X) K ^(X) S I=1
"RTN","XQ8",74,0)
 I 'K S X=X_(I+1)
"RTN","XQ8",75,0)
 Q
"RTN","XQ8",76,0)
 ;BUILD moved to XQ81
"RTN","XQ8",77,0)
 Q
"RTN","XQ81")
0^4^B62776969
"RTN","XQ81",1,0)
XQ81 ;SEA/AMF/LUKE,SF/RWF - Build menu trees ;04/18/2002  10:22
"RTN","XQ81",2,0)
 ;;8.0;KERNEL;**81,116,157**;Jul 10, 1995
"RTN","XQ81",3,0)
BUILD ;
"RTN","XQ81",4,0)
 ;
"RTN","XQ81",5,0)
RD2 N XQSTAT S XQSTAT=$$STATUS()
"RTN","XQ81",6,0)
 I 'XQSTAT W !!,"Some one else is rebuilding menus.  Sorry." Q
"RTN","XQ81",7,0)
 K ZTSK
"RTN","XQ81",8,0)
 D MICRO ;Turn off micro surgery for now
"RTN","XQ81",9,0)
 ;
"RTN","XQ81",10,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",11,0)
 K XQFG W !!,"This option will build menu trees for each primary and secondary menu.",!,"You may build all the trees, or build them selectively, using 'verify'.",!,"Note that the 'compiled menus' will only be built into ^XUTL on this CPU.",!
"RTN","XQ81",12,0)
 S DIR(0)="Y",DIR("A")="Do you wish to verify each primary menu",DIR("B")="NO",DIR("??")="XQBUILDTREE-VER" D ^DIR K DIR G:$D(DIRUT) BLDEND S XQVE=(Y=1)
"RTN","XQ81",13,0)
 S DIR(0)="Y",DIR("A")="Would you like to build secondary menu trees too",DIR("B")="YES",DIR("??")="XQBUILDTREE-SEC" D ^DIR G:$D(DIRUT) BLDEND S XQBSEC=(Y=1)
"RTN","XQ81",14,0)
 ;
"RTN","XQ81",15,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Would you like to queue this job",DIR("B")="YES" D ^DIR K DIR G:$D(DIRUT) BLDEND I Y=1 D
"RTN","XQ81",16,0)
 .S ZTRTN="QUE^XQ81",ZTIO=""
"RTN","XQ81",17,0)
 .S ZTSAVE("XQVE")="",ZTSAVE("XQBSEC")="",ZTSAVE("XQSTART")=""
"RTN","XQ81",18,0)
 .S ZTDESC="Build menu trees in ^DIC(19,""AXQ"")"
"RTN","XQ81",19,0)
 .D ^%ZTLOAD
"RTN","XQ81",20,0)
 .I $D(ZTSK),'XQVE W !!,"Task #: ",ZTSK,!
"RTN","XQ81",21,0)
 .Q
"RTN","XQ81",22,0)
 ;
"RTN","XQ81",23,0)
 I $D(ZTSK) K ^DIC(19,"AXQ","P0") S XQALLDON="" G BLDEND
"RTN","XQ81",24,0)
 E  S ^DIC(19,"AXQ","P0")=$H L +^DIC(19,"AXQ","P0")
"RTN","XQ81",25,0)
 ;
"RTN","XQ81",26,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Do you really wish to run this DIRECTLY (it may take some time)",DIR("B")="NO" D ^DIR K DIR G:$D(DIRUT) BLDEND G:Y'=1 RD2
"RTN","XQ81",27,0)
 ;
"RTN","XQ81",28,0)
KIDS ;Entry from KIDS
"RTN","XQ81",29,0)
 I '$D(XQSTAT),$D(^DIC(19,"AXQ","P0")) S XQSTAT=$$STATUS I 'XQSTAT W !!,"  Some one else is building menus.  Sorry." K XQSTAT Q
"RTN","XQ81",30,0)
 I '$D(^DIC(19,"AXQ","P0","STOP")) D MICRO
"RTN","XQ81",31,0)
 I '$D(^DIC(19,"AXQ","P0")) S ^DIC(19,"AXQ","P0")=$H L +^DIC(19,"AXQ","P0")
"RTN","XQ81",32,0)
 I '$D(XQVE) S XQFG=0,XQBSEC=1,XQVE=0
"RTN","XQ81",33,0)
 N XQNTREE,XQNDONE S (XQNTREE,XQNDONE)=0
"RTN","XQ81",34,0)
 ;
"RTN","XQ81",35,0)
 ;Set up the error trap so we can clear the screen if it blows
"RTN","XQ81",36,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XQ81"
"RTN","XQ81",37,0)
 E  S X="ERR^XQ81",@^%ZOSF("TRAP")
"RTN","XQ81",38,0)
 ;
"RTN","XQ81",39,0)
 ;Set up the bar graph and window if not from KIDS
"RTN","XQ81",40,0)
 I '$D(XPDNM) D INIT^XPDID
"RTN","XQ81",41,0)
 I XPDIDVT D
"RTN","XQ81",42,0)
 .I $D(XPDIDTOT) S XQSAVTOT=XPDIDTOT
"RTN","XQ81",43,0)
 .S X="Rebuilding Menus" D TITLE^XPDID(X)
"RTN","XQ81",44,0)
 .S XPDIDTOT=50 ;Number of divisions in bar graph
"RTN","XQ81",45,0)
 .D UPDATE^XPDID(0)
"RTN","XQ81",46,0)
 .Q
"RTN","XQ81",47,0)
 ;
"RTN","XQ81",48,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",49,0)
 W !!,"Starting Menu Rebuild:  ",XQSTART
"RTN","XQ81",50,0)
 S XQFG=0 W !!,"Collecting primary menus in the New Person file..."
"RTN","XQ81",51,0)
 ;
"RTN","XQ81",52,0)
DQ ;Entry from taskman  Write if $D(XQFG)
"RTN","XQ81",53,0)
 K ZTREQ
"RTN","XQ81",54,0)
 I '$D(XQSTART) S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",55,0)
 N XQNOW,XQ8FLG,XQTASK
"RTN","XQ81",56,0)
 S XQ8FLG=0
"RTN","XQ81",57,0)
 S:'$D(XQNOW) XQNOW=$H
"RTN","XQ81",58,0)
 S ^DIC(19,"AXQ","P0")=XQNOW
"RTN","XQ81",59,0)
 S ^DIC(19,"AXQ","P0","STOP")=XQNOW ;Stop micro surgery if it's running
"RTN","XQ81",60,0)
 ;
"RTN","XQ81",61,0)
 S XQSEC=1,XQ81T="" I 'XQVE H 1
"RTN","XQ81",62,0)
 S XQI="" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:XQI'=+XQI!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",63,0)
 S XQI="U" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"U"'[$E(XQI)!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",64,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"P"'[$E(XQI)!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2,$L(^(0)) S XQ81T=^(0) Q
"RTN","XQ81",65,0)
 S:XQ81T="" XQ81T="Unknown"
"RTN","XQ81",66,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"P"'[$E(XQI)!(XQI="")  I "P"[$E(XQI),XQI'="P0" K ^TMP("XQO",$J,XQI)
"RTN","XQ81",67,0)
 ;
"RTN","XQ81",68,0)
 ;Find the various trees and put them into ^TMP($J), and count them
"RTN","XQ81",69,0)
 S:'$D(XQH) XQH=$H K ^TMP($J) S XQI=.5 F XQK=0:0 S XQI=$O(^VA(200,XQI)) Q:XQI'=+XQI  I $D(^VA(200,XQI,0)),$L($P(^VA(200,XQI,0),U,3)) D SET
"RTN","XQ81",70,0)
 ;
"RTN","XQ81",71,0)
 S (XQNTREE,%)=0 F  S %=$O(^TMP($J,%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",72,0)
 S %=0 F  S %=$O(^TMP($J,"SEC",%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",73,0)
 ;
"RTN","XQ81",74,0)
 W:$D(XQFG) !!?20,"Primary menus found in the New Person file",!?20,"------------------------------------------"
"RTN","XQ81",75,0)
 W:$D(XQFG) !!,"OPTION NAME         MENU TEXT",?49,"# OF",?62,"LAST",?71,"LAST",!?49,"USERS",?62,"USED",?71,"BUILT",!
"RTN","XQ81",76,0)
 S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,XQBLD)) Q:XQBLD'>0!(X=U)  I $D(^DIC(19,XQBLD,0)) S XQJ=^DIC(19,XQBLD,0) D VER
"RTN","XQ81",77,0)
 S XQSEC=0 I $D(XQFG),XQBSEC W !!,"Building secondary menu trees...."
"RTN","XQ81",78,0)
 I XQBSEC S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,"SEC",XQBLD)) Q:XQBLD'>0  D SEC
"RTN","XQ81",79,0)
 I 'XQVE S XQK="P" F XQBLD=0:0 S XQK=$O(^TMP("XQO",$J,XQK)) Q:XQK'["P"  S ^(XQK,0)=XQH
"RTN","XQ81",80,0)
 G BLDEND
"RTN","XQ81",81,0)
 ;
"RTN","XQ81",82,0)
SEC S XQL="P"_XQBLD Q:$D(^TMP("XQO",$J,XQL))  D RD3 Q
"RTN","XQ81",83,0)
 S XQL="P" F XQN=0:0 S XQL=$O(^TMP("XQO",$J,XQL)) Q:$E(XQL)'="P"  I $D(^TMP("XQO",$J,XQL,"^",XQBLD)) Q
"RTN","XQ81",84,0)
 D:$E(XQL)'="P" RD3
"RTN","XQ81",85,0)
 Q
"RTN","XQ81",86,0)
 ;
"RTN","XQ81",87,0)
VER I $D(XQFG) D
"RTN","XQ81",88,0)
 .N XQMT,XQOPNM
"RTN","XQ81",89,0)
 .S XQK=$P(^TMP($J,XQBLD),U,2)
"RTN","XQ81",90,0)
 .S:$L(XQK) XQK=$E(XQK,4,5)_"/"_$E(XQK,6,7)_"/"_$E(XQK,2,3)
"RTN","XQ81",91,0)
 .S XQOPNM=$P(XQJ,U)
"RTN","XQ81",92,0)
 .S XQMT=$P(XQJ,U,2) I $L(XQMT)>28 S XQMT=$E(XQMT,1,25)_"..."
"RTN","XQ81",93,0)
 .W !,$P(XQJ,U,1)
"RTN","XQ81",94,0)
 .W:($L(XQOPNM)>20) !
"RTN","XQ81",95,0)
 .W ?20,XQMT,?49,+^TMP($J,XQBLD),?60,XQK
"RTN","XQ81",96,0)
 .Q
"RTN","XQ81",97,0)
 ;
"RTN","XQ81",98,0)
 I $D(XQFG) S:$D(^DIC(19,"AXQ","P"_XQBLD,0)) XQ81T=+^(0) I $L(XQ81T) S %H=XQ81T D YMD^%DTC S XQK=X W ?71,$E(XQK,4,5),"/",$E(XQK,6,7),"/",$E(XQK,2,3)
"RTN","XQ81",99,0)
 ;
"RTN","XQ81",100,0)
RD3 ;Update counter an rebuild it if necessary
"RTN","XQ81",101,0)
 I $D(XQFG),XPDIDVT D
"RTN","XQ81",102,0)
 .N %
"RTN","XQ81",103,0)
 .S XQNDONE=XQNDONE+1
"RTN","XQ81",104,0)
 .S %=(XQNDONE/XQNTREE)*XPDIDTOT
"RTN","XQ81",105,0)
 .D UPDATE^XPDID(%)
"RTN","XQ81",106,0)
 .Q
"RTN","XQ81",107,0)
 ;
"RTN","XQ81",108,0)
 S XQDIC="P"_XQBLD D CHK^XQ8 I XQRE W:$D(XQFG) !,"SOMEONE ELSE IS CURRENTLY REBUILDING THIS MENU" Q
"RTN","XQ81",109,0)
 I XQVE,XQSEC S DIR(0)="Y",DIR("A")="Rebuild",DIR("B")="YES" D ^DIR Q:$D(DIRUT)  W ! Q:Y'=1
"RTN","XQ81",110,0)
 S XQFG1=1 D PM2^XQ8
"RTN","XQ81",111,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ81",112,0)
 Q
"RTN","XQ81",113,0)
 ;
"RTN","XQ81",114,0)
SET G:'$D(^VA(200,XQI,201)) SET1 S XQK=+^(201) Q:'$L(XQK)  ;I $D(XQFG) W:'(XQI#10) "."
"RTN","XQ81",115,0)
 S XQR="" S:$D(^VA(200,XQI,1.1)) XQR=$P(^(1.1),".",1) S XQP=1_U_XQR
"RTN","XQ81",116,0)
 I $D(^TMP($J,XQK)) S XQP=^TMP($J,XQK) S XQP=XQP+1_U_$S(XQR>$P(XQP,U,2):XQR,1:$P(XQP,U,2))
"RTN","XQ81",117,0)
 I $D(^DIC(19,XQK,0)),$P(^(0),U,4)="M" S ^TMP($J,XQK)=XQP
"RTN","XQ81",118,0)
 ;
"RTN","XQ81",119,0)
SET1 I XQBSEC F XQN=0:0 S XQN=$O(^VA(200,XQI,203,XQN)) Q:XQN'>0  S XQL=+^(XQN,0) I $D(^DIC(19,XQL,0)),$P(^(0),U,4)="M" S ^TMP($J,"SEC",XQL)=""
"RTN","XQ81",120,0)
 Q
"RTN","XQ81",121,0)
 ;
"RTN","XQ81",122,0)
QUE ;Entry point for the option XQBUILDTREEQUE, and XQBUILDALL
"RTN","XQ81",123,0)
 ;Also called by CHEK^XQ83
"RTN","XQ81",124,0)
 S XQVE=0,XQBSEC=1 K XQFG
"RTN","XQ81",125,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",126,0)
 G DQ
"RTN","XQ81",127,0)
 ;
"RTN","XQ81",128,0)
BLDEND ;File a report, cleanup, and quit.
"RTN","XQ81",129,0)
 ;
"RTN","XQ81",130,0)
 K %,%H,%TG,C,D,DIC,DIR,I,J,K,L,V,XQBSEC,X,Y,Z,XQL,XQN,XQRE,XQK,XQI,XQII,UU,XQH,XQPX,XQSAV,XQXUF,XQ81T,XQDATE,XQSEC,XQVE,XQBLD,XQP,XQR,XQJ
"RTN","XQ81",131,0)
 ;
"RTN","XQ81",132,0)
 I $D(XQALLDON) K XQALLDON Q  ;Quit here if we're just creating a task
"RTN","XQ81",133,0)
 ;
"RTN","XQ81",134,0)
 D MERGET
"RTN","XQ81",135,0)
 D CLEAN
"RTN","XQ81",136,0)
 D MERGEX
"RTN","XQ81",137,0)
 ;
"RTN","XQ81",138,0)
 K ^TMP($J),^TMP("XQO",$J)
"RTN","XQ81",139,0)
 ;
"RTN","XQ81",140,0)
 ;Clear the flags and locks.
"RTN","XQ81",141,0)
 K ^DIC(19,"AXQ","P0","STOP") ;Allow Micro surgery to start up
"RTN","XQ81",142,0)
 K ^DIC(19,"AXQ","P0") ;Clear the rebuild flag (redundant, I know)
"RTN","XQ81",143,0)
 L -^DIC(19,"AXQ","P0") ;Unlock the rebuild flag, everybody's good to go
"RTN","XQ81",144,0)
 ;
"RTN","XQ81",145,0)
 S %=$S($D(XPDNM):"KIDS",$D(ZTSK):"QUEUED",1:"LIVE")
"RTN","XQ81",146,0)
 D REPORT^XQ84(%)
"RTN","XQ81",147,0)
 K XQSTART,ZTSK
"RTN","XQ81",148,0)
 ;
"RTN","XQ81",149,0)
 I '$D(XPDIDVT) K XQFG Q
"RTN","XQ81",150,0)
 ;
"RTN","XQ81",151,0)
 I $D(XQFG),XPDIDVT F %=((XQNDONE/XQNTREE)*XPDIDTOT):1:XPDIDTOT D UPDATE^XPDID(%) H .25
"RTN","XQ81",152,0)
 I $D(XQFG),XPDIDVT D UPDATE^XPDID(XPDIDTOT)
"RTN","XQ81",153,0)
 I $D(XQFG) W !!,"Menu Rebuild Complete:  ",$$HTE^XLFDT($H)
"RTN","XQ81",154,0)
 ;
"RTN","XQ81",155,0)
 ;
"RTN","XQ81",156,0)
 H 2
"RTN","XQ81",157,0)
 ;If we're not from KIDS then clean it up, otherwise let kids do it.
"RTN","XQ81",158,0)
 I '$D(XPDNM) D
"RTN","XQ81",159,0)
 .D EXIT^XPDID()
"RTN","XQ81",160,0)
 .K XPDIDVT,XPDIDTOT
"RTN","XQ81",161,0)
 .Q
"RTN","XQ81",162,0)
 ;
"RTN","XQ81",163,0)
 I $D(XQSAVTOT) S XPDIDTOT=XQSAVTOT
"RTN","XQ81",164,0)
 K %,VALMCOFF,VALMCON,VALMIOXY,VALMSGR,VALMWD,XQFG,XQNDONE,XQNTREE,XQSAVTOT
"RTN","XQ81",165,0)
 Q
"RTN","XQ81",166,0)
 ;
"RTN","XQ81",167,0)
 ;================================Subroutines==========================
"RTN","XQ81",168,0)
 ;
"RTN","XQ81",169,0)
MERGET ;Merge ^TMP("XQO",$J) into ^DIC(19,"AXQ")
"RTN","XQ81",170,0)
 N X,XQFLAG S X="P",XQFLAG=0
"RTN","XQ81",171,0)
 I $D(XQFG) W !!,"Merging...."
"RTN","XQ81",172,0)
 F  S X=$O(^TMP("XQO",$J,X)) Q:X=""  D
"RTN","XQ81",173,0)
 .L +^DIC(19,"AXQ",X):5 I '$T S XQFLAG=1 Q
"RTN","XQ81",174,0)
 .K ^DIC(19,"AXQ",X)
"RTN","XQ81",175,0)
 .M ^DIC(19,"AXQ",X)=^TMP("XQO",$J,X)
"RTN","XQ81",176,0)
 .L -^DIC(19,"AXQ",X)
"RTN","XQ81",177,0)
 .Q
"RTN","XQ81",178,0)
 I XQFLAG G MERGET
"RTN","XQ81",179,0)
 Q
"RTN","XQ81",180,0)
 ;
"RTN","XQ81",181,0)
CLEAN ;Clean out unused menu trees from ^DIC(19,"AXQ")
"RTN","XQ81",182,0)
 N X,Y S X="P"
"RTN","XQ81",183,0)
 F  S X=$O(^DIC(19,"AXQ",X)) Q:X=""  D
"RTN","XQ81",184,0)
 .I X'="PXU" D
"RTN","XQ81",185,0)
 ..S Y=$E(X,2,99)
"RTN","XQ81",186,0)
 ..I '$D(^TMP($J,Y))&('$D(^TMP($J,"SEC",Y))) K ^DIC(19,"AXQ",X),^XUTL("XQO",X)
"RTN","XQ81",187,0)
 ..Q
"RTN","XQ81",188,0)
 .Q
"RTN","XQ81",189,0)
 Q
"RTN","XQ81",190,0)
 ;
"RTN","XQ81",191,0)
MERGEX ;Merge ^DIC(19,"AXQ") into ^XUTL("XQO")
"RTN","XQ81",192,0)
 N X,XQFLAG S X="P",XQFLAG=0
"RTN","XQ81",193,0)
 F  S X=$O(^DIC(19,"AXQ",X)) Q:X=""  D
"RTN","XQ81",194,0)
 .L +^XUTL("XQO",X):5 I '$T S XQFLAG=1 Q
"RTN","XQ81",195,0)
 .K ^XUTL("XQO",X)
"RTN","XQ81",196,0)
 .M ^XUTL("XQO",X)=^DIC(19,"AXQ",X)
"RTN","XQ81",197,0)
 .L -^XUTL("XQO",X)
"RTN","XQ81",198,0)
 .Q
"RTN","XQ81",199,0)
 I XQFLAG G MERGEX
"RTN","XQ81",200,0)
 I $D(XQFG) W " done."
"RTN","XQ81",201,0)
 Q
"RTN","XQ81",202,0)
 ;
"RTN","XQ81",203,0)
STATUS()  ;Are the menus being rebuilt even as we speak?
"RTN","XQ81",204,0)
 N %,XQTHEN
"RTN","XQ81",205,0)
 S %=$G(^DIC(19,"AXQ","P0")) I %="" Q 1  ;It finished.  Never mind.
"RTN","XQ81",206,0)
 L +^DIC(19,"AXQ","P0"):0 ;If job is still running we can't lock it
"RTN","XQ81",207,0)
 I $T L -^DIC(19,"AXQ","P0") K ^("P0") Q 1  ;Job must have failed
"RTN","XQ81",208,0)
 Q 0
"RTN","XQ81",209,0)
 ;
"RTN","XQ81",210,0)
 ;
"RTN","XQ81",211,0)
MICRO ;Turn off micro surgery
"RTN","XQ81",212,0)
 I $D(^DIC(19,"AXQ","P0","MICRO")) D
"RTN","XQ81",213,0)
 .S ^DIC(19,"AXQ","P0","STOP")=$H ;Turn off micro-surgery
"RTN","XQ81",214,0)
 .K ^DIC(19,"AXQ","P0","MICRO")
"RTN","XQ81",215,0)
 .H 2
"RTN","XQ81",216,0)
 .Q
"RTN","XQ81",217,0)
 Q
"RTN","XQ81",218,0)
 ;
"RTN","XQ81",219,0)
 ;
"RTN","XQ81",220,0)
ERR ;Come here on error
"RTN","XQ81",221,0)
 N XQERROR
"RTN","XQ81",222,0)
 S XQERROR=$$EC^%ZOSV
"RTN","XQ81",223,0)
 D ^%ZTER
"RTN","XQ81",224,0)
 D EXIT^XPDID()
"RTN","XQ81",225,0)
 G UNWIND^%ZTER
"RTN","XQ81",226,0)
 Q
"RTN","XQ82")
0^20^B5592001
"RTN","XQ82",1,0)
XQ82 ;SF-ISC.SEA/JLI - CLEAN OLD $JOB DATA OUT OF XUTL("XQ", & OTHERS ;04/16/2002  14:14
"RTN","XQ82",2,0)
 ;;8.0;KERNEL;**59,67,157**;Jul 10, 1995
"RTN","XQ82",3,0)
 S DDATE=$$HTFM^XLFDT($H-7) ;Get seven days ago in FM format
"RTN","XQ82",4,0)
 ;For any entry in user stack w/ date older than 7 days or w/o zero node
"RTN","XQ82",5,0)
 ;kill XUTL("XQ",n) and corresponding UTILITY(n) and TMP(n) nodes.
"RTN","XQ82",6,0)
 F J=0:0 S J=$O(^XUTL("XQ",J)) Q:J'>0  I $S('$D(^(J,0)):1,1:^(0)<DDATE) D
"RTN","XQ82",7,0)
 . I $D(^XUTL("XQ",J,"ZTSKNUM")) L +^%ZTSCH("TASK",^XUTL("XQ",J,"ZTSKNUM")):0 Q:'$T  L -^%ZTSCH("TASK",^XUTL("XQ",J,"ZTSKNUM"))
"RTN","XQ82",8,0)
 . K ^XUTL("XQ",J),^UTILITY(J),^TMP(J)
"RTN","XQ82",9,0)
 . Q
"RTN","XQ82",10,0)
 ;Loop thru UTILITY and look for nodes w/o corresponding XUTL("XQ",n)
"RTN","XQ82",11,0)
L1 S A="" F  S A=$O(^UTILITY(A)) Q:A=""  D
"RTN","XQ82",12,0)
 . I A>0,'$D(^XUTL("XQ",A)) K ^UTILITY(A) Q  ;UTILITY($J) w/o XUTL("XQ",$J) node.
"RTN","XQ82",13,0)
 . Q:A>0  Q:"^ROU^GLO^LRLTR^"[("^"_A_"^")
"RTN","XQ82",14,0)
 . F J=0:0 S J=$O(^UTILITY(A,J)) Q:J'>0  I '$D(^XUTL("XQ",J)) K ^UTILITY(A,J) ;Remove UTILITY(namespace,$J) w/o XUTL("XQ",$J)
"RTN","XQ82",15,0)
 . Q
"RTN","XQ82",16,0)
 ;Loop thru TMP and look for nodes w/o corresponding XUTL("XQ",n)
"RTN","XQ82",17,0)
L2 S A="" F  S A=$O(^TMP(A)) Q:A=""  D
"RTN","XQ82",18,0)
 . I A>0,'$D(^XUTL("XQ",A)) K ^TMP(A) Q  ;TMP($J) w/o XUTL("XQ",$J) node.
"RTN","XQ82",19,0)
 . Q:A>0  ;Q:"^ROU^GLO^LRLTR^"[("^"_A_"^")
"RTN","XQ82",20,0)
 . F J=0:0 S J=$O(^TMP(A,J)) Q:J'>0  I '$D(^XUTL("XQ",J)) K ^TMP(A,J) ;Remove TMP(namespace,$J) w/o XUTL("XQ",$J)
"RTN","XQ82",21,0)
 . Q
"RTN","XQ82",22,0)
L3 ;Now to cleanup the XTMP global w/ XTMP(namespace,0)<DT
"RTN","XQ82",23,0)
 S A="" F  S A=$O(^XTMP(A)) Q:A=""  S J=$G(^XTMP(A,0)) I J<DT K ^XTMP(A)
"RTN","XQ82",24,0)
L4 ;Now go thru and clean old ^XUSEC(0,"CUR",duz,sign-on) nodes.
"RTN","XQ82",25,0)
 F I=0:0 S I=$O(^XUSEC(0,"CUR",I)) Q:I'>0  F J=0:0 S J=$O(^XUSEC(0,"CUR",I,J)) Q:(J'>0)!(J'<DDATE)  K ^XUSEC(0,"CUR",I,J)
"RTN","XQ82",26,0)
L5 ;Now go through and clean old ^XUSEC(0,"AS*" nodes.
"RTN","XQ82",27,0)
 D L51("AS1"),L51("AS2")
"RTN","XQ82",28,0)
L6 ;Clean out old build nodes from ^XUTL
"RTN","XQ82",29,0)
 S K="" F  S K=$O(^XUTL("XQO",K)) Q:K=""  I $D(^XUTL("XQO",K,"^BUILD")),($P($H,",",2)-^("^BUILD")>1800)!(^("^BUILD")>$P($H,",",2)) K ^("^BUILD")
"RTN","XQ82",30,0)
EXIT ;
"RTN","XQ82",31,0)
 K X,%DT,Y,J,K,DDATE
"RTN","XQ82",32,0)
 Q
"RTN","XQ82",33,0)
L51(NDX) ;
"RTN","XQ82",34,0)
 S I="" F  S I=$O(^XUSEC(0,NDX,I)) Q:I=""  F J=0:0 S J=$O(^XUSEC(0,NDX,I,J)) Q:(J'>0)!(J'<DDATE)  K ^XUSEC(0,NDX,I,J)
"RTN","XQ82",35,0)
 Q
"RTN","XQ83")
0^6^B32147680
"RTN","XQ83",1,0)
XQ83 ;SF-ISC.SEA/JLI/LUKE - FIND ^XUTL NODES NEEDING SURGERY ;04/18/2002  10:28
"RTN","XQ83",2,0)
 ;;8.0;KERNEL;**60,157**;Jul 10, 1995
"RTN","XQ83",3,0)
 Q
"RTN","XQ83",4,0)
DQ ;TaskMan entry fired by CHEK below
"RTN","XQ83",5,0)
 ;
"RTN","XQ83",6,0)
 Q:'$D(^DIC(19,"AT"))  ;Nothing to do
"RTN","XQ83",7,0)
 ;
"RTN","XQ83",8,0)
 I $D(^DIC(19,"AXQ","P0"))=1 D  ;Somebody is rebuilding menus
"RTN","XQ83",9,0)
 .L +^DIC(19,"AXQ","P0"):0 ;If we can lock it the flag is bogus
"RTN","XQ83",10,0)
 .I $T L -^DIC(19,"AXQ","P0") K ^DIC(19,"AXQ","P0")
"RTN","XQ83",11,0)
 .Q
"RTN","XQ83",12,0)
 Q:$D(^DIC(19,"AXQ","P0"))=1
"RTN","XQ83",13,0)
 ;
"RTN","XQ83",14,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) D
"RTN","XQ83",15,0)
 .N X,Y,Z
"RTN","XQ83",16,0)
 .S X=$G(^DIC(19,"AXQ","P0","STOP")) Q:X=""
"RTN","XQ83",17,0)
 .S Y=$H
"RTN","XQ83",18,0)
 .S Z=$$HDIFF^XLFDT(Y,X,1)
"RTN","XQ83",19,0)
 .I Z>0 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag left over from yesterday
"RTN","XQ83",20,0)
 .S Z=$$HDIFF^XLFDT(Y,X,2)
"RTN","XQ83",21,0)
 .I Z>11000 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag is over 2 hours old
"RTN","XQ83",22,0)
 .Q
"RTN","XQ83",23,0)
 Q:$D(^DIC(19,"AXQ","P0","STOP"))  ;Rebuilding - stop micro surgery
"RTN","XQ83",24,0)
 ;
"RTN","XQ83",25,0)
 S ^DIC(19,"AXQ","P0","MICRO")=$H ;Set the 'I am working' flag.
"RTN","XQ83",26,0)
 ;
"RTN","XQ83",27,0)
 D NOW^%DTC ;Returns: %=3010706.131332, %H=58626,47612, X=3010706
"RTN","XQ83",28,0)
 S X=% S %XQT1=X H 2
"RTN","XQ83",29,0)
 S XQSTART=$$HTE^XLFDT($H) ;Returns: Jul 06, 2001@13:19:20
"RTN","XQ83",30,0)
 ;
"RTN","XQ83",31,0)
 S X1=X,X2=-21 D C^%DTC F %K=0:0 S %K=$O(^DIC(19,"AT",%K)) Q:%K'>0!(%K'<X)  K ^(%K) ;Kill of those that are 21 says old
"RTN","XQ83",32,0)
 S X=DT+2 F  S X=$O(^DIC(19,"AT",X)) Q:X'>0  S %K="" F  S %K=$O(^DIC(19,"AT",X,%K)) Q:%K=""  K ^(%K) S ^DIC(19,"AT",$$NOW^XLFDT(),%K)=""
"RTN","XQ83",33,0)
 ;Kill off old "AT" nodes
"RTN","XQ83",34,0)
 ;
"RTN","XQ83",35,0)
LOOP ;Main loop
"RTN","XQ83",36,0)
 ;
"RTN","XQ83",37,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) G KILL
"RTN","XQ83",38,0)
 K ^TMP($J) S X=%XQT,%XQX="",N=0 F %K=X:0 S %K=$O(^DIC(19,"AT",%K)) Q:%K'>0!(%K>%XQT1)  S %XQT=%K,%Z="" F %J=0:0 S %Z=$O(^DIC(19,"AT",%K,%Z)) Q:%Z=""  S N=N+1,^TMP($J,N,%Z)="",^TMP($J,"A",%Z,N)=""
"RTN","XQ83",39,0)
 ;$O through "AT" and set up lists in ^TMP, ^TMP($J,"A" is the XREF
"RTN","XQ83",40,0)
 ;
"RTN","XQ83",41,0)
 I '$D(^TMP($J)) S XQN="P0",X=%XQT D H^%DTC S %XQT=%H_","_%T F %K=0:0 S XQN=$O(^XUTL("XQO",XQN)) Q:$E(XQN)'="P"  S ^(XQN,0)=%XQT
"RTN","XQ83",42,0)
 I '$D(^TMP($J)) G KILL
"RTN","XQ83",43,0)
 ;If nothing appears in TMP quit
"RTN","XQ83",44,0)
 ;
"RTN","XQ83",45,0)
 S %Z="" F %K=0:0 S %Z=$O(^TMP($J,"A",%Z)) Q:%Z=""  F N=0:0 S N=$O(^TMP($J,"A",%Z,N)) Q:N'>0  I $O(^(N))>0 K ^TMP($J,N)
"RTN","XQ83",46,0)
 ;F N=0:0 S N=$O(^TMP($J,N)) Q:N'>0  S %Z=$O(^(N,"")),%X1=+%Z,%XC=$E(%Z,$L(%X1)+1,99),%X2=$E(%XC,2,99),XJ=$S(%XC="DIFROM":"DNUL",%XC["I":"DINS",%XC["D":"DDEL",%Z=+%Z:"DREG",%XC["S":"DSYN",%XC["P":"DPRI",1:"DNUL") D @XJ
"RTN","XQ83",47,0)
 F XQXM=0:0 S XQXM=$O(^TMP($J,XQXM)) Q:XQXM'>0  S XQOP=$O(^(XQXM,"")),XQENT=$S(XQOP["S":"SYN",XQOP["I":"INS",XQOP["D":"DEL",XQOP["P":"PRI",1:"REG") D @XQENT
"RTN","XQ83",48,0)
 ;solve the entry for the type of operation needs to be performed and
"RTN","XQ83",49,0)
 ; to that code below.
"RTN","XQ83",50,0)
 ;Remove the "AT" nodes that we processed
"RTN","XQ83",51,0)
 F XQI=0:0 S XQI=$O(^DIC(19,"AT",XQI)) Q:(XQI'<%XQT1)!(XQI<1)  K ^(XQI)
"RTN","XQ83",52,0)
 D NOW^%DTC S %XQT=%XQT1 S:%=0 %="" S %XQT1=X H 2
"RTN","XQ83",53,0)
 G LOOP
"RTN","XQ83",54,0)
 ;
"RTN","XQ83",55,0)
DINS F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"D"_%X2)))!$D(^(%X1))!$D(^(%X2)) K ^TMP($J,N) Q
"RTN","XQ83",56,0)
 I $D(^TMP($J,N)) F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"S"_%X2))) K ^TMP($J,%M)
"RTN","XQ83",57,0)
 Q
"RTN","XQ83",58,0)
DDEL F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"I"_%X2))) K ^TMP($J,N) Q
"RTN","XQ83",59,0)
 I $D(^TMP($J,N)) F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"S"_%X2))) K ^TMP($J,%M)
"RTN","XQ83",60,0)
 Q
"RTN","XQ83",61,0)
DREG F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  S X=$O(^(%M,"")) I X[("I"_%X2)!(X[("S"_%X2)) K ^TMP($J,%M)
"RTN","XQ83",62,0)
 Q
"RTN","XQ83",63,0)
DSYN F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  S X=$O(^(%M,"")) I X=%X2!(X=(%X1_"I"_%X2)) K ^TMP($J,N) Q
"RTN","XQ83",64,0)
 Q
"RTN","XQ83",65,0)
DNUL K ^TMP($J,N)
"RTN","XQ83",66,0)
DPRI Q
"RTN","XQ83",67,0)
 ;
"RTN","XQ83",68,0)
DEL S XQC="D" D SPLIT D ^XQ83D Q
"RTN","XQ83",69,0)
 ;
"RTN","XQ83",70,0)
DIFROM S XQH=%XQT D QUE^XQ81
"RTN","XQ83",71,0)
 G KILL
"RTN","XQ83",72,0)
 ;
"RTN","XQ83",73,0)
INS S XQC="I" D SPLIT D ^XQ83A Q
"RTN","XQ83",74,0)
 ;
"RTN","XQ83",75,0)
SYN S XQC="S" D SPLIT D SYN^XQ83R Q
"RTN","XQ83",76,0)
 ;
"RTN","XQ83",77,0)
REG S XQC="" D REG^XQ83R Q
"RTN","XQ83",78,0)
 ;
"RTN","XQ83",79,0)
PRI ; Enter a new Primary menu
"RTN","XQ83",80,0)
 S XQC="P" D SPLIT S (A,XQDIC)="P"_XQOPM,XQVE=0,XQRB=0,XQFG1=1 K XQFG L +^XUTL("XQO",A) D PM1^XQ8 S ^XUTL("XQO",XQDIC,0)=%XQT1 L -^XUTL("XQO",XQDIC)
"RTN","XQ83",81,0)
 Q
"RTN","XQ83",82,0)
 ;
"RTN","XQ83",83,0)
SPLIT S XQOPM=+XQOP,XQOPI=+$P(XQOP,XQC,2),XQC1=XQOPM_","_XQOPI_",",XQC2=","_XQC1,XQOPI1=XQOPI_",",XQOPI2=","_XQOPI1 Q
"RTN","XQ83",84,0)
 ;
"RTN","XQ83",85,0)
 ;
"RTN","XQ83",86,0)
CHEKV ;First see if the compiled menus live on this system
"RTN","XQ83",87,0)
 ;If so fall through to CHEK, else quit (called by XQOO*)
"RTN","XQ83",88,0)
 Q:'$D(^XUTL("XQO"))
"RTN","XQ83",89,0)
 ;
"RTN","XQ83",90,0)
CHEK ;See if microsurgery needs to be run here
"RTN","XQ83",91,0)
 ;Called by XUS+25 and XUSG+18
"RTN","XQ83",92,0)
 ;Also kicked off by the option XQKICKMICRO
"RTN","XQ83",93,0)
 ;
"RTN","XQ83",94,0)
 Q:'$D(^DIC(19,"AT"))  ;Nothing to do
"RTN","XQ83",95,0)
 ;
"RTN","XQ83",96,0)
 I $D(^DIC(19,"AXQ","P0"))=1 D  ;Somebody is rebuilding menus
"RTN","XQ83",97,0)
 .L +^DIC(19,"AXQ","P0"):0 ;If we can lock it the flag is bogus
"RTN","XQ83",98,0)
 .I $T L -^DIC(19,"AXQ","P0") K ^DIC(19,"AXQ","P0")
"RTN","XQ83",99,0)
 .Q
"RTN","XQ83",100,0)
 Q:$D(^DIC(19,"AXQ","P0"))=1
"RTN","XQ83",101,0)
 ;
"RTN","XQ83",102,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) D
"RTN","XQ83",103,0)
 .N X,Y,Z
"RTN","XQ83",104,0)
 .S X=$G(^DIC(19,"AXQ","P0","STOP")) Q:X=""
"RTN","XQ83",105,0)
 .S Y=$H
"RTN","XQ83",106,0)
 .S Z=$$HDIFF^XLFDT(Y,X,1)
"RTN","XQ83",107,0)
 .I Z>0 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag left over from yesterday
"RTN","XQ83",108,0)
 .S Z=$$HDIFF^XLFDT(Y,X,2)
"RTN","XQ83",109,0)
 .I Z>11000 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag is over 2 hours old
"RTN","XQ83",110,0)
 .Q
"RTN","XQ83",111,0)
 Q:$D(^DIC(19,"AXQ","P0","STOP"))  ;Rebuilding - stop micro surgery
"RTN","XQ83",112,0)
 ;
"RTN","XQ83",113,0)
 ;If the compiled menus do not exist on "AXQ" rebuild all of them
"RTN","XQ83",114,0)
 S %XQH=$O(^DIC(19,"AXQ","P")) I %XQH'["P" D  Q
"RTN","XQ83",115,0)
 .;S ^DIC(19,"AXQ","P0")=$H
"RTN","XQ83",116,0)
 .S ZTIO="",ZTDTH=$H,ZTRTN="QUE^XQ81",ZTSAVE("DUZ")=.5
"RTN","XQ83",117,0)
 .D SETVOL
"RTN","XQ83",118,0)
 .D ^%ZTLOAD
"RTN","XQ83",119,0)
 .Q
"RTN","XQ83",120,0)
 ;
"RTN","XQ83",121,0)
 Q:'$D(^XUTL("XQO",%XQH,0))  L ^XUTL("XQO",%XQH,0):0 I '$T K %XQH Q
"RTN","XQ83",122,0)
 ;If the first menu has a 0th node lock it, if it won't lock quit
"RTN","XQ83",123,0)
 N X S %H=$P(^XUTL("XQO",%XQH,0),U,1) D YMD^%DTC S:%>.001 %=%-.001 S:%=0 %="" S %XQT=X_%
"RTN","XQ83",124,0)
 ;Get date off first entry set %XQT (looks like: 3000414.081043)
"RTN","XQ83",125,0)
 S %XQX="",%ZO="" S:'$D(XQM) XQM=+$G(^VA(200,DUZ,201)) I XQM>0,'$D(^XUTL("XQO","P"_XQM)) S %XQX=XQM_"P",^DIC(19,"AT",%XQT+.0001,%XQX)=""
"RTN","XQ83",126,0)
 ;Set Primary menu of this user, if not there flag it in "AT" it looks
"RTN","XQ83",127,0)
 ;  like this: ^DIC(19,"AT",3000414.081143,9P)
"RTN","XQ83",128,0)
 ;I $O(^DIC(19,"AT",%XQT))>0
"RTN","XQ83",129,0)
 ;
"RTN","XQ83",130,0)
 S ^DIC(19,"AXQ","P0","MICRO")=$H,%XQX=1
"RTN","XQ83",131,0)
 S %TIM=$P($H,",")-1_","_$P($H,",",2)
"RTN","XQ83",132,0)
 L -^XUTL("XQO",%XQH,0)
"RTN","XQ83",133,0)
 ;
"RTN","XQ83",134,0)
 G DQ
"RTN","XQ83",135,0)
 ;******************************************************
"RTN","XQ83",136,0)
 ;
"RTN","XQ83",137,0)
 S ZTDESC="MICRO UPDATING XUTL",ZTRTN="DQ^XQ83",ZTSAVE("%XQT")="",ZTSAVE("DUZ")=.5,ZTDTH=%TIM,ZTIO="" D:'$D(ZTCPU) SETVOL D ^%ZTLOAD
"RTN","XQ83",138,0)
 ;Unlock the node and task off DQ above and quit
"RTN","XQ83",139,0)
 ;
"RTN","XQ83",140,0)
 Q
"RTN","XQ83",141,0)
SETVOL ;
"RTN","XQ83",142,0)
 X ^%ZOSF("UCI") S ZTCPU=$P(Y,",",2),ZTUCI=$P(Y,",")
"RTN","XQ83",143,0)
 Q
"RTN","XQ83",144,0)
 ;
"RTN","XQ83",145,0)
KILL D REPORT^XQ84("MICRO")
"RTN","XQ83",146,0)
 K ^DIC(19,"AXQ","P0","MICRO")
"RTN","XQ83",147,0)
 ;
"RTN","XQ83",148,0)
 K %,%H,%XQH,%I,%T,%XQA,%XQX,%XQT,%XQX1,%XQX2,%XQY,A,B,I,I0,%Z,%ZO
"RTN","XQ83",149,0)
 K J,K,M,N,P,X,XQA,XQC,XQC1,XQC2,XQE,XQENT,XQK,XQOP,XQOPI,XQOPI1,XQOPI2
"RTN","XQ83",150,0)
 K XQI,XQOPM,XQOPS,XQP,XQXM,Y
"RTN","XQ83",151,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ83",152,0)
 Q
"RTN","XQ83A")
0^7^B26531678
"RTN","XQ83A",1,0)
XQ83A ;ISC-SF..SEA/JLI,LUKE - MICROSURGERY ON MENU TREES TO ADD A NEW ITEM TO A MENU ;06/26/2000  09:14
"RTN","XQ83A",2,0)
 ;;8.0;KERNEL;**157**;Jul 10, 1995
"RTN","XQ83A",3,0)
ENTRY ;
"RTN","XQ83A",4,0)
 D TABLE
"RTN","XQ83A",5,0)
 I XQC'="P" S A="P" F XQJ=0:0 S A=$O(^DIC(19,"AXP",A)) Q:$E(A)'="P"  I $D(^(A,U,XQOPM)) L +^DIC(19,"AXP",A) K ^(A,0) D ADD S ^DIC(19,"AXP",A,0)=%XQT1 L -^DIC(19,"AXP",A)
"RTN","XQ83A",6,0)
 K L,M,N,P,R,S,T,XQJ,XQLAST,XQLM,XQLM1,XQNAM,XQNAME,XQNEW,XQOLD,XQP1,XQP2,XQPATH,XQSYN
"RTN","XQ83A",7,0)
 Q
"RTN","XQ83A",8,0)
TABLE ;
"RTN","XQ83A",9,0)
 K ^TMP($J,"NEW"),^("S2"),^("PATH") Q:'$D(^DIC(19,XQOPI,0))
"RTN","XQ83A",10,0)
 S ^TMP($J,"NEW",1,1)=XQOPI_",",S2=^DIC(19,XQOPI,0) S:$P(S2,U,3)'="" $P(S2,U,6)=" OOO " K SU S:$D(^("U")) SU=^("U")
"RTN","XQ83A",11,0)
 S XQP="" F IJ=0:0 S IJ=$O(^DIC(19,XQOPI,3.91,IJ)) Q:IJ'>0  I ($D(^(IJ,0))#2),$P(^(0),U)'="" S XQP=$S(XQP="":"",1:XQP_",")_$P(^(0),U)_$P(^(0),U,2)
"RTN","XQ83A",12,0)
 S:XQP'="" $P(S2,U,9)=XQP S ^TMP($J,"S2",XQOPI)=S2 S:$D(SU) ^(XQOPI,"U")=SU I XQC="P" S XQNEW=XQOPM,XQOLD="",N=1,S=1 D XPAND
"RTN","XQ83A",13,0)
 F J=0:0 S J=$O(^TMP($J,"NEW",J)),N=J+1,S=1 Q:J'>0  F K=0:0 S K=$O(^TMP($J,"NEW",J,K)) Q:K'>0  S XQOLD=^(K),XQNEW=+$P(XQOLD,",",J) I $D(^DIC(19,XQNEW,10)) D XPAND
"RTN","XQ83A",14,0)
 D PATHS K ^TMP($J,"OLD"),^("NEW"),^("S2")
"RTN","XQ83A",15,0)
 Q
"RTN","XQ83A",16,0)
 ;
"RTN","XQ83A",17,0)
XPAND ; eXPAND option into subtree, if it is a menu
"RTN","XQ83A",18,0)
 F L=0:0 S L=$O(^DIC(19,XQNEW,10,L)) Q:L'>0  S T=+^(L,0),S1=$P(^(0),U,2),S2=^DIC(19,T,0) S:$P(S2,U,3)'="" $P(S2,U,6)=" OOO " I XQC2'[(","_T_",")&(XQOLD'[(","_T_",")) D X1
"RTN","XQ83A",19,0)
 K S1,S2
"RTN","XQ83A",20,0)
 Q
"RTN","XQ83A",21,0)
X1 ;
"RTN","XQ83A",22,0)
 S ^TMP($J,"NEW",N,S)=XQOLD_T_"," S:S1'="" ^(S,"S")=S1 S S=S+1 Q:$D(^TMP($J,"S2",T))  S ^(T)=S2 S:$D(^DIC(19,T,"U")) ^TMP($J,"S2",T,"U")=^("U")
"RTN","XQ83A",23,0)
 S XQP="" I $D(^DIC(19,T,3.91)) F IJ=0:0 S IJ=$O(^DIC(19,T,3.91,IJ)) Q:IJ'>0  I ($D(^(IJ,0))#2),$P(^(0),U,1)'="" S XQP=$S(XQP="":"",1:XQP_",")_$P(^(0),U,1)_$P(^(0),U,2)
"RTN","XQ83A",24,0)
 I XQP'="" S $P(^TMP($J,"S2",T),U,9)=XQP
"RTN","XQ83A",25,0)
 Q
"RTN","XQ83A",26,0)
PATHS ;
"RTN","XQ83A",27,0)
 F I=0:0 S I=$O(^TMP($J,"NEW",I)) Q:I'>0  F J=0:0 S J=$O(^TMP($J,"NEW",I,J)) Q:J'>0  S PATH=^(J),SYN=$S($D(^(J,"S")):^("S"),1:"") D PATH1
"RTN","XQ83A",28,0)
 Q
"RTN","XQ83A",29,0)
PATH1 ;
"RTN","XQ83A",30,0)
 S T=$P(PATH,",",I),NPATH=$P(PATH,",",1,I-1)_",",BASE=$S(NPATH'=",":^TMP($J,"PATH",NPATH),1:"")
"RTN","XQ83A",31,0)
 S XQK=$P(BASE,U,7),XQE=$P(BASE,U,11),XQP=$P(BASE,U,10),XQF=$P(BASE,U,17)
"RTN","XQ83A",32,0)
 S NEW=^TMP($J,"S2",T),XQUC=$S($D(^(T,"U")):^("U"),1:"")
"RTN","XQ83A",33,0)
 S XQK1=$P(NEW,U,6),XQE1=$P(NEW,U,10),XQP1=$P(NEW,U,9),XQF1="" I $P(NEW,U,16),$D(^DIC(19,T,3)) S XQF1=$P(^(3),U)
"RTN","XQ83A",34,0)
 S XQK=$S(XQK'=""&(XQK1'=""):XQK_","_XQK1,1:XQK_XQK1),XQE=$S(XQE'=""&(XQE1'=""):XQE_","_XQE1,1:XQE_XQE1),XQP=$S(XQP'=""&(XQP1'=""):XQP_","_XQP,1:XQP_XQP1),XQF=$S(XQF'=""&(XQF1'=""):XQF_","_XQF1,1:XQF_XQF1)
"RTN","XQ83A",35,0)
 S ^TMP($J,"PATH",PATH)=U_$P(NEW,U,1,2)_U_$S($P(NEW,U,3)]"":1,1:"")_U_$P(NEW,U,4)_U_PATH_U_XQK_U_$P(NEW,U,7,8)_U_XQP_U_XQE_U_$P(NEW,U,11,15)_U_XQF_U_$P(NEW,U,17,99),^(PATH,"U")=XQUC,^("SYN")=SYN
"RTN","XQ83A",36,0)
 Q
"RTN","XQ83A",37,0)
 ;
"RTN","XQ83A",38,0)
ADD ;
"RTN","XQ83A",39,0)
 Q:'$D(^DIC(19,"AXP",A,U,XQOPM))  G:$D(^TMP($J,"OLD",XQOPM)) DOIT S ^TMP($J,"OLD",XQOPM,1)=^DIC(19,"AXP",A,U,XQOPM)
"RTN","XQ83A",40,0)
 S N=0 F J=2:1 S N=$O(^DIC(19,"AXP",A,U,XQOPM,0,N)) Q:N'>0  S P=^(N),$P(L,U,7)=$P(P,U,2),$P(L,U,10,11)=$P(P,U,3,4),$P(L,U,5)=$P(P,U),P=$P(^(N),U),^TMP($J,"OLD",XQOPM,J)=L F K=1:1:J-1 I $P(^TMP($J,"OLD",XQOPM,K),U,9)=P K ^(J) S J=J-1 Q
"RTN","XQ83A",41,0)
DOIT K ^TMP($J,"PATH",(XQOPI_","),"SYN") S XQ83AJ=$O(^DIC(19,XQOPM,10,"B",XQOPI,0)) Q:XQ83AJ'>0  S XQ83AJ=$P(^DIC(19,XQOPM,10,XQ83AJ,0),U,2) I XQ83AJ'="" S ^TMP($J,"PATH",(XQOPI_","),"SYN")=XQ83AJ
"RTN","XQ83A",42,0)
 F XQ83AJ=0:0 S XQ83AJ=$O(^TMP($J,"OLD",XQOPM,XQ83AJ)) Q:XQ83AJ'>0  S T=^(XQ83AJ) D ADD1
"RTN","XQ83A",43,0)
 Q
"RTN","XQ83A",44,0)
 ;
"RTN","XQ83A",45,0)
ADD1 ;
"RTN","XQ83A",46,0)
 S XQA=$P(T,U,6),XQK=$P(T,U,7),XQP=$P(T,U,10),XQE=$P(T,U,11),XQF=$P(T,U,17)
"RTN","XQ83A",47,0)
 S PATH="" F K=0:0 S PATH=$O(^TMP($J,"PATH",PATH)) Q:PATH=""  S BASE=^(PATH),XQUC=^(PATH,"U"),SYN=$S($D(^("SYN")):^("SYN"),1:"") D ADD2
"RTN","XQ83A",48,0)
 Q
"RTN","XQ83A",49,0)
 ;
"RTN","XQ83A",50,0)
ADD2 ;
"RTN","XQ83A",51,0)
 S XQK1=$P(BASE,U,7),XQP1=$P(BASE,U,10),XQE1=$P(BASE,U,11),XQF1=$P(BASE,U,17) S XQK1=$S(XQK'=""&(XQK1'=""):XQK_","_XQK1,1:XQK_XQK1),XQP1=$S(XQP'=""&(XQP1'=""):XQP_","_XQP1,1:XQP_XQP1),XQE1=$S(XQE'=""&(XQE1'=""):XQE_","_XQE1,1:XQE_XQE1)
"RTN","XQ83A",52,0)
 S XQF1=$S(XQF'=""&(XQF1'=""):XQF_","_XQF1,1:XQF_XQF1)
"RTN","XQ83A",53,0)
 S XQFLG=0,N=$L(PATH,","),T=$P(PATH,",",N-1)
"RTN","XQ83A",54,0)
 I $S('$D(^DIC(19,"AXP",A,U,T)):1,$P(^(T),U,6)=(XQA_PATH):1,1:0) S ^(T)=$P(BASE,U,1,5)_U_XQA_PATH_U_XQK1_U_$P(BASE,U,8,9)_U_XQP1_U_XQE1_U_$P(BASE,U,12,16)_U_XQF1_U_$P(BASE,U,18,99),XQFLG=1
"RTN","XQ83A",55,0)
 I 'XQFLG S BASE1=XQA_PATH_U_XQK1_U_XQP1_U_XQE1_U_XQF1 F N=0:0 S N=$O(^DIC(19,"AXP",A,U,T,0,N)) Q:N'>0  S L=N I $P(^(N),U)=(XQA_PATH) S ^(N)=BASE1,XQFLG=1 Q
"RTN","XQ83A",56,0)
 I 'XQFLG F N=1:1 I '$D(^DIC(19,"AXP",A,U,T,0,N)) S ^(N)=BASE1,^(0)=$S('($D(^DIC(19,"AXP",A,U,T,0))#2):0,1:^(0))+1 Q
"RTN","XQ83A",57,0)
 S XQSYNY=$E($S(XQUC'="":XQUC,1:$P(BASE,U,3)),1,27),V=T_U_"1" D SYN3^XQ83R
"RTN","XQ83A",58,0)
 I SYN'="" S XQSYNY=SYN,V=T_U_"0" D SYN3^XQ83R
"RTN","XQ83A",59,0)
 K V
"RTN","XQ83A",60,0)
 Q
"RTN","XQ83D")
0^8^B9411981
"RTN","XQ83D",1,0)
XQ83D ;ISC-SF..SEA/JLI - MICRO SURGERY ON MENU TREES FOR ITEM DELETED FROM MENU ;04/16/2002  13:58
"RTN","XQ83D",2,0)
 ;;8.0;KERNEL;**157**;Jul 10, 1995
"RTN","XQ83D",3,0)
 I $D(^DIC(19,+XQOPM,0)),$D(^(10,"B",+XQOPI)) S XQB=$O(^(+XQOPI,0)) I $D(^DIC(19,+XQOPM,10,XQB,0)),+^(0)=+XQOPI Q  ;  item hasn't been removed, or was put back on
"RTN","XQ83D",4,0)
 D TABLE^XQ83A
"RTN","XQ83D",5,0)
 S A="P" F XQI=0:0 S A=$O(^XUTL("XQO",A)) Q:A'["P"  I $D(^(A,U,XQOPI)),$D(^(XQOPM)) S XQAKEY=$S(+$E(A,2,99)=+XQOPM:1,1:0) D A
"RTN","XQ83D",6,0)
 Q
"RTN","XQ83D",7,0)
XPAND ;
"RTN","XQ83D",8,0)
 F L=0:0 S L=$O(^DIC(19,XQNEW,10,L)) Q:L'>0  S T=+^(L,0) I $P(^DIC(19,T,0),U,3)="",'$D(^TMP($J,"ACT",T)) S K=K+1,^(T)="",^TMP($J,"NEW",K)=T
"RTN","XQ83D",9,0)
 Q
"RTN","XQ83D",10,0)
 ;
"RTN","XQ83D",11,0)
A ;
"RTN","XQ83D",12,0)
 S PATH=""
"RTN","XQ83D",13,0)
 F XQ83DI=0:0 S PATH=$O(^TMP($J,"PATH",PATH)) Q:PATH=""  S XQ83DN=$L(PATH,","),XQJ=$P(PATH,",",XQ83DN-1),XQVAL=^(PATH),XQSYN=^(PATH,"SYN"),XQUC=^("U") I $D(^XUTL("XQO",A,U,XQJ)) S XQPATH=","_$S(XQAKEY:"",1:XQOPM_",")_PATH D DA
"RTN","XQ83D",14,0)
 K XQB,XQFND,XQJ,XQSYN,XQPATH,XQ83DI,XQ83DN,PATH
"RTN","XQ83D",15,0)
 Q
"RTN","XQ83D",16,0)
 ;
"RTN","XQ83D",17,0)
DA ;
"RTN","XQ83D",18,0)
 F XQK=0:0 S XQK=$O(^XUTL("XQO",A,U,XQJ,0,XQK)) Q:XQK'>0  S XQB=$P(^(XQK),U) I ","_XQB[XQPATH S ^(0)=^XUTL("XQO",A,U,XQJ,0)-1 K:^(0)'>0 ^(0) K ^(0,XQK) I XQSYN'="" S XQ2=XQSYN,XQ1=XQJ_U_"0" D DELNAM
"RTN","XQ83D",19,0)
 S XQB=$P(^XUTL("XQO",A,U,XQJ),U,6) I ","_XQB[XQPATH D DA1 I XQSYN'="" S XQ2=XQSYN,XQ1=XQJ_U_"0" D DELNAM
"RTN","XQ83D",20,0)
 I '$D(^XUTL("XQO",A,U,XQJ)) S XQ2=$E(XQUC,1,27),XQ1=XQJ_U_"1" D DELNAM
"RTN","XQ83D",21,0)
 Q
"RTN","XQ83D",22,0)
 ;
"RTN","XQ83D",23,0)
DA1 ;
"RTN","XQ83D",24,0)
 I $D(^XUTL("XQO",A,U,XQJ))'>9 K ^(XQJ) Q
"RTN","XQ83D",25,0)
 S XQ2=^XUTL("XQO",A,U,XQJ)
"RTN","XQ83D",26,0)
 ;
"RTN","XQ83D",27,0)
 S XQ1=0 F XQJJ=0:0 S XQJJ=$O(^XUTL("XQO",A,U,XQJ,0,XQJJ)) Q:XQJJ'>0  S XQ1=XQJJ
"RTN","XQ83D",28,0)
 S XQA=^XUTL("XQO",A,U,XQJ,0,XQ1),^(XQJ)=$P(^XUTL("XQO",A,U,XQJ),U,1,5)_U_$P(XQA,U,1,2)_U_$P(^(XQJ),U,8,9)_U_$P(XQA,U,3,4)_U_$P(^(XQJ),U,12,16)_U_$P(XQA,U,5)_U_$P(^(XQJ),U,18,99),^(0)=^(XQJ,0)-1 K:^(0)=0 ^(0) K ^(0,XQ1),XQA,XQ1,XQ2
"RTN","XQ83D",29,0)
 Q
"RTN","XQ83D",30,0)
 ;
"RTN","XQ83D",31,0)
DELNAM ;
"RTN","XQ83D",32,0)
 S XQ3=XQ2 F XQK=0:0 S XQ3=$O(^XUTL("XQO",A,XQ3)) Q:$E(XQ3,1,$L(XQ2))'=XQ2  I ^(XQ3)=XQ1 K ^(XQ3) Q
"RTN","XQ83D",33,0)
 K XQ1,XQ2,XQ3
"RTN","XQ83D",34,0)
 Q
"RTN","XQ83D",35,0)
 ;
"RTN","XQ83R")
0^9^B28235554
"RTN","XQ83R",1,0)
XQ83R ;SF-ISC.SEA/JLI/LUKE - SURGERY ON ^XUTL("XQO", NODES FOR REGULAR MODIFICATIONS TO OPTIONS ;04/16/2002  13:58
"RTN","XQ83R",2,0)
 ;;8.0;KERNEL;**47,157**;Jul 10, 1995
"RTN","XQ83R",3,0)
 Q
"RTN","XQ83R",4,0)
REG S XQOPI=+XQOP,XQC1=XQOPI_",",XQC2=","_XQC1
"RTN","XQ83R",5,0)
 D TABLE^XQ83A
"RTN","XQ83R",6,0)
 S XQ83R="" F I=0:0 S I=$O(^DIC(19,"AD",XQOPI,I)) Q:I'>0  S XQ83R=XQ83R_I_","
"RTN","XQ83R",7,0)
 S A="P" F %I=0:0 S XQ83RL=0 S A=$O(^XUTL("XQO",A)) Q:$E(A)'="P"  D
"RTN","XQ83R",8,0)
 . I $D(^XUTL("XQO",A,U,XQOPI)) D  Q
"RTN","XQ83R",9,0)
 . . L +^XUTL("XQO",A) K ^(A,0)
"RTN","XQ83R",10,0)
 . . F XQ83RI=1:1 S XQOPM=$P(XQ83R,",",XQ83RI) S:XQOPM="" ^XUTL("XQO",A,0)=%XQT1 L:XQOPM="" -^XUTL("XQO",A) Q:XQOPM=""  D ADD^XQ83A
"RTN","XQ83R",11,0)
 . F XQ83RI=1:1 S XQOPM=$P(XQ83R,",",XQ83RI) Q:XQOPM=""  D
"RTN","XQ83R",12,0)
 . . I $D(^XUTL("XQO",A,"^",XQOPM)) D
"RTN","XQ83R",13,0)
 . . . I '$D(XQ83LOCK) L +^XUTL("XQO",A) S XQ83LOCK=1 K ^XUTL("XQO",A,0)
"RTN","XQ83R",14,0)
 . . . D ADD^XQ83A
"RTN","XQ83R",15,0)
 . I $D(XQ83LOCK) L -^XUTL("XQO",A) K XQ83LOCK S ^XUTL("XQO",A,0)=%XQT1
"RTN","XQ83R",16,0)
 Q
"RTN","XQ83R",17,0)
 ;
"RTN","XQ83R",18,0)
A ;
"RTN","XQ83R",19,0)
 S B=0 F J=0:0 S B=$O(^XUTL("XQO",A,B)) Q:B=""!(B=U)  I +^(B)=XQOPI K ^(B)
"RTN","XQ83R",20,0)
 D A1
"RTN","XQ83R",21,0)
 F I=0:0 S I=$O(^XUTL("XQO",A,U,I)) Q:I'>0  D A2
"RTN","XQ83R",22,0)
 Q
"RTN","XQ83R",23,0)
A2 ;
"RTN","XQ83R",24,0)
 S L=0,%XQX=$P(^XUTL("XQO",A,U,I),U,9) I $E(%XQX,1,$L(XQC1))=XQC1!(%XQX[XQC2) S L=1
"RTN","XQ83R",25,0)
 I 'L F J=0:0 S J=$O(^XUTL("XQO",A,U,I,0,J)) Q:J'>0  S %XQX=$P(^(J),U,2) I $E(%XQX,1,$L(XQC1))=XQC1!(%XQX[XQC2) S L=1 Q
"RTN","XQ83R",26,0)
 I L S K=0 D D F J=0:0 S J=$O(^XUTL("XQO",A,U,I,0,J)) Q:J'>0  D D1
"RTN","XQ83R",27,0)
 I L I K=0 K ^XUTL("XQO",A,U,I)
"RTN","XQ83R",28,0)
 K L,K
"RTN","XQ83R",29,0)
 Q
"RTN","XQ83R",30,0)
 ;
"RTN","XQ83R",31,0)
A1 ;
"RTN","XQ83R",32,0)
 Q:$P(^DIC(19,XQOPI,0),U,3)'=""  D:'($D(^("U"))#2) UP S %XQX=^DIC(19,XQOPI,"U"),%XQX2=1 D A11
"RTN","XQ83R",33,0)
 S %XQX2=0 F M=0:0 S M=$O(^DIC(19,"AD",XQOPI,M)) Q:M'>0  S N=$O(^(M,0)) Q:N'>0  S %XQX=$S('($D(^DIC(19,M,10,N,0))#2):"",1:$P(^(0),U,2)) I %XQX'="" D A11
"RTN","XQ83R",34,0)
 Q
"RTN","XQ83R",35,0)
A11 ;
"RTN","XQ83R",36,0)
 S %XQY=%XQX F P=1:1 S %XQY=$O(^XUTL("XQO",A,%XQY)) Q:$P(%XQY,U,1)'=%XQX  Q:+$P(%XQY,U,2)'=(P-1)  I +^(%XQY)=XQOPI S P=0 Q
"RTN","XQ83R",37,0)
 I $P(%XQY,U,1)=%XQX S %XQY=$O(^XUTL("XQO",A,%XQY)) Q:$P(%XQY,U,1)'=%XQX  I +^(%XQY)=XQOPI S P=0 Q
"RTN","XQ83R",38,0)
 I P S ^XUTL("XQO",A,(%XQX_U_$S(P=1:"",1:P-1)))=XQOPI_U_%XQX2
"RTN","XQ83R",39,0)
 Q
"RTN","XQ83R",40,0)
 ;
"RTN","XQ83R",41,0)
D ;
"RTN","XQ83R",42,0)
 S XQA=$P(^XUTL("XQO",A,U,I),U,9) D GET Q:XQA=""  S ^XUTL("XQO",A,U,I)=U_$P(^DIC(19,I,0),U,1,2)_U_$S($P(^(0),U,3)]"":1,1:"")_U_$P(^(0),U,4)_U_XQA_U_XQK_U_$P(^(0),U,7,8)_U_XQP_U_XQE_U_$P(^(0),U,11,15)_U_XQF_U_$P(^(0),U,17,99),K=K+1
"RTN","XQ83R",43,0)
 Q
"RTN","XQ83R",44,0)
D1 ;
"RTN","XQ83R",45,0)
 S XQA=$P(^XUTL("XQO",A,U,I,0,J),U,2) D GET K ^XUTL("XQO",A,U,I,0,J) Q:XQA=""  I K>0 S ^(K)=XQA_U_XQK_U_XQP_U_XQE_U_XQF,K=K+1 Q
"RTN","XQ83R",46,0)
 S ^XUTL("XQO",A,U,I)=U_$P(^DIC(19,I,0),U,1,2)_U_$S($P(^(0),U,3)]"":1,1:"")_U_$P(^(0),U,4)_U_XQA_U_XQK_U_$P(^(0),U,7,8)_U_XQP_U_XQE_U_$P(^(0),U,11,15)_U_XQF_U_$P(^(0),U,17,99),K=K+1
"RTN","XQ83R",47,0)
 Q
"RTN","XQ83R",48,0)
 ;
"RTN","XQ83R",49,0)
GET ;
"RTN","XQ83R",50,0)
 S XQOOO="",(XQK,XQP,XQE,XQF)="" F M=1:1 S %XQA=$P(XQA,",",M) Q:%XQA'>0  D SUM
"RTN","XQ83R",51,0)
 S:XQOOO XQA="" K XQOOO
"RTN","XQ83R",52,0)
 Q
"RTN","XQ83R",53,0)
 ;
"RTN","XQ83R",54,0)
SUM ;
"RTN","XQ83R",55,0)
 S XQK1=$P(^DIC(19,%XQA,0),U,6),XQE1=$P(^(0),U,10),XQF1="" I $D(^(3)) S XQF1=$P(^(3),U)
"RTN","XQ83R",56,0)
 S XQK=$S(XQK'=""&(XQK1'=""):XQK_","_XQK1,1:XQK_XQK1),XQE=$S(XQE'=""&(XQE1'=""):XQE_","_XQE1,1:XQE_XQE1),XQF=$S(XQF'=""&(XQF1'=""):XQF_","_XQF1,1:XQF_XQF1)
"RTN","XQ83R",57,0)
 S XQOOO=$S($P(^DIC(19,%XQA,0),U,3)'="":1,1:XQOOO)
"RTN","XQ83R",58,0)
 S XQP1="" F I=0:0 S I=$O(^DIC(19,%XQA,3.91,I)) Q:I'>0  S XQP1=$S(XQP1'="":XQP1_";",1:"")_$P(^(I,0),U)_$P(^(0),U,2)
"RTN","XQ83R",59,0)
 S:XQP1="" XQP1=$P(^DIC(19,%XQA,0),U,9) S XQP=$S(XQP1'=""&(XQP'=""):XQP_";"_XQP1,1:XQP_XQP1)
"RTN","XQ83R",60,0)
 Q
"RTN","XQ83R",61,0)
 ;
"RTN","XQ83R",62,0)
UP S X=$P(^DIC(19,XQOPI,0),U,2) I X'?.PUN S X=$$UP^XLFSTR(X) ;F Z=1:1 Q:X?.NUP  S W=$A(X,Z) I W<123,W>96 S X=$E(X,1,Z-1)_$C(W-32)_$E(X,Z+1,255)
"RTN","XQ83R",63,0)
 S X=$E(X,1,30),^DIC(19,XQOPI,"U")=X,^DIC(19,"C",X,XQOPI)=""
"RTN","XQ83R",64,0)
 Q
"RTN","XQ83R",65,0)
 ;
"RTN","XQ83R",66,0)
SYN ;
"RTN","XQ83R",67,0)
 S A="P" F S=0:0 S A=$O(^XUTL("XQO",A)) Q:$E(A)'="P"  D SYN1
"RTN","XQ83R",68,0)
 K A,S,T,XQSYN,XQNAM
"RTN","XQ83R",69,0)
 Q
"RTN","XQ83R",70,0)
SYN1 ;
"RTN","XQ83R",71,0)
 S XQNAM="",V=XQOPI_U_"0" F T=0:0 S XQNAM=$O(^XUTL("XQO",A,XQNAM)) Q:XQNAM=""!(XQNAM=U)  I ^(XQNAM)=V K ^(XQNAM)
"RTN","XQ83R",72,0)
 I $S('$D(^DIC(19,XQOPI,0)):1,$P(^(0),U,3)'="":1,1:0) S XQNAM="",V=XQOPI_U_"1" F T=0:0 S XQNAM=$O(^XUTL("XQO",A,XQNAM)) Q:XQNAM=""!(XQNAM=U)  I ^(XQNAM)=V K ^(XQNAM)
"RTN","XQ83R",73,0)
 Q:'$D(^DIC(19,XQOPI,0))  Q:$P(^DIC(19,XQOPI,0),U,3)'=""  F XQOPM=0:0 S XQOPM=$O(^DIC(19,"AD",XQOPI,XQOPM)) Q:XQOPM'>0  S XQ1=$O(^(XQOPM,0)) I $D(^DIC(19,XQOPM,10,XQ1,0)) S XQSYN=$P(^(0),U,2) I XQSYN'="" D SYN2
"RTN","XQ83R",74,0)
 Q
"RTN","XQ83R",75,0)
SYN2 ;
"RTN","XQ83R",76,0)
 Q:'$D(^XUTL("XQO",A,U,XQOPI))  S XQSYN2A=","_XQOPM_","_XQOPI_","
"RTN","XQ83R",77,0)
 S XQSYN2=$S($P(A,"P",2)=XQOPM:1,(","_$P(^XUTL("XQO",A,U,XQOPI),U,9))[XQSYN2A:1,1:0) F T=0:0 Q:XQSYN2  S T=$O(^XUTL("XQO",A,U,XQOPI,0,T)) Q:T'>0  I (","_$P(^(T),U,2))[XQSYN2A S XQSYN2=1
"RTN","XQ83R",78,0)
 K XQSYN2A I 'XQSYN2 K T,XQSYN2 Q
"RTN","XQ83R",79,0)
 S XQLAST=XQOPI,V=XQLAST_U_"0",XQSYNY=XQSYN D SYN3 K XQLAST,V,XQSYNY,XQSYN2
"RTN","XQ83R",80,0)
 Q
"RTN","XQ83R",81,0)
SYN3 S XQNAM=XQSYNY_"]]]]]]]]]]]" F XQ83RT=1:1 S XQNAM=$O(^XUTL("XQO",A,XQNAM)) Q:$P(XQNAM,U,1)'=XQSYNY  I +^(XQNAM)=+V S XQ83RT=0 Q
"RTN","XQ83R",82,0)
 Q:'XQ83RT  I XQ83RT=1 S ^XUTL("XQO",A,(XQSYNY_U))=V Q
"RTN","XQ83R",83,0)
 I XQ83RT>1,$D(^XUTL("XQO",A,XQSYNY_U)) S ^(XQSYNY_U_"1")=^(XQSYNY_U) K ^(XQSYNY_U)
"RTN","XQ83R",84,0)
 F XQ83RT=1:1 I '$D(^XUTL("XQO",A,(XQSYNY_U_XQ83RT))) S ^(XQSYNY_U_XQ83RT)=V Q
"RTN","XQ83R",85,0)
 K XQ83RT
"RTN","XQ83R",86,0)
 Q
"RTN","XQ84")
0^16^B37218485
"RTN","XQ84",1,0)
XQ84 ;SEA/Luke - Menu Rebuild Utilities ;04/18/2002  10:30
"RTN","XQ84",2,0)
 ;;8.0;KERNEL;**157**;Jul 10, 1995
"RTN","XQ84",3,0)
 ;
"RTN","XQ84",4,0)
 ;
"RTN","XQ84",5,0)
SHOW ; Show what's in the global ^XUTL("XQ","REBUILDS")
"RTN","XQ84",6,0)
 I '$D(^XUTL("XQ","REBUILDS")) W !,"  Sorry, there is no data in the global ^XUTL(""XQ"",""REBUILDS"") to show you.",! Q
"RTN","XQ84",7,0)
 ;
"RTN","XQ84",8,0)
 N %,XQI,XQNL,XQNI,XQNT
"RTN","XQ84",9,0)
 N XQB,XQE,XQBY,XQTYPE,XQT,XQUCI,XQJ
"RTN","XQ84",10,0)
 ;
"RTN","XQ84",11,0)
 I '$D(IOF) D HOME^%ZIS
"RTN","XQ84",12,0)
 W @IOF
"RTN","XQ84",13,0)
 S XQNL=0 ;Line counter
"RTN","XQ84",14,0)
 S XQNI=1 ;Item or occurance counter
"RTN","XQ84",15,0)
 S XQNT=$S($D(IOSL):IOSL-4,1:18) ;Number of lines on the screen
"RTN","XQ84",16,0)
 ;
"RTN","XQ84",17,0)
 D TITLE
"RTN","XQ84",18,0)
 D TOP
"RTN","XQ84",19,0)
 ;
"RTN","XQ84",20,0)
 S XQI=0
"RTN","XQ84",21,0)
 F  Q:$D(DIRUT)  S XQI=$O(^XUTL("XQ","REBUILDS",XQI)) Q:XQI=""  D
"RTN","XQ84",22,0)
 .S %=^XUTL("XQ","REBUILDS",XQI)
"RTN","XQ84",23,0)
 .S XQBY=$P($P(%,U,3),","),XQBY=$E(XQBY,1,12)
"RTN","XQ84",24,0)
 .S XQB=$P(%,U,1),XQE=$P(%,U,2),XQTYPE=$P(%,U,4),XQT=$P(%,U,5)
"RTN","XQ84",25,0)
 .S XQUCI="  Location:  "_$P(%,U,6,8)
"RTN","XQ84",26,0)
 .S XQJ="     Job #:  "_$P(%,U,9)
"RTN","XQ84",27,0)
 .D WRITE
"RTN","XQ84",28,0)
 .Q
"RTN","XQ84",29,0)
 ;
"RTN","XQ84",30,0)
 K DIRUT,DUOUT
"RTN","XQ84",31,0)
 Q
"RTN","XQ84",32,0)
 ;
"RTN","XQ84",33,0)
WRITE ;Write an entry unless the screen is full
"RTN","XQ84",34,0)
 I XQNL>XQNT D
"RTN","XQ84",35,0)
 .D WAIT Q:$D(DIRUT)
"RTN","XQ84",36,0)
 .W @IOF
"RTN","XQ84",37,0)
 .S XQNL=0
"RTN","XQ84",38,0)
 .D TOP
"RTN","XQ84",39,0)
 .Q
"RTN","XQ84",40,0)
 Q:$D(DIRUT)
"RTN","XQ84",41,0)
 W !,XQNI,".",?4,XQB,?28,XQE,?51,XQBY,?60,XQTYPE,?71,XQT,!,XQUCI,XQJ,!
"RTN","XQ84",42,0)
 S XQNL=XQNL+3,XQNI=XQNI+1
"RTN","XQ84",43,0)
 Q
"RTN","XQ84",44,0)
 ;
"RTN","XQ84",45,0)
TOP ; Format the top of the page
"RTN","XQ84",46,0)
 W !,?11,"Start",?35,"End",?53,"By",?59,"Type/Name",?72,"Task #",!
"RTN","XQ84",47,0)
 S XQNL=XQNL+2
"RTN","XQ84",48,0)
 Q
"RTN","XQ84",49,0)
 ;
"RTN","XQ84",50,0)
TITLE ;What is this all about?
"RTN","XQ84",51,0)
 W ?36,"Recent Menu Rebuilds",!
"RTN","XQ84",52,0)
 S XQNL=XQNL+2
"RTN","XQ84",53,0)
 Q
"RTN","XQ84",54,0)
 ;
"RTN","XQ84",55,0)
WAIT ;That's a screen load hold it here for a minute
"RTN","XQ84",56,0)
 N X,Y
"RTN","XQ84",57,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","XQ84",58,0)
 Q
"RTN","XQ84",59,0)
 ;
"RTN","XQ84",60,0)
 ;
"RTN","XQ84",61,0)
USER ;Rebuild the menu trees of a specific user
"RTN","XQ84",62,0)
 ;called by the option XQBUILDUSER
"RTN","XQ84",63,0)
 Q
"RTN","XQ84",64,0)
 N XUN,XQCNT,XQSEC,XQREACT,XQPRIM
"RTN","XQ84",65,0)
 S (XQCNT,XQSEC)=0
"RTN","XQ84",66,0)
 S XQFORCE="" ;Distinguish USER from REACT
"RTN","XQ84",67,0)
 ;
"RTN","XQ84",68,0)
 S XUN=+$$LOOKUP^XUSER Q:XUN'>0
"RTN","XQ84",69,0)
 S XQPRIM=$G(^VA(200,XUN,201)) I XQPRIM'>0 W !!,"No Primary Menu defined for this user." Q
"RTN","XQ84",70,0)
 S XQCNT=1,XQREACT(XQCNT)=XQPRIM
"RTN","XQ84",71,0)
 F  S XQSEC=$O(^VA(200,XUN,203,"B",XQSEC)) Q:XQSEC'=+XQSEC  D
"RTN","XQ84",72,0)
 .Q:'$D(^DIC(19,XQSEC,0))  ;Error in Buffalo...old pointer?
"RTN","XQ84",73,0)
 .I $P(^DIC(19,XQSEC,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)=XQSEC
"RTN","XQ84",74,0)
 .Q
"RTN","XQ84",75,0)
 S DIR(0)="Y",DIR("A")=" Queue this rebuild? ",DIR("B")="Y"
"RTN","XQ84",76,0)
 S DIR("?")=" Please enter 'Y'es or 'N'o."
"RTN","XQ84",77,0)
 D ^DIR I Y=1 D
"RTN","XQ84",78,0)
 .S ZTRTN="REACTQ^XQ84"
"RTN","XQ84",79,0)
 .S ZTSAVE("XUN")=""
"RTN","XQ84",80,0)
 .S ZTSAVE("XQREACT(")="",ZTSAVE("XQCNT")="",ZTSAVE("XQFORCE")=""
"RTN","XQ84",81,0)
 .S ZTIO="",ZTDTH=$H
"RTN","XQ84",82,0)
 .S ZTDESC="Rebuild "_$P(^VA(200,XUN,0),U)_"'s menu trees (DUZ="_XUN_")"
"RTN","XQ84",83,0)
 .D ^%ZTLOAD
"RTN","XQ84",84,0)
 .I $D(ZTSK) W !!," Task number: ",ZTSK
"RTN","XQ84",85,0)
 .Q
"RTN","XQ84",86,0)
 K DIR,Y
"RTN","XQ84",87,0)
 ;
"RTN","XQ84",88,0)
 I '$D(ZTSK) D REACTQ W !!," Done."
"RTN","XQ84",89,0)
 K ZTSK
"RTN","XQ84",90,0)
 Q
"RTN","XQ84",91,0)
 ;
"RTN","XQ84",92,0)
REACT(XUN) ;From XUSERNEW, check trees for reactivated user
"RTN","XQ84",93,0)
 ;
"RTN","XQ84",94,0)
 N XQCNT,XQSEC,XQREACT,XQPRIM,XQCHAT
"RTN","XQ84",95,0)
 S XQCHAT=1 I $D(XQUEUED)!$D(XWB) S XQCHAT=0 ;Anybody out there?
"RTN","XQ84",96,0)
 S XQPRIM=$G(^VA(200,XUN,201)) I 'XQPRIM,'$D(XQQUE) W:XQCHAT !!,"** WARNING ** No Primary Menu defined." Q
"RTN","XQ84",97,0)
 I (XQPRIM'=+XQPRIM)!($G(^DIC(19,XQPRIM,0))="") Q
"RTN","XQ84",98,0)
 S (XQCNT,XQSEC)=0
"RTN","XQ84",99,0)
 I XQPRIM,'$D(^DIC(19,"AXQ","P"_XQPRIM)),$P(^DIC(19,XQPRIM,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)=XQPRIM
"RTN","XQ84",100,0)
 F  S XQSEC=$O(^VA(200,XUN,203,"B",XQSEC)) Q:XQSEC'=+XQSEC  D
"RTN","XQ84",101,0)
 .I '$D(^DIC(19,"AXQ","P"_XQSEC)),$P(^DIC(19,XQSEC,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)=XQSEC
"RTN","XQ84",102,0)
 .Q
"RTN","XQ84",103,0)
 ;
"RTN","XQ84",104,0)
 Q:XQCNT=0  ;The menu trees look OK to me.
"RTN","XQ84",105,0)
 ;
"RTN","XQ84",106,0)
 I XQCHAT,XQCNT>0 D
"RTN","XQ84",107,0)
 .W !!,"This user's menus will have to be rebuilt."
"RTN","XQ84",108,0)
 .S DIR(0)="Y",DIR("A")="Queue this rebuild? ",DIR("B")="Y"
"RTN","XQ84",109,0)
 .S DIR("?")="Please enter 'Y'es or 'N'o."
"RTN","XQ84",110,0)
 .D ^DIR
"RTN","XQ84",111,0)
 .S:Y=1 XQQUE=""
"RTN","XQ84",112,0)
 .K DIR,Y
"RTN","XQ84",113,0)
 .Q
"RTN","XQ84",114,0)
 I 'XQCHAT S XQQUE=""
"RTN","XQ84",115,0)
 ;
"RTN","XQ84",116,0)
 I XQCNT>0,$D(XQQUE) D
"RTN","XQ84",117,0)
 .S ZTRTN="REACTQ^XQ84"
"RTN","XQ84",118,0)
 .S ZTSAVE("XQREACT(")="",ZTSAVE("XUN")=""
"RTN","XQ84",119,0)
 .S ZTIO="",ZTDTH=$H
"RTN","XQ84",120,0)
 .S ZTDESC="Rebuild reactivated user's menu trees (DUZ="_XUN_")"
"RTN","XQ84",121,0)
 .D ^%ZTLOAD
"RTN","XQ84",122,0)
 .I XQCHAT,$D(ZTSK) W !!,"Task number: ",ZTSK
"RTN","XQ84",123,0)
 .K ZTSK
"RTN","XQ84",124,0)
 .Q
"RTN","XQ84",125,0)
 I XQCNT>0,'$D(XQQUE) D REACTQ
"RTN","XQ84",126,0)
 Q
"RTN","XQ84",127,0)
 ;
"RTN","XQ84",128,0)
REACTQ ;Queued job to rebuild a reativated user's menu trees
"RTN","XQ84",129,0)
 ;  can also be run in real time by REACT and USER (above)
"RTN","XQ84",130,0)
 ;
"RTN","XQ84",131,0)
 K ZTREQ ;Don't delete the task information
"RTN","XQ84",132,0)
 I $D(^DIC(19,"AXQ","P0")) S XQSTAT=$$STATUS^XQ81 Q:'XQSTAT  ;Menus are being rebuilt
"RTN","XQ84",133,0)
 D MICRO^XQ81
"RTN","XQ84",134,0)
 Q:'$D(XQREACT)  ;Nothing to rebuild
"RTN","XQ84",135,0)
 S ^DIC(19,"AXQ","P0")=$H
"RTN","XQ84",136,0)
 N XQCNT,XQDIC S XQCNT=0
"RTN","XQ84",137,0)
 F  S XQCNT=$O(XQREACT(XQCNT)) Q:XQCNT=""  D
"RTN","XQ84",138,0)
 .S (XQFG1,XQXUF)="",XQDIC="P"_XQREACT(XQCNT)
"RTN","XQ84",139,0)
 .D PM2^XQ8
"RTN","XQ84",140,0)
 .Q
"RTN","XQ84",141,0)
 D MERGET^XQ81
"RTN","XQ84",142,0)
 D MERGEX^XQ81
"RTN","XQ84",143,0)
 K ^DIC(19,"AXQ","P0"),^TMP($J),^TMP("XQO",$J)
"RTN","XQ84",144,0)
 D REPORT($E($P(^VA(200,XUN,0),U),1,9))
"RTN","XQ84",145,0)
 K D,I,W,X,XQK,XQQUE,XQXUF,Y,Z
"RTN","XQ84",146,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ84",147,0)
 Q
"RTN","XQ84",148,0)
 ;
"RTN","XQ84",149,0)
 ;
"RTN","XQ84",150,0)
REPORT(XQTYPE) ;Tell Rick What happened.
"RTN","XQ84",151,0)
 N %,X,XQI,XQJ,XQK,XQLINE,XQEND,Y
"RTN","XQ84",152,0)
 S XQEND=$$HTE^XLFDT($H)
"RTN","XQ84",153,0)
 I '$D(XQSTART) S XQSTART=XQEND
"RTN","XQ84",154,0)
 S XQLINE=XQSTART_"^"_XQEND_"^"_$P(^VA(200,DUZ,0),U,1)_"^"
"RTN","XQ84",155,0)
 ;S X=$S($D(^DIC(19,"AXQ","P0","MICRO")):"MICRO",$D(ZTSK):"QUEUED",1:"LIVE")
"RTN","XQ84",156,0)
 S X=XQTYPE K XQTYPE
"RTN","XQ84",157,0)
 S Y=$S($D(ZTSK):ZTSK,1:"LIVE")
"RTN","XQ84",158,0)
 S XQLINE=XQLINE_X_"^"_Y
"RTN","XQ84",159,0)
 D GETENV^%ZOSV
"RTN","XQ84",160,0)
 S XQLINE=XQLINE_"^"_$P(Y,"^",1,3)_"^"_$J
"RTN","XQ84",161,0)
 I $D(^XUTL("XQ","REBUILDS")) D
"RTN","XQ84",162,0)
 .S (XQJ,XQK)=0
"RTN","XQ84",163,0)
 .F  S XQJ=$O(^XUTL("XQ","REBUILDS",XQJ)) Q:XQJ=""!(XQJ=49)  S XQK=XQK+1
"RTN","XQ84",164,0)
 .F XQI=XQK:-1:1 S ^XUTL("XQ","REBUILDS",XQI+1)=^(XQI)
"RTN","XQ84",165,0)
 .Q
"RTN","XQ84",166,0)
 S ^XUTL("XQ","REBUILDS",1)=XQLINE
"RTN","XQ84",167,0)
 Q
"RTN","XQ84",168,0)
 ;
"RTN","XQ84",169,0)
 ;
"RTN","XQ84",170,0)
NOW ;Is there a rebuild of any kind running right now?
"RTN","XQ84",171,0)
 N % S %=0
"RTN","XQ84",172,0)
 I $D(^DIC(19,"AXQ","P0","MICRO")) D
"RTN","XQ84",173,0)
 .W !!?6,"Micro surgery is currently updating the compiled menus."
"RTN","XQ84",174,0)
 .I $D(^DIC(19,"AXQ","AXQ","STOP")) D
"RTN","XQ84",175,0)
 ..W !?6,"... but it has been instructed to stop."
"RTN","XQ84",176,0)
 ..Q
"RTN","XQ84",177,0)
 .S %=47
"RTN","XQ84",178,0)
 .Q
"RTN","XQ84",179,0)
 Q:%=47
"RTN","XQ84",180,0)
 I $D(^DIC(19,"AXQ","P0")) D
"RTN","XQ84",181,0)
 .W !!?6," A complete menu rebuild is currently running."
"RTN","XQ84",182,0)
 .S %=47
"RTN","XQ84",183,0)
 .Q
"RTN","XQ84",184,0)
 Q:%=47
"RTN","XQ84",185,0)
 W !!?6,"There is no menu rebuild activity running on your system right now."
"RTN","XQ84",186,0)
 Q
"RTN","XQ8A")
0^11^B6567473
"RTN","XQ8A",1,0)
XQ8A ;SEA/LUKE - Rebuild menus in all production accounts ;06/26/2000  09:15
"RTN","XQ8A",2,0)
 ;;8.0;KERNEL;**46,157**;Jul 10, 1995
"RTN","XQ8A",3,0)
BLD1 ;Build the ^XUTL("XQO") for a single XQDIC in all production UCI's
"RTN","XQ8A",4,0)
 S XQ8SV=XQY_U_XQDIC_U_XQY0
"RTN","XQ8A",5,0)
BLD12 K DIC S DIC="^DIC(19,",DIC(0)="AEQMZ" D ^DIC I Y<1 K DIC Q
"RTN","XQ8A",6,0)
 I $P(Y(0),U,4)'="M" W !!,$P(Y(0),U)," is not a menu-type option and can't be compiled." G BLD12
"RTN","XQ8A",7,0)
 S XQDIC="P"_+Y,XQXUF="" I +Y=$O(^DIC(19,"B","XUCOMMAND",0)) S XQDIC="PXU" K XQXUF
"RTN","XQ8A",8,0)
 S DIR(0)="Y",DIR("A")="Que rebuilds on all production UCI's",DIR("B")="N",DIR("?")="Answering 'Y' will cause a job to be queued on all production UCI's" D ^DIR S XQUR=Y
"RTN","XQ8A",9,0)
 W !!,"Task number(s):" S (ZTUCI,ZTVOL)="" D FIRE
"RTN","XQ8A",10,0)
 I 'XQUR G OUT
"RTN","XQ8A",11,0)
 S ZTVOL=0 D GETENV^%ZOSV S XQHERE=$P(Y,U,2),XQPROD=$P(^%ZOSF("PROD"),",")
"RTN","XQ8A",12,0)
 F XQI=0:0 S ZTVOL=$O(^%ZIS(14.5,"B",ZTVOL)) Q:ZTVOL=""  S ZTUCI=$O(^%ZIS(14.6,"AT",XQPROD,XQHERE,ZTVOL,"")) I ZTUCI]"" D FIRE
"RTN","XQ8A",13,0)
 ;
"RTN","XQ8A",14,0)
OUT ;Exit here
"RTN","XQ8A",15,0)
 S XQY=+XQ8SV,XQDIC=$P(XQ8SV,U,2),XQY0=$P(XQ8SV,3,99)
"RTN","XQ8A",16,0)
 K %,%X,%Y,DIC,DIR,XQ8SV,XQDATE,XQFG1,XQHERE,XQI,XQPROD,XQRE,XQUCI,XQUR,XQVOL,XQXUF,ZTSK,ZTUCI,ZTVOL,Y
"RTN","XQ8A",17,0)
 Q
"RTN","XQ8A",18,0)
FIRE ;Fire off a task in selected UCI
"RTN","XQ8A",19,0)
 S (XQRE,XQFG1)=0,ZTIO="",ZTRTN="PM1^XQ8",ZTDTH=$H,ZTSAVE("XQDIC")="",ZTSAVE("XQRE")="",ZTSAVE("XQFG1")="",ZTDESC="Rebuilding "_XQDIC_" from FIRE^XQ8A"
"RTN","XQ8A",20,0)
 S:$D(XQXUF) ZTSAVE("XQXUF")=""
"RTN","XQ8A",21,0)
 D ^%ZTLOAD W " ",ZTSK
"RTN","XQ8A",22,0)
 Q
"RTN","XQ8A",23,0)
 ;
"RTN","XQ8A",24,0)
ALL ;Rebuild menus in all UCI's marked in the UCI Association Table
"RTN","XQ8A",25,0)
 ;  which is in %ZIS(14.6)
"RTN","XQ8A",26,0)
 D ^XQDATE S XQDATE=%Y
"RTN","XQ8A",27,0)
 K ^DIC(19,"AT")
"RTN","XQ8A",28,0)
 S XQVOL=""
"RTN","XQ8A",29,0)
 F  S XQVOL=$O(^%ZIS(14.5,"B",XQVOL)) Q:XQVOL=""  D
"RTN","XQ8A",30,0)
 .S XQUCI=""
"RTN","XQ8A",31,0)
 .F  S XQUCI=$O(^%ZIS(14.6,"AV",XQVOL,XQUCI)) Q:XQUCI=""  D
"RTN","XQ8A",32,0)
 ..S XQN=$O(^%ZIS(14.6,"AV",XQVOL,XQUCI,0)) Q:XQN=""
"RTN","XQ8A",33,0)
 ..I $P(^%ZIS(14.6,XQN,0),U,7) D FIRE2
"RTN","XQ8A",34,0)
 ..Q
"RTN","XQ8A",35,0)
 .Q
"RTN","XQ8A",36,0)
 K %,%Y,XQDATE,XQUCI,XQVOL
"RTN","XQ8A",37,0)
 Q
"RTN","XQ8A",38,0)
FIRE2 ;Queue menubuild in a particular UCI
"RTN","XQ8A",39,0)
 S (XQRE,XQFG1)=0,ZTSAVE("XQRE")="",ZTSAVE("XQFG1")=""
"RTN","XQ8A",40,0)
 S ZTCPU=XQVOL,ZTUCI=XQUCI
"RTN","XQ8A",41,0)
 S ZTRTN="QUE^XQ81",ZTDTH=$H,ZTIO=""
"RTN","XQ8A",42,0)
 S ZTDESC="Menu rebuild in "_ZTCPU_","_ZTUCI_" on "_XQDATE
"RTN","XQ8A",43,0)
 D ^%ZTLOAD
"RTN","XQ8A",44,0)
 Q
"RTN","XQCS")
0^14^B35404398
"RTN","XQCS",1,0)
XQCS ;SEA/Luke - Client/Server Utilities ;04/16/2002  14:05
"RTN","XQCS",2,0)
 ;;8.0;KERNEL;**15,28,82,116,115,177,188,157**;Jul 10, 1995
"RTN","XQCS",3,0)
 ;
"RTN","XQCS",4,0)
CHK(XQUSR,XQOPT,XQRPC) ;Check to see if this user can run this RPC from
"RTN","XQCS",5,0)
 ;this option.
"RTN","XQCS",6,0)
 ;
"RTN","XQCS",7,0)
 ;Input: XQUSR-DUZ of user
"RTN","XQCS",8,0)
 ;       XQOPT - name or IEN of the option
"RTN","XQCS",9,0)
 ;       XQRPC - name or IEN of the remote procedure.  If this
"RTN","XQCS",10,0)
 ;               variable is null no check is made to see if a
"RTN","XQCS",11,0)
 ;               procedure is allowed.  That is, we only look
"RTN","XQCS",12,0)
 ;               to see if the option is there and  if the user
"RTN","XQCS",13,0)
 ;               has been assigned access to it.
"RTN","XQCS",14,0)
 ;
"RTN","XQCS",15,0)
 ;Output: XQMES - returned as 1 if the user is allowed to use this
"RTN","XQCS",16,0)
 ;        option (and RPC is valid if XQRPC input variable is not
"RTN","XQCS",17,0)
 ;        null), or as a message string explaining why the option
"RTN","XQCS",18,0)
 ;        or RPC is not allowed.
"RTN","XQCS",19,0)
 ;
"RTN","XQCS",20,0)
 ;Rules: If M code exsists in ^DIC(19,option#,"RPC",rpc#,1) the
"RTN","XQCS",21,0)
 ;       RULES field for a corresponding RPC, the software sets
"RTN","XQCS",22,0)
 ;       the flag XQRPCOK to 1 and executes the field's code.
"RTN","XQCS",23,0)
 ;       If the flag is returned as less than 1, the request for
"RTN","XQCS",24,0)
 ;       use of that RPC is denied.  Rules are written by the
"RTN","XQCS",25,0)
 ;       package developer and are not required.
"RTN","XQCS",26,0)
 ;
"RTN","XQCS",27,0)
 ;
"RTN","XQCS",28,0)
 N %,X,XQCY0,XQDIC,XQKEY,XQRPCOK,XQPM,XQSM,XQSMY,XQYSAV
"RTN","XQCS",29,0)
 ;
"RTN","XQCS",30,0)
 S XQMES=1
"RTN","XQCS",31,0)
 D OPT I 'XQMES Q XQMES
"RTN","XQCS",32,0)
 I ($G(XQY0)'="XUS SIGNON")&(XQUSR>0) D USER I 'XQMES Q XQMES
"RTN","XQCS",33,0)
 S %=$G(XQRPC) I %]"" S XQRPC=% D RPC I 'XQMES Q XQMES
"RTN","XQCS",34,0)
 Q XQMES
"RTN","XQCS",35,0)
 ;
"RTN","XQCS",36,0)
 ;
"RTN","XQCS",37,0)
OPT ;See if the option is there and is a broker type option
"RTN","XQCS",38,0)
 I XQOPT'=+XQOPT S XQOPT=$O(^DIC(19,"B",XQOPT,0))
"RTN","XQCS",39,0)
 I XQOPT'>0 S XQMES="No such option in the ""B"" cross reference of the Option File." Q
"RTN","XQCS",40,0)
 I $G(MODE)="CHECK" D OPT1 Q
"RTN","XQCS",41,0)
 I '$D(^TMP("XQCS",$J)) S XQOPT=$$OPTLK($P(^DIC(19,XQOPT,0),U))
"RTN","XQCS",42,0)
 Q
"RTN","XQCS",43,0)
OPT1 ;
"RTN","XQCS",44,0)
 I XQOPT'=+XQOPT S XQOPT=$O(^DIC(19,"B",XQOPT,0)) I XQOPT'>0 S XQMES="No such option in the ""B"" cross reference of the Option File." Q
"RTN","XQCS",45,0)
 I '$D(^DIC(19,XQOPT,0)) S XQMES="No such option in the Option File."  Q
"RTN","XQCS",46,0)
 ;I $P(^DIC(19,XQOPT,0),U,4)'="B" S XQMES="This option is not a Client/Server-type option."  Q
"RTN","XQCS",47,0)
 ;
"RTN","XQCS",48,0)
 ;Check for Out-Of-Order, etc.  Patch XU*8*38 7/16/96
"RTN","XQCS",49,0)
 ;
"RTN","XQCS",50,0)
 S XQCY0=^DIC(19,XQOPT,0) ;W XQCY0
"RTN","XQCS",51,0)
 I $L($P(XQCY0,U,3)) S XQMES="Option out of order with message: "_$P(XQCY0,U,3)_"."  Q
"RTN","XQCS",52,0)
 I $L($P(XQCY0,U,6)) S %=$P(XQCY0,U,6) I '$D(^XUSEC(%,DUZ)) S XQMES="Option locked, "_$P(^VA(200,DUZ,0),U)_" does not hold the key."  Q
"RTN","XQCS",53,0)
 I $L($P(XQCY0,U,16)) I $D(^DIC(19,XQOPT,3)),^(3)]"" S %=^(3) I $D(^XUSEC(%,DUZ)) S XQMES="Reverse lock, "_$P(^VA(200,DUZ,0),U)_" holds the key."  Q
"RTN","XQCS",54,0)
 I $L($P(XQCY0,U,9)) S XQZ=$P(XQCY0,U,9) D ^XQDATE S (XX,X)=% D XQO^XQ92 I X=""!(XX'=X) S XQMES="This option is time restricted."  Q
"RTN","XQCS",55,0)
 I $D(^DIC(19,+XQOPT,3.91)),$P(^(3.91,0),U,4)>1 S:$D(XQY) XQYSAV=XQY D ^XQDATE S X=%,XQY=+XQOPT D ^XQ92 S:$D(XQYSAV) XQY=XQYSAV I X="" S XQMES="This option is time restricted."  Q
"RTN","XQCS",56,0)
 ;End patch 38
"RTN","XQCS",57,0)
 Q
"RTN","XQCS",58,0)
 ;
"RTN","XQCS",59,0)
OPTLK(V) ;Lookup a Option in the file, Return it's IEN
"RTN","XQCS",60,0)
 N XQOPT S XQOPT=$O(^DIC(19,"B",V,0)) I XQOPT'>0 Q ""
"RTN","XQCS",61,0)
 I '$D(XQMES) N XQMES S XQMES=1
"RTN","XQCS",62,0)
 N XQCS,XQCSO S XQCS(XQOPT)="" N XQOPT K ^TMP("XQCS",$J)
"RTN","XQCS",63,0)
 F  S XQOPT=$O(XQCS("")) Q:XQOPT=""  K XQCS(XQOPT) I '$D(XQCSO(XQOPT)) D OPT1 D:XQMES  I 'XQMES Q
"RTN","XQCS",64,0)
 . N I,J F I=0:0 S I=$O(^DIC(19,XQOPT,"RPC",I)) Q:I'>0  K J S J=^(I,0) S:$D(^(1)) J(1)=^(1) I '$D(^TMP("XQCS",$J,+J)) S ^TMP("XQCS",$J,+J,0)=J I $D(J(1)) S ^(1)=J(1)
"RTN","XQCS",65,0)
 . F I=0:0 S I=$O(^DIC(19,XQOPT,10,I)) Q:I'>0  S J=+^(I,0) I $P(^DIC(19,J,0),U,4)="B" S XQCS(J)=""
"RTN","XQCS",66,0)
 . S XQCSO(XQOPT)=""
"RTN","XQCS",67,0)
 . Q
"RTN","XQCS",68,0)
 Q $O(^DIC(19,"B",V,0))
"RTN","XQCS",69,0)
 ;
"RTN","XQCS",70,0)
RPC ;See if rpc exsists, is registered, is locked, etc.
"RTN","XQCS",71,0)
 ; I '$D(^DIC(19,XQOPT,"RPC",0)) S XQMES="No RPC subfile defined for the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",72,0)
 ; I $P(^DIC(19,XQOPT,"RPC",0),U,4)<1 S XQMES="No remote procedure calls registered for the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",73,0)
 I XQRPC'=+XQRPC S XQRPC=$O(^XWB(8994,"B",XQRPC,0)) I XQRPC'>0 S XQMES="No RPC by that name in the ""B"" cross-reference of the Remote Procedure File." Q
"RTN","XQCS",74,0)
 I '$D(^XWB(8994,XQRPC,0)) S XQMES="No such procedure in the Remote Procedure File." Q
"RTN","XQCS",75,0)
 ; I '$D(^DIC(19,XQOPT,"RPC","B",XQRPC)) S XQMES="The remote procedure "_$P(^XWB(8994,XQRPC,0),U)_" is not registered to the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",76,0)
 I '$D(^TMP("XQCS",$J,XQRPC)) S XQMES="The remote procedure "_$P(^XWB(8994,XQRPC,0),U)_" is not registered to the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",77,0)
 ; S %=$O(^DIC(19,XQOPT,"RPC","B",XQRPC,0)),XQKEY=$P(^DIC(19,XQOPT,"RPC",%,0),U,2)
"RTN","XQCS",78,0)
 S XQKEY=$P(^TMP("XQCS",$J,XQRPC,0),U,2)
"RTN","XQCS",79,0)
 I $L(XQKEY) I '$D(^XUSEC(XQKEY,XQUSR)) S XQMES="Remote procedure is locked." Q
"RTN","XQCS",80,0)
 ;
"RTN","XQCS",81,0)
RULES ;Check the rules for this RPC
"RTN","XQCS",82,0)
 ;S %=$O(^DIC(19,XQOPT,"RPC","B",XQRPC,0))
"RTN","XQCS",83,0)
 ;I $D(^DIC(19,XQOPT,"RPC",%,1)),$L(^(1)) D
"RTN","XQCS",84,0)
 I $D(^TMP("XQCS",$J,XQRPC,1)),$L(^(1)) D
"RTN","XQCS",85,0)
 . S XQRPCOK=1
"RTN","XQCS",86,0)
 . X ^TMP("XQCS",$J,XQRPC,1)
"RTN","XQCS",87,0)
 . I XQRPCOK<1 S XQMES="Remote procedure request failed rules test."
"RTN","XQCS",88,0)
 . Q
"RTN","XQCS",89,0)
 Q
"RTN","XQCS",90,0)
 ;
"RTN","XQCS",91,0)
 ;
"RTN","XQCS",92,0)
 ;
"RTN","XQCS",93,0)
USER ;See if XQUSR has been assigned access this option or not
"RTN","XQCS",94,0)
 ;
"RTN","XQCS",95,0)
 N XQYES
"RTN","XQCS",96,0)
 S XQMES=1,(XQSMY,%,XQYES)=0
"RTN","XQCS",97,0)
 ;
"RTN","XQCS",98,0)
TOP ;See if XQOPT is on top level of a tree: primary, secondary, or common
"RTN","XQCS",99,0)
 S XQPM=+$G(^VA(200,XQUSR,201)) I XQOPT=XQPM Q
"RTN","XQCS",100,0)
 ;
"RTN","XQCS",101,0)
 ;Check the Common Options (XUCOMMAND)
"RTN","XQCS",102,0)
 I $D(^DIC(19,"B","XUCOMMAND")) D
"RTN","XQCS",103,0)
 . N XQCOM
"RTN","XQCS",104,0)
 . S XQCOM=$O(^DIC(19,"B","XUCOMMAND",0))
"RTN","XQCS",105,0)
 . I $D(^DIC(19,XQCOM,10,"B",XQOPT)) S XQYES=1
"RTN","XQCS",106,0)
 . I XQYES Q
"RTN","XQCS",107,0)
 . I '$D(^XUTL("XQO","PXU",0)) S %=$$BUILD("PXU")
"RTN","XQCS",108,0)
 . I $D(^XUTL("XQO","PXU","^",XQOPT)) S XQYES=1
"RTN","XQCS",109,0)
 . Q
"RTN","XQCS",110,0)
 I XQYES Q
"RTN","XQCS",111,0)
 ;
"RTN","XQCS",112,0)
 ;
"RTN","XQCS",113,0)
 I $D(^VA(200,XQUSR,203,0)),$P(^(0),U,4)>0 S XQSMY=1 D
"RTN","XQCS",114,0)
 . S XQDIC="U"_XQUSR I $S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,XQUSR,203.1)):1,1:^VA(200,XQUSR,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) D ^XQSET
"RTN","XQCS",115,0)
 . S (XQSM,%)=0
"RTN","XQCS",116,0)
 . F  Q:%  S XQSM=$O(^XUTL("XQO",XQDIC,"^",XQSM)) Q:XQSM=""  I XQSM=XQOPT S XQYES=1 Q
"RTN","XQCS",117,0)
 . Q
"RTN","XQCS",118,0)
 I XQYES Q
"RTN","XQCS",119,0)
 ;
"RTN","XQCS",120,0)
DEEP ;See if it's under the top somewhere - start with primary tree
"RTN","XQCS",121,0)
 I XQPM>0 D
"RTN","XQCS",122,0)
 .S XQDIC="P"_XQPM
"RTN","XQCS",123,0)
 .I $P(^DIC(19,XQPM,0),U,4)="M",'$D(^XUTL("XQO",XQDIC,0)) S %=$$BUILD(XQDIC)
"RTN","XQCS",124,0)
 .I $D(^XUTL("XQO",XQDIC,"^",XQOPT)) S XQYES=1
"RTN","XQCS",125,0)
 .Q
"RTN","XQCS",126,0)
 I XQYES Q
"RTN","XQCS",127,0)
 ;
"RTN","XQCS",128,0)
 ;Check secondary trees
"RTN","XQCS",129,0)
 S (XQSM,%)=0
"RTN","XQCS",130,0)
 I XQSMY F  Q:XQYES  S XQSM=$O(^XUTL("XQO","U"_XQUSR,"^",XQSM)) Q:XQSM=""  D
"RTN","XQCS",131,0)
 . S XQDIC="P"_XQSM
"RTN","XQCS",132,0)
 . I $P(^DIC(19,XQSM,0),U,4)="M",'$D(^XUTL("XQO",XQDIC,0)) S %=$$BUILD(XQDIC)
"RTN","XQCS",133,0)
 . I $D(^XUTL("XQO",XQDIC,"^",XQOPT)) S XQYES=1
"RTN","XQCS",134,0)
 . Q
"RTN","XQCS",135,0)
 I XQYES Q
"RTN","XQCS",136,0)
 ;
"RTN","XQCS",137,0)
 I $L(XQMES<5) S XQMES="User "_$P(^VA(200,XQUSR,0),U)_" does not have access to option "_$P(^DIC(19,XQOPT,0),U)
"RTN","XQCS",138,0)
 Q
"RTN","XQCS",139,0)
 ;
"RTN","XQCS",140,0)
 ;End of main program
"RTN","XQCS",141,0)
 ;
"RTN","XQCS",142,0)
BUILD(XQDIC)   ;A missing ^XUTL node brings us here
"RTN","XQCS",143,0)
 I $D(^DIC(19,"AXQ",XQDIC)) D
"RTN","XQCS",144,0)
 .L +^DIC(19,"AXQ",XQDIC):5
"RTN","XQCS",145,0)
 .I '$D(^XUTL("XQO",XQDIC)) M ^XUTL("XQO",XQDIC)=^DIC(19,"AXQ",XQDIC)
"RTN","XQCS",146,0)
 .L -^DIC(19,"AXQ",XQDIC)
"RTN","XQCS",147,0)
 .Q
"RTN","XQCS",148,0)
 I $D(^XUTL("XQO",XQDIC,0)) Q 1
"RTN","XQCS",149,0)
 ;
"RTN","XQCS",150,0)
 ;If they are not even in ^DIC the make them from scratch
"RTN","XQCS",151,0)
 I '$D(^DIC(19,"AXQ",XQDIC)) D
"RTN","XQCS",152,0)
 .;D REACT^XQ84(DUZ)
"RTN","XQCS",153,0)
 .S XQMES="Your menus are being rebuilt.  Please try again later."
"RTN","XQCS",154,0)
 Q 0
"RTN","XQLOCK")
0^12^B28321990
"RTN","XQLOCK",1,0)
XQLOCK ;SEA/Luke - Find all the keys in the tree ;07/01/2002  09:22
"RTN","XQLOCK",2,0)
 ;;8.0;KERNEL;**20,157**;Jul 10, 1995
"RTN","XQLOCK",3,0)
 ;
"RTN","XQLOCK",4,0)
 ;
"RTN","XQLOCK",5,0)
 ;Input: XQX is the internal number of the parent menu
"RTN","XQLOCK",6,0)
 ;       XQUSR is the DUZ of the owner of that menu
"RTN","XQLOCK",7,0)
 ;
"RTN","XQLOCK",8,0)
EN1 ;Look up menu trees by user. Entry for option ENLOCK1.
"RTN","XQLOCK",9,0)
 S XQEN=0 D INIT,USR G:Y=-1 OUT D BLD G:'XQN OUT D DISP,SHOW,CHUZ1,OUT
"RTN","XQLOCK",10,0)
 Q
"RTN","XQLOCK",11,0)
 ;
"RTN","XQLOCK",12,0)
EN2 ;Look up keys for a given menu tree. Entry for option ENLOCK2.
"RTN","XQLOCK",13,0)
 S XQEN=1 D INIT,TREE G:Y=-1 OUT D BLD G:'XQN OUT D DISP,SHOW,CHUZ1,OUT
"RTN","XQLOCK",14,0)
 Q
"RTN","XQLOCK",15,0)
EN3 ;Look up Keys for menu delegation.
"RTN","XQLOCK",16,0)
 S XQEN=2,XQUSR=XQDA,XQDIC=XQX D INIT,BLD G:'XQN OUT D DISP,SHOW,CHUZ1,OUT
"RTN","XQLOCK",17,0)
 Q
"RTN","XQLOCK",18,0)
 ;
"RTN","XQLOCK",19,0)
INIT ;Get things set up
"RTN","XQLOCK",20,0)
 S XQBOSS=0 S:$D(^XUSEC("XUMGR",DUZ)) XQBOSS=1
"RTN","XQLOCK",21,0)
 Q
"RTN","XQLOCK",22,0)
USR ;Find the user and the menu in question
"RTN","XQLOCK",23,0)
 Q:XQEN=2
"RTN","XQLOCK",24,0)
 S DIC="^VA(200,",DIC(0)="AEMQZ",DIC("A")="Please enter the user's name: " W ! D ^DIC Q:Y=-1  S XQUSR=+Y Q:XQEN  D SHO Q:Y=-1
"RTN","XQLOCK",25,0)
 ;
"RTN","XQLOCK",26,0)
 W !!,"Enter a menu tree by number : " R %:DTIME S:%="" %=U S:(%=0)!('$D(XQMENU(%)))!(%'=+%) %=U
"RTN","XQLOCK",27,0)
 I %=U S Y=-1 Q
"RTN","XQLOCK",28,0)
 S XQX=+XQMENU(%)
"RTN","XQLOCK",29,0)
 Q
"RTN","XQLOCK",30,0)
 ;
"RTN","XQLOCK",31,0)
TREE ;Get the name of the menu tree in question
"RTN","XQLOCK",32,0)
 S DIC="^DIC(19,",DIC(0)="AEMQZ",DIC("A")="Please enter the parent menu: " D ^DIC Q:Y=-1  S XQX=+Y
"RTN","XQLOCK",33,0)
 Q
"RTN","XQLOCK",34,0)
 ;
"RTN","XQLOCK",35,0)
BLD ;See if the menu tree has been built if not, do it
"RTN","XQLOCK",36,0)
 S:$D(XQDIC) XQSAV=XQDIC S:XQX'["P" XQX="P"_XQX S XQDIC=XQX
"RTN","XQLOCK",37,0)
 I '$D(^XUTL("XQO",XQDIC)) S XQXUF="" W !!,"==> Working... "
"RTN","XQLOCK",38,0)
 D PM1^XQ8
"RTN","XQLOCK",39,0)
 I $D(XQPSM) S XQSAVE1=XQPSM
"RTN","XQLOCK",40,0)
 S XQPSM="P"_XQDIC
"RTN","XQLOCK",41,0)
 D MERGE^XQ12
"RTN","XQLOCK",42,0)
 I $D(XQSAVE1) S XQPSM=XQSAVE1
"RTN","XQLOCK",43,0)
 ;
"RTN","XQLOCK",44,0)
FIND ;Order through the child options and find the locks
"RTN","XQLOCK",45,0)
 S XQJ=0,XQN=0
"RTN","XQLOCK",46,0)
 F  S XQJ=$O(^XUTL("XQO",XQDIC,"^",XQJ)) Q:XQJ=""  I $P(^(XQJ),U,7)]""&($P(^DIC(19,XQJ,0),U,6)]"") S XQNM=$P(^(0),U,1),XQTXT=$P(^(0),U,2),XQK=$P(^(0),U,6) D GOT1
"RTN","XQLOCK",47,0)
 ;
"RTN","XQLOCK",48,0)
 I 'XQN W:'$D(ZTQUEUED) !!,"No keys need to be given to this user for this menu tree." Q  ;There are no keys to give, so quit
"RTN","XQLOCK",49,0)
 Q
"RTN","XQLOCK",50,0)
 ;
"RTN","XQLOCK",51,0)
DISP ;Display the locked options with their keys
"RTN","XQLOCK",52,0)
 W !!,"There ",$S(XQN=1:"is one ",1:"are some "),"locked option",$S(XQN=1:":",1:"s:")
"RTN","XQLOCK",53,0)
 W !!," Option Name",?23,"Option Text",?62,"Locked With",!
"RTN","XQLOCK",54,0)
 F XQI=0:1:XQN-1 W !,$P(^TMP($J,"XQ",XQI),U),?22,$P(^TMP($J,"XQ",XQI),U,2),?60,$P(^TMP($J,"XQ",XQI),U,3) D:XQI&'(XQI#15) PAUSE^XQLOCK1 Q:XQI=-1
"RTN","XQLOCK",55,0)
 Q
"RTN","XQLOCK",56,0)
 ;
"RTN","XQLOCK",57,0)
SHOW ;Show the current set of keys
"RTN","XQLOCK",58,0)
 W !!,"This is the current set of keys we are working with: ",! S XQJ="",XQI=5 F XQK=0:1 S XQJ=$O(XQKEY(XQJ)) Q:XQJ=""  W:'(XQK#XQI) ! W ?(XQK#XQI*15),XQJ
"RTN","XQLOCK",59,0)
 Q
"RTN","XQLOCK",60,0)
 ;
"RTN","XQLOCK",61,0)
CHUZ1 W !!,"Please enter one of the following codes:",!!?5,"'A' means allocate these keys",!?5,"'D' means delegate this key set"
"RTN","XQLOCK",62,0)
 W !?5,"'E' to edit the set of keys you wish to allocate",!?5,"'^' or 'RETURN' to quit",!?5,"'L' to list the locked options again, or",!?5,"'S' to show the set of keys you are allocating again."
"RTN","XQLOCK",63,0)
 R !!,"Enter A, D, E, ^, L, or S: ",XQUR:DTIME S:XQUR="" XQUR=U Q:XQUR=U
"RTN","XQLOCK",64,0)
 I "AaDdEe^LlSs"'[$E(XQUR,1) W $C(7),"?? " G CHUZ1
"RTN","XQLOCK",65,0)
 I XQUR="A"!(XQUR="a") S XQAL=1 D:'$D(XQUSR) USR D:$D(XQUSR) DOIT K XQUS Q:XQEN=2  G CHUZ1
"RTN","XQLOCK",66,0)
 I XQUR="D"!(XQUR="d") S XQAL=0 D:'$D(XQUSR) USR D:$D(XQUSR) DOIT K XQUSR Q:XQEN=2  G CHUZ1
"RTN","XQLOCK",67,0)
 I XQUR="E"!(XQUR="e") D EDIT^XQLOCK1 Q:XQUR=U  G CHUZ1
"RTN","XQLOCK",68,0)
 I XQUR="L"!(XQUR="l") D DISP G CHUZ1
"RTN","XQLOCK",69,0)
 I XQUR="S"!(XQUR="s") D SHOW G CHUZ1
"RTN","XQLOCK",70,0)
 Q
"RTN","XQLOCK",71,0)
 ;
"RTN","XQLOCK",72,0)
DOIT ;Add the key set to a user's Aloocated or Delegated Keys file
"RTN","XQLOCK",73,0)
 N DA,DIC,X
"RTN","XQLOCK",74,0)
 S XQFL=$S(XQAL:51,1:52),DIC="^VA(200,"_+XQUSR_","_XQFL_",",DIC(0)="NMQ",DIC("P")=$S(XQAL:"200.051PA",1:"200.052P"),DA(1)=XQUSR
"RTN","XQLOCK",75,0)
 S XQNXT="" F  S XQNXT=$O(XQKEY(XQNXT)) Q:XQNXT=""  S X=XQKEY(XQNXT),DINUM=X I '$D(^VA(200,XQUSR,XQFL,"B",X,X)) D FILE^DICN
"RTN","XQLOCK",76,0)
 K DINUM
"RTN","XQLOCK",77,0)
 S XQZZGOOD=1
"RTN","XQLOCK",78,0)
 Q
"RTN","XQLOCK",79,0)
 ;
"RTN","XQLOCK",80,0)
OUT ;Clean up and quit
"RTN","XQLOCK",81,0)
 S:$D(XQSAV) XQDIC=XQSAV
"RTN","XQLOCK",82,0)
 K ^TMP($J,"XQ")
"RTN","XQLOCK",83,0)
 K %,DA,DIC,X,XQ,XQAL,XQEN,XQBOSS,XQI,XQIJ,XQJ,XQK,XQKEY,XQKN,XQMENU,XQN,XQNM,XQNXT,XQOP,XQSAV,XQSAVE1,XQTXT,XQUR,XQUSR,XQX,XQZZGOOD,Y
"RTN","XQLOCK",84,0)
 Q
"RTN","XQLOCK",85,0)
 ;
"RTN","XQLOCK",86,0)
GOT1 ;Record a lock
"RTN","XQLOCK",87,0)
 S XQKN=$O(^DIC(19.1,"B",XQK,0))
"RTN","XQLOCK",88,0)
 I 'XQBOSS Q:'$D(^VA(200,DUZ,52,XQKN))  ;DUZ can't allocate that key
"RTN","XQLOCK",89,0)
 I $D(XQUSR) Q:$D(^VA(200,+XQUSR,51,"B",XQKN))  ;User already owns that key
"RTN","XQLOCK",90,0)
 S:'$D(ZTQUEUED) ^TMP($J,"XQ",XQN)="["_XQNM_"]  "_U_XQTXT_U_" <== "_XQK
"RTN","XQLOCK",91,0)
 S XQN=XQN+1
"RTN","XQLOCK",92,0)
 S XQKEY(XQK)=XQKN
"RTN","XQLOCK",93,0)
 Q
"RTN","XQLOCK",94,0)
 ;
"RTN","XQLOCK",95,0)
SHO ;Show the primary and secondary menus of +XQUSR
"RTN","XQLOCK",96,0)
 S %=+^VA(200,+XQUSR,201),XQMENU(1)=%_U_$P(^DIC(19,%,0),U,1,2)
"RTN","XQLOCK",97,0)
 I XQMENU(1)="" W !!?5,"==> ",$P(XQUSR,U,2)," has no primary menu." S Y=-1 Q
"RTN","XQLOCK",98,0)
 S %=0 F XQI=2:1  S %=$O(^VA(200,+XQUSR,203,%)) Q:%'>0  S XQSM=+^(%,0) I $D(^DIC(19,XQSM,0))#2 S XQMENU(XQI)=XQSM_U_$P(^(0),U,1,2)
"RTN","XQLOCK",99,0)
 I '$D(ZTQUEUED) W ! S XQIJ=0 F  S XQIJ=$O(XQMENU(XQIJ)) Q:XQIJ=""  W !,XQIJ,". ",$P(XQMENU(XQIJ),U,2),?23,$P(XQMENU(XQIJ),U,3),?62,$S(XQIJ=1:"Primary Menu",1:"Secondary") D:'(XQIJ#22) PAUSE^XQLOCK1
"RTN","XQLOCK",100,0)
 Q
"RTN","XQLOCK",101,0)
 ;
"RTN","XQLOCK",102,0)
KEY ;Look up a key in the Key file and get its number
"RTN","XQLOCK",103,0)
 S XQ=$O(^DIC(19.1,"B",XQK,0)) I XQ="" W $C(7),!!?5,"==> A key named ",XQK," ??",!
"RTN","XQLOCK",104,0)
 Q
"RTN","XQTOC")
0^15^B16630019
"RTN","XQTOC",1,0)
XQTOC ;SEA/MJM - Time Out/Continue/Jump Start ;05/31/2001  10:57
"RTN","XQTOC",2,0)
 ;;8.0;KERNEL;**20,157**;Jul 10, 1995
"RTN","XQTOC",3,0)
 ;
"RTN","XQTOC",4,0)
 S ^XUTL("XQ",$J,1)=XQY_XQPSM_U_XQY0,^("T")=1
"RTN","XQTOC",5,0)
 Q:XQJS=0
"RTN","XQTOC",6,0)
 S %=^VA(200,DUZ,202.1) K ^(202.1) S $P(XQJS,U,2)=%,XQY=+%,XQPSM=$P(%,XQY,2,99),XQDIC=$S(XQPSM[",":$P(XQPSM,",",2),1:XQPSM)
"RTN","XQTOC",7,0)
 I '$D(^XUTL("XQO",XQDIC,"^",XQY)) D NOGO Q
"RTN","XQTOC",8,0)
 D
"RTN","XQTOC",9,0)
 .N %
"RTN","XQTOC",10,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQTOC",11,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQTOC",12,0)
 .I %]"" S XQOPTN=$P(%,"^",1,99)
"RTN","XQTOC",13,0)
 .E  D NOGO S XQFAIL=""
"RTN","XQTOC",14,0)
 .Q
"RTN","XQTOC",15,0)
 I $D(XQFAIL) K XQFAIL Q
"RTN","XQTOC",16,0)
 ;
"RTN","XQTOC",17,0)
 W !!,"You were last executing the '",$P(XQOPTN,U,3),"' menu option."
"RTN","XQTOC",18,0)
ASK W !,"Do you wish to resume" S %=1 D YN^DICN I '% W !!,"If you wish to continue at the last option you were executing, enter 'Y',",! G ASK
"RTN","XQTOC",19,0)
 I %=1
"RTN","XQTOC",20,0)
 E  D NOGO Q
"RTN","XQTOC",21,0)
 ;
"RTN","XQTOC",22,0)
 ;S XQY0=$P(^XUTL("XQO",XQDIC,"^",XQY),U,2,99)
"RTN","XQTOC",23,0)
 D
"RTN","XQTOC",24,0)
 .N %
"RTN","XQTOC",25,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQTOC",26,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQTOC",27,0)
 .I %]"" S XQY0=$P(%,"^",2,99)
"RTN","XQTOC",28,0)
 .E  D NOGO S XQFAIL=""
"RTN","XQTOC",29,0)
 .Q
"RTN","XQTOC",30,0)
 I $D(XQFAIL) K XQFAIL Q
"RTN","XQTOC",31,0)
 ;
"RTN","XQTOC",32,0)
 I $D(^XUTL("XQO",XQDIC,"^",XQY,0)) D
"RTN","XQTOC",33,0)
 .S XQ=^(0)
"RTN","XQTOC",34,0)
 .F XQI=1:1:XQ D
"RTN","XQTOC",35,0)
 ..N %
"RTN","XQTOC",36,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI))
"RTN","XQTOC",37,0)
 ..I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY,0,XQI))
"RTN","XQTOC",38,0)
 ..I %]"" S XQ(XQI)=% ;$P(^XUTL("XQO",XQDIC,"^",XQY,0,XQI),U)
"RTN","XQTOC",39,0)
 ..Q
"RTN","XQTOC",40,0)
 .Q
"RTN","XQTOC",41,0)
 E  S XQ=0
"RTN","XQTOC",42,0)
 Q
"RTN","XQTOC",43,0)
 ;
"RTN","XQTOC",44,0)
SET ;Set up variables to GO JUMP^XQ72.  Enter from ASK1+1^XQ
"RTN","XQTOC",45,0)
 S %=^XUTL("XQ",$J,1),XQSV=+%_U_+%_U_$P(%,U,2,99)
"RTN","XQTOC",46,0)
 K XQJS
"RTN","XQTOC",47,0)
 Q
"RTN","XQTOC",48,0)
 ;
"RTN","XQTOC",49,0)
LOOK ;Look up the Jump Start Entry
"RTN","XQTOC",50,0)
 F  Q:XQUR'[U  S XQUR=$P(XQUR,U,2)
"RTN","XQTOC",51,0)
 I '$L(XQUR) D NOGO Q
"RTN","XQTOC",52,0)
 D S^XQ75 I 'XQY D NOGO Q
"RTN","XQTOC",53,0)
 Q
"RTN","XQTOC",54,0)
 ;
"RTN","XQTOC",55,0)
NOGO ;Continue fails: reset to primary menu
"RTN","XQTOC",56,0)
 S XQY=^XUTL("XQ",$J,"XQM"),XQA3="",XQA=0 K XQCON,XQRE,XQJS,XQUR,XQOPTN
"RTN","XQTOC",57,0)
 D S1^XQCHK ; Reconstruct XQY0
"RTN","XQTOC",58,0)
 S $P(^XUTL("XQ",$J,0),U,3)=$P(^(0),U,3)_", NOGO"
"RTN","XQTOC",59,0)
 Q
"RTN","XQTOC",60,0)
 ;
"RTN","XQTOC",61,0)
 ;
"RTN","XQTOC",62,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQTOC",63,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQTOC",64,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQTOC",65,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_" Option: " G ASK^XQ
"RTN","XQTOC",66,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQTOC",67,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQTOC",68,0)
 W !!,$P("Great^OK^All right^Well certainly^Fine","^",$R(5)+1),".  ",$P("See you later.^I'll be ready when you are.^Hurry back!^Have a nice lunch.","^",$R(3)+X+1)
"RTN","XQTOC",69,0)
 G H^XUS
"RTN","XQTOC",70,0)
 ;
"RTN","XQTOC",71,0)
SS ;Search Secondaries for a particular option.
"RTN","XQTOC",72,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQTOC",73,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=+^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQTOC",74,0)
 Q
"RTN","XUSERNEW")
0^19^B18286823
"RTN","XUSERNEW",1,0)
XUSERNEW ;SF/RWF - ADD NEW USER ;01/29/2002  08:01
"RTN","XUSERNEW",2,0)
 ;;8.0;KERNEL;**16,49,134,208,157**;Jul 10, 1995
"RTN","XUSERNEW",3,0)
 ;In the call to NEW^XM for new users the variable XMZ must be undef.
"RTN","XUSERNEW",4,0)
 ;on a reactivation XMZ should be set to the current max message number.
"RTN","XUSERNEW",5,0)
EN ;Add
"RTN","XUSERNEW",6,0)
 S Y=$$ADD("","",1) G EXIT:Y'>0,RE:$P(Y,U,3)'=1
"RTN","XUSERNEW",7,0)
 S DR="["_$$GET^XUPARAM("XUNEW USER","N")_"]"
"RTN","XUSERNEW",8,0)
 S XUN=+Y,DIE=200,DA=XUN D XUDIE^XUS5 G:$D(DTOUT) EXIT
"RTN","XUSERNEW",9,0)
 S Y=XUN K XMZ D NEW^XM K XMDT,XMM,XMZ
"RTN","XUSERNEW",10,0)
 ;ACCESS LETTER, Also see XUSERBLK
"RTN","XUSERNEW",11,0)
 W ! D LETTER(XUN,1)
"RTN","XUSERNEW",12,0)
 K DIR,DIWF,XUTEXT
"RTN","XUSERNEW",13,0)
 ;
"RTN","XUSERNEW",14,0)
 ;Fall in from above, called from REACT
"RTN","XUSERNEW",15,0)
KEYS S DIR(0)="Y",DIR("B")="NO",DIR("A")="Do you wish to allocate security keys" D ^DIR G:$D(DIRUT) EXIT
"RTN","XUSERNEW",16,0)
 I Y=1 S XQHOLD(XUN)="",XQKEY(0)=0,XQDA=0,XQAL=1,XQ6="",XQFL="" D KEY^XQ6
"RTN","XUSERNEW",17,0)
 ;
"RTN","XUSERNEW",18,0)
 ;Check on adding this user to user groups
"RTN","XUSERNEW",19,0)
 I $P(^VA(200,XUN,0),U,3)'="" D  ;Must have access code & mailbox
"RTN","XUSERNEW",20,0)
 .N DIR,Y
"RTN","XUSERNEW",21,0)
 .S DIR(0)="Y",DIR("B")="NO",DIR("A")="Do you wish to add this user to mail groups" D ^DIR G:$D(DIRUT) EXIT
"RTN","XUSERNEW",22,0)
 .I Y=1 D ENLOCAL1^XMVGRP(XUN)
"RTN","XUSERNEW",23,0)
 .K XMDUN,XMDUZ,XMV
"RTN","XUSERNEW",24,0)
 .Q
"RTN","XUSERNEW",25,0)
 ;
"RTN","XUSERNEW",26,0)
EXIT K D0,DA,DDER,DDSFILE,DIE,DIC,DIR,DI,DICR,DIG,DIH,DISYS,DIU,DIV,DIWT,DLAYGO,DR,DQ,K,I,X,X1,XQHOLD,XQKEY,XUN,XUSOLD,XMB,XMZ,Y,Z,XQ6,XQFL,DTOUT
"RTN","XUSERNEW",27,0)
 Q
"RTN","XUSERNEW",28,0)
 ;
"RTN","XUSERNEW",29,0)
RE ;Jump from new user to reactivate
"RTN","XUSERNEW",30,0)
 S XUN=+Y,DIR("A")="This isn't a new user, Want to reactivate?",DIR(0)="Y",DIR("B")="NO" D ^DIR G EXIT:$D(DIRUT)!(Y'=1),RE2
"RTN","XUSERNEW",31,0)
 ;Reactivate a user
"RTN","XUSERNEW",32,0)
REACT ;SEA/WDE-REACTIVATE A USER
"RTN","XUSERNEW",33,0)
 N XUN,XUSOLD,DIE,DIC,DA,DR,FDA
"RTN","XUSERNEW",34,0)
 S XUN=+$$LOOKUP^XUSER G EXIT:XUN<0
"RTN","XUSERNEW",35,0)
RE2 S XUSOLD=^VA(200,XUN,0)
"RTN","XUSERNEW",36,0)
 S FDA(200,XUN_",",9.2)="@" ;Clear the Termination date
"RTN","XUSERNEW",37,0)
 D UPDATE^DIE("E","FDA")
"RTN","XUSERNEW",38,0)
 ;Show the screanman form
"RTN","XUSERNEW",39,0)
 S DIE=200,DR="["_$$GET^XUPARAM("XUREACT USER","N")_"]",DA=XUN D XUDIE^XUS5 G:$D(DTOUT) EXIT
"RTN","XUSERNEW",40,0)
 I $P(^VA(200,XUN,0),U,3)="" W !!,"No ACCESS CODE has been entered.",$C(7),!
"RTN","XUSERNEW",41,0)
 I $P(^VA(200,XUN,0),U,11)>0,$P(^(0),U,11)'>DT W !!,"User is still TERMINATED.",$C(7),!
"RTN","XUSERNEW",42,0)
 S DIR(0)="Y",DIR("A")="Deny access to old mail messages",DIR("B")="NO",DIR("?")="Enter a 'YES' to restrict access to old mail messages." D ^DIR G:$D(DIRUT) EXIT
"RTN","XUSERNEW",43,0)
 K XMZ S:Y=1 XMZ=+$P(^XMB(3.9,0),"^",3) S Y=XUN D NEW^XM K XMDT,XMM,XMZ
"RTN","XUSERNEW",44,0)
 D REACT^XQ84(XUN) ;See if this user's menu trees need to be rebuilt
"RTN","XUSERNEW",45,0)
 G KEYS
"RTN","XUSERNEW",46,0)
 Q
"RTN","XUSERNEW",47,0)
ADD(NP1,KEYS,NONC) ;Common point to do DIC call for adding a new person.
"RTN","XUSERNEW",48,0)
 ;NP1 will be added to the default or what comes from the NPI field of the KSP.
"RTN","XUSERNEW",49,0)
 ;KEYS is a list of Keys to give the new person
"RTN","XUSERNEW",50,0)
 N DA,DR,DLAYGO,XUITNAME,XUS1,XUS2,DIC,DIE,DIK,NP2,Y I $G(^XTV(8989.3,1,"NPI"))]"" X ^("NPI") S NP2=DR
"RTN","XUSERNEW",51,0)
 S:'$D(NP2) NP2="1;"_$S($D(^XUSEC("XUSPF200",DUZ)):9,1:"9R~")_";4"
"RTN","XUSERNEW",52,0)
 S DIC="^VA(200,",DIC(0)="AELMQ",DLAYGO=200,DIC("A")="Enter NEW PERSON's name (Family,Given Middle Suffix): ",DIC("DR")="",XUITNAME=1
"RTN","XUSERNEW",53,0)
 D ^DIC S XUS1=Y G AX:(Y'>0)!($P(Y,U,3)'>0)
"RTN","XUSERNEW",54,0)
 S DA=+$G(^VA(200,+XUS1,3.1)) I DA,'$G(NONC) D
"RTN","XUSERNEW",55,0)
 . W !,"Name components."
"RTN","XUSERNEW",56,0)
 . S DIE="^VA(20,",DR="1;2;3;5"
"RTN","XUSERNEW",57,0)
 . L +^VA(20,DA,0):60 D ^DIE L -^VA(20,DA,0)
"RTN","XUSERNEW",58,0)
 . I $D(Y)!$D(DTOUT) S DA=+XUS1,XUS1=-1
"RTN","XUSERNEW",59,0)
 . E  S $P(XUS1,U,2)=$P(^VA(200,+XUS1,0),U)
"RTN","XUSERNEW",60,0)
 D:XUS1>0
"RTN","XUSERNEW",61,0)
 . W !,"Now for the Identifiers."
"RTN","XUSERNEW",62,0)
 . S DA=+XUS1,DIE="^VA(200,",DR=NP2_$S($D(NP1):";"_NP1,1:""),DIE("NO^")="OUTOK"
"RTN","XUSERNEW",63,0)
 . L +^VA(200,DA,0):60 D ^DIE L -^VA(200,DA,0)
"RTN","XUSERNEW",64,0)
 . S:$D(Y)!$D(DTOUT) XUS1=-1
"RTN","XUSERNEW",65,0)
 I XUS1<0 D  S XUS1=-1
"RTN","XUSERNEW",66,0)
 . W !?5,"<'",$P(^VA(200,DA,0),U),"' DELETED>"
"RTN","XUSERNEW",67,0)
 . S DIK="^VA(200," D ^DIK
"RTN","XUSERNEW",68,0)
 . Q:$P($G(^DIC(3,0)),U)'="USER"!'$D(^DD(3,0))
"RTN","XUSERNEW",69,0)
 . S DIK="^DIC(3,",XUS1=$P($G(^DIC(3,DA,0)),U,16) D ^DIK
"RTN","XUSERNEW",70,0)
 . Q:'XUS1!($P($G(^DIC(16,0)),U)'="PERSON")!'$D(^DD(16,0))
"RTN","XUSERNEW",71,0)
 . S DIK="^DIC(16,",DA=XUS1 D ^DIK
"RTN","XUSERNEW",72,0)
 I XUS1>0,$D(KEYS) F XUS2=1:1 S Y=$P(KEYS,",",XUS2) Q:'$L(Y)  S %=$$ADD^XQKEY(XUS1,Y) I '% W !,"Key '",Y,"' not allocated"
"RTN","XUSERNEW",73,0)
AX Q XUS1
"RTN","XUSERNEW",74,0)
REPRINT S DA=+$$LOOKUP^XUSER G EXIT:DA'>0
"RTN","XUSERNEW",75,0)
 D LETTER(DA) G EXIT
"RTN","XUSERNEW",76,0)
LETTER(XUN,ASK) ;Print access letter
"RTN","XUSERNEW",77,0)
 Q:'$G(XUN)  N DIWF,FR,TO,BY,DIR
"RTN","XUSERNEW",78,0)
 S XUTEXT=$$GET^XUPARAM("XUSER COMPUTER ACCOUNT","N"),XUTEXT=$O(^DIC(9.2,"B",XUTEXT,0))
"RTN","XUSERNEW",79,0)
 S DIR(0)="Y",DIR("A")="Print User Account Access Letter"
"RTN","XUSERNEW",80,0)
 I XUTEXT>0 S Y=1 D:$G(ASK) ^DIR I Y=1 D
"RTN","XUSERNEW",81,0)
 . S XUU="________",DIWF="^DIC(9.2,XUTEXT,1,",DIWF(1)=200,FR=XUN,TO=XUN,BY="NUMBER" D EN2^DIWF
"RTN","XUSERNEW",82,0)
 . Q
"RTN","XUSERNEW",83,0)
 K XUTEXT
"RTN","XUSERNEW",84,0)
 Q
"VER")
8.0^22.0
**END**
**END**
