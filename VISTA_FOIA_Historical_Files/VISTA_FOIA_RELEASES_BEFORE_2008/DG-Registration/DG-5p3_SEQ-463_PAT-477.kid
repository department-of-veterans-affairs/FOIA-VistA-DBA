Released DG*5.3*477 SEQ #463
Extracted from mail message
**KIDS**:DG*5.3*477^

**INSTALL NAME**
DG*5.3*477
"BLD",1596,0)
DG*5.3*477^REGISTRATION^0^3030815^y
"BLD",1596,1,0)
^^3^3^3030815^
"BLD",1596,1,1,0)
PATIENT DATA REVIEW FIXES & ENHANCEMENTS
"BLD",1596,1,2,0)
Refer to patch DG*5.3*477 in the FORUM Patch Module for a complete
"BLD",1596,1,3,0)
description.
"BLD",1596,4,0)
^9.64PA^2^1
"BLD",1596,4,2,0)
2
"BLD",1596,4,2,2,0)
^9.641^2^1
"BLD",1596,4,2,2,2,0)
PATIENT  (File-top level)
"BLD",1596,4,2,2,2,1,0)
^9.6411^.313^1
"BLD",1596,4,2,2,2,1,.313,0)
CLAIM NUMBER
"BLD",1596,4,2,222)
y^n^p^^^^n
"BLD",1596,4,"APDD",2,2)

"BLD",1596,4,"APDD",2,2,.313)

"BLD",1596,4,"B",2,2)

"BLD",1596,"ABNS",0)
^9.66A^^
"BLD",1596,"ABPKG")
^^
"BLD",1596,"INID")
^y
"BLD",1596,"INIT")
DG477PST
"BLD",1596,"KRN",0)
^9.67PA^8989.52^19
"BLD",1596,"KRN",.4,0)
.4
"BLD",1596,"KRN",.4,"NM",0)
^9.68A^^
"BLD",1596,"KRN",.401,0)
.401
"BLD",1596,"KRN",.402,0)
.402
"BLD",1596,"KRN",.403,0)
.403
"BLD",1596,"KRN",.5,0)
.5
"BLD",1596,"KRN",.84,0)
.84
"BLD",1596,"KRN",3.6,0)
3.6
"BLD",1596,"KRN",3.8,0)
3.8
"BLD",1596,"KRN",9.2,0)
9.2
"BLD",1596,"KRN",9.8,0)
9.8
"BLD",1596,"KRN",9.8,"NM",0)
^9.68A^20^18
"BLD",1596,"KRN",9.8,"NM",2,0)
DG477PST^^0^B19551869
"BLD",1596,"KRN",9.8,"NM",3,0)
VAFCRAUD^^0^B56907832
"BLD",1596,"KRN",9.8,"NM",5,0)
VAFCMGB3^^0^B32503031
"BLD",1596,"KRN",9.8,"NM",6,0)
VAFCMGA^^0^B56478936
"BLD",1596,"KRN",9.8,"NM",7,0)
VAFCMGB0^^0^B46238892
"BLD",1596,"KRN",9.8,"NM",8,0)
VAFCMGA1^^0^B19845162
"BLD",1596,"KRN",9.8,"NM",9,0)
VAFCEHU1^^0^B53748283
"BLD",1596,"KRN",9.8,"NM",10,0)
VAFCQRY1^^0^B46708922
"BLD",1596,"KRN",9.8,"NM",11,0)
VAFCLAU^^0^B5114636
"BLD",1596,"KRN",9.8,"NM",12,0)
VAFCMGB1^^0^B42175654
"BLD",1596,"KRN",9.8,"NM",13,0)
VAFCRAU^^0^B6506773
"BLD",1596,"KRN",9.8,"NM",14,0)
VAFCEHU2^^0^B58810198
"BLD",1596,"KRN",9.8,"NM",15,0)
VAFCEHU3^^0^B21615424
"BLD",1596,"KRN",9.8,"NM",16,0)
VAFCEHLM^^0^B19208241
"BLD",1596,"KRN",9.8,"NM",17,0)
VAFCAUD^^0^B24016806
"BLD",1596,"KRN",9.8,"NM",18,0)
VAFCRPC^^0^B4310892
"BLD",1596,"KRN",9.8,"NM",19,0)
VAFCHFS^^0^B30461172
"BLD",1596,"KRN",9.8,"NM",20,0)
VAFCMSG3^^0^B30137539
"BLD",1596,"KRN",9.8,"NM","B","DG477PST",2)

"BLD",1596,"KRN",9.8,"NM","B","VAFCAUD",17)

"BLD",1596,"KRN",9.8,"NM","B","VAFCEHLM",16)

"BLD",1596,"KRN",9.8,"NM","B","VAFCEHU1",9)

"BLD",1596,"KRN",9.8,"NM","B","VAFCEHU2",14)

"BLD",1596,"KRN",9.8,"NM","B","VAFCEHU3",15)

"BLD",1596,"KRN",9.8,"NM","B","VAFCHFS",19)

"BLD",1596,"KRN",9.8,"NM","B","VAFCLAU",11)

"BLD",1596,"KRN",9.8,"NM","B","VAFCMGA",6)

"BLD",1596,"KRN",9.8,"NM","B","VAFCMGA1",8)

"BLD",1596,"KRN",9.8,"NM","B","VAFCMGB0",7)

"BLD",1596,"KRN",9.8,"NM","B","VAFCMGB1",12)

"BLD",1596,"KRN",9.8,"NM","B","VAFCMGB3",5)

"BLD",1596,"KRN",9.8,"NM","B","VAFCMSG3",20)

"BLD",1596,"KRN",9.8,"NM","B","VAFCQRY1",10)

"BLD",1596,"KRN",9.8,"NM","B","VAFCRAU",13)

"BLD",1596,"KRN",9.8,"NM","B","VAFCRAUD",3)

"BLD",1596,"KRN",9.8,"NM","B","VAFCRPC",18)

"BLD",1596,"KRN",19,0)
19
"BLD",1596,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",1596,"KRN",19,"NM",1,0)
VAFC PDR PURGE^^0
"BLD",1596,"KRN",19,"NM",2,0)
RG ADMIN USER MENU^^2
"BLD",1596,"KRN",19,"NM","B","RG ADMIN USER MENU",2)

"BLD",1596,"KRN",19,"NM","B","VAFC PDR PURGE",1)

"BLD",1596,"KRN",19.1,0)
19.1
"BLD",1596,"KRN",101,0)
101
"BLD",1596,"KRN",101,"NM",0)
^9.68A^23^23
"BLD",1596,"KRN",101,"NM",1,0)
VAFC EXCPT DISPLAY ONLY QUERY^^0
"BLD",1596,"KRN",101,"NM",2,0)
VAFC EXCPT HINQ INQUIRY^^0
"BLD",1596,"KRN",101,"NM",3,0)
VAFC EXCPT MERGE ALL^^0
"BLD",1596,"KRN",101,"NM",4,0)
VAFC EXCPT MERGE COMPLETE^^0
"BLD",1596,"KRN",101,"NM",5,0)
VAFC EXCPT MERGE MENU^^0
"BLD",1596,"KRN",101,"NM",6,0)
VAFC EXCPT MERGE REJECT^^0
"BLD",1596,"KRN",101,"NM",7,0)
VAFC EXCPT MERGE SELECTED^^0
"BLD",1596,"KRN",101,"NM",8,0)
VAFC EXCPT MERGE UNDO^^0
"BLD",1596,"KRN",101,"NM",9,0)
VAFC EXCPT MPI/PD DATA^^0
"BLD",1596,"KRN",101,"NM",10,0)
VAFC EXCPT PATIENT AUDIT^^0
"BLD",1596,"KRN",101,"NM",11,0)
VAFC EXCPT PATIENT AUDIT MENU^^0
"BLD",1596,"KRN",101,"NM",12,0)
VAFC EXCPT PATIENT INQUIRY^^0
"BLD",1596,"KRN",101,"NM",13,0)
VAFC EXCPT PUSH CMOR^^0
"BLD",1596,"KRN",101,"NM",14,0)
VAFC EXCPT RPA CHECK^^0
"BLD",1596,"KRN",101,"NM",15,0)
VAFC EXCPT RPA DISPLAY^^0
"BLD",1596,"KRN",101,"NM",16,0)
VAFC EXCPT RPA SEND^^0
"BLD",1596,"KRN",101,"NM",17,0)
VAFC EXCPT SUM ACTS MENU^^0
"BLD",1596,"KRN",101,"NM",18,0)
VAFC EXCPT SUM NEW^^0
"BLD",1596,"KRN",101,"NM",19,0)
VAFC EXCPT SUM OLD^^0
"BLD",1596,"KRN",101,"NM",20,0)
VAFC EXCPT SUM PAT^^0
"BLD",1596,"KRN",101,"NM",21,0)
VAFC EXCPT SUM REV FULL^^0
"BLD",1596,"KRN",101,"NM",22,0)
VAFC EXCPT SUM SITE^^0
"BLD",1596,"KRN",101,"NM",23,0)
VAFC EXCPT TF INQUIRY^^0
"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT DISPLAY ONLY QUERY",1)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT HINQ INQUIRY",2)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MERGE ALL",3)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MERGE COMPLETE",4)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MERGE MENU",5)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MERGE REJECT",6)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MERGE SELECTED",7)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MERGE UNDO",8)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT MPI/PD DATA",9)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT PATIENT AUDIT",10)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT PATIENT AUDIT MENU",11)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT PATIENT INQUIRY",12)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT PUSH CMOR",13)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT RPA CHECK",14)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT RPA DISPLAY",15)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT RPA SEND",16)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT SUM ACTS MENU",17)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT SUM NEW",18)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT SUM OLD",19)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT SUM PAT",20)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT SUM REV FULL",21)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT SUM SITE",22)

"BLD",1596,"KRN",101,"NM","B","VAFC EXCPT TF INQUIRY",23)

"BLD",1596,"KRN",409.61,0)
409.61
"BLD",1596,"KRN",409.61,"NM",0)
^9.68A^2^2
"BLD",1596,"KRN",409.61,"NM",1,0)
VAFC EXCPT LOCAL AUDIT^^0
"BLD",1596,"KRN",409.61,"NM",2,0)
VAFC EXCPT REMOTE AUDIT^^0
"BLD",1596,"KRN",409.61,"NM","B","VAFC EXCPT LOCAL AUDIT",1)

"BLD",1596,"KRN",409.61,"NM","B","VAFC EXCPT REMOTE AUDIT",2)

"BLD",1596,"KRN",771,0)
771
"BLD",1596,"KRN",870,0)
870
"BLD",1596,"KRN",8989.51,0)
8989.51
"BLD",1596,"KRN",8989.52,0)
8989.52
"BLD",1596,"KRN",8994,0)
8994
"BLD",1596,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",1596,"KRN",8994,"NM",1,0)
VAFC REMOTE AUDIT^^0
"BLD",1596,"KRN",8994,"NM","B","VAFC REMOTE AUDIT",1)

"BLD",1596,"KRN","B",.4,.4)

"BLD",1596,"KRN","B",.401,.401)

"BLD",1596,"KRN","B",.402,.402)

"BLD",1596,"KRN","B",.403,.403)

"BLD",1596,"KRN","B",.5,.5)

"BLD",1596,"KRN","B",.84,.84)

"BLD",1596,"KRN","B",3.6,3.6)

"BLD",1596,"KRN","B",3.8,3.8)

"BLD",1596,"KRN","B",9.2,9.2)

"BLD",1596,"KRN","B",9.8,9.8)

"BLD",1596,"KRN","B",19,19)

"BLD",1596,"KRN","B",19.1,19.1)

"BLD",1596,"KRN","B",101,101)

"BLD",1596,"KRN","B",409.61,409.61)

"BLD",1596,"KRN","B",771,771)

"BLD",1596,"KRN","B",870,870)

"BLD",1596,"KRN","B",8989.51,8989.51)

"BLD",1596,"KRN","B",8989.52,8989.52)

"BLD",1596,"KRN","B",8994,8994)

"BLD",1596,"QUES",0)
^9.62^^
"BLD",1596,"REQB",0)
^9.611^9^6
"BLD",1596,"REQB",4,0)
DG*5.3*474^2
"BLD",1596,"REQB",5,0)
DG*5.3*307^2
"BLD",1596,"REQB",6,0)
DG*5.3*454^2
"BLD",1596,"REQB",7,0)
DG*5.3*384^2
"BLD",1596,"REQB",8,0)
DG*5.3*484^2
"BLD",1596,"REQB",9,0)
DG*5.3*244^2
"BLD",1596,"REQB","B","DG*5.3*244",9)

"BLD",1596,"REQB","B","DG*5.3*307",5)

"BLD",1596,"REQB","B","DG*5.3*384",7)

"BLD",1596,"REQB","B","DG*5.3*454",6)

"BLD",1596,"REQB","B","DG*5.3*474",4)

"BLD",1596,"REQB","B","DG*5.3*484",8)

"FIA",2)
PATIENT
"FIA",2,0)
^DPT(
"FIA",2,0,0)
2I
"FIA",2,0,1)
y^n^p^^^^n
"FIA",2,0,10)

"FIA",2,0,11)

"FIA",2,0,"RLRO")

"FIA",2,0,"VR")
5.3^DG
"FIA",2,2)
1
"FIA",2,2,.313)

"INIT")
DG477PST
"KRN",19,5664,-1)
2^2
"KRN",19,5664,0)
RG ADMIN USER MENU^MPI/PD Patient Admin User Menu^^M^^^^^^^^272
"KRN",19,5664,10,0)
^19.01IP^3^3
"KRN",19,5664,10,3,0)
6871^^5
"KRN",19,5664,10,3,"^")
VAFC PDR PURGE
"KRN",19,5664,"U")
MPI/PD PATIENT ADMIN USER MENU
"KRN",19,6871,-1)
0^1
"KRN",19,6871,0)
VAFC PDR PURGE^Purge Patient Data Reviews^^R^^^^^^^^REGISTRATION
"KRN",19,6871,1,0)
^19.06^3^3^3030324^^^
"KRN",19,6871,1,1,0)
This option allows you to purge entries in the PATIENT DATA
"KRN",19,6871,1,2,0)
EXCEPTION (#391.98) and PATIENT DATA ELEMENT (#391.99) files 
"KRN",19,6871,1,3,0)
over 30 days old.
"KRN",19,6871,25)
PDRPRG^VAFCEHLM
"KRN",19,6871,"U")
PURGE PATIENT DATA REVIEWS
"KRN",101,1052,-1)
0^17
"KRN",101,1052,0)
VAFC EXCPT SUM ACTS MENU^Actions for summary screen^^M^^^^^^^^REGISTRATION
"KRN",101,1052,1,0)
^^2^2^2990212^^^
"KRN",101,1052,1,1,0)
This protocol is the main menu for the Clinical Information Resource 
"KRN",101,1052,1,2,0)
Network (CIRN) Patient Data Review [VAFC EXCEPTION HANDLER] summary screen.
"KRN",101,1052,4)
26^4
"KRN",101,1052,10,0)
^101.01PA^6^5
"KRN",101,1052,10,1,0)
1053^SS^4^
"KRN",101,1052,10,1,"^")
VAFC EXCPT SUM SITE
"KRN",101,1052,10,2,0)
1054^SN^6^
"KRN",101,1052,10,2,"^")
VAFC EXCPT SUM NEW
"KRN",101,1052,10,3,0)
1056^SOL^3^
"KRN",101,1052,10,3,"^")
VAFC EXCPT SUM OLD
"KRN",101,1052,10,4,0)
1055^P^5^
"KRN",101,1052,10,4,"^")
VAFC EXCPT SUM PAT
"KRN",101,1052,10,6,0)
1057^SP^1^
"KRN",101,1052,10,6,"^")
VAFC EXCPT SUM REV FULL
"KRN",101,1052,20)

"KRN",101,1052,26)
D SHOW^VALM
"KRN",101,1052,28)
Select Action:
"KRN",101,1052,99)
59211,47862
"KRN",101,1053,-1)
0^22
"KRN",101,1053,0)
VAFC EXCPT SUM SITE^Sort by Site^^A^^^^^^^^REGISTRATION
"KRN",101,1053,1,0)
^^2^2^2990212^^^
"KRN",101,1053,1,1,0)
This protocol sorts the exceptions by site in the Clinical Information
"KRN",101,1053,1,2,0)
Resource Network (CIRN) Patient Data Review [VAFC EXCEPTION HANDLER] option.
"KRN",101,1053,20)
S VAFCSORT="SS" D SACT^VAFCEHLM
"KRN",101,1053,99)
57469,42247
"KRN",101,1054,-1)
0^18
"KRN",101,1054,0)
VAFC EXCPT SUM NEW^Sort by Newest^^A^^^^^^^^REGISTRATION
"KRN",101,1054,1,0)
^^3^3^2990212^^^
"KRN",101,1054,1,1,0)
This protocol sorts the exceptions by newest event in the Clinical 
"KRN",101,1054,1,2,0)
Information Resource Network (CIRN) Patient Data Review [VAFC 
"KRN",101,1054,1,3,0)
EXCEPTION HANDLER] option.
"KRN",101,1054,20)
S VAFCSORT="SN" D SACT^VAFCEHLM
"KRN",101,1054,99)
57180,38695
"KRN",101,1055,-1)
0^20
"KRN",101,1055,0)
VAFC EXCPT SUM PAT^Sort by Patient^^A^^^^^^^^REGISTRATION
"KRN",101,1055,1,0)
^^3^3^2990212^^^
"KRN",101,1055,1,1,0)
This protocol sorts the exceptions by patient in the Clinical 
"KRN",101,1055,1,2,0)
Information Resource Network (CIRN) Patient Data Review [VAFC 
"KRN",101,1055,1,3,0)
EXCEPTION HANDLER] option.
"KRN",101,1055,20)
S VAFCSORT="SP" D SACT^VAFCEHLM
"KRN",101,1055,99)
57180,38695
"KRN",101,1056,-1)
0^19
"KRN",101,1056,0)
VAFC EXCPT SUM OLD^Sort by Oldest^^A^^^^^^^^REGISTRATION
"KRN",101,1056,1,0)
^^3^3^2990212^^^
"KRN",101,1056,1,1,0)
This protocol sorts the exceptions by oldest event in the Clinical 
"KRN",101,1056,1,2,0)
Information Resource Network (CIRN) Patient Data Review [VAFC 
"KRN",101,1056,1,3,0)
EXCEPTION HANDLER] option.
"KRN",101,1056,20)
S VAFCSORT="SO" D SACT^VAFCEHLM
"KRN",101,1056,99)
57180,38695
"KRN",101,1057,-1)
0^21
"KRN",101,1057,0)
VAFC EXCPT SUM REV FULL^Select Patient^^A^^^^^^^^REGISTRATION
"KRN",101,1057,1,0)
^^3^3^2990212^^^^
"KRN",101,1057,1,1,0)
This protocol allows the user to process a selected patient from the 
"KRN",101,1057,1,2,0)
summary screen in the Clinical Information Resource Network (CIRN) 
"KRN",101,1057,1,3,0)
Patient Data Review [VAFC EXCEPTION HANDLER] option.
"KRN",101,1057,20)
D FULL^VAFCEHLM
"KRN",101,1057,28)

"KRN",101,1057,99)
57190,66371
"KRN",101,1059,-1)
0^5
"KRN",101,1059,0)
VAFC EXCPT MERGE MENU^PIMS EXCEPTION MERGE MENU^^M^^^^^^^^REGISTRATION
"KRN",101,1059,1,0)
^101.06^2^2^3001207^^^^
"KRN",101,1059,1,1,0)
This protocol is the Clinical Information Resource Network (CIRN) 
"KRN",101,1059,1,2,0)
Patient Data Review [VAFC EXCEPTION HANDLER] option merge menu.
"KRN",101,1059,4)
26^4
"KRN",101,1059,10,0)
^101.01PA^12^11
"KRN",101,1059,10,1,0)
1060^MA^21^
"KRN",101,1059,10,1,"^")
VAFC EXCPT MERGE ALL
"KRN",101,1059,10,2,0)
1061^MS^11^
"KRN",101,1059,10,2,"^")
VAFC EXCPT MERGE SELECTED
"KRN",101,1059,10,3,0)
1062^RJ^12^
"KRN",101,1059,10,3,"^")
VAFC EXCPT MERGE REJECT
"KRN",101,1059,10,4,0)
1063^MC^22^
"KRN",101,1059,10,4,"^")
VAFC EXCPT MERGE COMPLETE
"KRN",101,1059,10,5,0)
1198^HI^30^
"KRN",101,1059,10,5,"^")
VAFC EXCPT HINQ INQUIRY
"KRN",101,1059,10,6,0)
1201^AUD^35^
"KRN",101,1059,10,6,"^")
VAFC EXCPT PATIENT AUDIT
"KRN",101,1059,10,7,0)
1248^UN^23^
"KRN",101,1059,10,7,"^")
VAFC EXCPT MERGE UNDO
"KRN",101,1059,10,8,0)
1728^PI^40^
"KRN",101,1059,10,8,"^")
VAFC EXCPT PATIENT INQUIRY
"KRN",101,1059,10,9,0)
1753^DO^45^
"KRN",101,1059,10,9,"^")
VAFC EXCPT DISPLAY ONLY QUERY
"KRN",101,1059,10,11,0)
1864^DI^55^
"KRN",101,1059,10,11,"^")
VAFC EXCPT MPI/PD DATA
"KRN",101,1059,10,12,0)
1880^PC^60^
"KRN",101,1059,10,12,"^")
VAFC EXCPT PUSH CMOR
"KRN",101,1059,24)
I 1 X:$D(^ORD(101,+$P(^ORD(101,DA(1),10,DA,0),"^",1),24)) ^(24)
"KRN",101,1059,26)
D SHOW^VALM
"KRN",101,1059,28)
Select Action: 
"KRN",101,1059,99)
58899,31715
"KRN",101,1060,-1)
0^3
"KRN",101,1060,0)
VAFC EXCPT MERGE ALL^Merge All Differences^^A^^^^^^^^REGISTRATION
"KRN",101,1060,1,0)
^^3^3^2990212^^^^
"KRN",101,1060,1,1,0)
This protocol allows the user to merge all differences for a selected 
"KRN",101,1060,1,2,0)
patient in the Clinical Information Resource Network (CIRN) Patient Data 
"KRN",101,1060,1,3,0)
Review [VAFC EXCEPTION HANDLER] option.
"KRN",101,1060,15)

"KRN",101,1060,20)
D MRGALL^VAFCMGA
"KRN",101,1060,99)
58539,45606
"KRN",101,1061,-1)
0^7
"KRN",101,1061,0)
VAFC EXCPT MERGE SELECTED^Selective Merge^^A^^^^^^^^REGISTRATION
"KRN",101,1061,1,0)
^^3^3^2990212^^^^
"KRN",101,1061,1,1,0)
This protocol allows the user to choose selected fields so that they 
"KRN",101,1061,1,2,0)
will merge in the Clinical Information Resource Network (CIRN) Patient 
"KRN",101,1061,1,3,0)
Data Review [VAFC EXCEPTION HANDLER] option.
"KRN",101,1061,15)

"KRN",101,1061,20)
D MRGSLCT^VAFCMGA
"KRN",101,1061,24)
I VALMPGE'=3
"KRN",101,1061,99)
58539,45606
"KRN",101,1062,-1)
0^6
"KRN",101,1062,0)
VAFC EXCPT MERGE REJECT^Reject Merge^^A^^^^^^^^REGISTRATION
"KRN",101,1062,1,0)
^^4^4^2990212^^^^
"KRN",101,1062,1,1,0)
This protocol allows the user to reject differences for a selected 
"KRN",101,1062,1,2,0)
patient so that they will not merge. This is done using the Clinical 
"KRN",101,1062,1,3,0)
Information Resource Network (CIRN) Patient Data Review [VAFC EXCEPTION 
"KRN",101,1062,1,4,0)
HANDLER] option.
"KRN",101,1062,20)
D REJECT^VAFCMGA
"KRN",101,1062,24)
I $D(@VALMAR@("E2F"))
"KRN",101,1062,99)
58539,45606
"KRN",101,1063,-1)
0^4
"KRN",101,1063,0)
VAFC EXCPT MERGE COMPLETE^Merge Completed^^A^^^^^^^^REGISTRATION
"KRN",101,1063,1,0)
^^3^3^2990212^^^^
"KRN",101,1063,1,1,0)
This protocol allows the user to verify that the merge is complete 
"KRN",101,1063,1,2,0)
for a selected patient in the Clinical Information Resource Network 
"KRN",101,1063,1,3,0)
(CIRN) Patient Data Review [VAFC EXCEPTION HANDLER] option.
"KRN",101,1063,20)
D COMPLETE^VAFCMGA
"KRN",101,1063,99)
58539,45606
"KRN",101,1198,-1)
0^2
"KRN",101,1198,0)
VAFC EXCPT HINQ INQUIRY^Hinq Inquiry^^A^^^^^^^^REGISTRATION
"KRN",101,1198,1,0)
^^3^3^2990212^^^^
"KRN",101,1198,1,1,0)
This protocol allows the user to do a HINQ inquiry for a selected 
"KRN",101,1198,1,2,0)
patient in the Clinical Information Resource Network (CIRN) Patient 
"KRN",101,1198,1,3,0)
Data Review [VAFC EXCEPTION HANDLER] option.
"KRN",101,1198,20)
D HI^VAFCMGA
"KRN",101,1198,99)
58539,45606
"KRN",101,1201,-1)
0^10
"KRN",101,1201,0)
VAFC EXCPT PATIENT AUDIT^Patient Audit^^A^^^^^^^^REGISTRATION
"KRN",101,1201,1,0)
^^3^3^2990212^^^^
"KRN",101,1201,1,1,0)
This protocol allows the user to audit the differences made in the 
"KRN",101,1201,1,2,0)
Clinical Information Resource Network (CIRN) Patient Data Review 
"KRN",101,1201,1,3,0)
[VAFC EXCEPTION HANDLER] option.
"KRN",101,1201,20)
D RAUD^VAFCMGA1
"KRN",101,1201,99)
58650,52540
"KRN",101,1248,-1)
0^8
"KRN",101,1248,0)
VAFC EXCPT MERGE UNDO^Undo Merge^^A^^^^^^^^REGISTRATION
"KRN",101,1248,1,0)
^^3^3^2990212^^^^
"KRN",101,1248,1,1,0)
This protocol allows the user to undo selected merges in the Clinical 
"KRN",101,1248,1,2,0)
Information Resource Network (CIRN) Patient Data Review [VAFC EXCEPTION 
"KRN",101,1248,1,3,0)
HANDLER] option.
"KRN",101,1248,20)
D UNDO^VAFCMGA1
"KRN",101,1248,24)
I $D(^TMP("VAFC-UNDO"))
"KRN",101,1248,99)
58539,45606
"KRN",101,1728,-1)
0^12
"KRN",101,1728,0)
VAFC EXCPT PATIENT INQUIRY^Patient Inquiry^^A^^^^^^^^REGISTRATION
"KRN",101,1728,1,0)
^101.06^2^2^3001207^^
"KRN",101,1728,1,1,0)
This protocol allows the user to do a Patient Inquiry from the
"KRN",101,1728,1,2,0)
Patient Data Review option [VAFC EXCEPTION HANDLER].
"KRN",101,1728,20)
D INQ^VAFCEHLM
"KRN",101,1728,99)
58539,45607
"KRN",101,1753,-1)
0^1
"KRN",101,1753,0)
VAFC EXCPT DISPLAY ONLY QUERY^MPI Display Only Query^^A^^^^^^^^REGISTRATION
"KRN",101,1753,1,0)
^101.06^3^3^3030204^^
"KRN",101,1753,1,1,0)
This protocol permits the user to perform a Display Only Query
"KRN",101,1753,1,2,0)
to the MPI from the Patient Data Review option [VAFC EXCEPTION
"KRN",101,1753,1,3,0)
HANDLER].
"KRN",101,1753,20)
D DISP^VAFCEHLM
"KRN",101,1753,99)
58539,45607
"KRN",101,1807,-1)
0^23
"KRN",101,1807,0)
VAFC EXCPT TF INQUIRY^Treating Facility Inq^^A^^^^^^^^REGISTRATION
"KRN",101,1807,1,0)
^101.06^3^3^3001206^^
"KRN",101,1807,1,1,0)
This protocol displays Clinical Information Resource Network - 
"KRN",101,1807,1,2,0)
Patient Demographics and Master Patient Index (CIRN PD/MPI) 
"KRN",101,1807,1,3,0)
information for the selected patient.
"KRN",101,1807,2,0)
^101.02A^1^1
"KRN",101,1807,2,1,0)
TF
"KRN",101,1807,2,"B","TF",1)

"KRN",101,1807,20)
D PDAT^VAFCEHLM
"KRN",101,1807,99)
58650,52570
"KRN",101,1864,-1)
0^9
"KRN",101,1864,0)
VAFC EXCPT MPI/PD DATA^MPI/PD Data Inquiry^^A^^^^^^^^REGISTRATION
"KRN",101,1864,1,0)
^^2^2^3020125^
"KRN",101,1864,1,1,0)
This protocol displays Master Patient Index/Patient
"KRN",101,1864,1,2,0)
Demographics (MPI/PD) information for the selected patient.
"KRN",101,1864,2,0)
^101.02A^1^1
"KRN",101,1864,2,1,0)
DI
"KRN",101,1864,2,"B","DI",1)

"KRN",101,1864,20)
D PDAT^VAFCMGA1
"KRN",101,1864,99)
58829,62894
"KRN",101,1872,-1)
0^16
"KRN",101,1872,0)
VAFC EXCPT RPA SEND^Send Remote Patient Audit Query^^A^^^^^^^^REGISTRATION
"KRN",101,1872,1,0)
^^2^2^3020314^
"KRN",101,1872,1,1,0)
This protocol allows the user to send a remote patient audit query
"KRN",101,1872,1,2,0)
to treating facility sites.
"KRN",101,1872,20)
D RSEND^VAFCLAU
"KRN",101,1872,99)
58877,50806
"KRN",101,1873,-1)
0^14
"KRN",101,1873,0)
VAFC EXCPT RPA CHECK^Check Remote Patient Audit Query^^A^^^^^^^^REGISTRATION
"KRN",101,1873,1,0)
^101.06^2^2^3030306^^
"KRN",101,1873,1,1,0)
This protocol allows the user to check the status of a remote patient
"KRN",101,1873,1,2,0)
audit query.
"KRN",101,1873,20)
D RCHK^VAFCLAU
"KRN",101,1873,99)
58877,50922
"KRN",101,1874,-1)
0^15
"KRN",101,1874,0)
VAFC EXCPT RPA DISPLAY^Display Remote Patient Audit Query^^A^^^^^^^^REGISTRATION
"KRN",101,1874,1,0)
^^1^1^3020314^
"KRN",101,1874,1,1,0)
This protocol allows the user to display a remote patient audit.
"KRN",101,1874,20)
D RDISP^VAFCLAU
"KRN",101,1874,99)
58877,51096
"KRN",101,1875,-1)
0^11
"KRN",101,1875,0)
VAFC EXCPT PATIENT AUDIT MENU^MPI/PD Patient Audit Action Menu^^M^^^^^^^^REGISTRATION
"KRN",101,1875,1,0)
^101.06^2^2^3020319^^
"KRN",101,1875,1,1,0)
This protocol serves as the action menu for the MPI/PD Patient Audit
"KRN",101,1875,1,2,0)
query actions.
"KRN",101,1875,4)
40
"KRN",101,1875,10,0)
^101.01PA^3^3
"KRN",101,1875,10,1,0)
1872^SND^5^^^Send Remote Audit
"KRN",101,1875,10,1,"^")
VAFC EXCPT RPA SEND
"KRN",101,1875,10,2,0)
1873^CHK^10^^^Check Remote Audit
"KRN",101,1875,10,2,"^")
VAFC EXCPT RPA CHECK
"KRN",101,1875,10,3,0)
1874^DSP^15^^^Display Remote Audit
"KRN",101,1875,10,3,"^")
VAFC EXCPT RPA DISPLAY
"KRN",101,1875,26)
D SHOW^VALM
"KRN",101,1875,28)
Select Action:
"KRN",101,1875,99)
59234,51839
"KRN",101,1880,-1)
0^13
"KRN",101,1880,0)
VAFC EXCPT PUSH CMOR^Push CMOR Request^^A^^^^^^^^REGISTRATION
"KRN",101,1880,1,0)
^^2^2^3020405^
"KRN",101,1880,1,1,0)
This protocol allows the user's site to relinquish being the CMOR for a
"KRN",101,1880,1,2,0)
patient and give it to another site.
"KRN",101,1880,20)
D LM^MPIFCMRP(VAFCDFN)
"KRN",101,1880,99)
58899,31561
"KRN",409.61,257,-1)
0^1
"KRN",409.61,257,0)
VAFC EXCPT LOCAL AUDIT^1^^80^5^19^1^1^^VAFC EXCPT PATIENT AUDIT MENU^MPI/PD PATIENT AUDIT ACTIONS^1^^1
"KRN",409.61,257,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,257,"ARRAY")
 ^TMP("VAFCLAU",$J)
"KRN",409.61,257,"COL",0)
^409.621^1^1
"KRN",409.61,257,"COL",1,0)
AUDIT^2^80^LOCAL PATIENT AUDIT DATA^H^0
"KRN",409.61,257,"COL","AIDENT",0,1)

"KRN",409.61,257,"COL","B","AUDIT",1)

"KRN",409.61,257,"FNL")
D EXIT^VAFCLAU
"KRN",409.61,257,"HDR")
D HDR^VAFCLAU
"KRN",409.61,257,"HLP")
D HELP^VAFCLAU
"KRN",409.61,257,"INIT")
D INIT^VAFCLAU
"KRN",409.61,258,-1)
0^2
"KRN",409.61,258,0)
VAFC EXCPT REMOTE AUDIT^1^^80^5^18^1^1^^^MPI/PD REMOTE PATIENT AUDIT^1^^1
"KRN",409.61,258,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,258,"ARRAY")
 ^TMP("VAFCRAU",$J)
"KRN",409.61,258,"COL",0)
^409.621^1^1
"KRN",409.61,258,"COL",1,0)
AUDIT^2^80^REMOTE PATIENT AUDIT DATA^H^0
"KRN",409.61,258,"COL","AIDENT",0,1)

"KRN",409.61,258,"COL","B","AUDIT",1)

"KRN",409.61,258,"FNL")
D EXIT^VAFCRAU
"KRN",409.61,258,"HDR")
D HDR^VAFCRAU
"KRN",409.61,258,"HLP")
D HELP^VAFCRAU
"KRN",409.61,258,"INIT")
D INIT^VAFCRAU
"KRN",8994,140,-1)
0^1
"KRN",8994,140,0)
VAFC REMOTE AUDIT^AUDIT^VAFCRPC^2^P^0^^^1
"KRN",8994,140,1,0)
^8994.01^2^2^3030610^^^^
"KRN",8994,140,1,1,0)
This Remote Procedure Call will allow users to pull an audit report
"KRN",8994,140,1,2,0)
from a remote site.
"KRN",8994,140,2,0)
^8994.02A^4^4
"KRN",8994,140,2,1,0)
VALUE^1^16^1^1
"KRN",8994,140,2,1,1,0)
^8994.021^1^1^3030610^^
"KRN",8994,140,2,1,1,1,0)
The VALUE can come in as 'I.ICN', 'S.SSN', 'D.DFN'or 'P.NAME'
"KRN",8994,140,2,2,0)
SSN^1^9^0^2
"KRN",8994,140,2,3,0)
SDT^1^30^1^3
"KRN",8994,140,2,4,0)
EDT^1^30^1^4
"KRN",8994,140,2,"B","EDT",4)

"KRN",8994,140,2,"B","SDT",3)

"KRN",8994,140,2,"B","SSN",2)

"KRN",8994,140,2,"B","VALUE",1)

"KRN",8994,140,2,"PARAMSEQ",1,1)

"KRN",8994,140,2,"PARAMSEQ",2,2)

"KRN",8994,140,2,"PARAMSEQ",3,3)

"KRN",8994,140,2,"PARAMSEQ",4,4)

"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813^2970721^12541
"PKG",5,22,1,"PAH",1,0)
477^3030815
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3030815
"PKG",5,22,1,"PAH",1,1,1,0)
PATIENT DATA REVIEW FIXES & ENHANCEMENTS
"PKG",5,22,1,"PAH",1,1,2,0)
Refer to patch DG*5.3*477 in the FORUM Patch Module for a complete
"PKG",5,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
18
"RTN","DG477PST")
0^2^B19551869
"RTN","DG477PST",1,0)
DG477PST ;BIR/DRI-DG*5.3*477 PATCH POST INSTALL ROUTINE ;9/11/02
"RTN","DG477PST",2,0)
 ;;5.3;Registration;**477**;Aug 13, 1993
"RTN","DG477PST",3,0)
 ;
"RTN","DG477PST",4,0)
 ;Reference to TRIG^DICR supported by IA #3405
"RTN","DG477PST",5,0)
 ;
"RTN","DG477PST",6,0)
POST ;Post-init functions
"RTN","DG477PST",7,0)
 D POST1,POST2
"RTN","DG477PST",8,0)
 Q
"RTN","DG477PST",9,0)
 ;
"RTN","DG477PST",10,0)
POST1 ;recompile input templates and update triggered fields
"RTN","DG477PST",11,0)
 ;Recompile input templates
"RTN","DG477PST",12,0)
 D COMPILE
"RTN","DG477PST",13,0)
 ;Update triggered fields
"RTN","DG477PST",14,0)
 D TRIG
"RTN","DG477PST",15,0)
 Q
"RTN","DG477PST",16,0)
 ;
"RTN","DG477PST",17,0)
COMPILE N GLOBAL,FIELD,CFIELD,NFIELD,TEMPLATP,TEMPLATN
"RTN","DG477PST",18,0)
 D BMES^XPDUTL("Beginning to compile templates on the PATIENT (#2) file.")
"RTN","DG477PST",19,0)
 ;
"RTN","DG477PST",20,0)
 S NFIELD=$P($T(AFIELDS),";;",2) ;get the fields that have new xref
"RTN","DG477PST",21,0)
 ;
"RTN","DG477PST",22,0)
 F GLOBAL="^DIE","^DIPT" DO
"RTN","DG477PST",23,0)
 .I GLOBAL="^DIE" D BMES^XPDUTL("   Compiling Input Templates")
"RTN","DG477PST",24,0)
 .I GLOBAL="^DIPT" DO
"RTN","DG477PST",25,0)
 . . D BMES^XPDUTL(" ")
"RTN","DG477PST",26,0)
 . . D BMES^XPDUTL("   Compiling Print Templates")
"RTN","DG477PST",27,0)
 .;
"RTN","DG477PST",28,0)
 .S FIELD=0
"RTN","DG477PST",29,0)
 .; go find templates on fields that have added cross-ref
"RTN","DG477PST",30,0)
 .F  S FIELD=$O(@GLOBAL@("AF",2,FIELD)) Q:'FIELD  DO
"RTN","DG477PST",31,0)
 . .;
"RTN","DG477PST",32,0)
 . .S CFIELD=","_FIELD_","
"RTN","DG477PST",33,0)
 . .;if we didn't add the cross reference, quit
"RTN","DG477PST",34,0)
 . .I NFIELD'[CFIELD Q
"RTN","DG477PST",35,0)
 . .;
"RTN","DG477PST",36,0)
 . .S TEMPLATP=0
"RTN","DG477PST",37,0)
 . .F  S TEMPLATP=$O(@GLOBAL@("AF",2,FIELD,TEMPLATP)) Q:'TEMPLATP  DO
"RTN","DG477PST",38,0)
 . . . S TEMPLATN=$P($G(@GLOBAL@(TEMPLATP,0)),"^",1)
"RTN","DG477PST",39,0)
 . . . I TEMPLATN="" DO  Q
"RTN","DG477PST",40,0)
 . . . . D BMES^XPDUTL("Could not compile template "_TEMPLATN_$C(13,10)_"Please review!")
"RTN","DG477PST",41,0)
 . . . .;
"RTN","DG477PST",42,0)
 . . . S X=$P($G(@GLOBAL@(TEMPLATP,"ROUOLD")),"^")
"RTN","DG477PST",43,0)
 . . . I X=""&($D(@GLOBAL@(TEMPLATP,"ROU"))'=0) DO  Q
"RTN","DG477PST",44,0)
 . . . . D BMES^XPDUTL("Could not find routine for template "_TEMPLATN_$C(13,10)_"Please review!")
"RTN","DG477PST",45,0)
 . . . I X=""&($D(@GLOBAL@(TEMPLATP,"ROU"))=0) Q
"RTN","DG477PST",46,0)
 . . . I $D(FIELD(X)) Q  ;already compiled
"RTN","DG477PST",47,0)
 . . .;
"RTN","DG477PST",48,0)
 . . . S FIELD(X)="" ;                remember the template was compiled
"RTN","DG477PST",49,0)
 . . . S Y=TEMPLATP ;                 set up the call for fman
"RTN","DG477PST",50,0)
 . . . S DMAX=$$ROUSIZE^DILF
"RTN","DG477PST",51,0)
 . . . I GLOBAL="^DIE" D EN^DIEZ Q
"RTN","DG477PST",52,0)
 . . . I GLOBAL="^DIPT" D EN^DIPZ Q
"RTN","DG477PST",53,0)
 .;
"RTN","DG477PST",54,0)
 S (X,Y)=""
"RTN","DG477PST",55,0)
 D BMES^XPDUTL("The following routine namespace was compiled:")
"RTN","DG477PST",56,0)
 F  S X=$O(FIELD(X)) Q:X=""  DO
"RTN","DG477PST",57,0)
 . S Y=$G(Y)+1 S PRINT(Y)=" "_X_"*"
"RTN","DG477PST",58,0)
 ;
"RTN","DG477PST",59,0)
 D MES^XPDUTL(.PRINT)
"RTN","DG477PST",60,0)
 K X,Y,DMAX,PRINT
"RTN","DG477PST",61,0)
 Q
"RTN","DG477PST",62,0)
 ;
"RTN","DG477PST",63,0)
 ;these are the fields that have a new cross-ref
"RTN","DG477PST",64,0)
AFIELDS ;;,.313,
"RTN","DG477PST",65,0)
 Q
"RTN","DG477PST",66,0)
 ;
"RTN","DG477PST",67,0)
TRIG ;Update trigger definitions
"RTN","DG477PST",68,0)
 N DGFLD
"RTN","DG477PST",69,0)
 D BMES^XPDUTL("Updating trigger field definitions...")
"RTN","DG477PST",70,0)
 F DGFLD=.092,.093 S DGFLD(2,DGFLD)=""
"RTN","DG477PST",71,0)
 D T1(.DGFLD)
"RTN","DG477PST",72,0)
 Q
"RTN","DG477PST",73,0)
 ;
"RTN","DG477PST",74,0)
T1(DGFLD) ;Check/update triggering field definitions
"RTN","DG477PST",75,0)
 ;Input: DGFLD=array of fields to update
"RTN","DG477PST",76,0)
 N DGOUT,DGFILE
"RTN","DG477PST",77,0)
 D TRIG^DICR(.DGFLD,.DGOUT)
"RTN","DG477PST",78,0)
 S DGFILE=0 F  S DGFILE=$O(DGOUT(DGFILE)) Q:'DGFILE  D
"RTN","DG477PST",79,0)
 .S DGFLD=0 F  S DGFLD=$O(DGOUT(DGFILE,DGFLD)) Q:'DGFLD  D
"RTN","DG477PST",80,0)
 ..D MES^XPDUTL("         Field #"_DGFLD_" of file #"_DGFILE_" updated.")
"RTN","DG477PST",81,0)
 ..Q
"RTN","DG477PST",82,0)
 .Q
"RTN","DG477PST",83,0)
 Q
"RTN","DG477PST",84,0)
 ;
"RTN","DG477PST",85,0)
POST2 ;translate marital status from 'n' to 'never married'
"RTN","DG477PST",86,0)
 ;caused by dg*5.3*474 initially installed 10/31/2002
"RTN","DG477PST",87,0)
 NEW FIELD,FILE,GLO,IEN,MSCNT,PDR,VAL
"RTN","DG477PST",88,0)
 D BMES^XPDUTL(" Translating MARITAL STATUS from 'N' to 'NEVER MARRIED' in the")
"RTN","DG477PST",89,0)
 D MES^XPDUTL(" PATIENT DATA ELEMENTS (#391.99) file for PATIENT DATA REVIEWS.")
"RTN","DG477PST",90,0)
 S GLO="^DGCN(391.98,""EVT"",3021030)",FILE=2,FIELD=.05,MSCNT=0
"RTN","DG477PST",91,0)
 F  S GLO=$Q(@GLO) Q:$QS(GLO,2)'="EVT"  S PDR=$QS(GLO,4) I PDR S IEN=$O(^DGCN(391.99,"AKY",PDR,FILE,FIELD,"")) I IEN Q  ;find first possible affected pdr
"RTN","DG477PST",92,0)
 I $G(IEN) S IEN=IEN-1 F  S IEN=$O(^DGCN(391.99,"ASRT",FILE,FIELD,IEN)) Q:'IEN  S VAL=$G(^DGCN(391.99,IEN,"VAL")) I VAL="N" S MSCNT=MSCNT+1 D
"RTN","DG477PST",93,0)
 . D UPD(IEN,50,"NEVER MARRIED"),UPD(IEN,.06,"@") ;loop through subsequent marital status elements and update if necessary
"RTN","DG477PST",94,0)
 D BMES^XPDUTL(" "_MSCNT_" MARITAL STATUS entries were translated.")
"RTN","DG477PST",95,0)
 Q
"RTN","DG477PST",96,0)
 ;
"RTN","DG477PST",97,0)
UPD(DA,FLD,VAL) ;update value
"RTN","DG477PST",98,0)
 L +^DGCN(391.99,DA,0):10 I '$T D BMES^XPDUTL("Unable to lock entry "_DA_" in the PATIENT DATA ELEMENT (#391.99) file.") Q
"RTN","DG477PST",99,0)
 S DIE="^DGCN(391.99,"
"RTN","DG477PST",100,0)
 S DR=FLD_"///^S X=VAL"
"RTN","DG477PST",101,0)
 D ^DIE K DIE,DR
"RTN","DG477PST",102,0)
 L -^DGCN(391.99,DA,0)
"RTN","DG477PST",103,0)
 Q
"RTN","VAFCAUD")
0^17^B24016806
"RTN","VAFCAUD",1,0)
VAFCAUD ;BIR/CML-MPI/PD AUDIT FILE PRINT FOR A SPECIFIED PATIENT ;01/06/99
"RTN","VAFCAUD",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**477**;30 Apr 99
"RTN","VAFCAUD",3,0)
 ;Reference to ^DIA(2 and data derived from the AUDIT file (#1.1)
"RTN","VAFCAUD",4,0)
 ;is supported by IA #2097 and #2602.
"RTN","VAFCAUD",5,0)
 ;Reference to ^ORD(101 supported by IA #2596
"RTN","VAFCAUD",6,0)
 S QFLG=1
"RTN","VAFCAUD",7,0)
 S RPCFLG=0 ;is this from an rpc call
"RTN","VAFCAUD",8,0)
BEGIN ;
"RTN","VAFCAUD",9,0)
 W !!,"This option prints information from the AUDIT file (#1.1) for a"
"RTN","VAFCAUD",10,0)
 W !,"selected patient and date range."
"RTN","VAFCAUD",11,0)
 W !!,"For the PATIENT file (#2) entry selected, the report prints the"
"RTN","VAFCAUD",12,0)
 W !,"patient name and DFN, date/time the field was edited, the user who"
"RTN","VAFCAUD",13,0)
 W !,"made the change, the field edited, the old value, and the new value."
"RTN","VAFCAUD",14,0)
 W !,"The option or protocol (if available) will also be displayed."
"RTN","VAFCAUD",15,0)
 D ASK1
"RTN","VAFCAUD",16,0)
 I $G(VAFCDFN) D ASK2
"RTN","VAFCAUD",17,0)
 I $G(VAFCBDT),$G(VAFCEDT) D DEV
"RTN","VAFCAUD",18,0)
 G QUIT
"RTN","VAFCAUD",19,0)
 ;
"RTN","VAFCAUD",20,0)
ASK1 ;Ask for PATIENT
"RTN","VAFCAUD",21,0)
 W !
"RTN","VAFCAUD",22,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: " D ^DIC K DIC Q:Y<0  S VAFCDFN=+Y
"RTN","VAFCAUD",23,0)
 I '$O(^DIA(2,"B",VAFCDFN,0)) W !!,"This patient has no audit data available for any date." G ASK1
"RTN","VAFCAUD",24,0)
 Q
"RTN","VAFCAUD",25,0)
 ;
"RTN","VAFCAUD",26,0)
ASK2 ;Ask for Date Range
"RTN","VAFCAUD",27,0)
 ;I '$D(VAFCDFN)&($D(DFN)) S VAFCDFN=DFN
"RTN","VAFCAUD",28,0)
 W !!,"Enter date range for data to be included in report."
"RTN","VAFCAUD",29,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","VAFCAUD",30,0)
 S DIR(0)="DAO^:DT:EPX",DIR("A")="Beginning Date:  " D ^DIR K DIR Q:$D(DIRUT)  S VAFCBDT=Y
"RTN","VAFCAUD",31,0)
 S DIR(0)="DAO^"_VAFCBDT_":DT:EPX",DIR("A")="Ending Date:  " D ^DIR K DIR Q:$D(DIRUT)  S VAFCEDT=Y
"RTN","VAFCAUD",32,0)
 Q
"RTN","VAFCAUD",33,0)
 ;
"RTN","VAFCAUD",34,0)
DEV W !!,"The right margin for this report is 80.",!!
"RTN","VAFCAUD",35,0)
 S ZTSAVE("VAFCBDT")="",ZTSAVE("VAFCEDT")="",ZTSAVE("VAFCDFN")=""
"RTN","VAFCAUD",36,0)
 D EN^XUTMDEVQ("START^VAFCAUD(VAFCDFN,VAFCBDT,VAFCEDT,RPCFLG)","MPI/PD - Print AUDIT File Data for a Specific Patient",.ZTSAVE) I 'POP Q
"RTN","VAFCAUD",37,0)
 W !,"NO DEVICE SELECTED OR REPORT PRINTED!!"
"RTN","VAFCAUD",38,0)
 G QUIT
"RTN","VAFCAUD",39,0)
 ;
"RTN","VAFCAUD",40,0)
START(VAFCDFN,VAFCBDT,VAFCEDT,RPCFLG) ;
"RTN","VAFCAUD",41,0)
 N IEN
"RTN","VAFCAUD",42,0)
 K ^TMP("VAFCAUD",$J)
"RTN","VAFCAUD",43,0)
 ;
"RTN","VAFCAUD",44,0)
LOOP ;Loop on "B" xref of the AUDIT file
"RTN","VAFCAUD",45,0)
 S STOP=VAFCEDT+1
"RTN","VAFCAUD",46,0)
 S IEN=0 F  S IEN=$O(^DIA(2,"B",VAFCDFN,IEN)) Q:'IEN  D
"RTN","VAFCAUD",47,0)
 .I $D(^DIA(2,IEN,0)) S EDITDT=$P(^(0),U,2) I EDITDT>VAFCBDT,EDITDT<STOP D
"RTN","VAFCAUD",48,0)
 ..S ^TMP("VAFCAUD",$J,EDITDT,IEN)=""
"RTN","VAFCAUD",49,0)
 ;
"RTN","VAFCAUD",50,0)
PRT ;Print report
"RTN","VAFCAUD",51,0)
 S (PG,QFLG)=0,U="^",$P(LN,"-",81)="",SITE=$P($$SITE^VASITE(),U,2)
"RTN","VAFCAUD",52,0)
 S PVAFCBDT=$$FMTE^XLFDT(VAFCBDT),PVAFCEDT=$$FMTE^XLFDT(VAFCEDT)
"RTN","VAFCAUD",53,0)
 D NOW^%DTC S HDT=$$FMTE^XLFDT($E(%,1,12))
"RTN","VAFCAUD",54,0)
 D HDR
"RTN","VAFCAUD",55,0)
 I '$O(^TMP("VAFCAUD",$J,0)) W !!,"No audit data found in this date range for this patient." Q
"RTN","VAFCAUD",56,0)
 S EDITDT=0 F  S EDITDT=$O(^TMP("VAFCAUD",$J,EDITDT)) Q:QFLG  Q:'EDITDT  D
"RTN","VAFCAUD",57,0)
 .S IEN=0 F  S IEN=$O(^TMP("VAFCAUD",$J,EDITDT,IEN)) Q:QFLG  Q:'IEN  D
"RTN","VAFCAUD",58,0)
 ..S PRTDT=$$FMTE^XLFDT($E(EDITDT,1,12))
"RTN","VAFCAUD",59,0)
 ..S IEN0=^DIA(2,IEN,0)
"RTN","VAFCAUD",60,0)
 ..K VAFCARR1 D FIELD^DID(2,$P(IEN0,U,3),"","LABEL","VAFCARR1")
"RTN","VAFCAUD",61,0)
 ..S FLD=$G(VAFCARR1("LABEL")) Q:FLD=""
"RTN","VAFCAUD",62,0)
 ..S USER=$P(IEN0,U,4)
"RTN","VAFCAUD",63,0)
 ..I 'USER S USER="UNKNOWN"
"RTN","VAFCAUD",64,0)
 ..I USER'="UNKNOWN" S DIC="^VA(200,",DIC(0)="MZO",X="`"_USER D ^DIC S USER=$P(Y,"^",2)
"RTN","VAFCAUD",65,0)
 ..S OLD=$G(^DIA(2,IEN,2)) I OLD']"" S OLD="<no previous value>"
"RTN","VAFCAUD",66,0)
 ..S NEW=$G(^DIA(2,IEN,3)) I NEW']"" S NEW="<no current value>"
"RTN","VAFCAUD",67,0)
 ..K OPTDA1,OPTDA2,VAFCOPTN,OPTNM I $G(^DIA(2,IEN,4.1)) D
"RTN","VAFCAUD",68,0)
 ...S OPTDA1=+$P(^DIA(2,IEN,4.1),"^")
"RTN","VAFCAUD",69,0)
 ...I OPTDA1 S DIC=19,DR=".01",DA=OPTDA1,DIQ(0)="EI",DIQ="VAFCOPTN" D EN^DIQ1 K DIC,DR,DA,DIQ S VAFCOPTN=$G(VAFCOPTN(19,OPTDA1,.01,"E"))
"RTN","VAFCAUD",70,0)
 ...S OPTDA2=$P(^DIA(2,IEN,4.1),"^",2)
"RTN","VAFCAUD",71,0)
 ...I $P(OPTDA2,";",2)="ORD(101," S DIC=101,DR=".01",DA=+OPTDA2,DIQ(0)="EI",DIQ="VAFCOPTN" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTNM=$G(VAFCOPTN(101,+OPTDA2,.01,"E")) Q
"RTN","VAFCAUD",72,0)
 ...I +OPTDA2 S DIC=19,DR=".01",DA=+OPTDA2,DIQ(0)="EI",DIQ="VAFCOPTN" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTNM=$G(VAFCOPTN(19,+OPTDA2,.01,"E")) Q
"RTN","VAFCAUD",73,0)
 ..I 'RPCFLG D:$Y+4>IOSL HDR Q:QFLG
"RTN","VAFCAUD",74,0)
 ..W !,PRTDT,?20,FLD,?51,USER,!?20,OLD," / ",NEW
"RTN","VAFCAUD",75,0)
 ..I $G(VAFCOPTN)'="" W !?3,VAFCOPTN
"RTN","VAFCAUD",76,0)
 ..I $G(OPTNM)'="" W:$G(VAFCOPTN)="" !?3 W "/",$G(OPTNM)
"RTN","VAFCAUD",77,0)
 ..W !
"RTN","VAFCAUD",78,0)
 Q
"RTN","VAFCAUD",79,0)
 ;
"RTN","VAFCAUD",80,0)
QUIT ;
"RTN","VAFCAUD",81,0)
 I '$G(RPCFLG),$E(IOST,1,2)="C-"&('$G(QFLG)) S DIR(0)="E" D  D ^DIR K DIR
"RTN","VAFCAUD",82,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","VAFCAUD",83,0)
 I '$G(RPCFLG) D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","VAFCAUD",84,0)
 K ^TMP("VAFCAUD",$J)
"RTN","VAFCAUD",85,0)
 K %,%I,C,VAFCDFN,EDITDT,FLD,HDT,IEN,IEN0,JJ,LN,NEW,OLD,OPTDA1,OPTDA2,VAFCOPTN,OPTNM,PG,PVAFCBDT,PVAFCEDT,PRTDT,POP
"RTN","VAFCAUD",86,0)
 K QFLG,VAFCARR1,VAFCBDT,VAFCEDT,RPCFLG,SITE,SS,STOP,USER,X,Y,ZTSK
"RTN","VAFCAUD",87,0)
 Q
"RTN","VAFCAUD",88,0)
 ;
"RTN","VAFCAUD",89,0)
HDR ;HEADER
"RTN","VAFCAUD",90,0)
 I 'RPCFLG I $E(IOST,1,2)="C-" S SS=22-$Y F JJ=1:1:SS W !
"RTN","VAFCAUD",91,0)
 I 'RPCFLG I $E(IOST,1,2)="C-",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","VAFCAUD",92,0)
 S PG=PG+1
"RTN","VAFCAUD",93,0)
 I 'RPCFLG W:$Y!($E(IOST,1,2)="C-") @IOF
"RTN","VAFCAUD",94,0)
 W !,"PATIENT AUDIT LIST at ",SITE," on ",HDT,?70,"Page: ",PG
"RTN","VAFCAUD",95,0)
 W !,"Patient: ",$P(^DPT(VAFCDFN,0),U)," (DFN #",VAFCDFN,")"
"RTN","VAFCAUD",96,0)
 W !,"Date Range: ",PVAFCBDT," to ",PVAFCEDT
"RTN","VAFCAUD",97,0)
 W !!,"Date/Time Edited",?20,"Field Edited",?51,"Edited By"
"RTN","VAFCAUD",98,0)
 W !?20,"Old Value / New Value",!?3,"Option/Protocol",!,LN
"RTN","VAFCAUD",99,0)
 Q
"RTN","VAFCEHLM")
0^16^B19208241
"RTN","VAFCEHLM",1,0)
VAFCEHLM ;ALB/JLU,LTL-FILE UTILITIES FOR 391.98 ;12/07/00
"RTN","VAFCEHLM",2,0)
 ;;5.3;Registration;**149,255,307,333,477**;Aug 13, 1993
"RTN","VAFCEHLM",3,0)
 ;
"RTN","VAFCEHLM",4,0)
 ;Reference to VTQ^MPIFSAQ supported by IA #2941
"RTN","VAFCEHLM",5,0)
 ;
"RTN","VAFCEHLM",6,0)
EN ; -- main entry point for VAFC EXCPT SUM SCR
"RTN","VAFCEHLM",7,0)
 ;fix records stuck in 'being reviewed' status
"RTN","VAFCEHLM",8,0)
 S IEN=0 F  S IEN=$O(^DGCN(391.98,"AST",5,IEN)) Q:'IEN  D  ;**255
"RTN","VAFCEHLM",9,0)
 . L +^DGCN(391.98,IEN,0):0 I '$T Q  ;record is truly being reviewed
"RTN","VAFCEHLM",10,0)
 . S XX=$$EDIT^VAFCEHU1(IEN,"AR") ;change record to action required
"RTN","VAFCEHLM",11,0)
 . L -^DGCN(391.98,IEN,0)
"RTN","VAFCEHLM",12,0)
 L +^DGCN(391.98,"VAFC PDR PURGE"):0 I '$T W $C(7),!!,"The Purge Patient Data Reviews process is currently running." QUIT
"RTN","VAFCEHLM",13,0)
 L -^DGCN(391.98,"VAFC PDR PURGE")
"RTN","VAFCEHLM",14,0)
 D EN^VALM("VAFC EXCPT SUM SCR")
"RTN","VAFCEHLM",15,0)
 Q
"RTN","VAFCEHLM",16,0)
 ;
"RTN","VAFCEHLM",17,0)
HDR ; -- header code
"RTN","VAFCEHLM",18,0)
 N RGSTRNG
"RTN","VAFCEHLM",19,0)
 S RGSTRNG="Review(s) currently on file."
"RTN","VAFCEHLM",20,0)
 S VALMHDR(1)=$$CENTER(RGSTRNG)
"RTN","VAFCEHLM",21,0)
 Q
"RTN","VAFCEHLM",22,0)
 ;
"RTN","VAFCEHLM",23,0)
INIT ; -- init variables and list array
"RTN","VAFCEHLM",24,0)
 ;checking for sort variable
"RTN","VAFCEHLM",25,0)
 N XQORNOD
"RTN","VAFCEHLM",26,0)
 I '$D(VAFCSORT) S VAFCSORT="SN"
"RTN","VAFCEHLM",27,0)
 ;
"RTN","VAFCEHLM",28,0)
INIT2 ;enter at this point to reset the screens after editing etc.
"RTN","VAFCEHLM",29,0)
 K @VALMAR
"RTN","VAFCEHLM",30,0)
 D SORTS^VAFCEHU2(VAFCSORT,VALMAR)
"RTN","VAFCEHLM",31,0)
 D FORMAT^VAFCEHU2(VALMAR,.VALMCNT,.VALMQUIT)
"RTN","VAFCEHLM",32,0)
 Q
"RTN","VAFCEHLM",33,0)
 ;
"RTN","VAFCEHLM",34,0)
HELP ; -- help code
"RTN","VAFCEHLM",35,0)
 S X="?",VALMSG="Select patient for detailed display or change sorting"
"RTN","VAFCEHLM",36,0)
 D DISP^XQORM1 W !!
"RTN","VAFCEHLM",37,0)
 Q
"RTN","VAFCEHLM",38,0)
 ;
"RTN","VAFCEHLM",39,0)
EXIT ; -- exit code
"RTN","VAFCEHLM",40,0)
 K @VALMAR,VAFCSORT
"RTN","VAFCEHLM",41,0)
 Q
"RTN","VAFCEHLM",42,0)
 ;
"RTN","VAFCEHLM",43,0)
EXPND ; -- expand code
"RTN","VAFCEHLM",44,0)
 Q
"RTN","VAFCEHLM",45,0)
 ;
"RTN","VAFCEHLM",46,0)
SACT D HDR
"RTN","VAFCEHLM",47,0)
 D INIT
"RTN","VAFCEHLM",48,0)
 S VALMBCK="R"
"RTN","VAFCEHLM",49,0)
 Q
"RTN","VAFCEHLM",50,0)
 ;
"RTN","VAFCEHLM",51,0)
FULL S VALMSG="** = Different, ->  = Edited, <UR> = Unresolved" D REVFUL^VAFCEHU2
"RTN","VAFCEHLM",52,0)
 S VALMBCK="R"
"RTN","VAFCEHLM",53,0)
 Q
"RTN","VAFCEHLM",54,0)
 ;
"RTN","VAFCEHLM",55,0)
DIFF S VALMBCK="R"
"RTN","VAFCEHLM",56,0)
 Q
"RTN","VAFCEHLM",57,0)
 ;
"RTN","VAFCEHLM",58,0)
INQ ; Patient Inquiry ;**255
"RTN","VAFCEHLM",59,0)
 N DFN
"RTN","VAFCEHLM",60,0)
 S DFN=+$P($G(^DGCN(391.98,IENPDR,0)),"^",1) ;**477
"RTN","VAFCEHLM",61,0)
 S VALMBCK=""
"RTN","VAFCEHLM",62,0)
 D FULL^VALM1
"RTN","VAFCEHLM",63,0)
 D EN^DGRPD
"RTN","VAFCEHLM",64,0)
 D PAUSE^VALM1
"RTN","VAFCEHLM",65,0)
 S VALMBCK="R"
"RTN","VAFCEHLM",66,0)
 Q
"RTN","VAFCEHLM",67,0)
 ;
"RTN","VAFCEHLM",68,0)
DISP ; Display Only Query to MPI ;**307
"RTN","VAFCEHLM",69,0)
 S VALMBCK=""
"RTN","VAFCEHLM",70,0)
 D FULL^VALM1
"RTN","VAFCEHLM",71,0)
 S MPIVAR("DFN")=$P(EXCPT,"^",1)
"RTN","VAFCEHLM",72,0)
 S MPIVAR("SSN")=$P($G(^DPT(+$P(EXCPT,"^",1),0)),"^",9)
"RTN","VAFCEHLM",73,0)
 S MPIVAR("NM")=$P($G(^DPT(+$P(EXCPT,"^",1),0)),"^",1)
"RTN","VAFCEHLM",74,0)
 S MPIVAR("DOB")=$P($P($G(^DPT(+$P(EXCPT,"^",1),0)),"^",3),".",1)
"RTN","VAFCEHLM",75,0)
 D VTQ^MPIFSAQ(.MPIVAR)
"RTN","VAFCEHLM",76,0)
 D PAUSE^VALM1
"RTN","VAFCEHLM",77,0)
 S VALMBCK="R"
"RTN","VAFCEHLM",78,0)
 K MPIVAR
"RTN","VAFCEHLM",79,0)
 Q
"RTN","VAFCEHLM",80,0)
 ;
"RTN","VAFCEHLM",81,0)
PDAT ;report to list CMOR, TF's & SUB's ;**333
"RTN","VAFCEHLM",82,0)
 N DFN
"RTN","VAFCEHLM",83,0)
 S DFN=+$P($G(^DGCN(391.98,IEN,0)),"^",1)
"RTN","VAFCEHLM",84,0)
 S VALMBCK=""
"RTN","VAFCEHLM",85,0)
 D FULL^VALM1
"RTN","VAFCEHLM",86,0)
 D START^VAFCPDAT
"RTN","VAFCEHLM",87,0)
 ;D PAUSE^VALM1
"RTN","VAFCEHLM",88,0)
 S VALMBCK="R"
"RTN","VAFCEHLM",89,0)
 Q
"RTN","VAFCEHLM",90,0)
 ;
"RTN","VAFCEHLM",91,0)
CENTER(STRG) ;
"RTN","VAFCEHLM",92,0)
 ;
"RTN","VAFCEHLM",93,0)
 N LEN,FIL,FIL1
"RTN","VAFCEHLM",94,0)
 S LEN=80-$L(STRG)
"RTN","VAFCEHLM",95,0)
 S FIL=LEN/2
"RTN","VAFCEHLM",96,0)
 S $P(FIL1," ",FIL)=""
"RTN","VAFCEHLM",97,0)
 Q FIL1_STRG
"RTN","VAFCEHLM",98,0)
 ;
"RTN","VAFCEHLM",99,0)
PDRPRG ;Purge PDRs ;**477
"RTN","VAFCEHLM",100,0)
 L +^DGCN(391.98,"VAFC PDR PURGE"):0 I '$T W $C(7),!!,"The Purge Patient Data Reviews process is currently running." Q
"RTN","VAFCEHLM",101,0)
 L -^DGCN(391.98,"VAFC PDR PURGE")
"RTN","VAFCEHLM",102,0)
 N TDATE,MAXDT,PDATE,X1,X2,X,Y
"RTN","VAFCEHLM",103,0)
 S NDATE=""
"RTN","VAFCEHLM",104,0)
 D NOW^%DTC S TDATE=X
"RTN","VAFCEHLM",105,0)
 S X1=TDATE,X2=-30 D C^%DTC
"RTN","VAFCEHLM",106,0)
 S (Y,MAXDT)=X D DD^%DT S PDATE=Y
"RTN","VAFCEHLM",107,0)
 S DIR("?")="Enter a date at least 30 days in the past."
"RTN","VAFCEHLM",108,0)
 S DIR("A")="Purge all Patient Data Reviews prior to "
"RTN","VAFCEHLM",109,0)
 S DIR("B")=PDATE,DIR(0)="DAO^:"_MAXDT_":EPX" D ^DIR K DIR Q:$D(DIRUT)
"RTN","VAFCEHLM",110,0)
 S NDATE=Y
"RTN","VAFCEHLM",111,0)
 S DIR(0)="YA",DIR("B")="NO"
"RTN","VAFCEHLM",112,0)
 S DIR("A")="Are you sure you want to purge Patient Data Reviews? " D ^DIR K DIR Q:$D(DIRUT)
"RTN","VAFCEHLM",113,0)
 Q:Y=0
"RTN","VAFCEHLM",114,0)
 ;
"RTN","VAFCEHLM",115,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSAVE,ZTREQ
"RTN","VAFCEHLM",116,0)
 S ZTRTN="QPRG^VAFCEHLM",ZTDESC="PURGE PATIENT DATA REVIEWS OVER 30 DAYS OLD OR X DAYS OLD AS SPECIFIED BY USER."
"RTN","VAFCEHLM",117,0)
 D NOW^%DTC
"RTN","VAFCEHLM",118,0)
 S ZTIO="",ZTDTH=%
"RTN","VAFCEHLM",119,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ,ZTSAVE("NDATE")=NDATE
"RTN","VAFCEHLM",120,0)
 D ^%ZTLOAD
"RTN","VAFCEHLM",121,0)
 W !!?15,"Patient Data Review Purge Queued, Task #"_ZTSK
"RTN","VAFCEHLM",122,0)
 D HOME^%ZIS K IO("Q")
"RTN","VAFCEHLM",123,0)
 Q
"RTN","VAFCEHLM",124,0)
QPRG ;
"RTN","VAFCEHLM",125,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","VAFCEHLM",126,0)
 L +^DGCN(391.98,"VAFC PDR PURGE"):0 I '$T Q
"RTN","VAFCEHLM",127,0)
 N PDR,EVTDT,ERR S PDR=0,EVTDT=""
"RTN","VAFCEHLM",128,0)
 F  S EVTDT=$O(^DGCN(391.98,"EVT",EVTDT)) Q:EVTDT>NDATE  D
"RTN","VAFCEHLM",129,0)
 . F  S PDR=$O(^DGCN(391.98,"EVT",EVTDT,PDR)) Q:'PDR  D
"RTN","VAFCEHLM",130,0)
 .. S ERR=$$DELEXCPT^VAFCEHU1(PDR)
"RTN","VAFCEHLM",131,0)
 L -^DGCN(391.98,"VAFC PDR PURGE")
"RTN","VAFCEHLM",132,0)
 K NDATE
"RTN","VAFCEHLM",133,0)
 Q
"RTN","VAFCEHU1")
0^9^B53748283
"RTN","VAFCEHU1",1,0)
VAFCEHU1 ;ALB/JLU,PTD-FILE UTILITIES FOR 391.98 ;11/21/02  12:24
"RTN","VAFCEHU1",2,0)
 ;;5.3;Registration;**149,255,307,477**;Aug 13, 1993
"RTN","VAFCEHU1",3,0)
 ;
"RTN","VAFCEHU1",4,0)
ADD(VAFCA,VAFCB) ;Main entry point to add an entry to 391.98
"RTN","VAFCEHU1",5,0)
 ;INPUTS    VAFCA - This parameter contains a piece string of 4 elements
"RTN","VAFCEHU1",6,0)
 ;Date Received^Event date^From whom^patient IEN
"RTN","VAFCEHU1",7,0)
 ;  Date Received - This is the date/time that the exception was received
"RTN","VAFCEHU1",8,0)
 ;at the facility.  Must be in FM format
"RTN","VAFCEHU1",9,0)
 ;  Event date - This is the date/time when the event occurred that caused
"RTN","VAFCEHU1",10,0)
 ;this information to be sent.  Must be in FM format
"RTN","VAFCEHU1",11,0)
 ;  From whom - This is who sent the information.  This should be in a
"RTN","VAFCEHU1",12,0)
 ;free text format.  There is a potential that exception could be coming
"RTN","VAFCEHU1",13,0)
 ;from sources other than what is listed in the institution file.
"RTN","VAFCEHU1",14,0)
 ;FORMAT of WHOM
"RTN","VAFCEHU1",15,0)
 ;  prior to RG*1*8: institution name(sender name)
"RTN","VAFCEHU1",16,0)
 ;     after RG*1*8: sending facility: station # -or- station #~domain
"RTN","VAFCEHU1",17,0)
 ;
"RTN","VAFCEHU1",18,0)
 ;  Patient IEN - The patient file internal entry number.
"RTN","VAFCEHU1",19,0)
 ;
"RTN","VAFCEHU1",20,0)
 ;         VAFCB - is an array storage structure. It can be either global
"RTN","VAFCEHU1",21,0)
 ;or local.  The array should be in the following format.
"RTN","VAFCEHU1",22,0)
 ;Ex.   A(file #,field #)=value
"RTN","VAFCEHU1",23,0)
 ;      A(file #, field #)=value
"RTN","VAFCEHU1",24,0)
 ;
"RTN","VAFCEHU1",25,0)
 ;In the case of multiples us the following structure:
"RTN","VAFCEHU1",26,0)
 ;Ex.   A(file #,field #,Subfile #, subfield #)=value
"RTN","VAFCEHU1",27,0)
 ;***NOTE*** THE SOFTWARE LOGIC TO HANDLE THIS MULTIPLE CASE HAS NOT
"RTN","VAFCEHU1",28,0)
 ;BEEN WRITTEN YET.
"RTN","VAFCEHU1",29,0)
 ;
"RTN","VAFCEHU1",30,0)
 ;**NOTE**
"RTN","VAFCEHU1",31,0)
 ;When setting info in the passage array please follow this format for
"RTN","VAFCEHU1",32,0)
 ;these exceptions.
"RTN","VAFCEHU1",33,0)
 ;-Unspecified or blank data should have no array element or an array
"RTN","VAFCEHU1",34,0)
 ;element set to the mumps null.
"RTN","VAFCEHU1",35,0)
 ;-If data from a sender can not be resolved then set
"RTN","VAFCEHU1",36,0)
 ; $P(array element,U,2)=1
"RTN","VAFCEHU1",37,0)
 ;-If you wish to delete what is in the receiving facilities field set
"RTN","VAFCEHU1",38,0)
 ;the array element to "@". EX. s X(1)="""@"""
"RTN","VAFCEHU1",39,0)
 ;
"RTN","VAFCEHU1",40,0)
 ;OUTPUTS
"RTN","VAFCEHU1",41,0)
 ; 0^error message - in the case of a failure
"RTN","VAFCEHU1",42,0)
 ; 1 - in the case that the entry is added
"RTN","VAFCEHU1",43,0)
 ;
"RTN","VAFCEHU1",44,0)
 N REC,EVT,WHO,PAT,RESLT,STATUS,LATEST
"RTN","VAFCEHU1",45,0)
 K ERR
"RTN","VAFCEHU1",46,0)
 S LATEST=""
"RTN","VAFCEHU1",47,0)
 I '$D(VAFCA) S ERR="0^Missing date/from parameter" G ADDQ
"RTN","VAFCEHU1",48,0)
 I '$D(VAFCB) S ERR="0^Missing array structure" G ADDQ
"RTN","VAFCEHU1",49,0)
 S REC=$P(VAFCA,U,1)
"RTN","VAFCEHU1",50,0)
 I REC']"" S ERR="0^Missing date of receipt" G ADDQ
"RTN","VAFCEHU1",51,0)
 S EVT=$P(VAFCA,U,2)
"RTN","VAFCEHU1",52,0)
 I EVT']"" S ERR="0^Missing date of event" G ADDQ
"RTN","VAFCEHU1",53,0)
 S WHO=$$WHO^VAFCEHU4($P(VAFCA,"^",3))
"RTN","VAFCEHU1",54,0)
 I WHO']"" S ERR="0^Missing who sent the information" G ADDQ
"RTN","VAFCEHU1",55,0)
 S PAT=$P(VAFCA,U,4)
"RTN","VAFCEHU1",56,0)
 I PAT']"" S ERR="0^Missing patient pointer" G ADDQ
"RTN","VAFCEHU1",57,0)
 I '$D(^DPT(PAT,0)) S ERR="0^Patient not defined" G ADDQ
"RTN","VAFCEHU1",58,0)
 I '$O(@VAFCB@("")) S ERR="0^Missing array storage structure" G ADDQ
"RTN","VAFCEHU1",59,0)
 ;There can be more than one patient update for a given day
"RTN","VAFCEHU1",60,0)
 ;resulting from different fields being edited.
"RTN","VAFCEHU1",61,0)
 ;I $D(^DGCN(391.98,"AKY",PAT,WHO,EVT)) S ERR="0^Entry already exists." G ADDQ
"RTN","VAFCEHU1",62,0)
 ;
"RTN","VAFCEHU1",63,0)
 ;update select edited fields and check for any differences
"RTN","VAFCEHU1",64,0)
 D EN^VAFCEHU3 I '$G(VAFCQ) S ERR="0^No exception needed" K VAFCQ G ADDQ
"RTN","VAFCEHU1",65,0)
 K VAFCQ
"RTN","VAFCEHU1",66,0)
 ;check for other entries for this date
"RTN","VAFCEHU1",67,0)
 S LATEST=$$CHKDATE(EVT,WHO,PAT)
"RTN","VAFCEHU1",68,0)
 ;if other entries than retire them based upon the event date
"RTN","VAFCEHU1",69,0)
 S STATUS=$S(LATEST:"ACTION REQUIRED",1:"RETIRED DATA")
"RTN","VAFCEHU1",70,0)
 ;
"RTN","VAFCEHU1",71,0)
 S (RESLT,RESLT(1))=$$EXCPTN(REC,EVT,WHO,PAT,STATUS)
"RTN","VAFCEHU1",72,0)
 I RESLT=-1 S ERR="0^Adding entry failed" G ADDQ
"RTN","VAFCEHU1",73,0)
 S RESLT=$$DATA(+RESLT,VAFCB)
"RTN","VAFCEHU1",74,0)
 I 'RESLT S ERR="0^Adding element failed"
"RTN","VAFCEHU1",75,0)
 ;
"RTN","VAFCEHU1",76,0)
ADDQ ;
"RTN","VAFCEHU1",77,0)
 I LATEST,'$D(ERR) D RETIRE(EVT,WHO,PAT)
"RTN","VAFCEHU1",78,0)
 Q $S($D(ERR):ERR,1:1)
"RTN","VAFCEHU1",79,0)
 ;
"RTN","VAFCEHU1",80,0)
CHKDATE(EVT,WHO,PAT) ;
"RTN","VAFCEHU1",81,0)
 N AFTER
"RTN","VAFCEHU1",82,0)
 S AFTER=$O(^DGCN(391.98,"AKY",PAT,WHO,EVT)) ;there is another date after
"RTN","VAFCEHU1",83,0)
 Q $S(AFTER:0,1:1)
"RTN","VAFCEHU1",84,0)
 ;
"RTN","VAFCEHU1",85,0)
RETIRE(EVT,WHO,PAT) ; Retire all previous entries from same site
"RTN","VAFCEHU1",86,0)
 N LP,ACTION,EDIT S LP=0
"RTN","VAFCEHU1",87,0)
 ;ien of action required
"RTN","VAFCEHU1",88,0)
 S ACTION=$O(^DGCN(391.984,"B","ACTION REQUIRED",0))
"RTN","VAFCEHU1",89,0)
 Q:'ACTION
"RTN","VAFCEHU1",90,0)
 ;looping to get all action required for "from" site
"RTN","VAFCEHU1",91,0)
 F  S LP=$O(^DGCN(391.98,"AKY",PAT,WHO,LP)) Q:'LP  D
"RTN","VAFCEHU1",92,0)
 .N ENTRY,DATA,XX,ELIEN,NODE
"RTN","VAFCEHU1",93,0)
 .S ENTRY=0
"RTN","VAFCEHU1",94,0)
 .F  S ENTRY=$O(^DGCN(391.98,"AKY",PAT,WHO,LP,ENTRY)) Q:'ENTRY!(ENTRY=+RESLT(1))  D
"RTN","VAFCEHU1",95,0)
 ..S DATA=$G(^DGCN(391.98,ENTRY,0))
"RTN","VAFCEHU1",96,0)
 ..;sets the status to retired
"RTN","VAFCEHU1",97,0)
 ..I DATA,$P(DATA,U,4)=ACTION D  S XX=$$EDIT(ENTRY,"RETIRED DATA")
"RTN","VAFCEHU1",98,0)
 ...;build array of EDITED elements from all entries being retired
"RTN","VAFCEHU1",99,0)
 ...S ELIEN=0
"RTN","VAFCEHU1",100,0)
 ...F  S ELIEN=$O(^DGCN(391.99,"B",ENTRY,ELIEN)) Q:'ELIEN  S NODE=$G(^DGCN(391.99,ELIEN,0)) I NODE,$P(NODE,U,5)=1 S EDIT($P(NODE,U,2),$P(NODE,U,3))=""
"RTN","VAFCEHU1",101,0)
 ..Q
"RTN","VAFCEHU1",102,0)
 ;mark EDITED fields in remaining entry
"RTN","VAFCEHU1",103,0)
 Q:'$O(EDIT(0))
"RTN","VAFCEHU1",104,0)
 N ELIEN,NODE,P2,P3 S ELIEN=0,DIE="^DGCN(391.99,",DR=".05///1"
"RTN","VAFCEHU1",105,0)
 F  S ELIEN=$O(^DGCN(391.99,"B",(+RESLT(1)),ELIEN)) Q:'ELIEN  D
"RTN","VAFCEHU1",106,0)
 .S NODE=$G(^DGCN(391.99,ELIEN,0)),(P2,P3)="" I NODE S P2=$P(NODE,U,2),P3=$P(NODE,U,3) I $D(EDIT(P2,P3)) D
"RTN","VAFCEHU1",107,0)
 ..L +^DGCN(391.99,ELIEN):60 ;**255
"RTN","VAFCEHU1",108,0)
 ..S DA=ELIEN D ^DIE
"RTN","VAFCEHU1",109,0)
 ..L -^DGCN(391.99,ELIEN) ;**255
"RTN","VAFCEHU1",110,0)
 K DA,DIE,DR,EDIT
"RTN","VAFCEHU1",111,0)
 Q
"RTN","VAFCEHU1",112,0)
 ;
"RTN","VAFCEHU1",113,0)
EXCPTN(REC,EVT,WHO,PAT,VAFCA) ;
"RTN","VAFCEHU1",114,0)
 N Y
"RTN","VAFCEHU1",115,0)
 K DIC,DA,DD,DO
"RTN","VAFCEHU1",116,0)
 S DGSENFLG="" ;**255
"RTN","VAFCEHU1",117,0)
 S DLAYGO=391.98
"RTN","VAFCEHU1",118,0)
 S DIC="^DGCN(391.98,"
"RTN","VAFCEHU1",119,0)
 S DIC(0)="L"
"RTN","VAFCEHU1",120,0)
 S X=PAT
"RTN","VAFCEHU1",121,0)
 S DIC("DR")=".02///"_REC_";.03///"_EVT_";.04///"_VAFCA_";50///"_WHO
"RTN","VAFCEHU1",122,0)
 D FILE^DICN
"RTN","VAFCEHU1",123,0)
 K DIC,DLAYGO,X,DGSENFLG ;**255
"RTN","VAFCEHU1",124,0)
 Q Y
"RTN","VAFCEHU1",125,0)
 ;
"RTN","VAFCEHU1",126,0)
DATA(VAFCA,VAFCB) ;
"RTN","VAFCEHU1",127,0)
 N ADDED,LP,LP1,VAR
"RTN","VAFCEHU1",128,0)
 F LP=0:0 S LP=$O(@VAFCB@(LP)) Q:'LP  DO
"RTN","VAFCEHU1",129,0)
 .F LP1=0:0 S LP1=$O(@VAFCB@(LP,LP1)) Q:'LP1  DO
"RTN","VAFCEHU1",130,0)
 ..K DIC,DA,DD,DO,VAFCE
"RTN","VAFCEHU1",131,0)
 ..S DLAYGO=391.99
"RTN","VAFCEHU1",132,0)
 ..S DIC="^DGCN(391.99,"
"RTN","VAFCEHU1",133,0)
 ..S DIC(0)="LI" ;**477 added 'I' to suppress incoming filer from generating bulletins
"RTN","VAFCEHU1",134,0)
 ..S X=VAFCA
"RTN","VAFCEHU1",135,0)
 ..S VAR=@VAFCB@(LP,LP1)
"RTN","VAFCEHU1",136,0)
 ..I (@VAFCB@(2,"FLD")[LP1_";"),(VAR]"") S VAFCE=1
"RTN","VAFCEHU1",137,0)
 ..S DIC("DR")=".02///"_LP_";.03///"_LP1_";.05///"_$G(VAFCE)_";.06///"_$P(VAR,U,2)_";50////^S X=$P(VAR,U)"
"RTN","VAFCEHU1",138,0)
 ..D FILE^DICN
"RTN","VAFCEHU1",139,0)
 ..I Y>0 S ADDED=1
"RTN","VAFCEHU1",140,0)
 ..Q
"RTN","VAFCEHU1",141,0)
 .Q
"RTN","VAFCEHU1",142,0)
 Q $S($D(ADDED):1,1:0)
"RTN","VAFCEHU1",143,0)
 ;
"RTN","VAFCEHU1",144,0)
CHK(A) ;
"RTN","VAFCEHU1",145,0)
 ;INPUT - A This parameter contains a piece string of 3 elements
"RTN","VAFCEHU1",146,0)
 ;      patient dfn^event date/time^from whom
"RTN","VAFCEHU1",147,0)
 ;These are the key element to finding the entry in the patient data 
"RTN","VAFCEHU1",148,0)
 ;exception file.
"RTN","VAFCEHU1",149,0)
 ;
"RTN","VAFCEHU1",150,0)
 ;Patient DFN is the internal entry number of the patient in the patient
"RTN","VAFCEHU1",151,0)
 ;file.
"RTN","VAFCEHU1",152,0)
 ;
"RTN","VAFCEHU1",153,0)
 ;event date/time is the date/time the event took place at the facility
"RTN","VAFCEHU1",154,0)
 ;that sent the data.  This date must be in FM format.
"RTN","VAFCEHU1",155,0)
 ;
"RTN","VAFCEHU1",156,0)
 ;from whom is who sent this information to this medical center.
"RTN","VAFCEHU1",157,0)
 ;
"RTN","VAFCEHU1",158,0)
 ;OUTPUT
"RTN","VAFCEHU1",159,0)
 ; ZERO(0) if nothing found
"RTN","VAFCEHU1",160,0)
 ; ZERO(0)^error description if an error found
"RTN","VAFCEHU1",161,0)
 ; IEN of the entry in the patient data exception file if found
"RTN","VAFCEHU1",162,0)
 ;
"RTN","VAFCEHU1",163,0)
 N FOUND,PAT,EVT,WHO
"RTN","VAFCEHU1",164,0)
 S FOUND=0
"RTN","VAFCEHU1",165,0)
 I '$D(A) S FOUND="0^Input parameter missing." G CHKQ
"RTN","VAFCEHU1",166,0)
 S PAT=$P(A,U,1)
"RTN","VAFCEHU1",167,0)
 I PAT']"" S FOUND="0^No patient DFN defined." G CHKQ
"RTN","VAFCEHU1",168,0)
 I '$D(^DPT(PAT,0)) S FOUND="0^No patient with this DFN." G CHKQ
"RTN","VAFCEHU1",169,0)
 S EVT=$P(A,U,2)
"RTN","VAFCEHU1",170,0)
 I EVT']"" S FOUND="0^Date of event not defined." G CHKQ
"RTN","VAFCEHU1",171,0)
 S WHO=$$WHO^VAFCEHU4($P(A,U,3))
"RTN","VAFCEHU1",172,0)
 I WHO']"" S FOUND="0^Who sent the information is not defined." G CHKQ
"RTN","VAFCEHU1",173,0)
 ;
"RTN","VAFCEHU1",174,0)
 I $D(^DGCN(391.98,"AKY",PAT,WHO,EVT)) DO
"RTN","VAFCEHU1",175,0)
 .S FOUND=$O(^(EVT,"")) ;naked on the ^dgcn aky cross ref.
"RTN","VAFCEHU1",176,0)
 .I '$D(^DGCN(391.98,FOUND,0)) S FOUND=0
"RTN","VAFCEHU1",177,0)
 .Q
"RTN","VAFCEHU1",178,0)
 ;
"RTN","VAFCEHU1",179,0)
CHKQ Q FOUND
"RTN","VAFCEHU1",180,0)
 ;
"RTN","VAFCEHU1",181,0)
DELEXCPT(IEN) ;
"RTN","VAFCEHU1",182,0)
 ;This entry point deletes the entire exception from the file 391.98 
"RTN","VAFCEHU1",183,0)
 ;and 391.99
"RTN","VAFCEHU1",184,0)
 ;INPUTS
"RTN","VAFCEHU1",185,0)
 ;IEN is the IEN of the entry in 391.98 it can be obtained from the call
"RTN","VAFCEHU1",186,0)
 ; to the CHK line tag.
"RTN","VAFCEHU1",187,0)
 ;
"RTN","VAFCEHU1",188,0)
 ;OUTPUT
"RTN","VAFCEHU1",189,0)
 ;ZERO(0) - if a problem or no deletion
"RTN","VAFCEHU1",190,0)
 ;ONE(1) - if deletion occurred
"RTN","VAFCEHU1",191,0)
 ;
"RTN","VAFCEHU1",192,0)
 I '$D(IEN) S ERR="0^Input parameter missing." G DELQ
"RTN","VAFCEHU1",193,0)
 I IEN']"" S ERR="0^Input parameter undefined." G DELQ
"RTN","VAFCEHU1",194,0)
 I '$D(^DGCN(391.98,IEN,0)) S ERR="0^Exception data missing." G DELQ
"RTN","VAFCEHU1",195,0)
 D DELDATA(IEN,.ERR)
"RTN","VAFCEHU1",196,0)
 ;
"RTN","VAFCEHU1",197,0)
 S DIK="^DGCN(391.98,"
"RTN","VAFCEHU1",198,0)
 S DA=IEN
"RTN","VAFCEHU1",199,0)
 D ^DIK
"RTN","VAFCEHU1",200,0)
 K DIK,DA
"RTN","VAFCEHU1",201,0)
 S ERR=1
"RTN","VAFCEHU1",202,0)
 ;
"RTN","VAFCEHU1",203,0)
DELQ Q ERR
"RTN","VAFCEHU1",204,0)
 ;
"RTN","VAFCEHU1",205,0)
DELDATA(IEN,ERR) ;
"RTN","VAFCEHU1",206,0)
 N LP
"RTN","VAFCEHU1",207,0)
 F LP=0:0 S LP=$O(^DGCN(391.99,"B",IEN,LP)) Q:'LP  DO
"RTN","VAFCEHU1",208,0)
 .I '$D(^DGCN(391.99,LP,0)) Q
"RTN","VAFCEHU1",209,0)
 .S DIK="^DGCN(391.99,"
"RTN","VAFCEHU1",210,0)
 .S DA=LP
"RTN","VAFCEHU1",211,0)
 .D ^DIK
"RTN","VAFCEHU1",212,0)
 .K DA,DIK
"RTN","VAFCEHU1",213,0)
 .S ERR=1
"RTN","VAFCEHU1",214,0)
 .Q
"RTN","VAFCEHU1",215,0)
 Q
"RTN","VAFCEHU1",216,0)
 ;
"RTN","VAFCEHU1",217,0)
EDIT(IEN,STAT) ;
"RTN","VAFCEHU1",218,0)
 ;This entry point allows the editing of the status of an exception.
"RTN","VAFCEHU1",219,0)
 ;INPUT
"RTN","VAFCEHU1",220,0)
 ;IEN - the ien for an entry from 391.98
"RTN","VAFCEHU1",221,0)
 ;STAT - the new status.
"RTN","VAFCEHU1",222,0)
 ;
"RTN","VAFCEHU1",223,0)
 ;OUTPUTS
"RTN","VAFCEHU1",224,0)
 ;ZERO(0)^ description if an error
"RTN","VAFCEHU1",225,0)
 ;1 if changed
"RTN","VAFCEHU1",226,0)
 N ERR
"RTN","VAFCEHU1",227,0)
 ;
"RTN","VAFCEHU1",228,0)
 I '$D(IEN) S ERR="0^IEN not defined." G EDITQ
"RTN","VAFCEHU1",229,0)
 I IEN']"" S ERR="0^IEN is null." G EDITQ
"RTN","VAFCEHU1",230,0)
 I '$D(STAT) S ERR="0^Status is not defined." G EDITQ
"RTN","VAFCEHU1",231,0)
 I STAT']"" S ERR="0^Status is null." G EDITQ
"RTN","VAFCEHU1",232,0)
 I '$D(^DGCN(391.98,IEN,0)) S ERR="0^No entry for the IEN." G EDITQ
"RTN","VAFCEHU1",233,0)
 ;
"RTN","VAFCEHU1",234,0)
 N DIE,DA,DR
"RTN","VAFCEHU1",235,0)
 S DIE="^DGCN(391.98,"
"RTN","VAFCEHU1",236,0)
 S DA=IEN
"RTN","VAFCEHU1",237,0)
 S DR=".04///"_STAT
"RTN","VAFCEHU1",238,0)
 D ^DIE
"RTN","VAFCEHU1",239,0)
 S ERR=1
"RTN","VAFCEHU1",240,0)
 ;
"RTN","VAFCEHU1",241,0)
EDITQ Q ERR
"RTN","VAFCEHU1",242,0)
 ;
"RTN","VAFCEHU1",243,0)
LOCK(IEN) ;this function call will check the status of the exception and
"RTN","VAFCEHU1",244,0)
 ;set it to being reviewed if it is able.  Exceptions that are being 
"RTN","VAFCEHU1",245,0)
 ;reviewed, data rejected, merge complete or retired data can not be
"RTN","VAFCEHU1",246,0)
 ;set to being reviewed and thus accessed.
"RTN","VAFCEHU1",247,0)
 ;
"RTN","VAFCEHU1",248,0)
 ;INPUT - IEN the ien of the exception
"RTN","VAFCEHU1",249,0)
 ;
"RTN","VAFCEHU1",250,0)
 ;OUTPUT - 1 if the exception was able to be locked/ status turned to
"RTN","VAFCEHU1",251,0)
 ;           being reviewed.
"RTN","VAFCEHU1",252,0)
 ;         0^description if the exception was not able to be "locked"
"RTN","VAFCEHU1",253,0)
 ;
"RTN","VAFCEHU1",254,0)
 N ERR,STAT,DATA
"RTN","VAFCEHU1",255,0)
 I '$D(IEN) S ERR="0^No input." G LCKQ
"RTN","VAFCEHU1",256,0)
 I IEN']"" S ERR="0^Null input." G LCKQ
"RTN","VAFCEHU1",257,0)
 L +^DGCN(391.98,IEN):0 I '$T S ERR="0^Exception is currently locked." G LCKQ ;**255
"RTN","VAFCEHU1",258,0)
 S DATA=$G(^DGCN(391.98,IEN,0))
"RTN","VAFCEHU1",259,0)
 I DATA="" S ERR="0^Exception not found." G LCKQ
"RTN","VAFCEHU1",260,0)
 S STAT=$P(DATA,U,4)
"RTN","VAFCEHU1",261,0)
 I STAT']"" S ERR="0^Status not defined." G LCKQ
"RTN","VAFCEHU1",262,0)
 S STAT=$G(^DGCN(391.984,STAT,0))
"RTN","VAFCEHU1",263,0)
 I STAT="" S ERR="0^Status not found." G LCKQ
"RTN","VAFCEHU1",264,0)
 I $P(STAT,U,2)'="AR",($P(STAT,U,2)'="DE") S ERR="0^"_$P(STAT,U,1) G LCKQ
"RTN","VAFCEHU1",265,0)
 I $$EDIT(IEN,"BR") S ERR="1^OK"
"RTN","VAFCEHU1",266,0)
 E  S ERR="0^Could not change status."
"RTN","VAFCEHU1",267,0)
 ;
"RTN","VAFCEHU1",268,0)
LCKQ Q ERR
"RTN","VAFCEHU2")
0^14^B58810198
"RTN","VAFCEHU2",1,0)
VAFCEHU2 ;ALB/JLU,LTL-UTILITIES FOR 391.98 AND 391.99 AND LIST MAN ;10/10/02  15:55
"RTN","VAFCEHU2",2,0)
 ;;5.3;Registration;**149,255,333,474,477**;Aug 13, 1993
"RTN","VAFCEHU2",3,0)
SORTS(SRT,ARY) ;
"RTN","VAFCEHU2",4,0)
 ;this tag will sort the exceptions in different formats depending on
"RTN","VAFCEHU2",5,0)
 ;what the user has selected.
"RTN","VAFCEHU2",6,0)
 ;
"RTN","VAFCEHU2",7,0)
 ;INPUTS - SRT this variable contains what sort is requested from the
"RTN","VAFCEHU2",8,0)
 ;list man patient review screen.
"RTN","VAFCEHU2",9,0)
 ; Ex.  SP  sort by patient
"RTN","VAFCEHU2",10,0)
 ;      SS  sort by site
"RTN","VAFCEHU2",11,0)
 ;      SO  sort by oldest event
"RTN","VAFCEHU2",12,0)
 ;      SN  sort by newest event
"RTN","VAFCEHU2",13,0)
 ;ARY - the array the calling program wants the info returned in.
"RTN","VAFCEHU2",14,0)
 ;
"RTN","VAFCEHU2",15,0)
 ;OUTPUT
"RTN","VAFCEHU2",16,0)
 ;a populated array that was passed in by the user.  The array is in
"RTN","VAFCEHU2",17,0)
 ;the structure xxx(#,0)=value
"RTN","VAFCEHU2",18,0)
 ;
"RTN","VAFCEHU2",19,0)
 S VAR=SRT_"(ARY)"
"RTN","VAFCEHU2",20,0)
 D @VAR
"RTN","VAFCEHU2",21,0)
 Q
"RTN","VAFCEHU2",22,0)
 ;
"RTN","VAFCEHU2",23,0)
SP(ARY) ;sort by patient
"RTN","VAFCEHU2",24,0)
 N LP,LP1,CTR
"RTN","VAFCEHU2",25,0)
 S LP=""
"RTN","VAFCEHU2",26,0)
 S CTR=1
"RTN","VAFCEHU2",27,0)
 F  S LP=$O(^DGCN(391.98,"C",LP)) Q:LP=""  F LP1=0:0 S LP1=$O(^DGCN(391.98,"C",LP,LP1)) Q:LP1=""  D BLD(LP1,ARY,.CTR)
"RTN","VAFCEHU2",28,0)
 Q
"RTN","VAFCEHU2",29,0)
 ;
"RTN","VAFCEHU2",30,0)
SS(ARY) ;sort by site
"RTN","VAFCEHU2",31,0)
 N LP,LP1,CTR
"RTN","VAFCEHU2",32,0)
 S LP=""
"RTN","VAFCEHU2",33,0)
 S CTR=1
"RTN","VAFCEHU2",34,0)
 F  S LP=$O(^DGCN(391.98,"FRM",LP)) Q:LP=""  F LP1=0:0 S LP1=$O(^DGCN(391.98,"FRM",LP,LP1)) Q:LP1=""  D BLD(LP1,ARY,.CTR)
"RTN","VAFCEHU2",35,0)
 Q
"RTN","VAFCEHU2",36,0)
 ;
"RTN","VAFCEHU2",37,0)
SO(ARY) ;sort by oldest event
"RTN","VAFCEHU2",38,0)
 N LP,LP1,CTR
"RTN","VAFCEHU2",39,0)
 S LP=""
"RTN","VAFCEHU2",40,0)
 S CTR=1
"RTN","VAFCEHU2",41,0)
 F  S LP=$O(^DGCN(391.98,"EVT",LP)) Q:LP=""  F LP1=0:0 S LP1=$O(^DGCN(391.98,"EVT",LP,LP1)) Q:LP1=""  D BLD(LP1,ARY,.CTR)
"RTN","VAFCEHU2",42,0)
 Q
"RTN","VAFCEHU2",43,0)
 ;
"RTN","VAFCEHU2",44,0)
SN(ARY) ;sort by newest event
"RTN","VAFCEHU2",45,0)
 N LP,LP1,CTR
"RTN","VAFCEHU2",46,0)
 S LP=999999999999
"RTN","VAFCEHU2",47,0)
 S CTR=1
"RTN","VAFCEHU2",48,0)
 F  S LP=$O(^DGCN(391.98,"EVT",LP),-1) Q:LP=""  F LP1=999999999999:0 S LP1=$O(^DGCN(391.98,"EVT",LP,LP1),-1) Q:LP1=""  D BLD(LP1,ARY,.CTR)
"RTN","VAFCEHU2",49,0)
 Q
"RTN","VAFCEHU2",50,0)
 ;
"RTN","VAFCEHU2",51,0)
BLD(LP1,ARY,CTR) ;this is the actual building subroutine.  the array that is
"RTN","VAFCEHU2",52,0)
 ;return is var(#,0)=value starting at 1.
"RTN","VAFCEHU2",53,0)
 ;
"RTN","VAFCEHU2",54,0)
 N DATA,STAT,PAT,XX
"RTN","VAFCEHU2",55,0)
 ;getting the exception
"RTN","VAFCEHU2",56,0)
 S DATA=$G(^DGCN(391.98,LP1,0))
"RTN","VAFCEHU2",57,0)
 Q:DATA']""
"RTN","VAFCEHU2",58,0)
 ;checking for the status
"RTN","VAFCEHU2",59,0)
 ;Q:$P(DATA,U,4)']"" ;**333
"RTN","VAFCEHU2",60,0)
 I $P(DATA,U,4)']"" S XX=$$EDIT^VAFCEHU1(LP1,"RETIRED DATA") Q  ;**333 retire
"RTN","VAFCEHU2",61,0)
 ;getting the status node from 391.984
"RTN","VAFCEHU2",62,0)
 S STAT=$G(^DGCN(391.984,$P(DATA,U,4),0))
"RTN","VAFCEHU2",63,0)
 ;if retired skip
"RTN","VAFCEHU2",64,0)
 I "RETIRED DATA"=$P(STAT,U,1) Q
"RTN","VAFCEHU2",65,0)
 ;if rejected skip
"RTN","VAFCEHU2",66,0)
 I "DATA REJECTED"=$P(STAT,U,1) Q
"RTN","VAFCEHU2",67,0)
 ;if merge complete
"RTN","VAFCEHU2",68,0)
 I "MERGE COMPLETE"=$P(STAT,U,1) Q
"RTN","VAFCEHU2",69,0)
 ;get patient file zero node
"RTN","VAFCEHU2",70,0)
 S PAT=$G(^DPT($P(DATA,U,1),0))
"RTN","VAFCEHU2",71,0)
 ;Q:PAT']"" ;**333
"RTN","VAFCEHU2",72,0)
 I $S(PAT']"":1,$$IFLOCAL^MPIF001(+$P(DATA,U,1)):1,$$IFVCCI^MPIF001(+$P(DATA,U,1))=-1:1,1:0) S XX=$$EDIT^VAFCEHU1(LP1,"RETIRED DATA") Q  ;**333 retire if a local, you're not the cmor or no cmor
"RTN","VAFCEHU2",73,0)
 S @ARY@(CTR,0)=$P(PAT,U,1)_U_$P(PAT,U,9)_U_$P(PAT,U,3)_U_$P(STAT,U,2)_U_$P(DATA,U,3)_U_$G(^DGCN(391.98,LP1,"FRM"))
"RTN","VAFCEHU2",74,0)
 S @ARY@(CTR,"VAFC")=LP1
"RTN","VAFCEHU2",75,0)
 S CTR=CTR+1
"RTN","VAFCEHU2",76,0)
 Q
"RTN","VAFCEHU2",77,0)
 ;
"RTN","VAFCEHU2",78,0)
FORMAT(ARY,VALMCNT,VALMQUIT) ;this subroutines formats the array in ARY
"RTN","VAFCEHU2",79,0)
 ;from file 391.98 for display by the list manager.  It accepts the
"RTN","VAFCEHU2",80,0)
 ;array name as its input in ARY.
"RTN","VAFCEHU2",81,0)
 ;VALMCNT and VALMQUIT are passed by reference
"RTN","VAFCEHU2",82,0)
 ;VALMCNT will be the total number of entries
"RTN","VAFCEHU2",83,0)
 ;VALMQUIT tells list man to quit if something when wrong.
"RTN","VAFCEHU2",84,0)
 ;
"RTN","VAFCEHU2",85,0)
 N CTR,STR,LP
"RTN","VAFCEHU2",86,0)
 S CTR=1
"RTN","VAFCEHU2",87,0)
 F LP=0:0 S LP=$O(@ARY@(LP)) Q:'LP  S STR=$G(@ARY@(LP,0)) I STR]"" DO
"RTN","VAFCEHU2",88,0)
 .N X,DATE
"RTN","VAFCEHU2",89,0)
 .S X=$$SETSTR^VALM1(CTR,"",1,4)
"RTN","VAFCEHU2",90,0)
 .S X=$$SETSTR^VALM1($E($P(STR,U,1),1,23),X,5,23)
"RTN","VAFCEHU2",91,0)
 .S X=$$SETSTR^VALM1($P(STR,U,2),X,29,9)
"RTN","VAFCEHU2",92,0)
 .S DATE=$$IN2EXDT^VAFCMGU0($P(STR,U,3))
"RTN","VAFCEHU2",93,0)
 .S X=$$SETSTR^VALM1(DATE,X,40,10)
"RTN","VAFCEHU2",94,0)
 .S X=$$SETSTR^VALM1($P(STR,U,4),X,51,2)
"RTN","VAFCEHU2",95,0)
 .S DATE=$$IN2EXDT^VAFCMGU0($P(STR,U,5))
"RTN","VAFCEHU2",96,0)
 .S X=$$SETSTR^VALM1(DATE,X,55,10)
"RTN","VAFCEHU2",97,0)
 .S X=$$SETSTR^VALM1($P(STR,U,6),X,67,$L($P(STR,U,6)))
"RTN","VAFCEHU2",98,0)
 .S @ARY@(LP,0)=X
"RTN","VAFCEHU2",99,0)
 .S @ARY@("IDX",CTR,CTR)=""
"RTN","VAFCEHU2",100,0)
 .S CTR=CTR+1
"RTN","VAFCEHU2",101,0)
 .Q
"RTN","VAFCEHU2",102,0)
 S VALMCNT=CTR-1
"RTN","VAFCEHU2",103,0)
 I CTR=1 DO
"RTN","VAFCEHU2",104,0)
 .S @ARY@(1,0)=""
"RTN","VAFCEHU2",105,0)
 .S @ARY@(2,0)="There are no exceptions on file to review."
"RTN","VAFCEHU2",106,0)
 .S VALMCNT=2
"RTN","VAFCEHU2",107,0)
 .Q
"RTN","VAFCEHU2",108,0)
 Q
"RTN","VAFCEHU2",109,0)
 ;
"RTN","VAFCEHU2",110,0)
FRMDATA(IEN,ARY) ;
"RTN","VAFCEHU2",111,0)
 ;This entry point will return all the data related to a given exception
"RTN","VAFCEHU2",112,0)
 ;INPUTS
"RTN","VAFCEHU2",113,0)
 ;  IEN - The IEN of the exception to be extracted.
"RTN","VAFCEHU2",114,0)
 ;  ARY - The array that the user wishes the information returned in.
"RTN","VAFCEHU2",115,0)
 ;        This array can be either local or global.
"RTN","VAFCEHU2",116,0)
 ;  Ex.   ^TMP("TEST",$J)
"RTN","VAFCEHU2",117,0)
 ;        If and array is not passed then a default global array will
"RTN","VAFCEHU2",118,0)
 ;        be used.  ^TMP($J,"VAFC-MRG","DATA")
"RTN","VAFCEHU2",119,0)
 ;OUTPUTS
"RTN","VAFCEHU2",120,0)
 ;  1 if the look up and retreival were successful
"RTN","VAFCEHU2",121,0)
 ;  0^description if they were not.
"RTN","VAFCEHU2",122,0)
 ;
"RTN","VAFCEHU2",123,0)
 N ERR,LP,DATA
"RTN","VAFCEHU2",124,0)
 I '$D(IEN) S ERR="0^Parameter not defined." G FRMQ
"RTN","VAFCEHU2",125,0)
 I IEN']"" S ERR="0^Exception not defined." G FRMQ
"RTN","VAFCEHU2",126,0)
 I '$D(^DGCN(391.98,IEN,0)) S ERR="0^Exception not in file." G FRMQ
"RTN","VAFCEHU2",127,0)
 I '$D(^DGCN(391.99,"B",IEN)) S ERR="0^Data for exception not defined." G FRMQ
"RTN","VAFCEHU2",128,0)
 I '$D(ARY) S ARY="^TMP($J,""VAFC-MRG"",""DATA"")"
"RTN","VAFCEHU2",129,0)
 I ARY']"" S ARY="^TMP($J,""VAFC-MRG"",""DATA"")"
"RTN","VAFCEHU2",130,0)
 S LP=""
"RTN","VAFCEHU2",131,0)
 F  S LP=$O(^DGCN(391.99,"B",IEN,LP)) Q:'LP  DO
"RTN","VAFCEHU2",132,0)
 . S DATA=$G(^DGCN(391.99,LP,0))
"RTN","VAFCEHU2",133,0)
 . Q:'DATA
"RTN","VAFCEHU2",134,0)
 . I $P(DATA,U,2)=""!($P(DATA,U,3)="") Q  ;**477
"RTN","VAFCEHU2",135,0)
 . I $S($P(DATA,U,3)=.211:1,$P(DATA,U,3)=.2403:1,1:0) D  ;**477 standardize mmn and nok for old pdr entries
"RTN","VAFCEHU2",136,0)
 . . N DGNAME S DGNAME=$G(^DGCN(391.99,LP,"VAL")) I $S(DGNAME="":0,DGNAME["@":0,1:1) D
"RTN","VAFCEHU2",137,0)
 . . . I $P(DATA,U,3)=.211 D STDNAME^XLFNAME(.DGNAME,"P") S DGNAME=$$FORMAT^DPTNAME(.DGNAME,3,35) I DGNAME="" Q
"RTN","VAFCEHU2",138,0)
 . . . I $P(DATA,U,3)=.2403 D STDNAME^XLFNAME(.DGNAME,"P") S DGNAME=$$FORMAT^DPTNAME(.DGNAME,3,35,,2,,1) I DGNAME="" Q
"RTN","VAFCEHU2",139,0)
 . . . D UPD(LP,50,DGNAME)
"RTN","VAFCEHU2",140,0)
 . I $P(DATA,U,3)=.05,($G(^DGCN(391.99,LP,"VAL"))="N") D UPD(LP,50,"NEVER MARRIED"),UPD(LP,.06,"@") S $P(DATA,"^",6)="" ;**477 translate marital status from 'n' to 'never married' and remove unresolved flag
"RTN","VAFCEHU2",141,0)
 . ;
"RTN","VAFCEHU2",142,0)
 . S @ARY@($P(DATA,U,2),$P(DATA,U,3))=$G(^DGCN(391.99,LP,"VAL"))_U_$P(DATA,U,5)_U_$P(DATA,U,6)
"RTN","VAFCEHU2",143,0)
 . Q
"RTN","VAFCEHU2",144,0)
 I $D(@ARY)>9 S ERR=1
"RTN","VAFCEHU2",145,0)
 E  S ERR="0^No elments found."
"RTN","VAFCEHU2",146,0)
 ;
"RTN","VAFCEHU2",147,0)
FRMQ Q ERR
"RTN","VAFCEHU2",148,0)
 ;
"RTN","VAFCEHU2",149,0)
REVFUL ;this entry point is to process the user selection from the summary
"RTN","VAFCEHU2",150,0)
 ;screen of the exception handler.
"RTN","VAFCEHU2",151,0)
 ;the variable VALMAR is expected.  This contains the array that is
"RTN","VAFCEHU2",152,0)
 ;being used as part of list manager
"RTN","VAFCEHU2",153,0)
 ;
"RTN","VAFCEHU2",154,0)
 ;variable collision during VAFCMG01 processing, changed ien to ienpdr ;**477
"RTN","VAFCEHU2",155,0)
 ;
"RTN","VAFCEHU2",156,0)
 S VALM("ENTITY")="Patient"
"RTN","VAFCEHU2",157,0)
 D EN^VALM2(XQORNOD(0))
"RTN","VAFCEHU2",158,0)
 I '$D(VALMY) G FULQ
"RTN","VAFCEHU2",159,0)
 N LP,RES
"RTN","VAFCEHU2",160,0)
 F LP=0:0 S LP=$O(VALMY(LP)) Q:'LP  DO  Q:RES<-9
"RTN","VAFCEHU2",161,0)
 .N IENPDR,LCK,MSG,EXCPT,FRM,STR,STAT,EDT,ARY
"RTN","VAFCEHU2",162,0)
 .S RES=0
"RTN","VAFCEHU2",163,0)
 .S IENPDR=$O(@VALMAR@("IDX",LP,0))
"RTN","VAFCEHU2",164,0)
 .Q:'IENPDR
"RTN","VAFCEHU2",165,0)
 .S IENPDR=$G(@VALMAR@(IENPDR,"VAFC"))
"RTN","VAFCEHU2",166,0)
 .Q:'IENPDR
"RTN","VAFCEHU2",167,0)
 .S LCK=$$LOCK^VAFCEHU1(IENPDR)
"RTN","VAFCEHU2",168,0)
 .I 'LCK DO  Q
"RTN","VAFCEHU2",169,0)
 ..N PAT
"RTN","VAFCEHU2",170,0)
 ..S PAT=$E(@VALMAR@(LP,0),4,27)
"RTN","VAFCEHU2",171,0)
 ..D FULL^VALM1
"RTN","VAFCEHU2",172,0)
 ..W $C(7)
"RTN","VAFCEHU2",173,0)
 ..W !!,"The status for ",PAT," is ",$P(LCK,U,2)
"RTN","VAFCEHU2",174,0)
 ..W !,"Review or merging of this data is not allowed at this time."
"RTN","VAFCEHU2",175,0)
 ..D PAUSE^VALM1
"RTN","VAFCEHU2",176,0)
 ..Q
"RTN","VAFCEHU2",177,0)
 .S EXCPT=$G(^DGCN(391.98,IENPDR,0))
"RTN","VAFCEHU2",178,0)
 .S FRM=$G(^DGCN(391.98,IENPDR,"FRM"))
"RTN","VAFCEHU2",179,0)
 .I 'EXCPT!(FRM']"") Q
"RTN","VAFCEHU2",180,0)
 .S ARY="^TMP($J,""VAFC-MRG"",""DATA"")"
"RTN","VAFCEHU2",181,0)
 .S STR=$$FRMDATA(IENPDR,ARY)
"RTN","VAFCEHU2",182,0)
 .Q:'STR
"RTN","VAFCEHU2",183,0)
 .S RES=$$EN^VAFCMG01($P(EXCPT,U,1),ARY,FRM,$P(EXCPT,U,3))
"RTN","VAFCEHU2",184,0)
 .S STAT=$S(RES>11:"DR",RES>9:"MC",RES<2:"DE",1:"AR")
"RTN","VAFCEHU2",185,0)
 .S EDT=$$EDIT^VAFCEHU1(IENPDR,STAT)
"RTN","VAFCEHU2",186,0)
 .I RES=10!(RES=11) D WHO(IENPDR,DUZ,"NOW")
"RTN","VAFCEHU2",187,0)
 .L -^DGCN(391.98,IENPDR) ;**255
"RTN","VAFCEHU2",188,0)
 .Q
"RTN","VAFCEHU2",189,0)
 D INIT2^VAFCEHLM
"RTN","VAFCEHU2",190,0)
 ;
"RTN","VAFCEHU2",191,0)
FULQ Q
"RTN","VAFCEHU2",192,0)
 ;
"RTN","VAFCEHU2",193,0)
WHO(IEN,WHO,WHEN) ;this entry point updates the exceptions as to who
"RTN","VAFCEHU2",194,0)
 ;made this update and when.
"RTN","VAFCEHU2",195,0)
 ;
"RTN","VAFCEHU2",196,0)
 S DIE="^DGCN(391.98,"
"RTN","VAFCEHU2",197,0)
 S DA=IEN
"RTN","VAFCEHU2",198,0)
 S DR="12////"_DUZ_";11///"_WHEN
"RTN","VAFCEHU2",199,0)
 D ^DIE
"RTN","VAFCEHU2",200,0)
 Q
"RTN","VAFCEHU2",201,0)
 ;
"RTN","VAFCEHU2",202,0)
RETPDR(DFN,STAIEN) ;retire site's PDRs 'awaiting review' for patient ;**474
"RTN","VAFCEHU2",203,0)
 ;INPUT    DFN - ien of the patient
"RTN","VAFCEHU2",204,0)
 ;      STAIEN - ien of the institution
"RTN","VAFCEHU2",205,0)
 ;
"RTN","VAFCEHU2",206,0)
 N DAT,IEN,NAM,PDRIEN,STANAM,VAFCINST
"RTN","VAFCEHU2",207,0)
 I 'DFN!'STAIEN Q
"RTN","VAFCEHU2",208,0)
 D GETS^DIQ(4,STAIEN_",",".01;999.1*",,"VAFCINST") ;retrieve current name and name history
"RTN","VAFCEHU2",209,0)
 S NAM=$G(VAFCINST(4,STAIEN_",",.01)) I NAM'="" S STANAM(NAM)="" ;get current name
"RTN","VAFCEHU2",210,0)
 S IEN="" F  S IEN=$O(VAFCINST(4.999,IEN)) Q:IEN=""  S NAM=$G(VAFCINST(4.999,IEN,.02)) I NAM'="" S STANAM(NAM)="" ;get name history in case site name change
"RTN","VAFCEHU2",211,0)
 S NAM="" F  S NAM=$O(STANAM(NAM)) Q:NAM=""  D  ;loop through array of names
"RTN","VAFCEHU2",212,0)
 . S DAT=0 F  S DAT=$O(^DGCN(391.98,"AKY",DFN,NAM,DAT)) Q:DAT=""  D  ;loop through site's pdrs for patient
"RTN","VAFCEHU2",213,0)
 . . S PDRIEN="" F  S PDRIEN=$O(^DGCN(391.98,"AKY",DFN,NAM,DAT,PDRIEN)) Q:'PDRIEN  I $P($G(^DGCN(391.98,PDRIEN,0)),"^",4)=1 S XX=$$EDIT^VAFCEHU1(PDRIEN,"RETIRED DATA") ;retire pdr's awaiting review
"RTN","VAFCEHU2",214,0)
 Q
"RTN","VAFCEHU2",215,0)
 ;
"RTN","VAFCEHU2",216,0)
UPD(DA,FLD,VAL) ;update value ;**477
"RTN","VAFCEHU2",217,0)
 L +^DGCN(391.99,DA,0):10
"RTN","VAFCEHU2",218,0)
 S DIE="^DGCN(391.99,"
"RTN","VAFCEHU2",219,0)
 S DR=FLD_"///^S X=VAL"
"RTN","VAFCEHU2",220,0)
 D ^DIE K DIE,DR
"RTN","VAFCEHU2",221,0)
 L -^DGCN(391.99,DA,0)
"RTN","VAFCEHU2",222,0)
 Q
"RTN","VAFCEHU3")
0^15^B21615424
"RTN","VAFCEHU3",1,0)
VAFCEHU3 ;BIR/LTL,PTD-File utilities for 391.98 ;10/23/02
"RTN","VAFCEHU3",2,0)
 ;;5.3;Registration;**149,295,384,474,477**;Aug 13, 1993
"RTN","VAFCEHU3",3,0)
 ;
"RTN","VAFCEHU3",4,0)
 ;Check for select fields that if edited can update without review
"RTN","VAFCEHU3",5,0)
EN ;
"RTN","VAFCEHU3",6,0)
 N VAFC,VAFCE,VAFCF S VAFCF=1
"RTN","VAFCEHU3",7,0)
 ;Save the array so a new one can be built for edit
"RTN","VAFCEHU3",8,0)
 M VAFC=@VAFCB K @VAFCB
"RTN","VAFCEHU3",9,0)
 F  S VAFCE=$P(VAFC(2,"FLD"),";",VAFCF) Q:'VAFCE  S VAFCF=VAFCF+1 D
"RTN","VAFCEHU3",10,0)
 .Q:(VAFCE>.01&(VAFCE<.111))!(VAFCE>.219)
"RTN","VAFCEHU3",11,0)
 .S @VAFCB@(2,VAFCE)=VAFC(2,VAFCE)
"RTN","VAFCEHU3",12,0)
 ;save the sending site's station number
"RTN","VAFCEHU3",13,0)
 I $D(VAFC(2,"SENDING SITE")) S @VAFCB@(2,"SENDING SITE")=VAFC(2,"SENDING SITE")
"RTN","VAFCEHU3",14,0)
ED ;D:$D(VAFCB) EDIT^VAFCPTED(PAT,VAFCB_"(2)",".01") ;**295 auto-updated fields - removed .111;.112;.113;.114;.115;.1112;.117;.131;.132;.211;.219 ;**474 stop all auto-updates
"RTN","VAFCEHU3",15,0)
 ;restore the array for possible exceptions
"RTN","VAFCEHU3",16,0)
 M @VAFCB=VAFC
"RTN","VAFCEHU3",17,0)
CH ;Any differences?
"RTN","VAFCEHU3",18,0)
 N DFN,DGNAME ;**295,**384
"RTN","VAFCEHU3",19,0)
 S DFN=PAT,VAFCQ=0,VAFCF=@VAFCB@(2,"FLD") D DEM^VADPT
"RTN","VAFCEHU3",20,0)
 ;reformat problem data
"RTN","VAFCEHU3",21,0)
 I @VAFCB@(2,.05)="N" S @VAFCB@(2,.05)="NEVER MARRIED" ;**477
"RTN","VAFCEHU3",22,0)
 ;If not null and different or null and edited and different,
"RTN","VAFCEHU3",23,0)
 ;we got an exception, we're out of here
"RTN","VAFCEHU3",24,0)
 ;NAME - .01 - VADM(1)
"RTN","VAFCEHU3",25,0)
 I '$$COMP^VAFCUTL(VADM(1),@VAFCB@(2,.01)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",26,0)
 ;SEX - .02 - VADM(5)
"RTN","VAFCEHU3",27,0)
 I (@VAFCB@(2,.02)'[U)&(($P(VADM(5),U,2)'=@VAFCB@(2,.02))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",28,0)
 ;DOB - .03 - VADM(3)
"RTN","VAFCEHU3",29,0)
 I (@VAFCB@(2,.03)'=$P(VADM(3),U)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",30,0)
 ;MARITAL STATUS - .05 - VADM(10)
"RTN","VAFCEHU3",31,0)
 I (@VAFCB@(2,.05)'="""@"""),($P(VADM(10),U,2)'=@VAFCB@(2,.05)),(@VAFCB@(2,.05)'[U) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",32,0)
 ;RELIGION - .08 - VADM(9)
"RTN","VAFCEHU3",33,0)
 I (@VAFCB@(2,.08)'[U),($P(VADM(9),U,2)'=@VAFCB@(2,.08)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",34,0)
 ;SSN - .09 - VADM(2)
"RTN","VAFCEHU3",35,0)
 I (@VAFCB@(2,.09)'=$P(VADM(2),U)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",36,0)
 ;get some address stuff
"RTN","VAFCEHU3",37,0)
 D ADD^VADPT
"RTN","VAFCEHU3",38,0)
 ;STREET ADDRESS [1] - .111 - VAPA(1)
"RTN","VAFCEHU3",39,0)
 I (@VAFCB@(2,.111)'="""@"""),'$$COMP^VAFCUTL(@VAFCB@(2,.111),VAPA(1)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",40,0)
 ;STREET ADDRESS [2] - .112 - VAPA(2)
"RTN","VAFCEHU3",41,0)
 I (@VAFCB@(2,.112)'="""@"""),'$$COMP^VAFCUTL(@VAFCB@(2,.112),VAPA(2)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",42,0)
 ;STREET ADDRESS [3] - .113 - VAPA(3)
"RTN","VAFCEHU3",43,0)
 I (@VAFCB@(2,.113)'="""@"""),'$$COMP^VAFCUTL(@VAFCB@(2,.113),VAPA(3)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",44,0)
 ;CITY - .114 - VAPA(4)
"RTN","VAFCEHU3",45,0)
 I (@VAFCB@(2,.114)'="""@"""),'$$COMP^VAFCUTL(VAPA(4),@VAFCB@(2,.114)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",46,0)
 ;STATE - .115 - VAPA(5)
"RTN","VAFCEHU3",47,0)
 I (@VAFCB@(2,.115)'="""@"""),($P(VAPA(5),U,2)'=@VAFCB@(2,.115)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",48,0)
 ;ZIP+4 - .1112 - VAPA(11)
"RTN","VAFCEHU3",49,0)
 I (@VAFCB@(2,.1112)'="""@"""),(@VAFCB@(2,.1112)'=$P(VAPA(11),U,2)) S VAFCQ=1 G CHQ ;**477 added u,2)
"RTN","VAFCEHU3",50,0)
 ;COUNTY CODE - .117 - VAPA(7)
"RTN","VAFCEHU3",51,0)
 I @VAFCB@(2,.117),(@VAFCB@(2,.117)'=$P(VAPA(7),U)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",52,0)
 ;PHONE HOME - .131 - VAPA(8)
"RTN","VAFCEHU3",53,0)
 I (@VAFCB@(2,.131)'="""@"""),'$$COMP^VAFCUTL($$HLPHONE^HLFNC(VAPA(8)),$$HLPHONE^HLFNC(@VAFCB@(2,.131))) S VAFCQ=1 G CHQ ;**384
"RTN","VAFCEHU3",54,0)
 ;Get the rest
"RTN","VAFCEHU3",55,0)
 D GETS^DIQ(2,DFN_",",".132;.211;.219;.2403;.301;.302;.31115;.323;.361;391;1901","","VAPA")
"RTN","VAFCEHU3",56,0)
 ;PHONE WORK - .132 - VAPA(2,DFN,.132)
"RTN","VAFCEHU3",57,0)
 I (@VAFCB@(2,.132)'="""@"""),'$$COMP^VAFCUTL($$HLPHONE^HLFNC(VAPA(2,DFN_",",.132)),$$HLPHONE^HLFNC(@VAFCB@(2,.132))) S VAFCQ=1 G CHQ ;**384
"RTN","VAFCEHU3",58,0)
 ;K-NAME - .211 - VAPA(2,DFN,.211)
"RTN","VAFCEHU3",59,0)
 I $S(VAPA(2,DFN_",",.211)="":0,1:1) S DGNAME=VAPA(2,DFN_",",.211) D STDNAME^XLFNAME(.DGNAME,"P") S DGNAME=$$FORMAT^DPTNAME(.DGNAME,3,35),VAPA(2,DFN_",",.211)=DGNAME ;**384 **477
"RTN","VAFCEHU3",60,0)
 I $S(@VAFCB@(2,.211)="":0,@VAFCB@(2,.211)["@":0,1:1) S DGNAME=@VAFCB@(2,.211) D STDNAME^XLFNAME(.DGNAME,"P") S DGNAME=$$FORMAT^DPTNAME(.DGNAME,3,35),@VAFCB@(2,.211)=DGNAME ;**384 **477
"RTN","VAFCEHU3",61,0)
 I (@VAFCB@(2,.211)'="""@"""),'$$COMP^VAFCUTL(VAPA(2,DFN_",",.211),@VAFCB@(2,.211)) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",62,0)
 ;K-PHONE - .219 - VAPA(2,DFN,.219)
"RTN","VAFCEHU3",63,0)
 I (@VAFCB@(2,.219)'="""@"""),'$$COMP^VAFCUTL($$HLPHONE^HLFNC(VAPA(2,DFN_",",.219)),$$HLPHONE^HLFNC(@VAFCB@(2,.219))) S VAFCQ=1 G CHQ ;**384
"RTN","VAFCEHU3",64,0)
 ;MOTHER'S MAIDEN NAME - .2403 - VAPA(2,DFN,.2403)
"RTN","VAFCEHU3",65,0)
 I $S(VAPA(2,DFN_",",.2403)="":0,1:1) S DGNAME=VAPA(2,DFN_",",.2403) D STDNAME^XLFNAME(.DGNAME,"P") S DGNAME=$$FORMAT^DPTNAME(.DGNAME,3,35,,2,,1),VAPA(2,DFN_",",.2403)=DGNAME ;**384 **477
"RTN","VAFCEHU3",66,0)
 I $S(@VAFCB@(2,.2403)="":0,@VAFCB@(2,.2403)["@":0,1:1) S DGNAME=@VAFCB@(2,.2403) D STDNAME^XLFNAME(.DGNAME,"P") S DGNAME=$$FORMAT^DPTNAME(.DGNAME,3,35,,2,,1),@VAFCB@(2,.2403)=DGNAME ;**384 **477
"RTN","VAFCEHU3",67,0)
 I ((@VAFCB@(2,.2403)'="""@""")&('$$COMP^VAFCUTL(VAPA(2,DFN_",",.2403),@VAFCB@(2,.2403))))!((@VAFCB@(2,.2403)="""@""")&((VAFCF[".2403;"))&((VAPA(2,DFN_",",.2403)]""))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",68,0)
 ;SERVICE CONNECTED - .301 - VAPA(2,DFN,.301)
"RTN","VAFCEHU3",69,0)
 ;I ((@VAFCB@(2,.301)'="""@""")&((VAPA(2,DFN_",",.301)'=@VAFCB@(2,.301))))!((@VAFCB@(2,.301)="""@""")&((VAFCF[".301;"))&((VAPA(2,DFN_",",.301)]""))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",70,0)
 ;SC% - .302 - VAPA(2,DFN,.302)
"RTN","VAFCEHU3",71,0)
 ;I (@VAFCB@(2,.302)&((VAPA(2,DFN_",",.302)'=@VAFCB@(2,.302))))!((@VAFCB@(2,.302)="""@""")&((VAFCF[".302;"))&((VAPA(2,DFN_",",.302)]""))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",72,0)
 ;EMPLOYMENT STATUS - .31115 - VAPA(2,DFN,.31115)
"RTN","VAFCEHU3",73,0)
 I ((@VAFCB@(2,.31115)'="""@""")&((VAPA(2,DFN_",",.31115)'=@VAFCB@(2,.31115))))!((@VAFCB@(2,.31115)="""@""")&((VAFCF[".31115;"))&((VAPA(2,DFN_",",.31115)]""))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",74,0)
 ;PERIOD OF SERVICE - .323 - VAPA(2,DFN,.323)
"RTN","VAFCEHU3",75,0)
 ;I ((@VAFCB@(2,.323)'="""@""")&((VAPA(2,DFN_",",.323)'=@VAFCB@(2,.323))))!((@VAFCB@(2,.323)="""@""")&((VAFCF[".323;"))&((VAPA(2,DFN_",",.323)]""))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",76,0)
 ;DATE OF DEATH - .351 - VAPA(2,DFN,.351)
"RTN","VAFCEHU3",77,0)
 S VAPA(2,DFN_",",.351)=$$GET1^DIQ(2,DFN_",",.351,"I")
"RTN","VAFCEHU3",78,0)
 I ((@VAFCB@(2,.351)'="""@""")&((@VAFCB@(2,.351)'=VAPA(2,DFN_",",.351))))!((@VAFCB@(2,.351)="""@""")&((VAFCF[".351"))&(VAPA(2,DFN_",",.351))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",79,0)
 ;PRIMARY ELIG CODE - .361 - VAPA(2,DFN,.361)
"RTN","VAFCEHU3",80,0)
 ;I (@VAFCB@(2,.361)]"")&(@VAFCB@(2,.361)'=VAPA(2,DFN_",",.361))!((@VAFCB@(2,.361)="")&((VAFCF[".361;"))&((@VAFCB@(2,.361)'=VAPA(2,DFN_",",.361)))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",81,0)
 ;PATIENT TYPE - 391 - VAPA(2,DFN,391)
"RTN","VAFCEHU3",82,0)
 ;I ((@VAFCB@(2,391)'="""@""")&(@VAFCB@(2,391)'=VAPA(2,DFN_",",391)))!((@VAFCB@(2,391)="""@""")&((VAFCF["391;"))&((VAPA(2,DFN_",",391)]""))) S VAFCQ=1 G CHQ
"RTN","VAFCEHU3",83,0)
 ;VETERAN (Y/N) - 1901 - VAPA(2,DFN,1901)
"RTN","VAFCEHU3",84,0)
 ;I ((@VAFCB@(2,1901)'="""@""")&(@VAFCB@(2,1901)'=VAPA(2,DFN_",",1901)))!((@VAFCB@(2,1901)="""@""")&((VAFCF["1901;"))&((VAPA(2,DFN_",",1901)]""))) S VAFCQ=1
"RTN","VAFCEHU3",85,0)
CHQ D:'$G(VAFCQ) EN^VAFCEHU4
"RTN","VAFCEHU3",86,0)
 D KVA^VADPT Q
"RTN","VAFCHFS")
0^19^B30461172
"RTN","VAFCHFS",1,0)
VAFCHFS ;BIR/DLR-BUILD HFS FILE FOR CAPTURING REPORT DATA ;08/20/01
"RTN","VAFCHFS",2,0)
 ;;5.3;Registration;**414,477**;Aug 13, 1993
"RTN","VAFCHFS",3,0)
 ;;Routine uses the following supported IAs #2263, #2320, #2336, and #2992.
"RTN","VAFCHFS",4,0)
HFS(LINETAG) ;
"RTN","VAFCHFS",5,0)
 N VAFCDIR,VAFCFILE,POP
"RTN","VAFCHFS",6,0)
 D HFSOPEN("RPC") I POP D  Q
"RTN","VAFCHFS",7,0)
 .S ^TMP("VAFCHFS",$J,1)="ERROR: UNABLE TO ACCESS HFS DIRECTORY "_VAFCDIR_" FILE "_VAFCFILE
"RTN","VAFCHFS",8,0)
 .S ^TMP("VAFCHFS",$J,2)="PLEASE CHECK DIRECTORY WRITE PRIVILEGES."
"RTN","VAFCHFS",9,0)
 U IO
"RTN","VAFCHFS",10,0)
 D @LINETAG
"RTN","VAFCHFS",11,0)
 D HFSCLOSE("RPC")
"RTN","VAFCHFS",12,0)
 ;M RESULTS=^TMP($J)
"RTN","VAFCHFS",13,0)
 Q
"RTN","VAFCHFS",14,0)
 ;
"RTN","VAFCHFS",15,0)
HFSOPEN(HANDLE) ;
"RTN","VAFCHFS",16,0)
 S VAFCDIR=$$GET^XPAR("SYS","VAFC HFS SCRATCH")
"RTN","VAFCHFS",17,0)
 S VAFCFILE="VAFC"_DUZ_".DAT"
"RTN","VAFCHFS",18,0)
 S IOM=132,IOSL=99999,IOST="P-DUMMY",IOF=""""""
"RTN","VAFCHFS",19,0)
 D OPEN^%ZISH(HANDLE,VAFCDIR,VAFCFILE,"W") Q:POP
"RTN","VAFCHFS",20,0)
 Q
"RTN","VAFCHFS",21,0)
 ;
"RTN","VAFCHFS",22,0)
HFSCLOSE(HANDLE) ;
"RTN","VAFCHFS",23,0)
 N VAFCDIR,VAFCFILE,VAFCDEL
"RTN","VAFCHFS",24,0)
 D CLOSE^%ZISH(HANDLE)
"RTN","VAFCHFS",25,0)
 K ^TMP("VAFCHFS",$J)
"RTN","VAFCHFS",26,0)
 S VAFCDIR=$$GET^XPAR("SYS","VAFC HFS SCRATCH")
"RTN","VAFCHFS",27,0)
 S VAFCFILE="VAFC"_DUZ_".DAT",VAFCDEL(VAFCFILE)=""
"RTN","VAFCHFS",28,0)
 S X=$$FTG^%ZISH(VAFCDIR,VAFCFILE,$NAME(^TMP("VAFCHFS",$J,1)),3)
"RTN","VAFCHFS",29,0)
 S X=$$DEL^%ZISH(VAFCDIR,$NA(VAFCDEL))
"RTN","VAFCHFS",30,0)
 Q
"RTN","VAFCHFS",31,0)
 ;
"RTN","VAFCHFS",32,0)
HFSGET(RM,GOTO) ;
"RTN","VAFCHFS",33,0)
 ;RM=Right margin
"RTN","VAFCHFS",34,0)
 S:'$G(RM) RM=80
"RTN","VAFCHFS",35,0)
 N ZTQUEUED,VAFCHFS,VAFCSUB,VAFCIO
"RTN","VAFCHFS",36,0)
 S VAFCHFS="VAFC_"_$J_".DAT",VAFCSUB="VAFCDATA"
"RTN","VAFCHFS",37,0)
 D OPEN(.RM,.VAFCHFS,"W",.VAFCIO)
"RTN","VAFCHFS",38,0)
 D @GOTO
"RTN","VAFCHFS",39,0)
 D CLOSE(.VAFCRM,.VAFCHFS,.VAFCSUB,.VAFCIO)
"RTN","VAFCHFS",40,0)
 Q
"RTN","VAFCHFS",41,0)
 ;
"RTN","VAFCHFS",42,0)
OPEN(VAFCRM,VAFCHFS,VAFCMODE,VAFCIO) ; -- open WORKSTATION device
"RTN","VAFCHFS",43,0)
 ;   VAFCRM: right margin
"RTN","VAFCHFS",44,0)
 ;  VAFCHFS: host file name
"RTN","VAFCHFS",45,0)
 ; VAFCMODE: open file in 'R'ead or 'W'rite mode
"RTN","VAFCHFS",46,0)
 S ZTQUEUED="" K IOPAR
"RTN","VAFCHFS",47,0)
 S IOP="OR WORKSTATION;"_$G(VAFCRM,80)
"RTN","VAFCHFS",48,0)
 S %ZIS("HFSMODE")=VAFCMODE,%ZIS("HFSNAME")=VAFCHFS
"RTN","VAFCHFS",49,0)
 D ^%ZIS K IOP,%ZIS
"RTN","VAFCHFS",50,0)
 U IO S VAFCIO=IO
"RTN","VAFCHFS",51,0)
 Q
"RTN","VAFCHFS",52,0)
 ;
"RTN","VAFCHFS",53,0)
CLOSE(VAFCRM,VAFCHFS,VAFCSUB,VAFCIO) ; -- close WORKSTATION device
"RTN","VAFCHFS",54,0)
 ; VAFCSUB: unique subscript name for output 
"RTN","VAFCHFS",55,0)
 I IO=VAFCIO D ^%ZISC
"RTN","VAFCHFS",56,0)
 U IO
"RTN","VAFCHFS",57,0)
 D USEHFS
"RTN","VAFCHFS",58,0)
 U IO
"RTN","VAFCHFS",59,0)
 Q
"RTN","VAFCHFS",60,0)
USEHFS ; -- use host file to build global array
"RTN","VAFCHFS",61,0)
 N IO,VAFCK,SECTION
"RTN","VAFCHFS",62,0)
 S SECTION=0
"RTN","VAFCHFS",63,0)
 S VAFCK=$$FTG^%ZISH(,VAFCHFS,$NA(^TMP($J,1)),2) I 'VAFCK Q
"RTN","VAFCHFS",64,0)
 N VAFCRR S VAFCRR(VAFCHFS)=""
"RTN","VAFCHFS",65,0)
 S VAFCK=$$DEL^%ZISH("",$NA(VAFCRR))
"RTN","VAFCHFS",66,0)
 Q
"RTN","VAFCHFS",67,0)
EDIT ;edit the HFS directory
"RTN","VAFCHFS",68,0)
 D EDITPAR^XPAREDIT("VAFC HFS SCRATCH")
"RTN","VAFCHFS",69,0)
 Q
"RTN","VAFCHFS",70,0)
DSPPDAT(VAFC) ;
"RTN","VAFCHFS",71,0)
 ; Output
"RTN","VAFCHFS",72,0)
 ;   VAFC - array passed back with the display formatted PDAT call
"RTN","VAFCHFS",73,0)
 N CNT,X,TXT
"RTN","VAFCHFS",74,0)
 S CNT=0,X=0 F  S X=$O(^TMP("VAFCHFS",$J,X)) Q:'X  S TXT=^TMP("VAFCHFS",$J,X) D  I $S<3000 S VAFC(CNT)="*** QUERY TERMINATED DUE TO VOLUME OF DATA FOR SELECTED DATE RANGE ***" Q  ;**477
"RTN","VAFCHFS",75,0)
 . I $E(TXT,1,20)="Treating Facilities:" S VAFC(CNT)="" S CNT=CNT+1
"RTN","VAFCHFS",76,0)
 . I $E(TXT,1,12)="Subscribers:" S VAFC(CNT)="" S CNT=CNT+1
"RTN","VAFCHFS",77,0)
 . I $E(TXT,1,12)="ICN History:" S VAFC(CNT)="" S CNT=CNT+1
"RTN","VAFCHFS",78,0)
 . I $E(TXT,1,13)="CMOR History:" S VAFC(CNT)="" S CNT=CNT+1
"RTN","VAFCHFS",79,0)
 . I $E(TXT,1,28)="CMOR Change Request History:" S VAFC(CNT)="" S CNT=CNT+1
"RTN","VAFCHFS",80,0)
 . I TXT'="" I $E(TXT,1,12)'="Enter RETURN" S VAFC(CNT)=^TMP("VAFCHFS",$J,X),CNT=CNT+1
"RTN","VAFCHFS",81,0)
 K ^TMP("VAFCHFS",$J)
"RTN","VAFCHFS",82,0)
 Q
"RTN","VAFCHFS",83,0)
CREATE ;create entry in File #8989.51 for remote HFS functionality
"RTN","VAFCHFS",84,0)
 N VAFC,VAFC1,ARRAY,Y,VAFCY
"RTN","VAFCHFS",85,0)
 S VAFC=$$FIND1^DIC(8989.51,"","X","VAFC HFS SCRATCH","B","","ERR")
"RTN","VAFCHFS",86,0)
 I VAFC>0 D
"RTN","VAFCHFS",87,0)
 . K DIC,DA,DO,X,DIE,DR S DIC=8989.51,DIC(0)="X",X="VAFC HFS SCRATCH" D ^DIC
"RTN","VAFCHFS",88,0)
 . S VAFCY=+Y L +^XTV(8989.51,VAFCY):5
"RTN","VAFCHFS",89,0)
 . S DIE=DIC,DA=+Y S DR=".02///Scratch HFS Directory;.03///0;.05///Directory name;1.1///F;1.2///1:250;1.3///Enter in an OS level directory with read/write/edit/delete privileges.;30///1",DR(2,8989.513)=".01///1;.02///4.2" D ^DIE  D
"RTN","VAFCHFS",90,0)
 .. L -^XTV(8989.51,VAFCY)
"RTN","VAFCHFS",91,0)
 .. K DIC,DA,DO,X,DIE,DR
"RTN","VAFCHFS",92,0)
 . S VAFC1=$$FIND1^DIC(8989.51,"","X","VAFC HFS SCRATCH","B","","ERR")
"RTN","VAFCHFS",93,0)
 . S ARRAY(1,1)="This fields should contain the directory specifications for the Kernel"
"RTN","VAFCHFS",94,0)
 . S ARRAY(1,2)="OPEN^%ZISH call.  The directory should be wide open with"
"RTN","VAFCHFS",95,0)
 . S ARRAY(1,3)="read/write/edit/delete privileges."
"RTN","VAFCHFS",96,0)
 . S ARRAY(1,4)="Example:"
"RTN","VAFCHFS",97,0)
 . S ARRAY(1,5)="A2$dir aij$:[000000]tcp$spool.dir /own/prot"
"RTN","VAFCHFS",98,0)
 . S ARRAY(1,6)="      Directory AIJ$:[000000]"
"RTN","VAFCHFS",99,0)
 . S ARRAY(1,7)="      TCP$SPOOL.DIR;1      [SYSTEM] (RWED,RWED,RWED,RWED)"
"RTN","VAFCHFS",100,0)
 . D WP^DIE(8989.51,VAFC1_",",20,"","ARRAY(1)")
"RTN","VAFCHFS",101,0)
 I VAFC<1 D
"RTN","VAFCHFS",102,0)
 . K FDA
"RTN","VAFCHFS",103,0)
 . S FDA(1,8989.51,"+1,",.01)="VAFC HFS SCRATCH"
"RTN","VAFCHFS",104,0)
 . S FDA(1,8989.51,"+1,",.02)="Scratch HFS Directory"
"RTN","VAFCHFS",105,0)
 . S FDA(1,8989.51,"+1,",.03)=0
"RTN","VAFCHFS",106,0)
 . S FDA(1,8989.51,"+1,",.05)="Directory name"
"RTN","VAFCHFS",107,0)
 . S FDA(1,8989.51,"+1,",1.1)="F"
"RTN","VAFCHFS",108,0)
 . S FDA(1,8989.51,"+1,",1.2)="1:250"
"RTN","VAFCHFS",109,0)
 . S FDA(1,8989.51,"+1,",1.3)="Enter in an OS level directory with read/write/edit/delete privileges."
"RTN","VAFCHFS",110,0)
 . S FDA(1,8989.513,"+2,+1,",.01)=1
"RTN","VAFCHFS",111,0)
 . S FDA(1,8989.513,"+2,+1,",.02)="4.2"
"RTN","VAFCHFS",112,0)
 . D UPDATE^DIE("","FDA(1)","FDAIEN") K FDA
"RTN","VAFCHFS",113,0)
 . S VAFC1=$$FIND1^DIC(8989.51,"","X","VAFC HFS SCRATCH","B","","ERR")
"RTN","VAFCHFS",114,0)
 . S ARRAY(1,1)="This fields should contain the directory specifications for the Kernel"
"RTN","VAFCHFS",115,0)
 . S ARRAY(1,2)="OPEN^%ZISH call.  The directory should be wide open with"
"RTN","VAFCHFS",116,0)
 . S ARRAY(1,3)="read/write/edit/delete privileges."
"RTN","VAFCHFS",117,0)
 . S ARRAY(1,4)="Example:"
"RTN","VAFCHFS",118,0)
 . S ARRAY(1,5)="A2$dir aij$:[000000]tcp$spool.dir /own/prot"
"RTN","VAFCHFS",119,0)
 . S ARRAY(1,6)="      Directory AIJ$:[000000]"
"RTN","VAFCHFS",120,0)
 . S ARRAY(1,7)="      TCP$SPOOL.DIR;1      [SYSTEM] (RWED,RWED,RWED,RWED)"
"RTN","VAFCHFS",121,0)
 . D WP^DIE(8989.51,VAFC1_",",20,"","ARRAY(1)")
"RTN","VAFCHFS",122,0)
 D EDIT
"RTN","VAFCHFS",123,0)
 Q
"RTN","VAFCLAU")
0^11^B5114636
"RTN","VAFCLAU",1,0)
VAFCLAU ;BHAM/DRI-LIST MANAGER ROUTINE FOR MPI/PD VAFC EXCPT LOCAL AUDIT IN PDR ;3/14/02
"RTN","VAFCLAU",2,0)
 ;;5.3;Registration;**477**;Aug 13, 1993
"RTN","VAFCLAU",3,0)
EN ;main entry point for VAFC EXCPT AUDIT LOCAL
"RTN","VAFCLAU",4,0)
 D EN^VALM("VAFC EXCPT LOCAL AUDIT")
"RTN","VAFCLAU",5,0)
 Q
"RTN","VAFCLAU",6,0)
HDR ; header code
"RTN","VAFCLAU",7,0)
 S VALMHDR(1)="MPI/PD PATIENT AUDIT DATA"
"RTN","VAFCLAU",8,0)
 S VALMHDR(2)=""
"RTN","VAFCLAU",9,0)
 Q
"RTN","VAFCLAU",10,0)
INIT ;
"RTN","VAFCLAU",11,0)
 K @VALMAR ;K ^TMP("VAFCLAU",$J)
"RTN","VAFCLAU",12,0)
 I '$D(DFN) G EXIT
"RTN","VAFCLAU",13,0)
 I '$D(^TMP("VAFCRAUD",$J)) G EXIT
"RTN","VAFCLAU",14,0)
 S LIN=1,X=0,STR="",TXT=""
"RTN","VAFCLAU",15,0)
 F  S X=$O(^TMP("VAFCRAUD",$J,X)) Q:'X  D
"RTN","VAFCLAU",16,0)
 . S TXT=^TMP("VAFCRAUD",$J,X)
"RTN","VAFCLAU",17,0)
 . I $E(TXT,1,12)'="Enter RETURN" D
"RTN","VAFCLAU",18,0)
 .. S STR=$$SETSTR^VALM1(TXT,STR,2,78)
"RTN","VAFCLAU",19,0)
 .. D ADDTMP
"RTN","VAFCLAU",20,0)
 S VALMCNT=LIN-1
"RTN","VAFCLAU",21,0)
 Q
"RTN","VAFCLAU",22,0)
ADDTMP ;
"RTN","VAFCLAU",23,0)
 S ^TMP("VAFCLAU",$J,LIN,0)=STR
"RTN","VAFCLAU",24,0)
 S ^TMP("VAFCLAU",$J,"IDX",LIN,LIN)=""
"RTN","VAFCLAU",25,0)
 S LIN=LIN+1,STR=""
"RTN","VAFCLAU",26,0)
 Q
"RTN","VAFCLAU",27,0)
RSEND ;Send remote AUDIT Query
"RTN","VAFCLAU",28,0)
 S VALMBCK=""
"RTN","VAFCLAU",29,0)
 D FULL^VALM1
"RTN","VAFCLAU",30,0)
 D SEND^VAFCRAUD(ICN,VAFCBDT,VAFCEDT)
"RTN","VAFCLAU",31,0)
 D PAUSE^VALM1
"RTN","VAFCLAU",32,0)
 D INIT
"RTN","VAFCLAU",33,0)
 S VALMBCK="R"
"RTN","VAFCLAU",34,0)
 Q
"RTN","VAFCLAU",35,0)
RCHK ;Check remote AUDIT Query
"RTN","VAFCLAU",36,0)
 S VALMBCK=""
"RTN","VAFCLAU",37,0)
 D FULL^VALM1
"RTN","VAFCLAU",38,0)
 D CHKSTAT^VAFCRAUD(ICN)
"RTN","VAFCLAU",39,0)
 D PAUSE^VALM1
"RTN","VAFCLAU",40,0)
 D INIT
"RTN","VAFCLAU",41,0)
 S VALMBCK="R"
"RTN","VAFCLAU",42,0)
 Q
"RTN","VAFCLAU",43,0)
RDISP ;Display remote AUDIT Query
"RTN","VAFCLAU",44,0)
 S VALMBCK=""
"RTN","VAFCLAU",45,0)
 D FULL^VALM1
"RTN","VAFCLAU",46,0)
 W !!,"Display data returned from remote patient audit queries."
"RTN","VAFCLAU",47,0)
 S TFL="",L="",Y="",STATUS=""
"RTN","VAFCLAU",48,0)
 I '$D(^XTMP("VAFCRAUD"_ICN)) W !!,"No remote query sent for this patient. " G QRD
"RTN","VAFCLAU",49,0)
 D GETTFL^VAFCRAUD(ICN,.TFL)
"RTN","VAFCLAU",50,0)
 W !!,"-> For Patient ",$P($G(^DPT(DFN,0)),"^",1),!
"RTN","VAFCLAU",51,0)
 I $D(TFL(0)) D
"RTN","VAFCLAU",52,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("VAFCRAUD"_ICN,X)) K TFL(X)
"RTN","VAFCLAU",53,0)
 D SELTF^VAFCRAUD
"RTN","VAFCLAU",54,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." G QRD
"RTN","VAFCLAU",55,0)
 I ((Y="")!(Y="^")) G QRD
"RTN","VAFCLAU",56,0)
 D PAUSE^VALM1
"RTN","VAFCLAU",57,0)
 D EN^VAFCRAU(ICN)
"RTN","VAFCLAU",58,0)
QRD D PAUSE^VALM1
"RTN","VAFCLAU",59,0)
 D INIT
"RTN","VAFCLAU",60,0)
 S VALMBCK="R"
"RTN","VAFCLAU",61,0)
 Q
"RTN","VAFCLAU",62,0)
HELP ;
"RTN","VAFCLAU",63,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","VAFCLAU",64,0)
 Q
"RTN","VAFCLAU",65,0)
EXIT ;
"RTN","VAFCLAU",66,0)
 S VALMBCK=""
"RTN","VAFCLAU",67,0)
 K ^TMP("VAFCLAU",$J),LIN,X,STR,TXT,Y,STATUS,TFL,TFARR,L
"RTN","VAFCLAU",68,0)
 S VALMBCK="R"
"RTN","VAFCLAU",69,0)
 Q
"RTN","VAFCMGA")
0^6^B56478936
"RTN","VAFCMGA",1,0)
VAFCMGA ;ALB/JRP,LTL-DEMOGRAPHIC MERGE SCREEN ACTIONS ;31-OCT-96
"RTN","VAFCMGA",2,0)
 ;;5.3;Registration;**149,477**;Aug 13, 1993
"RTN","VAFCMGA",3,0)
 ;
"RTN","VAFCMGA",4,0)
 ;NOTE: The VAFCMGA* routines contain line tags used to implement
"RTN","VAFCMGA",5,0)
 ;      the actions of a List Manager user interface.  All line
"RTN","VAFCMGA",6,0)
 ;      tags assume that the following variables and arrays are
"RTN","VAFCMGA",7,0)
 ;      defined.
"RTN","VAFCMGA",8,0)
 ;
"RTN","VAFCMGA",9,0)
 ;Input  : VAFCDFN - Pointer to entry in PATIENT file (#2) to merge
"RTN","VAFCMGA",10,0)
 ;                   data into
"RTN","VAFCMGA",11,0)
 ;         VAFCARR - Array contain data to merge (full global reference)
"RTN","VAFCMGA",12,0)
 ;                   VAFCARR() should be set as follows:
"RTN","VAFCMGA",13,0)
 ;                     VAFCARR(File,Field) = Value
"RTN","VAFCMGA",14,0)
 ;                       Where File = File number Value is from
"RTN","VAFCMGA",15,0)
 ;                             Field = Field number Value is from
"RTN","VAFCMGA",16,0)
 ;                             Value = Info to merge
"RTN","VAFCMGA",17,0)
 ;                       Notes: Dates must be in FileMan format
"RTN","VAFCMGA",18,0)
 ;                            : Special considerations for Value
"RTN","VAFCMGA",19,0)
 ;                                "@"  - Displays <DELETE> and deletes
"RTN","VAFCMGA",20,0)
 ;                                       local value if merged
"RTN","VAFCMGA",21,0)
 ;                                "^text"  - Displays text and ignores
"RTN","VAFCMGA",22,0)
 ;                                           field if merged
"RTN","VAFCMGA",23,0)
 ;                                NULL  - Displays <UNSPECIFIED> and
"RTN","VAFCMGA",24,0)
 ;                                        ignores field if merged
"RTN","VAFCMGA",25,0)
 ;                                Doesn't exist  - Displays <UNSPECIFIED>
"RTN","VAFCMGA",26,0)
 ;                                                 and ignores field
"RTN","VAFCMGA",27,0)
 ;                                                 if merged
"RTN","VAFCMGA",28,0)
 ;         VAFCFROM - Text denoting where merge data cam from (1-35)
"RTN","VAFCMGA",29,0)
 ;         VAFCEVDT - Date/time merge data was instantiated (FileMan)
"RTN","VAFCMGA",30,0)
 ;         All variables set by List Manager Interface
"RTN","VAFCMGA",31,0)
 ;         Display area and variables required List Manager interface
"RTN","VAFCMGA",32,0)
 ;         Display
"RTN","VAFCMGA",33,0)
 ;           VALMAR(Line,0) = Line of text in display
"RTN","VAFCMGA",34,0)
 ;         Indexes
"RTN","VAFCMGA",35,0)
 ;           VALMAR("IDX",Line,Entry) = ""
"RTN","VAFCMGA",36,0)
 ;           VALMAR("E2F",Entry,N) = File^Field
"RTN","VAFCMGA",37,0)
 ;             N => Allows for multiple fields per entry (starts with 1)
"RTN","VAFCMGA",38,0)
 ;           VALMAR("E2G",Entry) = Group entry is contained in
"RTN","VAFCMGA",39,0)
 ;           VALMAR("GRP",Group) = First line of group in display
"RTN","VAFCMGA",40,0)
 ;             Note: The E2F and E2G indexes are only set if the data
"RTN","VAFCMGA",41,0)
 ;                   to merge does not match the local data
"RTN","VAFCMGA",42,0)
 ;
"RTN","VAFCMGA",43,0)
MRGALL ;Merge all differences
"RTN","VAFCMGA",44,0)
 ;
"RTN","VAFCMGA",45,0)
 ;Input  : See above note on input variables
"RTN","VAFCMGA",46,0)
 ;Output : VALMAR() array will be rebuilt accordingly
"RTN","VAFCMGA",47,0)
 ;
"RTN","VAFCMGA",48,0)
 ;Declare variables
"RTN","VAFCMGA",49,0)
 N VAFCDOTS,ENTRY,REBUILD,FILE,FIELD,VALUE,REPEAT
"RTN","VAFCMGA",50,0)
 N TMP,IENS,FDAROOT,MSGROOT,QUOTE
"RTN","VAFCMGA",51,0)
 S FDAROOT="^TMP(""VAFC-MERGE-UPLOAD"","_$J_",""FDA"")"
"RTN","VAFCMGA",52,0)
 S MSGROOT="^TMP(""VAFC-MERGE-UPLOAD"","_$J_",""MSG"")"
"RTN","VAFCMGA",53,0)
 S QUOTE=$C(34)
"RTN","VAFCMGA",54,0)
 S IENS=VAFCDFN_","
"RTN","VAFCMGA",55,0)
 K @FDAROOT,@MSGROOT
"RTN","VAFCMGA",56,0)
 ;Build array of differences to merge
"RTN","VAFCMGA",57,0)
 N DGNOFDEL S DGNOFDEL=1 ;**477 stop NOK Name x-ref from firing.
"RTN","VAFCMGA",58,0)
 NEW EASZIPLK S EASZIPLK=1 ;**477 zipcode lookup for GMT
"RTN","VAFCMGA",59,0)
 S ENTRY=""
"RTN","VAFCMGA",60,0)
 F  S ENTRY=$O(@VALMAR@("E2F",ENTRY)) Q:(ENTRY="")  D
"RTN","VAFCMGA",61,0)
 .;Remember which group(s) to rebuild
"RTN","VAFCMGA",62,0)
 .S TMP=$G(@VALMAR@("E2G",ENTRY))
"RTN","VAFCMGA",63,0)
 .S:(TMP'="") REBUILD(TMP)=""
"RTN","VAFCMGA",64,0)
 .;Loop through list of fields contained in the entry
"RTN","VAFCMGA",65,0)
 .S REPEAT=""
"RTN","VAFCMGA",66,0)
 .F  S REPEAT=$O(@VALMAR@("E2F",ENTRY,REPEAT)) Q:(REPEAT="")  D
"RTN","VAFCMGA",67,0)
 ..S TMP=$G(@VALMAR@("E2F",ENTRY,REPEAT))
"RTN","VAFCMGA",68,0)
 ..S FILE=+$P(TMP,"^",1)
"RTN","VAFCMGA",69,0)
 ..S FIELD=+$P(TMP,"^",2)
"RTN","VAFCMGA",70,0)
 ..;Get remote value
"RTN","VAFCMGA",71,0)
 ..S VALUE=$G(@VAFCARR@(FILE,FIELD))
"RTN","VAFCMGA",72,0)
 ..;Screen for ignore conditions
"RTN","VAFCMGA",73,0)
 ..I $P(VALUE,U,3) S VALMSG=$S($G(VALMSG)]"":VALMSG_","_ENTRY,1:"Can't merge unresolved item(s) "_ENTRY) Q
"RTN","VAFCMGA",74,0)
 ..S VALUE=$P(VALUE,U)
"RTN","VAFCMGA",75,0)
 ..Q:(VALUE="")
"RTN","VAFCMGA",76,0)
 ..;Convert "@" to @
"RTN","VAFCMGA",77,0)
 ..S:(VALUE=(QUOTE_"@"_QUOTE)) VALUE="@"
"RTN","VAFCMGA",78,0)
 ..;Move data into upload array
"RTN","VAFCMGA",79,0)
 ..I $S(ENTRY=6:0,ENTRY=7:0,ENTRY=9:0,1:1) S @FDAROOT@(FILE,IENS,FIELD)=VALUE ;let zipcode populate city, state and county for merge all ;**477 for GMT
"RTN","VAFCMGA",80,0)
 ..;Prepare for undo
"RTN","VAFCMGA",81,0)
 ..S ^TMP("VAFC-UNDO",$J,"FDA",FILE,IENS,FIELD)=$$GET1^DIQ(FILE,IENS,FIELD)
"RTN","VAFCMGA",82,0)
 ;Merge differences
"RTN","VAFCMGA",83,0)
 I (+$O(@FDAROOT@(0))) D FILE^DIE("E",FDAROOT,MSGROOT)
"RTN","VAFCMGA",84,0)
 ;Rebuild required portion of display
"RTN","VAFCMGA",85,0)
 S VAFCDOTS=1
"RTN","VAFCMGA",86,0)
 S ENTRY=""
"RTN","VAFCMGA",87,0)
 F  S ENTRY=$O(REBUILD(ENTRY)) Q:(ENTRY="")  D RBLDGRP^VAFCMGB(ENTRY)
"RTN","VAFCMGA",88,0)
 ;No more differences
"RTN","VAFCMGA",89,0)
 S:('$D(@VALMAR@("E2F"))) VALMSG="** No differences found **"
"RTN","VAFCMGA",90,0)
 ;Done - refresh List Manager display
"RTN","VAFCMGA",91,0)
 S VALMBCK="R"
"RTN","VAFCMGA",92,0)
 Q
"RTN","VAFCMGA",93,0)
MRGSLCT ;Merge user selected differences
"RTN","VAFCMGA",94,0)
 ;
"RTN","VAFCMGA",95,0)
 ;Input  : See above note on input variables
"RTN","VAFCMGA",96,0)
 ;Output : Modified areas of VALMAR() array will be rebuilt accordingly
"RTN","VAFCMGA",97,0)
 ;
"RTN","VAFCMGA",98,0)
 ;Declare variables
"RTN","VAFCMGA",99,0)
 N VAFCDOTS,ENTRY,REBUILD,VALMY,FILE,FIELD,REPEAT
"RTN","VAFCMGA",100,0)
 N TMP,IENS,FDAROOT,MSGROOT,QUOTE,UNDO
"RTN","VAFCMGA",101,0)
 S QUOTE=$C(34)
"RTN","VAFCMGA",102,0)
 S FDAROOT="^TMP(""VAFC-MERGE-UPLOAD"","_$J_",""FDA"")"
"RTN","VAFCMGA",103,0)
 S MSGROOT="^TMP(""VAFC-MERGE-UPLOAD"","_$J_",""MSG"")"
"RTN","VAFCMGA",104,0)
 S IENS=VAFCDFN_","
"RTN","VAFCMGA",105,0)
 K @FDAROOT,@MSGROOT
"RTN","VAFCMGA",106,0)
 ;Prompt user for entries to merge
"RTN","VAFCMGA",107,0)
 D EN^VALM2($G(XQORNOD(0)),"O")
"RTN","VAFCMGA",108,0)
 ;Build array of data selected for merging
"RTN","VAFCMGA",109,0)
 N DGNOFDEL S DGNOFDEL=1 ;**477 stop NOK Name x-ref from firing.
"RTN","VAFCMGA",110,0)
 NEW EASZIPLK S EASZIPLK=1 ;**477 zipcode lookup for GMT
"RTN","VAFCMGA",111,0)
 I $D(VALMY(8)) F ENTRY=6,7,9 I '$D(VALMY(ENTRY)) S VALMY(ENTRY)="",UNDO(ENTRY)="" ;prepare to undo city, state and county if zip selected ;**477 for GMT
"RTN","VAFCMGA",112,0)
 S ENTRY=""
"RTN","VAFCMGA",113,0)
 F  S ENTRY=$O(VALMY(ENTRY)) Q:(ENTRY="")  D
"RTN","VAFCMGA",114,0)
 .;Remember which group(s) to rebuild
"RTN","VAFCMGA",115,0)
 .S TMP=$G(@VALMAR@("E2G",ENTRY))
"RTN","VAFCMGA",116,0)
 .S:(TMP'="") REBUILD(TMP)=""
"RTN","VAFCMGA",117,0)
 .;Loop through list of fields contained in the entry
"RTN","VAFCMGA",118,0)
 .S REPEAT=""
"RTN","VAFCMGA",119,0)
 .F  S REPEAT=$O(@VALMAR@("E2F",ENTRY,REPEAT)) Q:(REPEAT="")  D
"RTN","VAFCMGA",120,0)
 ..S TMP=$G(@VALMAR@("E2F",ENTRY,REPEAT))
"RTN","VAFCMGA",121,0)
 ..S FILE=+$P(TMP,"^",1)
"RTN","VAFCMGA",122,0)
 ..S FIELD=+$P(TMP,"^",2)
"RTN","VAFCMGA",123,0)
 ..;Get remote value
"RTN","VAFCMGA",124,0)
 ..S VALUE=$G(@VAFCARR@(FILE,FIELD))
"RTN","VAFCMGA",125,0)
 ..;Screen for ignore conditions
"RTN","VAFCMGA",126,0)
 ..I $P(VALUE,U,3) S VALMSG=$S($G(VALMSG)]"":VALMSG_","_ENTRY,1:"Can't merge unresolved item(s) "_ENTRY) Q
"RTN","VAFCMGA",127,0)
 ..S VALUE=$P(VALUE,U)
"RTN","VAFCMGA",128,0)
 ..Q:(VALUE="")
"RTN","VAFCMGA",129,0)
 ..;Convert "@" to @
"RTN","VAFCMGA",130,0)
 ..S:(VALUE=(QUOTE_"@"_QUOTE)) VALUE="@"
"RTN","VAFCMGA",131,0)
 ..;Move data into upload array
"RTN","VAFCMGA",132,0)
 ..I '$D(UNDO(ENTRY)) S @FDAROOT@(FILE,IENS,FIELD)=VALUE ;**477 for GMT
"RTN","VAFCMGA",133,0)
 ..;Prepare for undo
"RTN","VAFCMGA",134,0)
 ..S ^TMP("VAFC-UNDO",$J,"FDA",FILE,IENS,FIELD)=$$GET1^DIQ(FILE,IENS,FIELD)
"RTN","VAFCMGA",135,0)
 ;Merge selected data BUT don't transmit until merge completed or rejected
"RTN","VAFCMGA",136,0)
 I (+$O(@FDAROOT@(0))) S VAFCA08=1 D FILE^DIE("E",FDAROOT,MSGROOT) K VAFCA08
"RTN","VAFCMGA",137,0)
 ;Rebuild required portion of display
"RTN","VAFCMGA",138,0)
 S VAFCDOTS=1
"RTN","VAFCMGA",139,0)
 S ENTRY=""
"RTN","VAFCMGA",140,0)
 F  S ENTRY=$O(REBUILD(ENTRY)) Q:(ENTRY="")  D RBLDGRP^VAFCMGB(ENTRY)
"RTN","VAFCMGA",141,0)
 ;No more differences
"RTN","VAFCMGA",142,0)
 S:('$D(@VALMAR@("E2F"))) VALMSG="** No differences found **"
"RTN","VAFCMGA",143,0)
 ;Done - refresh List Manager display
"RTN","VAFCMGA",144,0)
 K @FDAROOT,@MSGROOT
"RTN","VAFCMGA",145,0)
 S VALMBCK="R"
"RTN","VAFCMGA",146,0)
 Q
"RTN","VAFCMGA",147,0)
 ;
"RTN","VAFCMGA",148,0)
COMPLETE ;Merge process completed ;**477 always prompt for merge, add verbage
"RTN","VAFCMGA",149,0)
 ;
"RTN","VAFCMGA",150,0)
 ;Input  : See above note on input variables
"RTN","VAFCMGA",151,0)
 ;Output : VAFCDONE will be set to '1'
"RTN","VAFCMGA",152,0)
 ;
"RTN","VAFCMGA",153,0)
 ;Declare variables
"RTN","VAFCMGA",154,0)
 N DIR,X,Y
"RTN","VAFCMGA",155,0)
 S VAFCDONE=1
"RTN","VAFCMGA",156,0)
 D FULL^VALM1 ;switch to full screen
"RTN","VAFCMGA",157,0)
 I ($D(@VALMAR@("E2F"))) D  ;check for differences
"RTN","VAFCMGA",158,0)
 .S DIR("A",7)="      ** Differences still exist between local and remote data **" ;check for differences
"RTN","VAFCMGA",159,0)
 .S DIR("A",8)=" "
"RTN","VAFCMGA",160,0)
 ;Make sure user is really done with merge process
"RTN","VAFCMGA",161,0)
 S DIR(0)="YA"
"RTN","VAFCMGA",162,0)
 S DIR("A",1)=" "
"RTN","VAFCMGA",163,0)
 S DIR("A",2)="NOTE: Since your site is the CMOR, you are considered to be the"
"RTN","VAFCMGA",164,0)
 S DIR("A",3)="      authoritative source.  By completing the merge, you confirm that"
"RTN","VAFCMGA",165,0)
 S DIR("A",4)="      your facility's NAME, SEX, DOB, SSN and MOTHER'S MAIDEN NAME are"
"RTN","VAFCMGA",166,0)
 S DIR("A",5)="      accurate for broadcast to all facilities sharing this patient."
"RTN","VAFCMGA",167,0)
 S DIR("A",6)=" "
"RTN","VAFCMGA",168,0)
 S DIR("A")="Are you ready to complete the merge process? (Yes/No) : "
"RTN","VAFCMGA",169,0)
 S DIR("B")="YES"
"RTN","VAFCMGA",170,0)
 D ^DIR
"RTN","VAFCMGA",171,0)
 S VAFCDONE=+Y
"RTN","VAFCMGA",172,0)
 ;User not done
"RTN","VAFCMGA",173,0)
 I ('VAFCDONE) S VALMBCK="R" Q
"RTN","VAFCMGA",174,0)
 ;  Create an entry in the ADT/HL7 PIVOT file (#391.71) and
"RTN","VAFCMGA",175,0)
 ;  mark it as requiring transmission of an HL7 ADT-A08 message
"RTN","VAFCMGA",176,0)
 D AVAFC^VAFCDD01(VAFCDFN)
"RTN","VAFCMGA",177,0)
 ;Done - quit List Manager interface
"RTN","VAFCMGA",178,0)
 S VALMBCK="Q"
"RTN","VAFCMGA",179,0)
 Q
"RTN","VAFCMGA",180,0)
 ;
"RTN","VAFCMGA",181,0)
REJECT ;Reject/ignore differences ;**477 add verbage
"RTN","VAFCMGA",182,0)
 ;
"RTN","VAFCMGA",183,0)
 ;Input  : See above note on input variables
"RTN","VAFCMGA",184,0)
 ;Output : VAFCRJCT will be set to '1'
"RTN","VAFCMGA",185,0)
 ;
"RTN","VAFCMGA",186,0)
 ;Declare variables
"RTN","VAFCMGA",187,0)
 N DIR,X,Y
"RTN","VAFCMGA",188,0)
 S VAFCRJCT=1
"RTN","VAFCMGA",189,0)
 ;Switch to full screen
"RTN","VAFCMGA",190,0)
 D FULL^VALM1
"RTN","VAFCMGA",191,0)
 ;Make sure user really wants to reject differences
"RTN","VAFCMGA",192,0)
 S DIR(0)="YA"
"RTN","VAFCMGA",193,0)
 S DIR("A",1)=" "
"RTN","VAFCMGA",194,0)
 S DIR("A",2)="NOTE: Since your site is the CMOR, you are considered to be the"
"RTN","VAFCMGA",195,0)
 S DIR("A",3)="      authoritative source.  By rejecting the remote data, you confirm"
"RTN","VAFCMGA",196,0)
 S DIR("A",4)="      that your facility's NAME, SEX, DOB, SSN and MOTHER'S MAIDEN NAME"
"RTN","VAFCMGA",197,0)
 S DIR("A",5)="      are accurate for broadcast to all facilities sharing this patient."
"RTN","VAFCMGA",198,0)
 S DIR("A",6)=" "
"RTN","VAFCMGA",199,0)
 S DIR("A")="Are you sure you want to reject the remote data? (Yes/No) : "
"RTN","VAFCMGA",200,0)
 S DIR("B")="YES"
"RTN","VAFCMGA",201,0)
 D ^DIR
"RTN","VAFCMGA",202,0)
 S VAFCRJCT=+Y
"RTN","VAFCMGA",203,0)
 ;Don't reject
"RTN","VAFCMGA",204,0)
 I ('VAFCRJCT) S VALMBCK="R" Q
"RTN","VAFCMGA",205,0)
 ;  Create an entry in the ADT/HL7 PIVOT file (#391.71) and
"RTN","VAFCMGA",206,0)
 ;  mark it as requiring transmission of an HL7 ADT-A08 message
"RTN","VAFCMGA",207,0)
 D AVAFC^VAFCDD01(VAFCDFN)
"RTN","VAFCMGA",208,0)
 ;Done - quit List Manager interface
"RTN","VAFCMGA",209,0)
 S VALMBCK="Q"
"RTN","VAFCMGA",210,0)
 Q
"RTN","VAFCMGA",211,0)
HI ;Hinq Inquiry
"RTN","VAFCMGA",212,0)
 S DFN=VAFCDFN
"RTN","VAFCMGA",213,0)
 D HINQ^DG10 S VALMBCK=""
"RTN","VAFCMGA",214,0)
 ;D EN^DVBHQZ4 S VALMBCK=""
"RTN","VAFCMGA",215,0)
 ;S VALMSG="Hinq request has "_$S($D(^DVB(395.5,DFN,0))&("PNEA"[$P($G(^DVB(395.5,DFN,0)),U,4)):"",1:"NOT ")_"been made for this patient."
"RTN","VAFCMGA",216,0)
HIQ Q
"RTN","VAFCMGA",217,0)
PA ;Patient Audit
"RTN","VAFCMGA",218,0)
 Q  ;**477 - no longer in use replaced by remote audit protcols
"RTN","VAFCMGA",219,0)
 I '$O(^DIA(2,"B",VAFCDFN,0)) S VALMSG="This patient has no audit data available.",VALMBCK="" G PAQ
"RTN","VAFCMGA",220,0)
 N IEN S DFN=VAFCDFN,QFLG=1 D FULL^VALM1 D:$T(ASK2^RGMTAUD)]"" ASK2^RGMTAUD S VALMBCK="R"
"RTN","VAFCMGA",221,0)
PAQ Q
"RTN","VAFCMGA1")
0^8^B19845162
"RTN","VAFCMGA1",1,0)
VAFCMGA1 ;BIR/LTL-DEMOGRAPHIC MERGE SCREEN ACTIONS cont. ;24 Sep 96
"RTN","VAFCMGA1",2,0)
 ;;5.3;Registration;**149,477**;Aug 13, 1993
"RTN","VAFCMGA1",3,0)
 ;
"RTN","VAFCMGA1",4,0)
 ;NOTE: The VAFCMGA* routines contain line tags used to implement
"RTN","VAFCMGA1",5,0)
 ;      the actions of a List Manager user interface.  All line
"RTN","VAFCMGA1",6,0)
 ;      tags assume that the following variables and arrays are
"RTN","VAFCMGA1",7,0)
 ;      defined.
"RTN","VAFCMGA1",8,0)
 ;
"RTN","VAFCMGA1",9,0)
 ;Input  : VAFCDFN - Pointer to entry in PATIENT file (#2) to merge
"RTN","VAFCMGA1",10,0)
 ;                   data into
"RTN","VAFCMGA1",11,0)
 ;         VAFCARR - Array contain data to merge (full global reference)
"RTN","VAFCMGA1",12,0)
 ;                   VAFCARR() should be set as follows:
"RTN","VAFCMGA1",13,0)
 ;                     VAFCARR(File,Field) = Value
"RTN","VAFCMGA1",14,0)
 ;                       Where File = File number Value is from
"RTN","VAFCMGA1",15,0)
 ;                             Field = Field number Value is from
"RTN","VAFCMGA1",16,0)
 ;                             Value = Info to merge
"RTN","VAFCMGA1",17,0)
 ;                       Notes: Dates must be in FileMan format
"RTN","VAFCMGA1",18,0)
 ;                            : Special considerations for Value
"RTN","VAFCMGA1",19,0)
 ;                             "@"  - Displays <Data Deleted> and deletes
"RTN","VAFCMGA1",20,0)
 ;                                       local value if merged
"RTN","VAFCMGA1",21,0)
 ;                                "^text"  - Displays text and ignores
"RTN","VAFCMGA1",22,0)
 ;                                           field if merged
"RTN","VAFCMGA1",23,0)
 ;                                NULL  - Displays <No Data Found> and
"RTN","VAFCMGA1",24,0)
 ;                                        ignores field if merged
"RTN","VAFCMGA1",25,0)
 ;                                Doesn't exist  - Displays <UR>
"RTN","VAFCMGA1",26,0)
 ;                                                 and ignores field
"RTN","VAFCMGA1",27,0)
 ;                                                 if merged
"RTN","VAFCMGA1",28,0)
 ;         VAFCFROM - Text denoting where merge data cam from (1-35)
"RTN","VAFCMGA1",29,0)
 ;         VAFCEVDT - Date/time merge data was instantiated (FileMan)
"RTN","VAFCMGA1",30,0)
 ;         All variables set by List Manager Interface
"RTN","VAFCMGA1",31,0)
 ;         Display area and variables required List Manager interface
"RTN","VAFCMGA1",32,0)
 ;         Display
"RTN","VAFCMGA1",33,0)
 ;           VALMAR(Line,0) = Line of text in display
"RTN","VAFCMGA1",34,0)
 ;         Indexes
"RTN","VAFCMGA1",35,0)
 ;           VALMAR("IDX",Line,Entry) = ""
"RTN","VAFCMGA1",36,0)
 ;           VALMAR("E2F",Entry,N) = File^Field
"RTN","VAFCMGA1",37,0)
 ;             N => Allows for multiple fields per entry (starts with 1)
"RTN","VAFCMGA1",38,0)
 ;           VALMAR("E2G",Entry) = Group entry is contained in
"RTN","VAFCMGA1",39,0)
 ;           VALMAR("GRP",Group) = First line of group in display
"RTN","VAFCMGA1",40,0)
 ;             Note: The E2F and E2G indexes are only set if the data
"RTN","VAFCMGA1",41,0)
 ;                   to merge does not match the local data
"RTN","VAFCMGA1",42,0)
 ;
"RTN","VAFCMGA1",43,0)
UNDO ;Undo selected merges
"RTN","VAFCMGA1",44,0)
 ;
"RTN","VAFCMGA1",45,0)
 ;Input  : See above note on input variables
"RTN","VAFCMGA1",46,0)
 ;Output : VALMAR() array will be rebuilt accordingly
"RTN","VAFCMGA1",47,0)
 ;
"RTN","VAFCMGA1",48,0)
 ;Declare variables
"RTN","VAFCMGA1",49,0)
 N VAFCDOTS
"RTN","VAFCMGA1",50,0)
 N ENTRY,IENS,FDAROOT,MSGROOT,QUOTE
"RTN","VAFCMGA1",51,0)
 S FDAROOT="^TMP(""VAFC-UNDO"","_$J_",""FDA"")"
"RTN","VAFCMGA1",52,0)
 S MSGROOT="^TMP(""VAFC-UNDO"","_$J_",""MSG"")"
"RTN","VAFCMGA1",53,0)
 S QUOTE=$C(34)
"RTN","VAFCMGA1",54,0)
 S IENS=VAFCDFN_","
"RTN","VAFCMGA1",55,0)
 I '$O(@FDAROOT@(0)) S VALMSG="You haven't merged anything yet?!" G UNDOQ
"RTN","VAFCMGA1",56,0)
 ;undo
"RTN","VAFCMGA1",57,0)
 S VALMSG="Merge undone."
"RTN","VAFCMGA1",58,0)
 N DGNOFDEL S DGNOFDEL=1 ;**477 stop NOK Name x-ref from firing.
"RTN","VAFCMGA1",59,0)
 ;NEW EASZIPLK S EASZIPLK=1 ;**477 zipcode lookup for GMT
"RTN","VAFCMGA1",60,0)
 D FILE^DIE("E",FDAROOT,MSGROOT)
"RTN","VAFCMGA1",61,0)
 ;Rebuild required portion of display
"RTN","VAFCMGA1",62,0)
 S VAFCDOTS=1
"RTN","VAFCMGA1",63,0)
 F ENTRY=1:1:4 D RBLDGRP^VAFCMGB(ENTRY)
"RTN","VAFCMGA1",64,0)
 ;No more differences
"RTN","VAFCMGA1",65,0)
 S:('$D(@VALMAR@("E2F"))) VALMSG="** No differences found **"
"RTN","VAFCMGA1",66,0)
 ;Done - refresh List Manager display
"RTN","VAFCMGA1",67,0)
UNDOQ K @FDAROOT,@MSGROOT S VALMBCK="R"
"RTN","VAFCMGA1",68,0)
 Q
"RTN","VAFCMGA1",69,0)
 ;
"RTN","VAFCMGA1",70,0)
PDAT ;remote pdat ;**477
"RTN","VAFCMGA1",71,0)
 NEW DFN,ICN,VAFCDEL,VAFCDIR,VAFCFILE
"RTN","VAFCMGA1",72,0)
 S DFN=VAFCDFN
"RTN","VAFCMGA1",73,0)
 S ICN=+$$GETICN^MPIF001(DFN)
"RTN","VAFCMGA1",74,0)
 S VALMBCK="" ;clear bottom portion of screen and prompt for action
"RTN","VAFCMGA1",75,0)
 S VAFCDIR=$$GET^XPAR("SYS","VAFC HFS SCRATCH") ;hfs directory
"RTN","VAFCMGA1",76,0)
 S VAFCFILE="VAFC"_DUZ_".DAT" ;file name for local pdat
"RTN","VAFCMGA1",77,0)
 S IOM=132,IOSL=99999,IOST="P-DUMMY",IOF=""""""
"RTN","VAFCMGA1",78,0)
 D OPEN^%ZISH("VAFC",VAFCDIR,VAFCFILE,"W") Q:POP  ;open up file
"RTN","VAFCMGA1",79,0)
 U IO
"RTN","VAFCMGA1",80,0)
 I ICN'="" D START^VAFCPDAT ;local pdat to file
"RTN","VAFCMGA1",81,0)
 D CLOSE^%ZISH("VAFC") ;close up file
"RTN","VAFCMGA1",82,0)
 K ^TMP("RGPDAT",$J) ;global array to hold pdat for listman
"RTN","VAFCMGA1",83,0)
 S X=$$FTG^%ZISH(VAFCDIR,VAFCFILE,$NAME(^TMP("RGPDAT",$J,1)),3) ;file to global
"RTN","VAFCMGA1",84,0)
 S VAFCDEL(VAFCFILE)="" ;list of file(s) to delete
"RTN","VAFCMGA1",85,0)
 S X=$$DEL^%ZISH(VAFCDIR,$NA(VAFCDEL)) ;delete file
"RTN","VAFCMGA1",86,0)
 I $D(^TMP("RGPDAT",$J)) D EN^RGEX04 ;list manager for remote pdat
"RTN","VAFCMGA1",87,0)
 S VALMBCK="R" ;refresh screen
"RTN","VAFCMGA1",88,0)
 Q
"RTN","VAFCMGA1",89,0)
 ;
"RTN","VAFCMGA1",90,0)
RAUD ;remote audit ;**477
"RTN","VAFCMGA1",91,0)
 NEW DFN,ICN,VAFCBDT,VAFCEDT,VAFCDEL,VAFCDIR,VAFCFILE
"RTN","VAFCMGA1",92,0)
 S DFN=VAFCDFN
"RTN","VAFCMGA1",93,0)
 S ICN=+$$GETICN^MPIF001(DFN)
"RTN","VAFCMGA1",94,0)
 S VALMBCK="" ;clear bottom portion of screen and prompt for action
"RTN","VAFCMGA1",95,0)
 D ASK2^VAFCAUD I '$G(VAFCBDT)!'$G(VAFCEDT) Q  ;date range of local and remote audits
"RTN","VAFCMGA1",96,0)
 S VAFCDIR=$$GET^XPAR("SYS","VAFC HFS SCRATCH") ;hfs directory
"RTN","VAFCMGA1",97,0)
 S VAFCFILE="VAFC"_DUZ_".DAT" ;file name for local audit
"RTN","VAFCMGA1",98,0)
 S IOM=132,IOSL=99999,IOST="P-DUMMY",IOF=""""""
"RTN","VAFCMGA1",99,0)
 D OPEN^%ZISH("VAFC",VAFCDIR,VAFCFILE,"W") Q:POP  ;open up file
"RTN","VAFCMGA1",100,0)
 U IO
"RTN","VAFCMGA1",101,0)
 I '$O(^DIA(2,"B",DFN,0)) W !,"This patient has no audit data available."
"RTN","VAFCMGA1",102,0)
 I $O(^DIA(2,"B",DFN,0)) S QFLG=1,RPCFLG=1 D START^VAFCAUD(DFN,VAFCBDT,VAFCEDT,RPCFLG) ;local audit to file
"RTN","VAFCMGA1",103,0)
 D CLOSE^%ZISH("VAFC") ;close up file
"RTN","VAFCMGA1",104,0)
 K ^TMP("VAFCRAUD",$J) ;global array to hold audit for listman
"RTN","VAFCMGA1",105,0)
 S X=$$FTG^%ZISH(VAFCDIR,VAFCFILE,$NAME(^TMP("VAFCRAUD",$J,1)),3) ;file to global
"RTN","VAFCMGA1",106,0)
 S VAFCDEL(VAFCFILE)="" ;list of file(s) to delete
"RTN","VAFCMGA1",107,0)
 S X=$$DEL^%ZISH(VAFCDIR,$NA(VAFCDEL)) ;delete file
"RTN","VAFCMGA1",108,0)
 I $D(^TMP("VAFCRAUD",$J)) D EN^VAFCLAU ;list manager for remote audit
"RTN","VAFCMGA1",109,0)
 S VALMBCK="R" ;refresh screen
"RTN","VAFCMGA1",110,0)
 Q
"RTN","VAFCMGB0")
0^7^B46238892
"RTN","VAFCMGB0",1,0)
VAFCMGB0 ;ALB/JRP-DEMOGRAPHIC MERGE SCREENS ;10/18/96
"RTN","VAFCMGB0",2,0)
 ;;5.3;Registration;**149,255,477**;Aug 13, 1993
"RTN","VAFCMGB0",3,0)
 ;
"RTN","VAFCMGB0",4,0)
 ;NOTE: This routine contains line tags used to build the display
"RTN","VAFCMGB0",5,0)
 ;      screen for a List Manager interface.  Refer to routine
"RTN","VAFCMGB0",6,0)
 ;      VAFCMGB for a description of input/output variables.
"RTN","VAFCMGB0",7,0)
 ;
"RTN","VAFCMGB0",8,0)
LOCAL(FILE,FIELD,IENS,ARRAY) ;Get local data from extraction array
"RTN","VAFCMGB0",9,0)
 ;
"RTN","VAFCMGB0",10,0)
 ;Input  : FILE - File number
"RTN","VAFCMGB0",11,0)
 ;         FIELD - Field number
"RTN","VAFCMGB0",12,0)
 ;         IENS - FDA entry number (ex: "DFN,")
"RTN","VAFCMGB0",13,0)
 ;         ARRAY - FDA array containing local data (full global ref)
"RTN","VAFCMGB0",14,0)
 ;                   (ie: ARRAY(File,IENS,Field) = Value)
"RTN","VAFCMGB0",15,0)
 ;         All variables denoted in VAFCMGB routine
"RTN","VAFCMGB0",16,0)
 ;Output : Value to display
"RTN","VAFCMGB0",17,0)
 ;Notes  : Existance/validity of input variables is assumed
"RTN","VAFCMGB0",18,0)
 ;       : ARRAY() is the ouput of the call to GETDATA^VAFCMGU0()
"RTN","VAFCMGB0",19,0)
 ;       :<No Data Found> is returned when ARRAY(File,IENS,Field) is NULL
"RTN","VAFCMGB0",20,0)
 ;         or does not exist
"RTN","VAFCMGB0",21,0)
 ;       : Phone numbers are returned in HL7 format
"RTN","VAFCMGB0",22,0)
 ;       : Social security numbers will contain dashes
"RTN","VAFCMGB0",23,0)
 ;       : Dates are returned in the format MM-DD-YYYY@HH:MM:SS
"RTN","VAFCMGB0",24,0)
 ;
"RTN","VAFCMGB0",25,0)
 ;Declare variables
"RTN","VAFCMGB0",26,0)
 N VALUE,QUOTE
"RTN","VAFCMGB0",27,0)
 S QUOTE=$C(34)
"RTN","VAFCMGB0",28,0)
 ;Get data
"RTN","VAFCMGB0",29,0)
 S VALUE=$G(@ARRAY@(FILE,IENS,FIELD))
"RTN","VAFCMGB0",30,0)
 ;Convert NULLS and quit
"RTN","VAFCMGB0",31,0)
 Q:(VALUE="") "<No Data Found>"
"RTN","VAFCMGB0",32,0)
 ;Convert phone numbers to HL7 format
"RTN","VAFCMGB0",33,0)
 I ((FIELD=.131)!(FIELD=.132)!(FIELD=.219)) I (FILE=2) D
"RTN","VAFCMGB0",34,0)
 .S VALUE=$$HLPHONE^HLFNC(VALUE)
"RTN","VAFCMGB0",35,0)
 ;Add dashes to SSN
"RTN","VAFCMGB0",36,0)
 I (FIELD=.09) I (FILE=2) D
"RTN","VAFCMGB0",37,0)
 .S VALUE=$TR(VALUE,"-","")
"RTN","VAFCMGB0",38,0)
 .S VALUE=$E(VALUE,1,3)_"-"_$E(VALUE,4,5)_"-"_$E(VALUE,6,10)
"RTN","VAFCMGB0",39,0)
 ;Convert dates to MM-DD-YYYY@HH:MM:SS format
"RTN","VAFCMGB0",40,0)
 I ((FIELD=.03)!(FIELD=.351)) I (FILE=2) D
"RTN","VAFCMGB0",41,0)
 .S VALUE=$$EX2INDT^VAFCMGU0(VALUE)
"RTN","VAFCMGB0",42,0)
 .S VALUE=$$IN2EXDT^VAFCMGU0(VALUE)
"RTN","VAFCMGB0",43,0)
 ;Done
"RTN","VAFCMGB0",44,0)
 Q VALUE
"RTN","VAFCMGB0",45,0)
 ;
"RTN","VAFCMGB0",46,0)
REMOTE(FILE,FIELD) ;Get remote data from merge array [VAFCARR()]
"RTN","VAFCMGB0",47,0)
 ;
"RTN","VAFCMGB0",48,0)
 ;Input  : FILE - File number
"RTN","VAFCMGB0",49,0)
 ;         FIELD - Field number
"RTN","VAFCMGB0",50,0)
 ;         All variables denoted in VAFCMGB routine
"RTN","VAFCMGB0",51,0)
 ;Output : Value to display
"RTN","VAFCMGB0",52,0)
 ;Notes  : Existance/validity of input variables is assumed
"RTN","VAFCMGB0",53,0)
 ;       :<No Data Found> is returned when VAFCARR(File,Field) is NULL or
"RTN","VAFCMGB0",54,0)
 ;         does not exist
"RTN","VAFCMGB0",55,0)
 ;       : <Data Deleted> is returned when VAFCARR(File,Field)="@"
"RTN","VAFCMGB0",56,0)
 ;       : When VAFCARR(Field,Field)="^text", text will be returned
"RTN","VAFCMGB0",57,0)
 ;       : Phone numbers are returned in HL7 format
"RTN","VAFCMGB0",58,0)
 ;       : Social security numbers will contain dashes
"RTN","VAFCMGB0",59,0)
 ;       : Dates are returned in the format MM-DD-YYYY@HH:MM:SS
"RTN","VAFCMGB0",60,0)
 ;
"RTN","VAFCMGB0",61,0)
 ;Declare variables
"RTN","VAFCMGB0",62,0)
 N VALUE,QUOTE
"RTN","VAFCMGB0",63,0)
 S QUOTE=$C(34)
"RTN","VAFCMGB0",64,0)
 ;Get data
"RTN","VAFCMGB0",65,0)
 S VALUE=$G(@VAFCARR@(FILE,FIELD))
"RTN","VAFCMGB0",66,0)
 ;Convert NULLS and quit
"RTN","VAFCMGB0",67,0)
 Q:($P(VALUE,U)="") "<No Data Found>"
"RTN","VAFCMGB0",68,0)
 ;Convert "@" and quit
"RTN","VAFCMGB0",69,0)
 Q:($P(VALUE,U)=(QUOTE_"@"_QUOTE)) "<Data Deleted>"
"RTN","VAFCMGB0",70,0)
 ;Convert unresolved and quit
"RTN","VAFCMGB0",71,0)
 Q:$P(VALUE,U,3) "<UR> "_$P(VALUE,U)
"RTN","VAFCMGB0",72,0)
 S VALUE=$P(VALUE,U)
"RTN","VAFCMGB0",73,0)
 ;Convert phone numbers to HL7 format
"RTN","VAFCMGB0",74,0)
 I ((FIELD=.131)!(FIELD=.132)!(FIELD=.219)) I (FILE=2) D
"RTN","VAFCMGB0",75,0)
 .S VALUE=$$HLPHONE^HLFNC(VALUE)
"RTN","VAFCMGB0",76,0)
 ;Add dashes to SSN
"RTN","VAFCMGB0",77,0)
 I (FIELD=.09) I (FILE=2) D
"RTN","VAFCMGB0",78,0)
 .S VALUE=$TR(VALUE,"-","")
"RTN","VAFCMGB0",79,0)
 .S VALUE=$E(VALUE,1,3)_"-"_$E(VALUE,4,5)_"-"_$E(VALUE,6,10)
"RTN","VAFCMGB0",80,0)
 ;Convert dates to MM-DD-YYYY@HH:MM:SS format
"RTN","VAFCMGB0",81,0)
 I ((FIELD=.03)!(FIELD=.351)) I (FILE=2) D
"RTN","VAFCMGB0",82,0)
 .S VALUE=$$IN2EXDT^VAFCMGU0(VALUE)
"RTN","VAFCMGB0",83,0)
 ;Convert ZIP to ZIP+4
"RTN","VAFCMGB0",84,0)
 I (FIELD=.1112) I (FILE=2) D  ;**255
"RTN","VAFCMGB0",85,0)
 .S VALUE=$TR(VALUE,"-") ;**477 old messaging didn't contain '-'
"RTN","VAFCMGB0",86,0)
 .S VALUE=$E(VALUE,1,5)_$S($E(VALUE,6,9)]"":"-"_$E(VALUE,6,9),1:"")
"RTN","VAFCMGB0",87,0)
 I (FIELD=.3612) I (FILE=2) D  ;**477
"RTN","VAFCMGB0",88,0)
 .I $L(VALUE)>7 S VALUE=$$HL7TFM^XLFDT(VALUE) ;convert hl7 to fileman date
"RTN","VAFCMGB0",89,0)
 ;Done
"RTN","VAFCMGB0",90,0)
 Q VALUE
"RTN","VAFCMGB0",91,0)
 ;
"RTN","VAFCMGB0",92,0)
DIFFCHK(FILE,FIELD,IENS,ARRAY) ;Compare local and remote data for differences
"RTN","VAFCMGB0",93,0)
 ;
"RTN","VAFCMGB0",94,0)
 ;Input  : FILE - File number
"RTN","VAFCMGB0",95,0)
 ;         FIELD - Field number
"RTN","VAFCMGB0",96,0)
 ;         IENS - FDA entry number (ex: "2169,")
"RTN","VAFCMGB0",97,0)
 ;         ARRAY - FDA array containing local data (full global ref)
"RTN","VAFCMGB0",98,0)
 ;                   (ie: ARRAY(File,IENS,Field) = Value)
"RTN","VAFCMGB0",99,0)
 ;         All variables denoted in VAFCMGB routine
"RTN","VAFCMGB0",100,0)
 ;Output : 1 = Local & remote data are different
"RTN","VAFCMGB0",101,0)
 ;         0 = Local & remote data are not different
"RTN","VAFCMGB0",102,0)
 ;Notes  : Existance/validity of input variables is assumed
"RTN","VAFCMGB0",103,0)
 ;       : ARRAY() is the ouput of the call to GETDATA^VAFCMGU0()
"RTN","VAFCMGB0",104,0)
 ;       : If VAFCARR(File,Field) is undefined, NULL, or has a value of
"RTN","VAFCMGB0",105,0)
 ;         "^text" a difference is not found (prevents overwritting of
"RTN","VAFCMGB0",106,0)
 ;         local data)
"RTN","VAFCMGB0",107,0)
 ;       : If VAFCARR(File,Field) is "@" and ARRAY(File,IENS,Field) is
"RTN","VAFCMGB0",108,0)
 ;         NULL or does not exist a difference is not found (prevents
"RTN","VAFCMGB0",109,0)
 ;         deletion of nothing)
"RTN","VAFCMGB0",110,0)
 ;       : Phone numbers are converted to HL7 format for comparison
"RTN","VAFCMGB0",111,0)
 ;       : Social security numbers are compared with dashes removed
"RTN","VAFCMGB0",112,0)
 ;       : Dates are converted to FileMan format for comparison
"RTN","VAFCMGB0",113,0)
 ;
"RTN","VAFCMGB0",114,0)
 ;Declare variables
"RTN","VAFCMGB0",115,0)
 N LOCAL,REMOTE,QUOTE
"RTN","VAFCMGB0",116,0)
 S QUOTE=$C(34)
"RTN","VAFCMGB0",117,0)
 ;Get local data
"RTN","VAFCMGB0",118,0)
 S LOCAL=$G(@ARRAY@(FILE,IENS,FIELD))
"RTN","VAFCMGB0",119,0)
 ;Get remote data
"RTN","VAFCMGB0",120,0)
 S REMOTE=$P($G(@VAFCARR@(FILE,FIELD)),U)
"RTN","VAFCMGB0",121,0)
 ;S:$E(REMOTE)=U&($P(REMOTE,U,2)]"") REMOTE=$P(REMOTE,U,2)
"RTN","VAFCMGB0",122,0)
 ;S:$P(REMOTE,U)=""&('$P(REMOTE,U,2)) REMOTE=""
"RTN","VAFCMGB0",123,0)
 ;S:$P(REMOTE,U)]"" REMOTE=$P(REMOTE,U)
"RTN","VAFCMGB0",124,0)
 ;Screen for remote value of NULL - return no diff
"RTN","VAFCMGB0",125,0)
 I (REMOTE="") Q 0
"RTN","VAFCMGB0",126,0)
 ;Screen for remote value of "^text" - return no diff
"RTN","VAFCMGB0",127,0)
 I (REMOTE=(QUOTE_"^")) Q 0
"RTN","VAFCMGB0",128,0)
 ;Screen for remote value of "@" and no local value - return no diff
"RTN","VAFCMGB0",129,0)
 I ((REMOTE=(QUOTE_"@"_QUOTE))&(LOCAL="")) Q 0
"RTN","VAFCMGB0",130,0)
 ;Convert phone numbers to HL7 format
"RTN","VAFCMGB0",131,0)
 I ((FIELD=.131)!(FIELD=.132)!(FIELD=.219)) I (FILE=2) D
"RTN","VAFCMGB0",132,0)
 .S LOCAL=$$HLPHONE^HLFNC(LOCAL)
"RTN","VAFCMGB0",133,0)
 .S REMOTE=$$HLPHONE^HLFNC(REMOTE)
"RTN","VAFCMGB0",134,0)
 ;Remove dashes from SSN
"RTN","VAFCMGB0",135,0)
 I (FIELD=.09) I (FILE=2) D
"RTN","VAFCMGB0",136,0)
 .S LOCAL=$TR(LOCAL,"-","")
"RTN","VAFCMGB0",137,0)
 .S REMOTE=$TR(REMOTE,"-","")
"RTN","VAFCMGB0",138,0)
 ;Convert dates to FileMan format (remote dates already in FM format)
"RTN","VAFCMGB0",139,0)
 I ((FIELD=.03)!(FIELD=.351)) I (FILE=2) D
"RTN","VAFCMGB0",140,0)
 .S LOCAL=$$EX2INDT^VAFCMGU0(LOCAL)
"RTN","VAFCMGB0",141,0)
 I (FIELD=.3612) I (FILE=2) D  ;*477
"RTN","VAFCMGB0",142,0)
 .S LOCAL=$$EX2INDT^VAFCMGU0(LOCAL)
"RTN","VAFCMGB0",143,0)
 .I $L(REMOTE)>7 S REMOTE=$$HL7TFM^XLFDT(REMOTE) ;convert hl7 to fileman date
"RTN","VAFCMGB0",144,0)
 ;Convert zip+4 to fileman format
"RTN","VAFCMGB0",145,0)
 I (FIELD=.1112) I (FILE=2) D  ;**255
"RTN","VAFCMGB0",146,0)
 .S LOCAL=$TR(LOCAL,"-","")
"RTN","VAFCMGB0",147,0)
 .S REMOTE=$TR(REMOTE,"-","")
"RTN","VAFCMGB0",148,0)
 ;Done - return comparison of local & remote data
"RTN","VAFCMGB0",149,0)
 Q ('(LOCAL=REMOTE))
"RTN","VAFCMGB0",150,0)
 ;
"RTN","VAFCMGB0",151,0)
GROUP1 ;Line tag to build logical group number one
"RTN","VAFCMGB0",152,0)
 ;
"RTN","VAFCMGB0",153,0)
 ;Group one contains the following fields:
"RTN","VAFCMGB0",154,0)
 ;  .01, .03, .09, .351
"RTN","VAFCMGB0",155,0)
 ;
"RTN","VAFCMGB0",156,0)
 ;Column width is limited to 30 characters
"RTN","VAFCMGB0",157,0)
 ;
"RTN","VAFCMGB0",158,0)
 ;Declare variables
"RTN","VAFCMGB0",159,0)
 N IENS,TARGET,MESSAGE,LINE,DATA,LOCAL,REMOTE,DIFF
"RTN","VAFCMGB0",160,0)
 S TARGET="^TMP(""VAFC-MERGE-TO"","_$J_",""DATA"")"
"RTN","VAFCMGB0",161,0)
 S MESSAGE="^TMP(""VAFC-MERGE-TO"","_$J_",""MESSAGE"")"
"RTN","VAFCMGB0",162,0)
 ;Initialize global locations
"RTN","VAFCMGB0",163,0)
 K @TARGET,@MESSAGE
"RTN","VAFCMGB0",164,0)
 ;Set group index
"RTN","VAFCMGB0",165,0)
 S @VALMAR@("GRP",1)=VALMCNT
"RTN","VAFCMGB0",166,0)
 ;Get local data for patient
"RTN","VAFCMGB0",167,0)
 D GETDATA^VAFCMGU0(VAFCDFN,1,TARGET,MESSAGE)
"RTN","VAFCMGB0",168,0)
 ;Build display
"RTN","VAFCMGB0",169,0)
 S IENS=VAFCDFN_","
"RTN","VAFCMGB0",170,0)
 ;Name
"RTN","VAFCMGB0",171,0)
 S LOCAL=$$LOCAL(2,.01,IENS,TARGET)
"RTN","VAFCMGB0",172,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB0",173,0)
 S REMOTE=$$REMOTE(2,.01)
"RTN","VAFCMGB0",174,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB0",175,0)
 S DIFF=$$DIFFCHK(2,.01,IENS,TARGET)
"RTN","VAFCMGB0",176,0)
 S LINE=$S(DIFF:"**",1:"  ")_" 1"
"RTN","VAFCMGB0",177,0)
 S:DIFF&($P($G(@VAFCARR@(2,.01)),U,2)) LINE="->"_" 1" ;**477 flag name if different - no longer auto updated
"RTN","VAFCMGB0",178,0)
 S DATA="Name: "_LOCAL
"RTN","VAFCMGB0",179,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,8)
"RTN","VAFCMGB0",180,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB0",181,0)
 S @VALMAR@("IDX",VALMCNT,1)=""
"RTN","VAFCMGB0",182,0)
 I (DIFF) D
"RTN","VAFCMGB0",183,0)
 .S @VALMAR@("E2F",1,1)="2^.01"
"RTN","VAFCMGB0",184,0)
 .S @VALMAR@("E2G",1)=1
"RTN","VAFCMGB0",185,0)
 I ('DIFF) D
"RTN","VAFCMGB0",186,0)
 .K @VALMAR@("E2F",1)
"RTN","VAFCMGB0",187,0)
 .K @VALMAR@("E2G",1)
"RTN","VAFCMGB0",188,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB0",189,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB0",190,0)
 ;SSN
"RTN","VAFCMGB0",191,0)
 S LOCAL=$$LOCAL(2,.09,IENS,TARGET)
"RTN","VAFCMGB0",192,0)
 S REMOTE=$$REMOTE(2,.09)
"RTN","VAFCMGB0",193,0)
 S DIFF=$$DIFFCHK(2,.09,IENS,TARGET)
"RTN","VAFCMGB0",194,0)
 S LINE=$S(DIFF:"**",1:"  ")_" 2"
"RTN","VAFCMGB0",195,0)
 S:DIFF&($P($G(@VAFCARR@(2,.09)),U,2)) LINE="->"_" 2"
"RTN","VAFCMGB0",196,0)
 S DATA="SSN: "_LOCAL
"RTN","VAFCMGB0",197,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,9)
"RTN","VAFCMGB0",198,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB0",199,0)
 S @VALMAR@("IDX",VALMCNT,2)=""
"RTN","VAFCMGB0",200,0)
 I (DIFF) D
"RTN","VAFCMGB0",201,0)
 .S @VALMAR@("E2F",2,1)="2^.09"
"RTN","VAFCMGB0",202,0)
 .S @VALMAR@("E2G",2)=1
"RTN","VAFCMGB0",203,0)
 I ('DIFF) D
"RTN","VAFCMGB0",204,0)
 .K @VALMAR@("E2F",2)
"RTN","VAFCMGB0",205,0)
 .K @VALMAR@("E2G",2)
"RTN","VAFCMGB0",206,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB0",207,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB0",208,0)
 ;Date of birth
"RTN","VAFCMGB0",209,0)
 S LOCAL=$$LOCAL(2,.03,IENS,TARGET)
"RTN","VAFCMGB0",210,0)
 S LOCAL=$P(LOCAL,"@",1)
"RTN","VAFCMGB0",211,0)
 S REMOTE=$$REMOTE(2,.03)
"RTN","VAFCMGB0",212,0)
 S REMOTE=$P(REMOTE,"@",1)
"RTN","VAFCMGB0",213,0)
 S DIFF=$$DIFFCHK(2,.03,IENS,TARGET)
"RTN","VAFCMGB0",214,0)
 S LINE=$S(DIFF:"**",1:"  ")_" 3"
"RTN","VAFCMGB0",215,0)
 S:DIFF&($P($G(@VAFCARR@(2,.03)),U,2)) LINE="->"_" 3"
"RTN","VAFCMGB0",216,0)
 S DATA="DOB: "_LOCAL
"RTN","VAFCMGB0",217,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,9)
"RTN","VAFCMGB0",218,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB0",219,0)
 S @VALMAR@("IDX",VALMCNT,3)=""
"RTN","VAFCMGB0",220,0)
 I (DIFF) D
"RTN","VAFCMGB0",221,0)
 .S @VALMAR@("E2F",3,1)="2^.03"
"RTN","VAFCMGB0",222,0)
 .S @VALMAR@("E2G",3)=1
"RTN","VAFCMGB0",223,0)
 I ('DIFF) D
"RTN","VAFCMGB0",224,0)
 .K @VALMAR@("E2F",3)
"RTN","VAFCMGB0",225,0)
 .K @VALMAR@("E2G",3)
"RTN","VAFCMGB0",226,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB0",227,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB0",228,0)
 ;Date of death - strip time
"RTN","VAFCMGB0",229,0)
 S LOCAL=$$LOCAL(2,.351,IENS,TARGET)
"RTN","VAFCMGB0",230,0)
 ;S LOCAL=$P(LOCAL,"@",1) ;**477 time has already been stripped
"RTN","VAFCMGB0",231,0)
 S REMOTE=$$REMOTE(2,.351)
"RTN","VAFCMGB0",232,0)
 ;S REMOTE=$P(REMOTE,"@",1) ;**477 time has already been stripped
"RTN","VAFCMGB0",233,0)
 S DIFF=$$DIFFCHK(2,.351,IENS,TARGET)
"RTN","VAFCMGB0",234,0)
 S LINE=$S(DIFF:"**",1:"  ")_" 4"
"RTN","VAFCMGB0",235,0)
 S:DIFF&($P($G(@VAFCARR@(2,.351)),U,2)) LINE="->"_" 4"
"RTN","VAFCMGB0",236,0)
 S DATA="DOD: "_LOCAL
"RTN","VAFCMGB0",237,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,9)
"RTN","VAFCMGB0",238,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB0",239,0)
 S @VALMAR@("IDX",VALMCNT,4)=""
"RTN","VAFCMGB0",240,0)
 I (DIFF) D
"RTN","VAFCMGB0",241,0)
 .S @VALMAR@("E2F",4,1)="2^.351"
"RTN","VAFCMGB0",242,0)
 .S @VALMAR@("E2G",4)=1
"RTN","VAFCMGB0",243,0)
 I ('DIFF) D
"RTN","VAFCMGB0",244,0)
 .K @VALMAR@("E2F",4)
"RTN","VAFCMGB0",245,0)
 .K @VALMAR@("E2G",4)
"RTN","VAFCMGB0",246,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB0",247,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB0",248,0)
 Q
"RTN","VAFCMGB1")
0^12^B42175654
"RTN","VAFCMGB1",1,0)
VAFCMGB1 ;ALB/JRP-DEMOGRAPHIC MERGE SCREENS ;10/18/96
"RTN","VAFCMGB1",2,0)
 ;;5.3;Registration;**149,295,384,477**;Aug 13, 1993
"RTN","VAFCMGB1",3,0)
 ;
"RTN","VAFCMGB1",4,0)
 ;NOTE: This routine contains line tags used to build the display
"RTN","VAFCMGB1",5,0)
 ;      screen for a List Manager interface.  Refer to routine
"RTN","VAFCMGB1",6,0)
 ;      VAFCMGB for a description of input/output variables.
"RTN","VAFCMGB1",7,0)
 ;
"RTN","VAFCMGB1",8,0)
GROUP2 ;Line tag to build logical group number two
"RTN","VAFCMGB1",9,0)
 ;
"RTN","VAFCMGB1",10,0)
 ;Group two contains the following fields:
"RTN","VAFCMGB1",11,0)
 ;  .111, .1112, .112, .113, .114, .115, .117, .131, .132
"RTN","VAFCMGB1",12,0)
 ;
"RTN","VAFCMGB1",13,0)
 ;Column width is limited to 30 characters
"RTN","VAFCMGB1",14,0)
 ;
"RTN","VAFCMGB1",15,0)
 ;Declare variables
"RTN","VAFCMGB1",16,0)
 N IENS,TARGET,MESSAGE,LINE,DATA,LOCAL,REMOTE,DIFF
"RTN","VAFCMGB1",17,0)
 S TARGET="^TMP(""VAFC-MERGE-TO"","_$J_",""DATA"")"
"RTN","VAFCMGB1",18,0)
 S MESSAGE="^TMP(""VAFC-MERGE-TO"","_$J_",""MESSAGE"")"
"RTN","VAFCMGB1",19,0)
 ;Initialize global locations
"RTN","VAFCMGB1",20,0)
 K @TARGET,@MESSAGE
"RTN","VAFCMGB1",21,0)
 ;Set group index
"RTN","VAFCMGB1",22,0)
 S @VALMAR@("GRP",2)=VALMCNT
"RTN","VAFCMGB1",23,0)
 ;Get local data for patient
"RTN","VAFCMGB1",24,0)
 D GETDATA^VAFCMGU0(VAFCDFN,2,TARGET,MESSAGE)
"RTN","VAFCMGB1",25,0)
 ;Build display
"RTN","VAFCMGB1",26,0)
 S IENS=VAFCDFN_","
"RTN","VAFCMGB1",27,0)
 ;Address lines 1 to 3
"RTN","VAFCMGB1",28,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.111,IENS,TARGET)
"RTN","VAFCMGB1",29,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",30,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.111)
"RTN","VAFCMGB1",31,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",32,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.111,IENS,TARGET)
"RTN","VAFCMGB1",33,0)
 S LINE=$$INSERT^VAFCMGU0(LOCAL,"",8)
"RTN","VAFCMGB1",34,0)
 S @VALMAR@(VALMCNT+1,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",35,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.112,IENS,TARGET)
"RTN","VAFCMGB1",36,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",37,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.112)
"RTN","VAFCMGB1",38,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",39,0)
 S:('DIFF) DIFF=$$DIFFCHK^VAFCMGB0(2,.112,IENS,TARGET)
"RTN","VAFCMGB1",40,0)
 S LINE=$$INSERT^VAFCMGU0(LOCAL,"",8)
"RTN","VAFCMGB1",41,0)
 S @VALMAR@(VALMCNT+2,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",42,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.113,IENS,TARGET)
"RTN","VAFCMGB1",43,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",44,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.113)
"RTN","VAFCMGB1",45,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",46,0)
 S:('DIFF) DIFF=$$DIFFCHK^VAFCMGB0(2,.113,IENS,TARGET)
"RTN","VAFCMGB1",47,0)
 S LINE=$$INSERT^VAFCMGU0(LOCAL,"",8)
"RTN","VAFCMGB1",48,0)
 S @VALMAR@(VALMCNT+3,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",49,0)
 S @VALMAR@(VALMCNT,0)=$S(DIFF:"**",1:"  ")_" 5 Address:"
"RTN","VAFCMGB1",50,0)
 I DIFF,($P($G(@VAFCARR@(2,.111)),U,2)!$P($G(@VAFCARR@(2,.112)),U,2)!$P($G(@VAFCARR@(2,.113)),U,2)) S @VALMAR@(VALMCNT,0)="-> 5 Address:" ;**295
"RTN","VAFCMGB1",51,0)
 S @VALMAR@("IDX",VALMCNT,5)=""
"RTN","VAFCMGB1",52,0)
 S @VALMAR@("IDX",VALMCNT+1,5)=""
"RTN","VAFCMGB1",53,0)
 S @VALMAR@("IDX",VALMCNT+2,5)=""
"RTN","VAFCMGB1",54,0)
 S @VALMAR@("IDX",VALMCNT+3,5)=""
"RTN","VAFCMGB1",55,0)
 I (DIFF) D
"RTN","VAFCMGB1",56,0)
 .S @VALMAR@("E2F",5,1)="2^.111"
"RTN","VAFCMGB1",57,0)
 .S @VALMAR@("E2F",5,2)="2^.112"
"RTN","VAFCMGB1",58,0)
 .S @VALMAR@("E2F",5,3)="2^.113"
"RTN","VAFCMGB1",59,0)
 .S @VALMAR@("E2G",5)=2
"RTN","VAFCMGB1",60,0)
 I ('DIFF) D
"RTN","VAFCMGB1",61,0)
 .K @VALMAR@("E2F",5)
"RTN","VAFCMGB1",62,0)
 .K @VALMAR@("E2G",5)
"RTN","VAFCMGB1",63,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",64,0)
 S VALMCNT=VALMCNT+4
"RTN","VAFCMGB1",65,0)
 ;City
"RTN","VAFCMGB1",66,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.114,IENS,TARGET)
"RTN","VAFCMGB1",67,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",68,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.114)
"RTN","VAFCMGB1",69,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",70,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.114,IENS,TARGET)
"RTN","VAFCMGB1",71,0)
 S LINE=$S(DIFF:"**",1:"  ")_" 6"
"RTN","VAFCMGB1",72,0)
 S:DIFF&($P($G(@VAFCARR@(2,.114)),U,2)) LINE="->"_" 6" ;**295
"RTN","VAFCMGB1",73,0)
 S DATA="City: "_LOCAL
"RTN","VAFCMGB1",74,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,8)
"RTN","VAFCMGB1",75,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",76,0)
 S @VALMAR@("IDX",VALMCNT,6)=""
"RTN","VAFCMGB1",77,0)
 I (DIFF) D
"RTN","VAFCMGB1",78,0)
 .S @VALMAR@("E2F",6,1)="2^.114"
"RTN","VAFCMGB1",79,0)
 .S @VALMAR@("E2G",6)=2
"RTN","VAFCMGB1",80,0)
 I ('DIFF) D
"RTN","VAFCMGB1",81,0)
 .K @VALMAR@("E2F",6)
"RTN","VAFCMGB1",82,0)
 .K @VALMAR@("E2G",6)
"RTN","VAFCMGB1",83,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",84,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB1",85,0)
 ;State
"RTN","VAFCMGB1",86,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.115,IENS,TARGET)
"RTN","VAFCMGB1",87,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",88,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.115)
"RTN","VAFCMGB1",89,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",90,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.115,IENS,TARGET)
"RTN","VAFCMGB1",91,0)
 I $D(^XUSEC("EAS GMT COUNTY EDIT",+DUZ)) D  ;**477 for GMT
"RTN","VAFCMGB1",92,0)
 . S LINE=$S(DIFF:"**",1:"  ")_" 7"
"RTN","VAFCMGB1",93,0)
 . S:DIFF&($P($G(@VAFCARR@(2,.115)),U,2)) LINE="->"_" 7"
"RTN","VAFCMGB1",94,0)
 I '$D(^XUSEC("EAS GMT COUNTY EDIT",+DUZ)) D  ;**477 for GMT
"RTN","VAFCMGB1",95,0)
 . S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB1",96,0)
 . S:DIFF&($P($G(@VAFCARR@(2,.115)),U,2)) LINE="->"
"RTN","VAFCMGB1",97,0)
 S DATA="State: "_LOCAL
"RTN","VAFCMGB1",98,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,7)
"RTN","VAFCMGB1",99,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",100,0)
 S @VALMAR@("IDX",VALMCNT,7)=""
"RTN","VAFCMGB1",101,0)
 I $D(^XUSEC("EAS GMT COUNTY EDIT",+DUZ)) D  ;**477 for GMT
"RTN","VAFCMGB1",102,0)
 . I (DIFF) D
"RTN","VAFCMGB1",103,0)
 . .S @VALMAR@("E2F",7,1)="2^.115"
"RTN","VAFCMGB1",104,0)
 . .S @VALMAR@("E2G",7)=2
"RTN","VAFCMGB1",105,0)
 . I ('DIFF) D
"RTN","VAFCMGB1",106,0)
 . .K @VALMAR@("E2F",7)
"RTN","VAFCMGB1",107,0)
 . .K @VALMAR@("E2G",7)
"RTN","VAFCMGB1",108,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",109,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB1",110,0)
 ;Zip+4
"RTN","VAFCMGB1",111,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.1112,IENS,TARGET)
"RTN","VAFCMGB1",112,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.1112)
"RTN","VAFCMGB1",113,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.1112,IENS,TARGET)
"RTN","VAFCMGB1",114,0)
 S LINE=$S(DIFF:"**",1:"  ")_" 8"
"RTN","VAFCMGB1",115,0)
 S:DIFF&($P($G(@VAFCARR@(2,.1112)),U,2)) LINE="->"_" 8" ;**295
"RTN","VAFCMGB1",116,0)
 S DATA="Zip+4: "_LOCAL
"RTN","VAFCMGB1",117,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,7)
"RTN","VAFCMGB1",118,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",119,0)
 S @VALMAR@("IDX",VALMCNT,8)=""
"RTN","VAFCMGB1",120,0)
 I (DIFF) D
"RTN","VAFCMGB1",121,0)
 .S @VALMAR@("E2F",8,1)="2^.1112"
"RTN","VAFCMGB1",122,0)
 .S @VALMAR@("E2G",8)=2
"RTN","VAFCMGB1",123,0)
 I ('DIFF) D
"RTN","VAFCMGB1",124,0)
 .K @VALMAR@("E2F",8)
"RTN","VAFCMGB1",125,0)
 .K @VALMAR@("E2G",8)
"RTN","VAFCMGB1",126,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",127,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB1",128,0)
 ;County
"RTN","VAFCMGB1",129,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.117,IENS,TARGET)
"RTN","VAFCMGB1",130,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",131,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.117)
"RTN","VAFCMGB1",132,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",133,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.117,IENS,TARGET)
"RTN","VAFCMGB1",134,0)
 I $D(^XUSEC("EAS GMT COUNTY EDIT",+DUZ)) D  ;**477 for GMT
"RTN","VAFCMGB1",135,0)
 . S LINE=$S(DIFF:"**",1:"  ")_" 9"
"RTN","VAFCMGB1",136,0)
 . S:DIFF&($P($G(@VAFCARR@(2,.117)),U,2)) LINE="->"_" 9"
"RTN","VAFCMGB1",137,0)
 I '$D(^XUSEC("EAS GMT COUNTY EDIT",+DUZ)) D  ;**477 for GMT
"RTN","VAFCMGB1",138,0)
 . S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB1",139,0)
 . S:DIFF&($P($G(@VAFCARR@(2,.117)),U,2)) LINE="->"
"RTN","VAFCMGB1",140,0)
 S DATA="County: "_LOCAL
"RTN","VAFCMGB1",141,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,6)
"RTN","VAFCMGB1",142,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",143,0)
 S @VALMAR@("IDX",VALMCNT,9)=""
"RTN","VAFCMGB1",144,0)
 I $D(^XUSEC("EAS GMT COUNTY EDIT",+DUZ)) D  ;**477 for GMT
"RTN","VAFCMGB1",145,0)
 . I (DIFF) D
"RTN","VAFCMGB1",146,0)
 . .S @VALMAR@("E2F",9,1)="2^.117"
"RTN","VAFCMGB1",147,0)
 . .S @VALMAR@("E2G",9)=2
"RTN","VAFCMGB1",148,0)
 . I ('DIFF) D
"RTN","VAFCMGB1",149,0)
 . .K @VALMAR@("E2F",9)
"RTN","VAFCMGB1",150,0)
 . .K @VALMAR@("E2G",9)
"RTN","VAFCMGB1",151,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",152,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB1",153,0)
 ;Home phone number
"RTN","VAFCMGB1",154,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.131,IENS,TARGET)
"RTN","VAFCMGB1",155,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",156,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.131)
"RTN","VAFCMGB1",157,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",158,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.131,IENS,TARGET)
"RTN","VAFCMGB1",159,0)
 S LINE=$S(DIFF:"**",1:"  ")_"10"
"RTN","VAFCMGB1",160,0)
 S:DIFF&($P($G(@VAFCARR@(2,.131)),U,2)) LINE="->"_"10" ;**384
"RTN","VAFCMGB1",161,0)
 S DATA="Home #: "_LOCAL
"RTN","VAFCMGB1",162,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,6)
"RTN","VAFCMGB1",163,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",164,0)
 S @VALMAR@("IDX",VALMCNT,10)=""
"RTN","VAFCMGB1",165,0)
 I (DIFF) D
"RTN","VAFCMGB1",166,0)
 .S @VALMAR@("E2F",10,1)="2^.131"
"RTN","VAFCMGB1",167,0)
 .S @VALMAR@("E2G",10)=2
"RTN","VAFCMGB1",168,0)
 I ('DIFF) D
"RTN","VAFCMGB1",169,0)
 .K @VALMAR@("E2F",10)
"RTN","VAFCMGB1",170,0)
 .K @VALMAR@("E2G",10)
"RTN","VAFCMGB1",171,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",172,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB1",173,0)
 ;Work phone number
"RTN","VAFCMGB1",174,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.132,IENS,TARGET)
"RTN","VAFCMGB1",175,0)
 S LOCAL=$E(LOCAL,1,30)
"RTN","VAFCMGB1",176,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.132)
"RTN","VAFCMGB1",177,0)
 S REMOTE=$E(REMOTE,1,30)
"RTN","VAFCMGB1",178,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.132,IENS,TARGET)
"RTN","VAFCMGB1",179,0)
 S LINE=$S(DIFF:"**",1:"  ")_"11"
"RTN","VAFCMGB1",180,0)
 S:DIFF&($P($G(@VAFCARR@(2,.132)),U,2)) LINE="->"_"11" ;**384
"RTN","VAFCMGB1",181,0)
 S DATA="Work #: "_LOCAL
"RTN","VAFCMGB1",182,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,6)
"RTN","VAFCMGB1",183,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,48)
"RTN","VAFCMGB1",184,0)
 S @VALMAR@("IDX",VALMCNT,11)=""
"RTN","VAFCMGB1",185,0)
 I (DIFF) D
"RTN","VAFCMGB1",186,0)
 .S @VALMAR@("E2F",11,1)="2^.132"
"RTN","VAFCMGB1",187,0)
 .S @VALMAR@("E2G",11)=2
"RTN","VAFCMGB1",188,0)
 I ('DIFF) D
"RTN","VAFCMGB1",189,0)
 .K @VALMAR@("E2F",11)
"RTN","VAFCMGB1",190,0)
 .K @VALMAR@("E2G",11)
"RTN","VAFCMGB1",191,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB1",192,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB1",193,0)
 ;Done - cleanup global locations used
"RTN","VAFCMGB1",194,0)
 K @TARGET,@MESSAGE
"RTN","VAFCMGB1",195,0)
 Q
"RTN","VAFCMGB3")
0^5^B32503031
"RTN","VAFCMGB3",1,0)
VAFCMGB3 ;ALB/JRP,LTL,PTD-DEMOGRAPHIC MERGE SCREENS ;07/10/98
"RTN","VAFCMGB3",2,0)
 ;;5.3;Registration;**149,477**;Aug 13, 1993
"RTN","VAFCMGB3",3,0)
 ;
"RTN","VAFCMGB3",4,0)
 ;NOTE: This routine contains line tags used to build the display
"RTN","VAFCMGB3",5,0)
 ;      screen for a List Manager interface.  Refer to routine
"RTN","VAFCMGB3",6,0)
 ;      VAFCMGB for a description of input/output variables.
"RTN","VAFCMGB3",7,0)
 ;
"RTN","VAFCMGB3",8,0)
GROUP4 ;Line tag to build logical group number four
"RTN","VAFCMGB3",9,0)
 ;
"RTN","VAFCMGB3",10,0)
 ;Group group contains the following fields
"RTN","VAFCMGB3",11,0)
 ;  .301, .302, .323, 391, 1901
"RTN","VAFCMGB3",12,0)
 ;
"RTN","VAFCMGB3",13,0)
 ;Column width is limited to 29 characters
"RTN","VAFCMGB3",14,0)
 ;
"RTN","VAFCMGB3",15,0)
 ;Declare variables
"RTN","VAFCMGB3",16,0)
 N IENS,TARGET,MESSAGE,LINE,DATA,LOCAL,REMOTE,DIFF
"RTN","VAFCMGB3",17,0)
 S TARGET="^TMP(""VAFC-MERGE-TO"","_$J_",""DATA"")"
"RTN","VAFCMGB3",18,0)
 S MESSAGE="^TMP(""VAFC-MERGE-TO"","_$J_",""MESSAGE"")"
"RTN","VAFCMGB3",19,0)
 ;Initialize global locations
"RTN","VAFCMGB3",20,0)
 K @TARGET,@MESSAGE
"RTN","VAFCMGB3",21,0)
 ;Set group index
"RTN","VAFCMGB3",22,0)
 S @VALMAR@("GRP",4)=VALMCNT
"RTN","VAFCMGB3",23,0)
 ;Get local data for patient
"RTN","VAFCMGB3",24,0)
 D GETDATA^VAFCMGU0(VAFCDFN,4,TARGET,MESSAGE)
"RTN","VAFCMGB3",25,0)
 ;Build display
"RTN","VAFCMGB3",26,0)
 S IENS=VAFCDFN_","
"RTN","VAFCMGB3",27,0)
 ;Patient Type
"RTN","VAFCMGB3",28,0)
 ;S LOCAL=$$LOCAL^VAFCMGB0(2,391,IENS,TARGET) ;**477
"RTN","VAFCMGB3",29,0)
 ;S LOCAL=$E(LOCAL,1,29)
"RTN","VAFCMGB3",30,0)
 ;S REMOTE=$$REMOTE^VAFCMGB0(2,391)
"RTN","VAFCMGB3",31,0)
 ;S REMOTE=$E(REMOTE,1,29)
"RTN","VAFCMGB3",32,0)
 ;S DIFF=$$DIFFCHK^VAFCMGB0(2,391,IENS,TARGET)
"RTN","VAFCMGB3",33,0)
 ;S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",34,0)
 ;S:DIFF&($P($G(@VAFCARR@(2,391)),U,2)) LINE="->"
"RTN","VAFCMGB3",35,0)
 ;S DATA="Type: "_LOCAL
"RTN","VAFCMGB3",36,0)
 ;S LINE=$$INSERT^VAFCMGU0(DATA,LINE,11)
"RTN","VAFCMGB3",37,0)
 ;S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",38,0)
 ;S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",39,0)
 ;I (DIFF) D
"RTN","VAFCMGB3",40,0)
 ;.S @VALMAR@("E2F",19,1)="2^391"
"RTN","VAFCMGB3",41,0)
 ;.S @VALMAR@("E2G",19)=4
"RTN","VAFCMGB3",42,0)
 ;I ('DIFF) D
"RTN","VAFCMGB3",43,0)
 ;.K @VALMAR@("E2F",19)
"RTN","VAFCMGB3",44,0)
 ;.K @VALMAR@("E2G",19)
"RTN","VAFCMGB3",45,0)
 ;W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB3",46,0)
 ;S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",47,0)
 ;Veteran
"RTN","VAFCMGB3",48,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,1901,IENS,TARGET)
"RTN","VAFCMGB3",49,0)
 S LOCAL=$E(LOCAL,1,29)
"RTN","VAFCMGB3",50,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,1901)
"RTN","VAFCMGB3",51,0)
 S REMOTE=$E(REMOTE,1,29)
"RTN","VAFCMGB3",52,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,1901,IENS,TARGET)
"RTN","VAFCMGB3",53,0)
 S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",54,0)
 S:DIFF&($P($G(@VAFCARR@(2,1901)),U,2)) LINE="->"
"RTN","VAFCMGB3",55,0)
 S DATA="Veteran: "_LOCAL
"RTN","VAFCMGB3",56,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,8)
"RTN","VAFCMGB3",57,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",58,0)
 S (@VALMAR@("IDX",VALMCNT,18),@VALMAR@("IDX",VALMCNT+1,18))=""
"RTN","VAFCMGB3",59,0)
 ;I (DIFF) D
"RTN","VAFCMGB3",60,0)
 ;.S @VALMAR@("E2F",20,1)="2^1901"
"RTN","VAFCMGB3",61,0)
 ;.S @VALMAR@("E2G",20)=4
"RTN","VAFCMGB3",62,0)
 ;I ('DIFF) D
"RTN","VAFCMGB3",63,0)
 ;.K @VALMAR@("E2F",20)
"RTN","VAFCMGB3",64,0)
 ;.K @VALMAR@("E2G",20)
"RTN","VAFCMGB3",65,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB3",66,0)
 S VALMCNT=VALMCNT+2
"RTN","VAFCMGB3",67,0)
 ;Service connected and percentage
"RTN","VAFCMGB3",68,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.301,IENS,TARGET)
"RTN","VAFCMGB3",69,0)
 S LOCAL("SC")=$E(LOCAL,1,29)
"RTN","VAFCMGB3",70,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.301)
"RTN","VAFCMGB3",71,0)
 S REMOTE("SC")=$E(REMOTE,1,29)
"RTN","VAFCMGB3",72,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.301,IENS,TARGET)
"RTN","VAFCMGB3",73,0)
 S LOCAL("SC%")=$$LOCAL^VAFCMGB0(2,.302,IENS,TARGET)
"RTN","VAFCMGB3",74,0)
 S REMOTE("SC%")=$$REMOTE^VAFCMGB0(2,.302)
"RTN","VAFCMGB3",75,0)
 S:('DIFF) DIFF=$$DIFFCHK^VAFCMGB0(2,.302,IENS,TARGET)
"RTN","VAFCMGB3",76,0)
 S:((LOCAL("SC%")="<No Data Found>")&(LOCAL("SC")="NO")) LOCAL("SC%")="N/A"
"RTN","VAFCMGB3",77,0)
 S:((REMOTE("SC%")="<No Data Found>")&(REMOTE("SC%")="NO")) REMOTE("SC%")="N/A"
"RTN","VAFCMGB3",78,0)
 S REMOTE("SC")=REMOTE("SC")_"  "_REMOTE("SC%")
"RTN","VAFCMGB3",79,0)
 S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",80,0)
 S:DIFF&($P($G(@VAFCARR@(2,.301)),U,2)) LINE="->"
"RTN","VAFCMGB3",81,0)
 S DATA="SC: "_LOCAL("SC")_"  SC%: "_LOCAL("SC%")
"RTN","VAFCMGB3",82,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,13)
"RTN","VAFCMGB3",83,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE("SC"),LINE,50)
"RTN","VAFCMGB3",84,0)
 ;S DATA="SC %: "_LOCAL("SC%")
"RTN","VAFCMGB3",85,0)
 ;S LINE=$$INSERT^VAFCMGU0(DATA,"",11)
"RTN","VAFCMGB3",86,0)
 ;S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE("SC%"),LINE,54)
"RTN","VAFCMGB3",87,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",88,0)
 ;S @VALMAR@("IDX",VALMCNT+1,21)=""
"RTN","VAFCMGB3",89,0)
 ;S @VALMAR@("IDX",VALMCNT+2,21)=""
"RTN","VAFCMGB3",90,0)
 ;I (DIFF) D
"RTN","VAFCMGB3",91,0)
 ;.S @VALMAR@("E2F",21,1)="2^.301"
"RTN","VAFCMGB3",92,0)
 ;.S @VALMAR@("E2F",21,2)="2^.302"
"RTN","VAFCMGB3",93,0)
 ;.S @VALMAR@("E2G",21)=4
"RTN","VAFCMGB3",94,0)
 ;I ('DIFF) D
"RTN","VAFCMGB3",95,0)
 ;.K @VALMAR@("E2F",21)
"RTN","VAFCMGB3",96,0)
 ;.K @VALMAR@("E2G",21)
"RTN","VAFCMGB3",97,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB3",98,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",99,0)
 ;Period of service
"RTN","VAFCMGB3",100,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.323,IENS,TARGET)
"RTN","VAFCMGB3",101,0)
 S LOCAL=$E(LOCAL,1,29)
"RTN","VAFCMGB3",102,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.323)
"RTN","VAFCMGB3",103,0)
 S REMOTE=$E(REMOTE,1,29)
"RTN","VAFCMGB3",104,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.323,IENS,TARGET)
"RTN","VAFCMGB3",105,0)
 S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",106,0)
 S:DIFF&($P($G(@VAFCARR@(2,.323)),U,2)) LINE="->"
"RTN","VAFCMGB3",107,0)
 S DATA="POS: "_LOCAL
"RTN","VAFCMGB3",108,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,12)
"RTN","VAFCMGB3",109,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",110,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",111,0)
 ;I (DIFF) D
"RTN","VAFCMGB3",112,0)
 ;.S @VALMAR@("E2F",22,1)="2^.323"
"RTN","VAFCMGB3",113,0)
 ;.S @VALMAR@("E2G",22)=4
"RTN","VAFCMGB3",114,0)
 ;I ('DIFF) D
"RTN","VAFCMGB3",115,0)
 ;.K @VALMAR@("E2F",22)
"RTN","VAFCMGB3",116,0)
 ;.K @VALMAR@("E2G",22)
"RTN","VAFCMGB3",117,0)
 W:(+$G(VAFCDOTS)) "."
"RTN","VAFCMGB3",118,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",119,0)
 ;Primary Eligibility Code
"RTN","VAFCMGB3",120,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.361,IENS,TARGET)
"RTN","VAFCMGB3",121,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.361)
"RTN","VAFCMGB3",122,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.361,IENS,TARGET)
"RTN","VAFCMGB3",123,0)
 S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",124,0)
 S:DIFF&($P($G(@VAFCARR@(2,.361)),U,2)) LINE="->"
"RTN","VAFCMGB3",125,0)
 S DATA="Prim Elig Code: "_LOCAL
"RTN","VAFCMGB3",126,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,3)
"RTN","VAFCMGB3",127,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",128,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",129,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",130,0)
 ;Date of eligibility status
"RTN","VAFCMGB3",131,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.3612,IENS,TARGET)
"RTN","VAFCMGB3",132,0)
 S REMOTE=$$FMTE^XLFDT($$REMOTE^VAFCMGB0(2,.3612),1)
"RTN","VAFCMGB3",133,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.3612,IENS,TARGET)
"RTN","VAFCMGB3",134,0)
 S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",135,0)
 S:DIFF&($P($G(@VAFCARR@(2,.3612)),U,2)) LINE="->"
"RTN","VAFCMGB3",136,0)
 S DATA="Date Verified: "_LOCAL
"RTN","VAFCMGB3",137,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,3)
"RTN","VAFCMGB3",138,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",139,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",140,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",141,0)
 ;Verification method
"RTN","VAFCMGB3",142,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.3615,IENS,TARGET)
"RTN","VAFCMGB3",143,0)
 S REMOTE=$$REMOTE^VAFCMGB0(2,.3615)
"RTN","VAFCMGB3",144,0)
 S DIFF=$$DIFFCHK^VAFCMGB0(2,.3615,IENS,TARGET)
"RTN","VAFCMGB3",145,0)
 S LINE=$S(DIFF:"**",1:"  ")
"RTN","VAFCMGB3",146,0)
 S:DIFF&($P($G(@VAFCARR@(2,.3615)),U,2)) LINE="->"
"RTN","VAFCMGB3",147,0)
 S DATA="Verification method: "
"RTN","VAFCMGB3",148,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,3)
"RTN","VAFCMGB3",149,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0("",LINE,50)
"RTN","VAFCMGB3",150,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",151,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",152,0)
 S LINE="",LINE=$$INSERT^VAFCMGU0(LOCAL,LINE,3)
"RTN","VAFCMGB3",153,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",154,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",155,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",156,0)
 ;Who verified locally (no remote data sent)
"RTN","VAFCMGB3",157,0)
 S LOCAL=$$LOCAL^VAFCMGB0(2,.3616,IENS,TARGET)
"RTN","VAFCMGB3",158,0)
 S REMOTE="<Not Available>"
"RTN","VAFCMGB3",159,0)
 S LINE="  "
"RTN","VAFCMGB3",160,0)
 S DATA="Who verified: "_LOCAL
"RTN","VAFCMGB3",161,0)
 S LINE=$$INSERT^VAFCMGU0(DATA,LINE,3)
"RTN","VAFCMGB3",162,0)
 S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",163,0)
 S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",164,0)
 S VALMCNT=VALMCNT+1
"RTN","VAFCMGB3",165,0)
 ;If PATIENT ELIGIBILITIES multiple contains EMPLOYEE, display local data (no remote data sent).
"RTN","VAFCMGB3",166,0)
 S LOCAL=$O(^DIC(8,"B","EMPLOYEE",0)) I LOCAL D
"RTN","VAFCMGB3",167,0)
 .Q:'$D(^DPT(VAFCDFN,"E",LOCAL,0))
"RTN","VAFCMGB3",168,0)
 .;Else patient is an employee
"RTN","VAFCMGB3",169,0)
 .S REMOTE="<Not Available>",LINE="  ",DATA="Other Eligibility: EMPLOYEE"
"RTN","VAFCMGB3",170,0)
 .S LINE=$$INSERT^VAFCMGU0(DATA,LINE,3)
"RTN","VAFCMGB3",171,0)
 .S @VALMAR@(VALMCNT,0)=$$INSERT^VAFCMGU0(REMOTE,LINE,50)
"RTN","VAFCMGB3",172,0)
 .S @VALMAR@("IDX",VALMCNT,18)=""
"RTN","VAFCMGB3",173,0)
 ;Done - cleanup global locations used
"RTN","VAFCMGB3",174,0)
 K @TARGET,@MESSAGE
"RTN","VAFCMGB3",175,0)
 Q
"RTN","VAFCMSG3")
0^20^B30137539
"RTN","VAFCMSG3",1,0)
VAFCMSG3 ;ALB/JRP,PKE-Message Builder Utilities ; 4/26/03 12:05pm
"RTN","VAFCMSG3",2,0)
 ;;5.3;Registration;**91,209,149,261,307,494,484,477**;Aug 13, 1993
"RTN","VAFCMSG3",3,0)
 ;
"RTN","VAFCMSG3",4,0)
 ;-- Line tags for building HL7 segments
"RTN","VAFCMSG3",5,0)
 ;
"RTN","VAFCMSG3",6,0)
 ; Standardized variable names:
"RTN","VAFCMSG3",7,0)
 ;   All HL7 variables created by calling INIT^HLFNC2() must exist
"RTN","VAFCMSG3",8,0)
 ;   DFN - Pointer to entry in PATIENT file (#2)
"RTN","VAFCMSG3",9,0)
 ;   EVNTHL7 - HL7 ADT event being transmitted
"RTN","VAFCMSG3",10,0)
 ;   EVNTDATE - Date/time event occurred (FileMan format)
"RTN","VAFCMSG3",11,0)
 ;   EVNTINFO() - Array containing extra info needed to build segments
"RTN","VAFCMSG3",12,0)
 ;                (full global reference)
"RTN","VAFCMSG3",13,0)
 ;   VAFSTR - String of fields to put into segment separated by commas
"RTN","VAFCMSG3",14,0)
 ;
"RTN","VAFCMSG3",15,0)
BLDEVN S VAFEVN=$$EN^VAFHLEVN(EVNTHL7,EVNTDATE,VAFSTR,HL("Q"),HL("FS"))
"RTN","VAFCMSG3",16,0)
 ;Manually add event type code (seq #1)
"RTN","VAFCMSG3",17,0)
 S $P(VAFEVN,HL("FS"),2)=EVNTHL7
"RTN","VAFCMSG3",18,0)
 ;Manually add event reason code (seq #4)
"RTN","VAFCMSG3",19,0)
 S $P(VAFEVN,HL("FS"),5)=$G(@EVNTINFO@("REASON",1))
"RTN","VAFCMSG3",20,0)
 ;If applicable, manually add operator (seq #5)
"RTN","VAFCMSG3",21,0)
 S:($D(@EVNTINFO@("USER"))) $P(VAFEVN,HL("FS"),6)=@EVNTINFO@("USER")
"RTN","VAFCMSG3",22,0)
 Q
"RTN","VAFCMSG3",23,0)
BLDPID ;
"RTN","VAFCMSG3",24,0)
 S VAFPID=$$EN^VAFCPID(DFN,VAFSTR)
"RTN","VAFCMSG3",25,0)
 ;CHECK IF PATIENT HAS AN ICN IF NOT A28
"RTN","VAFCMSG3",26,0)
 I $P(VAFPID,HL("FS"),3)=HLQ&(EVNTHL7'="A28") D
"RTN","VAFCMSG3",27,0)
 . I $T(GETICN^MPIF001)']"" Q
"RTN","VAFCMSG3",28,0)
 . ; returns National ICN -- don't create local ICN
"RTN","VAFCMSG3",29,0)
 . N ICN S ICN=$$GETICN^MPIF001(DFN)
"RTN","VAFCMSG3",30,0)
 . I +ICN>0 S $P(VAFPID,HL("FS"),3)=ICN
"RTN","VAFCMSG3",31,0)
 Q
"RTN","VAFCMSG3",32,0)
 ;
"RTN","VAFCMSG3",33,0)
BLDPD1 ;
"RTN","VAFCMSG3",34,0)
 I EVNTHL7="A28" D
"RTN","VAFCMSG3",35,0)
 . N CHANGE,CMOR
"RTN","VAFCMSG3",36,0)
 . N X S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCMSG3",37,0)
 . I +$$GETVCCI^MPIF001(DFN)'>0 D
"RTN","VAFCMSG3",38,0)
 . . ;S CMOR=$P($$SITE^VASITE(),"^")
"RTN","VAFCMSG3",39,0)
 . . ;S CHANGE=$$CHANGE^MPIF001(DFN,CMOR)
"RTN","VAFCMSG3",40,0)
 . . ;I +CHANGE<0 D START^RGHLLOG(),EXC^RGHLLOG(211,"Trouble updating CMOR while building A28 msg in VAFCMSG3 for DFN = "_DFN),STOP^RGHLLOG()
"RTN","VAFCMSG3",41,0)
 S VAFPD1=$$EN^VAFHLPD1(DFN)
"RTN","VAFCMSG3",42,0)
 ;
"RTN","VAFCMSG3",43,0)
BLDPV1 I EVNTHL7="A28" S VAFPV1="PV1"_HL("FS")_1
"RTN","VAFCMSG3",44,0)
 E  S VAFPV1=$$EN^VAFCPV1(DFN) Q
"RTN","VAFCMSG3",45,0)
 ;
"RTN","VAFCMSG3",46,0)
BLDROL ;
"RTN","VAFCMSG3",47,0)
 I $G(@EVNTINFO@("SERVER PROTOCOL"))'="VAFC ADT-A08-SDAM SERVER"
"RTN","VAFCMSG3",48,0)
 IF  I $G(^DPT(DFN,.1))]"" DO
"RTN","VAFCMSG3",49,0)
 . D BLDROL^VAFCROL("VAFROL",DFN,EVNTDATE,VAFSTR,$G(@EVNTINFO@("PIVOT")))
"RTN","VAFCMSG3",50,0)
 Q
"RTN","VAFCMSG3",51,0)
 ;
"RTN","VAFCMSG3",52,0)
BLDOBX ;
"RTN","VAFCMSG3",53,0)
 N VAFARRY S SECINFO=$$EN^VAFHLZSN(DFN) I $P(SECINFO,"^",2)'="",$P(SECINFO,"^",2)'?.2"""" D  ;**477
"RTN","VAFCMSG3",54,0)
 . S VAFARRY(2)="CE"
"RTN","VAFCMSG3",55,0)
 . S $P(VAFARRY(3),$E(HL("ECH"),1),2)="SECURITY LEVEL"
"RTN","VAFCMSG3",56,0)
 . S VAFARRY(5)=$P(SECINFO,"^",2)
"RTN","VAFCMSG3",57,0)
 . S VAFARRY(11)="F"
"RTN","VAFCMSG3",58,0)
 . S VAFARRY(14)=$$FMDATE^HLFNC($P(SECINFO,"^",4))
"RTN","VAFCMSG3",59,0)
 . S VAFARRY(16)=$P(SECINFO,"^",3)
"RTN","VAFCMSG3",60,0)
 ;
"RTN","VAFCMSG3",61,0)
 S VAFOBX=$$EN^VAFHLOBX(.VAFARRY) K SECINFO
"RTN","VAFCMSG3",62,0)
 Q
"RTN","VAFCMSG3",63,0)
 ;
"RTN","VAFCMSG3",64,0)
BLDZPD S VAFZPD=$$EN^VAFHLZPD(DFN,VAFSTR) Q
"RTN","VAFCMSG3",65,0)
 ;
"RTN","VAFCMSG3",66,0)
BLDZSP S VAFZSP=$$EN^VAFHLZSP(DFN) Q
"RTN","VAFCMSG3",67,0)
 ;
"RTN","VAFCMSG3",68,0)
BLDZEL S VAFZEL=$$EN^VAFHLZEL(DFN,VAFSTR,1) Q
"RTN","VAFCMSG3",69,0)
 ;
"RTN","VAFCMSG3",70,0)
BLDZCT S VAFZCT=$$EN^VAFHLZCT(DFN,VAFSTR) Q
"RTN","VAFCMSG3",71,0)
 ;
"RTN","VAFCMSG3",72,0)
BLDZEM S VAFZEM=$$EN^VAFHLZEM(DFN,VAFSTR) Q
"RTN","VAFCMSG3",73,0)
 ;
"RTN","VAFCMSG3",74,0)
BLDZFF S VAFZFF="ZFF"_HL("FS")_2_HL("FS")
"RTN","VAFCMSG3",75,0)
 S VAFZFF=VAFZFF_$P($G(^VAT(391.71,+$G(@EVNTINFO@("PIVOT")),2)),U)
"RTN","VAFCMSG3",76,0)
 Q
"RTN","VAFCMSG3",77,0)
 ;
"RTN","VAFCMSG3",78,0)
BLDZIR K DGREL,DGINC,DGINR,DGDEP
"RTN","VAFCMSG3",79,0)
 D ALL^DGMTU21(DFN,"V",EVNTDATE,"R")
"RTN","VAFCMSG3",80,0)
 S VAFZIR=$$EN^VAFHLZIR(+$G(DGINR("V")),VAFSTR,1)
"RTN","VAFCMSG3",81,0)
 K DGREL,DGINC,DGINR,DGDEP
"RTN","VAFCMSG3",82,0)
 Q
"RTN","VAFCMSG3",83,0)
 ;
"RTN","VAFCMSG3",84,0)
BLDZEN S VAFZEN=$$EN^VAFHLZEN(DFN,VAFSTR,1,HL("Q"),HL("FS")) Q
"RTN","VAFCMSG3",85,0)
 ;
"RTN","VAFCMSG3",86,0)
 ;
"RTN","VAFCMSG3",87,0)
 ;-- Line tags for copying HL7 segments into HL7 message
"RTN","VAFCMSG3",88,0)
 ;
"RTN","VAFCMSG3",89,0)
 ; Standardized variable names:
"RTN","VAFCMSG3",90,0)
 ;   Variables set by BLDxxx tags
"RTN","VAFCMSG3",91,0)
 ;   XMITARRY - Array to build HL7 message into (full global reference)
"RTN","VAFCMSG3",92,0)
 ;   LASTLINE - Last line number used in HL7 message
"RTN","VAFCMSG3",93,0)
 ;            - This value will be incremented appropriately
"RTN","VAFCMSG3",94,0)
 ;   LINESADD - Total number of lines added to HL7 message
"RTN","VAFCMSG3",95,0)
 ;            - This value will be incremented appropriately
"RTN","VAFCMSG3",96,0)
 ;
"RTN","VAFCMSG3",97,0)
CPYEVN N I
"RTN","VAFCMSG3",98,0)
 S LASTLINE=1+$G(LASTLINE)
"RTN","VAFCMSG3",99,0)
 S @XMITARRY@(LASTLINE)=VAFEVN
"RTN","VAFCMSG3",100,0)
 S LINESADD=1+$G(LINESADD)
"RTN","VAFCMSG3",101,0)
 S I=""
"RTN","VAFCMSG3",102,0)
 F  S I=+$O(VAFEVN(I)) Q:('I)  D
"RTN","VAFCMSG3",103,0)
 .S @XMITARRY@(LASTLINE,I)=VAFEVN(I)
"RTN","VAFCMSG3",104,0)
 .S LINESADD=LINESADD+1
"RTN","VAFCMSG3",105,0)
 Q
"RTN","VAFCMSG3",106,0)
 ;                                 rev $o is # lines from array 
"RTN","VAFCMSG3",107,0)
CPYPID S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFPID(""),-1)
"RTN","VAFCMSG3",108,0)
 MERGE @XMITARRY@(LASTLINE)=VAFPID Q
"RTN","VAFCMSG3",109,0)
 ;
"RTN","VAFCMSG3",110,0)
CPYPD1 S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFPD1(""),-1)
"RTN","VAFCMSG3",111,0)
 MERGE @XMITARRY@(LASTLINE)=VAFPD1 Q
"RTN","VAFCMSG3",112,0)
 ;
"RTN","VAFCMSG3",113,0)
CPYPV1 S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFPV1(""),-1)
"RTN","VAFCMSG3",114,0)
 MERGE @XMITARRY@(LASTLINE)=VAFPV1 Q
"RTN","VAFCMSG3",115,0)
 ;
"RTN","VAFCMSG3",116,0)
CPYROL N I,J,K
"RTN","VAFCMSG3",117,0)
 S I=""
"RTN","VAFCMSG3",118,0)
 F K=1:1 S I=+$O(VAFROL(I)) Q:('I)  D
"RTN","VAFCMSG3",119,0)
 . S J=""
"RTN","VAFCMSG3",120,0)
 . F  S J=$O(VAFROL(I,J)) Q:(J="")  D
"RTN","VAFCMSG3",121,0)
 . . S:('J) @XMITARRY@(LASTLINE+K)=VAFROL(I,J)
"RTN","VAFCMSG3",122,0)
 . . S:(J) @XMITARRY@(LASTLINE+K,J)=VAFROL(I,J)
"RTN","VAFCMSG3",123,0)
 . . S LINESADD=1+$G(LINESADD)
"RTN","VAFCMSG3",124,0)
 S LASTLINE=LASTLINE+K-1
"RTN","VAFCMSG3",125,0)
 Q
"RTN","VAFCMSG3",126,0)
 ;
"RTN","VAFCMSG3",127,0)
CPYOBX S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFOBX(""),-1)
"RTN","VAFCMSG3",128,0)
 MERGE @XMITARRY@(LASTLINE)=VAFOBX Q
"RTN","VAFCMSG3",129,0)
 ;
"RTN","VAFCMSG3",130,0)
CPYZPD S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZPD(""),-1)
"RTN","VAFCMSG3",131,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZPD Q
"RTN","VAFCMSG3",132,0)
 ;
"RTN","VAFCMSG3",133,0)
CPYZSP S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZSP(""),-1)
"RTN","VAFCMSG3",134,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZSP Q
"RTN","VAFCMSG3",135,0)
 ;
"RTN","VAFCMSG3",136,0)
CPYZEL S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZEL(""),-1)
"RTN","VAFCMSG3",137,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZEL Q
"RTN","VAFCMSG3",138,0)
 ;
"RTN","VAFCMSG3",139,0)
CPYZCT S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZCT(""),-1)
"RTN","VAFCMSG3",140,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZCT Q
"RTN","VAFCMSG3",141,0)
 ;
"RTN","VAFCMSG3",142,0)
CPYZEM S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZEM(""),-1)
"RTN","VAFCMSG3",143,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZEM Q
"RTN","VAFCMSG3",144,0)
 ;
"RTN","VAFCMSG3",145,0)
CPYZFF S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZFF(""),-1)
"RTN","VAFCMSG3",146,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZFF Q
"RTN","VAFCMSG3",147,0)
 ;
"RTN","VAFCMSG3",148,0)
CPYZIR S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZIR(""),-1)
"RTN","VAFCMSG3",149,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZIR Q
"RTN","VAFCMSG3",150,0)
 ;
"RTN","VAFCMSG3",151,0)
CPYZEN S LASTLINE=1+$G(LASTLINE),LINESADD=1+$G(LINESADD)+$O(VAFZEN(""),-1)
"RTN","VAFCMSG3",152,0)
 MERGE @XMITARRY@(LASTLINE)=VAFZEN Q
"RTN","VAFCMSG3",153,0)
 ;
"RTN","VAFCMSG3",154,0)
 ;
"RTN","VAFCMSG3",155,0)
 ;-- Line tags for deleting variables used to build HL7 segments
"RTN","VAFCMSG3",156,0)
 ;
"RTN","VAFCMSG3",157,0)
DELEVN K VAFEVN Q
"RTN","VAFCMSG3",158,0)
 ;
"RTN","VAFCMSG3",159,0)
DELPID K VAFPID Q
"RTN","VAFCMSG3",160,0)
 ;
"RTN","VAFCMSG3",161,0)
DELPD1 K VAFPD1 Q
"RTN","VAFCMSG3",162,0)
 ;
"RTN","VAFCMSG3",163,0)
DELPV1 K VAFPV1 Q
"RTN","VAFCMSG3",164,0)
 ;
"RTN","VAFCMSG3",165,0)
DELROL K VAFROL Q
"RTN","VAFCMSG3",166,0)
 ;
"RTN","VAFCMSG3",167,0)
DELOBX K VAFOBX Q
"RTN","VAFCMSG3",168,0)
 ;
"RTN","VAFCMSG3",169,0)
DELZPD K VAFZPD Q
"RTN","VAFCMSG3",170,0)
 ;
"RTN","VAFCMSG3",171,0)
DELZSP K VAFZSP Q 
"RTN","VAFCMSG3",172,0)
 ;
"RTN","VAFCMSG3",173,0)
DELZEL K VAFZEL Q
"RTN","VAFCMSG3",174,0)
 ;
"RTN","VAFCMSG3",175,0)
DELZCT K VAFZCT Q
"RTN","VAFCMSG3",176,0)
 ;
"RTN","VAFCMSG3",177,0)
DELZEM K VAFZEM Q
"RTN","VAFCMSG3",178,0)
 ;
"RTN","VAFCMSG3",179,0)
DELZFF K VAFZFF Q
"RTN","VAFCMSG3",180,0)
 ;
"RTN","VAFCMSG3",181,0)
DELZIR K VAFZIR Q
"RTN","VAFCMSG3",182,0)
 ;
"RTN","VAFCMSG3",183,0)
DELZEN K VAFZEN Q
"RTN","VAFCMSG3",184,0)
 ;
"RTN","VAFCQRY1")
0^10^B46708922
"RTN","VAFCQRY1",1,0)
VAFCQRY1 ;BIR/DLR-Query for patient demographics ;10/30/02  13:58
"RTN","VAFCQRY1",2,0)
 ;;5.3;Registration;**428,474,477**;Aug 13, 1993
"RTN","VAFCQRY1",3,0)
 ;
"RTN","VAFCQRY1",4,0)
 ;Reference to $$GETDFNS^MPIF002 supported by IA #3634.
"RTN","VAFCQRY1",5,0)
 ;
"RTN","VAFCQRY1",6,0)
BLDPID(DFN,CNT,SEQ,PID,HL,ERR)  ;build PID from File #2
"RTN","VAFCQRY1",7,0)
 N VAFCMN,VAFCMMN,SITE,VAFCZN,SSN,SITE,APID,PDOD,HIST,HISTDT,VAFCHMN,LVL,LVL1,NXT,LNGTH,NXTC,COMP,REP,SUBCOMP,LVL2,X,STATE,CITY,CLAIM,HLECH,HLFS,HLQ,X,STATEIEN
"RTN","VAFCQRY1",8,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),HLQ=HL("Q")
"RTN","VAFCQRY1",9,0)
 S COMP=$E(HL("ECH"),1)
"RTN","VAFCQRY1",10,0)
 S SUBCOMP=$E(HL("ECH"),4)
"RTN","VAFCQRY1",11,0)
 S REP=$E(HL("ECH"),2)
"RTN","VAFCQRY1",12,0)
 ;get Patient File MPI node
"RTN","VAFCQRY1",13,0)
 S VAFCMN=$$MPINODE^MPIFAPI(DFN)
"RTN","VAFCQRY1",14,0)
 I +VAFCMN<0 S VAFCMN=""
"RTN","VAFCQRY1",15,0)
 S VAFCZN=^DPT(DFN,0)
"RTN","VAFCQRY1",16,0)
 S SSN=$P(^DPT(DFN,0),"^",9)
"RTN","VAFCQRY1",17,0)
 S SITE=$$SITE^VASITE
"RTN","VAFCQRY1",18,0)
 S APID(2)=CNT
"RTN","VAFCQRY1",19,0)
 ;repeat patient ID list including ICN (NI),SSN (SS),CLAIM# (PN) AND DFN (PI)
"RTN","VAFCQRY1",20,0)
 S APID(4)=""
"RTN","VAFCQRY1",21,0)
 ;National Identifier (ICN)
"RTN","VAFCQRY1",22,0)
 I VAFCMN'="" I +VAFCMN>0 S APID(4)=$P(VAFCMN,"^")_"V"_$P(VAFCMN,"^",2)_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L" D
"RTN","VAFCQRY1",23,0)
 . ;Assumption that if this is a local ICN at this point send the message with an expiration date of today, so that it will be treated as a deprecated ID and stored on the MPI as such
"RTN","VAFCQRY1",24,0)
 . I $E($P(VAFCMN,"^"),1,3)=$P($$SITE^VASITE,"^",3) S APID(4)=APID(4)_COMP_COMP_$$HLDATE^HLFNC(DT)
"RTN","VAFCQRY1",25,0)
 I $G(SSN)'="" S APID(4)=APID(4)_$S(APID(4)'="":REP,1:"")_SSN_COMP_COMP_COMP_"USSSA"_SUBCOMP_SUBCOMP_"0363"_COMP_"SS"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"
"RTN","VAFCQRY1",26,0)
 I $G(DFN)'="" S APID(4)=APID(4)_$S(APID(4)'="":REP,1:"")_DFN_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L" D
"RTN","VAFCQRY1",27,0)
 .;CLAIM#
"RTN","VAFCQRY1",28,0)
 .I $D(^DPT(DFN,.31)) S CLAIM=$P(^DPT(DFN,.31),"^",3) I +CLAIM>0 S APID(4)=APID(4)_REP_CLAIM_COMP_COMP_COMP_"USVBA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PN"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"
"RTN","VAFCQRY1",29,0)
 I $D(^DPT(DFN,"MPIFHIS")) N HIST S NXTC=0,LVL=0,HIST=0  F  S HIST=$O(^DPT(DFN,"MPIFHIS",HIST)) Q:'HIST  S VAFCHMN=^DPT(DFN,"MPIFHIS",HIST,0) S HISTDT=$P(VAFCHMN,"^",4) D
"RTN","VAFCQRY1",30,0)
 . ;**477 due to a timing issue if checksum and D/T of deprication of ICN is not present hang two seconds and try again if still not able to get ICN set D/T to DT
"RTN","VAFCQRY1",31,0)
 . I $G(HISTDT)="" H 2 S VAFCHMN=^DPT(DFN,"MPIFHIS",HIST,0) S HISTDT=$P(VAFCHMN,"^",4) I HISTDT="" S HISTDT=DT
"RTN","VAFCQRY1",32,0)
 . I APID(4)'="" D
"RTN","VAFCQRY1",33,0)
 .. S NXT=$P(VAFCHMN,"^")_"V"_$P(VAFCHMN,"^",2)_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"_COMP_COMP_$$HLDATE^HLFNC(HISTDT)
"RTN","VAFCQRY1",34,0)
 .. I LVL=0 D
"RTN","VAFCQRY1",35,0)
 ... I $L(APID(4)_NXT)'>244 S APID(4)=APID(4)_REP_NXT Q
"RTN","VAFCQRY1",36,0)
 ... I $L(APID(4)_NXT)>244 S LVL=1 S LNGTH=244-$L(APID(4)),APID(4)=APID(4)_REP_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),NXTC=1
"RTN","VAFCQRY1",37,0)
 .. I LVL>0 D
"RTN","VAFCQRY1",38,0)
 ... I $L($G(APID(4,LVL))_NXT)'>245 S APID(4,LVL)=$G(APID(4,LVL))_$S(NXTC=0:REP,1:"")_NXT Q
"RTN","VAFCQRY1",39,0)
 ... I $L($G(APID(4,LVL))_NXT)>245 S LNGTH=244-$L(APID(4,LVL)),APID(4,LVL)=APID(4,LVL)_REP_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)) S LVL=LVL+1 S APID(4,LVL)=NXT
"RTN","VAFCQRY1",40,0)
 . I NXTC=1 S NXTC=0
"RTN","VAFCQRY1",41,0)
 . I APID(4)="" S APID(4)=$P(VAFCHMN,"^")_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"_COMP_COMP_$$HLDATE^HLFNC(HISTDT)
"RTN","VAFCQRY1",42,0)
 ;patient name (last^first^middle^suffix^prefix^^"L" for legal)
"RTN","VAFCQRY1",43,0)
 S APID(6)=$$HLNAME^XLFNAME($P(VAFCZN,"^"),"",$E(HL("ECH"),1)) I $P(APID(6),$E(HL("ECH"),1),7)'="L" S $P(APID(6),$E(HL("ECH"),1),7)="L"
"RTN","VAFCQRY1",44,0)
 ;mother's maiden name  (last^first^middle^suffix^prefix^^"M" for maiden name)
"RTN","VAFCQRY1",45,0)
 S APID(7)=HL("Q")
"RTN","VAFCQRY1",46,0)
 I $D(^DPT(DFN,.24)) S VAFCMMN=$P(^DPT(DFN,.24),"^",3) D
"RTN","VAFCQRY1",47,0)
 . S APID(7)=$$HLNAME^XLFNAME(VAFCMMN,"",$E(HL("ECH"),1)) I APID(7)="" S APID(7)=HL("Q")
"RTN","VAFCQRY1",48,0)
 . I $P(APID(7),$E(HL("ECH"),1),7)'="M" S $P(APID(7),$E(HL("ECH"),1),7)="M"
"RTN","VAFCQRY1",49,0)
 S APID(8)=$$HLDATE^HLFNC($P(VAFCZN,"^",3))  ;date/time of birth
"RTN","VAFCQRY1",50,0)
 S APID(9)=$P(VAFCZN,"^",2)  ;sex
"RTN","VAFCQRY1",51,0)
 ;place of birth city and state
"RTN","VAFCQRY1",52,0)
ADDR S APID(12)="" D
"RTN","VAFCQRY1",53,0)
 . I $D(^DPT(DFN,0)) D
"RTN","VAFCQRY1",54,0)
 .. ;address info
"RTN","VAFCQRY1",55,0)
 .. S $P(APID(12),COMP)=$$GET1^DIQ(2,DFN_",",.111) I $P(APID(12),COMP)="" S $P(APID(12),COMP)=HL("Q")
"RTN","VAFCQRY1",56,0)
 .. N LINE2 S LINE2=$$GET1^DIQ(2,DFN_",",.112) N LINE3 S LINE3=$$GET1^DIQ(2,DFN_",",.113)
"RTN","VAFCQRY1",57,0)
 .. S $P(APID(12),COMP,2)=LINE2 I $P(APID(12),COMP,2)="" S $P(APID(12),COMP,2)=HL("Q")
"RTN","VAFCQRY1",58,0)
 .. S $P(APID(12),COMP,8)=LINE3 I $P(APID(12),COMP,8)="" S $P(APID(12),COMP,8)=HL("Q")
"RTN","VAFCQRY1",59,0)
 .. S $P(APID(12),COMP,3)=$$GET1^DIQ(2,DFN_",",.114) I $P(APID(12),COMP,3)="" S $P(APID(12),COMP,3)=HL("Q")
"RTN","VAFCQRY1",60,0)
 .. S STATEIEN=$$GET1^DIQ(2,DFN_",",.115,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) S $P(APID(12),COMP,4)=$G(STATE) I $P(APID(12),COMP,4)="" S $P(APID(12),COMP,4)=HL("Q")
"RTN","VAFCQRY1",61,0)
 .. S $P(APID(12),COMP,5)=$$GET1^DIQ(2,DFN_",",.1112) I $P(APID(12),COMP,5)="" S $P(APID(12),COMP,5)=HL("Q")
"RTN","VAFCQRY1",62,0)
 .. S $P(APID(12),COMP,7)="P"
"RTN","VAFCQRY1",63,0)
 .. ;place of birth information
"RTN","VAFCQRY1",64,0)
 .. S CITY=$$GET1^DIQ(2,DFN_",",.092) D
"RTN","VAFCQRY1",65,0)
 ... I $G(CITY)'="" S $P(X,COMP,3)=CITY
"RTN","VAFCQRY1",66,0)
 ... I $G(CITY)="" S $P(X,COMP,3)=HL("Q")
"RTN","VAFCQRY1",67,0)
 ... S STATEIEN=$$GET1^DIQ(2,DFN_",",.093,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) D
"RTN","VAFCQRY1",68,0)
 .... I $G(STATE)'="" S $P(X,COMP,4)=STATE
"RTN","VAFCQRY1",69,0)
 .... I $G(STATE)="" S $P(X,COMP,4)=HL("Q")
"RTN","VAFCQRY1",70,0)
 ... S $P(X,COMP,7)="N"
"RTN","VAFCQRY1",71,0)
 ... S APID(12)=$G(APID(12))_REP_X
"RTN","VAFCQRY1",72,0)
 S APID(13)=$$GET1^DIQ(2,DFN_",",.117) I APID(13)="" S APID(13)=HL("Q")  ;county code
"RTN","VAFCQRY1",73,0)
 N PHONEN,HNUM,WNUM S PHONEN=$G(^DPT(DFN,.13)) S HNUM=$P(PHONEN,"^",1),WNUM=$P(PHONEN,"^",2)
"RTN","VAFCQRY1",74,0)
 S APID(14)=$$HLPHONE^HLFNC(HNUM)
"RTN","VAFCQRY1",75,0)
 S APID(15)=$$HLPHONE^HLFNC(WNUM)
"RTN","VAFCQRY1",76,0)
 D DEM^VADPT
"RTN","VAFCQRY1",77,0)
 S APID(17)="" I +VADM(10)>0 S X=$P($G(^DIC(11,+VADM(10),0)),"^",3),APID(17)=$S(X="N":"S",X="U":"",X="":HLQ,1:X) ;marital status (DHCP N=HL7 S, U="") ;**477
"RTN","VAFCQRY1",78,0)
 S APID(18)="" I +VADM(9)>0 S APID(18)=$P($G(^DIC(13,+VADM(9),0)),"^",4) I APID(18)="" S APID(18)=29  ;religious pref (if blank send 29 (UNKNOWN))
"RTN","VAFCQRY1",79,0)
 S APID(30)="" I $D(^DPT(DFN,.35)) S PDOD=$P(^DPT(DFN,.35),"^") S APID(30)=$$HLDATE^HLFNC(PDOD)  ;date of death
"RTN","VAFCQRY1",80,0)
 N X F X=6,7,8,9,13,14,15,17,18,30 I APID(X)="" S APID(X)=HL("Q")
"RTN","VAFCQRY1",81,0)
 ;list of fields used for backwards compatibility with HDR
"RTN","VAFCQRY1",82,0)
 S APID(3)=$P(VAFCMN,"^")_"V"_$P(VAFCMN,"^",2)  ;Patient ID
"RTN","VAFCQRY1",83,0)
 S APID(20)=SSN  ;ssn passed in PID-3
"RTN","VAFCQRY1",84,0)
 S APID(24)=CITY_" "_STATE  ;place of birth (not used) use PID-11 with an 'N' instead
"RTN","VAFCQRY1",85,0)
 ;list of fields not currently used or supported (# is 1 more than seq)
"RTN","VAFCQRY1",86,0)
 S APID(5)=""  ;Alternate Patient Identifier
"RTN","VAFCQRY1",87,0)
 S APID(10)=""  ;patient alias
"RTN","VAFCQRY1",88,0)
 S APID(11)=""  ;race
"RTN","VAFCQRY1",89,0)
 S APID(16)=""  ;primary language
"RTN","VAFCQRY1",90,0)
 S APID(19)=""  ;patient account #
"RTN","VAFCQRY1",91,0)
 S APID(21)=""  ;drivers lic #
"RTN","VAFCQRY1",92,0)
 S APID(22)=""  ;mother's id
"RTN","VAFCQRY1",93,0)
 S APID(23)=""  ;ethnic group
"RTN","VAFCQRY1",94,0)
 S APID(25)=""
"RTN","VAFCQRY1",95,0)
 S APID(26)=""
"RTN","VAFCQRY1",96,0)
 S APID(27)=""
"RTN","VAFCQRY1",97,0)
 S APID(28)=""
"RTN","VAFCQRY1",98,0)
 S APID(29)=""
"RTN","VAFCQRY1",99,0)
 S APID(31)=""
"RTN","VAFCQRY1",100,0)
 S PID(1)="PID"_HL("FS")
"RTN","VAFCQRY1",101,0)
 S LVL=1,X=1 F  S X=$O(APID(X)) Q:'X  D
"RTN","VAFCQRY1",102,0)
 . S PID(LVL)=$G(PID(LVL))
"RTN","VAFCQRY1",103,0)
 . S NXT=APID(X) D
"RTN","VAFCQRY1",104,0)
 .. I '$O(APID(X,0)) S NXT=NXT_HL("FS")
"RTN","VAFCQRY1",105,0)
 .. I $L($G(PID(LVL))_NXT)>245 S LNGTH=245-$L(PID(LVL)),PID(LVL)=PID(LVL)_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),LVL=LVL+1
"RTN","VAFCQRY1",106,0)
 .. I $L($G(PID(LVL))_NXT)'>245 S PID(LVL)=$G(PID(LVL))_NXT
"RTN","VAFCQRY1",107,0)
 . S LVL2=0 F  S LVL2=$O(APID(X,LVL2)) Q:'LVL2  D
"RTN","VAFCQRY1",108,0)
 .. S NXT=APID(X,LVL2) D
"RTN","VAFCQRY1",109,0)
 ... I $L($G(PID(LVL))_NXT)>245 S LNGTH=245-$L(PID(LVL)),PID(LVL)=PID(LVL)_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),LVL=LVL+1
"RTN","VAFCQRY1",110,0)
 ... I $L($G(PID(LVL))_NXT)'>245 S PID(LVL)=$G(PID(LVL))_NXT
"RTN","VAFCQRY1",111,0)
 ... I '$O(APID(X,LVL2)) S PID(LVL)=PID(LVL)_HL("FS")
"RTN","VAFCQRY1",112,0)
 D KVA^VADPT
"RTN","VAFCQRY1",113,0)
 Q
"RTN","VAFCRAU")
0^13^B6506773
"RTN","VAFCRAU",1,0)
VAFCRAU ;BHAM/DRI-LIST MANAGER ROUTINE FOR MPI/PD VAFC EXCPT REMOTE AUDIT IN PDR ;3/14/02  11:41
"RTN","VAFCRAU",2,0)
 ;;5.3;Registration;**477**;Aug 13, 1993
"RTN","VAFCRAU",3,0)
 ;Reference to RPCCHK^XWB2HL7 supported by IA #3144
"RTN","VAFCRAU",4,0)
 ;Reference to RTNDATA^XWBDRPC supported by IA #3149
"RTN","VAFCRAU",5,0)
EN(ICN) ;main entry point for VAFC EXCPT REMOTE AUDIT
"RTN","VAFCRAU",6,0)
 D EN^VALM("VAFC EXCPT REMOTE AUDIT")
"RTN","VAFCRAU",7,0)
 Q
"RTN","VAFCRAU",8,0)
HDR ;header code
"RTN","VAFCRAU",9,0)
 S VALMHDR(1)="MPI/PD REMOTE AUDIT DATA"
"RTN","VAFCRAU",10,0)
 S VALMHDR(2)=""
"RTN","VAFCRAU",11,0)
 Q
"RTN","VAFCRAU",12,0)
INIT ;
"RTN","VAFCRAU",13,0)
 K @VALMAR ;K ^TMP("VAFCRAU",$J)
"RTN","VAFCRAU",14,0)
 I '$D(DFN) G EXIT
"RTN","VAFCRAU",15,0)
 S LIN=1,X=0,STR="",TXT=""
"RTN","VAFCRAU",16,0)
 S TXT="-> For Patient "_$P($G(^DPT(DFN,0)),"^",1) S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","VAFCRAU",17,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","VAFCRAU",18,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","VAFCRAU",19,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","VAFCRAU",20,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","VAFCRAU",21,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","VAFCRAU",22,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","VAFCRAU",23,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","VAFCRAU",24,0)
 . S TXT="  "_$P(TFL(SL),"^")_"  status: ("_STATUS_")"
"RTN","VAFCRAU",25,0)
 . D ADDTMP
"RTN","VAFCRAU",26,0)
 . S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP D
"RTN","VAFCRAU",27,0)
 . S LOC=$P(TFL(SL),"^",2)
"RTN","VAFCRAU",28,0)
 . N STATUS,RETURN,RESULT,RET
"RTN","VAFCRAU",29,0)
 . I '$D(^XTMP("VAFCRAUD"_ICN,0)) S TXT=" - No audit query exists for this patient." S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","VAFCRAU",30,0)
 . I $D(^XTMP("VAFCRAUD"_ICN,LOC,0)) D
"RTN","VAFCRAU",31,0)
 .. S RETURN(0)=$P(^XTMP("VAFCRAUD"_ICN,LOC,0),"^")
"RTN","VAFCRAU",32,0)
 .. D RPCCHK^XWB2HL7(.RESULT,RETURN(0)) I +RESULT(0)=1 D
"RTN","VAFCRAU",33,0)
 ... D RTNDATA^XWBDRPC(.RET,RETURN(0)) D
"RTN","VAFCRAU",34,0)
 ... I $G(RET(0))<0 S TXT="No Data Returned Due To: "_$P(RET(0),"^",2,99) S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP Q
"RTN","VAFCRAU",35,0)
 ... I $G(RET)'="",$D(@RET) S GLO=RET F  S GLO=$Q(@GLO) Q:$QS(GLO,1)'=$J  S TXT=@GLO S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","VAFCRAU",36,0)
 ... S R=0 F  S R=$O(RET(R)) Q:'R  S TXT=RET(R) S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","VAFCRAU",37,0)
 K TFARR,R,L,SL,LOC,TFL,GLO
"RTN","VAFCRAU",38,0)
 S VALMCNT=LIN-1
"RTN","VAFCRAU",39,0)
 Q
"RTN","VAFCRAU",40,0)
ADDTMP ;
"RTN","VAFCRAU",41,0)
 S ^TMP("VAFCRAU",$J,LIN,0)=STR
"RTN","VAFCRAU",42,0)
 S ^TMP("VAFCRAU",$J,"IDX",LIN,LIN)=""
"RTN","VAFCRAU",43,0)
 S LIN=LIN+1,STR=""
"RTN","VAFCRAU",44,0)
 Q
"RTN","VAFCRAU",45,0)
HELP ;
"RTN","VAFCRAU",46,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","VAFCRAU",47,0)
 Q
"RTN","VAFCRAU",48,0)
EXIT ;
"RTN","VAFCRAU",49,0)
 S VALMBCK=""
"RTN","VAFCRAU",50,0)
 K ^TMP("VAFCRAU",$J),LIN,X,STR,TXT
"RTN","VAFCRAU",51,0)
 S VALMBCK="R"
"RTN","VAFCRAU",52,0)
 Q
"RTN","VAFCRAUD")
0^3^B56907832
"RTN","VAFCRAUD",1,0)
VAFCRAUD ;BHAM/DRI-ROUTINE TO CALL VAFC REMOTE AUDIT (PATIENT) ;2/22/02
"RTN","VAFCRAUD",2,0)
 ;;5.3;Registration;**477**;Aug 13, 1993
"RTN","VAFCRAUD",3,0)
 ;Reference to ^DGCN(391.91 supported by IA #2911
"RTN","VAFCRAUD",4,0)
 ;Reference to EN1^XWB2HL7 supported by IA #3144
"RTN","VAFCRAUD",5,0)
 ;Reference to RPCCHK^XWB2HL7 supported by IA #3144
"RTN","VAFCRAUD",6,0)
 ;Reference to RTNDATA^XWBDRPC supported by IA #3149
"RTN","VAFCRAUD",7,0)
ASK ;Ask For Patient
"RTN","VAFCRAUD",8,0)
 K DIRUT
"RTN","VAFCRAUD",9,0)
 W !!,"Patient lookup can be done by Patient Name, SSN or by ICN.",!
"RTN","VAFCRAUD",10,0)
 S DFN="",ICN=""
"RTN","VAFCRAUD",11,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: ",D="SSN^AICN^B^BS^BS5"
"RTN","VAFCRAUD",12,0)
 D MIX^DIC1 K DIC,D
"RTN","VAFCRAUD",13,0)
 I Y<0 S REXIT=1 G QUIT
"RTN","VAFCRAUD",14,0)
 S DFN=+Y
"RTN","VAFCRAUD",15,0)
 S ICN=+$$GETICN^MPIF001(DFN) I ICN<1 W !,"There is no Integration Control Number assigned to this patient,",!,"no treating facilities to query." G ASK
"RTN","VAFCRAUD",16,0)
 Q
"RTN","VAFCRAUD",17,0)
ASK2 ;Ask for Date Range
"RTN","VAFCRAUD",18,0)
 W !!,"Enter date range for data to be included in report."
"RTN","VAFCRAUD",19,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","VAFCRAUD",20,0)
 S DIR(0)="DAO^:DT:EPX",DIR("A")="Beginning Date:  " D ^DIR K DIR G:$D(DIRUT) QUIT S VAFCBDT=Y
"RTN","VAFCRAUD",21,0)
 S DIR(0)="DAO^"_VAFCBDT_":DT:EPX",DIR("A")="Ending Date:  " D ^DIR K DIR G:$D(DIRUT) QUIT S VAFCEDT=Y
"RTN","VAFCRAUD",22,0)
 ;
"RTN","VAFCRAUD",23,0)
 D SEND(ICN,VAFCBDT,VAFCEDT)
"RTN","VAFCRAUD",24,0)
 ;
"RTN","VAFCRAUD",25,0)
QUIT ;
"RTN","VAFCRAUD",26,0)
 K Y
"RTN","VAFCRAUD",27,0)
 Q
"RTN","VAFCRAUD",28,0)
 ;
"RTN","VAFCRAUD",29,0)
SEND(ICN,VAFCBDT,VAFCEDT) ;
"RTN","VAFCRAUD",30,0)
 N TFL,X,Y,SNTDT,MPIDIR
"RTN","VAFCRAUD",31,0)
 D GETTFL(ICN,.TFL)
"RTN","VAFCRAUD",32,0)
 I $D(^XTMP("VAFCRAUD"_ICN,0)) S SNTDT=$$FMTE^XLFDT($P(^XTMP("VAFCRAUD"_ICN,0),"^",2)) W !,"Query last sent for this ICN on "_SNTDT,!
"RTN","VAFCRAUD",33,0)
 I $P($G(TFL(0)),"^",1)=1 D
"RTN","VAFCRAUD",34,0)
 . D SELTF Q:((Y="")!(Y="^"))
"RTN","VAFCRAUD",35,0)
 . W !,"Remote patient data queries will be sent to: "
"RTN","VAFCRAUD",36,0)
 . S CNT=0,X=0 F  S X=$O(TFARR(X)) Q:'X  S CNT=CNT+1
"RTN","VAFCRAUD",37,0)
 . I CNT>22 D D2
"RTN","VAFCRAUD",38,0)
 . I CNT<23 D D1
"RTN","VAFCRAUD",39,0)
 . W ! K DIR S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do you want to continue" D ^DIR S MPIDIR=+Y K DIR
"RTN","VAFCRAUD",40,0)
 . I MPIDIR=1 S X=0 F  S X=$O(TFL(X)) Q:'X  D
"RTN","VAFCRAUD",41,0)
 .. W !?3,"Sending Remote Query to: ",X,"  ",$P(TFL(X),"^")
"RTN","VAFCRAUD",42,0)
 .. I $D(^XTMP("VAFCRAUD"_ICN,X)) K ^XTMP("VAFCRAUD"_ICN,X)
"RTN","VAFCRAUD",43,0)
 .. D REQ(ICN,.TFL,X)
"RTN","VAFCRAUD",44,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query will be sent."
"RTN","VAFCRAUD",45,0)
 K ICNARR,X,Y,CNT,TFARR,TFL
"RTN","VAFCRAUD",46,0)
 Q
"RTN","VAFCRAUD",47,0)
SEND2 ;
"RTN","VAFCRAUD",48,0)
 N REXIT S REXIT=0
"RTN","VAFCRAUD",49,0)
 W !!,"This option sends a remote query to selected treating"
"RTN","VAFCRAUD",50,0)
 W !,"facility site(s) for MPI/PD data for a patient."
"RTN","VAFCRAUD",51,0)
 F  D  Q:REXIT=1
"RTN","VAFCRAUD",52,0)
 . D ASK
"RTN","VAFCRAUD",53,0)
 . I $D(Y) D SEND
"RTN","VAFCRAUD",54,0)
 K ICN,DFN
"RTN","VAFCRAUD",55,0)
 Q
"RTN","VAFCRAUD",56,0)
CHKSTAT(ICN) ;check on the status for a given ICN or SSN
"RTN","VAFCRAUD",57,0)
 N TFL,L,Y,ICNARR,STATUS,SL
"RTN","VAFCRAUD",58,0)
 W !!,"Checking the status of remote patient data query.",!
"RTN","VAFCRAUD",59,0)
 I '$D(^XTMP("VAFCRAUD"_ICN)) W !,"No remote query sent for this patient." Q
"RTN","VAFCRAUD",60,0)
 D GETTFL(ICN,.TFL)
"RTN","VAFCRAUD",61,0)
 W !!,"-> For ICN ",$P(ICN,"V",1),!
"RTN","VAFCRAUD",62,0)
 I $D(TFL(0)) D
"RTN","VAFCRAUD",63,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("VAFCRAUD"_ICN,X)) K TFL(X)
"RTN","VAFCRAUD",64,0)
 D SELTF
"RTN","VAFCRAUD",65,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","VAFCRAUD",66,0)
 Q:((Y="")!(Y="^"))
"RTN","VAFCRAUD",67,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","VAFCRAUD",68,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","VAFCRAUD",69,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","VAFCRAUD",70,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","VAFCRAUD",71,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","VAFCRAUD",72,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","VAFCRAUD",73,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","VAFCRAUD",74,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")"
"RTN","VAFCRAUD",75,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query sent for this patient."
"RTN","VAFCRAUD",76,0)
 K ICNARR,L,SL,TFARR,TFL
"RTN","VAFCRAUD",77,0)
 Q
"RTN","VAFCRAUD",78,0)
CHKSTAT2 ;
"RTN","VAFCRAUD",79,0)
 N REXIT S REXIT=0
"RTN","VAFCRAUD",80,0)
 W !!,"This option checks the status of an existing remote patient data query."
"RTN","VAFCRAUD",81,0)
 F  D  Q:REXIT=1
"RTN","VAFCRAUD",82,0)
 . D ASK
"RTN","VAFCRAUD",83,0)
 . I $D(Y) D CHKSTAT
"RTN","VAFCRAUD",84,0)
 K ICN,DFN
"RTN","VAFCRAUD",85,0)
 Q
"RTN","VAFCRAUD",86,0)
DISP    ;display returned AUDIT queries
"RTN","VAFCRAUD",87,0)
 W !!,"Display data returned from remote patient data queries."
"RTN","VAFCRAUD",88,0)
 W !,"(Be sure HISTORY is enabled to capture data!)",!
"RTN","VAFCRAUD",89,0)
 N TFL,L,Y,ICNARR,STATUS
"RTN","VAFCRAUD",90,0)
 I '$D(^XTMP("VAFCRAUD"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","VAFCRAUD",91,0)
 D GETTFL(ICN,.TFL)
"RTN","VAFCRAUD",92,0)
 W !!,"-> For ICN ",$P(ICN,"V",1),!
"RTN","VAFCRAUD",93,0)
 I $D(TFL(0)) D
"RTN","VAFCRAUD",94,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("VAFCRAUD"_ICN,X)) K TFL(X)
"RTN","VAFCRAUD",95,0)
 D SELTF
"RTN","VAFCRAUD",96,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","VAFCRAUD",97,0)
 Q:((Y="")!(Y="^"))
"RTN","VAFCRAUD",98,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","VAFCRAUD",99,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","VAFCRAUD",100,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","VAFCRAUD",101,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","VAFCRAUD",102,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","VAFCRAUD",103,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","VAFCRAUD",104,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","VAFCRAUD",105,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")"
"RTN","VAFCRAUD",106,0)
 . D DISPLAY(ICN,$P(TFL(SL),"^",2))
"RTN","VAFCRAUD",107,0)
 I '$D(TFL(0)) W !?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query exists for this patient."
"RTN","VAFCRAUD",108,0)
 K ICNARR,L,SL,TFARR,TFL
"RTN","VAFCRAUD",109,0)
 Q
"RTN","VAFCRAUD",110,0)
DISP2 ;
"RTN","VAFCRAUD",111,0)
 N REXIT S REXIT=0
"RTN","VAFCRAUD",112,0)
 F  D  Q:REXIT=1
"RTN","VAFCRAUD",113,0)
 . D ASK
"RTN","VAFCRAUD",114,0)
 . I $D(Y) D DISP
"RTN","VAFCRAUD",115,0)
 K ICN,DFN
"RTN","VAFCRAUD",116,0)
 Q
"RTN","VAFCRAUD",117,0)
DISPLAY(ICN,LOC) ;display a remote audit report
"RTN","VAFCRAUD",118,0)
 N STATUS,RETURN,RESULT,RET
"RTN","VAFCRAUD",119,0)
 I '$D(^XTMP("VAFCRAUD"_ICN,0)) W !?15," - No audit query exists for this record."
"RTN","VAFCRAUD",120,0)
 I $D(^XTMP("VAFCRAUD"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("VAFCRAUD"_ICN,LOC,0),"^") D
"RTN","VAFCRAUD",121,0)
 . D RPCCHK^XWB2HL7(.RESULT,RETURN(0)) I +RESULT(0)=1 D
"RTN","VAFCRAUD",122,0)
 .. D RTNDATA^XWBDRPC(.RET,RETURN(0)) S R=0 F  S R=$O(RET(R)) Q:'R  W !,RET(R) I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1
"RTN","VAFCRAUD",123,0)
 . I $D(RET(0)) I RET(0)<0 W !!,"No data returned due to: "_$P(RET(0),"^",2)
"RTN","VAFCRAUD",124,0)
 . K R
"RTN","VAFCRAUD",125,0)
 Q
"RTN","VAFCRAUD",126,0)
GETTFL(ICN,TFL) ;Check for existing Treating Facilities
"RTN","VAFCRAUD",127,0)
 N LOC,HOME
"RTN","VAFCRAUD",128,0)
 S HOME=$$SITE^VASITE()
"RTN","VAFCRAUD",129,0)
 S TF=0 F  S TF=$O(^DGCN(391.91,"APAT",DFN,TF)) Q:'TF  D
"RTN","VAFCRAUD",130,0)
 . S LOC=$$NNT^XUAF4(TF)
"RTN","VAFCRAUD",131,0)
 . I $P(LOC,"^",2)'=$E($P(HOME,"^",3),1,3) D
"RTN","VAFCRAUD",132,0)
 .. S TFL($P(LOC,"^",2))=LOC
"RTN","VAFCRAUD",133,0)
 .. S LOC=$P(LOC,"^",2)
"RTN","VAFCRAUD",134,0)
 .. D MONITOR(ICN,LOC,.RESULT)
"RTN","VAFCRAUD",135,0)
 .. S $P(TFL(LOC),"^",3)=$P(RESULT(0),"^",2)
"RTN","VAFCRAUD",136,0)
 I $O(TFL(0)) S TFL(0)=1
"RTN","VAFCRAUD",137,0)
 K TF
"RTN","VAFCRAUD",138,0)
 Q
"RTN","VAFCRAUD",139,0)
SELTF ;Allow the user to select treating facilites from a list
"RTN","VAFCRAUD",140,0)
 K TFARR,TFARR1
"RTN","VAFCRAUD",141,0)
 S I=0 F  S I=$O(TFL(I)) Q:'I  D
"RTN","VAFCRAUD",142,0)
 . S TFARR1($P(TFL(I),"^",1))=$P(TFL(I),"^",2)_"^"_$P(TFL(I),"^",1)
"RTN","VAFCRAUD",143,0)
 S I="",CNT=0 F  S I=$O(TFARR1(I)) Q:I=""  D
"RTN","VAFCRAUD",144,0)
 . S CNT=CNT+1 S TFARR(CNT)=TFARR1(I)
"RTN","VAFCRAUD",145,0)
 I CNT=1 S Y=1 Q
"RTN","VAFCRAUD",146,0)
 K DIR,Y
"RTN","VAFCRAUD",147,0)
 S CNT=CNT+1,TFARR(CNT)="ALL"
"RTN","VAFCRAUD",148,0)
 S DIR(0)="LA^1:"_CNT
"RTN","VAFCRAUD",149,0)
 S DIR("A")="Select site(s) 1-"_(CNT-1)_" or "_CNT_" for all: "
"RTN","VAFCRAUD",150,0)
 W !,"Select one or more of the following: "
"RTN","VAFCRAUD",151,0)
 I CNT>22 D D2
"RTN","VAFCRAUD",152,0)
 I CNT<23 D D1
"RTN","VAFCRAUD",153,0)
 D ^DIR K DIR
"RTN","VAFCRAUD",154,0)
 I Y<1 K TFARR,TFARR1,L,I,A,CNT Q
"RTN","VAFCRAUD",155,0)
 S Y=","_Y
"RTN","VAFCRAUD",156,0)
 I Y[(","_CNT_",") K TFARR(CNT),TFARR1,CNT,I Q
"RTN","VAFCRAUD",157,0)
 S I=0,A="" F  S I=$O(TFARR(I)) Q:'I  I Y'[(","_I_",") S A=$P(TFARR(I),"^",1) K TFL(A) K TFARR(I)
"RTN","VAFCRAUD",158,0)
 K L,I,A,TFARR(CNT),CNT,TFARR1
"RTN","VAFCRAUD",159,0)
 Q
"RTN","VAFCRAUD",160,0)
MONITOR(ICN,LOC,RESULT) ;
"RTN","VAFCRAUD",161,0)
 N STATUS,RETURN
"RTN","VAFCRAUD",162,0)
 I '$D(^XTMP("VAFCRAUD"_ICN,0)) S RESULT(0)="-1^Unknown" Q
"RTN","VAFCRAUD",163,0)
 I '$D(^XTMP("VAFCRAUD"_ICN,LOC,0)) S RESULT(0)="-1^Unknown" Q
"RTN","VAFCRAUD",164,0)
 I $D(^XTMP("VAFCRAUD"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("VAFCRAUD"_ICN,LOC,0),"^",1) D RPCCHK^XWB2HL7(.RESULT,RETURN(0))
"RTN","VAFCRAUD",165,0)
 Q
"RTN","VAFCRAUD",166,0)
REQ(ICN,TFL,LOC)        ;request a remote audit report
"RTN","VAFCRAUD",167,0)
 ;LOC - STATION# OF THE INSTITUTION file entry
"RTN","VAFCRAUD",168,0)
 N VALUE S VALUE="ICN",VALUE(VALUE)=ICN
"RTN","VAFCRAUD",169,0)
 I +LOC>0 D EN1^XWB2HL7(.RETURN,LOC,"VAFC REMOTE AUDIT",1,.VALUE,"",VAFCBDT,VAFCEDT)
"RTN","VAFCRAUD",170,0)
 S ^XTMP("VAFCRAUD"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE AUDIT QUERY"
"RTN","VAFCRAUD",171,0)
 S ^XTMP("VAFCRAUD"_ICN,LOC,0)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","VAFCRAUD",172,0)
 Q
"RTN","VAFCRAUD",173,0)
SENS ;Check for patient sensitivity
"RTN","VAFCRAUD",174,0)
 N RESULT
"RTN","VAFCRAUD",175,0)
 D PTSEC^DGSEC4(.RESULT,DFN,0,"RPC - VAFC REMOTE AUDIT^Remote Audit Query")
"RTN","VAFCRAUD",176,0)
 I RESULT(1)>0 D
"RTN","VAFCRAUD",177,0)
 . I '$D(^XUSEC("DG SENSITIVITY",DUZ)) D
"RTN","VAFCRAUD",178,0)
 . W !!,"PATIENT MARKED SENSITIVE."
"RTN","VAFCRAUD",179,0)
 . W !,"You do not have proper security to view this record."
"RTN","VAFCRAUD",180,0)
 Q
"RTN","VAFCRAUD",181,0)
D1 ;
"RTN","VAFCRAUD",182,0)
 S C1=1,I=0 F  S I=$O(TFARR(I)) Q:'I  D
"RTN","VAFCRAUD",183,0)
 . W !,C1_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2) S C1=C1+1
"RTN","VAFCRAUD",184,0)
 K C1,I
"RTN","VAFCRAUD",185,0)
 Q
"RTN","VAFCRAUD",186,0)
D2 ;
"RTN","VAFCRAUD",187,0)
 S I2=23 F I=1:1:22 D
"RTN","VAFCRAUD",188,0)
 . W !,I_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2)
"RTN","VAFCRAUD",189,0)
 . I $D(TFARR(I2)) W ?41,I2_". ",?44,"("_$P(TFARR(I2),"^",1)_") "_$P(TFARR(I2),"^",2) S I2=I2+1
"RTN","VAFCRAUD",190,0)
 K I,I2
"RTN","VAFCRAUD",191,0)
 Q
"RTN","VAFCRPC")
0^18^B4310892
"RTN","VAFCRPC",1,0)
VAFCRPC ;BIR/DLR-RPC ENTRY POINTS ;10/24/02  13:07
"RTN","VAFCRPC",2,0)
 ;;5.3;Registration;**414,440,474,477**;Aug 13, 1993
"RTN","VAFCRPC",3,0)
 ;;Routine uses the following supported IAs #2701 and #3027.
"RTN","VAFCRPC",4,0)
PDAT(RETURN,ICN,SSN) ;remote pdat display
"RTN","VAFCRPC",5,0)
 N TYPE,REP,ARRAY,DFN,VAFCSEN
"RTN","VAFCRPC",6,0)
 I ICN="" S RETURN(1)="-1^Invalid ICN passed into RPC" Q
"RTN","VAFCRPC",7,0)
 S DFN=$$GETDFN^MPIF001(ICN) ;IA 2701
"RTN","VAFCRPC",8,0)
 ;IF DFN=null check SSN in cases where ICN x-ref isn't set
"RTN","VAFCRPC",9,0)
 ;log patient sensitivity on receiving system and send msg bulletin
"RTN","VAFCRPC",10,0)
 I +DFN<1 S RETURN(1)="-1^Unknown ICN" Q
"RTN","VAFCRPC",11,0)
 ;D NOTICE^DGSEC4(.VAFCSEN,DFN,"RPC - VAFC REMOTE PDAT FROM THE MPI^MPI/PD Patient Inquiry",3) ;IA #3027
"RTN","VAFCRPC",12,0)
 S ARRAY="^TMP(""VAFCHFS"","_$J_")"
"RTN","VAFCRPC",13,0)
 S TYPE="I",REP=1 D HFS^VAFCHFS("START^VAFCPDAT")
"RTN","VAFCRPC",14,0)
 ;M RETURN=@ARRAY
"RTN","VAFCRPC",15,0)
 D DSPPDAT^VAFCHFS(.RETURN)
"RTN","VAFCRPC",16,0)
 K ^TMP("VAFCHFS",$J)
"RTN","VAFCRPC",17,0)
 Q
"RTN","VAFCRPC",18,0)
AUDIT(RETURN,VALUE,SSN,SDT,EDT) ;remote audit display
"RTN","VAFCRPC",19,0)
 ;'value' will pass in either an icn, ssn, dfn or patient name
"RTN","VAFCRPC",20,0)
 N ARRAY,DFN,ICN,NAME,SSN,VAFCSEN
"RTN","VAFCRPC",21,0)
 S ICN=$G(VALUE("ICN")) ;icn (local or national) passed in
"RTN","VAFCRPC",22,0)
 S NAME=$G(VALUE("NAME")) ;patient name passed in
"RTN","VAFCRPC",23,0)
 S SSN=$G(VALUE("SSN")) ;social security number passed in
"RTN","VAFCRPC",24,0)
 S DFN=$G(VALUE("DFN")) ;patient file ien passed in
"RTN","VAFCRPC",25,0)
 I $G(SSN)'="" S DFN=$O(^DPT("SSN",SSN,0)) I DFN="" S RETURN(1)="-1^Invalid SSN passed into RPC" Q
"RTN","VAFCRPC",26,0)
 I $G(ICN)'="" S DFN=$$GETDFN^MPIF001(ICN) I DFN="" S RETURN(1)="-1^Invalid ICN passed into RPC" Q  ;IA 2701
"RTN","VAFCRPC",27,0)
 I $G(NAME)'="" S DFN=$O(^DPT("B",NAME,0)) I DFN="" S RETURN(1)="-1^Invalid NAME passed into RPC" Q
"RTN","VAFCRPC",28,0)
 I $S('$G(DFN):1,'$D(^DPT(DFN,0)):1,1:0) S RETURN(1)="-1^Invalid DFN passed into RPC" Q
"RTN","VAFCRPC",29,0)
 ;log patient sensitivity on receiving system and send msg bulletin
"RTN","VAFCRPC",30,0)
 ;D NOTICE^DGSEC4(.VAFCSEN,DFN,"RPC - VAFC REMOTE AUDIT FROM THE MPI^Remote Audit Query",3) ;IA #3027
"RTN","VAFCRPC",31,0)
 S ARRAY="^TMP(""VAFCHFS"","_$J_")"
"RTN","VAFCRPC",32,0)
 D HFS^VAFCHFS("START^VAFCAUD(DFN,SDT,EDT,1)")
"RTN","VAFCRPC",33,0)
 ;M RETURN=@ARRAY
"RTN","VAFCRPC",34,0)
 D DSPPDAT^VAFCHFS(.RETURN)
"RTN","VAFCRPC",35,0)
 K ^TMP("VAFCHFS",$J)
"RTN","VAFCRPC",36,0)
 Q
"VER")
8.0^22.0
"^DD",2,2,.313,0)
CLAIM NUMBER^FXO^^.31;3^S DFN=DA D EV^DGLOCK I $D(X) S L=$S($D(^DPT(DA,0)):$P(^(0),U,9),1:X) W:X?1"SS".E "  ",L S:X?1"SS".E X=L I X'=L K:$L(X)>8!($L(X)<7)!'(X?.N) X
"^DD",2,2,.313,1,0)
^.1
"^DD",2,2,.313,1,991,0)
2^AVAFC313^MUMPS
"^DD",2,2,.313,1,991,1)
I ($T(AVAFC^VAFCDD01)'="") S VAFCF=".313;" D AVAFC^VAFCDD01(DA)
"^DD",2,2,.313,1,991,2)
I ($T(AVAFC^VAFCDD01)'="") S VAFCF=".313;" D AVAFC^VAFCDD01(DA)
"^DD",2,2,.313,1,991,"%D",0)
^.101^15^15^3030211^^
"^DD",2,2,.313,1,991,"%D",1,0)
This cross reference is used to remember that changes were made to the
"^DD",2,2,.313,1,991,"%D",2,0)
PATIENT file (#2) outside of the Registration process.  Execution of this
"^DD",2,2,.313,1,991,"%D",3,0)
cross reference will create an entry in the ADT/HL7 PIVOT file (#391.71)
"^DD",2,2,.313,1,991,"%D",4,0)
and mark it as requiring transmission of an HL7 ADT-A08 message.
"^DD",2,2,.313,1,991,"%D",5,0)
  
"^DD",2,2,.313,1,991,"%D",6,0)
The local variable VAFCFLG will be set to 1 if the cross reference is
"^DD",2,2,.313,1,991,"%D",7,0)
not executed because the change is being made from within the Registration
"^DD",2,2,.313,1,991,"%D",8,0)
process.
"^DD",2,2,.313,1,991,"%D",9,0)
  
"^DD",2,2,.313,1,991,"%D",10,0)
Execution of this cross reference can be prevented by setting the local
"^DD",2,2,.313,1,991,"%D",11,0)
variable VAFCA08 equal to 1.
"^DD",2,2,.313,1,991,"%D",12,0)
  
"^DD",2,2,.313,1,991,"%D",13,0)
The local variable VAFCF is used to identify the field edited.
"^DD",2,2,.313,1,991,"%D",14,0)
This data is stored in the FIELD(S) EDITED (#2.1) field in the 
"^DD",2,2,.313,1,991,"%D",15,0)
ADT/HL7 PIVOT file (#391.71).
"^DD",2,2,.313,1,991,"DT")
3030210
"^DD",2,2,.313,2)
S Y(0)=Y S Y=$E(Y,1,10)
"^DD",2,2,.313,2.1)
S Y=$E(Y,1,10)
"^DD",2,2,.313,3)
Enter this patient's claim number as 7-8 numerics or enter SS if the claim number is the same as his/her SSN.
"^DD",2,2,.313,20,0)
^.3LA^1^1
"^DD",2,2,.313,20,1,0)
ECD
"^DD",2,2,.313,21,0)
^^4^4^2861117^^^
"^DD",2,2,.313,21,1,0)
If the applicant is a veteran enter his/her claim number as 7-8 numerics
"^DD",2,2,.313,21,2,0)
or by entering the characters 'SS' if his/her claim number is the same
"^DD",2,2,.313,21,3,0)
as his/her social security number.  Once eligibility has been verified
"^DD",2,2,.313,21,4,0)
only users who hold the designated security key may enter/edit this field.
"^DD",2,2,.313,"DEL",1,0)
S DFN=DA D EV^DGLOCK I '$D(X)
"^DD",2,2,.313,"DT")
3030210
**END**
**END**
