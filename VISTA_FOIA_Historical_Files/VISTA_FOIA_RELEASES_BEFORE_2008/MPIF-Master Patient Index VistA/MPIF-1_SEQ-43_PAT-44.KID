Released MPIF*1*44 SEQ #43
Extracted from mail message
**KIDS**:MPIF*1.0*44^

**INSTALL NAME**
MPIF*1.0*44
"BLD",2350,0)
MPIF*1.0*44^MASTER PATIENT INDEX VISTA^0^3070112^y
"BLD",2350,1,0)
^^3^3^3070112^
"BLD",2350,1,1,0)
MPI CHANGES 3 & MPI CHANGES 4 ENHANCEMENTS
"BLD",2350,1,2,0)
Refer to patch MPIF*1*44 in the FORUM Patch Module for a complete
"BLD",2350,1,3,0)
description.
"BLD",2350,4,0)
^9.64PA^^
"BLD",2350,6.3)
7
"BLD",2350,"ABNS",0)
^9.66A^^
"BLD",2350,"ABPKG")
^^
"BLD",2350,"KRN",0)
^9.67PA^8989.52^19
"BLD",2350,"KRN",.4,0)
.4
"BLD",2350,"KRN",.401,0)
.401
"BLD",2350,"KRN",.402,0)
.402
"BLD",2350,"KRN",.403,0)
.403
"BLD",2350,"KRN",.5,0)
.5
"BLD",2350,"KRN",.84,0)
.84
"BLD",2350,"KRN",3.6,0)
3.6
"BLD",2350,"KRN",3.8,0)
3.8
"BLD",2350,"KRN",9.2,0)
9.2
"BLD",2350,"KRN",9.8,0)
9.8
"BLD",2350,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",2350,"KRN",9.8,"NM",1,0)
MPIFA24B^^0^B10894461
"BLD",2350,"KRN",9.8,"NM",2,0)
MPIFA28^^0^B5089239
"BLD",2350,"KRN",9.8,"NM",3,0)
MPIFA31B^^0^B16253562
"BLD",2350,"KRN",9.8,"NM",4,0)
MPIFAPI^^0^B47331120
"BLD",2350,"KRN",9.8,"NM","B","MPIFA24B",1)

"BLD",2350,"KRN",9.8,"NM","B","MPIFA28",2)

"BLD",2350,"KRN",9.8,"NM","B","MPIFA31B",3)

"BLD",2350,"KRN",9.8,"NM","B","MPIFAPI",4)

"BLD",2350,"KRN",19,0)
19
"BLD",2350,"KRN",19,"NM",0)
^9.68A^13^13
"BLD",2350,"KRN",19,"NM",1,0)
MPIF SITE PARAMETER^^0
"BLD",2350,"KRN",19,"NM",2,0)
MPIF CMOR MGR^^0
"BLD",2350,"KRN",19,"NM",3,0)
MPIF NEW REQUEST^^0
"BLD",2350,"KRN",19,"NM",4,0)
MPIF PUSH CMOR^^0
"BLD",2350,"KRN",19,"NM",5,0)
MPIF EDIT REQUEST^^0
"BLD",2350,"KRN",19,"NM",6,0)
MPIF REVIEW REQUEST^^0
"BLD",2350,"KRN",19,"NM",7,0)
MPIF BATCH REVIEW^^0
"BLD",2350,"KRN",19,"NM",8,0)
MPIF VIEW REQUEST^^0
"BLD",2350,"KRN",19,"NM",9,0)
MPIF RECEIVED REQUESTS^^0
"BLD",2350,"KRN",19,"NM",10,0)
MPIF SENT REQUESTS^^0
"BLD",2350,"KRN",19,"NM",11,0)
MPIF DISAPPROVE REPORT^^0
"BLD",2350,"KRN",19,"NM",12,0)
MPIF APPROVED REPORT^^0
"BLD",2350,"KRN",19,"NM",13,0)
MPIF CMOR REQUEST AUTO JOB^^0
"BLD",2350,"KRN",19,"NM","B","MPIF APPROVED REPORT",12)

"BLD",2350,"KRN",19,"NM","B","MPIF BATCH REVIEW",7)

"BLD",2350,"KRN",19,"NM","B","MPIF CMOR MGR",2)

"BLD",2350,"KRN",19,"NM","B","MPIF CMOR REQUEST AUTO JOB",13)

"BLD",2350,"KRN",19,"NM","B","MPIF DISAPPROVE REPORT",11)

"BLD",2350,"KRN",19,"NM","B","MPIF EDIT REQUEST",5)

"BLD",2350,"KRN",19,"NM","B","MPIF NEW REQUEST",3)

"BLD",2350,"KRN",19,"NM","B","MPIF PUSH CMOR",4)

"BLD",2350,"KRN",19,"NM","B","MPIF RECEIVED REQUESTS",9)

"BLD",2350,"KRN",19,"NM","B","MPIF REVIEW REQUEST",6)

"BLD",2350,"KRN",19,"NM","B","MPIF SENT REQUESTS",10)

"BLD",2350,"KRN",19,"NM","B","MPIF SITE PARAMETER",1)

"BLD",2350,"KRN",19,"NM","B","MPIF VIEW REQUEST",8)

"BLD",2350,"KRN",19.1,0)
19.1
"BLD",2350,"KRN",101,0)
101
"BLD",2350,"KRN",409.61,0)
409.61
"BLD",2350,"KRN",771,0)
771
"BLD",2350,"KRN",870,0)
870
"BLD",2350,"KRN",8989.51,0)
8989.51
"BLD",2350,"KRN",8989.51,"NM",0)
^9.68A^^0
"BLD",2350,"KRN",8989.52,0)
8989.52
"BLD",2350,"KRN",8994,0)
8994
"BLD",2350,"KRN","B",.4,.4)

"BLD",2350,"KRN","B",.401,.401)

"BLD",2350,"KRN","B",.402,.402)

"BLD",2350,"KRN","B",.403,.403)

"BLD",2350,"KRN","B",.5,.5)

"BLD",2350,"KRN","B",.84,.84)

"BLD",2350,"KRN","B",3.6,3.6)

"BLD",2350,"KRN","B",3.8,3.8)

"BLD",2350,"KRN","B",9.2,9.2)

"BLD",2350,"KRN","B",9.8,9.8)

"BLD",2350,"KRN","B",19,19)

"BLD",2350,"KRN","B",19.1,19.1)

"BLD",2350,"KRN","B",101,101)

"BLD",2350,"KRN","B",409.61,409.61)

"BLD",2350,"KRN","B",771,771)

"BLD",2350,"KRN","B",870,870)

"BLD",2350,"KRN","B",8989.51,8989.51)

"BLD",2350,"KRN","B",8989.52,8989.52)

"BLD",2350,"KRN","B",8994,8994)

"BLD",2350,"QUES",0)
^9.62^^
"BLD",2350,"REQB",0)
^9.611^4^4
"BLD",2350,"REQB",1,0)
MPIF*1.0*43^2
"BLD",2350,"REQB",2,0)
MPIF*1.0*35^2
"BLD",2350,"REQB",3,0)
MPIF*1.0*25^2
"BLD",2350,"REQB",4,0)
MPIF*1.0*45^2
"BLD",2350,"REQB","B","MPIF*1.0*25",3)

"BLD",2350,"REQB","B","MPIF*1.0*35",2)

"BLD",2350,"REQB","B","MPIF*1.0*43",1)

"BLD",2350,"REQB","B","MPIF*1.0*45",4)

"KRN",19,5469,-1)
0^2
"KRN",19,5469,0)
MPIF CMOR MGR^Coordinating Master of Record (CMOR) Request^Obsolete with MPIF*1.0*44.^M^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5469,1,0)
^^5^5^3010709^
"KRN",19,5469,1,1,0)
This is the main menu that contains options for managing incoming and
"KRN",19,5469,1,2,0)
outgoing CMOR requests.  Options provide the ability to display, review
"KRN",19,5469,1,3,0)
and process CMOR requests.  The ability to change the CMOR to another site
"KRN",19,5469,1,4,0)
(pushing the CMOR) is also included along with a number of useful tracking
"KRN",19,5469,1,5,0)
reports.
"KRN",19,5469,10,0)
^19.01IP^11^10
"KRN",19,5469,10,1,0)
5471^PEND^7
"KRN",19,5469,10,1,"^")
MPIF RECEIVED REQUESTS
"KRN",19,5469,10,2,0)
5470^SENT^8
"KRN",19,5469,10,2,"^")
MPIF SENT REQUESTS
"KRN",19,5469,10,3,0)
5472^^6
"KRN",19,5469,10,3,"^")
MPIF VIEW REQUEST
"KRN",19,5469,10,4,0)
5473^^1
"KRN",19,5469,10,4,"^")
MPIF NEW REQUEST
"KRN",19,5469,10,6,0)
5475^^4
"KRN",19,5469,10,6,"^")
MPIF REVIEW REQUEST
"KRN",19,5469,10,7,0)
5476^^5
"KRN",19,5469,10,7,"^")
MPIF BATCH REVIEW
"KRN",19,5469,10,8,0)
6385^^3
"KRN",19,5469,10,8,"^")
MPIF EDIT REQUEST
"KRN",19,5469,10,9,0)
6721^APP^10
"KRN",19,5469,10,9,"^")
MPIF APPROVED REPORT
"KRN",19,5469,10,10,0)
6722^DIS^9
"KRN",19,5469,10,10,"^")
MPIF DISAPPROVE REPORT
"KRN",19,5469,10,11,0)
6723^^2
"KRN",19,5469,10,11,"^")
MPIF PUSH CMOR
"KRN",19,5469,99)
60600,49902
"KRN",19,5469,"U")
COORDINATING MASTER OF RECORD 
"KRN",19,5470,-1)
0^10
"KRN",19,5470,0)
MPIF SENT REQUESTS^Report - Sent Requests Still Pending^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5470,1,0)
^^2^2^3010709^
"KRN",19,5470,1,1,0)
This report lists all CMOR requests entered that are still outstanding.
"KRN",19,5470,1,2,0)
The report sorts by station number and date requested.
"KRN",19,5470,25)
RPT1^MPIFNQ
"KRN",19,5470,"U")
REPORT - SENT REQUESTS STILL P
"KRN",19,5471,-1)
0^9
"KRN",19,5471,0)
MPIF RECEIVED REQUESTS^Report - Pending Received Requests^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5471,1,0)
^^2^2^3010709^
"KRN",19,5471,1,1,0)
This report lists all outstanding CMOR requests that need to be
"KRN",19,5471,1,2,0)
reviewed and processed.
"KRN",19,5471,25)
RPT2^MPIFNQ
"KRN",19,5471,99)
56810,32094
"KRN",19,5471,"U")
REPORT - PENDING RECEIVED REQU
"KRN",19,5472,-1)
0^8
"KRN",19,5472,0)
MPIF VIEW REQUEST^Display a CMOR Change Request^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5472,1,0)
^^1^1^2970710^^
"KRN",19,5472,1,1,0)
View all information for a particular CMOR request.
"KRN",19,5472,25)
INQ^MPIFNQ
"KRN",19,5472,"U")
DISPLAY A CMOR CHANGE REQUEST
"KRN",19,5473,-1)
0^3
"KRN",19,5473,0)
MPIF NEW REQUEST^Create a New CMOR Change Request^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5473,1,0)
^^2^2^3010709^
"KRN",19,5473,1,1,0)
This option is used to request a change of CMOR from the current CMOR to
"KRN",19,5473,1,2,0)
the facility making the request (i.e., changing the CMOR to your site).
"KRN",19,5473,25)
NEW^MPIFEDIT
"KRN",19,5473,"U")
CREATE A NEW CMOR CHANGE REQUE
"KRN",19,5474,-1)
0^1
"KRN",19,5474,0)
MPIF SITE PARAMETER^Site Parameters Edit for CMOR^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5474,1,0)
^19.06^4^4^3061129^^^^
"KRN",19,5474,1,1,0)
This option allows editing of site parameters that affect the 
"KRN",19,5474,1,2,0)
processing of CMOR requests.  These parameters allow incoming CMOR 
"KRN",19,5474,1,3,0)
requests to be processed manually or automatically and define a 
"KRN",19,5474,1,4,0)
mailgroup that will receive a message when a new request is received.
"KRN",19,5474,25)
TYPE^MPIFUTL
"KRN",19,5474,"U")
SITE PARAMETERS EDIT FOR CMOR
"KRN",19,5475,-1)
0^6
"KRN",19,5475,0)
MPIF REVIEW REQUEST^Review Pending Change of CMOR Requests^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5475,1,0)
^^2^2^3010709^
"KRN",19,5475,1,1,0)
This option allows the user to review unprocessed CMOR requests that need
"KRN",19,5475,1,2,0)
to be approved or denied.
"KRN",19,5475,25)
EN^MPIFREV
"KRN",19,5475,"U")
REVIEW PENDING CHANGE OF CMOR 
"KRN",19,5476,-1)
0^7
"KRN",19,5476,0)
MPIF BATCH REVIEW^Batch Review of CMOR Change Requests^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,5476,1,0)
^^2^2^3010709^
"KRN",19,5476,1,1,0)
This option allows the processing of pending CMOR requests by station
"KRN",19,5476,1,2,0)
rather than having to enter individual CMOR request numbers.
"KRN",19,5476,25)
BATCH^MPIFREV
"KRN",19,5476,"U")
BATCH REVIEW OF CMOR CHANGE RE
"KRN",19,6385,-1)
0^5
"KRN",19,6385,0)
MPIF EDIT REQUEST^Edit Open CMOR Change Request^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA^^
"KRN",19,6385,1,0)
^^2^2^3010709^
"KRN",19,6385,1,1,0)
This option allows the user to edit existing CMOR change requests that
"KRN",19,6385,1,2,0)
have a status of OPEN.
"KRN",19,6385,20)

"KRN",19,6385,25)
EDIT^MPIFNEW
"KRN",19,6385,"U")
EDIT OPEN CMOR CHANGE REQUEST
"KRN",19,6721,-1)
0^12
"KRN",19,6721,0)
MPIF APPROVED REPORT^Report - CMOR Requests Approved^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA^^
"KRN",19,6721,1,0)
^^2^2^3010709^
"KRN",19,6721,1,1,0)
This report prints the CMOR requests that have an approved status starting
"KRN",19,6721,1,2,0)
with the date selected by the user.
"KRN",19,6721,20)

"KRN",19,6721,25)
RPT3^MPIFNQ
"KRN",19,6721,"U")
REPORT - CMOR REQUESTS APPROVE
"KRN",19,6722,-1)
0^11
"KRN",19,6722,0)
MPIF DISAPPROVE REPORT^Report - CMOR Requests Disapproved^Obsolete with MPIF*1.0*44.^R^^^^^^^^
"KRN",19,6722,1,0)
^^2^2^3010709^
"KRN",19,6722,1,1,0)
This report prints the CMOR requests that have a disapproved status
"KRN",19,6722,1,2,0)
starting with the date selected by the user.
"KRN",19,6722,25)
RPT4^MPIFNQ
"KRN",19,6722,"U")
REPORT - CMOR REQUESTS DISAPPR
"KRN",19,6723,-1)
0^4
"KRN",19,6723,0)
MPIF PUSH CMOR^Push CMOR Request^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,6723,1,0)
^19.06^2^2^3001206^^
"KRN",19,6723,1,1,0)
This option will allow you to give up being the CMOR and give it to
"KRN",19,6723,1,2,0)
another site.
"KRN",19,6723,25)
NEW^MPIFCMRP
"KRN",19,6723,"U")
PUSH CMOR REQUEST
"KRN",19,6724,-1)
0^13
"KRN",19,6724,0)
MPIF CMOR REQUEST AUTO JOB^AUTO CHANGE CMOR NIGHT JOB^Obsolete with MPIF*1.0*44.^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,6724,1,0)
^^3^3^3001206^
"KRN",19,6724,1,1,0)
This job will look at all pending CMOR requests that you have received and
"KRN",19,6724,1,2,0)
if they are older than 14 days, they will be processed as if the auto
"KRN",19,6724,1,3,0)
accept parameter was enabled.
"KRN",19,6724,25)
CHK^MPIFAREQ
"KRN",19,6724,"U")
AUTO CHANGE CMOR NIGHT JOB
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
44^3070112
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3070112
"PKG",282,22,1,"PAH",1,1,1,0)
MPI CHANGES 3 & MPI CHANGES 4 ENHANCEMENTS
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*44 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","MPIFA24B")
0^1^B10894461^B7230667
"RTN","MPIFA24B",1,0)
MPIFA24B ;BP/CMC-BUILD A24 ADD ME MSGS ;JULY 22, 2002
"RTN","MPIFA24B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,28,31,25,43,44**;30 Apr 99;Build 7
"RTN","MPIFA24B",3,0)
 ;
"RTN","MPIFA24B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24B",7,0)
 ;
"RTN","MPIFA24B",8,0)
A24(DFN,PID2) ;BUILD AND SEND A24 **43 added PID2 as a parameter - not required.
"RTN","MPIFA24B",9,0)
 ; if PID2 is defined it will contain the previous ICN data, passed by reference
"RTN","MPIFA24B",10,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA24B",11,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA24B",12,0)
 S CNT=1
"RTN","MPIFA24B",13,0)
 D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIFA24B",14,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA24B",15,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24B",16,0)
 S ERR="",TCNT=0
"RTN","MPIFA24B",17,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A24",.ERR)
"RTN","MPIFA24B",18,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",19,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR)
"RTN","MPIFA24B",20,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",21,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA24B",22,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",23,0)
 I '$D(PID2) D BLDPID^VAFCQRY(DFN,2,"ALL",.PID2,.HL,.ERR) ;**43 TO ONLY BUILD 2ND PID SEGMENT IF NOT PASSED
"RTN","MPIFA24B",24,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",25,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA24B",26,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA24B",27,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",28,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA24B",29,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA24B",30,0)
 S CNT=0 F  S CNT=$O(PID2(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",31,0)
 .I CNT=1 S HLA("HLS",4)=PID2(CNT)
"RTN","MPIFA24B",32,0)
 .I CNT>1 S HLA("HLS",4,CNT-1)=PID2(CNT)
"RTN","MPIFA24B",33,0)
 S HLA("HLS",5)=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 Adding Pseudo SSN Reason, 1 and 21 to ZPD segment
"RTN","MPIFA24B",34,0)
 K HLL("LINKS")
"RTN","MPIFA24B",35,0)
 D GENERATE^HLMA("MPIF ADT-A24 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA24B",36,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA24B",37,0)
 I '+RESLT S ^XTMP("MPIFA24%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A24 message to MPI for DFN "_DFN,^XTMP("MPIFA24%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",38,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA24B",39,0)
 ;**44 TRIGGER A31 TO UPDATE ANY DEMOGRAPHIC CHANGES
"RTN","MPIFA24B",40,0)
 N A31 S A31=$$A31^MPIFA31B(DFN)
"RTN","MPIFA24B",41,0)
 I $P(A31,"^",2)'="" D
"RTN","MPIFA24B",42,0)
 .;log exception about A31 not being sent
"RTN","MPIFA24B",43,0)
 .D START^RGHLLOG()
"RTN","MPIFA24B",44,0)
 .D EXC^RGHLLOG(208,$P(A31,"^",2,3),"Unable to generate A31 for DFN"_DFN,DFN)
"RTN","MPIFA24B",45,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFA24B",46,0)
 I $P(A31,"^",2)="" S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A31 message to MPI for DFN "_DFN,^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",47,0)
 Q RESLT
"RTN","MPIFA24B",48,0)
 ;
"RTN","MPIFA24B",49,0)
RT ;
"RTN","MPIFA24B",50,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA24B",51,0)
 I $P($G(MPI),"^")=-1 D START^RGHLLOG(),EXC^RGHLLOG(224,"No logical link defined for the MPI",$G(DFN)),STOP^RGHLLOG() Q
"RTN","MPIFA24B",52,0)
 S HLL("LINKS",1)="MPIF ADT-A24 CLIENT^"_MPI
"RTN","MPIFA24B",53,0)
 Q
"RTN","MPIFA24B",54,0)
RES ;
"RTN","MPIFA24B",55,0)
 N NXT,DFN
"RTN","MPIFA24B",56,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24B",57,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24B",58,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24B",59,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION --**44 stopped logging exception as MPI has already logged it.
"RTN","MPIFA24B",60,0)
 ..;D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24B",61,0)
 ..;D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24B",62,0)
 ..;D STOP^RGHLLOG(0)
"RTN","MPIFA24B",63,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24B",64,0)
 Q
"RTN","MPIFA28")
0^2^B5089239^B4673412
"RTN","MPIFA28",1,0)
MPIFA28 ;BP/CMC-BUILD A28 ADD ME MSGS ;MARCH 4, 2002
"RTN","MPIFA28",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,31,25,35,44**;30 Apr 99;Build 7
"RTN","MPIFA28",3,0)
 ;
"RTN","MPIFA28",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA28",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA28",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA28",7,0)
 ;
"RTN","MPIFA28",8,0)
A28(DFN) ;BUILD AND SEND A28
"RTN","MPIFA28",9,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA28",10,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA28",11,0)
 S CNT=1
"RTN","MPIFA28",12,0)
 D INIT^HLFNC2("MPIF ADT-A28 SERVER",.HL)
"RTN","MPIFA28",13,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA28",14,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA28",15,0)
 S ERR="",TCNT=0
"RTN","MPIFA28",16,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A28",.ERR)
"RTN","MPIFA28",17,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",18,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR)
"RTN","MPIFA28",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",20,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA28",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",22,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA28",23,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA28",24,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA28",25,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA28",26,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA28",27,0)
 S HLA("HLS",4)=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 ADDED PSEUDO SSN REASON, 1 and 21 TO ZPD SEGMENT
"RTN","MPIFA28",28,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA28",29,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA28",30,0)
 S HLL("LINKS",1)="MPIF ADT-A28 CLIENT^"_MPI
"RTN","MPIFA28",31,0)
 D GENERATE^HLMA("MPIF ADT-A28 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA28",32,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA28",33,0)
 I +RESLT S ^XTMP("MPIFA28%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A28 message to MPI for DFN "_DFN,^XTMP("MPIFA28%"_DFN,"MPI",0)="A"
"RTN","MPIFA28",34,0)
 I $D(^DPT("AICNL",1,DFN)) D
"RTN","MPIFA28",35,0)
 .I $G(^DPT("AICNL",1,DFN))="" S ^DPT("AICNL",1,DFN)="2^"_DT
"RTN","MPIFA28",36,0)
 .; **35
"RTN","MPIFA28",37,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA28",38,0)
 Q RESLT
"RTN","MPIFA28",39,0)
 ;
"RTN","MPIFA28",40,0)
RES ;
"RTN","MPIFA28",41,0)
 N NXT,DFN
"RTN","MPIFA28",42,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA28",43,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA28",44,0)
 K ^XTMP("MPIFA28%"_DFN)
"RTN","MPIFA28",45,0)
 Q
"RTN","MPIFA31B")
0^3^B16253562^B6347929
"RTN","MPIFA31B",1,0)
MPIFA31B ;BP/CMC-BUILD A31 MSGS ;FEB 5, 2002
"RTN","MPIFA31B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24,27,28,31,25,44**;30 Apr 99;Build 7
"RTN","MPIFA31B",3,0)
 ;
"RTN","MPIFA31B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA31B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA31B",7,0)
 ;  $$PV1^VAFCSB, $$RADE^VAFCSB, $$LABE^VAFCSB, $$PHARA^VAFCSB, $$PV2^VAFCSB - #4921
"RTN","MPIFA31B",8,0)
TA31 ; Tasked entry point
"RTN","MPIFA31B",9,0)
 N TMP
"RTN","MPIFA31B",10,0)
 S TMP=$$A31(DFN)
"RTN","MPIFA31B",11,0)
 Q
"RTN","MPIFA31B",12,0)
 ;
"RTN","MPIFA31B",13,0)
A31(DFN) ;BUILD AND SEND A31
"RTN","MPIFA31B",14,0)
 I $P($$SITE^VASITE,"^",3)=200 Q 1
"RTN","MPIFA31B",15,0)
 ; ^ PATCH 25 IF this is the FHIE Host system, don't build A31 messages
"RTN","MPIFA31B",16,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID,EN,LAB,PV1,PV2,RAD,PRE,ZPD
"RTN","MPIFA31B",17,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA31B",18,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3) 0
"RTN","MPIFA31B",19,0)
 ; ^ LOCAL ICN DON'T SEND
"RTN","MPIFA31B",20,0)
 Q:+$$GETICN^MPIF001(DFN)=-1 0
"RTN","MPIFA31B",21,0)
 ; ^ NO ICN DON'T SEND
"RTN","MPIFA31B",22,0)
 S CNT=1
"RTN","MPIFA31B",23,0)
 D INIT^HLFNC2("MPIF ADT-A31 SERVER",.HL)
"RTN","MPIFA31B",24,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA31B",25,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA31B",26,0)
 S ERR="",TCNT=0
"RTN","MPIFA31B",27,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A31",.ERR)
"RTN","MPIFA31B",28,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",29,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR) ;**25
"RTN","MPIFA31B",30,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",31,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR) ;**44 NEW PD1 SEGMENT VALUES -- SENDING CMOR AGAIN AS WITHOUT 40 ON THE MPI SIDE THIS IS A PROBLEM.
"RTN","MPIFA31B",32,0)
 ;S PD1=$$PD1^VAFCSB ;**44 NEW PD1 SEGMENT VALUES -- IMDQ DECIDED NOT TO SEND PREFERRED FACILITY 9/7/06
"RTN","MPIFA31B",33,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") I $T D
"RTN","MPIFA31B",34,0)
 .;**44 VAFCSB coming in with DG*5.3*707
"RTN","MPIFA31B",35,0)
 .S PV1=$$PV1^VAFCSB ;**44 PV1 segment
"RTN","MPIFA31B",36,0)
 .S RAD=$$RADE^VAFCSB ;**44 OBX FOR LAST RADIOLOGY EXAM
"RTN","MPIFA31B",37,0)
 .S LAB=$$LABE^VAFCSB ;**44 OBX FOR LAST LAB EXAM
"RTN","MPIFA31B",38,0)
 .S PRE=$$PHARA^VAFCSB ;**44 OBX FOR ACTIVE PRESCRIPTIONS
"RTN","MPIFA31B",39,0)
 .S PV2=$$PV2^VAFCSB ;**44 PV2 segment
"RTN","MPIFA31B",40,0)
 S ZPD=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 ADDED PSEUDO SSN REASON (34), 1 and 21 TO ZPD SEGMENT
"RTN","MPIFA31B",41,0)
 S EN=1
"RTN","MPIFA31B",42,0)
 S HLA("HLS",EN)=EVN(1),EN=EN+1
"RTN","MPIFA31B",43,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA31B",44,0)
 .I CNT=1 S HLA("HLS",EN)=PID(CNT)
"RTN","MPIFA31B",45,0)
 .I CNT>1 S HLA("HLS",EN,CNT-1)=PID(CNT)
"RTN","MPIFA31B",46,0)
 S EN=EN+1
"RTN","MPIFA31B",47,0)
 I $G(PD1(1))'="" S HLA("HLS",EN)=PD1(1),EN=EN+1 ;**44 only pass PD1 segment if has values -- SENDING CMOR AGAIN AS WITHOUT 40 ON MPI SIDE THIS IS A PROBLEM.
"RTN","MPIFA31B",48,0)
 I $G(PV1)'="" S HLA("HLS",EN)=PV1,EN=EN+1 ;**44 only pass PV1 segment if has values
"RTN","MPIFA31B",49,0)
 I $G(PV2)'="" S HLA("HLS",EN)=PV2,EN=EN+1 ;**44 only pass PV2 segment if has values
"RTN","MPIFA31B",50,0)
 I $G(RAD)'="" S HLA("HLS",EN)=RAD,EN=EN+1 ;**44 only pass RADIOLOGY IN OBX segment if has values
"RTN","MPIFA31B",51,0)
 I $G(LAB)'="" S HLA("HLS",EN)=LAB,EN=EN+1 ;**44 only pass LAB IN OBX segment if has values
"RTN","MPIFA31B",52,0)
 I $G(PRE)'="" S HLA("HLS",EN)=PRE,EN=EN+1 ;**44 only pass PRESCRIPTION IN OBX segment if has values
"RTN","MPIFA31B",53,0)
 S HLA("HLS",EN)=ZPD,EN=EN+1 ;**44 ZPD SEGMENT
"RTN","MPIFA31B",54,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA31B",55,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA31B",56,0)
 S HLL("LINKS",1)="MPIF ADT-A31 CLIENT^"_MPI
"RTN","MPIFA31B",57,0)
 D GENERATE^HLMA("MPIF ADT-A31 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA31B",58,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA31B",59,0)
 S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA31 msg to MPI for DFN "_DFN
"RTN","MPIFA31B",60,0)
 I '+RESLT S ^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA31B",61,0)
 K HLA,HLL("LINKS"),COMP,REP,SUBCOMP,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA31B",62,0)
 ;**44 REMOVED HLEID, HLECH AND HLFS from Kill line above
"RTN","MPIFA31B",63,0)
 Q RESLT
"RTN","MPIFA31B",64,0)
 ;
"RTN","MPIFA31B",65,0)
RES ;
"RTN","MPIFA31B",66,0)
 N NXT,DFN,ERROR
"RTN","MPIFA31B",67,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA31B",68,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2),ERROR=$P(HLNODE,HL("FS"),4)
"RTN","MPIFA31B",69,0)
 .I $E(HLNODE,1,3)="MSA"&($G(ERROR)'="") D
"RTN","MPIFA31B",70,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA31B",71,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA31B",72,0)
 ..;**44 check which type of exception to be logged
"RTN","MPIFA31B",73,0)
 ..I ERROR["Rejected" D EXC^RGHLLOG(234,ERROR_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA31B",74,0)
 ..;I ERROR'["Rejected" D EXC^RGHLLOG(208,ERROR_" for HL msg# "_HLMTIEN,DFN) NO EXCEPTION NEEDS TO BE LOGGED
"RTN","MPIFA31B",75,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA31B",76,0)
 K ^XTMP("MPIFA31%"_DFN)
"RTN","MPIFA31B",77,0)
 Q
"RTN","MPIFAPI")
0^4^B47331120^B31723970
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14,16,17,21,27,28,33,35,37,43,45,44**;30 Apr 99;Build 7
"RTN","MPIFAPI",3,0)
 ; Integration Agreements Utilized:
"RTN","MPIFAPI",4,0)
 ;   ^DPT( - #2070 and #4079
"RTN","MPIFAPI",5,0)
 ;   ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFAPI",6,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFAPI",7,0)
 ;
"RTN","MPIFAPI",8,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",9,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",10,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",11,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",12,0)
 S MPINUM=0,X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",13,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",14,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",15,0)
 S MPINUM=MPINUM1_"V"_MPICHK,MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",16,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",17,0)
 D ^DIE
"RTN","MPIFAPI",18,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",19,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",20,0)
 Q MPINUM
"RTN","MPIFAPI",21,0)
SETUP ;
"RTN","MPIFAPI",22,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",23,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",24,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",25,0)
 S NUM=SITE_"0000000",CHK=$$CHECKDG^MPIFSPC(NUM),MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",26,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",27,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",28,0)
 K DD,D0
"RTN","MPIFAPI",29,0)
 D FILE^DICN
"RTN","MPIFAPI",30,0)
 K DIC,X,Y
"RTN","MPIFAPI",31,0)
 Q MPINUM
"RTN","MPIFAPI",32,0)
 ;
"RTN","MPIFAPI",33,0)
MPILINK() ;returns MPI logical Link
"RTN","MPIFAPI",34,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",35,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",36,0)
 I '$D(MPIL) Q "-1^NOT DEFINED"
"RTN","MPIFAPI",37,0)
 S MPILINK=$O(MPIL(0))
"RTN","MPIFAPI",38,0)
 I MPILINK="" Q "-1^NOT DEFINED"
"RTN","MPIFAPI",39,0)
 S MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",40,0)
 Q MPILINK
"RTN","MPIFAPI",41,0)
 ;
"RTN","MPIFAPI",42,0)
SUBNUM(DFN) ; returns SCN from MPI node for given DFN
"RTN","MPIFAPI",43,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",44,0)
 ; returns:  -1^error message << always returns.
"RTN","MPIFAPI",45,0)
 ;*** Subscription control numbers no longer exist
"RTN","MPIFAPI",46,0)
 Q "-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",47,0)
 ;
"RTN","MPIFAPI",48,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",49,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",50,0)
 ; returns:  -1^error message or MPI node from patient file
"RTN","MPIFAPI",51,0)
 N TMP
"RTN","MPIFAPI",52,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",53,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",54,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",55,0)
 L +^DPT("MPI",DFN):10 ;**45 added lock check for getting ICN data back
"RTN","MPIFAPI",56,0)
 N NODE S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",57,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",58,0)
 I +NODE>0 D
"RTN","MPIFAPI",59,0)
 .;**45 checking if checksum for ICN is correct, if not update the 991.02 field
"RTN","MPIFAPI",60,0)
 .; and include new value in NODE returned.
"RTN","MPIFAPI",61,0)
 .N CHK S CHK=$$CHECKDG^MPIFSPC($P(NODE,"^"))
"RTN","MPIFAPI",62,0)
 .I CHK'=$P(NODE,"^",2) S TMP=$$SETICN^MPIF001(DFN,$P(NODE,"^"),CHK) S $P(NODE,"^",2)=CHK
"RTN","MPIFAPI",63,0)
 L -^DPT("MPI",DFN)
"RTN","MPIFAPI",64,0)
 Q NODE
"RTN","MPIFAPI",65,0)
 ;
"RTN","MPIFAPI",66,0)
GETADFN(ICN) ; return DFN ONLY if ICN is the active ICN
"RTN","MPIFAPI",67,0)
 ; ICN - Integration Control Number for patient to be returned
"RTN","MPIFAPI",68,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",69,0)
 ;           DFN - IEN for the patient entry in the Patient file (#2)
"RTN","MPIFAPI",70,0)
 N RETURN,DFN
"RTN","MPIFAPI",71,0)
 I $G(ICN)'>0 Q "-1^NO ICN"
"RTN","MPIFAPI",72,0)
 I '$D(^DPT("AICN",ICN)) Q "-1^ICN NOT IN DATABASE"
"RTN","MPIFAPI",73,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIFAPI",74,0)
 I $G(DFN)'>0 Q "-1^BAD AICN CROSS-REFERENCE"
"RTN","MPIFAPI",75,0)
 I $P($G(^DPT(DFN,"MPI")),"^")'=ICN Q "-1^ICN is not Active one"
"RTN","MPIFAPI",76,0)
 Q DFN
"RTN","MPIFAPI",77,0)
 ;
"RTN","MPIFAPI",78,0)
UPDATE(DFN,ARR,MPISILNT,REMOVE) ;api to edit 'mpi','mpifhis' and 'mpicmor' nodes
"RTN","MPIFAPI",79,0)
 ;**37 UPDATE module moved 3/30/05 from MPIFAPI into MPIFAPI1.
"RTN","MPIFAPI",80,0)
 ;Linetag must remain due to DBIA #2706.
"RTN","MPIFAPI",81,0)
 Q $$UPDATE^MPIFAPI1(DFN,ARR,.MPISILNT,.REMOVE)
"RTN","MPIFAPI",82,0)
 ;
"RTN","MPIFAPI",83,0)
MPIQ(DFN) ;MPI QUERY
"RTN","MPIFAPI",84,0)
 N MPIFARR
"RTN","MPIFAPI",85,0)
 L +^DPT(DFN):2 I '$T,'$D(MPIFS) W $C(7),!!,"Patient is being edited. No attempt will be made to connect to the MPI." H 2 Q
"RTN","MPIFAPI",86,0)
 I '$D(MPIFS) D  ;Not from SmartCard background job
"RTN","MPIFAPI",87,0)
 .;**37 mods to L -^DPT
"RTN","MPIFAPI",88,0)
 .I $G(DGNEW)=1 D  ;New patient, fields always blank, ask
"RTN","MPIFAPI",89,0)
 ..D WRTLN
"RTN","MPIFAPI",90,0)
 ..; **44 Adding Pseudo SSN Reason to the list of prompted fields if SSN is a pseudo and there isn't already a reason stored
"RTN","MPIFAPI",91,0)
 ..N MPIFP S MPIFP="" S DA=DFN,DIQ(0)="EI",DIC=2,DR=".09;.0906",DIQ="MPIFARR" D EN^DIQ1 K DA,DR,DIC,DQ,DR
"RTN","MPIFAPI",92,0)
 ..I $D(MPIFARR(2,DFN,.0906,"I")) D
"RTN","MPIFAPI",93,0)
 ...I MPIFARR(2,DFN,.09,"E")["P",("S"[MPIFARR(2,DFN,.0906,"I")) S MPIFP=".0906;"
"RTN","MPIFAPI",94,0)
 ...S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",95,0)
 ...S DR=MPIFP_".2403;.092;.093;1",DR(2,2.01)=".01" D ^DIE K DA,DIE,DR Q
"RTN","MPIFAPI",96,0)
 .I $G(DGNEW)="" D  ;Existing patient, get current values
"RTN","MPIFAPI",97,0)
 ..N MPIDOB,IMPRS,MPIMMN,MPICTY,MPIST
"RTN","MPIFAPI",98,0)
 ..S DIC=2,DR=".02;.03;.09;.0906;.092;.093;.2403;994;1",DR(2.01)=".01" ;**44 include pseudo ssn reason to list
"RTN","MPIFAPI",99,0)
 ..S DA=DFN,DA(2.01)=1,DIQ(0)="EI",DIQ="MPIFARR"
"RTN","MPIFAPI",100,0)
 ..D EN^DIQ1 K DA,DIC,DIQ,DR
"RTN","MPIFAPI",101,0)
 ..;build DR from blank fields / imprecise DOB / pseudo SSN
"RTN","MPIFAPI",102,0)
 ..S DR=""
"RTN","MPIFAPI",103,0)
 ..S MPIDOB=$G(MPIFARR(2,DFN,.03,"I")) ;DATE OF BIRTH
"RTN","MPIFAPI",104,0)
 ..I MPIDOB="" S DR=DR_".03;" ;DOB null
"RTN","MPIFAPI",105,0)
 ..;Is DOB imprecise?
"RTN","MPIFAPI",106,0)
 ..I MPIDOB'="" S IMPRS=0 D
"RTN","MPIFAPI",107,0)
 ...I $E(MPIDOB,4,7)="0000" S IMPRS=1 ;Year only; no month/day
"RTN","MPIFAPI",108,0)
 ...I ($E(MPIDOB,6,7)="00")&($E(MPIDOB,4,5)'="00") S IMPRS=1 ;Year/month only; no day
"RTN","MPIFAPI",109,0)
 ...I IMPRS=1 S DR=DR_".03;" ;DOB imprecise
"RTN","MPIFAPI",110,0)
 ..I $G(MPIFARR(2,DFN,.02,"I"))="" S DR=DR_".02;" ;SEX
"RTN","MPIFAPI",111,0)
 ..;if the SSN is null, add to prompted fields
"RTN","MPIFAPI",112,0)
 ..N SSNP S SSNP=0
"RTN","MPIFAPI",113,0)
 ..I ($G(MPIFARR(2,DFN,.09,"E"))="") S DR=DR_".09;",SSNP=1 ;SSN
"RTN","MPIFAPI",114,0)
 ..I DR'="" D
"RTN","MPIFAPI",115,0)
 ...D WRTLN
"RTN","MPIFAPI",116,0)
 ...S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",117,0)
 ...D ^DIE K DA,DIE,DR,DIC,DIQ
"RTN","MPIFAPI",118,0)
 ...;if SSN was prompted then reinitialize SSN ARRAY variable
"RTN","MPIFAPI",119,0)
 ...I SSNP=1 S MPIFARR(2,DFN,.09,"E")="" S DIC=2,DR=".09" S DA=DFN,DA(2.01)=1,DIQ(0)="E",DIQ="MPIFARR" D EN^DIQ1 K DA,DIC,DIQ,DR
"RTN","MPIFAPI",120,0)
 ...;**44 if the PSEUDO SSN REASON field exist
"RTN","MPIFAPI",121,0)
 ..S DR="" ;reset DR to null to be able to concatenate the fields together since DR was just killed above
"RTN","MPIFAPI",122,0)
 ..I $D(MPIFARR(2,DFN,.0906,"I")) D
"RTN","MPIFAPI",123,0)
 ...;check to see if the SSN is a PSEUDO and the PSEUDO SSN REASON is null or "S" (FOLLOW-UP REQUIRED), if so add PSEUDO SSN REASON to the prompted fields
"RTN","MPIFAPI",124,0)
 ...I MPIFARR(2,DFN,.09,"E")["P",("S"[MPIFARR(2,DFN,.0906,"I")) S DR="" S:SSNP=0 DR=".09;" S DR=DR_".0906;"
"RTN","MPIFAPI",125,0)
 ..I $G(MPIFARR(2,DFN,994,"I"))="" S DR=DR_"994;" ;MULTIPLE BIRTH INDICATOR
"RTN","MPIFAPI",126,0)
 ..S MPIMMN=$G(MPIFARR(2,DFN,.2403,"E")) ;MOTHER'S MAIDEN NAME
"RTN","MPIFAPI",127,0)
 ..I $$VALDT(MPIMMN) S DR=DR_".2403;" ;Validate MMN value
"RTN","MPIFAPI",128,0)
 ..S MPICTY=$G(MPIFARR(2,DFN,.092,"E")) ;PLACE OF BIRTH [CITY]
"RTN","MPIFAPI",129,0)
 ..S MPIST=$G(MPIFARR(2,DFN,.093,"E")) ;PLACE OF BIRTH [STATE]
"RTN","MPIFAPI",130,0)
 ..I $S($$VALDT(MPICTY):1,$$VALDT(MPIST):1,1:0) S DR=DR_".092;.093;" ;Validate POB [CITY] & [STATE] value
"RTN","MPIFAPI",131,0)
 ..I $G(MPIFARR(2.01,1,.01,"E"))="" S DR=DR_"1",DR(2,2.01)=".01;1" ;ALIAS **44 ADDING ALIAS SSN TO FIELDS
"RTN","MPIFAPI",132,0)
 ..I DR'="" D
"RTN","MPIFAPI",133,0)
 ...D WRTLN
"RTN","MPIFAPI",134,0)
 ...S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",135,0)
 ...D ^DIE K DA,DIE,DR,DIC,DIQ
"RTN","MPIFAPI",136,0)
 L -^DPT(DFN)
"RTN","MPIFAPI",137,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFAPI",138,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",139,0)
 ;**43 No longer get list of potential matches to pick from
"RTN","MPIFAPI",140,0)
 ;I $G(MPIFRTN)="" D
"RTN","MPIFAPI",141,0)
 ;. ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",142,0)
 ;. \/ setup Local ICN and proceed
"RTN","MPIFAPI",143,0)
 ;.N ICN,ERR
"RTN","MPIFAPI",144,0)
 ;.S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",145,0)
 ;.Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",146,0)
 ;.S ERR=$$SETICN^MPIF001(DFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",147,0)
 ;.Q:+ERR=-1
"RTN","MPIFAPI",148,0)
 ;. ^ couldn't set ICN don't set other fields
"RTN","MPIFAPI",149,0)
 ;.S ERR=$$SETLOC^MPIF001(DFN,1),ERR=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",150,0)
 K MPIFRTN,ZTREQ
"RTN","MPIFAPI",151,0)
 Q
"RTN","MPIFAPI",152,0)
 ;
"RTN","MPIFAPI",153,0)
MPIQQ(PDFN) ; Entry point for queuing d/c
"RTN","MPIFAPI",154,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",155,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",156,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",157,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",158,0)
 S ZTSAVE("PDFN")=PDFN,ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",159,0)
 ; ^ silent flag
"RTN","MPIFAPI",160,0)
 S ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",161,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",162,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFAPI",163,0)
 N TSK S TSK=ZTSK
"RTN","MPIFAPI",164,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",165,0)
 Q TSK
"RTN","MPIFAPI",166,0)
 ;
"RTN","MPIFAPI",167,0)
WRTLN ;**37 Write intro text ONLY if there are fields to ask
"RTN","MPIFAPI",168,0)
 W !!,"Please verify or update the following information:",!
"RTN","MPIFAPI",169,0)
 Q
"RTN","MPIFAPI",170,0)
 ;
"RTN","MPIFAPI",171,0)
VALDT(VAL) ;**37 Validate value passed in.
"RTN","MPIFAPI",172,0)
 ;Prompt if field contains invalid data (e.g., UNKNOWN, NOT KNOWN, etc.)
"RTN","MPIFAPI",173,0)
 ;Returns 0 if not found
"RTN","MPIFAPI",174,0)
 ;Returns 1 if found
"RTN","MPIFAPI",175,0)
 I VAL="" Q 1
"RTN","MPIFAPI",176,0)
 I $E($$UP^XLFSTR(VAL),1,3)="UNK" Q 1
"RTN","MPIFAPI",177,0)
 I $E($$UP^XLFSTR(VAL),1,4)="NONE" Q 1
"RTN","MPIFAPI",178,0)
 I $E($$UP^XLFSTR(VAL),1,4)="NOT " Q 1
"RTN","MPIFAPI",179,0)
 I $$UP^XLFSTR(VAL)["UNAVAILABLE" Q 1
"RTN","MPIFAPI",180,0)
 I $$UP^XLFSTR(VAL)["DECEASED" Q 1
"RTN","MPIFAPI",181,0)
 I $E($$UP^XLFSTR(VAL),1,2)="DC" Q 1
"RTN","MPIFAPI",182,0)
 Q 0
"RTN","MPIFAPI",183,0)
 ;
"VER")
8.0^22.0
"BLD",2350,6)
^43
**END**
**END**
