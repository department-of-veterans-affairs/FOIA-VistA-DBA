Released DG*5.3*625 SEQ #537
Extracted from mail message
**KIDS**:DG*5.3*625^

**INSTALL NAME**
DG*5.3*625
"BLD",5364,0)
DG*5.3*625^REGISTRATION^0^3041026^y
"BLD",5364,4,0)
^9.64PA^^
"BLD",5364,"ABPKG")
n
"BLD",5364,"INIT")
ADDMGRP^DG53625P
"BLD",5364,"KRN",0)
^9.67PA^8989.52^19
"BLD",5364,"KRN",.4,0)
.4
"BLD",5364,"KRN",.401,0)
.401
"BLD",5364,"KRN",.402,0)
.402
"BLD",5364,"KRN",.403,0)
.403
"BLD",5364,"KRN",.5,0)
.5
"BLD",5364,"KRN",.84,0)
.84
"BLD",5364,"KRN",3.6,0)
3.6
"BLD",5364,"KRN",3.8,0)
3.8
"BLD",5364,"KRN",9.2,0)
9.2
"BLD",5364,"KRN",9.8,0)
9.8
"BLD",5364,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5364,"KRN",9.8,"NM",1,0)
DGENUPL4^^0^B65181451
"BLD",5364,"KRN",9.8,"NM",2,0)
DGENUPLB^^0^B11114623
"BLD",5364,"KRN",9.8,"NM","B","DGENUPL4",1)

"BLD",5364,"KRN",9.8,"NM","B","DGENUPLB",2)

"BLD",5364,"KRN",19,0)
19
"BLD",5364,"KRN",19.1,0)
19.1
"BLD",5364,"KRN",101,0)
101
"BLD",5364,"KRN",409.61,0)
409.61
"BLD",5364,"KRN",771,0)
771
"BLD",5364,"KRN",870,0)
870
"BLD",5364,"KRN",8989.51,0)
8989.51
"BLD",5364,"KRN",8989.52,0)
8989.52
"BLD",5364,"KRN",8994,0)
8994
"BLD",5364,"KRN","B",.4,.4)

"BLD",5364,"KRN","B",.401,.401)

"BLD",5364,"KRN","B",.402,.402)

"BLD",5364,"KRN","B",.403,.403)

"BLD",5364,"KRN","B",.5,.5)

"BLD",5364,"KRN","B",.84,.84)

"BLD",5364,"KRN","B",3.6,3.6)

"BLD",5364,"KRN","B",3.8,3.8)

"BLD",5364,"KRN","B",9.2,9.2)

"BLD",5364,"KRN","B",9.8,9.8)

"BLD",5364,"KRN","B",19,19)

"BLD",5364,"KRN","B",19.1,19.1)

"BLD",5364,"KRN","B",101,101)

"BLD",5364,"KRN","B",409.61,409.61)

"BLD",5364,"KRN","B",771,771)

"BLD",5364,"KRN","B",870,870)

"BLD",5364,"KRN","B",8989.51,8989.51)

"BLD",5364,"KRN","B",8989.52,8989.52)

"BLD",5364,"KRN","B",8994,8994)

"BLD",5364,"QUES",0)
^9.62^^
"BLD",5364,"REQB",0)
^9.611^1^1
"BLD",5364,"REQB",1,0)
DG*5.3*451^2
"BLD",5364,"REQB","B","DG*5.3*451",1)

"INIT")
ADDMGRP^DG53625P
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
625^3041026
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","DG53625P")
0^^B2549458
"RTN","DG53625P",1,0)
DG53625P ;TDM - Patch DG*5.3*625 Install Utility Routine ; 10/19/04 10:40am
"RTN","DG53625P",2,0)
 ;;5.3;Registration;**625**; Aug 13,1993
"RTN","DG53625P",3,0)
 ;
"RTN","DG53625P",4,0)
 Q
"RTN","DG53625P",5,0)
ADDMGRP ;Check for IB MEANS TEST mail group and add if not already there.
"RTN","DG53625P",6,0)
 N MGRP,WPARY,FDA,ERR
"RTN","DG53625P",7,0)
 S MGRP="IB MEANS TEST"
"RTN","DG53625P",8,0)
 ;
"RTN","DG53625P",9,0)
 D BMES^XPDUTL("Add '"_MGRP_"' mail group.")
"RTN","DG53625P",10,0)
 K FDA,ERR
"RTN","DG53625P",11,0)
 I $$FIND1^DIC(3.8,"","X",MGRP) D BMES^XPDUTL("'"_MGRP_"' entry already exists!") Q
"RTN","DG53625P",12,0)
 S WPARY(1,0)="This mail group will receive Means Test error messages from integrated billing."
"RTN","DG53625P",13,0)
 S WPARY(2,0)="errors and the editing/deletion of records which are associated with"
"RTN","DG53625P",14,0)
 S WPARY(3,0)="Means Test/Category C billing."
"RTN","DG53625P",15,0)
 ;
"RTN","DG53625P",16,0)
 S FDA(3.8,"+1,",.01)=MGRP
"RTN","DG53625P",17,0)
 S FDA(3.8,"+1,",3)="WPARY"
"RTN","DG53625P",18,0)
 S FDA(3.8,"+1,",4)="PU"
"RTN","DG53625P",19,0)
 S FDA(3.8,"+1,",5)=.5
"RTN","DG53625P",20,0)
 ;
"RTN","DG53625P",21,0)
 D UPDATE^DIE("","FDA","","ERR")
"RTN","DG53625P",22,0)
 I $D(ERR) D BMES^XPDUTL(MGRP_" not added!  ERROR:"),MES^XPDUTL(ERR("DIERR",1)_": "_ERR("DIERR",1,"TEXT",1)) Q
"RTN","DG53625P",23,0)
 D MES^XPDUTL("'"_MGRP_"' successfully added.")
"RTN","DG53625P",24,0)
 Q
"RTN","DGENUPL4")
0^1^B65181451
"RTN","DGENUPL4",1,0)
DGENUPL4 ;ALB/CJM,RTK,ISA/KWP,ISD/GSN,PHH,RGL,PJR,BRM,TDM - PROCESS INCOMING (Z11 EVENT TYPE) HL7 MESSAGES ; 10/8/04 3:18pm
"RTN","DGENUPL4",2,0)
 ;;5.3;REGISTRATION;**147,177,232,253,327,367,377,514,451,625**;Aug 13,1993
"RTN","DGENUPL4",3,0)
 ;
"RTN","DGENUPL4",4,0)
UOBJECTS(DFN,DGPAT,DGELG,DGCDIS,MSGID,ERRCOUNT,MSGS,OLDPAT,OLDELG,OLDCDIS) ;
"RTN","DGENUPL4",5,0)
 ;Description: Used to update the PATIENT, ELIGIBILITY, and CATASTROPHIC
"RTN","DGENUPL4",6,0)
 ;DISABILITY objects 'in memory'.
"RTN","DGENUPL4",7,0)
 ;
"RTN","DGENUPL4",8,0)
 ;Input:
"RTN","DGENUPL4",9,0)
 ;  DFN - ien of record in the PATIENT file
"RTN","DGENUPL4",10,0)
 ;  DGPAT - PATIENT object array (pass by reference)
"RTN","DGENUPL4",11,0)
 ;  DGELG - ELIGIBILITY object array (pass by reference)
"RTN","DGENUPL4",12,0)
 ;  DGCDIS - CATASTROPHIC DISABILITY object array (pass by reference)
"RTN","DGENUPL4",13,0)
 ;  MSGID - message control id of the HL7 message being processed
"RTN","DGENUPL4",14,0)
 ;  ERRCOUNT - count of errors (pass by reference)
"RTN","DGENUPL4",15,0)
 ;  MSGS - array of messages for the site (pass by reference)
"RTN","DGENUPL4",16,0)
 ;
"RTN","DGENUPL4",17,0)
 ;Output:
"RTN","DGENUPL4",18,0)
 ;  Function Value: 1 if the update was successful 'in memory',
"RTN","DGENUPL4",19,0)
 ;           consistency checks pass and the objects can be stored in
"RTN","DGENUPL4",20,0)
 ;           the local database, 0 otherwise.
"RTN","DGENUPL4",21,0)
 ;  DGPAT - PATIENT object array (pass by reference)
"RTN","DGENUPL4",22,0)
 ;  DGELG - ELIGIBILITY object array (pass by reference)
"RTN","DGENUPL4",23,0)
 ;  DGCDIS - CATASTROPHIC DISABILITY object array (pass by reference)
"RTN","DGENUPL4",24,0)
 ;  ERRCOUNT - count of errors (pass by reference)
"RTN","DGENUPL4",25,0)
 ;  MSGS - array of messages for the site (pass by reference)
"RTN","DGENUPL4",26,0)
 ;  OLDPAT - patient object array as it currently exists in database before the update (pass by reference)
"RTN","DGENUPL4",27,0)
 ;  OLDELG - eligibility object array as it currently exists in database before the update (pass by reference)
"RTN","DGENUPL4",28,0)
 ;  OLDCDIS - catastrophically disability object array as it currently exists in database before the update (pass by reference)
"RTN","DGENUPL4",29,0)
 ;
"RTN","DGENUPL4",30,0)
 N DGPAT3,DGELG3,DGCDIS3,SUCCESS
"RTN","DGENUPL4",31,0)
 S SUCCESS=1
"RTN","DGENUPL4",32,0)
 D
"RTN","DGENUPL4",33,0)
 .;first get the local site's current data
"RTN","DGENUPL4",34,0)
 .I ('$$GET^DGENPTA(DFN,.OLDPAT))!('$$GET^DGENELA(DFN,.OLDELG))!('$$GET^DGENCDA(DFN,.OLDCDIS)) D  Q
"RTN","DGENUPL4",35,0)
 ..D ADDERROR^DGENUPL(MSGID,DGPAT("SSN"),"UNABLE TO ACCESS PATIENT RECORD",.ERRCOUNT)
"RTN","DGENUPL4",36,0)
 ..S SUCCESS=0
"RTN","DGENUPL4",37,0)
 .;
"RTN","DGENUPL4",38,0)
 .;Phase II CD Consistency Checks (SRS 6.5.1.4) check VISTA against HEC
"RTN","DGENUPL4",39,0)
 .S SUCCESS=$$CDCHECK^DGENUPL9()
"RTN","DGENUPL4",40,0)
 .Q:'SUCCESS
"RTN","DGENUPL4",41,0)
 .;
"RTN","DGENUPL4",42,0)
 .;now merge with the update
"RTN","DGENUPL4",43,0)
 .D MERGE
"RTN","DGENUPL4",44,0)
 .;
"RTN","DGENUPL4",45,0)
 .;add the assumed values
"RTN","DGENUPL4",46,0)
 .D ADD
"RTN","DGENUPL4",47,0)
 .;
"RTN","DGENUPL4",48,0)
 .;now do the consistency checks
"RTN","DGENUPL4",49,0)
 .S SUCCESS=$$CHECK()
"RTN","DGENUPL4",50,0)
 .Q:'SUCCESS
"RTN","DGENUPL4",51,0)
 .;
"RTN","DGENUPL4",52,0)
 .;replace input arrays with fully updated versions
"RTN","DGENUPL4",53,0)
 .K DGPAT M DGPAT=DGPAT3
"RTN","DGENUPL4",54,0)
 .K DGELG M DGELG=DGELG3
"RTN","DGENUPL4",55,0)
 .K DGCDIS M DGCDIS=DGCDIS3
"RTN","DGENUPL4",56,0)
 ;
"RTN","DGENUPL4",57,0)
 I SUCCESS D
"RTN","DGENUPL4",58,0)
 .;
"RTN","DGENUPL4",59,0)
 .;list of required notifications
"RTN","DGENUPL4",60,0)
 .;
"RTN","DGENUPL4",61,0)
 .;change in date of death
"RTN","DGENUPL4",62,0)
 .I DGPAT("DEATH"),$P(OLDPAT("DEATH"),".")'=$P(DGPAT("DEATH"),".") D
"RTN","DGENUPL4",63,0)
 ..D ADDMSG^DGENUPL3(.MSGS,"HEC SHOWS DATE OF DEATH = "_$$FMTE^XLFDT(DGPAT("DEATH"),"1"),1)
"RTN","DGENUPL4",64,0)
 ..D ADDMSG^DGENUPL3(.MSGS,$S('OLDPAT("DEATH"):"SITE DOES NOT HAVE DATE OF DEATH",1:"SITE HAS DATE OF DEATH = "_$$FMTE^XLFDT(OLDPAT("DEATH"),"1")),1)
"RTN","DGENUPL4",65,0)
 .;
"RTN","DGENUPL4",66,0)
 .I OLDPAT("DEATH"),'DGPAT("DEATH") D
"RTN","DGENUPL4",67,0)
 ..D ADDMSG^DGENUPL3(.MSGS,"HEC SHOWS NO DATE OF DEATH",1)
"RTN","DGENUPL4",68,0)
 ..D ADDMSG^DGENUPL3(.MSGS,"SITE HAS DATE OF DEATH = "_$$FMTE^XLFDT(OLDPAT("DEATH"),"1"),1)
"RTN","DGENUPL4",69,0)
 .;
"RTN","DGENUPL4",70,0)
 .;change in POW
"RTN","DGENUPL4",71,0)
 .I OLDELG("POW")="N",DGELG("POW")="Y" D ADDMSG^DGENUPL3(.MSGS,"POW STATUS CHANGED TO YES")
"RTN","DGENUPL4",72,0)
 .I OLDELG("POW")="Y",DGELG("POW")="N" D ADDMSG^DGENUPL3(.MSGS,"POW STATUS CHANGED TO NO")
"RTN","DGENUPL4",73,0)
 .;
"RTN","DGENUPL4",74,0)
 .;SC to NSC
"RTN","DGENUPL4",75,0)
 .I OLDELG("SC")="Y",DGELG("SC")="N" D ADDMSG^DGENUPL3(.MSGS,"VETERAN CHANGED TO NON-SERVICE CONNECTED",1)
"RTN","DGENUPL4",76,0)
 .;
"RTN","DGENUPL4",77,0)
 .; Change from Eligible to Ineligible
"RTN","DGENUPL4",78,0)
 .I 'OLDPAT("INELDATE"),DGPAT("INELDATE") D ADDMSG^DGENUPL3(.MSGS,"VETERAN PREVIOUSLY ELIGIBLE FOR VA HEALTH CARE, NOW INELIGIBLE.",1)
"RTN","DGENUPL4",79,0)
 .;
"RTN","DGENUPL4",80,0)
 .; Check for erroneous CD deletion
"RTN","DGENUPL4",81,0)
 .I OLDCDIS("VCD")="","@"[DGCDIS("VCD") Q  ;no notification is needed
"RTN","DGENUPL4",82,0)
 .;
"RTN","DGENUPL4",83,0)
 .; CD Determination Changed
"RTN","DGENUPL4",84,0)
 .I OLDCDIS("VCD")'=DGCDIS("VCD") D ADDMSG^DGENUPL3(.MSGS,"VETERANS CD EVALUATION HAS CHANGED.")
"RTN","DGENUPL4",85,0)
 D EP^DGENUPLB
"RTN","DGENUPL4",86,0)
 Q SUCCESS
"RTN","DGENUPL4",87,0)
 ;
"RTN","DGENUPL4",88,0)
ADD ;
"RTN","DGENUPL4",89,0)
 ;Description: adds computed and assumed values to the updated objects
"RTN","DGENUPL4",90,0)
 ;
"RTN","DGENUPL4",91,0)
 ;Input: DGELG3(),DGPAT3() created in the UOBJECTS procedure.
"RTN","DGENUPL4",92,0)
 ;
"RTN","DGENUPL4",93,0)
 N SUB,TYPE,DATA
"RTN","DGENUPL4",94,0)
 S DGELG3("ELIGENTBY")=.5
"RTN","DGENUPL4",95,0)
 S SUB=0 F  S SUB=$O(DGELG3("RATEDIS",SUB)) Q:'SUB  S DGELG3("RATEDIS",SUB,"RDSC")=1
"RTN","DGENUPL4",96,0)
 ;
"RTN","DGENUPL4",97,0)
 ; Default Patient Types
"RTN","DGENUPL4",98,0)
 I DGELG3("SC")="N" S DGPAT3("VETERAN")="Y",DGPAT3("PATYPE")=$O(^DG(391,"B","NSC VETERAN",0))
"RTN","DGENUPL4",99,0)
 I DGELG3("SC")="Y" S DGPAT3("VETERAN")="Y",DGPAT3("PATYPE")=$O(^DG(391,"B","SC VETERAN",0))
"RTN","DGENUPL4",100,0)
 ;
"RTN","DGENUPL4",101,0)
 ; If Ineldate apply the business rules
"RTN","DGENUPL4",102,0)
 I DGPAT3("INELDATE"),DGELG3("SC")'="Y" D
"RTN","DGENUPL4",103,0)
 .S DGPAT3("VETERAN")="N",DGPAT3("PATYPE")=$O(^DG(391,"B","NON-VETERAN (OTHER)",0))
"RTN","DGENUPL4",104,0)
 .S DGELG3("POS")=$O(^DIC(21,"B","OTHER NON-VETERANS",0))
"RTN","DGENUPL4",105,0)
 ;
"RTN","DGENUPL4",106,0)
 ;update/set ELIGIBILITY VERIF. SOURCE field (Ineligible Project):
"RTN","DGENUPL4",107,0)
 I DGELG3("ELIGVERIF")["VIVA" S DATA(.3613)="H"
"RTN","DGENUPL4",108,0)
 E  S DATA(.3613)="V"
"RTN","DGENUPL4",109,0)
 ;
"RTN","DGENUPL4",110,0)
 ; File the data fields modified by Ineligible Business Rules
"RTN","DGENUPL4",111,0)
 I $$UPD^DGENDBS(2,DFN,.DATA,.ERROR)
"RTN","DGENUPL4",112,0)
 Q
"RTN","DGENUPL4",113,0)
 ;
"RTN","DGENUPL4",114,0)
MERGE ;
"RTN","DGENUPL4",115,0)
 ;Description: merges arrays with current patient data with the updates
"RTN","DGENUPL4",116,0)
 ; Merges DGPAT() + OLDPAT() -> DGPAT3()
"RTN","DGENUPL4",117,0)
 ;        DGELG() + OLDELG() -> DGELG3()
"RTN","DGENUPL4",118,0)
 ;        DGCDIS() + OLDCDIS() -> DGCDIS3()
"RTN","DGENUPL4",119,0)
 ;
"RTN","DGENUPL4",120,0)
 ;Input:
"RTN","DGENUPL4",121,0)
 ;  DGPAT,DGELG,DGCDIS,OLDPAT,OLDELG,OLDCDIS arrays
"RTN","DGENUPL4",122,0)
 ;
"RTN","DGENUPL4",123,0)
 ;Output:
"RTN","DGENUPL4",124,0)
 ;  DGPAT3,DGELG3,DGCDIS3 arrays
"RTN","DGENUPL4",125,0)
 ;
"RTN","DGENUPL4",126,0)
 N SUB,SUB2,LOC,HEC,NATCODE
"RTN","DGENUPL4",127,0)
 M DGPAT3=OLDPAT,DGELG3=OLDELG,DGCDIS3=OLDCDIS
"RTN","DGENUPL4",128,0)
 ;
"RTN","DGENUPL4",129,0)
 ;discard MT status from local database - don't ever want to use it during upload
"RTN","DGENUPL4",130,0)
 S DGELG3("MTSTA")=DGELG("MTSTA")
"RTN","DGENUPL4",131,0)
 ;
"RTN","DGENUPL4",132,0)
 ;patient array
"RTN","DGENUPL4",133,0)
 S SUB=""
"RTN","DGENUPL4",134,0)
 F  S SUB=$O(DGPAT(SUB)) Q:(SUB="")  I (DGPAT(SUB)'="") S DGPAT3(SUB)=$S((DGPAT(SUB)="@"):"",1:DGPAT(SUB))
"RTN","DGENUPL4",135,0)
 ;
"RTN","DGENUPL4",136,0)
 ;Allow Ineligible info deletion (Ineligible Project):
"RTN","DGENUPL4",137,0)
 I $D(DGPAT("INELDEC")),DGPAT("INELDEC")="" S DGPAT("INELDEC")="@"
"RTN","DGENUPL4",138,0)
 I $D(DGPAT("INELREA")),DGPAT("INELREA")="" S DGPAT("INELREA")="@"
"RTN","DGENUPL4",139,0)
 I $D(DGPAT("INELDATE")),DGPAT("INELDATE")="" S DGPAT("INELDATE")="@"
"RTN","DGENUPL4",140,0)
 ;
"RTN","DGENUPL4",141,0)
 ;catastrophic disability array
"RTN","DGENUPL4",142,0)
 S SUB=""
"RTN","DGENUPL4",143,0)
 F  S SUB=$O(DGCDIS(SUB)) Q:(SUB="")  D
"RTN","DGENUPL4",144,0)
 .I $D(DGCDIS(SUB))=1 I ($G(DGCDIS(SUB))'="") S DGCDIS3(SUB)=DGCDIS(SUB)
"RTN","DGENUPL4",145,0)
 .I $D(DGCDIS(SUB))=10 D
"RTN","DGENUPL4",146,0)
 ..S SUB2=""
"RTN","DGENUPL4",147,0)
 ..F  S SUB2=$O(DGCDIS(SUB,SUB2)) Q:SUB2=""  D
"RTN","DGENUPL4",148,0)
 ...I ($G(DGCDIS(SUB,SUB2))'="") S DGCDIS3(SUB,SUB2)=DGCDIS(SUB,SUB2)
"RTN","DGENUPL4",149,0)
 ...I SUB="PROC" D
"RTN","DGENUPL4",150,0)
 ....N CDPROC,CDEXT,LIEN
"RTN","DGENUPL4",151,0)
 ....S CDPROC=$G(DGCDIS3("PROC",SUB2))
"RTN","DGENUPL4",152,0)
 ....Q:CDPROC=""
"RTN","DGENUPL4",153,0)
 ....S CDEXT=DGCDIS3("EXT",SUB2)
"RTN","DGENUPL4",154,0)
 ....Q:CDEXT=""
"RTN","DGENUPL4",155,0)
 ....S LIEN=$O(^DGEN(27.17,CDPROC,1,"B",CDEXT,0))
"RTN","DGENUPL4",156,0)
 ....Q:LIEN=""
"RTN","DGENUPL4",157,0)
 ....K DGCDIS3("EXT",SUB2)
"RTN","DGENUPL4",158,0)
 ....S DGCDIS3("EXT",SUB2,LIEN)=CDEXT
"RTN","DGENUPL4",159,0)
 ;
"RTN","DGENUPL4",160,0)
 ;eligibility array
"RTN","DGENUPL4",161,0)
 F  S SUB=$O(DGELG(SUB)) Q:(SUB="")  I ($G(DGELG(SUB))'="") S DGELG3(SUB)=$S((DGELG(SUB)="@"):"",1:DGELG(SUB))
"RTN","DGENUPL4",162,0)
 ;
"RTN","DGENUPL4",163,0)
 ;rated disabilities from HEC should replace local sites
"RTN","DGENUPL4",164,0)
 D
"RTN","DGENUPL4",165,0)
 .K DGELG3("RATEDIS")
"RTN","DGENUPL4",166,0)
 .M DGELG3("RATEDIS")=DGELG("RATEDIS")
"RTN","DGENUPL4",167,0)
 ;
"RTN","DGENUPL4",168,0)
 ;primary eligibility
"RTN","DGENUPL4",169,0)
 I (DGELG("ELIG","CODE")'="") S DGELG3("ELIG","CODE")=$S((DGELG("ELIG","CODE")="@"):"",($$NATCODE^DGENELA(DGELG("ELIG","CODE"))=$$NATCODE^DGENELA(DGELG3("ELIG","CODE"))):DGELG3("ELIG","CODE"),1:DGELG("ELIG","CODE"))
"RTN","DGENUPL4",170,0)
 ;
"RTN","DGENUPL4",171,0)
 ;patient eligibilities multiple
"RTN","DGENUPL4",172,0)
 ;delete the veteran type codes not mapped to national codes sent by HEC, but leave the non-veteran types and the codes where there is a match
"RTN","DGENUPL4",173,0)
 ;first find all the local codes already in the patient file and the ones sent from HEC, keep in arrays LOC and HEC
"RTN","DGENUPL4",174,0)
 S NATCODE=$$NATCODE^DGENELA(DGELG("ELIG","CODE")) I NATCODE S HEC(NATCODE)=""
"RTN","DGENUPL4",175,0)
 S SUB=0 F  S SUB=$O(DGELG("ELIG","CODE",SUB)) Q:'SUB  S NATCODE=$$NATCODE^DGENELA(SUB) I NATCODE S HEC(NATCODE)=""
"RTN","DGENUPL4",176,0)
 S SUB=0 F  S SUB=$O(DGELG3("ELIG","CODE",SUB)) Q:'SUB  S NATCODE=$$NATCODE^DGENELA(SUB) I NATCODE S LOC(NATCODE)=""
"RTN","DGENUPL4",177,0)
 ;Now discard the codes in the local patient database that don't map to a national code sent by HEC, as well as HUMANIARIAN EMERGENCY code if not sent by HEC: 
"RTN","DGENUPL4",178,0)
 S SUB=0
"RTN","DGENUPL4",179,0)
 F  S SUB=$O(DGELG3("ELIG","CODE",SUB)) Q:'SUB  D
"RTN","DGENUPL4",180,0)
 .I $P($G(^DIC(8,SUB,0)),"^",5)="Y"!($P($G(^DIC(8,SUB,0)),"^")["HUMANITARIAN EMERGENCY"),'$D(HEC($$NATCODE^DGENELA(SUB))) K DGELG3("ELIG","CODE",SUB)
"RTN","DGENUPL4",181,0)
 ;now add the codes included in the update that the local database does not already contain
"RTN","DGENUPL4",182,0)
 S SUB=0
"RTN","DGENUPL4",183,0)
 F  S SUB=$O(DGELG("ELIG","CODE",SUB)) Q:'SUB  D
"RTN","DGENUPL4",184,0)
 .I '$D(LOC($$NATCODE^DGENELA(SUB))) S DGELG3("ELIG","CODE",SUB)=SUB
"RTN","DGENUPL4",185,0)
 ;Agent Orange Exp. Location, use local database when upload is NULL
"RTN","DGENUPL4",186,0)
 D AO^DGENUPL9
"RTN","DGENUPL4",187,0)
 Q
"RTN","DGENUPL4",188,0)
 ;
"RTN","DGENUPL4",189,0)
CHECK() ;
"RTN","DGENUPL4",190,0)
 ;Description: Does the consistency checks on the PATIENT, ELIGIBILITY, and CATASTROPHIC DISABILITY objects.
"RTN","DGENUPL4",191,0)
 ;
"RTN","DGENUPL4",192,0)
 ;Input:
"RTN","DGENUPL4",193,0)
 ;  OLDPAT,DGPAT3,DGELG3,DGCDIS3,ERRCOUNT,MSGID
"RTN","DGENUPL4",194,0)
 ;  DGENR -Enrollment Array
"RTN","DGENUPL4",195,0)
 ;  DGPAT -Patient Array
"RTN","DGENUPL4",196,0)
 ;  MSGS  -Warning and Error Message array   
"RTN","DGENUPL4",197,0)
 ;
"RTN","DGENUPL4",198,0)
 ;Output:
"RTN","DGENUPL4",199,0)
 ;  Function Value - 1 if consistency checks passed, 0 otherwise
"RTN","DGENUPL4",200,0)
 ;
"RTN","DGENUPL4",201,0)
 N SUCCESS,ALIVE,ERRMSG,DGENR
"RTN","DGENUPL4",202,0)
 S SUCCESS=1
"RTN","DGENUPL4",203,0)
 S ERRMSG=""
"RTN","DGENUPL4",204,0)
 ;
"RTN","DGENUPL4",205,0)
 ;if upload includes date of death, check for indications that the patient is alive
"RTN","DGENUPL4",206,0)
 I DGPAT3("DEATH"),'OLDPAT("DEATH") D  S:ALIVE SUCCESS=0
"RTN","DGENUPL4",207,0)
 .;
"RTN","DGENUPL4",208,0)
 .;determine if the patient is at the moment being registered
"RTN","DGENUPL4",209,0)
 .S ALIVE=$$IFREG^DGREG(DFN)
"RTN","DGENUPL4",210,0)
 .;
"RTN","DGENUPL4",211,0)
 .;check if an inpatient
"RTN","DGENUPL4",212,0)
 .I 'ALIVE,$$INPAT^DGENPTA(DFN,DT,DT) S ALIVE=1
"RTN","DGENUPL4",213,0)
 .;
"RTN","DGENUPL4",214,0)
 .;Phase II locally enrolled with enrollment date after death date and status of unverified and rejected-initial application by vamc (SRS 6.5.1.2 e)
"RTN","DGENUPL4",215,0)
 .N CURIEN,CURENR
"RTN","DGENUPL4",216,0)
 .S CURIEN=$$FINDCUR^DGENA(DFN)
"RTN","DGENUPL4",217,0)
 .I CURIEN,$$GET^DGENA(CURIEN,.CURENR),CURENR("DATE")>DGPAT3("DEATH"),CURENR("STATUS")=1!(CURENR("STATUS")=14) S ALIVE=1
"RTN","DGENUPL4",218,0)
 .;there is an indication that he patient may not be dead
"RTN","DGENUPL4",219,0)
 .D:ALIVE ADDERROR^DGENUPL(MSGID,DGPAT("SSN"),"LOCAL SITE VERIFY PATIENT DEATH",.ERRCOUNT),ADDMSG^DGENUPL3(.MSGS,"ELIBILITY UPLOAD CONTAINED DATE OF DEATH AND WAS REJECTED, PLEASE VERIFY PATIENT DEATH",1),NOTIFY^DGENUPL3(.DGPAT,.MSGS)
"RTN","DGENUPL4",220,0)
 ;
"RTN","DGENUPL4",221,0)
 ;only do the consistency checks on this data if it is verified
"RTN","DGENUPL4",222,0)
 I SUCCESS,(DGELG3("ELIGSTA")="V") D
"RTN","DGENUPL4",223,0)
 .I $$CHECK^DGENPTA1(.DGPAT3,.ERRMSG),$$CHECK^DGENELA1(.DGELG3,.DGPAT3,.DGCDIS3,.ERRMSG),$$CHECK^DGENCDA1(.DGCDIS3,.ERRMSG)
"RTN","DGENUPL4",224,0)
 .E  D
"RTN","DGENUPL4",225,0)
 ..S SUCCESS=0
"RTN","DGENUPL4",226,0)
 ..D ADDERROR^DGENUPL(MSGID,DGPAT("SSN"),ERRMSG,.ERRCOUNT)
"RTN","DGENUPL4",227,0)
 Q SUCCESS
"RTN","DGENUPLB")
0^2^B11114623
"RTN","DGENUPLB",1,0)
DGENUPLB ;TDM - PROCESS INCOMING (Z11 EVENT TYPE) HL7 MESSAGES ; 10/26/04 2:01pm
"RTN","DGENUPLB",2,0)
 ;;5.3;REGISTRATION;**625**;Aug 13,1993
"RTN","DGENUPLB",3,0)
 ;
"RTN","DGENUPLB",4,0)
EP N MSGARY
"RTN","DGENUPLB",5,0)
 D CHECK,SNDMSG
"RTN","DGENUPLB",6,0)
 Q
"RTN","DGENUPLB",7,0)
 ;
"RTN","DGENUPLB",8,0)
CHECK ;Perform C&P and SC status checks and generate mailman messages
"RTN","DGENUPLB",9,0)
 ;for MCCR eligibility & billing staff.
"RTN","DGENUPLB",10,0)
 Q:'$D(OLDELG)
"RTN","DGENUPLB",11,0)
 N RDOCC,TMPARY,RD,RDOCC1,RDOCC2,RDFLG
"RTN","DGENUPLB",12,0)
 ;
"RTN","DGENUPLB",13,0)
 ;Change in SC Indicator
"RTN","DGENUPLB",14,0)
 I OLDELG("SC")'=DGELG("SC") D
"RTN","DGENUPLB",15,0)
 .Q:(OLDELG("SC")="")&(DGELG("SC")="N")
"RTN","DGENUPLB",16,0)
 .Q:(OLDELG("SC")="N")&(DGELG("SC")="")
"RTN","DGENUPLB",17,0)
 .D ADDMSG^DGENUPL3(.MSGARY,"VETERAN SC INDICATOR CHANGED",1)
"RTN","DGENUPLB",18,0)
 ;
"RTN","DGENUPLB",19,0)
 ;SC% change to 50% or greater
"RTN","DGENUPLB",20,0)
 I (OLDELG("SCPER")<50),(DGELG("SCPER")>49) D ADDMSG^DGENUPL3(.MSGARY,"VETERAN SC% CHANGED TO 50% OR GREATER",1)
"RTN","DGENUPLB",21,0)
 ;
"RTN","DGENUPLB",22,0)
 ;Change in VA Pension
"RTN","DGENUPLB",23,0)
 I OLDELG("VAPEN")'=DGELG("VAPEN") D
"RTN","DGENUPLB",24,0)
 .Q:(OLDELG("VAPEN")="")&(DGELG("VAPEN")="N")
"RTN","DGENUPLB",25,0)
 .Q:(OLDELG("VAPEN")="N")&(DGELG("VAPEN")="")
"RTN","DGENUPLB",26,0)
 .D ADDMSG^DGENUPL3(.MSGARY,"VETERAN VA PENSION CHANGED",1)
"RTN","DGENUPLB",27,0)
 ;
"RTN","DGENUPLB",28,0)
 ;Change in Rated Disabilities
"RTN","DGENUPLB",29,0)
 I $D(OLDELG("RATEDIS")) D
"RTN","DGENUPLB",30,0)
 .S RDOCC=0 F  S RDOCC=$O(OLDELG("RATEDIS",RDOCC)) Q:RDOCC=""  D
"RTN","DGENUPLB",31,0)
 ..S RD=$P(OLDELG("RATEDIS",RDOCC,"RD"),"^") Q:RD=""
"RTN","DGENUPLB",32,0)
 ..S TMPARY(RD)=RDOCC
"RTN","DGENUPLB",33,0)
 ;
"RTN","DGENUPLB",34,0)
 I $D(DGELG("RATEDIS")) D
"RTN","DGENUPLB",35,0)
 .S RDOCC=0 F  S RDOCC=$O(DGELG("RATEDIS",RDOCC)) Q:RDOCC=""  D
"RTN","DGENUPLB",36,0)
 ..S RD=$P(DGELG("RATEDIS",RDOCC,"RD"),"^") Q:RD=""
"RTN","DGENUPLB",37,0)
 ..S $P(TMPARY(RD),"^",2)=RDOCC
"RTN","DGENUPLB",38,0)
 ;
"RTN","DGENUPLB",39,0)
 I $D(TMPARY) D
"RTN","DGENUPLB",40,0)
 .S RD="",RDFLG=0
"RTN","DGENUPLB",41,0)
 .F  S RD=$O(TMPARY(RD)) Q:RD=""  D
"RTN","DGENUPLB",42,0)
 ..S RDOCC1=+$P(TMPARY(RD),"^"),RDOCC2=+$P(TMPARY(RD),"^",2)
"RTN","DGENUPLB",43,0)
 ..I $G(OLDELG("RATEDIS",RDOCC1,"RD"))'=$G(DGELG("RATEDIS",RDOCC2,"RD")) S RDFLG=1
"RTN","DGENUPLB",44,0)
 .I RDFLG D ADDMSG^DGENUPL3(.MSGARY,"VETERAN RATED DISABILITIES CHANGED",1)
"RTN","DGENUPLB",45,0)
 Q
"RTN","DGENUPLB",46,0)
 ;
"RTN","DGENUPLB",47,0)
SNDMSG ;Description: Send messages generated above to the G.IB MEANS TEST
"RTN","DGENUPLB",48,0)
 ;mail group.
"RTN","DGENUPLB",49,0)
 ;
"RTN","DGENUPLB",50,0)
 N TEXT,XMDUZ,XMTEXT,XMSUB,XMSTRIP,XMROU,XMY,XMZ,XMDF,COUNT
"RTN","DGENUPLB",51,0)
 N HEADER,NSC,POW,TMPSTR,XMGROUP,ELIG,CD
"RTN","DGENUPLB",52,0)
 ;
"RTN","DGENUPLB",53,0)
 ;if there are no alerts, then quit
"RTN","DGENUPLB",54,0)
 Q:'$D(MSGARY)
"RTN","DGENUPLB",55,0)
 S HEADER="C&P Alert: ",XMDF="",(XMDUN,XMDUZ)="Registration Enrollment Module"
"RTN","DGENUPLB",56,0)
 ;DGPAT("SSN") is built by the parser. DGPAT("NAME"),DGPAT("SEX"),DGPAT("DOB")(are merged into DGPAT from OLDPAT.
"RTN","DGENUPLB",57,0)
 ;The checks below are to setup the DGPAT elements from OLDPAT if NOTIFY is called before the merge.
"RTN","DGENUPLB",58,0)
 I '$D(DGPAT("NAME")) S DGPAT("NAME")=$G(OLDPAT("NAME"))
"RTN","DGENUPLB",59,0)
 I '$D(DGPAT("SEX")) S DGPAT("SEX")=$G(OLDPAT("SEX"))
"RTN","DGENUPLB",60,0)
 I '$D(DGPAT("DOB")) S DGPAT("DOB")=$G(OLDPAT("DOB"))
"RTN","DGENUPLB",61,0)
 S TMPSTR=" ("_$E(DGPAT("NAME"),1,1)
"RTN","DGENUPLB",62,0)
 S TMPSTR=TMPSTR_$E(DGPAT("SSN"),$L(DGPAT("SSN"))-3,1000)_")"
"RTN","DGENUPLB",63,0)
 S XMSUB=HEADER_$E(DGPAT("NAME"),1,25)_TMPSTR
"RTN","DGENUPLB",64,0)
 ;
"RTN","DGENUPLB",65,0)
 ; send msg to mail group in IB SITE PARAMETERS (#350.9) file
"RTN","DGENUPLB",66,0)
 S XMY("G.IB MEANS TEST")=""    ; Means Test billing Group
"RTN","DGENUPLB",67,0)
 ;
"RTN","DGENUPLB",68,0)
 S XMTEXT="TEXT("
"RTN","DGENUPLB",69,0)
 S TEXT(1)="The enrollment/eligibility upload produced the following alerts:"
"RTN","DGENUPLB",70,0)
 S TEXT(2)="  "
"RTN","DGENUPLB",71,0)
 S TEXT(3)="Patient Name   :     "_DGPAT("NAME")
"RTN","DGENUPLB",72,0)
 S TEXT(4)="SSN            :     "_DGPAT("SSN")
"RTN","DGENUPLB",73,0)
 S TEXT(5)="DOB            :     "_$$EXTERNAL^DILFD(2,$$FIELD^DGENPTA1("DOB"),"F",DGPAT("DOB"))
"RTN","DGENUPLB",74,0)
 S TEXT(6)="SEX            :     "_$$EXTERNAL^DILFD(2,$$FIELD^DGENPTA1("SEX"),"F",DGPAT("SEX"))
"RTN","DGENUPLB",75,0)
 S TEXT(7)=" "
"RTN","DGENUPLB",76,0)
 ;
"RTN","DGENUPLB",77,0)
 S TEXT(8)=" ** Alerts **"
"RTN","DGENUPLB",78,0)
 S TEXT(9)=" "
"RTN","DGENUPLB",79,0)
 S COUNT=0 F  S COUNT=$O(MSGARY(COUNT)) Q:'COUNT  S TEXT(10+COUNT)=COUNT_") "_MSGARY(COUNT)
"RTN","DGENUPLB",80,0)
 ;
"RTN","DGENUPLB",81,0)
 D ^XMD
"RTN","DGENUPLB",82,0)
 Q
"VER")
8.0^22
**END**
**END**
