Released RG*1*1 SEQ #2
Extracted from mail message
**KIDS**:RG*1.0*1^

**INSTALL NAME**
RG*1.0*1
"BLD",665,0)
RG*1.0*1^CLINICAL INFO RESOURCE NETWORK^0^2991012^y
"BLD",665,1,0)
^^3^3^2991005^
"BLD",665,1,1,0)
EXCEPTION MESSAGE ENHANCEMENTS
"BLD",665,1,2,0)
Refer to patch RG*1*1 in the FORUM Patch Module for a complete
"BLD",665,1,3,0)
description.
"BLD",665,4,0)
^9.64PA^991.1^2
"BLD",665,4,991.1,0)
991.1
"BLD",665,4,991.1,2,0)
^9.641^991.12^1
"BLD",665,4,991.1,2,991.12,0)
EXCEPTION  (sub-file)
"BLD",665,4,991.1,2,991.12,1,0)
^9.6411^3^1
"BLD",665,4,991.1,2,991.12,1,3,0)
PATIENT
"BLD",665,4,991.1,222)
y^y^p^^^^n
"BLD",665,4,991.11,0)
991.11
"BLD",665,4,991.11,222)
y^y^f^^y^^y^m^n
"BLD",665,4,991.11,224)
N X S X=+^(0) I X=228!(X=229)
"BLD",665,4,"APDD",991.1,991.12)

"BLD",665,4,"APDD",991.1,991.12,3)

"BLD",665,4,"B",991.1,991.1)

"BLD",665,4,"B",991.11,991.11)

"BLD",665,"ABNS",0)
^9.66A^^
"BLD",665,"ABPKG")
^n^
"BLD",665,"INIT")

"BLD",665,"KRN",0)
^9.67PA^19^18
"BLD",665,"KRN",.4,0)
.4
"BLD",665,"KRN",.401,0)
.401
"BLD",665,"KRN",.402,0)
.402
"BLD",665,"KRN",.403,0)
.403
"BLD",665,"KRN",.5,0)
.5
"BLD",665,"KRN",.84,0)
.84
"BLD",665,"KRN",3.6,0)
3.6
"BLD",665,"KRN",3.8,0)
3.8
"BLD",665,"KRN",9.2,0)
9.2
"BLD",665,"KRN",9.8,0)
9.8
"BLD",665,"KRN",9.8,"NM",0)
^9.68A^10^9
"BLD",665,"KRN",9.8,"NM",1,0)
RGRSDYN1^^0^B17021424
"BLD",665,"KRN",9.8,"NM",2,0)
RGJCREC^^0^B43992526
"BLD",665,"KRN",9.8,"NM",3,0)
RGRSPT^^0^B17495245
"BLD",665,"KRN",9.8,"NM",4,0)
RGRSBUL1^^0^B25678433
"BLD",665,"KRN",9.8,"NM",5,0)
RGHLLOG^^0^B10085269
"BLD",665,"KRN",9.8,"NM",6,0)
RGRSUTIL^^0^B7989549
"BLD",665,"KRN",9.8,"NM",8,0)
RGEVPM^^0^B20683110
"BLD",665,"KRN",9.8,"NM",9,0)
RGJCSUB^^0^B56551769
"BLD",665,"KRN",9.8,"NM",10,0)
RGJCTS01^^0^B5403236
"BLD",665,"KRN",9.8,"NM","B","RGEVPM",8)

"BLD",665,"KRN",9.8,"NM","B","RGHLLOG",5)

"BLD",665,"KRN",9.8,"NM","B","RGJCREC",2)

"BLD",665,"KRN",9.8,"NM","B","RGJCSUB",9)

"BLD",665,"KRN",9.8,"NM","B","RGJCTS01",10)

"BLD",665,"KRN",9.8,"NM","B","RGRSBUL1",4)

"BLD",665,"KRN",9.8,"NM","B","RGRSDYN1",1)

"BLD",665,"KRN",9.8,"NM","B","RGRSPT",3)

"BLD",665,"KRN",9.8,"NM","B","RGRSUTIL",6)

"BLD",665,"KRN",19,0)
19
"BLD",665,"KRN",19,"NM",0)
^9.68A^5^5
"BLD",665,"KRN",19,"NM",1,0)
RG EXCEPTION MENU^^0
"BLD",665,"KRN",19,"NM",2,0)
RG EXCEPTION POTENTIAL MATCH^^0
"BLD",665,"KRN",19,"NM",3,0)
RG ADMIN COORD MENU^^2
"BLD",665,"KRN",19,"NM",4,0)
RG EXCEPTION NOTIFIER^^0
"BLD",665,"KRN",19,"NM",5,0)
XU USER SIGN-ON^^2
"BLD",665,"KRN",19,"NM","B","RG ADMIN COORD MENU",3)

"BLD",665,"KRN",19,"NM","B","RG EXCEPTION MENU",1)

"BLD",665,"KRN",19,"NM","B","RG EXCEPTION NOTIFIER",4)

"BLD",665,"KRN",19,"NM","B","RG EXCEPTION POTENTIAL MATCH",2)

"BLD",665,"KRN",19,"NM","B","XU USER SIGN-ON",5)

"BLD",665,"KRN",19.1,0)
19.1
"BLD",665,"KRN",101,0)
101
"BLD",665,"KRN",409.61,0)
409.61
"BLD",665,"KRN",771,0)
771
"BLD",665,"KRN",869.2,0)
869.2
"BLD",665,"KRN",870,0)
870
"BLD",665,"KRN",8994,0)
8994
"BLD",665,"KRN","B",.4,.4)

"BLD",665,"KRN","B",.401,.401)

"BLD",665,"KRN","B",.402,.402)

"BLD",665,"KRN","B",.403,.403)

"BLD",665,"KRN","B",.5,.5)

"BLD",665,"KRN","B",.84,.84)

"BLD",665,"KRN","B",3.6,3.6)

"BLD",665,"KRN","B",3.8,3.8)

"BLD",665,"KRN","B",9.2,9.2)

"BLD",665,"KRN","B",9.8,9.8)

"BLD",665,"KRN","B",19,19)

"BLD",665,"KRN","B",19.1,19.1)

"BLD",665,"KRN","B",101,101)

"BLD",665,"KRN","B",409.61,409.61)

"BLD",665,"KRN","B",771,771)

"BLD",665,"KRN","B",869.2,869.2)

"BLD",665,"KRN","B",870,870)

"BLD",665,"KRN","B",8994,8994)

"BLD",665,"PRE")
RGP1ENV
"BLD",665,"QUES",0)
^9.62^^
"BLD",665,"REQB",0)
^9.611^^0
"DATA",991.11,228,0)
228^2^1^104^4
"DATA",991.11,228,10)
Patient Does Not Exist
"DATA",991.11,228,99,0)
^^1^1^2991005^^^^
"DATA",991.11,228,99,1,0)
The patient does not exist in the patient file.
"DATA",991.11,229,0)
229^2^1^104^6
"DATA",991.11,229,10)
Duplicate Station Number in Institution File (#4)
"DATA",991.11,229,99,0)
^^2^2^2991005^^^^
"DATA",991.11,229,99,1,0)
A Station Number has been entered for multiple institutions in
"DATA",991.11,229,99,2,0)
the Institution (#4) file.
"FIA",991.1)
CIRN HL7 EXCEPTION LOG
"FIA",991.1,0)
^RGHL7(991.1,
"FIA",991.1,0,0)
991.1
"FIA",991.1,0,1)
y^y^p^^^^n
"FIA",991.1,0,10)

"FIA",991.1,0,11)

"FIA",991.1,0,"RLRO")

"FIA",991.1,0,"VR")
1.0^RG
"FIA",991.1,991.1)
1
"FIA",991.1,991.12)
1
"FIA",991.1,991.12,3)

"FIA",991.11)
CIRN HL7 EXCEPTION TYPE
"FIA",991.11,0)
^RGHL7(991.11,
"FIA",991.11,0,0)
991.11I
"FIA",991.11,0,1)
y^y^f^^y^^y^m^n
"FIA",991.11,0,10)

"FIA",991.11,0,11)
N X S X=+^(0) I X=228!(X=229)
"FIA",991.11,0,"RLRO")

"FIA",991.11,0,"VR")
1.0^RG
"FIA",991.11,991.11)
0
"FIA",991.11,991.112)
0
"FIA",991.11,991.1199)
0
"FRV1",991.11,"228,0",4)
RG CIRN DEMOGRAPHIC ISSUES
"FRV1",991.11,"228,0",4,"F")
;XMB(3.8,
"FRV1",991.11,"229,0",4)
RG CIRN DEMOGRAPHIC ISSUES
"FRV1",991.11,"229,0",4,"F")
;XMB(3.8,
"KRN",19,4718,-1)
2^5
"KRN",19,4718,0)
XU USER SIGN-ON^User sign-on event^^X^12597^^^^^^^^^
"KRN",19,4718,10,0)
^19.01IP^4^4
"KRN",19,4718,10,3,0)
6405
"KRN",19,4718,10,3,"^")
RG EXCEPTION NOTIFIER
"KRN",19,4718,"U")
USER SIGN-ON EVENT
"KRN",19,5663,-1)
2^3
"KRN",19,5663,0)
RG ADMIN COORD MENU^CIRN Patient Admin Coordinator Menu^^M^^^^^^^^272^^^
"KRN",19,5663,10,0)
^19.01IP^38^10
"KRN",19,5663,10,38,0)
6403^MSG^50
"KRN",19,5663,10,38,"^")
RG EXCEPTION MENU
"KRN",19,5663,"U")
CIRN PATIENT ADMIN COORDINATOR
"KRN",19,6403,-1)
0^1
"KRN",19,6403,0)
RG EXCEPTION MENU^Message Exception Menu^^M^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",19,6403,1,0)
^^2^2^2990929^^^
"KRN",19,6403,1,1,0)
This menu is used to view CIRN Health Level Seven (HL7) message 
"KRN",19,6403,1,2,0)
exceptions logged in the CIRN HL7 EXCEPTION LOG file (#991.1).
"KRN",19,6403,10,0)
^19.01IP^1^1
"KRN",19,6403,10,1,0)
6404^^1
"KRN",19,6403,10,1,"^")
RG EXCEPTION POTENTIAL MATCH
"KRN",19,6403,99)
57897,53359
"KRN",19,6403,"U")
MESSAGE EXCEPTION MENU
"KRN",19,6404,-1)
0^2
"KRN",19,6404,0)
RG EXCEPTION POTENTIAL MATCH^View Potential Match Patient^^R^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",19,6404,1,0)
^^8^8^2990922^^^^
"KRN",19,6404,1,1,0)
This option produces a list of patients from the CIRN HL7 EXCEPTION 
"KRN",19,6404,1,2,0)
LOG file (#991.1) who have been identified as having more than one 
"KRN",19,6404,1,3,0)
potential match on the Master Patient Index (MPI).  These patients 
"KRN",19,6404,1,4,0)
have not been resolved using the Single Patient Initialization to 
"KRN",19,6404,1,5,0)
MPI option [MPIF IND MPI LOAD].
"KRN",19,6404,1,6,0)
  
"KRN",19,6404,1,7,0)
Before producing the report, this option purges DUPLICATE potential 
"KRN",19,6404,1,8,0)
match entries from the CIRN HL7 EXCEPTION LOG file (#991.1).
"KRN",19,6404,25)
RGEVPM
"KRN",19,6404,"U")
VIEW POTENTIAL MATCH PATIENT
"KRN",19,6405,-1)
0^4
"KRN",19,6405,0)
RG EXCEPTION NOTIFIER^CIRN HL7 Exception Notifier^^A^^^^^^^^CLINICAL INFO RESOURCE NETWORK^^1
"KRN",19,6405,1,0)
^^2^2^2990708^
"KRN",19,6405,1,1,0)
This option is used to notify members of the RG CIRN DEMOGRAPHIC 
"KRN",19,6405,1,2,0)
ISSUES Mail Group that there are exceptions to review.
"KRN",19,6405,20)
D EXCEPT^RGRSUTIL
"KRN",19,6405,"U")
CIRN HL7 EXCEPTION NOTIFIER
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PGL",991.11,0,4,6)
MAIL GROUP^P3.8'^XMB(3.8,^0;4^Q
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
1^2991012
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^2991012
"PKG",272,22,1,"PAH",1,1,1,0)
EXCEPTION MESSAGE ENHANCEMENTS
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*1 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"PRE")
RGP1ENV
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","RGEVPM")
0^8^B20683110
"RTN","RGEVPM",1,0)
RGEVPM ;BIR/CML-VIEW POTENTIAL MATCH PATIENT LIST ;07/20/99
"RTN","RGEVPM",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGEVPM",3,0)
 S QFLG=1
"RTN","RGEVPM",4,0)
BEGIN ;
"RTN","RGEVPM",5,0)
 W !!,"This report prints a list of patients who have been identified as having"
"RTN","RGEVPM",6,0)
 W !,"multiple Potential Matches on the Master Patient Index (MPI) and who haven't"
"RTN","RGEVPM",7,0)
 W !,"yet been resolved using the option ""Single Patient Initialization to MPI""."
"RTN","RGEVPM",8,0)
 W !,"Status is current as of the date/time the report is generated."
"RTN","RGEVPM",9,0)
 W !!,"This data is pulled from the CIRN HL7 EXCEPTION LOG file (#991.1)."
"RTN","RGEVPM",10,0)
 W !,"Prior to producing the report, duplicate POTENTIAL MATCH patients will be"
"RTN","RGEVPM",11,0)
 W !,"purged from the file."
"RTN","RGEVPM",12,0)
 ;
"RTN","RGEVPM",13,0)
 D EXCTMP
"RTN","RGEVPM",14,0)
 I XCNT=0 W !!,"There are no patients identified as Potential Matches." G QUIT
"RTN","RGEVPM",15,0)
DEV ;
"RTN","RGEVPM",16,0)
 W !!,"The right margin for this report is 80.",!!
"RTN","RGEVPM",17,0)
 D EN^XUTMDEVQ("START^RGEVPM","CIRN - Potential Match Patient List") I 'POP Q
"RTN","RGEVPM",18,0)
 W !,"NO DEVICE SELECTED OR REPORT PRINTED!!"
"RTN","RGEVPM",19,0)
 G QUIT
"RTN","RGEVPM",20,0)
START ;
"RTN","RGEVPM",21,0)
 S HOME=$$SITE^VASITE()   ;institution file ptr^station name^station number
"RTN","RGEVPM",22,0)
 ;
"RTN","RGEVPM",23,0)
LOOP ;Search ^RGHL7(991.1,"ADFN" to see how many patients need to be resolved to MPI
"RTN","RGEVPM",24,0)
 K ^TMP("RGEVPM",$J)
"RTN","RGEVPM",25,0)
 ;
"RTN","RGEVPM",26,0)
 S (RCNT,RGDFN)=0
"RTN","RGEVPM",27,0)
 F  S RGDFN=$O(^RGHL7(991.1,"ADFN",218,RGDFN)) Q:'RGDFN  D
"RTN","RGEVPM",28,0)
 .S ICN=+$$GETICN^MPIF001(RGDFN)
"RTN","RGEVPM",29,0)
 .I $E(ICN,1,3)=$P(HOME,"^",3)!(ICN<0) D
"RTN","RGEVPM",30,0)
 ..S RCNT=RCNT+1
"RTN","RGEVPM",31,0)
 ..S DFN=RGDFN D DEM^VADPT
"RTN","RGEVPM",32,0)
 ..S ^TMP("RGEVPM",$J,VADM(1),RGDFN)=$P(VADM(2),"^")_"^"_$P(VADM(3),"^",2)
"RTN","RGEVPM",33,0)
 ;
"RTN","RGEVPM",34,0)
PRT ;Print report
"RTN","RGEVPM",35,0)
 S (PG,QFLG)=0,$P(LN,"-",81)="",LOCSITE=$P(HOME,"^",2)
"RTN","RGEVPM",36,0)
 D NOW^%DTC S HDT=$$FMTE^XLFDT($E(%,1,12))
"RTN","RGEVPM",37,0)
 D HDR
"RTN","RGEVPM",38,0)
 I '$D(^TMP("RGEVPM",$J)) W !!,"No patients found who need to be resolved to the MPI." G QUIT
"RTN","RGEVPM",39,0)
 ;
"RTN","RGEVPM",40,0)
 ;count the number of patients who need to be resolved
"RTN","RGEVPM",41,0)
 S PTNM="",CNT=0
"RTN","RGEVPM",42,0)
 F  S PTNM=$O(^TMP("RGEVPM",$J,PTNM)) Q:PTNM=""  Q:QFLG  D
"RTN","RGEVPM",43,0)
 .S RGDFN=0
"RTN","RGEVPM",44,0)
 .F  S RGDFN=$O(^TMP("RGEVPM",$J,PTNM,RGDFN)) Q:'RGDFN  S CNT=CNT+1
"RTN","RGEVPM",45,0)
 ;
"RTN","RGEVPM",46,0)
 S PTNM=""
"RTN","RGEVPM",47,0)
 F  S PTNM=$O(^TMP("RGEVPM",$J,PTNM)) Q:PTNM=""  Q:QFLG  D
"RTN","RGEVPM",48,0)
 .S RGDFN=0
"RTN","RGEVPM",49,0)
 .F  S RGDFN=$O(^TMP("RGEVPM",$J,PTNM,RGDFN)) Q:'RGDFN  Q:QFLG  D
"RTN","RGEVPM",50,0)
 ..S SSN=$P(^TMP("RGEVPM",$J,PTNM,RGDFN),"^")
"RTN","RGEVPM",51,0)
 ..S DOB=$P(^TMP("RGEVPM",$J,PTNM,RGDFN),"^",2)
"RTN","RGEVPM",52,0)
 ..D:$Y+4>IOSL HDR Q:QFLG  W !,PTNM,?36,SSN,?50,DOB,?68,$J(RGDFN,9)
"RTN","RGEVPM",53,0)
 W !!,"TOTAL: ",CNT
"RTN","RGEVPM",54,0)
 ;
"RTN","RGEVPM",55,0)
QUIT ;
"RTN","RGEVPM",56,0)
 I $E(IOST,1,2)="C-"&('QFLG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","RGEVPM",57,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGEVPM",58,0)
 K ^TMP("RGEVPM",$J)
"RTN","RGEVPM",59,0)
 K %,CNT,DA,DFN,DIK,DIR,DOB,DUPCNT,EXCDT,HDT,HOME,ICN,IEN,IEN2,JJ,LCNT,LN,LOCSITE
"RTN","RGEVPM",60,0)
 K NCNT,NODE,OLDDT,OLDNODE,PG,PTNM,QFLG,RCNT,RDT,RGDFN,SS,SSN,VADM,X,XCNT,Y,ZTSK
"RTN","RGEVPM",61,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","RGEVPM",62,0)
 ;
"RTN","RGEVPM",63,0)
HDR ;HEADER
"RTN","RGEVPM",64,0)
 I $E(IOST,1,2)="C-" S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGEVPM",65,0)
 I $E(IOST,1,2)="C-",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","RGEVPM",66,0)
 S PG=PG+1 W:$Y!($E(IOST,1,2)="C-") @IOF
"RTN","RGEVPM",67,0)
 W !,"PATIENT LIST of Potential Matches to be Resolved",?72,"Page: ",PG
"RTN","RGEVPM",68,0)
 W !,"Printed at ",LOCSITE," on ",HDT
"RTN","RGEVPM",69,0)
 W !!,"Patient Name",?39,"SSN",?52,"DOB",?70,"DFN",!,LN
"RTN","RGEVPM",70,0)
 Q
"RTN","RGEVPM",71,0)
 ;
"RTN","RGEVPM",72,0)
EXCTMP ;Count number of POTENTIAL MATCH type entries (IEN=218) in CIRN HL7 EXCEPTION LOG 
"RTN","RGEVPM",73,0)
 ;file 991.1, build XTMP global of unique patients and purge dup entries in file.
"RTN","RGEVPM",74,0)
 W !!,"...one moment please..",!
"RTN","RGEVPM",75,0)
 K ^TMP("RGEVPM",$J)
"RTN","RGEVPM",76,0)
 S (RGDFN,CNT,XCNT,DUPCNT)=0
"RTN","RGEVPM",77,0)
 F  S RGDFN=$O(^RGHL7(991.1,"ADFN",218,RGDFN)) Q:'RGDFN  D
"RTN","RGEVPM",78,0)
 .S IEN=0
"RTN","RGEVPM",79,0)
 .F  S IEN=$O(^RGHL7(991.1,"ADFN",218,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPM",80,0)
 ..S IEN2=0
"RTN","RGEVPM",81,0)
 ..F  S IEN2=$O(^RGHL7(991.1,"ADFN",218,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPM",82,0)
 ...S CNT=CNT+1
"RTN","RGEVPM",83,0)
 ...S EXCDT=$P(^RGHL7(991.1,IEN,0),"^",3)
"RTN","RGEVPM",84,0)
 ...I '$D(^TMP("RGEVPM",$J,RGDFN)) D  Q
"RTN","RGEVPM",85,0)
 ....S XCNT=XCNT+1
"RTN","RGEVPM",86,0)
 ....D SETTMP
"RTN","RGEVPM",87,0)
 ...I $D(^TMP("RGEVPM",$J,RGDFN))  D
"RTN","RGEVPM",88,0)
 ....S OLDNODE=^TMP("RGEVPM",$J,RGDFN)
"RTN","RGEVPM",89,0)
 ....S OLDDT=$P(OLDNODE,"^")
"RTN","RGEVPM",90,0)
 ....I EXCDT>OLDDT D  Q
"RTN","RGEVPM",91,0)
 .....S DA(1)=$P(OLDNODE,"^",2),DA=$P(OLDNODE,"^",3)
"RTN","RGEVPM",92,0)
 .....D DELDUP
"RTN","RGEVPM",93,0)
 .....D SETTMP
"RTN","RGEVPM",94,0)
 ....I OLDDT>EXCDT!(OLDDT=EXCDT) D
"RTN","RGEVPM",95,0)
 .....S DA(1)=IEN,DA=IEN2
"RTN","RGEVPM",96,0)
 .....D DELDUP
"RTN","RGEVPM",97,0)
 W !,CNT," POTENTIAL MATCH exceptions found in CIRN HL7 EXCEPTION LOG file (#991.1)."
"RTN","RGEVPM",98,0)
 W !,DUPCNT," duplicate patient entries purged."
"RTN","RGEVPM",99,0)
 W !,XCNT," patients remaining to be checked for possible MPI resolution."
"RTN","RGEVPM",100,0)
 Q
"RTN","RGEVPM",101,0)
 ;
"RTN","RGEVPM",102,0)
SETTMP ;set TMP global for patient check
"RTN","RGEVPM",103,0)
 S ^TMP("RGEVPM",$J,RGDFN)=EXCDT_"^"_IEN_"^"_IEN2
"RTN","RGEVPM",104,0)
 Q
"RTN","RGEVPM",105,0)
 ;
"RTN","RGEVPM",106,0)
DELDUP ;delete patient dups from file
"RTN","RGEVPM",107,0)
 S DUPCNT=DUPCNT+1
"RTN","RGEVPM",108,0)
 S DIK="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGEVPM",109,0)
 D ^DIK K DIK,DA
"RTN","RGEVPM",110,0)
 Q
"RTN","RGEVPM",111,0)
 ;
"RTN","RGEVPM",112,0)
CURPM() ;Call to check if there are any patients in the CIRN HL7 EXCEPTION LOG
"RTN","RGEVPM",113,0)
 ;file (#991.1) with an exception TYPE of "POTENTIAL MATCH" who currently need
"RTN","RGEVPM",114,0)
 ;to be resolved to the MPI.
"RTN","RGEVPM",115,0)
 ;returns a value of "1" if any are found, "0" if none are found
"RTN","RGEVPM",116,0)
 N LOC,RGDFN,GOT,ICN
"RTN","RGEVPM",117,0)
 S LOC=$P($$SITE^VASITE(),"^",3)
"RTN","RGEVPM",118,0)
 S (GOT,RGDFN)=0
"RTN","RGEVPM",119,0)
 F  S RGDFN=$O(^RGHL7(991.1,"ADFN",218,RGDFN)) Q:'RGDFN  D  Q:GOT
"RTN","RGEVPM",120,0)
 .S ICN=+$$GETICN^MPIF001(RGDFN)
"RTN","RGEVPM",121,0)
 .I $E(ICN,1,3)=LOC!(ICN<0) S GOT=1 Q
"RTN","RGEVPM",122,0)
 I GOT Q 1
"RTN","RGEVPM",123,0)
 Q 0
"RTN","RGHLLOG")
0^5^B10085269
"RTN","RGHLLOG",1,0)
RGHLLOG ;CAIRO/DKM-LOG MESSAGE PROCESSING INFO ;09/04/98
"RTN","RGHLLOG",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGHLLOG",3,0)
 ;=================================================================
"RTN","RGHLLOG",4,0)
 ; Log information about message processing and exceptions
"RTN","RGHLLOG",5,0)
 ; in CIRN HL7 Exception Log file.
"RTN","RGHLLOG",6,0)
 ;=================================================================
"RTN","RGHLLOG",7,0)
 ; Start time for run log
"RTN","RGHLLOG",8,0)
START(RGMSG,RGDC,RGPARAM) ;
"RTN","RGHLLOG",9,0)
 ;This entry point starts the log process in the CIRN HL7 EXCEPTION LOG
"RTN","RGHLLOG",10,0)
 ;file (#991.1), if the (#6) MINIMAL EXCEPTION LOGGING? field in
"RTN","RGHLLOG",11,0)
 ;File #990.8 is set to 0.
"RTN","RGHLLOG",12,0)
 ; Input: Required
"RTN","RGHLLOG",13,0)
 ;   RGMSG - IEN of message entry in File #773, usually HLMTIEN
"RTN","RGHLLOG",14,0)
 ;        Optional
"RTN","RGHLLOG",15,0)
 ;   RGDC - Event Class, associated with an entry in File #
"RTN","RGHLLOG",16,0)
 ;   RGPARAM - reprocessing routine
"RTN","RGHLLOG",17,0)
 S U="^"
"RTN","RGHLLOG",18,0)
 K RGLOG
"RTN","RGHLLOG",19,0)
 S RGLOG(3)=$G(RGMSG),RGLOG(5)=$G(RGDC),RGLOG(4)=$G(RGPARAM),RGLOG(1)=$$NOW^XLFDT
"RTN","RGHLLOG",20,0)
 I '$P(^RGSITE("COR",1,0),U,8) S RGLOG=$$CREATE
"RTN","RGHLLOG",21,0)
 Q
"RTN","RGHLLOG",22,0)
 ; Create a log entry
"RTN","RGHLLOG",23,0)
CREATE() Q:$G(RGLOG) RGLOG
"RTN","RGHLLOG",24,0)
 L +^RGHL7(991.1,0):10
"RTN","RGHLLOG",25,0)
 S RGLOG=$O(^RGHL7(991.1,$C(1)),-1)+1
"RTN","RGHLLOG",26,0)
 S:$G(RGLOG(1))="" RGLOG(1)=$$NOW^XLFDT S:$G(RGLOG(3))="" RGLOG(3)=$G(HLMTIEN)
"RTN","RGHLLOG",27,0)
 S (DA,X)=RGLOG,DIC="^RGHL7(991.1,",DIC(0)="L",DLAYGO=991.1,DIC("DR")="1///"_$G(RGLOG(1))_";3////"_$G(RGLOG(3))_";5///"_$G(RGLOG(5))_";4////"_$G(RGLOG(4)) K DD,DO D FILE^DICN K DIC,DA,X,DLAYGO
"RTN","RGHLLOG",28,0)
 L -^RGHL7(991.1,0)
"RTN","RGHLLOG",29,0)
 Q RGLOG
"RTN","RGHLLOG",30,0)
 ; Log time run completed
"RTN","RGHLLOG",31,0)
STOP(RGQUIT) ;
"RTN","RGHLLOG",32,0)
 ;This entry point completes the logging process
"RTN","RGHLLOG",33,0)
 ; Input: required
"RTN","RGHLLOG",34,0)
 ;    RGQUIT - 0 for success and 1 for failure
"RTN","RGHLLOG",35,0)
 ;
"RTN","RGHLLOG",36,0)
 Q:'$G(RGLOG)
"RTN","RGHLLOG",37,0)
 L +^RGHL7(991.1,RGLOG):10
"RTN","RGHLLOG",38,0)
 S DIE="^RGHL7(991.1,",DR="1.5///NOW;1.6///^S X=$G(RGQUIT)",DA=RGLOG D ^DIE K DIE,DA,DR
"RTN","RGHLLOG",39,0)
 L -^RGHL7(991.1,RGLOG)
"RTN","RGHLLOG",40,0)
 K RGLOG,RGQUIT,X,Y,DIC,DIE
"RTN","RGHLLOG",41,0)
 Q
"RTN","RGHLLOG",42,0)
 ; Log unclassified exception (old entry point)
"RTN","RGHLLOG",43,0)
ERR(RGERR,RGSEV) ;
"RTN","RGHLLOG",44,0)
 D EXC(18,RGERR)
"RTN","RGHLLOG",45,0)
 S RGQUIT=$G(RGQUIT)!$G(RGSEV)
"RTN","RGHLLOG",46,0)
 Q
"RTN","RGHLLOG",47,0)
 ; Log an exception
"RTN","RGHLLOG",48,0)
EXC(RGEXC,RGERR,RGDFN) ;
"RTN","RGHLLOG",49,0)
 ;This entry point logs exceptions in the CIRN HL7 EXCEPTION LOG
"RTN","RGHLLOG",50,0)
 ;file (#991.1)
"RTN","RGHLLOG",51,0)
 ; Input: Required
"RTN","RGHLLOG",52,0)
 ;   RGEXC - Exception type in File #991.11
"RTN","RGHLLOG",53,0)
 ;   RGERR - Supplemental text
"RTN","RGHLLOG",54,0)
 ;        Optional
"RTN","RGHLLOG",55,0)
 ;   RGDFN - IEN in the PATIENT file (#2)
"RTN","RGHLLOG",56,0)
 ;
"RTN","RGHLLOG",57,0)
 N RGI,RGZ
"RTN","RGHLLOG",58,0)
 S U="^"
"RTN","RGHLLOG",59,0)
 S:RGEXC[U RGERR=$P(RGEXC,U,2,999),RGEXC=+RGEXC
"RTN","RGHLLOG",60,0)
 S:RGEXC'=+RGEXC RGERR=RGEXC,RGEXC=18
"RTN","RGHLLOG",61,0)
 S:'$D(^RGHL7(991.11,RGEXC)) RGEXC=18
"RTN","RGHLLOG",62,0)
 L +^RGHL7(991.11,RGEXC):10
"RTN","RGHLLOG",63,0)
 S RGZ=$G(^RGHL7(991.11,RGEXC,0))
"RTN","RGHLLOG",64,0)
 S:$L(RGZ) $P(^RGHL7(991.11,RGEXC,0),U,5)=$P(RGZ,U,5)+1
"RTN","RGHLLOG",65,0)
 S:$P(RGZ,U,2)>1 RGQUIT=1
"RTN","RGHLLOG",66,0)
 L -^RGHL7(991.11,RGEXC)
"RTN","RGHLLOG",67,0)
 S RGLOG=$$CREATE
"RTN","RGHLLOG",68,0)
 L +^RGHL7(991.1,RGLOG):10
"RTN","RGHLLOG",69,0)
 S RGI=$O(^RGHL7(991.1,RGLOG,1,$C(1)),-1)+1
"RTN","RGHLLOG",70,0)
 S RGERR=$E($G(RGERR),1,100)
"RTN","RGHLLOG",71,0)
 S DIC="^RGHL7(991.1,"_RGLOG_",1,"
"RTN","RGHLLOG",72,0)
 S X=RGI,DA(1)=RGLOG,DIC(0)="FL",DLAYGO=991.12,DIC("P")=$P(^DD(991.1,2,0),"^",2)
"RTN","RGHLLOG",73,0)
 D ^DIC
"RTN","RGHLLOG",74,0)
 S DIE=DIC
"RTN","RGHLLOG",75,0)
 K DIC,DA,DR,DLAYGO
"RTN","RGHLLOG",76,0)
 S DA(1)=RGLOG,DA=RGI,DR="1///"_$G(RGLN)_";2///"_$G(RGEXC)_";3///"_$G(RGDFN)_";10///"_$G(RGERR)
"RTN","RGHLLOG",77,0)
 D ^DIE K DIE,DA,DR
"RTN","RGHLLOG",78,0)
 L -^RGHL7(991.1,RGLOG)
"RTN","RGHLLOG",79,0)
 S RGI=$P(RGZ,U,3),RGZ=$P(RGZ,U,4)
"RTN","RGHLLOG",80,0)
 Q:'RGI!'RGZ
"RTN","RGHLLOG",81,0)
 ;quit and don't send message for exception type 218 potential match
"RTN","RGHLLOG",82,0)
 Q:RGEXC=218
"RTN","RGHLLOG",83,0)
 S DIC="^XMB(3.8,",DIC(0)="NZ",X="`"_RGZ D ^DIC K DIC Q:+Y<1  S RGZ=$P(Y,U,2) K Y
"RTN","RGHLLOG",84,0)
 Q:RGZ=""!$P($G(^RGSITE("COR",1,0)),U,7)
"RTN","RGHLLOG",85,0)
 S RGERR=$$EXC^RGHLEXC(RGEXC,RGERR),RGZ="G."_RGZ
"RTN","RGHLLOG",86,0)
 I RGI=2 D ALERT^RGRSUTL2(RGERR,RGZ) Q
"RTN","RGHLLOG",87,0)
 D MAIL^RGRSUTL2(RGERR,RGZ,"CIRN Exception: "_$$EXC^RGHLEXC(RGEXC),"HL7 Msg#"_$G(RGLOG(3)))
"RTN","RGHLLOG",88,0)
 Q
"RTN","RGJCREC")
0^2^B43992526
"RTN","RGJCREC",1,0)
RGJCREC ;SF/JC,LTL-CIRN SUBSCRIPTION PROCESSOR ;05/12/98
"RTN","RGJCREC",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGJCREC",3,0)
REC ;Receive inbound CIRN Subscription request
"RTN","RGJCREC",4,0)
 ;Read in message for file 774 Master File Update
"RTN","RGJCREC",5,0)
 ;
"RTN","RGJCREC",6,0)
 Q:($G(HL("MTN"))'="MFN")!($G(HL("ETN"))'="Z15")  ;only process CIRN MFN/Z15 messages
"RTN","RGJCREC",7,0)
 K RGS,RGSEG,RGFS,RGCS,RGEC,RGSS,RGFILE,RGACT,RGCD,RGID,RGICN,RGSSN,RGPN,RGLL,RGTP,RGAD,RGTD,RGRAP,RGCMOR,RGDFN,RGPPFI,RGSCN,RGCURI,RGFROM,RGTO,RGSTUB,RGAD1,RGL,RGRC,HLER
"RTN","RGJCREC",8,0)
 N RGLOG,RGMTXT,X D START^RGHLLOG(HLMTIEN,"SCN_REQ","")
"RTN","RGJCREC",9,0)
 ;
"RTN","RGJCREC",10,0)
 S RGS="",U="^"
"RTN","RGJCREC",11,0)
 S RGFS=HL("FS") ;Field
"RTN","RGJCREC",12,0)
 S RGCS=$E(HL("ECH"),1) ;Component
"RTN","RGJCREC",13,0)
 S RGRC=$E(HL("ECH"),2) ;Repitition
"RTN","RGJCREC",14,0)
 S RGEC=$E(HL("ECH"),3) ;Escape
"RTN","RGJCREC",15,0)
 S RGSS=$E(HL("ECH"),4) ;Sub-component separator
"RTN","RGJCREC",16,0)
 F RGI=1:1 X HLNEXT Q:HLQUIT'>0  S (RGSEG,RGS(RGI))=HLNODE D
"RTN","RGJCREC",17,0)
 .S J=0 F  S J=$O(HLNODE(J)) Q:'J  S RGS(RGI,J)=HLNODE(J)
"RTN","RGJCREC",18,0)
 .D PARS
"RTN","RGJCREC",19,0)
 ;K RGLL ;TS 3-27-98
"RTN","RGJCREC",20,0)
 ;D PARS add this to hl7 processing logic above
"RTN","RGJCREC",21,0)
 I $D(RGFILE) Q:RGFILE'=774
"RTN","RGJCREC",22,0)
 ;Pt DFN
"RTN","RGJCREC",23,0)
 S RGDFN=$$GETDFN^MPIF001(+RGICN)
"RTN","RGJCREC",24,0)
 I +$$SEND2^VAFCUTL1(RGDFN,"T") D CLEAN Q  ;don't process test patients
"RTN","RGJCREC",25,0)
 ;Validate DFN/ICN/SSN on receiving system
"RTN","RGJCREC",26,0)
 I RGDFN'>0 D  D CLEAN Q
"RTN","RGJCREC",27,0)
 . S RGMTXT=" See Appendix F of the Clinical Information Resource Network Patient Demographics (CIRN-PD) and Master Patient Index (MPI) Installation and Implementation Guide."
"RTN","RGJCREC",28,0)
 . D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" Bad DFN, "_$G(RGDFN)_", for "_$G(RGPN)_" (ICN#"_$G(RGICN)_")"_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",29,0)
 I $P(^DPT(RGDFN,0),U,9)'=RGSSN D  D CLEAN Q
"RTN","RGJCREC",30,0)
 . S RGMTXT=" See Appendix B of the Clinical Information Resource Network (CIRN) Patient Administration User Manual."
"RTN","RGJCREC",31,0)
 . D EXC^RGHLLOG(213,"Msg#"_$G(HL("MID"))_" Mismatched SSN,"_$P(^DPT(RGDFN,0),U,9)_"/"_$G(RGSSN)_" for "_$G(RGPN)_" (ICN#"_$G(RGICN)_")"_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",32,0)
 ;Pt CMOR/Subscription Control Number
"RTN","RGJCREC",33,0)
 S RGPPFI=$$GETVCCI^MPIF001(RGDFN)
"RTN","RGJCREC",34,0)
 I +RGPPFI<1 D  D CLEAN Q
"RTN","RGJCREC",35,0)
 . S RGMTXT=" See Appendix F of the Clinical Information Resource Network Patient Demographics (CIRN-PD) and Master Patient Index (MPI) Installation and Implementation Guide."
"RTN","RGJCREC",36,0)
 . D EXC^RGHLLOG(211,"Msg#"_$G(HL("MID"))_" Bad CMOR "_$G(RGPPFI)_" for DFN#"_$G(RGDFN)_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",37,0)
 ;Verify that sender and receiver agree on CMOR
"RTN","RGJCREC",38,0)
 I RGCMOR'=RGPPFI D  D CLEAN Q
"RTN","RGJCREC",39,0)
 . S RGMTXT=" See Appendix F of the Clinical Information Resource Network Patient Demographics (CIRN-PD) and Master Patient Index (MPI) Installation and Implementation Guide."
"RTN","RGJCREC",40,0)
 . D EXC^RGHLLOG(211,"Msg#"_$G(HL("MID"))_" Mismatched CMOR, "_$G(RGCMOR)_"/"_$G(RGPPFI)_" for "_$G(RGPN)_" (ICN#"_$G(RGICN)_")"_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",41,0)
 S RGSCN=$$GETSCN(RGDFN)
"RTN","RGJCREC",42,0)
 I RGSCN="" D  D CLEAN Q
"RTN","RGJCREC",43,0)
 . S RGMTXT=" See Appendix F of the Clinical Information Resource Network Patient Demographics (CIRN-PD) and Master Patient Index (MPI) Installation and Implementation Guide."
"RTN","RGJCREC",44,0)
 . D EXC^RGHLLOG(228,"Msg#"_$G(HL("MPI"))_" "_$G(RGPN)_" Does not exist in patient database. "_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",45,0)
 ;Current Site ien
"RTN","RGJCREC",46,0)
 S RGCURI=+$$SITE^VASITE()
"RTN","RGJCREC",47,0)
 ;If not CMOR, don't update anyone else
"RTN","RGJCREC",48,0)
 I $$IFVCCI^MPIF001(RGDFN)'=1 D FIL K RGLL Q  ;TS 3-27-98
"RTN","RGJCREC",49,0)
 ;If filing data at owner site, que update to CLINICAL SUBSCRIBERS
"RTN","RGJCREC",50,0)
 D REC1
"RTN","RGJCREC",51,0)
 ;Add new clinical subscriber to local registry
"RTN","RGJCREC",52,0)
 D FIL
"RTN","RGJCREC",53,0)
 D REC2
"RTN","RGJCREC",54,0)
CLEAN K RGSTUB,RGLL ;TS 3-27-98
"RTN","RGJCREC",55,0)
 D STOP^RGHLLOG(0)
"RTN","RGJCREC",56,0)
 K RGS,RGSEG,RGFS,RGCS,RGEC,RGSS,RGFILE,RGACT,RGCD,RGID,RGICN,RGSSN,RGPN,RGLL,RGTP,RGAD,RGTD,RGRAP,RGCMOR,RGDFN,RGPPFI,RGSCN,RGCURI,RGFROM,RGTO,RGSTUB,RGAD1,RGL,RGRC,RGI
"RTN","RGJCREC",57,0)
 Q
"RTN","RGJCREC",58,0)
REC1 ;Update clinical subscribers with newest one
"RTN","RGJCREC",59,0)
 D GET^RGRSDYN1(RGDFN,RGSCN,0,"",.RGLL)
"RTN","RGJCREC",60,0)
 N I S I=0 F  S I=$O(RGLL("LINKS",I)) Q:I<1  D
"RTN","RGJCREC",61,0)
 .S RGFROM=RGLL ;New Subscriber
"RTN","RGJCREC",62,0)
 .I $E(RGFROM,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request from "_RGFROM_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",63,0)
 .S RGTO=$P(RGLL("LINKS",I),U,2) ;Destination (Clinical Subscriber)
"RTN","RGJCREC",64,0)
 .I $E(RGTO,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request to "_RGTO_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",65,0)
 .S RGSTUB=RGFROM_U_RGTO_U_RGICN_U_RGPN_U_RGTP_U_RGAD_U_$G(RGTD)
"RTN","RGJCREC",66,0)
 .D:RGFROM'=RGTO EN^RGEQ("SCN_REQ",RGSTUB) ;put on Event Queue
"RTN","RGJCREC",67,0)
 Q
"RTN","RGJCREC",68,0)
REC2 ;Update newest subscriber with previous subscribers and CMOR
"RTN","RGJCREC",69,0)
 ;change 4/10/98 CMC to get links
"RTN","RGJCREC",70,0)
 K RGLL("LINKS")
"RTN","RGJCREC",71,0)
 D GET^RGRSDYN1(RGDFN,RGSCN,0,"",.RGLL)
"RTN","RGJCREC",72,0)
 S I=0 F  S I=$O(RGLL("LINKS",I)) Q:I<1  D
"RTN","RGJCREC",73,0)
 .S RGTO=RGLL
"RTN","RGJCREC",74,0)
 .I $E(RGTO,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request to "_RGTO_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",75,0)
 .S RGFROM=$P(RGLL("LINKS",I),U,2)
"RTN","RGJCREC",76,0)
 .I $E(RGFROM,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request from "_RGFROM_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",77,0)
 .S RGSTUB=RGFROM_U_RGTO_U_RGICN_U_RGPN_U_RGTP_U_RGAD_U_$G(RGTD)
"RTN","RGJCREC",78,0)
 .I RGTO'=RGFROM D EN^RGEQ("SCN_REQ",RGSTUB)
"RTN","RGJCREC",79,0)
 ;Now send current institution (CMOR)
"RTN","RGJCREC",80,0)
 K RGL
"RTN","RGJCREC",81,0)
 D LINK^HLUTIL3(RGCURI,.RGL) S RGL=$O(RGL(0)) Q:RGL<1
"RTN","RGJCREC",82,0)
 ;changed cmc 5/9/98
"RTN","RGJCREC",83,0)
 S RGSTUB=RGL(RGL)_U_RGLL_U_RGICN_U_RGPN_U_RGTP_U_RGAD_U_$G(RGTD)
"RTN","RGJCREC",84,0)
 D:RGL(RGL)'=RGLL EN^RGEQ("SCN_REQ",RGSTUB)
"RTN","RGJCREC",85,0)
 K RGSTUB
"RTN","RGJCREC",86,0)
 Q
"RTN","RGJCREC",87,0)
PARS ;Parse it
"RTN","RGJCREC",88,0)
 I $E(RGSEG,1,3)="MFI" D
"RTN","RGJCREC",89,0)
 .S RGFILE=+$P(RGSEG,RGFS,2) ;File number
"RTN","RGJCREC",90,0)
 I $E(RGSEG,1,3)="MFE" D
"RTN","RGJCREC",91,0)
 .S RGACT=$P(RGSEG,RGFS,2) ;Action
"RTN","RGJCREC",92,0)
 .S RGCD=$P(RGSEG,RGFS,4) ;creation date
"RTN","RGJCREC",93,0)
 .S RGID=$P(RGSEG,RGFS,5) D  ;Primary Key
"RTN","RGJCREC",94,0)
 ..S RGICN=+RGID,RGSSN=$P(RGID,RGSS,2),RGPN=$P(RGID,RGCS,2) ;ICN,Patient Name
"RTN","RGJCREC",95,0)
 I $E(RGSEG,1,3)="ZSD" D
"RTN","RGJCREC",96,0)
 .S RGLL=$P(RGSEG,RGFS,2) ;LLink
"RTN","RGJCREC",97,0)
 .S RGTP=$P(RGSEG,RGFS,3) ;Type
"RTN","RGJCREC",98,0)
 .S RGAD=$P(RGSEG,RGFS,4) ;Activation Date
"RTN","RGJCREC",99,0)
 .S RGTD=$P(RGSEG,RGFS,5) ;Termination Date
"RTN","RGJCREC",100,0)
 .S RGRAP=$P(RGSEG,RGFS,6) ;Receiving Application
"RTN","RGJCREC",101,0)
 .S RGCMOR=$P(RGSEG,RGFS,7) ;CIRN Master of Record
"RTN","RGJCREC",102,0)
 Q
"RTN","RGJCREC",103,0)
GETSCN(RGDPT) ;Return existing SCN or Activate a new subscription for this patient
"RTN","RGJCREC",104,0)
 ;RGDPT=PATIENT DFN
"RTN","RGJCREC",105,0)
 N RGAR,RGAN
"RTN","RGJCREC",106,0)
 ;get subscription control #
"RTN","RGJCREC",107,0)
 S RGSCN=+$P($$MPINODE^MPIFAPI(RGDPT),"^",5)
"RTN","RGJCREC",108,0)
 ;if no SCN, create new and update 991.05, then return result
"RTN","RGJCREC",109,0)
 I 'RGSCN S RGSCN=$$ACT^HLSUB S RGAR(991.05)=RGSCN S RGAN=$$UPDATE^MPIFAPI(RGDPT,"RGAR") I RGAN=-1 S RGSCN=""
"RTN","RGJCREC",110,0)
 Q RGSCN
"RTN","RGJCREC",111,0)
FIL ;File message
"RTN","RGJCREC",112,0)
 ;Normalize dates
"RTN","RGJCREC",113,0)
 N RGCHK,RGTD1
"RTN","RGJCREC",114,0)
 S RGAD1=$$DTHF^RGHLUT(RGAD)
"RTN","RGJCREC",115,0)
 I $G(RGTD)]"" S RGTD1=$$DTHF^RGHLUT(RGTD)
"RTN","RGJCREC",116,0)
 ;check to see if this subscriber is yourself
"RTN","RGJCREC",117,0)
 D LINK^HLUTIL3(+$$SITE^VASITE,.RGCHK) Q:$O(RGCHK(0))=""  S RGCHK=RGCHK($O(RGCHK(0)))
"RTN","RGJCREC",118,0)
 I $G(RGCHK)'=RGLL D UPD^HLSUB(RGSCN,RGLL,RGTP,RGAD1,$G(RGTD1),$G(RGRAP),.HLER)
"RTN","RGJCREC",119,0)
 Q
"RTN","RGJCREC",120,0)
GETINST(LINK) ;returns institution ien from logical link
"RTN","RGJCREC",121,0)
 I $G(LINK)="" Q 0
"RTN","RGJCREC",122,0)
 S DIC=870,DIC(0)="EMQZ",X=LINK D ^DIC
"RTN","RGJCREC",123,0)
 I Y=-1 Q Y
"RTN","RGJCREC",124,0)
 Q $P(Y(0),"^",2)
"RTN","RGJCSUB")
0^9^B56551769
"RTN","RGJCSUB",1,0)
RGJCSUB ;SF/JC-CIRN SUBSCRIPTION GENERATOR ;04/30/97
"RTN","RGJCSUB",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGJCSUB",3,0)
SUB ;Interactive PATIENT SUBSCRIPTION REQUEST
"RTN","RGJCSUB",4,0)
 ;Institution originating request
"RTN","RGJCSUB",5,0)
 N RGFROM,RGFROMS,RGFRLNK
"RTN","RGJCSUB",6,0)
 S RGFROM=+$$KSP^XUPARAM("INST")
"RTN","RGJCSUB",7,0)
 S DIC=4,DIC(0)="XMQZ",X=RGFROM D ^DIC
"RTN","RGJCSUB",8,0)
 K DIC,DA,DR
"RTN","RGJCSUB",9,0)
 S DIC("A")="Select your current institution: "
"RTN","RGJCSUB",10,0)
 S DIC=4,DIC(0)="AEMQZ",DIC("B")=$P(Y,U,2) D ^DIC
"RTN","RGJCSUB",11,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","RGJCSUB",12,0)
 S RGFROM=$P(Y,U,2)
"RTN","RGJCSUB",13,0)
 K DIC,DUOUT,DTOUT
"RTN","RGJCSUB",14,0)
 ;Local Station Number
"RTN","RGJCSUB",15,0)
 S RGFROMS=$$GET1^DIQ(4,+Y_",",99)
"RTN","RGJCSUB",16,0)
 ;Logical Link
"RTN","RGJCSUB",17,0)
 D LINK^HLUTIL3(RGFROM,.HLI)
"RTN","RGJCSUB",18,0)
 S HLI=+$O(HLI(0)) I 'HLI W !!,"There's no LOGICAL LINK associated with the facility you entered." G SUB
"RTN","RGJCSUB",19,0)
 S RGFRLNK=HLI(HLI)
"RTN","RGJCSUB",20,0)
 K HLI
"RTN","RGJCSUB",21,0)
PAT ;Patient ICN
"RTN","RGJCSUB",22,0)
 N RGDFN,RGNAME,RGICN
"RTN","RGJCSUB",23,0)
 S DIC="^DPT(",DIC(0)="AEQMZ" D ^DIC Q:Y'>0  S RGDFN=+Y
"RTN","RGJCSUB",24,0)
 S RGNAME=$P(Y,U,2),RGICN=$$GETICN^MPIF001(RGDFN)
"RTN","RGJCSUB",25,0)
 I +RGICN=-1 W !,"ERROR - Patient, ",RGNAME," does not have an INTEGRATION CONTROL NUMBER ASSIGNED." Q
"RTN","RGJCSUB",26,0)
VCCI ;Owner Site
"RTN","RGJCSUB",27,0)
 S RGVCCI=$$GETVCCI^MPIF001(RGDFN) ;SITE IEN
"RTN","RGJCSUB",28,0)
 S RGVCCIS=$$GET1^DIQ(4,+RGVCCI_",",99) ;INSTITUTION NUMBER
"RTN","RGJCSUB",29,0)
 S RGVCCIN=$$GET1^DIQ(4,+RGVCCI_",",.01) ;SITE NAME
"RTN","RGJCSUB",30,0)
 I RGVCCIN=RGFROM!(RGVCCI="") W !,"You appear to be the owner site for this patient.",!,"The local Subscription Registry will not be updated." Q
"RTN","RGJCSUB",31,0)
 W !,"The CMOR Site for this patient is ",$G(RGVCCIN)
"RTN","RGJCSUB",32,0)
TYPE ;Subscription type-0=descriptive,1=descriptive and clinical
"RTN","RGJCSUB",33,0)
 N RGTYPE,RGTYPEX
"RTN","RGJCSUB",34,0)
 K DIR
"RTN","RGJCSUB",35,0)
 S DIR(0)="SM^0:Descriptive;1:Clinical and Descriptive"
"RTN","RGJCSUB",36,0)
 S DIR("A")="Enter the TYPE of subscription: "
"RTN","RGJCSUB",37,0)
 S DIR("B")="Clinical and Descriptive"
"RTN","RGJCSUB",38,0)
 D ^DIR K DIR
"RTN","RGJCSUB",39,0)
 Q:$D(DUOUT)!($D(DTOUT))
"RTN","RGJCSUB",40,0)
 S RGTYPE=Y,RGTYPEX=Y(0)
"RTN","RGJCSUB",41,0)
TARGET ;Institution to receive request
"RTN","RGJCSUB",42,0)
 N RGTO,RGTOS
"RTN","RGJCSUB",43,0)
 S DIC=4,DIC(0)="AEMQZ"
"RTN","RGJCSUB",44,0)
 S DIC("A")="Send subscription request to which institution? "
"RTN","RGJCSUB",45,0)
 S DIC("B")=$$GET1^DIQ(4,+RGVCCI_",",.01)
"RTN","RGJCSUB",46,0)
 D ^DIC
"RTN","RGJCSUB",47,0)
 K DIC
"RTN","RGJCSUB",48,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","RGJCSUB",49,0)
 S RGTO=$P(Y,U,2),RGTOS=+$$GET1^DIQ(4,+Y_",",99)
"RTN","RGJCSUB",50,0)
 ;Logical Link
"RTN","RGJCSUB",51,0)
 N HLI,RGTOLNK
"RTN","RGJCSUB",52,0)
 D LINK^HLUTIL3(RGTO,.HLI)
"RTN","RGJCSUB",53,0)
 S HLI=+$O(HLI(0))
"RTN","RGJCSUB",54,0)
 I 'HLI W !,"There is no LOGICAL LINK associated with this institution.",!,"Your request cannot be transmitted without this information." Q
"RTN","RGJCSUB",55,0)
 S RGTOLNK=HLI(HLI)
"RTN","RGJCSUB",56,0)
 K HLI
"RTN","RGJCSUB",57,0)
AD ;Activation date/time+/-TIMEZONE OFFSET
"RTN","RGJCSUB",58,0)
 N RGAD,RGTZAD
"RTN","RGJCSUB",59,0)
 S %DT="AETX",%DT("A")="Enter the ACTIVATION DATE/TIME: "
"RTN","RGJCSUB",60,0)
 S %DT("B")="NOW"
"RTN","RGJCSUB",61,0)
 D ^%DT
"RTN","RGJCSUB",62,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","RGJCSUB",63,0)
 I Y=-1 W !,"Invalid date" G AD
"RTN","RGJCSUB",64,0)
 S RGAD=Y,RGTZAD=$$DTFH^RGHLUT(Y,1)
"RTN","RGJCSUB",65,0)
TD ;Optional Termination Date
"RTN","RGJCSUB",66,0)
 N RGTD,RGTZTD
"RTN","RGJCSUB",67,0)
 K %DT
"RTN","RGJCSUB",68,0)
 S %DT="AETX",%DT("A")="Enter an optional TERMINATION DATE/TIME: "
"RTN","RGJCSUB",69,0)
 D ^%DT
"RTN","RGJCSUB",70,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","RGJCSUB",71,0)
 I Y>0 S RGTD=Y,RGTZTD=$$DTFH^RGHLUT(Y,1)
"RTN","RGJCSUB",72,0)
REVIEW ;
"RTN","RGJCSUB",73,0)
 W !!
"RTN","RGJCSUB",74,0)
 W "You are about to submit a PATIENT SUBSCRIPTION REQUEST ",!
"RTN","RGJCSUB",75,0)
 W "with the following information:",!!
"RTN","RGJCSUB",76,0)
 W "ORIGIN OF REQUEST: ",RGFROMS,"   NETWORK NODE: ",RGFRLNK,!!
"RTN","RGJCSUB",77,0)
 W "RECEIVER OF REQUEST: ",RGTOS,"   NETWORK NODE: ",RGTOLNK,!!
"RTN","RGJCSUB",78,0)
 W "SUBSCRIPTION TYPE: ",RGTYPEX,!!
"RTN","RGJCSUB",79,0)
 W "PATIENT: ",RGNAME,!!
"RTN","RGJCSUB",80,0)
 W "PATIENT ICN: ",RGICN,!!
"RTN","RGJCSUB",81,0)
 W "ACTIVATION DATE: ",$$FMTE^XLFDT(RGAD,1),!!
"RTN","RGJCSUB",82,0)
 I $G(RGTD) W "TERMINATION DATE: ",$$FMTE^XLFDT(RGTD,1),!!
"RTN","RGJCSUB",83,0)
 K DIR
"RTN","RGJCSUB",84,0)
 S DIR("A")="Is this correct? "
"RTN","RGJCSUB",85,0)
 S DIR("?")="Enter '^' to quit, 'NO' to start over."
"RTN","RGJCSUB",86,0)
 S DIR("?",1)="Accepting this information will result in a message"
"RTN","RGJCSUB",87,0)
 S DIR("?",2)="being sent to the institution (receiver) you have specified."
"RTN","RGJCSUB",88,0)
 S DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR
"RTN","RGJCSUB",89,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","RGJCSUB",90,0)
 I Y=0 G SUB
"RTN","RGJCSUB",91,0)
 D BM(RGFRLNK,RGTOLNK,+RGICN,RGNAME,RGTYPE,RGTZAD,$G(RGTZTD))
"RTN","RGJCSUB",92,0)
 Q
"RTN","RGJCSUB",93,0)
EQ(RGEV,RGSTUB,RGERR,RGEP) ;Entry point for Event Queue Processor
"RTN","RGJCSUB",94,0)
 S FLL=$P(RGSTUB,U),TLL=$P(RGSTUB,U,2),ICN=$P(RGSTUB,U,3)
"RTN","RGJCSUB",95,0)
 S PN=$P(RGSTUB,U,4),TP=$P(RGSTUB,U,5),AD=$P(RGSTUB,U,6)
"RTN","RGJCSUB",96,0)
 S TD=$P(RGSTUB,U,7)
"RTN","RGJCSUB",97,0)
 I FLL=""!(TLL="")!(ICN="")!(PN="")!(TP="") S RGERR="REQUIRED PARAMETERS MISSING IN STUB"
"RTN","RGJCSUB",98,0)
 I AD="" S AD=$$NOW^XLFDT,AD=$$DTFH^RGHLUT(AD,1) ;activation date
"RTN","RGJCSUB",99,0)
 D BM(FLL,TLL,ICN,PN,TP,AD,TD)
"RTN","RGJCSUB",100,0)
 Q
"RTN","RGJCSUB",101,0)
BM(FLL,TLL,ICN,PN,TP,AD,TD) ;Build Subscription Request Message
"RTN","RGJCSUB",102,0)
 ;FLL-'FROM' LOGICAL LINK NAME
"RTN","RGJCSUB",103,0)
 ;TLL-'TO' LOGICAL LINK NAME
"RTN","RGJCSUB",104,0)
 ;ICN-PATIENT ID
"RTN","RGJCSUB",105,0)
 ;PN-PATIENT NAME
"RTN","RGJCSUB",106,0)
 ;TP-SUBSCRIPTION TYPE
"RTN","RGJCSUB",107,0)
 ;AD-ACTIVATION DATE HL7 FORMAT
"RTN","RGJCSUB",108,0)
 ;TD-TERMINATION DATE HL7 FORMAT-OPTIONAL
"RTN","RGJCSUB",109,0)
 N RGCMOR,RGDFN,RGSSN
"RTN","RGJCSUB",110,0)
 Q:'+ICN
"RTN","RGJCSUB",111,0)
 S RGDFN=$$GETDFN^MPIF001(+ICN) Q:+RGDFN<1
"RTN","RGJCSUB",112,0)
 S RGSSN=$P(^DPT(RGDFN,0),U,9)
"RTN","RGJCSUB",113,0)
 ;Get institution number of CMOR
"RTN","RGJCSUB",114,0)
 S RGCMOR=$$GETVCCI^MPIF001(RGDFN)
"RTN","RGJCSUB",115,0)
 N RGCS,RGRC,RGEC,RGSS,HL
"RTN","RGJCSUB",116,0)
 D INIT^HLFNC2("RG PT SUBSCRIPTION REQUEST",.HL) Q:+$G(HL)
"RTN","RGJCSUB",117,0)
 S HLL("LINKS",1)="RG PT SUBSCRIPTION RECEIVER^"_TLL
"RTN","RGJCSUB",118,0)
 S RGCS=$E(HL("ECH"),1) ;Component
"RTN","RGJCSUB",119,0)
 S RGRC=$E(HL("ECH"),2) ;Repitition
"RTN","RGJCSUB",120,0)
 S RGEC=$E(HL("ECH"),3) ;Escape
"RTN","RGJCSUB",121,0)
 S RGSS=$E(HL("ECH"),4) ;Sub-component separator
"RTN","RGJCSUB",122,0)
MFI ;MFI-master file identifier segment
"RTN","RGJCSUB",123,0)
 N X,HLA S X=""
"RTN","RGJCSUB",124,0)
 S $P(X,HL("FS"))="MFI"
"RTN","RGJCSUB",125,0)
 S $P(X,HL("FS"),2)="774"_RGCS_"SUBSCRIPTION REGISTRY"_RGCS_"L"
"RTN","RGJCSUB",126,0)
 S $P(X,HL("FS"),4)="UPD"
"RTN","RGJCSUB",127,0)
 S $P(X,HL("FS"),7)="NE"
"RTN","RGJCSUB",128,0)
 S HLA("HLS",1)=X
"RTN","RGJCSUB",129,0)
MFE ;MFE-master file entry segment
"RTN","RGJCSUB",130,0)
 S X=""
"RTN","RGJCSUB",131,0)
 S $P(X,HL("FS"))="MFE"
"RTN","RGJCSUB",132,0)
 S $P(X,HL("FS"),2)="MUP",$P(X,HL("FS"),4)=AD
"RTN","RGJCSUB",133,0)
 S $P(X,HL("FS"),5)=+ICN_RGSS_RGSSN_RGSS_2_RGCS_PN_RGCS_"L"
"RTN","RGJCSUB",134,0)
 S HLA("HLS",2)=X
"RTN","RGJCSUB",135,0)
DATA ;Record level data in 'ZSD' SEGMENT
"RTN","RGJCSUB",136,0)
 S HLA("HLS",3)="ZSD"_HL("FS")_FLL_HL("FS")_TP_HL("FS")_AD_HL("FS")_$G(TD)_HL("FS")_HL("FS")_RGCMOR
"RTN","RGJCSUB",137,0)
SEND ;SEND TO HL7 PACKAGE
"RTN","RGJCSUB",138,0)
 N HLRST
"RTN","RGJCSUB",139,0)
 D GENERATE^HLMA("RG PT SUBSCRIPTION REQUEST","LM",1,.HLRST,"",.HL)
"RTN","RGJCSUB",140,0)
 Q
"RTN","RGJCSUB",141,0)
ROUTE ;routing logic-parse A04 and put new message on event queue
"RTN","RGJCSUB",142,0)
 ;to primary facility
"RTN","RGJCSUB",143,0)
 ;If triggered by an A04
"RTN","RGJCSUB",144,0)
 ;I $G(HL("ETN"))'="A04" Q
"RTN","RGJCSUB",145,0)
 K RGLL D R1
"RTN","RGJCSUB",146,0)
 K RGVCCI,RGVCCIN,RGVCCIS
"RTN","RGJCSUB",147,0)
 Q
"RTN","RGJCSUB",148,0)
R1 ;A04
"RTN","RGJCSUB",149,0)
 N RGI,RGFS,RGLOC,RGLOCIEN,RGLOCNM,RGLOCSN,RGPN,RGSN,RGS,RGSCN,RGTP,RGTO
"RTN","RGJCSUB",150,0)
 S RGS="",RGFS=HL("FS")
"RTN","RGJCSUB",151,0)
 F RGI=1:1 X HLNEXT Q:HLQUIT'>0  Q:$P(HLNODE,HL("FS"))="PID"
"RTN","RGJCSUB",152,0)
 Q:HLQUIT'>0
"RTN","RGJCSUB",153,0)
 S RGICN=+$P(HLNODE,HL("FS"),3)
"RTN","RGJCSUB",154,0)
 Q:'RGICN
"RTN","RGJCSUB",155,0)
 S RGDFN=+$$GETDFN^MPIF001(RGICN)
"RTN","RGJCSUB",156,0)
 Q:RGDFN'>0
"RTN","RGJCSUB",157,0)
 S RGVCCI=$$GETVCCI^MPIF001(RGDFN)
"RTN","RGJCSUB",158,0)
 Q:RGVCCI<1
"RTN","RGJCSUB",159,0)
 ;fix TS need IEN for compare not sta. num.
"RTN","RGJCSUB",160,0)
 S RGVCCI=$$LKUP^XUAF4(RGVCCI)
"RTN","RGJCSUB",161,0)
 I RGVCCI="" D START^RGHLLOG(HLMTIEN),EXC^RGHLLOG(229,"MSG#"_$G(HLMID)_" Unable to send Subscription.  Duplicate station number of "_$$GETVCCI^MPIF001(RGDFN)_" in Institution file.",RGDFN) D STOP^RGHLLOG() Q
"RTN","RGJCSUB",162,0)
 S RGPN=$P(^DPT(RGDFN,0),U) Q:RGPN=""
"RTN","RGJCSUB",163,0)
 S RGTP=1 ;clinical update
"RTN","RGJCSUB",164,0)
 S RGAD=$$NOW^XLFDT,RGAD=$$DTFH^RGHLUT(RGAD,1) ;activation date
"RTN","RGJCSUB",165,0)
 ;Local Station information
"RTN","RGJCSUB",166,0)
 S RGLOC=$$SITE^VASITE(),RGLOCIEN=$P(RGLOC,U,1),RGLOCNM=$P(RGLOC,U,2),RGLOCSN=$P(RGLOC,U,3)
"RTN","RGJCSUB",167,0)
 I RGVCCI=RGLOCIEN D  ;current site is owner site, update existing subscribers
"RTN","RGJCSUB",168,0)
 .S RGSCN=$$GETSCN^RGJCREC(RGDFN) ;get SCN
"RTN","RGJCSUB",169,0)
 .D LINK^HLUTIL3(RGLOCIEN,.RGFROM) ;get local link definition
"RTN","RGJCSUB",170,0)
 .S RGLL=$O(RGFROM(0)) Q:RGLL=""  S RGLL=RGFROM(RGLL)
"RTN","RGJCSUB",171,0)
 .D REC1^RGJCREC
"RTN","RGJCSUB",172,0)
 I RGVCCI'=RGLOCIEN D  ;current site is not owner, update only owner
"RTN","RGJCSUB",173,0)
 .D LINK^HLUTIL3(RGLOCIEN,.RGFROM) ;Local Link
"RTN","RGJCSUB",174,0)
 .S RGFROM=$O(RGFROM(0)) Q:RGFROM=""  S RGFROM=RGFROM(RGFROM) ;sending facility
"RTN","RGJCSUB",175,0)
 .I $E(RGFROM,1,2)'="VA" D START^RGHLLOG(HLMTIEN),EXC^RGHLLOG(224,"MSG#"_$G(HLMID)_" Unable to send Subscription from "_RGFROM_".  This is not a CIRN Site.",RGDFN) D STOP^RGHLLOG() Q
"RTN","RGJCSUB",176,0)
 .D LINK^HLUTIL3(RGVCCI,.RGTO) ;get VCCI Link
"RTN","RGJCSUB",177,0)
 .S RGTO=$O(RGTO(0)) Q:RGTO=""
"RTN","RGJCSUB",178,0)
 .S RGTO=RGTO(RGTO) ;receiving facility
"RTN","RGJCSUB",179,0)
 .I $E(RGTO,1,2)'="VA" D START^RGHLLOG(HLMTIEN),EXC^RGHLLOG(224,"MSG#"_$G(HLMID)_" Unable to send Subscription to "_RGTO_".  This is not a CIRN Site.",RGDFN) D STOP^RGHLLOG() Q
"RTN","RGJCSUB",180,0)
 .Q:RGTO=RGFROM
"RTN","RGJCSUB",181,0)
 .S RGSTUB=RGFROM_U_RGTO_U_RGICN_U_RGPN_U_RGTP_U_RGAD
"RTN","RGJCSUB",182,0)
 .D EN^RGEQ("SCN_REQ",RGSTUB)
"RTN","RGJCTS01")
0^10^B5403236
"RTN","RGJCTS01",1,0)
RGJCTS01 ;SLC/TS-SUBSCRIPTION CONTROL STARTUP UTILITY TO CMOR ;09/18/97
"RTN","RGJCTS01",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGJCTS01",3,0)
 ;IMPROVED FOR CMOR COMMUNICATION TS
"RTN","RGJCTS01",4,0)
INSERT(ZZHLDPT) ; pass dfn
"RTN","RGJCTS01",5,0)
 S ZZRGEV="SCN_REQ"
"RTN","RGJCTS01",6,0)
 K ZZFMLK,ZZTOLK
"RTN","RGJCTS01",7,0)
 ;setup for event stub
"RTN","RGJCTS01",8,0)
 S ZZHLINST=+$$KSP^XUPARAM("INST") ;who are we
"RTN","RGJCTS01",9,0)
 D LINK^HLUTIL3(ZZHLINST,.ZZFMLK) S ZZFMLK=$O(ZZFMLK(0)) Q:ZZFMLK<1
"RTN","RGJCTS01",10,0)
 S $P(ZZSTUB,U,1)=ZZFMLK(ZZFMLK)
"RTN","RGJCTS01",11,0)
 I $E($P(ZZSTUB,U,1),1,2)'="VA" D
"RTN","RGJCTS01",12,0)
 . D START^RGHLLOG(HLMTIEN,"SCN_REQ",""),EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request from, "_$P($G(ZZSTUB),U,1)_".  This is not a CIRN site.",ZZHLDPT) D STOP^RGHLLOG(1) Q 
"RTN","RGJCTS01",13,0)
 S ZZTOST=$$GETVCCI^MPIF001(ZZHLDPT) ;who owns him
"RTN","RGJCTS01",14,0)
 ;fix TS change to IEN
"RTN","RGJCTS01",15,0)
 S ZZTOST=$$LKUP^XUAF4(ZZTOST)
"RTN","RGJCTS01",16,0)
 D LINK^HLUTIL3(ZZTOST,.ZZTOLK) S ZZTOLK=$O(ZZTOLK(0)) Q:ZZTOLK<1
"RTN","RGJCTS01",17,0)
 S $P(ZZSTUB,U,2)=ZZTOLK(ZZTOLK)
"RTN","RGJCTS01",18,0)
 I $E($P(ZZSTUB,U,2),1,2)'="VA" D
"RTN","RGJCTS01",19,0)
 . D START^RGHLLOG(HLMTIEN,"SCN_REQ",""),EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request to, "_$P($G(ZZSTUB),U,2)_".  This is not a CIRN site.",ZZHLDPT) D STOP^RGHLLOG(1) Q
"RTN","RGJCTS01",20,0)
 S ZZRGICN=$$GETICN^MPIF001(ZZHLDPT)
"RTN","RGJCTS01",21,0)
 S $P(ZZSTUB,U,3)=ZZRGICN
"RTN","RGJCTS01",22,0)
 S DIC="^DPT(",DIC(0)="NZ",X=ZZHLDPT D ^DIC Q:Y'>0  S ZZPNM=$P(Y,U,2)
"RTN","RGJCTS01",23,0)
 S $P(ZZSTUB,U,4)=ZZPNM
"RTN","RGJCTS01",24,0)
 S $P(ZZSTUB,U,5)=0
"RTN","RGJCTS01",25,0)
 Q:ZZFMLK(ZZFMLK)=ZZTOLK(ZZTOLK)
"RTN","RGJCTS01",26,0)
 D EN^RGEQ(ZZRGEV,ZZSTUB)
"RTN","RGJCTS01",27,0)
 K ZZHLINST,ZZRGEV,ZZFMLK,ZZTOLK,ZZSTUB,ZZTOST,ZZRGICN,ZZPNM,X,Y,DIC
"RTN","RGJCTS01",28,0)
 Q
"RTN","RGP1ENV")
0^^B591900
"RTN","RGP1ENV",1,0)
RGP1ENV ;B'HAM/PTD-RG*1*1 PATCH ENVIRONMENT CHECK ROUTINE ;06/17/99
"RTN","RGP1ENV",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGP1ENV",3,0)
 ;Determine current version of CIRN installed.
"RTN","RGP1ENV",4,0)
 S RGVER=$$VERSION^XPDUTL("RG")
"RTN","RGP1ENV",5,0)
 ;If version not 1.0, abort install.
"RTN","RGP1ENV",6,0)
 I (RGVER'="1.0") W !!," CLINICAL INFO RESOURCE NETWORK version 1.0 must be installed." S XPDQUIT=2
"RTN","RGP1ENV",7,0)
 I '$D(XPDQUIT) W !!,"Environment check is ok.",!
"RTN","RGP1ENV",8,0)
 K RGVER
"RTN","RGP1ENV",9,0)
 Q
"RTN","RGP1ENV",10,0)
 ;
"RTN","RGRSBUL1")
0^4^B25678433
"RTN","RGRSBUL1",1,0)
RGRSBUL1 ;ALB/RJS,CML-RGRSTEXT BULLTINE ROUTINE (PART 2) ;07/24/98
"RTN","RGRSBUL1",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGRSBUL1",3,0)
SSNBULL(DFN,ARRAY,NAME,SSN,ICN,CMOR) ;
"RTN","RGRSBUL1",4,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",5,0)
 ;ISSUES mail group about an SSN change for a given patient.
"RTN","RGRSBUL1",6,0)
 ;
"RTN","RGRSBUL1",7,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",8,0)
 ;
"RTN","RGRSBUL1",9,0)
 ;   DFN   - IEN in the PATIENT file (#2)
"RTN","RGRSBUL1",10,0)
 ;  ARRAY  - Array of data containing sending sites station number
"RTN","RGRSBUL1",11,0)
 ;   NAME  - Patient's Name
"RTN","RGRSBUL1",12,0)
 ;   SSN   - Patient's SSN
"RTN","RGRSBUL1",13,0)
 ;   ICN   - Patient's ICN (Integration Control Number) 
"RTN","RGRSBUL1",14,0)
 ;   CMOR  - Patient's CMOR (CIRN Master of Record)
"RTN","RGRSBUL1",15,0)
 ;
"RTN","RGRSBUL1",16,0)
 Q:$G(DFN)=""!($G(ARRAY)="")
"RTN","RGRSBUL1",17,0)
 N LOCDATA,RGRSTEXT,INDEX,COUNTER
"RTN","RGRSBUL1",18,0)
 S RGRSTEXT(1)="The CIRN Package has received an SSN change from:"
"RTN","RGRSBUL1",19,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",20,0)
 S RGRSTEXT(3)="           "
"RTN","RGRSBUL1",21,0)
 S RGRSTEXT(4)="This change has been made in your local data base for:"
"RTN","RGRSBUL1",22,0)
 S RGRSTEXT(5)=NAME
"RTN","RGRSBUL1",23,0)
 S RGRSTEXT(6)="           "
"RTN","RGRSBUL1",24,0)
 S RGRSTEXT(7)="=> Local "_$P($$SITE^VASITE(),"^",2)_" data PRIOR to update:"
"RTN","RGRSBUL1",25,0)
 S RGRSTEXT(8)="NAME: "_NAME
"RTN","RGRSBUL1",26,0)
 S RGRSTEXT(9)="SSN: "_SSN
"RTN","RGRSBUL1",27,0)
 S RGRSTEXT(10)="ICN: "_ICN
"RTN","RGRSBUL1",28,0)
 S RGRSTEXT(11)="CMOR: "_CMOR
"RTN","RGRSBUL1",29,0)
 S RGRSTEXT(12)="--------------------------------------------------------"
"RTN","RGRSBUL1",30,0)
 S RGRSTEXT(13)="=> Update received from "_$P($$INST(@ARRAY@("SENDING SITE"))," -->")_":"
"RTN","RGRSBUL1",31,0)
 S RGRSTEXT(14)="SSN: "_@ARRAY@("SSN")
"RTN","RGRSBUL1",32,0)
 D BULL2^RGRSBULL("CIRN SSN CHANGE - "_NAME,"RGRSTEXT(")
"RTN","RGRSBUL1",33,0)
 Q
"RTN","RGRSBUL1",34,0)
 ;
"RTN","RGRSBUL1",35,0)
NOT2(ARRAY) ;
"RTN","RGRSBUL1",36,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",37,0)
 ;ISSUES mail group about invalid subscription information for a given
"RTN","RGRSBUL1",38,0)
 ;patient.
"RTN","RGRSBUL1",39,0)
 ;
"RTN","RGRSBUL1",40,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",41,0)
 ;
"RTN","RGRSBUL1",42,0)
 ;  ARRAY  - Array of information regarding the invalid subscription
"RTN","RGRSBUL1",43,0)
 ;
"RTN","RGRSBUL1",44,0)
 Q:($G(ARRAY)="")
"RTN","RGRSBUL1",45,0)
 N RGRSTEXT,INDEX,COUNTER
"RTN","RGRSBUL1",46,0)
 S RGRSTEXT(1)="The CIRN Package has received a message from:"
"RTN","RGRSBUL1",47,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",48,0)
 S RGRSTEXT(3)="This patient has your station as a subscriber, however"
"RTN","RGRSBUL1",49,0)
 S RGRSTEXT(4)="the patient was not found in your database."
"RTN","RGRSBUL1",50,0)
 S RGRSTEXT(5)="--------------------------------------------------------"
"RTN","RGRSBUL1",51,0)
 S RGRSTEXT(6)="Remote Data"
"RTN","RGRSBUL1",52,0)
 S RGRSTEXT(7)="           "
"RTN","RGRSBUL1",53,0)
 S INDEX=0,COUNTER=8
"RTN","RGRSBUL1",54,0)
 F  S INDEX=$O(@ARRAY@("MESSAGE",INDEX)) Q:INDEX']""  D
"RTN","RGRSBUL1",55,0)
 . S RGRSTEXT(COUNTER)=@ARRAY@("MESSAGE",INDEX)
"RTN","RGRSBUL1",56,0)
 . S COUNTER=COUNTER+1
"RTN","RGRSBUL1",57,0)
 D BULL2^RGRSBULL("CIRN - PATIENT NOT FOUND","RGRSTEXT(")
"RTN","RGRSBUL1",58,0)
 Q
"RTN","RGRSBUL1",59,0)
 ;
"RTN","RGRSBUL1",60,0)
SENSTIVE(DFN,ARRAY,NAME) ;FIRES WHEN PT. IS FLAGGED AS SENSITIVE AT ANOTHER SITE
"RTN","RGRSBUL1",61,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",62,0)
 ;ISSUES mail group when a given patient is flagged as sensitive at
"RTN","RGRSBUL1",63,0)
 ;another site.
"RTN","RGRSBUL1",64,0)
 ;
"RTN","RGRSBUL1",65,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",66,0)
 ;
"RTN","RGRSBUL1",67,0)
 ;   DFN  - IEN in the PATIENT file (#2)
"RTN","RGRSBUL1",68,0)
 ;  ARRAY - Array of data containing sending sites station number
"RTN","RGRSBUL1",69,0)
 ;  NAME  - Patient's name
"RTN","RGRSBUL1",70,0)
 ;
"RTN","RGRSBUL1",71,0)
 Q:($G(ARRAY)="")!($G(DFN)="")
"RTN","RGRSBUL1",72,0)
 N RGRSTEXT,INDEX,COUNTER
"RTN","RGRSBUL1",73,0)
 S RGRSTEXT(1)="The CIRN Package has received a message from:"
"RTN","RGRSBUL1",74,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",75,0)
 S RGRSTEXT(3)="   "
"RTN","RGRSBUL1",76,0)
 S RGRSTEXT(4)="This message indicates that Pt. "_NAME_" is flagged as Sensitive at"
"RTN","RGRSBUL1",77,0)
 S RGRSTEXT(5)="the other facility but is not flagged as Sensitive at your facility."
"RTN","RGRSBUL1",78,0)
 S RGRSTEXT(6)="  "
"RTN","RGRSBUL1",79,0)
 S RGRSTEXT(7)="Remote User Who Flagged the Pt as Sensitive: "_@ARRAY@("SENSITIVITY USER")
"RTN","RGRSBUL1",80,0)
 S RGRSTEXT(8)="Date/time remote user Flagged Pt Sensitive:  "_$$FMTE^XLFDT(@ARRAY@("SENSITIVITY DATE"))
"RTN","RGRSBUL1",81,0)
 D BULL2^RGRSBULL("Remote Sensitivity Indicated","RGRSTEXT(")
"RTN","RGRSBUL1",82,0)
 Q
"RTN","RGRSBUL1",83,0)
 ;
"RTN","RGRSBUL1",84,0)
RMTDOD(DFN,ARRAY,NAME,RDOD,LDOD) ;Fires when patient has a Date of Death at another site
"RTN","RGRSBUL1",85,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",86,0)
 ;ISSUES mail group when a given patient has a Date of Death at
"RTN","RGRSBUL1",87,0)
 ;another site.
"RTN","RGRSBUL1",88,0)
 ;
"RTN","RGRSBUL1",89,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",90,0)
 ;
"RTN","RGRSBUL1",91,0)
 ;  DFN   - IEN in the PATIENT file (#2)
"RTN","RGRSBUL1",92,0)
 ;  ARRAY - Array of data containing sending sites station number
"RTN","RGRSBUL1",93,0)
 ;  NAME  - Patient's name
"RTN","RGRSBUL1",94,0)
 ;  RDOD  - Date of Death at remote site
"RTN","RGRSBUL1",95,0)
 ;  LDOD  - Date of Death at local site
"RTN","RGRSBUL1",96,0)
 ;
"RTN","RGRSBUL1",97,0)
 Q:($G(ARRAY)="")!($G(DFN)="")
"RTN","RGRSBUL1",98,0)
 Q:(RDOD=LDOD)  ;If remote DOD and local DOD same, QUIT
"RTN","RGRSBUL1",99,0)
 N RGRSTEXT
"RTN","RGRSBUL1",100,0)
 S RGRSTEXT(1)="The CIRN Package has received a message from:"
"RTN","RGRSBUL1",101,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",102,0)
 S RGRSTEXT(3)="   "
"RTN","RGRSBUL1",103,0)
 S RGRSTEXT(4)="This message indicates that patient "_NAME
"RTN","RGRSBUL1",104,0)
 I 'LDOD S RGRSTEXT(5)="has a date of death at the other facility but not at your facility." G RMTMSG
"RTN","RGRSBUL1",105,0)
 I LDOD,(LDOD'=RDOD) S RGRSTEXT(5)="has a different date of death at the other facility than at your facility."
"RTN","RGRSBUL1",106,0)
RMTMSG S RGRSTEXT(6)="  "
"RTN","RGRSBUL1",107,0)
 S RGRSTEXT(7)="Date of Death from other facility:  "_$$FMTE^XLFDT(RDOD)
"RTN","RGRSBUL1",108,0)
 I LDOD,(LDOD'=RDOD) S RGRSTEXT(8)="Date of Death at your facility:  "_$$FMTE^XLFDT(LDOD)
"RTN","RGRSBUL1",109,0)
 D BULL2^RGRSBULL("Remote Date of Death Indicated","RGRSTEXT(")
"RTN","RGRSBUL1",110,0)
 Q
"RTN","RGRSBUL1",111,0)
 ;
"RTN","RGRSBUL1",112,0)
INST(SITENUM) ;
"RTN","RGRSBUL1",113,0)
 N RETURN,IEN,DATA,NAME,NUMBER
"RTN","RGRSBUL1",114,0)
 S RETURN=""
"RTN","RGRSBUL1",115,0)
 Q:$G(SITENUM)="" RETURN
"RTN","RGRSBUL1",116,0)
 S IEN=$$LKUP^XUAF4(SITENUM)
"RTN","RGRSBUL1",117,0)
 I IEN>0 S DATA=$$NS^XUAF4(IEN)
"RTN","RGRSBUL1",118,0)
 I $G(DATA)]"" D 
"RTN","RGRSBUL1",119,0)
 . S NAME=$P(DATA,"^",1),NUMBER=$P(DATA,"^",2)
"RTN","RGRSBUL1",120,0)
 . S RETURN=NAME_" --> Site Number: "_NUMBER
"RTN","RGRSBUL1",121,0)
 Q RETURN
"RTN","RGRSBUL1",122,0)
 ;
"RTN","RGRSBUL1",123,0)
FORMAT(DATA1,DATA2) ;
"RTN","RGRSBUL1",124,0)
 N SPACES,SPACENUM,LENGTH1,LENGTH2,RETURN
"RTN","RGRSBUL1",125,0)
 S SPACES="                       "
"RTN","RGRSBUL1",126,0)
 S LENGTH1=$L(DATA1),LENGTH2=$L(DATA2)
"RTN","RGRSBUL1",127,0)
 I LENGTH1>23 S DATA1=$E(DATA1,1,23) S LENGTH1=23
"RTN","RGRSBUL1",128,0)
 I LENGTH2>22 S DATA2=$E(DATA2,1,22)
"RTN","RGRSBUL1",129,0)
 S SPACENUM=23-LENGTH1
"RTN","RGRSBUL1",130,0)
 S SPACES=$E(SPACES,1,SPACENUM)
"RTN","RGRSBUL1",131,0)
 S RETURN=DATA1_SPACES_" "_DATA2
"RTN","RGRSBUL1",132,0)
 Q $G(RETURN)
"RTN","RGRSBUL1",133,0)
 ;
"RTN","RGRSBUL1",134,0)
FREE(DATA) ;
"RTN","RGRSBUL1",135,0)
 Q:$G(DATA)="" ""
"RTN","RGRSBUL1",136,0)
 Q:$G(DATA)["@" ""
"RTN","RGRSBUL1",137,0)
 Q:$G(DATA)=HL("Q") ""
"RTN","RGRSBUL1",138,0)
 Q $G(DATA)
"RTN","RGRSDYN1")
0^1^B17021424
"RTN","RGRSDYN1",1,0)
RGRSDYN1 ;ALB/RJS-BUILD DYNAMIC LINK LIST FOR A TFU ;06/09/97
"RTN","RGRSDYN1",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGRSDYN1",3,0)
EN(CLIENT,CLASS) ;
"RTN","RGRSDYN1",4,0)
 ;CLIENT=HL7 CLIENT PROTOCOL AT TARGET SYSTEM
"RTN","RGRSDYN1",5,0)
 ;DATA CLASS (Opt.) = Pull from Subs. Registry ONLY
"RTN","RGRSDYN1",6,0)
 ;For now, anything else is both DESCRIPTIVE AND CLINICAL
"RTN","RGRSDYN1",7,0)
 S CLASS=$G(CLASS),CLIENT=$G(CLIENT)
"RTN","RGRSDYN1",8,0)
 Q:CLIENT=""  ;No receiver
"RTN","RGRSDYN1",9,0)
 N PPF,DFN,HERE,RGRS,PPFIEN,ICN,MPI
"RTN","RGRSDYN1",10,0)
PARS ;Parse local outbound message
"RTN","RGRSDYN1",11,0)
 N RGDC
"RTN","RGRSDYN1",12,0)
 D INITIZE^RGRSUTIL,EN^RGRSPAR1("RGRS")
"RTN","RGRSDYN1",13,0)
 ;Get DFN
"RTN","RGRSDYN1",14,0)
 S ICN=$G(RGRS("ICN")) Q:$G(ICN)']""
"RTN","RGRSDYN1",15,0)
 S DFN=$$GETDFN^MPIF001(ICN) Q:+DFN'>0
"RTN","RGRSDYN1",16,0)
 Q:+$$SEND2^VAFCUTL1(DFN,"T")  ;don't broadcast test patients
"RTN","RGRSDYN1",17,0)
 Q:$$IFLOCAL^MPIF001(DFN)
"RTN","RGRSDYN1",18,0)
 S PPF=$$GETVCCI^MPIF001(DFN)\1 Q:+PPF'>0
"RTN","RGRSDYN1",19,0)
 S PPFIEN=$$LKUP^XUAF4(PPF)
"RTN","RGRSDYN1",20,0)
 ;Where we're at            Changed to 3rd piece CMC 5/9/98
"RTN","RGRSDYN1",21,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSDYN1",22,0)
NOTPPF ; if not ppf send only to ppf
"RTN","RGRSDYN1",23,0)
 I PPF'=HERE D  Q
"RTN","RGRSDYN1",24,0)
 . N PPFLINK,INDEX
"RTN","RGRSDYN1",25,0)
 . D LINK^HLUTIL3(PPFIEN,.PPFLINK)
"RTN","RGRSDYN1",26,0)
 . S INDEX=$O(PPFLINK(0))
"RTN","RGRSDYN1",27,0)
 . I INDEX]"" S HLL("LINKS",1)=CLIENT_"^"_PPFLINK(INDEX)
"RTN","RGRSDYN1",28,0)
ISPPF ;
"RTN","RGRSDYN1",29,0)
 I PPF=HERE D  Q
"RTN","RGRSDYN1",30,0)
 . N PARENT,INDEX,SUBCONTL,CHILDREN,INDEX1,NODE
"RTN","RGRSDYN1",31,0)
 . S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","RGRSDYN1",32,0)
 . S SUBCONTL=$P($G(NODE),"^",5)
"RTN","RGRSDYN1",33,0)
 . ;Get subscribers, return updated HLL array
"RTN","RGRSDYN1",34,0)
 . ;replaced with GET line tag: I SUBCONTL]"" D GET^HLSUB(SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN1",35,0)
 . D GET(DFN,SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN1",36,0)
 . ;Get MPI link from SITE PARAMETER
"RTN","RGRSDYN1",37,0)
 . S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGRSDYN1",38,0)
 . . I $P($G(MPI),U)'=-1 S HLL("LINKS",9999999999)=CLIENT_"^"_MPI
"RTN","RGRSDYN1",39,0)
 . . I $P($G(MPI),U)=-1 D
"RTN","RGRSDYN1",40,0)
 . . . N RGLOG,RGMTXT
"RTN","RGRSDYN1",41,0)
 . . . S RGMTXT=" See Appendix F of the Clinical Information Resource Network Patient Demographics (CIRN-PD) and Master Patient Index (MPI) Installation and Implementation Guide."
"RTN","RGRSDYN1",42,0)
 . . . D START^RGHLLOG(HLMTIEN,"","") D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)"_RGMTXT) D STOP^RGHLLOG(0)
"RTN","RGRSDYN1",43,0)
 ;
"RTN","RGRSDYN1",44,0)
GET(RGDFN,RGSCN,RGTP,RGCLP,RGLL) ;GET Subscribers
"RTN","RGRSDYN1",45,0)
 ;RGDFN - Patient IEN from FILE (#2)
"RTN","RGRSDYN1",46,0)
 ;RGSCN - Subcription Control Number
"RTN","RGRSDYN1",47,0)
 ;RGTP  - SUBSCRIBER TYPE (0,1,2)/Null=all
"RTN","RGRSDYN1",48,0)
 ;RGCLP - HL7 CLIENT PROTOCOL (required)
"RTN","RGRSDYN1",49,0)
 ;RGLL  - HLL("LINKS",x)=CLIENT PROTOCOL^LOGICAL LINK (passed by reference)
"RTN","RGRSDYN1",50,0)
 N RG,RGI,RGLLIEN,RGLLI,RGLLS,RGLLN,RGLLZ,RGTF,RGTFF,RGTFI,RGX,HLER
"RTN","RGRSDYN1",51,0)
 S U="^"
"RTN","RGRSDYN1",52,0)
 ;get subscribers
"RTN","RGRSDYN1",53,0)
 I RGSCN'="" D GET^HLSUB(RGSCN,RGTP,RGCLP,.RGLL)
"RTN","RGRSDYN1",54,0)
 ;check for a treating facility that is not a subscriber
"RTN","RGRSDYN1",55,0)
 S RGI=0 F  S RGI=$O(^DGCN(391.91,"B",RGDFN,RGI)) Q:'RGI  I $D(^DGCN(391.91,RGI,0)) S RGTF=$G(^DGCN(391.91,RGI,0)),RGTFI=$P(RGTF,U,2) D:RGTFI'=+$$SITE^VASITE
"RTN","RGRSDYN1",56,0)
 .;checking INSTITUTION of links to the TREATING FACILITY INSTITUTION
"RTN","RGRSDYN1",57,0)
 .;RGTFF=1 - Flag for adding Treating Facility to Subcription Control
"RTN","RGRSDYN1",58,0)
 .S RGTFF=1
"RTN","RGRSDYN1",59,0)
 .S RGX=0 F  S RGX=$O(RGLL("LINKS",RGX)) Q:'RGX!(RGTFF=0)  D
"RTN","RGRSDYN1",60,0)
 ..S RGLLIEN=$P(RGLL("LINKS",RGX),U,6)
"RTN","RGRSDYN1",61,0)
 ..I $G(RGLL)="" S RGLL("ERR",RGX)="No logical link defined for "_$P(RGLL("LINKS",RGX),U)_"." Q
"RTN","RGRSDYN1",62,0)
 ..S RGLLI=RGTFI,RGLLN=$P(RGLL("LINKS",RGX),U,2)
"RTN","RGRSDYN1",63,0)
 ..I '$L(RGLLI),'$D(RGLL("ERR",RGX)) S RGLL("ERR",RGX)="Link "_$P(RGLL("LINKS",RGX),U,2)_" does not contain a link to the INSTUTUTION (#4) file." Q
"RTN","RGRSDYN1",64,0)
 ..I $L(RGLLI) S:RGLLI'=RGTFI RGTFF=1 I RGLLI=RGTFI S RGTFF=0 Q
"RTN","RGRSDYN1",65,0)
 .;If TF not in Subscriber list, kill list, add to subscription control file then get new list 
"RTN","RGRSDYN1",66,0)
 .I RGTFF=1 D LINK^HLUTIL3("`"_RGTFI,.RG,"I") S RGLLI=$O(RG(0)) D
"RTN","RGRSDYN1",67,0)
 ..I +$G(RGLLI)>0 S RGLLN=$P(RG(RGLLI),U),RGLLI=RGTFI
"RTN","RGRSDYN1",68,0)
 ..I +$G(RGLLI)>0 S:RGSCN="" RGSCN=$$GETSCN^RGJCREC(RGDFN) D UPD^HLSUB(RGSCN,RGLLN,RGTP,$$NOW^XLFDT,,,.HLER) K RGLL("LINKS") D GET^HLSUB(RGSCN,RGTP,RGCLP,.RGLL)
"RTN","RGRSDYN1",69,0)
 ..I +$G(RGLLI)'>0 W !,"Unable to find Logical link for "_$$GET1^DIQ(4,RGTFI_",",.01)
"RTN","RGRSDYN1",70,0)
 Q
"RTN","RGRSPT")
0^3^B17495245
"RTN","RGRSPT",1,0)
RGRSPT ;ALB/RJS,CML-HIGH LEVEL ROUTINE FOR PARSING AND FILING ;06/25/98
"RTN","RGRSPT",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGRSPT",3,0)
 ;
"RTN","RGRSPT",4,0)
 ;Parse Incoming Message, and file.
"RTN","RGRSPT",5,0)
 ;
"RTN","RGRSPT",6,0)
 ;
"RTN","RGRSPT",7,0)
 Q:($G(HL("MTN"))'="ADT")
"RTN","RGRSPT",8,0)
 N RGRSDFN,VAFCA,RGRS,VAFCA08,RGRSARAY,BOGUS,RGDC,SENSTVTY,CMORDISP
"RTN","RGRSPT",9,0)
 N NAME,LASTNAME,SSN,ICN,CMOR,CMORIEN,OTHSITE,RGRSDATA,HERE,BULSUB,NODE
"RTN","RGRSPT",10,0)
 S RGRSARAY="RGRS(2)"
"RTN","RGRSPT",11,0)
 D INITIZE^RGRSUTIL ;copy HL7 message into local RGDC array
"RTN","RGRSPT",12,0)
 S VAFCA=$$EN^RGRSMSH() ;parse MSH for filer
"RTN","RGRSPT",13,0)
 D EN^RGRSPARS(RGRSARAY) ;parse HL7 message into local array RGRS
"RTN","RGRSPT",14,0)
 I $$SKIP^RGRSZZPT(1,RGRSARAY) D  G EXIT ;skip if certain data is not there
"RTN","RGRSPT",15,0)
 . D SKIPBULL^RGRSBULL(RGRSARAY)
"RTN","RGRSPT",16,0)
 S RGRSDFN=$$GETDFN^MPIF001(@RGRSARAY@(991.01)) ;Get DFN from ICN
"RTN","RGRSPT",17,0)
 Q:+$$SEND2^VAFCUTL1(RGRSDFN,"T")  ;safeguard to prevent the processing of test patients
"RTN","RGRSPT",18,0)
 S OTHSITE=@RGRSARAY@("SITENUM")\1
"RTN","RGRSPT",19,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSPT",20,0)
 ;
"RTN","RGRSPT",21,0)
 ;If patient not known in site, send bulletin, go exit
"RTN","RGRSPT",22,0)
 ;
"RTN","RGRSPT",23,0)
 I +RGRSDFN=-1 M RGRS("MESSAGE")=RGDC D NOT2^RGRSBUL1(RGRSARAY) G EXIT
"RTN","RGRSPT",24,0)
 ;
"RTN","RGRSPT",25,0)
 S NAME=$$GET1^DIQ(2,RGRSDFN_",",.01)
"RTN","RGRSPT",26,0)
 S LASTNAME=$P(NAME,",",1)
"RTN","RGRSPT",27,0)
 S SSN=$$GET1^DIQ(2,RGRSDFN_",",.09)
"RTN","RGRSPT",28,0)
 S NODE=$$MPINODE^MPIFAPI(RGRSDFN)
"RTN","RGRSPT",29,0)
 S ICN=$P(NODE,"^")
"RTN","RGRSPT",30,0)
 S CMORIEN=$P(NODE,"^",3)
"RTN","RGRSPT",31,0)
 S CMOR=$$NS^XUAF4(CMORIEN)
"RTN","RGRSPT",32,0)
 S CMORDISP=$P(CMOR,"^",1)
"RTN","RGRSPT",33,0)
 S CMOR=$P(CMOR,"^",2)
"RTN","RGRSPT",34,0)
 ;
"RTN","RGRSPT",35,0)
 S @RGRSARAY@("NAME")=@RGRSARAY@(.01)
"RTN","RGRSPT",36,0)
 S @RGRSARAY@("SSN")=@RGRSARAY@(.09)
"RTN","RGRSPT",37,0)
 S @RGRSARAY@("ICN")=@RGRSARAY@(991.01)
"RTN","RGRSPT",38,0)
 S @RGRSARAY@("CMOR")=$P($$NS^XUAF4($$LKUP^XUAF4(OTHSITE)),"^")
"RTN","RGRSPT",39,0)
 ;
"RTN","RGRSPT",40,0)
 ;If ICN or CMOR don't match, send bulletin and go exit
"RTN","RGRSPT",41,0)
 I '$$MATCH(RGRSDFN,RGRSARAY,,,ICN,CMOR,.BULSUB) D  G EXIT
"RTN","RGRSPT",42,0)
 . D MTCHBULL^RGRSBULL(RGRSDFN,RGRSARAY,NAME,SSN,ICN,CMORDISP,BULSUB)
"RTN","RGRSPT",43,0)
 ;
"RTN","RGRSPT",44,0)
 ;if ICN and CMOR match, check for SSN edit from CMOR
"RTN","RGRSPT",45,0)
 I @RGRSARAY@("SENDING SITE")=CMOR,(SSN'=@RGRSARAY@(.09)) D
"RTN","RGRSPT",46,0)
 .D SSNBULL^RGRSBUL1(RGRSDFN,RGRSARAY,NAME,SSN,ICN,CMORDISP)
"RTN","RGRSPT",47,0)
 ;
"RTN","RGRSPT",48,0)
 ;If patient is Sensitive at other site but not here send bulletin
"RTN","RGRSPT",49,0)
 S SENSTVTY=$G(@RGRSARAY@("SENSITIVITY"))
"RTN","RGRSPT",50,0)
 I '$$SENSTIVE^RGRSENS(RGRSDFN),SENSTVTY D SENSTIVE^RGRSBUL1(RGRSDFN,RGRSARAY,NAME)
"RTN","RGRSPT",51,0)
 ;
"RTN","RGRSPT",52,0)
 ;If patient has DATE OF DEATH (DOD) at remote site send bulletin
"RTN","RGRSPT",53,0)
 ;Ignore time if present with date.
"RTN","RGRSPT",54,0)
 S RMTDOD=@RGRSARAY@(.351),RMTDOD=$P(RMTDOD,".")
"RTN","RGRSPT",55,0)
 S DFN=RGRSDFN D DEM^VADPT
"RTN","RGRSPT",56,0)
 S LOCDOD=$P($P(VADM(6),"^"),".")
"RTN","RGRSPT",57,0)
 ;If there is a remote DOD but no local DOD  OR
"RTN","RGRSPT",58,0)
 ;if remote DOD is different from local DOD, send bulletin
"RTN","RGRSPT",59,0)
 I RMTDOD D RMTDOD^RGRSBUL1(RGRSDFN,RGRSARAY,NAME,RMTDOD,LOCDOD)
"RTN","RGRSPT",60,0)
 K LOCDOD,RMTDOD,VADM
"RTN","RGRSPT",61,0)
 ;
"RTN","RGRSPT",62,0)
 I '$$AUTO^RGJUSITE() D  G EXIT
"RTN","RGRSPT",63,0)
 . ;
"RTN","RGRSPT",64,0)
 . ;IF it's the CMOR - review file
"RTN","RGRSPT",65,0)
 . ;
"RTN","RGRSPT",66,0)
 . I (OTHSITE)=(HERE) D  Q
"RTN","RGRSPT",67,0)
 . . S VAFCA=VAFCA_"^"_RGRSDFN
"RTN","RGRSPT",68,0)
 . . S VAFCA08=1 S BOGUS=$$ADD^VAFCEHU1(VAFCA,"RGRS")
"RTN","RGRSPT",69,0)
 . ;
"RTN","RGRSPT",70,0)
 . ;IF it's not the CMOR - Don't Rebroadcast
"RTN","RGRSPT",71,0)
 . ;
"RTN","RGRSPT",72,0)
 . I (OTHSITE)'=(HERE) D  Q
"RTN","RGRSPT",73,0)
 . . S VAFCA08=1
"RTN","RGRSPT",74,0)
 . . D EDIT^VAFCPTED(RGRSDFN,RGRSARAY,".01;.03;.09;.02;.05;.08;.111;.112;.113;.114;.115;.1112;.117;.131;.132;.211;.219;.2403;.31115")
"RTN","RGRSPT",75,0)
 ;
"RTN","RGRSPT",76,0)
 I $$AUTO^RGJUSITE() D  G EXIT
"RTN","RGRSPT",77,0)
 . ;
"RTN","RGRSPT",78,0)
 . ;IF it's the CMOR - rebroadcast
"RTN","RGRSPT",79,0)
 . ;
"RTN","RGRSPT",80,0)
 . I (OTHSITE)=(HERE) D  Q
"RTN","RGRSPT",81,0)
 . . D EDIT^VAFCPTED(RGRSDFN,RGRSARAY,".01;.03;.09;.02;.05;.08;.111;.112;.113;.114;.115;.1112;.117;.131;.132;.211;.219;.2403;.31115")
"RTN","RGRSPT",82,0)
 . ;
"RTN","RGRSPT",83,0)
 . ;IF it's not the CMOR - Don't Rebroadcast
"RTN","RGRSPT",84,0)
 . ;
"RTN","RGRSPT",85,0)
 . I (OTHSITE)'=(HERE) D  Q
"RTN","RGRSPT",86,0)
 . . S VAFCA08=1
"RTN","RGRSPT",87,0)
 . . D EDIT^VAFCPTED(RGRSDFN,RGRSARAY,".01;.03;.09;.02;.05;.08;.111;.112;.113;.114;.115;.1112;.117;.131;.132;.211;.219;.2403;.31115")
"RTN","RGRSPT",88,0)
EXIT ;
"RTN","RGRSPT",89,0)
 Q
"RTN","RGRSPT",90,0)
 ;
"RTN","RGRSPT",91,0)
MATCH(DFN,RGRSARAY,LASTNAME,SSN,ICN,CMOR,BULSUB) ;
"RTN","RGRSPT",92,0)
 Q:$G(DFN)=""!($G(RGRSARAY)="") 0
"RTN","RGRSPT",93,0)
 N COUNT,TRUE S (COUNT,TRUE)=0
"RTN","RGRSPT",94,0)
 S BULSUB=""
"RTN","RGRSPT",95,0)
 I $D(LASTNAME) D
"RTN","RGRSPT",96,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",97,0)
 . I (LASTNAME'=""),(LASTNAME=$P(@RGRSARAY@(.01),",",1)) S TRUE=TRUE+1
"RTN","RGRSPT",98,0)
 I $D(SSN) D
"RTN","RGRSPT",99,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",100,0)
 . I (SSN'=""),(SSN=$G(@RGRSARAY@(.09))) S TRUE=TRUE+1
"RTN","RGRSPT",101,0)
 I $D(ICN) D
"RTN","RGRSPT",102,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",103,0)
 . I (ICN'=""),(ICN=$G(@RGRSARAY@(991.01))) S TRUE=TRUE+1 Q
"RTN","RGRSPT",104,0)
 . S BULSUB=BULSUB_"ICN"
"RTN","RGRSPT",105,0)
 I $D(CMOR) D
"RTN","RGRSPT",106,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",107,0)
 . I (CMOR'=""),(CMOR=$G(@RGRSARAY@("SITENUM"))) S TRUE=TRUE+1 Q
"RTN","RGRSPT",108,0)
 . I BULSUB]"" S BULSUB=BULSUB_" & "
"RTN","RGRSPT",109,0)
 . S BULSUB=BULSUB_"CMOR"
"RTN","RGRSPT",110,0)
 I COUNT=TRUE Q 1
"RTN","RGRSPT",111,0)
 Q 0
"RTN","RGRSUTIL")
0^6^B7989549
"RTN","RGRSUTIL",1,0)
RGRSUTIL ;ALB/RJS-CIRN UTILITIES ;03/12/96
"RTN","RGRSUTIL",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**1**;30 Apr 99
"RTN","RGRSUTIL",3,0)
EXCEPT ;This entry point identifies exception notifications
"RTN","RGRSUTIL",4,0)
 ;Check the mail group field in File #991.11 to see if this user should
"RTN","RGRSUTIL",5,0)
 ;be notified.
"RTN","RGRSUTIL",6,0)
 S RGTYPE=218 S RGMG=$P(^RGHL7(991.11,RGTYPE,0),"^",4)
"RTN","RGRSUTIL",7,0)
 D GETS^DIQ(3.8,RGMG_",","2*","I","RGAR") S RGNOTFY=0,RGX="" F  S RGX=$O(RGAR(3.81,RGX)) Q:RGX=""  I RGAR(3.81,RGX,.01,"I")=$G(DUZ) S RGNOTFY=1
"RTN","RGRSUTIL",8,0)
 ;identify existence of potential matches
"RTN","RGRSUTIL",9,0)
 I RGNOTFY=1 S RGNOTFY=$$CURPM^RGEVPM()
"RTN","RGRSUTIL",10,0)
 I RGNOTFY=1 D SET^XUS1A("!Use the Message Exception Menu to review the potential match patients.")
"RTN","RGRSUTIL",11,0)
 K RGTYPE,RGMG,RGNOTFY,RGAR,RGX
"RTN","RGRSUTIL",12,0)
 Q
"RTN","RGRSUTIL",13,0)
SNODE(PEICE,DATA,NODE1,NODE2) ;Set Node in ^TMP("RGDC",$J) Global
"RTN","RGRSUTIL",14,0)
 I $D(NODE2) S $P(^TMP("RGDC",$J,RGNOW,NODE1,NODE2),"^",PEICE)=DATA Q
"RTN","RGRSUTIL",15,0)
 S $P(^TMP("RGDC",$J,RGNOW,NODE1),"^",PEICE)=DATA
"RTN","RGRSUTIL",16,0)
 Q
"RTN","RGRSUTIL",17,0)
SEG(SEGMENT,PIECE,CODE) ;Return segment from RGDC array and kill node
"RTN","RGRSUTIL",18,0)
 N RGNODE,RGDATA,RGDONE,RGC K RGDONE
"RTN","RGRSUTIL",19,0)
 I '$D(RGC) S RGC=$E(HL("ECH"))
"RTN","RGRSUTIL",20,0)
 S RGNODE=0
"RTN","RGRSUTIL",21,0)
 F  S RGNODE=$O(RGDC(RGNODE)) Q:RGNODE=""!($D(RGDONE))  D
"RTN","RGRSUTIL",22,0)
 .S RGDATA=RGDC(RGNODE)
"RTN","RGRSUTIL",23,0)
 .I ($P(RGDATA,HL("FS"),1)=SEGMENT)&($P($P(RGDATA,HL("FS"),PIECE),RGC,1)=CODE) S RGDONE=1 K RGDC(RGNODE)
"RTN","RGRSUTIL",24,0)
 Q:$D(RGDONE) $G(RGDATA)
"RTN","RGRSUTIL",25,0)
 Q ""
"RTN","RGRSUTIL",26,0)
SEG1(SEGMENT,PIECE,CODE) ;Return segment from RGDC array 
"RTN","RGRSUTIL",27,0)
 N RGNODE,RGDATA,RGDONE,RGC K RGDONE
"RTN","RGRSUTIL",28,0)
 I '$D(RGC) S RGC=$E(HL("ECH"))
"RTN","RGRSUTIL",29,0)
 S RGNODE=0
"RTN","RGRSUTIL",30,0)
 F  S RGNODE=$O(RGDC(RGNODE)) Q:RGNODE=""!($D(RGDONE))  D
"RTN","RGRSUTIL",31,0)
 .S RGDATA=RGDC(RGNODE)
"RTN","RGRSUTIL",32,0)
 .I ($P(RGDATA,HL("FS"),1)=SEGMENT)&($P($P(RGDATA,HL("FS"),PIECE),RGC,1)=CODE) S RGDONE=1
"RTN","RGRSUTIL",33,0)
 Q:$D(RGDONE) $G(RGDATA)
"RTN","RGRSUTIL",34,0)
 Q ""
"RTN","RGRSUTIL",35,0)
ERROR(CODE) ;**THIS ENTRY POINT IS NO LONGER USED**
"RTN","RGRSUTIL",36,0)
 Q ""
"RTN","RGRSUTIL",37,0)
INITIZE ;Initialize RGDC array with incoming message
"RTN","RGRSUTIL",38,0)
 N I,J,X
"RTN","RGRSUTIL",39,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  S RGDC(I)=HLNODE,J=0  F  S J=$O(HLNODE(J)) Q:'J  S RGDC(I,J)=HLNODE(J)
"RTN","RGRSUTIL",40,0)
 Q
"RTN","RGRSUTIL",41,0)
SSNDFN(SSN) ;Input ssn output DFN
"RTN","RGRSUTIL",42,0)
 N DFN
"RTN","RGRSUTIL",43,0)
 Q:$G(SSN)="" -1
"RTN","RGRSUTIL",44,0)
 S DFN=$O(^DPT("SSN",+SSN,0))
"RTN","RGRSUTIL",45,0)
 Q:$L(DFN) DFN
"RTN","RGRSUTIL",46,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","RGRSUTIL",47,0)
 Q:$L(DFN) DFN
"RTN","RGRSUTIL",48,0)
 Q -1
"RTN","RGRSUTIL",49,0)
 ;
"RTN","RGRSUTIL",50,0)
LINE() ; Return a dashed line.       
"RTN","RGRSUTIL",51,0)
 Q $TR($J("",80)," ","-")
"RTN","RGRSUTIL",52,0)
 ;
"RTN","RGRSUTIL",53,0)
PAUSE() ; Pause for CRT output.
"RTN","RGRSUTIL",54,0)
 ;  Input:   IOST, IOSL
"RTN","RGRSUTIL",55,0)
 ;  Output:  0  --  Continue to display output
"RTN","RGRSUTIL",56,0)
 ;           1  --  Quit
"RTN","RGRSUTIL",57,0)
 Q:$E(IOST,1,2)'["C-" 0
"RTN","RGRSUTIL",58,0)
 N DIR,DIRUT,DTOUT,DUOUT,RGJ
"RTN","RGRSUTIL",59,0)
 F RGJ=$Y:1:(IOSL-4) W !
"RTN","RGRSUTIL",60,0)
 S DIR(0)="E" D ^DIR
"RTN","RGRSUTIL",61,0)
 Q $D(DIRUT)!($D(DUOUT))
"RTN","RGRSUTIL",62,0)
 ;
"RTN","RGRSUTIL",63,0)
DIAG(X) ; Return a string for diagnoses.
"RTN","RGRSUTIL",64,0)
 ;  Input:   X  -  Code for type of diagnosis (Primary, etc.)
"RTN","RGRSUTIL",65,0)
 ;  Output:  Descriptive string, i.e., "Primary", etc.
"RTN","RGRSUTIL",66,0)
 Q $S($G(X)="":"Unknown",X="A":"Additional",X="P":"Primary",X="S":"Secondary",X="T":"Tertiary",1:"Unknown")
"RTN","RGRSUTIL",67,0)
 ;
"RTN","RGRSUTIL",68,0)
ORD(X) ; Return a string for orders.
"RTN","RGRSUTIL",69,0)
 ;  Input:   X  -  Code for type of order (Lab, etc.)
"RTN","RGRSUTIL",70,0)
 ;  Output:  Descriptive string, i.e., "Lab", etc.
"RTN","RGRSUTIL",71,0)
 Q $S($G(X)="":"Unknown",X="L":"Lab",X="R":"Radiology",1:"Unknown")
"RTN","RGRSUTIL",72,0)
 ;
"RTN","RGRSUTIL",73,0)
UPDTFLD(FILE,FLD,ANS1,ANS2) ; Returns the correct field answer
"RTN","RGRSUTIL",74,0)
 ;DLR - Added to prevent the overwriting the last four in ZIP with null
"RTN","RGRSUTIL",75,0)
 ; input:  FILE  - file number (ex. 2 PATIENT)
"RTN","RGRSUTIL",76,0)
 ;         FLD  -  field number (ex. .1112 ZIP+4)
"RTN","RGRSUTIL",77,0)
 ;         ANS1 -  existing field value
"RTN","RGRSUTIL",78,0)
 ;         ANS2 -  incoming value
"RTN","RGRSUTIL",79,0)
 I (FILE=2)&(FLD=.1112) I $E(ANS1,1,5)=$E(ANS2,1,5),($L(ANS2)=5) Q ANS1
"RTN","RGRSUTIL",80,0)
 Q ANS2
"RTN","RGRSUTIL",81,0)
 ;
"RTN","RGRSUTIL",82,0)
SSNINT(SSN) ;
"RTN","RGRSUTIL",83,0)
 Q:$G(SSN)="" ""
"RTN","RGRSUTIL",84,0)
 Q $TRANSLATE(SSN,"-","")
"SEC","^DIC",991.11,991.11,0,"AUDIT")
@
"SEC","^DIC",991.11,991.11,0,"DD")
@
"SEC","^DIC",991.11,991.11,0,"DEL")
@
"SEC","^DIC",991.11,991.11,0,"LAYGO")
@
"SEC","^DIC",991.11,991.11,0,"RD")
@
"SEC","^DIC",991.11,991.11,0,"WR")
@
"UP",991.1,991.12,-1)
991.1^1
"UP",991.1,991.12,0)
991.12
"VER")
8.0^21.0
"^DD",991.1,991.12,3,0)
PATIENT^P2'^DPT(^0;4^Q
"^DD",991.1,991.12,3,1,0)
^.1
"^DD",991.1,991.12,3,1,1,0)
991.1^ADFN^MUMPS
"^DD",991.1,991.12,3,1,1,1)
N T S T=$P($G(^RGHL7(991.1,DA(1),1,DA,0)),U,3) I T]"" S ^RGHL7(991.1,"ADFN",T,X,DA(1),DA)=""
"^DD",991.1,991.12,3,1,1,2)
N T S T=$P($G(^RGHL7(991.1,DA(1),1,DA,0)),U,3) I T]"" K ^RGHL7(991.1,"ADFN",T,X,DA(1),DA)
"^DD",991.1,991.12,3,1,1,3)
DO NOT DELETE!
"^DD",991.1,991.12,3,1,1,"%D",0)
^^8^8^2990922^^
"^DD",991.1,991.12,3,1,1,"%D",1,0)
This cross-reference is used to sort entries in the CIRN HL7 EXCEPTION 
"^DD",991.1,991.12,3,1,1,"%D",2,0)
LOG file (#991.1) by EXCEPTION multiple fields TYPE (#2) and PATIENT (#3).
"^DD",991.1,991.12,3,1,1,"%D",3,0)
 
"^DD",991.1,991.12,3,1,1,"%D",4,0)
Set logic:
"^DD",991.1,991.12,3,1,1,"%D",5,0)
S ^RGHL7(991.1,"ADFN",(#2) TYPE,(#3) PATIENT,DA(1),DA)=""
"^DD",991.1,991.12,3,1,1,"%D",6,0)
 
"^DD",991.1,991.12,3,1,1,"%D",7,0)
Kill logic:
"^DD",991.1,991.12,3,1,1,"%D",8,0)
K ^RGHL7(991.1,"ADFN",(#2) TYPE,(#3) PATIENT,DA(1),DA)
"^DD",991.1,991.12,3,1,1,"DT")
2990708
"^DD",991.1,991.12,3,3)
Enter Patient DFN for this exception.
"^DD",991.1,991.12,3,21,0)
^^3^3^2990708^^
"^DD",991.1,991.12,3,21,1,0)
Pointer to PATIENT file (#2) for the patient involved in this exception
"^DD",991.1,991.12,3,21,2,0)
(DFN). This field is not required as every exception type does not have an
"^DD",991.1,991.12,3,21,3,0)
associated DFN.
"^DD",991.1,991.12,3,"DT")
2990708
"^DD",991.11,991.11,0)
FIELD^^99^8
"^DD",991.11,991.11,0,"DDA")
N
"^DD",991.11,991.11,0,"DT")
2980721
"^DD",991.11,991.11,0,"ID",10)
W:$D(^(10)) "   ",$E(^(10),1,100)
"^DD",991.11,991.11,0,"IX","B",991.11,.01)

"^DD",991.11,991.11,0,"IX","C",991.11,10)

"^DD",991.11,991.11,0,"NM","CIRN HL7 EXCEPTION TYPE")

"^DD",991.11,991.11,0,"PT",991.12,2)

"^DD",991.11,991.11,0,"VRPK")
CLINICAL INFO RESOURCE NETWORK
"^DD",991.11,991.11,.01,0)
NUMBER^RNJ12,0X^^0;1^K:X'=X\1!(X<1) X S:$D(X) DINUM=X
"^DD",991.11,991.11,.01,1,0)
^.1
"^DD",991.11,991.11,.01,1,1,0)
991.11^B
"^DD",991.11,991.11,.01,1,1,1)
S ^RGHL7(991.11,"B",$E(X,1,30),DA)=""
"^DD",991.11,991.11,.01,1,1,2)
K ^RGHL7(991.11,"B",$E(X,1,30),DA)
"^DD",991.11,991.11,.01,3)
Index of this exception.
"^DD",991.11,991.11,.01,21,0)
^^1^1^2990308^^
"^DD",991.11,991.11,.01,21,1,0)
This is the index number of this exception.
"^DD",991.11,991.11,.01,"DT")
2970201
"^DD",991.11,991.11,1,0)
SEVERITY^S^0:INFORMATIONAL;1:MINOR;2:SEVERE;^0;2^Q
"^DD",991.11,991.11,1,3)
Severity level of this exception.
"^DD",991.11,991.11,1,21,0)
^^2^2^2990308^^
"^DD",991.11,991.11,1,21,1,0)
This is the severity level of this exception, '0' for Informational,
"^DD",991.11,991.11,1,21,2,0)
'1' for Minor or '2' for Severe.
"^DD",991.11,991.11,1,"DT")
2970201
"^DD",991.11,991.11,2,0)
ACTION^S^0:NONE;1:MAIL;2:ALERT;^0;3^Q
"^DD",991.11,991.11,2,3)
Action to be taken upon logging this exception.
"^DD",991.11,991.11,2,21,0)
^^2^2^2990308^^
"^DD",991.11,991.11,2,21,1,0)
This is the action to be taken upon logging this exception,
"^DD",991.11,991.11,2,21,2,0)
'0' for None, '1' for Mail, or '2' for Alert.
"^DD",991.11,991.11,2,"DT")
2970201
"^DD",991.11,991.11,3,0)
COUNT^NJ12,0X^^0;5^K:X\1'=X!(X<0) X
"^DD",991.11,991.11,3,3)
Total number of exceptions logged with this type.
"^DD",991.11,991.11,3,21,0)
^^1^1^2990308^^
"^DD",991.11,991.11,3,21,1,0)
This is a count of all exceptions logged of this type.
"^DD",991.11,991.11,3,"DT")
2970317
"^DD",991.11,991.11,6,0)
MAIL GROUP^P3.8'^XMB(3.8,^0;4^Q
"^DD",991.11,991.11,6,3)
Mail group to which notification will be sent for alert and mail action types.
"^DD",991.11,991.11,6,21,0)
^^3^3^2990308^^
"^DD",991.11,991.11,6,21,1,0)
This is a pointer to the MAIL GROUP file (#3.8), indicating
"^DD",991.11,991.11,6,21,2,0)
which mail group a notification will be sent to for alert
"^DD",991.11,991.11,6,21,3,0)
and mail action types.
"^DD",991.11,991.11,6,"DT")
2970201
"^DD",991.11,991.11,10,0)
TEXT^F^^10;E1,100^K:$L(X)>100!($L(X)<1) X
"^DD",991.11,991.11,10,1,0)
^.1
"^DD",991.11,991.11,10,1,1,0)
991.11^C
"^DD",991.11,991.11,10,1,1,1)
S ^RGHL7(991.11,"C",$E(X,1,30),DA)=""
"^DD",991.11,991.11,10,1,1,2)
K ^RGHL7(991.11,"C",$E(X,1,30),DA)
"^DD",991.11,991.11,10,1,1,"DT")
2970201
"^DD",991.11,991.11,10,3)
Text message for this exception.
"^DD",991.11,991.11,10,21,0)
^^2^2^2990308^^
"^DD",991.11,991.11,10,21,1,0)
This is a free text field (up to 100 characters) which holds the
"^DD",991.11,991.11,10,21,2,0)
message for this exception.
"^DD",991.11,991.11,10,"DT")
2970201
"^DD",991.11,991.11,20,0)
SECURITY KEY^991.112P^^20;0
"^DD",991.11,991.11,20,21,0)
^^4^4^2990308^^^
"^DD",991.11,991.11,20,21,1,0)
This is used to control access to a particular exception type. 
"^DD",991.11,991.11,20,21,2,0)
A user must possess at least one of the listed security keys to 
"^DD",991.11,991.11,20,21,3,0)
access the associated exception.  If no security keys are listed, 
"^DD",991.11,991.11,20,21,4,0)
access is unrestricted.
"^DD",991.11,991.11,99,0)
DESCRIPTION^991.1199^^99;0
"^DD",991.11,991.11,99,21,0)
^^2^2^2990308^^^
"^DD",991.11,991.11,99,21,1,0)
This is a word-processing field used for storing
"^DD",991.11,991.11,99,21,2,0)
the detailed explanation of this exception type.
"^DD",991.11,991.112,0)
SECURITY KEY SUB-FIELD^^.01^1
"^DD",991.11,991.112,0,"DT")
2980721
"^DD",991.11,991.112,0,"IX","B",991.112,.01)

"^DD",991.11,991.112,0,"NM","SECURITY KEY")

"^DD",991.11,991.112,0,"UP")
991.11
"^DD",991.11,991.112,.01,0)
SECURITY KEY^MP19.1'X^DIC(19.1,^0;1^S DINUM=X
"^DD",991.11,991.112,.01,1,0)
^.1
"^DD",991.11,991.112,.01,1,1,0)
991.112^B
"^DD",991.11,991.112,.01,1,1,1)
S ^RGHL7(991.11,DA(1),20,"B",$E(X,1,30),DA)=""
"^DD",991.11,991.112,.01,1,1,2)
K ^RGHL7(991.11,DA(1),20,"B",$E(X,1,30),DA)
"^DD",991.11,991.112,.01,3)
Enter a security key to control access to this exception.
"^DD",991.11,991.112,.01,21,0)
^^4^4^2990308^^
"^DD",991.11,991.112,.01,21,1,0)
This is used to control access to a particular exception type. 
"^DD",991.11,991.112,.01,21,2,0)
A user must possess at least one of the listed security keys to 
"^DD",991.11,991.112,.01,21,3,0)
access the associated exception.  If no security keys are listed, 
"^DD",991.11,991.112,.01,21,4,0)
access is unrestricted.
"^DD",991.11,991.112,.01,"DT")
2980721
"^DD",991.11,991.1199,0)
DESCRIPTION SUB-FIELD^^.01^1
"^DD",991.11,991.1199,0,"DT")
2970201
"^DD",991.11,991.1199,0,"NM","DESCRIPTION")

"^DD",991.11,991.1199,0,"UP")
991.11
"^DD",991.11,991.1199,.01,0)
DESCRIPTION^WL^^0;1^Q
"^DD",991.11,991.1199,.01,3)
Detailed explanation of this exception.
"^DD",991.11,991.1199,.01,21,0)
^^1^1^2990308^^^
"^DD",991.11,991.1199,.01,21,1,0)
This field holds the detailed explanation of this exception.
"^DD",991.11,991.1199,.01,"DT")
2970201
"^DIC",991.11,991.11,0)
CIRN HL7 EXCEPTION TYPE^991.11
"^DIC",991.11,991.11,0,"GL")
^RGHL7(991.11,
"^DIC",991.11,991.11,"%D",0)
^^3^3^2990308^^
"^DIC",991.11,991.11,"%D",1,0)
This file holds the CIRN HL7 exception types.  It is pointed to by
"^DIC",991.11,991.11,"%D",2,0)
the TYPE field (#2) for the EXCEPTION subfield (#991.12) of the CIRN
"^DIC",991.11,991.11,"%D",3,0)
HL7 EXCEPTION LOG file (#991.1).
"^DIC",991.11,"B","CIRN HL7 EXCEPTION TYPE",991.11)

**END**
**END**
