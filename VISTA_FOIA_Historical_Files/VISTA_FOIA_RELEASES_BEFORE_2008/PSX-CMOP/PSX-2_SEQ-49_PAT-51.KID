Released PSX*2*51 SEQ #49
Extracted from mail message
**KIDS**:PSX*2.0*51^

**INSTALL NAME**
PSX*2.0*51
"BLD",4691,0)
PSX*2.0*51^CMOP^0^3041215^y
"BLD",4691,1,0)
^^19^19^3040824^
"BLD",4691,1,1,0)
1)      Problem: The retransmission of a batch failed to complete the 
"BLD",4691,1,2,0)
updating of prescription statuses in Prescription file #52 and RX 
"BLD",4691,1,3,0)
Suspense file #52.5
"BLD",4691,1,4,0)
 
"BLD",4691,1,5,0)
Resolution:
"BLD",4691,1,6,0)
 
"BLD",4691,1,7,0)
Code has been put in place to complete the updating of prescriptions 
"BLD",4691,1,8,0)
statuses in Prescription file #52 and RX Suspense file #52.5 for 
"BLD",4691,1,9,0)
retransmissions.
"BLD",4691,1,10,0)
 
"BLD",4691,1,11,0)
2)      Problem: The controlling data is stored in ^XTMP and is subject 
"BLD",4691,1,12,0)
to a periodic KERNEL job that clears out the ^XTMP global after midnight 
"BLD",4691,1,13,0)
if the job extends beyond midnight. That has occurred and the job shut 
"BLD",4691,1,14,0)
down.
"BLD",4691,1,15,0)
 
"BLD",4691,1,16,0)
Resolution:
"BLD",4691,1,17,0)
 
"BLD",4691,1,18,0)
The parameter in the ^XTMP setting has been set to protect the global for 
"BLD",4691,1,19,0)
two days.
"BLD",4691,4,0)
^9.64PA^^
"BLD",4691,"KRN",0)
^9.67PA^8989.52^19
"BLD",4691,"KRN",.4,0)
.4
"BLD",4691,"KRN",.401,0)
.401
"BLD",4691,"KRN",.402,0)
.402
"BLD",4691,"KRN",.403,0)
.403
"BLD",4691,"KRN",.5,0)
.5
"BLD",4691,"KRN",.84,0)
.84
"BLD",4691,"KRN",3.6,0)
3.6
"BLD",4691,"KRN",3.8,0)
3.8
"BLD",4691,"KRN",9.2,0)
9.2
"BLD",4691,"KRN",9.8,0)
9.8
"BLD",4691,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",4691,"KRN",9.8,"NM",1,0)
PSXRTRAN^^0^B63996798
"BLD",4691,"KRN",9.8,"NM",2,0)
PSXRSUS1^^0^B5885865
"BLD",4691,"KRN",9.8,"NM",3,0)
PSXRTRA1^^0^B16248666
"BLD",4691,"KRN",9.8,"NM",4,0)
PSXRTR^^0^B23784153
"BLD",4691,"KRN",9.8,"NM","B","PSXRSUS1",2)

"BLD",4691,"KRN",9.8,"NM","B","PSXRTR",4)

"BLD",4691,"KRN",9.8,"NM","B","PSXRTRA1",3)

"BLD",4691,"KRN",9.8,"NM","B","PSXRTRAN",1)

"BLD",4691,"KRN",19,0)
19
"BLD",4691,"KRN",19.1,0)
19.1
"BLD",4691,"KRN",101,0)
101
"BLD",4691,"KRN",409.61,0)
409.61
"BLD",4691,"KRN",771,0)
771
"BLD",4691,"KRN",870,0)
870
"BLD",4691,"KRN",8989.51,0)
8989.51
"BLD",4691,"KRN",8989.52,0)
8989.52
"BLD",4691,"KRN",8994,0)
8994
"BLD",4691,"KRN","B",.4,.4)

"BLD",4691,"KRN","B",.401,.401)

"BLD",4691,"KRN","B",.402,.402)

"BLD",4691,"KRN","B",.403,.403)

"BLD",4691,"KRN","B",.5,.5)

"BLD",4691,"KRN","B",.84,.84)

"BLD",4691,"KRN","B",3.6,3.6)

"BLD",4691,"KRN","B",3.8,3.8)

"BLD",4691,"KRN","B",9.2,9.2)

"BLD",4691,"KRN","B",9.8,9.8)

"BLD",4691,"KRN","B",19,19)

"BLD",4691,"KRN","B",19.1,19.1)

"BLD",4691,"KRN","B",101,101)

"BLD",4691,"KRN","B",409.61,409.61)

"BLD",4691,"KRN","B",771,771)

"BLD",4691,"KRN","B",870,870)

"BLD",4691,"KRN","B",8989.51,8989.51)

"BLD",4691,"KRN","B",8989.52,8989.52)

"BLD",4691,"KRN","B",8994,8994)

"BLD",4691,"QUES",0)
^9.62^^
"BLD",4691,"REQB",0)
^9.611^1^1
"BLD",4691,"REQB",1,0)
PSX*2.0*41^1
"BLD",4691,"REQB","B","PSX*2.0*41",1)

"MBREQ")
0
"PKG",526,-1)
1^1
"PKG",526,0)
CMOP^PSX^CONSOLIDATED MAIL OUTPATIENT PHARMACY
"PKG",526,20,0)
^9.402P^^
"PKG",526,22,0)
^9.49I^1^1
"PKG",526,22,1,0)
2.0^3000210^3000217^11853
"PKG",526,22,1,"PAH",1,0)
51^3041215
"PKG",526,22,1,"PAH",1,1,0)
^^19^19^3041215
"PKG",526,22,1,"PAH",1,1,1,0)
1)      Problem: The retransmission of a batch failed to complete the 
"PKG",526,22,1,"PAH",1,1,2,0)
updating of prescription statuses in Prescription file #52 and RX 
"PKG",526,22,1,"PAH",1,1,3,0)
Suspense file #52.5
"PKG",526,22,1,"PAH",1,1,4,0)
 
"PKG",526,22,1,"PAH",1,1,5,0)
Resolution:
"PKG",526,22,1,"PAH",1,1,6,0)
 
"PKG",526,22,1,"PAH",1,1,7,0)
Code has been put in place to complete the updating of prescriptions 
"PKG",526,22,1,"PAH",1,1,8,0)
statuses in Prescription file #52 and RX Suspense file #52.5 for 
"PKG",526,22,1,"PAH",1,1,9,0)
retransmissions.
"PKG",526,22,1,"PAH",1,1,10,0)
 
"PKG",526,22,1,"PAH",1,1,11,0)
2)      Problem: The controlling data is stored in ^XTMP and is subject 
"PKG",526,22,1,"PAH",1,1,12,0)
to a periodic KERNEL job that clears out the ^XTMP global after midnight 
"PKG",526,22,1,"PAH",1,1,13,0)
if the job extends beyond midnight. That has occurred and the job shut 
"PKG",526,22,1,"PAH",1,1,14,0)
down.
"PKG",526,22,1,"PAH",1,1,15,0)
 
"PKG",526,22,1,"PAH",1,1,16,0)
Resolution:
"PKG",526,22,1,"PAH",1,1,17,0)
 
"PKG",526,22,1,"PAH",1,1,18,0)
The parameter in the ^XTMP setting has been set to protect the global for 
"PKG",526,22,1,"PAH",1,1,19,0)
two days.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSXRSUS1")
0^2^B5885865
"RTN","PSXRSUS1",1,0)
PSXRSUS1 ;BIR/WPB,BAB,HTW-CMOP Transmission Handler sub routine ;15 Dec 2001
"RTN","PSXRSUS1",2,0)
 ;;2.0;CMOP;**41,51**;11 Apr 97
"RTN","PSXRSUS1",3,0)
 ;
"RTN","PSXRSUS1",4,0)
STOREVAR ; store critical variables
"RTN","PSXRSUS1",5,0)
 S X1=DT,X2=+2 D C^%DTC S XXX=X K X1,X2
"RTN","PSXRSUS1",6,0)
 S ^XTMP("PSXTVARS "_$J,0)=XXX_U_DT_U_"variables for CMOP transmissions"
"RTN","PSXRSUS1",7,0)
 S ZZ=""
"RTN","PSXRSUS1",8,0)
 F X="PSXDIVML","PSOSITE","PSOLAP","PSOSYS","PSOPAR","PSXSYS","PSXTRANS","PSXFLAG","PRTDT","PSOINST","PSXDUZ","PSXSITE" S @X=$G(@X)
"RTN","PSXRSUS1",9,0)
 F X="PSXCS","PSXDAYS","PSXDTRG","PSOBARS","PSOBAR1","PSOBAR0","PSOPROP","PSXVENDR","PSLION","TPRTDT" S @X=$G(@X)
"RTN","PSXRSUS1",10,0)
 S ZZ=""
"RTN","PSXRSUS1",11,0)
 F YY="PSXDIVML^1","PSOSITE^2","PSOLAP^3","PSOSYS^4","PSOPAR^5","PSXSYS^6","PSXTRANS^7","PSXFLAG^8","PRTDT^9","PSOINST^10","PSXDUZ^11","PSXSITE^12" D SET^PSXUTL(.ZZ,U,YY)
"RTN","PSXRSUS1",12,0)
 S ^XTMP("PSXTVARS "_$J,1)=ZZ
"RTN","PSXRSUS1",13,0)
 S ZZ=""
"RTN","PSXRSUS1",14,0)
 F YY="PSXCS^1","PSXDAYS^2","PSXDTRG^3","PSOBARS^4","PSOBAR1^5","PSOBAR0^6","PSOPROP^7","PSXVENDR^8","PSLION^9","TPRTDT^10" D SET^PSXUTL(.ZZ,U,YY)
"RTN","PSXRSUS1",15,0)
 S ^XTMP("PSXTVARS "_$J,2)=ZZ
"RTN","PSXRSUS1",16,0)
 K XXX
"RTN","PSXRSUS1",17,0)
 Q
"RTN","PSXRSUS1",18,0)
RESETVAR ; retrieve critical variables
"RTN","PSXRSUS1",19,0)
 S ZZ=^XTMP("PSXTVARS "_$J,1)
"RTN","PSXRSUS1",20,0)
 F YY="PSXDIVML^1","PSOSITE^2","PSOLAP^3","PSOSYS^4","PSOPAR^5","PSXSYS^6","PSXTRANS^7","PSXFLAG^8","PRTDT^9","PSOINST^10","PSXDUZ^11","PSXSITE^12" D SET^PSXUTL(.ZZ,U,YY)
"RTN","PSXRSUS1",21,0)
 S ZZ=^XTMP("PSXTVARS "_$J,2)
"RTN","PSXRSUS1",22,0)
 F YY="PSXCS^1","PSXDAYS^2","PSXDTRG^3","PSOBARS^4","PSOBAR1^5","PSOBAR0^6","PSOPROP^7","PSXVENDR^8","PSLION^9","TPRTDT^10" D PIECE^PSXUTL(ZZ,U,YY)
"RTN","PSXRSUS1",23,0)
 Q
"RTN","PSXRTR")
0^4^B23784153
"RTN","PSXRTR",1,0)
PSXRTR ;BIR/BAB,WPB,PWC-Transmit Data to CMOP Host System ;14 Dec 2001
"RTN","PSXRTR",2,0)
 ;;2.0;CMOP;**18,23,27,31,28,41,51**;11 Apr 97
"RTN","PSXRTR",3,0)
 ;Reference to ^DIC(4.2 supported by DBIA #1966
"RTN","PSXRTR",4,0)
 ;Reference to ^PS(59   supported by DBIA #1976
"RTN","PSXRTR",5,0)
 ;Reference to File #200 supported by DBIA #10060
"RTN","PSXRTR",6,0)
 ;Requires PSXHDR,PSXORD (A B C D) arrays
"RTN","PSXRTR",7,0)
 Q
"RTN","PSXRTR",8,0)
EN ;Entry point for data transmission, load mailman message and send
"RTN","PSXRTR",9,0)
 S PSXJOB=1,PSXRTRN=0 K ERR
"RTN","PSXRTR",10,0)
 I $E(IOST)="C" W !,"EN^PSXRTR DIV: ",PSOSITE," ",+$G(PSXBAT)
"RTN","PSXRTR",11,0)
 I (($G(PSXBAT)="")!('$D(^PSX(550.1,"C",PSXBAT)))) G EXIT
"RTN","PSXRTR",12,0)
 S (PSXMSG,PSXMFLAG,PSXEND,PSXSTART)=0
"RTN","PSXRTR",13,0)
 F  S PSXMSG=$O(^PSX(550.1,"C",PSXBAT,PSXMSG)) Q:PSXMSG'>0  S PSXEND=PSXMSG S:PSXSTART=0 PSXSTART=PSXMSG
"RTN","PSXRTR",14,0)
 S PSXSITE=$P($G(PSXSYS),U,3),PSXSENDR=$$GET1^DIQ(200,DUZ,.01),SITENUM=$P($G(PSXSYS),U,2),PSXDIV=$P($G(^PS(59,+PSOSITE,0)),U,1),XSITE=$P($G(^PS(59,+PSOSITE,0)),U,6)
"RTN","PSXRTR",15,0)
 S PSXHDR=PSXSITE_U_+PSXSYS_U_SITENUM_U_PSXTDT_U_PSXSENDR_U_PSXSTART_U_PSXEND_U_PSXDIV_U_XSITE,PSXREF=SITENUM_"-"_$$GET1^DIQ(550.2,PSXBAT,.01)
"RTN","PSXRTR",16,0)
 N DOMAIN,LCNT,XMDUZ,XMSUB,XMZ,ORD
"RTN","PSXRTR",17,0)
 S (LCNT,PSXMSGCT,PSXRXCT)=0
"RTN","PSXRTR",18,0)
 S X=$$KSP^XUPARAM("INST"),DIC="4",DIC(0)="XMZO" D ^DIC S SITEX=$P(Y,"^",2) K DIC,X,Y
"RTN","PSXRTR",19,0)
 S XMSUB="CMOP"_$S($G(PSXCS)=1:" Controlled Substances",1:"")_" Transmission from "_SITEX,XMDUZ=.5
"RTN","PSXRTR",20,0)
XMZ D XMZ^XMA2
"RTN","PSXRTR",21,0)
 I XMZ'>0 G XMZ
"RTN","PSXRTR",22,0)
 K SITEX
"RTN","PSXRTR",23,0)
HDR ;Gather data from header, load NTE1 - NTE5 into mailmessage from PSXORD( array
"RTN","PSXRTR",24,0)
 S ORD="$$XMIT"_U_$$GET1^DIQ(550.2,PSXBAT,.01)_U_PSXHDR D TXT
"RTN","PSXRTR",25,0)
 S ORD=$G(PSXORD("A")) D TXT
"RTN","PSXRTR",26,0)
 ;If not any data in the refill/nonrefill/copay instructions set 
"RTN","PSXRTR",27,0)
 ;set array equal to NTE...+3 spaces
"RTN","PSXRTR",28,0)
 S:$G(PSXORD("B",1))="" PSXORD("B",1)="NTE|2||   "
"RTN","PSXRTR",29,0)
 S:$G(PSXORD("C",1))="" PSXORD("C",1)="NTE|3||   "
"RTN","PSXRTR",30,0)
 S:$G(PSXORD("D",1))="" PSXORD("D",1)="NTE|4||   "
"RTN","PSXRTR",31,0)
 F ZZ="B","C","D" S Z=0 F  S Z=$O(PSXORD(ZZ,Z)) Q:Z'>0  S ORD=$G(PSXORD(ZZ,Z)) D TXT
"RTN","PSXRTR",32,0)
 ;Gather data for individual patient orders
"RTN","PSXRTR",33,0)
LOCK ;
"RTN","PSXRTR",34,0)
 D NOW^%DTC S DTTM=%,(MSG,ZCNT)=0
"RTN","PSXRTR",35,0)
 ; load patients' 550.1 "T" nodes into the mail message
"RTN","PSXRTR",36,0)
 F  S MSG=$O(^PSX(550.1,"C",PSXBAT,MSG)) Q:MSG=""  S PSXMSGCT=PSXMSGCT+1,LNTX=+$P(^PSX(550.1,MSG,"T",0),U,4) D
"RTN","PSXRTR",37,0)
 .S ORD="$MSG^"_+$G(^PSX(550.1,MSG,0))_U_LNTX D TXT
"RTN","PSXRTR",38,0)
 .F PSX=1:1:LNTX I $G(^PSX(550.1,MSG,"T",PSX,0))]"" S ORD=$G(^(0)) S:$E(ORD,1,7)="ORC|NW|" PSXRXCT=PSXRXCT+1 D TXT
"RTN","PSXRTR",39,0)
 .K DA,DIE,DR S DA=MSG L +^PSX(550.1,DA)
"RTN","PSXRTR",40,0)
 .S DIE="^PSX(550.1,",DR="1///2;5////"_DTTM_";3////"_PSXBAT
"RTN","PSXRTR",41,0)
 .D ^DIE L -^PSX(550.1,DA) K DA,DIE,DR ;update msgs in 550.1
"RTN","PSXRTR",42,0)
 S ORD="$$ENDXMIT^"_U_PSXFAC_U_PSXBAT_U_PSXMSGCT_U_PSXRXCT D TXT K ORD
"RTN","PSXRTR",43,0)
 S ^XMB(3.9,XMZ,2,0)="^3.92A^"_LCNT_U_LCNT_U_DT,XMDUN="CMOP Manager"
"RTN","PSXRTR",44,0)
 S XMDUZ=.5
"RTN","PSXRTR",45,0)
 S RECV=$P($G(^PSX(550,+PSXSYS,0)),U,4),DOMAIN="@"_$$GET1^DIQ(4.2,RECV,.01)
"RTN","PSXRTR",46,0)
 ;code to divert patient transmissions for testing
"RTN","PSXRTR",47,0)
 I '$D(^XTMP("PSXDIVERTCMOP")) S XMY("S.PSXX CMOP SERVER"_DOMAIN)="" I 1 ;****TESTING
"RTN","PSXRTR",48,0)
 E  S XX=^XTMP("PSXDIVERTCMOP",1) S XMY(XX)="" H 1 ;****TESTING S.PSXX
"RTN","PSXRTR",49,0)
 D ENT1^XMD
"RTN","PSXRTR",50,0)
 D XMIT
"RTN","PSXRTR",51,0)
 S PSXFLAG=1 D EN^PSXNOTE
"RTN","PSXRTR",52,0)
 K DIE,DA,DR,BAT,PSX,PSXORD,MSG,LNTX,LCNT,DOMAIN,RECV,SITENUM,Z,ZZ,XMDUN,XMDUZ,XMSUB,XMY,XMZ,PSXDIV,XSITE
"RTN","PSXRTR",53,0)
 Q
"RTN","PSXRTR",54,0)
XMIT ;Update 550.2 # of ORDs, RXs; rxS IN 52, 52.5: 550.2 to Transmitted
"RTN","PSXRTR",55,0)
 ;Update 550 with batch
"RTN","PSXRTR",56,0)
 N PSXTRDTM D NOW^%DTC S PSXTRDTM=%
"RTN","PSXRTR",57,0)
 L +^PSX(550.2,PSXBAT):600 I '$T S XQAMSG="CMOP Transmission file in use. Entry for trans "_PSXBAT_" not complete. Contact IRM." D GRP1^PSXNOTE,SETUP^XQALERT K XQAMSG,XQA Q
"RTN","PSXRTR",58,0)
 S DA=PSXBAT,DIE="^PSX(550.2,",DR="1////2;11////"_PSXSTART_";12////"_PSXEND_";13////"_PSXMSGCT_";14////"_PSXRXCT_";5////"_PSXTRDTM
"RTN","PSXRTR",59,0)
 D ^DIE K DA,DIE,DR
"RTN","PSXRTR",60,0)
 L -^PSX(550.2,PSXBAT)
"RTN","PSXRTR",61,0)
 S PSXMFLAG=1
"RTN","PSXRTR",62,0)
 D ^PSXRXU ; update RXs in 52 52.5
"RTN","PSXRTR",63,0)
 L +^PSX(550,+PSXSYS):600 Q:'$T
"RTN","PSXRTR",64,0)
 S DA=+PSXSYS,DIE="^PSX(550,",DR="6////"_PSXBAT D ^DIE K DIE,DA,DR
"RTN","PSXRTR",65,0)
 L -^PSX(550,+PSXSYS)
"RTN","PSXRTR",66,0)
 Q
"RTN","PSXRTR",67,0)
TXT ;
"RTN","PSXRTR",68,0)
 I $G(ORD)]"" S LCNT=LCNT+1,^XMB(3.9,XMZ,2,LCNT,0)=ORD
"RTN","PSXRTR",69,0)
 Q
"RTN","PSXRTR",70,0)
EXIT K %,ERROR,PSXRTRN,PSXJOB,PSXER,PSXHDR,PSXFAC,PSXBAT,PSXEND,PSXMFLAG,PSXMSG,PSXMSGCT,PSXRXCT,PSXSENDR,PSXSITE,PSXTDT,N Q
"RTN","PSXRTR",71,0)
 Q
"RTN","PSXRTR",72,0)
DIVERT ; divert transmissions from CMOP to the user evoking the divert
"RTN","PSXRTR",73,0)
 W !,"This will divert CMOP Patient transmissions to the user evoking the divert",!,"for one day or until 'D RESET^PSXRTR' is executed.",!
"RTN","PSXRTR",74,0)
 K DIR S DIR(0)="YO",DIR("B")="N" D ^DIR
"RTN","PSXRTR",75,0)
 I 'Y W !,"CMOP Patient transmissions >>NOT DIVERTED<<",! Q
"RTN","PSXRTR",76,0)
 S ^XTMP("PSXDIVERTCMOP",0)=DT_U_DT_U_"Divert CMOP Transmissions"
"RTN","PSXRTR",77,0)
 S ^XTMP("PSXDIVERTCMOP",1)=DUZ
"RTN","PSXRTR",78,0)
 W !!,"CMOP Patient transmissions >>DIVERTED<< to ",$$GET1^DIQ(200,DUZ,.01),!!,"Use 'D RESET^PSXRTR' to restore normal CMOP Patient transmissions.",!
"RTN","PSXRTR",79,0)
 K DIR S DIR(0)="E",DIR("A")="<CR> Continue" D ^DIR
"RTN","PSXRTR",80,0)
 Q
"RTN","PSXRTR",81,0)
RESET ; reset normal CMOP Patient transmissions
"RTN","PSXRTR",82,0)
 S XX=$D(^XTMP("PSXDIVERTCMOP"))
"RTN","PSXRTR",83,0)
 S N=$S(XX>0:"HAD BEEN",1:"HAD NOT BEEN")
"RTN","PSXRTR",84,0)
 W !,"CMOP Patient transmissions >>",N,"<< diverted"
"RTN","PSXRTR",85,0)
 I XX S XX=^XTMP("PSXDIVERTCMOP",1) W " to ",$$GET1^DIQ(200,XX,.01)
"RTN","PSXRTR",86,0)
 W ".",!,"CMOP Patient transmissions are set to go to the CMOP.",!
"RTN","PSXRTR",87,0)
 K ^XTMP("PSXDIVERTCMOP")
"RTN","PSXRTR",88,0)
 Q
"RTN","PSXRTRA1")
0^3^B16248666
"RTN","PSXRTRA1",1,0)
PSXRTRA1 ;BIR/PDW-RETRANSMISSION REPORT SUBROUTINE ;11 AUG 2002
"RTN","PSXRTRA1",2,0)
 ;;2.0;CMOP;**41,51**;11 Apr 97
"RTN","PSXRTRA1",3,0)
 ;Reference to ^PSRX(   supported by DBIA #1977
"RTN","PSXRTRA1",4,0)
REPORT ;
"RTN","PSXRTRA1",5,0)
 K ^TMP($J,"PSXRTRPT"),LSSN S CNT=21
"RTN","PSXRTRA1",6,0)
 S PTNM="" F  S PTNM=$O(^PSX(550.2,OLDBAT,15,"C",PTNM)) Q:PTNM=""  D
"RTN","PSXRTRA1",7,0)
 . S DFN=0 F  S LSSN="" S DFN=$O(^PSX(550.2,OLDBAT,15,"C",PTNM,DFN)) Q:DFN'>0  D RXS
"RTN","PSXRTRA1",8,0)
 D MM
"RTN","PSXRTRA1",9,0)
 K PTNM,RXPTR,XSTAT
"RTN","PSXRTRA1",10,0)
 Q
"RTN","PSXRTRA1",11,0)
RXS ;
"RTN","PSXRTRA1",12,0)
 S RXPTR=0 F  S RXPTR=$O(^PSX(550.2,OLDBAT,15,"C",PTNM,DFN,RXPTR)) Q:RXPTR=""  D
"RTN","PSXRTRA1",13,0)
 . S FILL=$O(^PSX(550.2,OLDBAT,15,"C",PTNM,DFN,RXPTR,""))
"RTN","PSXRTRA1",14,0)
 . D TXT
"RTN","PSXRTRA1",15,0)
 Q
"RTN","PSXRTRA1",16,0)
MM S XMSUB="CMOP Retransmission Report for "_$G(OLDBATNM),XMDUZ=.5,XMDUN="CMOP Managers"
"RTN","PSXRTRA1",17,0)
 D XMZ^XMA2 G:$G(XMZ)'>0 MM
"RTN","PSXRTRA1",18,0)
 S ^XMB(3.9,XMZ,2,1,0)="CMOP Re-Transmission Report"
"RTN","PSXRTRA1",19,0)
 S ^XMB(3.9,XMZ,2,2,0)=$G(PSXBATNM)_" Re-Transmission of "_$G(OLDBATNM)
"RTN","PSXRTRA1",20,0)
 S ^XMB(3.9,XMZ,2,3,0)=" "
"RTN","PSXRTRA1",21,0)
 S ^XMB(3.9,XMZ,2,4,0)="The Original Transmission # "_$G(OLDBATNM)_" contained:"
"RTN","PSXRTRA1",22,0)
 S ^XMB(3.9,XMZ,2,5,0)="Beginning Message Number: "_$P(^PSX(550.2,OLDBAT,1),"^",5)
"RTN","PSXRTRA1",23,0)
 S ^XMB(3.9,XMZ,2,6,0)="Ending Message Number   : "_$P(^PSX(550.2,OLDBAT,1),"^",6)
"RTN","PSXRTRA1",24,0)
 S ^XMB(3.9,XMZ,2,7,0)="Total Orders            : "_$P(^PSX(550.2,OLDBAT,1),"^",7)
"RTN","PSXRTRA1",25,0)
 S ^XMB(3.9,XMZ,2,8,0)="Total Rx's              : "_$P(^PSX(550.2,OLDBAT,1),"^",8)
"RTN","PSXRTRA1",26,0)
 S ^XMB(3.9,XMZ,2,9,0)=" "
"RTN","PSXRTRA1",27,0)
 S ^XMB(3.9,XMZ,2,10,0)="Retransmission # "_$G(PSXBATNM)_" contained:"
"RTN","PSXRTRA1",28,0)
 S ^XMB(3.9,XMZ,2,11,0)="Beginning Message Number: "_$G(MCT)
"RTN","PSXRTRA1",29,0)
 S ^XMB(3.9,XMZ,2,12,0)="Ending Message Number   : "_$G(LMSG)
"RTN","PSXRTRA1",30,0)
 S ^XMB(3.9,XMZ,2,13,0)="Total Orders            : "_$G(PSXMSGCT)
"RTN","PSXRTRA1",31,0)
 S ^XMB(3.9,XMZ,2,14,0)="Total Rx's              : "_$G(PSXRXCT)
"RTN","PSXRTRA1",32,0)
 S ^XMB(3.9,XMZ,2,15,0)=" "
"RTN","PSXRTRA1",33,0)
 S ^XMB(3.9,XMZ,2,16,0)="Following is a list of the original prescription orders and their status."
"RTN","PSXRTRA1",34,0)
 S ^XMB(3.9,XMZ,2,17,0)="** Prescriptions that have been refilled or released are not sent. **"
"RTN","PSXRTRA1",35,0)
 I '$D(^TMP($J,"PSXRTRPT")) S ^XMB(3.9,XMZ,17,0)="All prescriptions were transmitted" S CNT=17 G MAIL
"RTN","PSXRTRA1",36,0)
 F JJ=18,19,20 S ^XMB(3.9,XMZ,2,JJ,0)=" "
"RTN","PSXRTRA1",37,0)
 S XX="Patient",Y="SSN",XX=$$SETSTR^VALM1("SSN",XX,25,3)
"RTN","PSXRTRA1",38,0)
 S XX=$$SETSTR^VALM1("RX",XX,40,2),XX=$$SETSTR^VALM1("RELEASE DATE | FILL'=",XX,55,21)
"RTN","PSXRTRA1",39,0)
 S ^XMB(3.9,XMZ,2,21,0)=XX
"RTN","PSXRTRA1",40,0)
 M ^XMB(3.9,XMZ,2)=^TMP($J,"PSXRTRPT","MM")
"RTN","PSXRTRA1",41,0)
MAIL ;
"RTN","PSXRTRA1",42,0)
 S ^XMB(3.9,XMZ,2,0)="^3.92A^"_CNT_"^"_CNT_"^"_DT
"RTN","PSXRTRA1",43,0)
 K XMY
"RTN","PSXRTRA1",44,0)
 S XMY(DUZ)="" ;****TESTING
"RTN","PSXRTRA1",45,0)
 D GRP^PSXNOTE ;****TESTING
"RTN","PSXRTRA1",46,0)
 D ENT1^XMD
"RTN","PSXRTRA1",47,0)
 Q
"RTN","PSXRTRA1",48,0)
TXT ; store PAT & RX info for mail message
"RTN","PSXRTRA1",49,0)
 D DEM^VADPT S SSN=$P(VADM(2),U,2),PATNM=VADM(1)
"RTN","PSXRTRA1",50,0)
 S RXNM=$P(^PSRX(RXPTR,0),U)_"-"_FILL
"RTN","PSXRTRA1",51,0)
 S XSTAT=""
"RTN","PSXRTRA1",52,0)
 I '$D(^PSX(550.2,PSXBAT,15,"B",RXPTR)) D
"RTN","PSXRTRA1",53,0)
 .S XSTAT=$$TESTREL^PSXRTRAN(RXPTR,FILL)
"RTN","PSXRTRA1",54,0)
 .S:XSTAT="SENT" XSTAT="OTHER"
"RTN","PSXRTRA1",55,0)
 S XX=""
"RTN","PSXRTRA1",56,0)
 I $G(LSSN)'=SSN D
"RTN","PSXRTRA1",57,0)
 . S XX=$E(PATNM,1,23)
"RTN","PSXRTRA1",58,0)
 . S XX=$$SETSTR^VALM1(SSN,XX,25,$L(SSN))
"RTN","PSXRTRA1",59,0)
 S XX=$$SETSTR^VALM1(RXNM,XX,40,$L(RXNM))
"RTN","PSXRTRA1",60,0)
 S:$L(XSTAT) XX=$$SETSTR^VALM1(XSTAT,XX,60,$L(XSTAT))
"RTN","PSXRTRA1",61,0)
 S CNT=$G(CNT)+1,LSSN=SSN
"RTN","PSXRTRA1",62,0)
 S ^TMP($J,"PSXRTRPT","MM",CNT,0)=XX
"RTN","PSXRTRA1",63,0)
 Q
"RTN","PSXRTRA1",64,0)
CANMSG ; lock on 550.1 not achieved send transmission cancelled message
"RTN","PSXRTRA1",65,0)
 S PSXCS=+$G(PSXCS)
"RTN","PSXRTRA1",66,0)
 S XMSUB=$S($G(PSXCS):"",1:"NON-")_"CS Retransmission Cancelled"
"RTN","PSXRTRA1",67,0)
 S XMTEXT="TXT("
"RTN","PSXRTRA1",68,0)
 S TXT(1,0)="The "_$S($G(PSXCS):"",1:"NON-")_"CS Manual Transmission was cancelled "_$$GET1^DIQ(550.2,OLDBAT,.01)
"RTN","PSXRTRA1",69,0)
 S TXT(2,0)="It could not obtain a lock on the RX QUEUE file. #550.1"
"RTN","PSXRTRA1",70,0)
 S TXT(3,0)="This indicates that a transmission was in progress."
"RTN","PSXRTRA1",71,0)
 S TXT(6,0)=" "
"RTN","PSXRTRA1",72,0)
 S TXT(7,0)="If you are getting this message frequently, please contact your IRM Group"
"RTN","PSXRTRA1",73,0)
 D EN^PSXNOTE ;****TESTING
"RTN","PSXRTRA1",74,0)
 D ^XMD
"RTN","PSXRTRA1",75,0)
 Q
"RTN","PSXRTRA1",76,0)
SETSTAT ;Set RX CMOP status to re-transmitted
"RTN","PSXRTRA1",77,0)
 N RXDA,CMPDA
"RTN","PSXRTRA1",78,0)
 S RXDA=0 F  S RXDA=$O(^PSX(550.2,PSXBAT,15,"B",RXDA)) Q:RXDA'>0  D
"RTN","PSXRTRA1",79,0)
 . S CMPDA=$O(^PSRX(RXDA,4,"B",OLDBAT,0)) Q:'CMPDA
"RTN","PSXRTRA1",80,0)
 . Q:'CMPDA  Q:'$D(^PSRX(RXDA,4,CMPDA,0))
"RTN","PSXRTRA1",81,0)
 . S $P(^PSRX(RXDA,4,CMPDA,0),U,4)=2
"RTN","PSXRTRA1",82,0)
 Q
"RTN","PSXRTRAN")
0^1^B63996798
"RTN","PSXRTRAN",1,0)
PSXRTRAN ;BIR/WPB/PDW-Batch Retransmission Routine ;13 Mar 2002  3:09 PM
"RTN","PSXRTRAN",2,0)
 ;;2.0;CMOP;**18,27,31,41,51**;11 Apr 97
"RTN","PSXRTRAN",3,0)
 ;Reference to ^PS(59,  supported by DBIA #1976
"RTN","PSXRTRAN",4,0)
 ;Reference to ^PS(59.7 supported by DBIA #694
"RTN","PSXRTRAN",5,0)
 ;Reference to ^PSRX(   supported by DBIA #1977
"RTN","PSXRTRAN",6,0)
 ;
"RTN","PSXRTRAN",7,0)
START I '$D(^XUSEC("PSXCMOPMGR",DUZ)) D NO Q
"RTN","PSXRTRAN",8,0)
 I '$D(^XUSEC("PSXRTRAN",DUZ)) D NO Q
"RTN","PSXRTRAN",9,0)
 I '$D(^XUSEC("PSX XMIT",DUZ)) D NO Q
"RTN","PSXRTRAN",10,0)
 D SET^PSXSYS
"RTN","PSXRTRAN",11,0)
 I '$D(PSXSYS) W !,"CMOP processing is inactivated, re-transmission of data not allowed." Q
"RTN","PSXRTRAN",12,0)
 S PSXJOB=2
"RTN","PSXRTRAN",13,0)
 I $D(^PSX(550,"TR","T")) W !,"There is another job in progress, try again later." G EXIT
"RTN","PSXRTRAN",14,0)
 L +PSX(550.1):3 I '$T W !,"There is another job in progress, try again later." G EXIT
"RTN","PSXRTRAN",15,0)
 I '$D(^PSX(550.2,"AX")) W !!,"No data to re-transmit." G EXIT
"RTN","PSXRTRAN",16,0)
 S DIC="^PSX(550.2,",DIC(0)="AMZEQ",DIC("S")="I ($D(^PSX(550.2,""AX"",+Y))),($P($G(^PSX(550.2,+Y,1)),U,3)=""""),($P($G(^PSX(550.2,+Y,1)),U,1)="""")"
"RTN","PSXRTRAN",17,0)
 D ^DIC K DIC,DIC("S"),DIC(0)
"RTN","PSXRTRAN",18,0)
 G:$D(DTOUT)!($D(DUOUT))!($G(Y)'>0) EXIT
"RTN","PSXRTRAN",19,0)
 S OLDBAT=+Y K Y,TRAN,TRANI
"RTN","PSXRTRAN",20,0)
 D GETS^DIQ(550.2,OLDBAT,".01;2;3;5;14;17","","TRAN"),TOP^PSXUTL("TRAN") ;external of fields
"RTN","PSXRTRAN",21,0)
 D GETS^DIQ(550.2,OLDBAT,".01;2;3;5;14;17","I","TRANI"),TOP^PSXUTL("TRANI") ;internal of fields
"RTN","PSXRTRAN",22,0)
 S OLDBATNM=TRAN(.01)
"RTN","PSXRTRAN",23,0)
 W !,"Transmission:       "_TRAN(.01)
"RTN","PSXRTRAN",24,0)
 W !,"Date:               "_TRAN(5)
"RTN","PSXRTRAN",25,0)
 W !,"Division:           "_TRAN(2)
"RTN","PSXRTRAN",26,0)
 W !,"Type:               "_TRAN(17)
"RTN","PSXRTRAN",27,0)
 W !,"CMOP Host:          "_TRAN(3)
"RTN","PSXRTRAN",28,0)
 W !,"Total RXs:          "_TRAN(14)
"RTN","PSXRTRAN",29,0)
 S TYP=$S(TRANI(17)="C":"CS",1:"STD")
"RTN","PSXRTRAN",30,0)
 S PSXCS=$S(TYP="CS":1,1:0) D SET^PSXSYS
"RTN","PSXRTRAN",31,0)
 I TRANI(3)'=+PSXSYS W !!,$$GET1^DIQ(550,+PSXSYS,.01)_" is the active host for transmitting "_TRAN(17) G EXIT
"RTN","PSXRTRAN",32,0)
CLOSED S CLOSED=$P($G(^PSX(550.2,OLDBAT,1)),U,1)
"RTN","PSXRTRAN",33,0)
 I CLOSED'="" W !,"The transmission selected has been acknowledged and cannot be re-transmitted." D RESET G EXIT
"RTN","PSXRTRAN",34,0)
 I $P($G(^PSX(550.2,OLDBAT,1)),U,2)'="" W !!,"This transmission has been re-transmitted once and cannot",!,"be retransmitted again." D RESET G ERRMSG^PSXERR1
"RTN","PSXRTRAN",35,0)
 W !!
"RTN","PSXRTRAN",36,0)
 S BMSG=$P($G(^PSX(550.2,OLDBAT,1)),U,5)-1,EMSG=$P($G(^PSX(550.2,OLDBAT,1)),U,6),PSOSITE=$P($G(^PSX(550.2,OLDBAT,0)),"^",3)
"RTN","PSXRTRAN",37,0)
 S PSXSTART=BMSG+1,PSXDUZ=DUZ,PSXSITE=$P($G(PSXSYS),U,3)
"RTN","PSXRTRAN",38,0)
 S SNDR=$$GET1^DIQ(200,$P($G(^PSX(550.2,OLDBAT,0)),U,5),.01)
"RTN","PSXRTRAN",39,0)
 S DIV=$P($G(^PS(59,$P($G(^PSX(550.2,OLDBAT,0)),U,3),0)),U,1),Y=$P($G(^PSX(550.2,OLDBAT,0)),U,6) X ^DD("DD") S TRNDT=Y
"RTN","PSXRTRAN",40,0)
 W !,"   *** Coordinate re-transmissions with ",$$GET1^DIQ(550,+PSXSYS,.01)," CMOP ***",!
"RTN","PSXRTRAN",41,0)
 S DIR(0)="Y^O",DIR("B")="NO",DIR("A")="Are you sure you want to Re-transmit this batch" D ^DIR K DIR
"RTN","PSXRTRAN",42,0)
 I Y=0!($D(DIRUT)) D RESET G EXIT
"RTN","PSXRTRAN",43,0)
QUE ;
"RTN","PSXRTRAN",44,0)
 F YY="PSXMFLAG","BMSG","EMSG","PSXSYS","OLDBAT*","PSXDUZ","PSXJOB","PSXSITE","PSOSITE","PSXSTART","PSXJOB","PSXSITE","TRAN*","PSXCS" S ZTSAVE(YY)=""
"RTN","PSXRTRAN",45,0)
 S ZTDTH=$H,ZTSAVE("ZZDATA")="",ZTIO="",ZTRTN="ENTRAN^PSXRTRAN",ZTDESC="CMOP Retransmission"
"RTN","PSXRTRAN",46,0)
 D ^%ZTLOAD ;****TESTING
"RTN","PSXRTRAN",47,0)
 ;D ENTRAN S PSXSTAT="H" D PSXSTAT^PSXRSYU G EXIT ;****TESTING ;to run in the foreground uncomment this line and comment out the previous line
"RTN","PSXRTRAN",48,0)
 I $D(ZTSK)[0 W !!,"Job Cancelled" G EXIT
"RTN","PSXRTRAN",49,0)
 E  W !!,"Re-transmission Queued "_ZTSK
"RTN","PSXRTRAN",50,0)
 S PSXSTAT="T" D PSXSTAT^PSXRSYU
"RTN","PSXRTRAN",51,0)
 G EXIT
"RTN","PSXRTRAN",52,0)
TXT I $G(ORD)]"" S LCNT=LCNT+1,^XMB(3.9,XMZ,2,LCNT,0)=ORD
"RTN","PSXRTRAN",53,0)
 Q
"RTN","PSXRTRAN",54,0)
ENTRAN ;Entry for data transmission
"RTN","PSXRTRAN",55,0)
LOCK ; >>>**** LOCK OF FILE 550.1 ****<<<
"RTN","PSXRTRAN",56,0)
 F I=1:1:3 L +^PSX(550.1):6 I $T S I=100
"RTN","PSXRTRAN",57,0)
 I I'=100 D CANMSG G EXIT ; could not get a lock in 18 minutes of waiting
"RTN","PSXRTRAN",58,0)
 K ^TMP($J,"PSX"),^TMP($J,"PSXDFN"),ZCNT,PSXBAT
"RTN","PSXRTRAN",59,0)
 S PSOPAR=^PS(59,PSOSITE,1)
"RTN","PSXRTRAN",60,0)
 S PSXTDIV=PSOSITE,PSXTYP=$S(+$G(PSXCS):"C",1:"N")
"RTN","PSXRTRAN",61,0)
 S PSOLAP=ION,PSOSYS=$G(^PS(59.7,1,40.1)),PSXTRANS=1,PSXFLAG=1
"RTN","PSXRTRAN",62,0)
 S PSOINST=+$P(PSXSYS,"^",2)
"RTN","PSXRTRAN",63,0)
 S PSXVENDR="AUTOMATED SYSTEM"
"RTN","PSXRTRAN",64,0)
 S PSXRTRAN=1,PSXRTRN=1,ZTREQ="@"
"RTN","PSXRTRAN",65,0)
RESETRX ; pull, reset RXs from 550.2 RX multiple, if released do not send, make report
"RTN","PSXRTRAN",66,0)
 K ^TMP($J,"PSXRTRAN"),LCNT
"RTN","PSXRTRAN",67,0)
 S PSXERFLG=0 S PSXFLAG=1,PSXRTRAN=1
"RTN","PSXRTRAN",68,0)
 F NI=1:1 Q:'$D(^PSX(550.2,OLDBAT,15,NI,0))  S XX=^(0) D
"RTN","PSXRTRAN",69,0)
 . N NI
"RTN","PSXRTRAN",70,0)
 . S RXDA=$P(XX,U,1),FILL=$P(XX,U,2),DFN=$P(XX,U,3),REC=$P(XX,U,5)
"RTN","PSXRTRAN",71,0)
 . S TEST=$$TESTREL(RXDA,FILL) ; test & catalog RXs for report, 'SENT' if OK, "FILL '=" if more recent fill, 'released date' if released 
"RTN","PSXRTRAN",72,0)
 . Q:TEST'="SENT"
"RTN","PSXRTRAN",73,0)
 . Q:'$D(^PS(52.5,"B",RXDA))  ;RX pulled early from suspense
"RTN","PSXRTRAN",74,0)
 . D RESET^PSXNEW(RXDA,FILL,"Re-Trans of "_OLDBAT)
"RTN","PSXRTRAN",75,0)
 . D SDT ;test/set RX into 550.2
"RTN","PSXRTRAN",76,0)
 ;
"RTN","PSXRTRAN",77,0)
 I '$G(PSXBAT) D NOTRAN G EXIT ;no RXs passed retesting
"RTN","PSXRTRAN",78,0)
 I PSXERFLG=1 S PSXJOB=7 D ^PSXERR
"RTN","PSXRTRAN",79,0)
 D EN^PSXBLD ; build 550.1 entries related to PSXBAT
"RTN","PSXRTRAN",80,0)
 I PSXERFLG=1 S PFLAG=1 D EN^PSXERR
"RTN","PSXRTRAN",81,0)
 S OLDSDT=$P($G(^PSX(550.2,OLDBAT,0)),"^",6)
"RTN","PSXRTRAN",82,0)
 S PSXSENDR=$$GET1^DIQ(200,PSXDUZ,.01),(SITEN,SITENUM)=$P($G(PSXSYS),U,2),PSXEND=EMSG,PSXDIV=$P($G(^PS(59,+PSOSITE,0)),U,1),XSITE=$P($G(^PS(59,+PSOSITE,0)),U,6)
"RTN","PSXRTRAN",83,0)
 S PSXSTART=$O(^PSX(550.1,"C",PSXBAT,0)),(PSXEND,EMSG)=$O(^PSX(550.1,"C",PSXBAT,"A"),-1)
"RTN","PSXRTRAN",84,0)
 S PSXBATNM=$$GET1^DIQ(550.2,PSXBAT,.01)
"RTN","PSXRTRAN",85,0)
 S PSXHDR=PSXSITE_U_+PSXSYS_U_SITENUM_U_PSXTDT_U_PSXSENDR_U_PSXSTART_U_EMSG_U_PSXDIV_U_XSITE,PSXREF=SITENUM_"-"_PSXBATNM
"RTN","PSXRTRAN",86,0)
 N DOMAIN,LCNT,XMDUZ,XMSUB,XMZ,ORD
"RTN","PSXRTRAN",87,0)
 S (LCNT,PSXMSGCT,PSXRXCT)=0
"RTN","PSXRTRAN",88,0)
 S X=$$KSP^XUPARAM("INST"),DIC="4",DIC(0)="MOXZ" D ^DIC S SITEX=$P(Y,"^",2),XMDUZ=.5 K X,Y,DIC
"RTN","PSXRTRAN",89,0)
XMZ S XMSUB="CMOP Retransmission Update from "_SITEX
"RTN","PSXRTRAN",90,0)
 D XMZ^XMA2
"RTN","PSXRTRAN",91,0)
 I XMZ'>0 H 2 G XMZ
"RTN","PSXRTRAN",92,0)
HDR ;Get header data
"RTN","PSXRTRAN",93,0)
 S ORD="$$RMIT"_U_PSXBATNM_U_PSXHDR_U_OLDBATNM D TXT
"RTN","PSXRTRAN",94,0)
 S PSXTYP=TRANI(17),PSXTDIV=TRANI(2)
"RTN","PSXRTRAN",95,0)
 S ORD=$G(PSXORD("A")) D TXT
"RTN","PSXRTRAN",96,0)
 S:$G(PSXORD("B",1))="" PSXORD("B",1)="NTE|2||"
"RTN","PSXRTRAN",97,0)
 S:$G(PSXORD("C",1))="" PSXORD("C",1)="NTE|3||"
"RTN","PSXRTRAN",98,0)
 S:$G(PSXORD("D",1))="" PSXORD("D",1)="NTE|4||"
"RTN","PSXRTRAN",99,0)
 F ZZ="B","C","D" S Z=0 F  S Z=$O(PSXORD(ZZ,Z)) Q:Z'>0  S ORD=$G(PSXORD(ZZ,Z)) D TXT
"RTN","PSXRTRAN",100,0)
MSG ;Get patient order data
"RTN","PSXRTRAN",101,0)
 S (LMSG,MSG)=0
"RTN","PSXRTRAN",102,0)
 F  S MSG=$O(^PSX(550.1,"C",PSXBAT,MSG)) Q:MSG'>0  S:$G(MCT)'>0 MCT=MSG S LMSG=MSG,PSXMSGCT=PSXMSGCT+1,LNTX=+$P(^PSX(550.1,MSG,"T",0),U,4) D
"RTN","PSXRTRAN",103,0)
 .S ORD="$MSG^"_+$G(^PSX(550.1,MSG,0))_U_LNTX D TXT
"RTN","PSXRTRAN",104,0)
 .F PSX=1:1:LNTX I $G(^PSX(550.1,MSG,"T",PSX,0))]"" S ORD=$G(^(0)) S:$E(ORD,1,7)="ORC|NW|" PSXRXCT=PSXRXCT+1 D TXT
"RTN","PSXRTRAN",105,0)
 .S DA=MSG,DIE="^PSX(550.1,",DR="1///2;5////"_$H_";3////"_PSXBAT D ^DIE K DIE,DA,DR
"RTN","PSXRTRAN",106,0)
 .S REC=MSG,PSXRTRN=1 ;D SUSPS^PSXRXU
"RTN","PSXRTRAN",107,0)
 S ORD="$$ENDRMIT^"_U_U_PSXBATNM_U_PSXMSGCT_U_PSXRXCT D TXT K ORD
"RTN","PSXRTRAN",108,0)
 S ^XMB(3.9,XMZ,2,0)="^3.92A^"_LCNT_U_LCNT_U_DT,XMDUN="CMOP Manager"
"RTN","PSXRTRAN",109,0)
 S XMDUZ=.5
"RTN","PSXRTRAN",110,0)
 S RECV=$P($G(^PSX(550,+PSXSYS,0)),U,4),DOMAIN="@"_$$GET1^DIQ(4.2,RECV,.01)
"RTN","PSXRTRAN",111,0)
 ;code to divert patient transmissions for testing
"RTN","PSXRTRAN",112,0)
 I '$D(^XTMP("PSXDIVERTCMOP")) S XMY("S.PSXX CMOP SERVER"_DOMAIN)="" I 1 ;****TESTING
"RTN","PSXRTRAN",113,0)
 E  S XX=^XTMP("PSXDIVERTCMOP",1) S XMY(XX)="" H 1 ;****TESTING S.PSXX
"RTN","PSXRTRAN",114,0)
 D ENT1^XMD
"RTN","PSXRTRAN",115,0)
 K DIE,DA,DR,BAT,PSX,PSXORD
"RTN","PSXRTRAN",116,0)
FILE L +^PSX(550.2,PSXBAT):30 G:'$T FILE
"RTN","PSXRTRAN",117,0)
 D NOW^%DTC S PSXTRDTM=%
"RTN","PSXRTRAN",118,0)
 S PSXLAST=LMSG,PSXFRST=MCT,DA=PSXBAT,DIE="^PSX(550.2,"
"RTN","PSXRTRAN",119,0)
 S DR="1////2;9////"_OLDBAT_";11////"_PSXFRST_";12////"_PSXLAST_";13////"_PSXMSGCT_";14////"_PSXRXCT_";5////"_PSXTRDTM D ^DIE
"RTN","PSXRTRAN",120,0)
 L -^PSX(550.2,PSXBAT) K DA,DIE
"RTN","PSXRTRAN",121,0)
F1 L +^PSX(550.2,OLDBAT):30 G:'$T F1
"RTN","PSXRTRAN",122,0)
 S DA=OLDBAT,DIE="^PSX(550.2,",DR="1////5;8////"_PSXBAT D ^DIE
"RTN","PSXRTRAN",123,0)
 L -^PSX(550.2,OLDBAT) K DA,DIE
"RTN","PSXRTRAN",124,0)
 S PSXOLD=OLDBAT
"RTN","PSXRTRAN",125,0)
 D AFTER1^PSXRSYU ;set PSXBAT into 550
"RTN","PSXRTRAN",126,0)
 S PSXFLAG=1,PSXRTRN=1
"RTN","PSXRTRAN",127,0)
 D EN^PSXNOTE
"RTN","PSXRTRAN",128,0)
 S OLDBAT=PSXOLD
"RTN","PSXRTRAN",129,0)
 D START^PSXRXU ;update RXs in 52.5 & 52
"RTN","PSXRTRAN",130,0)
 D OERRCLR^PSXRSUS
"RTN","PSXRTRAN",131,0)
 S OLDBAT=PSXOLD
"RTN","PSXRTRAN",132,0)
 D SETSTAT^PSXRTRA1
"RTN","PSXRTRAN",133,0)
 D REPORT^PSXRTRA1
"RTN","PSXRTRAN",134,0)
RESET S PSXSTAT="H" D PSXSTAT^PSXRSYU
"RTN","PSXRTRAN",135,0)
 G EXIT
"RTN","PSXRTRAN",136,0)
 Q
"RTN","PSXRTRAN",137,0)
NO W !,"You are not authorized to use this option!" Q
"RTN","PSXRTRAN",138,0)
EXIT S ZTREQ="@"
"RTN","PSXRTRAN",139,0)
 L -^PSX(550.1)
"RTN","PSXRTRAN",140,0)
 K PSXSTART,PSXEND,PSXRXCT,PSXMSGCT,PSXLAST,PSXSITE,PSXTDT,LASTBAT,LCNT,CNTX,MSG,REC,SITENUM,XQAMSG,XX,XMY,XMSUB,XMFROM,XMZ,XMDUZ,XMDUN,LNCT,OLDBAT,PSXMFLAG,FLAG,PSXSENDR,BMSG,EMSG,RECV,DOMAIN,CLOSED,PSXDIV,XSITE
"RTN","PSXRTRAN",141,0)
 K %,DIV,LNTX,SNDR,STATUS,TRNDT,Z,ZZ,PSXHDR,PSXJOB,PSXRTRN,PSXSTAT,PSXFRST,PSXBAT,PSXDUZ,PSXFLAG,DIR,Y,X,OLDSDT,S1,Y,DIRUT,DIROUT,DTOUT,DUOUT,BAD,MCT,LMSG,PSXOLD,PSXRXD
"RTN","PSXRTRAN",142,0)
 K ^PSX("CMOP TRANS"),PSXBATNM,OLDBATNM,TRAN,TRANI,PSXTRDTM,I
"RTN","PSXRTRAN",143,0)
 K ^TMP($J)
"RTN","PSXRTRAN",144,0)
 Q
"RTN","PSXRTRAN",145,0)
CANMSG ; lock on 550.1 not achieved send transmission cancelled message
"RTN","PSXRTRAN",146,0)
 D CANMSG^PSXRTRA1
"RTN","PSXRTRAN",147,0)
 Q
"RTN","PSXRTRAN",148,0)
TESTREL(RXDA,FILL) ; test release date, gather RX data, store for report
"RTN","PSXRTRAN",149,0)
 ;returns SENT, "FILL '=", or Released Date
"RTN","PSXRTRAN",150,0)
 N DFN,VADM,SSN,RELDT,RELDTE,PATNM,REPLY,FILLX
"RTN","PSXRTRAN",151,0)
 S DFN=$$GET1^DIQ(52,RXDA,2,"I"),PATNM=$$GET1^DIQ(52,RXDA,2)
"RTN","PSXRTRAN",152,0)
 D DEM^VADPT S SSN=$P(VADM(2),U,2)
"RTN","PSXRTRAN",153,0)
 S RXNM=$P(^PSRX(RXDA,0),U)_"-"_FILL
"RTN","PSXRTRAN",154,0)
 I FILL=0 S RELDT=$P(^PSRX(RXDA,2),U,13)\1 I 1
"RTN","PSXRTRAN",155,0)
 E  S RELDT=$P(^PSRX(RXDA,1,FILL,0),U,18)\1
"RTN","PSXRTRAN",156,0)
 S REPLY="SENT"
"RTN","PSXRTRAN",157,0)
 S:RELDT REPLY=$$FMTE^XLFDT(RELDT)
"RTN","PSXRTRAN",158,0)
 S FILLX=+$O(^PSRX(RXDA,1,"A"),-1) I FILL'=FILLX S REPLY="Fill '= "_FILLX
"RTN","PSXRTRAN",159,0)
 Q REPLY
"RTN","PSXRTRAN",160,0)
NOTRAN ;no RXs passed testing to go into a new transmission
"RTN","PSXRTRAN",161,0)
 S XMSUB="Retransmission of "_OLDBATNM_" failed"
"RTN","PSXRTRAN",162,0)
 K TXT,XMY
"RTN","PSXRTRAN",163,0)
 S TXT(1,0)="No prescriptions passed testing to go into a new transmission"
"RTN","PSXRTRAN",164,0)
 S XMTEXT="TXT("
"RTN","PSXRTRAN",165,0)
 D GRP^PSXNOTE
"RTN","PSXRTRAN",166,0)
 D ^XMD
"RTN","PSXRTRAN",167,0)
 Q
"RTN","PSXRTRAN",168,0)
SDT ;functional code as to SDT^PSXRPPL test and set individual RXs into 550.2
"RTN","PSXRTRAN",169,0)
 N SDT
"RTN","PSXRTRAN",170,0)
 S REC=$O(^PS(52.5,"B",RXDA,0)) Q:'REC
"RTN","PSXRTRAN",171,0)
 S XX=^PS(52.5,REC,0),SDT=$P(XX,U,2)
"RTN","PSXRTRAN",172,0)
 S XDFN=DFN
"RTN","PSXRTRAN",173,0)
 N RXN,RXDA,FILL
"RTN","PSXRTRAN",174,0)
 D GETDATA^PSXRPPL ;if RX is OK makes entry into new batch PSXBAT
"RTN","PSXRTRAN",175,0)
 D:$G(RXN) PSOUL^PSSLOCK(RXN),OERRLOCK^PSXRPPL(RXN)
"RTN","PSXRTRAN",176,0)
 Q
"VER")
8.0^22.0
**END**
**END**
