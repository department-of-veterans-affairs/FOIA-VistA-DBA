Released XU*8*145 SEQ #129
Extracted from mail message
**KIDS**:XU*8.0*145^

**INSTALL NAME**
XU*8.0*145
"BLD",268,0)
XU*8.0*145^KERNEL^0^3000327^y
"BLD",268,4,0)
^9.64PA^^
"BLD",268,"ABPKG")
n
"BLD",268,"KRN",0)
^9.67PA^19^17
"BLD",268,"KRN",.4,0)
.4
"BLD",268,"KRN",.401,0)
.401
"BLD",268,"KRN",.402,0)
.402
"BLD",268,"KRN",.403,0)
.403
"BLD",268,"KRN",.5,0)
.5
"BLD",268,"KRN",.84,0)
.84
"BLD",268,"KRN",3.6,0)
3.6
"BLD",268,"KRN",3.8,0)
3.8
"BLD",268,"KRN",9.2,0)
9.2
"BLD",268,"KRN",9.8,0)
9.8
"BLD",268,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",268,"KRN",9.8,"NM",1,0)
XPDI^^0^B38432074
"BLD",268,"KRN",9.8,"NM",2,0)
XPDIA^^0^B54051187
"BLD",268,"KRN",9.8,"NM","B","XPDI",1)

"BLD",268,"KRN",9.8,"NM","B","XPDIA",2)

"BLD",268,"KRN",19,0)
19
"BLD",268,"KRN",19,"NM",0)
^9.68A^^
"BLD",268,"KRN",19.1,0)
19.1
"BLD",268,"KRN",101,0)
101
"BLD",268,"KRN",409.61,0)
409.61
"BLD",268,"KRN",771,0)
771
"BLD",268,"KRN",870,0)
870
"BLD",268,"KRN",8994,0)
8994
"BLD",268,"KRN","B",.4,.4)

"BLD",268,"KRN","B",.401,.401)

"BLD",268,"KRN","B",.402,.402)

"BLD",268,"KRN","B",.403,.403)

"BLD",268,"KRN","B",.5,.5)

"BLD",268,"KRN","B",.84,.84)

"BLD",268,"KRN","B",3.6,3.6)

"BLD",268,"KRN","B",3.8,3.8)

"BLD",268,"KRN","B",9.2,9.2)

"BLD",268,"KRN","B",9.8,9.8)

"BLD",268,"KRN","B",19,19)

"BLD",268,"KRN","B",19.1,19.1)

"BLD",268,"KRN","B",101,101)

"BLD",268,"KRN","B",409.61,409.61)

"BLD",268,"KRN","B",771,771)

"BLD",268,"KRN","B",870,870)

"BLD",268,"KRN","B",8994,8994)

"BLD",268,"QUES",0)
^9.62^^
"BLD",268,"REQB",0)
^9.611^1^1
"BLD",268,"REQB",1,0)
XU*8.0*131^1
"BLD",268,"REQB","B","XU*8.0*131",1)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
145^3000327
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","XPDI")
0^1^B38432074
"RTN","XPDI",1,0)
XPDI ;SFISC/RSD - Install Process ;03/14/2000  09:19
"RTN","XPDI",2,0)
 ;;8.0;KERNEL;**10,21,39,41,44,58,68,108,145**;Jul 10, 1995
"RTN","XPDI",3,0)
EN ;install
"RTN","XPDI",4,0)
 N DIR,DIRUT,POP,XPD,XPDA,XPDD,XPDIJ,XPDDIQ,XPDIT,XPDIABT,XPDNM,XPDNOQUE,XPDPKG,XPDREQAB,XPDST,XPDSET,XPDSET1,XPDT,XPDQUIT,XPDQUES,Y,ZTSK,%
"RTN","XPDI",5,0)
 S %="I '$P(^(0),U,9),$D(^XPD(9.7,""ASP"",Y,1,Y)),$D(^XTMP(""XPDI"",Y))",XPDST=$$LOOK^XPDI1(%)
"RTN","XPDI",6,0)
 Q:'XPDST!$D(XPDQUIT)
"RTN","XPDI",7,0)
 S XPDIT=0,(XPDSET,XPDSET1)=$P(^XPD(9.7,XPDST,0),U) K ^TMP($J)
"RTN","XPDI",8,0)
 ;Check each part of XPDT array
"RTN","XPDI",9,0)
 F  S XPDIT=$O(XPDT(XPDIT)) Q:'XPDIT  D  Q:'$D(XPDT)!$D(XPDQUIT)
"RTN","XPDI",10,0)
 .S XPDA=+XPDT(XPDIT),XPDNM=$P(XPDT(XPDIT),U,2),XPDPKG=+$P($G(^XPD(9.7,+XPDT(XPDIT),0)),U,2),%=$P(^(0),U,5)
"RTN","XPDI",11,0)
 .W !,"Checking Install for Package ",XPDNM
"RTN","XPDI",12,0)
 .;check that Install file was created correctly
"RTN","XPDI",13,0)
 .I '$D(^XPD(9.7,XPDA,"INI"))!'$D(^("INIT")) W !,"**INSTALL FILE IS CORRUPTED**",!,*7 S XPDQUIT=1 Q
"RTN","XPDI",14,0)
 .;run enviroment check routine
"RTN","XPDI",15,0)
 .;XPDREQAB req. build missing, =2 global killed
"RTN","XPDI",16,0)
 .I $$ENV^XPDIL1(1) S:$G(XPDREQAB)=2 XPDQUIT=1 Q
"RTN","XPDI",17,0)
 .;save variables that are setup in environ. chck. routine
"RTN","XPDI",18,0)
 .I $D(XPDNOQUE)!$D(XPDDIQ) D
"RTN","XPDI",19,0)
 ..S:$D(XPDNOQUE) ^XTMP("XPDI",XPDA,"ENVVAR","XPDNOQUE")=XPDNOQUE
"RTN","XPDI",20,0)
 ..I $D(XPDDIQ) M ^XTMP("XPDI",XPDA,"ENVVAR","XPDDIQ")=XPDDIQ
"RTN","XPDI",21,0)
 .D QUES^XPDI1(XPDA) Q:'$D(XPDT(+XPDIT))!$D(XPDQUIT)
"RTN","XPDI",22,0)
 .;XPDIJ=XPDA if XPDIJ routine is part of Build
"RTN","XPDI",23,0)
 .S:$D(^XTMP("XPDI",XPDA,"RTN","XPDIJ")) XPDIJ=XPDA
"RTN","XPDI",24,0)
 .D XQSET^XPDI1(XPDA)
"RTN","XPDI",25,0)
 ;NONE = no Build to install
"RTN","XPDI",26,0)
 G NONE:'$O(XPDT(""))!$D(XPDQUIT)!($G(XPDREQAB))
"RTN","XPDI",27,0)
 ;check that we have all Builds to install
"RTN","XPDI",28,0)
 S XPDA=XPDST,XPDNM=XPDSET,Y=0
"RTN","XPDI",29,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S %=+$O(^(Y,0)) I '$D(XPDT("DA",%)) G NONE
"RTN","XPDI",30,0)
 W !
"RTN","XPDI",31,0)
 ;See if a Master Build
"RTN","XPDI",32,0)
 S %=$O(^XTMP("XPDI",XPDA,"BLD",0)),%=$P(^(%,0),U,3) S:%=1 XPDT("MASTER")=XPDA
"RTN","XPDI",33,0)
 ;Inhibit Logon Question
"RTN","XPDI",34,0)
 D DIR^XPDIQ("XPI") I $D(DIRUT) D ABRTALL(2) Q
"RTN","XPDI",35,0)
 ;disable options question
"RTN","XPDI",36,0)
 D DIR^XPDIQ("XPZ") I $D(DIRUT) D ABRTALL(2) Q
"RTN","XPDI",37,0)
 ;XPDSET=set name,(also build name), of options that will be disabled
"RTN","XPDI",38,0)
 ;XPDSET1=setname or null if they don't want to disable
"RTN","XPDI",39,0)
 D  I XPDSET1="^" D ABRTALL(2) Q
"RTN","XPDI",40,0)
 .;if they say no, set XPDET1=""
"RTN","XPDI",41,0)
 .S:'$G(XPDQUES("XPZ1")) XPDSET1="",Y=0
"RTN","XPDI",42,0)
 .S ^XTMP("XQOO",XPDSET,0)=XPDSET_" is being installed by KIDS^"_DT_U_DUZ
"RTN","XPDI",43,0)
 .I XPDSET1]"" D  Q:XPDSET1="^"!(XPDSET1="")
"RTN","XPDI",44,0)
 ..;merge the options/protocols that were put in ^TMP($J,"XQOO",build name)
"RTN","XPDI",45,0)
 ..M ^XTMP("XQOO",XPDSET)=^TMP($J,"XQOO",XPDSET)
"RTN","XPDI",46,0)
 ..D INIT^XQOO(.XPDSET1) Q:"^"[XPDSET1
"RTN","XPDI",47,0)
 ..N DIR S DIR(0)="N^0:60:0",DIR("B")=0
"RTN","XPDI",48,0)
 ..S DIR("A")="Delay Install (Minutes)",DIR("?")="Enter the number of minutes to delay the installing of Routines after the Disable of Options"
"RTN","XPDI",49,0)
 ..W ! D ^DIR I $D(DIRUT) S XPDSET1="^"
"RTN","XPDI",50,0)
 .;Y is set in the call to DIR in previous .DO
"RTN","XPDI",51,0)
 .;save setname into first Build and the Delay in minutes, Y
"RTN","XPDI",52,0)
 .K XPD S XPD(9.7,XPDST_",",7)=(XPDSET1]"")_XPDSET,XPD(9.7,XPDST_",",8)=Y
"RTN","XPDI",53,0)
 .D FILE^DIE("","XPD")
"RTN","XPDI",54,0)
 ;check if they want to update other CPUs
"RTN","XPDI",55,0)
 I $G(XPDQUES("XPZ2")) D  I $D(DIRUT) D ABRTALL(2) Q
"RTN","XPDI",56,0)
 .N DA,DIE,DIR,DR,I,XPD,X,Y,Z
"RTN","XPDI",57,0)
 .;if they haven't already added Volume Sets, populate the mulitple
"RTN","XPDI",58,0)
 .I '$O(^XPD(9.7,XPDA,"VOL",0)) D  I $D(XPD) D UPDATE^DIE("","XPD")
"RTN","XPDI",59,0)
 ..X ^%ZOSF("UCI") S Y=$P(Y,",",2),(I,Z)=0
"RTN","XPDI",60,0)
 ..F  S I=$O(^%ZIS(14.5,I)) Q:'I  S X=$G(^(I,0)) S:$P(X,U)]""&$P(X,U,11)&($P(X,U)'=Y) Z=Z+1,XPD(9.703,"+"_Z_","_XPDA_",",.01)=$P(X,U)
"RTN","XPDI",61,0)
 .W !!,"I will Update the following VOLUME SETS:",!
"RTN","XPDI",62,0)
 .S I=0 F  S I=$O(^XPD(9.7,XPDA,"VOL",I)) Q:'I  W ?3,$P(^(I,0),U),!
"RTN","XPDI",63,0)
 .W ! S DIR(0)="Y",DIR("A")="Want to edit this list",DIR("B")="NO"
"RTN","XPDI",64,0)
 .D ^DIR Q:$D(DIRUT)  D:Y
"RTN","XPDI",65,0)
 ..S DA=XPDA,DIE="^XPD(9.7,",DR=30,DR(2,9.703)=".01"
"RTN","XPDI",66,0)
 ..D ^DIE
"RTN","XPDI",67,0)
 .I '$O(^XPD(9.7,XPDA,"VOL",0)) W !!,"No VOLUME SETS selected!!" Q
"RTN","XPDI",68,0)
 .Q:$$TM^%ZTLOAD  ;quit if Taskman is running
"RTN","XPDI",69,0)
 .W !!,"TASKMAN is not running. If you install now, you must run the routine XPDCPU",!,"in the production UCI for each of the VOLUME SETS you have listed once"
"RTN","XPDI",70,0)
 .W !,"the installation starts!!",!,"If you Queue the install, the VOLUME SETS will be updated automatically.",*7,*7,!!
"RTN","XPDI",71,0)
DEV S POP=0 S:'$D(^DD(3.5,0)) POP=1
"RTN","XPDI",72,0)
 ;check if home device is defined
"RTN","XPDI",73,0)
 I 'POP S IOP="",%ZIS=0 D ^%ZIS
"RTN","XPDI",74,0)
 ;Kernel Virgin Install
"RTN","XPDI",75,0)
 I POP S XPDA=XPDST D:$G(XPDIJ) XPDIJ^XPDI1 G EN^XPDIJ
"RTN","XPDI",76,0)
 ;set XPDA=starting Build, ask for device for messages
"RTN","XPDI",77,0)
 ;XPDNOQUE is defined means don't let them queue output
"RTN","XPDI",78,0)
 W !!,"Enter the Device you want to print the Install messages."
"RTN","XPDI",79,0)
 W:'$D(XPDNOQUE) !,"You can queue the install by enter a 'Q' at the device prompt."
"RTN","XPDI",80,0)
 W !,"Enter a '^' to abort the install.",!
"RTN","XPDI",81,0)
 S XPDA=XPDST,%ZIS=$P("Q",U,'$D(XPDNOQUE))
"RTN","XPDI",82,0)
 D ^%ZIS G:POP ASKABRT
"RTN","XPDI",83,0)
 ;reset expiration date to T+7 on transport global
"RTN","XPDI",84,0)
 S XPDD=$$FMADD^XLFDT(DT,7),^XTMP("XPDI",0)=XPDD_U_DT
"RTN","XPDI",85,0)
 I $D(IO("Q")) D  G ASKABRT:$D(ZTSK)[0 D XPDIJ^XPDI1:$G(XPDIJ),QUIT^XPDI1(XPDST) Q
"RTN","XPDI",86,0)
 . N DIR
"RTN","XPDI",87,0)
 . S DIR(0)="DA^"_DT_":"_XPDD_":AEFRSX"
"RTN","XPDI",88,0)
 . S DIR("A")="Request Start Time: "
"RTN","XPDI",89,0)
 . S DIR("B")="NOW"
"RTN","XPDI",90,0)
 . S DIR("?")="Enter a Date including Timestamp not to exceed 7 days in the future."
"RTN","XPDI",91,0)
 . D ^DIR
"RTN","XPDI",92,0)
 .Q:$D(DIRUT)
"RTN","XPDI",93,0)
 .S ZTDTH=Y,ZTRTN="EN^XPDIJ",ZTDESC="KIDS install",ZTSAVE("XPDA")=""
"RTN","XPDI",94,0)
 .D ^%ZTLOAD,HOME^%ZIS K IO("Q")
"RTN","XPDI",95,0)
 .Q:$D(ZTSK)[0
"RTN","XPDI",96,0)
 .W !,"Install Queued!",!!
"RTN","XPDI",97,0)
 .;save task into first Build
"RTN","XPDI",98,0)
 .K XPD S XPD(9.7,XPDST_",",5)=ZTSK,XPDIT=0
"RTN","XPDI",99,0)
 .F  S XPDIT=$O(XPDT(XPDIT)) Q:'XPDIT  S XPD(9.7,+XPDT(XPDIT)_",",.02)=1 D FILE^DIE("","XPD") K XPD
"RTN","XPDI",100,0)
 ;run install
"RTN","XPDI",101,0)
 U IO D XPDIJ^XPDI1:$G(XPDIJ),QUIT^XPDI1(XPDST) G EN^XPDIJ
"RTN","XPDI",102,0)
 Q
"RTN","XPDI",103,0)
 ;
"RTN","XPDI",104,0)
 ;XPDA=ien to del, XPDK=1 kill global, XPDALL=1 deleting all
"RTN","XPDI",105,0)
 ;XPDST=starting package.
"RTN","XPDI",106,0)
ABORT(XPDA,XPDK,XPDALL) ;abort install of Build XPDA
"RTN","XPDI",107,0)
 N %,DA,DIK,XPDJ,XPDNM,Y
"RTN","XPDI",108,0)
 Q:'$D(^XPD(9.7,XPDA,0))  S XPDNM=$P(^(0),U)
"RTN","XPDI",109,0)
 D BMES^XPDUTL(XPDNM_" Build will not be installed"_$S(XPDK=1:", Transport Global deleted!",1:""))
"RTN","XPDI",110,0)
 S DIK="^XPD(9.7,",XPDJ=XPDT("NM",XPDNM),DA=XPDA
"RTN","XPDI",111,0)
 ;kill XPDT array, but don't kill global if XPDK=2
"RTN","XPDI",112,0)
 K XPDT("NM",XPDNM),XPDT("DA",XPDA),XPDT(XPDJ),XPDT("GP") Q:XPDK=2
"RTN","XPDI",113,0)
 K ^XTMP("XPDI",XPDA)
"RTN","XPDI",114,0)
 ;if we are not deleting all packages and we are deleting the starting package
"RTN","XPDI",115,0)
 ;set the next package to the starting package. It must always be 1.
"RTN","XPDI",116,0)
 I '$G(XPDALL),XPDA=XPDST S Y=$O(XPDT(0)) D:Y
"RTN","XPDI",117,0)
 .;unlock starting install
"RTN","XPDI",118,0)
 .L -^XPD(9.7,XPDST)
"RTN","XPDI",119,0)
 .S XPDST=+XPDT(Y),XPDT(1)=XPDT(Y),XPDT("DA",XPDST)=1,XPDT("NM",$P(XPDT(Y),U,2))=1,XPDIT=0
"RTN","XPDI",120,0)
 .K XPDT(Y) N XPD
"RTN","XPDI",121,0)
 .S %="XPD(9.7,"""_XPDST_","")",@%@(3)=XPDST,@%@(4)=1
"RTN","XPDI",122,0)
 .;loop thru the rest of the packages and reset the starting package field
"RTN","XPDI",123,0)
 .F  S Y=$O(XPDT(Y)) Q:'Y  D
"RTN","XPDI",124,0)
 ..S XPD(9.7,+XPDT(Y)_",",3)=XPDST
"RTN","XPDI",125,0)
 .D FILE^DIE("","XPD")
"RTN","XPDI",126,0)
 D ^DIK
"RTN","XPDI",127,0)
 Q
"RTN","XPDI",128,0)
ASKABRT ;ask if want to unload distribution
"RTN","XPDI",129,0)
 N DIR,DIRUT,X,Y
"RTN","XPDI",130,0)
 S XPDQUIT=1,DIR(0)="Y",DIR("A")="Install ABORTED, Want to remove the Transport Globals",DIR("B")="YES"
"RTN","XPDI",131,0)
 W ! D ^DIR I Y D ABRTALL(1) Q
"RTN","XPDI",132,0)
 L -^XPD(9.7,XPDST)
"RTN","XPDI",133,0)
 Q
"RTN","XPDI",134,0)
ABRTALL(XPDK) ;abort all Builds
"RTN","XPDI",135,0)
 N XPDA
"RTN","XPDI",136,0)
 S XPDT=0
"RTN","XPDI",137,0)
 F  S XPDT=$O(XPDT(XPDT)) Q:'XPDT  S XPDA=+XPDT(XPDT) D ABORT(XPDA,XPDK,1)
"RTN","XPDI",138,0)
 ;unlock starting install
"RTN","XPDI",139,0)
 L -^XPD(9.7,XPDST)
"RTN","XPDI",140,0)
 Q
"RTN","XPDI",141,0)
NONE W !!,"**NOTHING INSTALLED**",!
"RTN","XPDI",142,0)
 Q
"RTN","XPDIA")
0^2^B54051187
"RTN","XPDIA",1,0)
XPDIA ;SFISC/RSD - Install Pre/Post Actions for Kernel Files ;03/27/2000  12:58
"RTN","XPDIA",2,0)
 ;;8.0;KERNEL;**10,15,21,28,44,58,68,131,145**;Jul 10, 1995
"RTN","XPDIA",3,0)
 Q
"RTN","XPDIA",4,0)
OPTF1 ;options file pre
"RTN","XPDIA",5,0)
 K ^TMP($J,"XPD")
"RTN","XPDIA",6,0)
 Q
"RTN","XPDIA",7,0)
OPTE1 ;options entry pre
"RTN","XPDIA",8,0)
 N %,I
"RTN","XPDIA",9,0)
 ;XPDFL= 0-send,1-delete,2-link,3-merge,4-attach,5-disable
"RTN","XPDIA",10,0)
 ;attach & disable never get here
"RTN","XPDIA",11,0)
 S ^TMP($J,"XPD",DA)=XPDFL
"RTN","XPDIA",12,0)
 ;if Menu linking or merge save menu mult. and process in FPOS code
"RTN","XPDIA",13,0)
 I XPDFL>1 M ^TMP($J,"XPD",DA,10)=^XTMP("XPDI",XPDA,"KRN",19,OLDA,10) K ^XTMP("XPDI",XPDA,"KRN",19,OLDA,10)
"RTN","XPDIA",14,0)
 ;if Menu link, XPDQUIT prevents data merge
"RTN","XPDIA",15,0)
 I XPDFL=2 S XPDQUIT=1 Q
"RTN","XPDIA",16,0)
 ;if this is new to the site then disable and quit
"RTN","XPDIA",17,0)
 I $G(XPDNEW) D:XPDSET  Q
"RTN","XPDIA",18,0)
 .;quit if option already has out of order msg.
"RTN","XPDIA",19,0)
 .Q:$P(^XTMP("XPDI",XPDA,"KRN",19,OLDA,0),U,3)]""
"RTN","XPDIA",20,0)
 .S $P(^XTMP("XPDI",XPDA,"KRN",19,OLDA,0),U,3)=$P(XPDSET,U,3)
"RTN","XPDIA",21,0)
 .D ADD^XQOO1($P(XPDSET,U,2),19,DA)
"RTN","XPDIA",22,0)
 S I=^XTMP("XPDI",XPDA,"KRN",19,OLDA,0),%=^DIC(19,DA,0)
"RTN","XPDIA",23,0)
 ;$P(%,U,3)=out of order message, keep sending ooo msg
"RTN","XPDIA",24,0)
 S:$P(I,U,3)="" $P(I,U,3)=$P(%,U,3)
"RTN","XPDIA",25,0)
 ;if there is no new Security Key, save the old Key
"RTN","XPDIA",26,0)
 S:$P(I,U,6)="" $P(I,U,6)=$P(%,U,6)
"RTN","XPDIA",27,0)
 ;if there is no reverse key, save the old key and flag
"RTN","XPDIA",28,0)
 I $P($G(^XTMP("XPDI",XPDA,"KRN",19,OLDA,3)),U)="",$L($P($G(^DIC(19,DA,3)),U)) S $P(I,U,16)=$P(%,U,16),$P(^XTMP("XPDI",XPDA,"KRN",19,OLDA,3),U)=$P(^(3),U)
"RTN","XPDIA",29,0)
 S ^XTMP("XPDI",XPDA,"KRN",19,OLDA,0)=I
"RTN","XPDIA",30,0)
 ;if there is a new Description, kill the old Description
"RTN","XPDIA",31,0)
 K:$O(^XTMP("XPDI",XPDA,"KRN",19,OLDA,1,0)) ^DIC(19,DA,1)
"RTN","XPDIA",32,0)
 ;kill old RCPs (RPC)
"RTN","XPDIA",33,0)
 K ^DIC(19,DA,"RPC")
"RTN","XPDIA",34,0)
 ;if Menu Text, (U;1) is different, kill C x-ref
"RTN","XPDIA",35,0)
 S I=$G(^DIC(19,DA,"U")) I I]"",I'=$G(^XTMP("XPDI",XPDA,"KRN",19,OLDA,"U")) K ^DIC(19,"C",I)
"RTN","XPDIA",36,0)
 S I=0
"RTN","XPDIA",37,0)
 ;XPDFL=3-merge menu items, Quit
"RTN","XPDIA",38,0)
 ;the new menu items have already been saved into ^TMP, will restore in
"RTN","XPDIA",39,0)
 ;the file post action as a relink
"RTN","XPDIA",40,0)
 Q:XPDFL=3
"RTN","XPDIA",41,0)
 ;we are replacing menu items, kill the old.
"RTN","XPDIA",42,0)
 ;loop thru and kill "AD" x-ref., it will be reset with new options
"RTN","XPDIA",43,0)
 F  S I=$O(^DIC(19,DA,10,I)) Q:'I  S %=+$G(^(I,0)) K:% ^DIC(19,"AD",%,DA,I)
"RTN","XPDIA",44,0)
 ;kill Menus (10)
"RTN","XPDIA",45,0)
 K ^DIC(19,DA,10)
"RTN","XPDIA",46,0)
 Q
"RTN","XPDIA",47,0)
OPTF2 ;options file post
"RTN","XPDIA",48,0)
 N ACT,DA,DIK,I,X,Y,Y0
"RTN","XPDIA",49,0)
 ;loop thru all the new incomming options
"RTN","XPDIA",50,0)
 S DA=0,DIK=DIC F  S DA=$O(^TMP($J,"XPD",DA)) Q:'DA  S ACT=^(DA) D
"RTN","XPDIA",51,0)
 .;if use as link then goto OPTFL, just update menus
"RTN","XPDIA",52,0)
 .G:ACT=2 OPTFL
"RTN","XPDIA",53,0)
 .;repoint Bulletin (220;1) and Mail Group (220;3)
"RTN","XPDIA",54,0)
 .S Y0=$G(^DIC(19,DA,220)) I Y0]"" S $P(Y0,U)=$$LK("^XMB(3.6)",$P(Y0,U)),$P(Y0,U,3)=$$LK("^XMB(3.8)",$P(Y0,U,3)),^DIC(19,DA,220)=Y0
"RTN","XPDIA",55,0)
 .;repoint RPC (RPC;1)
"RTN","XPDIA",56,0)
 .S (I,X)=0 F  S I=$O(^DIC(19,DA,"RPC",I)) Q:'I  S Y0=$P($G(^(I,0)),U) D
"RTN","XPDIA",57,0)
 ..S Y=$$LK("^XWB(8994)",Y0)
"RTN","XPDIA",58,0)
 ..I 'Y K ^DIC(19,DA,"RPC",I) D BMES^XPDUTL(" RPC "_Y0_" in Option "_$P(^DIC(19,DA,0),U)_" **NOT FOUND**") Q
"RTN","XPDIA",59,0)
 ..S $P(^DIC(19,DA,"RPC",I,0),U)=Y,X=I_U_(X+1)
"RTN","XPDIA",60,0)
 .S:X $P(^DIC(19,DA,"RPC",0),U,3,4)=X
"RTN","XPDIA",61,0)
 .;repoint Package (0;12) and Help Frame (0;7)
"RTN","XPDIA",62,0)
 .S Y0=^DIC(19,DA,0),$P(Y0,U,12)=$$LK("^DIC(9.4)",$P(Y0,U,12)),$P(Y0,U,7)=$$LK("^DIC(9.2)",$P(Y0,U,7)),^DIC(19,DA,0)=Y0
"RTN","XPDIA",63,0)
OPTFL .;need to loop through ^TMP($J,"XPD",DA,10,I) these are menus that need to be
"RTN","XPDIA",64,0)
 .;merged, they could also be linked menu, but treat like merge
"RTN","XPDIA",65,0)
 .S I=0 F  S I=$O(^TMP($J,"XPD",DA,10,I)) Q:'I  S Y0=$G(^(I,0)),X=$G(^(U)) D:X]"" MENU(DA,X,Y0)
"RTN","XPDIA",66,0)
 .;loop thru Menu and repoint Option (0;1), text is on ^(U) node
"RTN","XPDIA",67,0)
 .;also need to recount all menus and reset zeroth node, use X
"RTN","XPDIA",68,0)
 .S (I,X)=0 F  S I=$O(^DIC(19,DA,10,I)) Q:'I  S Y0=$G(^(I,U)) D
"RTN","XPDIA",69,0)
 ..I $L(Y0) D  Q:'Y
"RTN","XPDIA",70,0)
 ...S Y=$$LK("^DIC(19)",Y0)
"RTN","XPDIA",71,0)
 ...K ^DIC(19,DA,10,I,U)
"RTN","XPDIA",72,0)
 ...I 'Y K ^DIC(19,DA,10,I) D BMES^XPDUTL(" Option "_Y0_" in Menu "_$P(^DIC(19,DA,0),U)_" **NOT FOUND**") Q
"RTN","XPDIA",73,0)
 ...S $P(^DIC(19,DA,10,I,0),U)=Y
"RTN","XPDIA",74,0)
 ..S X=I_U_(X+1)
"RTN","XPDIA",75,0)
 .S:X $P(^DIC(19,DA,10,0),U,3,4)=X
"RTN","XPDIA",76,0)
 .;re-index this option
"RTN","XPDIA",77,0)
 .D IX1^DIK
"RTN","XPDIA",78,0)
 K ^TMP($J,"XPD")
"RTN","XPDIA",79,0)
 Q
"RTN","XPDIA",80,0)
OPTDEL ;option delete
"RTN","XPDIA",81,0)
 D DEL("^DIC(19,",DUZ)
"RTN","XPDIA",82,0)
 D OPT^XPDIA2
"RTN","XPDIA",83,0)
 Q
"RTN","XPDIA",84,0)
PROF1 ;protocols file pre
"RTN","XPDIA",85,0)
 K ^TMP($J,"XPD")
"RTN","XPDIA",86,0)
 Q
"RTN","XPDIA",87,0)
PROE1 ;protocols entry pre
"RTN","XPDIA",88,0)
 G PROE1^XPDIA0
"RTN","XPDIA",89,0)
 ;
"RTN","XPDIA",90,0)
PROF2 ;protocols file post
"RTN","XPDIA",91,0)
 N ACT,DA,DIK,I,X,Y,Y0
"RTN","XPDIA",92,0)
 ;loop thru all the new incomming protocols
"RTN","XPDIA",93,0)
 S DA=0,DIK=DIC F  S DA=$O(^TMP($J,"XPD",DA)) Q:'DA  S ACT=^(DA) D
"RTN","XPDIA",94,0)
 .;if use as link then goto PROFL, just update menus
"RTN","XPDIA",95,0)
 .G:ACT=2 PROFL
"RTN","XPDIA",96,0)
 .;repoint Package (0;12)
"RTN","XPDIA",97,0)
 .S Y0=^ORD(101,DA,0) S:$L($P(Y0,U,12)) $P(Y0,U,12)=$$LK("^DIC(9.4)",$P(Y0,U,12)),^ORD(101,DA,0)=Y0
"RTN","XPDIA",98,0)
 .;repoint File Link (5;1), its a variable pointer
"RTN","XPDIA",99,0)
 .S Y0=$P($G(^ORD(101,DA,5)),U),Y=$P(Y0,";",2),Y0=$P(Y0,";")
"RTN","XPDIA",100,0)
 .I Y0,$L(Y) S Y0=$O(@("^"_Y_"""B"","""_Y0_""",0)")),$P(^ORD(101,DA,5),U)=$S(Y0:Y0_";"_Y,1:"")
"RTN","XPDIA",101,0)
 .;repoint HL7 fields, node 770
"RTN","XPDIA",102,0)
 .S Y0=$G(^ORD(101,DA,770)) I $L(Y0) D  S ^ORD(101,DA,770)=Y0
"RTN","XPDIA",103,0)
 ..S $P(Y0,U)=$$LK("^HL(771)",$P(Y0,U)),$P(Y0,U,2)=$$LK("^HL(771)",$P(Y0,U,2))
"RTN","XPDIA",104,0)
 ..S $P(Y0,U,3)=$$LK("^HL(771.2)",$P(Y0,U,3)),$P(Y0,U,11)=$$LK("^HL(771.2)",$P(Y0,U,11))
"RTN","XPDIA",105,0)
 ..S $P(Y0,U,4)=$$LK("^HL(779.001)",$P(Y0,U,4)),$P(Y0,U,7)=$$LK("^HLCS(870)",$P(Y0,U,7))
"RTN","XPDIA",106,0)
 ..S $P(Y0,U,8)=$$LK("^HL(779.003)",$P(Y0,U,8)),$P(Y0,U,9)=$$LK("^HL(779.003)",$P(Y0,U,9))
"RTN","XPDIA",107,0)
 ..S $P(Y0,U,10)=$$LK("^HL(771.5)",$P(Y0,U,10))
"RTN","XPDIA",108,0)
 .;loop thru Access and resolve (3;1), kill if it doesn't resolve
"RTN","XPDIA",109,0)
 .S (I,X)=0 F  S I=$O(^ORD(101,DA,3,I)) Q:'I  S Y0=$P($G(^(I,0)),U) D
"RTN","XPDIA",110,0)
 ..;Y0=.01 of Access(Security Key)
"RTN","XPDIA",111,0)
 ..S Y=$$LK("^DIC(19.1)",Y0)
"RTN","XPDIA",112,0)
 ..I 'Y K ^ORD(101,DA,3,I) D BMES^XPDUTL(" Key "_Y0_" in Protocol "_$P(^ORD(101,DA,0),U)_" **NOT FOUND**") Q
"RTN","XPDIA",113,0)
 ..S $P(^ORD(101,DA,3,I,0),U)=Y,X=I_U_(X+1)
"RTN","XPDIA",114,0)
 .S:X $P(^ORD(101,DA,3,0),U,3,4)=X
"RTN","XPDIA",115,0)
PROFL .;need to loop through ^TMP($J,"XPD",DA,10,I) these are menus that need to be
"RTN","XPDIA",116,0)
 .;merged, they are also linked menu, but treat like merge
"RTN","XPDIA",117,0)
 .S I=0 F  S I=$O(^TMP($J,"XPD",DA,10,I)) Q:'I  S Y0=$G(^(I,0)),X=$G(^(U)) D:X]"" MENU(DA,X,Y0)
"RTN","XPDIA",118,0)
 .;loop thru Menu and repoint Option (0;1), text is on ^(U) node
"RTN","XPDIA",119,0)
 .;also need to recount all menus and reset zeroth node, use X
"RTN","XPDIA",120,0)
 .S (I,X)=0 F  S I=$O(^ORD(101,DA,10,I)) Q:'I  S Y0=$G(^(I,U)) D
"RTN","XPDIA",121,0)
 ..I $L(Y0) D  Q:'Y
"RTN","XPDIA",122,0)
 ...S Y=$$LK("^ORD(101)",Y0)
"RTN","XPDIA",123,0)
 ...K ^ORD(101,DA,10,I,U)
"RTN","XPDIA",124,0)
 ...I 'Y K ^ORD(101,DA,10,I) D BMES^XPDUTL(" Protocol "_Y0_" in Protocol Menu "_$P(^ORD(101,DA,0),U)_" **NOT FOUND**") Q
"RTN","XPDIA",125,0)
 ...S $P(^ORD(101,DA,10,I,0),U)=Y
"RTN","XPDIA",126,0)
 ..S X=I_U_(X+1)
"RTN","XPDIA",127,0)
 .S:X $P(^ORD(101,DA,10,0),U,3,4)=X
"RTN","XPDIA",128,0)
 .;need to loop through ^TMP($J,"XPD",DA,775,I) these are subscribers that need to be
"RTN","XPDIA",129,0)
 .;merged, they are also linked subscriber, but treat like merge
"RTN","XPDIA",130,0)
 .S I=0 F  S I=$O(^TMP($J,"XPD",DA,775,I)) Q:'I  S Y0=$G(^(I,0)),X=$G(^(U)) D:X]"" SUBS(DA,X)
"RTN","XPDIA",131,0)
 .;loop thru subscriber and repoint Option (0;1), text is on ^(U) node
"RTN","XPDIA",132,0)
 .;also need to recount all menus and reset zeroth node, use X
"RTN","XPDIA",133,0)
 .S (I,X)=0 F  S I=$O(^ORD(101,DA,775,I)) Q:'I  S Y0=$G(^(I,U)) D
"RTN","XPDIA",134,0)
 ..I $L(Y0) D  Q:'Y
"RTN","XPDIA",135,0)
 ...S Y=$$LK("^ORD(101)",Y0)
"RTN","XPDIA",136,0)
 ...K ^ORD(101,DA,775,I,U)
"RTN","XPDIA",137,0)
 ...I 'Y K ^ORD(101,DA,775,I) D BMES^XPDUTL(" Protocol "_Y0_" in Protocol Subscriber "_$P(^ORD(101,DA,0),U)_" **NOT FOUND**") Q
"RTN","XPDIA",138,0)
 ...S $P(^ORD(101,DA,775,I,0),U)=Y
"RTN","XPDIA",139,0)
 ..S X=I_U_(X+1)
"RTN","XPDIA",140,0)
 .S:X $P(^ORD(101,DA,775,0),U,3,4)=X
"RTN","XPDIA",141,0)
 .;re-index this option
"RTN","XPDIA",142,0)
 .D IX1^DIK
"RTN","XPDIA",143,0)
 K ^TMP($J,"XPD")
"RTN","XPDIA",144,0)
 Q
"RTN","XPDIA",145,0)
PRODEL ;option delete
"RTN","XPDIA",146,0)
 D DEL("^ORD(101,",DUZ)
"RTN","XPDIA",147,0)
 D PRO^XPDIA2
"RTN","XPDIA",148,0)
 Q
"RTN","XPDIA",149,0)
LK(GR,X) ;lookup, GR=global root, X=lookup value
"RTN","XPDIA",150,0)
 Q:$G(X)="" ""
"RTN","XPDIA",151,0)
 N I S I=$O(@GR@("B",X,0))
"RTN","XPDIA",152,0)
 I I,$D(@GR@(I,0))#2 Q I
"RTN","XPDIA",153,0)
 Q ""
"RTN","XPDIA",154,0)
 ;
"RTN","XPDIA",155,0)
ADD(XPDSDD,XPDSDA,X) ;add to multiple, XPDSDD=sub DD#, XPDSDA=DA, X=value
"RTN","XPDIA",156,0)
 Q:$G(X)=""
"RTN","XPDIA",157,0)
 N XPD
"RTN","XPDIA",158,0)
 S XPD(XPDSDD,"?+1,"_XPDSDA_",",.01)=X
"RTN","XPDIA",159,0)
 D UPDATE^DIE("E","XPD")
"RTN","XPDIA",160,0)
 Q
"RTN","XPDIA",161,0)
 ;this is used to add menu items to an option or protocol
"RTN","XPDIA",162,0)
MENU(DA,X,X0) ;DA=ien of option/protocol, X=Menu item, X0=0 node of menu item
"RTN","XPDIA",163,0)
 N DIC,DLAYGO,DIK,D0,D1,I,Y,Y0
"RTN","XPDIA",164,0)
 S DIC=$S(XPDFIL=19:"^DIC(19,",1:"^ORD(101,")_DA_",10,",DIC(0)="L",DLAYGO=XPDFIL,(D0,DA(1))=DA
"RTN","XPDIA",165,0)
 S:'$D(@(DIC_"0)")) @(DIC_"0)")=U_$P(^DD(XPDFIL,10,0),U,2)
"RTN","XPDIA",166,0)
 S:$L($G(X0)) DIC("DR")="2///"_$P(X0,U,2)_";3///"_$P(X0,U,3)_$S($L($P(X0,U,4)):";4///"_$P(X0,U,4)_";5///"_$P(X0,U,5)_";6///"_$P(X0,U,6),1:"")
"RTN","XPDIA",167,0)
 D ^DIC
"RTN","XPDIA",168,0)
 Q
"RTN","XPDIA",169,0)
 ;this is used to add subscriber items to a protocol
"RTN","XPDIA",170,0)
SUBS(DA,X) ;DA=ien of protocol, X=subscriber
"RTN","XPDIA",171,0)
 N DIC,DLAYGO,DIK,D0,D1,I,Y,Y0
"RTN","XPDIA",172,0)
 S DIC="^ORD(101,"_DA_",775,",DIC(0)="L",DLAYGO=XPDFIL,(D0,DA(1))=DA
"RTN","XPDIA",173,0)
 S:'$D(@(DIC_"0)")) @(DIC_"0)")=U_$P(^DD(XPDFIL,775,0),U,2)
"RTN","XPDIA",174,0)
 D ^DIC
"RTN","XPDIA",175,0)
 Q
"RTN","XPDIA",176,0)
DEL(DIK,DUZ) ;delete
"RTN","XPDIA",177,0)
 N DA,XPDI,XPDF
"RTN","XPDIA",178,0)
 S XPDI=0,DUZ(0)="@",XPDF=+$P(DIK,"(",2)
"RTN","XPDIA",179,0)
 F  S XPDI=$O(^TMP($J,"XPDEL",XPDI)) Q:'XPDI  D
"RTN","XPDIA",180,0)
 .K ^TMP("DIFIXPT",$J) S DA=XPDI
"RTN","XPDIA",181,0)
 .D ^DIK ;FIXPT^DIA3("D",XPDF,XPDI)
"RTN","XPDIA",182,0)
 .I $D(^TMP("DIFIXPT",$J))  D WP^XPDUTL("^TMP(""DIFIXPT"",$J)")
"RTN","XPDIA",183,0)
 Q
"VER")
8.0^22.0
**END**
**END**
