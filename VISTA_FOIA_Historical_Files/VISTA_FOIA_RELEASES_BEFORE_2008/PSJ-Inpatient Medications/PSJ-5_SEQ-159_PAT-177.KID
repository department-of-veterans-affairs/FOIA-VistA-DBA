Released PSJ*5*177 SEQ #159
Extracted from mail message
**KIDS**:PSJ*5.0*177^

**INSTALL NAME**
PSJ*5.0*177
"BLD",6810,0)
PSJ*5.0*177^INPATIENT MEDICATIONS^0^3060731^y
"BLD",6810,1,0)
^^27^27^3060707^
"BLD",6810,1,1,0)
HD000000104291 - Stop Date calculation can be in the Past
"BLD",6810,1,2,0)
------------------------------------------------------------------------
"BLD",6810,1,3,0)
When editing the Additive or Solution of an active order that was 
"BLD",6810,1,4,0)
previously renewed, the stop date/time can be re-calculated in the Past. 
"BLD",6810,1,5,0)
This will cause the order to be expired immediately upon verification.  
"BLD",6810,1,6,0)
The solution to this issue is to modify the Stop Date/Time calculation to 
"BLD",6810,1,7,0)
use the "Last Renewed" date as a starting point, instead of the 
"BLD",6810,1,8,0)
"Original" Start Date/Time of the order, when editing the Additive or 
"BLD",6810,1,9,0)
Solution of an active IV order that has been previously renewed. (this 
"BLD",6810,1,10,0)
makes the Stop Date/Time calculation that occurs during edits to the 
"BLD",6810,1,11,0)
Additives and Solutions fields consistent with edits to other fields).
"BLD",6810,1,12,0)
 
"BLD",6810,1,13,0)
During the Testing of the solution above a new issue has been found.
"BLD",6810,1,14,0)
 
"BLD",6810,1,15,0)
New Issue 1: Editing the Additive or Solution for non-renewed orders
"BLD",6810,1,16,0)
------------------------------------------------------------------------
"BLD",6810,1,17,0)
This is the same issue as the Original issue but it can also apply to a 
"BLD",6810,1,18,0)
Non-renewed Active order.
"BLD",6810,1,19,0)
 
"BLD",6810,1,20,0)
The solution for the New issue is to Modify the Inpatient Meds IV Order 
"BLD",6810,1,21,0)
Check logic to Display the warning message "The Stop Date/Time is in the 
"BLD",6810,1,22,0)
Past.  This order will automatically expire upon verification", anytime 
"BLD",6810,1,23,0)
the stop date calculation returns a Stop Date/Time in the past.  The 
"BLD",6810,1,24,0)
Pharmacist will then be asked if they still wish to continue.  If they 
"BLD",6810,1,25,0)
continue, the order will automatically expire immediately upon 
"BLD",6810,1,26,0)
verification  If they select to not continue, they may go back to the 
"BLD",6810,1,27,0)
profile and edit the Stop Date/Time.
"BLD",6810,4,0)
^9.64PA^^
"BLD",6810,6)
3^
"BLD",6810,"ABPKG")
n
"BLD",6810,"KRN",0)
^9.67PA^8989.52^19
"BLD",6810,"KRN",.4,0)
.4
"BLD",6810,"KRN",.401,0)
.401
"BLD",6810,"KRN",.402,0)
.402
"BLD",6810,"KRN",.403,0)
.403
"BLD",6810,"KRN",.5,0)
.5
"BLD",6810,"KRN",.84,0)
.84
"BLD",6810,"KRN",3.6,0)
3.6
"BLD",6810,"KRN",3.8,0)
3.8
"BLD",6810,"KRN",9.2,0)
9.2
"BLD",6810,"KRN",9.8,0)
9.8
"BLD",6810,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",6810,"KRN",9.8,"NM",1,0)
PSIVCAL^^0^57659970
"BLD",6810,"KRN",9.8,"NM",2,0)
PSJUTL^^0^63047097
"BLD",6810,"KRN",9.8,"NM","B","PSIVCAL",1)

"BLD",6810,"KRN",9.8,"NM","B","PSJUTL",2)

"BLD",6810,"KRN",19,0)
19
"BLD",6810,"KRN",19.1,0)
19.1
"BLD",6810,"KRN",101,0)
101
"BLD",6810,"KRN",409.61,0)
409.61
"BLD",6810,"KRN",771,0)
771
"BLD",6810,"KRN",870,0)
870
"BLD",6810,"KRN",8989.51,0)
8989.51
"BLD",6810,"KRN",8989.52,0)
8989.52
"BLD",6810,"KRN",8994,0)
8994
"BLD",6810,"KRN","B",.4,.4)

"BLD",6810,"KRN","B",.401,.401)

"BLD",6810,"KRN","B",.402,.402)

"BLD",6810,"KRN","B",.403,.403)

"BLD",6810,"KRN","B",.5,.5)

"BLD",6810,"KRN","B",.84,.84)

"BLD",6810,"KRN","B",3.6,3.6)

"BLD",6810,"KRN","B",3.8,3.8)

"BLD",6810,"KRN","B",9.2,9.2)

"BLD",6810,"KRN","B",9.8,9.8)

"BLD",6810,"KRN","B",19,19)

"BLD",6810,"KRN","B",19.1,19.1)

"BLD",6810,"KRN","B",101,101)

"BLD",6810,"KRN","B",409.61,409.61)

"BLD",6810,"KRN","B",771,771)

"BLD",6810,"KRN","B",870,870)

"BLD",6810,"KRN","B",8989.51,8989.51)

"BLD",6810,"KRN","B",8989.52,8989.52)

"BLD",6810,"KRN","B",8994,8994)

"BLD",6810,"QUES",0)
^9.62^^
"BLD",6810,"REQB",0)
^9.611^2^1
"BLD",6810,"REQB",2,0)
PSJ*5.0*157^2
"BLD",6810,"REQB","B","PSJ*5.0*157",2)

"MBREQ")
0
"PKG",203,-1)
1^1
"PKG",203,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",203,20,0)
^9.402P^^
"PKG",203,22,0)
^9.49I^1^1
"PKG",203,22,1,0)
5.0^2971215^2980417^1271
"PKG",203,22,1,"PAH",1,0)
177^3060731^33234
"PKG",203,22,1,"PAH",1,1,0)
^^27^27^3060731
"PKG",203,22,1,"PAH",1,1,1,0)
HD000000104291 - Stop Date calculation can be in the Past
"PKG",203,22,1,"PAH",1,1,2,0)
------------------------------------------------------------------------
"PKG",203,22,1,"PAH",1,1,3,0)
When editing the Additive or Solution of an active order that was 
"PKG",203,22,1,"PAH",1,1,4,0)
previously renewed, the stop date/time can be re-calculated in the Past. 
"PKG",203,22,1,"PAH",1,1,5,0)
This will cause the order to be expired immediately upon verification.  
"PKG",203,22,1,"PAH",1,1,6,0)
The solution to this issue is to modify the Stop Date/Time calculation to 
"PKG",203,22,1,"PAH",1,1,7,0)
use the "Last Renewed" date as a starting point, instead of the 
"PKG",203,22,1,"PAH",1,1,8,0)
"Original" Start Date/Time of the order, when editing the Additive or 
"PKG",203,22,1,"PAH",1,1,9,0)
Solution of an active IV order that has been previously renewed. (this 
"PKG",203,22,1,"PAH",1,1,10,0)
makes the Stop Date/Time calculation that occurs during edits to the 
"PKG",203,22,1,"PAH",1,1,11,0)
Additives and Solutions fields consistent with edits to other fields).
"PKG",203,22,1,"PAH",1,1,12,0)
 
"PKG",203,22,1,"PAH",1,1,13,0)
During the Testing of the solution above a new issue has been found.
"PKG",203,22,1,"PAH",1,1,14,0)
 
"PKG",203,22,1,"PAH",1,1,15,0)
New Issue 1: Editing the Additive or Solution for non-renewed orders
"PKG",203,22,1,"PAH",1,1,16,0)
------------------------------------------------------------------------
"PKG",203,22,1,"PAH",1,1,17,0)
This is the same issue as the Original issue but it can also apply to a 
"PKG",203,22,1,"PAH",1,1,18,0)
Non-renewed Active order.
"PKG",203,22,1,"PAH",1,1,19,0)
 
"PKG",203,22,1,"PAH",1,1,20,0)
The solution for the New issue is to Modify the Inpatient Meds IV Order 
"PKG",203,22,1,"PAH",1,1,21,0)
Check logic to Display the warning message "The Stop Date/Time is in the 
"PKG",203,22,1,"PAH",1,1,22,0)
Past.  This order will automatically expire upon verification", anytime 
"PKG",203,22,1,"PAH",1,1,23,0)
the stop date calculation returns a Stop Date/Time in the past.  The 
"PKG",203,22,1,"PAH",1,1,24,0)
Pharmacist will then be asked if they still wish to continue.  If they 
"PKG",203,22,1,"PAH",1,1,25,0)
continue, the order will automatically expire immediately upon 
"PKG",203,22,1,"PAH",1,1,26,0)
verification  If they select to not continue, they may go back to the 
"PKG",203,22,1,"PAH",1,1,27,0)
profile and edit the Stop Date/Time.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSIVCAL")
0^1^B57659970^B54669382
"RTN","PSIVCAL",1,0)
PSIVCAL ;BIR/RGY,PR-CALCULATES START AND STOP DATES ;12 Mar 99 / 12:42 PM
"RTN","PSIVCAL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**4,26,41,47,63,67,69,58,94,80,110,111,177**;16 DEC 97
"RTN","PSIVCAL",3,0)
 ;
"RTN","PSIVCAL",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVCAL",5,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVCAL",6,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVCAL",7,0)
 ;
"RTN","PSIVCAL",8,0)
ENT ;NEEDS PSIVTYPE (P(4))
"RTN","PSIVCAL",9,0)
 I $G(PSJREN) D  Q:P(2)
"RTN","PSIVCAL",10,0)
 . I $G(P("OLDON")) N P2 S P2=$G(@("^PS(55,"_DFN_",""IV"","_+P("OLDON")_",0)")),P2=$P(P2,"^",2) I P2 S P(2)=P2
"RTN","PSIVCAL",11,0)
 I $G(PSJORD)["P",$G(P("APPT"))?7N1"."1.N S START=$$DATE2^PSJUTL2(P("APPT")) G Q
"RTN","PSIVCAL",12,0)
 I $G(PSJSYSW0)=""!($P(PSJSYSW0,U,5)=2) S START=+$E(P("LOG"),1,12) G Q
"RTN","PSIVCAL",13,0)
 ;I $G(P("RES"))="R" N PSIVAC S PSIVAC="PR" D ENAD I PSIVADM S P(2)=PSIVADM Q
"RTN","PSIVCAL",14,0)
 S PSIVSN=+P("IVRM"),START="",PSIVTYPE=$G(P(4)) Q:PSIVTYPE=""
"RTN","PSIVCAL",15,0)
 N PSIV X $S($E(PSIVAC)="C":"S X=+$E(P(""LOG""),1,12) D H^%DTC S PSIV=%T",1:"S PSIV=$P($H,"","",2)") G T2:PSIVTYPE'["P"&('P(5))
"RTN","PSIVCAL",16,0)
 I P(11)']"" X $S($E(PSIVAC)="C":"S Y=+$E(P(""LOG""),1,12)",1:"D NOW^%DTC S Y=%") S Y=Y+.007\.01/100 S:'$P(Y,".",2) Y=$$MDNGHT(Y) X ^DD("DD") S START=Y G Q
"RTN","PSIVCAL",17,0)
 S X=P(11) D CHK S PX=Y,X1=PSIV\3600,X2=PSIV#3600\60,X=$E(".0",1,$L(X1)#2+1)_X1_$E("0",X2<10)_X2,START=$S($E(PSIVAC)="C":$P(P("LOG"),"."),1:"T")
"RTN","PSIVCAL",18,0)
 S X1=$P(PX,"-"),X1=$E(".0",1,$L(X1)#2+1)_X1,X2=$P(PX,"-",PSGCNT),X2=$E(".0",1,$L(X2)#2+1)_X2
"RTN","PSIVCAL",19,0)
 S NAT=+$P($G(^PS(59.6,+$O(^PS(59.6,"B",+VAIN(4),0)),0)),U,5)
"RTN","PSIVCAL",20,0)
 I '$D(PSGDT) S PSGDT=$$DATE^PSJUTL2()
"RTN","PSIVCAL",21,0)
 I X<X1,'NAT S START=$$ENSD^PSGNE3(P(9),P(11),+$E(P("LOG"),1,12),PSGDT) G Q
"RTN","PSIVCAL",22,0)
 I X>X2 S START=$$ENSD^PSGNE3(P(9),P(11),+$E(P("LOG"),1,12),PSGDT) G Q
"RTN","PSIVCAL",23,0)
T6 F I=2:1:PSGCNT S X1="."_$P(PX,"-",I-1),X2="."_$P(PX,"-",I) Q:+X1<X&(+X2>X)
"RTN","PSIVCAL",24,0)
 S X1=X-X1,X2=$S(NAT:0,1:X2-X),START=$S(X1<X2:$P(PX,"-",I-1),1:$P(PX,"-",I)) S:START="" START=$P(PX,"-") X $S($E(PSIVAC)="C":"S Y=$P(P(""LOG""),""."") X ^DD(""DD"") S PSIV=Y",1:"S PSIV=""TODAY""") S START=PSIV_"@"_$E("0",$L(START)=3)_START G Q
"RTN","PSIVCAL",25,0)
T2 S X=+("."_$E(10000+(PSIV\3600*100)+(PSIV#3600\60),2,5)),START=$O(^PS(59.5,PSIVSN,3,"AT",X)) S:'START START=$O(^(0)),PSIVTOM=1 I 'START S START=X K PSIVTOM
"RTN","PSIVCAL",26,0)
 S START=$S($E(PSIVAC)="C":$P(P("LOG"),"."),1:DT)_START I $D(PSIVTOM) S X1=$S($E(PSIVAC)="C":$P(P("LOG"),"."),1:DT),X2=1 D C^%DTC S Y=$P(X,".")_START K PSIVTOM
"RTN","PSIVCAL",27,0)
 S X=START,%DT="XRTX" D ^%DT
"RTN","PSIVCAL",28,0)
Q ;
"RTN","PSIVCAL",29,0)
 I START["@" S X=START,%DT="RTX" D ^%DT S START=+Y
"RTN","PSIVCAL",30,0)
 S P(2)=START
"RTN","PSIVCAL",31,0)
 I $G(PSJORD)["P" D:'$G(PSGRDTX(+PSJORD,"PSGSD")) REQDT^PSJLIVMD(PSJORD) S START=$G(PSGRDTX(+PSJORD,"PSGSD")) S P(2)=$S(START:START,1:P(2))
"RTN","PSIVCAL",32,0)
 K NAT,START,PSIVTYPE,PSIVSTRT,PSGCNT,X1,X2,PX
"RTN","PSIVCAL",33,0)
 Q
"RTN","PSIVCAL",34,0)
CHK F Y=1:1 Q:$L(X)>240!($P(X,"-",Y)="")  S $P(X,"-",Y)=$P(X,"-",Y)_$E("0000",1,4-$L($P(X,"-",Y)))
"RTN","PSIVCAL",35,0)
 S Y=X,PSGCNT=$L(X,"-") S:X]""&(PSGCNT<1) PSGCNT=1 Q
"RTN","PSIVCAL",36,0)
 ;
"RTN","PSIVCAL",37,0)
ENSTOP ; WILL CALCULATE STOP DATE FOR ORDER
"RTN","PSIVCAL",38,0)
 ;NEEDS (DFN) & ON
"RTN","PSIVCAL",39,0)
 N WALL,P3,ADX,DDLX,OIX,DRGT,PSIDAY S (WALL,P3,PSIDAY)=0
"RTN","PSIVCAL",40,0)
 D:'$G(PSIVSITE) ^PSIVSET  Q:'P(2)
"RTN","PSIVCAL",41,0)
 I P(23)'="" S PSIVTYPE="C"
"RTN","PSIVCAL",42,0)
 S STOP="",X="",PSIVSTRT=P(2),PSIVTYPE=$G(P(4)) I $G(PSJREN) D
"RTN","PSIVCAL",43,0)
 . N RDT I $G(ON)["P" S RDT=+$$LASTREN^PSJLMPRI(DFN,ON)
"RTN","PSIVCAL",44,0)
 . S PSIVSTRT=$$DATE2^PSJUTL2($S($G(RDT):RDT,1:$G(PSGDT)))
"RTN","PSIVCAL",45,0)
 . Q
"RTN","PSIVCAL",46,0)
 ;BHW - PSJ*5*177 - Begin Modifications - Reset Start date to Last Renewed date for active orders that have been renewed
"RTN","PSIVCAL",47,0)
 I ('$G(PSJREN))&($G(P(4))="A")&($G(ON)["V") D
"RTN","PSIVCAL",48,0)
 . N RDT S RDT=+$$LASTREN^PSJLMPRI(DFN,ON)
"RTN","PSIVCAL",49,0)
 . I +RDT S PSIVSTRT=RDT
"RTN","PSIVCAL",50,0)
 . Q
"RTN","PSIVCAL",51,0)
 ;BHW - PSJ*5*177 - End Modifications - Resetting PSIVSTRT will recalculate the stop date based on the Last renewed date.
"RTN","PSIVCAL",52,0)
 ;
"RTN","PSIVCAL",53,0)
 I $S("^NOW^STAT^ONCE^ONE-TIME^ONE TIME^ONETIME^1TIME^1-TIME^1 TIME^"[(U_P(9)_U):1,1:0),PSIVTYPE="P"!P(5)!(P(23)="P") S X=$$ENOSD^PSJDCU(PSJSYSW0,PSIVSTRT,DFN) I X]"" S:P(11)=""&($G(ON)["P") PSIVCAL=1 G END
"RTN","PSIVCAL",54,0)
 N DUR,DURMIN I $G(PSJORD)["V" S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,"IV",1) I DUR]"" S DURMIN=$$DURMIN^PSJLIVMD(DUR) I DURMIN D  G END
"RTN","PSIVCAL",55,0)
 . S X=$$FMADD^XLFDT(PSIVSTRT,,,DURMIN)
"RTN","PSIVCAL",56,0)
 I $G(PSJORD)["P"!($G(PSJORD)["V") N PSIVLIM,MINS,LIM S PSIVLIM=$$GETLIM(DFN,PSJORD) I PSIVLIM]"" S MINS=$$GETMIN(PSIVLIM,DFN,PSJORD) I MINS S X=$$FMADD^XLFDT(PSIVSTRT,,,MINS) G END
"RTN","PSIVCAL",57,0)
 I $P(PSIVSITE,"^",5) D
"RTN","PSIVCAL",58,0)
 . N Z S Y=0
"RTN","PSIVCAL",59,0)
 . F  S Y=$O(^PS(55,DFN,"IV",Y)) Q:'Y  S Z=^(Y,0) D  Q:X]""
"RTN","PSIVCAL",60,0)
 .. I $P(Z,"^",17)="A",$$ONE^PSJBCMA(DFN,Y_"V",$P(Z,"^",9))'="O" S X=$P(Z,"^",3) Q
"RTN","PSIVCAL",61,0)
 S:X WALL=X
"RTN","PSIVCAL",62,0)
 S PSIDAY=$S(PSIVTYPE="A":$P(PSIVSITE,"^",4),PSIVTYPE="H":$P(PSIVSITE,"^",17),PSIVTYPE="P":$P(PSIVSITE,"^",18),PSIVTYPE="S":$P(PSIVSITE,"^",20),1:$P(PSIVSITE,"^",21))
"RTN","PSIVCAL",63,0)
 S PSJDAY="" D  I PSJDAY]"",PSJDAY<PSIDAY S PSIDAY=PSJDAY
"RTN","PSIVCAL",64,0)
 . N A,B
"RTN","PSIVCAL",65,0)
 . Q:'$D(PSJORD)  S A=""
"RTN","PSIVCAL",66,0)
 . I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVCAL",67,0)
 . I PSJORD["U" S A=$G(^PS(55,PSGP,5,+PSJORD,8))
"RTN","PSIVCAL",68,0)
 . I PSJORD["I" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVCAL",69,0)
 . S A=$P(A,"^") Q:A=""  I $D(^PS(53.46,"B",A)) S B=$O(^PS(53.46,"B",A,"")),PSJDAY=$P(^PS(53.46,B,0),"^",2)
"RTN","PSIVCAL",70,0)
 F X=0:0 S X=$O(DRG("AD",X)) Q:'X  I $P(^PS(52.6,+$P(DRG("AD",+X),U),0),"^",4),($P(^(0),"^",4))<+PSIDAY S PSIDAY=$P(^(0),"^",4)
"RTN","PSIVCAL",71,0)
 I WALL,($$FMADD^XLFDT(PSIVSTRT,PSIDAY,"D"))>WALL S PSIDAY=$$FMDIFF^XLFDT(WALL,PSIVSTRT,1) S:PSIDAY<1 PSIDAY=""
"RTN","PSIVCAL",72,0)
 S DRGT=$S($D(DRG("AD")):"AD",1:"SOL") F ADX=0:0 S ADX=$O(DRG(DRGT,ADX)) Q:'ADX!($G(DRGTMP)&($G(DRGTN)["AD")&(DRGT="SOL"))  D
"RTN","PSIVCAL",73,0)
 . I DRGT="AD",+$P(^PS(52.6,$P(DRG(DRGT,+ADX),U),0),"^",4),(+$P(^(0),"^",4))<+Y S Y=$P(^(0),"^",4)
"RTN","PSIVCAL",74,0)
 . S OIX=+$P(DRG(DRGT,ADX),"^",6),DDLX=$P(^PS(50.7,OIX,0),"^",5) Q:'DDLX  D DDLIM(.PSIDAY,.P3)
"RTN","PSIVCAL",75,0)
 I '$G(DRG("AD",0)),$G(DRGTMP),($G(DRGTN)["SOL") S OIX=$P($G(DRGTMP),"^",6) I OIX S DDLX=$P(^PS(50.7,OIX,0),"^",5) I DDLX  D DDLIM(.PSIDAY,.P3)
"RTN","PSIVCAL",76,0)
 I $G(P3),$G(P(2)) I P3>P(2) S X=P3 G END
"RTN","PSIVCAL",77,0)
 S:'PSIDAY PSIDAY=1
"RTN","PSIVCAL",78,0)
TIME S X2=PSIDAY,X1=PSIVSTRT D C^%DTC S X=$P(X,"."),X=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVCAL",79,0)
END ;
"RTN","PSIVCAL",80,0)
 S P(3)=+X
"RTN","PSIVCAL",81,0)
 I $G(PSJORD)["P" D:'$G(PSGRDTX(+PSJORD,"PSGFD")) REQDT^PSJLIVMD(PSJORD) S P(3)=$S($G(PSGRDTX(+PSJORD,"PSGFD")):PSGRDTX(+PSJORD,"PSGFD"),1:P(3))
"RTN","PSIVCAL",82,0)
 S P(3)=$$DATE2^PSJUTL2(P(3)),P(2)=$$DATE2^PSJUTL2(P(2))
"RTN","PSIVCAL",83,0)
 Q
"RTN","PSIVCAL",84,0)
 ;
"RTN","PSIVCAL",85,0)
ENAD ;Will get last admin. time for order (needs dfn and on)
"RTN","PSIVCAL",86,0)
 N P4,PSIVX,PSIVY
"RTN","PSIVCAL",87,0)
 I $P(PSJSYSW0,U,5)=2 S PSIVADM=$$DATE^PSJUTL2() Q
"RTN","PSIVCAL",88,0)
 I $S($G(PSIVAC)["R":1,P(9)="QOD":1,1:P(9)?1"Q".N1"D") S PSIVADM=$$ENSD^PSGNE3(P(9),P(11),+$E(P("LOG"),1,12),+$P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,2)) Q:PSIVADM
"RTN","PSIVCAL",89,0)
 S PSIVX=X,PSIVY=Y,P4=P(4) S:P(4)="C" P4=P(23) S:P4="S" P4=$S(P(5):"P",1:"A") D NOW^%DTC S Y=%,PSIVNOW=Y I (P4="P"&(P(11)="")&'P(15))!("HA"[P4&'P(15)) S Y=Y+.007\.01/100 G QAD
"RTN","PSIVCAL",90,0)
 D P:P4="P"&('P(15)),AH:P(15)
"RTN","PSIVCAL",91,0)
QAD ;
"RTN","PSIVCAL",92,0)
 S:'$D(PSGSA) PSGSA=""
"RTN","PSIVCAL",93,0)
 S PSIVSD=Y I Y S OD=$L(PSGSA," ") I OD>2 S X=+PSGSA\1 F OD1=2:1:OD-1 I $P(PSGSA," ",OD1)'>$S(OD1>2:$P(PSGSA," ",OD1-1),1:PSGSA#1) S X1=X,X2=1 D C^%DTC
"RTN","PSIVCAL",94,0)
 I PSIVSD,OD>2 S Y=X_PSIVSD
"RTN","PSIVCAL",95,0)
 S PSIVADM=+Y,X=PSIVX,Y=PSIVY K PSGSA,PSIVSD,OD,OD1,PSIVMI,PSIVNOW S:PSIVADM<P(2) PSIVADM=P(2) Q
"RTN","PSIVCAL",96,0)
 ;
"RTN","PSIVCAL",97,0)
P S CD=PSIVNOW,PSGSA="",(PSIVSD,OD)=DT_.0001,X=P(11) D CHK S P(11)=X D ENP4^PSIVWL
"RTN","PSIVCAL",98,0)
 I PSGSA="" S PSIVSD=DT_.0001,PSIVMIN=-1440 D ENT^PSIVWL S $P(Y,".",2)=$P(P(11),"-",$L(P(11),"-")) Q
"RTN","PSIVCAL",99,0)
 S Y=$P(PSGSA," ",$L(PSGSA," ")-1) Q
"RTN","PSIVCAL",100,0)
AH F PSIVADM=0:-1 S CD=PSIVNOW,(X,X1)=DT,X2=PSIVADM D:X2 C^%DTC S X=$P(X,".") S (OD1,PSIVSD,OD)=X_.0001,PSIVMIN=P(15) D ENP3^PSIVWL Q:PSIVADM<-4!(PSGSA]"")
"RTN","PSIVCAL",101,0)
 S Y=$P(PSGSA," ",$L(PSGSA," ")-1) Q
"RTN","PSIVCAL",102,0)
MDNGHT(Y)          ;Sets Start Date/Time on orders placed between midnight and 12:30
"RTN","PSIVCAL",103,0)
 S Y=$$FMADD^XLFDT(Y,-1,0,0,0),Y=$P(Y,".")_".24" Q Y
"RTN","PSIVCAL",104,0)
 ;
"RTN","PSIVCAL",105,0)
DDLIM(PSIVDUR,STPDT) ;  
"RTN","PSIVCAL",106,0)
 N P3
"RTN","PSIVCAL",107,0)
 I DDLX["D" D  Q:(STPDT=0)
"RTN","PSIVCAL",108,0)
 . I +DDLX'<+PSIVDUR S STPDT=0 Q
"RTN","PSIVCAL",109,0)
 . S PSIVDUR=+DDLX,X2=PSIVDUR,X1=PSIVSTRT D C^%DTC S X=$P(X,"."),X=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14)) I X>P(2) S P(3)=X
"RTN","PSIVCAL",110,0)
 I DDLX["L",($G(P(9))]""),$G(P(15)),("AH"'[PSIVTYPE) D
"RTN","PSIVCAL",111,0)
 . Q:'$G(P(2))!'$G(OIX)  N FIRST,DOSAR,LAST,NEWDUR
"RTN","PSIVCAL",112,0)
 . S STRING=P(2)_"^"_$S($G(STPDT):STPDT,1:$$FMADD^XLFDT(PSGDT,30))_"^"_P(9)_"^C^"_OIX S FIRST=$$ENQ^PSJORP2(DFN,STRING)
"RTN","PSIVCAL",113,0)
 . S FIRST=$S($G(FIRST):FIRST,1:P(2)) Q:'FIRST  S DSTMP=FIRST,DOSAR(1)=DSTMP F I=2:1:DDLX+1 S DOSAR(I)=$$FMADD^XLFDT(DSTMP,,,P(15)),DSTMP=DOSAR(I)
"RTN","PSIVCAL",114,0)
 . I $D(DOSAR) S LAST=$O(DOSAR(""),-1) I LAST S LAST=DOSAR(LAST) I LAST>P(2) S NEWDUR=$$FMDIFF^XLFDT(LAST,P(2)) I NEWDUR<PSIVDUR S P(3)=LAST
"RTN","PSIVCAL",115,0)
 S P(3)=$$DATE2^PSJUTL2(P(3)),P(2)=$$DATE2^PSJUTL2(P(2)) S STPDT=P(3)
"RTN","PSIVCAL",116,0)
 Q
"RTN","PSIVCAL",117,0)
 ;
"RTN","PSIVCAL",118,0)
GETLIM(DFN,PSJORD) ;
"RTN","PSIVCAL",119,0)
 N ND2P5,F
"RTN","PSIVCAL",120,0)
 S F=$S(PSJORD["P":"^PS(53.1,+PSJORD,",PSJORD["V":"^PS(55,DFN,""IV"",+PSJORD,",1:"")
"RTN","PSIVCAL",121,0)
 S ND2P5=$G(@(F_"2.5)")) S LIM=$P(ND2P5,"^",4) Q:LIM="" 0
"RTN","PSIVCAL",122,0)
 S ND0=$G(@(F_"0)")) I PSJORD["P",($P(ND0,"^",4)'="F") Q 0
"RTN","PSIVCAL",123,0)
 N MULT S MULT=$S($E(LIM)="h":60,$E(LIM)="d":1440,$E(LIM)="m":LIM,$E(LIM)="l":LIM,1:0) I MULT S LIM=MULT*$E(LIM,2,99)
"RTN","PSIVCAL",124,0)
 Q LIM
"RTN","PSIVCAL",125,0)
 ;
"RTN","PSIVCAL",126,0)
GETMIN(LIM,DFN,PSJORD) ;
"RTN","PSIVCAL",127,0)
 N F
"RTN","PSIVCAL",128,0)
 I LIM!(LIM=0) Q LIM
"RTN","PSIVCAL",129,0)
 S F=$S(PSJORD["P":"^PS(53.1,+PSJORD,",PSJORD["V":"^PS(55,DFN,""IV"",+PSJORD,",1:"")
"RTN","PSIVCAL",130,0)
 N RATE S RATE=$S(PSJORD["P":+$P($G(@(F_"8)")),"^",5),PSJORD["V":+$P($G(@(F_"0)")),"^",8),1:0) I RATE D
"RTN","PSIVCAL",131,0)
 . S LIM=$S($E(LIM)="m":$E(LIM,2,99),$E(LIM)="l":($E(LIM,2,99)*1000),1:0)/RATE S LIM=LIM*60
"RTN","PSIVCAL",132,0)
 Q LIM
"RTN","PSJUTL")
0^2^B63047097^B59274204
"RTN","PSJUTL",1,0)
PSJUTL ;BIR/MLM-MISC. INPATIENT UTILITIES ;17 Mar 98 / 11:05 AM
"RTN","PSJUTL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**9,47,58,80,110,136,157,177**;16 DEC 97
"RTN","PSJUTL",3,0)
 ;
"RTN","PSJUTL",4,0)
 ; Reference to ^DIC(42 is supported by DBIA 10039.
"RTN","PSJUTL",5,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJUTL",6,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSJUTL",7,0)
 ; Reference to ^DIC is supported by DBIA 10006.
"RTN","PSJUTL",8,0)
 ; Reference to ^DIC1 is supported by DBIA 10007.
"RTN","PSJUTL",9,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSJUTL",10,0)
 ; Reference to ^VALM1 is supported by DBIA 10116.
"RTN","PSJUTL",11,0)
 ;
"RTN","PSJUTL",12,0)
ENDL ; device look-up
"RTN","PSJUTL",13,0)
 N DA,DIC,DIE,DIX,DO,DR
"RTN","PSJUTL",14,0)
 S DIC="^%ZIS(1,",DIC(0)="EIMZ" D DO^DIC1,^DIC I Y'>0 K X Q
"RTN","PSJUTL",15,0)
 S X=Y(0,0)
"RTN","PSJUTL",16,0)
 Q
"RTN","PSJUTL",17,0)
 ;
"RTN","PSJUTL",18,0)
ENDH(X) ; device help
"RTN","PSJUTL",19,0)
 N D,XQH,DA,DIC,DIE,DO,DR,DZ
"RTN","PSJUTL",20,0)
 S DIC="^%ZIS(1,",DIC(0)="EIM" D DO^DIC1,^DIC
"RTN","PSJUTL",21,0)
 Q
"RTN","PSJUTL",22,0)
 ;
"RTN","PSJUTL",23,0)
READ ; hold screen
"RTN","PSJUTL",24,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","PSJUTL",25,0)
 W ! I $D(IOSL),$Y<(IOSL-4) G READ
"RTN","PSJUTL",26,0)
 W !?5,"Press return to continue  " R X:$S($D(DTIME):DTIME,1:300)
"RTN","PSJUTL",27,0)
 Q
"RTN","PSJUTL",28,0)
 ;
"RTN","PSJUTL",29,0)
ENOISC(PSJOI,USAGE)          ;Set DIC("S") so that only Orderable Items with at 
"RTN","PSJUTL",30,0)
 ;least 1 active dispense drug for the specified usage.
"RTN","PSJUTL",31,0)
 ;Input:  PSJOI IEN of Orderable Item selected
"RTN","PSJUTL",32,0)
 ;        USAGE - Type of drugs (UD,IV,etc) to be selected
"RTN","PSJUTL",33,0)
 ;Output: 1-At least one dispense drug found
"RTN","PSJUTL",34,0)
 ;        0-None found
"RTN","PSJUTL",35,0)
 N FOUND,PSJ
"RTN","PSJUTL",36,0)
 S PSJ=$P($G(^PS(50.7,+PSJOI,0)),U,4),FOUND=$S('PSJ:1,PSJ>DT:1,1:0)
"RTN","PSJUTL",37,0)
 I FOUND S FOUND=0 F PSJ=0:0 S PSJ=$O(^PSDRUG("ASP",PSJOI,PSJ)) Q:FOUND!'PSJ  I $P($G(^PSDRUG(PSJ,2)),U,3)[USAGE,'$G(^("I"))!($G(^("I"))'<DT) S FOUND=1
"RTN","PSJUTL",38,0)
 Q FOUND
"RTN","PSJUTL",39,0)
 ;
"RTN","PSJUTL",40,0)
AADR ; display allergies and adverse reactions
"RTN","PSJUTL",41,0)
 D ATS^PSJMUTL(60,50,1) N A,B
"RTN","PSJUTL",42,0)
 I (PSGALG=0)&(PSGADR=0) W !!,"No allergies or ADRs on file."
"RTN","PSJUTL",43,0)
 I PSGALG'=0 W !!,"Allergies: " S B="PSGALG" F  S A=$Q(@B) Q:A=""  W ?12,$G(@A),! S B=A
"RTN","PSJUTL",44,0)
 I PSGADR'=0 W !,"      ADR: " S B="PSGADR" F  S A=$Q(@B) Q:A=""  W ?12,$G(@A),! S B=A
"RTN","PSJUTL",45,0)
 D READ K PSGALG,PSGADR Q
"RTN","PSJUTL",46,0)
 ;
"RTN","PSJUTL",47,0)
ENALU ; application look-up
"RTN","PSJUTL",48,0)
 N PSJ S PSJ=DA(1) N DA,DIC,DIE,DIX,DO,DR S DIC="^PS(50.35,",DIC(0)="EIMZ" D DO^DIC1,^DIC I Y'>0 K X Q
"RTN","PSJUTL",49,0)
 S X=$P(Y(0),"^",2) K:$S(X="":1,1:$D(^PS(50.3,PSJ,1,"B",X))) X
"RTN","PSJUTL",50,0)
 Q
"RTN","PSJUTL",51,0)
 ;
"RTN","PSJUTL",52,0)
ENAQ ; application query
"RTN","PSJUTL",53,0)
 S X=DZ N D,DA,DIC,DIE,DO,DR,DZ,XQH S DIC="^PS(50.35,",DIC(0)="EIMQ" D DO^DIC1,^DIC
"RTN","PSJUTL",54,0)
 Q
"RTN","PSJUTL",55,0)
 ;
"RTN","PSJUTL",56,0)
ENPC(PSJTYP,PSJSYSP,LEN,TEXT) ; Copy Provider Comments -> Special Instructions.
"RTN","PSJUTL",57,0)
 Q:'$D(^PS(53.1,+$G(PSJORD),12,1,0)) ""
"RTN","PSJUTL",58,0)
 N DIR,PSGSI,PSGOEE,X,Y
"RTN","PSJUTL",59,0)
 S Y="" F X=0:0 S X=$O(^PS(53.1,+$G(PSJORD),12,X)) Q:'X  S Y=Y_^(X,0)_" " Q:$L(Y)>LEN
"RTN","PSJUTL",60,0)
 S:$G(PSJTYP)'="V" Y=$$ENSET^PSGSICHK(Y) S:$G(PSJTYP)="V" Y=$E(Y,1,$L(Y)-1)
"RTN","PSJUTL",61,0)
 I $L(Y)'<LEN S PSGOEE=0 D REDISP Q PSGSI
"RTN","PSJUTL",62,0)
 ;Display Provider Comments Prior to Asking the Copy Provider Comments Question;BHW;PSJ*5*136
"RTN","PSJUTL",63,0)
 N PSJTMP S PSJTMP=0
"RTN","PSJUTL",64,0)
 W !,"PROVIDER COMMENTS:"
"RTN","PSJUTL",65,0)
 F  S PSJTMP=$O(^PS(53.1,+$G(PSJORD),12,PSJTMP)) Q:'PSJTMP  W !,^PS(53.1,+$G(PSJORD),12,PSJTMP,0)
"RTN","PSJUTL",66,0)
 S PSGSI=Y W ! S DIR(0)="S^Y:Yes;N:No;!:Copy and flag for display in a BCMA Message Box",DIR("A")="Copy the Provider Comments into "_$$ENFIELD(PSJTYP)_" (Yes/No/!)",DIR("??")="^D ENPCHLP1^PSJUTL(PSJTYP)" D ^DIR
"RTN","PSJUTL",67,0)
 Q:Y="Y" PSGSI
"RTN","PSJUTL",68,0)
 Q:Y="!" PSGSI_"^1"
"RTN","PSJUTL",69,0)
 Q ""
"RTN","PSJUTL",70,0)
 ;
"RTN","PSJUTL",71,0)
REDISP ; Redisplay Provider Comments and allow entry of Spec. Instructions.
"RTN","PSJUTL",72,0)
 D CLEAR^VALM1 F X=0:0 S X=$O(^PS(53.1,+$G(PSJORD),12,X)) Q:'X  W ^(X,0),!
"RTN","PSJUTL",73,0)
 W !! S PSGSI=""
"RTN","PSJUTL",74,0)
 D:PSJTYP'="V" 8^PSGOE81
"RTN","PSJUTL",75,0)
 I PSJTYP="V" D 64^PSIVEDT1 S PSGSI=P("OPI")
"RTN","PSJUTL",76,0)
 Q
"RTN","PSJUTL",77,0)
 ;
"RTN","PSJUTL",78,0)
ENPCHLP1(Y) ; Display help messages for Provider Comment copy.
"RTN","PSJUTL",79,0)
 W !,"Enter ""YES"" to copy Provider Comments into the ",$$ENFIELD(Y)," field",!,"or ""NO"" to bypass",!,"or ""!"" to copy the Provider Comments into the ",$$ENFIELD(PSJTYP)," field",!,"and flag them for display in a BCMA Message Box",!!
"RTN","PSJUTL",80,0)
 Q
"RTN","PSJUTL",81,0)
ENPCHLP2(Y,X) ;
"RTN","PSJUTL",82,0)
 W !,"The Provider Comments entered for this order are longer than the space available",!,"in the ",$$ENFIELD(Y)," field.",!!,"Enter ""YES"" to copy the first ",X-3," characters into the ",$$ENFIELD(Y),!,"field, or ""NO"" to continue.",!!
"RTN","PSJUTL",83,0)
 Q
"RTN","PSJUTL",84,0)
ENBCMA(PSJTYP)  ;
"RTN","PSJUTL",85,0)
 N DIR,X,Y
"RTN","PSJUTL",86,0)
 W !!,"Would you like to flag the ",$$ENFIELD(PSJTYP)," field for display in a BCMA",!,"Message box?"
"RTN","PSJUTL",87,0)
 W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Flag the "_$$ENFIELD(PSJTYP)_" (Yes/No)" D ^DIR
"RTN","PSJUTL",88,0)
 K PSJCOMSI I $G(PSJCOM),$G(PSJORD)'["P" N TEXT S TEXT=$S(PSJTYP="U":$G(PSGSI),1:$G(P("OPI"))) S PSJCOMSI=$$COMSI(PSJCOM,TEXT)
"RTN","PSJUTL",89,0)
 Q:Y="Y" $S($G(PSJTYP)="U":$P(PSGSI,"^")_"^1",1:$P(P("OPI"),"^")_"^1")
"RTN","PSJUTL",90,0)
 Q $S(PSJTYP="U":$P(PSGSI,"^"),1:$P($G(P("OPI")),"^"))
"RTN","PSJUTL",91,0)
ENFIELD(Y) ;
"RTN","PSJUTL",92,0)
 Q $S(Y="V":"Other Print Info",1:"Special Instructions")
"RTN","PSJUTL",93,0)
 ;
"RTN","PSJUTL",94,0)
COMSI(PARENT,INSTR) ;
"RTN","PSJUTL",95,0)
 N DIR,X,Y
"RTN","PSJUTL",96,0)
 W !!!!?15,"** WARNING **",!?5,"This order is part of a complex order."
"RTN","PSJUTL",97,0)
 W !!,"Would you like to copy the ",$$ENFIELD(PSJTYP)
"RTN","PSJUTL",98,0)
 W !,"to the other orders in the complex order?"
"RTN","PSJUTL",99,0)
 S DIR(0)="S^Y:Yes;N:No",DIR("A")="     Copy the "_$$ENFIELD(PSJTYP)_" (Yes/No)" D ^DIR
"RTN","PSJUTL",100,0)
 Q:Y="Y" 1
"RTN","PSJUTL",101,0)
 Q 0
"RTN","PSJUTL",102,0)
 ;
"RTN","PSJUTL",103,0)
ENORL(X) ; Return patient's location as variable ptr.
"RTN","PSJUTL",104,0)
 Q $S(+$G(^DIC(42,+X,44)):+$G(^(44))_";SC(",$D(^DIC(42,+X,0)):+X_";DIC(42,",1:"")
"RTN","PSJUTL",105,0)
 ;
"RTN","PSJUTL",106,0)
ENMARD() ; validate MAR SELECTION DEFAULT string in WARD PARMS file.
"RTN","PSJUTL",107,0)
 N PSJANS,PSJX1,PSJX2,RANGE,Q
"RTN","PSJUTL",108,0)
 S RANGE="1:6" F PSJX1=1:1:6 S RANGE(PSJX1)=""
"RTN","PSJUTL",109,0)
 S:$E(X)="-" X=+RANGE_X S:$E($L(X))="-" X=X_$P(RANGE,":",2)
"RTN","PSJUTL",110,0)
 S PSJANS="" F Q=1:1:$L(X,",") S PSJX1=$P(X,",",Q) D FS Q:'$D(PSJANS)
"RTN","PSJUTL",111,0)
 Q:'$G(PSJANS) 0
"RTN","PSJUTL",112,0)
 S PSJANS=$E(PSJANS,1,$L(PSJANS)-1) F Q=1:1:$L(PSJANS,",") D  Q:'$D(PSJANS)
"RTN","PSJUTL",113,0)
 .I $P(PSJANS,",",Q)=1,$L(PSJANS,",")>1 W !!,"All Medications (1) may not be selected in combination with other types." K PSJANS Q
"RTN","PSJUTL",114,0)
 .W ?47,$P(PSJANS,",",Q)," - ",$P($T(@$P(PSJANS,",",Q)),";;",2),!
"RTN","PSJUTL",115,0)
 S:$G(PSJANS) X=PSJANS Q $G(PSJANS)
"RTN","PSJUTL",116,0)
 ;
"RTN","PSJUTL",117,0)
FS ;
"RTN","PSJUTL",118,0)
 I $S(PSJX1?1.N1"-"1.N:0,PSJX1'?1.N:1,'$D(RANGE(PSJX1)):1,1:","_PSJANS[PSJX1) K PSJANS Q
"RTN","PSJUTL",119,0)
 I PSJX1'["-" S PSJANS=PSJANS_PSJX1_"," Q
"RTN","PSJUTL",120,0)
 S PSJX2=+PSJX1,PSJANS=PSJANS_PSJX2_","
"RTN","PSJUTL",121,0)
 F  S PSJX2=$O(RANGE(PSJX2)) K:$S(X="":1,","_PSJANS[PSJX2:1,1:PSJX2>$P(PSJX1,"-",2)) PSJANS Q:'$D(PSJANS)  S PSJANS=PSJANS_PSJX2_"," Q:PSJX2=$P(PSJX1,"-",2)
"RTN","PSJUTL",122,0)
 Q
"RTN","PSJUTL",123,0)
 ;
"RTN","PSJUTL",124,0)
ENMARDH ;Help text for MAR default answer.
"RTN","PSJUTL",125,0)
 W !!?2,"Enter the number corresponding to the type of orders to be included on MARs",!,"printed for this ward. Multiple types (except 1) may be selected using ""-""",!,"or "","" as delimiters.",!!,"Choose from: ",!
"RTN","PSJUTL",126,0)
 N X F X=1:1:6 W !?13,X," - ",$P($T(@X),";;",2)
"RTN","PSJUTL",127,0)
 W !
"RTN","PSJUTL",128,0)
 Q
"RTN","PSJUTL",129,0)
1 ;;All Medications
"RTN","PSJUTL",130,0)
2 ;;Non-IV Medications only
"RTN","PSJUTL",131,0)
3 ;;IV Piggybacks
"RTN","PSJUTL",132,0)
4 ;;LVPs
"RTN","PSJUTL",133,0)
5 ;;TPNs
"RTN","PSJUTL",134,0)
6 ;;Chemotherapy Medications (IV)
"RTN","PSJUTL",135,0)
 ;
"RTN","PSJUTL",136,0)
EFD ;The following EFD Tags are used to Calculate the Expected First Dose for backdoor
"RTN","PSJUTL",137,0)
 ;orders.  The call to $$ENQ^PSJORP2 is used to actually perform the calculation.
"RTN","PSJUTL",138,0)
 ;The program $$ENQ^PSJORP2 requires the variable INFO to equal the following:
"RTN","PSJUTL",139,0)
 ;BHW;PSJ*5*136
"RTN","PSJUTL",140,0)
 ; INFO (piece 1) = START DATE/TIME      ;PSGNESD (NEW ORDER)
"RTN","PSJUTL",141,0)
 ; INFO (piece 2) = STOP DATE/TIME       ;PSGNEFD (NEW ORDER)
"RTN","PSJUTL",142,0)
 ; INFO (piece 3) = SCHEDULE             ;PSGSCH  (NEW ORDER)
"RTN","PSJUTL",143,0)
 ; INFO (piece 4) = SCHEDULE TYPE        ;PSGST   (NEW ORDER)
"RTN","PSJUTL",144,0)
 ; INFO (piece 5) = ORDERABLE ITEM       ;PSGDRG  (NEW ORDER)
"RTN","PSJUTL",145,0)
 ; INFO (piece 6) = ADMIN TIMES          ;PSGS0Y  (NEW ORDER)
"RTN","PSJUTL",146,0)
 ; 
"RTN","PSJUTL",147,0)
EFDNEW ;Call Here if NEW or RENEWED Order
"RTN","PSJUTL",148,0)
 N INFO
"RTN","PSJUTL",149,0)
 S INFO=($G(PSGNESD))_U_($G(PSGNEFD))_U_($G(PSGSCH))_U_($G(PSGST))_U_($G(PSGDRG))_U_($G(PSGS0Y))
"RTN","PSJUTL",150,0)
 D EFDDISP
"RTN","PSJUTL",151,0)
 QUIT
"RTN","PSJUTL",152,0)
EFDACT ;Call here if Editing Fields for an ACTIVE order
"RTN","PSJUTL",153,0)
 ; Field 10 = Start Date
"RTN","PSJUTL",154,0)
 ; Field 34 = Stop Date
"RTN","PSJUTL",155,0)
 ; Field 41 = Admin Times
"RTN","PSJUTL",156,0)
 N INFO,KEY,ORDER,LAST
"RTN","PSJUTL",157,0)
 ;Loop Fields to be edited, in order, and determine when to Display expected first dose message
"RTN","PSJUTL",158,0)
 F KEY=1:1 S ORDER=$P(PSGOEER,";",KEY) Q:'$L(ORDER)  I "10^34^41"[$P(ORDER,U,1) S ORDER(KEY)=$P(ORDER,U,1)
"RTN","PSJUTL",159,0)
 ;If there are no entries in ORDER, then were Not Editing Start/Stop or Admin Times
"RTN","PSJUTL",160,0)
 S LAST=$O(ORDER(99),-1) Q:'LAST
"RTN","PSJUTL",161,0)
 ;Only display EFD once, so Quit if this call is not for the Last field in the Edit
"RTN","PSJUTL",162,0)
 S LAST=ORDER(LAST)
"RTN","PSJUTL",163,0)
 I LAST'=PSGF2 Q
"RTN","PSJUTL",164,0)
 S INFO=($G(PSGSD))_U_($G(PSGFD))_U_($G(PSGSCH))_U_($G(PSGST))_U_($G(PSGPDRG))_U_($G(PSGS0Y))
"RTN","PSJUTL",165,0)
 D EFDDISP
"RTN","PSJUTL",166,0)
 QUIT
"RTN","PSJUTL",167,0)
EFDNV ;Call here if Editing Fields for a NON-VERIFIED order
"RTN","PSJUTL",168,0)
 ; Field 10 = Start Date
"RTN","PSJUTL",169,0)
 ; Field 25 = Stop Date
"RTN","PSJUTL",170,0)
 ; Field 39 = Admin Times
"RTN","PSJUTL",171,0)
 N INFO,KEY,ORDER,LAST
"RTN","PSJUTL",172,0)
 ;Check if called during finish process
"RTN","PSJUTL",173,0)
 I '$D(PSGOEER) D  D EFDDISP Q
"RTN","PSJUTL",174,0)
 . S INFO=($G(PSGNESD))_U_($G(PSGNEFD))_U_($G(PSGSCH))_U_($G(PSGST))_U_($G(PSGPDRG))_U_($G(PSGS0Y))
"RTN","PSJUTL",175,0)
 . Q
"RTN","PSJUTL",176,0)
 ;Loop Fields to be edited, in order, and determine when to Display expected first dose message
"RTN","PSJUTL",177,0)
 F KEY=1:1 S ORDER=$P(PSGOEER,";",KEY) Q:'$L(ORDER)  I "10^25^39"[$P(ORDER,U,1) S ORDER(KEY)=$P(ORDER,U,1)
"RTN","PSJUTL",178,0)
 ;If there are no entries in ORDER, then were Not Editing Start/Stop or Admin Times
"RTN","PSJUTL",179,0)
 S LAST=$O(ORDER(99),-1) Q:'LAST
"RTN","PSJUTL",180,0)
 ;Only display EFD once, so Quit if this call is not for the Last field in the Edit
"RTN","PSJUTL",181,0)
 S LAST=ORDER(LAST)
"RTN","PSJUTL",182,0)
 I LAST'=PSGF2 Q
"RTN","PSJUTL",183,0)
 S INFO=($G(PSGSD))_U_($G(PSGFD))_U_($G(PSGSCH))_U_($G(PSGST))_U_($G(PSGPDRG))_U_($G(PSGS0Y))
"RTN","PSJUTL",184,0)
 D EFDDISP
"RTN","PSJUTL",185,0)
 QUIT
"RTN","PSJUTL",186,0)
EFDIV(PSGZZND) ;Set variables for EFD on IV orders.
"RTN","PSJUTL",187,0)
 S PSGNESD=P(2),PSGNEFD=P(3),PSGSCH=P(9),PSGST=$P($G(PSGZZND),"^",5),PSGDRG=$P($G(P("PD")),"^"),PSGS0Y=P(11)
"RTN","PSJUTL",188,0)
 ;BHW - PSJ*5*177 Add call to check stop date.  If it's in the past, Display Message
"RTN","PSJUTL",189,0)
 D CHKSTOP
"RTN","PSJUTL",190,0)
 D EFDNEW
"RTN","PSJUTL",191,0)
 W !
"RTN","PSJUTL",192,0)
 Q
"RTN","PSJUTL",193,0)
EFDDISP ;Display Expected First Dose
"RTN","PSJUTL",194,0)
 N Y
"RTN","PSJUTL",195,0)
 Q:$G(PSGST)="OC"!($G(PSGST)="P")
"RTN","PSJUTL",196,0)
 Q:$G(PSGSCH)["ON CALL"!($G(PSGSCH)["ON-CALL")!($G(PSGSCH)["ONCALL")
"RTN","PSJUTL",197,0)
 Q:$G(PSGSCH)["PRN"
"RTN","PSJUTL",198,0)
 I '$L($G(PSGP)) N PSGP S PSGP=""
"RTN","PSJUTL",199,0)
 ;
"RTN","PSJUTL",200,0)
 S Y=$$ENQ^PSJORP2(PSGP,INFO)
"RTN","PSJUTL",201,0)
 I 'Y S Y="Unable to Calculate"
"RTN","PSJUTL",202,0)
 X ^DD("DD")
"RTN","PSJUTL",203,0)
 W !,"Expected First Dose: ",Y H 2
"RTN","PSJUTL",204,0)
 Q
"RTN","PSJUTL",205,0)
CHKSTOP ;BHW - PSJ*5*177 Warn user if the Stop Date is < now.
"RTN","PSJUTL",206,0)
 I '+$G(P(3)) Q
"RTN","PSJUTL",207,0)
 N PSNOW,%,%H,%I,X D NOW^%DTC S PSNOW=%
"RTN","PSJUTL",208,0)
 I +P(3)<PSNOW D  Q
"RTN","PSJUTL",209,0)
 . W !,$C(7),"The Stop Date/Time is in the Past!!!  This order will",!,"automatically EXPIRE upon Verification!!",!
"RTN","PSJUTL",210,0)
 . Q
"RTN","PSJUTL",211,0)
 Q
"VER")
8.0^22.0
"BLD",6810,6)
^159
**END**
**END**
