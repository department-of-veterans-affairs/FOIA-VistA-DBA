Released IB*2*247 SEQ #241
Extracted from mail message
**KIDS**:IB*2.0*247^

**INSTALL NAME**
IB*2.0*247
"BLD",4627,0)
IB*2.0*247^INTEGRATED BILLING^0^3040310^y
"BLD",4627,1,0)
^^1^1^3031016^
"BLD",4627,1,1,0)
COMBAT VETERAN PHASE II
"BLD",4627,4,0)
^9.64PA^^
"BLD",4627,"INIT")
POST^IB20P247
"BLD",4627,"KRN",0)
^9.67PA^8989.52^19
"BLD",4627,"KRN",.4,0)
.4
"BLD",4627,"KRN",.401,0)
.401
"BLD",4627,"KRN",.402,0)
.402
"BLD",4627,"KRN",.403,0)
.403
"BLD",4627,"KRN",.5,0)
.5
"BLD",4627,"KRN",.84,0)
.84
"BLD",4627,"KRN",3.6,0)
3.6
"BLD",4627,"KRN",3.8,0)
3.8
"BLD",4627,"KRN",9.2,0)
9.2
"BLD",4627,"KRN",9.8,0)
9.8
"BLD",4627,"KRN",9.8,"NM",0)
^9.68A^13^13
"BLD",4627,"KRN",9.8,"NM",1,0)
IBAMTS^^0^B15917567
"BLD",4627,"KRN",9.8,"NM",2,0)
IBAMTS1^^0^B22333609
"BLD",4627,"KRN",9.8,"NM",3,0)
IBAMTS2^^0^B9672528
"BLD",4627,"KRN",9.8,"NM",4,0)
IBARX1^^0^B21141555
"BLD",4627,"KRN",9.8,"NM",5,0)
IBECEAU5^^0^B22121415
"BLD",4627,"KRN",9.8,"NM",6,0)
IBOVOP2^^0^B13589783
"BLD",4627,"KRN",9.8,"NM",7,0)
IBTRED^^0^B21734876
"BLD",4627,"KRN",9.8,"NM",8,0)
IBTRKR41^^0^B11942598
"BLD",4627,"KRN",9.8,"NM",9,0)
IBTUBO1^^0^B33781772
"BLD",4627,"KRN",9.8,"NM",10,0)
IB20P247^^0^B15681267
"BLD",4627,"KRN",9.8,"NM",11,0)
IBTRKR3^^0^B25993216
"BLD",4627,"KRN",9.8,"NM",12,0)
IBAMTI^^0^B27257826
"BLD",4627,"KRN",9.8,"NM",13,0)
IBACV^^0^B8127705
"BLD",4627,"KRN",9.8,"NM","B","IB20P247",10)

"BLD",4627,"KRN",9.8,"NM","B","IBACV",13)

"BLD",4627,"KRN",9.8,"NM","B","IBAMTI",12)

"BLD",4627,"KRN",9.8,"NM","B","IBAMTS",1)

"BLD",4627,"KRN",9.8,"NM","B","IBAMTS1",2)

"BLD",4627,"KRN",9.8,"NM","B","IBAMTS2",3)

"BLD",4627,"KRN",9.8,"NM","B","IBARX1",4)

"BLD",4627,"KRN",9.8,"NM","B","IBECEAU5",5)

"BLD",4627,"KRN",9.8,"NM","B","IBOVOP2",6)

"BLD",4627,"KRN",9.8,"NM","B","IBTRED",7)

"BLD",4627,"KRN",9.8,"NM","B","IBTRKR3",11)

"BLD",4627,"KRN",9.8,"NM","B","IBTRKR41",8)

"BLD",4627,"KRN",9.8,"NM","B","IBTUBO1",9)

"BLD",4627,"KRN",19,0)
19
"BLD",4627,"KRN",19,"NM",0)
^9.68A^^
"BLD",4627,"KRN",19.1,0)
19.1
"BLD",4627,"KRN",101,0)
101
"BLD",4627,"KRN",409.61,0)
409.61
"BLD",4627,"KRN",771,0)
771
"BLD",4627,"KRN",870,0)
870
"BLD",4627,"KRN",8989.51,0)
8989.51
"BLD",4627,"KRN",8989.52,0)
8989.52
"BLD",4627,"KRN",8994,0)
8994
"BLD",4627,"KRN","B",.4,.4)

"BLD",4627,"KRN","B",.401,.401)

"BLD",4627,"KRN","B",.402,.402)

"BLD",4627,"KRN","B",.403,.403)

"BLD",4627,"KRN","B",.5,.5)

"BLD",4627,"KRN","B",.84,.84)

"BLD",4627,"KRN","B",3.6,3.6)

"BLD",4627,"KRN","B",3.8,3.8)

"BLD",4627,"KRN","B",9.2,9.2)

"BLD",4627,"KRN","B",9.8,9.8)

"BLD",4627,"KRN","B",19,19)

"BLD",4627,"KRN","B",19.1,19.1)

"BLD",4627,"KRN","B",101,101)

"BLD",4627,"KRN","B",409.61,409.61)

"BLD",4627,"KRN","B",771,771)

"BLD",4627,"KRN","B",870,870)

"BLD",4627,"KRN","B",8989.51,8989.51)

"BLD",4627,"KRN","B",8989.52,8989.52)

"BLD",4627,"KRN","B",8994,8994)

"BLD",4627,"QUES",0)
^9.62^^
"BLD",4627,"REQB",0)
^9.611^6^6
"BLD",4627,"REQB",1,0)
IB*2.0*171^2
"BLD",4627,"REQB",2,0)
IB*2.0*159^2
"BLD",4627,"REQB",3,0)
IB*2.0*174^2
"BLD",4627,"REQB",4,0)
IB*2.0*160^2
"BLD",4627,"REQB",5,0)
IB*2.0*234^2
"BLD",4627,"REQB",6,0)
DG*5.3*576^2
"BLD",4627,"REQB","B","DG*5.3*576",6)

"BLD",4627,"REQB","B","IB*2.0*159",2)

"BLD",4627,"REQB","B","IB*2.0*160",4)

"BLD",4627,"REQB","B","IB*2.0*171",1)

"BLD",4627,"REQB","B","IB*2.0*174",3)

"BLD",4627,"REQB","B","IB*2.0*234",5)

"INIT")
POST^IB20P247
"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^2^1
"PKG",200,20,2,0)
2^^IBAXDR
"PKG",200,20,2,1)

"PKG",200,20,"B",2,2)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
247^3040310^123456830
"PKG",200,22,1,"PAH",1,1,0)
^^1^1^3040310
"PKG",200,22,1,"PAH",1,1,1,0)
COMBAT VETERAN PHASE II
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
13
"RTN","IB20P247")
0^10^B15681267
"RTN","IB20P247",1,0)
IB20P247 ;WOIFO/SS - POST INIT ROUTINE FOR IB*2*247 ;6-OCT-03
"RTN","IB20P247",2,0)
 ;;2.0;INTEGRATED BILLING;**247**;21-MAR-94
"RTN","IB20P247",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IB20P247",4,0)
 ;
"RTN","IB20P247",5,0)
 Q
"RTN","IB20P247",6,0)
POST ; adding charge removal reason entries if not there
"RTN","IB20P247",7,0)
 N IBX,IBT,IBY,X,Y,DIC,DO
"RTN","IB20P247",8,0)
 D ADDCRR
"RTN","IB20P247",9,0)
 D ADDNBR
"RTN","IB20P247",10,0)
 Q
"RTN","IB20P247",11,0)
 ;
"RTN","IB20P247",12,0)
ADDCRR ; need to add charge removal reasons
"RTN","IB20P247",13,0)
 N IBX,IBT,IBY,DIC,Y,X
"RTN","IB20P247",14,0)
 F IBX=1:1 S IBY=$P($T(CRR+IBX),";",3,99) Q:IBY=""  S IBT=$P(IBY,";") I '$O(^IBE(350.3,"B",IBT,0)) K DO D
"RTN","IB20P247",15,0)
 . S DIC="^IBE(350.3,",DIC(0)="",X=IBT,DIC("DR")=$P(IBY,";",2,3)
"RTN","IB20P247",16,0)
 . D FILE^DICN I Y>0 D BMES^XPDUTL("  --> Added Charge Removal Reasons: "_IBT)
"RTN","IB20P247",17,0)
 Q
"RTN","IB20P247",18,0)
 ;
"RTN","IB20P247",19,0)
ADDNBR ; need to add non billable reasons
"RTN","IB20P247",20,0)
 F IBX=1:1 S IBT=$P($T(NBR+IBX),";",3) Q:IBT=""  I '$O(^IBE(356.8,"B",IBT,0)) K DO D
"RTN","IB20P247",21,0)
 . S DIC="^IBE(356.8,",DIC(0)="",X=IBT
"RTN","IB20P247",22,0)
 . D FILE^DICN I Y>0 D BMES^XPDUTL("  --> Added Reason Not Billable: "_IBT)
"RTN","IB20P247",23,0)
 Q
"RTN","IB20P247",24,0)
 ;
"RTN","IB20P247",25,0)
CRR ; charge removal reasons to add in #350.3
"RTN","IB20P247",26,0)
 ;;COMBAT VETERAN;.02///CV;.03///GENERIC
"RTN","IB20P247",27,0)
 ;;
"RTN","IB20P247",28,0)
NBR ; non-billable reasons to add in #356.8 if not there
"RTN","IB20P247",29,0)
 ;;HEAD/NECK CANCER
"RTN","IB20P247",30,0)
 ;;COMBAT VETERAN
"RTN","IB20P247",31,0)
 ;;
"RTN","IB20P247",32,0)
 ;
"RTN","IB20P247",33,0)
 ;-------- report for CV expiration date problem
"RTN","IB20P247",34,0)
RPT ;
"RTN","IB20P247",35,0)
 I '$$PATCH^XPDUTL("DG*5.3*576") W !,"The patch DG*5.3*576 needs to be installed to run the report." Q
"RTN","IB20P247",36,0)
 K ^TMP("DGCVEX",$J),^TMP("IBCVEX",$J)
"RTN","IB20P247",37,0)
 D EN^DGCVEXP
"RTN","IB20P247",38,0)
 N IBDFN,IBDT,IBNNN
"RTN","IB20P247",39,0)
 S IBNNN=0
"RTN","IB20P247",40,0)
 S IBDFN=0 F  S IBDFN=$O(^TMP("DGCVEX",$J,IBDFN)) Q:+IBDFN=0  D
"RTN","IB20P247",41,0)
 . S IBDT=0 F  S IBDT=$O(^TMP("DGCVEX",$J,IBDFN,IBDT)) Q:+IBDT=0  D COUNTIN(IBDFN,IBDT,.IBNNN)
"RTN","IB20P247",42,0)
 D PRINTREP(IBNNN)
"RTN","IB20P247",43,0)
 K ^TMP("DGCVEX",$J),^TMP("IBCVEX",$J)
"RTN","IB20P247",44,0)
 Q
"RTN","IB20P247",45,0)
 ;--------
"RTN","IB20P247",46,0)
 ;IBDF - patient's DFN
"RTN","IB20P247",47,0)
 ;IBD - the last date of CV
"RTN","IB20P247",48,0)
COUNTIN(IBDF,IBD,IBNN) ;
"RTN","IB20P247",49,0)
 ;3rd party claims
"RTN","IB20P247",50,0)
 N IBIEN,IBRVDT,IB1,IBTO,IBFR,IBI,IBK
"RTN","IB20P247",51,0)
 S IBIEN=0 F  S IBIEN=$O(^DGCR(399,"C",IBDF,IBIEN)) Q:+IBIEN=0  D
"RTN","IB20P247",52,0)
 . S IB1=$G(^DGCR(399,IBIEN,0))
"RTN","IB20P247",53,0)
 . Q:+$P(IB1,"^",5)=0  ;no care type
"RTN","IB20P247",54,0)
 . S IBTO=+$P($G(^DGCR(399,IBIEN,"U")),"^",2),IBFR=+$G(^DGCR(399,IBIEN,"U"))
"RTN","IB20P247",55,0)
 . ;outpatients
"RTN","IB20P247",56,0)
 . I $P(IB1,"^",5)>2 D:IBD=IBFR SETTMP(IBDF,IBD,IBIEN,1,.IBNN) Q
"RTN","IB20P247",57,0)
 . ;inpatients
"RTN","IB20P247",58,0)
 . I (IBD'<IBFR) I IBTO=0!(IBD'>IBTO) D SETTMP(IBDF,IBD,IBIEN,2,.IBNN)
"RTN","IB20P247",59,0)
 ;1st party copays
"RTN","IB20P247",60,0)
 S IBIEN=0 F  S IBIEN=$O(^IB("C",IBDF,IBIEN)) Q:+IBIEN=0  D
"RTN","IB20P247",61,0)
 . S IB1=$G(^IB(IBIEN,0)),IBFR=+$P(IB1,"^",14),IBTO=+$P(IB1,"^",15)
"RTN","IB20P247",62,0)
 . I (IBD'<IBFR),(IBD'>IBTO) D SETTMP(IBDF,IBD,IBIEN,3,.IBNN)
"RTN","IB20P247",63,0)
 Q
"RTN","IB20P247",64,0)
 ;--------
"RTN","IB20P247",65,0)
 ; print report
"RTN","IB20P247",66,0)
PRINTREP(IBNN) ;
"RTN","IB20P247",67,0)
 N IBDFN,IBDT,IB1,IBN
"RTN","IB20P247",68,0)
 D HEADER
"RTN","IB20P247",69,0)
 S IBDFN=0 F  S IBDFN=$O(^TMP("IBCVEX",$J,IBDFN)) Q:+IBDFN=0  D
"RTN","IB20P247",70,0)
 . S IBDT=0 F  S IBDT=$O(^TMP("IBCVEX",$J,IBDFN,IBDT)) Q:+IBDT=0  D
"RTN","IB20P247",71,0)
 .. S IBN=0 F  S IBN=$O(^TMP("IBCVEX",$J,IBDFN,IBDT,IBN)) Q:+IBN=0  D OUTP(IBDFN,IBDT,$G(^TMP("IBCVEX",$J,IBDFN,IBDT,IBN)))
"RTN","IB20P247",72,0)
 D FOOTER(IBNN)
"RTN","IB20P247",73,0)
 Q
"RTN","IB20P247",74,0)
 ;--------
"RTN","IB20P247",75,0)
 ;set ^TMP
"RTN","IB20P247",76,0)
SETTMP(IBDFN,IBDT,IBIEN1,IBTYP,IBNUM) ;
"RTN","IB20P247",77,0)
 S IBNUM=IBNUM+1,^TMP("IBCVEX",$J,IBDFN,IBDT,IBNUM)=IBTYP_"^"_IBIEN1
"RTN","IB20P247",78,0)
 Q
"RTN","IB20P247",79,0)
OUTP(IBDFN,IBDT,IBDATA) ;
"RTN","IB20P247",80,0)
 Q:$G(IBDATA)=""
"RTN","IB20P247",81,0)
 N Y S Y=$$PATINFO(IBDFN)
"RTN","IB20P247",82,0)
 W !,$P(Y,"^"),?30,$P(Y,"^",2),?43,$$STRDATE(IBDT),?55,$E($$BILLINFO(IBDATA),1,18)
"RTN","IB20P247",83,0)
 Q
"RTN","IB20P247",84,0)
 ;--------
"RTN","IB20P247",85,0)
 ;billing info
"RTN","IB20P247",86,0)
BILLINFO(IBDATA) ;
"RTN","IB20P247",87,0)
 I +IBDATA=3 Q $P($P($G(^IB(+$P(IBDATA,"^",2),0)),"^",11),"-",2)_" PATIENT"
"RTN","IB20P247",88,0)
 Q $P($G(^DGCR(399,+$P(IBDATA,"^",2),0)),"^")_" INSURANCE"
"RTN","IB20P247",89,0)
 ;--------
"RTN","IB20P247",90,0)
 ;Fileman date to String format
"RTN","IB20P247",91,0)
 ;Y - fileman date
"RTN","IB20P247",92,0)
STRDATE(Y) ;
"RTN","IB20P247",93,0)
 I Y>0 X ^DD("DD") Q Y
"RTN","IB20P247",94,0)
 Q ""
"RTN","IB20P247",95,0)
 ;--------
"RTN","IB20P247",96,0)
 ;patient info
"RTN","IB20P247",97,0)
PATINFO(DFN) ;
"RTN","IB20P247",98,0)
 I +$G(DFN)=0 Q "??"
"RTN","IB20P247",99,0)
 N VADM,VA,VAERR
"RTN","IB20P247",100,0)
 D DEM^VADPT
"RTN","IB20P247",101,0)
 Q $E($G(VADM(1)),1,28)_"^"_$P($G(VADM(2)),"^",2)
"RTN","IB20P247",102,0)
 ;
"RTN","IB20P247",103,0)
 ;--------
"RTN","IB20P247",104,0)
HEADER ;header
"RTN","IB20P247",105,0)
 W !,"...Please wait..."
"RTN","IB20P247",106,0)
 W !,?15,">> CV Billing Verification Report <<"
"RTN","IB20P247",107,0)
 D LINE
"RTN","IB20P247",108,0)
 W !,"Name",?30,"SSN",?43,"Date",?55,"Bill #"
"RTN","IB20P247",109,0)
 D LINE
"RTN","IB20P247",110,0)
 Q
"RTN","IB20P247",111,0)
 ;--------
"RTN","IB20P247",112,0)
FOOTER(IBNNN) ;footer
"RTN","IB20P247",113,0)
 D LINE
"RTN","IB20P247",114,0)
 W !,"Total: "_IBNNN_" bills/copays"
"RTN","IB20P247",115,0)
 Q
"RTN","IB20P247",116,0)
 ;--------
"RTN","IB20P247",117,0)
LINE ;line
"RTN","IB20P247",118,0)
 W !,"-----------------------------",?30,"------------",?43,"-----------",?55,"------------------"
"RTN","IB20P247",119,0)
 Q
"RTN","IB20P247",120,0)
 ;
"RTN","IBACV")
0^13^B8127705
"RTN","IBACV",1,0)
IBACV ;WOIFO/SS-COMBAT VET UTILITIES ;7-AUG-03
"RTN","IBACV",2,0)
 ;;2.0;INTEGRATED BILLING;**234,247**;21-MAR-94
"RTN","IBACV",3,0)
 ;; Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBACV",4,0)
 ;
"RTN","IBACV",5,0)
 ;To replace CL^SDCO21 with CL^IBACV that wraps out both CL^SDCO21 and $$CVEDT^DGCV
"RTN","IBACV",6,0)
CL(IBDFN,IBSDDT,IBSDOE,IBSDCLY) ;Build Classification Array
"RTN","IBACV",7,0)
 ; Input  -- DFN      Patient file IEN  
"RTN","IBACV",8,0)
 ;   SDDT     Date/Time [Optional]
"RTN","IBACV",9,0)
 ;   SDOE     Outpatient Encounter file IEN  [Optional]
"RTN","IBACV",10,0)
 ; Output -- SDCLY    Classification Array
"RTN","IBACV",11,0)
 ;    Subscripted by Class. Type file (#409.41) IEN
"RTN","IBACV",12,0)
 ;
"RTN","IBACV",13,0)
 ;To replace CL^SDCO21 with CL^IBACV that wraps out both CL^SDCO21 and $$CVEDT^DGCV
"RTN","IBACV",14,0)
 D CL^SDCO21(IBDFN,$G(IBSDDT),$G(IBSDOE),.IBSDCLY)
"RTN","IBACV",15,0)
 S:+$$CVEDT(IBDFN,$G(IBSDDT))=1 IBSDCLY(7)=""
"RTN","IBACV",16,0)
 Q
"RTN","IBACV",17,0)
 ;
"RTN","IBACV",18,0)
 ;returns CV status as:
"RTN","IBACV",19,0)
 ; current_CV_status^end_date^if_ever_had_CV_status
"RTN","IBACV",20,0)
CVEDT(IBDFN,IBDT)       ;
"RTN","IBACV",21,0)
 N IBRET S IBRET=$$CVEDT^DGCV($G(IBDFN),$G(IBDT))
"RTN","IBACV",22,0)
 Q (+$P(IBRET,"^",3))_"^"_(+$P(IBRET,"^",2))_"^"_(+$P(IBRET,"^",1))  ;swop
"RTN","IBACV",23,0)
 ;
"RTN","IBACV",24,0)
 ;/**
"RTN","IBACV",25,0)
 ;Return the classification description of code sets for #.03 in #351.2.
"RTN","IBACV",26,0)
 ;  Input:
"RTN","IBACV",27,0)
 ; X  --  Patient class [1-ao|2-ir|3-ec|4-sc|5-mst|6-hnc|7-cv]
"RTN","IBACV",28,0)
 ; IBCASE -- "M" - mixed case (the first letter is uppercase and others-lowercase)
"RTN","IBACV",29,0)
PATTYPE(X,IBCASE) ; */
"RTN","IBACV",30,0)
 N IBZ
"RTN","IBACV",31,0)
 S IBZ=$S(X=1:"AGENT ORANGE",X=2:"IONIZING RADIATION",X=3:"ENVIRONMENTAL CONTAMINANT",X=4:"SERVICE CONNECTED",X=5:"MILITARY SEXUAL TRAUMA",X=6:"HEAD/NECK CANCER",X=7:"COMBAT VETERAN",1:"SPECIAL")
"RTN","IBACV",32,0)
 Q:$G(IBCASE)="M" $$LOWER^VALM1(IBZ)
"RTN","IBACV",33,0)
 Q IBZ
"RTN","IBACV",34,0)
 ;
"RTN","IBACV",35,0)
 ;if Combat Vet sends e-mail to mailgroup "IB COMBAT VET RX COPAY"
"RTN","IBACV",36,0)
 ;IBDFN-patient IEN, IBDT - date, IBRXPTR - pointer to #52 file to get prescription #
"RTN","IBACV",37,0)
RXALRT(IBDFN,IBDT,IBRXPTR) ;
"RTN","IBACV",38,0)
 N IB1
"RTN","IBACV",39,0)
 S IB1=$$CVEDT(IBDFN,$G(IBDT))
"RTN","IBACV",40,0)
 I +IB1 D EMAIL(IBDFN,$G(IBDT),$P(IB1,"^",2),$G(IBRXPTR))
"RTN","IBACV",41,0)
 Q
"RTN","IBACV",42,0)
 ;sends e-mail to mail group IB COMBAT VET RX COPAY
"RTN","IBACV",43,0)
EMAIL(DFN,IBEFDT,IBEXPDT,IBRX) ;
"RTN","IBACV",44,0)
 N IBTODAY,IBPAT,IBT,IBSSN
"RTN","IBACV",45,0)
 N XMSUB,XMY,XMTEXT,XMDUZ
"RTN","IBACV",46,0)
 N Y D NOW^%DTC S Y=%\1 X ^DD("DD") S IBTODAY=Y
"RTN","IBACV",47,0)
 I +$G(DFN)>0 D
"RTN","IBACV",48,0)
 . N VADM,VA,VAERR
"RTN","IBACV",49,0)
 . D DEM^VADPT
"RTN","IBACV",50,0)
 . S IBPAT=$G(VADM(1))
"RTN","IBACV",51,0)
 . S IBSSN=$P($G(VADM(2)),"^",2)
"RTN","IBACV",52,0)
 S IBRX=$P($G(^PSRX(+$G(IBRX),0)),"^",1) ;get RX number
"RTN","IBACV",53,0)
 S:IBPAT="" IBPAT="Unknown"
"RTN","IBACV",54,0)
 S XMSUB="COMBAT VET RX COPAY REVIEW NEEDED"
"RTN","IBACV",55,0)
 S XMY("G.IB COMBAT VET RX COPAY")=""
"RTN","IBACV",56,0)
 S XMTEXT="IBT(",XMDUZ="INTEGRATED BILLING PACKAGE"
"RTN","IBACV",57,0)
 S IBT(1,0)="PATIENT: "_IBPAT
"RTN","IBACV",58,0)
 I $G(IBEXPDT)>0 S Y=IBEXPDT X ^DD("DD") S IBT(1,0)=IBT(1,0)_"  COMBAT VET until: "_Y
"RTN","IBACV",59,0)
 S IBT(2,0)="SSN: "_IBSSN
"RTN","IBACV",60,0)
 S IBT(3,0)=""
"RTN","IBACV",61,0)
 S IBT(4,0)=$S(IBRX'="":"RX#: "_IBRX,1:"")
"RTN","IBACV",62,0)
 S IBT(5,0)="RX RELEASE DATE: "_IBTODAY
"RTN","IBACV",63,0)
 S IBT(6,0)=""
"RTN","IBACV",64,0)
 S IBT(7,0)="The above patient has a Combat Veteran status. Please review this"
"RTN","IBACV",65,0)
 S IBT(8,0)="prescription to determine if the RX Copay charge should be cancelled."
"RTN","IBACV",66,0)
 S IBT(9,0)=""
"RTN","IBACV",67,0)
 D ^XMD
"RTN","IBACV",68,0)
 Q
"RTN","IBACV",69,0)
 ;
"RTN","IBACV",70,0)
 ;
"RTN","IBAMTI")
0^12^B27257826
"RTN","IBAMTI",1,0)
IBAMTI ;ALB/CPM - SPECIAL INPATIENT BILLING CASES ; 11-AUG-93
"RTN","IBAMTI",2,0)
 ;;2.0;INTEGRATED BILLING;**52,132,153,156,234,247**;21-MAR-94
"RTN","IBAMTI",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBAMTI",4,0)
 ;
"RTN","IBAMTI",5,0)
ADM(DFN,IBPM,IBCL) ; Create a new case record upon admission
"RTN","IBAMTI",6,0)
 ;  Input:     DFN  --  Pointer to the patient in file #2
"RTN","IBAMTI",7,0)
 ;            IBPM  --  Pointer to the adm movement in file #405
"RTN","IBAMTI",8,0)
 ;            IBCL  --  Patient class [1-ao|2-ir|3-sc|4-ec|5-mst|6-hnc|7-cv]
"RTN","IBAMTI",9,0)
 I '$G(DFN)!'$G(IBPM)!'$G(IBCL) G ADMQ
"RTN","IBAMTI",10,0)
 N DA,DIC,DIE,DR,IBC,X,Y
"RTN","IBAMTI",11,0)
 ;
"RTN","IBAMTI",12,0)
 ; - need to swap the input of 3 (SC) to 4, and 4 (EC) to 3
"RTN","IBAMTI",13,0)
 S IBCL=$S(IBCL=3:4,IBCL=4:3,IBCL=5:5,1:IBCL)
"RTN","IBAMTI",14,0)
 ;
"RTN","IBAMTI",15,0)
 K DD,DO S DIC="^IBE(351.2,",DIC(0)="",X=DFN D FILE^DICN S IBC=+Y
"RTN","IBAMTI",16,0)
 S DR=".02////"_IBPM_";.03////"_IBCL_";.05////1;2.01////"_DUZ_";2.02///NOW;2.03////"_DUZ_";2.04///NOW"
"RTN","IBAMTI",17,0)
 S DA=IBC,DIE=DIC D ^DIE
"RTN","IBAMTI",18,0)
 D BULL(1,IBCL) ; send admission bulletin
"RTN","IBAMTI",19,0)
ADMQ Q
"RTN","IBAMTI",20,0)
 ;
"RTN","IBAMTI",21,0)
DIS(IBPM) ; Update the case record upon discharge
"RTN","IBAMTI",22,0)
 ;  Input:    IBPM  --  Pointer to the adm movement in file #405
"RTN","IBAMTI",23,0)
 N DA,DIE,DR,IBC
"RTN","IBAMTI",24,0)
 S IBC=$O(^IBE(351.2,"AC",+$G(IBPM),0)) I 'IBC G DISQ
"RTN","IBAMTI",25,0)
 S DR=".05////2;.06////"_DT_";2.03////"_DUZ_";2.04///NOW"
"RTN","IBAMTI",26,0)
 S DA=IBC,DIE="^IBE(351.2," D ^DIE
"RTN","IBAMTI",27,0)
 D BULL(2,+$P($G(^IBE(351.2,IBC,0)),"^",3)) ; send discharge bulletin
"RTN","IBAMTI",28,0)
DISQ Q
"RTN","IBAMTI",29,0)
 ;
"RTN","IBAMTI",30,0)
BGJ ; Perform nightly background monitoring of all case records.
"RTN","IBAMTI",31,0)
 N IBC,IBCD,IBNUM
"RTN","IBAMTI",32,0)
 S IBC=0 F  S IBC=$O(^IBE(351.2,IBC)) Q:'IBC  S IBCD=$G(^(IBC,0)) D
"RTN","IBAMTI",33,0)
 .Q:$P(IBCD,"^",8)  ; case has been dispositioned
"RTN","IBAMTI",34,0)
 .Q:$P(IBCD,"^",5)=1  ; patient still admitted
"RTN","IBAMTI",35,0)
 .I '$P(IBCD,"^",6) S $P(^IBE(351.2,IBC,0),"^",6)=DT Q  ; no disch date
"RTN","IBAMTI",36,0)
 .S IBNUM=$$FMDIFF^XLFDT(DT,$P(IBCD,"^",6))
"RTN","IBAMTI",37,0)
 .Q:IBNUM<45  ; still time to disposition the case
"RTN","IBAMTI",38,0)
 .D NOTICE(IBNUM,+IBCD,+$P(IBCD,"^",2),+$P(IBCD,"^",3)) ; send reminder to disposition
"RTN","IBAMTI",39,0)
 Q
"RTN","IBAMTI",40,0)
 ;
"RTN","IBAMTI",41,0)
BULL(IBEV,IBCL) ; Send a bulletin at admission and discharge.
"RTN","IBAMTI",42,0)
 ;  Input:    IBEV  --  Event [1:admission|2:discharge]
"RTN","IBAMTI",43,0)
 ;            IBCL  --  Patient class [1-ao|2-ir|3-ec|4-sc|5-mst|6-hnc|7-cv]
"RTN","IBAMTI",44,0)
 K IBT S IBPT=$$PT^IBEFUNC(DFN)
"RTN","IBAMTI",45,0)
 S XMSUB=$E($P(IBPT,"^"),1,14)_"  "_$P(IBPT,"^",3)_" - "_$$UCCL(IBCL)_$S($G(IBEV)=1:" ADM",1:" DISCH")
"RTN","IBAMTI",46,0)
 S IBT(1)="The following Means Test copay "_$$LCCL(IBCL)_" patient was just "_$S($G(IBEV)=1:"admitted:",1:"discharged:")
"RTN","IBAMTI",47,0)
 S IBT(2)=" " S IBC=2
"RTN","IBAMTI",48,0)
 S IBDUZ=DUZ D PAT^IBAERR1
"RTN","IBAMTI",49,0)
 S IBC=IBC+1,IBT(IBC)=" "
"RTN","IBAMTI",50,0)
 S IBC=IBC+1,IBT(IBC)=$S($G(IBEV)=1:"Please note that a special inpatient case record has been created for",1:"Please note that you have 45 days to determine if this episode of care")
"RTN","IBAMTI",51,0)
 S IBC=IBC+1,IBT(IBC)=$S($G(IBEV)=1:"this admission.",1:"should be billed.")
"RTN","IBAMTI",52,0)
 ;---CV
"RTN","IBAMTI",53,0)
 I IBCL=7,$G(IBEV)=2 D 
"RTN","IBAMTI",54,0)
 . N Y,X,IBZ,IBFL,IBEXP,IBTODAY,IBDIS
"RTN","IBAMTI",55,0)
 . S (Y,X,IBZ,IBFL,IBEXP,IBTODAY,IBDIS)=0
"RTN","IBAMTI",56,0)
 . D NOW^%DTC S IBTODAY=%\1
"RTN","IBAMTI",57,0)
 . S IBZ=$$CVEDT^IBACV(DFN,IBTODAY)
"RTN","IBAMTI",58,0)
 . I +IBZ=1 Q  ;patient is still CV
"RTN","IBAMTI",59,0)
 . S IBEXP=+$P(IBZ,"^",2)\1
"RTN","IBAMTI",60,0)
 . S IBDIS=+$G(^DGPM(+$P($G(^DGPM(+$G(IBPM),0)),"^",17),0))\1
"RTN","IBAMTI",61,0)
 . ; if CV expired during inpatient stay
"RTN","IBAMTI",62,0)
 . I IBDIS>0,IBEXP'>IBDIS D
"RTN","IBAMTI",63,0)
 . . S IBFL=1
"RTN","IBAMTI",64,0)
 . . S Y=IBEXP D DD^%DT S IBEXP=Y
"RTN","IBAMTI",65,0)
 . . S IBC=IBC+1,IBT(IBC)=""
"RTN","IBAMTI",66,0)
 . . S IBC=IBC+1,IBT(IBC)="WARNING: Patient's CV status has expired on "_IBEXP_" during the"
"RTN","IBAMTI",67,0)
 . . S IBC=IBC+1,IBT(IBC)="inpatient stay. Billing needs to be adjusted accordingly."
"RTN","IBAMTI",68,0)
 . ; if discharge move was entered after actual discharge date
"RTN","IBAMTI",69,0)
 . I IBFL=0 D
"RTN","IBAMTI",70,0)
 . . S Y=IBEXP D DD^%DT S IBEXP=Y
"RTN","IBAMTI",71,0)
 . . S IBC=IBC+1,IBT(IBC)=""
"RTN","IBAMTI",72,0)
 . . S IBC=IBC+1,IBT(IBC)="WARNING: Patient CV status has expired on "_IBEXP_""
"RTN","IBAMTI",73,0)
 ;---
"RTN","IBAMTI",74,0)
 I IBEV=2 D
"RTN","IBAMTI",75,0)
 .I '$$BIL^DGMTUB(DFN,DT) S IBC=IBC+1,IBT(IBC)=" ",IBC=IBC+1,IBT(IBC)="Note: This patient, who was MT copay at admission, is no longer MT billable."
"RTN","IBAMTI",76,0)
 .I $$BFO^IBECEAU(DFN,+$G(^DGPM(IBPM,0))\1) S IBC=IBC+1,IBT(IBC)=" ",IBC=IBC+1,IBT(IBC)="Note: This patient was billed the outpatient copayment at admission."
"RTN","IBAMTI",77,0)
 D SEND^IBACVA2
"RTN","IBAMTI",78,0)
 Q
"RTN","IBAMTI",79,0)
 ;
"RTN","IBAMTI",80,0)
NOTICE(IBNUM,DFN,IBPM,IBCL) ; Notice to disposition billing case
"RTN","IBAMTI",81,0)
 ;  Input:   IBNUM  --  Number of days since discharge
"RTN","IBAMTI",82,0)
 ;             DFN  --  Pointer to the patient in file #2
"RTN","IBAMTI",83,0)
 ;            IBPM  --  Pointer to the admission in file #405
"RTN","IBAMTI",84,0)
 ;            IBCL  --  Patient class [1-ao|2-ir|3-ec|4-sc|5-mst|6-hnc|7-cv]
"RTN","IBAMTI",85,0)
 ;
"RTN","IBAMTI",86,0)
 Q:IBNUM#15  ; send notice every 15 days only
"RTN","IBAMTI",87,0)
 N IBC K IBT S IBPT=$$PT^IBEFUNC(DFN)
"RTN","IBAMTI",88,0)
 S XMSUB="NOTICE TO DISPOSITION SPECIAL INPATIENT BILLING CASE"
"RTN","IBAMTI",89,0)
 S IBT(1)="The case record for this Means Test copay "_$$LCCL(IBCL)_" patient"
"RTN","IBAMTI",90,0)
 S IBT(2)="is now "_IBNUM_" days old and should be dispositioned:"
"RTN","IBAMTI",91,0)
 S IBT(3)=" " S IBC=3
"RTN","IBAMTI",92,0)
 S IBDUZ=DUZ D PAT^IBAERR1
"RTN","IBAMTI",93,0)
 S Y=+$G(^DGPM(+$G(IBPM),0)) D DD^%DT
"RTN","IBAMTI",94,0)
 S IBC=IBC+1,IBT(IBC)=" Adm Date: "_Y
"RTN","IBAMTI",95,0)
 S Y=+$G(^DGPM(+$P($G(^DGPM(+$G(IBPM),0)),"^",17),0)) D DD^%DT
"RTN","IBAMTI",96,0)
 S IBC=IBC+1,IBT(IBC)="Disc Date: "_Y
"RTN","IBAMTI",97,0)
 S IBC=IBC+1,IBT(IBC)=" "
"RTN","IBAMTI",98,0)
 S IBC=IBC+1,IBT(IBC)="Please determine if this episode of care should be billed, and use"
"RTN","IBAMTI",99,0)
 S IBC=IBC+1,IBT(IBC)="the Cancel/Edit/Add Patient Charges option to add charges, or the"
"RTN","IBAMTI",100,0)
 S IBC=IBC+1,IBT(IBC)="Disposition Special Inpatient Billing Cases option to enter the reason"
"RTN","IBAMTI",101,0)
 S IBC=IBC+1,IBT(IBC)="for not billing."
"RTN","IBAMTI",102,0)
 D SEND^IBACVA2
"RTN","IBAMTI",103,0)
 Q
"RTN","IBAMTI",104,0)
 ;
"RTN","IBAMTI",105,0)
UCCL(X) ; Return the upper case classification description.
"RTN","IBAMTI",106,0)
 ;  Input:       X  --  Patient class [1-ao|2-ir|3-ec|4-sc|5-mst|6-hnc|7-cv]
"RTN","IBAMTI",107,0)
 Q $S('$G(X):"SPECIAL",1:$$PATTYPE^IBACV(X))
"RTN","IBAMTI",108,0)
 ;
"RTN","IBAMTI",109,0)
LCCL(X) ; Return the lower case classification description.
"RTN","IBAMTI",110,0)
 ;  Input:       X  --  Patient class [1-ao|2-ir|3-ec|4-sc|5-mst|6-hnc|7-cv]
"RTN","IBAMTI",111,0)
 Q $S('$G(X):"Special",1:$$PATTYPE^IBACV(X,"M"))
"RTN","IBAMTI",112,0)
 ;
"RTN","IBAMTS")
0^1^B15917567
"RTN","IBAMTS",1,0)
IBAMTS ;ALB/CPM - APPOINTMENT EVENT DRIVER INTERFACE ; 20-JUL-93
"RTN","IBAMTS",2,0)
 ;;2.0;INTEGRATED BILLING;**52,115,132,153,164,156,171,247**;21-MAR-94
"RTN","IBAMTS",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBAMTS",4,0)
 ;
"RTN","IBAMTS",5,0)
EN ; Main interface entry point.
"RTN","IBAMTS",6,0)
 ;
"RTN","IBAMTS",7,0)
 S IBJOB=5,IBWHER="",IBDUZ=DUZ,IBY=1
"RTN","IBAMTS",8,0)
 ; Do Transfer Pricing
"RTN","IBAMTS",9,0)
 D ^IBATEO
"RTN","IBAMTS",10,0)
 ; Check Encounter Related to LTC
"RTN","IBAMTS",11,0)
 N IBALTC D EN^IBAECO
"RTN","IBAMTS",12,0)
 I '$$BILST^DGMTUB(DFN) G ENQ ; never Means Test billable
"RTN","IBAMTS",13,0)
 I '$$CHECK^IBECEAU(0) D ^IBAERR1 G ENQ ; can't set vital parameters
"RTN","IBAMTS",14,0)
 ;
"RTN","IBAMTS",15,0)
 ; - process all parent outpatient encounters
"RTN","IBAMTS",16,0)
 S IBORG=0 F  S IBORG=$O(^TMP("SDEVT",$J,SDHDL,IBORG)) Q:'IBORG  D
"RTN","IBAMTS",17,0)
 .S IBOE=0 F  S IBOE=$O(^TMP("SDEVT",$J,SDHDL,IBORG,"SDOE",IBOE)) Q:'IBOE  S IBEVT=$G(^(IBOE,0,"AFTER")),IBEV0=$G(^("BEFORE")) D
"RTN","IBAMTS",18,0)
 ..S IBDT=$S(IBEVT:+IBEVT,1:+IBEV0),IBDAT=$P(IBDT,".")
"RTN","IBAMTS",19,0)
 ..S IBAPTY=$S(IBEVT:$P(IBEVT,"^",10),1:$P(IBEV0,"^",10))
"RTN","IBAMTS",20,0)
 ..S IBBILLED=$$BFO^IBECEAU(DFN,IBDAT),IBY=1
"RTN","IBAMTS",21,0)
 ..;
"RTN","IBAMTS",22,0)
 ..; - if C&P encounter, cancel charges for the day and quit
"RTN","IBAMTS",23,0)
 ..I IBAPTY=1!(IBALTC) D:IBBILLED  Q
"RTN","IBAMTS",24,0)
 ...S IBCRES=+$O(^IBE(350.3,"B",$S(IBALTC:"BILLED LTC CHARGE",1:"COMP & PENSION VISIT RECORDED"),0))
"RTN","IBAMTS",25,0)
 ...S:'IBCRES IBCRES=23 S IBWHER=""
"RTN","IBAMTS",26,0)
 ...D CANCH^IBECEAU4(IBBILLED,IBCRES,0)
"RTN","IBAMTS",27,0)
 ..;
"RTN","IBAMTS",28,0)
 ..; - quit if there are any C&P encounters on the visit date
"RTN","IBAMTS",29,0)
 ..Q:$$CNP^IBECEAU(DFN,IBDAT)
"RTN","IBAMTS",30,0)
 ..;
"RTN","IBAMTS",31,0)
 ..; - quit if there are any LTC encounters on the visit date
"RTN","IBAMTS",32,0)
 ..Q:$$LTCENC^IBAECU(DFN,IBDAT)
"RTN","IBAMTS",33,0)
 ..;
"RTN","IBAMTS",34,0)
 ..; - don't process child events
"RTN","IBAMTS",35,0)
 ..I IBEVT]"" Q:$P(IBEVT,"^",6)
"RTN","IBAMTS",36,0)
 ..I IBEVT="",IBEV0]"" Q:$P(IBEV0,"^",6)
"RTN","IBAMTS",37,0)
 ..;
"RTN","IBAMTS",38,0)
 ..; - get statuses
"RTN","IBAMTS",39,0)
 ..S IBAST=+$P(IBEVT,"^",12),IBBST=+$P(IBEV0,"^",12)
"RTN","IBAMTS",40,0)
 ..;
"RTN","IBAMTS",41,0)
 ..; - do either NEW or UPDATED processing
"RTN","IBAMTS",42,0)
 ..I IBAST=2,IBBST'=2 D NEW^IBAMTS1 Q
"RTN","IBAMTS",43,0)
 ..D UPD^IBAMTS2
"RTN","IBAMTS",44,0)
 ;
"RTN","IBAMTS",45,0)
ENQ K IBJOB,IBWHER,IBORG,IBOE,IBEVT,IBEV0,IBAST,IBBST,IBDUZ,IBY
"RTN","IBAMTS",46,0)
 K IBDT,IBDAT,IBAPTY,IBBILLED,IBSERV,IBSITE,IBFAC,IBCRES,IBRTED
"RTN","IBAMTS",47,0)
 Q
"RTN","IBAMTS",48,0)
 ;
"RTN","IBAMTS",49,0)
BULL ; Send bulletin when classified patients are billed stops which
"RTN","IBAMTS",50,0)
 ; are exempt from the classification process.
"RTN","IBAMTS",51,0)
 N IBT,IBC,IBPT,IBDUZ,IBX S IBPT=$$PT^IBEFUNC(DFN),IBX=$$CLTY
"RTN","IBAMTS",52,0)
 S XMSUB="CHARGE FOR STOP CODE EXEMPT FROM CLASSIFICATION"
"RTN","IBAMTS",53,0)
 S IBT(1)="The following patient, who "_$S(IBX="SC":"has a service connected disability,",IBX="CV":"is Combat Veteran",1:"has claimed exposure to "_IBX_",")
"RTN","IBAMTS",54,0)
 S IBT(2)="was billed the Means Test outpatient copay for a stop code which is"
"RTN","IBAMTS",55,0)
 S IBT(3)="exempt from classification:"
"RTN","IBAMTS",56,0)
 S IBT(4)=" " S IBC=4
"RTN","IBAMTS",57,0)
 S IBDUZ=DUZ D PAT^IBAERR1
"RTN","IBAMTS",58,0)
 S Y=IBDAT D DD^%DT
"RTN","IBAMTS",59,0)
 S IBC=IBC+1,IBT(IBC)="Stop Date: "_Y
"RTN","IBAMTS",60,0)
 S IBC=IBC+1,IBT(IBC)="Stop Code: "_$P($G(^DIC(40.7,+$P(IBEVT,"^",3),0)),"^")
"RTN","IBAMTS",61,0)
 S IBC=IBC+1,IBT(IBC)=" "
"RTN","IBAMTS",62,0)
 S IBC=IBC+1,IBT(IBC)="Please check this patient's medical record to determine if the care provided"
"RTN","IBAMTS",63,0)
 S IBC=IBC+1,IBT(IBC)="was related to the "_$S(IBX="SC":"SC disability",IBX="CV":"Combat Veteran status",1:"claimed exposure")_", and, if related, cancel the charge."
"RTN","IBAMTS",64,0)
 D MAIL^IBAERR1
"RTN","IBAMTS",65,0)
 K X,Y,XMSUB,XMY,XMTEXT,XMDUZ
"RTN","IBAMTS",66,0)
 Q
"RTN","IBAMTS",67,0)
 ;
"RTN","IBAMTS",68,0)
CLTY() ; Return the classification type
"RTN","IBAMTS",69,0)
 N IBARR,Y D CL^SDCO21(DFN,IBDAT,"",.IBARR) S Y=""
"RTN","IBAMTS",70,0)
 I $D(IBARR(3)) S Y="SC" G CLTYQ
"RTN","IBAMTS",71,0)
 I $D(IBARR(7)),+$$CVEDT^IBACV(DFN,IBDAT) S Y="CV" G CLTYQ
"RTN","IBAMTS",72,0)
 I $D(IBARR(1)) S Y="Agent Orange" G CLTYQ
"RTN","IBAMTS",73,0)
 I $D(IBARR(2)) S Y="Ionizing Radiation" G CLTYQ
"RTN","IBAMTS",74,0)
 I $D(IBARR(4)) S Y="Environmental Contaminants" G CLTYQ
"RTN","IBAMTS",75,0)
 I $D(IBARR(5)) S Y="Military Sexual Trauma" G CLTYQ
"RTN","IBAMTS",76,0)
 I $D(IBARR(6)) S Y="Head/Neck Cancer" G CLTYQ
"RTN","IBAMTS",77,0)
CLTYQ Q Y
"RTN","IBAMTS1")
0^2^B22333609
"RTN","IBAMTS1",1,0)
IBAMTS1 ;ALB/CPM - PROCESS NEW OUTPATIENT ENCOUNTERS ; 22-JUL-93
"RTN","IBAMTS1",2,0)
 ;;2.0;INTEGRATED BILLING;**20,52,132,153,166,156,167,247**;21-MAR-94
"RTN","IBAMTS1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBAMTS1",4,0)
 ;
"RTN","IBAMTS1",5,0)
NEW ; Appointment fully processed - prepare a new charge.
"RTN","IBAMTS1",6,0)
 ;
"RTN","IBAMTS1",7,0)
 ;  ibbilled is set to 1 if the patient has already been billed on this
"RTN","IBAMTS1",8,0)
 ;  date.  if the date is after 12/5/01, check the type of bill to see
"RTN","IBAMTS1",9,0)
 ;  if it is an upgrade from primary (1st bill) to specialty (new bill)
"RTN","IBAMTS1",10,0)
 I IBBILLED D:IBDAT'<3011206 CHKPRIM I IBBILLED G NEWQ
"RTN","IBAMTS1",11,0)
 ;
"RTN","IBAMTS1",12,0)
 ; - for registrations, get disposition, and use log-out date/time
"RTN","IBAMTS1",13,0)
 I IBORG=3 D  G:'IBDISP NEWQ
"RTN","IBAMTS1",14,0)
 .S IBDISP=+$P($G(^TMP("SDEVT",$J,SDHDL,IBORG,"DIS",0,"AFTER")),"^",7)
"RTN","IBAMTS1",15,0)
 .Q:'IBDISP
"RTN","IBAMTS1",16,0)
 .S IBTEMP=+$P($G(^TMP("SDEVT",$J,SDHDL,IBORG,"DIS",0,"AFTER")),"^",6)
"RTN","IBAMTS1",17,0)
 .S:IBTEMP IBDT=IBTEMP,IBDAT=$P(IBDT,".")
"RTN","IBAMTS1",18,0)
 ;
"RTN","IBAMTS1",19,0)
 I '$$BIL^DGMTUB(DFN,IBDT) G NEWQ ; patient is not Means Test billable
"RTN","IBAMTS1",20,0)
 ;
"RTN","IBAMTS1",21,0)
 ; - perform batch of edits
"RTN","IBAMTS1",22,0)
 I '$$CHKS G NEWQ
"RTN","IBAMTS1",23,0)
 ;
"RTN","IBAMTS1",24,0)
 ; - quit if AO/IR/EC/MST/HNC/CV exposure is indicated, or SC related
"RTN","IBAMTS1",25,0)
 D CLSF(0,.IBCLSF)
"RTN","IBAMTS1",26,0)
 I IBCLSF[1 G NEWQ
"RTN","IBAMTS1",27,0)
 ;
"RTN","IBAMTS1",28,0)
 S IBSL="409.68:"_IBOE
"RTN","IBAMTS1",29,0)
 ;
"RTN","IBAMTS1",30,0)
BLD ; - build the charge. May also enter from IBAMTS2 (requires IBSL)
"RTN","IBAMTS1",31,0)
 ;
"RTN","IBAMTS1",32,0)
 ;  find the clinic stop code in 409.68 (dbia402) and find the matching
"RTN","IBAMTS1",33,0)
 ;  entry in file 352.5.  the 352.5 entry is populated in the 350 field
"RTN","IBAMTS1",34,0)
 ;  for reference using the ibstopda variable
"RTN","IBAMTS1",35,0)
 N %,IBSTOPDA,IBTYPE
"RTN","IBAMTS1",36,0)
 S %=$$GETSC^IBEMTSCU(IBSL,IBDAT) I % S IBSTOPDA=%
"RTN","IBAMTS1",37,0)
 ;
"RTN","IBAMTS1",38,0)
 ;  get the rate, ibtype = primary or specialty
"RTN","IBAMTS1",39,0)
 S IBTYPE=$P($G(^IBE(352.5,+$G(IBSTOPDA),0)),"^",3) I IBTYPE=0 Q
"RTN","IBAMTS1",40,0)
 ;  if the type is not defined, must be a local created sc, set it to primary
"RTN","IBAMTS1",41,0)
 I 'IBTYPE S IBTYPE=1
"RTN","IBAMTS1",42,0)
 S IBX="O" D TYPE^IBAUTL2 G:IBY<0 NEWQ
"RTN","IBAMTS1",43,0)
 S IBUNIT=1,(IBFR,IBTO)=IBDAT,IBEVDA="*"
"RTN","IBAMTS1",44,0)
 D ADD^IBECEAU3 G:IBY<0 NEWQ
"RTN","IBAMTS1",45,0)
 ;
"RTN","IBAMTS1",46,0)
 ; - if enctr is exempt from classification, but patient isn't, send msg
"RTN","IBAMTS1",47,0)
 I $$EXOE^SDCOU2($S($G(IBOEN):IBOEN,1:IBOE)),$$CLPT(DFN,IBDAT) D BULL^IBAMTS
"RTN","IBAMTS1",48,0)
 ;
"RTN","IBAMTS1",49,0)
 ; - if the opt billing rate is over a year old, place the charge on hold
"RTN","IBAMTS1",50,0)
 ;I $$OLDRATE(IBRTED,IBFR) D  G CLOCK
"RTN","IBAMTS1",51,0)
 ;.S DIE="^IB(",DA=IBN,DR=".05////20" D ^DIE K DIE,DA,DR
"RTN","IBAMTS1",52,0)
 ;
"RTN","IBAMTS1",53,0)
 ; - drop the charge into the background filer
"RTN","IBAMTS1",54,0)
 D IBFLR G:IBY<0 NEWQ
"RTN","IBAMTS1",55,0)
 ;
"RTN","IBAMTS1",56,0)
 ; - if there is no active billing clock, add one
"RTN","IBAMTS1",57,0)
CLOCK I '$D(^IBE(351,"ACT",DFN)) S IBCLDT=IBDAT D CLADD^IBAUTL3
"RTN","IBAMTS1",58,0)
 ;
"RTN","IBAMTS1",59,0)
NEWQ I IBY<0 D ^IBAERR1
"RTN","IBAMTS1",60,0)
 K IBDISP,IBCLSF,IBCLDA,IBMED,IBCLDT,IBN,IBBS,IBTEMP
"RTN","IBAMTS1",61,0)
 K IBUNIT,IBFR,IBTO,IBSL,IBEVDA,IBX,IBDESC,IBATYP,IBCHG
"RTN","IBAMTS1",62,0)
 Q
"RTN","IBAMTS1",63,0)
 ;
"RTN","IBAMTS1",64,0)
CHKS() ; Perform a batch of edits to determine whether to bill.
"RTN","IBAMTS1",65,0)
 ;  Input variables required:   IBEVT  --  encounter
"RTN","IBAMTS1",66,0)
 ;                             IBAPTY  --  appt type
"RTN","IBAMTS1",67,0)
 ;                              IBDAT  --  appt date
"RTN","IBAMTS1",68,0)
 ;                               IBDT  --  appt date/time
"RTN","IBAMTS1",69,0)
 ;                              IBORG  --  originating process
"RTN","IBAMTS1",70,0)
 ;                             IBDISP  --  disposition (if registration)
"RTN","IBAMTS1",71,0)
 N IBRESULT
"RTN","IBAMTS1",72,0)
 ;
"RTN","IBAMTS1",73,0)
 ;  default is fail the checks
"RTN","IBAMTS1",74,0)
 S IBRESULT=0
"RTN","IBAMTS1",75,0)
 ;
"RTN","IBAMTS1",76,0)
 ;  for appts prior to 12/6/2001
"RTN","IBAMTS1",77,0)
 I IBDAT<3011206 D  Q IBRESULT
"RTN","IBAMTS1",78,0)
 .   ; - non-count clinic
"RTN","IBAMTS1",79,0)
 .   I $P($G(^SC(+$P(IBEVT,"^",4),0)),"^",17)="Y" Q
"RTN","IBAMTS1",80,0)
 .   ;
"RTN","IBAMTS1",81,0)
 .   ; - non-billable appointment type
"RTN","IBAMTS1",82,0)
 .   I $$IGN^IBEFUNC(IBAPTY,IBDAT) Q
"RTN","IBAMTS1",83,0)
 .   ;
"RTN","IBAMTS1",84,0)
 .   ; - non-billable disposition/stop code/clinic
"RTN","IBAMTS1",85,0)
 .   I IBORG=1!(IBORG=2),$$NBCL^IBEFUNC(+$P(IBEVT,"^",4),IBDT) Q
"RTN","IBAMTS1",86,0)
 .   I IBORG=1!(IBORG=2),$$NBCSC^IBEFUNC(+$P(IBEVT,"^",3),IBDT) Q
"RTN","IBAMTS1",87,0)
 .   I IBORG=3,$$NBDIS^IBEFUNC(IBDISP,IBDT) Q
"RTN","IBAMTS1",88,0)
 .   ;
"RTN","IBAMTS1",89,0)
 .   ; - ignore if checked out late and pt was an inpatient at midnight
"RTN","IBAMTS1",90,0)
 .   I DT>IBDAT,$$INPT(DFN,IBDAT_".2359") Q
"RTN","IBAMTS1",91,0)
 .   ;
"RTN","IBAMTS1",92,0)
 .   ;  pass the checks
"RTN","IBAMTS1",93,0)
 .   S IBRESULT=1
"RTN","IBAMTS1",94,0)
 ;
"RTN","IBAMTS1",95,0)
 ;  for appts on or after 12/6/2001
"RTN","IBAMTS1",96,0)
 ;
"RTN","IBAMTS1",97,0)
 ; - non-billable appointment type
"RTN","IBAMTS1",98,0)
 I $$IGN^IBEFUNC(IBAPTY,IBDAT) Q 0
"RTN","IBAMTS1",99,0)
 ;
"RTN","IBAMTS1",100,0)
 ; - non-count clinic
"RTN","IBAMTS1",101,0)
 I $P($G(^SC(+$P(IBEVT,"^",4),0)),"^",17)="Y" Q 0
"RTN","IBAMTS1",102,0)
 ;
"RTN","IBAMTS1",103,0)
 ; - ignore if checked out late and pt was an inpatient at midnight
"RTN","IBAMTS1",104,0)
 I DT>IBDAT,$$INPT(DFN,IBDAT_".2359") Q 0
"RTN","IBAMTS1",105,0)
 ;
"RTN","IBAMTS1",106,0)
 ;  pass the checks
"RTN","IBAMTS1",107,0)
 Q 1
"RTN","IBAMTS1",108,0)
 ;
"RTN","IBAMTS1",109,0)
 ;
"RTN","IBAMTS1",110,0)
IBFLR ; Drop the charge into the IB Background filer.
"RTN","IBAMTS1",111,0)
 N IBSEQNO,IBNOS,IBNOW,IBTOTL,IBSERV,IBWHER,IBFAC,IBSITE,IBAFY,IBARTYP,IBIL,IBTRAN
"RTN","IBAMTS1",112,0)
 D NOW^%DTC S IBNOW=%,IBNOS=IBN
"RTN","IBAMTS1",113,0)
 S IBSEQNO=$P($G(^IBE(350.1,+IBATYP,0)),"^",5) I 'IBSEQNO S IBY="-1^IB023"
"RTN","IBAMTS1",114,0)
 I IBY>0 D ^IBAFIL
"RTN","IBAMTS1",115,0)
 Q
"RTN","IBAMTS1",116,0)
 ;
"RTN","IBAMTS1",117,0)
CLPT(DFN,VDATE) ; Should the patient be asked the classification questions?
"RTN","IBAMTS1",118,0)
 ;  Input:     DFN  --  Pointer to the patient in file #2
"RTN","IBAMTS1",119,0)
 ;           VDATE  --  Visit date
"RTN","IBAMTS1",120,0)
 N IBARR D CL^SDCO21(DFN,VDATE,"",.IBARR)
"RTN","IBAMTS1",121,0)
 Q $D(IBARR)>0
"RTN","IBAMTS1",122,0)
 ;
"RTN","IBAMTS1",123,0)
INPT(DFN,VAINDT) ; Was the patient an inpatient at VAINDT?
"RTN","IBAMTS1",124,0)
 ;  Input:     DFN  --  Pointer to the patient in file #2
"RTN","IBAMTS1",125,0)
 ;          VAINDT  --  Date/time to check for inpatient status
"RTN","IBAMTS1",126,0)
 ; Output:       1 - inpatient | 0 - not an inpatient
"RTN","IBAMTS1",127,0)
 N VADMVT D ADM^VADPT2
"RTN","IBAMTS1",128,0)
 Q VADMVT>0
"RTN","IBAMTS1",129,0)
 ;
"RTN","IBAMTS1",130,0)
CLSF(IBUPD,Y) ; Examine classification questions.
"RTN","IBAMTS1",131,0)
 ;  Input:   IBUPD  --  0 if event just checked out
"RTN","IBAMTS1",132,0)
 ;                      1 if event is being updated
"RTN","IBAMTS1",133,0)
 ;               Y  --  array to place output
"RTN","IBAMTS1",134,0)
 ;  Output:  indicators returned as  ao^ir^sc^ec^mst^hnc^CV [1|yes, 0|no]
"RTN","IBAMTS1",135,0)
 ;             if IBUPD=0, Y is returned as a single string
"RTN","IBAMTS1",136,0)
 ;             if IBUPD=1, Y("BEFORE"),Y("AFTER") are defined.
"RTN","IBAMTS1",137,0)
 N X,ZA,ZB S:'$G(IBUPD) Y="" S:$G(IBUPD) (Y("BEFORE"),Y("AFTER"))=""
"RTN","IBAMTS1",138,0)
 S X=0 F  S X=$O(^TMP("SDEVT",$J,SDHDL,IBORG,"SDOE",IBOE,"CL",X)) Q:'X  S ZB=$G(^(X,0,"BEFORE")),ZA=$G(^("AFTER")) D
"RTN","IBAMTS1",139,0)
 .I '$G(IBUPD) S:ZA $P(Y,"^",+ZA)=+$P(ZA,"^",3) Q
"RTN","IBAMTS1",140,0)
 .S $P(Y("BEFORE"),"^",+ZB)=+$P(ZB,"^",3),$P(Y("AFTER"),"^",+ZA)=+$P(ZA,"^",3)
"RTN","IBAMTS1",141,0)
 Q
"RTN","IBAMTS1",142,0)
 ;
"RTN","IBAMTS1",143,0)
OLDRATE(IBRTED,IBFR) ; See if the copay rate effective date is too old.
"RTN","IBAMTS1",144,0)
 ;  Input:   IBRTED  --  Charge Effective Date
"RTN","IBAMTS1",145,0)
 ;             IBFR  --  Visit Date
"RTN","IBAMTS1",146,0)
 ;  Output:       1  --  Effective Date is too old
"RTN","IBAMTS1",147,0)
 ;                0  --  Not
"RTN","IBAMTS1",148,0)
 ;
"RTN","IBAMTS1",149,0)
 N IBNUM,IBYR
"RTN","IBAMTS1",150,0)
 S IBNUM=$$FMDIFF^XLFDT(IBFR,IBRTED),IBYR=$E(IBFR,1,3)
"RTN","IBAMTS1",151,0)
 Q IBYR#4&(IBNUM>364)!(IBYR#4=0&(IBNUM>365))
"RTN","IBAMTS1",152,0)
 ;
"RTN","IBAMTS1",153,0)
 ;
"RTN","IBAMTS1",154,0)
CHKPRIM ;  check to see if patient has been billed for primary
"RTN","IBAMTS1",155,0)
 ;  and this is a specialty stop.  if so, cancel the primary
"RTN","IBAMTS1",156,0)
 ;  bill and let the software create the new specialty charge
"RTN","IBAMTS1",157,0)
 ;  input ibbilled  = last parent bill to check (ien 350)
"RTN","IBAMTS1",158,0)
 ;                    used to check the rate
"RTN","IBAMTS1",159,0)
 ;  output ibbilled = last parent bill number to prevent
"RTN","IBAMTS1",160,0)
 ;                    adding specialty charge
"RTN","IBAMTS1",161,0)
 N %,IBSTOPDA,IBTYPE,IBCRES,IBI,IBS
"RTN","IBAMTS1",162,0)
 ;
"RTN","IBAMTS1",163,0)
 ;  get the stop code for the 2nd visit on the same day
"RTN","IBAMTS1",164,0)
 S IBSTOPDA=$$GETSC^IBEMTSCU("409.68:"_IBOE,IBDAT) I 'IBSTOPDA Q
"RTN","IBAMTS1",165,0)
 ;
"RTN","IBAMTS1",166,0)
 ;  get the rate, ibtype = primary or specialty
"RTN","IBAMTS1",167,0)
 S IBTYPE=$P(^IBE(352.5,IBSTOPDA,0),"^",3)
"RTN","IBAMTS1",168,0)
 ;  if the new appt is not specialty, quit ... no need to create
"RTN","IBAMTS1",169,0)
 ;  a new charge
"RTN","IBAMTS1",170,0)
 I IBTYPE'=2 Q
"RTN","IBAMTS1",171,0)
 ;
"RTN","IBAMTS1",172,0)
 ;  if the last charge was billed at specialty, quit
"RTN","IBAMTS1",173,0)
 I $P($G(^IBE(352.5,+$P($G(^IB(+IBBILLED,0)),"^",20),0)),"^",3)=2 Q
"RTN","IBAMTS1",174,0)
 ;
"RTN","IBAMTS1",175,0)
 ;  cancel the charge
"RTN","IBAMTS1",176,0)
 ;  cancellation reason = billed at higher tier rate
"RTN","IBAMTS1",177,0)
 S IBCRES=6,IBS=$P($G(^IB(+IBBILLED,0)),"^",5)
"RTN","IBAMTS1",178,0)
 ;
"RTN","IBAMTS1",179,0)
 ; if not billed, on hold, or cacelled wait
"RTN","IBAMTS1",180,0)
 I IBS'=3!(IBS'=8)!(IBS'=10) F IBI=1:1:10 H 1 S IBS=$P($G(^IB(+IBBILLED,0)),"^",5) I IBS=3!(IBS=8)!(IBS=10) Q
"RTN","IBAMTS1",181,0)
 ;
"RTN","IBAMTS1",182,0)
 D CANC^IBAMTS2
"RTN","IBAMTS1",183,0)
 ;
"RTN","IBAMTS1",184,0)
 ;  set ibbilled = 0 to create the specialty charge
"RTN","IBAMTS1",185,0)
 S IBBILLED=0
"RTN","IBAMTS1",186,0)
 Q
"RTN","IBAMTS2")
0^3^B9672528
"RTN","IBAMTS2",1,0)
IBAMTS2 ;ALB/CPM - PROCESS UPDATED OUTPATIENT ENCOUNTERS ; 25-AUG-93
"RTN","IBAMTS2",2,0)
 ;;2.0;INTEGRATED BILLING;**52,91,117,132,153,156,167,247**;21-MAR-94
"RTN","IBAMTS2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBAMTS2",4,0)
 ;
"RTN","IBAMTS2",5,0)
UPD ; Perform encounter update actions.
"RTN","IBAMTS2",6,0)
 N IBCBK,IBFILTER,IBVAL
"RTN","IBAMTS2",7,0)
 ;
"RTN","IBAMTS2",8,0)
 ; - was check out deleted?
"RTN","IBAMTS2",9,0)
 I IBAST'=2,IBBST=2 S IBCRES=$S(IBAST=8:5,1:1)
"RTN","IBAMTS2",10,0)
 ;
"RTN","IBAMTS2",11,0)
 ; - see if checked out appt classifications were changed
"RTN","IBAMTS2",12,0)
 I IBAST=2,IBBST=2 D CLSF^IBAMTS1(1,.IBCLSF) S IBACT=$$CLUPD() G:'IBACT UPDQ D  I IBACT'=1 G UPDQ
"RTN","IBAMTS2",13,0)
 .I IBACT=1 S IBCRES=2 Q
"RTN","IBAMTS2",14,0)
 .I IBACT=2 N IBCLSF D NEW^IBAMTS1
"RTN","IBAMTS2",15,0)
 ;
"RTN","IBAMTS2",16,0)
 ; - cancel charge if there is a cancellation reason, and the billed
"RTN","IBAMTS2",17,0)
 ; - charge was for the appointment that is no longer billable
"RTN","IBAMTS2",18,0)
 I '$G(IBCRES) G UPDQ
"RTN","IBAMTS2",19,0)
 I '$$LINK(IBOE,$S(IBEVT:IBEVT,1:IBEV0),IBBILLED) G UPDQ
"RTN","IBAMTS2",20,0)
 D CANC G:IBY<0 UPDQ
"RTN","IBAMTS2",21,0)
 ;
"RTN","IBAMTS2",22,0)
 ; - look for other billable visits if Means Test billable
"RTN","IBAMTS2",23,0)
 I '$$BIL^DGMTUB(DFN,IBDT) G UPDQ
"RTN","IBAMTS2",24,0)
 S IBBILLED=0
"RTN","IBAMTS2",25,0)
 ;
"RTN","IBAMTS2",26,0)
 S IBVAL("DFN")=DFN,IBVAL("BDT")=IBDAT-.1,IBVAL("EDT")=IBDAT_.99
"RTN","IBAMTS2",27,0)
 S IBFILTER=""
"RTN","IBAMTS2",28,0)
 ; Skip encounter just cancelled,
"RTN","IBAMTS2",29,0)
 ;  consider only parent encounters, appts checked out
"RTN","IBAMTS2",30,0)
 S IBCBK="I Y'=IBOE,'$P(Y0,U,6),$P(Y0,U,12)=2 D BEDIT^IBAMTS2(Y,Y0) S:IBBILLED SDSTOP=1"
"RTN","IBAMTS2",31,0)
 D SCAN^IBSDU("PATIENT/DATE",.IBVAL,IBFILTER,IBCBK,1) K ^TMP("DIERR",$J)
"RTN","IBAMTS2",32,0)
 ;
"RTN","IBAMTS2",33,0)
UPDQ K IBCLSF,IBACT,IBC,IBOEN,IBEVT
"RTN","IBAMTS2",34,0)
 Q
"RTN","IBAMTS2",35,0)
 ;
"RTN","IBAMTS2",36,0)
BEDIT(IBOEN,IBEVT) ; - perform batch edit
"RTN","IBAMTS2",37,0)
 I $P(IBEVT,U,10)=1 S UNBILLED=1 Q  ; C&P exam -- stop looking
"RTN","IBAMTS2",38,0)
 S IBORG=+$P(IBEVT,U,8),IBAPTY=+$P(IBEVT,U,10)
"RTN","IBAMTS2",39,0)
 I IBORG=3 S IBDISP=+$$DISND^IBSDU(IBOEN,IBEVT,7) Q:'IBDISP
"RTN","IBAMTS2",40,0)
 Q:'$$CHKS^IBAMTS1
"RTN","IBAMTS2",41,0)
 ;
"RTN","IBAMTS2",42,0)
 ; - check classifications
"RTN","IBAMTS2",43,0)
 S IBCLSF=$$ENCL(IBOEN)
"RTN","IBAMTS2",44,0)
 I IBCLSF[1 Q  ; care was related to ao/ir/ec/sc/mst/hnc/cv
"RTN","IBAMTS2",45,0)
 S IBSL="409.68:"_IBOEN ; set softlink
"RTN","IBAMTS2",46,0)
 ;
"RTN","IBAMTS2",47,0)
 ; - ready to bill another encounter
"RTN","IBAMTS2",48,0)
 D BLD^IBAMTS1 S IBBILLED=1
"RTN","IBAMTS2",49,0)
 Q
"RTN","IBAMTS2",50,0)
 ;
"RTN","IBAMTS2",51,0)
CRES ; List of cancellation reasons
"RTN","IBAMTS2",52,0)
 ;;CHECK OUT DELETED
"RTN","IBAMTS2",53,0)
 ;;CLASSIFICATION CHANGED
"RTN","IBAMTS2",54,0)
 ;;MT OP APPT NO-SHOW
"RTN","IBAMTS2",55,0)
 ;;MT OP APPT CANCELLED
"RTN","IBAMTS2",56,0)
 ;;RECD INPATIENT CARE
"RTN","IBAMTS2",57,0)
 ;;BILLED AT HIGHER TIER RATE
"RTN","IBAMTS2",58,0)
 ;
"RTN","IBAMTS2",59,0)
LINK(IBOE,IBEVT,IBN) ; Was the billed charge for the current appointment?
"RTN","IBAMTS2",60,0)
 ;  Input:     IBOE  --  Pointer to outpatient encounter in file #409.68
"RTN","IBAMTS2",61,0)
 ;            IBEVT  --  Zeroth node of encounter in file #409.68
"RTN","IBAMTS2",62,0)
 ;              IBN  --  Pointer to charge in file #350
"RTN","IBAMTS2",63,0)
 ;  Output:       0  --  Charge was not for current appointment
"RTN","IBAMTS2",64,0)
 ;                1  --  Charge was for current appointment
"RTN","IBAMTS2",65,0)
 N IBSL,Y
"RTN","IBAMTS2",66,0)
 I '$G(IBOE)!'$G(IBEVT)!'$G(IBN) G LINKQ
"RTN","IBAMTS2",67,0)
 S IBSL=$P($G(^IB(IBN,0)),"^",4)
"RTN","IBAMTS2",68,0)
 I +IBSL=44 S Y=$P(IBSL,";",1,2)=("44:"_$P(IBEVT,"^",4)_";S:"_+IBEVT) G LINKQ
"RTN","IBAMTS2",69,0)
 I +IBSL=409.68 S Y=IBSL=("409.68:"_IBOE)
"RTN","IBAMTS2",70,0)
LINKQ Q +$G(Y)
"RTN","IBAMTS2",71,0)
 ;
"RTN","IBAMTS2",72,0)
CLUPD() ; Examine changes in the classification.
"RTN","IBAMTS2",73,0)
 ;  Output:    0  --  no changes
"RTN","IBAMTS2",74,0)
 ;             1  --  changes require charges to be cancelled
"RTN","IBAMTS2",75,0)
 ;             2  --  changes require appt to be billed
"RTN","IBAMTS2",76,0)
 ;             3  --  [ec] cancel charge, create deferred charge
"RTN","IBAMTS2",77,0)
 ;             4  --  [ec] pass deferred charge, disposition case
"RTN","IBAMTS2",78,0)
 N I,Y S Y=0
"RTN","IBAMTS2",79,0)
 I IBCLSF("BEFORE")=IBCLSF("AFTER") G CLUPDQ
"RTN","IBAMTS2",80,0)
 F I=1,2,3,4,5,6,7 I '$P(IBCLSF("BEFORE"),U,I),$P(IBCLSF("AFTER"),U,I) S Y=$S(I=4:3,1:1) G CLUPDQ
"RTN","IBAMTS2",81,0)
 F I=1,2,3,4,5,6,7 I $P(IBCLSF("BEFORE"),U,I),'$P(IBCLSF("AFTER"),U,I) S Y=$S(I=4:4,1:2) Q
"RTN","IBAMTS2",82,0)
CLUPDQ Q Y
"RTN","IBAMTS2",83,0)
 ;
"RTN","IBAMTS2",84,0)
CANC ; Determine cancellation reason and cancel charge
"RTN","IBAMTS2",85,0)
 ;  Input variables:   IBCRES  --  Code for reason to be determined
"RTN","IBAMTS2",86,0)
 ;                   IBBILLED  --  Charge to be cancelled
"RTN","IBAMTS2",87,0)
 S IBCRES=$P($T(CRES+IBCRES),";;",2),IBCRES=+$O(^IBE(350.3,"B",IBCRES,0))
"RTN","IBAMTS2",88,0)
 D CANCH^IBECEAU4(IBBILLED,IBCRES)
"RTN","IBAMTS2",89,0)
 Q
"RTN","IBAMTS2",90,0)
 ;
"RTN","IBAMTS2",91,0)
ENCL(IBOE) ; Return classification results for an encounter.
"RTN","IBAMTS2",92,0)
 ;  Input:    IBOE  --  Pointer to outpatient encounter in file #409.68
"RTN","IBAMTS2",93,0)
 ;  Output:   ao^ir^sc^ec^mst^hnc^cv, where, for each piece,
"RTN","IBAMTS2",94,0)
 ;                      1 - care was related to condition, and
"RTN","IBAMTS2",95,0)
 ;                      0 (or null) - care not related to condition
"RTN","IBAMTS2",96,0)
 N CL,CLD,X,Y S Y=""
"RTN","IBAMTS2",97,0)
 S CL=0 F  S CL=$O(^SDD(409.42,"OE",+$G(IBOE),CL)) Q:'CL  S CLD=$G(^SDD(409.42,CL,0)) I CLD S $P(Y,U,+CLD)=+$P(CLD,U,3)
"RTN","IBAMTS2",98,0)
 Q Y
"RTN","IBARX1")
0^4^B21141555
"RTN","IBARX1",1,0)
IBARX1 ;ALB/AAS - INTEGRATED BILLING, PHARMACY COPAY INTERFACE (CONT.) ;21-FEB-91
"RTN","IBARX1",2,0)
 ;;2.0;INTEGRATED BILLING;**34,101,150,158,156,234,247**;21-MAR-94
"RTN","IBARX1",3,0)
 ;;Per VHA Directive 10-93-142 ;This routine should not be modified.
"RTN","IBARX1",4,0)
 ;
"RTN","IBARX1",5,0)
 ;  - process 1 rx entry and accumulate totals
"RTN","IBARX1",6,0)
 ;
"RTN","IBARX1",7,0)
RX N IBAM,IBNOCH
"RTN","IBARX1",8,0)
 ;if Combat Vet send alert e-mail to mailgroup "IB COMBAT VET RX COPAY"
"RTN","IBARX1",9,0)
 D
"RTN","IBARX1",10,0)
 . N Y D NOW^%DTC S Y=%\1
"RTN","IBARX1",11,0)
 . D RXALRT^IBACV(DFN,Y,+$P($P($G(IBSAVX(1)),"^",1),":",2))
"RTN","IBARX1",12,0)
 ;
"RTN","IBARX1",13,0)
 I $P(IBX,"^")'?1.N1":"1.N.ANP S Y="-1^IB012" G RXQ
"RTN","IBARX1",14,0)
 I $P(IBX,"^",2)<1 S Y="-1^IB013" G RXQ
"RTN","IBARX1",15,0)
 ;
"RTN","IBARX1",16,0)
 D BDESC
"RTN","IBARX1",17,0)
 ;
"RTN","IBARX1",18,0)
 S DA=IBATYP D COST^IBAUTL
"RTN","IBARX1",19,0)
 ;
"RTN","IBARX1",20,0)
 ; compute amount above cap
"RTN","IBARX1",21,0)
 D NEW^IBARXMC($P(IBX,"^",2),X1,DT,.IBCHRG,.IBNOCH)
"RTN","IBARX1",22,0)
 ;
"RTN","IBARX1",23,0)
 S IBTCH=$P(IBX,"^",2)*X1
"RTN","IBARX1",24,0)
 ;
"RTN","IBARX1",25,0)
 ; add to 354.71
"RTN","IBARX1",26,0)
 S IBAM=$$ADD^IBARXMN(DFN,"^^"_$S($G(IBEFDT):IBEFDT,1:DT)_"^^P^"_$P(IBX,"^")_"^"_$P(IBX,"^",2)_"^"_IBTCH_"^"_IBDESC_"^"_$S($G(IBAMP):IBAMP,1:"")_"^"_IBCHRG_"^"_IBNOCH_"^"_(+$P($$SITE^IBARXMU,"^",3)),IBATYP) I IBAM<1 S Y="-1^IB316" G RXQ
"RTN","IBARX1",27,0)
 ;
"RTN","IBARX1",28,0)
 ; setup new pieces (4, 5, 6, and 7), quit if above cap
"RTN","IBARX1",29,0)
 S $P(IBSAVY(IBJ),"^",4,7)=$S(IBNOCH:1,1:0)_"^"_$S(IBNOCH&(IBCHRG):"P",IBCHRG:"F",1:"")_"^"_(+$G(IBEXMP))_"^"_IBAM G:'IBCHRG RXQ
"RTN","IBARX1",30,0)
 ;
"RTN","IBARX1",31,0)
 S IBTOTL=IBTOTL+IBCHRG
"RTN","IBARX1",32,0)
 S IBWHER=2
"RTN","IBARX1",33,0)
 D ADD^IBAUTL
"RTN","IBARX1",34,0)
 I +Y<1 G RXQ
"RTN","IBARX1",35,0)
 S IBPARNT=$S($D(IBPARNT):IBPARNT,1:IBN)
"RTN","IBARX1",36,0)
 S $P(^IB(IBN,1),"^",1)=IBDUZ,$P(^IB(IBN,0),"^",2,13)=DFN_"^"_IBATYP_"^"_$P(IBX,"^")_"^2^"_$P(IBX,"^",2)_"^"_IBCHRG_"^"_IBDESC_"^"_IBPARNT_"^^"_IBIL_"^"_IBTRAN_"^"_IBFAC,$P(^(0),"^",19)=IBAM
"RTN","IBARX1",37,0)
 K IBPARNT,^IB("AC",1,IBN) ;S ^IB("AC",2,IBN)=""
"RTN","IBARX1",38,0)
 D INDEX
"RTN","IBARX1",39,0)
 S $P(IBSAVY(IBJ),"^",1,3)=IBN_"^"_IBCHRG_"^"_IBIL
"RTN","IBARX1",40,0)
 S:'$D(IBNOS) IBNOS="" S IBNOS=IBN_"^"_IBNOS
"RTN","IBARX1",41,0)
RXQ Q
"RTN","IBARX1",42,0)
 ;
"RTN","IBARX1",43,0)
CANRX ;  - ibx = ibn for parent entry
"RTN","IBARX1",44,0)
 ;  - ibn = new cancellation entry
"RTN","IBARX1",45,0)
 N IBAM,IBAMY
"RTN","IBARX1",46,0)
 S IBY(IBJ)=1
"RTN","IBARX1",47,0)
 I '$D(^IBE(350.3,+$P(IBX,"^",2),0)) S (Y,IBY(IBJ))="-1^IB020" G CANRXQ
"RTN","IBARX1",48,0)
 I '$D(^IB(+IBX,0)) S (Y,IBY(IBJ))="-1^IB021" G CANRXQ
"RTN","IBARX1",49,0)
 S IBND=^IB(+IBX,0)
"RTN","IBARX1",50,0)
 S IBCRES=$P(IBX,"^",2)
"RTN","IBARX1",51,0)
 ;  -find most recent entry for parent ibx
"RTN","IBARX1",52,0)
 ;  -if status isn't an update or new, error already cancelled?
"RTN","IBARX1",53,0)
 D LAST I IBLAST'=IBPARNT,$D(^IB(IBLAST,0)),$P(^IBE(350.1,$P(^IB(IBLAST,0),"^",3),0),"^",5)=2 S (Y,IBY(IBJ))="-1^IB026^ Ref. No: "_+^IB(+IBLAST,0) G CANRXQ ;already cancelled
"RTN","IBARX1",54,0)
 ;
"RTN","IBARX1",55,0)
 ; cancel 354.71
"RTN","IBARX1",56,0)
 S IBAM=$$CANCEL^IBARXMN(DFN,$P(IBND,"^",19),.IBAMY,IBCRES) I $G(IBAMY)<0 S (Y,IBY(IBJ))=IBAMY G CANRXQ
"RTN","IBARX1",57,0)
 ;
"RTN","IBARX1",58,0)
 I $P(IBND,"^",5)=8 D  QUIT  ;Cancel a charge with a status of HOLD
"RTN","IBARX1",59,0)
 . N DIE,DA,DR
"RTN","IBARX1",60,0)
 . S DIE="^IB(",DA=+IBX,DR=".05////10;.1////"_IBCRES
"RTN","IBARX1",61,0)
 . DO ^DIE
"RTN","IBARX1",62,0)
 . S Y=1,IBY(IBJ)=1,Y(IBJ)=+IBX
"RTN","IBARX1",63,0)
 ;
"RTN","IBARX1",64,0)
 S IBPARNT=$P(IBND,"^",9) I '$D(^IB(IBPARNT,0)) S (Y,IBY(IBJ))="-1^IB027" G CANRXQ
"RTN","IBARX1",65,0)
 S IBATYP=$P(^IBE(350.1,$P(IBND,"^",3),0),"^",6) ;cancellation action type for parent
"RTN","IBARX1",66,0)
 I '$D(^IBE(350.1,+IBATYP,0)) S (Y,IBY(IBJ))="-1^IB022" G CANRXQ
"RTN","IBARX1",67,0)
 S IBSEQNO=$P(^IBE(350.1,+IBATYP,0),"^",5) I 'IBSEQNO S (Y,IBY(IBJ))="-1^IB023" G CANRXQ
"RTN","IBARX1",68,0)
 S IBIL=$P(IBND,"^",11) I IBIL="" S (Y,IBY(IBJ))="-1^IB024" G CANRXQ
"RTN","IBARX1",69,0)
 S IBUNIT=$S($D(^IB(+IBLAST,0)):$P(^(0),"^",6),1:$P(IBND,"^",6)) I IBUNIT<1 S (Y,IBY(IBJ))="-1^IB025" G CANRXQ
"RTN","IBARX1",70,0)
 S IBCHRG=$S($D(^IB(+IBLAST,0)):$P(^(0),"^",7),1:$P(IBND,"^",7)) I IBCHRG<1 S (Y,IBY(IBJ))="-1^IB025" G CANRXQ
"RTN","IBARX1",71,0)
 S IBTOTL=IBTOTL+IBCHRG
"RTN","IBARX1",72,0)
 S IBWHER=2
"RTN","IBARX1",73,0)
 D ADD^IBAUTL I +Y<1 S IBY(IBJ)=Y G CANRXQ
"RTN","IBARX1",74,0)
 S $P(^IB(IBN,1),"^",1)=IBDUZ,$P(^IB(IBN,0),"^",2,13)=DFN_"^"_IBATYP_"^"_$P(IBND,"^",4)_"^2^"_IBUNIT_"^"_IBCHRG_"^"_$P(IBND,"^",8)_"^"_IBPARNT_"^"_IBCRES_"^"_IBIL_"^^"_IBFAC S:IBAM $P(^(0),"^",19)=IBAM
"RTN","IBARX1",75,0)
 K ^IB("AC",1,IBN) ;S ^IB("AC",2,IBN)=""
"RTN","IBARX1",76,0)
 D INDEX
"RTN","IBARX1",77,0)
 S Y(IBJ)=IBN_"^"_IBCHRG_"^"_IBIL
"RTN","IBARX1",78,0)
 S IBNOS=IBN
"RTN","IBARX1",79,0)
CANRXQ Q
"RTN","IBARX1",80,0)
 ;
"RTN","IBARX1",81,0)
BDESC ;  -return brief description
"RTN","IBARX1",82,0)
 N X,Y S IBDESC="",X=$P(IBX,"^")
"RTN","IBARX1",83,0)
 I $D(^IBE(350.1,IBATYP,20)) X ^(20) S IBDESC=X
"RTN","IBARX1",84,0)
 Q
"RTN","IBARX1",85,0)
LAST ;find last entry
"RTN","IBARX1",86,0)
 S IBLAST=""
"RTN","IBARX1",87,0)
 S IBPARNT=$P(^IB(+IBX,0),"^",9) I 'IBPARNT S IBPARNT=+IBX
"RTN","IBARX1",88,0)
 S IBLDT=$O(^IB("APDT",IBPARNT,"")) I +IBLDT F IBL=0:0 S IBL=$O(^IB("APDT",IBPARNT,IBLDT,IBL)) Q:'IBL  S IBLAST=IBL
"RTN","IBARX1",89,0)
 I IBLAST="" S IBLAST=IBPARNT
"RTN","IBARX1",90,0)
 Q
"RTN","IBARX1",91,0)
 ;
"RTN","IBARX1",92,0)
INDEX ;cross-reference entry
"RTN","IBARX1",93,0)
 N X,Y
"RTN","IBARX1",94,0)
 S DA=IBN,DIK="^IB(" D IX^DIK
"RTN","IBARX1",95,0)
 K DIK Q
"RTN","IBARX1",96,0)
 ;
"RTN","IBARX1",97,0)
SERV(Y) ; -- Service check for Pharmacy
"RTN","IBARX1",98,0)
 ;    called by the screen in the input transform for the IB SERVICE/SECTION
"RTN","IBARX1",99,0)
 ;    field of the PHARMACY SITE file.
"RTN","IBARX1",100,0)
 ;    input = Y internal entry number in service section file
"RTN","IBARX1",101,0)
 ;    output = 1 if okay to use (service matches) or 0 if not okay
"RTN","IBARX1",102,0)
 ;
"RTN","IBARX1",103,0)
 ; -- screen logic for field 1003 in file 59 should be 
"RTN","IBARX1",104,0)
 ;    S DIC("S")="I $$SERV^IBARX1(+Y)"
"RTN","IBARX1",105,0)
 ;
"RTN","IBARX1",106,0)
 Q $S('$G(Y):0,1:$D(^IBE(350.1,"ANEW",Y,1,1))&$D(^IBE(350.1,"ANEW",Y,1,2)))
"RTN","IBECEAU5")
0^5^B22121415
"RTN","IBECEAU5",1,0)
IBECEAU5 ;ALB/BGA - Cancel/Edit/Add CALC Observation COPAY ; 17-MAY-2000
"RTN","IBECEAU5",2,0)
 ;;2.0;INTEGRATED BILLING;**132,153,156,167,247**;21-MAR-94
"RTN","IBECEAU5",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBECEAU5",4,0)
 ;
"RTN","IBECEAU5",5,0)
 ; Find the IB action type and outpatient copay rate for an inpatient Observation
"RTN","IBECEAU5",6,0)
 ;
"RTN","IBECEAU5",7,0)
OBS ; Called from EN^IBAMTD when adding an Inpatient Observation Copay
"RTN","IBECEAU5",8,0)
 ; 
"RTN","IBECEAU5",9,0)
 ; Check to see if you have a clock
"RTN","IBECEAU5",10,0)
 I '$G(IBCLDA) S IBCLDT=$P(IBADMDT,".") D CLADD^IBAUTL3 G:IBY<1 END
"RTN","IBECEAU5",11,0)
 ; Calculate Outpatient COPAY Charge return IBATYP,IBCHG,IBDESC,IBRTED
"RTN","IBECEAU5",12,0)
 ; setting IBTYPE=2 to designate all observation is specialty care
"RTN","IBECEAU5",13,0)
 S (IBDT,IBADMDT)=$P(IBADMDT,"."),IBX="O",IBTYPE=2 D CHRG G:IBY<1 END
"RTN","IBECEAU5",14,0)
 ; Set the SOFTLINK field = Admission Movment:405
"RTN","IBECEAU5",15,0)
 S IBSL="405:"_IBA,IBUNIT=1,(IBFR,IBEVDT)=IBADMDT,IBTO=$P(IBDISDT,"."),IBEVDA="*"
"RTN","IBECEAU5",16,0)
 ; Add the charge to ^IB set IBN= new charge's IEN
"RTN","IBECEAU5",17,0)
 D ADD^IBECEAU3 G:IBY<1 END
"RTN","IBECEAU5",18,0)
 ; Pass the charge to AR set IBTRAN and IBIL
"RTN","IBECEAU5",19,0)
 S IBDUZ=DUZ D IBFLR^IBAMTS1
"RTN","IBECEAU5",20,0)
END K IBFR,IBTO,IBTYPE
"RTN","IBECEAU5",21,0)
 Q
"RTN","IBECEAU5",22,0)
 ;
"RTN","IBECEAU5",23,0)
CHRG ; Called from OPT^IBECEA33 when adding a obs copay from CANCEL/EDIT/ADD
"RTN","IBECEAU5",24,0)
 ;
"RTN","IBECEAU5",25,0)
 ;     Input: Optional if no IBDT than default to DT
"RTN","IBECEAU5",26,0)
 ;     Output:  IBATYP, IBCHG, IBDESC, IBRTED
"RTN","IBECEAU5",27,0)
 ;
"RTN","IBECEAU5",28,0)
 I '$D(IBDT) S IBDT=DT
"RTN","IBECEAU5",29,0)
 D TYPE^IBAUTL2 ; Sets IBCHRG=Outpat Copay $ and IBRTED=effective DT of rate
"RTN","IBECEAU5",30,0)
 Q:'IBCHG  ; Error occurred sets IBY in TYPE^IBAUTL2 
"RTN","IBECEAU5",31,0)
 S IBBS=$$MCCRUTL^IBCRU1("OBSERVATION CARE",5)
"RTN","IBECEAU5",32,0)
 S IBATYP=$P($G(^DGCR(399.1,+IBBS,0)),"^",7) I 'IBATYP S IBY="-1^IB008" Q
"RTN","IBECEAU5",33,0)
 I $D(^IBE(350.1,+IBATYP,20)) X ^(20) ; sets IBDESC
"RTN","IBECEAU5",34,0)
 Q
"RTN","IBECEAU5",35,0)
 ;
"RTN","IBECEAU5",36,0)
CLSF(DGMVP) ;
"RTN","IBECEAU5",37,0)
 ; This Subroutine evaluates an Inpatient Admission for an Observation Speciality
"RTN","IBECEAU5",38,0)
 ; where the patient has claimed exposure. The Special Inpatient Billing
"RTN","IBECEAU5",39,0)
 ; case record is evaluated to detemine the status of the disposition
"RTN","IBECEAU5",40,0)
 ; the results are than displayed on the Outpatient Events Reports
"RTN","IBECEAU5",41,0)
 ;
"RTN","IBECEAU5",42,0)
 N DGIEN,DG0,IBDISP,IBOUT,IBREAS,IBTYP
"RTN","IBECEAU5",43,0)
 Q:'DGMVP!('$D(^IBE(351.2,"AC",DGMVP)))  ; no special case record on file
"RTN","IBECEAU5",44,0)
 S DGIEN=0,DGIEN=$O(^IBE(351.2,"AC",DGMVP,DGIEN)) Q:'DGIEN
"RTN","IBECEAU5",45,0)
 S DG0=$G(^IBE(351.2,DGIEN,0)) ; Special Inpatient Billing Case Record
"RTN","IBECEAU5",46,0)
 Q:$P(DG0,U,8)&('$P(DG0,U,7))  ; Case disposed care not related to Condition
"RTN","IBECEAU5",47,0)
 S IBTYP=$P(DG0,U,3)
"RTN","IBECEAU5",48,0)
 S IBTYP=$$UCCL^IBAMTI(IBTYP) S:IBTYP="SPECIAL" IBTYP="SPECIAL CASE"
"RTN","IBECEAU5",49,0)
 S IBOUT="* Patient Claims EPISODE OF CARE related to: "_IBTYP
"RTN","IBECEAU5",50,0)
 I '$P(DG0,U,8) S IBDISP="** STATUS - Case has not been DISPOSITIONED" D PRINT Q
"RTN","IBECEAU5",51,0)
 I $P(DG0,U,8),$P(DG0,U,7) D
"RTN","IBECEAU5",52,0)
 . S IBDISP="** Case has been DIPOSITIONED and Care is NOT BILLABLE"
"RTN","IBECEAU5",53,0)
 . S IBREAS=$G(^IBE(351.2,DGIEN,1,0))
"RTN","IBECEAU5",54,0)
 . D PRINT
"RTN","IBECEAU5",55,0)
 Q
"RTN","IBECEAU5",56,0)
 ;
"RTN","IBECEAU5",57,0)
PRINT ;
"RTN","IBECEAU5",58,0)
 I IBLINE>55 D HDR^IBOVOP2 W !,IBFLD1,!?5,IBFLD2
"RTN","IBECEAU5",59,0)
 I $Y>(IOSL-5) D PAUSE^IBOUTL Q:IBQUIT  D HDR^IBOVOP2 W !,IBFLD1,!?5,IBFLD2
"RTN","IBECEAU5",60,0)
 W !!,?5,IBOUT
"RTN","IBECEAU5",61,0)
 W:$G(IBDISP)]"" !,?5,IBDISP ; Writes the status of the disposition
"RTN","IBECEAU5",62,0)
 I $G(IBREAS)]"" D
"RTN","IBECEAU5",63,0)
 . W !,?5,"Reason Not Billable: ",$E(IBREAS,1,55) ; Writes Reason Not Billed
"RTN","IBECEAU5",64,0)
 Q
"RTN","IBECEAU5",65,0)
 ;
"RTN","IBECEAU5",66,0)
FEE ; This Subroutine permits a Clerk to add a DG FEE SERVICE (OPT)
"RTN","IBECEAU5",67,0)
 ; when the value of the fee for service is less than the normal
"RTN","IBECEAU5",68,0)
 ; Outpatient Copayment.
"RTN","IBECEAU5",69,0)
 ;
"RTN","IBECEAU5",70,0)
 Q:'$G(IBAFEE)!('$G(IBCHG))
"RTN","IBECEAU5",71,0)
 ; Reset ibdesc="DG FEE SERVICE (OPT) NEW", ibatyp=57
"RTN","IBECEAU5",72,0)
 ;  before adding entry from ADD^IBECEAU3 to ^IB
"RTN","IBECEAU5",73,0)
 S IBATYP=IBAFEE I $D(^IBE(350.1,+IBATYP,20)) X ^(20)
"RTN","IBECEAU5",74,0)
 N DIR,X,Y,DIRUT
"RTN","IBECEAU5",75,0)
 S DIR(0)="350,.07",DIR("A")="Fee Amount"
"RTN","IBECEAU5",76,0)
 S DIR("B")=$S(IBCHG?1N.N1"."1N:IBCHG_0,1:IBCHG)
"RTN","IBECEAU5",77,0)
 S DIR("T")=180,DIR("?")=" "
"RTN","IBECEAU5",78,0)
 S DIR("?",1)="     *** The Fee for Service can not be LESS than $1.00 or"
"RTN","IBECEAU5",79,0)
 S DIR("?",2)="     *** GREATER than $"_$S(IBCHG?1N.N1"."1N:IBCHG_0,1:IBCHG)_"."
"RTN","IBECEAU5",80,0)
 D ^DIR I $G(DIRUT) S IBY=-1 Q
"RTN","IBECEAU5",81,0)
 I $G(Y)>50.8!($G(Y)<1) D  G FEE
"RTN","IBECEAU5",82,0)
 . W !,?10,"*** The Fee for Service can not be GREATER than $"_$S(IBCHG?1N.N1"."1N:IBCHG_0,1:IBCHG)
"RTN","IBECEAU5",83,0)
 . W !,?10,"*** AND must be GREATER than $.99==> Please try Again"
"RTN","IBECEAU5",84,0)
 S:$G(Y) IBCHG=Y
"RTN","IBECEAU5",85,0)
 Q
"RTN","IBECEAU5",86,0)
 ;
"RTN","IBECEAU5",87,0)
IBOVOP(IBDATE) ;
"RTN","IBECEAU5",88,0)
 ; This Subroutine expands the functions of the Outpatient Events Report
"RTN","IBECEAU5",89,0)
 ; by adding Inpatient Observation Admissions/Discharges to the the report.
"RTN","IBECEAU5",90,0)
 ; Find Admissions or Discharges Associated with Inpatient Observation
"RTN","IBECEAU5",91,0)
 ; Specialities and Load them into ^TMP("IBOVOP",$J) to be printed
"RTN","IBECEAU5",92,0)
 ; by ^IBOVOP the Outpatient Events Report.
"RTN","IBECEAU5",93,0)
 ;
"RTN","IBECEAU5",94,0)
 Q:'$G(IBDATE)
"RTN","IBECEAU5",95,0)
 N DGPM0,DGMVP,IBDATE1,IBDFN,IBI,IBENDDT,IBSPEC
"RTN","IBECEAU5",96,0)
 N IBFLD1,IBFLD2,IBFLD3,IBFLD4,IBFLD5,IBSUB3,IBSUB4,IBSUB5,IBSUB6
"RTN","IBECEAU5",97,0)
 S IBDATE1=$P(IBDATE,"."),IBI=($P(IBDATE,".")-1)+.99999
"RTN","IBECEAU5",98,0)
 S IBENDDT=IBDATE1+.9999
"RTN","IBECEAU5",99,0)
 F  S IBI=$O(^DGPM("B",IBI)) Q:'IBI!(IBI>IBENDDT)  D
"RTN","IBECEAU5",100,0)
 . S DGMVP=0 F  S DGMVP=$O(^DGPM("B",IBI,DGMVP)) Q:'DGMVP  D
"RTN","IBECEAU5",101,0)
 . . S DGPM0=$G(^DGPM(DGMVP,0)) Q:$P(DGPM0,U,2)'=1
"RTN","IBECEAU5",102,0)
 . . S IBTYP=$P(DGPM0,U,2) ; 1=Admission
"RTN","IBECEAU5",103,0)
 . . S IBSPEC=$$MVT^DGPMOBS(DGMVP) Q:+IBSPEC<1  ; quite not OBS
"RTN","IBECEAU5",104,0)
 . . S IBDFN=$P(DGPM0,U,3) Q:'IBDFN
"RTN","IBECEAU5",105,0)
 . . Q:$$BILST^DGMTUB(IBDFN)<($P(+DGPM0,"."))  ; quite not MT billable
"RTN","IBECEAU5",106,0)
 . . S IBSUB3=$$FLD1^IBOVOP1(IBDFN) Q:IBSUB3=""  ; subscript 3 PT name
"RTN","IBECEAU5",107,0)
 . . S IBSUB4="OBS ADMIS"
"RTN","IBECEAU5",108,0)
 . . S IBSUB5=$$FLD3^IBOVOP1(+DGPM0) Q:IBSUB5=""
"RTN","IBECEAU5",109,0)
 . . S IBSUB6=0
"RTN","IBECEAU5",110,0)
 . . S IBFLD1=$E($P(IBSPEC,U,3),U,30) ; Treating Speciality
"RTN","IBECEAU5",111,0)
 . . S IBFLD2=""
"RTN","IBECEAU5",112,0)
 . . S IBFLD3=$S($P(DGPM0,U,17):"DISCHARGED",1:"ADMISSION")
"RTN","IBECEAU5",113,0)
 . . S IBFLD4=IBDFN,IBFLD5="",IBFLD6=DGMVP
"RTN","IBECEAU5",114,0)
 . . ; Set the Global for the Outpatient Event Report
"RTN","IBECEAU5",115,0)
 . . S ^TMP("IBOVOP",$J,IBSUB3,IBSUB4,IBSUB5,IBSUB6)=IBFLD1_U_IBFLD2_U_IBFLD3_U_IBFLD4_U_IBFLD5_U_IBFLD6
"RTN","IBECEAU5",116,0)
 Q
"RTN","IBOVOP2")
0^6^B13589783
"RTN","IBOVOP2",1,0)
IBOVOP2 ;ALB/CPM-Opt/Reg Events Report Print Utilities ; 30-AUG-93
"RTN","IBOVOP2",2,0)
 ;;2.0;INTEGRATED BILLING;**52,132,153,156,167,176,234,247**;21-MAR-94
"RTN","IBOVOP2",3,0)
 ;; Per VHA Directive 10-93-142, this routine should not be modified
"RTN","IBOVOP2",4,0)
 ;
"RTN","IBOVOP2",5,0)
PRINT ; Retrieve data for printing.
"RTN","IBOVOP2",6,0)
 N IBCOMBAT
"RTN","IBOVOP2",7,0)
 S IBFLD1="" I '$D(^TMP("IBOVOP",$J)) W !!,"No Outpatient activity recorded for MT/LTC copay patients on ",$$DAT1^IBOUTL(IBDATE),"."
"RTN","IBOVOP2",8,0)
 F  S IBFLD1=$O(^TMP("IBOVOP",$J,IBFLD1)) Q:(IBFLD1="")!(IBQUIT)  W ! D:IBLINE>55 HDR W !,IBFLD1 D  D CHRGS Q:IBQUIT
"RTN","IBOVOP2",9,0)
 .S IBFLD2="" F  S IBFLD2=$O(^TMP("IBOVOP",$J,IBFLD1,IBFLD2)) Q:(IBFLD2="")!(IBQUIT)  D
"RTN","IBOVOP2",10,0)
 ..S IBFLD3="" F  S IBFLD3=$O(^TMP("IBOVOP",$J,IBFLD1,IBFLD2,IBFLD3)) Q:(IBFLD3="")!(IBQUIT)  D
"RTN","IBOVOP2",11,0)
 ...S IBSEQ="" F  S IBSEQ=$O(^TMP("IBOVOP",$J,IBFLD1,IBFLD2,IBFLD3,IBSEQ)) Q:(IBSEQ="")!(IBQUIT)  S IBDATA=$G(^(IBSEQ)) D
"RTN","IBOVOP2",12,0)
 ....S IBFLD4=$P(IBDATA,"^",1),IBFLD5=$P(IBDATA,"^",2),IBFLD6=$P(IBDATA,"^",3),DFN=$P(IBDATA,"^",4)
"RTN","IBOVOP2",13,0)
 ....S IBCOMBAT=$$CVEDT^IBACV(DFN,IBDATE) I +IBCOMBAT I $P(IBCOMBAT,"^",2)>0 W !,"Veteran has CV status until "_$$DAT1^IBOUTL($P(IBCOMBAT,"^",2))
"RTN","IBOVOP2",14,0)
 ....W !?5,IBFLD2
"RTN","IBOVOP2",15,0)
 ....W ?20,IBFLD3,?26,IBFLD4,?44,IBFLD5,?63,IBFLD6 D CLSF(+$P(IBDATA,"^",5)) D:IBFLD2="OBS ADMIS" CLSF^IBECEAU5(+$P(IBDATA,U,6)) W ! S IBLINE=IBLINE+1
"RTN","IBOVOP2",16,0)
 ....Q:$O(^TMP("IBOVOP",$J,IBFLD1))=""
"RTN","IBOVOP2",17,0)
 ....I IBLINE>55 D HDR W !,IBFLD1 I $D(^TMP("IBOVOP",$J,IBFLD1,IBFLD2,IBFLD3,IBSEQ+1)) W !?5,IBFLD2
"RTN","IBOVOP2",18,0)
 ....I $Y>(IOSL-5) D PAUSE^IBOUTL Q:IBQUIT  D HDR W !,IBFLD1,!?5,IBFLD2
"RTN","IBOVOP2",19,0)
 D:'IBQUIT PAUSE^IBOUTL
"RTN","IBOVOP2",20,0)
 Q
"RTN","IBOVOP2",21,0)
 ;
"RTN","IBOVOP2",22,0)
CHRGS ; Find OP charges for day, if any. Build string for print.
"RTN","IBOVOP2",23,0)
 Q:'$G(DFN)
"RTN","IBOVOP2",24,0)
 N IBSTDATA
"RTN","IBOVOP2",25,0)
 I $D(^IB("AFDT",DFN,-IBDATE))=10 D
"RTN","IBOVOP2",26,0)
 .S IBPRNT="" F  S IBPRNT=$O(^IB("AFDT",DFN,-IBDATE,IBPRNT)) Q:IBPRNT=""!(IBQUIT)  D
"RTN","IBOVOP2",27,0)
 ..S IBIEN="" F  S IBIEN=$O(^IB("AD",IBPRNT,IBIEN)) Q:IBIEN=""!(IBQUIT)  D
"RTN","IBOVOP2",28,0)
 ...S IBDATA=$G(^IB(IBIEN,0)) Q:IBDATA=""
"RTN","IBOVOP2",29,0)
 ...I $Y>(IOSL-5) D PAUSE^IBOUTL Q:IBQUIT  D HDR W !,IBFLD1
"RTN","IBOVOP2",30,0)
 ...S IBSTAT=$P($G(^IBE(350.21,+$P(IBDATA,"^",5),0)),"^",2)
"RTN","IBOVOP2",31,0)
 ...S IBACT=$S($P($G(^IBE(350.1,+$P(IBDATA,"^",3),0)),"^",8)'="":$P(^(0),"^",8),1:$P(^(0),"^",1))
"RTN","IBOVOP2",32,0)
 ...S IBAMT=$P(IBDATA,"^",7)
"RTN","IBOVOP2",33,0)
 ...S IBAMT=$S(IBAMT?1N.N1"."1N:IBAMT_"0 ",IBAMT?1N.N:IBAMT_".00 ",1:IBAMT)
"RTN","IBOVOP2",34,0)
 ...S IBAMT=$S(IBACT["CANCEL":"*($"_IBAMT_")",1:"* $"_IBAMT)
"RTN","IBOVOP2",35,0)
 ...S IBSTDATA=$G(^IBE(352.5,+$P(IBDATA,"^",20),0))
"RTN","IBOVOP2",36,0)
 ...I IBSTDATA'="" W !?26,"Stop Code: ",$P(IBSTDATA,"^",4),?58,"#",$P(IBSTDATA,"^"),?63,$$TYPE^IBEMTSCR(+$P(IBSTDATA,"^",3))
"RTN","IBOVOP2",37,0)
 ...W !?5,IBAMT,?13,IBACT,?63,IBSTAT S IBLINE=IBLINE+1
"RTN","IBOVOP2",38,0)
 Q
"RTN","IBOVOP2",39,0)
 ;
"RTN","IBOVOP2",40,0)
HDR ; Print header.
"RTN","IBOVOP2",41,0)
 S IBPAGE=IBPAGE+1,IBLINE=5,IBTITLE="Means Test/LTC Outpatient and Registration Activity for "_$$DAT1^IBOUTL(IBDATE)
"RTN","IBOVOP2",42,0)
 I $E(IOST,1,2)["C-"!(IBPAGE>1) W @IOF,*13
"RTN","IBOVOP2",43,0)
 W ?(80-$L(IBTITLE))\2,IBTITLE
"RTN","IBOVOP2",44,0)
 S IBTITLE="Printed: "_$$DAT1^IBOUTL(DT)
"RTN","IBOVOP2",45,0)
 W !?(80-$L(IBTITLE))\2,IBTITLE,?70,"Page: "_IBPAGE
"RTN","IBOVOP2",46,0)
 W !!,"Patient/Event",?20,"Time",?26,"Clinic/Stop",?44,"Appt.Type",?63,"(Status)",!
"RTN","IBOVOP2",47,0)
 Q
"RTN","IBOVOP2",48,0)
 ;
"RTN","IBOVOP2",49,0)
CLSF(IBOE) ; Display classification results.
"RTN","IBOVOP2",50,0)
 ;  Input:    IBOE  --  Pointer to Outpatient Encounter in file #409.68
"RTN","IBOVOP2",51,0)
 I '$G(IBOE) G CLSFQ
"RTN","IBOVOP2",52,0)
 N I,IBCLS,IBCLSD,IBF S IBF=0,IBCLSD=$$ENCL^IBAMTS2(IBOE)
"RTN","IBOVOP2",53,0)
 I IBCLSD]"" F I=1,2,3,4,5,6,7 S IBCLS=$P(IBCLSD,"^",I) I IBCLS]"" W:'IBF !?6 W:IBF "  " W "Care related to ",$S(I=1:"AO",I=2:"IR",I=3:"SC",I=4:"EC",I=5:"MST",I=6:"HNC",I=7:"CV",1:"??"),"? ",$S(IBCLS:"YES",1:"NO") S IBF=1
"RTN","IBOVOP2",54,0)
CLSFQ Q
"RTN","IBTRED")
0^7^B21734876
"RTN","IBTRED",1,0)
IBTRED ;ALB/AAS - EXPAND/EDIT CLAIMS TRACKING ENTRY ; 01-JUL-1993
"RTN","IBTRED",2,0)
 ;;2.0;INTEGRATED BILLING;**71,91,160,247**;21-MAR-94
"RTN","IBTRED",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRED",4,0)
 ;
"RTN","IBTRED",5,0)
% ;
"RTN","IBTRED",6,0)
EN ; -- main entry point for IBT EXPAND/EDIT TRACKING
"RTN","IBTRED",7,0)
 I '$D(DT) D DT^DICRW
"RTN","IBTRED",8,0)
 K XQORS,VALMEVL,DFN,IBTRN,IBTRV,IBTRC,IBTRD
"RTN","IBTRED",9,0)
 I '$G(IBTRN) G EN^IBTRE Q  ; entry from programmer mode
"RTN","IBTRED",10,0)
 D EN^VALM("IBT EXPAND/EDIT TRACKING")
"RTN","IBTRED",11,0)
 K IBFASTXT
"RTN","IBTRED",12,0)
 Q
"RTN","IBTRED",13,0)
 ;
"RTN","IBTRED",14,0)
HDR ; -- header code
"RTN","IBTRED",15,0)
 D PID^VADPT
"RTN","IBTRED",16,0)
 S VALMHDR(1)="Expanded Claims Tracking Info for: "_$E($P($G(^DPT(DFN,0)),"^"),1,20)_" "_$E($G(^(0)),1)_VA("BID")_"   ROI: "_$$EXPAND^IBTRE(356,.31,$P(^IBT(356,IBTRN,0),"^",31))
"RTN","IBTRED",17,0)
 S VALMHDR(2)="                              For: "_$$ETYP(IBTRN)
"RTN","IBTRED",18,0)
 Q
"RTN","IBTRED",19,0)
 ;
"RTN","IBTRED",20,0)
INIT ; -- init variables and list array
"RTN","IBTRED",21,0)
 K VALMQUIT
"RTN","IBTRED",22,0)
 S VALMCNT=0,VALMBG=1
"RTN","IBTRED",23,0)
 D BLD,HDR
"RTN","IBTRED",24,0)
 Q
"RTN","IBTRED",25,0)
 ;
"RTN","IBTRED",26,0)
BLD ; -- list builder
"RTN","IBTRED",27,0)
 N IBTRND,IBTRND1,IBTRND2,IBETYP
"RTN","IBTRED",28,0)
 K ^TMP("IBTRED",$J)
"RTN","IBTRED",29,0)
 F I=1:1:30 D BLANK(.I)
"RTN","IBTRED",30,0)
 I '$G(IBTRPRF) S IBTRPRF=123
"RTN","IBTRED",31,0)
 I IBTRPRF<10 S X=$S(IBTRPRF=1:"IBTRED  HR MENU",IBTRPRF=2:"IBTRED  IR MENU",IBTRPRF=3:"IBTRED  BI MENU",1:"IBTRED  MENU") D PROT^IBTRPR(X)
"RTN","IBTRED",32,0)
 D KILL^VALM10()
"RTN","IBTRED",33,0)
 S IBTRND=$G(^IBT(356,IBTRN,0)),IBTRND1=$G(^(1))
"RTN","IBTRED",34,0)
 S IBETYP=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTRED",35,0)
 S VALMCNT=30
"RTN","IBTRED",36,0)
 D VISIT D ^IBTRED0,^IBTRED01
"RTN","IBTRED",37,0)
 Q
"RTN","IBTRED",38,0)
 ;
"RTN","IBTRED",39,0)
VISIT ; -- Visit info Region
"RTN","IBTRED",40,0)
 N OFFSET,START,IBOE,IBOE0
"RTN","IBTRED",41,0)
 S START=1,OFFSET=2
"RTN","IBTRED",42,0)
 D SET^IBCNSP(START,OFFSET," Visit Information ",IORVON,IORVOFF)
"RTN","IBTRED",43,0)
 D SET^IBCNSP(START+1,OFFSET,"    Visit Type: "_$P(IBETYP,"^"))
"RTN","IBTRED",44,0)
 I '$D(IBETYP) N IBETYP S IBETYP=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTRED",45,0)
 S X=$P(IBETYP,"^",3) D @X
"RTN","IBTRED",46,0)
 Q
"RTN","IBTRED",47,0)
1 ; -- visit region for admission or scheduled admission
"RTN","IBTRED",48,0)
 I $P($G(^DGPM(+$P(IBTRND,"^",5),0)),"^",17) S VAINDT=+$G(^DGPM(+$P(IBTRND,"^",5),0))
"RTN","IBTRED",49,0)
 I '$D(VAIN) S VA200="" D INP^VADPT
"RTN","IBTRED",50,0)
 I VAIN(7)="" S Y=$P(IBTRND,"^",6) D D^DIQ S $P(VAIN(7),"^",2)=Y
"RTN","IBTRED",51,0)
 D SET^IBCNSP(START+2,OFFSET,"Admission Date: "_$P(VAIN(7),"^",2))
"RTN","IBTRED",52,0)
 D SET^IBCNSP(START+3,OFFSET,"          Ward: "_$P(VAIN(4),"^",2))
"RTN","IBTRED",53,0)
 D SET^IBCNSP(START+4,OFFSET,"     Specialty: "_$P(VAIN(3),"^",2))
"RTN","IBTRED",54,0)
 Q
"RTN","IBTRED",55,0)
2 ; -- visit region for  outpatient care
"RTN","IBTRED",56,0)
 S IBOE=$P(IBTRND,"^",4),IBOE0=$$SCE^IBSDU(+IBOE)
"RTN","IBTRED",57,0)
 D SET^IBCNSP(START+2,OFFSET,"    Visit Date: "_$$DAT1^IBOUTL($P(IBTRND,"^",6),"2P"))
"RTN","IBTRED",58,0)
 I +IBOE<1 D  Q
"RTN","IBTRED",59,0)
 .D SET^IBCNSP(START+3,OFFSET,"  No Outpatient Encounter Found") Q
"RTN","IBTRED",60,0)
 D SET^IBCNSP(START+3,OFFSET,"        Clinic: "_$P($G(^SC(+$P(IBOE0,"^",4),0)),"^"))
"RTN","IBTRED",61,0)
 D SET^IBCNSP(START+4,OFFSET,"  Appt. Status: "_$$EXPAND^IBTRE(409.68,.12,$P(IBOE0,"^",12)))
"RTN","IBTRED",62,0)
 D SET^IBCNSP(START+5,OFFSET,"    Appt. Type: "_$$EXPAND^IBTRE(409.68,.1,$P(IBOE0,"^",10)))
"RTN","IBTRED",63,0)
 D SET^IBCNSP(START+6,OFFSET,"  Special Cond: "_$$ENCL(IBOE))
"RTN","IBTRED",64,0)
 Q
"RTN","IBTRED",65,0)
 ;
"RTN","IBTRED",66,0)
3 ; -- visit region for rx refill
"RTN","IBTRED",67,0)
 N PSONTALK,PSOTMP
"RTN","IBTRED",68,0)
 S PSONTALK=1 ;PSORXN=+$P(IBTRND,"^",8),PSOFILL=+$P(IBTRND,"^",10)
"RTN","IBTRED",69,0)
 S X=+$P(IBTRND,"^",8)_"^"_+$P(IBTRND,"^",10) D EN^PSOCPVW
"RTN","IBTRED",70,0)
 D SET^IBCNSP(START+2,OFFSET,"Prescription #: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),.01,"E")))
"RTN","IBTRED",71,0)
 I $P(IBTRND,"^",10)=0 D SET^IBCNSP(START+3,OFFSET,"     Fill Date: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),22,"E")))
"RTN","IBTRED",72,0)
 I +$P(IBTRND,"^",10) D SET^IBCNSP(START+3,OFFSET,"   Refill Date: "_$G(PSOTMP(52.1,+$P(IBTRND,"^",10),.01,"E")))
"RTN","IBTRED",73,0)
 D SET^IBCNSP(START+4,OFFSET,"          Drug: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),6,"E")))
"RTN","IBTRED",74,0)
 D SET^IBCNSP(START+5,OFFSET,"      Quantity: "_$J($G(PSOTMP(52,+$P(IBTRND,"^",8),7,"E")),8))
"RTN","IBTRED",75,0)
 D SET^IBCNSP(START+6,OFFSET,"   Days Supply: "_$J($G(PSOTMP(52,+$P(IBTRND,"^",8),8,"E")),8))
"RTN","IBTRED",76,0)
 D SET^IBCNSP(START+7,OFFSET,"          NDC#: "_$P($G(^PSDRUG(+$P($G(^PSRX(+$P(IBTRND,"^",8),0)),"^",6),2)),"^",4))
"RTN","IBTRED",77,0)
 D SET^IBCNSP(START+8,OFFSET,"     Physician: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),4,"E")))
"RTN","IBTRED",78,0)
 Q
"RTN","IBTRED",79,0)
 ;
"RTN","IBTRED",80,0)
4 ; -- Visit region for prosthetics
"RTN","IBTRED",81,0)
 D 4^IBTRED01
"RTN","IBTRED",82,0)
 Q
"RTN","IBTRED",83,0)
 ;
"RTN","IBTRED",84,0)
HELP ; -- help code
"RTN","IBTRED",85,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","IBTRED",86,0)
 Q
"RTN","IBTRED",87,0)
 ;
"RTN","IBTRED",88,0)
EXIT ; -- exit code
"RTN","IBTRED",89,0)
 K VALMQUIT,IBTRN
"RTN","IBTRED",90,0)
 D CLEAN^VALM10,FULL^VALM1
"RTN","IBTRED",91,0)
 Q
"RTN","IBTRED",92,0)
 ;
"RTN","IBTRED",93,0)
BLANK(LINE) ; -- Build blank line
"RTN","IBTRED",94,0)
 D SET^VALM10(.LINE,$J("",80))
"RTN","IBTRED",95,0)
 Q
"RTN","IBTRED",96,0)
 ;
"RTN","IBTRED",97,0)
ETYP(IBTRN) ; -- Expand type of epidose and date
"RTN","IBTRED",98,0)
 N IBY S IBY=""
"RTN","IBTRED",99,0)
 S IBTRND=$G(^IBT(356,+IBTRN,0)) I IBTRND="" G ETYPQ
"RTN","IBTRED",100,0)
 S IBETYPD=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTRED",101,0)
 I IBETYPD="" G ETYPQ
"RTN","IBTRED",102,0)
 S IBY=$P(IBETYPD,"^")_" on "_$$DAT1^IBOUTL($P(IBTRND,"^",6),"2P")
"RTN","IBTRED",103,0)
ETYPQ Q IBY
"RTN","IBTRED",104,0)
 ;
"RTN","IBTRED",105,0)
ENCL(IBOE) ; -- output format of classifications
"RTN","IBTRED",106,0)
 N I,X,IBCL,IBCL1 S IBCL=""
"RTN","IBTRED",107,0)
 I '$G(IBOE) G ENCLQ
"RTN","IBTRED",108,0)
 S IBCL1=$$ENCL^IBAMTS2(+IBOE)
"RTN","IBTRED",109,0)
 F I=1:1:7 S X=$P(IBCL1,"^",I) S:X IBCL=IBCL_$S(I=1:"AO",I=2:"IR",I=3:"SC",I=4:"EC",I=5:"MST",I=6:"HNC",I=7:"CV",1:"")_"  "
"RTN","IBTRED",110,0)
ENCLQ Q IBCL
"RTN","IBTRKR3")
0^11^B25993216
"RTN","IBTRKR3",1,0)
IBTRKR3 ;ALB/AAS - CLAIMS TRACKING - ADD/TRACK RX FILLS ; 13-AUG-93
"RTN","IBTRKR3",2,0)
 ;;2.0;INTEGRATED BILLING;**13,43,121,160,247**;21-MAR-94
"RTN","IBTRKR3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRKR3",4,0)
 ;
"RTN","IBTRKR3",5,0)
% ; -- entry point for nightly background job
"RTN","IBTRKR3",6,0)
 N IBTSBDT,IBTSEDT
"RTN","IBTRKR3",7,0)
 S IBTSBDT=$$FMADD^XLFDT(DT,-14)-.1
"RTN","IBTRKR3",8,0)
 S IBTSEDT=$$FMADD^XLFDT(DT,-7)+.9
"RTN","IBTRKR3",9,0)
 D EN1
"RTN","IBTRKR3",10,0)
 Q
"RTN","IBTRKR3",11,0)
 ;
"RTN","IBTRKR3",12,0)
EN ; -- entry point to ask date range
"RTN","IBTRKR3",13,0)
 N IBBDT,IBEDT,IBTSBDT,IBTSEDT,IBTALK,IBMESS
"RTN","IBTRKR3",14,0)
 S IBTALK=1
"RTN","IBTRKR3",15,0)
 I '$P($G(^IBE(350.9,1,6)),"^",4) W !!,"I'm sorry, Tracking of Prescription Refills is currrently turned off." G ENQ
"RTN","IBTRKR3",16,0)
 W !!!,"Select the Date Range of Rx Refills to Add to Claims Tracking.",!
"RTN","IBTRKR3",17,0)
 D DATE^IBOUTL
"RTN","IBTRKR3",18,0)
 I IBBDT<1!(IBEDT<1) G ENQ
"RTN","IBTRKR3",19,0)
 S IBTSBDT=IBBDT,IBTSEDT=IBEDT
"RTN","IBTRKR3",20,0)
 ;
"RTN","IBTRKR3",21,0)
 ; -- check selected dates
"RTN","IBTRKR3",22,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBTRKR3",23,0)
 ; start date can't be before parameters
"RTN","IBTRKR3",24,0)
 I +IBTRKR,IBTSBDT<+IBTRKR S IBTSBDT=IBTRKR W !!,"Begin date is before Claims Tracking Start Date, changed to ",$$DAT1^IBOUTL(IBTSBDT)
"RTN","IBTRKR3",25,0)
 ; -- end date into future
"RTN","IBTRKR3",26,0)
 I IBTSEDT>$$FMADD^XLFDT(DT,-3) W !!,"I'll automatically change the end date to 3 days prior to the date queued to run."
"RTN","IBTRKR3",27,0)
 ;
"RTN","IBTRKR3",28,0)
 W !!!,"I'm going to automatically queue this off and send you a"
"RTN","IBTRKR3",29,0)
 W !,"mail message when complete.",!
"RTN","IBTRKR3",30,0)
 S ZTIO="",ZTRTN="EN1^IBTRKR3",ZTSAVE("IB*")="",ZTDESC="IB - Add Rx Refills to Claims Tracking"
"RTN","IBTRKR3",31,0)
 D ^%ZTLOAD I $G(ZTSK) K ZTSK W !,"Request Queued"
"RTN","IBTRKR3",32,0)
ENQ K ZTSK,ZTIO,ZTSAVE,ZTDESC,ZTRTN
"RTN","IBTRKR3",33,0)
 D HOME^%ZIS
"RTN","IBTRKR3",34,0)
 Q
"RTN","IBTRKR3",35,0)
 ;
"RTN","IBTRKR3",36,0)
EN1 ; -- add rx refills to claims tracking file
"RTN","IBTRKR3",37,0)
 N I,J,X,Y,IBTRKR,IBDT,IBRXN,IBFILL,DFN,IBDATA,IBCNT,IBCNT1,IBCNT2
"RTN","IBTRKR3",38,0)
 ;
"RTN","IBTRKR3",39,0)
 ; -- check parameters
"RTN","IBTRKR3",40,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBTRKR3",41,0)
 G:'$P(IBTRKR,"^",4) EN1Q ; quit if rx tracking off
"RTN","IBTRKR3",42,0)
 I +IBTRKR,IBTSBDT<+IBTRKR S IBTSBDT=IBTRKR ; start date can't be before parameters
"RTN","IBTRKR3",43,0)
 ;
"RTN","IBTRKR3",44,0)
 ; -- users can queue into future, make sure dates not after date run
"RTN","IBTRKR3",45,0)
 I IBTSEDT>$$FMADD^XLFDT(DT,-3) S IBMESS="(Selected end date of "_$$DAT1^IBOUTL(IBTSEDT)_" automatically changed to "_$$DAT1^IBOUTL($$FMADD^XLFDT(DT,-3))_".)",IBTSEDT=$$FMADD^XLFDT(DT,-3)
"RTN","IBTRKR3",46,0)
 ;
"RTN","IBTRKR3",47,0)
 S IBRXTYP=$O(^IBE(356.6,"AC",4,0)) ; event type pointer for rx billing
"RTN","IBTRKR3",48,0)
 ;
"RTN","IBTRKR3",49,0)
 ; -- cnt= total count, cnt1=count added nsc, cnt2=count of pending
"RTN","IBTRKR3",50,0)
 S (IBCNT,IBCNT1,IBCNT2)=0
"RTN","IBTRKR3",51,0)
 S IBDT=IBTSBDT-.0001
"RTN","IBTRKR3",52,0)
 F  S IBDT=$O(^PSRX("AD",IBDT)) Q:'IBDT!(IBDT>IBTSEDT)  S IBRXN="" F  S IBRXN=$O(^PSRX("AD",IBDT,IBRXN)) Q:'IBRXN  S IBFILL="" F  S IBFILL=$O(^PSRX("AD",IBDT,IBRXN,IBFILL)) Q:IBFILL=""  D RXCHK
"RTN","IBTRKR3",53,0)
 ;
"RTN","IBTRKR3",54,0)
 I $G(IBTALK) D BULL^IBTRKR31
"RTN","IBTRKR3",55,0)
EN1Q I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBTRKR3",56,0)
 Q
"RTN","IBTRKR3",57,0)
 ;
"RTN","IBTRKR3",58,0)
RXCHK ; -- check and add rx
"RTN","IBTRKR3",59,0)
 S IBCNT=IBCNT+1
"RTN","IBTRKR3",60,0)
 ;I IBFILL<1 G RXCHKQ ;       original fill
"RTN","IBTRKR3",61,0)
 I IBDT>(DT+.24) G RXCHKQ ;  future fill
"RTN","IBTRKR3",62,0)
 I '$D(ZTQUEUED),($G(IBTALK)) W "."
"RTN","IBTRKR3",63,0)
 ;
"RTN","IBTRKR3",64,0)
 S IBRXDATA=$G(^PSRX(IBRXN,0)),IBRXSTAT=$P(IBRXDATA,"^",15)
"RTN","IBTRKR3",65,0)
 S DFN=$P(IBRXDATA,"^",2)
"RTN","IBTRKR3",66,0)
 ;I IBDT=$P($O(^DPT(DFN,"S",(IBDT-.00001))),".") G RXCHKQ ;scheduled appointment on same day as fill date
"RTN","IBTRKR3",67,0)
 ;I $$BABCSC^IBEFUNC(DFN,$P(IBDT,".",1)) G RXCHKQ ; is billable clinic stop in encounter file for data (allows telephone stops on same day, but not others) (P121 - RC, can now bill Rx if on same day as opt visit)
"RTN","IBTRKR3",68,0)
 ;
"RTN","IBTRKR3",69,0)
 ; -- not already in claims tracking
"RTN","IBTRKR3",70,0)
 I $O(^IBT(356,"ARXFL",IBRXN,IBFILL,0)) G RXCHKQ ; already in claims tracking
"RTN","IBTRKR3",71,0)
 ;
"RTN","IBTRKR3",72,0)
 ; -- see if tracking only insured and pt is insured
"RTN","IBTRKR3",73,0)
 I $P(IBTRKR,"^",4)=1,'$$INSURED^IBCNS1(DFN,IBDT) G RXCHKQ ; patient not insure
"RTN","IBTRKR3",74,0)
 ;
"RTN","IBTRKR3",75,0)
 ; -- check rx status (not deleted)
"RTN","IBTRKR3",76,0)
 I IBRXSTAT=13 G RXCHKQ
"RTN","IBTRKR3",77,0)
 ;
"RTN","IBTRKR3",78,0)
 ; -- original fill not released or returned to stock
"RTN","IBTRKR3",79,0)
 I 'IBFILL,'$P($G(^PSRX(IBRXN,2)),"^",13) G RXCHKQ
"RTN","IBTRKR3",80,0)
 I 'IBFILL,$P($G(^PSRX(IBRXN,2)),"^",15) G RXCHKQ
"RTN","IBTRKR3",81,0)
 ;
"RTN","IBTRKR3",82,0)
 ; -- refill not released or returned to stock
"RTN","IBTRKR3",83,0)
 I +IBFILL,'$P($G(^PSRX(IBRXN,1,IBFILL,0)),"^",18) G RXCHKQ
"RTN","IBTRKR3",84,0)
 I +IBFILL,$P($G(^PSRX(IBRXN,1,IBFILL,0)),"^",16) G RXCHKQ
"RTN","IBTRKR3",85,0)
 ;
"RTN","IBTRKR3",86,0)
 ; -- check drug (not investigational, supply, or over the counter drug
"RTN","IBTRKR3",87,0)
 S IBDRUG=$P(IBRXDATA,"^",6)
"RTN","IBTRKR3",88,0)
 S IBDEA=$P($G(^PSDRUG(+$P(IBRXDATA,"^",6),0)),"^",3)
"RTN","IBTRKR3",89,0)
 I IBDEA["I"!(IBDEA["S")!(IBDEA["9") G RXCHKQ ; investigational drug, supply or otc
"RTN","IBTRKR3",90,0)
 ;
"RTN","IBTRKR3",91,0)
 ; -- see if insured for prescriptions
"RTN","IBTRKR3",92,0)
 I '$$PTCOV^IBCNSU3(DFN,IBDT,"PHARMACY",.IBANY) S IBRMARK=$S($G(IBANY):"SERVICE NOT COVERED",1:"NOT INSURED")
"RTN","IBTRKR3",93,0)
 ;
"RTN","IBTRKR3",94,0)
 ; -- check sc status
"RTN","IBTRKR3",95,0)
 D ELIG^VADPT
"RTN","IBTRKR3",96,0)
 ;if the patient is covered by insurance for pharmacy ($G(IBRMARK)="")
"RTN","IBTRKR3",97,0)
 ;AND if no copay in #350
"RTN","IBTRKR3",98,0)
 ;then we need to determine the non billable reason and set IBRMARK
"RTN","IBTRKR3",99,0)
 ;
"RTN","IBTRKR3",100,0)
 ;IF VAEL(3) -- if this is a veteran with SC(service connection) status
"RTN","IBTRKR3",101,0)
 I $G(IBRMARK)="",VAEL(3),'$G(^PSRX(IBRXN,"IB")) D
"RTN","IBTRKR3",102,0)
 .I $P(VAEL(3),"^",2)>49 S IBRMARK="NEEDS SC DETERMINATION"
"RTN","IBTRKR3",103,0)
 .I $P(VAEL(3),"^",2)<50 S IBRMARK="SC TREATMENT"
"RTN","IBTRKR3",104,0)
 .I $$RXST^IBARXEU(DFN,$P(IBRXDATA,U,13))>0 S IBRMARK="NEEDS SC DETERMINATION"
"RTN","IBTRKR3",105,0)
 ;
"RTN","IBTRKR3",106,0)
 ;IF +VAEL(3)=0 if the veteran doesn't have SC status, but
"RTN","IBTRKR3",107,0)
 ;the veteran still may have CV status active
"RTN","IBTRKR3",108,0)
 I $G(IBRMARK)="",+VAEL(3)=0,'$G(^PSRX(IBRXN,"IB")) D
"RTN","IBTRKR3",109,0)
 .I $$CVEDT^IBACV(DFN,IBDT) S IBRMARK="NEEDS SC DETERMINATION" ;SC-because IB staff usually is using this reason to search for cases that need to be reviewed. COMBAT VETERAN reason will be used after review if this was a case
"RTN","IBTRKR3",110,0)
 ;
"RTN","IBTRKR3",111,0)
 ; -- ok to add to tracking module
"RTN","IBTRKR3",112,0)
 D REFILL^IBTUTL1(DFN,IBRXTYP,IBDT,IBRXN,IBFILL,$G(IBRMARK)) I '$D(ZTQUEUED),$G(IBTALK) W "+"
"RTN","IBTRKR3",113,0)
 I $G(IBRMARK)'="" S IBCNT2=IBCNT2+1
"RTN","IBTRKR3",114,0)
 I $G(IBRMARK)="" S IBCNT1=IBCNT1+1
"RTN","IBTRKR3",115,0)
 K IBANY,IBRMARK,VAEL,VA,IBDEA,IBDRUG,IBRXSTAT,IBRXDATA,DFN,X,Y
"RTN","IBTRKR3",116,0)
RXCHKQ Q
"RTN","IBTRKR41")
0^8^B11942598
"RTN","IBTRKR41",1,0)
IBTRKR41 ;ALB/AAS - CLAIMS TRACKING - ADD/TRACK OUTPATIENT ENCOUNTERS ; 13-AUG-93
"RTN","IBTRKR41",2,0)
 ;;2.0;INTEGRATED BILLING;**43,55,91,132,174,247**;21-MAR-94
"RTN","IBTRKR41",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRKR41",4,0)
 ;
"RTN","IBTRKR41",5,0)
OPCHK ; -- check and add rx
"RTN","IBTRKR41",6,0)
 N Y,Y0
"RTN","IBTRKR41",7,0)
 K IBRMARK
"RTN","IBTRKR41",8,0)
 I '$D(ZTQUEUED),($G(IBTALK)) W "."
"RTN","IBTRKR41",9,0)
 ;
"RTN","IBTRKR41",10,0)
 S IBOEDATA=$$SCE^IBSDU(IBOE),IBOESTAT=$P(IBOEDATA,"^",15)
"RTN","IBTRKR41",11,0)
 S DFN=$P(IBOEDATA,"^",2)
"RTN","IBTRKR41",12,0)
 I 'DFN G OPCHKQ
"RTN","IBTRKR41",13,0)
 I $P(IBOEDATA,"^",5) S IBVSIT=$P(IBOEDATA,"^",5) I '$$BDSRC^IBEFUNC3(IBVSIT) G OPCHKQ ;non-billable data sources
"RTN","IBTRKR41",14,0)
 ;
"RTN","IBTRKR41",15,0)
 ; -- see if tracking only insured and pt is insured/insured for outpt visits
"RTN","IBTRKR41",16,0)
 I $P(IBTRKR,"^",3)=1,'$$INSURED^IBCNS1(DFN,IBDT) G OPCHKQ ; patient not insured
"RTN","IBTRKR41",17,0)
 ;
"RTN","IBTRKR41",18,0)
 ; -- see if outpatient services are covered
"RTN","IBTRKR41",19,0)
 I '$$PTCOV^IBCNSU3(DFN,IBDT,"OUTPATIENT",.IBANY) S IBRMARK=$S($G(IBANY):"SERVICE NOT COVERED",1:"NOT INSURED")
"RTN","IBTRKR41",20,0)
 ;
"RTN","IBTRKR41",21,0)
 ; -- see if appointment type is billable
"RTN","IBTRKR41",22,0)
 I '$$RPT^IBEFUNC($P(IBOEDATA,"^",10),+IBOEDATA) S IBRMARK="NON-BILLABLE APPOINTMENT TYPE"
"RTN","IBTRKR41",23,0)
 ;
"RTN","IBTRKR41",24,0)
 ; -- check sc status, special conditions etc.
"RTN","IBTRKR41",25,0)
 I $G(IBRMARK)="" S IBENCL=$$ENCL^IBAMTS2(IBOE) I IBENCL["1" D  ; return 1 in string if true "ao^ir^sc^ec^mst^hnc^cv"
"RTN","IBTRKR41",26,0)
 .I $P(IBENCL,"^",3) S IBRMARK="SC TREATMENT" Q
"RTN","IBTRKR41",27,0)
 .I $P(IBENCL,"^",1) S IBRMARK="AGENT ORANGE" Q
"RTN","IBTRKR41",28,0)
 .I $P(IBENCL,"^",2) S IBRMARK="IONIZING RADIATION" Q
"RTN","IBTRKR41",29,0)
 .I $P(IBENCL,"^",4) S IBRMARK="ENV. CONTAM." Q
"RTN","IBTRKR41",30,0)
 .I $P(IBENCL,"^",5) S IBRMARK="MILITARY SEXUAL TRAUMA" Q
"RTN","IBTRKR41",31,0)
 .I $P(IBENCL,"^",6) S IBRMARK="HEAD/NECK CANCER" Q
"RTN","IBTRKR41",32,0)
 .I $P(IBENCL,"^",7) S IBRMARK="COMBAT VETERAN" Q
"RTN","IBTRKR41",33,0)
 ;
"RTN","IBTRKR41",34,0)
 ; -- check for non-billable stops or clinic
"RTN","IBTRKR41",35,0)
 S X=$P(IBOEDATA,"^",4) I X,$$NBCT^IBEFUNC(X,+IBOEDATA) S IBRMARK="NON-BILLABLE CLINIC"
"RTN","IBTRKR41",36,0)
 S X=$P(IBOEDATA,"^",3) I X,$$NBST^IBEFUNC(X,+IBOEDATA) S IBRMARK="NON-BILLABLE STOP CODE"
"RTN","IBTRKR41",37,0)
 ;
"RTN","IBTRKR41",38,0)
 ; -- ok to add to tracking module
"RTN","IBTRKR41",39,0)
 D OPT^IBTUTL1(DFN,IBOETYP,IBDT,IBOE,$G(IBRMARK),$G(IBVSIT)) I '$D(ZTQUEUED),$G(IBTALK) W "+"
"RTN","IBTRKR41",40,0)
 I $G(IBRMARK)'="" S IBCNT2=IBCNT2+1
"RTN","IBTRKR41",41,0)
 I $G(IBRMARK)="" S IBCNT1=IBCNT1+1
"RTN","IBTRKR41",42,0)
OPCHKQ K IBANY,IBRMARK,VAEL,VA,IBOEDATA,IBVSIT,DFN,X,Y
"RTN","IBTRKR41",43,0)
 Q
"RTN","IBTRKR41",44,0)
 ;
"RTN","IBTRKR41",45,0)
BULL ; -- send bulletin
"RTN","IBTRKR41",46,0)
 ;
"RTN","IBTRKR41",47,0)
 S XMSUB="Outpatient Encounters added to Claims Tracking Complete"
"RTN","IBTRKR41",48,0)
 S IBT(1)="The process to automatically add Opt Encounters has successfully completed."
"RTN","IBTRKR41",49,0)
 S IBT(1.1)=""
"RTN","IBTRKR41",50,0)
 S IBT(2)="              Start Date: "_$$DAT1^IBOUTL(IBTSBDT)
"RTN","IBTRKR41",51,0)
 S IBT(3)="                End Date: "_$$DAT1^IBOUTL(IBTSEDT)
"RTN","IBTRKR41",52,0)
 I $D(IBMESS) S IBT(3.1)=IBMESS
"RTN","IBTRKR41",53,0)
 S IBT(4)=""
"RTN","IBTRKR41",54,0)
 S IBT(5)="            Total Encounters Checked: "_$G(IBCNT)
"RTN","IBTRKR41",55,0)
 S IBT(6)="              Total Encounters Added: "_$G(IBCNT1)
"RTN","IBTRKR41",56,0)
 S IBT(7)=" Total Non-billable Encounters Added: "_$G(IBCNT2)
"RTN","IBTRKR41",57,0)
 S IBT(8)=""
"RTN","IBTRKR41",58,0)
 S IBT(9)="*The SC, Agent Orange, Environmental Contaminate, Ionizing Radiation,"
"RTN","IBTRKR41",59,0)
 S IBT(10)="Military Sexual Trauma,Head Neck Cancer and Combat Veteran status"
"RTN","IBTRKR41",60,0)
 S IBT(11)="visits have been added for insured patients but automatically"
"RTN","IBTRKR41",61,0)
 S IBT(12)="indicated as not billable"
"RTN","IBTRKR41",62,0)
 D SEND^IBTRKR31
"RTN","IBTRKR41",63,0)
BULLQ Q
"RTN","IBTUBO1")
0^9^B33781772
"RTN","IBTUBO1",1,0)
IBTUBO1 ;ALB/AAS - UNBILLED AMOUNTS - GENERATE UNBILLED REPORTS ;29-SEP-94
"RTN","IBTUBO1",2,0)
 ;;2.0;INTEGRATED BILLING;**19,31,32,91,123,159,247**;21-MAR-94
"RTN","IBTUBO1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTUBO1",4,0)
 ;
"RTN","IBTUBO1",5,0)
OPT(IBOE,IBQUERY) ; - Has the outpatient encounter been billed?
"RTN","IBTUBO1",6,0)
 ;   Input: IBOE=pointer to outpatient encounter in file #409.68
"RTN","IBTUBO1",7,0)
 ;               (NOTE: this value may be null)
"RTN","IBTUBO1",8,0)
 ;          IBQUERY (Passed by reference)=flag that is incremented when
"RTN","IBTUBO1",9,0)
 ;                  the Scheduling query API is invoked
"RTN","IBTUBO1",10,0)
 ;  *Pre-set variables: DFN=patient IEN, IBDT=event date, IBRT=bill rate,
"RTN","IBTUBO1",11,0)
 ;                      IBEDT=End of reporting period date.
"RTN","IBTUBO1",12,0)
 I '$G(DFN)!('$G(IBDT))!('$G(IBRT)) G OPTQ
"RTN","IBTUBO1",13,0)
 N IBCN,IBCPT,IBCT,IBDATA,IBDAY,IBDIV,IBFL,IBNAME,IBQUIT,IBNCF,IBXX,IBYD,IBYY,IBZ
"RTN","IBTUBO1",14,0)
 ;
"RTN","IBTUBO1",15,0)
 ; - Check to be sure the the encounter is billable.
"RTN","IBTUBO1",16,0)
 I $$INPT^IBAMTS1(DFN,IBDT\1_.2359) G OPTQ ;  Became inpatient same day.
"RTN","IBTUBO1",17,0)
 I $G(IBOE),$$ENCL^IBAMTS2(IBOE)["1" G OPTQ ; "ao^ir^sc^ec^mst^hnc^cv" encounter.
"RTN","IBTUBO1",18,0)
 S IBDAY=$E(IBDT,1,7),IBNAME=$P($G(^DPT(DFN,0)),U),IBQUIT="",IBNCF=0
"RTN","IBTUBO1",19,0)
 ;
"RTN","IBTUBO1",20,0)
 ; - If no encounter, see if add/edits or registrations are not billable.
"RTN","IBTUBO1",21,0)
 I '$G(IBOE) D NOOE G:IBQUIT OPTQ
"RTN","IBTUBO1",22,0)
 ;
"RTN","IBTUBO1",23,0)
 ; - If encounter was dated prior to Reasonable Charges (9/1/99) and
"RTN","IBTUBO1",24,0)
 ;   the claim was not authorized before end of reporting period, add
"RTN","IBTUBO1",25,0)
 ;   encounter Tort Rate to Unbilled Outpatient Amount
"RTN","IBTUBO1",26,0)
 I IBDAY<2990901 D PRERC,SETUB:'IBQUIT G OPTQ
"RTN","IBTUBO1",27,0)
 I '$G(IBOE) G OPTQ ; If still no encounter, quit.
"RTN","IBTUBO1",28,0)
 ;
"RTN","IBTUBO1",29,0)
 ; - If encounter was made after start of Reasonable Charges (9/1/99)
"RTN","IBTUBO1",30,0)
 ;   and any of the encounter's procedure codes have no corresponding
"RTN","IBTUBO1",31,0)
 ;   inst. or prof. claims that were not authorized before end of the
"RTN","IBTUBO1",32,0)
 ;   reporting period, add the charges for the procedures to the
"RTN","IBTUBO1",33,0)
 ;   Unbilled Outpatient Amount.
"RTN","IBTUBO1",34,0)
 ;
"RTN","IBTUBO1",35,0)
 ; - Gather all procedures associated with the encounter.
"RTN","IBTUBO1",36,0)
 D GETCPT^SDOE(IBOE,"IBYY") G:'$G(IBYY) OPTQ ; Check CPT qty.
"RTN","IBTUBO1",37,0)
 ;
"RTN","IBTUBO1",38,0)
 ; - Determine the encounter division.
"RTN","IBTUBO1",39,0)
 S IBDIV=+$P($$GETOE^SDOE(IBOE),U,11) S:'IBDIV IBDIV=+$$PRIM^VASITE()
"RTN","IBTUBO1",40,0)
 ;
"RTN","IBTUBO1",41,0)
 ; - Build array of all billable encounter procedures.
"RTN","IBTUBO1",42,0)
 S IBXX=0 F  S IBXX=$O(IBYY(IBXX)) Q:'IBXX  D
"RTN","IBTUBO1",43,0)
 . ;
"RTN","IBTUBO1",44,0)
 . ; - Get procedure pointer and code.
"RTN","IBTUBO1",45,0)
 . S IBZ=+IBYY(IBXX),IBCN=$P($$CPT^ICPTCOD(IBZ),"^",2)
"RTN","IBTUBO1",46,0)
 . ;
"RTN","IBTUBO1",47,0)
 . ; - Ignore LAB services for vets with Medicare Supplemental coverage.
"RTN","IBTUBO1",48,0)
 . I IBCN>79999,IBCN<90000 Q
"RTN","IBTUBO1",49,0)
 . ;
"RTN","IBTUBO1",50,0)
 . ; - Get the institutional/professional charge components.
"RTN","IBTUBO1",51,0)
 . S IBCPT(IBZ,1)=+$$BICOST^IBCRCI(IBRT,3,IBDAY,"PROCEDURE",IBZ,"",IBDIV,"",1)
"RTN","IBTUBO1",52,0)
 . S IBCPT(IBZ,2)=+$$BICOST^IBCRCI(IBRT,3,IBDAY,"PROCEDURE",IBZ,"",IBDIV,"",2)
"RTN","IBTUBO1",53,0)
 . ;
"RTN","IBTUBO1",54,0)
 . ; - Eliminate components without a charge.
"RTN","IBTUBO1",55,0)
 . I 'IBCPT(IBZ,1) K IBCPT(IBZ,1)
"RTN","IBTUBO1",56,0)
 . I 'IBCPT(IBZ,2) K IBCPT(IBZ,2)
"RTN","IBTUBO1",57,0)
 ;
"RTN","IBTUBO1",58,0)
 I '$D(IBCPT) G OPTQ ; Quit if no billable procedures remain.
"RTN","IBTUBO1",59,0)
 ;
"RTN","IBTUBO1",60,0)
 ; - Look at all of the vet's bills for the day and eliminate
"RTN","IBTUBO1",61,0)
 ;   from the array those procedures that have been billed.
"RTN","IBTUBO1",62,0)
 S IBXX=0
"RTN","IBTUBO1",63,0)
 F  S IBXX=$O(^DGCR(399,"AOPV",DFN,IBDAY,IBXX)) Q:'IBXX  D
"RTN","IBTUBO1",64,0)
 . ;
"RTN","IBTUBO1",65,0)
 . ; - Perform general checks on the claim.
"RTN","IBTUBO1",66,0)
 . S IBDATA=$$CKBIL^IBTUBOU(IBXX) Q:IBDATA=""  S IBNCF=IBNCF+1
"RTN","IBTUBO1",67,0)
 . ;
"RTN","IBTUBO1",68,0)
 . ; If Compile/Store & Not authorized before reporting period - Quit.
"RTN","IBTUBO1",69,0)
 . I $G(IBCOMP),$P(IBDATA,U,3)>IBEDT Q
"RTN","IBTUBO1",70,0)
 . ;
"RTN","IBTUBO1",71,0)
 . ; - The episode has been billed. Check the revenue code multiple for
"RTN","IBTUBO1",72,0)
 . ;   all procedures billed on the claim.
"RTN","IBTUBO1",73,0)
 . S IBYY=0
"RTN","IBTUBO1",74,0)
 . F  S IBYY=$O(^DGCR(399,IBXX,"RC",IBYY)) Q:'IBYY  S IBYD=^(IBYY,0) D
"RTN","IBTUBO1",75,0)
 . . ;
"RTN","IBTUBO1",76,0)
 . . ; - Get the procedure code and charge type for the revenue code.
"RTN","IBTUBO1",77,0)
 . . S IBZ=$P(IBYD,U,6)
"RTN","IBTUBO1",78,0)
 . . S IBCT=$S($P(IBYD,U,12):$P(IBYD,U,12),1:$P(IBDATA,U,4))
"RTN","IBTUBO1",79,0)
 . . I 'IBZ!('IBCT) Q  ; Can't determine code/charge type for procedure.
"RTN","IBTUBO1",80,0)
 . . ; Delete procedure from unbilled procedures array.
"RTN","IBTUBO1",81,0)
 . . I $D(IBCPT(IBZ,IBCT)) K IBCPT(IBZ,IBCT) Q
"RTN","IBTUBO1",82,0)
 . . K IBCPT(IBZ)
"RTN","IBTUBO1",83,0)
 ;
"RTN","IBTUBO1",84,0)
 ; - Again, quit if no billable procedures remain.
"RTN","IBTUBO1",85,0)
 I '$D(IBCPT) G OPTQ
"RTN","IBTUBO1",86,0)
 ;
"RTN","IBTUBO1",87,0)
 ; - The encounter has unbilled procedure codes. Increment the counters
"RTN","IBTUBO1",88,0)
 ;   as per the extract specification.
"RTN","IBTUBO1",89,0)
 ;
"RTN","IBTUBO1",90,0)
 ; - Count the encounter (element 37N).
"RTN","IBTUBO1",91,0)
 S IBUNB("ENCNTRS")=IBUNB("ENCNTRS")+1 S:$G(IBXTRACT) IB(14)=IB(14)+1
"RTN","IBTUBO1",92,0)
 ;
"RTN","IBTUBO1",93,0)
 ; - Look at all the unbilled procedures.
"RTN","IBTUBO1",94,0)
 S IBZ=0 F  S IBZ=$O(IBCPT(IBZ)) Q:'IBZ  D
"RTN","IBTUBO1",95,0)
 . ;
"RTN","IBTUBO1",96,0)
 . ; - Count the procedure (element 37M).
"RTN","IBTUBO1",97,0)
 . I $G(IBXTRACT) S IB(13)=IB(13)+1
"RTN","IBTUBO1",98,0)
 . ;
"RTN","IBTUBO1",99,0)
 . ; - Count the institutional component (element 37I) and its
"RTN","IBTUBO1",100,0)
 . ;   corresponding charge amount (element 37J).
"RTN","IBTUBO1",101,0)
 . I $G(IBCPT(IBZ,1)) D
"RTN","IBTUBO1",102,0)
 . . S IBUNB("CPTMS-I")=IBUNB("CPTMS-I")+1
"RTN","IBTUBO1",103,0)
 . . S IBUNB("UNBILOP")=IBUNB("UNBILOP")+IBCPT(IBZ,1)
"RTN","IBTUBO1",104,0)
 . . I $G(IBXTRACT) S IB(9)=IB(9)+1,IB(10)=IB(10)+IBCPT(IBZ,1)
"RTN","IBTUBO1",105,0)
 . ;
"RTN","IBTUBO1",106,0)
 . ; - Count the professional component (element 37K) and its
"RTN","IBTUBO1",107,0)
 . ;   corresponding charge amount (element 37L).
"RTN","IBTUBO1",108,0)
 . I $G(IBCPT(IBZ,2)) D
"RTN","IBTUBO1",109,0)
 . . S IBUNB("CPTMS-P")=IBUNB("CPTMS-P")+1
"RTN","IBTUBO1",110,0)
 . . S IBUNB("UNBILOP")=IBUNB("UNBILOP")+IBCPT(IBZ,2)
"RTN","IBTUBO1",111,0)
 . . I $G(IBXTRACT) S IB(11)=IB(11)+1,IB(12)=IB(12)+IBCPT(IBZ,2)
"RTN","IBTUBO1",112,0)
 ;
"RTN","IBTUBO1",113,0)
 D SETUB
"RTN","IBTUBO1",114,0)
 ;
"RTN","IBTUBO1",115,0)
OPTQ Q
"RTN","IBTUBO1",116,0)
 ;
"RTN","IBTUBO1",117,0)
PRERC ; - Determine if a pre-9/1/99 visit has been billed.
"RTN","IBTUBO1",118,0)
 ;   Output: IBQUIT will be set to 1 if the visit has been billed.
"RTN","IBTUBO1",119,0)
 ;   *Pre-set variables DFN,IBDAY,IBDET,IBNAME,IBNCF,IBQUIT,IBRT,IBEDT
"RTN","IBTUBO1",120,0)
 ;    and IB/IBUNB arrays required.
"RTN","IBTUBO1",121,0)
 I $D(^TMP($J,"IBTUB-OPT",IBNAME_"@@"_DFN,IBDAY)) S IBQUIT=1 G PRCQ
"RTN","IBTUBO1",122,0)
 ;
"RTN","IBTUBO1",123,0)
 ; - Check all outpatient claims on event date.
"RTN","IBTUBO1",124,0)
 N IBXX S IBXX=0
"RTN","IBTUBO1",125,0)
 F  S IBXX=$O(^DGCR(399,"AOPV",DFN,IBDAY,IBXX)) Q:'IBXX  D  Q:IBQUIT
"RTN","IBTUBO1",126,0)
 . ;
"RTN","IBTUBO1",127,0)
 . ; - Perform general checks on the claim.
"RTN","IBTUBO1",128,0)
 . S IBDATA=$$CKBIL^IBTUBOU(IBXX) Q:IBDATA=""  S IBNCF=IBNCF+1
"RTN","IBTUBO1",129,0)
 . ;
"RTN","IBTUBO1",130,0)
 . ; If Compile/Store & Not authorized before reporting period - Quit.
"RTN","IBTUBO1",131,0)
 . I $G(IBCOMP),$P(IBDATA,U,3)>IBEDT Q
"RTN","IBTUBO1",132,0)
 . ;
"RTN","IBTUBO1",133,0)
 . S IBQUIT=1 ; Episode has been billed-set flag.
"RTN","IBTUBO1",134,0)
 ;
"RTN","IBTUBO1",135,0)
 I IBQUIT G PRCQ ; Epsiode was billed.
"RTN","IBTUBO1",136,0)
 ;
"RTN","IBTUBO1",137,0)
 ; - The episode was not billed; determine the tort rate for a visit
"RTN","IBTUBO1",138,0)
 ;   and increment the number and amount of unbilled pre-9/1/99 visits.
"RTN","IBTUBO1",139,0)
 S IBXX=+$$BICOST^IBCRCI(IBRT,3,IBDAY,"OUTPATIENT VISIT DATE")
"RTN","IBTUBO1",140,0)
 S IBUNB("UNBILOP")=IBUNB("UNBILOP")+IBXX
"RTN","IBTUBO1",141,0)
 S IBUNB("ENCNTRS")=IBUNB("ENCNTRS")+1
"RTN","IBTUBO1",142,0)
 ;
"RTN","IBTUBO1",143,0)
 I $G(IBXTRACT) S IB(7)=IB(7)+1,IB(8)=IB(8)+IBXX ; For DM extract.
"RTN","IBTUBO1",144,0)
 ;
"RTN","IBTUBO1",145,0)
PRCQ Q
"RTN","IBTUBO1",146,0)
 ;
"RTN","IBTUBO1",147,0)
NOOE ; - If there is no encounter, look for add/edits or registrations.
"RTN","IBTUBO1",148,0)
 ;   Output: IBQUIT will be set to 1 if the visit is non-billable.
"RTN","IBTUBO1",149,0)
 ;   *Pre-set variable IBQUIT required.
"RTN","IBTUBO1",150,0)
 N IBDATA,IBSC,IBSDV,IBXX,IBZERR
"RTN","IBTUBO1",151,0)
 ;
"RTN","IBTUBO1",152,0)
 ; - Check if for a visit at the visit date/time.
"RTN","IBTUBO1",153,0)
 S IBXX=$$EXOE^SDOE(DFN,IBDT,IBDT,"","IBZERR")
"RTN","IBTUBO1",154,0)
 I IBXX D CKENC^IBTUBOU(IBXX,"",.IBQUIT) G NOOEQ
"RTN","IBTUBO1",155,0)
 ;
"RTN","IBTUBO1",156,0)
 ; - Find next add/edit stop code encounter after IBDT.
"RTN","IBTUBO1",157,0)
 D SCAN^IBTUBOU(DFN,IBDT,.IBQUERY)
"RTN","IBTUBO1",158,0)
 ;
"RTN","IBTUBO1",159,0)
NOOEQ Q
"RTN","IBTUBO1",160,0)
 ;
"RTN","IBTUBO1",161,0)
SETUB ; Set array elements for the detail report.
"RTN","IBTUBO1",162,0)
 ; Array element format:
"RTN","IBTUBO1",163,0)
 ;  ^TMP($J,"IBTUB-OPT",NAME@@DFN,DATE,IBX)=bill status^claim type
"RTN","IBTUBO1",164,0)
 ;  ^TMP($J,"IBTUB-OPT",NAME@@DFN,DATE,IBX,CPT no)=inst rate^prof rate
"RTN","IBTUBO1",165,0)
 ;
"RTN","IBTUBO1",166,0)
 N IBCTF
"RTN","IBTUBO1",167,0)
 S ^TMP($J,"IBTUB-OPT",IBNAME_"@@"_DFN,IBDAY,IBX)=IBNCF G:'IBDET SETUBQ
"RTN","IBTUBO1",168,0)
 I $D(IBCPT) S IBXX=0 F  S IBXX=$O(IBCPT(IBXX)) Q:'IBXX  D
"RTN","IBTUBO1",169,0)
 . S IBCTF=$S($G(IBCPT(IBXX,1)):"I",1:"")
"RTN","IBTUBO1",170,0)
 . S IBCTF=$S($G(IBCPT(IBXX,2)):$S(IBCTF="I":"I,P",1:"P"),1:IBCTF)
"RTN","IBTUBO1",171,0)
 . S ^TMP($J,"IBTUB-OPT",IBNAME_"@@"_DFN,IBDAY,IBX,IBXX)=+$G(IBCPT(IBXX,1))_U_+$G(IBCPT(IBXX,2))_U_IBCTF
"RTN","IBTUBO1",172,0)
 ;
"RTN","IBTUBO1",173,0)
SETUBQ Q
"VER")
8.0^22
**END**
**END**
