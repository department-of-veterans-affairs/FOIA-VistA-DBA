Released PSJ*5*149 SEQ #138
Extracted from mail message
**KIDS**:PSJ*5.0*149^

**INSTALL NAME**
PSJ*5.0*149
"BLD",6320,0)
PSJ*5.0*149^INPATIENT MEDICATIONS^0^3050829^y
"BLD",6320,1,0)
^^10^10^3050715^^
"BLD",6320,1,1,0)
     This patch addresses two separate issues.  In the first issue,
"BLD",6320,1,2,0)
     if the ward group or ward location is not properly defined, or
"BLD",6320,1,3,0)
     if the administration team is not properly defined, patients and
"BLD",6320,1,4,0)
      or medications can be left off of the Action Profile-2 Report
"BLD",6320,1,5,0)
     [PSJU AP-2].
"BLD",6320,1,6,0)
  
"BLD",6320,1,7,0)
     The second issue addressed by this patch will make CPRS and backdoor
"BLD",6320,1,8,0)
     pharmacy function consistently with respect to discontinuing an
"BLD",6320,1,9,0)
     original order while it has a pending renewal.  CPRS will not allow
"BLD",6320,1,10,0)
     the original order to be discontinued, backdoor currently will.
"BLD",6320,4,0)
^9.64PA^^
"BLD",6320,6)
2^
"BLD",6320,"ABPKG")
n
"BLD",6320,"KRN",0)
^9.67PA^8989.52^19
"BLD",6320,"KRN",.4,0)
.4
"BLD",6320,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",.401,0)
.401
"BLD",6320,"KRN",.402,0)
.402
"BLD",6320,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",.403,0)
.403
"BLD",6320,"KRN",.5,0)
.5
"BLD",6320,"KRN",.84,0)
.84
"BLD",6320,"KRN",3.6,0)
3.6
"BLD",6320,"KRN",3.8,0)
3.8
"BLD",6320,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",9.2,0)
9.2
"BLD",6320,"KRN",9.8,0)
9.8
"BLD",6320,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6320,"KRN",9.8,"NM",1,0)
PSGCAP0^^0^21979348
"BLD",6320,"KRN",9.8,"NM",2,0)
PSGCAPP^^0^13989426
"BLD",6320,"KRN",9.8,"NM",3,0)
PSJOE^^0^83953005
"BLD",6320,"KRN",9.8,"NM",4,0)
PSJLIORD^^0^9649309
"BLD",6320,"KRN",9.8,"NM","B","PSGCAP0",1)

"BLD",6320,"KRN",9.8,"NM","B","PSGCAPP",2)

"BLD",6320,"KRN",9.8,"NM","B","PSJLIORD",4)

"BLD",6320,"KRN",9.8,"NM","B","PSJOE",3)

"BLD",6320,"KRN",19,0)
19
"BLD",6320,"KRN",19,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",19.1,0)
19.1
"BLD",6320,"KRN",19.1,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",101,0)
101
"BLD",6320,"KRN",101,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",409.61,0)
409.61
"BLD",6320,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",771,0)
771
"BLD",6320,"KRN",771,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",870,0)
870
"BLD",6320,"KRN",870,"NM",0)
^9.68A^^0
"BLD",6320,"KRN",8989.51,0)
8989.51
"BLD",6320,"KRN",8989.52,0)
8989.52
"BLD",6320,"KRN",8994,0)
8994
"BLD",6320,"KRN","B",.4,.4)

"BLD",6320,"KRN","B",.401,.401)

"BLD",6320,"KRN","B",.402,.402)

"BLD",6320,"KRN","B",.403,.403)

"BLD",6320,"KRN","B",.5,.5)

"BLD",6320,"KRN","B",.84,.84)

"BLD",6320,"KRN","B",3.6,3.6)

"BLD",6320,"KRN","B",3.8,3.8)

"BLD",6320,"KRN","B",9.2,9.2)

"BLD",6320,"KRN","B",9.8,9.8)

"BLD",6320,"KRN","B",19,19)

"BLD",6320,"KRN","B",19.1,19.1)

"BLD",6320,"KRN","B",101,101)

"BLD",6320,"KRN","B",409.61,409.61)

"BLD",6320,"KRN","B",771,771)

"BLD",6320,"KRN","B",870,870)

"BLD",6320,"KRN","B",8989.51,8989.51)

"BLD",6320,"KRN","B",8989.52,8989.52)

"BLD",6320,"KRN","B",8994,8994)

"BLD",6320,"QUES",0)
^9.62^^
"BLD",6320,"REQB",0)
^9.611^3^3
"BLD",6320,"REQB",1,0)
PSJ*5.0*111^1
"BLD",6320,"REQB",2,0)
PSJ*5.0*151^1
"BLD",6320,"REQB",3,0)
PSJ*5.0*110^1
"BLD",6320,"REQB","B","PSJ*5.0*110",3)

"BLD",6320,"REQB","B","PSJ*5.0*111",1)

"BLD",6320,"REQB","B","PSJ*5.0*151",2)

"MBREQ")
0
"PKG",203,-1)
1^1
"PKG",203,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",203,22,0)
^9.49I^1^1
"PKG",203,22,1,0)
5.0^2971215^2980417^1271
"PKG",203,22,1,"PAH",1,0)
149^3050829^33234
"PKG",203,22,1,"PAH",1,1,0)
^^10^10^3050829
"PKG",203,22,1,"PAH",1,1,1,0)
     This patch addresses two separate issues.  In the first issue,
"PKG",203,22,1,"PAH",1,1,2,0)
     if the ward group or ward location is not properly defined, or
"PKG",203,22,1,"PAH",1,1,3,0)
     if the administration team is not properly defined, patients and
"PKG",203,22,1,"PAH",1,1,4,0)
      or medications can be left off of the Action Profile-2 Report
"PKG",203,22,1,"PAH",1,1,5,0)
     [PSJU AP-2].
"PKG",203,22,1,"PAH",1,1,6,0)
  
"PKG",203,22,1,"PAH",1,1,7,0)
     The second issue addressed by this patch will make CPRS and backdoor
"PKG",203,22,1,"PAH",1,1,8,0)
     pharmacy function consistently with respect to discontinuing an
"PKG",203,22,1,"PAH",1,1,9,0)
     original order while it has a pending renewal.  CPRS will not allow
"PKG",203,22,1,"PAH",1,1,10,0)
     the original order to be discontinued, backdoor currently will.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSGCAP0")
0^1^B21979348
"RTN","PSGCAP0",1,0)
PSGCAP0 ;BIR/CML3-ACTION PROFILE ;12 Mar 98 / 9:30 AM
"RTN","PSGCAP0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**8,58,111,149**;16 DEC 97
"RTN","PSGCAP0",3,0)
 ;
"RTN","PSGCAP0",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191
"RTN","PSGCAP0",5,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192
"RTN","PSGCAP0",6,0)
 ;
"RTN","PSGCAP0",7,0)
GOD ; gather order data
"RTN","PSGCAP0",8,0)
 S ND=$G(^PS(55,PSGP,5,PSJJORD,0)),ND2=$G(^(2)),SI=$P($G(^(6)),"^"),DRG=$G(^(.2)) ;WS=$S(DRG&PSGAPWD:$D(^PSI(58.1,"D",+DRG,PSGAPWD)),1:0)
"RTN","PSGCAP0",9,0)
 S X=$$NFWS^PSJUTL1(PSGP,PSJJORD_"U",PSGAPWD) S NF=$P(X,U),WS=$P(X,U,2),SM=$S('$P(X,U,3):0,$P(X,U,4):1,1:2)
"RTN","PSGCAP0",10,0)
 N X,PSG
"RTN","PSGCAP0",11,0)
 D DRGDISP^PSJLMUT1(PSGP,PSJJORD_"U",20,0,.PSG,1)
"RTN","PSGCAP0",12,0)
 S DRG=PSG(1),DRG=$S(DRG["NOT FOUND":"z",1:DRG) ;SM=$S('$P(ND,"^",5):0,$P(ND,"^",6):1,1:2)
"RTN","PSGCAP0",13,0)
 S ST=$S($P(ND,U,27)="R"&($P(ND,U,9)="A"):"R",1:$P(ND,U,9)),ND=$P(ND,"^",7)
"RTN","PSGCAP0",14,0)
 N DDRG S (X,DCU)=0 F  S X=$O(^PS(55,PSGP,5,PSJJORD,1,X)) Q:'X  S DDRG=^(X,0),DCU=DCU+($P($G(^PSDRUG(+DDRG,660)),"^",6)*($S($P(DDRG,"^",2):$P(DDRG,"^",2),1:1)))
"RTN","PSGCAP0",15,0)
 ;
"RTN","PSGCAP0",16,0)
 ;
"RTN","PSGCAP0",17,0)
 S SD=$P(ND2,"^",2),FD=$P(ND2,"^",4) F X="SD","FD" S @X=$E($$ENDTC^PSGMI(@X),1,5)
"RTN","PSGCAP0",18,0)
 ;S Y=SI S:Y]"" Y=$$ENSET^PSGSICHK(Y) S:'$G(PSGAPWDN) PSGAPWDN=PSJPWDN S ^TMP($J,S1,PSGAPWDN,PN,ND_"^"_DRG,PSJJORD)=ST_"^"_SD_"^"_FD_"^"_WS_"^"_SM_"^"_NF_"^"_DCU_"^"_DRG S:Y]"" ^(PSJJORD,1)=Y Q
"RTN","PSGCAP0",19,0)
 S Y=SI S:Y]"" Y=$$ENSET^PSGSICHK(Y) S PSGAPWDN=$S($G(PSGAPWD)="zz":"zz",$G(PSGAPWDN):PSGAPWDN,'$G(PSGAPWDN):PSJPWDN,1:"zz"),^TMP($J,S1,PSGAPWDN,PN,ND_"^"_DRG,PSJJORD)=ST_"^"_SD_"^"_FD_"^"_WS_"^"_SM_"^"_NF_"^"_DCU_"^"_DRG S:Y]"" ^(PSJJORD,1)=Y Q
"RTN","PSGCAP0",20,0)
 ;
"RTN","PSGCAP0",21,0)
PAT ;
"RTN","PSGCAP0",22,0)
 D PSJAC2^PSJAC(1),NOW^%DTC S PSGDT=%,PN=$E($P(PSGP(0),"^"),1,20)_"^"_PSGP
"RTN","PSGCAP0",23,0)
 S S1="zz" I PSGAPS="T",PSJPWD,PSJPRB]"",$D(^PS(57.7,PSJPWD,1,+$O(^PS(57.7,"AWRT",PSJPWD,PSJPRB,0)),0)),$P(^(0),"^")]"" S S1=$P(^(0),"^")
"RTN","PSGCAP0",24,0)
 I PSGAPS="P",PSJPTSP,$D(^VA(200,PSJPTSP,0)),$P(^(0),"^")]"" S S1=$P(^(0),"^")
"RTN","PSGCAP0",25,0)
 S:PSGMTYPE[1 PSGMTYPE="2,3,4,5,6"
"RTN","PSGCAP0",26,0)
 I PSGMTYPE[2 D
"RTN","PSGCAP0",27,0)
 . F STRT=PSGAPSD-.0001:0 S STRT=$O(^PS(55,PSGP,5,"AUS",STRT)) Q:$S('STRT:1,PSGAPO="E":STRT>PSGAPFD,1:0)  I STRT'=PSGAPSD F PSJJORD=0:0 S PSJJORD=$O(^PS(55,PSGP,5,"AUS",STRT,PSJJORD)) Q:'PSJJORD  D GOD
"RTN","PSGCAP0",28,0)
 . S XTYPE=2,PST="S" D ^PSGCAPIV
"RTN","PSGCAP0",29,0)
 N XTYPE F XTYPE=3:1:6 I PSGMTYPE[XTYPE S PST=$S(XTYPE=3:"P",XTYPE=4:"A",XTYPE=5:"H",1:"C") D ^PSGCAPIV
"RTN","PSGCAP0",30,0)
 I PSGMTYPE[3 S XTYPE=3,PST="S" D ^PSGCAPIV ;* Find syringe type iv
"RTN","PSGCAP0",31,0)
 I $D(^TMP($J,S1,PSGAPWDN,PN)) S ^(PN)=$P(PSJPSEX,"^",2)_"^"_$E($P(PSJPDOB,"^",2),1,10)_";"_PSJPAGE_"^"_VA("PID")_"^"_PSJPDX_"^"_$S(PSJPRB]"":PSJPRB,1:"*NF*")_"^"_$E($P(PSJPAD,"^",2),1,10)_"^"_$E($P(PSJPTD,"^",2),1,10)
"RTN","PSGCAP0",32,0)
 I  S ^TMP($J,S1,PSGAPWDN,PN)=^(PN)_"^"_PSJPWT_"^"_PSJPWTD_"^"_PSJPHT_"^"_PSJPHTD_"^"_$P(PSGP(0),"^")
"RTN","PSGCAP0",33,0)
 Q
"RTN","PSGCAP0",34,0)
 ;
"RTN","PSGCAP0",35,0)
ENQ ; queued entry point
"RTN","PSGCAP0",36,0)
 N ALFLG,DCU,DRGI,DRGN,DRGT,KKA,HT,HTD,ON,PST,PSIVUP,PSJORIFN,QST,WTD,XTYPE
"RTN","PSGCAP0",37,0)
 K ^TMP($J) S STT=PSGAPSD-.0001,PSJACNWP=1 D @("P"_PSGSS),^PSGCAPP D ^%ZISC
"RTN","PSGCAP0",38,0)
 Q
"RTN","PSGCAP0",39,0)
 ;
"RTN","PSGCAP0",40,0)
PG ;
"RTN","PSGCAP0",41,0)
 I PSGAPWD="zz" D CLIN Q
"RTN","PSGCAP0",42,0)
 F PSGAPWD=0:0 S PSGAPWD=$O(^PS(57.5,"AC",PSGAPWG,PSGAPWD)) Q:'PSGAPWD  I $D(^DIC(42,PSGAPWD,0)),$P(^(0),"^")]"" S PSGAPWDN=$P(^(0),"^") D PW
"RTN","PSGCAP0",43,0)
 Q
"RTN","PSGCAP0",44,0)
 ;
"RTN","PSGCAP0",45,0)
PW ;
"RTN","PSGCAP0",46,0)
 F PSGP=0:0 S PSGP=$O(^DPT("CN",PSGAPWDN,PSGP)) Q:'PSGP  D PAT
"RTN","PSGCAP0",47,0)
 Q
"RTN","PSGCAP0",48,0)
 ;
"RTN","PSGCAP0",49,0)
PP ;
"RTN","PSGCAP0",50,0)
 F PSGP=0:0 S PSGP=$O(PSGPAT(PSGP)) Q:'PSGP  S PSGAPWDN=$P($G(^DPT(PSGP,.1)),"^") S:PSGAPWDN]"" PSGAPWD=+$O(^DIC(42,"B",PSGAPWDN,0)) S:PSGAPWDN="" PSGAPWDN="zz" D PAT
"RTN","PSGCAP0",51,0)
 Q
"RTN","PSGCAP0",52,0)
 ;
"RTN","PSGCAP0",53,0)
PL S CL="" F  S CL=$O(^PS(57.8,"AD",CG,CL)) Q:CL=""  D PC
"RTN","PSGCAP0",54,0)
 Q
"RTN","PSGCAP0",55,0)
PC S PSGAPWDN=$S($D(^SC(CL,0)):$P(^(0),"^"),1:"")
"RTN","PSGCAP0",56,0)
 S PSGP="" F  S PSGP=$O(^PS(53.1,"AD",CL,PSGP)) Q:PSGP=""  D PAT
"RTN","PSGCAP0",57,0)
 N INDEX,APSTOP
"RTN","PSGCAP0",58,0)
 F INDEX="AIVC","AUDC" S APSTOP=0 F  S APSTOP=$O(^PS(55,INDEX,APSTOP)) Q:'APSTOP  D
"RTN","PSGCAP0",59,0)
 . S DFN=0 F  S DFN=$O(^PS(55,INDEX,APSTOP,CL,DFN)) Q:'DFN  I '$D(^TMP("PSGAP0",$J,"OUTPT",DFN)) S PSGP=DFN,Q=APSTOP,PSGAPWD="zz" D PAT
"RTN","PSGCAP0",60,0)
 Q
"RTN","PSGCAP0",61,0)
CLIN ;
"RTN","PSGCAP0",62,0)
 N INDEX,APSTOP,CLIN
"RTN","PSGCAP0",63,0)
 F INDEX="AIVC","AUDC" S APSTOP=0 F  S APSTOP=$O(^PS(55,INDEX,APSTOP)) Q:'APSTOP  S CLIN=0 F  S CLIN=$O(^PS(55,INDEX,APSTOP,CLIN)) Q:'CLIN  D
"RTN","PSGCAP0",64,0)
 . S DFN=0 F  S DFN=$O(^PS(55,INDEX,APSTOP,CLIN,DFN)) Q:'DFN  I '$D(^TMP("PSGAP0",$J,"OUTPT",DFN)) S PSGP=DFN,Q=APSTOP,PSGAPWD="zz" D PAT
"RTN","PSGCAP0",65,0)
 Q
"RTN","PSGCAP0",66,0)
 ;
"RTN","PSGCAP0",67,0)
ENOR ;
"RTN","PSGCAP0",68,0)
 D ENCV^PSGSETU I $D(XQUIT) Q
"RTN","PSGCAP0",69,0)
 S (DFN,PSGP)=+ORVP D ^PSJAC S PSGPAT=PSGP,PSGPAT(DFN)="",(PSGAP,PSGAPWD,PSGAPWG)=0,(PSGAPWDN,PSGAPWGN)="",PSGSS="P" D ORS^PSGCAP S PSJNKF=1 D DONE^PSGCAP Q
"RTN","PSGCAPP")
0^2^B13989426
"RTN","PSGCAPP",1,0)
PSGCAPP ;BIR/CML3-PRINT DATA FOR ACTION PROFILE ;05 Oct 98 / 10:21 AM
"RTN","PSGCAPP",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**8,20,60,111,149**;16 DEC 97
"RTN","PSGCAPP",3,0)
LOOP ;
"RTN","PSGCAPP",4,0)
 D NOW^%DTC S PSGDT=%,PSGPDT=$$ENDTC2^PSGMI(PSGDT),CML=IO'=IO(0)!($E(IOST,1,2)'="C-")
"RTN","PSGCAPP",5,0)
 U IO I '$D(^TMP($J)) D  G DONE
"RTN","PSGCAPP",6,0)
 .W:$Y @IOF W !?26,"UNIT DOSE ACTION PROFILE #2",?62,PSGPDT,!?10,"NO ",$S(PSGAPO="E":"EXPIRING",1:"ACTIVE")," ORDERS FOUND FOR ",$S(PSGSS="G":"WARD GROUP: "_PSGAPWGN,PSGSS="W":"WARD: "_PSGAPWDN,1:"PATIENT(S) SELECTED"),"."
"RTN","PSGCAPP",7,0)
 S (LN,LINE,ALN,S1,WD,PN)="",$P(LN,"_",19)="",$P(LINE,"-",81)="",$P(ALN," -",18)="",ALN=ALN_" A C T I V E"_ALN
"RTN","PSGCAPP",8,0)
 S PSGVAMC=$$SITE^PSGMMAR2(80)
"RTN","PSGCAPP",9,0)
 F  S (PS1,S1,PSJTEAM)=$O(^TMP($J,S1)) Q:S1=""!$D(PSJDLW)  S:S1="zz" (PS1,PSJTEAM)="NOT FOUND" F  S WD=$O(^TMP($J,S1,WD)) Q:WD=""!$D(PSJDLW)  D
"RTN","PSGCAPP",10,0)
 . F  S PN=$O(^TMP($J,S1,WD,PN)) Q:PN=""!$D(PSJDLW)  S PI=$G(^(PN)) S:PI="" PI=$G(^TMP($J,S1,"zz",PN)) D H1
"RTN","PSGCAPP",11,0)
 ;
"RTN","PSGCAPP",12,0)
DONE ;PSJ*5*149 Add WD1 to killed variables.
"RTN","PSGCAPP",13,0)
 W:CML&($Y) @IOF K AD,ALN,CML,DF,LINE,LN,MF,N,PG,PI,PPN,PS1,PSGPDT,RCT,RF,PID,TD,WD,PSJDLW,PSGVAMC,WD1 Q
"RTN","PSGCAPP",14,0)
 ;
"RTN","PSGCAPP",15,0)
H1 ; first header for patient
"RTN","PSGCAPP",16,0)
 ; PSJ*5*149 Use WD1 to preserve value of WD
"RTN","PSGCAPP",17,0)
 N WD1
"RTN","PSGCAPP",18,0)
 I $G(WD)="zz" S WD1=WD N WD S WD="*NF*"
"RTN","PSGCAPP",19,0)
 D ^PSGCAPP0
"RTN","PSGCAPP",20,0)
 S WD=$G(WD1,WD)
"RTN","PSGCAPP",21,0)
END ;
"RTN","PSGCAPP",22,0)
 S (ON,DRG)="" F  S DRG=$O(^TMP($J,S1,WD,PN,DRG)) Q:DRG=""  F  S ON=$O(^TMP($J,S1,WD,PN,DRG,ON)) Q:ON=""  S ND=^(ON),SI=$G(^(ON,1)) D NP:$Y+12>IOSL Q:$D(PSJDLW)  D ORDP
"RTN","PSGCAPP",23,0)
 Q:$D(PSJDLW)
"RTN","PSGCAPP",24,0)
 I $D(^PS(53.1,"AC",PSGP)) W !!?13,"******** THIS PATIENT HAS NON-VERIFIED ORDERS. ********"
"RTN","PSGCAPP",25,0)
 S DF=1 W:'$D(PSJDLW) !!?16,LN,?40,LN_LN,!?16,"Date AND Time",?40,"PROVIDER'S SIGNATURE"
"RTN","PSGCAPP",26,0)
 D:$Y+10>IOSL NP1 W:'$D(PSJDLW) !!!?10,"MULTIDISCIPLINARY REVIEW",!?16,"(WHEN APPROPRIATE)",?40,LN_LN,!?40,"PHARMACIST'S SIGNATURE"
"RTN","PSGCAPP",27,0)
 D:$Y+6>IOSL NP1 W:'$D(PSJDLW) !!?40,LN_LN,!?40,"NURSE'S SIGNATURE"
"RTN","PSGCAPP",28,0)
 I IOSL-$Y>10 W !!?3,"ADDITIONAL MEDICATION ORDERS:" F  W !!,LINE Q:$Y+9>IOSL
"RTN","PSGCAPP",29,0)
 I  W:'$D(PSJDLW) !!?16,LN,?40,LN_LN,!?16,"Date AND Time",?40,"PROVIDER'S SIGNATURE",!
"RTN","PSGCAPP",30,0)
 E  F Q=$Y+5:1:IOSL-1 W !
"RTN","PSGCAPP",31,0)
 W:'$D(PSJDLW) !?2,PPN,?40,PID,?78-$L(PDOB),PDOB Q
"RTN","PSGCAPP",32,0)
 ;
"RTN","PSGCAPP",33,0)
ORDP ;
"RTN","PSGCAPP",34,0)
 S N=N+1 I ON["V" D PRT^PSGCAPIV(ON) Q
"RTN","PSGCAPP",35,0)
 N X,PSG S PSGP=$P(PN,U,2)
"RTN","PSGCAPP",36,0)
 D DRGDISP^PSJLMUT1(+PSGP,+ON_"U",39,69,.PSG,0)
"RTN","PSGCAPP",37,0)
 S SM=$P(ND,"^",5),NF=$P(ND,"^",6),DCU=$P(ND,"^",7),DCU=$S($E(DCU)=".":"0"_DCU,'DCU:"0.00",1:DCU) W !,$J(N,3)
"RTN","PSGCAPP",38,0)
 W ?5,PSG(1),?46,$P(DRG,"^"),?49,$P(ND,"^",2),?55,$P(ND,"^",3),?61,$P(ND,"^") I NF!SM!$P(ND,"^",4) W ?65 W:NF "NF " W:$P(ND,"^",4) "WS " W:SM $E("HSM",SM,3)
"RTN","PSGCAPP",39,0)
 N X F X=1:0 S X=$O(PSG(X)) Q:'X  W !?5,PSG(X)
"RTN","PSGCAPP",40,0)
 I SI]"" W !?8,"Special Instructions: " F X=1:1:$L(SI," ") S Y=$P(SI," ",X) W:$X+$L(Y)>78 !?31 W Y," "
"RTN","PSGCAPP",41,0)
ORDP1 ;*** Also being called from ^PSGCAPIV.
"RTN","PSGCAPP",42,0)
 W !!?5,"__TAKE NO ACTION     __DISCONTINUE     __RENEW   COST/DOSE: ",DCU,!?2,"------------------------------------------------------------------------",! Q
"RTN","PSGCAPP",43,0)
 ;
"RTN","PSGCAPP",44,0)
NP ;
"RTN","PSGCAPP",45,0)
 W:'$D(PSJDLW) !!?16,LN,?40,LN_LN,!?16,"Date AND Time",?40,"PROVIDER'S SIGNATURE"
"RTN","PSGCAPP",46,0)
 ;
"RTN","PSGCAPP",47,0)
NP1 ;
"RTN","PSGCAPP",48,0)
 Q:$D(PSJDLW)
"RTN","PSGCAPP",49,0)
 I $E(IOST,1)="C" K DIR S DIR(0)="E" D ^DIR K DIR I $D(DTOUT)!$D(DUOUT) S PSJDLW=1 Q
"RTN","PSGCAPP",50,0)
 F Q=$Y:1:IOSL-4 W !
"RTN","PSGCAPP",51,0)
 ;* S PG=PG+1 W !?2,PPN,?40,PID,?78-$L(PDOB),PDOB W:$Y @IOF W !?28,"UNIT DOSE ACTION PROFILE #2",?73-$L(PG),"Page: "_PG,!?1,PPN,?40,PID,?60,PDOB I DF W !!,LINE Q
"RTN","PSGCAPP",52,0)
 S PG=PG+1 W !?2,PPN,?40,PID,?78-$L(PDOB),PDOB W:$Y @IOF
"RTN","PSGCAPP",53,0)
 W !?26,"UNIT DOSE ACTION PROFILE #2",?73-$L(PG),"Page: "_PG
"RTN","PSGCAPP",54,0)
 W !?+PSGVAMC,$P(PSGVAMC,U,2)
"RTN","PSGCAPP",55,0)
 W !?1,PPN,?40,PID,?60,PDOB
"RTN","PSGCAPP",56,0)
 I DF W !!,LINE Q
"RTN","PSGCAPP",57,0)
 W !!," No. Action",?16,"Drug",?46,"ST Start Stop  Status/Info",!,ALN
"RTN","PSGCAPP",58,0)
 Q
"RTN","PSJLIORD")
0^4^B9649309
"RTN","PSJLIORD",1,0)
PSJLIORD ;BIR/MV-INPATIENT ORDER ENTRY FOR IV ;10 Mar 98 / 4:19 PM
"RTN","PSJLIORD",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**1,16,29,58,85,110,149**;16 DEC 97
"RTN","PSJLIORD",3,0)
 ;
"RTN","PSJLIORD",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJLIORD",5,0)
 ; Reference to EN1^ORCFLAG is supported by DBIA #3620.
"RTN","PSJLIORD",6,0)
 ; Reference to AND^ORX8 is supported by DBIA #3632.
"RTN","PSJLIORD",7,0)
 ;
"RTN","PSJLIORD",8,0)
EN(DFN,PSJORD) ; Display order with numbers.
"RTN","PSJLIORD",9,0)
 ;N ON,ON55,P,PSIVAC,PSGEBN,PSGLI,PSJSTAR
"RTN","PSJLIORD",10,0)
 N ON55,P,PSIVAC,PSGEBN,PSGLI,PSJSTAR
"RTN","PSJLIORD",11,0)
 D UDVARS
"RTN","PSJLIORD",12,0)
 S (PSGEBN,PSGLI)=""
"RTN","PSJLIORD",13,0)
 ;* S PSIVAC="C" S (P("PON"),ON,ON55)=+PSJORD_"V"
"RTN","PSJLIORD",14,0)
 S PSIVAC="E" S (P("PON"),ON,ON55)=+PSJORD_"V"
"RTN","PSJLIORD",15,0)
 S PSIVUP=+$$GTPCI^PSIVUTL D GT55^PSIVORFB
"RTN","PSJLIORD",16,0)
 D:'$D(P("OT")) GTOT^PSIVUTL(P(4))
"RTN","PSJLIORD",17,0)
 NEW PSJL
"RTN","PSJLIORD",18,0)
 N PSIVNUM S PSIVNUM=1
"RTN","PSJLIORD",19,0)
 ;;I $E(P("OT"))'="F" S PSJSTAR="(1)^(4)^(5)^(6)^(7)^(9)^(10)"
"RTN","PSJLIORD",20,0)
 I $E(P("OT"))="I" S PSJSTAR="(1)^(4)^(5)^(6)^(7)^(9)^(10)"
"RTN","PSJLIORD",21,0)
 E  S PSJSTAR="(1)^(2)^(3)^(4)^(5)^(6)^(7)^(9)" D GTDATA^PSJLIFN
"RTN","PSJLIORD",22,0)
 NEW PSGACT D PSGACT
"RTN","PSJLIORD",23,0)
 ;* Only allow activity logs for non pharmacist/RN personel if coming
"RTN","PSJLIORD",24,0)
 ;* from the Non-verify/pending option.
"RTN","PSJLIORD",25,0)
 I '+$P(PSJSYSU,";"),$G(PSJPNV) S PSGACT="L"
"RTN","PSJLIORD",26,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE") ; Call to EN^PSJLIVMD
"RTN","PSJLIORD",27,0)
 S VALMBCK="Q"
"RTN","PSJLIORD",28,0)
 Q
"RTN","PSJLIORD",29,0)
 ;
"RTN","PSJLIORD",30,0)
PSGACT ;Setup selectable actions based on order's status
"RTN","PSJLIORD",31,0)
 S (X,XKEYS)=$$CHKKEYS()
"RTN","PSJLIORD",32,0)
 N PSGR S PSGACT=""
"RTN","PSJLIORD",33,0)
 S PSJCOM=$P($G(^PS(55,DFN,"IV",+ON55,.2)),U,8)
"RTN","PSJLIORD",34,0)
 I PSJCOM S PSGR=0
"RTN","PSJLIORD",35,0)
 I PSJCOM S PSGR=$$AND^ORX8(PSJCOM) S:PSGR=1 PSGR=$$RNEWOK^PSJUTL2(PSJCOM,DFN)
"RTN","PSJLIORD",36,0)
 I 'PSJCOM S PSGR='$$EXPIRED^PSGOER(DFN,ON55)
"RTN","PSJLIORD",37,0)
 S X=XKEYS
"RTN","PSJLIORD",38,0)
 ;I P(17)="A" S PSGACT=$S(PSJCOM:"L",1:"EL") S:+X PSGACT=PSGACT_"DO"_$S(P(10):"",1:"H")_$S(PSGR:"R",1:"")
"RTN","PSJLIORD",39,0)
 ;I P(17)="A" S PSGACT="L" S:+X PSGACT=$S(P(10):"DROL",1:"DHROL")
"RTN","PSJLIORD",40,0)
 I P(17)="A" S PSGACT="EL" S:+X PSGACT=PSGACT_"DO"_$S(P(10):"",1:"H")_$S(PSGR:"R",1:"")
"RTN","PSJLIORD",41,0)
 I P(17)="H" S PSGACT="L" S:+X PSGACT=$S(P(10):"DL",1:"DHL")
"RTN","PSJLIORD",42,0)
 I P(17)="R" S PSGACT="L" ;S:+X PSGACT="DL"  PSJ*5*149
"RTN","PSJLIORD",43,0)
 I P(17)="D" S PSGACT="L"
"RTN","PSJLIORD",44,0)
 I P(17)="D"&P(12) S PSGACT="L" S:+X PSGACT="L"_$S(PSGR:"R",1:"")
"RTN","PSJLIORD",45,0)
 I P(17)="E" S PSGACT="L" D:+X
"RTN","PSJLIORD",46,0)
 . I $P($G(^PS(55,DFN,"IV",+ON55,.2)),U,4)="D" Q
"RTN","PSJLIORD",47,0)
 . S PSGACT="L"_$S($P($G(^PS(55,DFN,"IV",+ON55,2)),U,6):"",PSGR:"R",1:"")
"RTN","PSJLIORD",48,0)
 I P(17)="O" S PSGACT="L" S:+X PSGACT="DOL"
"RTN","PSJLIORD",49,0)
 I P(17)="N" S PSGACT="EL" S:+X PSGACT="DELV"
"RTN","PSJLIORD",50,0)
 S PSGACT=PSGACT_$P(X,U,2)
"RTN","PSJLIORD",51,0)
 Q
"RTN","PSJLIORD",52,0)
UDVARS ;* Remove un-use variables.
"RTN","PSJLIORD",53,0)
 K PSGCANFL,PSGDI,PSGDO,PSGEB,PSGEBN,PSGFD,PSGFDN,PSHSM,PSGLI
"RTN","PSJLIORD",54,0)
 K PSGLIN,PSGLMT,PSGMR,PSGMRN,PSGNEF,PSGOAT
"RTN","PSJLIORD",55,0)
 K PSGODO,PSGODT,PSGOEA,PSGOEAV,PSGOEEWF,PSGOENG,PSGOFD,PSGOFDN
"RTN","PSJLIORD",56,0)
 K PSGOHSM,PSGOINST,PSGOMR,PSGOMRN,PSGONC,PSGOPD,PSGOPDN,PSGOPR
"RTN","PSJLIORD",57,0)
 K PSGOPRN,PSGOSCH,PSGOSD,PSGOSDN,PSGOSI,PSGOSM,PSGOST,PSGOSTN
"RTN","PSJLIORD",58,0)
 K PSGPD,PSGPDN,PSGPI,PSGPR,PSGPRIO,PSGPRN,PSGPTMP,PSGRRF,PSGS0XT
"RTN","PSJLIORD",59,0)
 K PSGS0Y,PSGSCH,PSGSD,PSGSDN,PSGSI,PSGSM,PSGST,PSGSTAT,PSGSTN
"RTN","PSJLIORD",60,0)
 K PSGEFN,PSGOEFN,PSGOEEF,PSGOEEG,PSGOEEND,PSGPDRG,PSGPDRGN
"RTN","PSJLIORD",61,0)
 K PSGNESDO,PSGNODE,PSGOEDMR,PSGOEPR,PSGPEN,PSGPENWS
"RTN","PSJLIORD",62,0)
 Q
"RTN","PSJLIORD",63,0)
CHKKEYS()  ;* Check for users' key to set up appropriate actions
"RTN","PSJLIORD",64,0)
 ;Output:
"RTN","PSJLIORD",65,0)
 ;  X=a^b
"RTN","PSJLIORD",66,0)
 ;  a=1 for either RN or Pharmacist; 0 for other
"RTN","PSJLIORD",67,0)
 ;  b="V" if not verified by key owner
"RTN","PSJLIORD",68,0)
 S XX=$G(^PS(55,DFN,"IV",+ON,4)),X=0
"RTN","PSJLIORD",69,0)
 I +PSJSYSU=3 S X=1 D
"RTN","PSJLIORD",70,0)
 . I '+$P(XX,U,4) S $P(X,U,2)="V"
"RTN","PSJLIORD",71,0)
 . I $L($T(EN1^ORCFLAG)) S $P(X,U,2)=$P(X,U,2)_"G"
"RTN","PSJLIORD",72,0)
 I +PSJSYSU=1 S X=1 D
"RTN","PSJLIORD",73,0)
 . I '+XX S $P(X,U,2)="V"
"RTN","PSJLIORD",74,0)
 Q X
"RTN","PSJOE")
0^3^B83953005
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133,140,151,149**;16 DEC 97
"RTN","PSJOE",3,0)
 ;
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",8,0)
 ; Reference to ^DPT is supported by DBIA #10035.
"RTN","PSJOE",9,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",10,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",11,0)
 ;
"RTN","PSJOE",12,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",13,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",14,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",15,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",16,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",17,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",18,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",19,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",20,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",21,0)
 ..K PSGRDTX
"RTN","PSJOE",22,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",23,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",24,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",25,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",26,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",27,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",28,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",29,0)
 ...S NXTPT=1
"RTN","PSJOE",30,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",31,0)
 .S PSJOL="S"
"RTN","PSJOE",32,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",33,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",34,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",35,0)
 ...N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",36,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",37,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",38,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",39,0)
 ;
"RTN","PSJOE",40,0)
DONE ;
"RTN","PSJOE",41,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",42,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",43,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",44,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",45,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",46,0)
 Q
"RTN","PSJOE",47,0)
 ;
"RTN","PSJOE",48,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSJOE",49,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",50,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",51,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",52,0)
 Q:PSGP<0
"RTN","PSJOE",53,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",54,0)
 Q
"RTN","PSJOE",55,0)
 ;
"RTN","PSJOE",56,0)
SELECT ; Select order from list
"RTN","PSJOE",57,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",58,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",59,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",60,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",61,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",62,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",63,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",64,0)
 ..S PSGORD=""
"RTN","PSJOE",65,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",66,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",67,0)
 S VALMBCK="Q"
"RTN","PSJOE",68,0)
 K PSJLM
"RTN","PSJOE",69,0)
 Q
"RTN","PSJOE",70,0)
 ;
"RTN","PSJOE",71,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",72,0)
 ; DFN    - Patient IEN
"RTN","PSJOE",73,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",74,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",75,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55
"RTN","PSJOE",76,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",77,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",78,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",79,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",80,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",81,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",82,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",83,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",84,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",85,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",86,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",87,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",88,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",89,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",90,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",91,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",92,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",93,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",94,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285"),$$SDIMO^SDAMA203(CLINIC,DFN)>-1 Q
"RTN","PSJOE",95,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",96,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",97,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",98,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",99,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM S PSJLM=1,PSGORD=PSJORD D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),@$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") Q
"RTN","PSJOE",100,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI
"RTN","PSJOE",101,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",102,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",103,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",104,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",105,0)
 ;Send SN to CPRS if auto-verify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",106,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",107,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",108,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",109,0)
 Q
"RTN","PSJOE",110,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",111,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",112,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",113,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",114,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",115,0)
 D ACT^PSGOEE
"RTN","PSJOE",116,0)
 Q
"RTN","PSJOE",117,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",118,0)
 D HOLDHDR
"RTN","PSJOE",119,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",120,0)
 I 'PSGRRF D ^PSGOER Q
"RTN","PSJOE",121,0)
 D ^PSGOERI
"RTN","PSJOE",122,0)
 Q
"RTN","PSJOE",123,0)
 ;
"RTN","PSJOE",124,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",125,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",126,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",127,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",128,0)
 ;
"RTN","PSJOE",129,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",130,0)
 D HOLDHDR
"RTN","PSJOE",131,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE")!(X="R") W !,$S(X="R":"This order has a pending renewal and cannot be DISCONTINUED.",1:"This order has already been DISCONTINUED.") D PAUSE^VALM1 Q
"RTN","PSJOE",132,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",133,0)
 S VALMBCK="Q"
"RTN","PSJOE",134,0)
 Q
"RTN","PSJOE",135,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",136,0)
 D HOLDHDR
"RTN","PSJOE",137,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",138,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",139,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",140,0)
 Q
"RTN","PSJOE",141,0)
 ;
"RTN","PSJOE",142,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",143,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",144,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",145,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",146,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",147,0)
 .D COPY^PSIVOD(PSGP,PSGORD) Q
"RTN","PSJOE",148,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",149,0)
 D ^PSJHVARS
"RTN","PSJOE",150,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",151,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",152,0)
 S PSGCOPY=1
"RTN","PSJOE",153,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",154,0)
 S VALMBCK="R"
"RTN","PSJOE",155,0)
 K PSGCOPY
"RTN","PSJOE",156,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",157,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",158,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",159,0)
 Q
"RTN","PSJOE",160,0)
 ;
"RTN","PSJOE",161,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",162,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",163,0)
 Q
"RTN","PSJOE",164,0)
FINISH ;
"RTN","PSJOE",165,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",166,0)
 Q
"RTN","PSJOE",167,0)
 ;
"RTN","PSJOE",168,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",169,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",170,0)
 Q
"RTN","PSJOE",171,0)
NEWSEL ;
"RTN","PSJOE",172,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",173,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",174,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",175,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",176,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",177,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",178,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",179,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",180,0)
 ..S PSGORD=""
"RTN","PSJOE",181,0)
 ..S ON=PSJORD
"RTN","PSJOE",182,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",183,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",184,0)
 ..I $G(PSJNOL) K PSJNOL I $D(ON),ON'=PSJORD D UNL^PSSLOCK(PSGP,ON)
"RTN","PSJOE",185,0)
 ..Q:$G(Y)<0
"RTN","PSJOE",186,0)
 S VALMBCK="Q"
"RTN","PSJOE",187,0)
 K PSJLM
"RTN","PSJOE",188,0)
 Q
"RTN","PSJOE",189,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",190,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",191,0)
 Q
"RTN","PSJOE",192,0)
LOCKERR ;
"RTN","PSJOE",193,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",194,0)
 Q
"RTN","PSJOE",195,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entry point.
"RTN","PSJOE",196,0)
 N ORIFN,NODE0
"RTN","PSJOE",197,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",198,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",199,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",200,0)
 D PAUSE^VALM1
"RTN","PSJOE",201,0)
 Q
"RTN","PSJOE",202,0)
 ;
"RTN","PSJOE",203,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",204,0)
 N NDP2,COM
"RTN","PSJOE",205,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",206,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",207,0)
 Q 0
"VER")
8.0^22.0
"BLD",6320,6)
^138
**END**
**END**
