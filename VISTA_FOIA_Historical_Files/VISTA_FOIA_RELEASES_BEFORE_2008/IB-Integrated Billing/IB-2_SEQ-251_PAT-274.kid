Released IB*2*274 SEQ #251
Extracted from mail message
**KIDS**:IB*2.0*274^

**INSTALL NAME**
IB*2.0*274
"BLD",5568,0)
IB*2.0*274^INTEGRATED BILLING^0^3040722^y
"BLD",5568,1,0)
^^2^2^3040722^^
"BLD",5568,1,1,0)
This patch will use the NEW command to limit the scope of the
"BLD",5568,1,2,0)
DIQUIET variable.
"BLD",5568,4,0)
^9.64PA^^0
"BLD",5568,"ABPKG")
n
"BLD",5568,"KRN",0)
^9.67PA^8989.52^19
"BLD",5568,"KRN",.4,0)
.4
"BLD",5568,"KRN",.401,0)
.401
"BLD",5568,"KRN",.402,0)
.402
"BLD",5568,"KRN",.403,0)
.403
"BLD",5568,"KRN",.5,0)
.5
"BLD",5568,"KRN",.84,0)
.84
"BLD",5568,"KRN",3.6,0)
3.6
"BLD",5568,"KRN",3.8,0)
3.8
"BLD",5568,"KRN",9.2,0)
9.2
"BLD",5568,"KRN",9.8,0)
9.8
"BLD",5568,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",5568,"KRN",9.8,"NM",1,0)
IBACUS^^0^B7456438
"BLD",5568,"KRN",9.8,"NM",2,0)
IBECUS1^^0^B19573217
"BLD",5568,"KRN",9.8,"NM",3,0)
IBECUS2^^0^B33042601
"BLD",5568,"KRN",9.8,"NM",4,0)
IBECUS21^^0^B14448685
"BLD",5568,"KRN",9.8,"NM",5,0)
IBECUS22^^0^B7188246
"BLD",5568,"KRN",9.8,"NM","B","IBACUS",1)

"BLD",5568,"KRN",9.8,"NM","B","IBECUS1",2)

"BLD",5568,"KRN",9.8,"NM","B","IBECUS2",3)

"BLD",5568,"KRN",9.8,"NM","B","IBECUS21",4)

"BLD",5568,"KRN",9.8,"NM","B","IBECUS22",5)

"BLD",5568,"KRN",19,0)
19
"BLD",5568,"KRN",19.1,0)
19.1
"BLD",5568,"KRN",101,0)
101
"BLD",5568,"KRN",409.61,0)
409.61
"BLD",5568,"KRN",771,0)
771
"BLD",5568,"KRN",870,0)
870
"BLD",5568,"KRN",8989.51,0)
8989.51
"BLD",5568,"KRN",8989.52,0)
8989.52
"BLD",5568,"KRN",8994,0)
8994
"BLD",5568,"KRN","B",.4,.4)

"BLD",5568,"KRN","B",.401,.401)

"BLD",5568,"KRN","B",.402,.402)

"BLD",5568,"KRN","B",.403,.403)

"BLD",5568,"KRN","B",.5,.5)

"BLD",5568,"KRN","B",.84,.84)

"BLD",5568,"KRN","B",3.6,3.6)

"BLD",5568,"KRN","B",3.8,3.8)

"BLD",5568,"KRN","B",9.2,9.2)

"BLD",5568,"KRN","B",9.8,9.8)

"BLD",5568,"KRN","B",19,19)

"BLD",5568,"KRN","B",19.1,19.1)

"BLD",5568,"KRN","B",101,101)

"BLD",5568,"KRN","B",409.61,409.61)

"BLD",5568,"KRN","B",771,771)

"BLD",5568,"KRN","B",870,870)

"BLD",5568,"KRN","B",8989.51,8989.51)

"BLD",5568,"KRN","B",8989.52,8989.52)

"BLD",5568,"KRN","B",8994,8994)

"BLD",5568,"QUES",0)
^9.62^^
"BLD",5568,"REQB",0)
^9.611^1^1
"BLD",5568,"REQB",1,0)
IB*2.0*240^2
"BLD",5568,"REQB","B","IB*2.0*240",1)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
274^3040722
"PKG",200,22,1,"PAH",1,1,0)
^^2^2^3040722
"PKG",200,22,1,"PAH",1,1,1,0)
This patch will use the NEW command to limit the scope of the
"PKG",200,22,1,"PAH",1,1,2,0)
DIQUIET variable.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","IBACUS")
0^1^B7456438
"RTN","IBACUS",1,0)
IBACUS ;ALB/CPM - TRICARE BILLING UTILITIES ; 02-AUG-96
"RTN","IBACUS",2,0)
 ;;2.0;INTEGRATED BILLING;**52,240,274**;21-MAR-94
"RTN","IBACUS",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBACUS",4,0)
 ;
"RTN","IBACUS",5,0)
CUS(DFN,IBDT) ; Does the patient have TRICARE coverage?
"RTN","IBACUS",6,0)
 ;  Input:    DFN  --  Pointer to the patient in file #2
"RTN","IBACUS",7,0)
 ;           DATE  --  Date on which coverage is to be determined
"RTN","IBACUS",8,0)
 ; Output:  IBCOV  --  0, if the vet has no billable TRICARE coverage
"RTN","IBACUS",9,0)
 ;                     >0 => pointer to such coverage in file #2.312
"RTN","IBACUS",10,0)
 ;
"RTN","IBACUS",11,0)
 N IBCOV,IBPOL,IBI
"RTN","IBACUS",12,0)
 S IBCOV=0
"RTN","IBACUS",13,0)
 I '$G(DFN) G CUSQ
"RTN","IBACUS",14,0)
 S:'$G(IBDT) IBDT=DT
"RTN","IBACUS",15,0)
 ;
"RTN","IBACUS",16,0)
 ; - find a billable TRICARE policy
"RTN","IBACUS",17,0)
 D ALL^IBCNS1(DFN,"IBPOL",1,IBDT)
"RTN","IBACUS",18,0)
 S IBI=0 F  S IBI=$O(IBPOL(IBI)) Q:'IBI  D  Q:IBCOV
"RTN","IBACUS",19,0)
 .Q:$P($G(IBPOL(IBI,3)),"^",4)  ; ignore billing this policy
"RTN","IBACUS",20,0)
 .I $P($G(^IBE(355.1,+$P($G(IBPOL(IBI,355.3)),"^",9),0)),"^",3)=7 S IBCOV=IBI
"RTN","IBACUS",21,0)
CUSQ Q IBCOV
"RTN","IBACUS",22,0)
 ;
"RTN","IBACUS",23,0)
 ;
"RTN","IBACUS",24,0)
TRI() ; Is the Tricare Billing engine up and running?
"RTN","IBACUS",25,0)
 ;  Input:  none
"RTN","IBACUS",26,0)
 ; Output:  0 - No  1 - Yes
"RTN","IBACUS",27,0)
 ;
"RTN","IBACUS",28,0)
 Q $P($G(^IBE(350.9,1,9)),"^",4)>0
"RTN","IBACUS",29,0)
 ;
"RTN","IBACUS",30,0)
 ;
"RTN","IBACUS",31,0)
CHPUS(DFN,DATE,IBRX,IBREF,IBLAB,IBRSITE,IBDUZ) ; Bill this patient for TRICARE?
"RTN","IBACUS",32,0)
 ;  Input:    DFN  --  Pointer to the patient in file #2
"RTN","IBACUS",33,0)
 ;           DATE  --  Date on which coverage is to be determined
"RTN","IBACUS",34,0)
 ;           IBRX  --  Pointer to the prescription in file #52
"RTN","IBACUS",35,0)
 ;          IBREF  --  Pointer to the refill in file #52.1, or
"RTN","IBACUS",36,0)
 ;                     0 if billing the original prescription
"RTN","IBACUS",37,0)
 ;          IBLAB  --  Pharmacy label printing device
"RTN","IBACUS",38,0)
 ;        IBRSITE  --  Pointer to the Pharmacy in file #59
"RTN","IBACUS",39,0)
 ;          IBDUZ  --  Pointer to the Pharmacy user in file #200
"RTN","IBACUS",40,0)
 ; Output:  IBCHK  --  0 => can't bill rx || 1 => bill rx
"RTN","IBACUS",41,0)
 ;
"RTN","IBACUS",42,0)
 N IBCHK,IBKEY S IBCHK=0
"RTN","IBACUS",43,0)
 I '$G(DFN) G CHPUSQ
"RTN","IBACUS",44,0)
 D POL^IBCNSU41(DFN)
"RTN","IBACUS",45,0)
 ;
"RTN","IBACUS",46,0)
 ; - make sure system is running and the patient has TRICARE coverage
"RTN","IBACUS",47,0)
 I '$$TRI() G CHPUSQ
"RTN","IBACUS",48,0)
 I '$$CUS(DFN,DATE) G CHPUSQ
"RTN","IBACUS",49,0)
 ;
"RTN","IBACUS",50,0)
 ; - check remaining user input
"RTN","IBACUS",51,0)
 I '$G(IBRX) G CHPUSQ
"RTN","IBACUS",52,0)
 I $G(IBREF)="" G CHPUSQ
"RTN","IBACUS",53,0)
 I $G(IBLAB)=""!('$G(IBRSITE))!('$G(IBDUZ)) G CHPUSQ
"RTN","IBACUS",54,0)
 ;
"RTN","IBACUS",55,0)
 ; - perform all Pharmacy edits
"RTN","IBACUS",56,0)
 I '$$CHK^PSOCPTRI(IBRX,IBREF) G CHPUSQ
"RTN","IBACUS",57,0)
 ;
"RTN","IBACUS",58,0)
 ; - queue rx for billing
"RTN","IBACUS",59,0)
 S IBCHK=1,IBKEY=IBRX_";"_IBREF
"RTN","IBACUS",60,0)
 S ^IBA(351.5,"APOST",IBKEY)=IBLAB_"^"_IBRSITE_"^"_IBDUZ
"RTN","IBACUS",61,0)
 ;
"RTN","IBACUS",62,0)
CHPUSQ Q IBCHK
"RTN","IBACUS",63,0)
 ;
"RTN","IBACUS",64,0)
 ;
"RTN","IBACUS",65,0)
 ;
"RTN","IBACUS",66,0)
 ;
"RTN","IBACUS",67,0)
 ; The following three queued entry points are invoked by the
"RTN","IBACUS",68,0)
 ; TRICARE Rx Billing engine.  The following two variables are
"RTN","IBACUS",69,0)
 ; defined for each of the jobs:
"RTN","IBACUS",70,0)
 ;
"RTN","IBACUS",71,0)
 ;     IBCHTRN  --  Pointer to the transaction entry in file #351.5
"RTN","IBACUS",72,0)
 ;      IBKEYD  --  1 ^ 2 ^ 3, where
"RTN","IBACUS",73,0)
 ;                    1 = Rx label printing device
"RTN","IBACUS",74,0)
 ;                    2 = Pointer to the Pharmacy in file #59
"RTN","IBACUS",75,0)
 ;                    3 = Pointer to the Pharmacy user in file #200
"RTN","IBACUS",76,0)
 ;
"RTN","IBACUS",77,0)
RXLAB ; Queued entry point to print the TRICARE Rx label.
"RTN","IBACUS",78,0)
 I $G(IBKEYD)="" G RXLABQ
"RTN","IBACUS",79,0)
 S IBCOP=$J(+$G(^IBA(351.5,+$G(IBCHTRN),2)),0,2)
"RTN","IBACUS",80,0)
 I 'IBCOP G RXLABQ
"RTN","IBACUS",81,0)
 D LABEL^PSOCPTRI(+$G(^IBA(351.5,IBCHTRN,0)),$P(IBKEYD,"^"),$P(IBKEYD,"^",2),$P(IBKEYD,"^",3),IBCOP)
"RTN","IBACUS",82,0)
RXLABQ K IBCOP
"RTN","IBACUS",83,0)
 Q
"RTN","IBACUS",84,0)
 ;
"RTN","IBACUS",85,0)
 ;
"RTN","IBACUS",86,0)
RXBIL ; Queued entry point to create TRICARE Rx Billing charges.
"RTN","IBACUS",87,0)
 ;
"RTN","IBACUS",88,0)
 ; - check some basic input
"RTN","IBACUS",89,0)
 I '$$RXSET G RXBILQ
"RTN","IBACUS",90,0)
 ;
"RTN","IBACUS",91,0)
 ; - create copay charge
"RTN","IBACUS",92,0)
 D BILL^IBACUS1(IBKEY,IBCHTRN)
"RTN","IBACUS",93,0)
 ;
"RTN","IBACUS",94,0)
 ; - create fiscal intermediary claim
"RTN","IBACUS",95,0)
 D BILL^IBACUS2(IBKEY,IBCHTRN)
"RTN","IBACUS",96,0)
 ;
"RTN","IBACUS",97,0)
RXBILQ Q
"RTN","IBACUS",98,0)
 ;
"RTN","IBACUS",99,0)
 ;
"RTN","IBACUS",100,0)
RXCAN ; Queued entry point to cancel TRICARE Rx Billing charges.
"RTN","IBACUS",101,0)
 ;
"RTN","IBACUS",102,0)
 ; - check some basic input
"RTN","IBACUS",103,0)
 I '$$RXSET G RXCANQ
"RTN","IBACUS",104,0)
 ;
"RTN","IBACUS",105,0)
 ; - cancel copay charge
"RTN","IBACUS",106,0)
 D CANC^IBACUS1(IBCHTRN)
"RTN","IBACUS",107,0)
 ;
"RTN","IBACUS",108,0)
 ; - cancel fiscal intermediary claim
"RTN","IBACUS",109,0)
 D CANC^IBACUS2(IBCHTRN)
"RTN","IBACUS",110,0)
 ;
"RTN","IBACUS",111,0)
RXCANQ Q
"RTN","IBACUS",112,0)
 ;
"RTN","IBACUS",113,0)
 ;
"RTN","IBACUS",114,0)
RXSET() ; Establish the session.
"RTN","IBACUS",115,0)
 N IBOK S IBOK=0
"RTN","IBACUS",116,0)
 ;
"RTN","IBACUS",117,0)
 ; - check some basic input
"RTN","IBACUS",118,0)
 I '$G(IBCHTRN) G RXSETQ
"RTN","IBACUS",119,0)
 S IBKEY=$P($G(^IBA(351.5,IBCHTRN,0)),"^")
"RTN","IBACUS",120,0)
 I IBKEY="" G RXSETQ
"RTN","IBACUS",121,0)
 S DUZ=+$P(IBKEYD,"^",3)
"RTN","IBACUS",122,0)
 I $G(^VA(200,DUZ,0))="" G RXSETQ
"RTN","IBACUS",123,0)
 ;
"RTN","IBACUS",124,0)
 N DIQUIET S DIQUIET=1 D DT^DICRW
"RTN","IBACUS",125,0)
 S IBOK=1
"RTN","IBACUS",126,0)
 ;
"RTN","IBACUS",127,0)
RXSETQ Q IBOK
"RTN","IBECUS1")
0^2^B19573217
"RTN","IBECUS1",1,0)
IBECUS1 ;RLM/DVAMC - TRICARE PHARMACY BILLING ENGINES ; 14-AUG-96
"RTN","IBECUS1",2,0)
 ;;2.0;INTEGRATED BILLING;**52,88,240,274**;21-MAR-94
"RTN","IBECUS1",3,0)
 ;
"RTN","IBECUS1",4,0)
BILLS ; Tasked entry point:  Secondary Billing engine.
"RTN","IBECUS1",5,0)
 ;
"RTN","IBECUS1",6,0)
 I $D(^%ZOSF("TRAP")) S X="ERRS^IBECUS1",@^("TRAP")
"RTN","IBECUS1",7,0)
 ;
"RTN","IBECUS1",8,0)
 ; - main idling loop
"RTN","IBECUS1",9,0)
 F  H 100 Q:'$P($G(^IBE(350.9,1,9)),"^",4)
"RTN","IBECUS1",10,0)
 ;
"RTN","IBECUS1",11,0)
 I $P($G(^IBE(350.9,1,9)),"^",10) S $P(^IBE(350.9,1,9),"^",5)="" G BILLQ
"RTN","IBECUS1",12,0)
 ;
"RTN","IBECUS1",13,0)
 ; - drop into Primary Billing task...
"RTN","IBECUS1",14,0)
 ;
"RTN","IBECUS1",15,0)
 ;
"RTN","IBECUS1",16,0)
BILLP ; Tasked entry point:  Primary Billing engine.
"RTN","IBECUS1",17,0)
 ;
"RTN","IBECUS1",18,0)
 I $D(^%ZOSF("TRAP")) S X="ERRP^IBECUS1",@^("TRAP")
"RTN","IBECUS1",19,0)
 ;
"RTN","IBECUS1",20,0)
 ; - open the port
"RTN","IBECUS1",21,0)
 D CALL^%ZISTCP(IBCHAN,IBBPORT) I POP G BILLC
"RTN","IBECUS1",22,0)
 ;
"RTN","IBECUS1",23,0)
 ; - start secondary job
"RTN","IBECUS1",24,0)
 D SECB
"RTN","IBECUS1",25,0)
 ;
"RTN","IBECUS1",26,0)
 ; - send alert notifying that the billing engine has started
"RTN","IBECUS1",27,0)
 D NOW^%DTC S $P(^IBE(350.9,1,9),"^",8)=%,Y=% X ^DD("DD")
"RTN","IBECUS1",28,0)
 S XQA("G.IB CHAMP RX START")="",XQAMSG="IPS Billing Process Started "_Y
"RTN","IBECUS1",29,0)
 D SETUP^XQALERT
"RTN","IBECUS1",30,0)
 ;
"RTN","IBECUS1",31,0)
 ; - main processing loop
"RTN","IBECUS1",32,0)
 F  R IBX:50 D SND,UPD I $P($G(^IBE(350.9,1,9)),"^",10) Q
"RTN","IBECUS1",33,0)
 ;
"RTN","IBECUS1",34,0)
BILLC D CLOSE^%ZISTCP
"RTN","IBECUS1",35,0)
 ;
"RTN","IBECUS1",36,0)
 ; - delete the primary task
"RTN","IBECUS1",37,0)
 S $P(^IBE(350.9,1,9),"^",4)=""
"RTN","IBECUS1",38,0)
 ;
"RTN","IBECUS1",39,0)
BILLQ Q
"RTN","IBECUS1",40,0)
 ;
"RTN","IBECUS1",41,0)
 ;
"RTN","IBECUS1",42,0)
SND ; Process all prescriptions queued for billing.
"RTN","IBECUS1",43,0)
 F  R *IBI:0 Q:IBI=-1  ; bleed queue
"RTN","IBECUS1",44,0)
 S IBKEY="" F  S IBKEY=$O(^IBA(351.5,"APOST",IBKEY)) Q:'IBKEY  S IBKEYD=$G(^(IBKEY)),IBROU="^IBECUS"_$S(IBKEYD["REVERSE":3,1:2) D @IBROU
"RTN","IBECUS1",45,0)
 Q
"RTN","IBECUS1",46,0)
 ;
"RTN","IBECUS1",47,0)
 ;
"RTN","IBECUS1",48,0)
UPD ; Update the last run date/time.
"RTN","IBECUS1",49,0)
 D NOW^%DTC
"RTN","IBECUS1",50,0)
 S $P(^IBE(350.9,1,9),"^",9)=%
"RTN","IBECUS1",51,0)
 Q
"RTN","IBECUS1",52,0)
 ;
"RTN","IBECUS1",53,0)
 ;
"RTN","IBECUS1",54,0)
ERRP ; Primary billing task error trap
"RTN","IBECUS1",55,0)
 D CLOSE^%ZISTCP
"RTN","IBECUS1",56,0)
 S $P(^IBE(350.9,1,9),"^",4)=""
"RTN","IBECUS1",57,0)
 G ^%ZTER
"RTN","IBECUS1",58,0)
 ;
"RTN","IBECUS1",59,0)
ERRS ; Secondary billing task error trap
"RTN","IBECUS1",60,0)
 D SECB
"RTN","IBECUS1",61,0)
 G ^%ZTER
"RTN","IBECUS1",62,0)
 ;
"RTN","IBECUS1",63,0)
SECB ; Start the secondary billing task.
"RTN","IBECUS1",64,0)
 S ZTRTN="BILLS^IBECUS1",ZTDTH=$H,ZTIO=""
"RTN","IBECUS1",65,0)
 S ZTDESC="IB - TRICARE Secondary Billing Task"
"RTN","IBECUS1",66,0)
 I IBVOL]"" S ZTCPU=IBVOL
"RTN","IBECUS1",67,0)
 F I="IBBPORT","IBCHAN","IBCHSET","IBPRESCR","IBVOL" S ZTSAVE(I)=""
"RTN","IBECUS1",68,0)
 D ^%ZTLOAD
"RTN","IBECUS1",69,0)
 ;
"RTN","IBECUS1",70,0)
 S $P(^IBE(350.9,1,9),"^",5)=$G(ZTSK)
"RTN","IBECUS1",71,0)
 ;
"RTN","IBECUS1",72,0)
 K ZTRTN,ZTDTH,ZTIO,ZTSK,ZTCPU,ZTSAVE
"RTN","IBECUS1",73,0)
 Q
"RTN","IBECUS1",74,0)
 ;
"RTN","IBECUS1",75,0)
 ;
"RTN","IBECUS1",76,0)
 ;
"RTN","IBECUS1",77,0)
AWPS ; Tasked entry point:  Secondary AWP Update engine.
"RTN","IBECUS1",78,0)
 ;
"RTN","IBECUS1",79,0)
 I $D(^%ZOSF("TRAP")) S X="ERRAS^IBECUS1",@^("TRAP")
"RTN","IBECUS1",80,0)
 ;
"RTN","IBECUS1",81,0)
 ; - main idling loop
"RTN","IBECUS1",82,0)
 F  H 100 Q:'$P($G(^IBE(350.9,1,9)),"^",6)
"RTN","IBECUS1",83,0)
 ;
"RTN","IBECUS1",84,0)
 I $P($G(^IBE(350.9,1,9)),"^",10) S $P(^IBE(350.9,1,9),"^",7)="" G AWPPQ
"RTN","IBECUS1",85,0)
 ;
"RTN","IBECUS1",86,0)
 ; - drop into Primary AWP Update task...
"RTN","IBECUS1",87,0)
 ;
"RTN","IBECUS1",88,0)
 ;
"RTN","IBECUS1",89,0)
AWPP ; Tasked Entry Point:  Primary AWP Update Engine
"RTN","IBECUS1",90,0)
 ;
"RTN","IBECUS1",91,0)
 I $D(^%ZOSF("TRAP")) S X="ERRAP^IBECUS1",@^("TRAP")
"RTN","IBECUS1",92,0)
 ;
"RTN","IBECUS1",93,0)
 ; - open the port
"RTN","IBECUS1",94,0)
 D CALL^%ZISTCP(IBCHAN,IBAPORT) I POP G AWPPC
"RTN","IBECUS1",95,0)
 ;
"RTN","IBECUS1",96,0)
 ; - start secondary job
"RTN","IBECUS1",97,0)
 D SECA
"RTN","IBECUS1",98,0)
 ;
"RTN","IBECUS1",99,0)
 ; - main processing loop
"RTN","IBECUS1",100,0)
 S IBUPD=0 F  R IBX:30 D  I $P($G(^IBE(350.9,1,9)),"^",10) Q
"RTN","IBECUS1",101,0)
 .;
"RTN","IBECUS1",102,0)
 .; - if no response, sent alert if necessary
"RTN","IBECUS1",103,0)
 .I IBX="" D:IBUPD  Q
"RTN","IBECUS1",104,0)
 ..D NOW^%DTC S Y=% X ^DD("DD")
"RTN","IBECUS1",105,0)
 ..S XQA("G.IB CHAMP RX START")=""
"RTN","IBECUS1",106,0)
 ..S XQAMSG="AWP update completed on "_Y_".  "_IBUPD_" new rates were added."
"RTN","IBECUS1",107,0)
 ..D SETUP^XQALERT
"RTN","IBECUS1",108,0)
 ..S IBUPD=0
"RTN","IBECUS1",109,0)
 .;
"RTN","IBECUS1",110,0)
 .; - respond if record is not in the anticipated format
"RTN","IBECUS1",111,0)
 .I IBX'?36N W "N" Q
"RTN","IBECUS1",112,0)
 .I IBX?36"9" Q
"RTN","IBECUS1",113,0)
 .;
"RTN","IBECUS1",114,0)
 .; - pull data from the transmitted record
"RTN","IBECUS1",115,0)
 .S IBNDCO=$E(IBX,1,11),IBNDCN=$E(IBX,12,22),IBAWP=$E(IBX,23,29)
"RTN","IBECUS1",116,0)
 .S IBAWP=$E(IBAWP,1,3)_"."_$E(IBAWP,4,7)
"RTN","IBECUS1",117,0)
 .S IBNDC=$S(IBNDCN:IBNDCN,1:IBNDCO)
"RTN","IBECUS1",118,0)
 .S IBNDC=$E(IBNDC,1,5)_"-"_$E(IBNDC,6,9)_"-"_$E(IBNDC,10,11)
"RTN","IBECUS1",119,0)
 .;
"RTN","IBECUS1",120,0)
 .; - find/build billable item and file the new charge item
"RTN","IBECUS1",121,0)
 .N DIQUIET S DIQUIET=1,IBG=0 D DT^DICRW
"RTN","IBECUS1",122,0)
 .S IBITEM=+$$ADDBI^IBCREF("NDC",IBNDC)
"RTN","IBECUS1",123,0)
 .I IBITEM,$$ADDCI^IBCREF(IBCHSET,IBITEM,DT,IBAWP) S IBG=1
"RTN","IBECUS1",124,0)
 .;
"RTN","IBECUS1",125,0)
 .; - respond and update the counter
"RTN","IBECUS1",126,0)
 .W "Y",!
"RTN","IBECUS1",127,0)
 .S:IBG IBUPD=IBUPD+1
"RTN","IBECUS1",128,0)
 ;
"RTN","IBECUS1",129,0)
AWPPC D CLOSE^%ZISTCP
"RTN","IBECUS1",130,0)
 ;
"RTN","IBECUS1",131,0)
 ; - delete the primary task
"RTN","IBECUS1",132,0)
 S $P(^IBE(350.9,1,9),"^",6)=""
"RTN","IBECUS1",133,0)
 ;
"RTN","IBECUS1",134,0)
AWPPQ Q
"RTN","IBECUS1",135,0)
 ;
"RTN","IBECUS1",136,0)
 ;
"RTN","IBECUS1",137,0)
SECA ; Start the secondary AWP Update task.
"RTN","IBECUS1",138,0)
 S ZTRTN="AWPS^IBECUS1",ZTDTH=$H,ZTIO=""
"RTN","IBECUS1",139,0)
 S ZTDESC="IB - TRICARE Secondary AWP Update Task"
"RTN","IBECUS1",140,0)
 I IBVOL]"" S ZTCPU=IBVOL
"RTN","IBECUS1",141,0)
 F I="IBAPORT","IBCHAN","IBCHSET","IBVOL" S ZTSAVE(I)=""
"RTN","IBECUS1",142,0)
 D ^%ZTLOAD
"RTN","IBECUS1",143,0)
 ;
"RTN","IBECUS1",144,0)
 S $P(^IBE(350.9,1,9),"^",7)=$G(ZTSK)
"RTN","IBECUS1",145,0)
 ;
"RTN","IBECUS1",146,0)
 K ZTRTN,ZTDTH,ZTIO,ZTSK,ZTCPU,ZTSAVE
"RTN","IBECUS1",147,0)
 Q
"RTN","IBECUS1",148,0)
 ;
"RTN","IBECUS1",149,0)
ERRAP ; Primary billing task error trap
"RTN","IBECUS1",150,0)
 D CLOSE^%ZISTCP
"RTN","IBECUS1",151,0)
 S $P(^IBE(350.9,1,9),"^",6)=""
"RTN","IBECUS1",152,0)
 G ^%ZTER
"RTN","IBECUS1",153,0)
 ;
"RTN","IBECUS1",154,0)
ERRAS ; Secondary billing task error trap
"RTN","IBECUS1",155,0)
 D SECA
"RTN","IBECUS1",156,0)
 G ^%ZTER
"RTN","IBECUS2")
0^3^B33042601
"RTN","IBECUS2",1,0)
IBECUS2 ;DVAMC/RLM - TRICARE PHARMACY BILL TRANSACTION ;14-AUG-96
"RTN","IBECUS2",2,0)
 ;;2.0;INTEGRATED BILLING;**52,89,143,162,240,274**;21-MAR-94
"RTN","IBECUS2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBECUS2",4,0)
 ;
"RTN","IBECUS2",5,0)
EN ; Attempt to bill a prescription directly to the FI.
"RTN","IBECUS2",6,0)
 ;  Input:    IBKEY  --  1 ; 2, where
"RTN","IBECUS2",7,0)
 ;                         1 = Pointer to the prescription in file #52
"RTN","IBECUS2",8,0)
 ;                         2 = Pointer to the refill in file #52.1, or
"RTN","IBECUS2",9,0)
 ;                             0 for the original fill
"RTN","IBECUS2",10,0)
 ;           IBKEYD  --  1 ^ 2 ^ 3 ^ 4 ^ 5, where
"RTN","IBECUS2",11,0)
 ;                         1 = Rx label printing device
"RTN","IBECUS2",12,0)
 ;                         2 = Pointer to the Pharmacy in file #59
"RTN","IBECUS2",13,0)
 ;                         3 = Pointer to the Pharmacy user in file #200
"RTN","IBECUS2",14,0)
 ;                         4 = Pointer to the billing transaction
"RTN","IBECUS2",15,0)
 ;                             in file #351.5 (cancellations only)
"RTN","IBECUS2",16,0)
 ;                         5 = Product Selection Reason 
"RTN","IBECUS2",17,0)
 ;                                  (Resubmissions only)
"RTN","IBECUS2",18,0)
 ;          IBCHSET  --  Pointer to the Charge Set in file #363.1
"RTN","IBECUS2",19,0)
 ;         IBPRESCR  --  Facility Prescriber ID number
"RTN","IBECUS2",20,0)
 ;
"RTN","IBECUS2",21,0)
 ; - get rx data; make sure there is an NDC
"RTN","IBECUS2",22,0)
 K IBDRX,IBERR,IBAWPV,IBRESP
"RTN","IBECUS2",23,0)
 N DIQUIET S DIQUIET=1 D DT^DICRW
"RTN","IBECUS2",24,0)
 S IBRX=+IBKEY,IBREF=+$P(IBKEY,";",2)
"RTN","IBECUS2",25,0)
 I $$TRANS^PSOCPTRI(IBRX,IBREF,.IBDRX)<0 S IBERR=1 G ENQ
"RTN","IBECUS2",26,0)
 ;
"RTN","IBECUS2",27,0)
 ; - make sure the AWP is available
"RTN","IBECUS2",28,0)
 S IBDRX("NDC")=$$NDC(IBDRX("NDC"))
"RTN","IBECUS2",29,0)
 S IBITEM=+$$FNDBI^IBCRU2("NDC",IBDRX("NDC"))
"RTN","IBECUS2",30,0)
 I 'IBITEM S IBERR=9 G ENQ ;                     NDC is not in CM
"RTN","IBECUS2",31,0)
 D ITMCHG^IBCRCC(IBCHSET,IBITEM,DT,"",.IBAWPV)
"RTN","IBECUS2",32,0)
 I +IBAWPV'=1 S IBERR=10 G ENQ ;                  Not 1 rate for NDC
"RTN","IBECUS2",33,0)
 S IBAWP=$P(IBAWPV(+$O(IBAWPV(0))),"^",3)
"RTN","IBECUS2",34,0)
 I 'IBAWP S IBERR=11 G ENQ ;                     NDC has a zero charge
"RTN","IBECUS2",35,0)
 ;
"RTN","IBECUS2",36,0)
 ; - is patient data intact?
"RTN","IBECUS2",37,0)
 S DFN=+$P($G(^PSRX(IBRX,0)),"^",2)
"RTN","IBECUS2",38,0)
 S IBDPT(0)=$G(^DPT(DFN,0)),IBDPT(.11)=$G(^(.11)),IBDPT(.13)=$G(^(.13))
"RTN","IBECUS2",39,0)
 I IBDPT(0)="" S IBERR=4 G ENQ
"RTN","IBECUS2",40,0)
 ;
"RTN","IBECUS2",41,0)
 ; - is patient covered by TRICARE?
"RTN","IBECUS2",42,0)
 S IBCDFN=$$CUS^IBACUS(DFN,DT)
"RTN","IBECUS2",43,0)
 I 'IBCDFN S IBERR=2 G ENQ
"RTN","IBECUS2",44,0)
 ;
"RTN","IBECUS2",45,0)
 ; - get the BIN Number for the insurance company
"RTN","IBECUS2",46,0)
 S IBCDFND=$G(^DPT(DFN,.312,IBCDFN,0))
"RTN","IBECUS2",47,0)
 S IBBIN=$P($G(^DIC(36,+IBCDFND,3)),"^",3)
"RTN","IBECUS2",48,0)
 I $L(IBBIN)'=6 S IBERR=5 G ENQ
"RTN","IBECUS2",49,0)
 ;
"RTN","IBECUS2",50,0)
 ; - build line1:
"RTN","IBECUS2",51,0)
 ;      o pharmacy division
"RTN","IBECUS2",52,0)
 ;      o FI identifier (bin number)
"RTN","IBECUS2",53,0)
 ;      o commercial software package version (32)
"RTN","IBECUS2",54,0)
 ;      o billing transaction code  (01)
"RTN","IBECUS2",55,0)
 ;      o control #_pharmacy #_group (37 spaces)
"RTN","IBECUS2",56,0)
 ;      o insured person's ssn
"RTN","IBECUS2",57,0)
 ;      o person code (3 spaces)
"RTN","IBECUS2",58,0)
 ;
"RTN","IBECUS2",59,0)
 S IBFS=$C(28),IBGS=$C(29)
"RTN","IBECUS2",60,0)
 S IBLINE(1)=$$FILL(IBDRX("DIV"),2)_IBBIN_3201_$J("",37)
"RTN","IBECUS2",61,0)
 S IBLINE(1)=IBLINE(1)_$$LJUST($P(IBCDFND,"^",2),18)_$J("",3)
"RTN","IBECUS2",62,0)
 ;
"RTN","IBECUS2",63,0)
 ; - build line2:
"RTN","IBECUS2",64,0)
 ;      o patient dob
"RTN","IBECUS2",65,0)
 ;      o patient sex
"RTN","IBECUS2",66,0)
 ;      o patient rel. to insured
"RTN","IBECUS2",67,0)
 ;      o other coverage indicator (0)
"RTN","IBECUS2",68,0)
 ;      o rx fill date
"RTN","IBECUS2",69,0)
 ;
"RTN","IBECUS2",70,0)
 S IBLINE(2)=$$DATE($P(IBDPT(0),"^",3))_$P(IBDPT(0),"^",2)
"RTN","IBECUS2",71,0)
 S IBLINE(2)=IBLINE(2)_$S($P(IBCDFND,"^",16)>3:4,1:+$P(IBCDFND,"^",16))
"RTN","IBECUS2",72,0)
 S IBLINE(2)=IBLINE(2)_"0"_$$DATE(IBDRX("FDT"))
"RTN","IBECUS2",73,0)
 ;
"RTN","IBECUS2",74,0)
 ; - build line3:
"RTN","IBECUS2",75,0)
 ;      o patient first name
"RTN","IBECUS2",76,0)
 ;      o patient last name
"RTN","IBECUS2",77,0)
 ;      o insured's first name
"RTN","IBECUS2",78,0)
 ;      o insured's last name
"RTN","IBECUS2",79,0)
 ;      o address line 1, city, state, zip, phone
"RTN","IBECUS2",80,0)
 ;      
"RTN","IBECUS2",81,0)
 S IBLINE(3)=IBFS_"C700"_IBFS_"C90"
"RTN","IBECUS2",82,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CA"_$$LJUST($P($P(IBDPT(0),"^"),",",2),12)
"RTN","IBECUS2",83,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CB"_$$LJUST($P($P(IBDPT(0),"^"),","),15)
"RTN","IBECUS2",84,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CC"_$$LJUST($P($P(IBCDFND,"^",17),",",2),12)
"RTN","IBECUS2",85,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CD"_$$LJUST($P($P(IBCDFND,"^",17),","),15)
"RTN","IBECUS2",86,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CM"_$$LJUST($P(IBDPT(.11),"^"),30)
"RTN","IBECUS2",87,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CN"_$$LJUST($P(IBDPT(.11),"^",4),20)
"RTN","IBECUS2",88,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CO"_$$LJUST($P($G(^DIC(5,+$P(IBDPT(.11),"^",5),0)),"^",2),2)
"RTN","IBECUS2",89,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CP"_$$LJUST($P(IBDPT(.11),"^",6),9)
"RTN","IBECUS2",90,0)
 S IBLINE(3)=IBLINE(3)_IBFS_"CQ"_$$FILL($TR($P(IBDPT(.13),"^"),"-",""),10)
"RTN","IBECUS2",91,0)
 ;
"RTN","IBECUS2",92,0)
 ; - build line4:
"RTN","IBECUS2",93,0)
 ;      o prescription number
"RTN","IBECUS2",94,0)
 ;      o new/refill code
"RTN","IBECUS2",95,0)
 ;      o quantity
"RTN","IBECUS2",96,0)
 ;      o days supply
"RTN","IBECUS2",97,0)
 ;      o compound code (0) or if site param IBDRX("COMP")
"RTN","IBECUS2",98,0)
 ;      o drug NDC #
"RTN","IBECUS2",99,0)
 ;      o dispense as written? (0) or if resubmit look at IBKEYD
"RTN","IBECUS2",100,0)
 ;      o ingredient cost
"RTN","IBECUS2",101,0)
 ;      o Prescriber ID
"RTN","IBECUS2",102,0)
 ;      o date prescription written
"RTN","IBECUS2",103,0)
 ;      o # refills authorized
"RTN","IBECUS2",104,0)
 ;      o rx origin code (1)
"RTN","IBECUS2",105,0)
 ;      o rx denial clarification (00)
"RTN","IBECUS2",106,0)
 ;      o usual and customary charge (currently ingr cost * 5)
"RTN","IBECUS2",107,0)
 ;
"RTN","IBECUS2",108,0)
 ; - but first, strip trailing alpha characters from the rx number
"RTN","IBECUS2",109,0)
 S:$E(IBDRX("RX#"),$L(IBDRX("RX#")))]9 IBDRX("RX#")=$E(IBDRX("RX#"),1,$L(IBDRX("RX#"))-1)
"RTN","IBECUS2",110,0)
 S IBLINE(4)=IBGS_$$FILL(IBDRX("RX#"),7)
"RTN","IBECUS2",111,0)
 S IBLINE(4)=IBLINE(4)_$$FILL(IBREF,2)
"RTN","IBECUS2",112,0)
 S IBLINE(4)=IBLINE(4)_$$FILL($P(IBDRX("QTY"),"."),5)
"RTN","IBECUS2",113,0)
 S IBLINE(4)=IBLINE(4)_$$FILL(IBDRX("SUP"),3)
"RTN","IBECUS2",114,0)
 S IBLINE(4)=IBLINE(4)_$S(+$P($G(^IBE(350.9,1,9)),"^",15):IBDRX("COMP"),1:0)
"RTN","IBECUS2",115,0)
 S IBLINE(4)=IBLINE(4)_$$FILL($TR(IBDRX("NDC"),"-",""),11)
"RTN","IBECUS2",116,0)
 S IBLINE(4)=IBLINE(4)_$S($P($G(^IBA(351.53,+$P(IBKEYD,"^",5),0)),"^"):$P(^(0),"^"),1:0)
"RTN","IBECUS2",117,0)
 ;
"RTN","IBECUS2",118,0)
 S IBUAC=$$FILL(+($E($TR($J(IBAWP,0,2),".",""),1,5))*IBDRX("QTY"),6)
"RTN","IBECUS2",119,0)
 S IBLINE(4)=IBLINE(4)_IBUAC_$$LJUST($S(+$P($G(^IBE(350.9,1,9)),"^",14)&($L(IBDRX("DEA"))):IBDRX("DEA"),1:IBPRESCR),10)
"RTN","IBECUS2",120,0)
 S IBLINE(4)=IBLINE(4)_$$DATE(IBDRX("ISS"))
"RTN","IBECUS2",121,0)
 S IBLINE(4)=IBLINE(4)_$$FILL(IBDRX("#REF"),2)
"RTN","IBECUS2",122,0)
 S IBLINE(4)=IBLINE(4)_"100"_$$FILL(IBUAC*5,6)
"RTN","IBECUS2",123,0)
 ;
"RTN","IBECUS2",124,0)
 ; - build line5:  (not currently used, though must be submitted)
"RTN","IBECUS2",125,0)
 S IBLINE(5)=IBFS_"DA000000"_IBFS_"DC000200"_IBFS_"DG000000000000"_IBFS_"DI00"_IBFS_"DL"_$J("",10)
"RTN","IBECUS2",126,0)
 S IBLINE(5)=IBLINE(5)_IBFS_"DM00000"_IBFS_"DN01"_IBFS_"DO"_$J("",6)_IBFS_"DU000000"_IBFS_"DX000000"
"RTN","IBECUS2",127,0)
 S IBLINE(5)=IBLINE(5)_IBFS_"E4  "_IBFS_"E5  "_IBFS_"E6  "_IBFS_"E700000000"
"RTN","IBECUS2",128,0)
 ;
"RTN","IBECUS2",129,0)
OUT ; - send transaction to the commercial pos package
"RTN","IBECUS2",130,0)
 W $C(2)
"RTN","IBECUS2",131,0)
 F I=1:1:5 W IBLINE(I)
"RTN","IBECUS2",132,0)
 W $C(3)
"RTN","IBECUS2",133,0)
 W !
"RTN","IBECUS2",134,0)
 ;
"RTN","IBECUS2",135,0)
 ; - receive response
"RTN","IBECUS2",136,0)
 R IBRESP(1)#220:120 I '$T S IBERR=6 G ENQ
"RTN","IBECUS2",137,0)
 R IBRESP(2)#220:60,IBRESP(3):60 I '$L(IBRESP(3)) S IBERR=7 G ENQ
"RTN","IBECUS2",138,0)
 ;
"RTN","IBECUS2",139,0)
 S IBRESP(1)=$E(IBRESP(1),2,999)
"RTN","IBECUS2",140,0)
 ;
"RTN","IBECUS2",141,0)
 S XMCHAN=""
"RTN","IBECUS2",142,0)
 I $E(IBRESP(1),1,3)="   " D ERROR^IBECUS22 G ENQ
"RTN","IBECUS2",143,0)
 I $E(IBRESP(1),17)="D" D DUP^IBECUS22 G ENQ
"RTN","IBECUS2",144,0)
 ;
"RTN","IBECUS2",145,0)
 ; - file the billing transaction in file #351.51
"RTN","IBECUS2",146,0)
 D ^IBECUS21
"RTN","IBECUS2",147,0)
 ;
"RTN","IBECUS2",148,0)
 ; - quit if a reject
"RTN","IBECUS2",149,0)
 I $E(IBRESP(1),17)="R" G ENQ
"RTN","IBECUS2",150,0)
 ;
"RTN","IBECUS2",151,0)
 ; - if there was an error, file it and quit
"RTN","IBECUS2",152,0)
 I $E(IBRESP(1),1,3) D ERROR^IBECUS22 G ENQ
"RTN","IBECUS2",153,0)
 ;
"RTN","IBECUS2",154,0)
 ; - Queue tasks to print the label and create charges
"RTN","IBECUS2",155,0)
 F IBI="RXLAB;Rx Label print","RXBIL;Rx Billing" D TASK(IBI)
"RTN","IBECUS2",156,0)
 ;
"RTN","IBECUS2",157,0)
 ; - delete rx from billing queue
"RTN","IBECUS2",158,0)
 K ^IBA(351.5,"APOST",IBKEY)
"RTN","IBECUS2",159,0)
 ;
"RTN","IBECUS2",160,0)
ENQ I $G(IBERR) D ERROR^IBECUS22
"RTN","IBECUS2",161,0)
 Q
"RTN","IBECUS2",162,0)
 ;
"RTN","IBECUS2",163,0)
 ;
"RTN","IBECUS2",164,0)
TASK(IBDESC) ; Queue off label print, charge creation and cancellation jobs
"RTN","IBECUS2",165,0)
 ;  Input:  IBDESC  --  1 ; 2 , where
"RTN","IBECUS2",166,0)
 ;                        1 = routine label to execute
"RTN","IBECUS2",167,0)
 ;                        2 = task description
"RTN","IBECUS2",168,0)
 K ZTSAVE,ZTCPU,ZTSK
"RTN","IBECUS2",169,0)
 S ZTRTN=$P(IBDESC,";")_"^IBACUS",ZTDTH=$H,ZTIO=""
"RTN","IBECUS2",170,0)
 S ZTDESC="IB - "_$P(IBDESC,";",2)
"RTN","IBECUS2",171,0)
 F I="IBKEYD","IBCHTRN" S ZTSAVE(I)=""
"RTN","IBECUS2",172,0)
 D ^%ZTLOAD
"RTN","IBECUS2",173,0)
 Q
"RTN","IBECUS2",174,0)
 ;
"RTN","IBECUS2",175,0)
 ;
"RTN","IBECUS2",176,0)
DATE(X) ; Set date in the format yyyymmdd, or 8 spaces.
"RTN","IBECUS2",177,0)
 N Y
"RTN","IBECUS2",178,0)
 S Y=($E($G(X))+17)_$E($G(X),2,7)
"RTN","IBECUS2",179,0)
 Q $S($L(Y)=8:Y,1:$J("",8))
"RTN","IBECUS2",180,0)
 ;
"RTN","IBECUS2",181,0)
FILL(X,LEN) ; Zero-fill, right justified.
"RTN","IBECUS2",182,0)
 N Y
"RTN","IBECUS2",183,0)
 S:'$G(LEN) LEN=1
"RTN","IBECUS2",184,0)
 S Y=$E($G(X),1,LEN)
"RTN","IBECUS2",185,0)
 F  Q:$L(Y)>(LEN-1)  S Y="0"_Y
"RTN","IBECUS2",186,0)
 Q Y
"RTN","IBECUS2",187,0)
 ;
"RTN","IBECUS2",188,0)
LJUST(X,LEN) ; Space-fill, left justified.
"RTN","IBECUS2",189,0)
 N Y
"RTN","IBECUS2",190,0)
 S:'$G(LEN) LEN=1
"RTN","IBECUS2",191,0)
 S Y=$E($G(X),1,LEN)
"RTN","IBECUS2",192,0)
 F  Q:$L(Y)>(LEN-1)  S Y=Y_" "
"RTN","IBECUS2",193,0)
 Q Y
"RTN","IBECUS2",194,0)
 ;
"RTN","IBECUS2",195,0)
STRIPL(X) ; Strip leading spaces.
"RTN","IBECUS2",196,0)
 N Y S Y=$G(X)
"RTN","IBECUS2",197,0)
 F  Q:$E(Y)'=" "  S Y=$E(Y,2,999)
"RTN","IBECUS2",198,0)
 Q Y
"RTN","IBECUS2",199,0)
 ;
"RTN","IBECUS2",200,0)
NDC(X) ; Massage the NDC as it is stored in Pharmacy
"RTN","IBECUS2",201,0)
 ;  Input:  X  --  The NDC as it is stored in Pharmacy
"RTN","IBECUS2",202,0)
 ; Output:  X  --  The NDC in the format 5N 1"-" 4N 1"-" 2N
"RTN","IBECUS2",203,0)
 ;
"RTN","IBECUS2",204,0)
 I $G(X)="" S X="" G NDCQ
"RTN","IBECUS2",205,0)
 ;
"RTN","IBECUS2",206,0)
 N LEN,PCE,Y,Z
"RTN","IBECUS2",207,0)
 ;
"RTN","IBECUS2",208,0)
 S Z(1)=5,Z(2)=4,Z(3)=2
"RTN","IBECUS2",209,0)
 S PCE=0 F  S PCE=$O(Z(PCE)) Q:'PCE  S LEN=Z(PCE) D
"RTN","IBECUS2",210,0)
 .S Y=$P(X,"-",PCE)
"RTN","IBECUS2",211,0)
 .I $L(Y)>LEN S Y=$E(Y,2,LEN+1)
"RTN","IBECUS2",212,0)
 .I $L(+Y)<LEN S Y=$$FILL(Y,LEN)
"RTN","IBECUS2",213,0)
 .S $P(X,"-",PCE)=Y
"RTN","IBECUS2",214,0)
 ;
"RTN","IBECUS2",215,0)
NDCQ Q X
"RTN","IBECUS21")
0^4^B14448685
"RTN","IBECUS21",1,0)
IBECUS21 ;RLM/DVAMC - FILE TRICARE PHARMACY TRANSACTIONS ; 14-AUG-96
"RTN","IBECUS21",2,0)
 ;;2.0;INTEGRATED BILLING;**52,240,274**;21-MAR-94
"RTN","IBECUS21",3,0)
 ;
"RTN","IBECUS21",4,0)
TRAN ; File a Pharmacy Billing transaction in file #351.5.
"RTN","IBECUS21",5,0)
 ;  Input:      DFN  --  Pointer to the patient in file #2
"RTN","IBECUS21",6,0)
 ;           IBLINE  --  Array of data transmitted to the FI
"RTN","IBECUS21",7,0)
 ;           IBRESP  --  Array of data received from the FI
"RTN","IBECUS21",8,0)
 ;            IBKEY  --  1 ; 2, where
"RTN","IBECUS21",9,0)
 ;                         1 = Pointer to the prescription in file #52
"RTN","IBECUS21",10,0)
 ;                         2 = Pointer to the refill in file #52.1, or
"RTN","IBECUS21",11,0)
 ;                             0 for the original fill
"RTN","IBECUS21",12,0)
 ;           IBKEYD  --  1 ^ 2 ^ 3 ^ 4, where
"RTN","IBECUS21",13,0)
 ;                         1 = Rx label printing device
"RTN","IBECUS21",14,0)
 ;                         2 = Pointer to the Pharmacy in file #59
"RTN","IBECUS21",15,0)
 ;                         3 = Pointer to the Pharmacy user in file #200
"RTN","IBECUS21",16,0)
 ;                         4 = Pointer to the billing transaction
"RTN","IBECUS21",17,0)
 ;                             in file #351.5 (cancellations only)
"RTN","IBECUS21",18,0)
 ;
"RTN","IBECUS21",19,0)
 ; - don't process duplicate transactions
"RTN","IBECUS21",20,0)
 I $E(IBRESP(1),17)="D" Q
"RTN","IBECUS21",21,0)
 ;
"RTN","IBECUS21",22,0)
 ; - find transaction entry or create a new one
"RTN","IBECUS21",23,0)
 S IBCHTRN=$O(^IBA(351.5,"B",IBKEY,0))
"RTN","IBECUS21",24,0)
 I 'IBCHTRN D
"RTN","IBECUS21",25,0)
 .S I=$P(^IBA(351.5,0),"^",3)
"RTN","IBECUS21",26,0)
 .F  S I=I+1 L +^IBA(351.5,I):1 Q:$T&'$D(^IBA(351.5,I))  L -^IBA(351.5,I)
"RTN","IBECUS21",27,0)
 .S ^IBA(351.5,I,0)=IBKEY,^IBA(351.5,"B",IBKEY,I)=""
"RTN","IBECUS21",28,0)
 .S ^IBA(351.5,0)=$P(^IBA(351.5,0),"^",1,2)_"^"_I_"^"_($P(^IBA(351.5,0),"^",4)+1)
"RTN","IBECUS21",29,0)
 .S IBCHTRN=I L -^IBA(351.5,IBCHTRN)
"RTN","IBECUS21",30,0)
 ;
"RTN","IBECUS21",31,0)
 ; - prepare i/o for filing
"RTN","IBECUS21",32,0)
 S IBPROC("I")="" F IBI=1:1:2 S IBPROC("I")=IBPROC("I")_$G(IBRESP(IBI))
"RTN","IBECUS21",33,0)
 S IBPROC("O")="" F IBI=1:1:5 S IBPROC("O")=IBPROC("O")_$G(IBLINE(IBI))
"RTN","IBECUS21",34,0)
 S IBPROC("O")=$E(IBPROC("O"),3,999)
"RTN","IBECUS21",35,0)
 ;
"RTN","IBECUS21",36,0)
 ; - file transaction data
"RTN","IBECUS21",37,0)
 S $P(^IBA(351.5,IBCHTRN,0),"^",2,6)=DFN_"^"_$P(IBCDFND,"^",2)_"^"_$TR(IBDRX("NDC"),"-","")_"^"_$J((+IBUAC/100),0,2)_"^"_IBDRX("QTY")
"RTN","IBECUS21",38,0)
 F IBI=1:1 S IBTABLE=$T(TABLE+IBI) Q:$P(IBTABLE,";",3)="$END"  D
"RTN","IBECUS21",39,0)
 .Q:$P(IBTABLE,";",4)<2
"RTN","IBECUS21",40,0)
 .;
"RTN","IBECUS21",41,0)
 .; - file only the 0th node for rejects
"RTN","IBECUS21",42,0)
 .I $E(IBRESP(1),17)="R",$P(IBTABLE,";",4)>1 Q
"RTN","IBECUS21",43,0)
 .;
"RTN","IBECUS21",44,0)
 .S X="" I $P(IBTABLE,";",6)'?1.N X $P(IBTABLE,";",6)
"RTN","IBECUS21",45,0)
 .I X="" S X=$E(IBPROC($P(IBTABLE,";",3)),$P(IBTABLE,";",6),$P(IBTABLE,";",7))
"RTN","IBECUS21",46,0)
 .I $P(IBTABLE,";",2)["D" Q:'X  D DOLLAR
"RTN","IBECUS21",47,0)
 .;
"RTN","IBECUS21",48,0)
 .; - file each field individually
"RTN","IBECUS21",49,0)
 .I X]"" S $P(^IBA(351.5,IBCHTRN,$P(IBTABLE,";",4)),"^",$P(IBTABLE,";",5))=X
"RTN","IBECUS21",50,0)
 ;
"RTN","IBECUS21",51,0)
 ; - delete cancellation authorization number
"RTN","IBECUS21",52,0)
 S $P(^IBA(351.5,IBCHTRN,6),"^")=""
"RTN","IBECUS21",53,0)
 ;
"RTN","IBECUS21",54,0)
 ; - handle rejects, update transaction date and cross reference
"RTN","IBECUS21",55,0)
 D REJECT
"RTN","IBECUS21",56,0)
 N DIQUIET S DIQUIET=1 D DT^DICRW S $P(^IBA(351.5,IBCHTRN,0),U,7)=DT
"RTN","IBECUS21",57,0)
 S DA=IBCHTRN,DIK="^IBA(351.5," D IX^DIK
"RTN","IBECUS21",58,0)
 Q
"RTN","IBECUS21",59,0)
 ;
"RTN","IBECUS21",60,0)
 ;
"RTN","IBECUS21",61,0)
DOLLAR ; Convert cents to dollars.
"RTN","IBECUS21",62,0)
 S X=$E(X,1,($L(X)-2))_"."_$E(X,($L(X)-1),$L(X))
"RTN","IBECUS21",63,0)
 F  Q:$E(X,1)'=0  S X=$E(X,2,999)
"RTN","IBECUS21",64,0)
 Q
"RTN","IBECUS21",65,0)
 ;
"RTN","IBECUS21",66,0)
 ;
"RTN","IBECUS21",67,0)
REJECT ; Act on billing rejects.
"RTN","IBECUS21",68,0)
 ;
"RTN","IBECUS21",69,0)
 ; - file reject information
"RTN","IBECUS21",70,0)
 S IBREJ="" I $E(IBRESP(1),17)="R" D
"RTN","IBECUS21",71,0)
 .F IBJ=20:2 S IBJA=$E(IBRESP(1),IBJ,IBJ+1) Q:IBJA="  "!(IBJA="")  D
"RTN","IBECUS21",72,0)
 ..S IBERRP=$$ERRIEN^IBECUS22("UNIVERSAL",IBJA)
"RTN","IBECUS21",73,0)
 ..I IBERRP S IBREJ=IBREJ_","_IBERRP
"RTN","IBECUS21",74,0)
 S:$L(IBREJ) IBREJ=$E(IBREJ,2,999)
"RTN","IBECUS21",75,0)
 S ^IBA(351.5,IBCHTRN,5)=IBREJ
"RTN","IBECUS21",76,0)
 ;
"RTN","IBECUS21",77,0)
 ; - if the transaction was not rejected, delete the existing
"RTN","IBECUS21",78,0)
 ;   reject entry if it exists
"RTN","IBECUS21",79,0)
 S IBCHREJ=$O(^IBA(351.52,"B",IBKEY,0))
"RTN","IBECUS21",80,0)
 I IBREJ="" D  G REJECTQ
"RTN","IBECUS21",81,0)
 .I IBCHREJ S DA=IBCHREJ,DIK="^IBA(351.52," D ^DIK K DA,DIK
"RTN","IBECUS21",82,0)
 ;
"RTN","IBECUS21",83,0)
 ; - add a new reject entry if necessary
"RTN","IBECUS21",84,0)
 I 'IBCHREJ D ADDREJ
"RTN","IBECUS21",85,0)
 ;
"RTN","IBECUS21",86,0)
 ; - update reject file
"RTN","IBECUS21",87,0)
 S DA=IBCHTRN,DIE="^IBA(351.52,",DR=".02////"_IBCHTRN_";.03////"_DT
"RTN","IBECUS21",88,0)
 D ^DIE K DA,DIE,DR
"RTN","IBECUS21",89,0)
 S ^IBA(351.52,IBCHREJ,1)=IBREJ
"RTN","IBECUS21",90,0)
 ;
"RTN","IBECUS21",91,0)
 ; - generate a reject alert
"RTN","IBECUS21",92,0)
 S XQA("G.IB CHAMP RX REJ")="",XQA(+$P(IBKEYD,"^",3))=""
"RTN","IBECUS21",93,0)
 S XQAMSG="Prescription #"_IBDRX("RX#")_" rejected for reason #"_IBREJ
"RTN","IBECUS21",94,0)
 S XQADATA=IBDRX("RX#")_"^"_IBREJ_"^"_DFN,XQAROU="DISP^IBECUS22"
"RTN","IBECUS21",95,0)
 D SETUP^XQALERT
"RTN","IBECUS21",96,0)
 ;
"RTN","IBECUS21",97,0)
 ; - remove prescription from queue
"RTN","IBECUS21",98,0)
 I $P($G(^IBE(351.51,+IBREJ,0)),"^",2)<89 K ^IBA(351.5,"APOST",IBKEY)
"RTN","IBECUS21",99,0)
REJECTQ Q
"RTN","IBECUS21",100,0)
 ;
"RTN","IBECUS21",101,0)
 ;
"RTN","IBECUS21",102,0)
ADDREJ ; Add stub entry to the Reject file.
"RTN","IBECUS21",103,0)
 S I=$P(^IBA(351.52,0),"^",3)
"RTN","IBECUS21",104,0)
 F  S I=I+1 L +^IBA(351.52,I):1 Q:$T&'$D(^IBA(351.52,I))  L -^IBA(351.52,I)
"RTN","IBECUS21",105,0)
 S ^IBA(351.52,I,0)=IBKEY,^IBA(351.52,"B",IBKEY,I)=""
"RTN","IBECUS21",106,0)
 S ^IBA(351.52,0)=$P(^IBA(351.52,0),"^",1,2)_"^"_I_"^"_($P(^IBA(351.52,0),"^",4)+1)
"RTN","IBECUS21",107,0)
 S IBCHREJ=I L -^IBA(351.52,I)
"RTN","IBECUS21",108,0)
 Q
"RTN","IBECUS21",109,0)
 ;
"RTN","IBECUS21",110,0)
 ;
"RTN","IBECUS21",111,0)
TABLE ; Table of field positions and file locations in file #351.5.
"RTN","IBECUS21",112,0)
 ;;O;0;2;S X=DFN
"RTN","IBECUS21",113,0)
 ;;O;0;3;48;65
"RTN","IBECUS21",114,0)
 ;;O;0;4;268;278
"RTN","IBECUS21",115,0)
 ;D;O;0;5;280;285
"RTN","IBECUS21",116,0)
 ;;O;0;6;259;263
"RTN","IBECUS21",117,0)
 ;D;I;2;1;18;23
"RTN","IBECUS21",118,0)
 ;D;I;2;2;24;29
"RTN","IBECUS21",119,0)
 ;D;I;2;3;30;35
"RTN","IBECUS21",120,0)
 ;D;I;2;4;36;41
"RTN","IBECUS21",121,0)
 ;D;I;2;5;42;47
"RTN","IBECUS21",122,0)
 ;;I;2;6;48;61
"RTN","IBECUS21",123,0)
 ;;I;2;7;62;101
"RTN","IBECUS21",124,0)
 ;D;I;3;1;102;109
"RTN","IBECUS21",125,0)
 ;D;I;3;2;110;117
"RTN","IBECUS21",126,0)
 ;D;I;3;3;118;125
"RTN","IBECUS21",127,0)
 ;D;I;3;4;126;131
"RTN","IBECUS21",128,0)
 ;D;I;3;5;132;137
"RTN","IBECUS21",129,0)
 ;D;I;3;6;138;143
"RTN","IBECUS21",130,0)
 ;D;I;3;7;144;149
"RTN","IBECUS21",131,0)
 ;D;I;3;8;150;155
"RTN","IBECUS21",132,0)
 ;;I;3;9;156;157
"RTN","IBECUS21",133,0)
 ;D;I;3;10;158;163
"RTN","IBECUS21",134,0)
 ;;I;7;1;164;323
"RTN","IBECUS21",135,0)
 ;;I;8;1;324;403
"RTN","IBECUS21",136,0)
 ;;$END
"RTN","IBECUS22")
0^5^B7188246
"RTN","IBECUS22",1,0)
IBECUS22 ;RLM/DVAMC - TRICARE PHARMACY BILLING UTILITIES ; 14-AUG-96
"RTN","IBECUS22",2,0)
 ;;2.0;INTEGRATED BILLING;**52,89,240,274**;21-MAR-94
"RTN","IBECUS22",3,0)
 ;
"RTN","IBECUS22",4,0)
ERROR ; File errors.
"RTN","IBECUS22",5,0)
 ;  Input:  IBERR [opt]  --  DHCP Error Code
"RTN","IBECUS22",6,0)
 ;         IBDRX("RX#")  --  Prescription Number
"RTN","IBECUS22",7,0)
 ;      IBRESP(1) [opt]  --  First record transmitted by the FI
"RTN","IBECUS22",8,0)
 ;                IBKEY  --  1 ; 2, where
"RTN","IBECUS22",9,0)
 ;                             1 = Pointer to the rx in file #52
"RTN","IBECUS22",10,0)
 ;                             2 = Pointer to the refill in file #52.1,
"RTN","IBECUS22",11,0)
 ;                                 or 0 for the original fill
"RTN","IBECUS22",12,0)
 ;               IBKEYD  --  1 ^ 2 ^ 3 ^ 4, where
"RTN","IBECUS22",13,0)
 ;                             1 = Rx label printing device
"RTN","IBECUS22",14,0)
 ;                             2 = Pointer to the Pharmacy in file #59
"RTN","IBECUS22",15,0)
 ;                             3 = Pointer to the Pharmacy user in
"RTN","IBECUS22",16,0)
 ;                                 file #200
"RTN","IBECUS22",17,0)
 ;                             4 = Pointer to the billing transaction
"RTN","IBECUS22",18,0)
 ;                                 in file #351.5 (cancellations only)
"RTN","IBECUS22",19,0)
 ;
"RTN","IBECUS22",20,0)
 I '$G(IBERR) S IBERC=$E(IBRESP(1),1,3)
"RTN","IBECUS22",21,0)
 I $G(IBERR) K ^IBA(351.5,"APOST",IBKEY) S IBERC=IBERR
"RTN","IBECUS22",22,0)
 S IBMACH=$S($D(IBERR):"DHCP",1:"MLINK")
"RTN","IBECUS22",23,0)
 K IBERR,IBTXT
"RTN","IBECUS22",24,0)
 ;
"RTN","IBECUS22",25,0)
 ; - expand the code if necessary
"RTN","IBECUS22",26,0)
 I $D(IBRESP(1)),$E(IBRESP(1),1,3)="   " S IBERC="001"
"RTN","IBECUS22",27,0)
 I IBERC?1.N S IBERC=+IBERC F  Q:$L(IBERC)>1  S IBERC="0"_IBERC
"RTN","IBECUS22",28,0)
 S IBERRP=$$ERRIEN(IBMACH,IBERC)
"RTN","IBECUS22",29,0)
 ;
"RTN","IBECUS22",30,0)
 ; - send bulletin to the Reject Notice group
"RTN","IBECUS22",31,0)
 S IBTXT(1)=IBMACH_" has detected error #"_IBERC_" while processing RX# "_$S($G(IBDRX("RX#"))]"":IBDRX("RX#"),1:"Unknown")
"RTN","IBECUS22",32,0)
 S IBTXT(2)="Error text: "_$$ERRTXT(IBERRP)
"RTN","IBECUS22",33,0)
 S XMDUN="TRICARE PHARMACY BILLING",XMDUZ=.5,XMSUB="Tricare/IPS Billing Error"
"RTN","IBECUS22",34,0)
 S XMTEXT="IBTXT(",XMY("G.IB CHAMP RX REJ")="",XMY(+$P(IBKEYD,"^",3))=""
"RTN","IBECUS22",35,0)
 N DIQUIET S DIQUIET=1 D DT^DICRW,^XMD
"RTN","IBECUS22",36,0)
 ;
"RTN","IBECUS22",37,0)
 ; - file the rejected transaction
"RTN","IBECUS22",38,0)
 S IBCHREJ=$O(^IBA(351.52,"B",IBKEY,0))
"RTN","IBECUS22",39,0)
 I 'IBCHREJ D ADDREJ^IBECUS21
"RTN","IBECUS22",40,0)
 I IBCHREJ S $P(^IBA(351.52,IBCHREJ,0),"^",3)=DT,^(1)=IBERRP
"RTN","IBECUS22",41,0)
 K IBERC,IBERRP,IBTXT,IBMACH,XMDUN,XMDUZ,XMSUB,XMTEXT,XMY,XMZ
"RTN","IBECUS22",42,0)
 Q
"RTN","IBECUS22",43,0)
 ;
"RTN","IBECUS22",44,0)
 ;
"RTN","IBECUS22",45,0)
DUP ; Act on duplicates.
"RTN","IBECUS22",46,0)
 S XQA("G.IB CHAMP RX REJ")=""
"RTN","IBECUS22",47,0)
 S XQAMSG="Prescription #"_$S($G(IBDRX("RX#"))]"":IBDRX("RX#"),1:"Unknown")_" is a duplicate submission."
"RTN","IBECUS22",48,0)
 D SETUP^XQALERT
"RTN","IBECUS22",49,0)
 K ^IBA(351.5,"APOST",IBKEY)
"RTN","IBECUS22",50,0)
 Q
"RTN","IBECUS22",51,0)
 ;
"RTN","IBECUS22",52,0)
 ;
"RTN","IBECUS22",53,0)
DISP ; Display Universal errors on alerts.
"RTN","IBECUS22",54,0)
 N ERR,TXT,X,Y
"RTN","IBECUS22",55,0)
 S Y=$G(^DPT(+$P(XQADATA,"^",3),0))
"RTN","IBECUS22",56,0)
 W !!,"RX# ",$P(XQADATA,"^")," for ",$P(Y,"^")," (",$E($P(Y,"^",9),6,10),") rejected because:"
"RTN","IBECUS22",57,0)
 S XQADATA=$P(XQADATA,"^",2)
"RTN","IBECUS22",58,0)
 F X=1:1 S ERR=$P(XQADATA,",",X) Q:ERR=""  D
"RTN","IBECUS22",59,0)
 .S TXT=$$ERRTXT(ERR)
"RTN","IBECUS22",60,0)
 .I TXT]"" W !?3,TXT
"RTN","IBECUS22",61,0)
 W !!,"Press ENTER key to continue..." R X:DTIME
"RTN","IBECUS22",62,0)
 Q
"RTN","IBECUS22",63,0)
 ;
"RTN","IBECUS22",64,0)
 ;
"RTN","IBECUS22",65,0)
ERRTXT(IEN) ; Return Error Text.
"RTN","IBECUS22",66,0)
 ;  Input:   IEN  --  Pointer to the Error Text in file #351.51
"RTN","IBECUS22",67,0)
 Q $P($G(^IBE(351.51,+$G(IEN),0)),"^",3)
"RTN","IBECUS22",68,0)
 ;
"RTN","IBECUS22",69,0)
ERRIEN(MACH,CODE) ; Return Error File Entry Number.
"RTN","IBECUS22",70,0)
 ;  Input:   MACH  --  System on which the error occurred
"RTN","IBECUS22",71,0)
 ;           CODE  --  Error Code
"RTN","IBECUS22",72,0)
 N X S X=""
"RTN","IBECUS22",73,0)
 I $G(MACH)="" G ERRIENQ
"RTN","IBECUS22",74,0)
 I $G(CODE)="" G ERRIENQ
"RTN","IBECUS22",75,0)
 S X=$O(^IBE(351.51,"AD",MACH,CODE,0))
"RTN","IBECUS22",76,0)
ERRIENQ Q X
"VER")
8.0^22
**END**
**END**
