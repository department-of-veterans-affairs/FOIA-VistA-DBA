Released PSJ*5*120 SEQ #168
Extracted from mail message
**KIDS**:PSJ*5.0*120^

**INSTALL NAME**
PSJ*5.0*120
"BLD",5700,0)
PSJ*5.0*120^INPATIENT MEDICATIONS^0^3070521^y
"BLD",5700,1,0)
^^17^17^3070430^
"BLD",5700,1,1,0)
1. A site reported a problem with the new duration field that was added to
"BLD",5700,1,2,0)
CPRS GUI v25. In response to a patient safety issue, this field was added 
"BLD",5700,1,3,0)
to the IV Fluid order dialog. In addition, Inpatient Medications V. 5.0 
"BLD",5700,1,4,0)
was modified to always have the duration field be used for the stop date 
"BLD",5700,1,5,0)
calculation. This has caused problems in sites where they have policies 
"BLD",5700,1,6,0)
that say certain medications can only be written for a certain period of 
"BLD",5700,1,7,0)
time. This patch corrects this problem by modifying Inpatient Medications 
"BLD",5700,1,8,0)
V. 5.0 to consider the duration the same way as all other stop date 
"BLD",5700,1,9,0)
parameters, rather than as an override.
"BLD",5700,1,10,0)
 
"BLD",5700,1,11,0)
In order to assist in communications with the provider, an alert will be 
"BLD",5700,1,12,0)
sent to the ordering provider whenever the duration they entered is not 
"BLD",5700,1,13,0)
used to calculate the stop date of the order. HD0000000111592
"BLD",5700,1,14,0)
 
"BLD",5700,1,15,0)
2. Several sites reported an error occuring when entering an IV order 
"BLD",5700,1,16,0)
that contained an allergy order-check. This patch corrects this problem. 
"BLD",5700,1,17,0)
HD0000000186397, HD0000000187239, HD0000000187452, HD0000000187507.
"BLD",5700,4,0)
^9.64PA^^
"BLD",5700,6)
7^
"BLD",5700,6.3)
10
"BLD",5700,"ABPKG")
n
"BLD",5700,"KRN",0)
^9.67PA^8989.52^19
"BLD",5700,"KRN",.4,0)
.4
"BLD",5700,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5700,"KRN",.401,0)
.401
"BLD",5700,"KRN",.401,"NM",0)
^9.68A^^
"BLD",5700,"KRN",.402,0)
.402
"BLD",5700,"KRN",.403,0)
.403
"BLD",5700,"KRN",.5,0)
.5
"BLD",5700,"KRN",.84,0)
.84
"BLD",5700,"KRN",3.6,0)
3.6
"BLD",5700,"KRN",3.8,0)
3.8
"BLD",5700,"KRN",9.2,0)
9.2
"BLD",5700,"KRN",9.8,0)
9.8
"BLD",5700,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5700,"KRN",9.8,"NM",1,0)
PSIVCAL^^0^B58510061
"BLD",5700,"KRN",9.8,"NM",2,0)
PSIVORFB^^0^B42928811
"BLD",5700,"KRN",9.8,"NM","B","PSIVCAL",1)

"BLD",5700,"KRN",9.8,"NM","B","PSIVORFB",2)

"BLD",5700,"KRN",19,0)
19
"BLD",5700,"KRN",19.1,0)
19.1
"BLD",5700,"KRN",101,0)
101
"BLD",5700,"KRN",409.61,0)
409.61
"BLD",5700,"KRN",771,0)
771
"BLD",5700,"KRN",870,0)
870
"BLD",5700,"KRN",8989.51,0)
8989.51
"BLD",5700,"KRN",8989.52,0)
8989.52
"BLD",5700,"KRN",8994,0)
8994
"BLD",5700,"KRN","B",.4,.4)

"BLD",5700,"KRN","B",.401,.401)

"BLD",5700,"KRN","B",.402,.402)

"BLD",5700,"KRN","B",.403,.403)

"BLD",5700,"KRN","B",.5,.5)

"BLD",5700,"KRN","B",.84,.84)

"BLD",5700,"KRN","B",3.6,3.6)

"BLD",5700,"KRN","B",3.8,3.8)

"BLD",5700,"KRN","B",9.2,9.2)

"BLD",5700,"KRN","B",9.8,9.8)

"BLD",5700,"KRN","B",19,19)

"BLD",5700,"KRN","B",19.1,19.1)

"BLD",5700,"KRN","B",101,101)

"BLD",5700,"KRN","B",409.61,409.61)

"BLD",5700,"KRN","B",771,771)

"BLD",5700,"KRN","B",870,870)

"BLD",5700,"KRN","B",8989.51,8989.51)

"BLD",5700,"KRN","B",8989.52,8989.52)

"BLD",5700,"KRN","B",8994,8994)

"BLD",5700,"QUES",0)
^9.62^^
"BLD",5700,"REQB",0)
^9.611^1^1
"BLD",5700,"REQB",1,0)
PSJ*5.0*177^2
"BLD",5700,"REQB","B","PSJ*5.0*177",1)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
120^3070521^10000000009
"PKG",197,22,1,"PAH",1,1,0)
^^17^17^3070521
"PKG",197,22,1,"PAH",1,1,1,0)
1. A site reported a problem with the new duration field that was added to
"PKG",197,22,1,"PAH",1,1,2,0)
CPRS GUI v25. In response to a patient safety issue, this field was added 
"PKG",197,22,1,"PAH",1,1,3,0)
to the IV Fluid order dialog. In addition, Inpatient Medications V. 5.0 
"PKG",197,22,1,"PAH",1,1,4,0)
was modified to always have the duration field be used for the stop date 
"PKG",197,22,1,"PAH",1,1,5,0)
calculation. This has caused problems in sites where they have policies 
"PKG",197,22,1,"PAH",1,1,6,0)
that say certain medications can only be written for a certain period of 
"PKG",197,22,1,"PAH",1,1,7,0)
time. This patch corrects this problem by modifying Inpatient Medications 
"PKG",197,22,1,"PAH",1,1,8,0)
V. 5.0 to consider the duration the same way as all other stop date 
"PKG",197,22,1,"PAH",1,1,9,0)
parameters, rather than as an override.
"PKG",197,22,1,"PAH",1,1,10,0)
 
"PKG",197,22,1,"PAH",1,1,11,0)
In order to assist in communications with the provider, an alert will be 
"PKG",197,22,1,"PAH",1,1,12,0)
sent to the ordering provider whenever the duration they entered is not 
"PKG",197,22,1,"PAH",1,1,13,0)
used to calculate the stop date of the order. HD0000000111592
"PKG",197,22,1,"PAH",1,1,14,0)
 
"PKG",197,22,1,"PAH",1,1,15,0)
2. Several sites reported an error occuring when entering an IV order 
"PKG",197,22,1,"PAH",1,1,16,0)
that contained an allergy order-check. This patch corrects this problem. 
"PKG",197,22,1,"PAH",1,1,17,0)
HD0000000186397, HD0000000187239, HD0000000187452, HD0000000187507.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSIVCAL")
0^1^B58510061^B57659970
"RTN","PSIVCAL",1,0)
PSIVCAL ;BIR/RGY,PR-CALCULATES START AND STOP DATES ;12 Mar 99 / 12:42 PM
"RTN","PSIVCAL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**4,26,41,47,63,67,69,58,94,80,110,111,177,120**;16 DEC 97;Build 10
"RTN","PSIVCAL",3,0)
 ;
"RTN","PSIVCAL",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVCAL",5,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVCAL",6,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVCAL",7,0)
 ;
"RTN","PSIVCAL",8,0)
ENT ;NEEDS PSIVTYPE (P(4))
"RTN","PSIVCAL",9,0)
 I $G(PSJREN) D  Q:P(2)
"RTN","PSIVCAL",10,0)
 . I $G(P("OLDON")) N P2 S P2=$G(@("^PS(55,"_DFN_",""IV"","_+P("OLDON")_",0)")),P2=$P(P2,"^",2) I P2 S P(2)=P2
"RTN","PSIVCAL",11,0)
 I $G(PSJORD)["P",$G(P("APPT"))?7N1"."1.N S START=$$DATE2^PSJUTL2(P("APPT")) G Q
"RTN","PSIVCAL",12,0)
 I $G(PSJSYSW0)=""!($P(PSJSYSW0,U,5)=2) S START=+$E(P("LOG"),1,12) G Q
"RTN","PSIVCAL",13,0)
 ;I $G(P("RES"))="R" N PSIVAC S PSIVAC="PR" D ENAD I PSIVADM S P(2)=PSIVADM Q
"RTN","PSIVCAL",14,0)
 S PSIVSN=+P("IVRM"),START="",PSIVTYPE=$G(P(4)) Q:PSIVTYPE=""
"RTN","PSIVCAL",15,0)
 N PSIV X $S($E(PSIVAC)="C":"S X=+$E(P(""LOG""),1,12) D H^%DTC S PSIV=%T",1:"S PSIV=$P($H,"","",2)") G T2:PSIVTYPE'["P"&('P(5))
"RTN","PSIVCAL",16,0)
 I P(11)']"" X $S($E(PSIVAC)="C":"S Y=+$E(P(""LOG""),1,12)",1:"D NOW^%DTC S Y=%") S Y=Y+.007\.01/100 S:'$P(Y,".",2) Y=$$MDNGHT(Y) X ^DD("DD") S START=Y G Q
"RTN","PSIVCAL",17,0)
 S X=P(11) D CHK S PX=Y,X1=PSIV\3600,X2=PSIV#3600\60,X=$E(".0",1,$L(X1)#2+1)_X1_$E("0",X2<10)_X2,START=$S($E(PSIVAC)="C":$P(P("LOG"),"."),1:"T")
"RTN","PSIVCAL",18,0)
 S X1=$P(PX,"-"),X1=$E(".0",1,$L(X1)#2+1)_X1,X2=$P(PX,"-",PSGCNT),X2=$E(".0",1,$L(X2)#2+1)_X2
"RTN","PSIVCAL",19,0)
 S NAT=+$P($G(^PS(59.6,+$O(^PS(59.6,"B",+VAIN(4),0)),0)),U,5)
"RTN","PSIVCAL",20,0)
 I '$D(PSGDT) S PSGDT=$$DATE^PSJUTL2()
"RTN","PSIVCAL",21,0)
 I X<X1,'NAT S START=$$ENSD^PSGNE3(P(9),P(11),+$E(P("LOG"),1,12),PSGDT) G Q
"RTN","PSIVCAL",22,0)
 I X>X2 S START=$$ENSD^PSGNE3(P(9),P(11),+$E(P("LOG"),1,12),PSGDT) G Q
"RTN","PSIVCAL",23,0)
T6 F I=2:1:PSGCNT S X1="."_$P(PX,"-",I-1),X2="."_$P(PX,"-",I) Q:+X1<X&(+X2>X)
"RTN","PSIVCAL",24,0)
 S X1=X-X1,X2=$S(NAT:0,1:X2-X),START=$S(X1<X2:$P(PX,"-",I-1),1:$P(PX,"-",I)) S:START="" START=$P(PX,"-") X $S($E(PSIVAC)="C":"S Y=$P(P(""LOG""),""."") X ^DD(""DD"") S PSIV=Y",1:"S PSIV=""TODAY""") S START=PSIV_"@"_$E("0",$L(START)=3)_START G Q
"RTN","PSIVCAL",25,0)
T2 S X=+("."_$E(10000+(PSIV\3600*100)+(PSIV#3600\60),2,5)),START=$O(^PS(59.5,PSIVSN,3,"AT",X)) S:'START START=$O(^(0)),PSIVTOM=1 I 'START S START=X K PSIVTOM
"RTN","PSIVCAL",26,0)
 S START=$S($E(PSIVAC)="C":$P(P("LOG"),"."),1:DT)_START I $D(PSIVTOM) S X1=$S($E(PSIVAC)="C":$P(P("LOG"),"."),1:DT),X2=1 D C^%DTC S Y=$P(X,".")_START K PSIVTOM
"RTN","PSIVCAL",27,0)
 S X=START,%DT="XRTX" D ^%DT
"RTN","PSIVCAL",28,0)
Q ;
"RTN","PSIVCAL",29,0)
 I START["@" S X=START,%DT="RTX" D ^%DT S START=+Y
"RTN","PSIVCAL",30,0)
 S P(2)=START
"RTN","PSIVCAL",31,0)
 I $G(PSJORD)["P" D:'$G(PSGRDTX(+PSJORD,"PSGSD")) REQDT^PSJLIVMD(PSJORD) S START=$G(PSGRDTX(+PSJORD,"PSGSD")) S P(2)=$S(START:START,1:P(2))
"RTN","PSIVCAL",32,0)
 K NAT,START,PSIVTYPE,PSIVSTRT,PSGCNT,X1,X2,PX
"RTN","PSIVCAL",33,0)
 Q
"RTN","PSIVCAL",34,0)
CHK F Y=1:1 Q:$L(X)>240!($P(X,"-",Y)="")  S $P(X,"-",Y)=$P(X,"-",Y)_$E("0000",1,4-$L($P(X,"-",Y)))
"RTN","PSIVCAL",35,0)
 S Y=X,PSGCNT=$L(X,"-") S:X]""&(PSGCNT<1) PSGCNT=1 Q
"RTN","PSIVCAL",36,0)
 ;
"RTN","PSIVCAL",37,0)
ENSTOP ; WILL CALCULATE STOP DATE FOR ORDER
"RTN","PSIVCAL",38,0)
 ;NEEDS (DFN) & ON
"RTN","PSIVCAL",39,0)
 N WALL,P3,ADX,DDLX,OIX,DRGT,PSIDAY,PSIMIN S (WALL,P3,PSIDAY,PSIMIN)=0
"RTN","PSIVCAL",40,0)
 D:'$G(PSIVSITE) ^PSIVSET  Q:'P(2)
"RTN","PSIVCAL",41,0)
 I P(23)'="" S PSIVTYPE="C"
"RTN","PSIVCAL",42,0)
 S STOP="",X="",PSIVSTRT=P(2),PSIVTYPE=$G(P(4)) I $G(PSJREN) D
"RTN","PSIVCAL",43,0)
 . N RDT I $G(ON)["P" S RDT=+$$LASTREN^PSJLMPRI(DFN,ON)
"RTN","PSIVCAL",44,0)
 . S PSIVSTRT=$$DATE2^PSJUTL2($S($G(RDT):RDT,1:$G(PSGDT)))
"RTN","PSIVCAL",45,0)
 ;BHW - PSJ*5*177 - Begin Modifications - Reset Start date to Last Renewed date for active orders that have been renewed
"RTN","PSIVCAL",46,0)
 I ('$G(PSJREN))&($G(P(4))="A")&($G(ON)["V") D
"RTN","PSIVCAL",47,0)
 . N RDT S RDT=+$$LASTREN^PSJLMPRI(DFN,ON)
"RTN","PSIVCAL",48,0)
 . I +RDT S PSIVSTRT=RDT
"RTN","PSIVCAL",49,0)
 . Q
"RTN","PSIVCAL",50,0)
 ;BHW - PSJ*5*177 - End Modifications - Resetting PSIVSTRT will recalculate the stop date based on the Last renewed date.
"RTN","PSIVCAL",51,0)
 ;
"RTN","PSIVCAL",52,0)
 I $S("^NOW^STAT^ONCE^ONE-TIME^ONE TIME^ONETIME^1TIME^1-TIME^1 TIME^"[(U_P(9)_U):1,1:0),PSIVTYPE="P"!P(5)!(P(23)="P") S X=$$ENOSD^PSJDCU(PSJSYSW0,PSIVSTRT,DFN) I X]"" S:P(11)=""&($G(ON)["P") PSIVCAL=1 G END
"RTN","PSIVCAL",53,0)
 N DUR,DURMIN,PSJPROV,PSJDNM,A,PSJDAY I $G(PSJORD)["V" S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,"IV",1) I DUR]"" S DURMIN=$$DURMIN^PSJLIVMD(DUR) I DURMIN S PSIMIN=DURMIN
"RTN","PSIVCAL",54,0)
 I $G(PSJORD)["P"!($G(PSJORD)["V") N MINS,LIM S PSIVLIM=$$GETLIM(DFN,PSJORD) I PSIVLIM]"" S MINS=$$GETMIN(PSIVLIM,DFN,PSJORD) I MINS,MINS<PSIMIN!'PSIMIN S PSIMIN=MINS
"RTN","PSIVCAL",55,0)
 I $P(PSIVSITE,"^",5) D
"RTN","PSIVCAL",56,0)
 . N Z S Y=0
"RTN","PSIVCAL",57,0)
 . F  S Y=$O(^PS(55,DFN,"IV",Y)) Q:'Y  S Z=^(Y,0) D  Q:X]""
"RTN","PSIVCAL",58,0)
 .. I $P(Z,"^",17)="A",$$ONE^PSJBCMA(DFN,Y_"V",$P(Z,"^",9))'="O" S X=$P(Z,"^",3) Q
"RTN","PSIVCAL",59,0)
 S:X WALL=X
"RTN","PSIVCAL",60,0)
 S PSIDAY=$S(PSIVTYPE="A":$P(PSIVSITE,"^",4),PSIVTYPE="H":$P(PSIVSITE,"^",17),PSIVTYPE="P":$P(PSIVSITE,"^",18),PSIVTYPE="S":$P(PSIVSITE,"^",20),1:$P(PSIVSITE,"^",21))
"RTN","PSIVCAL",61,0)
 S PSJDAY="" D  I PSJDAY]"",PSJDAY<PSIDAY S PSIDAY=PSJDAY
"RTN","PSIVCAL",62,0)
 . N A,B,PSJCLIN
"RTN","PSIVCAL",63,0)
 . Q:'$D(PSJORD)  S A=""
"RTN","PSIVCAL",64,0)
 . I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVCAL",65,0)
 . I PSJORD["U" S A=$G(^PS(55,PSGP,5,+PSJORD,8))
"RTN","PSIVCAL",66,0)
 . I PSJORD["V" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVCAL",67,0)
 . S (PSJCLIN,A)=$P(A,"^") Q:A=""  S PSJCLIN=$P(^SC(PSJCLIN,0),"^") I $D(^PS(53.46,"B",A)) S B=$O(^PS(53.46,"B",A,"")),PSJDAY=$P(^PS(53.46,B,0),"^",2)
"RTN","PSIVCAL",68,0)
 F X=0:0 S X=$O(DRG("AD",X)) Q:'X  I $P(^PS(52.6,+$P(DRG("AD",+X),U),0),"^",4),($P(^(0),"^",4))<+PSIDAY S PSIDAY=$P(^(0),"^",4)
"RTN","PSIVCAL",69,0)
 I WALL,($$FMADD^XLFDT(PSIVSTRT,PSIDAY,"D"))>WALL S PSIDAY=$$FMDIFF^XLFDT(WALL,PSIVSTRT,1) S:PSIDAY<1 PSIDAY=""
"RTN","PSIVCAL",70,0)
 S DRGT=$S($D(DRG("AD")):"AD",1:"SOL") F ADX=0:0 S ADX=$O(DRG(DRGT,ADX)) Q:'ADX!($G(DRGTMP)&($G(DRGTN)["AD")&(DRGT="SOL"))  D
"RTN","PSIVCAL",71,0)
 . S OIX=+$P(DRG(DRGT,ADX),"^",6),DDLX=$P(^PS(50.7,OIX,0),"^",5) Q:'DDLX  D DDLIM(.PSIDAY,.P3)
"RTN","PSIVCAL",72,0)
 I '$G(DRG("AD",0)),$G(DRGTMP),($G(DRGTN)["SOL") S OIX=$P($G(DRGTMP),"^",6) I OIX S DDLX=$P(^PS(50.7,OIX,0),"^",5) I DDLX  D DDLIM(.PSIDAY,.P3)
"RTN","PSIVCAL",73,0)
 I $G(P3),$G(P(2)) I P3>P(2) S X=P3 G END
"RTN","PSIVCAL",74,0)
 S:('PSIDAY&'PSIMIN) PSIDAY=1
"RTN","PSIVCAL",75,0)
TIME S X2=PSIDAY,X1=PSIVSTRT D C^%DTC S X=$P(X,"."),X=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVCAL",76,0)
 I PSIMIN,PSIMIN<(PSIDAY*1440) S X=$$FMADD^XLFDT(PSIVSTRT,,,PSIMIN) D
"RTN","PSIVCAL",77,0)
 . I '(PSIMIN#1440) S X=$P(X,"."),X=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVCAL",78,0)
END ;
"RTN","PSIVCAL",79,0)
 S P(3)=+X
"RTN","PSIVCAL",80,0)
 I $G(PSJORD)["P" D:'$G(PSGRDTX(+PSJORD,"PSGFD")) REQDT^PSJLIVMD(PSJORD) S P(3)=$S($G(PSGRDTX(+PSJORD,"PSGFD")):PSGRDTX(+PSJORD,"PSGFD"),1:P(3))
"RTN","PSIVCAL",81,0)
 S P(3)=$$DATE2^PSJUTL2(P(3)),P(2)=$$DATE2^PSJUTL2(P(2))
"RTN","PSIVCAL",82,0)
 Q
"RTN","PSIVCAL",83,0)
 ;
"RTN","PSIVCAL",84,0)
ENAD ;Will get last admin. time for order (needs dfn and on)
"RTN","PSIVCAL",85,0)
 N P4,PSIVX,PSIVY
"RTN","PSIVCAL",86,0)
 I $P(PSJSYSW0,U,5)=2 S PSIVADM=$$DATE^PSJUTL2() Q
"RTN","PSIVCAL",87,0)
 I $S($G(PSIVAC)["R":1,P(9)="QOD":1,1:P(9)?1"Q".N1"D") S PSIVADM=$$ENSD^PSGNE3(P(9),P(11),+$E(P("LOG"),1,12),+$P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,2)) Q:PSIVADM
"RTN","PSIVCAL",88,0)
 S PSIVX=X,PSIVY=Y,P4=P(4) S:P(4)="C" P4=P(23) S:P4="S" P4=$S(P(5):"P",1:"A") D NOW^%DTC S Y=%,PSIVNOW=Y I (P4="P"&(P(11)="")&'P(15))!("HA"[P4&'P(15)) S Y=Y+.007\.01/100 G QAD
"RTN","PSIVCAL",89,0)
 D P:P4="P"&('P(15)),AH:P(15)
"RTN","PSIVCAL",90,0)
QAD ;
"RTN","PSIVCAL",91,0)
 S:'$D(PSGSA) PSGSA=""
"RTN","PSIVCAL",92,0)
 S PSIVSD=Y I Y S OD=$L(PSGSA," ") I OD>2 S X=+PSGSA\1 F OD1=2:1:OD-1 I $P(PSGSA," ",OD1)'>$S(OD1>2:$P(PSGSA," ",OD1-1),1:PSGSA#1) S X1=X,X2=1 D C^%DTC
"RTN","PSIVCAL",93,0)
 I PSIVSD,OD>2 S Y=X_PSIVSD
"RTN","PSIVCAL",94,0)
 S PSIVADM=+Y,X=PSIVX,Y=PSIVY K PSGSA,PSIVSD,OD,OD1,PSIVMI,PSIVNOW S:PSIVADM<P(2) PSIVADM=P(2) Q
"RTN","PSIVCAL",95,0)
 ;
"RTN","PSIVCAL",96,0)
P S CD=PSIVNOW,PSGSA="",(PSIVSD,OD)=DT_.0001,X=P(11) D CHK S P(11)=X D ENP4^PSIVWL
"RTN","PSIVCAL",97,0)
 I PSGSA="" S PSIVSD=DT_.0001,PSIVMIN=-1440 D ENT^PSIVWL S $P(Y,".",2)=$P(P(11),"-",$L(P(11),"-")) Q
"RTN","PSIVCAL",98,0)
 S Y=$P(PSGSA," ",$L(PSGSA," ")-1) Q
"RTN","PSIVCAL",99,0)
AH F PSIVADM=0:-1 S CD=PSIVNOW,(X,X1)=DT,X2=PSIVADM D:X2 C^%DTC S X=$P(X,".") S (OD1,PSIVSD,OD)=X_.0001,PSIVMIN=P(15) D ENP3^PSIVWL Q:PSIVADM<-4!(PSGSA]"")
"RTN","PSIVCAL",100,0)
 S Y=$P(PSGSA," ",$L(PSGSA," ")-1) Q
"RTN","PSIVCAL",101,0)
MDNGHT(Y)          ;Sets Start Date/Time on orders placed between midnight and 12:30
"RTN","PSIVCAL",102,0)
 S Y=$$FMADD^XLFDT(Y,-1,0,0,0),Y=$P(Y,".")_".24" Q Y
"RTN","PSIVCAL",103,0)
 ;
"RTN","PSIVCAL",104,0)
DDLIM(PSIVDUR,STPDT) ;  
"RTN","PSIVCAL",105,0)
 N P3
"RTN","PSIVCAL",106,0)
 I DDLX["D" D  Q:(STPDT=0)
"RTN","PSIVCAL",107,0)
 . I +DDLX'<+PSIVDUR S STPDT=0 Q
"RTN","PSIVCAL",108,0)
 . S PSIVDUR=+DDLX,X2=PSIVDUR,X1=PSIVSTRT D C^%DTC S X=$P(X,"."),X=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14)) I X>P(2) S P(3)=X
"RTN","PSIVCAL",109,0)
 I DDLX["L",($G(P(9))]""),$G(P(15)),("AH"'[PSIVTYPE) D
"RTN","PSIVCAL",110,0)
 . Q:'$G(P(2))!'$G(OIX)  N FIRST,DOSAR,LAST,NEWDUR
"RTN","PSIVCAL",111,0)
 . S STRING=P(2)_"^"_$S($G(STPDT):STPDT,1:$$FMADD^XLFDT(PSGDT,30))_"^"_P(9)_"^C^"_OIX S FIRST=$$ENQ^PSJORP2(DFN,STRING)
"RTN","PSIVCAL",112,0)
 . S FIRST=$S($G(FIRST):FIRST,1:P(2)) Q:'FIRST  S DSTMP=FIRST,DOSAR(1)=DSTMP F I=2:1:DDLX+1 S DOSAR(I)=$$FMADD^XLFDT(DSTMP,,,P(15)),DSTMP=DOSAR(I)
"RTN","PSIVCAL",113,0)
 . I $D(DOSAR) S LAST=$O(DOSAR(""),-1) I LAST S LAST=DOSAR(LAST) I LAST>P(2) S NEWDUR=$$FMDIFF^XLFDT(LAST,P(2)) I NEWDUR<PSIVDUR S P(3)=LAST
"RTN","PSIVCAL",114,0)
 S P(3)=$$DATE2^PSJUTL2(P(3)),P(2)=$$DATE2^PSJUTL2(P(2)) S STPDT=P(3)
"RTN","PSIVCAL",115,0)
 Q
"RTN","PSIVCAL",116,0)
 ;
"RTN","PSIVCAL",117,0)
GETLIM(DFN,PSJORD) ;
"RTN","PSIVCAL",118,0)
 N ND2P5,F
"RTN","PSIVCAL",119,0)
 S F=$S(PSJORD["P":"^PS(53.1,+PSJORD,",PSJORD["V":"^PS(55,DFN,""IV"",+PSJORD,",1:"")
"RTN","PSIVCAL",120,0)
 S ND2P5=$G(@(F_"2.5)")) S LIM=$P(ND2P5,"^",4) Q:LIM="" 0
"RTN","PSIVCAL",121,0)
 S ND0=$G(@(F_"0)")) I PSJORD["P",$P(ND0,"^",4)="U" Q 0
"RTN","PSIVCAL",122,0)
 N MULT S MULT=$S($E(LIM)="h":60,$E(LIM)="d":1440,$E(LIM)="m":LIM,$E(LIM)="l":LIM,1:0) I MULT S LIM=MULT*$E(LIM,2,99)
"RTN","PSIVCAL",123,0)
 Q LIM
"RTN","PSIVCAL",124,0)
 ;
"RTN","PSIVCAL",125,0)
GETMIN(LIM,DFN,PSJORD) ;
"RTN","PSIVCAL",126,0)
 N F
"RTN","PSIVCAL",127,0)
 I LIM!(LIM=0) Q LIM
"RTN","PSIVCAL",128,0)
 S F=$S(PSJORD["P":"^PS(53.1,+PSJORD,",PSJORD["V":"^PS(55,DFN,""IV"",+PSJORD,",1:"")
"RTN","PSIVCAL",129,0)
 N RATE S RATE=$S(PSJORD["P":+$P($G(@(F_"8)")),"^",5),PSJORD["V":+$P($G(@(F_"0)")),"^",8),1:0) I RATE D
"RTN","PSIVCAL",130,0)
 . S LIM=$S($E(LIM)="m":$E(LIM,2,99),$E(LIM)="l":($E(LIM,2,99)*1000),1:0)/RATE S LIM=LIM*60
"RTN","PSIVCAL",131,0)
 Q LIM
"RTN","PSIVORFB")
0^2^B42928811^B29730553
"RTN","PSIVORFB",1,0)
PSIVORFB ;BIR/MLM-FILE/RETRIEVE ORDERS IN ^PS(55 ;25 Sep 98 / 2:24 PM
"RTN","PSIVORFB",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,18,28,68,58,85,110,111,120**;16 DEC 97;Build 10
"RTN","PSIVORFB",3,0)
 ;
"RTN","PSIVORFB",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVORFB",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSIVORFB",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVORFB",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA #2173.
"RTN","PSIVORFB",8,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVORFB",9,0)
 ;
"RTN","PSIVORFB",10,0)
NEW55 ; Get new order number in 55.
"RTN","PSIVORFB",11,0)
 N DA,DD,DO,DIC,DLAYGO,X,Y,PSIVLIM,MINS,PSJDSTP1,PSJDSTP2,A,PSJCLIN,PSJDNM,PSJPROV,PSJWARD,PSJPAO
"RTN","PSIVORFB",12,0)
 I $D(^PS(55,+DFN)),'$D(^PS(55,+DFN,0)) D ENSET0^PSGNE3(+DFN)
"RTN","PSIVORFB",13,0)
 I $G(PSJORD)["V"!($G(PSJORD)["P"),$G(P(2))]"" S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJORD) I PSIVLIM D
"RTN","PSIVORFB",14,0)
 . S MINS=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD),PSJDSTP1=$$FMADD^XLFDT(P(2),,,MINS)
"RTN","PSIVORFB",15,0)
 . S X=$P(PSJDSTP1,"."),PSJDSTP2=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVORFB",16,0)
 I $G(PSJORD)["P",$G(PSIVLIM) D
"RTN","PSIVORFB",17,0)
 . I $P($G(^PS(53.1,+PSJORD,0)),"^",25)]"" D CHKD Q:PSJPAO
"RTN","PSIVORFB",18,0)
 . I $G(PSJDSTP1),+PSJDSTP1'=+P(3),+PSJDSTP2'=+P(3) D
"RTN","PSIVORFB",19,0)
 .. S PSJPROV=DUZ I PSJORD["P" S PSJPROV=$P($G(^PS(53.1,+PSJORD,0)),"^",2)
"RTN","PSIVORFB",20,0)
 .. I PSJORD["V" S PSJPROV=$P($G(^PS(55,DFN,"IV",+PSJORD,0)),"^",6)
"RTN","PSIVORFB",21,0)
 .. D NOW^%DTC S XQA(PSJPROV)="",XQAID="PSJ,"_DFN_";"_PSJPROV_";"_%,XQADATA=""
"RTN","PSIVORFB",22,0)
 .. D
"RTN","PSIVORFB",23,0)
 ... I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVORFB",24,0)
 ... I PSJORD["V" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVORFB",25,0)
 ... S PSJCLIN=$P(A,"^") I PSJCLIN]"" S PSJCLIN=$P(^SC(PSJCLIN,0),"^")
"RTN","PSIVORFB",26,0)
 .. S A=$G(^DPT(DFN,0)),PSJWARD=$G(^(.1))
"RTN","PSIVORFB",27,0)
 .. S XQAMSG=$P(A,"^")_" ("_$E($P(A,"^"))_$E($P(A,"^",9),6,9)_"): ["_$S(PSJWARD]"":$E(PSJWARD,1,10),$G(PSJCLIN)]"":$E(PSJCLIN,1,10),1:"UNKNOWN")_"] "
"RTN","PSIVORFB",28,0)
 .. S A=$O(DRG("AD",0)) I A]"" S A=DRG("AD",A)
"RTN","PSIVORFB",29,0)
 .. I A="" S A=$O(DRG("SOL",0)) I A]"" S A=DRG("SOL",A)
"RTN","PSIVORFB",30,0)
 .. S PSJDNM=$P(^PS(50.7,+$P(A,"^",6),0),"^")
"RTN","PSIVORFB",31,0)
 .. S XQAMSG=XQAMSG_PSJDNM_" your DURATION not used for stop date/time"
"RTN","PSIVORFB",32,0)
 .. D SETUP^XQALERT
"RTN","PSIVORFB",33,0)
 S DIC="^PS(55,",DIC(0)="LN",DLAYGO=55,(DINUM,X)=+DFN D ^DIC Q:Y<0
"RTN","PSIVORFB",34,0)
LOCK0 F  L +^PS(55,DFN,"IV",0):0 I  Q
"RTN","PSIVORFB",35,0)
 S ND=$S($D(^PS(55,DFN,"IV",0)):^(0),1:"^55.01") F DA=$P(ND,"^",3)+1:1 W "." I '$D(^PS(55,DFN,"IV",DA)) S $P(ND,"^",3)=DA,$P(ND,"^",4)=$P(ND,"^",4)+1,^PS(55,DFN,"IV",0)=ND Q
"RTN","PSIVORFB",36,0)
 L +^PS(55,DFN,"IV",+DA):0 E  G LOCK0
"RTN","PSIVORFB",37,0)
 S ^PS(55,DFN,"IV",+DA,0)=+DA,^PS(55,DFN,"IV","B",+DA,+DA)=""
"RTN","PSIVORFB",38,0)
 L -^PS(55,DFN,"IV",0) S ON55=+DA_"V"
"RTN","PSIVORFB",39,0)
 Q
"RTN","PSIVORFB",40,0)
 ;
"RTN","PSIVORFB",41,0)
SET55 ; Move data from local variables to 55.
"RTN","PSIVORFB",42,0)
 I '$D(ON55) W !,"*** Can't create this order at this time ***" Q
"RTN","PSIVORFB",43,0)
 N DA,DIK,ND,PSIVACT,PSIVDUR
"RTN","PSIVORFB",44,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON55,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSIVORFB",45,0)
 S ND(.3)=$G(P("INS")),ND(2.5)="" N X S X=$S($G(PSGORD):PSGORD,1:$G(ON)) I X D
"RTN","PSIVORFB",46,0)
 .N PKG S PKG=$E(X,$L(X)) S PKG=$S(PKG="V":"""IV""",PKG="U":5,PKG="P":"P",1:"") Q:PKG=""
"RTN","PSIVORFB",47,0)
 .S PSIVDUR=$$GETDUR^PSJLIVMD(DFN,+X,$E(X,$L(X)),1) Q:PSIVDUR=""
"RTN","PSIVORFB",48,0)
 .I $G(IVLIMIT) S ND(2.5)="^^^"_PSIVDUR K IVLIMIT Q
"RTN","PSIVORFB",49,0)
 .S ND(2.5)="^"_PSIVDUR
"RTN","PSIVORFB",50,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSIVORFB",51,0)
 F X=0,1,2.5,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSIVORFB",52,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSIVORFB",53,0)
 S X=^PS(55,DFN,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(P("LOG"),"^"),"."),$P(X,"^",8)="A",^(0)=X
"RTN","PSIVORFB",54,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSIVORFB",55,0)
 S:+$G(P("CLIN")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN")
"RTN","PSIVORFB",56,0)
 S:+$G(P("APPT")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^",2)=P("APPT")
"RTN","PSIVORFB",57,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSIVORFB",58,0)
 ;S:'$D(PSIVUP) PSIVUP=+$$GTPCI^PSIVUTL K ^PS(55,DFN,"IV",+ON55,5) I $O(^PS(53.45,PSIVUP,4,0)) S %X="^PS(53.45,"_PSIVUP_",4,",%Y="^PS(55,"_DFN_",""IV"","_+ON55_",5," D %XY^%RCR
"RTN","PSIVORFB",59,0)
 I '$G(PSIVCHG)!($G(PSJREN)&($G(PSIVCHG)=2)) I $G(P("PON")),P("PON")'=ON55 D
"RTN","PSIVORFB",60,0)
 . N X S X=$S(P("PON")["P":"^PS(53.1,+P(""PON""),12,0)",P("PON")["V"&$G(PSJREN):"^PS(55,DFN,""IV"",+P(""PON""),5,0)",1:"") Q:X=""
"RTN","PSIVORFB",61,0)
 . I $O(@X) S %X=X,%Y="^PS(55,"_DFN_",""IV"","_+ON55_",5," D %XY^%RCR
"RTN","PSIVORFB",62,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSIVORFB",63,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSIVORFB",64,0)
 I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" K PSJCOMSI N PSJCHILD,PSJOEORD S PSJOEORD=0 F  S PSJOEORD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD)) Q:'PSJOEORD  D
"RTN","PSIVORFB",65,0)
 . N PSJCHILD S PSJCHILD=0 F  S PSJCHILD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD,PSJCHILD)) Q:'PSJCHILD  S PSJCHILD(+PSJCHILD)=PSJCOM
"RTN","PSIVORFB",66,0)
 . S PSJCHILD=0 F  S PSJCHILD=$O(PSJCHILD(PSJCHILD)) Q:'PSJCHILD  D
"RTN","PSIVORFB",67,0)
 .. Q:PSJCHILD=PSJORD  K DR,DA,DIE,ORD S DR="31////"_$P($G(P("OPI")),"^",1,2),DA(1)=DFN
"RTN","PSIVORFB",68,0)
 .. N ON,ON55 S (ON,ON55)=+PSJCHILD_"V" S:+$G(PSJPINIT)'>0 PSJPINIT=DUZ S PSIVALT=1,PSIVAL="COMPLEX ORDER" D ENTACT^PSIVAL D
"RTN","PSIVORFB",69,0)
 ... I $P($G(^PS(55,DFN,"IV",+ON55,3)),"^")'=$P(P("OPI"),"^") S P("FC")="OTHER PRINT INFO^"_$P($G(^(3)),"^")_U_$P(P("OPI"),"^") D GTFC^PSIVORAL
"RTN","PSIVORFB",70,0)
 ... I $D(^PS(55,DFN,"IV",+ON55,0)) S ^PS(55,DFN,"IV",+ON55,3)=P("OPI") D EN1^PSJHL2(DFN,"XX",ON55)
"RTN","PSIVORFB",71,0)
 Q
"RTN","PSIVORFB",72,0)
 ;
"RTN","PSIVORFB",73,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSIVORFB",74,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSIVORFB",75,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSIVORFB",76,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSIVORFB",77,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=Y
"RTN","PSIVORFB",78,0)
 Q
"RTN","PSIVORFB",79,0)
GT55 ; Retrieve data from 55 into local array
"RTN","PSIVORFB",80,0)
 K DRG,DRGN,P S:'$D(ON55) ON55=ON S P("REN")="",Y=$G(^PS(55,DFN,"IV",+ON55,0)) F X=1:1:23 S P(X)=$P(Y,U,X)
"RTN","PSIVORFB",81,0)
 S P("21FLG")=P(21)
"RTN","PSIVORFB",82,0)
 S P("PON")=ON55,PSJORIFN=P(21),P(6)=P(6)_U_$P($G(^VA(200,+P(6),0)),U),(DRG,DRGN)="",P("REM")=$G(^PS(55,DFN,"IV",+ON55,1))
"RTN","PSIVORFB",83,0)
 S Y=$G(^PS(55,DFN,"IV",+ON55,2)),P("LOG")=$P(Y,U),P("IVRM")=$P(Y,U,2)_U_$P($G(^PS(59.5,+$P(Y,U,2),0)),U)
"RTN","PSIVORFB",84,0)
 S P("CLRK")=$P(Y,U,11)_U_$P($G(^VA(200,+$P(Y,U,11),0)),U),P("RES")=$P(Y,U,8),P("FRES")=$P(Y,U,9),P("SYRS")=$P(Y,U,4),P("OPI")=$G(^PS(55,DFN,"IV",+ON55,3))
"RTN","PSIVORFB",85,0)
 S P("INS")=$G(^PS(55,DFN,"IV",+ON55,.3))
"RTN","PSIVORFB",86,0)
 S P("CLIN")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^"),P("APPT")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^",2)
"RTN","PSIVORFB",87,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORFB",88,0)
 D:'$D(PSJLABEL) GTPC(ON55) S ND=$G(^PS(55,DFN,"IV",+ON55,.2)),P("PD")=$S($P(ND,U):$P(ND,U)_U_$$OIDF^PSJLMUT1(+ND)_U_$P($G(^PS(50.7,+ND,0)),U),1:""),P("DO")=$P(ND,U,2),P("PRY")=$P(ND,U,4),P("NAT")=$P(ND,U,5),(PSJCOM,P("PRNTON"))=$P(ND,U,8)
"RTN","PSIVORFB",89,0)
 I P("PRY")="D",'+P("IVRM") S P("IVRM")=+$G(PSIVSN)_U_$P($G(^PS(59.5,+$G(PSIVSN),0)),U)
"RTN","PSIVORFB",90,0)
 S P("MR")=$P(ND,U,3),ND=$G(^PS(51.2,+P("MR"),0)),P("MR")=P("MR")_U_$S($P(ND,U,3)]"":$P(ND,U,3),1:$P(ND,U)) D GTCUM
"RTN","PSIVORFB",91,0)
 D GTDRG,GTOT^PSIVUTL(P(4))
"RTN","PSIVORFB",92,0)
K ; Kill and exit.
"RTN","PSIVORFB",93,0)
 K FIL,ND
"RTN","PSIVORFB",94,0)
 Q
"RTN","PSIVORFB",95,0)
GTDRG ; Get drug info and place in DRG(.
"RTN","PSIVORFB",96,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,DFN,"IV",+ON55,DRGT,Y)) Q:'Y  D
"RTN","PSIVORFB",97,0)
 .; naked ref below refers to line above
"RTN","PSIVORFB",98,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,DRG(DRGT,0))=$G(DRG(DRGT,0))+1
"RTN","PSIVORFB",99,0)
 .S DRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORFB",100,0)
 Q
"RTN","PSIVORFB",101,0)
 ;
"RTN","PSIVORFB",102,0)
GTCUM ; Retrieve dispensing info.
"RTN","PSIVORFB",103,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,9)),P("LF")=$P(ND,U),P("LFA")=$P(ND,U,2),P("CUM")=$P(ND,U,3)
"RTN","PSIVORFB",104,0)
 Q
"RTN","PSIVORFB",105,0)
 ;
"RTN","PSIVORFB",106,0)
GTPC(ON) ; Retrieve Provider Comments and create "scratch" fields to edit
"RTN","PSIVORFB",107,0)
 ;S:'$D(PSIVUP) PSIVUP=+$$GTPCI^PSIVUTL K ^PS(53.45,PSIVUP,4)
"RTN","PSIVORFB",108,0)
 ;K ^PS(53.45,PSIVUP,4) I $O(^PS(55,DFN,"IV",+ON,5,0)) S %X="^PS(55,"_DFN_",""IV"","_+ON_",5,",%Y="^PS(53.45,"_PSIVUP_",4," D %XY^%RCR
"RTN","PSIVORFB",109,0)
 Q
"RTN","PSIVORFB",110,0)
 ;
"RTN","PSIVORFB",111,0)
SETNEW ; Create new order and set
"RTN","PSIVORFB",112,0)
 D NEW55,SET55
"RTN","PSIVORFB",113,0)
 Q
"RTN","PSIVORFB",114,0)
CHKD ;Check for a previous active order and compare the duration
"RTN","PSIVORFB",115,0)
 N PSJPO,A,PSJDUR
"RTN","PSIVORFB",116,0)
 S PSJDUR=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",117,0)
 S PSJPAO=0,PSJPO=PSJORD
"RTN","PSIVORFB",118,0)
CHKDR S PSJPO=$P($G(^PS(53.1,+PSJPO,0)),"^",25) Q:PSJPO=""
"RTN","PSIVORFB",119,0)
 I PSJPO["P" G CHKDR
"RTN","PSIVORFB",120,0)
 I PSJPO["V" S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJPO) I PSJDUR'=PSIVLIM S PSJPAO=1 Q
"RTN","PSIVORFB",121,0)
 G CHKDR
"VER")
8.0^22.0
"BLD",5700,6)
^168
**END**
**END**
